<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>懒羊羊</title>
  
  <subtitle>我是不会和普通的羊一般见识的。</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.xxlaila.cn/"/>
  <updated>2020-06-07T01:57:42.000Z</updated>
  <id>https://www.xxlaila.cn/</id>
  
  <author>
    <name>xxlaila</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>prometheus自动发现pod配置</title>
    <link href="https://www.xxlaila.cn/2020/06/07/prometheus%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0pod%E9%85%8D%E7%BD%AE/"/>
    <id>https://www.xxlaila.cn/2020/06/07/prometheus自动发现pod配置/</id>
    <published>2020-06-07T01:56:44.000Z</published>
    <updated>2020-06-07T01:57:42.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h3 id="prometheus自动发现pod配置"><a href="#prometheus自动发现pod配置" class="headerlink" title="prometheus自动发现pod配置"></a>prometheus自动发现pod配置</h3><p>按照传统的方法来部署<code>prometheus</code>监控实际发现，新增某个东西的时候都要去一个个配置job很麻烦，不如自动发现pod和svc，把新生成的pod和svc等资源，自动加入到系统的pod和svc监控中去。实际上我们使用的官方k8s部署prometheus已经帮我们完成。我们在部署pod和svc的时候增加配置即可。</p><a id="more"></a><h3 id="部署自动发现redis"><a href="#部署自动发现redis" class="headerlink" title="部署自动发现redis"></a>部署自动发现redis</h3><p>要想自动发现集群中的 Service，就需要在 Service 的annotation区域添加：prometheus.io/scrape=true的声明，要自动发现集群中的 pod，也需要我们在 pod 的annotation区域添加：prometheus.io/scrape=true的声明</p><h4 id="部署redis"><a href="#部署redis" class="headerlink" title="部署redis"></a>部署redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; redis-deploy.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: redis</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: redis</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">        prometheus.io/port: <span class="string">"9121"</span></span><br><span class="line">      labels:</span><br><span class="line">        app: redis</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: redis</span><br><span class="line">        image: redis:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        env:</span><br><span class="line">          - name: TZ</span><br><span class="line">            value: Asia/Shanghai</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6379</span><br><span class="line">      - name: redis-exporter</span><br><span class="line">        image: oliver006/redis_exporter:latest</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9121</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建redis</span></span><br><span class="line">kubectl apply -f redis-deploy.yaml</span><br></pre></td></tr></table></figure><h4 id="创建redis-服务"><a href="#创建redis-服务" class="headerlink" title="创建redis 服务"></a>创建redis 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;redis-service.yml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace:</span><br><span class="line">  name: redis</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">    prometheus.io/port: <span class="string">"9121"</span></span><br><span class="line">  labels:</span><br><span class="line">    app: redis</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: redis</span><br><span class="line">    port: 6379</span><br><span class="line">    targetPort: 6379</span><br><span class="line">  - name: prom</span><br><span class="line">    port: 9121</span><br><span class="line">    targetPort: 9121</span><br><span class="line">  selector:</span><br><span class="line">    app: redis</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建svc</span></span><br><span class="line"> kubectl apply -f redis-service.yml</span><br></pre></td></tr></table></figure><h3 id="部署nginx"><a href="#部署nginx" class="headerlink" title="部署nginx"></a>部署nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;nginx-deploy.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">        prometheus.io/port: <span class="string">"9113"</span></span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">      - name: nginx-exporter</span><br><span class="line">        image: fish/nginx-exporter</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9113</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建nginx</span></span><br><span class="line">kubectl apply -f nginx-deploy.yaml</span><br></pre></td></tr></table></figure><h4 id="创建nginx-服务"><a href="#创建nginx-服务" class="headerlink" title="创建nginx 服务"></a>创建nginx 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;nginx-service.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace:</span><br><span class="line">  name: nginx</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">    prometheus.io/port: <span class="string">"9113"</span></span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: nginx</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">  - name: fish</span><br><span class="line">    port: 9113</span><br><span class="line">    targetPort: 9113</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建nginx 服务</span></span><br><span class="line">kubectl apply -f nginx-service.yaml</span><br></pre></td></tr></table></figure><p>创建完成后，在<code>prometheus</code>ui界面的<code>status——&gt;Service Discovery</code>可以看到。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;prometheus自动发现pod配置&quot;&gt;&lt;a href=&quot;#prometheus自动发现pod配置&quot; class=&quot;headerlink&quot; title=&quot;prometheus自动发现pod配置&quot;&gt;&lt;/a&gt;prometheus自动发现pod配置&lt;/h3&gt;&lt;p&gt;按照传统的方法来部署&lt;code&gt;prometheus&lt;/code&gt;监控实际发现，新增某个东西的时候都要去一个个配置job很麻烦，不如自动发现pod和svc，把新生成的pod和svc等资源，自动加入到系统的pod和svc监控中去。实际上我们使用的官方k8s部署prometheus已经帮我们完成。我们在部署pod和svc的时候增加配置即可。&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="https://www.xxlaila.cn/categories/kubernetes/"/>
    
    
      <category term="prometheus" scheme="https://www.xxlaila.cn/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>yum 安装nginx 增加lua-nginx-module和nginx-gridfs</title>
    <link href="https://www.xxlaila.cn/2020/06/07/yum-%E5%AE%89%E8%A3%85nginx-%E5%A2%9E%E5%8A%A0lua-nginx-module%E5%92%8Cnginx-gridfs/"/>
    <id>https://www.xxlaila.cn/2020/06/07/yum-安装nginx-增加lua-nginx-module和nginx-gridfs/</id>
    <published>2020-06-07T01:55:18.000Z</published>
    <updated>2020-06-07T01:56:28.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h3 id="yum-安装nginx-增加lua-nginx-module和nginx-gridfs"><a href="#yum-安装nginx-增加lua-nginx-module和nginx-gridfs" class="headerlink" title="yum 安装nginx 增加lua-nginx-module和nginx-gridfs"></a>yum 安装nginx 增加lua-nginx-module和nginx-gridfs</h3><h3 id="安装LuaJIT"><a href="#安装LuaJIT" class="headerlink" title="安装LuaJIT"></a>安装LuaJIT</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y luajit luajit-devel</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="下载依赖模块"><a href="#下载依赖模块" class="headerlink" title="下载依赖模块"></a>下载依赖模块</h3><p>提前下载nginx对应的版本源码包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ngx_devel_kit</span></span><br><span class="line">wget https://github.com/vision5/ngx_devel_kit/archive/v0.3.1.tar.gz</span><br><span class="line">tar zxf v0.3.1.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># ngx_lua</span></span><br><span class="line">wget https://github.com/openresty/lua-nginx-module/archive/v0.10.13.tar.gz</span><br><span class="line">tar zxf v0.10.13.tar.gz</span><br></pre></td></tr></table></figure><h3 id="查看nginx现有编译参数"><a href="#查看nginx现有编译参数" class="headerlink" title="查看nginx现有编译参数"></a>查看nginx现有编译参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br></pre></td></tr></table></figure><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>使用动态模块方式加载编译。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure &lt;原参数&gt; --with-ld-opt=<span class="string">"-Wl,-rpath,/usr/lib64/"</span> --add-dynamic-module=/root/ngx_devel_kit-0.3.1 --add-dynamic-module=/root/lua-nginx-module-0.10.13</span><br><span class="line"></span><br><span class="line">make</span><br></pre></td></tr></table></figure><p><strong>注释</strong>： <code>with-ld-opt</code>参数如有不需要增加，需要和自身的对比。</p><h3 id="nginx-添加gridfs的支持"><a href="#nginx-添加gridfs的支持" class="headerlink" title="nginx 添加gridfs的支持"></a>nginx 添加gridfs的支持</h3><p>运行nginx 的时候出现<code>nginx: [emerg] unknown directive &quot;gridfs&quot;</code>。发现nginx的这个插件<code>nginx-grifs</code>是用于<code>nginx-gridFS</code>读取<code>MongoDB</code>的图片。</p><h3 id="下载nginx-gridfs源码"><a href="#下载nginx-gridfs源码" class="headerlink" title="下载nginx-gridfs源码"></a>下载nginx-gridfs源码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/mdirolf/nginx-gridfs.git</span><br><span class="line"><span class="built_in">cd</span> nginx-gridfs</span><br><span class="line">git submodule init</span><br><span class="line">git submodule update</span><br></pre></td></tr></table></figure><h3 id="重新编译nginx"><a href="#重新编译nginx" class="headerlink" title="重新编译nginx"></a>重新编译nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure &lt;原参数&gt; --add-module=../nginx-gridfs/</span><br></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>编译完成以后，在nginx的包目录下面会生成一个objs目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证是否有误</span></span><br><span class="line">objs/nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制nginx到/usr/sbin/</span></span><br><span class="line">cp objs/nginx /usr/sbin/</span><br></pre></td></tr></table></figure><h3 id="测试nginx-gridfs"><a href="#测试nginx-gridfs" class="headerlink" title="测试nginx-gridfs"></a>测试nginx-gridfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx 配置</span></span><br><span class="line">location /static/ &#123;</span><br><span class="line">       gridfs xxlaila_ota field=filename <span class="built_in">type</span>=string;</span><br><span class="line">       mongo mongodb://xxlaila:xxlaila123@192.168.36.12:27017,192.168.36.14:27017,192.168.36.13:27017/?replicaSet=xxlaila&amp;authSource=admin;</span><br><span class="line"></span><br><span class="line">       secure_link <span class="variable">$arg_md5</span>,<span class="variable">$arg_expires</span>;</span><br><span class="line">       secure_link_md5 <span class="string">"<span class="variable">$secure_link_expires</span><span class="variable">$uri</span> llsp5T2nbV3AffY"</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$secure_link</span> = <span class="string">""</span>) &#123;</span><br><span class="line">           <span class="built_in">return</span> 403;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$secure_link</span> = <span class="string">"0"</span>) &#123;</span><br><span class="line">           <span class="built_in">return</span> 410;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试图片上传</span></span><br><span class="line">sudo mongofiles put --host localhost --port 27017 --db qrcode --<span class="built_in">local</span> ~/photo.jpg --<span class="built_in">type</span> jpg</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;yum-安装nginx-增加lua-nginx-module和nginx-gridfs&quot;&gt;&lt;a href=&quot;#yum-安装nginx-增加lua-nginx-module和nginx-gridfs&quot; class=&quot;headerlink&quot; title=&quot;yum 安装nginx 增加lua-nginx-module和nginx-gridfs&quot;&gt;&lt;/a&gt;yum 安装nginx 增加lua-nginx-module和nginx-gridfs&lt;/h3&gt;&lt;h3 id=&quot;安装LuaJIT&quot;&gt;&lt;a href=&quot;#安装LuaJIT&quot; class=&quot;headerlink&quot; title=&quot;安装LuaJIT&quot;&gt;&lt;/a&gt;安装LuaJIT&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install -y luajit luajit-devel&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="nginx" scheme="https://www.xxlaila.cn/categories/nginx/"/>
    
    
      <category term="nginx" scheme="https://www.xxlaila.cn/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>yum安装的Nginx添加第三方模块支持tcp</title>
    <link href="https://www.xxlaila.cn/2020/05/30/yum%E5%AE%89%E8%A3%85%E7%9A%84Nginx%E6%B7%BB%E5%8A%A0%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97%E6%94%AF%E6%8C%81tcp/"/>
    <id>https://www.xxlaila.cn/2020/05/30/yum安装的Nginx添加第三方模块支持tcp/</id>
    <published>2020-05-30T01:49:07.000Z</published>
    <updated>2020-05-30T01:50:20.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --><h3 id="yum安装的Nginx添加第三方模块支持tcp"><a href="#yum安装的Nginx添加第三方模块支持tcp" class="headerlink" title="yum安装的Nginx添加第三方模块支持tcp"></a>yum安装的Nginx添加第三方模块支持tcp</h3><p>需求：生产有个业务是四层转发，nginx1.9开始支持tcp层的转发，通过stream实现的。<br>实现：在Centos7.6下yum直接安装的nginx，添加新模块支持tcp转发；重新编译Nginx并添加 –with-stream 参数。</p><a id="more"></a><h3 id="查看nginx版本及模块"><a href="#查看nginx版本及模块" class="headerlink" title="查看nginx版本及模块"></a>查看nginx版本及模块</h3><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br><span class="line">nginx <span class="symbol">version:</span> nginx/<span class="number">1.16</span>.<span class="number">1</span></span><br><span class="line">built by gcc <span class="number">4.8</span>.<span class="number">5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span>.<span class="number">5</span>-<span class="number">39</span>) (GCC)</span><br><span class="line">built <span class="keyword">with</span> OpenSSL <span class="number">1.0</span>.<span class="number">2</span>k-fips  <span class="number">26</span> Jan <span class="number">2017</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure <span class="symbol">arguments:</span> --prefix=<span class="regexp">/usr/share</span><span class="regexp">/nginx --sbin-path=/usr</span><span class="regexp">/sbin/nginx</span> --modules-path=<span class="regexp">/usr/lib</span>64/nginx/modules --conf-path=<span class="regexp">/etc/nginx</span><span class="regexp">/nginx.conf --error-log-path=/var</span><span class="regexp">/log/nginx</span><span class="regexp">/error.log --http-log-path=/var</span><span class="regexp">/log/nginx</span><span class="regexp">/access.log --http-client-body-temp-path=/var</span><span class="regexp">/lib/nginx</span><span class="regexp">/tmp/client</span>_body --http-proxy-temp-path=<span class="regexp">/var/lib</span><span class="regexp">/nginx/tmp</span><span class="regexp">/proxy --http-fastcgi-temp-path=/var</span><span class="regexp">/lib/nginx</span><span class="regexp">/tmp/fastcgi</span> --http-uwsgi-temp-path=<span class="regexp">/var/lib</span><span class="regexp">/nginx/tmp</span><span class="regexp">/uwsgi --http-scgi-temp-path=/var</span><span class="regexp">/lib/nginx</span><span class="regexp">/tmp/scgi</span> --pid-path=<span class="regexp">/run/nginx</span>.pid --lock-path=<span class="regexp">/run/lock</span><span class="regexp">/subsys/nginx</span> --user=nginx --group=nginx --<span class="keyword">with</span>-file-aio --<span class="keyword">with</span>-ipv6 --<span class="keyword">with</span>-http_ssl_module --<span class="keyword">with</span>-http_v2_module --<span class="keyword">with</span>-http_realip_module --<span class="keyword">with</span>-stream_ssl_preread_module --<span class="keyword">with</span>-http_addition_module --<span class="keyword">with</span>-http_xslt_module=dynamic --<span class="keyword">with</span>-http_image_filter_module=dynamic --<span class="keyword">with</span>-http_sub_module --<span class="keyword">with</span>-http_dav_module --<span class="keyword">with</span>-http_flv_module --<span class="keyword">with</span>-http_mp4_module --<span class="keyword">with</span>-http_gunzip_module --<span class="keyword">with</span>-http_gzip_static_module --<span class="keyword">with</span>-http_random_index_module --<span class="keyword">with</span>-http_secure_link_module --<span class="keyword">with</span>-http_degradation_module --<span class="keyword">with</span>-http_slice_module --<span class="keyword">with</span>-http_stub_status_module --<span class="keyword">with</span>-http_perl_module=dynamic --<span class="keyword">with</span>-http_auth_request_module --<span class="keyword">with</span>-mail=dynamic --<span class="keyword">with</span>-mail_ssl_module --<span class="keyword">with</span>-pcre --<span class="keyword">with</span>-pcre-jit --<span class="keyword">with</span>-stream=dynamic --<span class="keyword">with</span>-stream_ssl_module --<span class="keyword">with</span>-google_perftools_module --<span class="keyword">with</span>-debug --<span class="keyword">with</span>-cc-opt=<span class="string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic'</span> --<span class="keyword">with</span>-ld-opt=<span class="string">'-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'</span></span><br></pre></td></tr></table></figure><h3 id="下载一个同版本可编译的Nginx"><a href="#下载一个同版本可编译的Nginx" class="headerlink" title="下载一个同版本可编译的Nginx"></a>下载一个同版本可编译的Nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br><span class="line">tar zxf nginx-1.16.1.tar.gz</span><br></pre></td></tr></table></figure><h3 id="备份原Nginx文件"><a href="#备份原Nginx文件" class="headerlink" title="备份原Nginx文件"></a>备份原Nginx文件</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir nginx-backup</span><br><span class="line">mv <span class="regexp">/usr/</span>sbin<span class="regexp">/nginx nginx-backup/</span>nginx.bak</span><br><span class="line">cp -r <span class="regexp">/etc/</span>nginx nginx-backup<span class="regexp">/</span></span><br></pre></td></tr></table></figure><h3 id="重新编译Nginx"><a href="#重新编译Nginx" class="headerlink" title="重新编译Nginx"></a>重新编译Nginx</h3><p>根据<code>nginx -V</code>查到已有的模块，加上本次需新增的模块: –with-stream，安装之前我们需要安装一些插件，免得在编译的过程中报错。</p><h4 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libxml2 libxml2-dev libxslt-devel</span><br><span class="line">yum -y install gd-devel</span><br><span class="line">yum -y install perl-devel perl-ExtUtils-Embed</span><br><span class="line">yum -y install GeoIP GeoIP-devel GeoIP-data</span><br><span class="line">yum -y install pcre-devel</span><br><span class="line">yum -y install openssl openssl-devel gperftools</span><br><span class="line">yum -y install gcc gcc-c++ make redhat-rpm-config</span><br></pre></td></tr></table></figure><h4 id="编译nginx"><a href="#编译nginx" class="headerlink" title="编译nginx"></a>编译nginx</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-<span class="number">1.16</span>.<span class="number">1</span></span><br><span class="line">./configure --prefix=<span class="regexp">/usr/share</span><span class="regexp">/nginx --sbin-path=/usr</span><span class="regexp">/sbin/nginx</span> --modules-path=<span class="regexp">/usr/lib</span>64/nginx/modules --conf-path=<span class="regexp">/etc/nginx</span><span class="regexp">/nginx.conf --error-log-path=/var</span><span class="regexp">/log/nginx</span><span class="regexp">/error.log --http-log-path=/var</span><span class="regexp">/log/nginx</span><span class="regexp">/access.log --http-client-body-temp-path=/var</span><span class="regexp">/lib/nginx</span><span class="regexp">/tmp/client</span>_body --http-proxy-temp-path=<span class="regexp">/var/lib</span><span class="regexp">/nginx/tmp</span><span class="regexp">/proxy --http-fastcgi-temp-path=/var</span><span class="regexp">/lib/nginx</span><span class="regexp">/tmp/fastcgi</span> --http-uwsgi-temp-path=<span class="regexp">/var/lib</span><span class="regexp">/nginx/tmp</span><span class="regexp">/uwsgi --http-scgi-temp-path=/var</span><span class="regexp">/lib/nginx</span><span class="regexp">/tmp/scgi</span> --pid-path=<span class="regexp">/run/nginx</span>.pid --lock-path=<span class="regexp">/run/lock</span><span class="regexp">/subsys/nginx</span> --user=nginx --group=nginx --<span class="keyword">with</span>-file-aio --<span class="keyword">with</span>-ipv6 --<span class="keyword">with</span>-http_ssl_module --<span class="keyword">with</span>-http_v2_module --<span class="keyword">with</span>-http_realip_module --<span class="keyword">with</span>-stream_ssl_preread_module --<span class="keyword">with</span>-http_addition_module --<span class="keyword">with</span>-http_xslt_module=dynamic --<span class="keyword">with</span>-http_image_filter_module=dynamic --<span class="keyword">with</span>-http_sub_module --<span class="keyword">with</span>-http_dav_module --<span class="keyword">with</span>-http_flv_module --<span class="keyword">with</span>-http_mp4_module --<span class="keyword">with</span>-http_gunzip_module --<span class="keyword">with</span>-http_gzip_static_module --<span class="keyword">with</span>-http_random_index_module --<span class="keyword">with</span>-http_secure_link_module --<span class="keyword">with</span>-http_degradation_module --<span class="keyword">with</span>-http_slice_module --<span class="keyword">with</span>-http_stub_status_module --<span class="keyword">with</span>-http_perl_module=dynamic --<span class="keyword">with</span>-http_auth_request_module --<span class="keyword">with</span>-mail=dynamic --<span class="keyword">with</span>-mail_ssl_module --<span class="keyword">with</span>-pcre --<span class="keyword">with</span>-pcre-jit --<span class="keyword">with</span>-stream=dynamic --<span class="keyword">with</span>-stream_ssl_module --<span class="keyword">with</span>-google_perftools_module --<span class="keyword">with</span>-debug --<span class="keyword">with</span>-cc-opt=<span class="string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic'</span> --<span class="keyword">with</span>-ld-opt=<span class="string">'-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'</span> --<span class="keyword">with</span>-stream</span><br></pre></td></tr></table></figure><h3 id="编译通过，继续验证"><a href="#编译通过，继续验证" class="headerlink" title="编译通过，继续验证"></a>编译通过，继续验证</h3><p>编译通过以后，执行<code>make</code>， <code>make</code>完成后不要继续输入<code>make install</code>，以免现在的nginx出现问题。以上完成后，会在objs目录下生成一个nginx文件，进行验证：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/root/nginx-1.16.1/objs/nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line">/root/nginx-1.16.1/objs/nginx -V</span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC)</span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio --with-ipv6 --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-stream_ssl_preread_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-http_auth_request_module --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-google_perftools_module --with-debug --with-cc-opt=<span class="string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic'</span> --with-ld-opt=<span class="string">'-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'</span> --with-stream</span><br></pre></td></tr></table></figure><p><strong>注</strong>：在执行<code>/root/nginx-1.16.1/objs/nginx -t</code>的时候，提示模块冲突<code>nginx: [emerg] module &quot;ngx_stream_module&quot; is already loaded in /usr/share/nginx/modules/mod-stream.conf:1</code>,<code>nginx: configuration file /etc/nginx/nginx.conf test failed</code> ,编辑<code>/usr/share/nginx/modules/mod-stream.conf</code>文件，对第一行进行注释。重新验证ok。该文件就只有一行。</p><h3 id="替换Nginx文件并重启"><a href="#替换Nginx文件并重启" class="headerlink" title="替换Nginx文件并重启"></a>替换Nginx文件并重启</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /root/nginx-1.16.1/objs/nginx /usr/sbin/</span><br><span class="line">systemctl start nginx</span><br></pre></td></tr></table></figure><h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC)</span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio --with-ipv6 --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-stream_ssl_preread_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-http_auth_request_module --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-google_perftools_module --with-debug --with-cc-opt=<span class="string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic'</span> --with-ld-opt=<span class="string">'-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'</span> --with-stream</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;yum安装的Nginx添加第三方模块支持tcp&quot;&gt;&lt;a href=&quot;#yum安装的Nginx添加第三方模块支持tcp&quot; class=&quot;headerlink&quot; title=&quot;yum安装的Nginx添加第三方模块支持tcp&quot;&gt;&lt;/a&gt;yum安装的Nginx添加第三方模块支持tcp&lt;/h3&gt;&lt;p&gt;需求：生产有个业务是四层转发，nginx1.9开始支持tcp层的转发，通过stream实现的。&lt;br&gt;实现：在Centos7.6下yum直接安装的nginx，添加新模块支持tcp转发；重新编译Nginx并添加 –with-stream 参数。&lt;/p&gt;
    
    </summary>
    
      <category term="nginx" scheme="https://www.xxlaila.cn/categories/nginx/"/>
    
    
      <category term="linux" scheme="https://www.xxlaila.cn/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>linux ssh只允许指定的用户登录</title>
    <link href="https://www.xxlaila.cn/2020/05/11/linux-ssh%E5%8F%AA%E5%85%81%E8%AE%B8%E6%8C%87%E5%AE%9A%E7%9A%84%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95/"/>
    <id>https://www.xxlaila.cn/2020/05/11/linux-ssh只允许指定的用户登录/</id>
    <published>2020-05-11T08:11:06.000Z</published>
    <updated>2020-05-12T07:21:21.780Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h3 id="linux-ssh只允许指定的用户登录"><a href="#linux-ssh只允许指定的用户登录" class="headerlink" title="linux ssh只允许指定的用户登录"></a>linux ssh只允许指定的用户登录</h3><p>linux ssh只允许指定的用户登录的方法按大类分有两种，一种是通过pam模块配置，一种是通过sshd配置文件配置，通过pam来进行控制比较好一点，新建用户直接吧用户添加到文件，删除用户直接在文件里面增加。重启sshd就可以。<a id="more"></a></p><h3 id="pam模块控制法"><a href="#pam模块控制法" class="headerlink" title="pam模块控制法"></a>pam模块控制法</h3><h4 id="pam-access-so模块法"><a href="#pam-access-so模块法" class="headerlink" title="pam_access.so模块法"></a>pam_access.so模块法</h4><p>在/etc/pam.d/sshd文件中增加如下两行内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">account    required     pam_nologin.so</span><br><span class="line">account    include      password-auth</span><br></pre></td></tr></table></figure><p>上面的配置表示在ssh认证中启用该模板，pam_access.so模块的具体工作行为根据配置文件/etc/security/access.conf来决定。该配置文件涉及到的几个字段意义如下：</p><ul><li>第一个字段：权限（permission），使用“+”表示授予权限，用“-”表示禁止权限。</li><li>第二个字段：用户（user），定义了用户、组以及用“@”表示的在不同主机上的同名用户和同一主机上不同名用户。</li><li>第三个字段：访问发起方（origins），定义了发起访问的主机名称、域名称、终端名称。</li></ul><h3 id="pam-listfile-so模块"><a href="#pam-listfile-so模块" class="headerlink" title="pam_listfile.so模块"></a>pam_listfile.so模块</h3><p>pam_listfile.so模块的功能和pam_access.so模块类似，目标也是实现基于用户/组，主机名/IP，终端的访问控制。不过它实现的方式和pam_access.so会稍微有些不同，因为它没有专门的默认配置文件。访问控制是靠pam配置文件中的控制选项和一个自定义的配置文件来实现的。而且除了针对上述访问源的控制之外，还能够控制到ruser，rhost，所属用户组和登录shell。所以有些用户认为它的功能似乎比pam_access.so更加灵活和强大一些。</p><p>使用pam_listfile.so模块配置的格式分为五个部分：分别是item、sense、file、onerr以及apply。 其中：</p><ul><li>item=[tty|user|rhost|ruser|group|shell]：定义了对哪些列出的目标或者条件采用规则，显然，这里可以指定多种不同的条件。</li><li>onerr=succeed|fail：定义了当出现错误（比如无法打开配置文件）时的缺省返回值。</li><li>sense=allow|deny：定义了当在配置文件中找到符合条件的项目时的控制方式。如果没有找到符合条件的项目，则一般验证都会通过。</li><li>file=filename：用于指定配置文件的全路径名称。</li><li>apply=user|@group：定义规则适用的用户类型（用户或者组）</li></ul><h3 id="配置-etc-pam-d-sshd"><a href="#配置-etc-pam-d-sshd" class="headerlink" title="配置/etc/pam.d/sshd"></a>配置/etc/pam.d/sshd</h3><p>/etc/pam.d/sshd文件中增加如下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/pam.d/sshd</span><br><span class="line"></span><br><span class="line"><span class="comment">#%PAM-1.0</span></span><br><span class="line">auth required pam_listfile.so item=user sense=allow file=/etc/sshusers  onerr=fail</span><br></pre></td></tr></table></figure><h3 id="添加可进行ssh的用户"><a href="#添加可进行ssh的用户" class="headerlink" title="添加可进行ssh的用户"></a>添加可进行ssh的用户</h3><p>在/etc/sshusers文件中增加如下内容，用户需要使用<code>useradd</code> 自行添加，是真是存在于系统中的。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xxlaila</span><br><span class="line">zhangsan</span><br></pre></td></tr></table></figure><p>表示只允许xxlaila、zhangsan两个人通过ssh登陆。也可以反其道而行之，指定不允许登陆的用户，相应用sshd文件就改为</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/pam.d/sshd</span><br><span class="line"></span><br><span class="line">auth required pam_listfile.so item=user sense=deny file=/etc/sshusers　onerr=succeed</span><br></pre></td></tr></table></figure><h3 id="重启sshd"><a href="#重启sshd" class="headerlink" title="重启sshd"></a>重启sshd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure><h3 id="以组的方式进行控制"><a href="#以组的方式进行控制" class="headerlink" title="以组的方式进行控制"></a>以组的方式进行控制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/pam.d/sshd</span><br><span class="line"></span><br><span class="line">auth required pam_listfile.so item=group sense=allow file=/etc/security/allow_groups onerr=fail</span><br></pre></td></tr></table></figure><h3 id="增加组配置文件"><a href="#增加组配置文件" class="headerlink" title="增加组配置文件"></a>增加组配置文件</h3><p>在/etc/security/allow_groups文件中增加内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root</span><br><span class="line">xxlaila</span><br><span class="line">work</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;linux-ssh只允许指定的用户登录&quot;&gt;&lt;a href=&quot;#linux-ssh只允许指定的用户登录&quot; class=&quot;headerlink&quot; title=&quot;linux ssh只允许指定的用户登录&quot;&gt;&lt;/a&gt;linux ssh只允许指定的用户登录&lt;/h3&gt;&lt;p&gt;linux ssh只允许指定的用户登录的方法按大类分有两种，一种是通过pam模块配置，一种是通过sshd配置文件配置，通过pam来进行控制比较好一点，新建用户直接吧用户添加到文件，删除用户直接在文件里面增加。重启sshd就可以。
    
    </summary>
    
      <category term="centos" scheme="https://www.xxlaila.cn/categories/centos/"/>
    
    
      <category term="centos" scheme="https://www.xxlaila.cn/tags/centos/"/>
    
  </entry>
  
  <entry>
    <title>mysql主从和双主</title>
    <link href="https://www.xxlaila.cn/2020/05/11/mysql%E4%B8%BB%E4%BB%8E%E5%92%8C%E5%8F%8C%E4%B8%BB/"/>
    <id>https://www.xxlaila.cn/2020/05/11/mysql主从和双主/</id>
    <published>2020-05-11T05:59:03.000Z</published>
    <updated>2020-05-12T07:21:21.770Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h3 id="mysql-主从"><a href="#mysql-主从" class="headerlink" title="mysql 主从"></a>mysql 主从</h3><p>修改 mysql-master1 的配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">skip-name-resolve</span><br><span class="line">server-id = 1</span><br><span class="line"><span class="built_in">log</span>-bin = mysql-bin</span><br><span class="line">sync_binlog = 1</span><br><span class="line">binlog_checksum = none</span><br><span class="line">binlog_format = mixed</span><br><span class="line"><span class="built_in">log</span>-slave-updates = 1</span><br><span class="line">binlog-ignore-db = mysql</span><br><span class="line">binlog-ignore-db = <span class="built_in">test</span></span><br><span class="line">expire_logs_days = 7</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="参数介绍"><a href="#参数介绍" class="headerlink" title="参数介绍"></a>参数介绍</h3><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>skip-name-resolve</td><td>选项可以禁用dns解析</td></tr><tr><td>server-id</td><td>唯一标识主机，mysql主从每个mysql实例配置都不一样就行。这个值默认是0，如果是0，主服务器拒绝任何从服务器的连接。</td></tr><tr><td>log-bin</td><td>开启二进制日志，该日志是在事务提交时写日志文件的。默认大小是1G，后面加001,002这样的后缀顺加。</td></tr><tr><td>sync_binlog</td><td>表示每次事务提交，MySQL都会把binlog刷下去，是最安全但是性能损耗最大的设置。这样的话，在数据库所在的主机操作系统损坏或者突然掉电的情况下，系统才有可能丢失1个事务的数据。但是binlog虽然是顺序IO，设置为1会影响mysql数据服务器的性能</td></tr><tr><td>binlog_checksum</td><td>不进行校验</td></tr><tr><td>binlog_format</td><td>binlog日志格式</td></tr><tr><td>log-slave-updates</td><td>中继日志执行之后，这些变化是否需要计入自己的binarylog。 当你的B服务器需要作为另外一个服务器的主服务器的时候需要打开。 就是双主互相备份，或者多主循环备份</td></tr><tr><td>binlog-ignore-db</td><td>指定不需要同步的数据库</td></tr><tr><td>expire_logs_days</td><td>binlog日志保持天数</td></tr></tbody></table><h4 id="重启mysql"><a href="#重启mysql" class="headerlink" title="重启mysql"></a>重启mysql</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl  restart mysqld</span><br></pre></td></tr></table></figure><h3 id="创建主从同步"><a href="#创建主从同步" class="headerlink" title="创建主从同步"></a>创建主从同步</h3><p>登录master-1 操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建同步账户</span></span><br><span class="line"><span class="comment"># grant replication slave,replication client on *.* to mysqlsave@'%' identified by '123456';</span></span><br><span class="line">grant replication slave on *.* to xingxing@<span class="string">'172.21.%.%'</span> identified by <span class="string">'123456'</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看下log bin日志和pos值位置</span></span><br><span class="line">flush logs;</span><br><span class="line">show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000002 |      120 |              | mysql,<span class="built_in">test</span>       |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="从服务器同步数据"><a href="#从服务器同步数据" class="headerlink" title="从服务器同步数据"></a>从服务器同步数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=<span class="string">'172.21.17.52'</span>,master_user=<span class="string">'xingxing'</span>,master_password=<span class="string">'123456'</span>,master_log_file=<span class="string">'mysql-bin.000002'</span>,master_log_pos=120; </span><br><span class="line"></span><br><span class="line">start slave;</span><br><span class="line">show slave status\G;</span><br></pre></td></tr></table></figure><h3 id="关闭主从同步"><a href="#关闭主从同步" class="headerlink" title="关闭主从同步"></a>关闭主从同步</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止主从</span></span><br><span class="line">stop slave;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 清除主从同步信息</span></span><br><span class="line"><span class="comment"># 清除binlog 文件名及位置</span></span><br><span class="line">reset slave;  </span><br><span class="line"><span class="comment"># 清除slave 的连接配置信息   </span></span><br><span class="line">reset slave all;</span><br></pre></td></tr></table></figure><h3 id="配置mysql-多主"><a href="#配置mysql-多主" class="headerlink" title="配置mysql 多主"></a>配置mysql 多主</h3><p>前面做了mysql的主从同步，mysql多主就是在相互做同步，需要注意的是每台数据库服务器都可能在同一个表中插入数据，如果表有一个自动增长的主键，那么就会在多服务器上出现主键冲突。在上述的主从配置中增加如下配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master-1 配置</span></span><br><span class="line">skip-name-resolve</span><br><span class="line">server-id = 1</span><br><span class="line"><span class="built_in">log</span>-bin = mysql-bin</span><br><span class="line">sync_binlog = 1</span><br><span class="line">binlog_checksum = none</span><br><span class="line">binlog_format = mixed</span><br><span class="line"><span class="built_in">log</span>-slave-updates = 1</span><br><span class="line">binlog-ignore-db = mysql,<span class="built_in">test</span></span><br><span class="line">expire_logs_days = 7</span><br><span class="line">auto-increment-offset = 1</span><br><span class="line">auto-increment-increment = 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># master-2 配置</span></span><br><span class="line">skip-name-resolve</span><br><span class="line">server-id = 1</span><br><span class="line"><span class="built_in">log</span>-bin = mysql-bin</span><br><span class="line">sync_binlog = 1</span><br><span class="line">binlog_checksum = none</span><br><span class="line">binlog_format = mixed</span><br><span class="line"><span class="built_in">log</span>-slave-updates = 1</span><br><span class="line">binlog-ignore-db = mysql,<span class="built_in">test</span></span><br><span class="line">expire_logs_days = 7</span><br><span class="line">auto-increment-offset = 2</span><br><span class="line">auto-increment-increment = 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">systemctl  restart mysqld</span><br></pre></td></tr></table></figure><h3 id="参数介绍-1"><a href="#参数介绍-1" class="headerlink" title="参数介绍"></a>参数介绍</h3><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>auto-increment-offset</td><td>表示这台服务器的序号，从该值开始</td></tr><tr><td>auto-increment-increment</td><td>服务器的数量</td></tr></tbody></table><h4 id="修改或创建账户授权"><a href="#修改或创建账户授权" class="headerlink" title="修改或创建账户授权"></a>修改或创建账户授权</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有mysql 服务器执行</span></span><br><span class="line">grant replication slave,replication client on *.* to xxlaila@<span class="string">'172.21.%.%'</span> identified by <span class="string">'123456'</span>;</span><br></pre></td></tr></table></figure><h4 id="查看下log-bin日志和pos值位置"><a href="#查看下log-bin日志和pos值位置" class="headerlink" title="查看下log bin日志和pos值位置"></a>查看下log bin日志和pos值位置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master-1</span></span><br><span class="line">show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000004 |      857 |              | mysql,<span class="built_in">test</span>       |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># master-2</span></span><br><span class="line">show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000004 |      351 |              | mysql,<span class="built_in">test</span>       |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br></pre></td></tr></table></figure><h4 id="配置同步"><a href="#配置同步" class="headerlink" title="配置同步"></a>配置同步</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mseter-1 同步操作</span></span><br><span class="line">unlock tables;</span><br><span class="line">stop slave;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 同步master-2</span></span><br><span class="line">change master to master_host=<span class="string">'172.21.16.87'</span>,master_user=<span class="string">'xxlaila'</span>,master_password=<span class="string">'123456'</span>,master_log_file=<span class="string">'mysql-bin.000004'</span>,master_log_pos=351;</span><br><span class="line"></span><br><span class="line">start slave;</span><br><span class="line"><span class="comment">## 查看同步状态，如下出现两个“Yes”，表明同步成功！</span></span><br><span class="line">show slave status \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.21.16.87</span><br><span class="line">                  Master_User: xxlaila</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000004</span><br><span class="line">          Read_Master_Log_Pos: 351</span><br><span class="line">               Relay_Log_File: mysqld-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 279</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000004</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">        ……………………………………………………………………</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">        ……………………………………………………………………</span><br><span class="line"><span class="comment">#master1就和master2实现了主从同步，即master1同步master2的数据。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># master-2 同步操作</span></span><br><span class="line">unlock tables;</span><br><span class="line">stop slave;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 同步master-1</span></span><br><span class="line">change master to master_host=<span class="string">'172.21.17.52'</span>,master_user=<span class="string">'xxlaila'</span>,master_password=<span class="string">'123456'</span>,master_log_file=<span class="string">'mysql-bin.000004'</span>,master_log_pos=857;</span><br><span class="line"></span><br><span class="line">start slave;</span><br><span class="line"><span class="comment">## 查看同步状态，如下出现两个“Yes”，表明同步成功！</span></span><br><span class="line">show slave status \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.21.17.52</span><br><span class="line">                  Master_User: xxlaila</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000004</span><br><span class="line">          Read_Master_Log_Pos: 857</span><br><span class="line">               Relay_Log_File: mysqld-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 279</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000004</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">        …………………………………………………………………………</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">        …………………………………………………………………………</span><br><span class="line"></span><br><span class="line"><span class="comment"># master2就和master1实现了主从同步，即master2也同步master1的数据。</span></span><br></pre></td></tr></table></figure><h3 id="测试同步"><a href="#测试同步" class="headerlink" title="测试同步"></a>测试同步</h3><h4 id="在mster-1"><a href="#在mster-1" class="headerlink" title="在mster-1"></a>在mster-1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数据库</span></span><br><span class="line">create database xxlaila DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建表</span></span><br><span class="line">create table <span class="keyword">if</span> not exists haha (</span><br><span class="line">  id int(10) PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">  name varchar(50) NOT NULL);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入数据</span></span><br><span class="line">insert into haha values(1,<span class="string">"张三"</span>),(2,<span class="string">"李四"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试自增id</span></span><br><span class="line">insert into haha(name) values(<span class="string">"小红"</span>);</span><br><span class="line">insert into haha(name) values(<span class="string">"小花"</span>);</span><br><span class="line"><span class="comment"># 查询数据</span></span><br><span class="line">select * from haha;</span><br><span class="line">+----+--------+</span><br><span class="line">| id | name   |</span><br><span class="line">+----+--------+</span><br><span class="line">|  1 | 张三   |</span><br><span class="line">|  2 | 李四   |</span><br><span class="line">|  3 | 小红   |</span><br><span class="line">|  5 | 小花   |</span><br><span class="line">+----+--------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录master-2数据库，查询数据库是否有数据</span></span><br></pre></td></tr></table></figure><h4 id="master-2-操作"><a href="#master-2-操作" class="headerlink" title="master-2 操作"></a>master-2 操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数据库</span></span><br><span class="line">create database xxlaila1 DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对xxlaila数据库写入新的数据</span></span><br><span class="line">insert into xxlaila.haha values(4,<span class="string">"王五"</span>),(6,<span class="string">"张麻子"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试自增id</span></span><br><span class="line">insert into haha(name) values(<span class="string">"小妹"</span>);</span><br><span class="line">insert into haha(name) values(<span class="string">"小第"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询xxlaila数据库验证数据是否插入和同步</span></span><br><span class="line">select * from haha;</span><br><span class="line">+----+-----------+</span><br><span class="line">| id | name      |</span><br><span class="line">+----+-----------+</span><br><span class="line">|  1 | 张三      |</span><br><span class="line">|  2 | 李四      |</span><br><span class="line">|  3 | 小红      |</span><br><span class="line">|  4 | 王五      |</span><br><span class="line">|  5 | 小花      |</span><br><span class="line">|  6 | 张麻子    |</span><br><span class="line">| 10 | 小妹      |</span><br><span class="line">| 12 | 小第      |</span><br><span class="line">+----+-----------+</span><br></pre></td></tr></table></figure><h3 id="Keepalived-配置"><a href="#Keepalived-配置" class="headerlink" title="Keepalived 配置"></a>Keepalived 配置</h3><p>Keepalived这里不进行阐述</p><h3 id="mysql-高可用"><a href="#mysql-高可用" class="headerlink" title="mysql 高可用"></a>mysql 高可用</h3><p>利用mysql的多主，前方使用haproxy+Keepalived 来代理mysql，这里贴出haproxy里面mysql的配置，完成以后测试停掉一条mysql服务器。插入部分数据，然后在吧停掉的mysql启动，查看数据是否同步。停掉的同时验证是否连接可用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">listen mysql_cluster</span><br><span class="line">    <span class="built_in">bind</span>     0.0.0.0:3306</span><br><span class="line">    mode     tcp</span><br><span class="line">    balance  roundrobin</span><br><span class="line">    option   tcplog</span><br><span class="line">    option   tcpka</span><br><span class="line">    fullconn 10240</span><br><span class="line">    server mysql1 172.21.17.52:3306 check port 3306 maxconn 300</span><br><span class="line">    server mysql2 172.21.16.87:3306 check port 3306 maxconn 300</span><br></pre></td></tr></table></figure><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>插入10000条数据，查看数据库同步状态。最后检查数据是否一致</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">VIP=1.1.1.1</span><br><span class="line">MysqlLogin=<span class="string">"mysql -h<span class="variable">$&#123;VIP&#125;</span> -uzxc -p123456 -P3306"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;=10000;i++))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$&#123;MysqlLogin&#125;</span> -e <span class="string">"insert into xxlaila.haha(name) values('小<span class="variable">$&#123;i&#125;</span>');"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"INSERT HELLO <span class="variable">$i</span>"</span></span><br><span class="line">     i=$((<span class="variable">$i</span>+1))</span><br><span class="line">    sleep 0.05</span><br><span class="line">&#125;&amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">date</span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p><strong>注视:</strong><br>mysql 同步参数<code>binlog-ignore-db</code>这个参数一般我不添加，如果在数据库创建了账号密码，账号密码不同步，在做读写分离，双主切换的时候。高可用的时候，就会显得很麻烦及蛋疼。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;mysql-主从&quot;&gt;&lt;a href=&quot;#mysql-主从&quot; class=&quot;headerlink&quot; title=&quot;mysql 主从&quot;&gt;&lt;/a&gt;mysql 主从&lt;/h3&gt;&lt;p&gt;修改 mysql-master1 的配置&lt;/p&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;skip-name-resolve&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server-id = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;-bin = mysql-bin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sync_binlog = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;binlog_checksum = none&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;binlog_format = mixed&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;-slave-updates = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;binlog-ignore-db = mysql&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;binlog-ignore-db = &lt;span class=&quot;built_in&quot;&gt;test&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;expire_logs_days = 7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://www.xxlaila.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://www.xxlaila.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql5.6yum安装</title>
    <link href="https://www.xxlaila.cn/2020/05/11/mysql5-6yum%E5%AE%89%E8%A3%85/"/>
    <id>https://www.xxlaila.cn/2020/05/11/mysql5-6yum安装/</id>
    <published>2020-05-11T05:57:48.000Z</published>
    <updated>2020-05-12T07:21:21.770Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h3 id="mysql-5-6-版本yum安装"><a href="#mysql-5-6-版本yum安装" class="headerlink" title="mysql 5.6 版本yum安装"></a>mysql 5.6 版本yum安装</h3><h3 id="添加mysql-yum-源"><a href="#添加mysql-yum-源" class="headerlink" title="添加mysql yum 源"></a>添加mysql yum 源</h3><p>到mysql官方下载<a href="https://repo.mysql.com/yum" target="_blank" rel="noopener">mysql源</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install https://repo.mysql.com/yum/mysql-5.6-community/el/6/x86_64/mysql-community-release-el6-5.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="安装-mysql"><a href="#安装-mysql" class="headerlink" title="安装 mysql"></a>安装 mysql</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mysql-community-server  mysql-community-client</span><br></pre></td></tr></table></figure><h4 id="启动mysql"><a href="#启动mysql" class="headerlink" title="启动mysql"></a>启动mysql</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> mysqld.service &amp;&amp;systemctl start mysqld.service &amp;&amp;systemctl status mysqld.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看端口</span></span><br><span class="line">netstat -ntlp|grep <span class="string">"mysqld"</span></span><br></pre></td></tr></table></figure><h3 id="设置mysql密码"><a href="#设置mysql密码" class="headerlink" title="设置mysql密码"></a>设置mysql密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一次登录不需要密码，指定mysql即可</span></span><br><span class="line"><span class="comment"># 更新密码</span></span><br><span class="line"><span class="built_in">set</span> password <span class="keyword">for</span> root@localhost = password(<span class="string">'123456'</span>);</span><br><span class="line">//update user <span class="built_in">set</span> password=password(<span class="string">'123456'</span>) <span class="built_in">where</span> user=<span class="string">'root'</span> and host=<span class="string">'localhost'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除不必要的账户</span></span><br><span class="line">delete from user <span class="built_in">where</span> password=<span class="string">''</span>;</span><br></pre></td></tr></table></figure><h3 id="修改连接数"><a href="#修改连接数" class="headerlink" title="修改连接数"></a>修改连接数</h3><h4 id="命令方式"><a href="#命令方式" class="headerlink" title="命令方式"></a>命令方式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看最大连接数</span></span><br><span class="line">show variables like <span class="string">'%max_connections%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改最大连接数</span></span><br><span class="line"><span class="built_in">set</span> GLOBAL max_connections = 200;</span><br></pre></td></tr></table></figure><h4 id="修改文件方式"><a href="#修改文件方式" class="headerlink" title="修改文件方式"></a>修改文件方式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">max_connections=1000</span><br></pre></td></tr></table></figure><h4 id="mysql连接数不生效"><a href="#mysql连接数不生效" class="headerlink" title="mysql连接数不生效"></a>mysql连接数不生效</h4><p>有时候修改了mysql.cnf 最大连接数不生效。可以在以下文件增加内容。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动文件增加</span></span><br><span class="line">vim /usr/lib/systemd/system/mysqld.service </span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">LimitNPROC=65535</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制用户对系统资源的使用</span></span><br><span class="line">vim /etc/security/limits.conf</span><br><span class="line">*           soft   nofile       655350</span><br><span class="line">*           hard   nofile       655350</span><br><span class="line">*           hard   nproc        655350</span><br><span class="line">*           soft   nproc        655350</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重载mysql</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure><h4 id="mysql-运行状态"><a href="#mysql-运行状态" class="headerlink" title="mysql 运行状态"></a>mysql 运行状态</h4><p>mysql 可以通过运行状态信息进行数据库的优化</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show status;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;mysql-5-6-版本yum安装&quot;&gt;&lt;a href=&quot;#mysql-5-6-版本yum安装&quot; class=&quot;headerlink&quot; title=&quot;mysql 5.6 版本yum安装&quot;&gt;&lt;/a&gt;mysql 5.6 版本yum安装&lt;/h3&gt;&lt;h3 id=&quot;添加mysql-yum-源&quot;&gt;&lt;a href=&quot;#添加mysql-yum-源&quot; class=&quot;headerlink&quot; title=&quot;添加mysql yum 源&quot;&gt;&lt;/a&gt;添加mysql yum 源&lt;/h3&gt;&lt;p&gt;到mysql官方下载&lt;a href=&quot;https://repo.mysql.com/yum&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;mysql源&lt;/a&gt;&lt;/p&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum -y install https://repo.mysql.com/yum/mysql-5.6-community/el/6/x86_64/mysql-community-release-el6-5.noarch.rpm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum clean all&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum makecache&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://www.xxlaila.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://www.xxlaila.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>redis 数据迁移</title>
    <link href="https://www.xxlaila.cn/2020/05/09/redis-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    <id>https://www.xxlaila.cn/2020/05/09/redis-数据迁移/</id>
    <published>2020-05-09T08:47:25.000Z</published>
    <updated>2020-05-12T07:21:21.590Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --><h3 id="redis-数据迁移"><a href="#redis-数据迁移" class="headerlink" title="redis 数据迁移"></a>redis 数据迁移</h3><h3 id="常见redis迁移工具"><a href="#常见redis迁移工具" class="headerlink" title="常见redis迁移工具"></a>常见redis迁移工具</h3><ul><li>redis-dump: redis-dump 是一个将redis数据导入/导出为json格式数据的小工具。</li><li>redis-port : 最初是 codis 项目相关工具，支持实时同步redis 数据到 codis/redis等中。</li><li>redis-migrate-tool： 是唯品会开源的redis数据迁移工具,可用于异构redis集群间的数据在线迁移。</li><li>redis-shake : 是阿里云的redis数据同步的工具。支持redis主从-&gt;redis-cluster，cluster-cluster等多种redis架构的数据同步。<a id="more"></a><blockquote><p><a href="https://github.com/delano/redis-dump" target="_blank" rel="noopener">https://github.com/delano/redis-dump</a><br><a href="https://github.com/CodisLabs/redis-port" target="_blank" rel="noopener">https://github.com/CodisLabs/redis-port</a><br><a href="https://github.com/vipshop/redis-migrate-tool" target="_blank" rel="noopener">https://github.com/vipshop/redis-migrate-tool</a><br><a href="https://github.com/alibaba/RedisShake" target="_blank" rel="noopener">https://github.com/alibaba/RedisShake</a></p></blockquote></li></ul><p>本次迁移主要是用到了<code>redis-shake</code>，本文以<code>redis-shake</code>来重点介绍迁移<code>redis</code>哨兵模式</p><h3 id="Redis-shake"><a href="#Redis-shake" class="headerlink" title="Redis-shake"></a>Redis-shake</h3><p>redis-shake是阿里云自研的开源工具，支持对Redis数据进行解析（decode）、恢复（restore）、备份（dump）、同步（sync/rump）。在sync模式下，redis-shake使用SYNC或PSYNC命令将数据从源端Redis同步到目的端Redis，支持全量数据同步和增量数据同步，增量同步在全量同步完成后自动开始。</p><p><strong>功能介绍:</strong></p><ul><li>备份dump：将源redis的全量数据通过RDB文件备份起来。</li><li>解析decode：对RDB文件进行读取，并以json格式解析存储。</li><li>恢复restore：将RDB文件恢复到目的redis数据库。</li><li>同步sync： 支持源redis和目的redis的数据同步，支持全量和增量数据的迁移。支持单节点、主从版、集群版之间的互相同步。需要注意的是，如果源端是集群版，可以启动一个RedisShake，从不同的db结点进行拉取，同时源端不能开启move slot功能；对于目的端，如果是集群版，写入可以是1个或者多个db结点。</li><li>同步rump：支持源redis和目的redis的数据同步，仅支持全量的迁移。采用scan和restore命令进行迁移，支持不同云厂商不同redis版本的迁移。</li></ul><h3 id="redis-shark安装"><a href="#redis-shark安装" class="headerlink" title="redis-shark安装"></a>redis-shark安装</h3><p><a href="https://github.com/alibaba/RedisShake/releases" target="_blank" rel="noopener">软件下载地址</a> 。软件解压缩后就可使用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装redis-shake</span></span><br><span class="line">wget https://github.com/alibaba/RedisShake/releases/download/release-v2.0.2-20200506/redis-shake-v2.0.2.tar.gz</span><br><span class="line">tar -zxvf redis-shake-v2.0.2.tar.gz</span><br><span class="line">mv redis-shake-v2.0.2 /usr/<span class="built_in">local</span>/redis-shake</span><br><span class="line"></span><br><span class="line"><span class="comment">#环境变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH=$PATH:/usr/local/redis-shake'</span>&gt;&gt;/etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看版本</span></span><br><span class="line">./redis-shake.linux -version</span><br></pre></td></tr></table></figure><h3 id="redis-shake模式介绍"><a href="#redis-shake模式介绍" class="headerlink" title="redis-shake模式介绍"></a>redis-shake模式介绍</h3><ul><li>dump模式 : 将云数据库Redis版实例中的数据备份到RDB文件中。</li><li>decode模式: decode实现对RDB文件进行读取，并以json格式解析存储。</li><li>restore模式: restore模式可将RDB文件恢复到目的redis数据库。</li><li>sync模式: sync模式将某Redis数据迁移至其它Redis集群。</li><li>rump模式: rump模式采用scan和restore命令进行迁移，支持不同云厂商不同redis版本的迁移。</li></ul><p>redis-shake –conf={配置文件地址} –type={模式：sync/dump等} 模式需要与配置文件中的source target对应。模式为sync, restore, dump, decode, rump其中之一，全量+增量同步请选择sync。mac下请使用redis-shake.darwin，windows请用redis-shake.windows</p><h4 id="redis-shake配置"><a href="#redis-shake配置" class="headerlink" title="redis-shake配置"></a>redis-shake配置</h4><blockquote><p>如何进行配置 <a href="https://github.com/alibaba/RedisShake/wiki/" target="_blank" rel="noopener">https://github.com/alibaba/RedisShake/wiki/</a><br>redis-shake迁移 <a href="https://help.aliyun.com/document_detail/111066.html" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/111066.html</a></p></blockquote><h4 id="sync模式参数"><a href="#sync模式参数" class="headerlink" title="sync模式参数"></a>sync模式参数</h4><blockquote><p><a href="https://help.aliyun.com/document_detail/111066.html" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/111066.html</a></p></blockquote><p>在sync模式下，redis-shake使用SYNC或PSYNC命令将数据从源端Redis同步到目的端Redis，支持全量数据同步和增量数据同步，增量同步在全量同步完成后自动开始。</p><h4 id="sync模式参数说明"><a href="#sync模式参数说明" class="headerlink" title="sync模式参数说明"></a>sync模式参数说明</h4><table><thead><tr><th>参数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>source.type</td><td>支持standalone，sentinel，cluster和proxy</td><td>cluster</td></tr><tr><td>source.address</td><td>源Redis的连接地址与服务端口。</td><td>xxx.xxx.1.10:6379</td></tr><tr><td>source.password_raw</td><td>源Redis的连接密码。</td><td>SourcePass233</td></tr><tr><td>target.address</td><td>目的Redis的连接地址与服务端口。</td><td>xx.redis.rds.aliyuncs.com:6379</td></tr><tr><td>target.password_raw</td><td>目的Redis的连接密码。</td><td>TargetPass233</td></tr><tr><td>rewrite</td><td>如果目的Redis有相同的key，是否覆盖，可选值：true（覆盖）；false（不覆盖）。</td><td>默认为true，为false且存在数据冲突则会出现异常提示。</td></tr><tr><td>target.db</td><td>待迁移的数据在目的Redis中的逻辑数据库名。当该值设置为-1时,源Redis和目的Redis中的名称相同</td><td>-1</td></tr><tr><td>parallel</td><td>RDB文件同步中使用的并发线程数，用于提高同步性能。</td><td>最小值为1,推荐值为64。</td></tr></tbody></table><h3 id="执行迁移"><a href="#执行迁移" class="headerlink" title="执行迁移"></a>执行迁移</h3><p>本次使用redis-shake迁移RDB文件内的数据，redis是哨兵模式。使用redis-shake的restore模式将自建Redis的备份文件内的数据迁移到一个自建Redis上。在新的环境搭建一套一样的redis哨兵模式。</p><h4 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; redis-shake.conf&lt;&lt;EOF</span><br><span class="line">source.rdb.input = /opt/redis/data/6379.rdb</span><br><span class="line">target.address = 172.33.66.17:6379</span><br><span class="line">target.password_raw = 123456</span><br><span class="line">target.db = -1</span><br><span class="line">rewrite = <span class="literal">true</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>redis-shake restore模式参数说明</strong></p><table><thead><tr><th>参数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>source.rdb.input</td><td>备份文件（RDB文件）的路径。</td><td>/opt/redis/data/6379.rdb</td></tr><tr><td>target.address</td><td>目的Redis的连接地址与端口号。</td><td>172.33.66.17:6379</td></tr><tr><td>target.password_raw</td><td>目的Redis的连接密码。</td><td>123456</td></tr><tr><td>target.db</td><td>设置待迁移的数据在目的Redis中的逻辑数据库名，默认值为-1。</td><td></td></tr><tr><td>例如，要将所有数据迁移到目的Redis中的DB10，则需将此参数的值设置为10。当该值设置为-1时，逻辑数据库名在源Redis和目的Redis中的名称相同，即源Redis中的DB0将被迁移至目的Redis中的DB0，DB1将被迁移至DB1，以此类推。</td><td>-1</td><td></td></tr><tr><td>rewrite</td><td>如果目的Redis有与RDB文件中相同的key，是否覆盖，可选值：true（覆盖）,false（不覆盖）</td><td>true</td></tr><tr><td>parallel</td><td>RDB文件同步中使用的并发线程数，用于提高同步性能。</td><td>64</td></tr></tbody></table><h4 id="使用如下命令进行迁移"><a href="#使用如下命令进行迁移" class="headerlink" title="使用如下命令进行迁移"></a>使用如下命令进行迁移</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-shake.linux -<span class="built_in">type</span>=restore -conf=redis-shake.conf</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1589023601734.jpg" alt="img"></p><blockquote><p>说明: 日志中出现restore: rdb done表示数据恢复完成，此时按Ctrl+C退出执行即可。</p></blockquote><blockquote><p>参考:<br><a href="https://help.aliyun.com/document_detail/116378.html" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/116378.html</a>?<br><a href="https://mp.weixin.qq.com/s/ae7Lmi-h4AzwO18I-PcfWg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ae7Lmi-h4AzwO18I-PcfWg</a></p></blockquote><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>登录新的redis 服务器，查看keys 是否一致。在登录redis从查看数据是否同步</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;redis-数据迁移&quot;&gt;&lt;a href=&quot;#redis-数据迁移&quot; class=&quot;headerlink&quot; title=&quot;redis 数据迁移&quot;&gt;&lt;/a&gt;redis 数据迁移&lt;/h3&gt;&lt;h3 id=&quot;常见redis迁移工具&quot;&gt;&lt;a href=&quot;#常见redis迁移工具&quot; class=&quot;headerlink&quot; title=&quot;常见redis迁移工具&quot;&gt;&lt;/a&gt;常见redis迁移工具&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;redis-dump: redis-dump 是一个将redis数据导入/导出为json格式数据的小工具。&lt;/li&gt;&lt;li&gt;redis-port : 最初是 codis 项目相关工具，支持实时同步redis 数据到 codis/redis等中。&lt;/li&gt;&lt;li&gt;redis-migrate-tool： 是唯品会开源的redis数据迁移工具,可用于异构redis集群间的数据在线迁移。&lt;/li&gt;&lt;li&gt;redis-shake : 是阿里云的redis数据同步的工具。支持redis主从-&amp;gt;redis-cluster，cluster-cluster等多种redis架构的数据同步。
    
    </summary>
    
      <category term="redis" scheme="https://www.xxlaila.cn/categories/redis/"/>
    
    
      <category term="redis" scheme="https://www.xxlaila.cn/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>mongodb数据还原</title>
    <link href="https://www.xxlaila.cn/2020/05/09/mongodb%E6%95%B0%E6%8D%AE%E8%BF%98%E5%8E%9F/"/>
    <id>https://www.xxlaila.cn/2020/05/09/mongodb数据还原/</id>
    <published>2020-05-09T05:39:40.000Z</published>
    <updated>2020-05-12T07:21:21.750Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h3 id="mongodb-还原"><a href="#mongodb-还原" class="headerlink" title="mongodb 还原"></a>mongodb 还原</h3><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>由于近期公司做数据迁移，从金融云迁移到普通云。涉及到mongodb数据库。数据库有几百G的数据文件。之前mongodb 做的副本集模式。在新环境下mongodb 同样也是做副本集。<a id="more"></a>而且认证的keyfile 也是和之前生产的一模一样。这里为了方便，新搭建的mongodb副本 和之前的用户、密码、keyfile保持一致，不同点在于ip地址。<a href="https://www.xxlaila.cn/2019/08/09/mongodb%E5%89%AF%E6%9C%AC%E9%9B%86/">mongodb副本集安装参考</a>，<a href="https://www.xxlaila.cn/2019/11/14/mongodb%E8%AF%AD%E6%B3%95%E5%AE%9E%E8%B7%B5/">mongodb命令语法及备份参考</a></p><h3 id="还原数据"><a href="#还原数据" class="headerlink" title="还原数据"></a>还原数据</h3><p>把备份的mongodb 文件压缩包拷贝到新副本集的<code>PRIMARY</code>节点。然后解压缩</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongorestore -h <span class="string">"xxlaila01/172.30.66.4:27017,172.30.66.49:27017,172.30.66.47:27017"</span> -u<span class="string">'systemprod'</span> -p<span class="string">'123456'</span> --oplogReplay /data/20200509_082001/</span><br></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>登录<code>SECONDARY</code>节点验证是否有数据库同步。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;mongodb-还原&quot;&gt;&lt;a href=&quot;#mongodb-还原&quot; class=&quot;headerlink&quot; title=&quot;mongodb 还原&quot;&gt;&lt;/a&gt;mongodb 还原&lt;/h3&gt;&lt;h3 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h3&gt;&lt;p&gt;由于近期公司做数据迁移，从金融云迁移到普通云。涉及到mongodb数据库。数据库有几百G的数据文件。之前mongodb 做的副本集模式。在新环境下mongodb 同样也是做副本集。
    
    </summary>
    
      <category term="mongodb" scheme="https://www.xxlaila.cn/categories/mongodb/"/>
    
    
      <category term="mongodb" scheme="https://www.xxlaila.cn/tags/mongodb/"/>
    
  </entry>
  
  <entry>
    <title>elasticsearch数据迁移</title>
    <link href="https://www.xxlaila.cn/2020/05/07/elasticsearch%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    <id>https://www.xxlaila.cn/2020/05/07/elasticsearch数据迁移/</id>
    <published>2020-05-07T10:08:12.000Z</published>
    <updated>2020-05-12T07:21:21.830Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h3 id="elasticsearch数据迁移"><a href="#elasticsearch数据迁移" class="headerlink" title="elasticsearch数据迁移"></a>elasticsearch数据迁移</h3><h3 id="迁移原因"><a href="#迁移原因" class="headerlink" title="迁移原因"></a>迁移原因</h3><p>公司从金融云迁移到普通云，需要吧elasticsearch的数据迁移到普通云来，elasticsearch的版本一致。ik分词，集群都提前做好</p><h3 id="迁移方式"><a href="#迁移方式" class="headerlink" title="迁移方式"></a>迁移方式</h3><p>第三方工具迁移或elasticsearch本身快照方式迁移，elasticsearch快照方式迁移需要对原有的es进行配置和重启。这里采用的是第三方工具进行迁移<code>Elaticsearch-dump</code>，<code>Elaticsearch-dump</code><a href="https://github.com/taskrabbit/elasticsearch-dump" target="_blank" rel="noopener">github地址</a></p><a id="more"></a><h3 id="elaticsearch-dump-安装"><a href="#elaticsearch-dump-安装" class="headerlink" title="elaticsearch-dump 安装"></a>elaticsearch-dump 安装</h3><h4 id="安装nodejs"><a href="#安装nodejs" class="headerlink" title="安装nodejs"></a>安装nodejs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">wget https://nodejs.org/dist/v12.16.3/node-v12.16.3-linux-x64.tar.xz</span><br><span class="line">tar xf node-v12.16.3-linux-x64.tar.xz</span><br><span class="line">mv node-v12.16.3-linux-x64 node</span><br><span class="line">NODE_HOME=<span class="string">"/opt/node"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export NODE_HOME=/opt/node"</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export PATH=<span class="variable">$&#123;NODE_HOME&#125;</span>/bin:<span class="variable">$PATH</span>"</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><h4 id="安装elasticdump"><a href="#安装elasticdump" class="headerlink" title="安装elasticdump"></a>安装elasticdump</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#全局安装</span></span><br><span class="line"><span class="attr">npm</span> <span class="string">install elasticdump -g  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看帮助   </span></span><br><span class="line"><span class="attr">elasticdump</span> <span class="string">--help</span></span><br></pre></td></tr></table></figure><h3 id="elasticsearch-索引数据"><a href="#elasticsearch-索引数据" class="headerlink" title="elasticsearch 索引数据"></a>elasticsearch 索引数据</h3><p>记录待迁移elasticsearch 索引数据内容和数据总量，以便迁移后核对</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://ip:9200/_cat/indices?v</span><br></pre></td></tr></table></figure><h3 id="索引迁移"><a href="#索引迁移" class="headerlink" title="索引迁移"></a>索引迁移</h3><h4 id="索引导出"><a href="#索引导出" class="headerlink" title="索引导出"></a>索引导出</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticdump --input=http://旧es_ip:9200/索引名称  --output=/opt/es/索引名称.index.json --<span class="built_in">type</span>=data</span><br></pre></td></tr></table></figure><h4 id="索引导入"><a href="#索引导入" class="headerlink" title="索引导入"></a>索引导入</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticdump --input=/opt/es/索引名称.index.json --output=http://新es_ip:9200</span><br></pre></td></tr></table></figure><h4 id="导出导入设置"><a href="#导出导入设置" class="headerlink" title="导出导入设置"></a>导出导入设置</h4><p>导入导出时会显示 每次操作的 object数据（默认为100），如果调大，设置–limit参数既可</p><h4 id="直接从源es到迁移到新的es"><a href="#直接从源es到迁移到新的es" class="headerlink" title="直接从源es到迁移到新的es"></a>直接从源es到迁移到新的es</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拷贝analyzer分词</span></span><br><span class="line">elasticdump --input=http://127.0.0.1:9200/my_index --output=http://127.0.0.1:9200/my_index --<span class="built_in">type</span>=analyzer</span><br><span class="line"><span class="comment"># 备份 mapping</span></span><br><span class="line">elasticdump --input=<span class="string">"http://127.0.0.1:9200/my_index"</span> --output=<span class="string">"http://127.0.0.1:9200/my_index"</span> --<span class="built_in">type</span>=mapping</span><br><span class="line"><span class="comment"># 备份数据</span></span><br><span class="line">elasticdump --input=<span class="string">"http://127.0.0.1:9200/my_index"</span> --output=<span class="string">"http://127.0.0.1:9200/my_index"</span> --<span class="built_in">type</span>=data</span><br></pre></td></tr></table></figure><p><strong>注意:</strong> elasticdump 提供给了–httpAuthFile 参数来做认证</p><blockquote><p>–httpAuthFile When using http auth provide credentials in ini file in form<br><code>user=&lt;username&gt; password=&lt;password&gt;</code><br>只需要写一个ini文件 ，文件中写入用户名和密码就可以了<br>这里其实还有另外一个好的方法<br>在–input参数和–output参数的的url中添加账号密码</p></blockquote><p><strong>例如:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elasticdump \</span><br><span class="line">  --input=http://prod-username:prod-passowrd@127.0.0.1:9200/my_index \</span><br><span class="line">  --output=http://putong-username:putong-password@127.0.0.1:9200/my_index \</span><br><span class="line">  --<span class="built_in">type</span>=data</span><br></pre></td></tr></table></figure><h3 id="数据比对"><a href="#数据比对" class="headerlink" title="数据比对"></a>数据比对</h3><p>数据对比方法，使用shell命令diff比较</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 老数据</span></span><br><span class="line">curl -s http://127.0.0.1:9200/_cat/indices | awk <span class="string">'&#123;print $3,$7&#125;'</span> |sort -nr &gt; es1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新数据</span></span><br><span class="line">curl -s http://127.0.0.1:9200/_cat/indices  | awk <span class="string">'&#123;print $3,$7&#125;'</span> | sort -nr &gt; es2.txt</span><br></pre></td></tr></table></figure><h3 id="迁移测试实战"><a href="#迁移测试实战" class="headerlink" title="迁移测试实战"></a>迁移测试实战</h3><p>一个es集群里面不止一个索引，为了方便这里写了一个脚本进行导出数据和导入数据</p><h4 id="直接迁移"><a href="#直接迁移" class="headerlink" title="直接迁移"></a>直接迁移</h4><p>直接迁移是从源es到迁移到新的es，适用于网络较好，数据量不大的场景</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Function: Elasticsearch data migration</span></span><br><span class="line"><span class="comment"># date: 2020-05-07</span></span><br><span class="line"><span class="comment"># Author: xxlaila</span></span><br><span class="line"></span><br><span class="line">ES_Old=<span class="string">"http://172.16.1.3:9200"</span></span><br><span class="line">ED_New=<span class="string">"http://172.25.1.5:9200"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">sleeps</span></span>()&#123;</span><br><span class="line">  sleep 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">INDEXS=`curl -s -XGET <span class="variable">$&#123;ES_Old&#125;</span>/_cat/indices?h=i`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> <span class="variable">$&#123;INDEXS&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment"># settings, analyzer, data, mapping, alias, template</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31melasticdump --input=<span class="variable">$&#123;ES_Old&#125;</span>/<span class="variable">$&#123;index&#125;</span> --output=<span class="variable">$&#123;ED_New&#125;</span>/<span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  <span class="comment">#echo -e "\033[31m拷贝settings: $&#123;index&#125;\033[0m\n"</span></span><br><span class="line">  <span class="comment">#elasticdump --input=$&#123;ES_Old&#125;/$&#123;index&#125; --output=$&#123;ED_New&#125;/$&#123;index&#125; --limit=10000 --type=settings</span></span><br><span class="line">  <span class="comment">#sleeps</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31m拷贝analyzer分词：<span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  elasticdump --input=<span class="variable">$&#123;ES_Old&#125;</span>/<span class="variable">$&#123;index&#125;</span> --output=<span class="variable">$&#123;ED_New&#125;</span>/<span class="variable">$&#123;index&#125;</span> --<span class="built_in">limit</span>=10000 --<span class="built_in">type</span>=analyzer  --<span class="built_in">limit</span>=500</span><br><span class="line">  sleeps</span><br><span class="line">  <span class="comment">#echo -e "\033[31m拷贝alias：$&#123;index&#125;\033[0m\n"</span></span><br><span class="line">  <span class="comment">#elasticdump --input=$&#123;ES_Old&#125;/$&#123;index&#125; --output=$&#123;ED_New&#125;/$&#123;index&#125; --limit=10000 --type=alias </span></span><br><span class="line">  <span class="comment">#sleeps</span></span><br><span class="line">  <span class="comment">#echo -e "\033[31m拷贝template：$&#123;index&#125;\033[0m\n"</span></span><br><span class="line">  <span class="comment">#elasticdump --input=$&#123;ES_Old&#125;/$&#123;index&#125; --output=$&#123;ED_New&#125;/$&#123;index&#125; --limit=10000 --type=template </span></span><br><span class="line">  <span class="comment">#sleeps</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31m拷贝映射：<span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  elasticdump --input=<span class="variable">$&#123;ES_Old&#125;</span>/<span class="variable">$&#123;index&#125;</span> --output=<span class="variable">$&#123;ED_New&#125;</span>/<span class="variable">$&#123;index&#125;</span> --<span class="built_in">type</span>=mapping --<span class="built_in">limit</span>=3000</span><br><span class="line">  sleeps</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31m拷贝数据：<span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  elasticdump --input=<span class="variable">$&#123;ES_Old&#125;</span>/<span class="variable">$&#123;index&#125;</span> --output=<span class="variable">$&#123;ED_New&#125;</span>/<span class="variable">$&#123;index&#125;</span> --<span class="built_in">type</span>=data --<span class="built_in">limit</span>=3000</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\n"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="文件迁移"><a href="#文件迁移" class="headerlink" title="文件迁移"></a>文件迁移</h4><p>文件迁移是吧数据导出为文件，然后吧文件复制到新的es集群，通过文件的方式进行恢复。适用于数据量大。网络不好。这里导出没有进行数据压缩</p><h4 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;es_backup.sh&lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Function: Elasticsearch data migration</span></span><br><span class="line"><span class="comment"># date: 2020-05-07</span></span><br><span class="line"><span class="comment"># Author: xxlaila</span></span><br><span class="line"></span><br><span class="line">mkdir -p /opt/es</span><br><span class="line"></span><br><span class="line">IP=`ifconfig |sed -n 2p |awk <span class="string">'&#123;print $1$2&#125;'</span>|sed <span class="string">'s/^.*[^0-9]\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)$/\1\.\2\.\3\.\4/g'</span>`</span><br><span class="line">NEW_IP=<span class="string">"172.33.66.9"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#INDEXS=`curl http://$&#123;IP&#125;:9200/_cat/indices|grep "green"|awk '&#123;print $3&#125;'`</span></span><br><span class="line">INDEXS=`curl -s -XGET http://<span class="variable">$&#123;IP&#125;</span>:9200/_cat/indices?h=i`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> <span class="variable">$&#123;INDEXS&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31m拷贝analyzer分词：<span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  elasticdump --input=http://<span class="variable">$&#123;IP&#125;</span>:9200/<span class="variable">$&#123;index&#125;</span> --output=/opt/es/<span class="variable">$&#123;index&#125;</span>_analyzer.json --<span class="built_in">type</span>=analyzer --<span class="built_in">limit</span>=500</span><br><span class="line">  sleep 3</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31m拷贝映射：<span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  elasticdump --input=http://<span class="variable">$&#123;IP&#125;</span>:9200/<span class="variable">$&#123;index&#125;</span> --output=/opt/es/<span class="variable">$&#123;index&#125;</span>_mapping.json --<span class="built_in">type</span>=mapping --<span class="built_in">limit</span>=500</span><br><span class="line">  sleep 3</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31m拷贝数据：<span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  elasticdump --input=http://<span class="variable">$&#123;IP&#125;</span>:9200/<span class="variable">$&#123;index&#125;</span> --output=/opt/es/<span class="variable">$&#123;index&#125;</span>_data.json --<span class="built_in">type</span>=data --<span class="built_in">limit</span>=10000 --concurrency=2</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">tar zcvf es_backup.tar.gz -C /opt es</span><br><span class="line">scp -r es_backup.tar.gz user@<span class="variable">$&#123;NEW_IP&#125;</span>:/home/user/</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; es_restore.sh&lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Function: Elasticsearch data restore</span></span><br><span class="line"><span class="comment"># date: 2020-05-08</span></span><br><span class="line"><span class="comment"># Author: xxlaila</span></span><br><span class="line"></span><br><span class="line">tar zxf es_backup.tar.gz</span><br><span class="line"></span><br><span class="line">INDEXS=`ls es/|grep <span class="string">"analyzer"</span>|awk -F<span class="string">"_"</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="comment"># analyzer restore</span></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> <span class="variable">$&#123;INDEXS&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$&#123;index&#125;</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31m恢复分词analyzer: <span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  elasticdump --input=`<span class="built_in">pwd</span>`/es/<span class="variable">$&#123;index&#125;</span>_analyzer.json --output=http://127.0.0.1:9200/<span class="variable">$&#123;index&#125;</span> --<span class="built_in">type</span>=analyzer -<span class="built_in">limit</span>=10000</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31m恢复mapping: <span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  elasticdump --input=`<span class="built_in">pwd</span>`/es/<span class="variable">$&#123;index&#125;</span>_mapping.json --output=http://127.0.0.1:9200/<span class="variable">$&#123;index&#125;</span> --<span class="built_in">type</span>=mapping -<span class="built_in">limit</span>=10000</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31m恢复数据data: <span class="variable">$&#123;index&#125;</span>\033[0m\n"</span></span><br><span class="line">  elasticdump --input=`<span class="built_in">pwd</span>`/es/<span class="variable">$&#123;index&#125;</span>_data.json --output=http://127.0.0.1:9200/<span class="variable">$&#123;index&#125;</span> --<span class="built_in">type</span>=data --<span class="built_in">limit</span>=10000 --concurrency=20</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="数据切割备份和恢复"><a href="#数据切割备份和恢复" class="headerlink" title="数据切割备份和恢复"></a>数据切割备份和恢复</h3><p>如果使用上述方式恢复失败，可以采用对数据进行切割的方式进行备份和恢复。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份数据，切割为100M的文件</span></span><br><span class="line">elasticdump --input=http://172.16.32.30:9200/hooklogs --output=es/hooklogs_data.json --fileSize=100mb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标服务器恢复</span></span><br><span class="line">file=`ls -ltrh|awk <span class="string">'&#123;print $NF&#125;'</span>|awk <span class="string">'NR&gt;1'</span>`</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;file&#125;</span>;<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$&#123;i&#125;</span>; elasticdump --input=./<span class="variable">$&#123;i&#125;</span> --output=http://127.0.0.1:9200/hooklogs --<span class="built_in">type</span>=data --<span class="built_in">limit</span>=500;<span class="keyword">done</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;elasticsearch数据迁移&quot;&gt;&lt;a href=&quot;#elasticsearch数据迁移&quot; class=&quot;headerlink&quot; title=&quot;elasticsearch数据迁移&quot;&gt;&lt;/a&gt;elasticsearch数据迁移&lt;/h3&gt;&lt;h3 id=&quot;迁移原因&quot;&gt;&lt;a href=&quot;#迁移原因&quot; class=&quot;headerlink&quot; title=&quot;迁移原因&quot;&gt;&lt;/a&gt;迁移原因&lt;/h3&gt;&lt;p&gt;公司从金融云迁移到普通云，需要吧elasticsearch的数据迁移到普通云来，elasticsearch的版本一致。ik分词，集群都提前做好&lt;/p&gt;&lt;h3 id=&quot;迁移方式&quot;&gt;&lt;a href=&quot;#迁移方式&quot; class=&quot;headerlink&quot; title=&quot;迁移方式&quot;&gt;&lt;/a&gt;迁移方式&lt;/h3&gt;&lt;p&gt;第三方工具迁移或elasticsearch本身快照方式迁移，elasticsearch快照方式迁移需要对原有的es进行配置和重启。这里采用的是第三方工具进行迁移&lt;code&gt;Elaticsearch-dump&lt;/code&gt;，&lt;code&gt;Elaticsearch-dump&lt;/code&gt;&lt;a href=&quot;https://github.com/taskrabbit/elasticsearch-dump&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;github地址&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="elasticsearch" scheme="https://www.xxlaila.cn/categories/elasticsearch/"/>
    
    
      <category term="elasticsearch" scheme="https://www.xxlaila.cn/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>etcd备份与恢复</title>
    <link href="https://www.xxlaila.cn/2020/04/13/etcd%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"/>
    <id>https://www.xxlaila.cn/2020/04/13/etcd备份与恢复/</id>
    <published>2020-04-13T02:35:48.000Z</published>
    <updated>2020-06-07T02:25:50.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 10:25:54 GMT+0800 (GMT+08:00) --><h3 id="ETCD-存储-k8s-所有数据信息"><a href="#ETCD-存储-k8s-所有数据信息" class="headerlink" title="ETCD 存储 k8s 所有数据信息"></a>ETCD 存储 k8s 所有数据信息</h3><p>ETCD 是k8s集群极为重要的一块服务，存储了集群所有的数据信息。同理，如果发生灾难或者 etcd 的数据丢失，都会影响集群数据的恢复，k8s中只用kube-apiserver和etcd进行数据交互。etcdctl版本: 3.3.18，kubernetes: v1.17.3。均采用二进制安装</p><a id="more"></a><h3 id="ETCD-一些查询操作"><a href="#ETCD-一些查询操作" class="headerlink" title="ETCD 一些查询操作"></a>ETCD 一些查询操作</h3><ul><li><p>查看集群状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 endpoint health</span><br><span class="line"></span><br><span class="line">https://172.21.16.204:2379 is healthy: successfully committed proposal: took = 15.614765ms</span><br><span class="line">https://172.21.17.32:2379 is healthy: successfully committed proposal: took = 40.200694ms</span><br><span class="line">https://172.21.17.18:2379 is healthy: successfully committed proposal: took = 230.022141ms</span><br></pre></td></tr></table></figure></li><li><p>获取某个 key 信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 get /registry/apiregistration.k8s.io/apiservices/v1.apps</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"kind"</span>:<span class="string">"APIService"</span>,<span class="string">"apiVersion"</span>:<span class="string">"apiregistration.k8s.io/v1beta1"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"name"</span>:<span class="string">"v1.apps"</span>,<span class="string">"uid"</span>:<span class="string">"5790ef34-84c1-432e-8ed8-4fe842c43dfe"</span>,<span class="string">"creationTimestamp"</span>:<span class="string">"2020-03-26T07:46:37Z"</span>,<span class="string">"labels"</span>:&#123;<span class="string">"kube-aggregator.kubernetes.io/automanaged"</span>:<span class="string">"onstart"</span>&#125;&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"service"</span>:null,<span class="string">"group"</span>:<span class="string">"apps"</span>,<span class="string">"version"</span>:<span class="string">"v1"</span>,<span class="string">"groupPriorityMinimum"</span>:17800,<span class="string">"versionPriority"</span>:15&#125;,<span class="string">"status"</span>:&#123;<span class="string">"conditions"</span>:[&#123;<span class="string">"type"</span>:<span class="string">"Available"</span>,<span class="string">"status"</span>:<span class="string">"True"</span>,<span class="string">"lastTransitionTime"</span>:<span class="string">"2020-03-26T07:46:37Z"</span>,<span class="string">"reason"</span>:<span class="string">"Local"</span>,<span class="string">"message"</span>:<span class="string">"Local APIServices are always available"</span>&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>获取 etcd 版本信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 version</span><br><span class="line"></span><br><span class="line">etcdctl version: 3.3.18</span><br><span class="line">API version: 3.3</span><br></pre></td></tr></table></figure></li><li><p>获取 ETCD 所有的 key</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 get / --prefix --keys-only</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据很多</span></span><br><span class="line">………………</span><br></pre></td></tr></table></figure></li></ul><h2 id="etcd-备份"><a href="#etcd-备份" class="headerlink" title="etcd 备份"></a>etcd 备份</h2><p>在其中一台服务器操作即可</p><h3 id="命令备份"><a href="#命令备份" class="headerlink" title="命令备份"></a>命令备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ENDPOINTS=<span class="string">"https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379"</span></span><br><span class="line">CACERT=<span class="string">"/etc/kubernetes/cert/ca.pem"</span></span><br><span class="line">CERT=<span class="string">"/etc/etcd/cert/etcd.pem"</span></span><br><span class="line">KEY=<span class="string">"/etc/etcd/cert/etcd-key.pem"</span></span><br><span class="line">DATE=`date +%Y%m%d-%H%M%S`</span><br><span class="line">BACKUP_DIR=<span class="string">"/opt/etcd_backup"</span></span><br><span class="line">/usr/bin/etcdctl --cacert=<span class="variable">$&#123;CACERT&#125;</span> --cert=<span class="variable">$&#123;CERT&#125;</span> --key=<span class="variable">$&#123;KEY&#125;</span>  --endpoints=<span class="string">"<span class="variable">$&#123;ENDPOINTS&#125;</span>"</span> snapshot save <span class="variable">$&#123;BACKUP_DIR&#125;</span>/mysnapshot-<span class="variable">$&#123;DATE&#125;</span>.db</span><br></pre></td></tr></table></figure><h3 id="脚本进行备份"><a href="#脚本进行备份" class="headerlink" title="脚本进行备份"></a>脚本进行备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;etcd-back.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 使用v3 版本进行备份，保留10分数据。加入定时任务，没半小时执行一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd vars</span></span><br><span class="line">ENDPOINTS=<span class="string">"https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379"</span></span><br><span class="line">CACERT=<span class="string">"/etc/kubernetes/cert/ca.pem"</span></span><br><span class="line">CERT=<span class="string">"/etc/etcd/cert/etcd.pem"</span></span><br><span class="line">KEY=<span class="string">"/etc/etcd/cert/etcd-key.pem"</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># time</span></span><br><span class="line">DATE=`date +%Y%m%d-%H%M%S`</span><br><span class="line"></span><br><span class="line"><span class="comment"># backup dir</span></span><br><span class="line">BACKUP_DIR=<span class="string">"/opt/etcd_backup"</span></span><br><span class="line"></span><br><span class="line">[ ! -d <span class="variable">$&#123;BACKUP_DIR&#125;</span> ] &amp;&amp; mkdir -p <span class="variable">$&#123;BACKUP_DIR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># exec backup</span></span><br><span class="line">/usr/bin/etcdctl --cacert=<span class="variable">$&#123;CACERT&#125;</span> --cert=<span class="variable">$&#123;CERT&#125;</span> --key=<span class="variable">$&#123;KEY&#125;</span>  --endpoints=<span class="string">"<span class="variable">$&#123;ENDPOINTS&#125;</span>"</span> snapshot save <span class="variable">$&#123;BACKUP_DIR&#125;</span>/mysnapshot-<span class="variable">$&#123;DATE&#125;</span>.db</span><br><span class="line"></span><br><span class="line"><span class="comment"># save 10</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_DIR&#125;</span></span><br><span class="line">ls -lt <span class="variable">$&#123;BACKUP_DIR&#125;</span>/*.db|awk <span class="string">'&#123;if(NR&gt;11)&#123;print "rm -rf "$9&#125;&#125;'</span>|sh</span><br></pre></td></tr></table></figure><h2 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul><li><p>停止所有 Master 上 kube-apiserver 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop kube-apiserver</span><br><span class="line"></span><br><span class="line">ps -ef | grep kube-apiserver</span><br></pre></td></tr></table></figure></li><li><p>停止集群中所有 ETCD 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop etcd</span><br><span class="line"></span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure></li></ul><h3 id="移除所有-ETCD-存储目录下数据"><a href="#移除所有-ETCD-存储目录下数据" class="headerlink" title="移除所有 ETCD 存储目录下数据"></a>移除所有 ETCD 存储目录下数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/etcd_backup/&#123;data,wal&#125;</span><br><span class="line">mv /var/lib/etcd/data /tmp/etcd_backup/data</span><br><span class="line">mv /var/lib/etcd/wal  /tmp/etcd_backup/wal</span><br></pre></td></tr></table></figure><h3 id="拷贝-ETCD-备份快照"><a href="#拷贝-ETCD-备份快照" class="headerlink" title="拷贝 ETCD 备份快照"></a>拷贝 ETCD 备份快照</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在备份的服务器上拷贝</span></span><br><span class="line">scp -r /opt/etcd_backup/mysnapshot-20200413-090001.db 172.21.17.32:/root/</span><br><span class="line">scp -r /opt/etcd_backup/mysnapshot-20200413-090001.db 172.21.17.18:/root/</span><br></pre></td></tr></table></figure><h3 id="恢复备份"><a href="#恢复备份" class="headerlink" title="恢复备份"></a>恢复备份</h3><p>这里<code>etcd</code>的数据和日志文件是分开存放的，所以在恢复的时候需要分别制定相应的目录。<code>/var/lib/ecd</code>移除下面的<code>data,wal</code>目录以后，在恢复的时候会自动的创建。不需要手动创建</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s-master01 机器上操作</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore /root/mysnapshot-20200413-090001.db   --name etcd01   --initial-cluster <span class="string">"etcd01=https://172.21.17.32:2380,etcd02=https://172.21.17.18:2380,etcd03=https://172.21.16.204:2380"</span>   --initial-cluster-token k8s-etcd-cluster   --initial-advertise-peer-urls https://172.21.17.32:2380   --data-dir=/var/lib/etcd/data --wal-dir=/var/lib/etcd/wal</span><br><span class="line"></span><br><span class="line"><span class="comment"># k8s-master02 机器上操作</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore /root/mysnapshot-20200413-090001.db   --name etcd02   --initial-cluster <span class="string">"etcd01=https://172.21.17.32:2380,etcd02=https://172.21.17.18:2380,etcd03=https://172.21.16.204:2380"</span>   --initial-cluster-token k8s-etcd-cluster   --initial-advertise-peer-urls https://172.21.17.18:2380   --data-dir=/var/lib/etcd/data --wal-dir=/var/lib/etcd/wal</span><br><span class="line"></span><br><span class="line"><span class="comment"># k8s-master03 机器上操作</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore /root/mysnapshot-20200413-090001.db   --name etcd03   --initial-cluster <span class="string">"etcd01=https://172.21.17.32:2380,etcd02=https://172.21.17.18:2380,etcd03=https://172.21.16.204:2380"</span>   --initial-cluster-token k8s-etcd-cluster   --initial-advertise-peer-urls https://172.21.16.204:2380   --data-dir=/var/lib/etcd/data --wal-dir=/var/lib/etcd/wal</span><br></pre></td></tr></table></figure><h3 id="启动和检查etcd"><a href="#启动和检查etcd" class="headerlink" title="启动和检查etcd"></a>启动和检查etcd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 三台 ETCD 都恢复完成后，依次登陆三台机器启动 ETCD</span></span><br><span class="line"></span><br><span class="line">systemctl start etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 三台 ETCD 启动完成，检查 ETCD 集群状态</span></span><br><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 endpoint health</span><br><span class="line">https://172.21.16.204:2379 is healthy: successfully committed proposal: took = 34.77035ms</span><br><span class="line">https://172.21.17.32:2379 is healthy: successfully committed proposal: took = 35.320698ms</span><br><span class="line">https://172.21.17.18:2379 is healthy: successfully committed proposal: took = 77.081728ms</span><br></pre></td></tr></table></figure><h3 id="启动kube-apiserver"><a href="#启动kube-apiserver" class="headerlink" title="启动kube-apiserver"></a>启动kube-apiserver</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ETCD 全部健康，分别到每台 Master 启动 kube-apiserver</span></span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Kubernetes 集群是否恢复正常</span></span><br><span class="line">kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Kubernetes 集群备份主要是备份 ETCD 集群。而恢复时，主要考虑恢复整个顺序：<br><code>停止kube-apiserver --&gt; 停止ETCD --&gt; 恢复数据 --&gt; 启动ETCD --&gt; 启动kube-apiserve</code></p><ul><li>注意：备份ETCD集群时，只需要备份一个ETCD就行，恢复时，拿同一份备份数据恢复。</li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 10:25:54 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;ETCD-存储-k8s-所有数据信息&quot;&gt;&lt;a href=&quot;#ETCD-存储-k8s-所有数据信息&quot; class=&quot;headerlink&quot; title=&quot;ETCD 存储 k8s 所有数据信息&quot;&gt;&lt;/a&gt;ETCD 存储 k8s 所有数据信息&lt;/h3&gt;&lt;p&gt;ETCD 是k8s集群极为重要的一块服务，存储了集群所有的数据信息。同理，如果发生灾难或者 etcd 的数据丢失，都会影响集群数据的恢复，k8s中只用kube-apiserver和etcd进行数据交互。etcdctl版本: 3.3.18，kubernetes: v1.17.3。均采用二进制安装&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="https://www.xxlaila.cn/categories/kubernetes/"/>
    
    
      <category term="etcd" scheme="https://www.xxlaila.cn/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>Prometheus监控应用</title>
    <link href="https://www.xxlaila.cn/2020/04/12/Prometheus%E7%9B%91%E6%8E%A7%E5%BA%94%E7%94%A8/"/>
    <id>https://www.xxlaila.cn/2020/04/12/Prometheus监控应用/</id>
    <published>2020-04-12T04:47:44.000Z</published>
    <updated>2020-05-12T07:21:21.730Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h2 id="Prometheus-应用"><a href="#Prometheus-应用" class="headerlink" title="Prometheus 应用"></a>Prometheus 应用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Prometheus的单机安装比较简单，这里采用的是单机进行安装。<a href="https://prometheus.io/download/" target="_blank" rel="noopener">Prometheus</a>的相关插件下载地址</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载Prometheus</span></span><br><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.17.1/prometheus-2.17.1.linux-amd64.tar.gz</span><br><span class="line">tar zxc prometheus-2.17.1.linux-amd64.tar.gz &amp;&amp; mv prometheus-2.17.1.linux-amd64 /opt/prometheus</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建prometheus 数据存放目录</span></span><br><span class="line">mkdir -p /opt/prometheus/data</span><br></pre></td></tr></table></figure><h4 id="创建prometheus启动文件"><a href="#创建prometheus启动文件" class="headerlink" title="创建prometheus启动文件"></a>创建prometheus启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/prometheus.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus</span><br><span class="line">Documentation=https://prometheus.io/docs</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml --storage.tsdb.path=/opt/prometheus/data</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动prometheus</span></span><br><span class="line">systemctl  restart prometheus.service &amp;&amp;systemctl  status prometheus.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认端口9090</span></span><br></pre></td></tr></table></figure><h3 id="部署node-exporter"><a href="#部署node-exporter" class="headerlink" title="部署node_exporter"></a>部署node_exporter</h3><p>主要用来监控服务器的基础信息，如: cpu、内存、磁盘、网卡。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载node_exporter</span></span><br><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.0.0-rc.0/node_exporter-1.0.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">tar node_exporter-1.0.0-rc.0.linux-amd64.tar.gz &amp;&amp; mv node_exporter-1.0.0-rc.0.linux-amd64/node_exporter /usr/bin/ &amp;&amp; rm -rf node_exporter-1.0.0-rc.0.linux-amd64*</span><br></pre></td></tr></table></figure><h3 id="设置node-exporter开机启动"><a href="#设置node-exporter开机启动" class="headerlink" title="设置node_exporter开机启动"></a>设置node_exporter开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/node_exporter.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">Documentation=https://prometheus.io/docs</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/bin/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 node_exporter</span></span><br><span class="line">systemctl  start node_exporter.service &amp;&amp; systemctl status node_exporter.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认端口9100</span></span><br></pre></td></tr></table></figure><h3 id="安装mysql-exporter"><a href="#安装mysql-exporter" class="headerlink" title="安装mysql_exporter"></a>安装mysql_exporter</h3><p>主要监控mysql数据库的信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载mysql_exporter</span></span><br><span class="line">wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.12.1/mysqld_exporter-0.12.1.linux-amd64.tar.gz</span><br><span class="line">&amp;&amp; tar zxf mysqld_exporter-0.12.1.linux-amd64.tar.gz &amp;&amp; mv mysqld_exporter-0.12.1.linux-amd64/mysqld_exporter &amp;&amp; rm -rf mysqld_exporter-0.12.1.linux-amd64*</span><br></pre></td></tr></table></figure><h4 id="创建msql的连接权限"><a href="#创建msql的连接权限" class="headerlink" title="创建msql的连接权限"></a>创建msql的连接权限</h4><p>mysqld_exporter需要连接Mysql，首先为它创建用户并赋予所需要的权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GRANT REPLICATION CLIENT, PROCESS ON . TO <span class="string">'exporter'</span>@<span class="string">'localhost'</span> identified by <span class="string">'123456'</span>;</span><br><span class="line">GRANT SELECT ON performance_schema.* TO <span class="string">'exporter'</span>@<span class="string">'localhost'</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建.my.cnf文件</span></span><br><span class="line">在当前的用户目录(可变更)创建.my.cnf文件</span><br><span class="line">cat &gt; .my.cnf&lt;&lt;EOF</span><br><span class="line">[client]</span><br><span class="line">user=exporter</span><br><span class="line">password=123456</span><br></pre></td></tr></table></figure><h4 id="设置mysql-exporter开启启动"><a href="#设置mysql-exporter开启启动" class="headerlink" title="设置mysql_exporter开启启动"></a>设置mysql_exporter开启启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/mysql_exporter.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=mysqld_exporter</span><br><span class="line">Documentation=https://prometheus.io/docs</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/bin/mysqld_exporter \</span><br><span class="line">         --collect.info_schema.processlist \</span><br><span class="line">         --collect.info_schema.innodb_tablespaces \</span><br><span class="line">         --collect.info_schema.innodb_metrics  \</span><br><span class="line">         --collect.perf_schema.tableiowaits \</span><br><span class="line">         --collect.perf_schema.indexiowaits \</span><br><span class="line">         --collect.perf_schema.tablelocks \</span><br><span class="line">         --collect.engine_innodb_status \</span><br><span class="line">         --collect.perf_schema.file_events \</span><br><span class="line">         --collect.binlog_size \</span><br><span class="line">         --collect.info_schema.clientstats \</span><br><span class="line">         --collect.perf_schema.eventswaits \</span><br><span class="line">         --config.my-cnf=/root/.my.cnf</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 mysql_exporter</span></span><br><span class="line">systemctl  start mysql_exporter.service &amp;&amp; systemctl  status mysql_exporter.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认端口9104</span></span><br></pre></td></tr></table></figure><p>使用granafa给 MySQLD_Exporter添加监控图表:</p><ul><li>主从主群监控(模板7371)：</li><li>相关mysql 状态监控7362：</li><li>缓冲池状态7365</li></ul><h3 id="Prometheus基于文件的动态加载"><a href="#Prometheus基于文件的动态加载" class="headerlink" title="Prometheus基于文件的动态加载"></a>Prometheus基于文件的动态加载</h3><p>基于文件的服务发现是最通用的方式。这种方式不需要依赖于任何的平台或者第三方服务。对于Prometheus而言也不可能支持所有的平台或者环境。通过基于文件的服务发现方式下，Prometheus会定时从文件中读取最新的Target信息，可以通过任意的方式将监控Target的信息写入即可。<br>Prometheus 可以通过JSON或者YAML格式的文件，定义所有的监控目标。下面我是通过yaml的文件格式来进行配置监控。在添加实例的时候添加了一些额外的标签信息。如: env、service、group等，实例中采集到的样本信息将包含这些标签信息，从而可以通过该标签按照环境对数据进行统计。</p><h4 id="修改prometheus-yml"><a href="#修改prometheus-yml" class="headerlink" title="修改prometheus.yml"></a>修改prometheus.yml</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> prometheus.yml </span><br><span class="line">globa<span class="variable">l:</span></span><br><span class="line">  scrape_interva<span class="variable">l:</span>     <span class="number">15</span>s # Set the scrape interval <span class="keyword">to</span> every <span class="number">15</span> seconds. Default <span class="keyword">is</span> every <span class="number">1</span> minute.</span><br><span class="line">  evaluation_interva<span class="variable">l:</span> <span class="number">15</span>s # Evaluate rules every <span class="number">15</span> seconds. The default <span class="keyword">is</span> every <span class="number">1</span> minute.</span><br><span class="line">  scrape_timeou<span class="variable">t:</span> <span class="number">10</span>s</span><br><span class="line">  # scrape_timeout <span class="keyword">is</span> <span class="keyword">set</span> <span class="keyword">to</span> the <span class="keyword">global</span> default (<span class="number">10</span>s).</span><br><span class="line">alertin<span class="variable">g:</span></span><br><span class="line">  alertmanager<span class="variable">s:</span></span><br><span class="line">  - static_config<span class="variable">s:</span></span><br><span class="line">    - target<span class="variable">s:</span></span><br><span class="line">      # - alertmanager:<span class="number">9093</span></span><br><span class="line">rule_file<span class="variable">s:</span></span><br><span class="line">  # - <span class="string">"first_rules.yml"</span></span><br><span class="line">  # - <span class="string">"second_rules.yml"</span></span><br><span class="line">scrape_config<span class="variable">s:</span></span><br><span class="line">  - job_name: <span class="string">'kxl_docker'</span></span><br><span class="line">    file_sd_config<span class="variable">s:</span></span><br><span class="line">      - <span class="keyword">file</span><span class="variable">s:</span></span><br><span class="line">          - /<span class="keyword">opt</span>/prometheus/sd_config/docker.yml</span><br><span class="line">        refresh_interva<span class="variable">l:</span> <span class="number">5</span>s</span><br><span class="line">  - job_name: <span class="string">'kxl_vm'</span></span><br><span class="line">    file_sd_config<span class="variable">s:</span></span><br><span class="line">       - <span class="keyword">file</span><span class="variable">s:</span></span><br><span class="line">            - /<span class="keyword">opt</span>/prometheus/sd_config/<span class="keyword">vm</span>.yml</span><br><span class="line">         refresh_interva<span class="variable">l:</span> <span class="number">5</span>s</span><br><span class="line">  - job_name: <span class="string">'kxl_mysql'</span></span><br><span class="line">    file_sd_config<span class="variable">s:</span></span><br><span class="line">      - <span class="keyword">file</span><span class="variable">s:</span></span><br><span class="line">          - /<span class="keyword">opt</span>/prometheus/sd_config/mysql.yml</span><br><span class="line">        refresh_interva<span class="variable">l:</span> <span class="number">5</span>s</span><br></pre></td></tr></table></figure><p>scrape_configs 这里我定义了三组，分别是监控docker、vm、mysql的，每一个组对应一个yml文件。对应的服务到对应的文件进行增加即可。还可以增加(zk、es、ng、redis)等服务。</p><h4 id="创建被扫描的文件"><a href="#创建被扫描的文件" class="headerlink" title="创建被扫描的文件"></a>创建被扫描的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/prometheus/sd_config &amp;&amp; <span class="built_in">cd</span> /opt/prometheus/sd_config</span><br></pre></td></tr></table></figure><ul><li>docker.yml</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- labels:</span><br><span class="line">    service: docker</span><br><span class="line">    env: <span class="built_in">test</span></span><br><span class="line">    group: docker</span><br><span class="line">  targets:</span><br><span class="line">    - 172.21.1.30:8080</span><br></pre></td></tr></table></figure><ul><li>vm.yml</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- labels:</span><br><span class="line">    env: <span class="built_in">test</span></span><br><span class="line">    group: linux_node</span><br><span class="line">    service: vm</span><br><span class="line">  targets:</span><br><span class="line">    - 172.21.1.30:9100</span><br><span class="line">    - 172.21.1.52:9100</span><br><span class="line">    - 172.21.1.52:9100</span><br></pre></td></tr></table></figure><ul><li>mysql.yml</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- labels:</span><br><span class="line">    service: mysql</span><br><span class="line">    env: <span class="built_in">test</span></span><br><span class="line">    group: mysql</span><br><span class="line">  targets:</span><br><span class="line">    - 172.21.1.30:9104</span><br><span class="line">    </span><br><span class="line">- labels:</span><br><span class="line">    service: mysql</span><br><span class="line">    env: dev</span><br><span class="line">    group: mysql</span><br><span class="line">  targets:</span><br><span class="line">    - 172.21.1.52:9104</span><br></pre></td></tr></table></figure><p>在Prometheus UI的Targets下就可以看到当前定义的yml文件中动态获取到实例信息以及监控任务的采集状态，同时在Labels列下会包含用户添加的自定义标签:<br><img src="https://img.xxlaila.cn/1586668119403.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586666702938.jpg" alt="img"></p><p>在Prometheus UI的service-discovery下可以看到我们定义的job类型<br><img src="https://img.xxlaila.cn/1586666819381.jpg" alt="img"></p><h3 id="alertmanager-部署"><a href="#alertmanager-部署" class="headerlink" title="alertmanager 部署"></a>alertmanager 部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/alertmanager/releases/download/v0.20.0/alertmanager-0.20.0.linux-amd64.tar.gz</span><br><span class="line">tar zxf alertmanager-0.20.0.linux-amd64.tar.gz &amp;&amp; mv alertmanager-0.20.0.linux-amd64 /opt/alertmanager &amp;&amp; rm -rf alertmanager-0.20.0.linux-amd64*</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alermanager会将数据保存到本地中，默认的存储路径为data/。因此，在启动Alertmanager之前需要创建相应的目录</span></span><br><span class="line">mkdir -p /opt/alertmanager/data</span><br></pre></td></tr></table></figure><h4 id="设置alertmanager开机启动"><a href="#设置alertmanager开机启动" class="headerlink" title="设置alertmanager开机启动"></a>设置alertmanager开机启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/alertmanager.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=alertmanager</span><br><span class="line">Documentation=https://prometheus.io/docs</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/opt/alertmanager/alertmanager --config.file=/opt/alertmanager/alertmanager.yml --storage.path=/opt/alertmanager/data</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start alertmanager &amp;&amp; systemctl status alertmanager</span><br></pre></td></tr></table></figure><h4 id="修改prometheus配置用于加载alertmanager和alertmanager-rules"><a href="#修改prometheus配置用于加载alertmanager和alertmanager-rules" class="headerlink" title="修改prometheus配置用于加载alertmanager和alertmanager rules"></a>修改prometheus配置用于加载alertmanager和alertmanager rules</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat prometheus.yml</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s <span class="comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span><br><span class="line">  evaluation_interval: 15s <span class="comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span><br><span class="line">  scrape_timeout: 10s</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - 172.21.1.30:9093</span><br><span class="line">rule_files:</span><br><span class="line">  - <span class="string">'rules/*.rules'</span></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: <span class="string">'kxl_promethes'</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files:</span><br><span class="line">           - /opt/prometheus/sd_config/data.yml</span><br><span class="line">        refresh_interval: 5s</span><br><span class="line">  - job_name: <span class="string">'kxl_docker'</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files:</span><br><span class="line">          - /opt/prometheus/sd_config/docker.yml</span><br><span class="line">        refresh_interval: 5s</span><br><span class="line">  - job_name: <span class="string">'kxl_vm'</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">       - files:</span><br><span class="line">            - /opt/prometheus/sd_config/vm.yml</span><br><span class="line">         refresh_interval: 5s</span><br><span class="line">  - job_name: <span class="string">'kxl_mysql'</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files:</span><br><span class="line">          - /opt/prometheus/sd_config/mysql.yml</span><br><span class="line">        refresh_interval: 5s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启prometheus</span></span><br><span class="line">systemctl  restart prometheus</span><br></pre></td></tr></table></figure><h4 id="新建rules规则"><a href="#新建rules规则" class="headerlink" title="新建rules规则"></a>新建rules规则</h4><ul><li><p>node 规则</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/prometheus/rules</span><br><span class="line"></span><br><span class="line">cat &gt;node.rules&lt;&lt;EOF</span><br><span class="line">groups:</span><br><span class="line">- name: kxl_Instances </span><br><span class="line">  rules:</span><br><span class="line">  - alert: InstanceDown</span><br><span class="line">    expr: up == 0</span><br><span class="line">    <span class="keyword">for</span>: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    <span class="comment"># Prometheus templates apply here in the annotation and label fields of the alert.</span></span><br><span class="line">    annotations:</span><br><span class="line">      description: <span class="string">'&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; has been down for more than 5 minutes.'</span></span><br><span class="line">      summary: <span class="string">'Instance &#123;&#123; $labels.instance &#125;&#125; down'</span></span><br><span class="line">      </span><br><span class="line">  - alert: 内存使用率过高</span><br><span class="line">    expr: 100-(node_memory_Buffers_bytes+node_memory_Cached_bytes+node_memory_MemFree_bytes)/node_memory_MemTotal_bytes*100 &gt; 30 </span><br><span class="line">    <span class="keyword">for</span>: 1m </span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 内存使用率过高"</span></span><br><span class="line">      description: <span class="string">"&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; of job &#123;&#123;<span class="variable">$labels</span>.job&#125;&#125;内存使用率超过80%,当前使用率[&#123;&#123; <span class="variable">$value</span> &#125;&#125;]."</span></span><br><span class="line"></span><br><span class="line">  - alert: cpu使用率过高</span><br><span class="line">    expr: 100-avg(irate(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;[5m])) by(instance)*100 &gt; 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; cpu使用率过高"</span></span><br><span class="line">      description: <span class="string">"&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; of job &#123;&#123;<span class="variable">$labels</span>.job&#125;&#125;cpu使用率超过80%,当前使用率[&#123;&#123; <span class="variable">$value</span> &#125;&#125;]."</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>mysql 规则</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; mysql.rules &lt;&lt;EOF</span><br><span class="line">groups:</span><br><span class="line">- name: MySQLStatsAlert</span><br><span class="line">  rules:</span><br><span class="line">  - alert: MySQL is down</span><br><span class="line">    expr: mysql_up == 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; MySQL is down"</span></span><br><span class="line">      description: <span class="string">"MySQL database is down. This requires immediate action!"</span></span><br><span class="line">  - alert: open files high</span><br><span class="line">    expr: mysql_global_status_innodb_num_open_files &gt; (mysql_global_variables_open_files_limit) * 0.75</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; open files high"</span></span><br><span class="line">      description: <span class="string">"Open files is high. Please consider increasing open_files_limit."</span></span><br><span class="line">  - alert: Read buffer size is bigger than max. allowed packet size</span><br><span class="line">    expr: mysql_global_variables_read_buffer_size &gt; mysql_global_variables_slave_max_allowed_packet </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Read buffer size is bigger than max. allowed packet size"</span></span><br><span class="line">      description: <span class="string">"Read buffer size (read_buffer_size) is bigger than max. allowed packet size (max_allowed_packet).This can break your replication."</span></span><br><span class="line">  - alert: Sort buffer possibly missconfigured</span><br><span class="line">    expr: mysql_global_variables_innodb_sort_buffer_size &lt;256*1024 or mysql_global_variables_read_buffer_size &gt; 4*1024*1024 </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Sort buffer possibly missconfigured"</span></span><br><span class="line">      description: <span class="string">"Sort buffer size is either too big or too small. A good value for sort_buffer_size is between 256k and 4M."</span></span><br><span class="line">  - alert: Thread stack size is too small</span><br><span class="line">    expr: mysql_global_variables_thread_stack &lt;196608</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Thread stack size is too small"</span></span><br><span class="line">      description: <span class="string">"Thread stack size is too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line">  - alert: Used more than 80% of max connections limited </span><br><span class="line">    expr: mysql_global_status_max_used_connections &gt; mysql_global_variables_max_connections * 0.8</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Used more than 80% of max connections limited"</span></span><br><span class="line">      description: <span class="string">"Used more than 80% of max connections limited"</span></span><br><span class="line">  - alert: InnoDB Force Recovery is enabled</span><br><span class="line">    expr: mysql_global_variables_innodb_force_recovery != 0 </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Force Recovery is enabled"</span></span><br><span class="line">      description: <span class="string">"InnoDB Force Recovery is enabled. This mode should be used for data recovery purposes only. It prohibits writing to the data."</span></span><br><span class="line">  - alert: InnoDB Log File size is too small</span><br><span class="line">    expr: mysql_global_variables_innodb_log_file_size &lt; 16777216 </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Log File size is too small"</span></span><br><span class="line">      description: <span class="string">"The InnoDB Log File size is possibly too small. Choosing a small InnoDB Log File size can have significant performance impacts."</span></span><br><span class="line">  - alert: InnoDB Flush Log at Transaction Commit</span><br><span class="line">    expr: mysql_global_variables_innodb_flush_log_at_trx_commit != 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Flush Log at Transaction Commit"</span></span><br><span class="line">      description: <span class="string">"InnoDB Flush Log at Transaction Commit is set to a values != 1. This can lead to a loss of commited transactions in case of a power failure."</span></span><br><span class="line">  - alert: Table definition cache too small</span><br><span class="line">    expr: mysql_global_status_open_table_definitions &gt; mysql_global_variables_table_definition_cache</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Table definition cache too small"</span></span><br><span class="line">      description: <span class="string">"Your Table Definition Cache is possibly too small. If it is much too small this can have significant performance impacts!"</span></span><br><span class="line">  - alert: Table open cache too small</span><br><span class="line">    expr: mysql_global_status_open_tables &gt;mysql_global_variables_table_open_cache * 99/100</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Table open cache too small"</span></span><br><span class="line">      description: <span class="string">"Your Table Open Cache is possibly too small (old name Table Cache). If it is much too small this can have significant performance impacts!"</span></span><br><span class="line">  - alert: Thread stack size is possibly too small</span><br><span class="line">    expr: mysql_global_variables_thread_stack &lt; 262144</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Thread stack size is possibly too small"</span></span><br><span class="line">      description: <span class="string">"Thread stack size is possibly too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line">  - alert: InnoDB Buffer Pool Instances is too small</span><br><span class="line">    expr: mysql_global_variables_innodb_buffer_pool_instances == 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Buffer Pool Instances is too small"</span></span><br><span class="line">      description: <span class="string">"If you are using MySQL 5.5 and higher you should use several InnoDB Buffer Pool Instances for performance reasons. Some rules are: InnoDB Buffer Pool Instance should be at least 1 Gbyte in size. InnoDB Buffer Pool Instances you can set equal to the number of cores of your machine."</span></span><br><span class="line">  - alert: InnoDB Plugin is enabled</span><br><span class="line">    expr: mysql_global_variables_ignore_builtin_innodb == 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Plugin is enabled"</span></span><br><span class="line">      description: <span class="string">"InnoDB Plugin is enabled"</span></span><br><span class="line">  - alert: Binary Log is disabled</span><br><span class="line">    expr: mysql_global_variables_log_bin != 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Binary Log is disabled"</span></span><br><span class="line">      description: <span class="string">"Binary Log is disabled. This prohibits you to do Point in Time Recovery (PiTR)."</span></span><br><span class="line">  - alert: Binlog Cache size too small</span><br><span class="line">    expr: mysql_global_variables_binlog_cache_size &lt; 1048576</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      env: <span class="string">"&#123;&#123; <span class="variable">$labels</span>.env &#125;&#125;"</span></span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Binlog Cache size too small"</span></span><br><span class="line">      description: <span class="string">"Binlog Cache size is possibly to small. A value of 1 Mbyte or higher is OK."</span></span><br><span class="line">  - alert: Binlog Statement Cache size too small</span><br><span class="line">    expr: mysql_global_variables_binlog_stmt_cache_size &lt;1048576 and mysql_global_variables_binlog_stmt_cache_size &gt; 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Binlog Statement Cache size too small"</span></span><br><span class="line">      description: <span class="string">"Binlog Statement Cache size is possibly to small. A value of 1 Mbyte or higher is typically OK."</span></span><br><span class="line">  - alert: Binlog Transaction Cache size too small</span><br><span class="line">    expr: mysql_global_variables_binlog_cache_size  &lt;1048576</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Binlog Transaction Cache size too small"</span></span><br><span class="line">      description: <span class="string">"Binlog Transaction Cache size is possibly to small. A value of 1 Mbyte or higher is typically OK."</span></span><br><span class="line">  - alert: Sync Binlog is enabled</span><br><span class="line">    expr: mysql_global_variables_sync_binlog == 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Sync Binlog is enabled"</span></span><br><span class="line">      description: <span class="string">"Sync Binlog is enabled. This leads to higher data security but on the cost of write performance."</span></span><br><span class="line">  - alert: IO thread stopped</span><br><span class="line">    expr: mysql_slave_status_slave_io_running != 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; IO thread stopped"</span></span><br><span class="line">      description: <span class="string">"IO thread has stopped. This is usually because it cannot connect to the Master any more."</span></span><br><span class="line">  - alert: SQL thread stopped </span><br><span class="line">    expr: mysql_slave_status_slave_sql_running == 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; SQL thread stopped"</span></span><br><span class="line">      description: <span class="string">"SQL thread has stopped. This is usually because it cannot apply a SQL statement received from the master."</span></span><br><span class="line">  - alert: SQL thread stopped</span><br><span class="line">    expr: mysql_slave_status_slave_sql_running != 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Sync Binlog is enabled"</span></span><br><span class="line">      description: <span class="string">"SQL thread has stopped. This is usually because it cannot apply a SQL statement received from the master."</span></span><br><span class="line">  - alert: Slave lagging behind Master</span><br><span class="line">    expr: rate(mysql_slave_status_seconds_behind_master[1m]) &gt;30 </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning </span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Slave lagging behind Master"</span></span><br><span class="line">      description: <span class="string">"Slave is lagging behind Master. Please check if Slave threads are running and if there are some performance issues!"</span></span><br><span class="line">  - alert: Slave is NOT <span class="built_in">read</span> only(Please ignore this warning indicator.)</span><br><span class="line">    expr: mysql_global_variables_read_only != 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Slave is NOT read only"</span></span><br><span class="line">      description: <span class="string">"Slave is NOT set to read only. You can accidentally manipulate data on the slave and get inconsistencies..."</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="配置告警策略"><a href="#配置告警策略" class="headerlink" title="配置告警策略"></a>配置告警策略</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cat alertmanager.yml </span><br><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line">  smtp_smarthost: <span class="string">'smtp.exmail.qq.com:465'</span></span><br><span class="line">  smtp_from: <span class="string">'zxc@xxlaila.cn.com'</span></span><br><span class="line">  smtp_auth_username: <span class="string">'zxc@xxlaila.cn.com'</span></span><br><span class="line">  smtp_auth_password: <span class="string">'123456'</span></span><br><span class="line">  smtp_require_tls: <span class="literal">true</span></span><br><span class="line">  hipchat_api_url: <span class="string">'https://hipchat.foobar.org/'</span></span><br><span class="line">  wechat_api_url: <span class="string">'https://qyapi.weixin.qq.com/cgi-bin/'</span></span><br><span class="line">  wechat_api_secret: <span class="string">'KJfj93r21389usdas0i--234jsnjkhf23sjkfjsfs'</span>    <span class="comment"># 企业微信Secret</span></span><br><span class="line">  wechat_api_corp_id: <span class="string">'wwa98423u9skdnkjahs'</span>    <span class="comment"># 企业微信CorpId</span></span><br><span class="line"></span><br><span class="line">templates:</span><br><span class="line">  - <span class="string">'template/*.tmpl'</span>   告警信息模版</span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  group_by: [<span class="string">'alertname'</span>]</span><br><span class="line">  group_wait: 10s</span><br><span class="line">  group_interval: 10s</span><br><span class="line">  repeat_interval: 1h</span><br><span class="line">  <span class="comment">#receiver: 'web.hook'</span></span><br><span class="line">  receiver: default</span><br><span class="line">  routes:</span><br><span class="line">  - receiver: <span class="string">'wechat'</span></span><br><span class="line">    <span class="built_in">continue</span>: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line"><span class="comment">#- name: 'web.hook'</span></span><br><span class="line">  - name: <span class="string">'default'</span></span><br><span class="line">    email_configs:</span><br><span class="line">    - to: <span class="string">'cq_xxlaila@163.com'</span></span><br><span class="line">      html: <span class="string">'&#123;&#123; template "test.html" . &#125;&#125;'</span></span><br><span class="line">      headers: &#123; Subject: <span class="string">"[WARN] email"</span>&#125;</span><br><span class="line">      send_resolved: <span class="literal">true</span></span><br><span class="line">    webhook_configs:</span><br><span class="line">    - url: <span class="string">'http://127.0.0.1:5001/'</span></span><br><span class="line">  - name: <span class="string">'wechat'</span></span><br><span class="line">    wechat_configs:</span><br><span class="line">    - send_resolved: <span class="literal">true</span></span><br><span class="line">      to_user: <span class="string">'@all'</span>              <span class="comment"># 接受人，都是all</span></span><br><span class="line">      to_party: <span class="string">'4'</span>                <span class="comment"># 接收组的id</span></span><br><span class="line">      agent_id: <span class="string">'1000002'</span>          <span class="comment"># 企业微信自定义应用的id</span></span><br><span class="line">      corp_id: <span class="string">'wwa98457kdsnkdnsadmsdnas'</span>   <span class="comment"># 企业微信CorpId</span></span><br><span class="line">      message: <span class="string">'&#123;&#123; template "test_wechat.html" . &#125;&#125;'</span>  <span class="comment"># 发送消息的模版</span></span><br><span class="line"></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: <span class="string">'critical'</span></span><br><span class="line">    target_match:</span><br><span class="line">      severity: <span class="string">'warning'</span></span><br><span class="line">    equal: [<span class="string">'alertname'</span>, <span class="string">'dev'</span>, <span class="string">'instance'</span>]</span><br></pre></td></tr></table></figure><p>Alertmanager主要负责对Prometheus产生的告警进行统一处理，因此在Alertmanager配置中一般会包含以下几个主要部分：</p><ul><li>全局配置（global）：用于定义一些全局的公共参数，如全局的SMTP配置，Slack配置等内容；</li><li>模板（templates）：用于定义告警通知时的模板，如HTML模板，邮件模板等；</li><li>告警路由（route）：根据标签匹配，确定当前告警应该如何处理；</li><li>接收人（receivers）：接收人是一个抽象的概念，它可以是一个邮箱也可以是微信，Slack或者Webhook等，接收人一般配合告警路由使用；</li><li>抑制规则（inhibit_rules）：合理设置抑制规则可以减少垃圾告警的产生</li></ul><h4 id="tmpl模板的配置"><a href="#tmpl模板的配置" class="headerlink" title=".tmpl模板的配置"></a>.tmpl模板的配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建.tmpl模版存放目录</span></span><br><span class="line">mkdir /opt/alertmanager/template &amp;&amp; <span class="built_in">cd</span> /opt/alertmanager/template</span><br><span class="line"></span><br><span class="line"><span class="comment"># 企业微信</span></span><br><span class="line">cat &gt;test_wechat.tmpl &lt;&lt;EOF</span><br><span class="line">&#123;&#123; define <span class="string">"test_wechat.html"</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; range <span class="variable">$i</span>, <span class="variable">$alert</span> := .Alerts.Firing &#125;&#125;</span><br><span class="line">    [报警项]:&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"alertname"</span> &#125;&#125;</span><br><span class="line">    [环境]: &#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"env"</span> &#125;&#125;</span><br><span class="line">    [实例]:&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"instance"</span> &#125;&#125;</span><br><span class="line">    [级别]: &#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"severity"</span> &#125;&#125;</span><br><span class="line">    [报警阀值]: &#123;&#123; index <span class="variable">$alert</span>.Annotations <span class="string">"summary"</span> &#125;&#125;</span><br><span class="line">    [报警描述]: &#123;&#123; index <span class="variable">$alert</span>.Annotations <span class="string">"description"</span> &#125;&#125;</span><br><span class="line">    [开始时间]: &#123;&#123; <span class="variable">$alert</span>.StartsAt &#125;&#125;</span><br><span class="line">  &#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 邮件告警</span></span><br><span class="line">cat &gt;test.tmpl &lt;&lt;EOF</span><br><span class="line">&#123;&#123; define <span class="string">"test.html"</span> &#125;&#125;</span><br><span class="line">&lt;table border=<span class="string">"1"</span>&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;报警项&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;环境&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;实例&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;级别&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;报警阀值&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;报警描述&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;开始时间&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; range <span class="variable">$i</span>, <span class="variable">$alert</span> := .Alerts &#125;&#125;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"alertname"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"env"</span>&#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"instance"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"severity"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Annotations <span class="string">"summary"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Annotations <span class="string">"description"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; <span class="variable">$alert</span>.StartsAt &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启alertmanager</span></span><br><span class="line">systemctl restart alertmanager</span><br></pre></td></tr></table></figure><p>企业微信截图<br><img src="https://img.xxlaila.cn/1587343723200.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h2 id=&quot;Prometheus-应用&quot;&gt;&lt;a href=&quot;#Prometheus-应用&quot; class=&quot;headerlink&quot; title=&quot;Prometheus 应用&quot;&gt;&lt;/a&gt;Prometheus 应用&lt;/h2&gt;&lt;h3 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h3&gt;&lt;p&gt;Prometheus的单机安装比较简单，这里采用的是单机进行安装。&lt;a href=&quot;https://prometheus.io/download/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Prometheus&lt;/a&gt;的相关插件下载地址&lt;/p&gt;
    
    </summary>
    
      <category term="监控" scheme="https://www.xxlaila.cn/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
      <category term="Prometheus" scheme="https://www.xxlaila.cn/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>关于openstack 安装centos-release-openstack-ocata失败解决</title>
    <link href="https://www.xxlaila.cn/2020/04/09/%E5%85%B3%E4%BA%8Eopenstack-%E5%AE%89%E8%A3%85centos-release-openstack-ocata%E5%A4%B1%E8%B4%A5%E8%A7%A3%E5%86%B3/"/>
    <id>https://www.xxlaila.cn/2020/04/09/关于openstack-安装centos-release-openstack-ocata失败解决/</id>
    <published>2020-04-09T05:16:19.000Z</published>
    <updated>2020-05-12T07:21:21.590Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --><h3 id="关于openstack-安装centos-release-openstack-ocata失败解决"><a href="#关于openstack-安装centos-release-openstack-ocata失败解决" class="headerlink" title="关于openstack 安装centos-release-openstack-ocata失败解决"></a>关于openstack 安装centos-release-openstack-ocata失败解决</h3><p>openstack ocata版本在后期增加节点的时候，安装<code>centos-release-openstack-ocata</code>失败。<a href="https://docs.openstack.org/ocata/install-guide-rdo/environment-packages.html" target="_blank" rel="noopener">ocata版本安装参考</a></p><h3 id="centos-release-openstack-ocata-错误提示"><a href="#centos-release-openstack-ocata-错误提示" class="headerlink" title="centos-release-openstack-ocata 错误提示"></a>centos-release-openstack-ocata 错误提示</h3><p>安装centos-release-openstack-ocata前系统版本<code>centos 7.4</code>，在yum安装的时候提示:<a id="more"></a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum install centos-release-openstack-ocata</span><br><span class="line"></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line"> * extras: mirrors.aliyun.com</span><br><span class="line"> * updates: mirrors.aliyun.com</span><br><span class="line">No package centos-release-openstack-ocata available.</span><br><span class="line">Error: Nothing to <span class="keyword">do</span></span><br></pre></td></tr></table></figure><p>经过查询得知，阿里云extras已经取消 centos-release-openstack-ocata的支持，于是乎怎么办。手动下载二进制包来进行安装。</p><h3 id="下载centos-release-openstack-ocata相关组件"><a href="#下载centos-release-openstack-ocata相关组件" class="headerlink" title="下载centos-release-openstack-ocata相关组件"></a>下载centos-release-openstack-ocata相关组件</h3><p><a href="http://vault.centos.org/7.4.1708/extras/x86_64/Packages/" target="_blank" rel="noopener">centos 7.4</a>对应下载地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-openstack-ocata-1-2.el7.noarch.rpm</span><br><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-ceph-jewel-1.0-1.el7.centos.noarch.rpm</span><br><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-qemu-ev-1.0-2.el7.noarch.rpm</span><br><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-storage-common-1-2.el7.centos.noarch.rpm</span><br><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-virt-common-1-1.el7.centos.noarch.rpm</span><br></pre></td></tr></table></figure><h4 id="安装对应的插件"><a href="#安装对应的插件" class="headerlink" title="安装对应的插件"></a>安装对应的插件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh *.rpm</span><br></pre></td></tr></table></figure><p>上述的几条命令可以使用一下方式进行快速的安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-openstack-ocata-1-2.el7.noarch.rpm</span><br><span class="line">yum -y install centos-release-openstack-ocata-1-2.el7.noarch.rpm</span><br></pre></td></tr></table></figure><h4 id="清理缓存"><a href="#清理缓存" class="headerlink" title="清理缓存"></a>清理缓存</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum cachemake</span><br></pre></td></tr></table></figure><p>在<code>yum cachemake</code>的时候又提示了错误。<code>HTTP Error 404 - Not Found</code>，具体错误如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Determining fastest mirrors</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line"> * extras: mirrors.aliyun.com</span><br><span class="line"> * updates: mirrors.cn99.com</span><br><span class="line">base                                                                                                                                                                               | 3.6 kB  00:00:00     </span><br><span class="line">centos-ceph-jewel                                                                                                                                                                  | 2.9 kB  00:00:00     </span><br><span class="line">http://mirror.centos.org/centos/7/cloud/x86_64/openstack-ocata/repodata/repomd.xml: [Errno 14] HTTP Error 404 - Not Found</span><br><span class="line">Trying other mirror.</span><br><span class="line">To address this issue please refer to the below wiki article </span><br><span class="line"></span><br><span class="line">https://wiki.centos.org/yum-errors</span><br><span class="line"></span><br><span class="line">If above article doesn<span class="string">'t help to resolve this issue please use https://bugs.centos.org/.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> One of the configured repositories failed (CentOS-7 - OpenStack ocata),</span></span><br><span class="line"><span class="string"> and yum doesn'</span>t have enough cached data to <span class="built_in">continue</span>. At this point the only</span><br><span class="line"> safe thing yum can <span class="keyword">do</span> is fail. There are a few ways to work <span class="string">"fix"</span> this:</span><br><span class="line"></span><br><span class="line">     1. Contact the upstream <span class="keyword">for</span> the repository and get them to fix the problem.</span><br><span class="line"></span><br><span class="line">     2. Reconfigure the baseurl/etc. <span class="keyword">for</span> the repository, to point to a working</span><br><span class="line">        upstream. This is most often useful <span class="keyword">if</span> you are using a newer</span><br><span class="line">        distribution release than is supported by the repository (and the</span><br><span class="line">        packages <span class="keyword">for</span> the previous distribution release still work).</span><br><span class="line"></span><br><span class="line">     3. Run the <span class="built_in">command</span> with the repository temporarily disabled</span><br><span class="line">            yum --disablerepo=centos-openstack-ocata ...</span><br><span class="line"></span><br><span class="line">     4. Disable the repository permanently, so yum won<span class="string">'t use it by default. Yum</span></span><br><span class="line"><span class="string">        will then just ignore the repository until you permanently enable it</span></span><br><span class="line"><span class="string">        again or use --enablerepo for temporary usage:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            yum-config-manager --disable centos-openstack-ocata</span></span><br><span class="line"><span class="string">        or</span></span><br><span class="line"><span class="string">            subscription-manager repos --disable=centos-openstack-ocata</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     5. Configure the failing repository to be skipped, if it is unavailable.</span></span><br><span class="line"><span class="string">        Note that yum will try to contact the repo. when it runs most commands,</span></span><br><span class="line"><span class="string">        so will have to try and fail each time (and thus. yum will be be much</span></span><br><span class="line"><span class="string">        slower). If it is a very temporary problem though, this is often a nice</span></span><br><span class="line"><span class="string">        compromise:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            yum-config-manager --save --setopt=centos-openstack-ocata.skip_if_unavailable=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">failure: repodata/repomd.xml from centos-openstack-ocata: [Errno 256] No more mirrors to try.</span></span><br><span class="line"><span class="string">http://mirror.centos.org/centos/7/cloud/x86_64/openstack-ocata/repodata/repomd.xml: [Errno 14] HTTP Error 404 - Not Found</span></span><br></pre></td></tr></table></figure><p>于是打开<code>http://mirror.centos.org/centos/7/cloud/x86_64</code>此链接地址，发现已经没有了<code>openstack-ocata</code>，所以才会导致失败。功夫不负有心人，终于在google找到一个有用的地址。</p><h3 id="修改OpenStack-ocata-repo"><a href="#修改OpenStack-ocata-repo" class="headerlink" title="修改OpenStack-ocata.repo"></a>修改OpenStack-ocata.repo</h3><p>修改<code>/etc/yum.repos.d/CentOS-OpenStack-ocata.repo</code>文件里面的<code>baseurl</code>地址，修改内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[centos-openstack-ocata]</span><br><span class="line">name=CentOS-7 - OpenStack ocata</span><br><span class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/7/cloud/$basearch/openstack-ocata/</span></span><br><span class="line">baseurl=http://mirror.neu.edu.cn/centos/7/cloud/<span class="variable">$basearch</span>/openstack-ocata/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Cloud</span><br><span class="line">exclude=sip,PyQt4</span><br></pre></td></tr></table></figure><p>完成后执行<code>yum makecache</code>或<code>centos-release-openstack-ocata</code>成功。可以打开<a href="http://mirror.neu.edu.cn/centos/7/cloud/x86_64/" target="_blank" rel="noopener">mirror.neu.edu.cn</a>查看是否有openstack-ocata<br><img src="https://img.xxlaila.cn/1586409079298.jpg" alt="img"></p><h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum upgrade</span><br><span class="line"><span class="comment"># 执行以后内容会从之前的centos 7.4 升级为 CentOS Linux release 7.7.1908 (Core)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h3 id="安装相关插件"><a href="#安装相关插件" class="headerlink" title="安装相关插件"></a>安装相关插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install python-openstackclient openstack-selinux</span><br><span class="line"></span><br><span class="line">yum install openstack-nova-compute conntrack libguestfs-tools</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;关于openstack-安装centos-release-openstack-ocata失败解决&quot;&gt;&lt;a href=&quot;#关于openstack-安装centos-release-openstack-ocata失败解决&quot; class=&quot;headerlink&quot; title=&quot;关于openstack 安装centos-release-openstack-ocata失败解决&quot;&gt;&lt;/a&gt;关于openstack 安装centos-release-openstack-ocata失败解决&lt;/h3&gt;&lt;p&gt;openstack ocata版本在后期增加节点的时候，安装&lt;code&gt;centos-release-openstack-ocata&lt;/code&gt;失败。&lt;a href=&quot;https://docs.openstack.org/ocata/install-guide-rdo/environment-packages.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ocata版本安装参考&lt;/a&gt;&lt;/p&gt;&lt;h3 id=&quot;centos-release-openstack-ocata-错误提示&quot;&gt;&lt;a href=&quot;#centos-release-openstack-ocata-错误提示&quot; class=&quot;headerlink&quot; title=&quot;centos-release-openstack-ocata 错误提示&quot;&gt;&lt;/a&gt;centos-release-openstack-ocata 错误提示&lt;/h3&gt;&lt;p&gt;安装centos-release-openstack-ocata前系统版本&lt;code&gt;centos 7.4&lt;/code&gt;，在yum安装的时候提示:
    
    </summary>
    
      <category term="openstack" scheme="https://www.xxlaila.cn/categories/openstack/"/>
    
    
      <category term="ocata" scheme="https://www.xxlaila.cn/tags/ocata/"/>
    
  </entry>
  
  <entry>
    <title>利用 zabbix 监控全国天气状况</title>
    <link href="https://www.xxlaila.cn/2020/04/08/%E5%88%A9%E7%94%A8-zabbix-%E7%9B%91%E6%8E%A7%E5%85%A8%E5%9B%BD%E5%A4%A9%E6%B0%94%E7%8A%B6%E5%86%B5/"/>
    <id>https://www.xxlaila.cn/2020/04/08/利用-zabbix-监控全国天气状况/</id>
    <published>2020-04-08T06:20:47.000Z</published>
    <updated>2020-05-12T07:21:21.740Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --><h2 id="利用-zabbix-监控全国天气状况"><a href="#利用-zabbix-监控全国天气状况" class="headerlink" title="利用 zabbix 监控全国天气状况"></a>利用 zabbix 监控全国天气状况</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本次主要是采用zabbix 的 http 代理方式进行数据的采集。可以通过网站的api接口来测试获取天气的状况。这里使用的是高德地图的天气。zabbix版本使用4.0 以上支持http 代理。3.0 版本不支持。<a id="more"></a></p><h3 id="利用zabbix创建测试"><a href="#利用zabbix创建测试" class="headerlink" title="利用zabbix创建测试"></a>利用zabbix创建测试</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;打开zabbix的配置——&gt;主机，点击任意一台主机进行item的配置。<br><img src="https://img.xxlaila.cn/1586253783229.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586253914768.jpg" alt="img"></p><h3 id="获取数据如下"><a href="#获取数据如下" class="headerlink" title="获取数据如下"></a>获取数据如下</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据上述创建的监控项，然后我们在<code>Latest data</code>里面看到获取的数据如下所示：<br><img src="https://img.xxlaila.cn/1586254044683.jpg" alt="img"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"status"</span>:<span class="string">"1"</span>,<span class="string">"count"</span>:<span class="string">"1"</span>,<span class="string">"info"</span>:<span class="string">"OK"</span>,<span class="string">"infocode"</span>:<span class="string">"10000"</span>,<span class="string">"lives"</span>:[&#123;<span class="string">"province"</span>:<span class="string">"重庆"</span>,<span class="string">"city"</span>:<span class="string">"重庆市"</span>,<span class="string">"adcode"</span>:<span class="string">"500000"</span>,<span class="string">"weather"</span>:<span class="string">"多云"</span>,<span class="string">"temperature"</span>:<span class="string">"21"</span>,<span class="string">"winddirection"</span>:<span class="string">"南"</span>,<span class="string">"windpower"</span>:<span class="string">"≤3"</span>,<span class="string">"humidity"</span>:<span class="string">"45"</span>,<span class="string">"reporttime"</span>:<span class="string">"2020-04-07 17:54:43"</span>&#125;]&#125;</span><br></pre></td></tr></table></figure><h3 id="监控天气信息为例"><a href="#监控天气信息为例" class="headerlink" title="监控天气信息为例"></a>监控天气信息为例</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;键值定义尽量和上述的一致，依赖项选择刚刚新建的http agent监控项<br><img src="https://img.xxlaila.cn/1586254230677.jpg" alt="img"></p><h4 id="添加预处理步骤"><a href="#添加预处理步骤" class="headerlink" title="添加预处理步骤"></a>添加预处理步骤</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据刚才获取到的数据来获取<code>weather</code>的值，不通平台的获取的数据类型不一样。这里的<code>weather</code>要根据不通平台的信息进行修改。否则无法获取数据，在该 <code>item</code> 点击<code>Preprocessing</code><br><img src="https://img.xxlaila.cn/1586254402880.jpg" alt="img"><br>定义气温、风力、风向、相对湿度，添加方法与上面相同</p><h3 id="建立触发器"><a href="#建立触发器" class="headerlink" title="建立触发器"></a>建立触发器</h3><p>这里建立一个温度超过30度显示温度过高，温度低于13度就显示温度低的两个触发器<br><img src="https://img.xxlaila.cn/1586305703882.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586329254191.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里我们需要添加全国34个省市，每一个省市都是手动建立，去查找每一个省市的代码需要多少时间，这里使用<a href="https://github.com/xxlaila/backup-monitoring/tree/master/weather" target="_blank" rel="noopener">python的一个小程序</a>来实现获取全国的城市，然后创建对应<code>item</code>和<code>Trigger</code>。添加完成以后的最后结果为:<br><img src="https://img.xxlaila.cn/1586306042202.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586306102916.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586306159679.jpg" alt="img"></p><h3 id="创建网络拓扑"><a href="#创建网络拓扑" class="headerlink" title="创建网络拓扑"></a>创建网络拓扑</h3><h4 id="创建背景图片"><a href="#创建背景图片" class="headerlink" title="创建背景图片"></a>创建背景图片</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以自行去网上照一张中国地图的图片。<br><img src="https://img.xxlaila.cn/1586306286532.jpg" alt="img"></p><h4 id="创建map图"><a href="#创建map图" class="headerlink" title="创建map图"></a>创建map图</h4><p>Monitoring——&gt;Maps——&gt;Create map<br><img src="https://img.xxlaila.cn/1586306412375.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586306469511.jpg" alt="img"></p><h4 id="编辑map"><a href="#编辑map" class="headerlink" title="编辑map"></a>编辑map</h4><p>标签用于显示监控的数据，添加高温的触发器，当触发高温报警后，图标由绿点会变成红绿 交替闪动，这里以西藏气温为例</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;Zabbix server:xizangzizhiqu-weather.<span class="keyword">last</span>()&#125;</span><br><span class="line">&#123;Zabbix server:xizangzizhiqu-temperature.<span class="keyword">last</span>()&#125;°C </span><br><span class="line">&#123;Zabbix server:xizangzizhiqu-winddirection.<span class="keyword">last</span>()&#125;风&#123;Zabbix server:xizangzizhiqu-windpower.<span class="keyword">last</span>()&#125;级</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1586329570620.jpg" alt="img"></p><h4 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h4><p><img src="https://img.xxlaila.cn/1586326792592.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586328948590.jpg" alt="img"></p><h3 id="zabbix-图标乱码"><a href="#zabbix-图标乱码" class="headerlink" title="zabbix 图标乱码"></a>zabbix 图标乱码</h3><p>在打开天气温度和湿度的图表时，显示乱码。在windows电脑上选择一个字体，比如<code>简体中文</code>，我这里使用的是中文楷体<code>simkai.ttf</code>字体。上传到zabbix server的服务器</p><h4 id="zabbix的安装目录"><a href="#zabbix的安装目录" class="headerlink" title="zabbix的安装目录"></a>zabbix的安装目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whereis  zabbix</span><br><span class="line">zabbix: /usr/lib/zabbix /etc/zabbix /usr/share/zabbix</span><br></pre></td></tr></table></figure><h4 id="切换到-usr-share-zabbix目录"><a href="#切换到-usr-share-zabbix目录" class="headerlink" title="切换到/usr/share/zabbix目录"></a>切换到/usr/share/zabbix目录</h4><p>切换到该目录可以使用<code>ls</code>命令，该目录下面已经没有fonts字体目录了。可以创建目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/share/zabbix/fonts</span><br><span class="line"></span><br><span class="line">mv simkai.ttf /usr/share/zabbix/fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 /etc/alternatives/zabbix-web-font 软连接</span></span><br><span class="line">rm -f /etc/alternatives/zabbix-web-font</span><br><span class="line">ln -s /usr/share/zabbix/fonts/simkai.ttf  /etc/alternatives/zabbix-web-font</span><br><span class="line"></span><br><span class="line">systemctl restart zabbix-server</span><br></pre></td></tr></table></figure><p><a href="https://www.zabbix.com/documentation/4.0/zh/manual/config/items/itemtypes/http" target="_blank" rel="noopener">zabbix api</a><br><a href="https://lbs.amap.com/api/webservice/guide/api/weatherinfo" target="_blank" rel="noopener">高德天气</a><br><a href="https://lbs.amap.com/api/webservice/guide/api/district" target="_blank" rel="noopener">高德城市</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --&gt;&lt;h2 id=&quot;利用-zabbix-监控全国天气状况&quot;&gt;&lt;a href=&quot;#利用-zabbix-监控全国天气状况&quot; class=&quot;headerlink&quot; title=&quot;利用 zabbix 监控全国天气状况&quot;&gt;&lt;/a&gt;利用 zabbix 监控全国天气状况&lt;/h2&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;本次主要是采用zabbix 的 http 代理方式进行数据的采集。可以通过网站的api接口来测试获取天气的状况。这里使用的是高德地图的天气。zabbix版本使用4.0 以上支持http 代理。3.0 版本不支持。
    
    </summary>
    
      <category term="zabbix" scheme="https://www.xxlaila.cn/categories/zabbix/"/>
    
    
      <category term="weather" scheme="https://www.xxlaila.cn/tags/weather/"/>
    
  </entry>
  
  <entry>
    <title>openvpn推送路由</title>
    <link href="https://www.xxlaila.cn/2020/03/26/openvpn%E6%8E%A8%E9%80%81%E8%B7%AF%E7%94%B1/"/>
    <id>https://www.xxlaila.cn/2020/03/26/openvpn推送路由/</id>
    <published>2020-03-26T01:05:15.000Z</published>
    <updated>2020-05-12T07:21:21.780Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;openvpn 做好以后，发现到腾讯云网络不通，拓扑图参考如下：<br><img src="https://img.xxlaila.cn/1585183381221.jpg" alt="img"><a id="more"></a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IDC机房和云上是通过vpn打通的。openvpn是假设在机房的，云上的部分东西是限制只能IDC访问。客户端拨号到openvpn以后是没有办法访问云上的。因为没有路由。所以需要在服务器端推送路由到客户端。</p><h3 id="修改服务器端配置"><a href="#修改服务器端配置" class="headerlink" title="修改服务器端配置"></a>修改服务器端配置</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;增加到云上的路由配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">"route 172.16.11.0 255.255.255.0"</span></span><br><span class="line">push <span class="string">"route 172.16.13.0 255.255.252.0"</span></span><br></pre></td></tr></table></figure><h3 id="增加nginx白名单的配置"><a href="#增加nginx白名单的配置" class="headerlink" title="增加nginx白名单的配置"></a>增加nginx白名单的配置</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在云上有nginx到的proxy。但是里面做有白名单，也是只能IDC访问，ping域名解析是公网的ip地址。用户拨入openvpn以后，同样也不开这部分服务。这里就需要增加指定的ip，xxx.xxx.xxx.xxx 换成自己本身的公网ip地址。我这里的这个地址是一个slb地址。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">"route xxx.xxx.xxx.xxx 255.255.255.255"</span></span><br></pre></td></tr></table></figure><h3 id="重启openvpn"><a href="#重启openvpn" class="headerlink" title="重启openvpn"></a>重启openvpn</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openvpn@server</span><br></pre></td></tr></table></figure><h3 id="客户端查看路由"><a href="#客户端查看路由" class="headerlink" title="客户端查看路由"></a>客户端查看路由</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">netstat -nr</span><br><span class="line"></span><br><span class="line">Routing tables</span><br><span class="line"></span><br><span class="line">Internet:</span><br><span class="line">Destination        Gateway            Flags        Refs      Use   Netif Expire</span><br><span class="line">default            192.168.31.1       UGSc          130        0     en0</span><br><span class="line">10                 10.8.0.5           UGSc            0        0   utun3</span><br><span class="line">10.8.0.1/32        10.8.0.5           UGSc            0        0   utun3</span><br><span class="line">10.8.0.5           10.8.0.6           UH             13        0   utun3</span><br><span class="line">115.xxx.xxx.xx/32  10.8.0.5           UGSc            0        0   utun3  </span><br><span class="line">127                127.0.0.1          UCS             0        0     lo0</span><br><span class="line">127.0.0.1          127.0.0.1          UH             68  6082666     lo0</span><br><span class="line">169.254            link<span class="comment">#5             UCS             2        0     en0      !</span></span><br><span class="line">172.16.11/24       10.8.0.5           UGSc            1        1   utun3</span><br><span class="line">172.16.13/22       10.8.0.5           UGSc            0        0   utun3</span><br><span class="line">172.21.17/20       10.8.0.5           UGSc            8        0   utun3</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ping ip地址或者域名进行验证是否ok</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;需求&quot;&gt;&lt;a href=&quot;#需求&quot; class=&quot;headerlink&quot; title=&quot;需求&quot;&gt;&lt;/a&gt;需求&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;openvpn 做好以后，发现到腾讯云网络不通，拓扑图参考如下：&lt;br&gt;&lt;img src=&quot;https://img.xxlaila.cn/1585183381221.jpg&quot; alt=&quot;img&quot;&gt;
    
    </summary>
    
      <category term="vpn" scheme="https://www.xxlaila.cn/categories/vpn/"/>
    
    
      <category term="openvpn" scheme="https://www.xxlaila.cn/tags/openvpn/"/>
    
  </entry>
  
  <entry>
    <title>openvpn配置ldap</title>
    <link href="https://www.xxlaila.cn/2020/03/11/openvpn%E9%85%8D%E7%BD%AEldap/"/>
    <id>https://www.xxlaila.cn/2020/03/11/openvpn配置ldap/</id>
    <published>2020-03-11T10:31:55.000Z</published>
    <updated>2020-05-12T07:21:21.850Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;企业内一般都有ldap，基本上所有的系统都支持ldap登录，openvpn也不例外，<a id="more"></a>使用ldap认证登录好处是员工可以使用一个账号就可以进行登录，不需要去记录N个账号密码。</p><h3 id="安装-openvpn-auth-ldap-插件"><a href="#安装-openvpn-auth-ldap-插件" class="headerlink" title="安装 openvpn-auth-ldap 插件"></a>安装 openvpn-auth-ldap 插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release &amp;&amp; yum -y install openvpn-auth-ldap</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;安装完成后，在目录 /usr/lib64/openvpn/plugin/lib/ 会出现 openvpn-auth-ldap.so 文件。在目录 /etc/openvpn 目录下自动生成 auth 目录，该目录里面存在 ldap.conf ，用于配置 LDAP 相关信息。</p><h3 id="配置-LDAP-相关信息"><a href="#配置-LDAP-相关信息" class="headerlink" title="配置 LDAP 相关信息"></a>配置 LDAP 相关信息</h3><h4 id="备份原先的配置文件"><a href="#备份原先的配置文件" class="headerlink" title="备份原先的配置文件"></a>备份原先的配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/openvpn/auth/ldap.conf /etc/openvpn/auth/ldap.conf.bak</span><br></pre></td></tr></table></figure><h4 id="编辑ldap-conf"><a href="#编辑ldap-conf" class="headerlink" title="编辑ldap.conf"></a>编辑ldap.conf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/auth/ldap.conf</span><br><span class="line">&lt;LDAP&gt;</span><br><span class="line">URLldap://xx.xx.xx.xx:389</span><br><span class="line">        Password123456</span><br><span class="line">Timeout15</span><br><span class="line">TLSEnableno</span><br><span class="line">FollowReferrals no</span><br><span class="line">&lt;/LDAP&gt;</span><br><span class="line">&lt;Authorization&gt;</span><br><span class="line">BaseDN<span class="string">"ou=People,dc=xxlaila,dc=cn"</span></span><br><span class="line">SearchFilter<span class="string">"uid=%u"</span></span><br><span class="line">RequireGroup<span class="literal">false</span></span><br><span class="line">&lt;/Authorization&gt;</span><br></pre></td></tr></table></figure><h4 id="编辑-openvpn-的配置文件"><a href="#编辑-openvpn-的配置文件" class="headerlink" title="编辑 openvpn 的配置文件"></a>编辑 openvpn 的配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加如下内容</span></span><br><span class="line">vim /etc/openvpn/server.conf</span><br><span class="line"></span><br><span class="line">plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so <span class="string">"/etc/openvpn/auth/ldap.conf"</span></span><br><span class="line">client-cert-not-required</span><br><span class="line">username-as-common-name</span><br></pre></td></tr></table></figure><blockquote><p>使用了上面安装的 openvpn-auth-ldap 认证插件，client-cert-not-required 表示不再需要客户端证书，将改为使用 LDAP 中的用户认证。</p></blockquote><h4 id="重新启动-OpenVPN-服务"><a href="#重新启动-OpenVPN-服务" class="headerlink" title="重新启动 OpenVPN 服务"></a>重新启动 OpenVPN 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openvpn@server</span><br></pre></td></tr></table></figure><h3 id="客户端配置修改"><a href="#客户端配置修改" class="headerlink" title="客户端配置修改"></a>客户端配置修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto tcp</span><br><span class="line">remote xxx.xxx.xxx 1194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line"></span><br><span class="line">ca ca.crt</span><br><span class="line">cert client.crt</span><br><span class="line">key client.key</span><br><span class="line">remote-cert-tls server</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line"></span><br><span class="line">ns-cert-type server   <span class="comment"># 增加此行</span></span><br><span class="line">auth-user-pass        <span class="comment"># 增加此行,开启 "用户名/密码" 认证</span></span><br><span class="line"></span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure><p><strong>注释</strong>:</p><ul><li>看到一些文档说开启ldap以后需要注释<code>cert client.crt</code>、<code>key client.key</code>，因为配置了 LDAP 不再需要客户端证书和密钥，但是在实际应用中，只要添加了<code>auth-user-pass</code>，不注释该两行也是可行的。因为在连接的时候就会提示输入账号和密码，否则不过。</li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;企业内一般都有ldap，基本上所有的系统都支持ldap登录，openvpn也不例外，
    
    </summary>
    
      <category term="vpn" scheme="https://www.xxlaila.cn/categories/vpn/"/>
    
    
      <category term="openvpn" scheme="https://www.xxlaila.cn/tags/openvpn/"/>
    
  </entry>
  
  <entry>
    <title>openvpn部署</title>
    <link href="https://www.xxlaila.cn/2020/03/10/openvpn%E9%83%A8%E7%BD%B2/"/>
    <id>https://www.xxlaila.cn/2020/03/10/openvpn部署/</id>
    <published>2020-03-10T11:48:13.000Z</published>
    <updated>2020-05-12T07:21:21.790Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于公司内部系统比较多，而且这部分系统都是只能在公司内网访问，<a id="more"></a>当人员出差或者不在办公室的时候就没办法访问，根据需求搭建vpn，来提供给员工访问，之前做的ipsec vpn，由于不是特别的稳定的，于是就选择使用openvpn。这里采用tls认证登录，根据每个员工进行建立账号。</p><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OpenVPN 是一个用于创建虚拟专用网络加密通道的软件包，OpenVPN 允许创建的 VPN 使用公开密钥、电子证书、或者用户名/密码来进行身份验证。它大量使用了 OpenSSL 加密库中的 SSLv3/TLSv1 协议函数库。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目前 OpenVPN 能在 Solaris、Linux、OpenBSD、FreeBSD、NetBSD、Mac OS X 与 Microsoft Windows 以及 Android 和 iOS 上运行，并包含了许多安全性的功能。它并不是一个基于 Web 的 VPN 软件，也不与 IPsec 及其他 VPN 软件包兼容。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OpenVPN 的技术核心是虚拟网卡，其次是 SSL 协议实现。</p><h3 id="openvpn有两种模式"><a href="#openvpn有两种模式" class="headerlink" title="openvpn有两种模式"></a>openvpn有两种模式</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数据包（TUN模式）或数据帧（TAP模式）</p><ul><li>TUN模式: TUN模拟了网络层设备，操作第三层数据包比如IP数据封包，创建的是三层路由隧道</li><li>TAP模式: 等同于一个以太网设备，它操作第二层数据包如以太网数据帧，创建一个以太网桥接,相对复杂<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TAP 接口的好处在于,客户端可以获得 VPN 服务器所处子网的 IP(忽略物理上的区别,可以完全将客户端看做是与VPN服务器处于同一子网的另一台机器)，而TUN 接口下所有的客户端则处于一个完全独立的子网内,与 VPN 服务器所在的子网没有关系，这种使用比较好，和公司的网络区分开，完全一个虚拟的网络。</li></ul><h4 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.4.1708 (Core)</span><br><span class="line"></span><br><span class="line">uname -a</span><br><span class="line">Linux k8s-nfs-data.kxl 3.10.0-693.el7.x86_64 <span class="comment">#1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure><h4 id="添加yum源"><a href="#添加yum源" class="headerlink" title="添加yum源"></a>添加yum源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.163.com/.<span class="built_in">help</span>/CentOS7-Base-163.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h4 id="安装-openvpn和easy-rsa"><a href="#安装-openvpn和easy-rsa" class="headerlink" title="安装 openvpn和easy-rsa"></a>安装 openvpn和easy-rsa</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install openvpn easy-rsa lzop</span><br><span class="line">yum install -y net-tools.x86_64 ntp ntpdate bridge-utils gcc  openssl-devel pam-devel zip</span><br></pre></td></tr></table></figure><h4 id="开启系统系统IP转发"><a href="#开启系统系统IP转发" class="headerlink" title="开启系统系统IP转发"></a>开启系统系统IP转发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="comment">#修改或添加参数</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行生效</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><h3 id="证书准备"><a href="#证书准备" class="headerlink" title="证书准备"></a>证书准备</h3><h4 id="配置easy-rsa-3-0"><a href="#配置easy-rsa-3-0" class="headerlink" title="配置easy-rsa-3.0"></a>配置easy-rsa-3.0</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;使用 easy-rsa 生成需要的证书及相关文件，在这个阶段会产生一些 key 和证书：</p><ul><li>CA 根证书</li><li>OpenVPN 服务器 ssl 证书</li><li>Diffie-Hellman 算法用到的 key</li></ul><h4 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将 easy-rsa 脚本复制到 /etc/openvpn/，该脚本主要用来方便地生成 CA 证书和各种 key，也可以根据版本号来进行复制，只复制需要的部分。查看 easy-rsa 版本号：<code>yum info easy-rsa</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa</span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa/</span><br><span class="line">\rm 3 3.0</span><br><span class="line"><span class="built_in">cd</span> 3.0.6/</span><br></pre></td></tr></table></figure><h4 id="编辑vars-文件"><a href="#编辑vars-文件" class="headerlink" title="编辑vars 文件"></a>编辑vars 文件</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vars 文件中定义的变量是用于生成证书的基本信息，没这个文件可新建，填写如下内容（变量值根据实际情况随便填写）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span></span><br><span class="line">/etc/openvpn/easy-rsa/3.0.6</span><br><span class="line"></span><br><span class="line">vim vars</span><br><span class="line"><span class="built_in">export</span> KEY_SIZE=2048 //生成密钥的位数</span><br><span class="line"><span class="built_in">export</span> KEY_COUNTRY=<span class="string">"CN"</span>   //你所在国家码，2个字符</span><br><span class="line"><span class="built_in">export</span> KEY_PROVINCE=<span class="string">"CQ"</span>   //你所在省份</span><br><span class="line"><span class="built_in">export</span> KEY_CITY=<span class="string">"CHONGQING"</span>   //你所在城市</span><br><span class="line"><span class="built_in">export</span> KEY_ORG=<span class="string">"xxlaila"</span>      //你所在组织</span><br><span class="line"><span class="built_in">export</span> KEY_EMAIL=admin@xxlaila.cn  //你的邮箱地址</span><br><span class="line"><span class="built_in">export</span> KEY_CN=ceshi  //随意</span><br><span class="line"><span class="built_in">export</span> KEY_NAME=ceshi  //随意</span><br><span class="line"><span class="built_in">export</span> KEY_OU=xxlaila  //你所在的单位</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使变量生效</span></span><br><span class="line"><span class="built_in">source</span> ./vars</span><br></pre></td></tr></table></figure><h4 id="生成-CA-根证书"><a href="#生成-CA-根证书" class="headerlink" title="生成 CA 根证书"></a>生成 CA 根证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始化 pki 相关目录</span></span><br><span class="line">./easyrsa init-pki</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成 CA 根证书, 输入 Common Name，名字随便起。</span></span><br><span class="line">./easyrsa build-ca nopass</span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: ./vars</span><br><span class="line"></span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">....................................................................+++</span><br><span class="line">.....+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [Easy-RSA CA]:xxlaila.cn</span><br><span class="line"></span><br><span class="line">CA creation complete and you may now import and sign cert requests.</span><br><span class="line">Your new CA certificate file <span class="keyword">for</span> publishing is at:</span><br><span class="line">/etc/openvpn/easy-rsa/3.0.6/pki/ca.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书如下</span></span><br><span class="line"><span class="comment"># find ./ -name ca*</span></span><br><span class="line">./x509-types/ca</span><br><span class="line">./pki/private/ca.key</span><br><span class="line">./pki/ca.crt</span><br></pre></td></tr></table></figure><h4 id="生成-OpenVPN-服务器证书和密钥"><a href="#生成-OpenVPN-服务器证书和密钥" class="headerlink" title="生成 OpenVPN 服务器证书和密钥"></a>生成 OpenVPN 服务器证书和密钥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一个参数 server 为证书名称，可以随便起，比如 ./easyrsa build-server-full openvpn nopass</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./easyrsa build-server-full server nopass</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: ./vars</span><br><span class="line"></span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line">..+++</span><br><span class="line">.........................................................................................................................................................+++</span><br><span class="line">writing new private key to <span class="string">'/etc/openvpn/easy-rsa/3.0.6/pki/private/server.key.7zl4ekqsBM'</span></span><br><span class="line">-----</span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa/3.0.6/pki/safessl-easyrsa.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">'s Distinguished Name is as follows</span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:'</span>server<span class="string">'</span></span><br><span class="line"><span class="string">Certificate is to be certified until Feb 14 07:19:05 2023 GMT (1080 days)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br></pre></td></tr></table></figure><h4 id="生成-Diffie-Hellman-算法需要的密钥文件"><a href="#生成-Diffie-Hellman-算法需要的密钥文件" class="headerlink" title="生成 Diffie-Hellman 算法需要的密钥文件"></a>生成 Diffie-Hellman 算法需要的密钥文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa gen-dh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成文件</span></span><br><span class="line">find ./ -name server*</span><br><span class="line">./x509-types/server</span><br><span class="line">./x509-types/serverClient</span><br><span class="line">./pki/private/server.key</span><br><span class="line">./pki/reqs/server.req</span><br><span class="line">./pki/issued/server.crt</span><br></pre></td></tr></table></figure><h4 id="生成-tls-auth-key"><a href="#生成-tls-auth-key" class="headerlink" title="生成 tls-auth key"></a>生成 tls-auth key</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这个 key 主要用于防止 DoS 和 TLS 攻击，这一步其实是可选的，但为了安全还是生成一下，该文件在后面配置 open VPN 时会用到。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn --genkey --secret ta.key</span><br></pre></td></tr></table></figure><h4 id="生成自动吊销用户证书"><a href="#生成自动吊销用户证书" class="headerlink" title="生成自动吊销用户证书"></a>生成自动吊销用户证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa gen-crl</span><br><span class="line">Note: using Easy-RSA configuration from: ./vars</span><br><span class="line"></span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa/3.0.6/pki/safessl-easyrsa.cnf</span><br><span class="line"></span><br><span class="line">An updated CRL has been created.</span><br><span class="line">CRL file: /etc/openvpn/easy-rsa/3.0.6/pki/crl.pem</span><br></pre></td></tr></table></figure><p><strong>注</strong>：crl.pem证书的不能移动，否则在后期删除用户认证的时候不生效，保持该目录即可</p><h4 id="整理证书"><a href="#整理证书" class="headerlink" title="整理证书"></a>整理证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/openvpn/server/certs &amp;&amp; <span class="built_in">cd</span> /etc/openvpn/server/certs/</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/pki/dh.pem ./</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/pki/ca.crt ./</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/pki/issued/server.crt ./</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/pki/private/server.key ./</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/ta.key ./</span><br><span class="line"></span><br><span class="line">ls -ltrh</span><br><span class="line">total 24K</span><br><span class="line">-rw------- 1 root root  424 Mar  1 15:27 dh.pem</span><br><span class="line">-rw------- 1 root root 1.2K Mar  1 15:27 ca.crt</span><br><span class="line">-rw------- 1 root root 4.5K Mar  1 15:28 server.crt</span><br><span class="line">-rw------- 1 root root 1.7K Mar  1 15:28 server.key</span><br><span class="line">-rw------- 1 root root  636 Mar  1 15:28 ta.key</span><br></pre></td></tr></table></figure><h3 id="openvpn-server配置"><a href="#openvpn-server配置" class="headerlink" title="openvpn server配置"></a>openvpn server配置</h3><h4 id="创建-open-VPN-日志目录"><a href="#创建-open-VPN-日志目录" class="headerlink" title="创建 open VPN 日志目录"></a>创建 open VPN 日志目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/<span class="built_in">log</span>/openvpn/</span><br><span class="line">chown openvpn:openvpn /var/<span class="built_in">log</span>/openvpn</span><br></pre></td></tr></table></figure><h4 id="配置-OpenVPN"><a href="#配置-OpenVPN" class="headerlink" title="配置 OpenVPN"></a>配置 OpenVPN</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 可以从 /usr/share/doc/openvpn-/sample/sample-config-files 复制一份 demo 到 /etc/openvpn/（openvpn 版本号查看：<code>yum info openvpn</code>。）然后改改，或者从头开始创建一个新的配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openvpn/</span><br><span class="line"></span><br><span class="line">vim server.conf</span><br><span class="line">port 1194   <span class="comment"># 监听的端口号</span></span><br><span class="line">proto udp   <span class="comment"># 服务端用的协议，udp,默认udp</span></span><br><span class="line">dev tun</span><br><span class="line">ca /etc/openvpn/server/certs/ca.crt  <span class="comment">#   CA 根证书路径</span></span><br><span class="line">cert /etc/openvpn/server/certs/server.crt  <span class="comment"># open VPN 服务器证书路径</span></span><br><span class="line">key /etc/openvpn/server/certs/server.key  <span class="comment"># open VPN 服务器密钥路径，This file should be kept secret</span></span><br><span class="line">dh /etc/openvpn/server/certs/dh.pem  <span class="comment"># Diffie-Hellman 算法密钥文件路径</span></span><br><span class="line">tls-auth /etc/openvpn/server/certs/ta.key 0 <span class="comment"># 开启TLS-auth，使用ta.key防御攻击。服务器端的第二个参数值为0，客户端的为1。</span></span><br><span class="line">ifconfig-pool-persist ipp.txt <span class="comment">#服务器自动给客户端分配IP后，客户端下次连接时，仍然采用上次的IP地址(第一次分配的IP保存在ipp.txt中，下一次分配其中保存的IP)。</span></span><br><span class="line">push <span class="string">"route 10.0.0.0 255.0.0.0"</span>   <span class="comment"># # 推送路由和DNS到客户端</span></span><br><span class="line">push <span class="string">"route 172.21.16.0 255.255.240.0"</span>  <span class="comment"># 推送路由到客户端，如果内网服务器地址是172.21.16.0的网段，可以增加此行，然后就可以ping通内网地址的所有服务器</span></span><br><span class="line">server 10.8.0.0 255.255.255.0   <span class="comment"># 该网段为 open VPN 虚拟网卡网段，不要和内网网段冲突即可。open VPN 默认为 10.8.0.0/24</span></span><br><span class="line">push <span class="string">"dhcp-option DNS 8.8.8.8"</span>  <span class="comment"># DNS 服务器配置，可以根据需要指定其他 ns</span></span><br><span class="line">push <span class="string">"dhcp-option DNS 8.8.4.4"</span></span><br><span class="line"><span class="comment"># push "redirect-gateway def1"   # 客户端所有流量都通过 open VPN 转发，类似于代理开全局，VPN服务器本身要通过客户端原来的网关访问(取消redirect-gateway def1 bypass-dhcp选项后这项必须开启，否则无法访问OpenVPN服务器)</span></span><br><span class="line">compress lzo</span><br><span class="line">duplicate-cn   <span class="comment"># 如果客户端都使用相同的证书和密钥连接VPN，一定要打开这个选项，否则每个证书只允许一个人连接VPN</span></span><br><span class="line">keepalive 10 120  <span class="comment"># 每10秒ping一次，连接超时时间设为120秒。</span></span><br><span class="line">comp-lzo  <span class="comment"># 开启VPN连接压缩，如果服务器端开启，客户端也必须开启</span></span><br><span class="line">client-to-client <span class="comment">#设置客户端是否可以访问客户端</span></span><br><span class="line">persist-key <span class="comment"># 持久化选项可以尽量避免访问在重启时由于用户权限降低而无法访问的某些资源。</span></span><br><span class="line">persist-tun</span><br><span class="line">max-clients 100 <span class="comment"># 允许最大的客户端连接数，默认100</span></span><br><span class="line">user openvpn  <span class="comment"># open VPN 进程启动用户，openvpn 用户在安装完 openvpn 后就自动生成了</span></span><br><span class="line">group openvpn</span><br><span class="line"><span class="built_in">log</span> /var/<span class="built_in">log</span>/openvpn/server.log  <span class="comment"># 指定 log 文件位置</span></span><br><span class="line"><span class="built_in">log</span>-append /var/<span class="built_in">log</span>/openvpn/server.log</span><br><span class="line">status /var/<span class="built_in">log</span>/openvpn/status.log</span><br><span class="line">verb 3</span><br><span class="line">explicit-exit-notify 1  <span class="comment"># 设置断线重连功能</span></span><br><span class="line">cipher AES-256-CBC    <span class="comment">#指定数据对称加密算法</span></span><br><span class="line">reneg-sec 0   <span class="comment">#reneg-sec服务器端会定期检查认证情况，默认3600秒一小时，使用OTP的话尽量时间长一些，否则客户端需要重新输入用户名密码和OTP一次性密码。</span></span><br><span class="line">auth-nocache  <span class="comment">#断线后防止内存中保存用户名和密码来提高安全性</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li>openvpn 2.4.8 版本启动协议需要使用udp，否则无法启动，启动的时候会提示<code>Options error: --explicit-exit-notify can only be used with --proto udp</code>，而且默认配置文件里面协议也是udp。udp协议有很多好处，<a href="https://www.cnblogs.com/nieliangcai/p/10362751.html" target="_blank" rel="noopener">可以参考</a>说明</li><li>push “redirect-gateway def1”: 参数，如果添加该参数，所有客户端的默认网关都将重定向到VPN，这将导致诸如web浏览器、DNS查询等所有客户端流量都经过这里。但是在实际的应用中，我们期望的是只有需要进过vpn流量的时候才走vpn，其他的就正常走我们自己的网络就可以啦。所以在server.conf文件里面这行就需要注释掉。</li></ul><h4 id="防火墙相关配置"><a href="#防火墙相关配置" class="headerlink" title="防火墙相关配置"></a>防火墙相关配置</h4><h5 id="禁用-Centos7-默认的-firewalld和SELinux"><a href="#禁用-Centos7-默认的-firewalld和SELinux" class="headerlink" title="禁用 Centos7 默认的 firewalld和SELinux"></a>禁用 Centos7 默认的 firewalld和SELinux</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 马上生效</span></span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭(需要重启服务器生效)</span></span><br><span class="line">sed -i ‘s/SELINUX=enforcing/SELINUX=disabled/g’ /etc/selinux/config</span><br></pre></td></tr></table></figure><h5 id="启用iptables"><a href="#启用iptables" class="headerlink" title="启用iptables"></a>启用iptables</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> iptables</span><br><span class="line">systemctl start iptables</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有防火墙规则</span></span><br><span class="line">iptables -F</span><br></pre></td></tr></table></figure><h5 id="添加防火墙规则"><a href="#添加防火墙规则" class="headerlink" title="添加防火墙规则"></a>添加防火墙规则</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 openvpn 的网络流量转发到公网：snat 规则</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables 规则持久化保存</span></span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">sudo /usr/libexec/iptables/iptables.init save</span><br></pre></td></tr></table></figure><h5 id="规则查看"><a href="#规则查看" class="headerlink" title="规则查看"></a>规则查看</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -nvL -t nat</span><br></pre></td></tr></table></figure><h4 id="启动-open-VPN"><a href="#启动-open-VPN" class="headerlink" title="启动 open VPN"></a>启动 open VPN</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start openvpn@server</span><br><span class="line">systemctl <span class="built_in">enable</span> openvpn@server</span><br><span class="line">systemctl status openvpn@server</span><br></pre></td></tr></table></figure><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -antpu | grep openvpn</span><br><span class="line">udp        0      0 0.0.0.0:1194            0.0.0.0:*                           1787/openvpn</span><br></pre></td></tr></table></figure><h4 id="路由器端口映射"><a href="#路由器端口映射" class="headerlink" title="路由器端口映射"></a>路由器端口映射</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于公司只有一个公网Ip，所以只能在路由器上做端口映射，<a href="https://www.xxlaila.cn/2019/09/10/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/">端口映射</a>参考</p><h3 id="openvpn-client"><a href="#openvpn-client" class="headerlink" title="openvpn client"></a>openvpn client</h3><h4 id="OpenVPN客户端配置"><a href="#OpenVPN客户端配置" class="headerlink" title="OpenVPN客户端配置"></a>OpenVPN客户端配置</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;要连接到 open VPN 服务端首先得需要一个客户端软件，在 Mac 下推荐使用 <a href="https://tunnelblick.net/downloads.html" target="_blank" rel="noopener">Tunnelblick</a>。Tunnelblick 是一个开源、免费的 Mac 版 open VPN 客户端软件。如果Tunnelblick安装失败，不要用常见的方式进行卸载，要在Tunnelblick的官方下载一个Tunnelblick的卸载安装包进行Tunnelblick的卸载，否则不成功。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面在服务端创建一个 open VPN 用户：其实创建用户的过程就是生成客户端 SSL 证书的过程，然后将其他相关的证书文件、key、.ovpn 文件（客户端配置文件）打包到一起供客户端使用。由于创建一个用户的过程比较繁琐，所以在此将整个过程写成了一个脚本 vpn_user.sh，然后定义一个客户端基础的模版文件 sample.ovpn。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先创建一个客户端配置模板文件 sample.ovpn，该文件在脚本中会用到，放到 /etc/openvpn/client/ 目录，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat sample.ovpn</span><br><span class="line">client</span><br><span class="line">proto udp</span><br><span class="line">dev tun</span><br><span class="line">remote [open VPN服务端公网 ip，根据实际情况填写] 1194  //openvpn服务器的外网IP和端口(可以写多个做到高可用)</span><br><span class="line">ca ca.crt</span><br><span class="line">cert admin.crt</span><br><span class="line">key admin.key</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">remote-cert-tls server  //指定采用服务器校验方式</span><br><span class="line">comp-lzo</span><br><span class="line">verb 3     //调试信息级别</span><br><span class="line">mute-replay-warnings</span><br><span class="line">resolv-retry infinite    //断线自动重新连接</span><br><span class="line">nobind    //不绑定特定的本地端口号</span><br><span class="line">persist-key    //与服务器端的保持一致</span><br><span class="line">persist-tun    //与服务器端的保持一致</span><br><span class="line">cipher AES-256-CBC    //指定数据对称加密算法</span><br></pre></td></tr></table></figure><p><strong>注</strong>: client.key 和 client.crt 替换为用户的key。</p><h4 id="linux-客户端"><a href="#linux-客户端" class="headerlink" title="linux 客户端"></a>linux 客户端</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;需要在linux服务器上安装openvpn，安装完成以后增加配置文件即可。client.ovpn配置文件和上述mac 配置文件一致，下面贴出有区别后的结果。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装openvpn</span></span><br><span class="line">yum -y install openvpn</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/client</span><br><span class="line"><span class="comment"># 把生成后的配置文件解压到该目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动openvpn 客户端</span></span><br><span class="line">nohup /usr/sbin/openvpn --config /etc/openvpn/client/usernmae.ovpn --<span class="built_in">log</span>-append /tmp/openvpn.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用账号和密码登录，需要使用systemd-tty-ask-password-agent来进行账号和密码输入登录认证,如下</span></span><br><span class="line"></span><br><span class="line">Password entry required <span class="keyword">for</span> <span class="string">'Enter Auth Username:'</span> (PID 4699).</span><br><span class="line">Please enter password with the systemd-tty-ask-password-agent tool!</span><br><span class="line"></span><br><span class="line">systemd-ask-password</span><br><span class="line">systemd-ask-password: required argument missing.</span><br><span class="line">Enter Auth Username: username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Broadcast message from root@VM_11-11_centos (Fri 2020-03-13 10:24:49 CST):</span><br><span class="line">Password entry required <span class="keyword">for</span> <span class="string">'Enter Auth Password:'</span> (PID 4762).</span><br><span class="line">Please enter password with the systemd-tty-ask-password-agent tool!</span><br><span class="line">systemd-tty-ask-password-agent</span><br><span class="line">Enter Auth Password: *********</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以查看/tmp/openvpn.log日志输出的记录信息。里面包含了一些路由的添加</p><h4 id="linux-下结果验证"><a href="#linux-下结果验证" class="headerlink" title="linux 下结果验证"></a>linux 下结果验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ifconfig tun0</span><br><span class="line">tun0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 10.8.0.10  netmask 255.255.255.255  destination 10.8.0.9</span><br><span class="line">        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 100  (UNSPEC)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><h4 id="windows下的client-ovpn配置文件"><a href="#windows下的client-ovpn配置文件" class="headerlink" title="windows下的client.ovpn配置文件"></a>windows下的client.ovpn配置文件</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;windows 客户端在官方下载对应的系统的客户端进行安装，安装完成后会在当前的用户目录下面有一个<code>C:\Users\username\OpenVPN\config\</code>的路径，吧在服务器上生成的username.zip解压到该目录下面即可。然后点击链接。windows 客户端的配置文件如下，和上面的一样。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat sample.ovpn</span><br><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto udp</span><br><span class="line">remote [open VPN服务端公网 ip，根据实际情况填写] 1194  //openvpn服务器的外网IP和端口(可以写多个做到高可用)</span><br><span class="line">resolv-retry infinite</span><br><span class="line"><span class="comment"># redirect-gateway def1#让客户端发起的所有IP请求都通过OpenVPN服务器</span></span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">cert admin.crt</span><br><span class="line">key admin.key</span><br><span class="line"><span class="comment">#auth-user-pass   //用用户名密码登陆认证方式</span></span><br><span class="line">remote-cert-tls server</span><br><span class="line">tls-auth ta.key 1<span class="comment">#ta.key</span></span><br><span class="line">tls-client<span class="comment">#TLS加密传输</span></span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure><p><strong>注释</strong>:</p><ul><li>auth-user-pass: 该参数是注释掉的，如果开启该参数，任意的账户和密码都可以链接vpn，非常的不安全，如果客户端开启这个参数，服务器端一定要启用用户认证。<a href="https://openvpn.net/community-resources/using-alternative-authentication-methods/" target="_blank" rel="noopener">用户认证</a>参考</li></ul><h4 id="创建-open-VPN-用户脚本"><a href="#创建-open-VPN-用户脚本" class="headerlink" title="创建 open VPN 用户脚本"></a>创建 open VPN 用户脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat vpn_user.sh</span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">OVPN_USER_KEYS_DIR=/etc/openvpn/client/keys</span><br><span class="line">EASY_RSA_VERSION=3.0.6</span><br><span class="line">EASY_RSA_DIR=/etc/openvpn/easy-rsa/</span><br><span class="line">PKI_DIR=<span class="variable">$EASY_RSA_DIR</span>/<span class="variable">$EASY_RSA_VERSION</span>/pki</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ -d <span class="string">"<span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    rm -rf <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span></span><br><span class="line">    rm -rf  <span class="variable">$PKI_DIR</span>/reqs/<span class="variable">$user</span>.req</span><br><span class="line">    sed -i <span class="string">'/'</span><span class="string">"<span class="variable">$user</span>"</span><span class="string">'/d'</span> <span class="variable">$PKI_DIR</span>/index.txt</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$EASY_RSA_DIR</span>/<span class="variable">$EASY_RSA_VERSION</span></span><br><span class="line">  <span class="comment"># 生成客户端 ssl 证书文件</span></span><br><span class="line">  ./easyrsa build-client-full <span class="variable">$user</span> nopass</span><br><span class="line">  <span class="comment"># 整理下生成的文件</span></span><br><span class="line">  mkdir -p  <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span></span><br><span class="line">  cp <span class="variable">$PKI_DIR</span>/ca.crt <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/   <span class="comment"># CA 根证书</span></span><br><span class="line">  cp <span class="variable">$PKI_DIR</span>/issued/<span class="variable">$user</span>.crt <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/   <span class="comment"># 客户端证书</span></span><br><span class="line">  cp <span class="variable">$PKI_DIR</span>/private/<span class="variable">$user</span>.key <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/  <span class="comment"># 客户端证书密钥</span></span><br><span class="line">  cp /etc/openvpn/client/sample.ovpn <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/<span class="variable">$user</span>.ovpn <span class="comment"># 客户端配置文件</span></span><br><span class="line">  sed -i <span class="string">'s/admin/'</span><span class="string">"<span class="variable">$user</span>"</span><span class="string">'/g'</span> <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/<span class="variable">$user</span>.ovpn</span><br><span class="line">  cp /etc/openvpn/server/certs/ta.key <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/ta.key  <span class="comment"># auth-tls 文件</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$OVPN_USER_KEYS_DIR</span></span><br><span class="line">  zip -r <span class="variable">$user</span>.zip <span class="variable">$user</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;执行上面脚本创建一个用户：sh vpn_user.sh<username>，会在 /etc/openvpn/client/keys 目录下生成以用户名命名的 zip 打包文件，将该压缩包下载到本地解压，然后将里面的 .ovpn 文件拖拽到 Tunnelblick 客户端软件即可使用。客户端目录随意存放。生产的内容如下</username></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── ca.crt</span><br><span class="line">├── username.crt</span><br><span class="line">├── username.key</span><br><span class="line">├── username.ovpn</span><br><span class="line">└── ta.key</span><br></pre></td></tr></table></figure><h4 id="删除一个-OpenVPN-用户"><a href="#删除一个-OpenVPN-用户" class="headerlink" title="删除一个 OpenVPN 用户"></a>删除一个 OpenVPN 用户</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上面介绍了如何添加一个用户，如果公司员工离职了或者其他原因，想删除对应用户 OpenVPN 的使用权，只要吊销对应用户的 SSL 证书即可。因为OpenVPN 的客户端和服务端的认证主要通过 SSL 证书进行双向认证。</p><h5 id="编辑-OpenVPN-服务端配置-server-conf-添加如下配置"><a href="#编辑-OpenVPN-服务端配置-server-conf-添加如下配置" class="headerlink" title="编辑 OpenVPN 服务端配置 server.conf 添加如下配置:"></a>编辑 OpenVPN 服务端配置 server.conf 添加如下配置:</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crl-verify /etc/openvpn/easy-rsa/3.0.6/pki/crl.pem</span><br></pre></td></tr></table></figure><h5 id="吊销用户证书"><a href="#吊销用户证书" class="headerlink" title="吊销用户证书"></a>吊销用户证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa/3.0.6/</span><br><span class="line">./easyrsa revoke username</span><br><span class="line">./easyrsa gen-crl</span><br></pre></td></tr></table></figure><h5 id="重启-OpenVPN-服务端使其生效"><a href="#重启-OpenVPN-服务端使其生效" class="headerlink" title="重启 OpenVPN 服务端使其生效"></a>重启 OpenVPN 服务端使其生效</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openvpn@server</span><br></pre></td></tr></table></figure><h5 id="一键删除用户"><a href="#一键删除用户" class="headerlink" title="一键删除用户"></a>一键删除用户</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat del_vpn_user.sh</span><br><span class="line"><span class="comment"># ! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line">OVPN_USER_KEYS_DIR=/etc/openvpn/client/keys</span><br><span class="line">EASY_RSA_VERSION=3.0.6</span><br><span class="line">EASY_RSA_DIR=/etc/openvpn/easy-rsa/</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$EASY_RSA_DIR</span>/<span class="variable">$EASY_RSA_VERSION</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">'yes\n'</span> | ./easyrsa revoke <span class="variable">$user</span></span><br><span class="line">  ./easyrsa gen-crl</span><br><span class="line">  <span class="comment"># 吊销掉证书后清理客户端相关文件</span></span><br><span class="line">  <span class="keyword">if</span> [ -d <span class="string">"<span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    rm -rf <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$&#123;user&#125;</span>*</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  systemctl restart openvpn@server</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上述配置完成了用户流量的分配，必要的地址都vpn，其余的走正常的自己的网络。不会全部走vpn。</p><blockquote><p>引用: <a href="https://www.yeboyzq.com/linux/fuwuqipeizhi/989.html" target="_blank" rel="noopener">https://www.yeboyzq.com/linux/fuwuqipeizhi/989.html</a><br><a href="https://qhh.me/2019/06/16/Cenos7-%E4%B8%8B%E6%90%AD%E5%BB%BA-OpenVPN-%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" target="_blank" rel="noopener">https://qhh.me/2019/06/16/Cenos7-%E4%B8%8B%E6%90%AD%E5%BB%BA-OpenVPN-%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;由于公司内部系统比较多，而且这部分系统都是只能在公司内网访问，
    
    </summary>
    
      <category term="vpn" scheme="https://www.xxlaila.cn/categories/vpn/"/>
    
    
      <category term="openvpn" scheme="https://www.xxlaila.cn/tags/openvpn/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes里的Service究竟是如何工作</title>
    <link href="https://www.xxlaila.cn/2020/03/01/Kubernetes%E9%87%8C%E7%9A%84Service%E7%A9%B6%E7%AB%9F%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C/"/>
    <id>https://www.xxlaila.cn/2020/03/01/Kubernetes里的Service究竟是如何工作/</id>
    <published>2020-03-01T03:31:06.000Z</published>
    <updated>2020-05-12T07:21:21.720Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Service是Kubernetes接入层的一种抽象资源，它为我们提供了一种固定的、统一的访问接口地址和负载均衡能力，<a id="more"></a>这时可能会想到，当时使用docker-compose的时候，不存在Service概念，不也运行起来了吗？是的，在Kubernetes集群内部Pod ip也是互通的，但是Pod的ip会经常因为扩容、重建而导致客户端访问错误，pod访问无法提供负载均衡的能力，而Service通过选择一组Pod的label就直接可以访问到Pod，而且可以使用万年不变的域名，所以就选择Service了。</p><h3 id="Service是怎么产生的，在集群内部是如何存在的呢"><a href="#Service是怎么产生的，在集群内部是如何存在的呢" class="headerlink" title="Service是怎么产生的，在集群内部是如何存在的呢"></a>Service是怎么产生的，在集群内部是如何存在的呢</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在kubernetes当中所谓的Service是kube-proxy生成iptables或ipvs规则，它会产生一组虚拟地址，在集群环境下有效。Service不能直接到达Pod内部，中间会间隔EndPoints，这是一组ip和port的组合。默认类型是ClusterIP它仅能接收集群中pod客户端程序的访问请求。这也是最常用的一种类型，另外还有NodePort、LoadBalancer、ExternalName。</p><h3 id="iptables或ipvs，到底是iptables还是ipvs呢？"><a href="#iptables或ipvs，到底是iptables还是ipvs呢？" class="headerlink" title="iptables或ipvs，到底是iptables还是ipvs呢？"></a>iptables或ipvs，到底是iptables还是ipvs呢？</h3><blockquote><p>一个Service对象就是工作节点上的一些iptables或ipvs规则，用于将到达Service对象IP地址的流量调度转发至相应的Endpoints对象指向的IP地址和端口之上。</p></blockquote><p>这句话我们经常看到，如何理解呢？</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes1.1之前是基于userspace实现，这种模型之下，每次请求流量要先到达内核空间，经有套接字转发到kube-proxy，然后再由它送回到内核空间，之后调度到后端pod之上，可以看出请求在用户空间和内核空间来回转发，效率必然不高。但是当pod无响应时，能够自动重定向到其它pod。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在Kubernetes1.1版本开始引入iptables规则，Kubernetes1.2开始成为默认类型。即在创建Service资源时，集群上每个节点的kube-proxy都会收到通知，并且创建iptables规则，用于转发到此Service ClusterIP的流量。工作TCP/IP的传输层，高效稳定。</p><p>但是这种方式有如下缺点：</p><ul><li>1、iptables代理模型挑中的pod无响应时，不能自动重定向到集群内部其它pod资源对象之上。</li><li>2、kube-proxy通过iptables处理Service和pod的交互，每产生一个计算节点或者产生大量的pod就需要产生相应大量的iptables规则，不难想象，这些iptables规则每次需要刷新匹配保证正确性，就需要占用大量的CPU资源，所以基于iptables的Service实现就成了制约Kubernetes承载更多pod的瓶颈。</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在Kubernetes1.11开始默认使用ipvs模型，在这种模型下kube-proxy会跟踪APIServer上Service和endpoints对象变化，调用netlink创建ipvs规则，请求调度流量功能由ipvs实现，运行于netfilter之上的钩子函数，具有流量转发速度快，规则性能同步好的特点，支持众多调度算法，剩下仍然由iptables完成。说到这里我们就大概明白了iptables和ipvs的作用和关系了。</p><h3 id="Kubernetes的服务发现是通过dns实现，那么为什么会出现四种类型的服务暴露方式呢？"><a href="#Kubernetes的服务发现是通过dns实现，那么为什么会出现四种类型的服务暴露方式呢？" class="headerlink" title="Kubernetes的服务发现是通过dns实现，那么为什么会出现四种类型的服务暴露方式呢？"></a>Kubernetes的服务发现是通过dns实现，那么为什么会出现四种类型的服务暴露方式呢？</h3><p>说到Service不得不介绍kubernetes网络模型和通信方式<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一个完整的Kubernetes集群应该包含三层网络，首先第一层是mater和node节点之间的网络，这个网络需要在部署kubernetes集群之前配置完成；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第二层网络是pod的网络通过kubelet或者cni插件实现，用于pod之间或者内部的通信，集群中的所有pod均处在同一个网络平面空间内，可以直接通信；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第三层网络是Service资源的网络，是一个虚拟网络，用于为Kubernetes集群配置IP地址，但此地址并不配置于任何主机或者容器的网络接口之上，而是通过kubeproxy配置为iptables规则，将发往该地址的所有流量调度至后端的pod之上。</p><p>通信方式分为以下四种：</p><ul><li>同一个pod的内部通信；</li><li>各个pod彼此通信；</li><li>pod和service的通信；</li><li>集群外部流向service的通信。</li></ul><p>所以Service为了满足这些通信方式就出现了如下类型：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP：为集群内部ip地址暴露服务，仅在集群内可达，外部ip无法访问，默认Service类型；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NodePort：这种类型建立在clusterIp之上，为节点的IP地址暴NodePort服务，外部节点可以通过NodeIP:NodePort直接访问；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoadBalancer：这种类型构建在NodePort之上，它可以关联到集群外部的某个负载均衡设备。Kubernetes没有为私有化集群提供LoadBalancer的支持。如果在私有化集群使用需要自建负载均衡器；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExternalName：其通过将Service映射至由externalName字段的内容指定的主机名来暴露服务，此主机名需要被DNS服务解析至CNAME类型的记录。这句话怎么理解呢？</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举个例子，你所有的服务都在集群内部，但是你有个数据库是mongodb，没有实现容器化，更没有部署在Kubernetes内部，当然你可以通过在ConfigMap中添加配置访问这个外部服务，但是当你的环境发生变化，比如从开发环境和生产环境的数据地址不同，这个时候你需要修改和重建ConfigMap。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个时候可以使用Kubernetes ExternalName内置服务发现机制运用于集群外部运行的服务，像使用集群内的服务一样使用外部服务！通过这种方式，您可以在开发环境和生产环境中实现相同的功能，如果您最终将服务移入集群内，则不需要更改任何代码和配置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line"> name: mongo</span><br><span class="line">spec:</span><br><span class="line"> <span class="built_in">type</span>: ExternalName</span><br><span class="line"> externalName: mango123456.com</span><br></pre></td></tr></table></figure><p>你只需要访问：mongodb://<dbuser>:<dbpassword>@mongo:<port>就可以自动访问外部服务。</port></dbpassword></dbuser></p><h3 id="Service本身有端口、Pod也有端口、容器也有端口，之间有什么关系呢？"><a href="#Service本身有端口、Pod也有端口、容器也有端口，之间有什么关系呢？" class="headerlink" title="Service本身有端口、Pod也有端口、容器也有端口，之间有什么关系呢？"></a>Service本身有端口、Pod也有端口、容器也有端口，之间有什么关系呢？</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;containerPort：一个信息性数据，为集群提供一个可以快速了解相关pod可以访问端口的途径，而且显式指定容器端口，无论你是否指定都不影响其他节点上的客户端pod对其进行访问；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port：服务提供端口，用于kubernetes集群内部服务访问；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;targetPort：pod目标端口，如果不设置使用默认port端口，port和nodePort的数据通过这个端口进入到Pod内部，Pod里面的containers的端口映射到这个端口，提供服务；</p><p>nodePort：Kubernetes集群外部用户访问端口；</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文主要总结了Service的工作原理和机制。只有明白Service这些概念，才能灵活使用Service，当我们服务出现故障的时候，根据它的原理去分析问题到底出在什么地方，进而快速解决问题。</p><blockquote><p>来源: 微信群分享<br>原文： <a href="https://mp.weixin.qq.com/s/ucwnfpXgHFNBR3CHd5JLMQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ucwnfpXgHFNBR3CHd5JLMQ</a><br>版权: 本文版权归原作者所有</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Service是Kubernetes接入层的一种抽象资源，它为我们提供了一种固定的、统一的访问接口地址和负载均衡能力，
    
    </summary>
    
      <category term="kubernetes" scheme="https://www.xxlaila.cn/categories/kubernetes/"/>
    
    
      <category term="service" scheme="https://www.xxlaila.cn/tags/service/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch集群规划</title>
    <link href="https://www.xxlaila.cn/2020/02/20/Elasticsearch%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92/"/>
    <id>https://www.xxlaila.cn/2020/02/20/Elasticsearch集群规划/</id>
    <published>2020-02-20T07:38:04.000Z</published>
    <updated>2020-05-12T07:21:21.790Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在Elasticsearch集群规划中，如何规划集群，合理的规划集群可以防止Elasticsearch出现脑裂，<a id="more"></a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为避免Elasticsearch集群出现脑裂，Elasticsearch的的config目录下elasticsearch.yml文件中配置避免脑裂的参数，常见的参数是<code>discovery.zen.minimum_master_nodes</code>,该参数决定主节点选择工程中至少需要有多少个master节点，默认配置1。基本的参数原则是N/2+1，如在一个3个节点的集群中，<code>discovery.zen.minimum_master_nodes</code>应该设置为2。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果在2个集群节点中，如果吧<code>discovery.zen.minimum_master_nodes</code>设置为2，当两个节点通信失败时，节点1会失去它的主状态，同时节点2也不会被选举为主节点。这种情况下可以配置另外一个参数来防止脑裂，<code>discovery.zen.ping.timeout</code>，默认值时3秒，用该参数来决定节点之间通信的等待时间。如在网络较差的环境里面可以调大该值。但该参数是适用于高网络延迟的情况。建议配置至少3节点的集群。</p><h3 id="分布式集群"><a href="#分布式集群" class="headerlink" title="分布式集群"></a>分布式集群</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch集群中的节点一般分为3中角色，如何区别这种角色，取决于在搭建分布式集群以前需要在配置文件中指定节点角色。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;节点简介</p><ul><li>master 节点: master节点主要负责元数据的处理；比如索引的新增、删除、分片分配等，每当元数据有更新时，master节点负责同步到其他节点上。</li><li>data 节点: data节点上保存了数据分片，负责数据相关的操作，如分片的增删改查以及搜索和整个操作。</li><li>client 节点: client节点起到路由请求作用，可以看作为负载均衡，适用于高并发访问的业务场景。</li></ul><h4 id="列子"><a href="#列子" class="headerlink" title="列子"></a>列子</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3台Elasticsearch服务器(172.21.1.10，172.21.1.11，172.21.1.12)，为避免脑裂，3台机器master节点为2（172.21.1.10，172.21.1.11），同时也为data节点。172.21.1.12为client节点，三个ip对应hostname为：node-10，node-11，node-12。</p><ul><li>172.21.1.10 节点<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: test1</span><br><span class="line">node.name: node-10</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"172.21.1.10"</span>, <span class="string">"172.21.1.11"</span>]</span><br><span class="line">http.cors.enable: <span class="literal">true</span></span><br><span class="line">http:cors.allow-origin: <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li></ul><p>注释:</p><ul><li>http.cors.enable: true,http:cors.allow-origin: “*”: 该两个参数为如果要使用head来进行监控Elasticsearch集群，需要配置此参数。<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">elasticsearch-head</a></li></ul><ul><li><p>172.21.1.11 节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: test1</span><br><span class="line">node.name: node-11</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"172.21.1.10"</span>, <span class="string">"172.21.1.11"</span>]</span><br><span class="line">http.cors.enable: <span class="literal">true</span></span><br><span class="line">http:cors.allow-origin: <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li><li><p>172.21.1.12 节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: test1</span><br><span class="line">node.name: node-12</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">node.master: <span class="literal">false</span></span><br><span class="line">node.data: talse</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"172.21.1.10"</span>, <span class="string">"172.21.1.11"</span>]</span><br><span class="line">http.cors.enable: <span class="literal">true</span></span><br><span class="line">http:cors.allow-origin: <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;启动各节点进行head验证</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch集群监控查看<a href="http://www.xxlaila.cn/2019/10/17/elasticserch%E6%97%A5%E5%B8%B8%E7%BB%B4%E6%8A%A4/">elasticserch日常维护</a>，监控插件可以参考<a href="http://www.xxlaila.cn/2019/11/19/logstash%E7%9B%91%E6%8E%A7/">logstash监控</a>末尾。</p><h3 id="Elasticsearch集群api"><a href="#Elasticsearch集群api" class="headerlink" title="Elasticsearch集群api"></a>Elasticsearch集群api</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;利用Elasticsearch 集群健康api查看当前集群的健康信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl http: //127.0.0.1:9200/_cluster/health</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span>: <span class="string">"test1"</span>,</span><br><span class="line">  <span class="string">"status"</span>: <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span>: 3,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span>: 3,</span><br><span class="line">  <span class="string">"active_primary_shards"</span>: 162,</span><br><span class="line">  <span class="string">"active_shards"</span>: 324,</span><br><span class="line">  <span class="string">"relocating_shards"</span>: 0,</span><br><span class="line">  <span class="string">"initializing_shards"</span>: 0,</span><br><span class="line">  <span class="string">"unassigned_shards"</span>: 0,</span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span>: 0,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span>: 0,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span>: 0,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span>: 0,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span>: 100.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h4><ul><li>cluster_name: 集群名称</li><li>status: 集群健康状态；green为所有的主分片和从分片都可以用，yellow所有主分片可用，但存在不可用的从分片，red存在不可用的主分片</li><li>timed_out: 是否超时</li><li>number_of_nodes: 节点数，包括master和data。</li><li>number_of_data_nodes: data节点数</li><li>active_primary_shards: 活动的主分片</li><li>active_shards: 所有活动分片数，包括主分片和副本</li><li>relocating_shards: 正在发生迁移的分片</li><li>initializing_shards: 正在初始化的分片</li><li>unassigned_shards: 没有被分配的分片</li><li>delayed_unassigned_shards: 延迟未被分配的分片</li><li>number_of_pending_tasks: master节点任务队列中的任务数</li><li>number_of_in_flight_fetch: 正在进行迁移的分片数</li><li>task_max_waiting_in_queue_millis: 队列中任务的最大等待时间</li><li>active_shards_percent_as_number: 活动分片的百分比</li></ul><h3 id="Elasticsearch容量评估"><a href="#Elasticsearch容量评估" class="headerlink" title="Elasticsearch容量评估"></a>Elasticsearch容量评估</h3><h4 id="存储容量评估"><a href="#存储容量评估" class="headerlink" title="存储容量评估"></a>存储容量评估</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch服务存储空间大小影响因素如下：</p><ul><li>副本数量：副本有利于增加数据的可靠性，但同时会增加存储成本。默认和建议的副本数量为 1。</li><li>索引开销：除原始数据外，ES 需要存储索引等数据，一般情况下数据膨胀为10% (_all等未计算)。</li><li>内部任务开销：ES 自身会占用约 20% 的磁盘空间用于段合并、日志等，因此要预留20%的此部分空间。</li><li>操作系统预留：操作系统也会占用5%的磁盘空间，用于关键流程处理、防止磁盘碎片化问题等。</li><li>安全阈值。通常至少预留15%的安全阈值。</li></ul><p>ES的实际空间可通过下面公式估算:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">实际空间 = 源数据 * (1 + 副本数量) * (1 + 索引开销) / （1-操作系统预留）/(1 - 内部任务开销) </span><br><span class="line">        = 源数据 * (1 + 副本数量) * 1.45</span><br><span class="line">        = 源数据 *2.9</span><br></pre></td></tr></table></figure><blockquote><ul><li>对于_all这项参数，如果不需要在业务上使用，通常建议您禁止或者有选择性地添加。</li><li>如果您需要开启_all参数的索引，磁盘容量的开销也会随之增大。建议在上述评估的基础上，增加空间至原来的1.5倍。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">磁盘总大小 = 源数据 * (1 + 副本数) * 1.7 * (1 + 0.5) </span><br><span class="line">= 源数据 * 5.1</span><br></pre></td></tr></table></figure></li></ul></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了保证服务能稳定运行，建议在上述评估的基础上至少预留50%的存储空间，因此建议申请的存储容量为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">存储容量 = 源数据 * (1 + 副本数量) * 1.45 * （1 + 0.5）</span><br><span class="line">        = 源数据 * 4.35</span><br></pre></td></tr></table></figure><h4 id="服务配置评估"><a href="#服务配置评估" class="headerlink" title="服务配置评估"></a>服务配置评估</h4><ul><li>建议您至少选择 3 个节点，保证集群具有较高的节点故障容错能力。</li><li>如有非常大的存储容量需求，建议主机配置规格更高，有助于提升集群性能和稳定性。</li><li>可以通过观察 CPU 使用率、集群查询QPS、集群写入QPS等监控指标，判断配置是否足够</li></ul><h4 id="分片数量评估"><a href="#分片数量评估" class="headerlink" title="分片数量评估"></a>分片数量评估</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard大小和数量是影响ES集群稳定性和性能的重要因素之一。ES集群中任何一个索引都需要有一个合理的shard规划（默认为5个）。索引分片的数量会影响集群稳定性和性能，且通常确定后无法轻松更改，需要提前规划：</p><ul><li>建议单个分片大小在小规格节点下不超过30GB，在高规格节点下不超过50GB。分片过大会导致ES故障的恢复速度慢，分片过小会导致内存不足等问题。</li><li>分片数量要尽量匹配节点数，分片数可以等于节点数，也可以是节点数的整数倍，方便分片在所有数据节点均匀分布。</li><li>对于日志分析或者超大索引场景，建议单个shard大小不要超过100GB。</li><li>单个节点上同一索引的shard个数不要超5个。</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;利用ansible来安装<a href="https://github.com/xxlaila/ansible" target="_blank" rel="noopener">Elasticsearch</a>集群，</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:56 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;集群规划&quot;&gt;&lt;a href=&quot;#集群规划&quot; class=&quot;headerlink&quot; title=&quot;集群规划&quot;&gt;&lt;/a&gt;集群规划&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;在Elasticsearch集群规划中，如何规划集群，合理的规划集群可以防止Elasticsearch出现脑裂，
    
    </summary>
    
      <category term="elasticsearch" scheme="https://www.xxlaila.cn/categories/elasticsearch/"/>
    
    
      <category term="elasticsearch" scheme="https://www.xxlaila.cn/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>traefik支持socketio会话</title>
    <link href="https://www.xxlaila.cn/2020/02/17/traefik%E6%94%AF%E6%8C%81socketio%E4%BC%9A%E8%AF%9D/"/>
    <id>https://www.xxlaila.cn/2020/02/17/traefik支持socketio会话/</id>
    <published>2020-02-17T10:48:57.000Z</published>
    <updated>2020-05-12T07:21:21.580Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;公司业务出现使用一个使用websocket的会话需求，和常见的web聊天工具一样，如网页QQ。<a id="more"></a>但是在研发在开发的时候没有做session会话的粘制，于是乎就是能在运维层面进行设置。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>socket.io</code>单节点模式是很容易部署的，但是往往在生产环境一个节点不能满足业务需求，况且还要保证节点挂掉的情况仍能正常提供服务，所以多节点模式就成为了生成环境的一种必须的部署模式。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将介绍如何在kubernetes 集群上部署多节点的socket.io服务，并使用traeifk 2.1 版本如何进行访问</p><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在普通环境下，我们配置websocket会话使用nginx很简单，配置一个ip_hash，其他的和普通的location配置差不多，但在kubernetes集群下，生产环境一般部署多个POD 来提供服务，而socket.io服务并不是单纯的无状态应用，只需要将POD 部署成多个就可以正常提供服务了，因为其底层需要建立很多连接来保持长连接，但是这样的话上一个请求可能会被路由到一个POD，下一个请求则很有可能会被路由到另外一个POD 中去了，这样就会出现错误。<br><img src="https://img.xxlaila.cn/1581937028934.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上图中可以看出是有的请求找不到对应的Session ID，也证明了上面提到的引起错误的原因。</p><h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从<a href="https://socket.io/docs/using-multiple-nodes/" target="_blank" rel="noopener">socket.io 官方文档</a>中可以看到对于多节点的介绍，其中通过Nginx的ip_hash 配置用得比较多，同一个ip 访问的请求通过hash 计算过后会被路由到相同的后端程序去，这样就不会出现上面的问题了。我们这里是部署在kubernetes集群上面的，通过traefik ingress来连接外部和集群内部间的请求的，所以这里中间就省略了Nginx这一层，当然你也可以多加上这一层，但是这样显然从架构上就冗余了，而且还有更好的解决方案的：sessionAffinity（也称会话亲和力）</p><blockquote><p>什么是sessionAffinity？ sessionAffinity是一个功能，将来自同一个客户端的请求总是被路由回服务器集群中的同一台服务器的能力。</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在kubernetes中启用sessionAffinity很简单，只需要简单的Service中配置即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.spec.sessionAffinity = <span class="string">"ClientIP"</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;默认情况下sessionAffinity=None，会随机选择一个后端进行路由转发的，设置成ClientIP后就和上面的ip_hash功能一样了，由于我们使用的是traefik ingress，这里还需要在Service中添加一个traefik的annotation：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: socket-demo</span><br><span class="line">  namespace: kube-apps</span><br><span class="line">  annotations:</span><br><span class="line">    traefik.backend.loadbalancer.stickiness: <span class="string">"true"</span></span><br><span class="line">    traefik.backend.loadbalancer.stickiness.cookieName: <span class="string">"socket"</span></span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: socket-demo</span><br><span class="line">spec:</span><br><span class="line">  sessionAffinity: <span class="string">"ClientIP"</span></span><br><span class="line">  ports:</span><br><span class="line">    - name: socketio</span><br><span class="line">      port: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: 3000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: socket-demo</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在traefik 的路径下面建立一个socket.toml文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[http]</span><br><span class="line">  [http.routers]</span><br><span class="line">    [http.routers.socketio]</span><br><span class="line">      namespace = <span class="string">"kube-ops"</span></span><br><span class="line">      entryPoints = [<span class="string">"web"</span>]</span><br><span class="line">      service = <span class="string">"socket-demo"</span></span><br><span class="line">      rule = <span class="string">"Host(`socket-demo.xxlaila.cn`)"</span></span><br><span class="line">  [http.services]</span><br><span class="line">    [http.services.socket-demo]</span><br><span class="line">      [http.services.socket-demo.loadBalancer]</span><br><span class="line">      passHostHeader = <span class="literal">true</span></span><br><span class="line">      [[http.services.socket-demo.loadBalancer.servers]]</span><br><span class="line">        url = <span class="string">"http://socket-demo.kube-ops.svc.cluster.local:80"</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;完成以后可以执行测试，打印出来的hostname是一样的，因为使用的所有的访问都来自一个ip地址。</p><p>部署在kubernetes集群上的yaml文件如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: socket-demo</span><br><span class="line">  namespace: kube-apps</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: socket-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: socket-demo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - image: cnych/socketdemo:k8s</span><br><span class="line">          imagePullPolicy: Always</span><br><span class="line">          name: socketdemo</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 3000</span><br><span class="line">              protocol: TCP</span><br><span class="line">          resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 100Mi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 50m</span><br><span class="line">              memory: 50Mi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: socket-demo</span><br><span class="line">  namespace: kube-apps</span><br><span class="line">  annotations:</span><br><span class="line">    traefik.backend.loadbalancer.stickiness: <span class="string">"true"</span></span><br><span class="line">    traefik.backend.loadbalancer.stickiness.cookieName: <span class="string">"socket"</span></span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: socket-demo</span><br><span class="line">spec:</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  ports:</span><br><span class="line">    - name: socketio</span><br><span class="line">      port: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: 3000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: socket-demo</span><br></pre></td></tr></table></figure><blockquote><p>参考文献:<br><a href="https://www.qikqiak.com/post/socketio-multiple-nodes-in-kubernetes/" target="_blank" rel="noopener">https://www.qikqiak.com/post/socketio-multiple-nodes-in-kubernetes/</a><br><a href="https://docs.traefik.cn/toml#configuration-backends" target="_blank" rel="noopener">https://docs.traefik.cn/toml#configuration-backends</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --&gt;&lt;h3 id=&quot;场景&quot;&gt;&lt;a href=&quot;#场景&quot; class=&quot;headerlink&quot; title=&quot;场景&quot;&gt;&lt;/a&gt;场景&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;公司业务出现使用一个使用websocket的会话需求，和常见的web聊天工具一样，如网页QQ。
    
    </summary>
    
      <category term="traefik" scheme="https://www.xxlaila.cn/categories/traefik/"/>
    
    
      <category term="socketio" scheme="https://www.xxlaila.cn/tags/socketio/"/>
    
  </entry>
  
  <entry>
    <title>白话Kubernetes基础概念</title>
    <link href="https://www.xxlaila.cn/2020/02/17/%E7%99%BD%E8%AF%9DKubernetes%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"/>
    <id>https://www.xxlaila.cn/2020/02/17/白话Kubernetes基础概念/</id>
    <published>2020-02-17T07:58:00.000Z</published>
    <updated>2020-05-12T07:21:21.770Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --><h2 id="Kubernetes-简介"><a href="#Kubernetes-简介" class="headerlink" title="Kubernetes 简介"></a>Kubernetes 简介</h2><p>微服务框架的流行，使得服务越来越精细化，服务也变的越来越多，对于发布和管理而言产生了巨大的挑战，而 <code>Docker</code> 的诞生，给与微服务的资源治理和控制提供了很好的基础。<a id="more"></a>容器化可以解决各个不同语言环境部署、移植性高、跨平台部署等。但是 <code>Docker</code> 对于容器服务的编排没有那么方便，因为 <code>Docker</code> 这方面不足，而诞生 <code>Kubernetes</code>，<code>Kubernetes</code> 是一个可移植的、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。</p><h2 id="使用-Kubernetes-带来那些方便"><a href="#使用-Kubernetes-带来那些方便" class="headerlink" title="使用 Kubernetes 带来那些方便"></a>使用 Kubernetes 带来那些方便</h2><ul><li>快速部署应用</li><li>很容易实现 水平伸缩 或 垂直伸缩</li><li>无缝发布新的应用版本</li><li>资源使用最大化</li><li>应用停止自动重启</li></ul><h2 id="Kubernetes-特点"><a href="#Kubernetes-特点" class="headerlink" title="Kubernetes 特点"></a>Kubernetes 特点</h2><ul><li>可移植：支持公有云、私有云、混合云、多重云（multi-cloud）</li><li>可扩展：模块化、插件化、可挂载、可组合</li><li>自动化：自动部署、自动重启、自动复制、自动伸缩/扩展</li></ul><h2 id="为什么需要-Kubernetes，它能做什么"><a href="#为什么需要-Kubernetes，它能做什么" class="headerlink" title="为什么需要 Kubernetes，它能做什么?"></a>为什么需要 Kubernetes，它能做什么?</h2><p>容器是打包和运行应用程序的好方式。在生产环境中，您需要管理运行应用程序的容器，并确保不会停机。例如，如果一个容器发生故障，则需要启动另一个容器。如果系统处理此行为，会不会更容易？</p><p>这就是 Kubernetes 的救援方法！Kubernetes 为您提供了一个可弹性运行分布式系统的框架。Kubernetes 会满足您的扩展要求、故障转移、部署模式等。</p><p>Kubernetes 为您提供：</p><ul><li><p><code>服务发现和负载均衡</code>：Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果到容器的流量很大，Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</p></li><li><p><code>存储编排</code>：Kubernetes 允许您自动挂载您选择的存储系统，例如本地存储、公共云提供商等。</p></li><li><p><code>自动部署和回滚</code>：您可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态更改为所需状态。例如，您可以自动化 Kubernetes 来为您的部署创建新容器，删除现有容器并将它们的所有资源用于新容器。</p></li><li><p><code>容器资源配额</code>：Kubernetes 允许您指定每个容器所需 CPU 和内存（RAM）。当容器指定了资源请求时，Kubernetes 可以做出更好的决策来管理容器的资源。</p></li><li><p><code>自我修复</code>：Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的运行状况检查的容器，并且在准备好服务之前不将其通告给客户端。</p></li><li><p><code>密钥与配置管理</code>：Kubernetes 允许您存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。您可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</p></li><li><p><code>配置文件</code>：Kubernetes 可以通过 ConfigMap 来存储配置。</p></li></ul><h2 id="Kubernetes-基础资源定义和理解"><a href="#Kubernetes-基础资源定义和理解" class="headerlink" title="Kubernetes 基础资源定义和理解"></a>Kubernetes 基础资源定义和理解</h2><p>一切皆为资源，一切即可描述，一切皆可管理。</p><h3 id="NameSpaces"><a href="#NameSpaces" class="headerlink" title="NameSpaces"></a>NameSpaces</h3><p>命名空间，在一个 Kubernetes 集群中可以使用namespace创建多个“虚拟集群”，这些namespace之间可以完全隔离，也可以通过某种方式，让一个namespace中的service可以访问到其他的namespace中的服务。</p><h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deployment 为 Pod 和 ReplicaSet 提供了一个声明式定义(declarative)方法，用来替代以前的 <code>ReplicationController</code> 来方便的管理应用。典型的应用场景包括：</p><ul><li>定义Deployment来创建Pod和ReplicaSet</li><li>滚动升级和回滚应用</li><li>扩容和缩容</li><li>暂停和继续Deployment</li></ul><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>Kubernetes Service 定义了这样一种抽象：一个 Pod 的逻辑分组，一种可以访问它们的策略 —— 通常称为<code>微服务</code>。 这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector实现的。</p><h3 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h3><p>Ingress 是从 Kubernetes集群外部访问集群内部服务的入口。比如官方维护的 <code>Ingress Nginx</code>。<code>ingress traefik</code>、<code>ingress haproxy</code>等。</p><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>Pod 是 kubernetes 中你可以创建和部署的最小也是最简的单位。Pod代表着集群中运行的进程。</p><p>Pod中封装着应用的容器（有的情况下是好几个容器），存储、独立的网络IP，管理容器如何运行的策略选项。Pod代表着部署的一个单位：kubernetes中应用的一个实例，可能由一个或者多个容器组合在一起共享资源。</p><h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><p>ConfigMap API 资源用来保存 key-value pair配置数据，这个数据可以在pods里使用，或者被用来为像controller一样的系统组件存储配置数据。虽然 ConfigMap 跟 Secrets 类似，但是ConfigMap更方便的处理不含敏感信息的字符串。 注意：ConfigMaps不是属性配置文件的替代品。ConfigMaps只是作为多个properties文件的引用。你可以把它理解为Linux系统中的/etc目录，专门用来存储配置文件的目录。</p><h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><p>Secret 解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。Secret 可以以Volume或者环境变量的方式使用。</p><p>Secret有三种类型：</p><ul><li><code>Service Account</code> ：用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中；</li><li><code>Opaque</code> ：base64编码格式的Secret，用来存储密码、密钥等；</li><li><code>kubernetes.io/dockerconfigjson</code> ：用来存储私有docker registry的认证信息。</li></ul><h3 id="PV-和-PVC"><a href="#PV-和-PVC" class="headerlink" title="PV 和 PVC"></a>PV 和 PVC</h3><p>用于数据持续存储，Pod中，容器销毁，所有数据都会被销毁，如果需要保留数据，这里就需要用到 PV存储卷，PVC存储卷申明。</p><p>PVC 常用于 Deployment 做数据持久存储。实现持久化存储还需要理解 Volume 概念。</p><h3 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h3><p>容器磁盘上的文件的生命周期是短暂的，这就使得在容器中运行重要应用时会出现一些问题。首先，当容器崩溃时，kubelet 会重启它，但是容器中的文件将丢失——容器以干净的状态（镜像最初的状态）重新启动。其次，在 Pod 中同时运行多个容器时，这些容器之间通常需要共享文件。Kubernetes 中的 Volume 抽象就很好的解决了这些问题。</p><h3 id="Labels-和-Selectors"><a href="#Labels-和-Selectors" class="headerlink" title="Labels 和 Selectors"></a>Labels 和 Selectors</h3><p><code>标签</code> 和 <code>选择器</code>。作用用于给每个容器打标签，然后各个控制器通过 Selector 匹配容器，并管理。比如 Deployment 或 Service 都是通过这种方式匹配相应的 Pod。</p><h2 id="自述"><a href="#自述" class="headerlink" title="自述"></a>自述</h2><p>以上只是介绍 Kubernetes 几种常用的资源概念和作用，具体介绍可以查阅<a href="https://kubernetes.io/docs/home/" target="_blank" rel="noopener">Kubernetes 官方文档</a>。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://kubernetes.io/docs/home/" target="_blank" rel="noopener">https://kubernetes.io/docs/home/</a></li><li><a href="https://jimmysong.io/kubernetes-handbook" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook</a></li><li><a href="https://www.jianshu.com/p/b5b9041e8d7b" target="_blank" rel="noopener">https://www.jianshu.com/p/b5b9041e8d7b</a></li></ul><blockquote><ul><li>来源: 微信群分享</li><li>原文: <a href="https://www.yp14.cn/2020/01/04/%E7%99%BD%E8%AF%9D-Kubernetes-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" target="_blank" rel="noopener">yp14</a></li><li>版权: 本文版权归原作者所有</li></ul></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sun Jun 07 2020 09:57:57 GMT+0800 (GMT+08:00) --&gt;&lt;h2 id=&quot;Kubernetes-简介&quot;&gt;&lt;a href=&quot;#Kubernetes-简介&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes 简介&quot;&gt;&lt;/a&gt;Kubernetes 简介&lt;/h2&gt;&lt;p&gt;微服务框架的流行，使得服务越来越精细化，服务也变的越来越多，对于发布和管理而言产生了巨大的挑战，而 &lt;code&gt;Docker&lt;/code&gt; 的诞生，给与微服务的资源治理和控制提供了很好的基础。
    
    </summary>
    
    
  </entry>
  
</feed>
