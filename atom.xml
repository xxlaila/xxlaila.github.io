<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>懒羊羊</title>
  
  <subtitle>我是不会和普通的羊一般见识的。</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.xxlaila.cn/"/>
  <updated>2020-04-13T02:44:54.456Z</updated>
  <id>https://www.xxlaila.cn/</id>
  
  <author>
    <name>xxlaila</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>etcd备份与恢复</title>
    <link href="https://www.xxlaila.cn/2020/04/13/etcd%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"/>
    <id>https://www.xxlaila.cn/2020/04/13/etcd备份与恢复/</id>
    <published>2020-04-13T02:35:48.000Z</published>
    <updated>2020-04-13T02:44:54.456Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="ETCD-存储-k8s-所有数据信息"><a href="#ETCD-存储-k8s-所有数据信息" class="headerlink" title="ETCD 存储 k8s 所有数据信息"></a>ETCD 存储 k8s 所有数据信息</h3><p>ETCD 是k8s集群极为重要的一块服务，存储了集群所有的数据信息。同理，如果发生灾难或者 etcd 的数据丢失，都会影响集群数据的恢复，k8s中只用kube-apiserver和etcd进行数据交互。etcdctl版本: 3.3.18，kubernetes: v1.17.3。均采用二进制安装</p><a id="more"></a><h3 id="ETCD-一些查询操作"><a href="#ETCD-一些查询操作" class="headerlink" title="ETCD 一些查询操作"></a>ETCD 一些查询操作</h3><ul><li><p>查看集群状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 endpoint health</span><br><span class="line"></span><br><span class="line">https://172.21.16.204:2379 is healthy: successfully committed proposal: took = 15.614765ms</span><br><span class="line">https://172.21.17.32:2379 is healthy: successfully committed proposal: took = 40.200694ms</span><br><span class="line">https://172.21.17.18:2379 is healthy: successfully committed proposal: took = 230.022141ms</span><br></pre></td></tr></table></figure></li><li><p>获取某个 key 信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 get /registry/apiregistration.k8s.io/apiservices/v1.apps</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"kind"</span>:<span class="string">"APIService"</span>,<span class="string">"apiVersion"</span>:<span class="string">"apiregistration.k8s.io/v1beta1"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"name"</span>:<span class="string">"v1.apps"</span>,<span class="string">"uid"</span>:<span class="string">"5790ef34-84c1-432e-8ed8-4fe842c43dfe"</span>,<span class="string">"creationTimestamp"</span>:<span class="string">"2020-03-26T07:46:37Z"</span>,<span class="string">"labels"</span>:&#123;<span class="string">"kube-aggregator.kubernetes.io/automanaged"</span>:<span class="string">"onstart"</span>&#125;&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"service"</span>:null,<span class="string">"group"</span>:<span class="string">"apps"</span>,<span class="string">"version"</span>:<span class="string">"v1"</span>,<span class="string">"groupPriorityMinimum"</span>:17800,<span class="string">"versionPriority"</span>:15&#125;,<span class="string">"status"</span>:&#123;<span class="string">"conditions"</span>:[&#123;<span class="string">"type"</span>:<span class="string">"Available"</span>,<span class="string">"status"</span>:<span class="string">"True"</span>,<span class="string">"lastTransitionTime"</span>:<span class="string">"2020-03-26T07:46:37Z"</span>,<span class="string">"reason"</span>:<span class="string">"Local"</span>,<span class="string">"message"</span>:<span class="string">"Local APIServices are always available"</span>&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>获取 etcd 版本信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 version</span><br><span class="line"></span><br><span class="line">etcdctl version: 3.3.18</span><br><span class="line">API version: 3.3</span><br></pre></td></tr></table></figure></li><li><p>获取 ETCD 所有的 key</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 get / --prefix --keys-only</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据很多</span></span><br><span class="line">………………</span><br></pre></td></tr></table></figure></li></ul><h2 id="etcd-备份"><a href="#etcd-备份" class="headerlink" title="etcd 备份"></a>etcd 备份</h2><p>在其中一台服务器操作即可</p><h3 id="命令备份"><a href="#命令备份" class="headerlink" title="命令备份"></a>命令备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ENDPOINTS=<span class="string">"https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379"</span></span><br><span class="line">CACERT=<span class="string">"/etc/kubernetes/cert/ca.pem"</span></span><br><span class="line">CERT=<span class="string">"/etc/etcd/cert/etcd.pem"</span></span><br><span class="line">KEY=<span class="string">"/etc/etcd/cert/etcd-key.pem"</span></span><br><span class="line">DATE=`date +%Y%m%d-%H%M%S`</span><br><span class="line">BACKUP_DIR=<span class="string">"/opt/etcd_backup"</span></span><br><span class="line">/usr/bin/etcdctl --cacert=<span class="variable">$&#123;CACERT&#125;</span> --cert=<span class="variable">$&#123;CERT&#125;</span> --key=<span class="variable">$&#123;KEY&#125;</span>  --endpoints=<span class="string">"<span class="variable">$&#123;ENDPOINTS&#125;</span>"</span> snapshot save <span class="variable">$&#123;BACKUP_DIR&#125;</span>/mysnapshot-<span class="variable">$&#123;DATE&#125;</span>.db</span><br></pre></td></tr></table></figure><h3 id="脚本进行备份"><a href="#脚本进行备份" class="headerlink" title="脚本进行备份"></a>脚本进行备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;etcd-back.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 使用v3 版本进行备份，保留10分数据。加入定时任务，没半小时执行一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd vars</span></span><br><span class="line">ENDPOINTS=<span class="string">"https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379"</span></span><br><span class="line">CACERT=<span class="string">"/etc/kubernetes/cert/ca.pem"</span></span><br><span class="line">CERT=<span class="string">"/etc/etcd/cert/etcd.pem"</span></span><br><span class="line">KEY=<span class="string">"/etc/etcd/cert/etcd-key.pem"</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># time</span></span><br><span class="line">DATE=`date +%Y%m%d-%H%M%S`</span><br><span class="line"></span><br><span class="line"><span class="comment"># backup dir</span></span><br><span class="line">BACKUP_DIR=<span class="string">"/opt/etcd_backup"</span></span><br><span class="line"></span><br><span class="line">[ ! -d <span class="variable">$&#123;BACKUP_DIR&#125;</span> ] &amp;&amp; mkdir -p <span class="variable">$&#123;BACKUP_DIR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># exec backup</span></span><br><span class="line">/usr/bin/etcdctl --cacert=<span class="variable">$&#123;CACERT&#125;</span> --cert=<span class="variable">$&#123;CERT&#125;</span> --key=<span class="variable">$&#123;KEY&#125;</span>  --endpoints=<span class="string">"<span class="variable">$&#123;ENDPOINTS&#125;</span>"</span> snapshot save <span class="variable">$&#123;BACKUP_DIR&#125;</span>/mysnapshot-<span class="variable">$&#123;DATE&#125;</span>.db</span><br><span class="line"></span><br><span class="line"><span class="comment"># save 10</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_DIR&#125;</span></span><br><span class="line">ls -lt <span class="variable">$&#123;BACKUP_DIR&#125;</span>/*.db|awk <span class="string">'&#123;if(NR&gt;11)&#123;print "rm -rf "$9&#125;&#125;'</span>|sh</span><br></pre></td></tr></table></figure><h2 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul><li><p>停止所有 Master 上 kube-apiserver 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop kube-apiserver</span><br><span class="line"></span><br><span class="line">ps -ef | grep kube-apiserver</span><br></pre></td></tr></table></figure></li><li><p>停止集群中所有 ETCD 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop etcd</span><br><span class="line"></span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure></li></ul><h3 id="移除所有-ETCD-存储目录下数据"><a href="#移除所有-ETCD-存储目录下数据" class="headerlink" title="移除所有 ETCD 存储目录下数据"></a>移除所有 ETCD 存储目录下数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/etcd_backup</span><br><span class="line">mv /var/lib/etcd/data /tmp/etcd_backup/</span><br></pre></td></tr></table></figure><h3 id="拷贝-ETCD-备份快照"><a href="#拷贝-ETCD-备份快照" class="headerlink" title="拷贝 ETCD 备份快照"></a>拷贝 ETCD 备份快照</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在备份的服务器上拷贝</span></span><br><span class="line">scp -r /opt/etcd_backup/mysnapshot-20200413-090001.db 172.21.17.32:/root/</span><br><span class="line">scp -r /opt/etcd_backup/mysnapshot-20200413-090001.db 172.21.17.18:/root/</span><br></pre></td></tr></table></figure><h3 id="恢复备份"><a href="#恢复备份" class="headerlink" title="恢复备份"></a>恢复备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s-master01 机器上操作</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore /root/mysnapshot-20200413-090001.db   --name etcd01   --initial-cluster <span class="string">"etcd01=https://172.21.17.32:2380,etcd02=https://172.21.17.18:2380,etcd03=https://172.21.16.204:2380"</span>   --initial-cluster-token k8s-etcd-cluster   --initial-advertise-peer-urls https://172.21.17.32:2380   --data-dir=/var/lib/etcd/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># k8s-master02 机器上操作</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore /root/mysnapshot-20200413-090001.db   --name etcd02   --initial-cluster <span class="string">"etcd01=https://172.21.17.32:2380,etcd02=https://172.21.17.18:2380,etcd03=https://172.21.16.204:2380"</span>   --initial-cluster-token k8s-etcd-cluster   --initial-advertise-peer-urls https://172.21.17.18:2380   --data-dir=/var/lib/etcd/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># k8s-master03 机器上操作</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore /root/mysnapshot-20200413-090001.db   --name etcd03   --initial-cluster <span class="string">"etcd01=https://172.21.17.32:2380,etcd02=https://172.21.17.18:2380,etcd03=https://172.21.16.204:2380"</span>   --initial-cluster-token k8s-etcd-cluster   --initial-advertise-peer-urls https://172.21.16.204:2380   --data-dir=/var/lib/etcd/data</span><br></pre></td></tr></table></figure><h3 id="启动和检查etcd"><a href="#启动和检查etcd" class="headerlink" title="启动和检查etcd"></a>启动和检查etcd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 三台 ETCD 都恢复完成后，依次登陆三台机器启动 ETCD</span></span><br><span class="line"></span><br><span class="line">systemctl start etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 三台 ETCD 启动完成，检查 ETCD 集群状态</span></span><br><span class="line">ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/cert/ca.pem --cert=/etc/etcd/cert/etcd.pem --key=/etc/etcd/cert/etcd-key.pem --endpoints=https://172.21.17.32:2379,https://172.21.17.18:2379,https://172.21.16.204:2379 endpoint health</span><br><span class="line">https://172.21.16.204:2379 is healthy: successfully committed proposal: took = 34.77035ms</span><br><span class="line">https://172.21.17.32:2379 is healthy: successfully committed proposal: took = 35.320698ms</span><br><span class="line">https://172.21.17.18:2379 is healthy: successfully committed proposal: took = 77.081728ms</span><br></pre></td></tr></table></figure><h3 id="启动kube-apiserver"><a href="#启动kube-apiserver" class="headerlink" title="启动kube-apiserver"></a>启动kube-apiserver</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ETCD 全部健康，分别到每台 Master 启动 kube-apiserver</span></span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Kubernetes 集群是否恢复正常</span></span><br><span class="line">kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Kubernetes 集群备份主要是备份 ETCD 集群。而恢复时，主要考虑恢复整个顺序：<br><code>停止kube-apiserver --&gt; 停止ETCD --&gt; 恢复数据 --&gt; 启动ETCD --&gt; 启动kube-apiserve</code></p><ul><li>注意：备份ETCD集群时，只需要备份一个ETCD就行，恢复时，拿同一份备份数据恢复。</li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;ETCD-存储-k8s-所有数据信息&quot;&gt;&lt;a href=&quot;#ETCD-存储-k8s-所有数据信息&quot; class=&quot;headerlink&quot; title=&quot;ETCD 存储 k8s 所有数据信息&quot;&gt;&lt;/a&gt;ETCD 存储 k8s 所有数据信息&lt;/h3&gt;&lt;p&gt;ETCD 是k8s集群极为重要的一块服务，存储了集群所有的数据信息。同理，如果发生灾难或者 etcd 的数据丢失，都会影响集群数据的恢复，k8s中只用kube-apiserver和etcd进行数据交互。etcdctl版本: 3.3.18，kubernetes: v1.17.3。均采用二进制安装&lt;/p&gt;
    
    </summary>
    
      <category term="kubernetes" scheme="https://www.xxlaila.cn/categories/kubernetes/"/>
    
    
      <category term="etcd" scheme="https://www.xxlaila.cn/tags/etcd/"/>
    
  </entry>
  
  <entry>
    <title>Prometheus监控应用</title>
    <link href="https://www.xxlaila.cn/2020/04/12/Prometheus%E7%9B%91%E6%8E%A7%E5%BA%94%E7%94%A8/"/>
    <id>https://www.xxlaila.cn/2020/04/12/Prometheus监控应用/</id>
    <published>2020-04-12T04:47:44.000Z</published>
    <updated>2020-04-20T01:05:01.832Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h2 id="Prometheus-应用"><a href="#Prometheus-应用" class="headerlink" title="Prometheus 应用"></a>Prometheus 应用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Prometheus的单机安装比较简单，这里采用的是单机进行安装。<a href="https://prometheus.io/download/" target="_blank" rel="noopener">Prometheus</a>的相关插件下载地址</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载Prometheus</span></span><br><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.17.1/prometheus-2.17.1.linux-amd64.tar.gz</span><br><span class="line">tar zxc prometheus-2.17.1.linux-amd64.tar.gz &amp;&amp; mv prometheus-2.17.1.linux-amd64 /opt/prometheus</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建prometheus 数据存放目录</span></span><br><span class="line">mkdir -p /opt/prometheus/data</span><br></pre></td></tr></table></figure><h4 id="创建prometheus启动文件"><a href="#创建prometheus启动文件" class="headerlink" title="创建prometheus启动文件"></a>创建prometheus启动文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/prometheus.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus</span><br><span class="line">Documentation=https://prometheus.io/docs</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml --storage.tsdb.path=/opt/prometheus/data</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动prometheus</span></span><br><span class="line">systemctl  restart prometheus.service &amp;&amp;systemctl  status prometheus.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认端口9090</span></span><br></pre></td></tr></table></figure><h3 id="部署node-exporter"><a href="#部署node-exporter" class="headerlink" title="部署node_exporter"></a>部署node_exporter</h3><p>主要用来监控服务器的基础信息，如: cpu、内存、磁盘、网卡。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载node_exporter</span></span><br><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.0.0-rc.0/node_exporter-1.0.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">tar node_exporter-1.0.0-rc.0.linux-amd64.tar.gz &amp;&amp; mv node_exporter-1.0.0-rc.0.linux-amd64/node_exporter /usr/bin/ &amp;&amp; rm -rf node_exporter-1.0.0-rc.0.linux-amd64*</span><br></pre></td></tr></table></figure><h3 id="设置node-exporter开机启动"><a href="#设置node-exporter开机启动" class="headerlink" title="设置node_exporter开机启动"></a>设置node_exporter开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/node_exporter.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">Documentation=https://prometheus.io/docs</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/bin/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 node_exporter</span></span><br><span class="line">systemctl  start node_exporter.service &amp;&amp; systemctl status node_exporter.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认端口9100</span></span><br></pre></td></tr></table></figure><h3 id="安装mysql-exporter"><a href="#安装mysql-exporter" class="headerlink" title="安装mysql_exporter"></a>安装mysql_exporter</h3><p>主要监控mysql数据库的信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载mysql_exporter</span></span><br><span class="line">wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.12.1/mysqld_exporter-0.12.1.linux-amd64.tar.gz</span><br><span class="line">&amp;&amp; tar zxf mysqld_exporter-0.12.1.linux-amd64.tar.gz &amp;&amp; mv mysqld_exporter-0.12.1.linux-amd64/mysqld_exporter &amp;&amp; rm -rf mysqld_exporter-0.12.1.linux-amd64*</span><br></pre></td></tr></table></figure><h4 id="创建msql的连接权限"><a href="#创建msql的连接权限" class="headerlink" title="创建msql的连接权限"></a>创建msql的连接权限</h4><p>mysqld_exporter需要连接Mysql，首先为它创建用户并赋予所需要的权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GRANT REPLICATION CLIENT, PROCESS ON . TO <span class="string">'exporter'</span>@<span class="string">'localhost'</span> identified by <span class="string">'123456'</span>;</span><br><span class="line">GRANT SELECT ON performance_schema.* TO <span class="string">'exporter'</span>@<span class="string">'localhost'</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建.my.cnf文件</span></span><br><span class="line">在当前的用户目录(可变更)创建.my.cnf文件</span><br><span class="line">cat &gt; .my.cnf&lt;&lt;EOF</span><br><span class="line">[client]</span><br><span class="line">user=exporter</span><br><span class="line">password=123456</span><br></pre></td></tr></table></figure><h4 id="设置mysql-exporter开启启动"><a href="#设置mysql-exporter开启启动" class="headerlink" title="设置mysql_exporter开启启动"></a>设置mysql_exporter开启启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/mysql_exporter.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=mysqld_exporter</span><br><span class="line">Documentation=https://prometheus.io/docs</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/bin/mysqld_exporter \</span><br><span class="line">         --collect.info_schema.processlist \</span><br><span class="line">         --collect.info_schema.innodb_tablespaces \</span><br><span class="line">         --collect.info_schema.innodb_metrics  \</span><br><span class="line">         --collect.perf_schema.tableiowaits \</span><br><span class="line">         --collect.perf_schema.indexiowaits \</span><br><span class="line">         --collect.perf_schema.tablelocks \</span><br><span class="line">         --collect.engine_innodb_status \</span><br><span class="line">         --collect.perf_schema.file_events \</span><br><span class="line">         --collect.binlog_size \</span><br><span class="line">         --collect.info_schema.clientstats \</span><br><span class="line">         --collect.perf_schema.eventswaits \</span><br><span class="line">         --config.my-cnf=/root/.my.cnf</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 mysql_exporter</span></span><br><span class="line">systemctl  start mysql_exporter.service &amp;&amp; systemctl  status mysql_exporter.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认端口9104</span></span><br></pre></td></tr></table></figure><p>使用granafa给 MySQLD_Exporter添加监控图表:</p><ul><li>主从主群监控(模板7371)：</li><li>相关mysql 状态监控7362：</li><li>缓冲池状态7365</li></ul><h3 id="Prometheus基于文件的动态加载"><a href="#Prometheus基于文件的动态加载" class="headerlink" title="Prometheus基于文件的动态加载"></a>Prometheus基于文件的动态加载</h3><p>基于文件的服务发现是最通用的方式。这种方式不需要依赖于任何的平台或者第三方服务。对于Prometheus而言也不可能支持所有的平台或者环境。通过基于文件的服务发现方式下，Prometheus会定时从文件中读取最新的Target信息，可以通过任意的方式将监控Target的信息写入即可。<br>Prometheus 可以通过JSON或者YAML格式的文件，定义所有的监控目标。下面我是通过yaml的文件格式来进行配置监控。在添加实例的时候添加了一些额外的标签信息。如: env、service、group等，实例中采集到的样本信息将包含这些标签信息，从而可以通过该标签按照环境对数据进行统计。</p><h4 id="修改prometheus-yml"><a href="#修改prometheus-yml" class="headerlink" title="修改prometheus.yml"></a>修改prometheus.yml</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> prometheus.yml </span><br><span class="line">globa<span class="variable">l:</span></span><br><span class="line">  scrape_interva<span class="variable">l:</span>     <span class="number">15</span>s # Set the scrape interval <span class="keyword">to</span> every <span class="number">15</span> seconds. Default <span class="keyword">is</span> every <span class="number">1</span> minute.</span><br><span class="line">  evaluation_interva<span class="variable">l:</span> <span class="number">15</span>s # Evaluate rules every <span class="number">15</span> seconds. The default <span class="keyword">is</span> every <span class="number">1</span> minute.</span><br><span class="line">  scrape_timeou<span class="variable">t:</span> <span class="number">10</span>s</span><br><span class="line">  # scrape_timeout <span class="keyword">is</span> <span class="keyword">set</span> <span class="keyword">to</span> the <span class="keyword">global</span> default (<span class="number">10</span>s).</span><br><span class="line">alertin<span class="variable">g:</span></span><br><span class="line">  alertmanager<span class="variable">s:</span></span><br><span class="line">  - static_config<span class="variable">s:</span></span><br><span class="line">    - target<span class="variable">s:</span></span><br><span class="line">      # - alertmanager:<span class="number">9093</span></span><br><span class="line">rule_file<span class="variable">s:</span></span><br><span class="line">  # - <span class="string">"first_rules.yml"</span></span><br><span class="line">  # - <span class="string">"second_rules.yml"</span></span><br><span class="line">scrape_config<span class="variable">s:</span></span><br><span class="line">  - job_name: <span class="string">'kxl_docker'</span></span><br><span class="line">    file_sd_config<span class="variable">s:</span></span><br><span class="line">      - <span class="keyword">file</span><span class="variable">s:</span></span><br><span class="line">          - /<span class="keyword">opt</span>/prometheus/sd_config/docker.yml</span><br><span class="line">        refresh_interva<span class="variable">l:</span> <span class="number">5</span>s</span><br><span class="line">  - job_name: <span class="string">'kxl_vm'</span></span><br><span class="line">    file_sd_config<span class="variable">s:</span></span><br><span class="line">       - <span class="keyword">file</span><span class="variable">s:</span></span><br><span class="line">            - /<span class="keyword">opt</span>/prometheus/sd_config/<span class="keyword">vm</span>.yml</span><br><span class="line">         refresh_interva<span class="variable">l:</span> <span class="number">5</span>s</span><br><span class="line">  - job_name: <span class="string">'kxl_mysql'</span></span><br><span class="line">    file_sd_config<span class="variable">s:</span></span><br><span class="line">      - <span class="keyword">file</span><span class="variable">s:</span></span><br><span class="line">          - /<span class="keyword">opt</span>/prometheus/sd_config/mysql.yml</span><br><span class="line">        refresh_interva<span class="variable">l:</span> <span class="number">5</span>s</span><br></pre></td></tr></table></figure><p>scrape_configs 这里我定义了三组，分别是监控docker、vm、mysql的，每一个组对应一个yml文件。对应的服务到对应的文件进行增加即可。还可以增加(zk、es、ng、redis)等服务。</p><h4 id="创建被扫描的文件"><a href="#创建被扫描的文件" class="headerlink" title="创建被扫描的文件"></a>创建被扫描的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/prometheus/sd_config &amp;&amp; <span class="built_in">cd</span> /opt/prometheus/sd_config</span><br></pre></td></tr></table></figure><ul><li>docker.yml</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- labels:</span><br><span class="line">    service: docker</span><br><span class="line">    env: <span class="built_in">test</span></span><br><span class="line">    group: docker</span><br><span class="line">  targets:</span><br><span class="line">    - 172.21.1.30:8080</span><br></pre></td></tr></table></figure><ul><li>vm.yml</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- labels:</span><br><span class="line">    env: <span class="built_in">test</span></span><br><span class="line">    group: linux_node</span><br><span class="line">    service: vm</span><br><span class="line">  targets:</span><br><span class="line">    - 172.21.1.30:9100</span><br><span class="line">    - 172.21.1.52:9100</span><br><span class="line">    - 172.21.1.52:9100</span><br></pre></td></tr></table></figure><ul><li>mysql.yml</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- labels:</span><br><span class="line">    service: mysql</span><br><span class="line">    env: <span class="built_in">test</span></span><br><span class="line">    group: mysql</span><br><span class="line">  targets:</span><br><span class="line">    - 172.21.1.30:9104</span><br><span class="line">    </span><br><span class="line">- labels:</span><br><span class="line">    service: mysql</span><br><span class="line">    env: dev</span><br><span class="line">    group: mysql</span><br><span class="line">  targets:</span><br><span class="line">    - 172.21.1.52:9104</span><br></pre></td></tr></table></figure><p>在Prometheus UI的Targets下就可以看到当前定义的yml文件中动态获取到实例信息以及监控任务的采集状态，同时在Labels列下会包含用户添加的自定义标签:<br><img src="https://img.xxlaila.cn/1586668119403.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586666702938.jpg" alt="img"></p><p>在Prometheus UI的service-discovery下可以看到我们定义的job类型<br><img src="https://img.xxlaila.cn/1586666819381.jpg" alt="img"></p><h3 id="alertmanager-部署"><a href="#alertmanager-部署" class="headerlink" title="alertmanager 部署"></a>alertmanager 部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/alertmanager/releases/download/v0.20.0/alertmanager-0.20.0.linux-amd64.tar.gz</span><br><span class="line">tar zxf alertmanager-0.20.0.linux-amd64.tar.gz &amp;&amp; mv alertmanager-0.20.0.linux-amd64 /opt/alertmanager &amp;&amp; rm -rf alertmanager-0.20.0.linux-amd64*</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alermanager会将数据保存到本地中，默认的存储路径为data/。因此，在启动Alertmanager之前需要创建相应的目录</span></span><br><span class="line">mkdir -p /opt/alertmanager/data</span><br></pre></td></tr></table></figure><h4 id="设置alertmanager开机启动"><a href="#设置alertmanager开机启动" class="headerlink" title="设置alertmanager开机启动"></a>设置alertmanager开机启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/alertmanager.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=alertmanager</span><br><span class="line">Documentation=https://prometheus.io/docs</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/opt/alertmanager/alertmanager --config.file=/opt/alertmanager/alertmanager.yml --storage.path=/opt/alertmanager/data</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start alertmanager &amp;&amp; systemctl status alertmanager</span><br></pre></td></tr></table></figure><h4 id="修改prometheus配置用于加载alertmanager和alertmanager-rules"><a href="#修改prometheus配置用于加载alertmanager和alertmanager-rules" class="headerlink" title="修改prometheus配置用于加载alertmanager和alertmanager rules"></a>修改prometheus配置用于加载alertmanager和alertmanager rules</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat prometheus.yml</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s <span class="comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span><br><span class="line">  evaluation_interval: 15s <span class="comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span><br><span class="line">  scrape_timeout: 10s</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - 172.21.1.30:9093</span><br><span class="line">rule_files:</span><br><span class="line">  - <span class="string">'rules/*.rules'</span></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: <span class="string">'kxl_promethes'</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files:</span><br><span class="line">           - /opt/prometheus/sd_config/data.yml</span><br><span class="line">        refresh_interval: 5s</span><br><span class="line">  - job_name: <span class="string">'kxl_docker'</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files:</span><br><span class="line">          - /opt/prometheus/sd_config/docker.yml</span><br><span class="line">        refresh_interval: 5s</span><br><span class="line">  - job_name: <span class="string">'kxl_vm'</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">       - files:</span><br><span class="line">            - /opt/prometheus/sd_config/vm.yml</span><br><span class="line">         refresh_interval: 5s</span><br><span class="line">  - job_name: <span class="string">'kxl_mysql'</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files:</span><br><span class="line">          - /opt/prometheus/sd_config/mysql.yml</span><br><span class="line">        refresh_interval: 5s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启prometheus</span></span><br><span class="line">systemctl  restart prometheus</span><br></pre></td></tr></table></figure><h4 id="新建rules规则"><a href="#新建rules规则" class="headerlink" title="新建rules规则"></a>新建rules规则</h4><ul><li><p>node 规则</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/prometheus/rules</span><br><span class="line"></span><br><span class="line">cat &gt;node.rules&lt;&lt;EOF</span><br><span class="line">groups:</span><br><span class="line">- name: kxl_Instances </span><br><span class="line">  rules:</span><br><span class="line">  - alert: InstanceDown</span><br><span class="line">    expr: up == 0</span><br><span class="line">    <span class="keyword">for</span>: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    <span class="comment"># Prometheus templates apply here in the annotation and label fields of the alert.</span></span><br><span class="line">    annotations:</span><br><span class="line">      description: <span class="string">'&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; has been down for more than 5 minutes.'</span></span><br><span class="line">      summary: <span class="string">'Instance &#123;&#123; $labels.instance &#125;&#125; down'</span></span><br><span class="line">      </span><br><span class="line">  - alert: 内存使用率过高</span><br><span class="line">    expr: 100-(node_memory_Buffers_bytes+node_memory_Cached_bytes+node_memory_MemFree_bytes)/node_memory_MemTotal_bytes*100 &gt; 30 </span><br><span class="line">    <span class="keyword">for</span>: 1m </span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 内存使用率过高"</span></span><br><span class="line">      description: <span class="string">"&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; of job &#123;&#123;<span class="variable">$labels</span>.job&#125;&#125;内存使用率超过80%,当前使用率[&#123;&#123; <span class="variable">$value</span> &#125;&#125;]."</span></span><br><span class="line"></span><br><span class="line">  - alert: cpu使用率过高</span><br><span class="line">    expr: 100-avg(irate(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;[5m])) by(instance)*100 &gt; 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; cpu使用率过高"</span></span><br><span class="line">      description: <span class="string">"&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; of job &#123;&#123;<span class="variable">$labels</span>.job&#125;&#125;cpu使用率超过80%,当前使用率[&#123;&#123; <span class="variable">$value</span> &#125;&#125;]."</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>mysql 规则</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; mysql.rules &lt;&lt;EOF</span><br><span class="line">groups:</span><br><span class="line">- name: MySQLStatsAlert</span><br><span class="line">  rules:</span><br><span class="line">  - alert: MySQL is down</span><br><span class="line">    expr: mysql_up == 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; MySQL is down"</span></span><br><span class="line">      description: <span class="string">"MySQL database is down. This requires immediate action!"</span></span><br><span class="line">  - alert: open files high</span><br><span class="line">    expr: mysql_global_status_innodb_num_open_files &gt; (mysql_global_variables_open_files_limit) * 0.75</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; open files high"</span></span><br><span class="line">      description: <span class="string">"Open files is high. Please consider increasing open_files_limit."</span></span><br><span class="line">  - alert: Read buffer size is bigger than max. allowed packet size</span><br><span class="line">    expr: mysql_global_variables_read_buffer_size &gt; mysql_global_variables_slave_max_allowed_packet </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Read buffer size is bigger than max. allowed packet size"</span></span><br><span class="line">      description: <span class="string">"Read buffer size (read_buffer_size) is bigger than max. allowed packet size (max_allowed_packet).This can break your replication."</span></span><br><span class="line">  - alert: Sort buffer possibly missconfigured</span><br><span class="line">    expr: mysql_global_variables_innodb_sort_buffer_size &lt;256*1024 or mysql_global_variables_read_buffer_size &gt; 4*1024*1024 </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Sort buffer possibly missconfigured"</span></span><br><span class="line">      description: <span class="string">"Sort buffer size is either too big or too small. A good value for sort_buffer_size is between 256k and 4M."</span></span><br><span class="line">  - alert: Thread stack size is too small</span><br><span class="line">    expr: mysql_global_variables_thread_stack &lt;196608</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Thread stack size is too small"</span></span><br><span class="line">      description: <span class="string">"Thread stack size is too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line">  - alert: Used more than 80% of max connections limited </span><br><span class="line">    expr: mysql_global_status_max_used_connections &gt; mysql_global_variables_max_connections * 0.8</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Used more than 80% of max connections limited"</span></span><br><span class="line">      description: <span class="string">"Used more than 80% of max connections limited"</span></span><br><span class="line">  - alert: InnoDB Force Recovery is enabled</span><br><span class="line">    expr: mysql_global_variables_innodb_force_recovery != 0 </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Force Recovery is enabled"</span></span><br><span class="line">      description: <span class="string">"InnoDB Force Recovery is enabled. This mode should be used for data recovery purposes only. It prohibits writing to the data."</span></span><br><span class="line">  - alert: InnoDB Log File size is too small</span><br><span class="line">    expr: mysql_global_variables_innodb_log_file_size &lt; 16777216 </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Log File size is too small"</span></span><br><span class="line">      description: <span class="string">"The InnoDB Log File size is possibly too small. Choosing a small InnoDB Log File size can have significant performance impacts."</span></span><br><span class="line">  - alert: InnoDB Flush Log at Transaction Commit</span><br><span class="line">    expr: mysql_global_variables_innodb_flush_log_at_trx_commit != 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Flush Log at Transaction Commit"</span></span><br><span class="line">      description: <span class="string">"InnoDB Flush Log at Transaction Commit is set to a values != 1. This can lead to a loss of commited transactions in case of a power failure."</span></span><br><span class="line">  - alert: Table definition cache too small</span><br><span class="line">    expr: mysql_global_status_open_table_definitions &gt; mysql_global_variables_table_definition_cache</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Table definition cache too small"</span></span><br><span class="line">      description: <span class="string">"Your Table Definition Cache is possibly too small. If it is much too small this can have significant performance impacts!"</span></span><br><span class="line">  - alert: Table open cache too small</span><br><span class="line">    expr: mysql_global_status_open_tables &gt;mysql_global_variables_table_open_cache * 99/100</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Table open cache too small"</span></span><br><span class="line">      description: <span class="string">"Your Table Open Cache is possibly too small (old name Table Cache). If it is much too small this can have significant performance impacts!"</span></span><br><span class="line">  - alert: Thread stack size is possibly too small</span><br><span class="line">    expr: mysql_global_variables_thread_stack &lt; 262144</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Thread stack size is possibly too small"</span></span><br><span class="line">      description: <span class="string">"Thread stack size is possibly too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size."</span></span><br><span class="line">  - alert: InnoDB Buffer Pool Instances is too small</span><br><span class="line">    expr: mysql_global_variables_innodb_buffer_pool_instances == 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Buffer Pool Instances is too small"</span></span><br><span class="line">      description: <span class="string">"If you are using MySQL 5.5 and higher you should use several InnoDB Buffer Pool Instances for performance reasons. Some rules are: InnoDB Buffer Pool Instance should be at least 1 Gbyte in size. InnoDB Buffer Pool Instances you can set equal to the number of cores of your machine."</span></span><br><span class="line">  - alert: InnoDB Plugin is enabled</span><br><span class="line">    expr: mysql_global_variables_ignore_builtin_innodb == 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; InnoDB Plugin is enabled"</span></span><br><span class="line">      description: <span class="string">"InnoDB Plugin is enabled"</span></span><br><span class="line">  - alert: Binary Log is disabled</span><br><span class="line">    expr: mysql_global_variables_log_bin != 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Binary Log is disabled"</span></span><br><span class="line">      description: <span class="string">"Binary Log is disabled. This prohibits you to do Point in Time Recovery (PiTR)."</span></span><br><span class="line">  - alert: Binlog Cache size too small</span><br><span class="line">    expr: mysql_global_variables_binlog_cache_size &lt; 1048576</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      env: <span class="string">"&#123;&#123; <span class="variable">$labels</span>.env &#125;&#125;"</span></span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Binlog Cache size too small"</span></span><br><span class="line">      description: <span class="string">"Binlog Cache size is possibly to small. A value of 1 Mbyte or higher is OK."</span></span><br><span class="line">  - alert: Binlog Statement Cache size too small</span><br><span class="line">    expr: mysql_global_variables_binlog_stmt_cache_size &lt;1048576 and mysql_global_variables_binlog_stmt_cache_size &gt; 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Binlog Statement Cache size too small"</span></span><br><span class="line">      description: <span class="string">"Binlog Statement Cache size is possibly to small. A value of 1 Mbyte or higher is typically OK."</span></span><br><span class="line">  - alert: Binlog Transaction Cache size too small</span><br><span class="line">    expr: mysql_global_variables_binlog_cache_size  &lt;1048576</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Binlog Transaction Cache size too small"</span></span><br><span class="line">      description: <span class="string">"Binlog Transaction Cache size is possibly to small. A value of 1 Mbyte or higher is typically OK."</span></span><br><span class="line">  - alert: Sync Binlog is enabled</span><br><span class="line">    expr: mysql_global_variables_sync_binlog == 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Sync Binlog is enabled"</span></span><br><span class="line">      description: <span class="string">"Sync Binlog is enabled. This leads to higher data security but on the cost of write performance."</span></span><br><span class="line">  - alert: IO thread stopped</span><br><span class="line">    expr: mysql_slave_status_slave_io_running != 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; IO thread stopped"</span></span><br><span class="line">      description: <span class="string">"IO thread has stopped. This is usually because it cannot connect to the Master any more."</span></span><br><span class="line">  - alert: SQL thread stopped </span><br><span class="line">    expr: mysql_slave_status_slave_sql_running == 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; SQL thread stopped"</span></span><br><span class="line">      description: <span class="string">"SQL thread has stopped. This is usually because it cannot apply a SQL statement received from the master."</span></span><br><span class="line">  - alert: SQL thread stopped</span><br><span class="line">    expr: mysql_slave_status_slave_sql_running != 1</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Sync Binlog is enabled"</span></span><br><span class="line">      description: <span class="string">"SQL thread has stopped. This is usually because it cannot apply a SQL statement received from the master."</span></span><br><span class="line">  - alert: Slave lagging behind Master</span><br><span class="line">    expr: rate(mysql_slave_status_seconds_behind_master[1m]) &gt;30 </span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning </span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Slave lagging behind Master"</span></span><br><span class="line">      description: <span class="string">"Slave is lagging behind Master. Please check if Slave threads are running and if there are some performance issues!"</span></span><br><span class="line">  - alert: Slave is NOT <span class="built_in">read</span> only(Please ignore this warning indicator.)</span><br><span class="line">    expr: mysql_global_variables_read_only != 0</span><br><span class="line">    <span class="keyword">for</span>: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"Instance &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; Slave is NOT read only"</span></span><br><span class="line">      description: <span class="string">"Slave is NOT set to read only. You can accidentally manipulate data on the slave and get inconsistencies..."</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="配置告警策略"><a href="#配置告警策略" class="headerlink" title="配置告警策略"></a>配置告警策略</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cat alertmanager.yml </span><br><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line">  smtp_smarthost: <span class="string">'smtp.exmail.qq.com:465'</span></span><br><span class="line">  smtp_from: <span class="string">'zxc@xxlaila.cn.com'</span></span><br><span class="line">  smtp_auth_username: <span class="string">'zxc@xxlaila.cn.com'</span></span><br><span class="line">  smtp_auth_password: <span class="string">'123456'</span></span><br><span class="line">  smtp_require_tls: <span class="literal">true</span></span><br><span class="line">  hipchat_api_url: <span class="string">'https://hipchat.foobar.org/'</span></span><br><span class="line">  wechat_api_url: <span class="string">'https://qyapi.weixin.qq.com/cgi-bin/'</span></span><br><span class="line">  wechat_api_secret: <span class="string">'KJfj93r21389usdas0i--234jsnjkhf23sjkfjsfs'</span>    <span class="comment"># 企业微信Secret</span></span><br><span class="line">  wechat_api_corp_id: <span class="string">'wwa98423u9skdnkjahs'</span>    <span class="comment"># 企业微信CorpId</span></span><br><span class="line"></span><br><span class="line">templates:</span><br><span class="line">  - <span class="string">'template/*.tmpl'</span>   告警信息模版</span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  group_by: [<span class="string">'alertname'</span>]</span><br><span class="line">  group_wait: 10s</span><br><span class="line">  group_interval: 10s</span><br><span class="line">  repeat_interval: 1h</span><br><span class="line">  <span class="comment">#receiver: 'web.hook'</span></span><br><span class="line">  receiver: default</span><br><span class="line">  routes:</span><br><span class="line">  - receiver: <span class="string">'wechat'</span></span><br><span class="line">    <span class="built_in">continue</span>: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line"><span class="comment">#- name: 'web.hook'</span></span><br><span class="line">  - name: <span class="string">'default'</span></span><br><span class="line">    email_configs:</span><br><span class="line">    - to: <span class="string">'cq_xxlaila@163.com'</span></span><br><span class="line">      html: <span class="string">'&#123;&#123; template "test.html" . &#125;&#125;'</span></span><br><span class="line">      headers: &#123; Subject: <span class="string">"[WARN] email"</span>&#125;</span><br><span class="line">      send_resolved: <span class="literal">true</span></span><br><span class="line">    webhook_configs:</span><br><span class="line">    - url: <span class="string">'http://127.0.0.1:5001/'</span></span><br><span class="line">  - name: <span class="string">'wechat'</span></span><br><span class="line">    wechat_configs:</span><br><span class="line">    - send_resolved: <span class="literal">true</span></span><br><span class="line">      to_user: <span class="string">'@all'</span>              <span class="comment"># 接受人，都是all</span></span><br><span class="line">      to_party: <span class="string">'4'</span>                <span class="comment"># 接收组的id</span></span><br><span class="line">      agent_id: <span class="string">'1000002'</span>          <span class="comment"># 企业微信自定义应用的id</span></span><br><span class="line">      corp_id: <span class="string">'wwa98457kdsnkdnsadmsdnas'</span>   <span class="comment"># 企业微信CorpId</span></span><br><span class="line">      message: <span class="string">'&#123;&#123; template "test_wechat.html" . &#125;&#125;'</span>  <span class="comment"># 发送消息的模版</span></span><br><span class="line"></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: <span class="string">'critical'</span></span><br><span class="line">    target_match:</span><br><span class="line">      severity: <span class="string">'warning'</span></span><br><span class="line">    equal: [<span class="string">'alertname'</span>, <span class="string">'dev'</span>, <span class="string">'instance'</span>]</span><br></pre></td></tr></table></figure><p>Alertmanager主要负责对Prometheus产生的告警进行统一处理，因此在Alertmanager配置中一般会包含以下几个主要部分：</p><ul><li>全局配置（global）：用于定义一些全局的公共参数，如全局的SMTP配置，Slack配置等内容；</li><li>模板（templates）：用于定义告警通知时的模板，如HTML模板，邮件模板等；</li><li>告警路由（route）：根据标签匹配，确定当前告警应该如何处理；</li><li>接收人（receivers）：接收人是一个抽象的概念，它可以是一个邮箱也可以是微信，Slack或者Webhook等，接收人一般配合告警路由使用；</li><li>抑制规则（inhibit_rules）：合理设置抑制规则可以减少垃圾告警的产生</li></ul><h4 id="tmpl模板的配置"><a href="#tmpl模板的配置" class="headerlink" title=".tmpl模板的配置"></a>.tmpl模板的配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建.tmpl模版存放目录</span></span><br><span class="line">mkdir /opt/alertmanager/template &amp;&amp; <span class="built_in">cd</span> /opt/alertmanager/template</span><br><span class="line"></span><br><span class="line"><span class="comment"># 企业微信</span></span><br><span class="line">cat &gt;test_wechat.tmpl &lt;&lt;EOF</span><br><span class="line">&#123;&#123; define <span class="string">"test_wechat.html"</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; range <span class="variable">$i</span>, <span class="variable">$alert</span> := .Alerts.Firing &#125;&#125;</span><br><span class="line">    [报警项]:&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"alertname"</span> &#125;&#125;</span><br><span class="line">    [环境]: &#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"env"</span> &#125;&#125;</span><br><span class="line">    [实例]:&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"instance"</span> &#125;&#125;</span><br><span class="line">    [级别]: &#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"severity"</span> &#125;&#125;</span><br><span class="line">    [报警阀值]: &#123;&#123; index <span class="variable">$alert</span>.Annotations <span class="string">"summary"</span> &#125;&#125;</span><br><span class="line">    [报警描述]: &#123;&#123; index <span class="variable">$alert</span>.Annotations <span class="string">"description"</span> &#125;&#125;</span><br><span class="line">    [开始时间]: &#123;&#123; <span class="variable">$alert</span>.StartsAt &#125;&#125;</span><br><span class="line">  &#123;&#123; end &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 邮件告警</span></span><br><span class="line">cat &gt;test.tmpl &lt;&lt;EOF</span><br><span class="line">&#123;&#123; define <span class="string">"test.html"</span> &#125;&#125;</span><br><span class="line">&lt;table border=<span class="string">"1"</span>&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;报警项&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;环境&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;实例&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;级别&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;报警阀值&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;报警描述&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;开始时间&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; range <span class="variable">$i</span>, <span class="variable">$alert</span> := .Alerts &#125;&#125;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"alertname"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"env"</span>&#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"instance"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">"severity"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Annotations <span class="string">"summary"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Annotations <span class="string">"description"</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; <span class="variable">$alert</span>.StartsAt &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启alertmanager</span></span><br><span class="line">systemctl restart alertmanager</span><br></pre></td></tr></table></figure><p>企业微信截图<br><img src="https://img.xxlaila.cn/1587343723200.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h2 id=&quot;Prometheus-应用&quot;&gt;&lt;a href=&quot;#Prometheus-应用&quot; class=&quot;headerlink&quot; title=&quot;Prometheus 应用&quot;&gt;&lt;/a&gt;Prometheus 应用&lt;/h2&gt;&lt;h3 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h3&gt;&lt;p&gt;Prometheus的单机安装比较简单，这里采用的是单机进行安装。&lt;a href=&quot;https://prometheus.io/download/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Prometheus&lt;/a&gt;的相关插件下载地址&lt;/p&gt;
    
    </summary>
    
      <category term="监控" scheme="https://www.xxlaila.cn/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
      <category term="Prometheus" scheme="https://www.xxlaila.cn/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>关于openstack 安装centos-release-openstack-ocata失败解决</title>
    <link href="https://www.xxlaila.cn/2020/04/09/%E5%85%B3%E4%BA%8Eopenstack-%E5%AE%89%E8%A3%85centos-release-openstack-ocata%E5%A4%B1%E8%B4%A5%E8%A7%A3%E5%86%B3/"/>
    <id>https://www.xxlaila.cn/2020/04/09/关于openstack-安装centos-release-openstack-ocata失败解决/</id>
    <published>2020-04-09T05:16:19.000Z</published>
    <updated>2020-04-10T00:42:02.028Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="关于openstack-安装centos-release-openstack-ocata失败解决"><a href="#关于openstack-安装centos-release-openstack-ocata失败解决" class="headerlink" title="关于openstack 安装centos-release-openstack-ocata失败解决"></a>关于openstack 安装centos-release-openstack-ocata失败解决</h3><p>openstack ocata版本在后期增加节点的时候，安装<code>centos-release-openstack-ocata</code>失败。<a href="https://docs.openstack.org/ocata/install-guide-rdo/environment-packages.html" target="_blank" rel="noopener">ocata版本安装参考</a></p><h3 id="centos-release-openstack-ocata-错误提示"><a href="#centos-release-openstack-ocata-错误提示" class="headerlink" title="centos-release-openstack-ocata 错误提示"></a>centos-release-openstack-ocata 错误提示</h3><p>安装centos-release-openstack-ocata前系统版本<code>centos 7.4</code>，在yum安装的时候提示:<a id="more"></a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum install centos-release-openstack-ocata</span><br><span class="line"></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line"> * extras: mirrors.aliyun.com</span><br><span class="line"> * updates: mirrors.aliyun.com</span><br><span class="line">No package centos-release-openstack-ocata available.</span><br><span class="line">Error: Nothing to <span class="keyword">do</span></span><br></pre></td></tr></table></figure><p>经过查询得知，阿里云extras已经取消 centos-release-openstack-ocata的支持，于是乎怎么办。手动下载二进制包来进行安装。</p><h3 id="下载centos-release-openstack-ocata相关组件"><a href="#下载centos-release-openstack-ocata相关组件" class="headerlink" title="下载centos-release-openstack-ocata相关组件"></a>下载centos-release-openstack-ocata相关组件</h3><p><a href="http://vault.centos.org/7.4.1708/extras/x86_64/Packages/" target="_blank" rel="noopener">centos 7.4</a>对应下载地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-openstack-ocata-1-2.el7.noarch.rpm</span><br><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-ceph-jewel-1.0-1.el7.centos.noarch.rpm</span><br><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-qemu-ev-1.0-2.el7.noarch.rpm</span><br><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-storage-common-1-2.el7.centos.noarch.rpm</span><br><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-virt-common-1-1.el7.centos.noarch.rpm</span><br></pre></td></tr></table></figure><h4 id="安装对应的插件"><a href="#安装对应的插件" class="headerlink" title="安装对应的插件"></a>安装对应的插件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh *.rpm</span><br></pre></td></tr></table></figure><p>上述的几条命令可以使用一下方式进行快速的安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://vault.centos.org/7.4.1708/extras/x86_64/Packages/centos-release-openstack-ocata-1-2.el7.noarch.rpm</span><br><span class="line">yum -y install centos-release-openstack-ocata-1-2.el7.noarch.rpm</span><br></pre></td></tr></table></figure><h4 id="清理缓存"><a href="#清理缓存" class="headerlink" title="清理缓存"></a>清理缓存</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum cachemake</span><br></pre></td></tr></table></figure><p>在<code>yum cachemake</code>的时候又提示了错误。<code>HTTP Error 404 - Not Found</code>，具体错误如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Determining fastest mirrors</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line"> * extras: mirrors.aliyun.com</span><br><span class="line"> * updates: mirrors.cn99.com</span><br><span class="line">base                                                                                                                                                                               | 3.6 kB  00:00:00     </span><br><span class="line">centos-ceph-jewel                                                                                                                                                                  | 2.9 kB  00:00:00     </span><br><span class="line">http://mirror.centos.org/centos/7/cloud/x86_64/openstack-ocata/repodata/repomd.xml: [Errno 14] HTTP Error 404 - Not Found</span><br><span class="line">Trying other mirror.</span><br><span class="line">To address this issue please refer to the below wiki article </span><br><span class="line"></span><br><span class="line">https://wiki.centos.org/yum-errors</span><br><span class="line"></span><br><span class="line">If above article doesn<span class="string">'t help to resolve this issue please use https://bugs.centos.org/.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> One of the configured repositories failed (CentOS-7 - OpenStack ocata),</span></span><br><span class="line"><span class="string"> and yum doesn'</span>t have enough cached data to <span class="built_in">continue</span>. At this point the only</span><br><span class="line"> safe thing yum can <span class="keyword">do</span> is fail. There are a few ways to work <span class="string">"fix"</span> this:</span><br><span class="line"></span><br><span class="line">     1. Contact the upstream <span class="keyword">for</span> the repository and get them to fix the problem.</span><br><span class="line"></span><br><span class="line">     2. Reconfigure the baseurl/etc. <span class="keyword">for</span> the repository, to point to a working</span><br><span class="line">        upstream. This is most often useful <span class="keyword">if</span> you are using a newer</span><br><span class="line">        distribution release than is supported by the repository (and the</span><br><span class="line">        packages <span class="keyword">for</span> the previous distribution release still work).</span><br><span class="line"></span><br><span class="line">     3. Run the <span class="built_in">command</span> with the repository temporarily disabled</span><br><span class="line">            yum --disablerepo=centos-openstack-ocata ...</span><br><span class="line"></span><br><span class="line">     4. Disable the repository permanently, so yum won<span class="string">'t use it by default. Yum</span></span><br><span class="line"><span class="string">        will then just ignore the repository until you permanently enable it</span></span><br><span class="line"><span class="string">        again or use --enablerepo for temporary usage:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            yum-config-manager --disable centos-openstack-ocata</span></span><br><span class="line"><span class="string">        or</span></span><br><span class="line"><span class="string">            subscription-manager repos --disable=centos-openstack-ocata</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     5. Configure the failing repository to be skipped, if it is unavailable.</span></span><br><span class="line"><span class="string">        Note that yum will try to contact the repo. when it runs most commands,</span></span><br><span class="line"><span class="string">        so will have to try and fail each time (and thus. yum will be be much</span></span><br><span class="line"><span class="string">        slower). If it is a very temporary problem though, this is often a nice</span></span><br><span class="line"><span class="string">        compromise:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            yum-config-manager --save --setopt=centos-openstack-ocata.skip_if_unavailable=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">failure: repodata/repomd.xml from centos-openstack-ocata: [Errno 256] No more mirrors to try.</span></span><br><span class="line"><span class="string">http://mirror.centos.org/centos/7/cloud/x86_64/openstack-ocata/repodata/repomd.xml: [Errno 14] HTTP Error 404 - Not Found</span></span><br></pre></td></tr></table></figure><p>于是打开<code>http://mirror.centos.org/centos/7/cloud/x86_64</code>此链接地址，发现已经没有了<code>openstack-ocata</code>，所以才会导致失败。功夫不负有心人，终于在google找到一个有用的地址。</p><h3 id="修改OpenStack-ocata-repo"><a href="#修改OpenStack-ocata-repo" class="headerlink" title="修改OpenStack-ocata.repo"></a>修改OpenStack-ocata.repo</h3><p>修改<code>/etc/yum.repos.d/CentOS-OpenStack-ocata.repo</code>文件里面的<code>baseurl</code>地址，修改内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[centos-openstack-ocata]</span><br><span class="line">name=CentOS-7 - OpenStack ocata</span><br><span class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/7/cloud/$basearch/openstack-ocata/</span></span><br><span class="line">baseurl=http://mirror.neu.edu.cn/centos/7/cloud/<span class="variable">$basearch</span>/openstack-ocata/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Cloud</span><br><span class="line">exclude=sip,PyQt4</span><br></pre></td></tr></table></figure><p>完成后执行<code>yum makecache</code>或<code>centos-release-openstack-ocata</code>成功。可以打开<a href="http://mirror.neu.edu.cn/centos/7/cloud/x86_64/" target="_blank" rel="noopener">mirror.neu.edu.cn</a>查看是否有openstack-ocata<br><img src="https://img.xxlaila.cn/1586409079298.jpg" alt="img"></p><h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum upgrade</span><br><span class="line"><span class="comment"># 执行以后内容会从之前的centos 7.4 升级为 CentOS Linux release 7.7.1908 (Core)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h3 id="安装相关插件"><a href="#安装相关插件" class="headerlink" title="安装相关插件"></a>安装相关插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install python-openstackclient openstack-selinux</span><br><span class="line"></span><br><span class="line">yum install openstack-nova-compute conntrack libguestfs-tools</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;关于openstack-安装centos-release-openstack-ocata失败解决&quot;&gt;&lt;a href=&quot;#关于openstack-安装centos-release-openstack-ocata失败解决&quot; class=&quot;headerlink&quot; title=&quot;关于openstack 安装centos-release-openstack-ocata失败解决&quot;&gt;&lt;/a&gt;关于openstack 安装centos-release-openstack-ocata失败解决&lt;/h3&gt;&lt;p&gt;openstack ocata版本在后期增加节点的时候，安装&lt;code&gt;centos-release-openstack-ocata&lt;/code&gt;失败。&lt;a href=&quot;https://docs.openstack.org/ocata/install-guide-rdo/environment-packages.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ocata版本安装参考&lt;/a&gt;&lt;/p&gt;&lt;h3 id=&quot;centos-release-openstack-ocata-错误提示&quot;&gt;&lt;a href=&quot;#centos-release-openstack-ocata-错误提示&quot; class=&quot;headerlink&quot; title=&quot;centos-release-openstack-ocata 错误提示&quot;&gt;&lt;/a&gt;centos-release-openstack-ocata 错误提示&lt;/h3&gt;&lt;p&gt;安装centos-release-openstack-ocata前系统版本&lt;code&gt;centos 7.4&lt;/code&gt;，在yum安装的时候提示:
    
    </summary>
    
      <category term="openstack" scheme="https://www.xxlaila.cn/categories/openstack/"/>
    
    
      <category term="ocata" scheme="https://www.xxlaila.cn/tags/ocata/"/>
    
  </entry>
  
  <entry>
    <title>利用 zabbix 监控全国天气状况</title>
    <link href="https://www.xxlaila.cn/2020/04/08/%E5%88%A9%E7%94%A8-zabbix-%E7%9B%91%E6%8E%A7%E5%85%A8%E5%9B%BD%E5%A4%A9%E6%B0%94%E7%8A%B6%E5%86%B5/"/>
    <id>https://www.xxlaila.cn/2020/04/08/利用-zabbix-监控全国天气状况/</id>
    <published>2020-04-08T06:20:47.000Z</published>
    <updated>2020-04-09T09:45:06.584Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h2 id="利用-zabbix-监控全国天气状况"><a href="#利用-zabbix-监控全国天气状况" class="headerlink" title="利用 zabbix 监控全国天气状况"></a>利用 zabbix 监控全国天气状况</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本次主要是采用zabbix 的 http 代理方式进行数据的采集。可以通过网站的api接口来测试获取天气的状况。这里使用的是高德地图的天气。zabbix版本使用4.0 以上支持http 代理。3.0 版本不支持。<a id="more"></a></p><h3 id="利用zabbix创建测试"><a href="#利用zabbix创建测试" class="headerlink" title="利用zabbix创建测试"></a>利用zabbix创建测试</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;打开zabbix的配置——&gt;主机，点击任意一台主机进行item的配置。<br><img src="https://img.xxlaila.cn/1586253783229.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586253914768.jpg" alt="img"></p><h3 id="获取数据如下"><a href="#获取数据如下" class="headerlink" title="获取数据如下"></a>获取数据如下</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据上述创建的监控项，然后我们在<code>Latest data</code>里面看到获取的数据如下所示：<br><img src="https://img.xxlaila.cn/1586254044683.jpg" alt="img"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"status"</span>:<span class="string">"1"</span>,<span class="string">"count"</span>:<span class="string">"1"</span>,<span class="string">"info"</span>:<span class="string">"OK"</span>,<span class="string">"infocode"</span>:<span class="string">"10000"</span>,<span class="string">"lives"</span>:[&#123;<span class="string">"province"</span>:<span class="string">"重庆"</span>,<span class="string">"city"</span>:<span class="string">"重庆市"</span>,<span class="string">"adcode"</span>:<span class="string">"500000"</span>,<span class="string">"weather"</span>:<span class="string">"多云"</span>,<span class="string">"temperature"</span>:<span class="string">"21"</span>,<span class="string">"winddirection"</span>:<span class="string">"南"</span>,<span class="string">"windpower"</span>:<span class="string">"≤3"</span>,<span class="string">"humidity"</span>:<span class="string">"45"</span>,<span class="string">"reporttime"</span>:<span class="string">"2020-04-07 17:54:43"</span>&#125;]&#125;</span><br></pre></td></tr></table></figure><h3 id="监控天气信息为例"><a href="#监控天气信息为例" class="headerlink" title="监控天气信息为例"></a>监控天气信息为例</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;键值定义尽量和上述的一致，依赖项选择刚刚新建的http agent监控项<br><img src="https://img.xxlaila.cn/1586254230677.jpg" alt="img"></p><h4 id="添加预处理步骤"><a href="#添加预处理步骤" class="headerlink" title="添加预处理步骤"></a>添加预处理步骤</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据刚才获取到的数据来获取<code>weather</code>的值，不通平台的获取的数据类型不一样。这里的<code>weather</code>要根据不通平台的信息进行修改。否则无法获取数据，在该 <code>item</code> 点击<code>Preprocessing</code><br><img src="https://img.xxlaila.cn/1586254402880.jpg" alt="img"><br>定义气温、风力、风向、相对湿度，添加方法与上面相同</p><h3 id="建立触发器"><a href="#建立触发器" class="headerlink" title="建立触发器"></a>建立触发器</h3><p>这里建立一个温度超过30度显示温度过高，温度低于13度就显示温度低的两个触发器<br><img src="https://img.xxlaila.cn/1586305703882.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586329254191.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里我们需要添加全国34个省市，每一个省市都是手动建立，去查找每一个省市的代码需要多少时间，这里使用<a href="https://github.com/xxlaila/backup-monitoring/tree/master/weather" target="_blank" rel="noopener">python的一个小程序</a>来实现获取全国的城市，然后创建对应<code>item</code>和<code>Trigger</code>。添加完成以后的最后结果为:<br><img src="https://img.xxlaila.cn/1586306042202.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586306102916.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586306159679.jpg" alt="img"></p><h3 id="创建网络拓扑"><a href="#创建网络拓扑" class="headerlink" title="创建网络拓扑"></a>创建网络拓扑</h3><h4 id="创建背景图片"><a href="#创建背景图片" class="headerlink" title="创建背景图片"></a>创建背景图片</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以自行去网上照一张中国地图的图片。<br><img src="https://img.xxlaila.cn/1586306286532.jpg" alt="img"></p><h4 id="创建map图"><a href="#创建map图" class="headerlink" title="创建map图"></a>创建map图</h4><p>Monitoring——&gt;Maps——&gt;Create map<br><img src="https://img.xxlaila.cn/1586306412375.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586306469511.jpg" alt="img"></p><h4 id="编辑map"><a href="#编辑map" class="headerlink" title="编辑map"></a>编辑map</h4><p>标签用于显示监控的数据，添加高温的触发器，当触发高温报警后，图标由绿点会变成红绿 交替闪动，这里以西藏气温为例</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;Zabbix server:xizangzizhiqu-weather.<span class="keyword">last</span>()&#125;</span><br><span class="line">&#123;Zabbix server:xizangzizhiqu-temperature.<span class="keyword">last</span>()&#125;°C </span><br><span class="line">&#123;Zabbix server:xizangzizhiqu-winddirection.<span class="keyword">last</span>()&#125;风&#123;Zabbix server:xizangzizhiqu-windpower.<span class="keyword">last</span>()&#125;级</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1586329570620.jpg" alt="img"></p><h4 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h4><p><img src="https://img.xxlaila.cn/1586326792592.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1586328948590.jpg" alt="img"></p><h3 id="zabbix-图标乱码"><a href="#zabbix-图标乱码" class="headerlink" title="zabbix 图标乱码"></a>zabbix 图标乱码</h3><p>在打开天气温度和湿度的图表时，显示乱码。在windows电脑上选择一个字体，比如<code>简体中文</code>，我这里使用的是中文楷体<code>simkai.ttf</code>字体。上传到zabbix server的服务器</p><h4 id="zabbix的安装目录"><a href="#zabbix的安装目录" class="headerlink" title="zabbix的安装目录"></a>zabbix的安装目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whereis  zabbix</span><br><span class="line">zabbix: /usr/lib/zabbix /etc/zabbix /usr/share/zabbix</span><br></pre></td></tr></table></figure><h4 id="切换到-usr-share-zabbix目录"><a href="#切换到-usr-share-zabbix目录" class="headerlink" title="切换到/usr/share/zabbix目录"></a>切换到/usr/share/zabbix目录</h4><p>切换到该目录可以使用<code>ls</code>命令，该目录下面已经没有fonts字体目录了。可以创建目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/share/zabbix/fonts</span><br><span class="line"></span><br><span class="line">mv simkai.ttf /usr/share/zabbix/fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 /etc/alternatives/zabbix-web-font 软连接</span></span><br><span class="line">rm -f /etc/alternatives/zabbix-web-font</span><br><span class="line">ln -s /usr/share/zabbix/fonts/simkai.ttf  /etc/alternatives/zabbix-web-font</span><br><span class="line"></span><br><span class="line">systemctl restart zabbix-server</span><br></pre></td></tr></table></figure><p><a href="https://www.zabbix.com/documentation/4.0/zh/manual/config/items/itemtypes/http" target="_blank" rel="noopener">zabbix api</a><br><a href="https://lbs.amap.com/api/webservice/guide/api/weatherinfo" target="_blank" rel="noopener">高德天气</a><br><a href="https://lbs.amap.com/api/webservice/guide/api/district" target="_blank" rel="noopener">高德城市</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h2 id=&quot;利用-zabbix-监控全国天气状况&quot;&gt;&lt;a href=&quot;#利用-zabbix-监控全国天气状况&quot; class=&quot;headerlink&quot; title=&quot;利用 zabbix 监控全国天气状况&quot;&gt;&lt;/a&gt;利用 zabbix 监控全国天气状况&lt;/h2&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;本次主要是采用zabbix 的 http 代理方式进行数据的采集。可以通过网站的api接口来测试获取天气的状况。这里使用的是高德地图的天气。zabbix版本使用4.0 以上支持http 代理。3.0 版本不支持。
    
    </summary>
    
      <category term="zabbix" scheme="https://www.xxlaila.cn/categories/zabbix/"/>
    
    
      <category term="weather" scheme="https://www.xxlaila.cn/tags/weather/"/>
    
  </entry>
  
  <entry>
    <title>openvpn推送路由</title>
    <link href="https://www.xxlaila.cn/2020/03/26/openvpn%E6%8E%A8%E9%80%81%E8%B7%AF%E7%94%B1/"/>
    <id>https://www.xxlaila.cn/2020/03/26/openvpn推送路由/</id>
    <published>2020-03-26T01:05:15.000Z</published>
    <updated>2020-03-26T01:06:44.667Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;openvpn 做好以后，发现到腾讯云网络不通，拓扑图参考如下：<br><img src="https://img.xxlaila.cn/1585183381221.jpg" alt="img"><a id="more"></a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IDC机房和云上是通过vpn打通的。openvpn是假设在机房的，云上的部分东西是限制只能IDC访问。客户端拨号到openvpn以后是没有办法访问云上的。因为没有路由。所以需要在服务器端推送路由到客户端。</p><h3 id="修改服务器端配置"><a href="#修改服务器端配置" class="headerlink" title="修改服务器端配置"></a>修改服务器端配置</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;增加到云上的路由配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">"route 172.16.11.0 255.255.255.0"</span></span><br><span class="line">push <span class="string">"route 172.16.13.0 255.255.252.0"</span></span><br></pre></td></tr></table></figure><h3 id="增加nginx白名单的配置"><a href="#增加nginx白名单的配置" class="headerlink" title="增加nginx白名单的配置"></a>增加nginx白名单的配置</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在云上有nginx到的proxy。但是里面做有白名单，也是只能IDC访问，ping域名解析是公网的ip地址。用户拨入openvpn以后，同样也不开这部分服务。这里就需要增加指定的ip，xxx.xxx.xxx.xxx 换成自己本身的公网ip地址。我这里的这个地址是一个slb地址。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">"route xxx.xxx.xxx.xxx 255.255.255.255"</span></span><br></pre></td></tr></table></figure><h3 id="重启openvpn"><a href="#重启openvpn" class="headerlink" title="重启openvpn"></a>重启openvpn</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openvpn@server</span><br></pre></td></tr></table></figure><h3 id="客户端查看路由"><a href="#客户端查看路由" class="headerlink" title="客户端查看路由"></a>客户端查看路由</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">netstat -nr</span><br><span class="line"></span><br><span class="line">Routing tables</span><br><span class="line"></span><br><span class="line">Internet:</span><br><span class="line">Destination        Gateway            Flags        Refs      Use   Netif Expire</span><br><span class="line">default            192.168.31.1       UGSc          130        0     en0</span><br><span class="line">10                 10.8.0.5           UGSc            0        0   utun3</span><br><span class="line">10.8.0.1/32        10.8.0.5           UGSc            0        0   utun3</span><br><span class="line">10.8.0.5           10.8.0.6           UH             13        0   utun3</span><br><span class="line">115.xxx.xxx.xx/32  10.8.0.5           UGSc            0        0   utun3  </span><br><span class="line">127                127.0.0.1          UCS             0        0     lo0</span><br><span class="line">127.0.0.1          127.0.0.1          UH             68  6082666     lo0</span><br><span class="line">169.254            link<span class="comment">#5             UCS             2        0     en0      !</span></span><br><span class="line">172.16.11/24       10.8.0.5           UGSc            1        1   utun3</span><br><span class="line">172.16.13/22       10.8.0.5           UGSc            0        0   utun3</span><br><span class="line">172.21.17/20       10.8.0.5           UGSc            8        0   utun3</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ping ip地址或者域名进行验证是否ok</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;需求&quot;&gt;&lt;a href=&quot;#需求&quot; class=&quot;headerlink&quot; title=&quot;需求&quot;&gt;&lt;/a&gt;需求&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;openvpn 做好以后，发现到腾讯云网络不通，拓扑图参考如下：&lt;br&gt;&lt;img src=&quot;https://img.xxlaila.cn/1585183381221.jpg&quot; alt=&quot;img&quot;&gt;
    
    </summary>
    
      <category term="vpn" scheme="https://www.xxlaila.cn/categories/vpn/"/>
    
    
      <category term="openvpn" scheme="https://www.xxlaila.cn/tags/openvpn/"/>
    
  </entry>
  
  <entry>
    <title>openvpn配置ldap</title>
    <link href="https://www.xxlaila.cn/2020/03/11/openvpn%E9%85%8D%E7%BD%AEldap/"/>
    <id>https://www.xxlaila.cn/2020/03/11/openvpn配置ldap/</id>
    <published>2020-03-11T10:31:55.000Z</published>
    <updated>2020-03-25T08:35:36.909Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;企业内一般都有ldap，基本上所有的系统都支持ldap登录，openvpn也不例外，<a id="more"></a>使用ldap认证登录好处是员工可以使用一个账号就可以进行登录，不需要去记录N个账号密码。</p><h3 id="安装-openvpn-auth-ldap-插件"><a href="#安装-openvpn-auth-ldap-插件" class="headerlink" title="安装 openvpn-auth-ldap 插件"></a>安装 openvpn-auth-ldap 插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release &amp;&amp; yum -y install openvpn-auth-ldap</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;安装完成后，在目录 /usr/lib64/openvpn/plugin/lib/ 会出现 openvpn-auth-ldap.so 文件。在目录 /etc/openvpn 目录下自动生成 auth 目录，该目录里面存在 ldap.conf ，用于配置 LDAP 相关信息。</p><h3 id="配置-LDAP-相关信息"><a href="#配置-LDAP-相关信息" class="headerlink" title="配置 LDAP 相关信息"></a>配置 LDAP 相关信息</h3><h4 id="备份原先的配置文件"><a href="#备份原先的配置文件" class="headerlink" title="备份原先的配置文件"></a>备份原先的配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/openvpn/auth/ldap.conf /etc/openvpn/auth/ldap.conf.bak</span><br></pre></td></tr></table></figure><h4 id="编辑ldap-conf"><a href="#编辑ldap-conf" class="headerlink" title="编辑ldap.conf"></a>编辑ldap.conf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/auth/ldap.conf</span><br><span class="line">&lt;LDAP&gt;</span><br><span class="line">URLldap://xx.xx.xx.xx:389</span><br><span class="line">        Password123456</span><br><span class="line">Timeout15</span><br><span class="line">TLSEnableno</span><br><span class="line">FollowReferrals no</span><br><span class="line">&lt;/LDAP&gt;</span><br><span class="line">&lt;Authorization&gt;</span><br><span class="line">BaseDN<span class="string">"ou=People,dc=xxlaila,dc=cn"</span></span><br><span class="line">SearchFilter<span class="string">"uid=%u"</span></span><br><span class="line">RequireGroup<span class="literal">false</span></span><br><span class="line">&lt;/Authorization&gt;</span><br></pre></td></tr></table></figure><h4 id="编辑-openvpn-的配置文件"><a href="#编辑-openvpn-的配置文件" class="headerlink" title="编辑 openvpn 的配置文件"></a>编辑 openvpn 的配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加如下内容</span></span><br><span class="line">vim /etc/openvpn/server.conf</span><br><span class="line"></span><br><span class="line">plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so <span class="string">"/etc/openvpn/auth/ldap.conf"</span></span><br><span class="line">client-cert-not-required</span><br><span class="line">username-as-common-name</span><br></pre></td></tr></table></figure><blockquote><p>使用了上面安装的 openvpn-auth-ldap 认证插件，client-cert-not-required 表示不再需要客户端证书，将改为使用 LDAP 中的用户认证。</p></blockquote><h4 id="重新启动-OpenVPN-服务"><a href="#重新启动-OpenVPN-服务" class="headerlink" title="重新启动 OpenVPN 服务"></a>重新启动 OpenVPN 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openvpn@server</span><br></pre></td></tr></table></figure><h3 id="客户端配置修改"><a href="#客户端配置修改" class="headerlink" title="客户端配置修改"></a>客户端配置修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto tcp</span><br><span class="line">remote xxx.xxx.xxx 1194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line"></span><br><span class="line">ca ca.crt</span><br><span class="line">cert client.crt</span><br><span class="line">key client.key</span><br><span class="line">remote-cert-tls server</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line"></span><br><span class="line">ns-cert-type server   <span class="comment"># 增加此行</span></span><br><span class="line">auth-user-pass        <span class="comment"># 增加此行,开启 "用户名/密码" 认证</span></span><br><span class="line"></span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure><p><strong>注释</strong>:</p><ul><li>看到一些文档说开启ldap以后需要注释<code>cert client.crt</code>、<code>key client.key</code>，因为配置了 LDAP 不再需要客户端证书和密钥，但是在实际应用中，只要添加了<code>auth-user-pass</code>，不注释该两行也是可行的。因为在连接的时候就会提示输入账号和密码，否则不过。</li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;企业内一般都有ldap，基本上所有的系统都支持ldap登录，openvpn也不例外，
    
    </summary>
    
      <category term="vpn" scheme="https://www.xxlaila.cn/categories/vpn/"/>
    
    
      <category term="openvpn" scheme="https://www.xxlaila.cn/tags/openvpn/"/>
    
  </entry>
  
  <entry>
    <title>openvpn部署</title>
    <link href="https://www.xxlaila.cn/2020/03/10/openvpn%E9%83%A8%E7%BD%B2/"/>
    <id>https://www.xxlaila.cn/2020/03/10/openvpn部署/</id>
    <published>2020-03-10T11:48:13.000Z</published>
    <updated>2020-03-25T08:32:27.852Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于公司内部系统比较多，而且这部分系统都是只能在公司内网访问，<a id="more"></a>当人员出差或者不在办公室的时候就没办法访问，根据需求搭建vpn，来提供给员工访问，之前做的ipsec vpn，由于不是特别的稳定的，于是就选择使用openvpn。这里采用tls认证登录，根据每个员工进行建立账号。</p><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OpenVPN 是一个用于创建虚拟专用网络加密通道的软件包，OpenVPN 允许创建的 VPN 使用公开密钥、电子证书、或者用户名/密码来进行身份验证。它大量使用了 OpenSSL 加密库中的 SSLv3/TLSv1 协议函数库。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目前 OpenVPN 能在 Solaris、Linux、OpenBSD、FreeBSD、NetBSD、Mac OS X 与 Microsoft Windows 以及 Android 和 iOS 上运行，并包含了许多安全性的功能。它并不是一个基于 Web 的 VPN 软件，也不与 IPsec 及其他 VPN 软件包兼容。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OpenVPN 的技术核心是虚拟网卡，其次是 SSL 协议实现。</p><h3 id="openvpn有两种模式"><a href="#openvpn有两种模式" class="headerlink" title="openvpn有两种模式"></a>openvpn有两种模式</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数据包（TUN模式）或数据帧（TAP模式）</p><ul><li>TUN模式: TUN模拟了网络层设备，操作第三层数据包比如IP数据封包，创建的是三层路由隧道</li><li>TAP模式: 等同于一个以太网设备，它操作第二层数据包如以太网数据帧，创建一个以太网桥接,相对复杂<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TAP 接口的好处在于,客户端可以获得 VPN 服务器所处子网的 IP(忽略物理上的区别,可以完全将客户端看做是与VPN服务器处于同一子网的另一台机器)，而TUN 接口下所有的客户端则处于一个完全独立的子网内,与 VPN 服务器所在的子网没有关系，这种使用比较好，和公司的网络区分开，完全一个虚拟的网络。</li></ul><h4 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.4.1708 (Core)</span><br><span class="line"></span><br><span class="line">uname -a</span><br><span class="line">Linux k8s-nfs-data.kxl 3.10.0-693.el7.x86_64 <span class="comment">#1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure><h4 id="添加yum源"><a href="#添加yum源" class="headerlink" title="添加yum源"></a>添加yum源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.163.com/.<span class="built_in">help</span>/CentOS7-Base-163.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h4 id="安装-openvpn和easy-rsa"><a href="#安装-openvpn和easy-rsa" class="headerlink" title="安装 openvpn和easy-rsa"></a>安装 openvpn和easy-rsa</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install openvpn easy-rsa lzop</span><br><span class="line">yum install -y net-tools.x86_64 ntp ntpdate bridge-utils gcc  openssl-devel pam-devel zip</span><br></pre></td></tr></table></figure><h4 id="开启系统系统IP转发"><a href="#开启系统系统IP转发" class="headerlink" title="开启系统系统IP转发"></a>开启系统系统IP转发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="comment">#修改或添加参数</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行生效</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><h3 id="证书准备"><a href="#证书准备" class="headerlink" title="证书准备"></a>证书准备</h3><h4 id="配置easy-rsa-3-0"><a href="#配置easy-rsa-3-0" class="headerlink" title="配置easy-rsa-3.0"></a>配置easy-rsa-3.0</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;使用 easy-rsa 生成需要的证书及相关文件，在这个阶段会产生一些 key 和证书：</p><ul><li>CA 根证书</li><li>OpenVPN 服务器 ssl 证书</li><li>Diffie-Hellman 算法用到的 key</li></ul><h4 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将 easy-rsa 脚本复制到 /etc/openvpn/，该脚本主要用来方便地生成 CA 证书和各种 key，也可以根据版本号来进行复制，只复制需要的部分。查看 easy-rsa 版本号：<code>yum info easy-rsa</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa</span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa/</span><br><span class="line">\rm 3 3.0</span><br><span class="line"><span class="built_in">cd</span> 3.0.6/</span><br></pre></td></tr></table></figure><h4 id="编辑vars-文件"><a href="#编辑vars-文件" class="headerlink" title="编辑vars 文件"></a>编辑vars 文件</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vars 文件中定义的变量是用于生成证书的基本信息，没这个文件可新建，填写如下内容（变量值根据实际情况随便填写）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span></span><br><span class="line">/etc/openvpn/easy-rsa/3.0.6</span><br><span class="line"></span><br><span class="line">vim vars</span><br><span class="line"><span class="built_in">export</span> KEY_SIZE=2048 //生成密钥的位数</span><br><span class="line"><span class="built_in">export</span> KEY_COUNTRY=<span class="string">"CN"</span>   //你所在国家码，2个字符</span><br><span class="line"><span class="built_in">export</span> KEY_PROVINCE=<span class="string">"CQ"</span>   //你所在省份</span><br><span class="line"><span class="built_in">export</span> KEY_CITY=<span class="string">"CHONGQING"</span>   //你所在城市</span><br><span class="line"><span class="built_in">export</span> KEY_ORG=<span class="string">"xxlaila"</span>      //你所在组织</span><br><span class="line"><span class="built_in">export</span> KEY_EMAIL=admin@xxlaila.cn  //你的邮箱地址</span><br><span class="line"><span class="built_in">export</span> KEY_CN=ceshi  //随意</span><br><span class="line"><span class="built_in">export</span> KEY_NAME=ceshi  //随意</span><br><span class="line"><span class="built_in">export</span> KEY_OU=xxlaila  //你所在的单位</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使变量生效</span></span><br><span class="line"><span class="built_in">source</span> ./vars</span><br></pre></td></tr></table></figure><h4 id="生成-CA-根证书"><a href="#生成-CA-根证书" class="headerlink" title="生成 CA 根证书"></a>生成 CA 根证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始化 pki 相关目录</span></span><br><span class="line">./easyrsa init-pki</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成 CA 根证书, 输入 Common Name，名字随便起。</span></span><br><span class="line">./easyrsa build-ca nopass</span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: ./vars</span><br><span class="line"></span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">....................................................................+++</span><br><span class="line">.....+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [Easy-RSA CA]:xxlaila.cn</span><br><span class="line"></span><br><span class="line">CA creation complete and you may now import and sign cert requests.</span><br><span class="line">Your new CA certificate file <span class="keyword">for</span> publishing is at:</span><br><span class="line">/etc/openvpn/easy-rsa/3.0.6/pki/ca.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书如下</span></span><br><span class="line"><span class="comment"># find ./ -name ca*</span></span><br><span class="line">./x509-types/ca</span><br><span class="line">./pki/private/ca.key</span><br><span class="line">./pki/ca.crt</span><br></pre></td></tr></table></figure><h4 id="生成-OpenVPN-服务器证书和密钥"><a href="#生成-OpenVPN-服务器证书和密钥" class="headerlink" title="生成 OpenVPN 服务器证书和密钥"></a>生成 OpenVPN 服务器证书和密钥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一个参数 server 为证书名称，可以随便起，比如 ./easyrsa build-server-full openvpn nopass</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./easyrsa build-server-full server nopass</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: ./vars</span><br><span class="line"></span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line">..+++</span><br><span class="line">.........................................................................................................................................................+++</span><br><span class="line">writing new private key to <span class="string">'/etc/openvpn/easy-rsa/3.0.6/pki/private/server.key.7zl4ekqsBM'</span></span><br><span class="line">-----</span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa/3.0.6/pki/safessl-easyrsa.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">'s Distinguished Name is as follows</span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:'</span>server<span class="string">'</span></span><br><span class="line"><span class="string">Certificate is to be certified until Feb 14 07:19:05 2023 GMT (1080 days)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br></pre></td></tr></table></figure><h4 id="生成-Diffie-Hellman-算法需要的密钥文件"><a href="#生成-Diffie-Hellman-算法需要的密钥文件" class="headerlink" title="生成 Diffie-Hellman 算法需要的密钥文件"></a>生成 Diffie-Hellman 算法需要的密钥文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa gen-dh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成文件</span></span><br><span class="line">find ./ -name server*</span><br><span class="line">./x509-types/server</span><br><span class="line">./x509-types/serverClient</span><br><span class="line">./pki/private/server.key</span><br><span class="line">./pki/reqs/server.req</span><br><span class="line">./pki/issued/server.crt</span><br></pre></td></tr></table></figure><h4 id="生成-tls-auth-key"><a href="#生成-tls-auth-key" class="headerlink" title="生成 tls-auth key"></a>生成 tls-auth key</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这个 key 主要用于防止 DoS 和 TLS 攻击，这一步其实是可选的，但为了安全还是生成一下，该文件在后面配置 open VPN 时会用到。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn --genkey --secret ta.key</span><br></pre></td></tr></table></figure><h4 id="生成自动吊销用户证书"><a href="#生成自动吊销用户证书" class="headerlink" title="生成自动吊销用户证书"></a>生成自动吊销用户证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa gen-crl</span><br><span class="line">Note: using Easy-RSA configuration from: ./vars</span><br><span class="line"></span><br><span class="line">Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa/3.0.6/pki/safessl-easyrsa.cnf</span><br><span class="line"></span><br><span class="line">An updated CRL has been created.</span><br><span class="line">CRL file: /etc/openvpn/easy-rsa/3.0.6/pki/crl.pem</span><br></pre></td></tr></table></figure><p><strong>注</strong>：crl.pem证书的不能移动，否则在后期删除用户认证的时候不生效，保持该目录即可</p><h4 id="整理证书"><a href="#整理证书" class="headerlink" title="整理证书"></a>整理证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/openvpn/server/certs &amp;&amp; <span class="built_in">cd</span> /etc/openvpn/server/certs/</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/pki/dh.pem ./</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/pki/ca.crt ./</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/pki/issued/server.crt ./</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/pki/private/server.key ./</span><br><span class="line">cp /etc/openvpn/easy-rsa/3.0.6/ta.key ./</span><br><span class="line"></span><br><span class="line">ls -ltrh</span><br><span class="line">total 24K</span><br><span class="line">-rw------- 1 root root  424 Mar  1 15:27 dh.pem</span><br><span class="line">-rw------- 1 root root 1.2K Mar  1 15:27 ca.crt</span><br><span class="line">-rw------- 1 root root 4.5K Mar  1 15:28 server.crt</span><br><span class="line">-rw------- 1 root root 1.7K Mar  1 15:28 server.key</span><br><span class="line">-rw------- 1 root root  636 Mar  1 15:28 ta.key</span><br></pre></td></tr></table></figure><h3 id="openvpn-server配置"><a href="#openvpn-server配置" class="headerlink" title="openvpn server配置"></a>openvpn server配置</h3><h4 id="创建-open-VPN-日志目录"><a href="#创建-open-VPN-日志目录" class="headerlink" title="创建 open VPN 日志目录"></a>创建 open VPN 日志目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/<span class="built_in">log</span>/openvpn/</span><br><span class="line">chown openvpn:openvpn /var/<span class="built_in">log</span>/openvpn</span><br></pre></td></tr></table></figure><h4 id="配置-OpenVPN"><a href="#配置-OpenVPN" class="headerlink" title="配置 OpenVPN"></a>配置 OpenVPN</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 可以从 /usr/share/doc/openvpn-/sample/sample-config-files 复制一份 demo 到 /etc/openvpn/（openvpn 版本号查看：<code>yum info openvpn</code>。）然后改改，或者从头开始创建一个新的配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openvpn/</span><br><span class="line"></span><br><span class="line">vim server.conf</span><br><span class="line">port 1194   <span class="comment"># 监听的端口号</span></span><br><span class="line">proto udp   <span class="comment"># 服务端用的协议，udp,默认udp</span></span><br><span class="line">dev tun</span><br><span class="line">ca /etc/openvpn/server/certs/ca.crt  <span class="comment">#   CA 根证书路径</span></span><br><span class="line">cert /etc/openvpn/server/certs/server.crt  <span class="comment"># open VPN 服务器证书路径</span></span><br><span class="line">key /etc/openvpn/server/certs/server.key  <span class="comment"># open VPN 服务器密钥路径，This file should be kept secret</span></span><br><span class="line">dh /etc/openvpn/server/certs/dh.pem  <span class="comment"># Diffie-Hellman 算法密钥文件路径</span></span><br><span class="line">tls-auth /etc/openvpn/server/certs/ta.key 0 <span class="comment"># 开启TLS-auth，使用ta.key防御攻击。服务器端的第二个参数值为0，客户端的为1。</span></span><br><span class="line">ifconfig-pool-persist ipp.txt <span class="comment">#服务器自动给客户端分配IP后，客户端下次连接时，仍然采用上次的IP地址(第一次分配的IP保存在ipp.txt中，下一次分配其中保存的IP)。</span></span><br><span class="line">push <span class="string">"route 10.0.0.0 255.0.0.0"</span>   <span class="comment"># # 推送路由和DNS到客户端</span></span><br><span class="line">push <span class="string">"route 172.21.16.0 255.255.240.0"</span>  <span class="comment"># 推送路由到客户端，如果内网服务器地址是172.21.16.0的网段，可以增加此行，然后就可以ping通内网地址的所有服务器</span></span><br><span class="line">server 10.8.0.0 255.255.255.0   <span class="comment"># 该网段为 open VPN 虚拟网卡网段，不要和内网网段冲突即可。open VPN 默认为 10.8.0.0/24</span></span><br><span class="line">push <span class="string">"dhcp-option DNS 8.8.8.8"</span>  <span class="comment"># DNS 服务器配置，可以根据需要指定其他 ns</span></span><br><span class="line">push <span class="string">"dhcp-option DNS 8.8.4.4"</span></span><br><span class="line"><span class="comment"># push "redirect-gateway def1"   # 客户端所有流量都通过 open VPN 转发，类似于代理开全局，VPN服务器本身要通过客户端原来的网关访问(取消redirect-gateway def1 bypass-dhcp选项后这项必须开启，否则无法访问OpenVPN服务器)</span></span><br><span class="line">compress lzo</span><br><span class="line">duplicate-cn   <span class="comment"># 如果客户端都使用相同的证书和密钥连接VPN，一定要打开这个选项，否则每个证书只允许一个人连接VPN</span></span><br><span class="line">keepalive 10 120  <span class="comment"># 每10秒ping一次，连接超时时间设为120秒。</span></span><br><span class="line">comp-lzo  <span class="comment"># 开启VPN连接压缩，如果服务器端开启，客户端也必须开启</span></span><br><span class="line">client-to-client <span class="comment">#设置客户端是否可以访问客户端</span></span><br><span class="line">persist-key <span class="comment"># 持久化选项可以尽量避免访问在重启时由于用户权限降低而无法访问的某些资源。</span></span><br><span class="line">persist-tun</span><br><span class="line">max-clients 100 <span class="comment"># 允许最大的客户端连接数，默认100</span></span><br><span class="line">user openvpn  <span class="comment"># open VPN 进程启动用户，openvpn 用户在安装完 openvpn 后就自动生成了</span></span><br><span class="line">group openvpn</span><br><span class="line"><span class="built_in">log</span> /var/<span class="built_in">log</span>/openvpn/server.log  <span class="comment"># 指定 log 文件位置</span></span><br><span class="line"><span class="built_in">log</span>-append /var/<span class="built_in">log</span>/openvpn/server.log</span><br><span class="line">status /var/<span class="built_in">log</span>/openvpn/status.log</span><br><span class="line">verb 3</span><br><span class="line">explicit-exit-notify 1  <span class="comment"># 设置断线重连功能</span></span><br><span class="line">cipher AES-256-CBC    <span class="comment">#指定数据对称加密算法</span></span><br><span class="line">reneg-sec 0   <span class="comment">#reneg-sec服务器端会定期检查认证情况，默认3600秒一小时，使用OTP的话尽量时间长一些，否则客户端需要重新输入用户名密码和OTP一次性密码。</span></span><br><span class="line">auth-nocache  <span class="comment">#断线后防止内存中保存用户名和密码来提高安全性</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li>openvpn 2.4.8 版本启动协议需要使用udp，否则无法启动，启动的时候会提示<code>Options error: --explicit-exit-notify can only be used with --proto udp</code>，而且默认配置文件里面协议也是udp。udp协议有很多好处，<a href="https://www.cnblogs.com/nieliangcai/p/10362751.html" target="_blank" rel="noopener">可以参考</a>说明</li><li>push “redirect-gateway def1”: 参数，如果添加该参数，所有客户端的默认网关都将重定向到VPN，这将导致诸如web浏览器、DNS查询等所有客户端流量都经过这里。但是在实际的应用中，我们期望的是只有需要进过vpn流量的时候才走vpn，其他的就正常走我们自己的网络就可以啦。所以在server.conf文件里面这行就需要注释掉。</li></ul><h4 id="防火墙相关配置"><a href="#防火墙相关配置" class="headerlink" title="防火墙相关配置"></a>防火墙相关配置</h4><h5 id="禁用-Centos7-默认的-firewalld和SELinux"><a href="#禁用-Centos7-默认的-firewalld和SELinux" class="headerlink" title="禁用 Centos7 默认的 firewalld和SELinux"></a>禁用 Centos7 默认的 firewalld和SELinux</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 马上生效</span></span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久关闭(需要重启服务器生效)</span></span><br><span class="line">sed -i ‘s/SELINUX=enforcing/SELINUX=disabled/g’ /etc/selinux/config</span><br></pre></td></tr></table></figure><h5 id="启用iptables"><a href="#启用iptables" class="headerlink" title="启用iptables"></a>启用iptables</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> iptables</span><br><span class="line">systemctl start iptables</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有防火墙规则</span></span><br><span class="line">iptables -F</span><br></pre></td></tr></table></figure><h5 id="添加防火墙规则"><a href="#添加防火墙规则" class="headerlink" title="添加防火墙规则"></a>添加防火墙规则</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 openvpn 的网络流量转发到公网：snat 规则</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables 规则持久化保存</span></span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">sudo /usr/libexec/iptables/iptables.init save</span><br></pre></td></tr></table></figure><h5 id="规则查看"><a href="#规则查看" class="headerlink" title="规则查看"></a>规则查看</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -nvL -t nat</span><br></pre></td></tr></table></figure><h4 id="启动-open-VPN"><a href="#启动-open-VPN" class="headerlink" title="启动 open VPN"></a>启动 open VPN</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start openvpn@server</span><br><span class="line">systemctl <span class="built_in">enable</span> openvpn@server</span><br><span class="line">systemctl status openvpn@server</span><br></pre></td></tr></table></figure><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -antpu | grep openvpn</span><br><span class="line">udp        0      0 0.0.0.0:1194            0.0.0.0:*                           1787/openvpn</span><br></pre></td></tr></table></figure><h4 id="路由器端口映射"><a href="#路由器端口映射" class="headerlink" title="路由器端口映射"></a>路由器端口映射</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于公司只有一个公网Ip，所以只能在路由器上做端口映射，<a href="https://www.xxlaila.cn/2019/09/10/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/">端口映射</a>参考</p><h3 id="openvpn-client"><a href="#openvpn-client" class="headerlink" title="openvpn client"></a>openvpn client</h3><h4 id="OpenVPN客户端配置"><a href="#OpenVPN客户端配置" class="headerlink" title="OpenVPN客户端配置"></a>OpenVPN客户端配置</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;要连接到 open VPN 服务端首先得需要一个客户端软件，在 Mac 下推荐使用 <a href="https://tunnelblick.net/downloads.html" target="_blank" rel="noopener">Tunnelblick</a>。Tunnelblick 是一个开源、免费的 Mac 版 open VPN 客户端软件。如果Tunnelblick安装失败，不要用常见的方式进行卸载，要在Tunnelblick的官方下载一个Tunnelblick的卸载安装包进行Tunnelblick的卸载，否则不成功。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面在服务端创建一个 open VPN 用户：其实创建用户的过程就是生成客户端 SSL 证书的过程，然后将其他相关的证书文件、key、.ovpn 文件（客户端配置文件）打包到一起供客户端使用。由于创建一个用户的过程比较繁琐，所以在此将整个过程写成了一个脚本 vpn_user.sh，然后定义一个客户端基础的模版文件 sample.ovpn。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先创建一个客户端配置模板文件 sample.ovpn，该文件在脚本中会用到，放到 /etc/openvpn/client/ 目录，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat sample.ovpn</span><br><span class="line">client</span><br><span class="line">proto udp</span><br><span class="line">dev tun</span><br><span class="line">remote [open VPN服务端公网 ip，根据实际情况填写] 1194  //openvpn服务器的外网IP和端口(可以写多个做到高可用)</span><br><span class="line">ca ca.crt</span><br><span class="line">cert admin.crt</span><br><span class="line">key admin.key</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">remote-cert-tls server  //指定采用服务器校验方式</span><br><span class="line">comp-lzo</span><br><span class="line">verb 3     //调试信息级别</span><br><span class="line">mute-replay-warnings</span><br><span class="line">resolv-retry infinite    //断线自动重新连接</span><br><span class="line">nobind    //不绑定特定的本地端口号</span><br><span class="line">persist-key    //与服务器端的保持一致</span><br><span class="line">persist-tun    //与服务器端的保持一致</span><br><span class="line">cipher AES-256-CBC    //指定数据对称加密算法</span><br></pre></td></tr></table></figure><p><strong>注</strong>: client.key 和 client.crt 替换为用户的key。</p><h4 id="linux-客户端"><a href="#linux-客户端" class="headerlink" title="linux 客户端"></a>linux 客户端</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;需要在linux服务器上安装openvpn，安装完成以后增加配置文件即可。client.ovpn配置文件和上述mac 配置文件一致，下面贴出有区别后的结果。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装openvpn</span></span><br><span class="line">yum -y install openvpn</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/client</span><br><span class="line"><span class="comment"># 把生成后的配置文件解压到该目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动openvpn 客户端</span></span><br><span class="line">nohup /usr/sbin/openvpn --config /etc/openvpn/client/usernmae.ovpn --<span class="built_in">log</span>-append /tmp/openvpn.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用账号和密码登录，需要使用systemd-tty-ask-password-agent来进行账号和密码输入登录认证,如下</span></span><br><span class="line"></span><br><span class="line">Password entry required <span class="keyword">for</span> <span class="string">'Enter Auth Username:'</span> (PID 4699).</span><br><span class="line">Please enter password with the systemd-tty-ask-password-agent tool!</span><br><span class="line"></span><br><span class="line">systemd-ask-password</span><br><span class="line">systemd-ask-password: required argument missing.</span><br><span class="line">Enter Auth Username: username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Broadcast message from root@VM_11-11_centos (Fri 2020-03-13 10:24:49 CST):</span><br><span class="line">Password entry required <span class="keyword">for</span> <span class="string">'Enter Auth Password:'</span> (PID 4762).</span><br><span class="line">Please enter password with the systemd-tty-ask-password-agent tool!</span><br><span class="line">systemd-tty-ask-password-agent</span><br><span class="line">Enter Auth Password: *********</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以查看/tmp/openvpn.log日志输出的记录信息。里面包含了一些路由的添加</p><h4 id="linux-下结果验证"><a href="#linux-下结果验证" class="headerlink" title="linux 下结果验证"></a>linux 下结果验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ifconfig tun0</span><br><span class="line">tun0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 10.8.0.10  netmask 255.255.255.255  destination 10.8.0.9</span><br><span class="line">        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 100  (UNSPEC)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><h4 id="windows下的client-ovpn配置文件"><a href="#windows下的client-ovpn配置文件" class="headerlink" title="windows下的client.ovpn配置文件"></a>windows下的client.ovpn配置文件</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;windows 客户端在官方下载对应的系统的客户端进行安装，安装完成后会在当前的用户目录下面有一个<code>C:\Users\username\OpenVPN\config\</code>的路径，吧在服务器上生成的username.zip解压到该目录下面即可。然后点击链接。windows 客户端的配置文件如下，和上面的一样。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat sample.ovpn</span><br><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto udp</span><br><span class="line">remote [open VPN服务端公网 ip，根据实际情况填写] 1194  //openvpn服务器的外网IP和端口(可以写多个做到高可用)</span><br><span class="line">resolv-retry infinite</span><br><span class="line"><span class="comment"># redirect-gateway def1#让客户端发起的所有IP请求都通过OpenVPN服务器</span></span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">cert admin.crt</span><br><span class="line">key admin.key</span><br><span class="line"><span class="comment">#auth-user-pass   //用用户名密码登陆认证方式</span></span><br><span class="line">remote-cert-tls server</span><br><span class="line">tls-auth ta.key 1<span class="comment">#ta.key</span></span><br><span class="line">tls-client<span class="comment">#TLS加密传输</span></span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure><p><strong>注释</strong>:</p><ul><li>auth-user-pass: 该参数是注释掉的，如果开启该参数，任意的账户和密码都可以链接vpn，非常的不安全，如果客户端开启这个参数，服务器端一定要启用用户认证。<a href="https://openvpn.net/community-resources/using-alternative-authentication-methods/" target="_blank" rel="noopener">用户认证</a>参考</li></ul><h4 id="创建-open-VPN-用户脚本"><a href="#创建-open-VPN-用户脚本" class="headerlink" title="创建 open VPN 用户脚本"></a>创建 open VPN 用户脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat vpn_user.sh</span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">OVPN_USER_KEYS_DIR=/etc/openvpn/client/keys</span><br><span class="line">EASY_RSA_VERSION=3.0.6</span><br><span class="line">EASY_RSA_DIR=/etc/openvpn/easy-rsa/</span><br><span class="line">PKI_DIR=<span class="variable">$EASY_RSA_DIR</span>/<span class="variable">$EASY_RSA_VERSION</span>/pki</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ -d <span class="string">"<span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    rm -rf <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span></span><br><span class="line">    rm -rf  <span class="variable">$PKI_DIR</span>/reqs/<span class="variable">$user</span>.req</span><br><span class="line">    sed -i <span class="string">'/'</span><span class="string">"<span class="variable">$user</span>"</span><span class="string">'/d'</span> <span class="variable">$PKI_DIR</span>/index.txt</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$EASY_RSA_DIR</span>/<span class="variable">$EASY_RSA_VERSION</span></span><br><span class="line">  <span class="comment"># 生成客户端 ssl 证书文件</span></span><br><span class="line">  ./easyrsa build-client-full <span class="variable">$user</span> nopass</span><br><span class="line">  <span class="comment"># 整理下生成的文件</span></span><br><span class="line">  mkdir -p  <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span></span><br><span class="line">  cp <span class="variable">$PKI_DIR</span>/ca.crt <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/   <span class="comment"># CA 根证书</span></span><br><span class="line">  cp <span class="variable">$PKI_DIR</span>/issued/<span class="variable">$user</span>.crt <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/   <span class="comment"># 客户端证书</span></span><br><span class="line">  cp <span class="variable">$PKI_DIR</span>/private/<span class="variable">$user</span>.key <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/  <span class="comment"># 客户端证书密钥</span></span><br><span class="line">  cp /etc/openvpn/client/sample.ovpn <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/<span class="variable">$user</span>.ovpn <span class="comment"># 客户端配置文件</span></span><br><span class="line">  sed -i <span class="string">'s/admin/'</span><span class="string">"<span class="variable">$user</span>"</span><span class="string">'/g'</span> <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/<span class="variable">$user</span>.ovpn</span><br><span class="line">  cp /etc/openvpn/server/certs/ta.key <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>/ta.key  <span class="comment"># auth-tls 文件</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$OVPN_USER_KEYS_DIR</span></span><br><span class="line">  zip -r <span class="variable">$user</span>.zip <span class="variable">$user</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;执行上面脚本创建一个用户：sh vpn_user.sh<username>，会在 /etc/openvpn/client/keys 目录下生成以用户名命名的 zip 打包文件，将该压缩包下载到本地解压，然后将里面的 .ovpn 文件拖拽到 Tunnelblick 客户端软件即可使用。客户端目录随意存放。生产的内容如下</username></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── ca.crt</span><br><span class="line">├── username.crt</span><br><span class="line">├── username.key</span><br><span class="line">├── username.ovpn</span><br><span class="line">└── ta.key</span><br></pre></td></tr></table></figure><h4 id="删除一个-OpenVPN-用户"><a href="#删除一个-OpenVPN-用户" class="headerlink" title="删除一个 OpenVPN 用户"></a>删除一个 OpenVPN 用户</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上面介绍了如何添加一个用户，如果公司员工离职了或者其他原因，想删除对应用户 OpenVPN 的使用权，只要吊销对应用户的 SSL 证书即可。因为OpenVPN 的客户端和服务端的认证主要通过 SSL 证书进行双向认证。</p><h5 id="编辑-OpenVPN-服务端配置-server-conf-添加如下配置"><a href="#编辑-OpenVPN-服务端配置-server-conf-添加如下配置" class="headerlink" title="编辑 OpenVPN 服务端配置 server.conf 添加如下配置:"></a>编辑 OpenVPN 服务端配置 server.conf 添加如下配置:</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crl-verify /etc/openvpn/easy-rsa/3.0.6/pki/crl.pem</span><br></pre></td></tr></table></figure><h5 id="吊销用户证书"><a href="#吊销用户证书" class="headerlink" title="吊销用户证书"></a>吊销用户证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa/3.0.6/</span><br><span class="line">./easyrsa revoke username</span><br><span class="line">./easyrsa gen-crl</span><br></pre></td></tr></table></figure><h5 id="重启-OpenVPN-服务端使其生效"><a href="#重启-OpenVPN-服务端使其生效" class="headerlink" title="重启 OpenVPN 服务端使其生效"></a>重启 OpenVPN 服务端使其生效</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openvpn@server</span><br></pre></td></tr></table></figure><h5 id="一键删除用户"><a href="#一键删除用户" class="headerlink" title="一键删除用户"></a>一键删除用户</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat del_vpn_user.sh</span><br><span class="line"><span class="comment"># ! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line">OVPN_USER_KEYS_DIR=/etc/openvpn/client/keys</span><br><span class="line">EASY_RSA_VERSION=3.0.6</span><br><span class="line">EASY_RSA_DIR=/etc/openvpn/easy-rsa/</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$EASY_RSA_DIR</span>/<span class="variable">$EASY_RSA_VERSION</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">'yes\n'</span> | ./easyrsa revoke <span class="variable">$user</span></span><br><span class="line">  ./easyrsa gen-crl</span><br><span class="line">  <span class="comment"># 吊销掉证书后清理客户端相关文件</span></span><br><span class="line">  <span class="keyword">if</span> [ -d <span class="string">"<span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$user</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    rm -rf <span class="variable">$OVPN_USER_KEYS_DIR</span>/<span class="variable">$&#123;user&#125;</span>*</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  systemctl restart openvpn@server</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上述配置完成了用户流量的分配，必要的地址都vpn，其余的走正常的自己的网络。不会全部走vpn。</p><blockquote><p>引用: <a href="https://www.yeboyzq.com/linux/fuwuqipeizhi/989.html" target="_blank" rel="noopener">https://www.yeboyzq.com/linux/fuwuqipeizhi/989.html</a><br><a href="https://qhh.me/2019/06/16/Cenos7-%E4%B8%8B%E6%90%AD%E5%BB%BA-OpenVPN-%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" target="_blank" rel="noopener">https://qhh.me/2019/06/16/Cenos7-%E4%B8%8B%E6%90%AD%E5%BB%BA-OpenVPN-%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;由于公司内部系统比较多，而且这部分系统都是只能在公司内网访问，
    
    </summary>
    
      <category term="vpn" scheme="https://www.xxlaila.cn/categories/vpn/"/>
    
    
      <category term="openvpn" scheme="https://www.xxlaila.cn/tags/openvpn/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes里的Service究竟是如何工作</title>
    <link href="https://www.xxlaila.cn/2020/03/01/Kubernetes%E9%87%8C%E7%9A%84Service%E7%A9%B6%E7%AB%9F%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C/"/>
    <id>https://www.xxlaila.cn/2020/03/01/Kubernetes里的Service究竟是如何工作/</id>
    <published>2020-03-01T03:31:06.000Z</published>
    <updated>2020-03-01T03:41:12.133Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Service是Kubernetes接入层的一种抽象资源，它为我们提供了一种固定的、统一的访问接口地址和负载均衡能力，<a id="more"></a>这时可能会想到，当时使用docker-compose的时候，不存在Service概念，不也运行起来了吗？是的，在Kubernetes集群内部Pod ip也是互通的，但是Pod的ip会经常因为扩容、重建而导致客户端访问错误，pod访问无法提供负载均衡的能力，而Service通过选择一组Pod的label就直接可以访问到Pod，而且可以使用万年不变的域名，所以就选择Service了。</p><h3 id="Service是怎么产生的，在集群内部是如何存在的呢"><a href="#Service是怎么产生的，在集群内部是如何存在的呢" class="headerlink" title="Service是怎么产生的，在集群内部是如何存在的呢"></a>Service是怎么产生的，在集群内部是如何存在的呢</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在kubernetes当中所谓的Service是kube-proxy生成iptables或ipvs规则，它会产生一组虚拟地址，在集群环境下有效。Service不能直接到达Pod内部，中间会间隔EndPoints，这是一组ip和port的组合。默认类型是ClusterIP它仅能接收集群中pod客户端程序的访问请求。这也是最常用的一种类型，另外还有NodePort、LoadBalancer、ExternalName。</p><h3 id="iptables或ipvs，到底是iptables还是ipvs呢？"><a href="#iptables或ipvs，到底是iptables还是ipvs呢？" class="headerlink" title="iptables或ipvs，到底是iptables还是ipvs呢？"></a>iptables或ipvs，到底是iptables还是ipvs呢？</h3><blockquote><p>一个Service对象就是工作节点上的一些iptables或ipvs规则，用于将到达Service对象IP地址的流量调度转发至相应的Endpoints对象指向的IP地址和端口之上。</p></blockquote><p>这句话我们经常看到，如何理解呢？</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes1.1之前是基于userspace实现，这种模型之下，每次请求流量要先到达内核空间，经有套接字转发到kube-proxy，然后再由它送回到内核空间，之后调度到后端pod之上，可以看出请求在用户空间和内核空间来回转发，效率必然不高。但是当pod无响应时，能够自动重定向到其它pod。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在Kubernetes1.1版本开始引入iptables规则，Kubernetes1.2开始成为默认类型。即在创建Service资源时，集群上每个节点的kube-proxy都会收到通知，并且创建iptables规则，用于转发到此Service ClusterIP的流量。工作TCP/IP的传输层，高效稳定。</p><p>但是这种方式有如下缺点：</p><ul><li>1、iptables代理模型挑中的pod无响应时，不能自动重定向到集群内部其它pod资源对象之上。</li><li>2、kube-proxy通过iptables处理Service和pod的交互，每产生一个计算节点或者产生大量的pod就需要产生相应大量的iptables规则，不难想象，这些iptables规则每次需要刷新匹配保证正确性，就需要占用大量的CPU资源，所以基于iptables的Service实现就成了制约Kubernetes承载更多pod的瓶颈。</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在Kubernetes1.11开始默认使用ipvs模型，在这种模型下kube-proxy会跟踪APIServer上Service和endpoints对象变化，调用netlink创建ipvs规则，请求调度流量功能由ipvs实现，运行于netfilter之上的钩子函数，具有流量转发速度快，规则性能同步好的特点，支持众多调度算法，剩下仍然由iptables完成。说到这里我们就大概明白了iptables和ipvs的作用和关系了。</p><h3 id="Kubernetes的服务发现是通过dns实现，那么为什么会出现四种类型的服务暴露方式呢？"><a href="#Kubernetes的服务发现是通过dns实现，那么为什么会出现四种类型的服务暴露方式呢？" class="headerlink" title="Kubernetes的服务发现是通过dns实现，那么为什么会出现四种类型的服务暴露方式呢？"></a>Kubernetes的服务发现是通过dns实现，那么为什么会出现四种类型的服务暴露方式呢？</h3><p>说到Service不得不介绍kubernetes网络模型和通信方式<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一个完整的Kubernetes集群应该包含三层网络，首先第一层是mater和node节点之间的网络，这个网络需要在部署kubernetes集群之前配置完成；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第二层网络是pod的网络通过kubelet或者cni插件实现，用于pod之间或者内部的通信，集群中的所有pod均处在同一个网络平面空间内，可以直接通信；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第三层网络是Service资源的网络，是一个虚拟网络，用于为Kubernetes集群配置IP地址，但此地址并不配置于任何主机或者容器的网络接口之上，而是通过kubeproxy配置为iptables规则，将发往该地址的所有流量调度至后端的pod之上。</p><p>通信方式分为以下四种：</p><ul><li>同一个pod的内部通信；</li><li>各个pod彼此通信；</li><li>pod和service的通信；</li><li>集群外部流向service的通信。</li></ul><p>所以Service为了满足这些通信方式就出现了如下类型：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusterIP：为集群内部ip地址暴露服务，仅在集群内可达，外部ip无法访问，默认Service类型；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NodePort：这种类型建立在clusterIp之上，为节点的IP地址暴NodePort服务，外部节点可以通过NodeIP:NodePort直接访问；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoadBalancer：这种类型构建在NodePort之上，它可以关联到集群外部的某个负载均衡设备。Kubernetes没有为私有化集群提供LoadBalancer的支持。如果在私有化集群使用需要自建负载均衡器；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExternalName：其通过将Service映射至由externalName字段的内容指定的主机名来暴露服务，此主机名需要被DNS服务解析至CNAME类型的记录。这句话怎么理解呢？</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举个例子，你所有的服务都在集群内部，但是你有个数据库是mongodb，没有实现容器化，更没有部署在Kubernetes内部，当然你可以通过在ConfigMap中添加配置访问这个外部服务，但是当你的环境发生变化，比如从开发环境和生产环境的数据地址不同，这个时候你需要修改和重建ConfigMap。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个时候可以使用Kubernetes ExternalName内置服务发现机制运用于集群外部运行的服务，像使用集群内的服务一样使用外部服务！通过这种方式，您可以在开发环境和生产环境中实现相同的功能，如果您最终将服务移入集群内，则不需要更改任何代码和配置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line"> name: mongo</span><br><span class="line">spec:</span><br><span class="line"> <span class="built_in">type</span>: ExternalName</span><br><span class="line"> externalName: mango123456.com</span><br></pre></td></tr></table></figure><p>你只需要访问：mongodb://<dbuser>:<dbpassword>@mongo:<port>就可以自动访问外部服务。</port></dbpassword></dbuser></p><h3 id="Service本身有端口、Pod也有端口、容器也有端口，之间有什么关系呢？"><a href="#Service本身有端口、Pod也有端口、容器也有端口，之间有什么关系呢？" class="headerlink" title="Service本身有端口、Pod也有端口、容器也有端口，之间有什么关系呢？"></a>Service本身有端口、Pod也有端口、容器也有端口，之间有什么关系呢？</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;containerPort：一个信息性数据，为集群提供一个可以快速了解相关pod可以访问端口的途径，而且显式指定容器端口，无论你是否指定都不影响其他节点上的客户端pod对其进行访问；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port：服务提供端口，用于kubernetes集群内部服务访问；</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;targetPort：pod目标端口，如果不设置使用默认port端口，port和nodePort的数据通过这个端口进入到Pod内部，Pod里面的containers的端口映射到这个端口，提供服务；</p><p>nodePort：Kubernetes集群外部用户访问端口；</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文主要总结了Service的工作原理和机制。只有明白Service这些概念，才能灵活使用Service，当我们服务出现故障的时候，根据它的原理去分析问题到底出在什么地方，进而快速解决问题。</p><blockquote><p>来源: 微信群分享<br>原文： <a href="https://mp.weixin.qq.com/s/ucwnfpXgHFNBR3CHd5JLMQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ucwnfpXgHFNBR3CHd5JLMQ</a><br>版权: 本文版权归原作者所有</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Service是Kubernetes接入层的一种抽象资源，它为我们提供了一种固定的、统一的访问接口地址和负载均衡能力，
    
    </summary>
    
      <category term="kubernetes" scheme="https://www.xxlaila.cn/categories/kubernetes/"/>
    
    
      <category term="service" scheme="https://www.xxlaila.cn/tags/service/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch集群规划</title>
    <link href="https://www.xxlaila.cn/2020/02/20/Elasticsearch%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92/"/>
    <id>https://www.xxlaila.cn/2020/02/20/Elasticsearch集群规划/</id>
    <published>2020-02-20T07:38:04.000Z</published>
    <updated>2020-03-01T03:32:22.145Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在Elasticsearch集群规划中，如何规划集群，合理的规划集群可以防止Elasticsearch出现脑裂，<a id="more"></a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为避免Elasticsearch集群出现脑裂，Elasticsearch的的config目录下elasticsearch.yml文件中配置避免脑裂的参数，常见的参数是<code>discovery.zen.minimum_master_nodes</code>,该参数决定主节点选择工程中至少需要有多少个master节点，默认配置1。基本的参数原则是N/2+1，如在一个3个节点的集群中，<code>discovery.zen.minimum_master_nodes</code>应该设置为2。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果在2个集群节点中，如果吧<code>discovery.zen.minimum_master_nodes</code>设置为2，当两个节点通信失败时，节点1会失去它的主状态，同时节点2也不会被选举为主节点。这种情况下可以配置另外一个参数来防止脑裂，<code>discovery.zen.ping.timeout</code>，默认值时3秒，用该参数来决定节点之间通信的等待时间。如在网络较差的环境里面可以调大该值。但该参数是适用于高网络延迟的情况。建议配置至少3节点的集群。</p><h3 id="分布式集群"><a href="#分布式集群" class="headerlink" title="分布式集群"></a>分布式集群</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch集群中的节点一般分为3中角色，如何区别这种角色，取决于在搭建分布式集群以前需要在配置文件中指定节点角色。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;节点简介</p><ul><li>master 节点: master节点主要负责元数据的处理；比如索引的新增、删除、分片分配等，每当元数据有更新时，master节点负责同步到其他节点上。</li><li>data 节点: data节点上保存了数据分片，负责数据相关的操作，如分片的增删改查以及搜索和整个操作。</li><li>client 节点: client节点起到路由请求作用，可以看作为负载均衡，适用于高并发访问的业务场景。</li></ul><h4 id="列子"><a href="#列子" class="headerlink" title="列子"></a>列子</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3台Elasticsearch服务器(172.21.1.10，172.21.1.11，172.21.1.12)，为避免脑裂，3台机器master节点为2（172.21.1.10，172.21.1.11），同时也为data节点。172.21.1.12为client节点，三个ip对应hostname为：node-10，node-11，node-12。</p><ul><li>172.21.1.10 节点<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: test1</span><br><span class="line">node.name: node-10</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"172.21.1.10"</span>, <span class="string">"172.21.1.11"</span>]</span><br><span class="line">http.cors.enable: <span class="literal">true</span></span><br><span class="line">http:cors.allow-origin: <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li></ul><p>注释:</p><ul><li>http.cors.enable: true,http:cors.allow-origin: “*”: 该两个参数为如果要使用head来进行监控Elasticsearch集群，需要配置此参数。<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">elasticsearch-head</a></li></ul><ul><li><p>172.21.1.11 节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: test1</span><br><span class="line">node.name: node-11</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"172.21.1.10"</span>, <span class="string">"172.21.1.11"</span>]</span><br><span class="line">http.cors.enable: <span class="literal">true</span></span><br><span class="line">http:cors.allow-origin: <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li><li><p>172.21.1.12 节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: test1</span><br><span class="line">node.name: node-12</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">node.master: <span class="literal">false</span></span><br><span class="line">node.data: talse</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"172.21.1.10"</span>, <span class="string">"172.21.1.11"</span>]</span><br><span class="line">http.cors.enable: <span class="literal">true</span></span><br><span class="line">http:cors.allow-origin: <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;启动各节点进行head验证</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch集群监控查看<a href="http://www.xxlaila.cn/2019/10/17/elasticserch%E6%97%A5%E5%B8%B8%E7%BB%B4%E6%8A%A4/">elasticserch日常维护</a>，监控插件可以参考<a href="http://www.xxlaila.cn/2019/11/19/logstash%E7%9B%91%E6%8E%A7/">logstash监控</a>末尾。</p><h3 id="Elasticsearch集群api"><a href="#Elasticsearch集群api" class="headerlink" title="Elasticsearch集群api"></a>Elasticsearch集群api</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;利用Elasticsearch 集群健康api查看当前集群的健康信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl http: //127.0.0.1:9200/_cluster/health</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span>: <span class="string">"test1"</span>,</span><br><span class="line">  <span class="string">"status"</span>: <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span>: 3,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span>: 3,</span><br><span class="line">  <span class="string">"active_primary_shards"</span>: 162,</span><br><span class="line">  <span class="string">"active_shards"</span>: 324,</span><br><span class="line">  <span class="string">"relocating_shards"</span>: 0,</span><br><span class="line">  <span class="string">"initializing_shards"</span>: 0,</span><br><span class="line">  <span class="string">"unassigned_shards"</span>: 0,</span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span>: 0,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span>: 0,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span>: 0,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span>: 0,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span>: 100.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h4><ul><li>cluster_name: 集群名称</li><li>status: 集群健康状态；green为所有的主分片和从分片都可以用，yellow所有主分片可用，但存在不可用的从分片，red存在不可用的主分片</li><li>timed_out: 是否超时</li><li>number_of_nodes: 节点数，包括master和data。</li><li>number_of_data_nodes: data节点数</li><li>active_primary_shards: 活动的主分片</li><li>active_shards: 所有活动分片数，包括主分片和副本</li><li>relocating_shards: 正在发生迁移的分片</li><li>initializing_shards: 正在初始化的分片</li><li>unassigned_shards: 没有被分配的分片</li><li>delayed_unassigned_shards: 延迟未被分配的分片</li><li>number_of_pending_tasks: master节点任务队列中的任务数</li><li>number_of_in_flight_fetch: 正在进行迁移的分片数</li><li>task_max_waiting_in_queue_millis: 队列中任务的最大等待时间</li><li>active_shards_percent_as_number: 活动分片的百分比</li></ul><h3 id="Elasticsearch容量评估"><a href="#Elasticsearch容量评估" class="headerlink" title="Elasticsearch容量评估"></a>Elasticsearch容量评估</h3><h4 id="存储容量评估"><a href="#存储容量评估" class="headerlink" title="存储容量评估"></a>存储容量评估</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elasticsearch服务存储空间大小影响因素如下：</p><ul><li>副本数量：副本有利于增加数据的可靠性，但同时会增加存储成本。默认和建议的副本数量为 1。</li><li>索引开销：除原始数据外，ES 需要存储索引等数据，一般情况下数据膨胀为10% (_all等未计算)。</li><li>内部任务开销：ES 自身会占用约 20% 的磁盘空间用于段合并、日志等，因此要预留20%的此部分空间。</li><li>操作系统预留：操作系统也会占用5%的磁盘空间，用于关键流程处理、防止磁盘碎片化问题等。</li><li>安全阈值。通常至少预留15%的安全阈值。</li></ul><p>ES的实际空间可通过下面公式估算:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">实际空间 = 源数据 * (1 + 副本数量) * (1 + 索引开销) / （1-操作系统预留）/(1 - 内部任务开销) </span><br><span class="line">        = 源数据 * (1 + 副本数量) * 1.45</span><br><span class="line">        = 源数据 *2.9</span><br></pre></td></tr></table></figure><blockquote><ul><li>对于_all这项参数，如果不需要在业务上使用，通常建议您禁止或者有选择性地添加。</li><li>如果您需要开启_all参数的索引，磁盘容量的开销也会随之增大。建议在上述评估的基础上，增加空间至原来的1.5倍。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">磁盘总大小 = 源数据 * (1 + 副本数) * 1.7 * (1 + 0.5) </span><br><span class="line">= 源数据 * 5.1</span><br></pre></td></tr></table></figure></li></ul></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了保证服务能稳定运行，建议在上述评估的基础上至少预留50%的存储空间，因此建议申请的存储容量为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">存储容量 = 源数据 * (1 + 副本数量) * 1.45 * （1 + 0.5）</span><br><span class="line">        = 源数据 * 4.35</span><br></pre></td></tr></table></figure><h4 id="服务配置评估"><a href="#服务配置评估" class="headerlink" title="服务配置评估"></a>服务配置评估</h4><ul><li>建议您至少选择 3 个节点，保证集群具有较高的节点故障容错能力。</li><li>如有非常大的存储容量需求，建议主机配置规格更高，有助于提升集群性能和稳定性。</li><li>可以通过观察 CPU 使用率、集群查询QPS、集群写入QPS等监控指标，判断配置是否足够</li></ul><h4 id="分片数量评估"><a href="#分片数量评估" class="headerlink" title="分片数量评估"></a>分片数量评估</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard大小和数量是影响ES集群稳定性和性能的重要因素之一。ES集群中任何一个索引都需要有一个合理的shard规划（默认为5个）。索引分片的数量会影响集群稳定性和性能，且通常确定后无法轻松更改，需要提前规划：</p><ul><li>建议单个分片大小在小规格节点下不超过30GB，在高规格节点下不超过50GB。分片过大会导致ES故障的恢复速度慢，分片过小会导致内存不足等问题。</li><li>分片数量要尽量匹配节点数，分片数可以等于节点数，也可以是节点数的整数倍，方便分片在所有数据节点均匀分布。</li><li>对于日志分析或者超大索引场景，建议单个shard大小不要超过100GB。</li><li>单个节点上同一索引的shard个数不要超5个。</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;利用ansible来安装<a href="https://github.com/xxlaila/ansible" target="_blank" rel="noopener">Elasticsearch</a>集群，</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;集群规划&quot;&gt;&lt;a href=&quot;#集群规划&quot; class=&quot;headerlink&quot; title=&quot;集群规划&quot;&gt;&lt;/a&gt;集群规划&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;在Elasticsearch集群规划中，如何规划集群，合理的规划集群可以防止Elasticsearch出现脑裂，
    
    </summary>
    
      <category term="elasticsearch" scheme="https://www.xxlaila.cn/categories/elasticsearch/"/>
    
    
      <category term="elasticsearch" scheme="https://www.xxlaila.cn/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>traefik支持socketio会话</title>
    <link href="https://www.xxlaila.cn/2020/02/17/traefik%E6%94%AF%E6%8C%81socketio%E4%BC%9A%E8%AF%9D/"/>
    <id>https://www.xxlaila.cn/2020/02/17/traefik支持socketio会话/</id>
    <published>2020-02-17T10:48:57.000Z</published>
    <updated>2020-02-17T11:09:56.889Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;公司业务出现使用一个使用websocket的会话需求，和常见的web聊天工具一样，如网页QQ。<a id="more"></a>但是在研发在开发的时候没有做session会话的粘制，于是乎就是能在运维层面进行设置。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>socket.io</code>单节点模式是很容易部署的，但是往往在生产环境一个节点不能满足业务需求，况且还要保证节点挂掉的情况仍能正常提供服务，所以多节点模式就成为了生成环境的一种必须的部署模式。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将介绍如何在kubernetes 集群上部署多节点的socket.io服务，并使用traeifk 2.1 版本如何进行访问</p><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在普通环境下，我们配置websocket会话使用nginx很简单，配置一个ip_hash，其他的和普通的location配置差不多，但在kubernetes集群下，生产环境一般部署多个POD 来提供服务，而socket.io服务并不是单纯的无状态应用，只需要将POD 部署成多个就可以正常提供服务了，因为其底层需要建立很多连接来保持长连接，但是这样的话上一个请求可能会被路由到一个POD，下一个请求则很有可能会被路由到另外一个POD 中去了，这样就会出现错误。<br><img src="https://img.xxlaila.cn/1581937028934.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上图中可以看出是有的请求找不到对应的Session ID，也证明了上面提到的引起错误的原因。</p><h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从<a href="https://socket.io/docs/using-multiple-nodes/" target="_blank" rel="noopener">socket.io 官方文档</a>中可以看到对于多节点的介绍，其中通过Nginx的ip_hash 配置用得比较多，同一个ip 访问的请求通过hash 计算过后会被路由到相同的后端程序去，这样就不会出现上面的问题了。我们这里是部署在kubernetes集群上面的，通过traefik ingress来连接外部和集群内部间的请求的，所以这里中间就省略了Nginx这一层，当然你也可以多加上这一层，但是这样显然从架构上就冗余了，而且还有更好的解决方案的：sessionAffinity（也称会话亲和力）</p><blockquote><p>什么是sessionAffinity？ sessionAffinity是一个功能，将来自同一个客户端的请求总是被路由回服务器集群中的同一台服务器的能力。</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在kubernetes中启用sessionAffinity很简单，只需要简单的Service中配置即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.spec.sessionAffinity = <span class="string">"ClientIP"</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;默认情况下sessionAffinity=None，会随机选择一个后端进行路由转发的，设置成ClientIP后就和上面的ip_hash功能一样了，由于我们使用的是traefik ingress，这里还需要在Service中添加一个traefik的annotation：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: socket-demo</span><br><span class="line">  namespace: kube-apps</span><br><span class="line">  annotations:</span><br><span class="line">    traefik.backend.loadbalancer.stickiness: <span class="string">"true"</span></span><br><span class="line">    traefik.backend.loadbalancer.stickiness.cookieName: <span class="string">"socket"</span></span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: socket-demo</span><br><span class="line">spec:</span><br><span class="line">  sessionAffinity: <span class="string">"ClientIP"</span></span><br><span class="line">  ports:</span><br><span class="line">    - name: socketio</span><br><span class="line">      port: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: 3000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: socket-demo</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在traefik 的路径下面建立一个socket.toml文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[http]</span><br><span class="line">  [http.routers]</span><br><span class="line">    [http.routers.socketio]</span><br><span class="line">      namespace = <span class="string">"kube-ops"</span></span><br><span class="line">      entryPoints = [<span class="string">"web"</span>]</span><br><span class="line">      service = <span class="string">"socket-demo"</span></span><br><span class="line">      rule = <span class="string">"Host(`socket-demo.xxlaila.cn`)"</span></span><br><span class="line">  [http.services]</span><br><span class="line">    [http.services.socket-demo]</span><br><span class="line">      [http.services.socket-demo.loadBalancer]</span><br><span class="line">      passHostHeader = <span class="literal">true</span></span><br><span class="line">      [[http.services.socket-demo.loadBalancer.servers]]</span><br><span class="line">        url = <span class="string">"http://socket-demo.kube-ops.svc.cluster.local:80"</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;完成以后可以执行测试，打印出来的hostname是一样的，因为使用的所有的访问都来自一个ip地址。</p><p>部署在kubernetes集群上的yaml文件如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: socket-demo</span><br><span class="line">  namespace: kube-apps</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: socket-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: socket-demo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - image: cnych/socketdemo:k8s</span><br><span class="line">          imagePullPolicy: Always</span><br><span class="line">          name: socketdemo</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 3000</span><br><span class="line">              protocol: TCP</span><br><span class="line">          resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 100Mi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 50m</span><br><span class="line">              memory: 50Mi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: socket-demo</span><br><span class="line">  namespace: kube-apps</span><br><span class="line">  annotations:</span><br><span class="line">    traefik.backend.loadbalancer.stickiness: <span class="string">"true"</span></span><br><span class="line">    traefik.backend.loadbalancer.stickiness.cookieName: <span class="string">"socket"</span></span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: socket-demo</span><br><span class="line">spec:</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  ports:</span><br><span class="line">    - name: socketio</span><br><span class="line">      port: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: 3000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: socket-demo</span><br></pre></td></tr></table></figure><blockquote><p>参考文献:<br><a href="https://www.qikqiak.com/post/socketio-multiple-nodes-in-kubernetes/" target="_blank" rel="noopener">https://www.qikqiak.com/post/socketio-multiple-nodes-in-kubernetes/</a><br><a href="https://docs.traefik.cn/toml#configuration-backends" target="_blank" rel="noopener">https://docs.traefik.cn/toml#configuration-backends</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;场景&quot;&gt;&lt;a href=&quot;#场景&quot; class=&quot;headerlink&quot; title=&quot;场景&quot;&gt;&lt;/a&gt;场景&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;公司业务出现使用一个使用websocket的会话需求，和常见的web聊天工具一样，如网页QQ。
    
    </summary>
    
      <category term="traefik" scheme="https://www.xxlaila.cn/categories/traefik/"/>
    
    
      <category term="socketio" scheme="https://www.xxlaila.cn/tags/socketio/"/>
    
  </entry>
  
  <entry>
    <title>白话Kubernetes基础概念</title>
    <link href="https://www.xxlaila.cn/2020/02/17/%E7%99%BD%E8%AF%9DKubernetes%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"/>
    <id>https://www.xxlaila.cn/2020/02/17/白话Kubernetes基础概念/</id>
    <published>2020-02-17T07:58:00.000Z</published>
    <updated>2020-03-01T03:37:40.869Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h2 id="Kubernetes-简介"><a href="#Kubernetes-简介" class="headerlink" title="Kubernetes 简介"></a>Kubernetes 简介</h2><p>微服务框架的流行，使得服务越来越精细化，服务也变的越来越多，对于发布和管理而言产生了巨大的挑战，而 <code>Docker</code> 的诞生，给与微服务的资源治理和控制提供了很好的基础。<a id="more"></a>容器化可以解决各个不同语言环境部署、移植性高、跨平台部署等。但是 <code>Docker</code> 对于容器服务的编排没有那么方便，因为 <code>Docker</code> 这方面不足，而诞生 <code>Kubernetes</code>，<code>Kubernetes</code> 是一个可移植的、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。</p><h2 id="使用-Kubernetes-带来那些方便"><a href="#使用-Kubernetes-带来那些方便" class="headerlink" title="使用 Kubernetes 带来那些方便"></a>使用 Kubernetes 带来那些方便</h2><ul><li>快速部署应用</li><li>很容易实现 水平伸缩 或 垂直伸缩</li><li>无缝发布新的应用版本</li><li>资源使用最大化</li><li>应用停止自动重启</li></ul><h2 id="Kubernetes-特点"><a href="#Kubernetes-特点" class="headerlink" title="Kubernetes 特点"></a>Kubernetes 特点</h2><ul><li>可移植：支持公有云、私有云、混合云、多重云（multi-cloud）</li><li>可扩展：模块化、插件化、可挂载、可组合</li><li>自动化：自动部署、自动重启、自动复制、自动伸缩/扩展</li></ul><h2 id="为什么需要-Kubernetes，它能做什么"><a href="#为什么需要-Kubernetes，它能做什么" class="headerlink" title="为什么需要 Kubernetes，它能做什么?"></a>为什么需要 Kubernetes，它能做什么?</h2><p>容器是打包和运行应用程序的好方式。在生产环境中，您需要管理运行应用程序的容器，并确保不会停机。例如，如果一个容器发生故障，则需要启动另一个容器。如果系统处理此行为，会不会更容易？</p><p>这就是 Kubernetes 的救援方法！Kubernetes 为您提供了一个可弹性运行分布式系统的框架。Kubernetes 会满足您的扩展要求、故障转移、部署模式等。</p><p>Kubernetes 为您提供：</p><ul><li><p><code>服务发现和负载均衡</code>：Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果到容器的流量很大，Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</p></li><li><p><code>存储编排</code>：Kubernetes 允许您自动挂载您选择的存储系统，例如本地存储、公共云提供商等。</p></li><li><p><code>自动部署和回滚</code>：您可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态更改为所需状态。例如，您可以自动化 Kubernetes 来为您的部署创建新容器，删除现有容器并将它们的所有资源用于新容器。</p></li><li><p><code>容器资源配额</code>：Kubernetes 允许您指定每个容器所需 CPU 和内存（RAM）。当容器指定了资源请求时，Kubernetes 可以做出更好的决策来管理容器的资源。</p></li><li><p><code>自我修复</code>：Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的运行状况检查的容器，并且在准备好服务之前不将其通告给客户端。</p></li><li><p><code>密钥与配置管理</code>：Kubernetes 允许您存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。您可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</p></li><li><p><code>配置文件</code>：Kubernetes 可以通过 ConfigMap 来存储配置。</p></li></ul><h2 id="Kubernetes-基础资源定义和理解"><a href="#Kubernetes-基础资源定义和理解" class="headerlink" title="Kubernetes 基础资源定义和理解"></a>Kubernetes 基础资源定义和理解</h2><p>一切皆为资源，一切即可描述，一切皆可管理。</p><h3 id="NameSpaces"><a href="#NameSpaces" class="headerlink" title="NameSpaces"></a>NameSpaces</h3><p>命名空间，在一个 Kubernetes 集群中可以使用namespace创建多个“虚拟集群”，这些namespace之间可以完全隔离，也可以通过某种方式，让一个namespace中的service可以访问到其他的namespace中的服务。</p><h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deployment 为 Pod 和 ReplicaSet 提供了一个声明式定义(declarative)方法，用来替代以前的 <code>ReplicationController</code> 来方便的管理应用。典型的应用场景包括：</p><ul><li>定义Deployment来创建Pod和ReplicaSet</li><li>滚动升级和回滚应用</li><li>扩容和缩容</li><li>暂停和继续Deployment</li></ul><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>Kubernetes Service 定义了这样一种抽象：一个 Pod 的逻辑分组，一种可以访问它们的策略 —— 通常称为<code>微服务</code>。 这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector实现的。</p><h3 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h3><p>Ingress 是从 Kubernetes集群外部访问集群内部服务的入口。比如官方维护的 <code>Ingress Nginx</code>。<code>ingress traefik</code>、<code>ingress haproxy</code>等。</p><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>Pod 是 kubernetes 中你可以创建和部署的最小也是最简的单位。Pod代表着集群中运行的进程。</p><p>Pod中封装着应用的容器（有的情况下是好几个容器），存储、独立的网络IP，管理容器如何运行的策略选项。Pod代表着部署的一个单位：kubernetes中应用的一个实例，可能由一个或者多个容器组合在一起共享资源。</p><h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><p>ConfigMap API 资源用来保存 key-value pair配置数据，这个数据可以在pods里使用，或者被用来为像controller一样的系统组件存储配置数据。虽然 ConfigMap 跟 Secrets 类似，但是ConfigMap更方便的处理不含敏感信息的字符串。 注意：ConfigMaps不是属性配置文件的替代品。ConfigMaps只是作为多个properties文件的引用。你可以把它理解为Linux系统中的/etc目录，专门用来存储配置文件的目录。</p><h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><p>Secret 解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。Secret 可以以Volume或者环境变量的方式使用。</p><p>Secret有三种类型：</p><ul><li><code>Service Account</code> ：用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中；</li><li><code>Opaque</code> ：base64编码格式的Secret，用来存储密码、密钥等；</li><li><code>kubernetes.io/dockerconfigjson</code> ：用来存储私有docker registry的认证信息。</li></ul><h3 id="PV-和-PVC"><a href="#PV-和-PVC" class="headerlink" title="PV 和 PVC"></a>PV 和 PVC</h3><p>用于数据持续存储，Pod中，容器销毁，所有数据都会被销毁，如果需要保留数据，这里就需要用到 PV存储卷，PVC存储卷申明。</p><p>PVC 常用于 Deployment 做数据持久存储。实现持久化存储还需要理解 Volume 概念。</p><h3 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h3><p>容器磁盘上的文件的生命周期是短暂的，这就使得在容器中运行重要应用时会出现一些问题。首先，当容器崩溃时，kubelet 会重启它，但是容器中的文件将丢失——容器以干净的状态（镜像最初的状态）重新启动。其次，在 Pod 中同时运行多个容器时，这些容器之间通常需要共享文件。Kubernetes 中的 Volume 抽象就很好的解决了这些问题。</p><h3 id="Labels-和-Selectors"><a href="#Labels-和-Selectors" class="headerlink" title="Labels 和 Selectors"></a>Labels 和 Selectors</h3><p><code>标签</code> 和 <code>选择器</code>。作用用于给每个容器打标签，然后各个控制器通过 Selector 匹配容器，并管理。比如 Deployment 或 Service 都是通过这种方式匹配相应的 Pod。</p><h2 id="自述"><a href="#自述" class="headerlink" title="自述"></a>自述</h2><p>以上只是介绍 Kubernetes 几种常用的资源概念和作用，具体介绍可以查阅<a href="https://kubernetes.io/docs/home/" target="_blank" rel="noopener">Kubernetes 官方文档</a>。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://kubernetes.io/docs/home/" target="_blank" rel="noopener">https://kubernetes.io/docs/home/</a></li><li><a href="https://jimmysong.io/kubernetes-handbook" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook</a></li><li><a href="https://www.jianshu.com/p/b5b9041e8d7b" target="_blank" rel="noopener">https://www.jianshu.com/p/b5b9041e8d7b</a></li></ul><blockquote><ul><li>来源: 微信群分享</li><li>原文: <a href="https://www.yp14.cn/2020/01/04/%E7%99%BD%E8%AF%9D-Kubernetes-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" target="_blank" rel="noopener">yp14</a></li><li>版权: 本文版权归原作者所有</li></ul></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h2 id=&quot;Kubernetes-简介&quot;&gt;&lt;a href=&quot;#Kubernetes-简介&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes 简介&quot;&gt;&lt;/a&gt;Kubernetes 简介&lt;/h2&gt;&lt;p&gt;微服务框架的流行，使得服务越来越精细化，服务也变的越来越多，对于发布和管理而言产生了巨大的挑战，而 &lt;code&gt;Docker&lt;/code&gt; 的诞生，给与微服务的资源治理和控制提供了很好的基础。
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>如何实现应用在Kubernetes上的优雅落地</title>
    <link href="https://www.xxlaila.cn/2020/02/17/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%BA%94%E7%94%A8%E5%9C%A8Kubernetes%E4%B8%8A%E7%9A%84%E4%BC%98%E9%9B%85%E8%90%BD%E5%9C%B0/"/>
    <id>https://www.xxlaila.cn/2020/02/17/如何实现应用在Kubernetes上的优雅落地/</id>
    <published>2020-02-17T07:31:30.000Z</published>
    <updated>2020-03-01T03:37:53.004Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="Kubernetes-热度"><a href="#Kubernetes-热度" class="headerlink" title="Kubernetes 热度"></a>Kubernetes 热度</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;国内外对 Kubernetes 这波潮流的追捧，包括各大云厂商：蚂蚁金服、京东、美团、滴滴等各大公司都把 Kubernetes 作为自己的基础设施的重心。<a id="more"></a>“一万个人眼中就有一万个哈姆雷特”，虽说 Kubernetes 是容器管理领域的事实标准，但实际上在不同背景的企业 Kubernetes 的落地方式上是存在差异的。大致可分为三类：</p><ul><li>一类是完全在 Kubernetes 之上（Above）以其原生方式部署和应用，这类用户大部分是一些初创企业，没有过多的技术栈负担，并且主要集中在使用公有云的 Kubernetes 方案和服务；</li><li>一类是基于 Kubernetes（On）构建的容器管理平台，复用了 Kubernetes 的一些概念但是并没有把应用的管理交给 Kubernetes 来管理，保持着旧的服务治理方式。这类企业发展时间比较久，技术负担比较重，无法立即切换到云原生的服务治理方式，一时无法抛弃多年的技术积累，这类用户主要集中在一些中型或大型的私有云的 Kubernetes 使用场景；</li><li>另一类是基于 Kubernetes 的设计理念（In）通过自定义应用负载来解决和适应本地化的应用管理需求，将本地化的负载和管理融入到原生的 Kubernetes 架构中。这也是目前应用管理的一个趋势，既能吃到云原生和社区 Kubernetes 的红利，又能更好地将多年的技术积累发展演进融入其中，这是一种拥抱云原生的一种绝佳的道路。</li></ul><h3 id="基础”斧”：Above-Kubernetes"><a href="#基础”斧”：Above-Kubernetes" class="headerlink" title="基础”斧”：Above Kubernetes"></a>基础”斧”：Above Kubernetes</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果现在让你选择一个容器管理平台，相信应该没人会错过 Kubernetes。尤其对于没有任何技术负担的用户，选择 Kubernetes 无疑是最明智的一个选择。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Above Kubernetes，这种落地方式很好理解，就是你把原生的、标准的、无任何接触和侵入改动的社区版本的 Kubernetes 拿来，直接部署运行起来即可。完全在 Kubernetes 之上构建自己的应用，通过标准的 Kubernetes API 来访问集群。你可以完全跟着社区升级演进你的 Kubernetes，保持与社区同步，完全借助于社区的力量维护你的 Kubernetes。这种落地方式无疑是最理想的，你不必考虑与社区和业界的主流脱离，同时也降低了管理和运维的成本。<br><img src="https://img.xxlaila.cn/640.webp" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如上图，你可以安装标准的主流的云原生体系来落地 Kubernetes，可以拥抱社区的一整套完整的架构方案，并且足以满足你的需求。</p><h3 id="高阶”斧”：On-Kubernetes"><a href="#高阶”斧”：On-Kubernetes" class="headerlink" title="高阶”斧”：On Kubernetes"></a>高阶”斧”：On Kubernetes</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;能够使用原生的 Kubernetes 集群诚然非常好，但是有些场景并不一定走得通。大家都知道，Kubernetes 的概念和设计其实是很超前的。谷歌的软件开发和应用部署理念虽然好，但业界大部分的企业还是陈旧的技术理念和更复杂的场景。对于一些有技术积淀的企业用户而言，想要一下子抛弃当前的应用管理和部署方式改为原生的 Kubernetes 的应用部署和管理方式，确实有些吃不消。那对于这些用户而言，肯定不能看着别人吃肉自己啃窝窝头。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On Kubernetes 的落地形态其实是一种妥协和中间过程，一方面很难一下子抛弃已有的基础设施，例如：服务治理、监控、网络拓扑等等。只能在原生的 Kubernetes 基础上做一些本地化改造使得 Kubernetes 能够满足当前的应用管理方式，例如：抛弃 Kube-Proxy 使用扁平化的内网环境、通过富容器的方式包装一些监控和代理组件等等。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种落地方式一方面能够做少量改动就吃到这波技术红利，一方面可以探索属于自己的云原生的道路。内部技术栈也可以朝着云原生的方向发展演进，不至于在这波潮流中落后太多，而且可以根据自己的场景做定制化的 Kubernetes 开发，甚至比社区的 Kubernetes 走的更远或者解决一些社区没有解决的问题。有得必有失，虽然可以在借助于 Kubernetes 的设计理念和管理能力，但是同时由于本地化的改造不能完全与社区版本的 Kubernetes 兼容。升级就会比较麻烦，每次升级不得不重新打 Patch，还会出现同时维护多个 Kubernetes 版本的窘境。这无疑会给开发和运维带来很多麻烦，所以这也不是一般的小公司能够走得通的道路。需要一定的研发和技术能力，比较典型的是美团点评的 HULK 2.0、京东的 JDOS 2.0 以及阿里巴巴的 Sigma。<br><img src="https://img.xxlaila.cn/641.webp" alt="img"></p><center>美团点评 HULK 2.0</center><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在这种高阶的玩法中，没有标准的套路，只有符合自己的方案。例如：美团点评结合自己已有的设施在 Kubernetes 以上构建了 HULK 2.0 系统，在存储、网络、负载生命周期管理以及应用监控等方面做了本地化改造，但是仍然保持对 Kubernetes API 的完全兼容。你可以根据自有的基础设施，例如存储、监控、链路追踪、服务发布以及网络等等一系列组件融合，甚至根据业务场景和自身需求对 Kubernetes 做深度的定制化，例如：网易云基于 Kubernetes 的深度定制化实践。</p><h3 id="绝杀”斧”：In-Kubernetes"><a href="#绝杀”斧”：In-Kubernetes" class="headerlink" title="绝杀”斧”：In Kubernetes"></a>绝杀”斧”：In Kubernetes</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;云原生这一说法在技术圈已经广为流传，甚至一些同学并不理解什么是云原生，但都知道要朝着云原生的方向发展演进。不管怎样，对于用户而言改变以往虚拟机的部署和管理方式以及服务的治理策略是必要的。不得不说，All in Kubernetes 是一个趋势，CRD 自 Kubernetes 1.7 版本产生到上周发布的 1.16 版本的 GA，也就是说我们完全有了可以在生产环境扩展 Kubernetes 的能力。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;大家如果深入了解 Kubernetes 会发现，Kubernetes 本身就是一个平台。Kubernetes 除了提供了很多的功能，例如：它可以简化应用程序的工作流、加快开发速度、用户可以使用 Label 以自己的方式组织管理资源。还可以使用 Annotation 来自定义资源的描述信息，比如：为管理工具提供状态检查等。此外，Kubernetes 控制器也是构建在跟开发人员和用户使用的相同的 API 之上。用户还可以编写自己的控制器和调度器，也可以通过各种插件机制扩展系统的功能。这就是说，我们完全可以在 Kubernetes 里面通过扩展 API 和负载类型完成任何形式和类型的应用负载和管理方法。即使你有复杂的技术栈不可摆脱或者说有复杂的工作流，没问题，你可以根据自己的需要在资源和应用生命周期注入任何外部依赖和逻辑。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种落地方式其实是借助于 Kubernetes 提供的扩展机制，完全将本地化、复杂化的逻辑转化为 Kubernetes 的设计和管理理念。不仅仅是使用 Kubernetes，而是融入和弱化原生 Kubernetes，最终每个用户都有着自己的一套独一无二的 Kubernetes。你中有我，我中有你。此外，它仍然完全和原生的 Kubernetes 兼容，可以优雅地升级和合并社区的 Patch 等等。比较有代表性的是阿里开源的 Openkruise 项目。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用户使用 Kubernetes 核心是对工作负载的管理，其实选择 On Kubernetes 的一个很大原因是用户当前的工作负载管理方式与 Kubernetes 的已有工作负载类型不能很好地匹配。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CRD 和 Operator 很好地解决了这个问题，让用户可以定制自己的负载。OpenKruise 项目就是这样一个典型的例子， 它是一组控制器，可扩展和补充 Kubernetes 核心控制器的工作负载管理。例如：它提供三种工作负载控制器：</p><ul><li><p>高级 StatefulSet：默认 StatefulSet 的增强版本，具有额外的功能，例如 inplace-update，pasue 和 MaxUnavailable。<br><img src="https://img.xxlaila.cn/642.webp" alt="img"></p></li><li><p>BroadcastJob：在集群中的所有节点上运行 Pod 以完成的作业。<br><img src="https://img.xxlaila.cn/643.webp" alt="img"></p></li><li><p>SidecarSet：一个控制器，它根据选择器将边车容器注入 Pod 规范，并且能够升级边车容器。<br><img src="https://img.xxlaila.cn/644.webp" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;理想的情况下，任何负载都可以做到 All in Kubernetes。甚至 Kubernetes 本身的负载管理，即 Kube-on-Kube。以及对于有状态服务的管理，例如：MySQL 集群 Operator 等等，你可以在 operatorhub 找到一些非常经典的例子。<br><img src="https://img.xxlaila.cn/645.webp" alt="img"></p></li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;虽说不同的落地方式互有差异，但其实都是不同背景下的最好选择，它们都可以做到完全兼容 Kubernetes 的 API，脱离了问题本身，都不能说哪种方式最好。</p><ul><li><p>Above Kubernetes：如果你是一家初创公司，只想使用 Kubernetes 满足正常的容器管理或者服务部署，没有什么负担，同时人力也不足，没有能力自己维护 Kubernetes</p></li><li><p>On Kubernetes：如果你是一家中型甚至大型公司，有着大量的技术积累和设施，并且有能力和人力改造和开发 Kubernetes 或者原生的 Kubernetes 并不能满足你的需求</p></li><li><p>In Kubernetes：你不满足于单纯使用 Kubernetes 或者说原生的 Kubernetes 不能满足你的需求，你可以从 Above Kubernetes 转变而来；当然，如果痛定思痛，或者想彻底地改造当前的基础设施和应用管理方式，想更加靠近云原生的道路或者想要升级陈旧的机器部署和交付模式，你可以从 On Kubernetes 转变而来，最终 All in Kubernetes！</p></li></ul><blockquote><ul><li>来源：知乎</li><li>原文：<a href="https://url.cn/5lyaniK" target="_blank" rel="noopener">https://url.cn/5lyaniK</a></li><li>版权：本文版权归原作者所有</li></ul></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;Kubernetes-热度&quot;&gt;&lt;a href=&quot;#Kubernetes-热度&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes 热度&quot;&gt;&lt;/a&gt;Kubernetes 热度&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;国内外对 Kubernetes 这波潮流的追捧，包括各大云厂商：蚂蚁金服、京东、美团、滴滴等各大公司都把 Kubernetes 作为自己的基础设施的重心。
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://www.xxlaila.cn/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>traefik2.0-动态配置</title>
    <link href="https://www.xxlaila.cn/2020/01/13/traefik2-0-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE/"/>
    <id>https://www.xxlaila.cn/2020/01/13/traefik2-0-动态配置/</id>
    <published>2020-01-13T09:39:36.000Z</published>
    <updated>2020-01-20T03:51:50.649Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;之前在traefik部署的时候做了traefik 2.0 的动态安装和动态配置加载<a id="more"></a>，本次来结合实际的场景进行配置测试，测试主要几个功能: 灰度发布、流量复制、ssl证书加载、tcp配置、中间件。<a href="https://www.xxlaila.cn/2020/01/09/traefik%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/">yaml配置参考</a>，本次主要是以toml格式进行配置文件的配置加载</p><h4 id="灰度发布"><a href="#灰度发布" class="headerlink" title="灰度发布"></a>灰度发布</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;灰度发布参部分考traefik2.0部署<a href="https://www.xxlaila.cn/2020/01/08/traefik2-0%E9%83%A8%E7%BD%B2/">动态配置加载</a>，最后部分。也可以按照下列写法，效果一致。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;canary.toml &lt;&lt;EOF</span></span><br><span class="line">[http]</span><br><span class="line">  [http.routers]</span><br><span class="line">    [http.routers.Router-canary]</span><br><span class="line">      namespace = <span class="string">"default"</span></span><br><span class="line">      entryPoints = [<span class="string">"web"</span>]</span><br><span class="line">      service = <span class="string">"nginx-canary"</span></span><br><span class="line">      rule = <span class="string">"Host(`wrr.xxlaila.cn`)"</span></span><br><span class="line"></span><br><span class="line">  [http.services]</span><br><span class="line">    [http.services.nginx-canary]</span><br><span class="line">      [http.services.nginx-canary.weighted]</span><br><span class="line">        [[http.services.nginx-canary.weighted.services]]</span><br><span class="line">          name = <span class="string">"appv1"</span></span><br><span class="line">          weight = 3</span><br><span class="line">        [[http.services.nginx-canary.weighted.services]]</span><br><span class="line">          name = <span class="string">"appv2"</span></span><br><span class="line">          weight = 2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1579491439096.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里的name指的是服务的名称，在浏览器打开进行测试，然后观察日志。</p><h4 id="流量复制"><a href="#流量复制" class="headerlink" title="流量复制"></a>流量复制</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;流量复制<a href="https://www.xxlaila.cn/2020/01/09/traefik%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/">yaml格式参考</a>，在node节点的conf目录下面新建一个mirr.toml文件。</p><ul><li>mirr.toml<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt; mirr.toml&lt;&lt;EOF</span></span><br><span class="line">[http]</span><br><span class="line">  [http.routers]</span><br><span class="line">    [http.routers.Router-nginx]</span><br><span class="line">      namespace = <span class="string">"default"</span></span><br><span class="line">      entryPoints = [<span class="string">"web"</span>]</span><br><span class="line">      service = <span class="string">"nginx-mirr"</span></span><br><span class="line">      rule = <span class="string">"Host(`mirror.xxlaila.cn`)"</span></span><br><span class="line"></span><br><span class="line">  [http.services]</span><br><span class="line">    [http.services.nginx-mirr]</span><br><span class="line">      [http.services.nginx-mirr.mirroring]</span><br><span class="line">        service = <span class="string">"app"</span></span><br><span class="line">        [[http.services.nginx-mirr.mirroring.mirrors]]</span><br><span class="line">          name = <span class="string">"appv1-nginx"</span></span><br><span class="line"></span><br><span class="line">        [[http.services.nginx-mirr.mirroring.mirrors]]</span><br><span class="line">          name = <span class="string">"appv2-nginx"</span></span><br><span class="line">          percent = 50</span><br><span class="line"></span><br><span class="line">    [http.services.appv1-nginx]</span><br><span class="line">      [http.services.appv1-nginx.loadBalancer]</span><br><span class="line">        [[http.services.appv1-nginx.loadBalancer.servers]]</span><br><span class="line">          url = <span class="string">"http://appv1/"</span></span><br><span class="line"></span><br><span class="line">    [http.services.appv2-nginx]</span><br><span class="line">      [http.services.appv2-nginx.loadBalancer]</span><br><span class="line">        [[http.services.appv2-nginx.loadBalancer.servers]]</span><br><span class="line">          url = <span class="string">"http://appv2/"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>url=http://appv1 和 url=http://appv2</code>可以以完成的域名写入<code>http://appv1.default.svc.cluster.local:80/</code>，保存退出以后可以在traefik 的dashboard界面看到，在浏览器输入域名进行访问测试<br><img src="https://img.xxlaila.cn/1579171592771.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1579171717285.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1579171755921.jpg" alt="img"></p><h3 id="ssl证书加载"><a href="#ssl证书加载" class="headerlink" title="ssl证书加载"></a>ssl证书加载</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;新起一个ssl.toml的文件用于证书的加载，吧配置文件进行分开，利于维护和错误时影响范围缩小。拷贝证书到node节点/opt/traefik/certs。</p><h4 id="单证书加载"><a href="#单证书加载" class="headerlink" title="单证书加载"></a>单证书加载</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;ssl.toml &lt;&lt;EOF</span></span><br><span class="line">[tls]</span><br><span class="line"></span><br><span class="line">  [[tls.certificates]]</span><br><span class="line">    certFile = <span class="string">"/config/certs/xxlaila.cn.crt"</span></span><br><span class="line">    keyFile = <span class="string">"/config/certs/xxlaila.cn.key"</span></span><br><span class="line">    stores = [<span class="string">"default"</span>]</span><br><span class="line"></span><br><span class="line">  [tls.stores]</span><br><span class="line">    [tls.stores.default]</span><br><span class="line">      [tls.stores.default.defaultCertificate]</span><br><span class="line">        certFile = <span class="string">"/config/certs/xxlaila.cn.crt"</span></span><br><span class="line">        keyFile = <span class="string">"/config/certs/xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line">  [tls.options]</span><br><span class="line">    [tls.options.default]</span><br><span class="line">      minVersion = <span class="string">"VersionTLS12"</span></span><br><span class="line">    [tls.options.mintls13]</span><br><span class="line">      minVersion = <span class="string">"VersionTLS13"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="多证书加载"><a href="#多证书加载" class="headerlink" title="多证书加载"></a>多证书加载</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;ssl.toml &lt;&lt;EOF</span></span><br><span class="line">[tls]</span><br><span class="line"></span><br><span class="line">  [[tls.certificates]]</span><br><span class="line">    certFile = <span class="string">"/config/certs/test.xxlaila.cn.crt"</span></span><br><span class="line">    keyFile = <span class="string">"/config/certs/test.xxlaila.cn.key"</span></span><br><span class="line">    stores = [<span class="string">"default"</span>]</span><br><span class="line">  [[tls.certificates]]</span><br><span class="line">    certFile = <span class="string">"/config/certs/dev.xxlaila.cn.crt"</span></span><br><span class="line">    keyFile = <span class="string">"/config/certs/dev.xxlaila.cn.key"</span></span><br><span class="line">    stores = [<span class="string">"kxldev"</span>]</span><br><span class="line"></span><br><span class="line">  [tls.stores]</span><br><span class="line">    [tls.stores.default]</span><br><span class="line">      [tls.stores.default.defaultCertificate]</span><br><span class="line">        certFile = <span class="string">"/config/certs/test.xxlaila.cn.crt"</span></span><br><span class="line">        keyFile = <span class="string">"/config/certs/test.xxlaila.cn.key"</span></span><br><span class="line">    [tls.stores.kxldev]</span><br><span class="line">      [tls.stores.kxldev.defaultCertificate]</span><br><span class="line">        certFile = <span class="string">"/config/certs/dev.xxlaila.cn.crt"</span></span><br><span class="line">        keyFile = <span class="string">"/config/certs/dev.xxlaila.cn.key"</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  [tls.options]</span><br><span class="line">    [tls.options.default]</span><br><span class="line">      minVersion = <span class="string">"VersionTLS12"</span></span><br><span class="line">    [tls.options.mintls13]</span><br><span class="line">      minVersion = <span class="string">"VersionTLS13"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里遇到一个问题，自己生成的证书，没办法加载，但是公司购买的证书，可以自动识别，不知道为啥。<a href="https://godoc.org/crypto/tls#pkg-constants" target="_blank" rel="noopener">cipherSuites</a>。</p><h3 id="tcp配置"><a href="#tcp配置" class="headerlink" title="tcp配置"></a>tcp配置</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于tcp 的路由是基于sni，之前参考一些文档，说的是traefik 2.0 版本的sni需要tls证书，但在2.1试用的时候，没有使用证书，而且支持域名。<a href="https://www.xxlaila.cn/2020/01/09/traefik%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/">参考tcp支持</a>，下面是测试代理redis服务和mongo数据库服务。</p><h4 id="redis-服务"><a href="#redis-服务" class="headerlink" title="redis 服务"></a>redis 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;redis_tcp.toml &lt;&lt;EOF</span></span><br><span class="line">[tcp]</span><br><span class="line">  [tcp.routers]</span><br><span class="line">    [tcp.routers.redis]</span><br><span class="line">      namespace = <span class="string">"kube-ops"</span></span><br><span class="line">      entryPoints = [<span class="string">"redis"</span>]</span><br><span class="line">      service = <span class="string">"redis"</span></span><br><span class="line">      rule = <span class="string">"HostSNI(`*`)"</span></span><br><span class="line"></span><br><span class="line">  [tcp.services]</span><br><span class="line">    [tcp.services.redis.loadBalancer]</span><br><span class="line">      [[tcp.services.redis.loadBalancer.servers]]</span><br><span class="line">        address = <span class="string">"redis.kube-ops.svc.cluster.local:6379"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="mongo服务"><a href="#mongo服务" class="headerlink" title="mongo服务"></a>mongo服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;mongo_tcp.toml&lt;&lt;EOF</span></span><br><span class="line">[tcp]</span><br><span class="line">  [tcp.routers]</span><br><span class="line">    [tcp.routers.mongo]</span><br><span class="line">      namespace = <span class="string">"default"</span></span><br><span class="line">      entryPoints = [<span class="string">"mongo"</span>]</span><br><span class="line">      service = <span class="string">"mongo"</span></span><br><span class="line">      rule = <span class="string">"HostSNI(`*`)"</span></span><br><span class="line"></span><br><span class="line">  [tcp.services]</span><br><span class="line">    [tcp.services.mongo.loadBalancer]</span><br><span class="line">      [[tcp.services.mongo.loadBalancer.servers]]</span><br><span class="line">        address = <span class="string">"mongo.default.svc.cluster.local:27017"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>测试效果<br><img src="https://img.xxlaila.cn/1579059828086.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1579059869663.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1578990332568.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1579059922027.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是在写toml文件的时候，在<code>HostSNI</code>这里的时候不能使用域名，只能使用*来代替，因为这里需要tls的支持。在<code>address</code>这个参数配置项目的时候可以使用一个完整的域<br>名，该域名是k8s默认的域名，及时服务被重新部署以后，也不会影响地址的链接。只要service保持不变。</p><h3 id="http"><a href="#http" class="headerlink" title="http"></a>http</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;配置一个<code>ll.xxlaila.cn</code>域名代理到后段appv2的服务去。然后配置了一个ip的白名单。强制跳转到https。这里需要用到中间件<code>Middlewares</code>，https强制跳转和ip白名单可以参考下面的中间件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;http_nginx.toml&lt;&lt;EOF</span></span><br><span class="line">[http]</span><br><span class="line">  [http.routers]</span><br><span class="line">    [http.routers.app]</span><br><span class="line">      namespace = <span class="string">"default"</span></span><br><span class="line">      entryPoints = [<span class="string">"web"</span>]</span><br><span class="line">      service = <span class="string">"appv2"</span></span><br><span class="line">      rule = <span class="string">"Host(`ll.xxlaila.cn`)"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>service</code>参数可以是服务名称，直接引用服务名也可以进行访问。在servers项的url里面会直接应用appv2服务的域名路径。<br><img src="https://img.xxlaila.cn/1579231822303.jpg" alt="img"></p><h4 id="跳转https和白名单"><a href="#跳转https和白名单" class="headerlink" title="跳转https和白名单"></a>跳转https和白名单</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里http强制跳转到https，加载白名单，这两种配置是写在<code>Middlewares</code>里面。让其他的来进行加载，<code>Middlewares</code>的写法参考下面章节。而ssl证书文件参考文档上面的ssl章节。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;http_nginx.toml&lt;&lt;EOF</span></span><br><span class="line">[http]</span><br><span class="line">  [http.routers]</span><br><span class="line">    [http.routers.Router0001]</span><br><span class="line">      namespace = <span class="string">"default"</span></span><br><span class="line">      entryPoints = [<span class="string">"web"</span>, <span class="string">"websecure"</span>]</span><br><span class="line">      service = <span class="string">"appv2-zxc"</span></span><br><span class="line">      rule = <span class="string">"Host(`ll.xxlaila.cn`)"</span></span><br><span class="line">      middlewares = [<span class="string">"test-ipwhitelist"</span>, <span class="string">"test-redirectscheme"</span>]</span><br><span class="line">      priority = 42</span><br><span class="line">      [http.routers.Router0001.tls]</span><br><span class="line"></span><br><span class="line">  [http.services]</span><br><span class="line">    [http.services.appv2-zxc]</span><br><span class="line">      [http.services.appv2-zxc.loadBalancer]</span><br><span class="line">      passHostHeader = <span class="literal">true</span></span><br><span class="line">      [[http.services.appv2-zxc.loadBalancer.servers]]</span><br><span class="line">        url = <span class="string">"http://appv2.default.svc.cluster.local:80"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1579251114979.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1579251505095.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1579251546993.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于自己生成的证书不能识别加载，故而使用了公司的证书，加载时可以正常的。以下是两个环境的配置文件，里面包含了ip白名单，https跳转，页面打开认证，header的加载。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;dev_nginx.toml&lt;&lt;EOF</span></span><br><span class="line">[http]</span><br><span class="line">  [http.routers]</span><br><span class="line">    [http.routers.Router0001]</span><br><span class="line">      namespace = <span class="string">"default"</span></span><br><span class="line">      entryPoints = [<span class="string">"web"</span>, <span class="string">"websecure"</span>]</span><br><span class="line">      service = <span class="string">"appv2-zxc"</span></span><br><span class="line">      rule = <span class="string">"Host(`ll.dev.xxlaila`)"</span></span><br><span class="line">      middlewares = [<span class="string">"test-ipwhitelist"</span>, <span class="string">"test-redirectscheme"</span>, <span class="string">"test-auth"</span>, <span class="string">"testHeader"</span>]</span><br><span class="line">      priority = 42</span><br><span class="line">      [http.routers.Router0001.tls]</span><br><span class="line">        options = <span class="string">"default"</span></span><br><span class="line"></span><br><span class="line">  [http.services]</span><br><span class="line">    [http.services.appv2-zxc]</span><br><span class="line">      [http.services.appv2-zxc.loadBalancer]</span><br><span class="line">      passHostHeader = <span class="literal">true</span></span><br><span class="line">      [[http.services.appv2-zxc.loadBalancer.servers]]</span><br><span class="line">        url = <span class="string">"http://appv2.default.svc.cluster.local:80"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;test_nginx.toml&lt;&lt;EOF</span></span><br><span class="line">[http]</span><br><span class="line">  [http.routers]</span><br><span class="line">    [http.routers.Router00010]</span><br><span class="line">      namespace = <span class="string">"default"</span></span><br><span class="line">      entryPoints = [<span class="string">"web"</span>, <span class="string">"websecure"</span>]</span><br><span class="line">      service = <span class="string">"appv1-zxc"</span></span><br><span class="line">      rule = <span class="string">"Host(`ll.test.xxlaila.cn`)"</span></span><br><span class="line">      middlewares = [<span class="string">"test-ipwhitelist"</span>, <span class="string">"test-redirectscheme"</span>, <span class="string">"test-auth"</span>, <span class="string">"testHeader"</span>]</span><br><span class="line">      priority = 42</span><br><span class="line">      [http.routers.Router00010.tls]</span><br><span class="line">        options = <span class="string">"default"</span></span><br><span class="line"></span><br><span class="line">  [http.services]</span><br><span class="line">    [http.services.appv1-zxc]</span><br><span class="line">      [http.services.appv1-zxc.loadBalancer]</span><br><span class="line">      passHostHeader = <span class="literal">true</span></span><br><span class="line">      [[http.services.appv1-zxc.loadBalancer.servers]]</span><br><span class="line">        url = <span class="string">"http://appv1.default.svc.cluster.local:80"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Middlewares针对每一个 router 开启和调整相关特性，Middlewares 是在请求实际转发到服务之前对其进行操作的组件，如果不满足要求的条件，甚至可以决定不转发请求。<br><strong>Traefik附带了一下功能</strong>:</p><ul><li>AddPrefix(给请求添加一个前缀路径)</li><li>BasicAuth</li><li>DigestAuth</li><li>ForwardAuth(委托第三方服务身份验证)</li><li>Buffering</li><li>Chain (定义可重用的Middleware集和)</li><li>CircuitBreaker (断路器，避免调用压垮服务)</li><li>Compress</li><li>Errors(提供自定义的错误页面)</li><li>Headers(头部请求)</li><li>IpWhitelist(白名单)</li><li>MaxConn(限制连接到服务的并发连接数)</li><li>PassTLSClientCert</li><li>RateLimit(在给定时间段内限制对服务的请求数量)</li><li>RedirectRegex</li><li>RedirectScheme</li><li>ReplacePath(在转发到服务之前更新请求路径)</li><li>ReplacePathRegex</li><li>Retry</li><li>StripPrefix</li><li>StripPrefixRegex<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;利用Middlewares来实现前端白名单请求。http强制跳转到https。白名单，页面打开认证，header。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;middlewares.toml &lt;&lt;EOF</span></span><br><span class="line">[http.middlewares]</span><br><span class="line">  [http.middlewares.test-ipwhitelist.ipWhiteList]</span><br><span class="line">    sourceRange = [<span class="string">"172.20.20.0/20"</span>, <span class="string">"172.21.21.0/20"</span>, <span class="string">"172.20.16.22"</span>]</span><br><span class="line"></span><br><span class="line">  [http.middlewares.test-redirectscheme.redirectScheme]</span><br><span class="line">    scheme = <span class="string">"https"</span></span><br><span class="line">    permanent = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  [http.middlewares.test-auth.basicAuth]</span><br><span class="line">    headerField = <span class="string">"X-WebAuth-User"</span></span><br><span class="line">    removeHeader = <span class="literal">true</span></span><br><span class="line">    users = [</span><br><span class="line">      <span class="string">"test:<span class="variable">$apr1</span><span class="variable">$H6uskkkW</span><span class="variable">$IgXLP6ewTrSuBkTrqE8wj</span>/"</span>, </span><br><span class="line">      <span class="string">"test2:<span class="variable">$apr1</span><span class="variable">$d9hr9HBB</span><span class="variable">$4HxwgUir3HP4EsggP</span>/QNo0"</span>,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">  [http.middlewares.testHeader.headers]</span><br><span class="line">    frameDeny = <span class="literal">true</span></span><br><span class="line">    sslRedirect = <span class="literal">true</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;实战&quot;&gt;&lt;a href=&quot;#实战&quot; class=&quot;headerlink&quot; title=&quot;实战&quot;&gt;&lt;/a&gt;实战&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;之前在traefik部署的时候做了traefik 2.0 的动态安装和动态配置加载
    
    </summary>
    
      <category term="Ingress" scheme="https://www.xxlaila.cn/categories/Ingress/"/>
    
    
      <category term="traefik" scheme="https://www.xxlaila.cn/tags/traefik/"/>
    
  </entry>
  
  <entry>
    <title>traefik 2.0 灰度发布</title>
    <link href="https://www.xxlaila.cn/2020/01/09/traefik%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/"/>
    <id>https://www.xxlaila.cn/2020/01/09/traefik灰度发布/</id>
    <published>2020-01-09T08:52:01.000Z</published>
    <updated>2020-01-19T01:16:12.020Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="灰度发布"><a href="#灰度发布" class="headerlink" title="灰度发布"></a>灰度发布</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traefik2.0 的一个更强大的功能就是灰度发布，灰度发布我们有时候也会称为金丝雀发布（Canary），主要就是让一部分测试的服务也参与到线上去，经过测试观察看是否符号上线要求。<a id="more"></a></p><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里部署两个nginx服务，通过 Traefik 来控制流量，将3/5的流量到v1 版本，2/5的流量到v2版本。需要利用Traefik2.0中提供的带权重的轮询(WRR)来实现该功能。</p><h4 id="nginx资源部署"><a href="#nginx资源部署" class="headerlink" title="nginx资源部署"></a>nginx资源部署</h4><ul><li><p>nginx-appv1.yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;nginx-appv1.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: appv1</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: appv1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        use: <span class="built_in">test</span></span><br><span class="line">        app: appv1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        lifecycle:</span><br><span class="line">          postStart:</span><br><span class="line">            <span class="built_in">exec</span>:</span><br><span class="line">              <span class="built_in">command</span>:  [<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"echo Hello v1 &gt; /usr/share/nginx/html/index.html"</span>]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: portv1</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: appv1</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: appv1</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: portv1</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>nginx-appv2.yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt; nginx-appv2.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: appv2</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: appv2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        use: <span class="built_in">test</span></span><br><span class="line">        app: appv2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        lifecycle:</span><br><span class="line">          postStart:</span><br><span class="line">            <span class="built_in">exec</span>:</span><br><span class="line">              <span class="built_in">command</span>:  [<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"echo Hello v2 &gt; /usr/share/nginx/html/index.html"</span>]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: portv2</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: appv2</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: appv2</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: portv2</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="执行创建"><a href="#执行创建" class="headerlink" title="执行创建"></a>执行创建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods -l use=test</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">appv1-6f88c7b898-qx2pc   2/2     Running   0          23h</span><br><span class="line">appv2-558fdbbdb7-6gd8l   2/2     Running   0          23h</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前面在安装traefik的时候在crd里面定义了一个TraefikService的crd资源，直接利用这个对象来配置 WRR。</p><h4 id="新建资源清单"><a href="#新建资源清单" class="headerlink" title="新建资源清单"></a>新建资源清单</h4><ul><li><p>nginx-wrr.yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;nginx-wrr.yaml&lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: TraefikService</span><br><span class="line">metadata:</span><br><span class="line">  name: app-wrr</span><br><span class="line">spec:</span><br><span class="line">  weighted:</span><br><span class="line">    services:</span><br><span class="line">      - name: appv1</span><br><span class="line">        weight: 3</span><br><span class="line">        port: 80</span><br><span class="line">        kind: Service</span><br><span class="line">      - name: appv2</span><br><span class="line">        weight: 2</span><br><span class="line">        port: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>nginx-ingressroute.yaml<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为灰度发布的服务创建一个 IngressRoute 资源对象。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;nginx-ingressroute.yaml&lt;&lt;EOF</span></span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: IngressRoute</span><br><span class="line">metadata:</span><br><span class="line">  name: wrringressroute</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  entryPoints:</span><br><span class="line">    - web</span><br><span class="line">  routes:</span><br><span class="line">  - match: Host(`nginx.xxlaila.cn`)</span><br><span class="line">    kind: Rule</span><br><span class="line">    services:</span><br><span class="line">    - name: app-wrr</span><br><span class="line">      kind: TraefikService</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p><strong>注</strong>:</p><ul><li>weight: 3: 定义权重</li><li>kind: Service: 可选，默认就是 Service</li></ul><ul><li>执行创建<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f nginx-wrr.yam</span></span><br><span class="line"><span class="comment"># kubectl apply -f nginx-ingressroute.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在浏览器访问<code>nginx.xxlaila.cn</code>，这里联系访问了5次，有三次请求到appv1，两次请求到appv2。符合3:2权重配置。</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># kubectl logs -f appv1-6f88c7b898-qx2pc nginx</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1578562105802.jpg" alt="img"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl logs -f appv2-558fdbbdb7-6gd8l nginx</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1578562349387.jpg" alt="img"></p><h3 id="流量复制"><a href="#流量复制" class="headerlink" title="流量复制"></a>流量复制</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traefik 2.0 还引入了流量镜像服务，是一种可以将流入流量复制并同时将其发送给其他服务的方法，镜像服务可以获得给定百分比的请求同时也会忽略这部分请求的响应。在traefik 2.0 中只能通过 FileProvider 进行配置，在 2.1 版本中可以通过 TraefikService 资源对象来进行配置。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;修改前面的nginx-appv2.yaml 为v1版本。创建一个 IngressRoute 对象，将服务v1的流量复制50%到服务v2。</p><ul><li>mirror-ingress-route.yaml<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt; mirror-ingress-route.yaml&lt;&lt;EOF</span></span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: TraefikService</span><br><span class="line">metadata:</span><br><span class="line">  name: app-mirror</span><br><span class="line">spec:</span><br><span class="line">  mirroring:</span><br><span class="line">    name: appv1</span><br><span class="line">    port: 80</span><br><span class="line">    mirrors:</span><br><span class="line">    - name: appv2</span><br><span class="line">      percent: 50</span><br><span class="line">      port: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: IngressRoute</span><br><span class="line">metadata:</span><br><span class="line">  name: mirror-ingress-route</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  entryPoints:</span><br><span class="line">  - web</span><br><span class="line">  routes:   </span><br><span class="line">  - match: Host(`mirror.xxlaila.cn`)</span><br><span class="line">    kind: Rule</span><br><span class="line">    services:</span><br><span class="line">    - name: app-mirror</span><br><span class="line">      kind: TraefikService</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f mirror-ingress-route.yaml</span></span><br><span class="line">ingressroute.traefik.containo.us/mirror-ingress-route created</span><br><span class="line">traefikservice.traefik.containo.us/mirroring-example created</span><br></pre></td></tr></table></figure></li></ul><p><strong>注</strong>:</p><ul><li>mirroring.appv1: 发送 100% 的请求到 K8S 的 Service “v1”</li><li>mirrors.appv2: 然后复制 50% 的请求到 v2</li><li>kind: TraefikService: 使用声明的 TraefikService 服务，而不是 K8S 的 Service</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在浏览器进行测试访问<code>mirror.xxlaila.cn</code>，进行6次访问，会有一半的请求会路由到appv2上来</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl logs -f appv1-6f88c7b898-qx2pc nginx</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1578563771830.jpg" alt="img"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl logs -f appv2-558fdbbdb7-6gd8l nginx</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1578563835542.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在安装traefik的时候引用了tracing.zipkin，当在浏览器访问的时候，可以在tracing的界面观察请求的路径<br><img src="https://img.xxlaila.cn/1578620392679.jpg" alt="img"></p><h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traefik2.0 已经支持了TCP服务的，这里以redis、mongodb为例来测试Traefik是如何支持TCP服务。</p><h4 id="redis-服务"><a href="#redis-服务" class="headerlink" title="redis 服务"></a>redis 服务</h4><ul><li>redis.yaml<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt; redis.yaml&lt;&lt;EOF</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: redis</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: redis</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: redis</span><br><span class="line">        image: redis:4</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6379</span><br><span class="line">          protocol: TCP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: redis</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 6379</span><br><span class="line">    targetPort: 6379</span><br><span class="line">  selector:</span><br><span class="line">    app: redis</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f redis.yaml</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="部署mongo服务"><a href="#部署mongo服务" class="headerlink" title="部署mongo服务"></a>部署mongo服务</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;mongo.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo</span><br><span class="line">  labels:</span><br><span class="line">    app: mongo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mongo</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mongo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: mongo</span><br><span class="line">        image: mongo:4.0</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 27017</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: mongo</span><br><span class="line">  ports:</span><br><span class="line">  - port: 27017</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f mongo.yaml</span></span><br></pre></td></tr></table></figure><h4 id="暴露-TCP-服务"><a href="#暴露-TCP-服务" class="headerlink" title="暴露 TCP 服务"></a>暴露 TCP 服务</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于 Traefik 中使用 TCP 路由配置需要 SNI，而 SNI 又是依赖 TLS 的，所以我们需要配置证书才行，但是如果没有证书的话，我们可以使用通配符 * 进行配置，我们这里创建一个 IngressRouteTCP 类型的 CRD 对象。在之前安装的时候crd文件里面已经加入了对应的crd资源。我在使用traefik 2.1版本的时候写入域名是可以成功的。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat redis-ingressroute-tcp.yaml </span></span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: IngressRouteTCP</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-traefik-tcp</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  entryPoints:</span><br><span class="line">    - redis</span><br><span class="line">  routes:</span><br><span class="line">  - match: HostSNI(`redis.ops.xxlaila.cn`)</span><br><span class="line">    services:</span><br><span class="line">    - name: redis</span><br><span class="line">      port: 6379</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f redis-ingressroute-tcp.yaml</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;mongo-ingressroute-tcp.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: IngressRouteTCP</span><br><span class="line">metadata:</span><br><span class="line">  name: mongo-traefik-tcp</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  entryPoints:</span><br><span class="line">    - mongo</span><br><span class="line">  routes:</span><br><span class="line">  - match: HostSNI(`mongo.ops.xxlaila.cn`)</span><br><span class="line">    services:</span><br><span class="line">    - name: mongo</span><br><span class="line">      port: 27017</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f &gt;mongo-ingressroute-tcp.yaml</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;要注意的是这里的entryPoints部分，是根据我们启动的 Traefik 的静态配置中的 entryPoints 来决定的，比如我们可以自己添加一个用于 Redis 的专门的入口点，在安装的时候已经添加。</p><p><img src="https://img.xxlaila.cn/1578564549279.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1578564836153.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1579059922027.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;灰度发布&quot;&gt;&lt;a href=&quot;#灰度发布&quot; class=&quot;headerlink&quot; title=&quot;灰度发布&quot;&gt;&lt;/a&gt;灰度发布&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Traefik2.0 的一个更强大的功能就是灰度发布，灰度发布我们有时候也会称为金丝雀发布（Canary），主要就是让一部分测试的服务也参与到线上去，经过测试观察看是否符号上线要求。
    
    </summary>
    
      <category term="Ingress" scheme="https://www.xxlaila.cn/categories/Ingress/"/>
    
    
      <category term="traefik" scheme="https://www.xxlaila.cn/tags/traefik/"/>
    
  </entry>
  
  <entry>
    <title>traefik 2.0部署</title>
    <link href="https://www.xxlaila.cn/2020/01/08/traefik2-0%E9%83%A8%E7%BD%B2/"/>
    <id>https://www.xxlaila.cn/2020/01/08/traefik2-0部署/</id>
    <published>2020-01-08T09:52:01.000Z</published>
    <updated>2020-03-05T11:39:54.837Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="认识"><a href="#认识" class="headerlink" title="认识"></a>认识</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traefik2.0 中的配置可以使用两种不同的方式</p><ul><li>动态配置：完全动态的路由配置</li><li>静态配置：启动配置<a id="more"></a></li></ul><h4 id="静态配置"><a href="#静态配置" class="headerlink" title="静态配置"></a>静态配置</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;连接到 providers 并定义 Treafik 将要监听的 entrypoints。在 Traefik 中有三种方式定义静态配置：在配置文件中、在命令行参数中、通过环境变量传递。</p><h4 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a>动态配置</h4><h4 id="静态配置-1"><a href="#静态配置-1" class="headerlink" title="静态配置"></a>静态配置</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;包含定义系统如何处理请求的所有配置内容，这些配置是可以改变的，而且是无缝热更新的，没有任何请求中断或连接损耗。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;配置KubernetesCRD和部署/公开服务</p><h4 id="安装文件准备"><a href="#安装文件准备" class="headerlink" title="安装文件准备"></a>安装文件准备</h4><ul><li><p>crd.yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt; crd.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: apiextensions.k8s.io/v1beta1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: ingressroutes.traefik.containo.us</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line">  group: traefik.containo.us</span><br><span class="line">  version: v1alpha1</span><br><span class="line">  names:</span><br><span class="line">    kind: IngressRoute</span><br><span class="line">    plural: ingressroutes</span><br><span class="line">    singular: ingressroute</span><br><span class="line">  scope: Namespaced</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apiextensions.k8s.io/v1beta1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: middlewares.traefik.containo.us</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line">  group: traefik.containo.us</span><br><span class="line">  version: v1alpha1</span><br><span class="line">  names:</span><br><span class="line">    kind: Middleware</span><br><span class="line">    plural: middlewares</span><br><span class="line">    singular: middleware</span><br><span class="line">  scope: Namespaced</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apiextensions.k8s.io/v1beta1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: ingressroutetcps.traefik.containo.us</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line">  group: traefik.containo.us</span><br><span class="line">  version: v1alpha1</span><br><span class="line">  names:</span><br><span class="line">    kind: IngressRouteTCP</span><br><span class="line">    plural: ingressroutetcps</span><br><span class="line">    singular: ingressroutetcp</span><br><span class="line">  scope: Namespaced</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apiextensions.k8s.io/v1beta1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: tlsoptions.traefik.containo.us</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line">  group: traefik.containo.us</span><br><span class="line">  version: v1alpha1</span><br><span class="line">  names:</span><br><span class="line">    kind: TLSOption</span><br><span class="line">    plural: tlsoptions</span><br><span class="line">    singular: tlsoption</span><br><span class="line">  scope: Namespaced</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apiextensions.k8s.io/v1beta1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: traefikservices.traefik.containo.us</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line">  group: traefik.containo.us</span><br><span class="line">  version: v1alpha1</span><br><span class="line">  names:</span><br><span class="line">    kind: TraefikService</span><br><span class="line">    plural: traefikservices</span><br><span class="line">    singular: traefikservice</span><br><span class="line">  scope: Namespaced</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>rbac.yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt; rbac.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line"></span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">      - endpoints</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - extensions</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - extensions</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses/status</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - traefik.containo.us</span><br><span class="line">    resources:</span><br><span class="line">      - middlewares</span><br><span class="line">      - ingressroutes</span><br><span class="line">      - traefikservices</span><br><span class="line">      - ingressroutetcps</span><br><span class="line">      - tlsoptions</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line"></span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: traefik-ingress-controller</span><br><span class="line">    namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>traefik.yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;traefik.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: traefik-ingress-lb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">      dnsPolicy: ClusterFirstWithHostNet</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik:v2.1.1</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        ports:</span><br><span class="line">        - name: web</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: websecure</span><br><span class="line">          containerPort: 443</span><br><span class="line">          hostPort: 443</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: mongo</span><br><span class="line">          hostPort: 27017</span><br><span class="line">          containerPort: 27017</span><br><span class="line">        - name: redis</span><br><span class="line">          containerPort: 6379</span><br><span class="line">          hostPort: 6379</span><br><span class="line">        args:</span><br><span class="line">        - --entrypoints.web.Address=:80</span><br><span class="line">        - --entrypoints.websecure.Address=:443</span><br><span class="line">        - --entryPoints.mongo.address=:27017</span><br><span class="line">        - --entrypoints.redis.Address=:6379</span><br><span class="line">        - --api.insecure=<span class="literal">true</span></span><br><span class="line">        - --providers.kubernetescrd</span><br><span class="line">        - --api</span><br><span class="line">        - --api.dashboard=<span class="literal">true</span></span><br><span class="line">        - --providers.kubernetesingress</span><br><span class="line">        - --accesslog</span><br><span class="line">        - --metrics</span><br><span class="line">        - --metrics.datadog=<span class="literal">true</span></span><br><span class="line">        - --metrics.prometheus=<span class="literal">true</span></span><br><span class="line">        - --tracing</span><br><span class="line">        - --tracing.zipkin=<span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">      nodeSelector:</span><br><span class="line">        IngressProxy: <span class="string">"true"</span></span><br><span class="line">      tolerations:</span><br><span class="line">      - effect: NoSchedule</span><br><span class="line">        key: node-role.kubernetes.io/ingress</span><br><span class="line">        operator: Equal</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  selector:</span><br><span class="line">    app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      name: web</span><br><span class="line">      targetPort: 80</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 8080</span><br><span class="line">      name: admin</span><br><span class="line">      targetPort: 8080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p><strong>注</strong>:</p><ul><li>args: 都是静态参数<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>--providers.kubernetesingress</code>这个参数可以开启，如果之前安装过traefik，也建立了一些traefik的ingress。就会自动的导入添加进来，这比较方便和实用。</li></ul><ul><li>Ingressroute.yaml<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;Ingressroute.yaml&lt;&lt;EOF</span></span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: IngressRoute</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-webui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  entryPoints:</span><br><span class="line">    - web</span><br><span class="line">  routes:</span><br><span class="line">  - match: Host(`traefik.xxlaila.cn`)</span><br><span class="line">    kind: Rule</span><br><span class="line">    services:</span><br><span class="line">    - name: traefik</span><br><span class="line">      port: 8080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>上述文件可以参考<a href="https://docs.traefik.io/routing/providers/kubernetes-crd/" target="_blank" rel="noopener">traefik官方</a>，可以直接拿来使用，根据自己的需求来进行修改。插件部分<a href="https://docs.traefik.io/observability/metrics/overview/" target="_blank" rel="noopener">参考</a>官方，也可以<a href="https://docs.traefik.io/user-guides/crd-acme/" target="_blank" rel="noopener">参考实列</a></p><h4 id="执行创建"><a href="#执行创建" class="headerlink" title="执行创建"></a>执行创建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在浏览器访问traefik.xxlaila.cn即可<br><img src="https://img.xxlaila.cn/1578558695609.jpg" alt="img"></p><h3 id="traefik-动态配置"><a href="#traefik-动态配置" class="headerlink" title="traefik 动态配置"></a>traefik 动态配置</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在很多时候，某一个应用程序突然发生改变，这就会产生配置文件的改动，按照之前的部署方式来进行使用traefik，每一次的都需要进行重新部署，这对于生成环境或者在正式使用的过程中是不允许的，还好traefik提供了动态配置，动态配置可以支持一个目录，也可以支持一个文件。似乎动态加载目录下面的配置文件更加的舒适，部分配置文件分开，有利于维护和影响小范围。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;动态配置文件生成过多，在某些时候变动过大，traefik重载配置可能会压力比较大。还好traefik有一个参数配置<code>providers.providersThrottleDuration</code>，该参数配置是Traefik在重新加载配置之后等待的持续时间，然后才考虑任何新的配置刷新事件。如果在此持续时间内有任何事件到达，则仅考虑最近的事件，所有先前的事件都将被丢弃。traefik默认时间是2s。</p><h4 id="部署traefik动态配置"><a href="#部署traefik动态配置" class="headerlink" title="部署traefik动态配置"></a>部署traefik动态配置</h4><h5 id="traefik-yaml"><a href="#traefik-yaml" class="headerlink" title="traefik.yaml"></a>traefik.yaml</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt; traefik.yaml&lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: traefik-ingress-lb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">      dnsPolicy: ClusterFirstWithHostNet</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /opt/traefix</span><br><span class="line">          <span class="built_in">type</span>: Directory</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik:v2.1.1</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: /config</span><br><span class="line">        ports:</span><br><span class="line">        - name: web</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: websecure</span><br><span class="line">          containerPort: 443</span><br><span class="line">          hostPort: 443</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        args:</span><br><span class="line">        - --configfile=/config/dy_traefik.yaml</span><br><span class="line">        </span><br><span class="line">      nodeSelector:</span><br><span class="line">        IngressProxy: <span class="string">"true"</span></span><br><span class="line">      tolerations:</span><br><span class="line">      - effect: NoSchedule</span><br><span class="line">        key: node-role.kubernetes.io/ingress</span><br><span class="line">        operator: Equal</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  selector:</span><br><span class="line">    app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      name: web</span><br><span class="line">      targetPort: 80</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 8080</span><br><span class="line">      name: admin</span><br><span class="line">      targetPort: 8080</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f traefik.yaml</span></span><br></pre></td></tr></table></figure><h4 id="dashboard部署"><a href="#dashboard部署" class="headerlink" title="dashboard部署"></a>dashboard部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;dashboard.yaml&lt;&lt;EOF</span></span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: IngressRoute</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-dashboard</span><br><span class="line">spec:</span><br><span class="line">  routes:</span><br><span class="line">  - match: Host(`traefik.xxlaila.cn`)</span><br><span class="line">    kind: Rule</span><br><span class="line">    services:</span><br><span class="line">    - name: api@internal</span><br><span class="line">      kind: TraefikService</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f dashboard.yaml</span></span><br></pre></td></tr></table></figure><h4 id="创建基础配置文件"><a href="#创建基础配置文件" class="headerlink" title="创建基础配置文件"></a>创建基础配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;dy_traefik.yaml&lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">serversTransport:</span><br><span class="line">  insecureSkipVerify: <span class="literal">true</span></span><br><span class="line">api:</span><br><span class="line">  dashboard: <span class="literal">true</span></span><br><span class="line">  insecure: <span class="literal">true</span></span><br><span class="line"><span class="built_in">log</span>:</span><br><span class="line">  filePath: <span class="string">"/config/logs/traefik.log"</span></span><br><span class="line">  format: <span class="string">"json"</span></span><br><span class="line">  level: <span class="string">"INFO"</span></span><br><span class="line">accessLog:</span><br><span class="line">  filePath: <span class="string">"/config/logs/access.log"</span></span><br><span class="line">  bufferingSize: 100</span><br><span class="line">  format: json</span><br><span class="line">providers:</span><br><span class="line">  kubernetesCRD: <span class="string">""</span></span><br><span class="line">  kubernetesIngress: <span class="string">""</span></span><br><span class="line">  providersThrottleDuration: 10s</span><br><span class="line">  file:</span><br><span class="line">    directory: /config/conf</span><br><span class="line">    watch: <span class="literal">true</span></span><br><span class="line">entryPoints:</span><br><span class="line">  web:</span><br><span class="line">    address: <span class="string">":80"</span></span><br><span class="line">  websecure:</span><br><span class="line">    address: <span class="string">":443"</span></span><br><span class="line">  redis:</span><br><span class="line">    address: <span class="string">":6379"</span></span><br><span class="line">  mysql:</span><br><span class="line">    address: <span class="string">":3306"</span></span><br><span class="line">  mongo:</span><br><span class="line">    address: <span class="string">":27017"</span></span><br><span class="line">  es:</span><br><span class="line">    address: <span class="string">":9200"</span></span><br><span class="line">metrics:</span><br><span class="line">  datadog:</span><br><span class="line">    address: 127.0.0.1:8125</span><br><span class="line">    addEntryPointsLabels: <span class="literal">true</span></span><br><span class="line">  prometheus:</span><br><span class="line">    buckets:</span><br><span class="line">      - 0.1</span><br><span class="line">      - 0.3</span><br><span class="line">      - 1.2</span><br><span class="line">      - 5.0</span><br><span class="line">tracing:</span><br><span class="line">  zipkin:</span><br><span class="line">    httpEndpoint: http://10.254.153.94:9411/api/v2/spans</span><br><span class="line">    sameSpan: <span class="literal">true</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dy_teaefik.yaml 配置文件是放在 traefik对应node节点，目录建立对应的/opt/traefik/{conf,logs,certs}。需要进行动态更新的文件放在conf目录下面。dy_traefik.yaml文件放在node的/opt/traefik目录下面。<br><strong>注</strong>:</p><ul><li>args: 都是静态参数</li><li>–configfile: 是指定traefik启动时候加载的配置文件</li><li>–providers.file.filename参数: 指定配置文件开启 File Provider</li><li>–providers.file.watch=true 参数: 让 Traefik 动态更新配置<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>--providers.kubernetesingress</code>这个参数可以开启，如果之前安装过traefik，也建立了一些traefik的ingress。就会自动的导入添加进来，这比较方便和实用。</li></ul><h4 id="执行创建-1"><a href="#执行创建-1" class="headerlink" title="执行创建"></a>执行创建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik.yaml</span></span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在conf下面建立一个rule.toml文件。配置一个灰度发布的规则，创建一个名为 Router0 的路由。在 web 这个入口点上面监听 Host=nginx.xxlaila.cn，将请求路由给名为 app 的服务。服务将请求路由给了 appv1 这个服务，权重为3，其他请求路由给了 appv2 服务，权重为2，创建nginx服务可以参考<a href="https://www.xxlaila.cn/2020/01/09/traefik%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/">nginx资源部署</a></p><ul><li>rule.toml<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;rule.toml&lt;&lt;EOF</span></span><br><span class="line">[http]</span><br><span class="line">  [http.routers]</span><br><span class="line">    [http.routers.Router0]</span><br><span class="line">      namespace = <span class="string">"default"</span></span><br><span class="line">      entryPoints = [<span class="string">"web"</span>]</span><br><span class="line">      service = <span class="string">"app"</span></span><br><span class="line">      rule = <span class="string">"Host(`nginx.xxlaila.cn`)"</span></span><br><span class="line"></span><br><span class="line">  [http.services]</span><br><span class="line">    [http.services.app]</span><br><span class="line"></span><br><span class="line">      [[http.services.app.weighted.services]]</span><br><span class="line">        name = <span class="string">"appv1"</span></span><br><span class="line">        weight = 3</span><br><span class="line"></span><br><span class="line">      [[http.services.app.weighted.services]]</span><br><span class="line">        name = <span class="string">"appv2"</span></span><br><span class="line">        weight = 2</span><br><span class="line"></span><br><span class="line">    [http.services.appv1]</span><br><span class="line">      [http.services.appv1.loadBalancer]</span><br><span class="line">        [[http.services.appv1.loadBalancer.servers]]</span><br><span class="line">          url = <span class="string">"http://appv1.default.svc.cluster.local:80/"</span></span><br><span class="line"></span><br><span class="line">    [http.services.appv2]</span><br><span class="line">      [http.services.appv2.loadBalancer]</span><br><span class="line">        [[http.services.appv2.loadBalancer.servers]]</span><br><span class="line">          url = <span class="string">"http://appv2.default.svc.cluster.local:80/"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  [http.middlewares]</span><br><span class="line">    [http.middlewares.Middleware00]</span><br><span class="line">      [http.middlewares.Middleware00.addPrefix]</span><br><span class="line">        prefix = <span class="string">"foobar"</span> </span><br><span class="line"></span><br><span class="line">    [http.middlewares.Middleware01]</span><br><span class="line">      [http.middlewares.Middleware01.basicAuth]</span><br><span class="line">        users = [<span class="string">"foobar"</span>, <span class="string">"foobar"</span>]</span><br><span class="line">        usersFile = <span class="string">"foobar"</span></span><br><span class="line">        realm = <span class="string">"foobar"</span></span><br><span class="line">        removeHeader = <span class="literal">true</span></span><br><span class="line">        headerField = <span class="string">"foobar"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik会自动加载配置，http.middlewares 的配置可以删除和增加来测试是否动态配置是否生效。<br><img src="https://img.xxlaila.cn/1578902148997.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1578902281052.jpg" alt="img"></p><p>这里进行5次请求，appv1 接受了3次请求，appv2 接受了两次请求</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl logs -f appv1-6f88c7b898-qx2pc nginx</span></span><br><span class="line">127.0.0.1 - - [13/Jan/2020:07:56:46 +0000] <span class="string">"GET / HTTP/1.1"</span> 200 9 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36"</span> <span class="string">"172.20.16.22"</span></span><br><span class="line">127.0.0.1 - - [13/Jan/2020:07:56:50 +0000] <span class="string">"GET / HTTP/1.1"</span> 200 9 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36"</span> <span class="string">"172.20.16.22"</span></span><br><span class="line">127.0.0.1 - - [13/Jan/2020:07:56:52 +0000] <span class="string">"GET / HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36"</span> <span class="string">"172.20.16.22"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl logs -f appv2-558fdbbdb7-6gd8l nginx</span></span><br><span class="line">127.0.0.1 - - [13/Jan/2020:07:56:48 +0000] <span class="string">"GET / HTTP/1.1"</span> 200 9 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36"</span> <span class="string">"172.20.16.22"</span></span><br><span class="line">127.0.0.1 - - [13/Jan/2020:07:56:54 +0000] <span class="string">"GET / HTTP/1.1"</span> 200 9 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36"</span> <span class="string">"172.20.16.22"</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;认识&quot;&gt;&lt;a href=&quot;#认识&quot; class=&quot;headerlink&quot; title=&quot;认识&quot;&gt;&lt;/a&gt;认识&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Traefik2.0 中的配置可以使用两种不同的方式&lt;/p&gt;&lt;ul&gt;&lt;li&gt;动态配置：完全动态的路由配置&lt;/li&gt;&lt;li&gt;静态配置：启动配置
    
    </summary>
    
      <category term="Ingress" scheme="https://www.xxlaila.cn/categories/Ingress/"/>
    
    
      <category term="traefik" scheme="https://www.xxlaila.cn/tags/traefik/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch索引管理</title>
    <link href="https://www.xxlaila.cn/2019/12/30/Elasticsearch%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86/"/>
    <id>https://www.xxlaila.cn/2019/12/30/Elasticsearch索引管理/</id>
    <published>2019-12-30T06:41:07.000Z</published>
    <updated>2020-02-20T08:22:27.926Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="痛点"><a href="#痛点" class="headerlink" title="痛点"></a>痛点</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;公司上线了elk日志分析系统，但是在线下开发测试环境数据量比较大，而且线下都是一些测试和开发使用的数据。也没有必要存放起来。<a id="more"></a>但是随着时间的推移，elasticsearch的数据量会撑爆磁盘。伴随着需要人为的清理。所以这就要删除一定时间的数据，来保障磁盘空间的使用量。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于索引过多，之前都是实用脚本来管理，比如：增量rollover动态更新脚本、定期delete脚本、定期force_merge脚本、定期shrink脚本、定期快照脚本，随着需求的过多，es也有三个集群，脚本维护虽然用了一定的科学管理办法，但是还是挺难维护的。</p><h3 id="elasticsearch-curator介绍"><a href="#elasticsearch-curator介绍" class="headerlink" title="elasticsearch-curator介绍"></a>elasticsearch-curator介绍</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elasticsearch-curator管理elasticsearch索引和快照，从集群里获取全部索引或者快照作为可操作列表；迭代用户定义的过滤器列表，根据需要逐步从此可操作列表中删除索引或快照；对保留下来的列表执行各种操作。</p><h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curator允许对索引和快照执行许多不同的操作，包括：</p><ul><li>从别名添加或删除索引（或两者！）</li><li>更改分片路由分配更改分片路由分配</li><li>关闭索引关闭索引</li><li>建索引创建索引</li><li>删除索引删除索引</li><li>删除快照删除快照</li><li>打开被关闭的索引打开被关闭的索引</li><li>对索引执行forcemerge段合并操作对索引执行forcemerge段合并操作</li><li>ndex索引，包括来自远程集群的索引reindex索引，包括来自远程集群的索引</li><li>更改索引的每个分片的副本数 更改索引的每个分片的副本数</li><li>rollover索引rollover索引</li><li>生成索引的快照（备份）生成索引的快照（备份）</li><li>还原快照还原快照</li></ul><h3 id="elasticsearch-curator安装"><a href="#elasticsearch-curator安装" class="headerlink" title="elasticsearch-curator安装"></a>elasticsearch-curator安装</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elasticsearch-curator安装可以通过两种方式来进行安装，一种是pip、一种是yum。这里使用pip来进行安装。<a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html" target="_blank" rel="noopener">安装参考</a></p><h4 id="pip-安装elasticsearch-curator"><a href="#pip-安装elasticsearch-curator" class="headerlink" title="pip 安装elasticsearch-curator"></a>pip 安装elasticsearch-curator</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pip install elasticsearch-curator</span></span><br></pre></td></tr></table></figure><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curator_cli --host 127.0.0.1 --port 9200  show_indices</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果es安装监听端口是0.0.0.0，则host参数和port参数不需要</span></span><br></pre></td></tr></table></figure><h4 id="配置-config-yml"><a href="#配置-config-yml" class="headerlink" title="配置 config.yml"></a>配置 config.yml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /opt/ELKStack/curator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat &gt; config.yaml&lt;&lt;EOF</span></span><br><span class="line">client:</span><br><span class="line">  hosts: [ <span class="string">"172.21.16.18"</span>, <span class="string">"172.21.16.19"</span>, <span class="string">"172.21.16.20"</span> ]</span><br><span class="line">  port: 9200</span><br><span class="line">  url_prefix:</span><br><span class="line">  use_ssl: False</span><br><span class="line">  certificate:</span><br><span class="line">  client_cert:</span><br><span class="line">  client_key:</span><br><span class="line">  ssl_no_validate: False</span><br><span class="line">  http_auth:</span><br><span class="line">  timeout: 30</span><br><span class="line">  master_only: False</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  loglevel: INFO</span><br><span class="line">  logfile:</span><br><span class="line">  logformat: default</span><br><span class="line">  blacklist: [<span class="string">'elasticsearch'</span>, <span class="string">'urllib3'</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>CONFIG.YML是配置文件，用于配置ES集群信息，<a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/configfile.html" target="_blank" rel="noopener">官方参考</a><ul><li>集群IP</li><li>安全认证信息</li><li>日志信息</li></ul></li></ul><h4 id="配置action-yaml"><a href="#配置action-yaml" class="headerlink" title="配置action.yaml"></a>配置action.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;action.yml &lt;&lt;EOF</span></span><br><span class="line">actions:</span><br><span class="line">  1:</span><br><span class="line">    action: delete_indices</span><br><span class="line">    description: &gt;-</span><br><span class="line">      Delete indices older than 30 days (based on index name), <span class="keyword">for</span> logstash-prefixed indices. Ignore the error <span class="keyword">if</span> the filter does not result <span class="keyword">in</span> an actionable list of indices (ignore_empty_list) and <span class="built_in">exit</span> cleanly.</span><br><span class="line">    options:</span><br><span class="line">      ignore_empty_list: True</span><br><span class="line">      disable_action: False</span><br><span class="line">    filters:</span><br><span class="line">    - filtertype: pattern</span><br><span class="line">      kind: regex</span><br><span class="line">      <span class="comment"># 保留 kibana|json|monitoring|metadata 不被清理</span></span><br><span class="line">      value: <span class="string">'^((?!(kibana|json|monitoring|metadata)).)*$'</span></span><br><span class="line">    - filtertype: age</span><br><span class="line">      <span class="built_in">source</span>: creation_date</span><br><span class="line">      direction: older</span><br><span class="line">      <span class="comment">#timestring: '%Yi-%m-%d'</span></span><br><span class="line">      unit: days</span><br><span class="line">      unit_count: 30</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果执行多个任务，在actions: 后面的依次类推，<a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/actionfile.html" target="_blank" rel="noopener">官方参考</a></p><h4 id="执行测试"><a href="#执行测试" class="headerlink" title="执行测试"></a>执行测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/bin/curator --config /opt/ELKStack/curator/config.yaml /opt/ELKStack/curator/action.yml 1&gt;&gt; /tmp/curator.log 2&gt;&amp;1</span></span><br></pre></td></tr></table></figure><ul><li><p>执行前</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curator_cli --host 127.0.0.1 --port 9200  show_indices</span></span><br><span class="line">2019-12-30 14:38:22,438 INFO      Instantiating client object</span><br><span class="line">2019-12-30 14:38:22,439 INFO      Testing client connectivity</span><br><span class="line">2019-12-30 14:38:22,506 INFO      Successfully created Elasticsearch client object with provided settings</span><br><span class="line">.kibana6.4</span><br><span class="line">.monitoring-es-6-2019.12.23</span><br><span class="line">.monitoring-es-6-2019.12.24</span><br><span class="line">.monitoring-es-6-2019.12.25</span><br><span class="line">.monitoring-es-6-2019.12.26</span><br><span class="line">.monitoring-es-6-2019.12.27</span><br><span class="line">.monitoring-es-6-2019.12.28</span><br><span class="line">.monitoring-es-6-2019.12.29</span><br><span class="line">.monitoring-es-6-2019.12.30</span><br><span class="line">.monitoring-kibana-6-2019.12.23</span><br><span class="line">.monitoring-kibana-6-2019.12.24</span><br><span class="line">.monitoring-kibana-6-2019.12.25</span><br><span class="line">.monitoring-kibana-6-2019.12.26</span><br><span class="line">.monitoring-kibana-6-2019.12.27</span><br><span class="line">.monitoring-kibana-6-2019.12.28</span><br><span class="line">.monitoring-kibana-6-2019.12.29</span><br><span class="line">.monitoring-kibana-6-2019.12.30</span><br><span class="line">uat-xxx-xxx-system-2019-11</span><br><span class="line">uat-xxx-xxx-system-2019-12</span><br><span class="line">uat-xxx-xxx-system-2019-11</span><br><span class="line">uat-xxx-xxx-system-2019-12</span><br><span class="line">uat-xxx-xxx-xxx-system-2019-11</span><br><span class="line">uat-xxx-xxx-xxx-system-2019-12</span><br><span class="line">dev-xxx-xxx-system-2019-12</span><br><span class="line">dev-xxx-xxx-system-2019-11</span><br><span class="line">dev-xxx-xxx-system-2019-12</span><br><span class="line">dev-xxx-xxx-system-2019-11</span><br><span class="line">dev-xxx-xxx-system-2019-12</span><br><span class="line">dev-xxx-xxx-xxx-system-2019-11</span><br><span class="line">dev-xxx-xxx-xxx-system-2019-12</span><br><span class="line"><span class="built_in">test</span>-xxx-xxx-system-2019-11</span><br><span class="line"><span class="built_in">test</span>-xxx-xxx-system-2019-12</span><br><span class="line"><span class="built_in">test</span>-xxx-xxx-xxx-system-2019-11</span><br><span class="line"><span class="built_in">test</span>-xxx-xxx-xxx-system-2019-12</span><br><span class="line">zxc-2019-11</span><br><span class="line">zxc-2019-12</span><br></pre></td></tr></table></figure></li><li><p>执行后</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /tmp/curator.log </span></span><br><span class="line">2019-12-30 16:09:44,383 INFO      Preparing Action ID: 1, <span class="string">"delete_indices"</span></span><br><span class="line">2019-12-30 16:09:44,384 INFO      Creating client object and testing connection</span><br><span class="line">2019-12-30 16:09:44,387 INFO      Instantiating client object</span><br><span class="line">2019-12-30 16:09:44,389 INFO      Testing client connectivity</span><br><span class="line">2019-12-30 16:09:44,398 INFO      Successfully created Elasticsearch client object with provided settings</span><br><span class="line">2019-12-30 16:09:44,403 INFO      Trying Action ID: 1, <span class="string">"delete_indices"</span>: Delete indices older than 30 days. Ignore the error <span class="keyword">if</span> the    filter does not result <span class="keyword">in</span> an actionable list of indices    (ignore_empty_list) and <span class="built_in">exit</span> cleanly.</span><br><span class="line">2019-12-30 16:09:46,667 INFO      Deleting 9 selected indices: [u<span class="string">'dev-xxx-xxx-system-2019-11'</span>, u<span class="string">'uat-xxx-xxx-system-2019-11'</span>, u<span class="string">'test-xxx-xxx-xxx-system-2019-11'</span>, u<span class="string">'test-xxx-xxx-system-2019-11'</span>, u<span class="string">'uat-xxx-xxx-xxx-system-2019-11'</span>, u<span class="string">'dev-xxx-xxx-xxx-system-2019-11'</span>, u<span class="string">'uat-xxx-xxx-system-2019-11'</span>, u<span class="string">'dev-xxx-xxx-system-2019-11'</span>, u<span class="string">'zxc-2019-11'</span>]</span><br><span class="line">2019-12-30 16:09:46,667 INFO      ---deleting index dev-xxx-xxx-system-2019-11</span><br><span class="line">2019-12-30 16:09:46,667 INFO      ---deleting index uat-xxx-xxx-system-2019-11</span><br><span class="line">2019-12-30 16:09:46,667 INFO      ---deleting index <span class="built_in">test</span>-xxx-xxx-xxx-system-2019-11</span><br><span class="line">2019-12-30 16:09:46,667 INFO      ---deleting index <span class="built_in">test</span>-xxx-xxx-system-2019-11</span><br><span class="line">2019-12-30 16:09:46,667 INFO      ---deleting index uat-xxx-xxx-xxx-system-2019-11</span><br><span class="line">2019-12-30 16:09:46,667 INFO      ---deleting index dev-xxx-xxx-xxx-system-2019-11</span><br><span class="line">2019-12-30 16:09:46,667 INFO      ---deleting index uat-xxx-xxx-system-2019-11</span><br><span class="line">2019-12-30 16:09:46,667 INFO      ---deleting index dev-xxx-xxx-system-2019-11</span><br><span class="line">2019-12-30 16:09:46,667 INFO      ---deleting index zxc-2019-11</span><br><span class="line">2019-12-30 16:09:56,702 INFO      Action ID: 1, <span class="string">"delete_indices"</span> completed.</span><br><span class="line">2019-12-30 16:09:56,702 INFO      Job completed.</span><br><span class="line"></span><br><span class="line"><span class="comment"># curator_cli --host 127.0.0.1 --port 9200  show_indices</span></span><br><span class="line">2019-12-30 16:13:09,174 INFO      Instantiating client object</span><br><span class="line">2019-12-30 16:13:09,175 INFO      Testing client connectivity</span><br><span class="line">2019-12-30 16:13:09,182 INFO      Successfully created Elasticsearch client object with provided settings</span><br><span class="line">.kibana6.4</span><br><span class="line">.monitoring-es-6-2019.12.23</span><br><span class="line">.monitoring-es-6-2019.12.24</span><br><span class="line">.monitoring-es-6-2019.12.25</span><br><span class="line">.monitoring-es-6-2019.12.26</span><br><span class="line">.monitoring-es-6-2019.12.27</span><br><span class="line">.monitoring-es-6-2019.12.28</span><br><span class="line">.monitoring-es-6-2019.12.29</span><br><span class="line">.monitoring-es-6-2019.12.30</span><br><span class="line">.monitoring-kibana-6-2019.12.23</span><br><span class="line">.monitoring-kibana-6-2019.12.24</span><br><span class="line">.monitoring-kibana-6-2019.12.25</span><br><span class="line">.monitoring-kibana-6-2019.12.26</span><br><span class="line">.monitoring-kibana-6-2019.12.27</span><br><span class="line">.monitoring-kibana-6-2019.12.28</span><br><span class="line">.monitoring-kibana-6-2019.12.29</span><br><span class="line">.monitoring-kibana-6-2019.12.30</span><br><span class="line">uat-xxx-xxx-system-2019-12</span><br><span class="line">uat-xxx-xxx-system-2019-12</span><br><span class="line">uat-xxx-xxx-xxx-system-2019-12</span><br><span class="line">dev-xxx-xxx-system-2019-12</span><br><span class="line">dev-xxx-xxx-system-2019-12</span><br><span class="line">dev-xxx-xxx-system-2019-12</span><br><span class="line">dev-xxx-xxx-xxx-system-2019-12</span><br><span class="line"><span class="built_in">test</span>-xxx-xxx-system-2019-12</span><br><span class="line"><span class="built_in">test</span>-xxx-xxx-xxx-system-2019-12</span><br><span class="line">zxc-2019-12</span><br></pre></td></tr></table></figure></li></ul><h4 id="设置计划任务"><a href="#设置计划任务" class="headerlink" title="设置计划任务"></a>设置计划任务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crontab -e</span></span><br><span class="line">42 4 1 * * /usr/bin/curator --config /opt/ELKStack/curator/config.yaml /opt/ELKStack/curator/action.yml 1&gt;&gt; /tmp/curator.log 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl restart crond</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;痛点&quot;&gt;&lt;a href=&quot;#痛点&quot; class=&quot;headerlink&quot; title=&quot;痛点&quot;&gt;&lt;/a&gt;痛点&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;公司上线了elk日志分析系统，但是在线下开发测试环境数据量比较大，而且线下都是一些测试和开发使用的数据。也没有必要存放起来。
    
    </summary>
    
      <category term="elasticsearch" scheme="https://www.xxlaila.cn/categories/elasticsearch/"/>
    
    
      <category term="elasticsearch" scheme="https://www.xxlaila.cn/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>centos 安装字体三步曲</title>
    <link href="https://www.xxlaila.cn/2019/12/23/centos-%E5%AE%89%E8%A3%85%E5%AD%97%E4%BD%93%E4%B8%89%E6%AD%A5%E6%9B%B2/"/>
    <id>https://www.xxlaila.cn/2019/12/23/centos-安装字体三步曲/</id>
    <published>2019-12-23T09:38:36.000Z</published>
    <updated>2019-12-23T09:43:27.263Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上传字体到服务器。</p><h3 id="安装准备"><a href="#安装准备" class="headerlink" title="安装准备"></a>安装准备</h3><a id="more"></a><h4 id="安装字体库"><a href="#安装字体库" class="headerlink" title="安装字体库"></a>安装字体库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install fontconfig</span></span><br></pre></td></tr></table></figure><h4 id="安装字体索引信息"><a href="#安装字体索引信息" class="headerlink" title="安装字体索引信息"></a>安装字体索引信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install ttmkfdir mkfontscale</span></span><br></pre></td></tr></table></figure><h4 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;linux的字体目录默认是存放在<code>/usr/share/fonts</code>，可以创建chinese用于存放中文字体。吧字体复制到该目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /usr/share/fonts/chinese</span></span><br></pre></td></tr></table></figure><h3 id="安装字体"><a href="#安装字体" class="headerlink" title="安装字体"></a>安装字体</h3><h4 id="生成字库索引信息"><a href="#生成字库索引信息" class="headerlink" title="生成字库索引信息"></a>生成字库索引信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkfontscale</span></span><br><span class="line"><span class="comment"># mkfontdir</span></span><br></pre></td></tr></table></figure><h4 id="更新字体缓存"><a href="#更新字体缓存" class="headerlink" title="更新字体缓存"></a>更新字体缓存</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fc-cache</span></span><br></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fc-list</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;上传字体到服务器。&lt;/p&gt;&lt;h3 id=&quot;安装准备&quot;&gt;&lt;a href=&quot;#安装准备&quot; class=&quot;headerlink&quot; title=&quot;安装准备&quot;&gt;&lt;/a&gt;安装准备&lt;/h3&gt;
    
    </summary>
    
      <category term="centos" scheme="https://www.xxlaila.cn/categories/centos/"/>
    
    
      <category term="fonts" scheme="https://www.xxlaila.cn/tags/fonts/"/>
    
  </entry>
  
  <entry>
    <title>nfs服务器异常</title>
    <link href="https://www.xxlaila.cn/2019/12/23/nfs%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%82%E5%B8%B8/"/>
    <id>https://www.xxlaila.cn/2019/12/23/nfs服务器异常/</id>
    <published>2019-12-23T01:29:41.000Z</published>
    <updated>2020-01-02T08:05:04.315Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="故障表现"><a href="#故障表现" class="headerlink" title="故障表现"></a>故障表现</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;近期发现只要是挂载nfs的服务器，不定期的出现服务器卡死，发现是在ansible自动化发布的时候出现一直卡死，然后登录服务器端发现发现命令不能用，如: ls、df等命令无法正常使用。<a id="more"></a>在客户端查看系统日志没有任何错误。查看系统资源，资源利用率也足够。</p><h3 id="故障解决"><a href="#故障解决" class="headerlink" title="故障解决"></a>故障解决</h3><h4 id="nfs服务端"><a href="#nfs服务端" class="headerlink" title="nfs服务端"></a>nfs服务端</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;登录nfs服务端查看系统的日志发现:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Dec 23 09:01:01 dev-nfs systemd: Removed slice User Slice of root.</span><br><span class="line">Dec 23 09:01:01 dev-nfs systemd: Stopping User Slice of root.</span><br><span class="line">Dec 23 09:21:26 dev-nfs systemd: Created slice User Slice of root.</span><br><span class="line">Dec 23 09:21:26 dev-nfs systemd: Starting User Slice of root.</span><br><span class="line">Dec 23 09:21:26 dev-nfs systemd: Started Session 12836 of user root.</span><br><span class="line">Dec 23 09:21:26 dev-nfs systemd-logind: New session 12836 of user root.</span><br><span class="line">Dec 23 09:21:26 dev-nfs systemd: Starting Session 12836 of user root.</span><br><span class="line">Dec 23 09:22:01 dev-nfs systemd: Stopping RPC <span class="built_in">bind</span> service...</span><br><span class="line">Dec 23 09:22:01 dev-nfs systemd: Starting RPC <span class="built_in">bind</span> service...</span><br><span class="line">Dec 23 09:22:01 dev-nfs systemd: Started RPC <span class="built_in">bind</span> service.</span><br><span class="line">Dec 23 09:22:11 dev-nfs systemd: Started Session 12837 of user root.</span><br><span class="line">Dec 23 09:22:11 dev-nfs systemd-logind: New session 12837 of user root.</span><br><span class="line">Dec 23 09:22:11 dev-nfs systemd: Starting Session 12837 of user root.</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Stopping NFS server and services...</span><br><span class="line">Dec 23 09:22:12 dev-nfs kernel: nfsd: last server has exited, flushing <span class="built_in">export</span> cache</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Stopping NFS Mount Daemon...</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Stopping NFSv4 ID-name mapping service...</span><br><span class="line">Dec 23 09:22:12 dev-nfs rpc.mountd[29810]: Caught signal 15, un-registering and exiting.</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Starting Preprocess NFS configuration...</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Started Preprocess NFS configuration.</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Starting NFSv4 ID-name mapping service...</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Starting NFS Mount Daemon...</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Started NFSv4 ID-name mapping service.</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Started NFS Mount Daemon.</span><br><span class="line">Dec 23 09:22:12 dev-nfs systemd: Starting NFS server and services...</span><br><span class="line">Dec 23 09:22:12 dev-nfs rpc.mountd[31339]: Version 1.3.0 starting</span><br><span class="line">Dec 23 09:22:12 dev-nfs kernel: NFSD: starting 90-second grace period (net ffffffff81ad9d40)</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;发现nfs的服务端出现 <code>kernel</code>内核的异常，于是乎登录google得知。发现nfs线程数不够了，提示要增加一些数量的threads。</p><h5 id="当前nfs状态"><a href="#当前nfs状态" class="headerlink" title="当前nfs状态"></a>当前nfs状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/net/rpc/nfsd </span></span><br><span class="line">rc 0 0 30463198</span><br><span class="line">fh 0 0 0 0 0</span><br><span class="line">io 1447382326 1456801108</span><br><span class="line">th 8 0 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000</span><br><span class="line">ra 32 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">net 30463199 0 30485174 266</span><br><span class="line">rpc 30463198 1 1 0 0</span><br><span class="line">proc3 22 2 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">proc4 2 70 30463126</span><br><span class="line">proc4ops 72 0 0 0 570540 491739 28774 6320 0 191550 6463291 255991 0 0 0 0 177217 0 0 523775 0 0 133 6853388 0 230 203547 27936 0 8180 209 0 0 209 0 311026 0 0 0 2126786 0 0 0 266 14491135 185 0 0 0 0 0 0 0 26 15971485 0 3 0 46 204 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br></pre></td></tr></table></figure><h5 id="查看线程数"><a href="#查看线程数" class="headerlink" title="查看线程数"></a>查看线程数</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/fs/nfsd/threads</span></span><br><span class="line">8</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;原来nfs默认启动了8个thread，应该是不够了，可以手动修改增加一些。修改nfs的默认线程数方式如下</p><h5 id="修改nfs的默认线程数"><a href="#修改nfs的默认线程数" class="headerlink" title="修改nfs的默认线程数"></a>修改nfs的默认线程数</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysconfig/nfs</span></span><br><span class="line"><span class="comment"># The default is 8. </span></span><br><span class="line">RPCNFSDCOUNT=32</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;需要重启nfs</p><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/net/rpc/nfsd</span></span><br><span class="line">rc 0 0 30464433</span><br><span class="line">fh 0 0 0 0 0</span><br><span class="line">io 1447382326 1456801108</span><br><span class="line">th 32 0 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000</span><br><span class="line">ra 64 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">net 30464434 0 30486409 268</span><br><span class="line">rpc 30464433 1 1 0 0</span><br><span class="line">proc3 22 2 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">proc4 2 70 30464361</span><br><span class="line">proc4ops 72 0 0 0 570540 491739 28774 6320 0 191550 6463293 255991 0 0 0 0 177217 0 0 523775 0 0 133 6853388 0 232 203547 27936 0 8180 209 0 0 209 0 311026 0 0 0 2126786 0 0 0 268 14492227 185 0 0 0 0 0 0 0 26 15971626 0 3 0 46 206 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /proc/fs/nfsd/threads</span></span><br><span class="line">32</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /proc/fs/nfsd/pool_threads</span></span><br><span class="line">32</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /proc/fs/nfsd/pool_stats </span></span><br><span class="line"><span class="comment"># pool packets-arrived sockets-enqueued threads-woken threads-timedout</span></span><br><span class="line">0 485 4 481 0</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;故障表现&quot;&gt;&lt;a href=&quot;#故障表现&quot; class=&quot;headerlink&quot; title=&quot;故障表现&quot;&gt;&lt;/a&gt;故障表现&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;近期发现只要是挂载nfs的服务器，不定期的出现服务器卡死，发现是在ansible自动化发布的时候出现一直卡死，然后登录服务器端发现发现命令不能用，如: ls、df等命令无法正常使用。
    
    </summary>
    
      <category term="centos" scheme="https://www.xxlaila.cn/categories/centos/"/>
    
    
      <category term="nfs" scheme="https://www.xxlaila.cn/tags/nfs/"/>
    
  </entry>
  
  <entry>
    <title>traefik https使用</title>
    <link href="https://www.xxlaila.cn/2019/12/19/traefik-https%E4%BD%BF%E7%94%A8/"/>
    <id>https://www.xxlaila.cn/2019/12/19/traefik-https使用/</id>
    <published>2019-12-19T06:06:08.000Z</published>
    <updated>2020-01-09T08:53:19.411Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;之前已经使用traefik服务作为入口，测试并访问了tomcat应用，之前是通过http来访问的，而我们在yaml文件里面也添加8443端口用于https访问，在实际环境中我们也是需要<br>https来进行访问应用，通过traefik实现https，<a href="https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">traefik http应用</a></p><a id="more"></a><h3 id="操作实践"><a href="#操作实践" class="headerlink" title="操作实践"></a>操作实践</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里我用了公司的证书，就是为了贴近真实，也满足测试需求，创建一个secret，保存https证书，如果没有证书，可以使用以下方式进行生成证书</p><h4 id="签证书"><a href="#签证书" class="headerlink" title="签证书"></a>签证书</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;没有证书可以使用命令生产证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir certs</span></span><br><span class="line"><span class="comment"># openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout xxlaila.cn.key -out xxlaila.cn.crt -subj "/CN=*.xxlaila.cn"</span></span><br></pre></td></tr></table></figure><h3 id="部署准备"><a href="#部署准备" class="headerlink" title="部署准备"></a>部署准备</h3><h4 id="traefik-toml"><a href="#traefik-toml" class="headerlink" title="traefik.toml"></a>traefik.toml</h4><ul><li><p>http 和https共同存在</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/certs/xxlaila.cn.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/certs/xxlaila.cn.key"</span></span><br></pre></td></tr></table></figure></li><li><p>所有http请求全部rewrite为https的规则</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line"> <span class="built_in"> address </span>= <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line"> <span class="built_in"> address </span>= <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/certs/xxlaila.cn.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/certs/xxlaila.cn.key"</span></span><br></pre></td></tr></table></figure></li><li><p>部分域名强制跳转https</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">      regex = <span class="string">"^http://traefix.xxlaila.cn/(.*)"</span></span><br><span class="line">      replacement = <span class="string">"https://traefix.xxlaila.cn/<span class="variable">$1</span>"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/certs/xxlaila.cn.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/certs/xxlaila.cn.key"</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="创建证书secret"><a href="#创建证书secret" class="headerlink" title="创建证书secret"></a>创建证书secret</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  kubectl create secret generic traefik-cert --from-file=certs/xxlaila.cn.crt --from-file=certs/xxlaila.cn.key --from-file=certs/dev.xxlaila.cn.crt --from-file=certs/dev.xxlaila.cn.key --from-file=certs/test.xxlaila.cn.crt --from-file=certs/test.xxlaila.cn.key  -n kube-system</span></span><br><span class="line">secret/traefik-cert created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get secret traefik-cert -n kube-system </span></span><br><span class="line">NAME           TYPE     DATA   AGE</span><br><span class="line">traefik-cert   Opaque   2      26s</span><br></pre></td></tr></table></figure><ul><li>traefik-cert.yaml<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">证书base64加密</span><br><span class="line"><span class="comment"># cat dev.xxlaila.cn.crt |base64 |tr -d '\n'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat &gt; traefik-cert.yaml&lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">kind: Secert</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-cert</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  <span class="string">"dev.xxlaila.cn.crt"</span>: </span><br><span class="line">  <span class="string">"dev.xxlaila.cn.key"</span>:</span><br><span class="line">  <span class="string">"test.xxlaila.cn.crt"</span></span><br><span class="line">  <span class="string">"test.xxlaila.cn.key"</span>:</span><br><span class="line">  <span class="string">"xxlaila.cn.crt"</span>:</span><br><span class="line">  <span class="string">"xxlaila.cn.key"</span>:</span><br><span class="line"><span class="built_in">type</span>:</span><br><span class="line">  - Opaque</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="创建configmap保存traefix的配置"><a href="#创建configmap保存traefix的配置" class="headerlink" title="创建configmap保存traefix的配置"></a>创建configmap保存traefix的配置</h4><ul><li>traefik.toml<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt; traefik.toml&lt;&lt;EOF</span></span><br><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">    address = <span class="string">":80"</span></span><br><span class="line">    compress = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    [entryPoints.http.whitelist]</span><br><span class="line">      sourceRange = [<span class="string">"172.21.0.0/16"</span>, <span class="string">"172.16.0.0/16"</span>]</span><br><span class="line">      useXForwardedFor = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">      entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">    address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/opt/traefix/certs/xxlaila.cn.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/opt/traefix/certs/xxlaila.cn.key"</span></span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/opt/traefix/certs/dev.xxlaila.cn.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/opt/traefix/certs/dev.xxlaila.cn.key"</span></span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/opt/traefix/certs/test.xxlaila.cn.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/opt/traefix/certs/test.xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rules</span></span><br><span class="line">filename = <span class="string">"/opt/traefix/conf/rules.toml"</span></span><br><span class="line">watch = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create configmap traefik-conf --from-file=conf/traefik.toml -n kube-system</span></span><br><span class="line">configmap/traefik-conf created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get configmap traefik-conf -n kube-system</span></span><br><span class="line">NAME           DATA   AGE</span><br><span class="line">traefik-conf   1      25s</span><br></pre></td></tr></table></figure></li></ul><h3 id="重新部署Traefix"><a href="#重新部署Traefix" class="headerlink" title="重新部署Traefix"></a>重新部署Traefix</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;重新部署Traefix主要是要关联创建的secret和configMap，并挂载相对应的主机目录。</p><h4 id="deployment-方式部署"><a href="#deployment-方式部署" class="headerlink" title="deployment 方式部署"></a>deployment 方式部署</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;修改片段</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim traefik-deployment.yaml </span></span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: traefik-ingress-lb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      hostNetwork: <span class="literal">true</span> </span><br><span class="line">      dnsPolicy: ClusterFirstWithHostNet</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ssl</span><br><span class="line">        secret:</span><br><span class="line">          secretName: traefik-cert</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: traefik-conf</span><br><span class="line">          defaultMode: 0644</span><br><span class="line">          items:</span><br><span class="line">            - key: traefik.toml</span><br><span class="line">              path: traefik.toml</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik:v1.7</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">"/certs"</span></span><br><span class="line">          name: <span class="string">"ssl"</span></span><br><span class="line">        - mountPath: <span class="string">"/etc/traefik.toml"</span></span><br><span class="line">          subPath: <span class="string">"traefik.toml"</span></span><br><span class="line">          name: <span class="string">"config"</span></span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">            add:</span><br><span class="line">              - NET_BIND_SERVICE</span><br><span class="line">        args:</span><br><span class="line">        - --api</span><br><span class="line">        - --web</span><br><span class="line">        - --api.dashboard</span><br><span class="line">        - --web.metrics</span><br><span class="line">        - --metrics.prometheus</span><br><span class="line">        - --web.metrics.prometheus</span><br><span class="line">        - --kubernetes</span><br><span class="line">        - --logLevel=INFO</span><br><span class="line">        - --traefiklog</span><br><span class="line">        - --traefiklog.format=json</span><br><span class="line">        - --accesslog</span><br><span class="line">        - --accesslog.format=json</span><br><span class="line">        - --accessLog.fields.headers.defaultMode=redact</span><br><span class="line">        - --insecureskipverify=<span class="literal">true</span></span><br><span class="line">        - --configFile=/etc/traefik.toml</span><br><span class="line">        - --defaultentrypoints=http,https</span><br><span class="line">        - --entrypoints=Name:https Address::443 TLS</span><br><span class="line">        - --entrypoints=Name:http Address::80 </span><br><span class="line">      nodeSelector:</span><br><span class="line">        IngressProxy: <span class="string">"true"</span></span><br><span class="line">      tolerations:</span><br><span class="line">      - effect: NoSchedule</span><br><span class="line">        key: node-role.kubernetes.io/ingress</span><br><span class="line">        operator: Equal</span><br></pre></td></tr></table></figure><ul><li>执行创建<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik-deployment.yaml</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="测试ui"><a href="#测试ui" class="headerlink" title="测试ui"></a>测试ui</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;ui.yaml&lt;&lt;EOF </span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    <span class="comment">#traefik.ingress.kubernetes.io/frontend-entry-points: http,https</span></span><br><span class="line">    <span class="comment">#traefik.ingress.kubernetes.io/redirect-entry-point: https</span></span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#tls:</span></span><br><span class="line">  <span class="comment">#  - secretName: traefik-cert</span></span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;ui-test.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui-test</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui-test</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.ingress.kubernetes.io/frontend-entry-points: http,https</span><br><span class="line">    traefik.ingress.kubernetes.io/redirect-entry-point: https</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#tls:</span></span><br><span class="line">  <span class="comment">#  - secretName: traefik-cert</span></span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>注</strong>:<br>tls: traefikm默认加载的证书是tls开头的crt、key证书。如果只有一个证书，可以这么设置。多个域名证书需要设定不同的secret名称，在tls引用的时候根据不同的域名指定不同secret名称<br>redirect-entry-point: 该域名强制跳转https</p><h3 id="traefik-代理外部服务"><a href="#traefik-代理外部服务" class="headerlink" title="traefik 代理外部服务"></a>traefik 代理外部服务</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefix对外部应用提供服务，这里以公司的一个应用app和harbor为列，</p><h4 id="java-app"><a href="#java-app" class="headerlink" title="java app"></a>java app</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt; java-app.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: app-biz</span><br><span class="line">  name: app-biz</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.ingress.kubernetes.io/affinity: <span class="string">"true"</span></span><br><span class="line">    traefik.ingress.kubernetes.io/load-balancer-method: drr</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 8030</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8030</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: app-biz</span><br><span class="line">  name: app-biz</span><br><span class="line">  namespace: default</span><br><span class="line">subsets:</span><br><span class="line">- addresses:</span><br><span class="line">  - ip: 172.22.1.1</span><br><span class="line">  - ip: 172.22.1.2</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 8030</span><br><span class="line">    protocol: TCP</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: app-biz</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">    traefik.ingress.kubernetes.io/frontend-entry-points: http,https</span><br><span class="line">    traefik.ingress.kubernetes.io/redirect-entry-point: https</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: app-biz.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: app-biz</span><br><span class="line">            servicePort: 8030</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="harbor"><a href="#harbor" class="headerlink" title="harbor"></a>harbor</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;harbor.yaml&lt;&lt;EOF</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: harbor</span><br><span class="line">  name: harbor</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.ingress.kubernetes.io/affinity: <span class="string">"true"</span></span><br><span class="line">    <span class="comment">#traefik.ingress.kubernetes.io/load-balancer-method: drr</span></span><br><span class="line">spec:</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: harbor</span><br><span class="line">  name: harbor</span><br><span class="line">  namespace: default</span><br><span class="line">subsets:</span><br><span class="line">- addresses:</span><br><span class="line">  - ip: 172.21.16.90</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: harbor</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">    traefik.ingress.kubernetes.io/frontend-entry-points: http,https</span><br><span class="line">    traefik.ingress.kubernetes.io/redirect-entry-point: https</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: harbor.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: harbor</span><br><span class="line">            servicePort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;之前已经使用traefik服务作为入口，测试并访问了tomcat应用，之前是通过http来访问的，而我们在yaml文件里面也添加8443端口用于https访问，在实际环境中我们也是需要&lt;br&gt;https来进行访问应用，通过traefik实现https，&lt;a href=&quot;https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;traefik http应用&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Ingress" scheme="https://www.xxlaila.cn/categories/Ingress/"/>
    
    
      <category term="traefik" scheme="https://www.xxlaila.cn/tags/traefik/"/>
    
  </entry>
  
  <entry>
    <title>kube-eventer事件发射器</title>
    <link href="https://www.xxlaila.cn/2019/12/16/kube-eventer%E4%BA%8B%E4%BB%B6%E5%8F%91%E5%B0%84%E5%99%A8/"/>
    <id>https://www.xxlaila.cn/2019/12/16/kube-eventer事件发射器/</id>
    <published>2019-12-16T03:05:43.000Z</published>
    <updated>2019-12-23T07:21:22.010Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-eventer 是一个事件发射器，它将 Kubernetes 事件发送到接收器(例如，DingTalk、SLS、Kafka 等)。<a id="more"></a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;监控是保障系统稳定性的重要组成部分，在 Kubernetes 开源生态中，资源类的监控工具与组件百花齐放，但是，只有资源类的监控是远远不够的，因为资源监控存在如下两个主要的缺欠：</p><ul><li>监控的实时性与准确性不足</li><li>监控的场景覆盖范围不足</li></ul><p><a href="https://github.com/AliyunContainerService/kube-eventer" target="_blank" rel="noopener">详细参考</a><br><a href="http://baijiahao.baidu.com/s?id=1639090263884959561&wfr=spider&for=pc" target="_blank" rel="noopener">推荐阅读</a></p><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="kubernetes-事件查看"><a href="#kubernetes-事件查看" class="headerlink" title="kubernetes 事件查看"></a>kubernetes 事件查看</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get events</span></span><br><span class="line">LAST SEEN   TYPE      REASON                    OBJECT                                 MESSAGE</span><br><span class="line">5d20h       Normal    NodeHasSufficientMemory   node/172.21.16.110                     Node 172.21.16.110 status is now: NodeHasSufficientMemory</span><br><span class="line">5d20h       Normal    NodeHasNoDiskPressure     node/172.21.16.110                     Node 172.21.16.110 status is now: NodeHasNoDiskPressure</span><br><span class="line">5d20h       Normal    RegisteredNode            node/172.21.16.110                     Node 172.21.16.110 event: Registered Node 172.21.16.110 <span class="keyword">in</span> Controller</span><br><span class="line">5d20h       Normal    RegisteredNode            node/172.21.16.110                     Node 172.21.16.110 event: Registered Node 172.21.16.110 <span class="keyword">in</span> Controller</span><br><span class="line">5d20h       Normal    Starting                  node/172.21.16.110                     Starting kubelet.</span><br><span class="line">5d20h       Warning   Rebooted                  node/172.21.17.30                      Node 172.21.17.30 has been rebooted, boot id: f4b25a34-ace9-417a-884a-6eb52bedd4d9</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspkubernetes事件分为两类:</p><ul><li>Normal: 达到期望的状态，目前的状态一致</li><li>Warning: 状态在没有预期的情况下产生的</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下载官方的yaml文件，定一个kube-eventer.yaml文件。修改<code>command</code>参数<code>--sink=</code>。这里公司使用的是企业微信。这里使用企业微信来进行告警通知。<a href="https://github.com/AliyunContainerService/kube-eventer/blob/master/docs/en/wechat-sink.md" target="_blank" rel="noopener">企业微信参数</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- --sink=wechat:?corp_id=skjfbikssa985e28974ihjkh&amp;corp_secret=dfjkiSdsdfgL-q8hhhzqKWomFqeC_letAMYCVPsda3sdsa&amp;agent_id=1000020&amp;to_user=&amp;label=kxl&amp;level=Normal</span><br></pre></td></tr></table></figure><h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><p><img src="https://img.xxlaila.cn/1576465910400.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Tue May 05 2020 12:29:29 GMT+0800 (CST) --&gt;&lt;h3 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;kube-eventer 是一个事件发射器，它将 Kubernetes 事件发送到接收器(例如，DingTalk、SLS、Kafka 等)。
    
    </summary>
    
      <category term="kubernetes" scheme="https://www.xxlaila.cn/categories/kubernetes/"/>
    
    
      <category term="kube-eventer" scheme="https://www.xxlaila.cn/tags/kube-eventer/"/>
    
  </entry>
  
</feed>
