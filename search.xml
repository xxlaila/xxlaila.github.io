<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>mysql8.0 é”™è¯¯</title>
    <url>/2019/11/07/mysql8.0%E9%94%99%E8%AF%AF/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h4 id="mysql-8-0-å€’å…¥æ•°æ®æŠ¥é”™"><a href="#mysql-8-0-å€’å…¥æ•°æ®æŠ¥é”™" class="headerlink" title="mysql 8.0 å€’å…¥æ•°æ®æŠ¥é”™"></a>mysql 8.0 å€’å…¥æ•°æ®æŠ¥é”™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»Šå¤©æ•°æ®åº“ä»5.6åˆ‡æ¢åˆ°8.0æµ‹è¯•çš„æ—¶å€™ï¼Œå€’å…¥æ•°æ®åˆ°8.0ç‰ˆæœ¬æŠ¥é”™ï¼Œé”™è¯¯æç¤ºï¼š2006 mysql server has gone awayã€‚<a id="more"></a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç»è¿‡æŸ¥è¯¢å¾—çŸ¥ï¼Œå¯¼å…¥SQLæ•°æ®åº“ç»“æ„+æ•°æ®æ—¶ï¼Œå¦‚æœsqlæ“ä½œæ—¶é—´è¿‡é•¿ï¼›æˆ–è€…æ˜¯ä¼ é€çš„æ•°æ®å¤ªå¤§ï¼ˆå’§å¦‚ä½¿ç”¨insertâ€¦valuesçš„è¯­å¥è¿‡é•¿ï¼‰ï¼›å°±ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ã€‚ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹äº†æ•°æ®åº“è¿æ¥è¶…æ—¶çš„æ—¶é—´é»˜è®¤æ˜¯8å°æ—¶ï¼Œé—®é¢˜åº”è¯¥ä¸æ˜¯å‡ºç°åœ¨è¿™é‡Œã€‚ç™»å½•è€ç‰ˆæœ¬æ•°æ®æŸ¥çœ‹è¯¥æ•°æ®åº“è¡¨çš„æ•°æ®ï¼Œå‘ç°è¯¥è¡¨å­˜æ”¾æ˜¯jsonçš„æ•°æ®æ ¼å¼æ•°æ®ï¼Œè€Œä¸”å¾ˆå¤§ï¼Œå¾ˆé•¿ã€‚é‚£ä¹ˆé—®é¢˜ç‚¹ä¹¦æ¥äº†ï¼Œå°±å¯ä»¥è§£å†³äº†</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡ä¿®æ”¹max_allowed_packedçš„é…ç½®å‚æ•°æ¥é¿å…ï¼Œä¿®æ”¹my.cnfåŠ å¤§max_allowed_packetçš„å€¼å³å¯ã€‚</p><ul><li>è§£å†³åŠæ³•<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰¾åˆ°ä½ çš„mysqlç›®å½•ä¸‹çš„my.inié…ç½®æ–‡ä»¶ï¼ŒåŠ å…¥ä»¥ä¸‹é…ç½®æˆ–è€…ä¿®æ”¹ä»¥ä¸‹é…ç½®<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">max_allowed_packet=300M</span><br></pre></td></tr></table></figure></li></ul><h4 id="å‚æ•°è¯¦è§£"><a href="#å‚æ•°è¯¦è§£" class="headerlink" title="å‚æ•°è¯¦è§£"></a>å‚æ•°è¯¦è§£</h4><ul><li><strong>max_allowed_packet</strong>: mysqlæ ¹æ®é…ç½®æ–‡ä»¶ä¼šé™åˆ¶serveræ¥å—çš„æ•°æ®åŒ…å¤§å°ã€‚å¦‚æœä¸€æ¬¡æ’å…¥æ•°æ®åº“ä¸­çš„æ•°æ®å¤ªå¤§çš„è¯å°±ä¼šå¤±è´¥ï¼Œ<a href="https://dev.mysql.com/doc/refman/8.0/en/packet-too-large.html" target="_blank" rel="noopener">å®˜æ–¹ä»‹ç»</a>ï¼Œ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæˆ‘åˆšå¼€å§‹ä¿®æ”¹çš„æ˜¯200Mï¼Œè¿˜æ˜¯å‡ºç°è¿™ä¸ªé”™è¯¯ï¼Œç„¶åæˆ‘çœ‹äº†ä¸€ä¸‹sqlæ–‡ä»¶å¤§å°æ˜¯åœ¨260å¤šMï¼Œç´¢æ€§æˆ‘å°±æŠŠè¿™ä¸ªå‚æ•°è°ƒæ•´ä¸º300Mï¼Œåœ¨æ‰§è¡Œå€’å…¥æ•°æ®okã€‚è¿™ä¸ªå‚æ•°è°ƒå¤§ä¸ä¼šå½±å“æœåŠ¡å™¨çš„æ€§èƒ½ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹è¯´æ˜ã€‚</li></ul><h4 id="mysql-1067-Invalid-default-value-for"><a href="#mysql-1067-Invalid-default-value-for" class="headerlink" title="mysql 1067 - Invalid default value for"></a>mysql 1067 - Invalid default value for</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mysql 8.0 åœ¨å€’å…¥æ•°æ®çš„æ—¶å€™æç¤º: 1067 - Invalid default value for â€˜xxx_dateâ€™ã€‚æŸ¥è¯¢ç»“æœå¾—çŸ¥è·¨ç‰ˆæœ¬å‡çº§å¼•èµ·çš„é»˜è®¤å€¼ä¸å…¼å®¹é—®é¢˜ï¼Œç™»å½•è€æœåŠ¡å™¨æŸ¥çœ‹è¯¥å­—æ®µæ˜¯ä¸€ä¸ªæ—¶é—´å­—æ®µï¼Œæ˜¯ä¸€ä¸ªdatetimeç±»å‹ï¼Œè€Œä¸”é»˜è®¤æ˜¯0ï¼Œç„¶åçœ‹äº†ä¸€ä¸‹å¯¼å‡ºçš„æ•°æ®æ•°æ®æ ¼å¼å±…ç„¶æ˜¯0000-00-00ï¼Œè¯¥ç±»å‹å¯èƒ½æ˜¯é»˜è®¤å€¼è¢«é™åˆ¶äº†ï¼ŒæŸ¥çœ‹ sql_modeã€‚</p><h5 id="æŸ¥çœ‹-sql-mode"><a href="#æŸ¥çœ‹-sql-mode" class="headerlink" title="æŸ¥çœ‹ sql_mode"></a>æŸ¥çœ‹ sql_mode</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'sql_mode'</span>;</span><br><span class="line">+---------------+-----------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                 |</span><br><span class="line">+---------------+-----------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+-----------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.02 sec)</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NO_ZERO_IN_DATE,NO_ZERO_DATEè¿™ä¸¤ä¸ªå‚æ•°é™åˆ¶æ—¶é—´ä¸èƒ½ä¸º0</p><h5 id="ä¸´æ—¶ä¿®æ”¹"><a href="#ä¸´æ—¶ä¿®æ”¹" class="headerlink" title="ä¸´æ—¶ä¿®æ”¹"></a>ä¸´æ—¶ä¿®æ”¹</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> session sql_mode=<span class="string">'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæˆ‘æ“ä½œäº†ï¼Œæ²¡æˆåŠŸï¼Œæˆ‘ç”¨çš„æ°¸ä¹…ä¿®æ”¹æˆåŠŸå¯¼å…¥çš„ã€‚ä¸çŸ¥é“ä¸ºå•¥ï¼Œå¯èƒ½æ˜¯å§¿åŠ¿ä¸å¯¹</p><h5 id="æ°¸ä¹…ä¿®æ”¹"><a href="#æ°¸ä¹…ä¿®æ”¹" class="headerlink" title="æ°¸ä¹…ä¿®æ”¹"></a>æ°¸ä¹…ä¿®æ”¹</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥ç›´æ¥ä¿®æ”¹my.cnfæ–‡ä»¶ï¼Œåœ¨[mysqld]ä¸‹é¢æ·»åŠ å¦‚ä¸‹åˆ—ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sql_mode=ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>istioéƒ¨ç½²</title>
    <url>/2019/10/29/istio%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="Istioä»‹ç»"><a href="#Istioä»‹ç»" class="headerlink" title="Istioä»‹ç»"></a>Istioä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;istioä»£è¡¨çš„æ˜¯Service Meshçš„æ–¹æ¡ˆå®ç°ï¼ŒIstio æœ‰åŠ©äºé™ä½è¿™äº›éƒ¨ç½²çš„å¤æ‚æ€§ï¼Œå¹¶å‡è½»å¼€å‘å›¢é˜Ÿçš„å‹åŠ›ã€‚æä¾›ä¸€ç§ç®€å•çš„æ–¹å¼æ¥ä¸ºå·²éƒ¨ç½²çš„æœåŠ¡å»ºç«‹ç½‘ç»œï¼Œä¸”æä¾›å…·æœ‰è´Ÿè½½å‡è¡¡ã€æœåŠ¡é—´è®¤è¯ã€ç›‘æ§ã€æµé‡ç®¡ç†ç­‰åŠŸèƒ½ã€‚</p><a id="more"></a><h3 id="æœåŠ¡ç½‘æ ¼ï¼ˆService-Meshï¼‰"><a href="#æœåŠ¡ç½‘æ ¼ï¼ˆService-Meshï¼‰" class="headerlink" title="æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰"></a>æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰ç”¨äºæè¿°æ„æˆè¿™äº›åº”ç”¨ç¨‹åºçš„å¾®æœåŠ¡ç½‘ç»œä»¥åŠåº”ç”¨ä¹‹é—´çš„äº¤äº’ã€‚éšç€è§„æ¨¡å’Œå¤æ‚æ€§çš„å¢é•¿ï¼ŒæœåŠ¡ç½‘æ ¼è¶Šæ¥è¶Šéš¾ä»¥ç†è§£å’Œç®¡ç†ã€‚å®ƒçš„éœ€æ±‚åŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœæ¢å¤ã€æŒ‡æ ‡æ”¶é›†å’Œç›‘æ§ä»¥åŠé€šå¸¸æ›´åŠ å¤æ‚çš„è¿ç»´éœ€æ±‚ï¼Œä¾‹å¦‚ A/B æµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒã€é™æµã€è®¿é—®æ§åˆ¶å’Œç«¯åˆ°ç«¯è®¤è¯ç­‰ã€‚è€Œistioåˆšå¥½æä¾›äº†ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡æ§åˆ¶æ•´ä¸ªæœåŠ¡å™¨ç½‘æ ¼æä¾›è¡Œä¸ºæ´å¯Ÿå’Œæ“ä½œæ§åˆ¶æ¥æ»¡è¶³å¾®æœåŠ¡åº”ç”¨çš„å¤šæ ·åŒ–</p><h3 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio æœåŠ¡ç½‘æ ¼é€»è¾‘ä¸Šåˆ†ä¸ºæ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ã€‚</p><ul><li>æ•°æ®å¹³é¢ç”±ä¸€ç»„ä»¥ sidecar æ–¹å¼éƒ¨ç½²çš„æ™ºèƒ½ä»£ç†ï¼ˆEnvoyï¼‰ç»„æˆã€‚è¿™äº›ä»£ç†å¯ä»¥è°ƒèŠ‚å’Œæ§åˆ¶å¾®æœåŠ¡åŠ Mixer ä¹‹é—´æ‰€æœ‰çš„ç½‘ç»œé€šä¿¡ã€‚</li><li>æ§åˆ¶å¹³é¢è´Ÿè´£ç®¡ç†å’Œé…ç½®ä»£ç†æ¥è·¯ç”±æµé‡ã€‚æ­¤å¤–æ§åˆ¶å¹³é¢é…ç½® Mixer ä»¥å®æ–½ç­–ç•¥å’Œæ”¶é›†é¥æµ‹æ•°æ®ã€‚</li></ul><p>æ„æˆæ¯ä¸ªé¢æ¿çš„ä¸åŒç»„ä»¶:<br><img src="https://img.xxlaila.cn/1567136153850.jpg" alt="img"></p><h4 id="istio-ç»„ä»¶"><a href="#istio-ç»„ä»¶" class="headerlink" title="istio ç»„ä»¶"></a>istio ç»„ä»¶</h4><ul><li>Envoy: Istio ä½¿ç”¨ Envoy ä»£ç†çš„æ‰©å±•ç‰ˆæœ¬ï¼Œç”¨äºè°ƒè§£æœåŠ¡ç½‘æ ¼ä¸­æ‰€æœ‰æœåŠ¡çš„æ‰€æœ‰å…¥ç«™å’Œå‡ºç«™æµé‡ï¼Œå±äºæ•°æ®å±‚é¢ã€‚Istioåˆ©ç”¨Envoyçš„å†…ç½®åŠŸèƒ½å®ç°å¦‚ä¸‹æŒ‡æ ‡:<ul><li>åŠ¨æ€æœåŠ¡å‘ç°</li><li>è´Ÿè½½å‡è¡¡</li><li>TLSç»ˆæ­¢</li><li>HTTP/2å’ŒgRPCä»£ç†</li><li>æ–­è·¯å™¨</li><li>å¥åº·æ£€æŸ¥</li><li>åˆ†é˜¶æ®µæ¨å‡ºï¼ŒæŒ‰ç™¾åˆ†æ¯”åˆ†é…æµé‡</li><li>æ•…éšœæ³¨å…¥</li><li>ä¸°å¯Œçš„æŒ‡æ ‡</li></ul></li><li>Mixer: æ˜¯ä¸€ä¸ªç‹¬ç«‹äºå¹³å°çš„ç»„ä»¶ï¼Œè´Ÿè´£åœ¨æœåŠ¡ç½‘æ ¼ä¸Šæ‰§è¡Œè®¿é—®æ§åˆ¶å’Œä½¿ç”¨ç­–ç•¥ï¼Œå¹¶ä» Envoy ä»£ç†å’Œå…¶ä»–æœåŠ¡æ”¶é›†é¥æµ‹æ•°æ®</li><li>Pilot: ä¸º Envoy sidecar æä¾›æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œä¸ºæ™ºèƒ½è·¯ç”±ï¼ˆä¾‹å¦‚ A/B æµ‹è¯•ã€é‡‘ä¸é›€éƒ¨ç½²ç­‰ï¼‰å’Œå¼¹æ€§ï¼ˆè¶…æ—¶ã€é‡è¯•ã€ç†”æ–­å™¨ç­‰ï¼‰æä¾›æµé‡ç®¡ç†åŠŸèƒ½</li><li>Citadel: é€šè¿‡å†…ç½®èº«ä»½å’Œå‡­è¯ç®¡ç†èµ‹èƒ½å¼ºå¤§çš„æœåŠ¡é—´å’Œæœ€ç»ˆç”¨æˆ·èº«ä»½éªŒè¯ã€‚å¯ç”¨äºå‡çº§æœåŠ¡ç½‘æ ¼ä¸­æœªåŠ å¯†çš„æµé‡ï¼Œå¹¶ä¸ºè¿ç»´äººå‘˜æä¾›åŸºäºæœåŠ¡æ ‡è¯†è€Œä¸æ˜¯ç½‘ç»œæ§åˆ¶çš„å¼ºåˆ¶æ‰§è¡Œç­–ç•¥çš„èƒ½åŠ›</li><li>Galley: ä»£è¡¨å…¶ä»–çš„ Istio æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œç”¨æ¥éªŒè¯ç”¨æˆ·ç¼–å†™çš„ Istio API é…ç½®ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒGalley å°†æ¥ç®¡ Istio è·å–é…ç½®ã€ å¤„ç†å’Œåˆ†é…ç»„ä»¶çš„é¡¶çº§è´£ä»»</li></ul><h3 id="Istion-å®‰è£…"><a href="#Istion-å®‰è£…" class="headerlink" title="Istion å®‰è£…"></a>Istion å®‰è£…</h3><h4 id="ä¸‹è½½istioåŒ…"><a href="#ä¸‹è½½istioåŒ…" class="headerlink" title="ä¸‹è½½istioåŒ…"></a>ä¸‹è½½istioåŒ…</h4><p>æ‰§è¡Œä¸‹è½½å’Œè‡ªåŠ¨è§£å‹ç¼©</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://git.io/getLatestIstio | ISTIO_VERSION=1.2.8 sh -</span></span><br><span class="line"><span class="comment"># cd istio-1.2.8/bin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp istioctl /usr/bin/</span></span><br></pre></td></tr></table></figure><p>å®‰è£…ç›®å½•ä¸­åŒ…å«ï¼š</p><ul><li><code>åœ¨ install/</code>: ç›®å½•ä¸­åŒ…å«äº† Kubernetes å®‰è£…æ‰€éœ€çš„ .yaml æ–‡ä»¶</li><li><code>samples/</code>: ç›®å½•ä¸­æ˜¯ç¤ºä¾‹åº”ç”¨</li><li><code>istioctl</code>: istioctlå®¢æˆ·ç«¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ‰‹åŠ¨å°†Envoyä½œä¸ºSidecarä»£ç†æ³¨å…¥å¹¶åˆ›å»ºè·¯ç”±è§„åˆ™å’Œç­–ç•¥æ—¶ï¼Œå°†ä½¿ç”¨æ­¤å·¥å…·ã€‚</li><li><code>istio.VERSION</code>: é…ç½®æ–‡ä»¶</li></ul><h3 id="åœ¨kubernetes-é›†ç¾¤ä¸­å®‰è£…"><a href="#åœ¨kubernetes-é›†ç¾¤ä¸­å®‰è£…" class="headerlink" title="åœ¨kubernetes é›†ç¾¤ä¸­å®‰è£…"></a>åœ¨kubernetes é›†ç¾¤ä¸­å®‰è£…</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio ä¼šè¢«å®‰è£…åˆ°è‡ªå·±çš„ istio-system å‘½åç©ºé—´ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¯¹æ‰€æœ‰å…¶ä»–å‘½åç©ºé—´çš„æœåŠ¡è¿›è¡Œç®¡ç†ã€‚è¿™é‡Œé‡‡ç”¨helmè¿›è¡Œå®‰è£…ï¼Œ<a href="https://xxlaila.github.io/2019/09/04/k8s-helm/" target="_blank" rel="noopener">helmå®‰è£…å‚è€ƒ</a>ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºKialiè®¾ç½®èº«ä»½éªŒè¯å‡­æ®ï¼ˆç›‘è§†ï¼‰ã€‚ç”¨äºåé¢çš„ç™»å½•è®¤è¯</p><h4 id="è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡"><a href="#è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡" class="headerlink" title="è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡"></a>è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># KIALI_USERNAME=$(read -p 'Kiali Username: ' uval &amp;&amp; echo -n $uval | base64)</span></span><br><span class="line"><span class="comment"># KIALI_PASSPHRASE=$(read -sp 'Kiali Passphrase: ' pval &amp;&amp; echo -n $pval | base64)</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºå‘½åç©ºé—´"><a href="#åˆ›å»ºå‘½åç©ºé—´" class="headerlink" title="åˆ›å»ºå‘½åç©ºé—´"></a>åˆ›å»ºå‘½åç©ºé—´</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># NAMESPACE=istio-system</span></span><br><span class="line"><span class="comment"># kubectl create namespace $NAMESPACE</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºç”¨äºå­˜å‚¨ä¸Šé¢è®¾ç½®çš„ç”¨æˆ·å/å¯†ç çš„æœºå¯†<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: kiali</span><br><span class="line">  namespace: <span class="variable">$NAMESPACE</span></span><br><span class="line">  labels:</span><br><span class="line">    app: kiali</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  username: <span class="variable">$KIALI_USERNAME</span></span><br><span class="line">  passphrase: <span class="variable">$KIALI_PASSPHRASE</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="ä½¿ç”¨helmå®‰è£…istio-CRD"><a href="#ä½¿ç”¨helmå®‰è£…istio-CRD" class="headerlink" title="ä½¿ç”¨helmå®‰è£…istio CRD"></a>ä½¿ç”¨helmå®‰è£…istio CRD</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm install install/kubernetes/helm/istio-init --name istio-init --namespace istio-system</span></span><br><span class="line">NAME:   istio-init</span><br><span class="line">LAST DEPLOYED: Fri Nov  1 10:13:22 2019</span><br><span class="line">NAMESPACE: istio-system</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/ClusterRole</span><br><span class="line">NAME                     AGE</span><br><span class="line">istio-init-istio-system  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ClusterRoleBinding</span><br><span class="line">NAME                                        AGE</span><br><span class="line">istio-init-admin-role-binding-istio-system  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME          DATA  AGE</span><br><span class="line">istio-crd-10  1     0s</span><br><span class="line">istio-crd-11  1     0s</span><br><span class="line">istio-crd-12  1     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Job</span><br><span class="line">NAME                     COMPLETIONS  DURATION  AGE</span><br><span class="line">istio-init-crd-10-1.2.8  0/1          0s</span><br><span class="line">istio-init-crd-11-1.2.8  0/1          0s</span><br><span class="line">istio-init-crd-12-1.2.8  0/1          0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ServiceAccount</span><br><span class="line">NAME                        SECRETS  AGE</span><br><span class="line">istio-init-service-account  0        0s</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod"><a href="#æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod" class="headerlink" title="æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod"></a>æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¿°å®‰è£…ä¼šæŠŠistioçš„23ä¸ªcrdéƒ½æäº¤ç»™kubernetes api æœåŠ¡å™¨ã€‚å¦‚æœå¯ç”¨äº†è¯ä¹¦ç®¡ç†ï¼Œcrdè®¡æ•°å™¨ä¸º28ä¸ªã€‚æˆ‘è¿™é‡Œæœªå¯ç”¨è¯ä¹¦ç®¡ç†ï¼Œåªæœ‰23ä¸ªã€‚è¿˜ç”Ÿæˆä¸‰ä¸ªpod</p><ul><li><p>CRD</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get CustomResourceDefinition</span></span><br><span class="line">NAME                                   CREATED AT</span><br><span class="line">adapters.config.istio.io               2019-10-29T08:41:31Z</span><br><span class="line">attributemanifests.config.istio.io     2019-10-29T08:41:30Z</span><br><span class="line">authorizationpolicies.rbac.istio.io    2019-10-29T08:41:36Z</span><br><span class="line">certificates.certmanager.k8s.io        2019-10-29T08:41:38Z</span><br><span class="line">challenges.certmanager.k8s.io          2019-10-29T08:41:40Z</span><br><span class="line">clusterissuers.certmanager.k8s.io      2019-10-29T08:41:37Z</span><br><span class="line">clusterrbacconfigs.rbac.istio.io       2019-10-29T08:41:26Z</span><br><span class="line">destinationrules.networking.istio.io   2019-10-29T08:41:25Z</span><br><span class="line">envoyfilters.networking.istio.io       2019-10-29T08:41:26Z</span><br><span class="line">gateways.networking.istio.io           2019-10-29T08:41:26Z</span><br><span class="line">handlers.config.istio.io               2019-10-29T08:41:33Z</span><br><span class="line">httpapispecbindings.config.istio.io    2019-10-29T08:41:27Z</span><br><span class="line">httpapispecs.config.istio.io           2019-10-29T08:41:28Z</span><br><span class="line">instances.config.istio.io              2019-10-29T08:41:32Z</span><br><span class="line">issuers.certmanager.k8s.io             2019-10-29T08:41:37Z</span><br><span class="line">meshpolicies.authentication.istio.io   2019-10-29T08:41:27Z</span><br><span class="line">orders.certmanager.k8s.io              2019-10-29T08:41:40Z</span><br><span class="line">policies.authentication.istio.io       2019-10-29T08:41:27Z</span><br><span class="line">quotaspecbindings.config.istio.io      2019-10-29T08:41:28Z</span><br><span class="line">quotaspecs.config.istio.io             2019-10-29T08:41:29Z</span><br><span class="line">rbacconfigs.rbac.istio.io              2019-10-29T08:41:31Z</span><br><span class="line">rules.config.istio.io                  2019-10-29T08:41:30Z</span><br><span class="line">serviceentries.networking.istio.io     2019-10-29T08:41:25Z</span><br><span class="line">servicerolebindings.rbac.istio.io      2019-10-29T08:41:31Z</span><br><span class="line">serviceroles.rbac.istio.io             2019-10-29T08:41:31Z</span><br><span class="line">sidecars.networking.istio.io           2019-10-29T08:41:34Z</span><br><span class="line">templates.config.istio.io              2019-10-29T08:41:32Z</span><br><span class="line">virtualservices.networking.istio.io    2019-10-29T08:41:25Z</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get crds | grep 'istio.io\|certmanager.k8s.io' | wc -l</span></span><br><span class="line">23</span><br></pre></td></tr></table></figure></li><li><p>pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">NAME                            READY   STATUS      RESTARTS   AGE</span><br><span class="line">istio-init-crd-10-1.2.8-pbtb8   0/1     Completed   0          47s</span><br><span class="line">istio-init-crd-11-1.2.8-shx6q   0/1     Completed   0          47s</span><br><span class="line">istio-init-crd-12-1.2.8-zmh2w   0/1     Completed   0          47s</span><br></pre></td></tr></table></figure></li></ul><h4 id="ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶"><a href="#ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶" class="headerlink" title="ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶"></a>ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install install/kubernetes/helm/istio --<span class="built_in">wait</span> \</span><br><span class="line">    --name istio \</span><br><span class="line">    --namespace istio-system \</span><br><span class="line">    --<span class="built_in">set</span> global.mtls.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> tracing.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> grafana.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> servicegraph.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> global.k8sIngress.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> global.k8sIngress.gatewayName=ingressgateway \</span><br><span class="line">    --<span class="built_in">set</span> grafana.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.createDemoSecret=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.contextPath=/ \</span><br><span class="line">    --<span class="built_in">set</span> <span class="string">"kiali.dashboard.jaegerURL=http://jaeger-query:16686"</span> \</span><br><span class="line">    --<span class="built_in">set</span> <span class="string">"kiali.dashboard.grafanaURL=http://grafana:3000"</span> \</span><br><span class="line">    --<span class="built_in">set</span> gateways.istio-ingressgateway.type=NodePort \</span><br><span class="line">    --<span class="built_in">set</span> gateways.istio-egressgateway.type=NodePort \</span><br><span class="line">    --<span class="built_in">set</span> sidecarInjectorWebhook.enabled=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="éªŒè¯å®‰è£…"><a href="#éªŒè¯å®‰è£…" class="headerlink" title="éªŒè¯å®‰è£…"></a>éªŒè¯å®‰è£…</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éªŒè¯æ–‡ä»¶é‡Œé¢çš„æœåŠ¡æ˜¯å¦éƒ½éƒ¨ç½²åœ¨kubernetes æœåŠ¡ä¸­ã€‚ç¡®ä¿éƒ¨ç½²çš„pod åœ¨å¯¹åº”çš„kubernetes namespace é‡Œé¢ï¼Œå¹¶æ­£å¸¸å¯åŠ¨ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æœŸé—´å°†åˆ›å»ºæ‰€éœ€çš„RBACæƒé™ï¼Œå¹¶éƒ¨ç½²Istio-Pilotï¼ŒIstio-Mixerï¼ŒIstio-Ingressï¼ŒIstio-Egresså’ŒIstio-CAï¼ˆè¯ä¹¦é¢å‘æœºæ„ï¼‰ã€‚</p><h5 id="æœåŠ¡å™¨éªŒè¯"><a href="#æœåŠ¡å™¨éªŒè¯" class="headerlink" title="æœåŠ¡å™¨éªŒè¯"></a>æœåŠ¡å™¨éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®ä¿éƒ¨ç½²äº†ä»¥ä¸‹KubernetesæœåŠ¡ï¼šistio-pilotï¼Œistio-mixerï¼Œistio-ingressã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc -n istio-system</span></span><br><span class="line">NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                                                      AGE</span><br><span class="line">grafana                  ClusterIP   10.254.113.150   &lt;none&gt;        3000/TCP                                                                                                                                     3h22m</span><br><span class="line">istio-citadel            ClusterIP   10.254.27.143    &lt;none&gt;        8060/TCP,15014/TCP                                                                                                                           3h22m</span><br><span class="line">istio-galley             ClusterIP   10.254.155.177   &lt;none&gt;        443/TCP,15014/TCP,9901/TCP                                                                                                                   3h22m</span><br><span class="line">istio-ingressgateway     NodePort    10.254.170.109   &lt;none&gt;        15020:31952/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32532/TCP,15030:31518/TCP,15031:31525/TCP,15032:30404/TCP,15443:30309/TCP   3h22m</span><br><span class="line">istio-pilot              ClusterIP   10.254.228.182   &lt;none&gt;        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       3h22m</span><br><span class="line">istio-policy             ClusterIP   10.254.13.184    &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP                                                                                                                 3h22m</span><br><span class="line">istio-sidecar-injector   ClusterIP   10.254.154.169   &lt;none&gt;        443/TCP                                                                                                                                      3h22m</span><br><span class="line">istio-telemetry          ClusterIP   10.254.71.72     &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       3h22m</span><br><span class="line">jaeger-agent             ClusterIP   None             &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP                                                                                                                   3h22m</span><br><span class="line">jaeger-collector         ClusterIP   10.254.100.29    &lt;none&gt;        14267/TCP,14268/TCP                                                                                                                          3h22m</span><br><span class="line">jaeger-query             ClusterIP   10.254.18.117    &lt;none&gt;        16686/TCP                                                                                                                                    3h22m</span><br><span class="line">kiali                    ClusterIP   10.254.156.117   &lt;none&gt;        20001/TCP                                                                                                                                    3h22m</span><br><span class="line">prometheus               ClusterIP   10.254.145.181   &lt;none&gt;        9090/TCP                                                                                                                                     3h22m</span><br><span class="line">tracing                  ClusterIP   10.254.87.72     &lt;none&gt;        80/TCP                                                                                                                                       3h22m</span><br><span class="line">zipkin                   ClusterIP   10.254.39.22     &lt;none&gt;        9411/TCP                                                                                                                                     3h22m</span><br></pre></td></tr></table></figure><h5 id="pod-éªŒè¯"><a href="#pod-éªŒè¯" class="headerlink" title="pod éªŒè¯"></a>pod éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®ä¿å·²éƒ¨ç½²ç›¸åº”çš„Kubernetes Podï¼Œå¹¶ä¸”æ‰€æœ‰å®¹å™¨éƒ½å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">grafana-6fb9f8c5c7-n2plk                  1/1     Running     0          3h19m</span><br><span class="line">istio-citadel-7c9b84ddb6-n5h2n            1/1     Running     0          3h19m</span><br><span class="line">istio-galley-64f7d8cc97-zdbb6             1/1     Running     0          3h19m</span><br><span class="line">istio-grafana-post-install-1.2.8-98grv    0/1     Completed   0          3h19m</span><br><span class="line">istio-ingressgateway-65c7498b78-dfmfp     1/1     Running     0          3h19m</span><br><span class="line">istio-init-crd-10-1.2.8-wxxjn             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-11-1.2.8-brjhh             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-12-1.2.8-w8wnc             0/1     Completed   0          3h20m</span><br><span class="line">istio-pilot-569499d666-vhgn5              2/2     Running     0          3h19m</span><br><span class="line">istio-policy-5dbbc56db5-dmr4p             2/2     Running     3          3h19m</span><br><span class="line">istio-sidecar-injector-747cf74498-99drh   1/1     Running     0          3h19m</span><br><span class="line">istio-telemetry-7db5dd4c57-zngq7          2/2     Running     4          3h19m</span><br><span class="line">istio-tracing-5d8f57c8ff-vt2kn            1/1     Running     0          3h19m</span><br><span class="line">kiali-7d749f9dcb-68tlt                    1/1     Running     0          3h19m</span><br><span class="line">prometheus-776fdf7479-zbrxl               1/1     Running     0          3h19m</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio ä»¥ä¸€ä¸ªé¡¹ç›®çš„å½¢å¼éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œéƒ¨ç½²å¥½çš„ pods ä¸­ï¼Œé™¤äº†æœ‰ istio-citadelã€ã€istio-ingressgatewayã€istio-pilot ç­‰ Istio æœ¬èº«çš„åŠŸèƒ½ç»„ä»¶ï¼Œè¿˜é›†æˆäº†å¾®æœåŠ¡ç›¸å…³çš„ç›‘æ§å·¥å…·ï¼Œï¼Œå¦‚ï¼šgrafanaã€jaeger-queryã€kialiã€prometheusã€‚è¿™äº›åŠŸèƒ½ä¸°å¯Œä¸”å¼ºå¤§çš„ç›‘æ§å·¥å…·ï¼Œå¸®åŠ© Istioå®ç°äº†å¾®æœåŠ¡çš„å¯è§†åŒ–ç®¡ç†ã€‚</p><h3 id="éƒ¨ç½²BookInfoç”¨ç¨‹åº"><a href="#éƒ¨ç½²BookInfoç”¨ç¨‹åº" class="headerlink" title="éƒ¨ç½²BookInfoç”¨ç¨‹åº"></a>éƒ¨ç½²BookInfoç”¨ç¨‹åº</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨å¼€å§‹éƒ¨ç½² Bookinfo ç¤ºä¾‹ç¨‹åºã€‚éƒ¨ç½²Bookinfoæ¡ä»¶æ˜¯é›†ç¾¤ä¸­è‡³å°‘æœ‰4ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸”æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸å¾—ä½äº4Gã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥éƒ¨ç½²å®‰è£…éšé™„çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºä¹‹ä¸€-BookInfoã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿä¹¦åº—åº”ç”¨ç¨‹åºï¼Œç”±å››ä¸ªæœåŠ¡ç»„æˆï¼Œè¿™äº›æœåŠ¡æä¾›ä¸€ä¸ªWebäº§å“é¡µé¢ï¼Œä¹¦ç±è¯¦ç»†ä¿¡æ¯ï¼Œè¯„è®ºï¼ˆå¸¦æœ‰å¤šä¸ªç‰ˆæœ¬çš„è¯„è®ºæœåŠ¡ï¼‰å’Œè¯„åˆ†-æ‰€æœ‰è¿™äº›éƒ½ä½¿ç”¨Istioè¿›è¡Œç®¡ç†ã€‚</p><ul><li><p>BookInfoåº”ç”¨ç¨‹åºåˆ†ä¸ºå››ä¸ªå•ç‹¬çš„å¾®æœåŠ¡:</p><ul><li>productpage ï¼šproductpage å¾®æœåŠ¡ä¼šè°ƒç”¨ details å’Œ reviews ä¸¤ä¸ªå¾®æœåŠ¡ï¼Œç”¨æ¥ç”Ÿæˆé¡µé¢ã€‚</li><li>details ï¼šè¿™ä¸ªå¾®æœåŠ¡åŒ…å«äº†ä¹¦ç±çš„ä¿¡æ¯ã€‚</li><li>reviews ï¼šè¿™ä¸ªå¾®æœåŠ¡åŒ…å«äº†ä¹¦ç±ç›¸å…³çš„è¯„è®ºã€‚å®ƒè¿˜ä¼šè°ƒç”¨ ratings å¾®æœåŠ¡ã€‚</li><li>ratings ï¼šratings å¾®æœåŠ¡ä¸­åŒ…å«äº†ç”±ä¹¦ç±è¯„ä»·ç»„æˆçš„è¯„çº§ä¿¡æ¯ã€‚</li></ul></li><li><p>reviews å¾®æœåŠ¡æœ‰ 3 ä¸ªç‰ˆæœ¬ï¼š</p><ul><li>v1 ç‰ˆæœ¬ä¸ä¼šè°ƒç”¨ ratings æœåŠ¡.</li><li>v2 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªé»‘è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li><li>v3 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªçº¢è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li></ul></li><li><p>ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸ªåº”ç”¨çš„ç«¯åˆ°ç«¯æ¶æ„<br><img src="https://img.xxlaila.cn/1572576628250.jpg" alt="img"></p></li></ul><h4 id="æ‰“æ ‡ç­¾"><a href="#æ‰“æ ‡ç­¾" class="headerlink" title="æ‰“æ ‡ç­¾"></a>æ‰“æ ‡ç­¾</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸º default å‘½åç©ºé—´æ‰“ä¸Šæ ‡ç­¾ istio-injection=enabledï¼Œå®ç° Sidecar è‡ªåŠ¨æ³¨å…¥ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label namespace default istio-injection=enabled</span></span><br><span class="line">namespace/default labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get namespace --show-labels</span></span><br><span class="line">NAME              STATUS   AGE   LABELS</span><br><span class="line">default           Active   43d   istio-injection=enabled</span><br><span class="line">istio-system      Active   29m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   43d   &lt;none&gt;</span><br><span class="line">kube-public       Active   43d   &lt;none&gt;</span><br><span class="line">kube-system       Active   43d   &lt;none&gt;</span><br><span class="line">monitoring        Active   35d   &lt;none&gt;</span><br><span class="line">weave             Active   35d   &lt;none&gt;</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„:</strong> æ­¤æ­¥éª¤å…ˆä¸æ‰§è¡Œï¼Œå¦‚æœè¿™è¿™ä¸ªæ‰§è¡Œäº†ï¼Œåœ¨åé¢éƒ¨ç½²Bookinfoçš„æ—¶å€™ä¼šæç¤ºå¦‚ä¸‹é”™è¯¯<code>Error creating: Internal error occurred: failed calling webhook &quot;sidecar-injector.istio.io&quot;: Post https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</code>è¿™ä¸€æ­¥æœ‰æ‰§è¡Œçš„å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œåˆ é™¤</li></ul><ul><li>åˆ é™¤nsçš„label<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get ns --show-labels</span></span><br><span class="line">NAME              STATUS   AGE    LABELS</span><br><span class="line">default           Active   2d4h   istio-injection=enabled</span><br><span class="line">istio-system      Active   174m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-public       Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-system       Active   2d4h   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl label namespace default istio-injection-</span></span><br><span class="line">namespace/default labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get ns --show-labels</span></span><br><span class="line">NAME              STATUS   AGE    LABELS</span><br><span class="line">default           Active   2d4h   &lt;none&gt;</span><br><span class="line">istio-system      Active   175m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-public       Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-system       Active   2d4h   &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><h4 id="éƒ¨ç½²Bookinfo"><a href="#éƒ¨ç½²Bookinfo" class="headerlink" title="éƒ¨ç½²Bookinfo"></a>éƒ¨ç½²Bookinfo</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›´æ¥ä½¿ç”¨kubectl createå…¶å¸¸è§„çš„YAMLéƒ¨ç½²æ–‡ä»¶æ¥éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚å°†ä½¿ç”¨istioctlå°†Envoyå®¹å™¨æ³¨å…¥åˆ°åº”ç”¨ç¨‹åºå®¹å™¨ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)</span></span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥å‘½ä»¤å°†å¯åŠ¨bookinfoåº”ç”¨ç¨‹åºä½“ç³»ç»“æ„å›¾ä¸­æ˜¾ç¤ºçš„æ‰€æœ‰å››ä¸ªæœåŠ¡ã€‚å·²å¯åŠ¨è¯„è®ºæœåŠ¡çš„æ‰€æœ‰3ä¸ªç‰ˆæœ¬ï¼Œå³v1ï¼Œv2å’Œv3ã€‚è€Œåœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ä¼šéƒ¨ç½²æ–°ç‰ˆæœ¬çš„å¾®æœåŠ¡ï¼Œè€Œä¸æ˜¯åŒæ—¶éƒ¨ç½²æ‰€æœ‰ç‰ˆæœ¬ã€‚</p><h4 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®è®¤æ‰€æœ‰æœåŠ¡å’ŒPodå‡å·²æ­£ç¡®å®šä¹‰å¹¶æ­£åœ¨è¿è¡Œã€‚</p><ul><li><p>æ£€æŸ¥ services</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   10.254.61.113    &lt;none&gt;        9080/TCP   2m27s</span><br><span class="line">kubernetes    ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP    43d</span><br><span class="line">productpage   ClusterIP   10.254.130.5     &lt;none&gt;        9080/TCP   2m23s</span><br><span class="line">ratings       ClusterIP   10.254.186.181   &lt;none&gt;        9080/TCP   2m26s</span><br><span class="line">reviews       ClusterIP   10.254.200.107   &lt;none&gt;        9080/TCP   2m25s</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥ pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-c5b5f496d-lphgd        1/1     Running   0          15h</span><br><span class="line">load-generator-7fbcc7489f-vbpnx   1/1     Running   2          20d</span><br><span class="line">nginx-deploy-d494b9564-vx97s      1/1     Running   1          20d</span><br><span class="line">productpage-v1-c7765c886-97spj    1/1     Running   0          15h</span><br><span class="line">ratings-v1-f745cf57b-mdgxr        1/1     Running   0          15h</span><br><span class="line">reviews-v1-75b979578c-ghqqm       1/1     Running   0          15h</span><br><span class="line">reviews-v2-597bf96c8f-r659w       1/1     Running   0          15h</span><br><span class="line">reviews-v3-54c6c64795-tvsmq       1/1     Running   0          15h</span><br></pre></td></tr></table></figure></li><li><p>ç¡®è®¤Bookinfoåº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œè¯·é€šè¿‡curlæŸä¸ªpodä¸­çš„å‘½ä»¤å‘å…¶å‘é€è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec -it $(kubectl get pod -l app=ratings -o jsonpath='&#123;.items[0].metadata.name&#125;') -c ratings -- curl productpage:9080/productpage | grep -o "&lt;title&gt;.*&lt;/title&gt;"</span></span><br><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ¯ä¸ªæœåŠ¡æ—è¾¹éƒ½æ³¨å…¥äº†Envoyï¼Œæ¶æ„å°†å¦‚ä¸‹<br><img src="https://img.xxlaila.cn/1572577460804.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BookinfoæœåŠ¡å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œï¼Œæ‚¨éœ€è¦ä½¿è¯¥åº”ç”¨ç¨‹åºå¯ä»¥ä»Kubernetesé›†ç¾¤å¤–éƒ¨è®¿é—®ï¼Œä¾‹å¦‚ï¼Œä»æµè§ˆå™¨è®¿é—®ã€‚Istioç½‘å…³ç”¨äºæ­¤ç›®çš„ã€‚ä½†æ˜¯æˆ‘åœ¨éƒ¨ç½² bookinfo-gateway çš„æ—¶å€™å‡ºç°é”™è¯¯ï¼Œé”™è¯¯å¦‚ä¸‹ï¼›ç„¶åçœ‹äº†ä¸€ä¸‹ bookinfo-gatewayå°±æ˜¯æä¾›ä¸€ä¸ªwebè®¿é—®çš„ç¨‹åºï¼Œæ—¢ç„¶æ˜¯æä¾›çš„ä¸€ä¸ªwebè®¿é—®ï¼Œæˆ‘å°±ä½¿ç”¨äº†Traefixæ¥æä¾›è¿™ä¸ªæœåŠ¡ã€‚</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Timeout): <span class="builtin-name">error</span> when creating <span class="string">"samples/bookinfo/networking/bookinfo-gateway.yaml"</span>: Timeout: request did <span class="keyword">not</span> complete within requested timeout 30s</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Timeout): <span class="builtin-name">error</span> when creating <span class="string">"samples/bookinfo/networking/bookinfo-gateway.yaml"</span>: Timeout: request did <span class="keyword">not</span> complete within requested timeout 30s</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»º-bookinfo-gateway"><a href="#åˆ›å»º-bookinfo-gateway" class="headerlink" title="åˆ›å»º bookinfo-gateway"></a>åˆ›å»º bookinfo-gateway</h4><ul><li>istio-Ingress.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: istio-web-ui</span><br><span class="line">  namespace: </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: productpage</span><br><span class="line">          servicePort: 9080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨è¾“å…¥<code>http://istio.xxlaila.cn</code> æ¥è®¿é—®ã€‚ç”¨ productpageä»¥æŸ¥çœ‹BookInfoç½‘é¡µã€‚å¦‚æœæ‚¨å¤šæ¬¡åˆ·æ–°é¡µé¢ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°äº§å“é¡µé¢ä¸Šæ˜¾ç¤ºçš„è¯„è®ºç‰ˆæœ¬ä¸åŒï¼Œå¹¶ä»¥å¾ªç¯æ–¹å¼æ˜¾ç¤ºï¼ˆçº¢è‰²æ˜Ÿæ˜Ÿï¼Œé»‘è‰²æ˜Ÿæ˜Ÿï¼Œæ— æ˜Ÿæ˜Ÿï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬å°šæœªä½¿ç”¨Istioæ¥æ§åˆ¶ç‰ˆæœ¬è·¯ç”±<br><img src="https://img.xxlaila.cn/1572578398765.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1572578189667.jpg" alt="img"></p><p>åŸºæœ¬é“è¿™é‡Œï¼ŒåŠ¨æ€æ›´æ”¹è¯·æ±‚è·¯ç”±å­¦ä¹ ä¸­ï¼ŒğŸ˜‚ğŸ˜‚ğŸ˜‚</p><h3 id="ç›‘æ§æ–¹å¼"><a href="#ç›‘æ§æ–¹å¼" class="headerlink" title="ç›‘æ§æ–¹å¼"></a>ç›‘æ§æ–¹å¼</h3><h4 id="ç”ŸæˆæœåŠ¡å›¾"><a href="#ç”ŸæˆæœåŠ¡å›¾" class="headerlink" title="ç”ŸæˆæœåŠ¡å›¾"></a>ç”ŸæˆæœåŠ¡å›¾</h4><p>è¦éªŒè¯Kialiæ˜¯å¦åœ¨æ‚¨çš„é›†ç¾¤ä¸­è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n istio-system get svc kiali</span></span><br><span class="line">NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">kiali   ClusterIP   10.254.156.117   &lt;none&gt;        20001/TCP   4h38m</span><br></pre></td></tr></table></figure><p>æµé‡å‘é€åˆ°ç½‘æ ¼ï¼Œæœ‰ä¸‰ç§é€‰æ‹©:<br>1.åœ¨ç½‘ç»œæµè§ˆå™¨ä¸­è®¿é—®<a href="http://istio.xxlaila.cn/productpage" target="_blank" rel="noopener">http://istio.xxlaila.cn/productpage</a><br>2.å¤šæ¬¡ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl http://istio.xxlaila.cn/productpage</span></span><br></pre></td></tr></table></figure><p>3.ä½¿ç”¨ä»¥ä¸‹watchå‘½ä»¤è¿ç»­å‘é€è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># watch -n 1 curl -o /dev/null -s -w %&#123;http_code&#125; http://istio.xxlaila.cn/productpage</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œéœ€è¦é…ç½®Kiali UIï¼Œæˆ‘ä»¬åŒæ ·é€‚ç”¨Traefixæ¥è¿›è¡Œé…ç½®</p><ul><li>kialiâ€“Ingress.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kiali--Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kiali-web-ui</span><br><span class="line">  namespace: istio-system </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: istio-kiali.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kiali</span><br><span class="line">          servicePort: 20001</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://istio-kiali.xxlaila.cn" target="_blank" rel="noopener">http://istio-kiali.xxlaila.cn</a> ï¼Œ è¦ç™»å½•Kiali UIï¼Œè¯·è½¬åˆ°Kialiç™»å½•å±å¹•ï¼Œç„¶åè¾“å…¥å­˜å‚¨åœ¨Kialiæœºå¯†ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ã€‚è´¦æˆ·å¯†ç æ˜¯å‰é¢æˆ‘ä»¬è®¾ç½®çš„</p><h4 id="1-ç½‘æ ¼æ¦‚è¿°"><a href="#1-ç½‘æ ¼æ¦‚è¿°" class="headerlink" title="1.ç½‘æ ¼æ¦‚è¿°"></a>1.ç½‘æ ¼æ¦‚è¿°</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•åç«‹å³æ˜¾ç¤ºçš„â€œæ¦‚è¿°â€é¡µé¢ä¸­æŸ¥çœ‹ç½‘æ ¼çš„æ¦‚è¿°ã€‚â€œæ¦‚è¿°â€é¡µé¢æ˜¾ç¤ºäº†ç½‘æ ¼ä¸­å…·æœ‰æœåŠ¡çš„æ‰€æœ‰åç§°ç©ºé—´ã€‚ä»¥ä¸‹å±å¹•æˆªå›¾æ˜¾ç¤ºäº†ç±»ä¼¼çš„é¡µé¢<br><img src="https://img.xxlaila.cn/1572578943386.jpg" alt="img"></p><h4 id="2-ç©ºé—´å›¾"><a href="#2-ç©ºé—´å›¾" class="headerlink" title="2.ç©ºé—´å›¾"></a>2.ç©ºé—´å›¾</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¦æŸ¥çœ‹åç§°ç©ºé—´å›¾ï¼Œè¯·åœ¨bookinfoBookinfoåç§°ç©ºé—´å¡ä¸­å•å‡»å›¾å›¾æ ‡ã€‚å›¾å½¢å›¾æ ‡ä½äºåç§°ç©ºé—´å¡çš„å·¦ä¸‹æ–¹ï¼Œçœ‹èµ·æ¥åƒæ˜¯ä¸€ç»„ç›¸è¿çš„åœˆå­ã€‚è¯¥é¡µé¢ç±»ä¼¼äº<br><img src="https://img.xxlaila.cn/1572579048298.jpg" alt="img"></p><h3 id="åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ"><a href="#åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ" class="headerlink" title="åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ"></a>åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ç”¨Istioçš„åº”ç”¨ç¨‹åºå¯ä»¥é…ç½®ä¸ºä½¿ç”¨æµè¡Œçš„Jaegeråˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿæ¥æ”¶é›†è·Ÿè¸ªèŒƒå›´ã€‚åˆ†å¸ƒå¼è·Ÿè¸ªä½¿æ‚¨å¯ä»¥æŸ¥çœ‹ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­å‘å‡ºçš„è¯·æ±‚æµï¼Œè€ŒIstioçš„æ¨¡å‹åˆ™å…è®¸è¿™æ ·åšï¼Œè€Œä¸æ„å»ºåº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„è¯­è¨€/æ¡†æ¶/å¹³å°æ— å…³ã€‚ä½¿ç”¨Traefixæ¥æä¾›è¿™ä¸ªæœåŠ¡ã€‚</p><ul><li><p>Jaeger-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; Jaeger-Ingress.yaml  &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jaeger-web-ui</span><br><span class="line">  namespace: istio-system </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: jaeger.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: jaeger-query</span><br><span class="line">          servicePort: 16686</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f Jaeger-Ingress.yaml </span></span><br><span class="line">ingress.extensions/jaeger-web-ui unchanged</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://jaeger.xxlaila.cn" target="_blank" rel="noopener">http://jaeger.xxlaila.cn</a> ï¼Œ ä½¿ç”¨Bookinfoç¤ºä¾‹ç”Ÿæˆè·Ÿè¸ªï¼Œè¦æŸ¥çœ‹è·Ÿè¸ªæ•°æ®ï¼Œå¿…é¡»å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡ã€‚è¯·æ±‚æ•°é‡å–å†³äºIstioçš„é‡‡æ ·ç‡ã€‚æ‚¨åœ¨å®‰è£…Istioæ—¶è®¾ç½®æ­¤é€Ÿç‡ã€‚é»˜è®¤é‡‡æ ·ç‡ä¸º1ï¼…ã€‚æ‚¨éœ€è¦è‡³å°‘å‘é€100ä¸ªè¯·æ±‚ï¼Œæ‰èƒ½æ˜¾ç¤ºç¬¬ä¸€æ¡è·Ÿè¸ªã€‚è¦å°†100ä¸ªè¯·æ±‚å‘é€åˆ°productpageæœåŠ¡ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in `seq 1 100`; do curl -s -o /dev/null http://istio.xxlaila.cn/productpage; done</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨ä»ªè¡¨æ¿çš„å·¦ä¾§çª—æ ¼ä¸­ï¼Œä»â€œæœåŠ¡â€ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©productpage.defaultï¼Œç„¶åå•å‡»â€œæŸ¥æ‰¾è·Ÿè¸ªâ€<br><img src="https://img.xxlaila.cn/1572592255728.jpg" alt="img"></p></li><li><p>å•å‡»é¡¶éƒ¨çš„æœ€æ–°è·Ÿè¸ªä»¥æŸ¥çœ‹ä¸å¯¹/ productpageçš„æœ€æ–°è¯·æ±‚ç›¸å¯¹åº”çš„è¯¦ç»†ä¿¡æ¯<br><img src="https://img.xxlaila.cn/1572592385675.jpg" alt="img"></p></li></ul><h3 id="ç›‘è§†Istio"><a href="#ç›‘è§†Istio" class="headerlink" title="ç›‘è§†Istio"></a>ç›‘è§†Istio</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚ä½•è®¾ç½®å’Œä½¿ç”¨Istioä»ªè¡¨æ¿ç›‘è§†ç½‘æ ¼æµé‡ã€‚ä½œä¸ºç›‘æ§çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦å°†å®‰è£…Grafana Istioæ’ä»¶ï¼Œå¹¶ä½¿ç”¨åŸºäºWebçš„ç•Œé¢æŸ¥çœ‹æœåŠ¡ç½‘æ ¼æµé‡æ•°æ®ã€‚Grafanaå°†ç”¨äºå¯è§†åŒ–æ™®ç½—ç±³ä¿®æ–¯æ•°æ®ã€‚åœ¨æ‰§è¡Œéƒ¨ç½²çš„æ—¶å€™ä¹Ÿéƒ¨ç½²äº†è¿™ä¸¤ä¸ªæœåŠ¡ã€‚</p><h4 id="åˆ›å»ºgrafana-Ingress"><a href="#åˆ›å»ºgrafana-Ingress" class="headerlink" title="åˆ›å»ºgrafana Ingress"></a>åˆ›å»ºgrafana Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;grafana-istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-istio-web-ui</span><br><span class="line">  namespace: istio-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana-istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ›å»ºï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨ä»¥å‰çš„grafanaé‡Œé¢æ·»åŠ æ•°æ®åº“æºï¼Œå°±ä¸ç”¨åœ¨æ–°èµ·ä¸€ä¸ªåŸŸåæ¥è¿›è¡Œè®¿é—®<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†æ¬¡åŠ è½½Bookinfoåº”ç”¨ç¨‹åºï¼ˆ<a href="http://istio.xxlaila.cn/productpageï¼‰" target="_blank" rel="noopener">http://istio.xxlaila.cn/productpageï¼‰</a> ï¼Œ åˆ·æ–°é¡µé¢å‡ æ¬¡ï¼ˆæˆ–å‘é€å‘½ä»¤å‡ æ¬¡ï¼‰ä»¥äº§ç”Ÿå°‘é‡æµé‡ã€‚å†æ¬¡æŸ¥çœ‹Istioä»ªè¡¨æ¿ã€‚å®ƒåº”è¯¥åæ˜ æ‰€äº§ç”Ÿçš„æµé‡ã€‚<br><img src="https://img.xxlaila.cn/1572593852626.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;istio è¿˜æä¾›äº†ç½‘æ ¼çš„å…¨å±€è§†å›¾ä»¥åŠç½‘æ ¼ä¸­çš„æœåŠ¡å’Œå·¥ä½œè´Ÿè½½ã€‚æ‚¨å¯ä»¥é€šè¿‡å¯¼èˆªåˆ°ç‰¹å®šçš„ä»ªè¡¨æ¿æ¥è·å–æœ‰å…³æœåŠ¡å’Œå·¥ä½œè´Ÿè½½çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚<br><img src="https://img.xxlaila.cn/1572594150893.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æä¾›äº†æœ‰å…³æœåŠ¡æŒ‡æ ‡çš„è¯¦ç»†ä¿¡æ¯ï¼Œç„¶åæ˜¯è¯¥æœåŠ¡çš„å®¢æˆ·ç«¯å·¥ä½œè´Ÿè½½ï¼ˆæ­£åœ¨è°ƒç”¨æ­¤æœåŠ¡çš„å·¥ä½œè´Ÿè½½ï¼‰å’ŒæœåŠ¡å·¥ä½œè´Ÿè½½ï¼ˆæ­£åœ¨æä¾›è¯¥æœåŠ¡çš„å·¥ä½œè´Ÿè½½ï¼‰ã€‚<br><img src="https://img.xxlaila.cn/1572594261333.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio åœ¨grafana æä¾›äº†å¾ˆå¤šçš„ç›‘æ§æŒ‡æ ‡ï¼Œå¯ä»¥åˆ†åˆ«ç‚¹å‡»çœ‹çœ‹<br><img src="https://img.xxlaila.cn/1572594330246.jpg" alt="img"></p><h3 id="æŸ¥è¯¢IstioæŒ‡æ ‡"><a href="#æŸ¥è¯¢IstioæŒ‡æ ‡" class="headerlink" title="æŸ¥è¯¢IstioæŒ‡æ ‡"></a>æŸ¥è¯¢IstioæŒ‡æ ‡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istioçš„æ•°æ®æ˜¯å­˜å‚¨åœ¨prometheusé‡Œé¢çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡prometheusè¿›è¡Œç›´æ¥æ•°æ®çš„æŸ¥è¯¢</p><h4 id="æŸ¥çœ‹prometheusæœåŠ¡"><a href="#æŸ¥çœ‹prometheusæœåŠ¡" class="headerlink" title="æŸ¥çœ‹prometheusæœåŠ¡"></a>æŸ¥çœ‹prometheusæœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n istio-system get svc prometheus</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">prometheus   ClusterIP   10.254.145.181   &lt;none&gt;        9090/TCP   5h35m</span><br></pre></td></tr></table></figure><h4 id="prometheus-traefix"><a href="#prometheus-traefix" class="headerlink" title="prometheus traefix"></a>prometheus traefix</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡traefix æ¥ä»£ç†prometheusï¼Œç„¶åæˆ‘ä»¬å°†æµé‡å‘é€åˆ°ç½‘æ ¼ã€‚</p><ul><li><p>prometheus-istio.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; prometheus-istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-istio-web-ui</span><br><span class="line">  namespace: istio-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus-istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f prometheus-istio-Ingress.yaml </span></span><br><span class="line">ingress.extensions/prometheus-istio-web-ui created</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://prometheus-istio.xxlaila.cn" target="_blank" rel="noopener">http://prometheus-istio.xxlaila.cn</a> ï¼Œå¯ä»¥åœ¨è¾“å…¥æ¡†é‡Œé¢è¾“å…¥è¡¨è¾¾å¼æ¥è·å–æŒ‡ï¼Œè¾“å…¥æ–‡æœ¬ï¼šistio_requests_total<br><img src="https://img.xxlaila.cn/1572594888435.jpg" alt="img"></p><ul><li><p>å…¶ä»–æŸ¥è¯¢å°è¯•ï¼š</p><ul><li><p>å¯¹productpageæœåŠ¡çš„æ‰€æœ‰è¯·æ±‚æ€»æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">istio_requests_total&#123;destination_service=<span class="string">"productpage.default.svc.cluster.local"</span>&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯¹v3ç‰ˆæœ¬çš„è¯„è®ºæœåŠ¡çš„æ‰€æœ‰è¯·æ±‚æ€»æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">istio_requests_total&#123;destination_service=<span class="string">"reviews.default.svc.cluster.local"</span>, destination_version=<span class="string">"v3"</span>&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>è¯¥æŸ¥è¯¢å°†æ‰€æœ‰è¯·æ±‚çš„å½“å‰æ€»æ•°è¿”å›åˆ°è¯„è®ºæœåŠ¡çš„v3ã€‚</p><ul><li>è¿‡å»5åˆ†é’Ÿå†…å¯¹productpageæœåŠ¡æ‰€æœ‰å®ä¾‹çš„è¯·æ±‚ç‡ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rate(istio_requests_total&#123;destination_service=~<span class="string">"productpage.*"</span>, response_code=<span class="string">"200"</span>&#125;[5m])</span><br></pre></td></tr></table></figure></li></ul></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>istio</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineæ ¸å¿ƒé«˜çº§ç¯‡</title>
    <url>/2019/10/26/pipeline%E9%AB%98%E7%BA%A7%E7%AF%87/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢çš„ä¸¤ç¯‡æ–‡ç« ä»‹ç»äº†pipelineçš„åŸºæœ¬ä½¿ç”¨å’Œä¸€äº›å®é™…ä½¿ç”¨çš„ä¾‹å­ï¼Œçœ‹ä¼¼å¾ˆä¸é”™ï¼Œä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¹Ÿä¼šå‡ºç°å¾ˆå¤šçš„ä¸è¶³å’Œé—®é¢˜ï¼Œéšä¹‹ç³»ç»Ÿçš„åºå¤§ã€æœåŠ¡çš„å¢åŠ ã€äººå‘˜çš„å‚å·®ä¸é½ä¼šå¯¼è‡´å¾ˆå¤šçš„é—®é¢˜ã€‚<a id="more"></a>å±Šæ—¶ä¼šå¸¦æ¥å¾ˆå¤§çš„ç»´æŠ¤æˆæœ¬å’Œä¸€äº›æ”¹åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åšäº‹æƒ…ä¹‹å‰å°±è¦è€ƒè™‘è¿›å»ï¼Œä¸€äº›æ„å¤–äº‹ä»¶çš„å‘ç”Ÿã€æˆ–è€…æ˜¯åœ¨å°†æ¥å³å°†ä¼šå‘ç”Ÿå’Œéœ€è¦æ”¹å˜çš„äº‹æƒ…æˆ‘ä»¬éƒ½è¦æƒ³åˆ°æˆ–è€…æ˜¯é¢„ç•™å£å­ï¼Œè¿™æ ·æ‰åœ¨ä»Šåæ‰©å±•ã€ä¿®æ”¹ã€å¼•å…¥éƒ½èƒ½æœ‰å¾ˆå¥½å¯å¡‘æ€§ã€‚</p><h3 id="jenkins-jobä»‹ç»"><a href="#jenkins-jobä»‹ç»" class="headerlink" title="jenkins jobä»‹ç»"></a>jenkins jobä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨jenkinsçš„æ™®é€šjobï¼Œæ™®é€šçš„jobå¥½å¤„æ˜¯é…ç½®ç®€å•ï¼Œç»“æ„åŒ–å¯ä»¥å¤æ‚ï¼Œä¹Ÿå¯ä»¥å•ä¸€ã€‚åœ¨ä½¿ç”¨jenkins jobçš„æ—¶å€™æˆ‘ä»¬åˆ†ä¸ºä¸¤ç§ï¼šä¸€ç§æ˜¯å•ä¸€jobï¼Œä¸€ç§æ˜¯å…·æœ‰è€¦åˆæ€§çš„ã€‚ä¸‹é¢å¯¹ä¸¤ç§æƒ…å†µè¿›è¡Œå¯¹æ¯”å’Œæ¯”è¾ƒã€‚</p><h4 id="jenkins-å•ä¸€job"><a href="#jenkins-å•ä¸€job" class="headerlink" title="jenkins å•ä¸€job"></a>jenkins å•ä¸€job</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨jenkinsçš„ä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œå•ä¸€çš„çš„jobå¯ä»¥è®©ç»´æŠ¤äººå‘˜å¯ä»¥å¾ˆå¥½çš„æŸ¥çœ‹é‡Œé¢çš„é€»è¾‘æ­¥éª¤ï¼Œjobé‡Œé¢æ‰€æœ‰çš„ä»»åŠ¡éƒ½åœ¨è¿™ä¸ªæ‰€å±çš„ç©ºé—´é‡Œé¢æ‰§è¡Œï¼Œå®ƒé‡Œé¢åŒ…å«äº†ï¼šä»£ç pullã€ç¼–è¯‘ã€æ‰“åŒ…ã€å¤åˆ¶åŒ…ã€å‘å¸ƒåŒ…ï¼ˆä½¿ç”¨å†…ç½®çš„shellæ¨¡å—æ¥å†™shellï¼Œè¿™ç§åº”è¯¥ä¸å­˜åœ¨ï¼‰ã€‚ç§å•ä¸€jobæœåŠ¡ç®—å¾—ä¸Šæ˜¯æœåŠ¡å‘¨åˆ°ï¼Œä¸å½±å“å…¶ä»–äººï¼Œè‡ªå·±ç®¡ç†å¥½è‡ªå·±çš„ä¸€äº©ä¸‰åˆ†åœ°ã€‚å¥½å¤„æ˜¯å½“å‡ºé”™ä»¥åå½±å“èŒƒå›´å°ï¼Œå®¹æ˜“æ§åˆ¶ã€‚å¦‚ä¸‹å›¾ï¼š<br><img src="https://img.xxlaila.cn/1572064519037.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¿™ä¸­æ¨¡å¼ä¸‹ï¼Œç»´æŠ¤äººå‘˜å‰æœŸç”¨çœ‹ä¼¼æ¯”è¾ƒè½»æ¾çš„å·¥ä½œå»ºç«‹èµ·äº†æ•´ä¸ªå‘å¸ƒæµç¨‹ã€‚ä½†æ˜¯åˆ°äº†åæœŸå°±ä¸è¡Œäº†ã€‚ä¹‹å‰æˆ‘åœ¨çš„è¿™å®¶å…¬å¸å‰æœŸä¹Ÿæ˜¯è¿™ä¹ˆè¿™ä¹ˆåšçš„ã€‚å¼€å‘å®Œæˆåæäº¤gitï¼Œç„¶åè‡ªåŠ¨è§¦å‘ã€æ„å»ºã€åˆ¶å“åº“ã€å‘å¸ƒï¼Œåœ¨ä¸€ä¸ªjobé‡Œé¢å°±å®Œæˆäº†ã€‚åæ¥æˆ‘ä»¬å‡†å¤‡æ¨è¡Œæ›´å¥½çš„devopsæ–¹æ¡ˆçš„æ—¶å€™ï¼›å‘ç°ä»¥å‰çš„è¿™ä¸ªjobå»ºç«‹æœ‰é—®é¢˜ï¼Œä¸€æƒ³åˆ°å‡ ç™¾ä¸ªå¾®æœåŠ¡ï¼Œå‡ ç™¾ä¸ªjobéœ€è¦å»è¿›è¡Œæ”¹é€ ã€‚é¡¿æ—¶æˆ‘ä»¬è¿ç»´è„¸çº¿ä¸€é»‘ï¼Œè™½ç„¶æˆ‘ä»¬è‡ªå·±å†™äº†ä¸€ä¸ªå¿«é€Ÿåœ¨jenkinsä¸Šå»ºç«‹jobï¼Œä½†æ˜¯ä¸€æƒ³åˆ°å‡ ç™¾ä¸ªè¿˜æ˜¯ä¸å¥½ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†jobä¹‹é—´çš„ä»»åŠ¡å…³è”ï¼Œç„¶åé€šè¿‡å‚æ•°ä¼ é€’å®Œæˆæ•´ä¸ªæµç¨‹æœåŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™ç§æ¨¡å¼ä¸‹çš„å¼Šç«¯å°±å¦‚ä¸Šé¢æ‰€è¯´çš„ä¸€æ ·ï¼Œä½†ä»€ä¹ˆæ—¶å€™å¥½çš„æœåŠ¡å‘¢ï¼Ÿå¥½çš„æœåŠ¡åˆæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™é‡Œä¹Ÿå¯ä»¥åµŒå¥—ä¸€äº›å¾®æœåŠ¡çš„æ¦‚å¿µç†è®ºã€‚å¦‚æœæˆ‘ä»¬è¦åšåˆ°ä»€ä¹ˆæ—¶å€™å¥½çš„æœåŠ¡ï¼Œæˆ‘ä»¬å¾—äº†è§£äº†è§£ä¸€ä¸‹: ä½è€¦åˆå’Œé«˜å†…èšã€‚äº†è§£è¿™ä¸ªä¸œè¥¿æœ‰åŠ©äºæˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„pipeline æµæ°´çº¿çš„è®¾è®¡ï¼ŒåŒ…æ‹¬åœ¨åæœŸdevopsçš„è®¾è®¡ä»¥åŠæ’¸ç éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚</p><h3 id="è€¦åˆæ€§"><a href="#è€¦åˆæ€§" class="headerlink" title="è€¦åˆæ€§"></a>è€¦åˆæ€§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆæˆ‘ä»¬æ¥äº†è§£è¿™ä¸€æ¦‚å¿µ: â€œé«˜å†…èšä½è€¦åˆâ€ã€‚åœ¨è½¯ä»¶è®¾è®¡ä¸­é€šå¸¸ç”¨è€¦åˆåº¦å’Œå†…èšåº¦ä½œä¸ºè¡¡é‡æ¨¡å—ç‹¬ç«‹ç¨‹åº¦çš„æ ‡å‡†ã€‚åˆ’åˆ†æ¨¡å—çš„ä¸€ä¸ªå‡†åˆ™æ˜¯é«˜å†…èšä½è€¦åˆã€‚ä»æ¨¡å—ç²’åº¦æ¥çœ‹ï¼Œé«˜å†…èšï¼šå°½å¯èƒ½ç±»çš„æ¯ä¸ªæˆå‘˜æ–¹æ³•åªå®Œæˆä¸€ä»¶äº‹ï¼ˆæœ€å¤§é™åº¦çš„èšåˆï¼‰ï¼›ä½è€¦åˆï¼šå‡å°‘ç±»å†…éƒ¨ï¼Œä¸€ä¸ªæˆå‘˜æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæˆå‘˜æ–¹æ³•ã€‚ä»ç±»è§’åº¦æ¥çœ‹ï¼Œé«˜å†…èšä½è€¦åˆï¼šå‡å°‘ç±»å†…éƒ¨ï¼Œå¯¹å…¶ä»–ç±»çš„è°ƒç”¨ï¼›ä»åŠŸèƒ½å—æ¥çœ‹ï¼Œé«˜å†…èšä½è€¦åˆï¼šå‡å°‘æ¨¡å—ä¹‹é—´çš„äº¤äº’å¤æ‚åº¦ï¼ˆæ¥å£æ•°é‡ï¼Œå‚æ•°æ•°æ®ï¼‰å³æ¨ªå‘ï¼šç±»ä¸ç±»ä¹‹é—´ã€æ¨¡å—ä¸æ¨¡å—ä¹‹é—´ï¼›çºµå‘ï¼šå±‚æ¬¡ä¹‹é—´ï¼›å°½å¯èƒ½ï¼Œå†…å®¹å†…èšï¼Œæ•°æ®è€¦åˆã€‚</p><h4 id="ä½è€¦åˆ"><a href="#ä½è€¦åˆ" class="headerlink" title="ä½è€¦åˆ"></a>ä½è€¦åˆ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸åŒæ¨¡å—ç›¸äº’ä¾èµ–å¤šå°‘ï¼Ÿæ¨¡å—åº”å°½å¯èƒ½ç‹¬ç«‹äºå…¶ä»–æ¨¡å—ï¼Œä»¥ä½¿å¯¹æ¨¡å—çš„æ›´æ”¹ä¸ä¼šä¸¥é‡å½±å“å…¶ä»–æ¨¡å—ã€‚</p><h4 id="é«˜è€¦åˆ"><a href="#é«˜è€¦åˆ" class="headerlink" title="é«˜è€¦åˆ"></a>é«˜è€¦åˆ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é«˜è€¦åˆå°†æ„å‘³ç€æ‚¨çš„æ¨¡å—å¯¹å…¶ä»–æ¨¡å—çš„å†…éƒ¨è¿ä½œäº†è§£å¤ªå¤šã€‚å¯¹å…¶ä»–æ¨¡å—äº†è§£å¤ªå¤šçš„æ¨¡å—ä¼šä½¿æ›´æ”¹éš¾ä»¥åè°ƒï¼Œå¹¶ä½¿æ¨¡å—èƒ½åŠ›å˜å¼±ã€‚å¦‚æœæ¨¡å—Aå¯¹æ¨¡å—Bçš„äº†è§£è¿‡å¤šï¼Œåˆ™å¯¹æ¨¡å—Bå†…éƒ¨çš„æ›´æ”¹å¯èƒ½ä¼šç ´åæ¨¡å—Açš„åŠŸèƒ½ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡å®ç°ä½è€¦åˆï¼Œå¯ä»¥è½»æ¾æ›´æ”¹æ¨¡å—å†…éƒ¨ï¼Œä¸å¿…æ‹…å¿ƒå®ƒä»¬å¯¹ç³»ç»Ÿä¸­å…¶ä»–æ¨¡å—çš„å½±å“ã€‚ä½è€¦åˆè¿˜ä½¿æˆ‘ä»¬çš„æ¨¡å—å½¼æ­¤ä¹‹é—´ä¸ç›¸äº’ä¾èµ–ï¼Œå› æ­¤æ›´æ˜“äºè®¾è®¡ï¼Œç¼–å†™å’Œæµ‹è¯•ä»£ç ã€‚æˆ‘ä»¬è¿˜è·å¾—äº†æ˜“äºé‡ç”¨å’Œå¯ç»„åˆçš„æ¨¡å—çš„ä¼˜åŠ¿ã€‚é—®é¢˜ä¹Ÿè¢«éš”ç¦»åˆ°å°çš„ï¼Œç‹¬ç«‹çš„ä»£ç å•å…ƒä¸­ã€‚</p><p><strong>å¥½å¤„:</strong></p><ul><li>å¯ç»´æŠ¤æ€§: æ›´æ”¹é™åˆ¶åœ¨ä¸€ä¸ªæ¨¡å—ä¸­</li><li>å¯æµ‹è¯•æ€§: å•å…ƒæµ‹è¯•ä¸­æ¶‰åŠçš„æ¨¡å—å¯ä»¥é™åˆ¶åœ¨æœ€ä½é™åº¦</li><li>å¯è¯»æ€§: éœ€è¦åˆ†æçš„ç±»å‡å°‘</li></ul><h4 id="é«˜å†…èš"><a href="#é«˜å†…èš" class="headerlink" title="é«˜å†…èš"></a>é«˜å†…èš</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…èšæ€§é€šå¸¸æ˜¯æŒ‡æ¨¡å—çš„å…ƒç´ å¦‚ä½•ç›¸äº’ç»„åˆã€‚ç›¸å…³ä»£ç åº”å½¼æ­¤æ¥è¿‘ï¼Œä»¥ä½¿å…¶å…·æœ‰é«˜åº¦çš„å‡èšåŠ›ã€‚æ˜“äºç»´æŠ¤çš„ä»£ç é€šå¸¸å…·æœ‰å¾ˆé«˜çš„å†…èšæ€§ã€‚æ¨¡å—ä¸­çš„å…ƒç´ ä¸è¯¥æ¨¡å—è¦æä¾›çš„åŠŸèƒ½ç›´æ¥ç›¸å…³ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ï¼Œæœ€å¥½æ˜¯åœ¨ä¸€ä¸ªåœ°æ–¹è¿›è¡Œä¿®æ”¹ï¼Œç„¶åå¯ä»¥å°½å¿«çš„å‘å¸ƒã€‚å¦‚æœå¾ˆå¤šä¸åŒçš„åœ°æ–¹è¦è¿›è¡Œä¿®æ”¹ï¼Œå°±æœ‰å¯èƒ½éœ€è¦å‘å¸ƒå¤šä¸ªå¾®æœåŠ¡æ‰èƒ½äº¤äº’è¿™ä¸ªåŠŸèƒ½ã€‚åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œä¿®æ”¹ï¼Œä¸ä»…ä¿®æ”¹é€Ÿåº¦å¾ˆæ…¢ï¼ŒåŒæ—¶éƒ¨ç½²å¤šä¸ªå¾®æœåŠ¡ä¹Ÿæé«˜äº†é£é™©ã€‚æ‰€ä»¥åœ¨æ‰¾åˆ°é—®é¢˜åŸŸçš„è¾¹ç•ŒåŸŸåå¯ä»¥ç¡®ä¿ç›¸å…³çš„è¡Œä¸ºèƒ½æ”¾åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼Œå¹¶ä¸”å®ƒä»¬ä¼šå’Œå…¶å®ƒè¾¹ç•Œä»¥å°½é‡ä½è€¦åˆçš„å½¢å¼è¿›è¡Œé€šä¿¡ã€‚</p><p><strong>å¥½å¤„:</strong></p><ul><li>å¯è¯»æ€§: åŠŸèƒ½åŒ…å«åœ¨å•ä¸ªæ¨¡å—ä¸­</li><li>å¯ç»´æŠ¤æ€§: è°ƒè¯•å¾€å¾€åŒ…å«åœ¨å•ä¸ªæ¨¡å—ä¸­</li><li>å¯é‡ç”¨æ€§: å…·æœ‰é›†ä¸­åŠŸèƒ½ä¸ä¼šè¢«æ— ç”¨çš„å¹²æ‰°</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…èšæ€§ä½æ„å‘³ç€ç»„æˆæŸäº›åŠŸèƒ½çš„ä»£ç ä¼šæ•£å¸ƒåœ¨æ‚¨çš„æ•´ä¸ªä»£ç åº“ä¸­ã€‚ä¸ä»…å¾ˆéš¾å‘ç°ä¸æ‚¨çš„æ¨¡å—ç›¸å…³çš„ä»£ç ï¼Œè€Œä¸”å¾ˆéš¾åœ¨ä¸åŒçš„æ¨¡å—ä¹‹é—´è·³è½¬å¹¶è·Ÿè¸ªçš„æ‰€æœ‰ä»£ç ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šä¿—çš„æ¥è®²ï¼Œå†…èšæ˜¯ä»åŠŸèƒ½è§’åº¦æ¥åº¦é‡æ¨¡å—å†…çš„è”ç³»ï¼Œå¥½çš„å†…èšæ¨¡å—åº”æ°å¥½åšä¸€ä»¶äº‹ã€‚æè¿°çš„æ˜¯æ¨¡å—å†…çš„åŠŸèƒ½è”ç³»ã€‚è€¦åˆæ˜¯è½¯ä»¶ç»“æ„ä¸­å„æ¨¡å—ä¹‹é—´ç›¸äº’è¿æ¥çš„ä¸€ç§åº¦é‡ï¼Œè€¦åˆå¼ºå¼±å–å†³äºæ¨¡å—é—´æ¥å£çš„å¤æ‚ç¨‹åº¦ã€è¿›å…¥æˆ–è®¿é—®ä¸€ä¸ªæ¨¡å—ç‚¹ä»¥åŠé€šè¿‡æ¥å£çš„æ•°æ®ã€‚</p><h4 id="å¯ç»´æŠ¤çš„ä»£ç "><a href="#å¯ç»´æŠ¤çš„ä»£ç " class="headerlink" title="å¯ç»´æŠ¤çš„ä»£ç "></a>å¯ç»´æŠ¤çš„ä»£ç </h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸€èˆ¬åœ¨ç¼–å†™å¯ç»´æŠ¤çš„ä»£ç æœ‰åŠ©äºæé«˜å¼€å‘äººå‘˜çš„ç”Ÿäº§åŠ›ã€‚å…·æœ‰é«˜åº¦å¯ç»´æŠ¤çš„ä»£ç ä½¿è®¾è®¡æ–°åŠŸèƒ½å’Œç¼–å†™ä»£ç å˜å¾—æ›´åŠ å®¹æ˜“ã€‚æ¨¡å—åŒ–ï¼ŒåŸºäºç»„ä»¶çš„åˆ†å±‚ä»£ç å¯æé«˜ç”Ÿäº§ç‡å¹¶é™ä½è¿›è¡Œæ›´æ”¹æ—¶çš„é£é™©ã€‚é€šè¿‡ä½¿ä»£ç ä¿æŒæ¾æ•£è€¦åˆï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ¨¡å—å†…ç¼–å†™ä»£ç ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–æ¨¡å—ã€‚é€šè¿‡ä¿æŒä»£ç çš„å†…èšæ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ›´è½»æ¾åœ°ç¼–å†™æ˜“äºä½¿ç”¨çš„DRYä»£ç ã€‚</p><p><strong>é—®é¢˜</strong>: å½“æˆ‘ä»¬é‡åˆ°é—®é¢˜æ—¶ï¼Œè¯·è¯„ä¼°ä¿®å¤ã€ä¿®æ”¹ç¨‹åºçš„ç¨‹åº¦ã€‚æ˜¯æ›´æ”¹ä¸€ä¸ªæ¨¡å—ï¼Œè¿˜æ˜¯æ›´æ”¹åˆ†æ•£åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ï¼Ÿåœ¨è¿›è¡Œæ›´æ”¹æ—¶ï¼Œå®ƒæ˜¯å¦å¯ä»¥è§£å†³æ‰€æœ‰çš„é—®é¢˜ï¼Œè¿˜æ˜¯ä¼šäº§ç”Ÿå…¶ä»–ä¸€äº›ä¸å¯é¢„çŸ¥çš„é—®é¢˜ï¼Ÿ</p><p>åœ¨ç¼–å†™å’Œä½¿ç”¨ä»£ç åº“æ—¶:</p><ul><li>æˆ‘è¦ä¿®å¤å’Œåˆ›å»ºçš„æ­¤åŠŸèƒ½æ¨¡å—æ˜¯å¤šå°‘ï¼Ÿ</li><li>æ­¤æ›´æ”¹æ˜¯è¦åœ¨å‡ ä¸ªä¸åŒçš„åœ°æ–¹è¿›è¡Œï¼Ÿ</li><li>æˆ‘èƒ½å¦ç‹¬ç«‹æµ‹è¯•ä»£ç ï¼Œæµ‹è¯•æ•´ä¸ªä»£ç æœ‰å¤šéš¾ï¼Ÿ</li><li>æˆ‘ä»¬æ˜¯å¦å¯ä»¥ä½¿ä»£ç æ›´æ¾æ•£åœ°è€¦åˆæ¥æ”¹å–„ï¼Ÿå¯ä»¥ä½¿ç”¨é«˜å†…èšæ¥æ”¹å–„æˆ‘ä»¬çš„ä»£ç å—ï¼Ÿ</li></ul><h3 id="Jenkins-è®¾è®¡"><a href="#Jenkins-è®¾è®¡" class="headerlink" title="Jenkins è®¾è®¡"></a>Jenkins è®¾è®¡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†ä¸Šé¢çš„çš„ç†è®ºä¸æ¦‚å¿µã€‚æ ¹æ®è¿™é‡Œç†è®ºå’Œæ¦‚å¿µæˆ‘ä»¬å°±å¯ä»¥è®¾è®¡å‡ºä¸€å¥—æ›´å¥½çš„devopsæµç¨‹ã€‚æœ¬æ–‡å°†kuberneteså¹³å°ä¸Šæ¥åšè¿™ä¸€å¥—è®¾è®¡ï¼Œå¹¶åœ¨å®é™…çš„ç¯å¢ƒä¸­åº”ç”¨ã€‚æ¶‰åŠçš„åŠŸèƒ½å¦‚ä¸‹: æœåŠ¡ Jobã€Code Jobã€Releaseã€Noticeå››ä¸ªåŠŸèƒ½ä»»åŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¯ä¸€ä¸ªç¯å¢ƒæœ‰é”™è¯¯ï¼Œå°±ä¼šæ‰§è¡Œå‘Šè­¦ä»»åŠ¡æ¨¡å—ï¼Œå‘Šè­¦ç›®å‰ä½¿ç”¨çš„æ˜¯<a href="https://github.com/xxlaila/jenkins-wechat-notice" target="_blank" rel="noopener">ä¼ä¸šå¾®ä¿¡</a>ã€‚jobä¹‹é—´éœ€è¦ä¼ é€’JOB_NAMEï¼Œenvï¼Œversionä¸‰ä¸ªå‚æ•°ã€‚åœ¨ä¹‹å‰çš„devopsè®¾è®¡é‡Œé¢æ•´ä¸ªjobçš„è°ƒç”¨è®¾è®¡è¿˜è¦å¤šã€‚å½¢æˆäº†ä¸€ä¸ªé€šç”¨ä½“ç³»ã€‚åœ¨è¿™ä¸ªè®¾è®¡é‡Œé¢ï¼Œå½“è¿˜éœ€è¦å¢åŠ ä¸€ä¸ªä»»åŠ¡æµç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹pipelineï¼Œç„¶åå¢åŠ ä¸€ä¸ªjobï¼Œåœ¨ä¸‹æ¬¡æ„å»ºçš„æ—¶å€™å°±ä¼šæŠŠæˆ‘ä»¬æ–°å¢åŠ çš„æµç¨‹ç»™åŠ è¿›å»ï¼Œéå¸¸çš„æ–¹ä¾¿ã€‚è®¾è®¡å›¾å¦‚ä¸‹ï¼š<br><img src="https://img.xxlaila.cn/1572081425995.jpg" alt="img"></p><h4 id="Project-Name"><a href="#Project-Name" class="headerlink" title="Project Name"></a>Project Name</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤jobä¸€èˆ¬å°±æ˜¯æœåŠ¡ï¼Œjobåç§°ä»¥æœåŠ¡çš„åç§°è¿›è¡Œå‘½åã€‚é‡Œé¢åŒ…å«äº†å››ä¸ªåŠŸèƒ½.</p><ul><li>Clone Code: clone ä»£ç ã€‚</li><li>Build Code: å°±æ˜¯å¯¹å¼€å‘æäº¤çš„ä»£ç è¿›è¡Œç¼–è¯‘ã€‚</li><li>Env Version: è·å–æœ¬æ¬¡æäº¤çš„hashï¼Œä»¥hashä¸ºç‰ˆæœ¬ï¼Œç»“åˆç¯å¢ƒæ¥åšä¸€ä¸ªç‰ˆæœ¬è®°å½•ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œåˆ¤æ–­ã€‚uat/prodç¯å¢ƒä¸éœ€è¦envå‰ç¼€ã€‚</li><li>Build Docker: æŠŠç¼–è¯‘å®Œæˆåçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰“åŒ…æˆä¸€ä¸ªdockeré•œåƒã€‚</li></ul><h4 id="Code-Test"><a href="#Code-Test" class="headerlink" title="Code Test"></a>Code Test</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºæµ‹è¯•è¿›è¡Œå¯¹ä»£ç çš„è‡ªåŠ¨åŒ–æµ‹è¯•ï¼›è‡ªåŠ¨åŒ–æµç¨‹ã€æ€§èƒ½ç­‰æµ‹è¯•</p><h4 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸»è¦æ˜¯è¿›è¡Œå‘å¸ƒæœåŠ¡ã€‚å½“æ¥å—åˆ°ä¸Šæ¸¸jobä¼ é€’æ¥çš„å‚æ•°ä¿¡æ¯åï¼Œç»“åˆå‚æ•°ä¿¡æ¯æ¥è¿›è¡Œå¯¹åº”çš„å‘å¸ƒåˆ°kubernetesä¸­namespaceä¸­ï¼Œä¸»è¦åŒ…å«äº†ä»¥ä¸‹åŠŸèƒ½</p><ul><li>Push Docker: æŠŠå‰é¢æ‰“åŒ…çš„dockeré•œåƒæ¨é€åˆ°harbor</li><li>Edit Files: ä¿®æ”¹å‘å¸ƒçš„è„šæœ¬</li><li>Release: æ‰§è¡Œ<code>kubectl</code>è¿›è¡Œå‘å¸ƒ<ul><li>å½“å‘å¸ƒåˆ°kubernetesä¸­ï¼Œkubernetes ä¼šæ‰§è¡Œ<a href="https://xxlaila.github.io/2019/09/27/k8s-pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/" target="_blank" rel="noopener">healthæ£€æµ‹</a>ï¼Œå¦‚æœå¯åŠ¨å¤±è´¥ï¼Œä¼šè¿›è¡Œé€šçŸ¥</li></ul></li></ul><h4 id="Notice"><a href="#Notice" class="headerlink" title="Notice"></a>Notice</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤jobä¸»è¦ç”¨äºé€šçŸ¥ã€‚å½“æ¥å—åˆ°è§„åˆ™çš„å‘Šè­¦é€šçŸ¥ä»¥åï¼Œå°±ä¼šè¿›è¡Œè§¦å‘é€šçŸ¥ç›¸å…³çš„äººå‘˜ã€‚</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineå¤šåˆ†æ”¯gitlabè§¦å‘</title>
    <url>/2019/10/25/pipeline%E5%A4%9A%E5%88%86%E6%94%AFgitlab%E8%A7%A6%E5%8F%91/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="enter password to read." />
    <label for="hbePass">enter password to read.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="3b0fd8fbed72e8ae53f7b7791611d0118b73ee419bffccd2afbd37e59584256d">d69a90776b8106231e3f5503e1ddcc13376254b97345feb73ace3f396649992630ffdbfd4d523e701abe00b6ccbfa8c9c55ba161d404eb570400424bd472062da452630f56925e4377c452329054926d605050ee96e849d4508a6026547ac5fc5dae64fb2cc6f4bec9d9567657ee2a7726da87308e9e266b6d722bc26c289eacc0fca7984be7066670bb623ad2ad1ea95a743a23818981c5c8b6606d6cb5e4639d80836d7853fe0317570e6c13d808c530c5577c3433cf11cb70983a49b878f4909939257516dc16685c35d1fa8cd27a2ac73208366a267b1f3d5de7d5f3c81ef40aeae8f230893115c0d5bfbc807e43afe6c2273254ee8e107309981eb879cc92d15c0fbde565557160f897c492369667de4f30a0bfe7031261402e7dd43b418a3269d20bbe2d1afaa89e1612a2103e2df1ea0c9583e8e2673e7efad019a88077512628b655e2129dd2a813b9646126b8597d30399230d2104d3385daa2b81beb2d8581dc9c5481c0d11bfe9cdd06cdd8846733d19e8580bce5c6662815c623c382881a8340396e4863f5624fd19a5cc5904bada6059d12fe1c253b408728e3b5652de52a63367418329021dfbb7d2064fac1b2d2094cf833b60e364d382213186bc552828460d09e5214f511c6ba9b895500b39d3e4fbde8b6639c25c93387348563ff40c71d2d7fb42005474779bbfff03679c0ca90f2ed33e233dcdba05d6eba96b92bdb303cc1d7727dc6fc3c2639e7851dc7e4aaf592dd311a86e269e5b907c3f5da8fda9380c50cf9105f76994822a8b46c7c4d9806f8170a69af6e24be751734da9f233dd9ca15ee6e106e256c4bdea541349130c66a338863b5166c64a5df6f2b536747beb9495891d3c67f9824982b919ee4bf50611c96e66c7a2e20af8bfc812d215c8689960a5b3c7082420cef76133f444e9f2bed800d13de3d09ee8be76cc8d57d640e4f3ab07528555bbc819d26769d44ce37ea137d224e242b6c0921e60b24378a3976e2f9e82876ebab82e0fa0e7f396b8ba6a265e7d3a402bc43bbef414151444591114549464a75c9529e5454de98eba89021133994f4d32ff331e2d47db589396b2b5e5a07e121c624cf002860502d6b59a911b9f6e5ca7b3a7f66b64b88eeab8f021d4619f118cf7ac4a009fb2662edd9079d4e9cb48fc5dbf9d9cb3e6e910583fda6ffd4303c764a1f96b284c0abbeda131fccc6ebb730874cbdcc5aee2bf49fde3ccd0bead349b05e3a7a2091cdde38fd9681e3bb48ff06da806d8befaeb27a1857327575688d64f4e68c133a8118d446dec3bb9c4365f7d7bbf221d0c921e89b7ec4ba063c595ebd49facf82ac807c4875f2c8e84ca904945f54763c720a624d5e792c436e5d84566b5419b9f38c01ddc9fc6040b8eca4c26e4e632edcc8fee17a49243c8e53743366654e572de58752413ca7ee59c40f876c00980b81eabeb5413572c5edd3215461d280635616058c726320645b04243079f5fd5c2638474a0272d170c9b60cd8946784adbbead4252466e7224398bbc655ba635924a72c7572cd001a2bc221e6b5eaa37824a7659680e5f0e508b720189618ff88460ce7a3d3c4d8b5c01f5238d6e0733dfef3aa1873491553349239b32a0d46299ec08bf290d360e9204451a7c7c10be7c12b0190b310e098337e148b351e81963211a43c19a9fa243ac49332d7de97c4489e63aa6e0bc1b1757d46bba3da27f730627755bd02f2c43c5ed6e89910e48c091fe788bc57c5c07e69738142dc79d33d81447db40b2348a2486cc2006193cbcc0a8860305a4e788f87d47f5298a8bb0a346c9b72b42b19bfafad9bf97679ef04a927b73bfa613eece084d04931e519e8ead13a3f4255ced6cbd338d310bf4f34f48cbbb04c131d1c19345d1b504e56ccca2775a9a7979d0999c474d3117bddb308581981f79791a726b4a0cf2b5d0842cbefbbc490c9cbaedb3e89ef307838be09f44b486ade7e6bdf57916489faa21b0685e21756a206e4e9d1643b634f76e017ea3bddbc07b6f28eeb536290521603e42f2a3f097d428f844e8263e575fe00bede9b6627a0e51526e60976314536784b3a334c9646389a9ae6eecfe1e75bcd00586284541af779ff7317b05a5241321f1941e8eb4aff3c4711b4951de4bd09b93d2c4a0f5afbb39b4c2b43f8cf3346c5b6f827e8b262f137225ed38286501fba12564e3665536378cf9656fa52315b8c2d81a32ba54ac4caeba731789591e6167e00af750468b3ccdb8daf7679ef64fd7e11d8583b4b25be396f61a753fc7317934cb9af765fefa78e0bb53693850636978e12d2645f166f8cd432b367c5e6a220f3ad30454158e5e321ba2ddd4d9be6e71c01d25d84b5039741943990ca9d92dfc7a709f17bf0227d6bdefae2183b6d4d27954c2f0c3e229359132435c838f28c517c290d345b2431f790c623840042056a56030ddca6813bf9b956f86b9432a51d57ae7bfd009b26408bcbe3b5e7dd0771db313a27e4487d7e9baa5b1f5cf3a93120e25ce789362a3839b0b7cad1504959cc8bba48a4ed5915c993ece4a0b1c29618c7914892dd81edc183086f539dc80fdea8bc05e806c0f7e75dd7945a08de873c1d098452abb59c29d2540d4e3f69af5d3712212778928fd45a80ab7ddda32260bc15c962db73ea43109609605ae8295e32ac6756f2c3dff33ba3c4c90ae5a367fbfcff556b76b77465a830d44f40ae34234c596842640884ed3b96361fcb4c49a0d05efd4265353e3b0492aedfe5d0b358f396822777dc629efe590d07459d6dc3702c8cd9da1dafde2bd7c01a37d4091ae335f46141b8891a71d5bf25ab740acee497473b7d79be22b31d30b13492e24db1a28be1494b87bf101e452e9baf64a8e6957e490f60597d98259aa22dec391279b611f2dd217d35940c9f7408c59f5ecb6c2311bac7f51e1e59714136c1a1a51650ead8ac165f93c3013fae85b7a5152094378a3e391459cc1cb83bbf45fbe204c154f1df4c5c3ba2fd47920a5f6e9a42885dd6b82020e0185b3782fc4f1c5857c6b38f110b9a64ba704732e09c9ee68c392ba3ff58f094d520001845c9e5c5e00c55f4c5a8071a9eb4810d35b737ec88b193d770d0f8eb47b34f665a2d077ebe4d884d42d21bd9933b3b002f728d8f21fa5d833447382cc41b48b4756cb492030057f1a1971c822e5976a2cdc67bba66d7d4fda0b32616c413a67d0eff23fd862b3dd15fede22d00027e618efd59aca3f7f59f7a24d9530237d17c8e81c0c5705c50c6e8e27a8fb5d548e3d14269d30a2af04027dd56e5398e13cb3a959751af86784ed76184b3a5d8abd02a615c41d2ac5733989806266ef176812291d66845309d3cda9845b61ee833cb7e94dbcb528288cf334000a8d87e94b0eca9f1f09260873502784f3525a3cee71e443c830e5e25e695cc8d19f2022a0ac6882c7a99fe04afb85727e2ae2a127d847e19d1cf5e9d2d8eee70fd89f4415cea8016863f96058b3def35b036d37182bd90463982cc077b329316389c5b5656f45dbf338724c73cb31ba14b2b688b8a4c96194512e0d07deeaef9e51bfb83e43a19aab7121a1fb8164b3ba77891bb59376567f139cb8e271b1b347b35647e3b15a1d13869d47f3ff55834aa07ccbf59db839747263f70ecce1c316e1b78978bd15d2acba4ef6cfa9f8463dad6a9582e1f31348a0064f5621acc24445c64ecec5f78b44300c65554969ec5be885a76a644eb68d53d69dfd3e2f4901b447cc234f2a3b580dc47d35d5aec5fa16ce943f663ea8c18bd368eacd67555086053e52b9e412a4ca6eecf44ff08f4f4e2cf827aa99eb19748dcbab82e3501995d5688088e2c2ef5270ed2e36e8d8bbd4eeeacbc768d2c3966fdd26b5e9d22c63d1b8d0466fb68992ea171afb910923fec622e7f98a0485d467a5af062608d1de4769f279ad755e76fe273dab766f578a5d36d8e0036b440421c189998cafdc707e60cb86f90b9297225a48b6787816cdd088d61430566a07c2b01e85d715d3c074800657f13f26ddc1b5442c93a8ee57d17021d6599641ae8c6e3c9563fc0a183da3f913080269bb60addbd064509a895f67d9112d91fd35c8b244e6dcef0e45b4547f72fa6348a4846548c99599150f9cac39c7fe3b70fd9169a3b689258163570ecb20680eab39830e179abbf9ae8bbacc8891bc68dfa71d070a6a94296297919efd5738589c00a46db511bbbe1fe4914fb6331b8eb1e6db260ada0a39ceee6f48d1002ad7af32acc980e55d5d6e194246278a37c3fde200e9cb6779b57fdd21d6fd653581297a75c5d04493800e9459144d241a1511c35812a3e130d87dd6a93a57b567328649c28999d924a5bbd4190d3d8469ca49ed55b7b17732b4f892cdc09f3f9536b5aaa49cf5ed0ffd7c6c93fea103b8b57b7530c618fb11307ab31bdda888881909f42cb726588ed1e30806927ff0deb583bf672012d49aeda4909cfbb8a77f57b0006338a2adaea391527ab6c7147400ba35043b765017e288a6d21eda1c51404954a30b0f698b85da528fc85128be32da005ad11f7c7fe7ecc0c58fded12dc298d050e2cded4fed499e0b9ed6951ccaeee889b45de62dca8c2209094d52663e8e74ae773824be61effb532c094a4c0c9f1b31ba43d402a4b1c773e238b46afa628e3181578918f398aeb2a6a536dd88098c146bfcdfe60f18c03f6619d4a5a56cdf5576d9928472b459c9fea409e0e70daa9fd5a4595d7d0082ae9da2cbc6b715e81a471b452c24c73e248b8e2445406410e9b5385e5ea162b2f9fb43fcb4b2e096fa28fb0f58b6041604e8abe3948a9c2f087d1ef3d8567464e4911bf4ec6387e0ec2cb0a92e0b674d5f38fee48fb14775d48d2078f81815b192b2fa63f8d9545f3269e129ec246ebbece2ade7c145835aa7350763681a6e12106246d8b0a3f26c0ca00d8fce3a658687980dd32fcac99ddb488c4fea50d79754c1913b3d80516d1d486efe6ab0447d410201baf110e37c4143b3466dc9440a958844715547564f3bcdd3e6debf545aecbad26076f9c0877b1eea5add23bf5f533756a5a1f4accd565f6264b5291d2f2d2c9d14ec13258b885dcc533cd7756ba56252136f373707b6a190c14fad1fd8982e859ee3c970430578a9b7997ee982869f6ed02817a98a45ae3fad22a17f26d8b29019f21ff80f44588fb889c37235142399e5e9f998b0fb8a60381561b75b6f555c9b8fb6f7636fd1b1b4d479655541e136a0c7dc1a3156be604c338b545f8588b0b08cc7e41a909ab9323d8b9439ab5a02e721653d0252e43087214a1fb1fb8cbc6023604d8fb1566753b4614d48d759f745d830ffd75e27f1cb6751ee50a5b5d24b5a59aeb1ca0324d06074e6ab4ae0d431c1f4359c7e4fef6673fa5fd912e7a1507fd389b67492305533a1482c6bd5879a28ad9d49a81b13d3bb4c7f08f40b4bd14dceb0118c1b844dcb1dc67a43c85595b5a98e948fbb3c107eeb03d622f5bcfe8c068180d2927e8b30e0271dae10eb76a05808b39e12da44a86dd8f85270369e6ee0ddd50056eea522be5a92cd79357d2bcc46f4a84b5c89fa320636f9a16a9933404d0b8646bb3d995eb331623e0ab20257611fde9aa7a6029207591dc2b11c5979a4e7f775fadf533052938e8d8f7d9fa25f1e125cbee2bee3ba5c1e35886ab81ab4fd1c5efa022569e56d8c879980ffb31d1b5bf9ee55f34ea4fdc033298052561f35162d6386dd7652d89baddcdf311ceeadb517385249f2adc4857b727eeea06f847ad445025f817ff34d4c04bf272d15731aa84c1c144d54371a7b625832316d4e28cf85059f4cc1c70cae9c8dc6e9483dba89b06978f2d6bb8381938938e4ba5dd08c147708b3c2569fc95d68df5c5005b921aa698d8beab822524ded35960593390da39cf067355373c15f2b45131b277bd99c57fbaa0d5144886188123685205b3ce1524e352e649ba59beebed88a6a9c6691bb66196fa6c5f66c2d501e0f7d74ee55b5b709d11766056a1add3685b5c462602bad5f9ec861643fbcd29d0b98b90f2b2a269a366c6397e2e8c2b9b20765bcd977ca4a909614ed08f6c6e35d82d8c84ec6394e7574f58ef1a193254e912fef5b806c7350f2a22f36e6991d0cf959681cc1dd99579bf3eea05fc40fe3cdc5075b4b8f05f7bef6a4bdae0f79d723f13bed050e908fa181bd41102fd8ac2eabae46cf1699dea58ecbf7852a8dbbb3ea303dff188174bc8effdd78e5d7ac448304db4fdb2ca059b257097a002f1296f9bf06ebaa48cd8bb7194c0ffa302618e211fbf30cbfd252c595192d3471426f900bcf173f8a1c6bc18553a35f648b6af44b58a0ee2adfdb795f1a073f05eb6631eac9088a9498b6381e01b578cde66ce01d4f6ec7d7365685e0590f1cf3eb2fa0b014f650000a68280bb391b39392ac60736be2223168aa90d59616c6813ada17287cc7ac241f379b0ad53d986053b282dd44b81df766ea8e44016dee21d8e2835ed3e9485aebd288e85532896f44aeda14a87501c0e9029f2dedd5ab653036556e1875501526f864d265217046d5d6674bb52019f7ef52401493e848c3c379034ddb25de7bcfc59a6d2102248b35bf922233c4e6d1c2b0473061ba2143be9bcb103e11cf34fdff19759aa20be0cf039b63a1e6c527a18de0da60993d33de9a88f29a0d715b939435099a2b7adcc383d59440ee9ca11e680c82db11acbc85c9c526650d65fab263a2aa8d7424ca47ee7801ebe1c3bdbb78f89e08838aba940348873c85e0cb51b299c6258ca7dfc94eb0520b74ddd08bfcdedeb2120d7b84f8c457936d92e27e5af6ac30f6dd7839f78545d16f115f502d74f90df7a53270d59654642d4fccea252b3e70a36f15c3be3d50b817aea057c49ed64a2267c2505d9eb485dc233a6b4aeca9de54625d6fb5af8d5f18bc434532c68c399af1b5d338c8e058a0504465ce4ae80591d09182da5bcfa6821b995332ac167281a66aa675c0287adebbcef8d30088307104339d53451600ecf757044cebc0c1ddf2865e9974ebfcf0c69552823ae48a968c4033be1001212ecd7bc5b1d0b41af19f584e4991723c0040703c02ccd10927c611df149a072e7d79c58eeef67b923f5d3bf66297d3a4930404cbc8a9639097a802476d48949325d031dfb0da011d5aff0642a358a3a50350d46df54cf84339495c7f20e51b5f8c44667ea60988cb0a54ac360bb675ac1d51f19d323a51e0192bd87de3ac545093d66a55eb82ea182efc561942f099a0611dedd3d257882a34b34b7b8a4bd3deb02c8a7097f54f1f476a114ac7a1ade7735d8f74f56eb7a3a11e6d0725044e1f8c0cb9963950765dfc3043b10b4be53804138103dfb76ed9d5b14ab048b3c1bae17028d23840456ee9cddcff39feafe8bd94142d780cf5994073850023d4254ba2ae1739a93987535e3f6d2e66f74c52e2e93239f6e3490b6fad857ffef28722903bcf6f72cbbad4515b33e2df71861123adfc9c74a950a5470591105b513059ec9e946a89fe9a93af1798d61b9817b61ef8be9dcbd362567eb67441f7cbcd045dedd8559fee2d2e2ee8b0aaa87e32e976110def56a32dddac94ff15f542e4b7cfc5efe6d3d05e07ed2bfe578460c88a52e0d95470e45eb3a4bfdd2ed2968c6d722b3b7de7ec521b6d6f57528f22a7ffdc856e85aa414558a9857fa0d8b8060ce4e9d58a3e493d9d35b4f87da1fd34f291eb747677ed2ec34c6f8158416fe4bba979755828076ea57fc6d010ceace4d2aa92ed50286d6dd54d0941eb796d87338fddc62152d4f35016e34510c7620bf7eb69d2176dc7d210d008d377c21b3b4d7b9550a08db280a0a534f091fa0e07b99b6c914356e57f4da517566cd784af5985dedee27d045ab64fea19f47aa8d64994beb304378a28200fb60535fe1aa875510d73a70e3b8378af86d2011c936ddc26e3445a40df63a9db4ba0c33b96fca93a7c0c273d917248485845f0fc83215b510726fddd15bba6f2d545c277da3e8d6c49768115a35545bde8a6dc2144f41601a722d08d198db232eaa611a6c914cd2d8cd2529b85cc000a9add86d61b87aef16763605139c2bc292dec4b36f8b329ba6907033a8814fcb97f4f6ed7b0e079f2c4f7f0b7a2a7c299a8e2f4f77faa7db3b4f32b1359d4c5a6108a59f45cd5098817756a5a4b7a0cbd22c04e374bad31b264c3e4b22c0ee8ef4e4afd8bf86f260e0872e33f32fedffa65e22c6e56b473fe2d3525e669c00c8802f50514d6fb5f417fce6255784d65b532707aa6f1f3b69029b522dbc5c4e361af2c154b6cea2da3b64662bb7b7ccdf384b0dcdb9a97e2c96c3983b3573406a5fd3fe3b28c33217c3ab9648b40c2650c3780bdc9251c246056e65dd7386a717c15ce7ca5ba87d466116ae27cf6e3be9ffa320c31f0adc1192b208dd7c66c59db63a76879448b9698cc577cf4f4d0969200d4509edaa6e28991a232c7f65d633c3a155298d4951dce6606cfeabed899b3a5330b28f68e5dc525eeeff0cf4fb80d92abaa2283a16651e68c56cefbdc86ee3eee822b181016a8ce32bd55877d66e99e15561c1ca01f11eda23bde2b9ba1002bb2f703578824826e060dc7953dabf34c0953aacb67a6f3d1b01025b2e421ce8f476636f1d58ae43a0658ee8819730115a1f9f392a21d17d8a4c92614069d76d1696b395b545a7d6c38d77ef35f7bdf721e1c400fdda076ec4e657cc39ccaddc3832ed6f059ddff4bfc466eb01087879a1b9becbb71d1fff1780e0d331515ad96ac232bbe0021f42444abe68e3dd369763398ac90efe40cade73f7763334992d041466f9ec0b30f2b946de6500a8fc75f91d5741a9ec06c481f41a2504fcf2c5d5d4e82ba193fac000021611f909bea40a06a31b22cd81d43a7d0358a2fdd9a978823fecfa71aecc9d468835f45d81e28ab7ec0af1b2dc1e98b10abceff23dc7081f88aa90fba4d8e88fd64da3b55b106a118ec3a11975ce1e029376274a0875a8224fa5ad6df774366b4dc55e9efad626b51f43911968dcda48bd4c96a7d316cba798d67d36faa17139c3ac6965f4756ccbba57659c6eb0fdef7c3a7929f7b5c07c2711cd3842ff7ef76276100f319133ab4781b1126f1e0655620cb52661ee3d72be937aa77e2fbb83a829a58f553710dd14420df4c0c562896d508c9bd803e13ddaf421993e49944a758dc198880477ef89c895c12be21fc3ebade2d617585b1619d4878fff30ba0cc98259f9b6e81f104d48945d99a5ae58ca4ccd82f6b63b48be258ad8d3a7e3750535b7c2e4b3103b2385dc0101b5d49e5b2913669fc9080befab419eac1742c31a17e52037e4a4fe5ffc83d7628223f8dad6d57d135a35eff9e1be8bad8790bc33272f81cc305aa6a92b777837d1074d8aae454ff94f550b03841cde7c49d9f1931e424706de9f13ec8ea83717896f5157895b37b5d347063a6cd278cfbc49801e721e1c729b868b84f397e17d477c1283428765dafba8488142fa8fad2250aabf8cfeacda14a26ea3a3beccdaed40d583d10b722c830a94c43d800c6657f43df2029fc393a7bc4c44fc187a9def02ef1af4f985a502564f0dfe26d6c7b4951b28178bc00e263a8d887d585c6dc905d072180c06881c221af4502294210fe4ed5a192dc97c252be2929fc1e5323370924d9eb1ed68512238afcaecaac3ddddb19f687360f604f83dd0eb87f2e1e9fb1e6feb6d1a8701380535e36aff9960e959ce74df8a5adde9cdaa90ec5d484c149523037cff0c80bd4cabe01011aa46722967cfecca1caf21d54c620cb1a6c86f9e6bcb0c1a1bdbadc2400370f17e421b5c53fff777443f456b3e6370e75aac9df29e8d91af9b1827c791e565b549e610f1979f71473b749ea50e28d3d88a0da8677fd6227e7e100b8f2a08544c55921d36a25dc3acf49fe30958cb0eb27ce3fcd39edd3470bdc2cc1b5bd321e11d7749886597bde3509889af2f99389d5e563b20640981e00a65c4fee59ac6c6424e7ad2f63ec53ba2c6f4861f993db3ffc3a1e38fe2dc5d6609b2bb199a347b29cbd0c0f7791e9e99c2e1f15eba24fb28aaa875f6ee4c6e5bf14abc7b7466ba6bcc4590d9835c83b5775035b67b7ff3e538e0db4211043dc01a0d5b5c638f4dde59f7e9136fa772fd15c8d7572446782a3131cc953992cded4e51f71438234a1027cb9906aaa29b66126ced19bcb7658acb4e7cb879223c3ebd199da35dfb66c8e23787555a00a41b8cf33f77a020c711d9a5ebfdb8de89638b7d237a58589acfef159888f039cead3342a5faca0f0c52eb03f62443d0e8ce0ec845fb05c85d576950c47d005db97444e0dba5c96fec3403f0d3f931835237b75e79a72ae828198e66ddd2086ee26e49c324154229a622c9e18be5b0698e8e2a4dfef41115c4f6a5c3c565ca20354045b7f26a7b985c90fa2a19ee52262cb7be110db5f133d741fab0419609127a92efeb5cc92ab04539c51ef18e03296335f6946f73781359d9a85d0920b6472027f8a089b5d7b2b6c5b3f95188c37ca7e85ae4cd32368ad32a0d5b4e6305c09bb2c774c44fcfb7c4140c4b9d23a5469ff82e1bba904436418432067bb1a6a0dc9fad5360fd928edfa06602613d128f3483107aa34b764c233be97fd73e85ead6dfeee0cd30d9dd08e2f636d14e328a688058f1682b572f851672d750da77a693d87b89848c69fa4977c1f3343d0a981177525d76a0ce753329b4c103db9f727692bc93d2f35d24867f2e8b3dcf8d0dc3e99ceb230fd7f4643a4795125623e06c83c914871ec0af4bbf511ff62675a20e01a92dcd36dded199efe6805b19bbba17bda8b6a92d2bfcb00b07d97be8081b4bedd2c161580e6d6cb0c99c80bc0d9e248336c34c8a61dacd004648f17cd455d0e819f1dbebd96f48e61c2226f89900c1ea432bb772cc41e2e1caf74bc7647c01075a625d910e873540b3fbfc4e3949ef9796a5dd5afa0df9363b3cfcf1aefa890e7dc0f73993566fa3256320e2311ab25d860b2a19d6dc1d07517231b8b978cf4342cb087c9ecfd8757c318e15b76f660e3f82bc4d56f0a58a3aa9b7addd5a0c3ed783fbf1787c248ec3dea3760411b7657e45f8710d0400ddfc029f9aa455901371ad3533843f7c785ece8a9b024fea38d5591c457a3b480077d01db429b37b15016f640f8c5db689fb34f87f5418e0da0512a5651f5cc19a550675d707affcf8a2e0224f5483c8717e7ea73da36f026930947c9edd530fca9c3a396e9c231241a2035fec3fb51926598dbc45a7ef38558f8cc917b973b926fdbf592d6d68da70a2242141019376f46c8995a9f66116a5ee3c21e6716831b9c6816d04005da8d2738e710b042c8e060125f6052fc82584c6851001e3dfb5e0b24df32a045a90547c2e60921cbd2c1fa7bfe2a0c5a20c073c3710f2df131d63df38d0b98b7bfce8c085c358f86573f0d0bcad351a01cbeed07ddc9e735b44daed094ba0f80d824f2c35440dfe0040bf6415e826a317937ec75b513679af816552955b79041e27a8586cabf837cf40a091eaad2cdbf3ced2f3140abc6abe31fbce0d96f56bdb35ab019c41cf3bbcf8e75a34d730a8e2af9d93377f9afa6c88301c1756d3c1bdf8c76f91ee87990ad4f36ba032be697869c1225b0c696af95be7ee26c1ba679a4b7482e55c6ec87f4a2c46d20a7c01971a35a679d1398116fe7fb74305425fea73afc1a06e80e94f25ca01d6653dccc73f929daf6fd4fc35b26b44126efe34acce6addc79114a29601555d23dbd97b95d4bdd12ceca94c12d73ea1a162cf1706ecfa7e94a0d1c370690eca2c150347ab9328f5b1d4b1d09229146baf6b7e30245728677943aeac221f42041e206568f18acf7cd2ace4f0b697bcaa15af4d027e4967a44c133ba592f1c148fae76948b1ce72c32cbbd97a061546902c99ebfcadd9afb86e7ccf66c239a4a1b9e7a15aa0c61d030feb10635ad5fc91d7900ac386f9d95dfa0c068033ef9c0c8ec2c8e314c5108625adbc3baa5190dd1492828a12e8d4869d412a2630972c9a8d77c95b71db6b970fe292ad23f1bcb61d539583f520affd12ab4cd9a0d075b3e3a027abc48c3bc1e1a22c8d8969d30a568393162e452b4600f1ea48854d1092857a8151e4e4a192cf2ca13edff8efd36ec4d9840fbbec8f2e3472c4af78bad9e7dcf5536a6cb05c38a961f246f2e76f6f6901e28056cb0e675361b6a014e21163745ed116454a12fa33163ec18028f7191a34707733c15d8072d76e39b83e2331c68249006b242afc3033e4dbece129640c0f4781b203808282a56dfdf3e4a1aa38b894047ac10c3b668ec9f5720a7ca12915ddf4e0996534d1651e9004e301dad36c9e137e69949e9770645c33465624699620b58539e3d608286e4134948d1d60e11ac626e56fb04e4c5ca32dbf7ab489481582fd458611869cdda0c729ad159c98268b9dc1930594289ae984adfa2ebc5aa96ab9d4d255183ee90d46bf7bd0c2d6c1ec1d3c8304e14a9431038b72a54af3e8c7e536481edd1f32335198c65520668c6f9f7c2afb7940a342610eb86e36b1a70827b70fe5486edfcc74c8a47f28ebcf8da5277de6812ca874458626042332aea220f31ada549e1b902a6d7dc88662ecb619401cd472dfb6a9556a36783e3f3cdfdc7973e53bafd2bcd3eab6174e80971539a8efee7d87f64a78a6b9485933003ae7a250a73e4e11d6ca3e488b861e8a124e256ef94ad2ac81e62e55873771b20ee4991141990894cd3be8bd5f431f670b21fc9daeadcc44d840c73df86d31147e40f88a04e207df5a5a43c5a614fb81f6cad0535dd7c3bc6024714ff343b9301dc7794b1455867dd47f63915c0159f959c5b30952cdc9c0b0ba446bb719e69abf5b390100d1578c2efc697aeb26dc221ec55ee224e119a493b99642024d9830e5fbd6e31baff2382852be0cc49ac42d3d8f37ffc289e0b15fd4a63dbfd7971dcdc73b88b96ac8f3c8eaa2b2505f19f346ac0f4f829c671f6a58a07d39ad03c23ebe044a0e5b23758c2e13760d97666d02c2ef02830b4ad04fee2264cbc305214b1fc6a1e3ed9312c1e919c88a9ee1bae8569fb5adaf5bbfc598e95001545aef0a767a05f5e4939aaff8ae3f9adc5f6ffeb8519c18b3c265796cf68e3265d6d7b0bfb7d6e03d4d8911837bd85c85495c7edbbcee4d8a6d6cfcbb9cd7b20369472cbf71c9801b1564259ba2d0f24246b24a9de6ad9209034e3fc8ac2156925e5d9ae58a85c9d208b52440cbc5752d72aec33f0c0ea95b32462cd92aadebbcdc616aaceb83ba61bf913d98d597dbb819fc6ace8312347bd144b341f01b9ac247775fda9f06006269d3254f4f9865b02181c9ec143820cd9876b79e47b00b5aa6cecb57329342ad30c472da632ea482d5a95730bd469efc12081d60836eb8a8269ad8853afdb9fecc15a9b880bd49acca8bcc0cba8dc58bf0ea1a1cdbc64b5c3b47a9cbeb8956ac443ebd7a0e9e0bb18fbec5547e1da828c6dbe54f53fbbfcd1624ec5fbf6550da38cf8ba13bfd6332e344a695e9274eadd8ed14dae27ec83d9e0646af8da69e4b539f5f5e0bec80da7e222f2e9a52d1c9b3e82ed4c4eeb0ceb255ac10b01c3a96a687a4a15f5bd8cf3675f7832e349e668a3f62a0dee118f5986425b0e188a6fcadad57e46f872628f25245c0045f7ce86872f977cf4276d85ad95c0344cb9fb34d2a03e168588b5f4488205d1893781fe4338742f0a1fbb1fca892f2c30f730eed51aa756824a8b0a6c518b2a1e852355eae3680f4034fe8ea2ac2087e323f284af2271be57ab7758e1c918619f33180e95686aee37cb85a87fde7de57d16dd58c87ea158f95e82a64298f2836ad06f93d43bb81e19c272eda3057c9aafdef3d80b43faaf4902f45eadbc75155e11033297da9dbdaf7236e93e48064ca30ca35e44c38d533f143822e17356d436e136255abab67b97250008880d03bc34f7d2e91eeac1ae63af549850697b062fe19cc56e25a8b3d840bb4062f956c80408f97a88d16b11f851461a013962fc1fd1829e512df93071b062acdafcd448c50afb5adfdc95d5f2fd7438af9c3716a70e47d7bede21814eb434b11acf423caf77dc4c202228f51cb5e5e64f3946e09caf6065daaa01566ee0ce94331958d855c0e8ab58b2544b947c45f62ab908f9b712642875b067a0d8bf3da63b86bd2f4e353aa16e0dd508e4952c5af0ccf5b5d3065c71d2dc59456ff709dca3777b4576eabb162a62d6cbc5a772ad76dce83d51ed3ed96529fc93fc0f1f17e4e4a17d442a29dfb790150267f85ce425cc3ae4ae5af011a48d3a780b8e5d3ef8837bb103f50f20e6e976b9ca5137bfc80996fd603bf36e6dae6905879a6e223d1b5515a03435307c5f9f1f12d7084856bd4b6de39d8a255ca3f3974c03623be9b16064cc18a3408c97d06f58caba183ed67b434b3f4c5f23cb11c6c2b2e16a9e43a1483a0287fa861240a8827798057e9c53a12fb30b9425cb9a31efde0cd376753e85312b9c1b24792ba184e9544a2ac0b71dcf73ee03e85c37d409e1117b4958876faad24745eda431af62c622526735831c6c31a4056731bb77ca2430c4cf5c6dd4a2df815d82bb2ff001d6cb356620871729863da45f2f6892405ea55ec9f5a0b14ea7fe76cfaff019c66b9de780e8694cf216796b711094c85c8eab468e5896158c0c196f1aa03baf0e2d97192e41633633325cc9c36682fa546d0a81b572aaf2935ebc2ac51ae0d5543051c20a444392e93d401b4182bdfafb7d20a6e122426b7b61af448b87e76d09033ed2565135aee782f3197ccbd36f7e220fa9bc17ff85d7f8807f8e02cb326914903502165a81d8b2436ffcdb7c041c32b96c6b52bba3d3d0978e58568553dd0b7565e9e2d4658305bc1f93a2e419ed20c704c440dcd7683d978fe519f25a5fe1715666c8b099c8c7c3ded947ee0f761ae7bc5d9a19f98f5dfc5c6babd9ab79fadd65bc7fef541f6bc43190452d1dcd5809d815f7076f333be17b6a7bfd5e385a3358d2c1bd8a45d9279cf707546b15c45c666d18e9e9fae52e5f6a7b67ec92edf167447d8f517b773899b6d897b294827c5c5148963d51de5edcb65dc4f62a70f209eeb5c7314087c270d1ade4edba853333d97c522be683bc3dab46ba601f17322e5b04b812fa082ad54f25e46f38962373af62221cc7c3467e1c4f3ffc221341702b4a4090dc7866326a9ec2b1918123d455141360e06465617c871be7a471c3b2cab48675a2ba6c1e4503ad6d03dca2e7e60ec8236c3642c38dfa7e7a9276f221e236f404510ac3f3cb26f68c516e1168a34799061a13b8d75417fa4e15dece7f6ffd8748815c7dd77c8df6c3702e1b003373d2f0da7a2debec25834d15c7af8376d69084c58d337a08a348a497cdb5047da677afd3ffa7f181e9816c069b78d7b33b8d511d624831a7ec9e58f8f88b7747e5a31b5284d748e4f4b7f53d279fcae90a5c272ef536ebd5bb39fc306bb5afefc05d0f367e791bd69f522f2da23a2fc5b206c82804385a263885911cbcec31b8a84498d992b02ff4f79b6cd28f1f6667d4172ee7098efb17f084cc8c5e213fc2efe6954ddec9484fa8beb54c4f22789231d357ff6b043793ee16186c584bee119a8523d45f5f8b1b94e494b2b8939b7b489fd81fbe60a5e498746d7cfb732a2794dae9a1655e1ff93369c1c23bdaf1dfeaf0a021c3f9cfdb1b242378003cc6dc8b529c73fab9d4eadbd00f6e253bee43d4d86345a7d58fd19f624ab21d5050df9f5dcd82f8f2b3d6ca94c4d13e49d319c4fe667df286f2a8fadb8b0a2b481c20b65c0061dcacc389a257da8201ab1989137c110a2cb957ce7ce8c702a6f73f8bcee686fb8a8c9ee28bc8f80415e1d29630ca22d5d3ce4517507acfd690fff6a226d946023712549044a40d56752d4286adce21486f29d4977a8d67603c72532fde3e70a9a909c249cc765201d13add4a6288e6fb19a4fabb872f6a4c2772a27fd90ab6d234a8cb8007891ab921364979451de0809290ad166c18026e8f9df1578cd8af403f95590d157df69ad708c9399bdf760cc2e49bb2efe60a88f17a00ef047ee68ef9b54d14db64427896cc6dfba9d47756c3b5a3d07afc719f431137ff9bfda67ef71f622a3302055163ad166de1b85e331e752bef169da00e6e97c9e2c51ce30c8b1daea2f8f9c640caaa07114ca6bcef0e3be111d2e14bc78733caf6ff2b178e5d33af6df733c9e4b5bcd2f5bc4f4cc0911363b0db4febb0ba741fd7fa625496c08352df715b7c0566ff676a02becdddb378cf0aa59b61070aea9a0dbdcf274c951e857437fd9a290a84a5153411ac8f722cde9d3848375bfd124908cd74a104f64fc657fe71ff037d526eab4263b5b028d6d330e2f5c4e40172d2f2279cc34ddc735b92f97d4aa2541d915c7ff0711ab8149d11553c43e89198d231f3fc44b48b2413268f1eaa32ee8525ceb72ef310ed1ff7467aeffea963ce41278ff2261c06bc65b04add138cc0e62f2609edee584274001820183920017907980e56a0080eb680500f7a7baf33c366743dd03f9bd14e073cc6fed311d7e9bfa7ee8853b056251b92d1997ef487ffe6d9b681a89fe297f3b921879ab3072fa58dcfb2ae838631e99c5e466430dfb4df1f296f12c358d7cec930ddb87b563ad2f6b282e4d73a556aebf26017467c1792bb428ef027b47b567d3514d811a899435a2fa1254c5b3f1b78ba753bb0c6cb6302da7d7834f2bbd5a5183e5628cf750fb73714827096dcc4eff1a9a1f4a1f4736f48b4f0ac4ae348d59b26c26f1d990646647659f1775b33a310b3a290e235884c703ed99efd8deb9989afea13b67af333ed2a5780d48a1cbf4c01b1f101bf41216ac668417a11aaab73665c8ce417b0a5daf4e08e1b30df7f7b8f846ece73f6242f36f92065828444dfc76e7bc4d916b2f9ce69e35779a0b46097de087c7a6f89c2184cd7561beb89bf03e3faf16e799fc8351dfc6e0db3407ad248c9c2a73f0e7330b421173d9cc44aafc7e1c448636f66835046f6307e1dbda3c969ed450beda02d09a062d1a284fd200db7a4fa2a3bc9f2224b046ee0b7eb283674d159c50028ac12d3e3fece76d2d86f471e9b2928baeca0d112aecdb49b260474b1a6d8726cb66233c311ac875140a5dbc46aca927c17156fe1ccc75391fca27f526ee64647de4f2895a2745a50c6a3edb3d31bef65a021a26ca6f22968e79eb953e9af3b6082e53f183051555a2279a8ff0f048cc4057e45d42b476201ead1a18dd6b671608417df941b9d5969e6c4e79f262f09cffbe612e9a9ff74b2f59af221bde1eea939136ac12b0ea3ed91538a2ece064f1f4d2dfe73521bda814db9822100682acc20ed603f2ea94271104ee966c2c53f2e9a1c8d8c24ea6456d5d3241da0cb5bd5d6702706c116265c6680c76fc3acd18c2bb829d7c8c95faf6c7de70019dcbc5b58bd44f633b2c765ac8d31a0054992855213d4b8835c73f090f1fd4b190b7663daf6c3dff72c232379d74112d8082c0c66f774e7f828ed7d5598a506ca614e352b335c5a90ebbfc28b0a18d2e61e2eafa2e0d76620bba49e950ff7136e68d83e85f66d43521e73fa8fc2c3d00306c06ae774708f0f08f4ece382e3ce6b00dd5afec73609f167c7905b4e3a8fb9f41b08abedc78beb7628727fc0f8d2d909f6d2eb47f70e7a203b3d1ddf1bfbeb83dd9f393ad39a64963764bc03d7669938333a07efe72fbc12935f108566c2aa41153ea9cdaec925f68d53df97eb02802bdd2b5ffcc0a3d8b4db6fb3e6abd0e4bff72ff78e43ff74fc4755b27449c926aba374d5bac2738a9c366bf81098b96f6b481c3e730a1bc955eb03ef5d75e0997ed9ba38c8fd27ce4d771427583b2f2a4417ecb0cd10c8057962a9742a6b4c746baf185f7bbb3df09a121fe38cb7740e94a58a0b0f506c6b899bb398b993a47478dcbe7c082b037888352c362b00ad3c64ef34a252f8bc034f86a6865f358cab884fed4492b9b2377d735386c65d903f13660a4587a4b6e2c1b7bfc5305c8fb876af07829e0e0aae513c381884e43271e7be3c2a6c04fad87adcad1a8380481f14c884364633777066fdf7a8e12728168244aec3b313d05314c81d7b7a30734a2415736dc51e9d787651a95e8575f760666ba6bdfec60865253195e773acb858f52a0b9e2143177c1be73441f8c271ed2c5ee6a95a6f996d3ad2ddf9b8264e1364bd0a95f3aa3a63a4b3e87daa4e1dfdb5299b461691047f9f57e96abe42b6631051f026fd8e9f731731fcf161f391f5e4d85ceed41d27be56c2f6392405381eb61b61f8c858c9aa26e2fe0ec8e8200b5a9e309e886dd7560bbcf68ee1005df7b04ae926bfdb6aa935d4cd908066f78fbde2c9df8765c2ce4045bc17886885c75d0dd284ca63f35ffe8fe5e3320377b5948be8492cd500deab938d6ae1ff1ee10ebb7aff70d663f39d60ef818303ae418d739f02fd6905bfb324e6a0bedc0b3fdc7b246bde6f7403536530877bb32c31db2f8d423299702041e76fd637d4e3054d5a6cea47f44239990123f757464a1718bc5c90a8855124ddd03b6af1214b3841d93cd061ead8a6a555bc7fa30ffc4c32bc88e0e1cd65aac015f1891afd3d3d5e12dc8f46d7d4da3bc3de2935d20e12eb1535245400d85edb6773e1e84c9291fad6b36dd0e3859c7250aa0d9df836e1f5922232c31e155641c5258875495e7e8f16ca97358153441bbf763bfdae140344a7d98e631521a1e1a99a1028042ea06fe8e808457a9775893091124ecc26580c52f9c9834085cd82df7152f3b856bf2778c67b39644f0057cc3e0428d92d31e4430abe69fb0c8ae9e1ecc3cb2902e35a770a6b6939822884e3df4e4bca5efdf1c91d98be1a740f1e2562f1d6411b0227df689a259b41ea49777614922d1ea0ae927f2c4177b1af5ccb7fc2604c13ea3ccf4fca43dda1110f15573ee60ba0fa362b271e3183e61ed16ace6b7b8d59ea8f14d6dc4fe877e1e73bccf7c87f02a9ac97212c22e914432b3b4379f44835291edcd3ebc776a0226c3a7adbb54d362cbac38551b04b1fa5434679f2be97f8af33f747289e1fe566a6a21ab853bbb661d5ff4d831e6c9c6b6062e43d827cf52840738cae4627602d7bd5f9ae41c310fb26864d18736cdad40e0ad75e33e09dc38c25e108df79abd5fe90451dc1d942c1168635b91ae474c17eedda81dad4becfdd59d4e6d56be05929d58318c6a06fb61751429e4d84e466e9d07a87e066dbb94fb766d2afe04e3bdbfa95fc0c170fd4e462c8329fe13d7021371e7b6bb46553afdb10cd9bf961a89188431223f5f00d6ba78a37d76990d3e40b5970d831d0790d60473eed292fe910bda5ab1308da4fcc4646cf73d9881b98514aecff4cd1002f2cc8d62f31fdde1c480057cad5c4b55126b873ec00cbd926495d75018c88826ba3c52df23b6406e5045623e72366c06de520b66fb2d1a076f8c7ee5a6595036fea421df3a518cd5d71434325149645d1e4269730124921373c7058d6a6ca3a87a772a1d274002f2213caf1628b05b8e465de69c1b025c1796a7ddab7eb5b9166074daa21acd813e32f73d243c35a1b35e9e5a04f9ac006cdb07ae6c6d61723d93d2fce97cb5789a77f7a85be9f051565b82aaa1e467930d6ed2f124de9c979c8589ac28b842cfa7b2ff7b44fcd6497f305cc8a0f5a438e0ef2fcf84cfd7ef502a48e704b0c8a4c58f1b8d8f428be5987278dc5559e6bf4adae73c439acf6f45435137a4724317ed190f48e38495a533c3fe6105902d90ed6479cefdb12e6ee03960280c4391127a97916fa3c07e174ec7cc3e870564cc9ece5d19112ee496be15cc56db8ab81685b4d3b755aaa063eea3484b7173d57003ae976ed5a3330c5d83e1d7fd72c5b4565ff889c6b4ec89dee7fd648188388c837730c68449bedfc6023fe909de2a891432cdc14d2c3aa5fed86f4f468fa28514e6b02f814d60819156cb31e85e1723c300a664dd82c194b80a03a82cd0ad9ef155ff41b6664c75b8f6de47f64d405d271e82601e1d8940d90fc7c975402a83ea2a6ac7a1af0938a8dc6b6811f0a4b4c2c8dc1f7f189dd8b50a6a0a6b9602ac66e24ea482cef5485648807f9c47b4b28e16a4d2744840afa2fdec142da10c45774e4f8d00b6b8c3f3959550c8cc99d99e28dba276792318fbfccae2715833c5a44226e05fea2ac72b42441402fbdb56f6b2d41b16141d58954823eaec93a2e7ca4b65c33da477f0ea5c84340171e8cca1007452d3017d1bbf4af5004174dee5d1b42179c99d3bca088b29651d2b00fece3a155e512c30020d1b6f934b8618a52a9b4a29ecca455663af9b0d0670a6af1bebabd62610826b2b8e3cad3db4bf3a2b2ef310bf847a546db4153b0d1fa266e7a1392f6bbba56d29b0873feb9b12744252debb6744ee6f2cb1747bc9a16e356708d24eaf5334525671db5c67178fcff18b5d9cfcb5f022e9e5f90bc78f6ac01ee2d00f2d67e9ee1a57acb0a4861db94a7bf787333538bd33532fa700faaa786c3e63bd103c1e7a32bf1073c98235daf78cb84a90afed845d00d883a160fb05a573ba8e72fe9675b70fba7ec3fdc042bc59e2a7f2bb2a3d0a76bf25e7d261c7de7761475152131ea258cded5194ea8ecc0618e8e51f8652fd131b2930ee24720c430b3a42274139446b6ca855783f955b4a5258e2d11a597a333e2347c4233c89e69a1fa75a3956ea3075999a20519cbaa4a6e2c45eb13659c1034aeb79421b4a543eff171c3344cc6a3b4c225a1a575c1e1c5f8bce48f1f1331d71ae972bba15e6043b0a2d605e7f2e6a3427a0ae7b9c3e7119884ea784038dc94f159f744e7f536821f13ff7d85850608d83542bb217089fa258f4d0f99959d50ed6da5b97e4cf3a9712aa57ef43cb46976e8e5e750aab2e44f388794263578c32e1e587ec6e31adbdb7cfac5ad30f079818a4942f3c92395e069146779748089e32ba3a2239147e7a748f954dc504b6663d4383c31de3ddd435fc89756b7531a39c4f318ec9b6b58d343da9ccffa63d22c518a6a2118b4b086d8626f929849fddeee772cb630c22b436051ca63788b4b1a73bca38b92d06fbef12e45ab7d190cf48232df9438296c2a4b2b6f28b73efb7966f6719bc649c42931f624ba8f0d3c33b8b6f8a64b847e20453bd29afa092a5b46b20599bdef82ddcd6f255280e33e4d3c94ef199c83e27aa83baad41727001476a886ac7dae431a103ead303476b9cbcc4b17fb9639de5434c16dc85da397097d1cba51dbf4b57578315c18d9413da0a3112a6d9062826cea44c7843c62d44577790126f06529f1e727e4ff4b9c957a87800bc4654c10b20bb08f41d429193faa4d7c26c3d0cea875697ac3a5c7549bf0cb8649df9bffcb3df7b880fcdbb359cc2f31396b0060615351cc1615528b75a9608fa17465fec4440189fb6354736c9c4248992e86e7119aae164329df4bdb11f6d77a905727646f2d4574765e520cc1b3846fbb75c9ce2459df1b5a2d8f48a6ab5956267d90bc512ac37fb358faf4d4ab54cc1ee5224d6bffbc39a81e928462bc37901b3ad18f2b1998bfff23d62eff446a7af5db66333b7420a6ba141fccde01d4dd84eeb39a42bbd07e2b97c2f8b178ed12acd4ebd1b3a9b9038d2e19a2085af44b15d29046c66dcd54febd8289f437b985c34532e80c1b220e74005842f4b623f42a15bf8d046fa02ad2104c1912ab953a75c6cbcafc9059572fd74c93194262148fa84045622d783cf3a1b58ef42256da3ba3cc404377d8b67d8677c9e9297a868439ea8194ee57f73ce4f24e7728864cf24c67c58fdbba3728e5a5b4dcbc540d2128d000e60e509c83334c165cf13018a4630ec647efd6f7c2abd9eaf91649d813af5d5124bb90325e5150d408cb51379690e9c7dc6a43a220cac2b724f58ee8ca418429808ec76fe9271af2f4dfce506facd717e15f5880ab3045a8bf0311de8cb44d5302446d636a7921ed4f875bbc4e0381c356805a8af0ac8fa6245a4dad693d3194311572cc760896e99dbfa191b0766b86d71cddc25f194fc8ee219daf7178b1a56df14ce8f6fd761a3d828570746ec8d27e4a96ecb875c1f85e475c61a6c68f2489308b5d2a032458a856311b5bbd061c490c8a0484193e58003ac55ad19a9284b8b7f38273b2c6b88e00e9c775307db618f905c90c3e65b068bb58e34b928b5b9614a860c6772e89b4f82705c560b3af5d3125725c71853725e2488763a072b43dc282a3ff9bc41e351ae48f02fa71e626cd011cfa31b1616d39e03c122dc22ccb4a41b4cbf195b9304464ad13fea78ab3eb9ae3da69c52d95b38fe4170b4955a6c46a2cf8b55367ac17ef388565acc6196c1634d31843e4b2cb380aadee986a98c64f69f5ed367c7acfc3cddc06a1de04ba4d5d2a731d9f46f08a449246b56bcfc797281bf1c2d182a22090d48c01cbd73b3b534a4d77e71c0f20dbeb9791ff684f1e1c276aa92577f5c879a181d32408e08bbdc88bb9f424cf2d22bbe98ab3a08362c82526e5af200f6a070c61241682fced64898c02c6e0d28782ab263069ca16d4d67188cbe916a24051175a70eae24406490b836cd148c426a4803e29668cef64f42d2492e4702cf65fcdb886cded8b748a55755f7fdcd7f952b1e944090f463e688d9a14df0ac35192f9e4218c538f5281068b052411382e4e2b3d985cb174f6b2dcc9561b662801ed32ee529a636f1b6024581231c04567abe1cdeb3f682006d28b49b8d4d2c328fcd3285d38ed99cd3937bd88c1742e89fe4d2e66d2d8e3f7332b86c90672b9f56eb6813f2352360ff4e642d4231afe4de98e3d18947a1afb5221076ae5665984259bf39fe38c6273199ef182483c70ececfeab0905ea0686124bcadceb09586b42448368408deb691edf7ca301c5a1ab615fb41745c6c8206af9d89c9b153bdc3c89a8716cacd0215c0fbe4c6fe3263ae5f41d7480fb856927c4b34976608296ae78870b4da93ec70965e9102d6dcd2713702ac6388330e854124ab79727f29504db591f8483c8bbc41ac1ce639b398958e410d5420afdf236f2cd82d5353dfbe479efd72cca56617512a36d029bbb616ebb3323e20781b0c220134d8c721ff9ad0e9071b2de3547774cbe5be287e21b330f0dcd87615df31bde9d26cada552138cdfae2b37da5c2d5b8746bae9dd8dd638ccd9f38e45162703c5e9f952994d2db54f7456563f7c9756041d49386ebe3ad4e65f14a7644fa05d67e759cfecca8e7e7fd8badda46751e74e68fd69f99febec70a245d991cd0cf7d2e338adc78006f2a60208ff380058f2f20f4a3f2fb6c064d05790d9e8a49392adadb878d58b017268befaf52782d2db0e57af82c88f8d5c921ebc75d7a8f9f551aa994877106f1deba992ee20a1751ddb93ab4be0fb2c102ecba8e0793d848735b1b0954c9f943c5bd55783cf267542825bfc41d8ab3e777e25df3952d4045a4f62ada5bd378ff4c60fe22f90b0cdefafce6c700e031d0ed6e89c1132d5024e886849c0aa5ed70323c33adf7a56b804ec7c61e93cf60282fb2be662e3932a08abc7f2d761236a7f938e8ceba44e5bc15a0b47154de7aff1ced797682c8341d0eca7e67a72802849f39130c07e5db4e1f3d4631a00292c4f3db8e729f50ece3a26df2342586561c43c4166b3b78b5b408d2e09b2b924e57a8b2a2e18b1403e5fd29d7ee9eca72572ad3d8ae9c7e77bfabfdc1caedf547b6195c95e4a6cac7141c842c8e98b6a136dd102978d450ad3fa47e2cc590995ab88463be353fb5a223ba1ad24154823f9d9740f6cf647cd9e1d1b048cc2962f75237d50dc90d2943747d971754b353ec25fa229132c2087eb5b40965342d30becac558cee9665a1aa2f00a74277ae9f096ad1918b89c829a5eab228a4bab0128d5298d1be5ee0c813c045584a0d48ebdc56024ca69119eeaf9ca858420bd145cf788a5c446f2b8a62b1c19057783222d38c7c34f8ed59d766119121542fb37b0c166215882362b458bdd31981fc55fa7500d18f7e1ab22cc8ecda2f52539c86b98dc4411bfaa592b06a709a982d0535062953100bbab64d393e23bff4f3522aaef91d90d5bd0eec21c362d28bda07b6b061887e3201940d952ea5b3bc4b048f0861b15b9347b09a711ee94a495eb66a084de44f540bea239641671fa1e0e1b1ceef2e37a4d532b3ec52aad26d24d31d785d78428b9dcbcac90b8258e06bcb6099053fbc018dc5fed4a94da1a58e084e48d55d349b472ff6d9e1985bdb61f516ebf4fa58f445d78860946472de21acfb40f21c62ab92588dced852c4f682a0b28b445412e6a798a14b05da5d4cea92d3220587870ec6dfd24ee99cde54886ade9a17d869a9e3da3601b4d186896526d0b7690bcf4583fd25c8b3f53af2b5d6fac8999508df43fad237f55d864326818df3e0b292c9e43fbd2aaf3e2a685970265ea886f2a0c9118caf877daefbe06eb9a351a6e10cf62bc17562e60c4f5b13a241fb67e2c902790710555ebc5970183b8bb41c14d41efc3c8a5aaf4d6f8160b64e6cb8dafcc4b00bed56f578d096e9bd8a20c6b11a8fb9fe9d5818cd19dc014476090332c2b08424d6b4c02b7bce9262f5626a81fa4f75ec388f075243b7f8b68dbad72cf7728cd0eeed2fcc2a5a2ae96fd903fc11f65e17776ac111f07a8b15528dc1e8d84b4d4162b9b4262feb4b68512ade101980c2f5aef3de68c2d8729186a457e887d03f670ca39076b7ee79a4a54ea3f75a2820fa72e3a2bb2b97b0d0128617622f350045fc68cef3915db3c725419aa90ae06a33918cd34c2c11cf0f0ce86f1bc5e18c0e1225d070d4b0aa147f06a224cb65396f214e0ef4bbef64fbe1c895678ec20cd68b1c52fec5a7f0c8e3d073b9a5500b5c9c43d1b32368a76bcda51b9f6a313e131108375fd7a2e62a3a09a9c6ff21c71a0b863945ba1f23e83cad848bd8b66a52c8129114ebf17facc672c0dfeb174766cb02c989ca6620616b42c0e9747d4993f5d02fc510706b86ac6c14232674faf873c953a683a85b0eb4ea27c8fba19065a9403eb8341e59241bc3f8b744309a524c1e44c39d3c611c2d41262de5aafd3a6268599f18ceed8ef5b3d22d23a19ea1f9f186dd41f0bd88a61ab4b1bf0653746022720d906259f339aea65b93e3d61697a630f93bf436f6732671dd6daac4fae8cabc8a0a3c751c8e4dbe1585fc762185709f1c059cdc4678ba16216cba89e0e43d6a4fc28aa8dfd1845930356a442223e8af908ef7bf7bb372bb9e927d9216c62aacb8c382cb4ea3f7796e3d7919e4ede2467f81d1bba200cc38ad361183a8ef20a4ec7146f0579c64d0f527857b35e634ef4856b5a35576fa0605e8ee411303b518f1aa7c1c4f351994462f2b60481147ff6fc294dcf54b350697f89f0a5b130f0ec41cfa40be8e0d0b9cc98217d11e113a9a4b61c15c74b4d1156da626e417f511722bafe111f397edcadcb77c140c2e76a59411e84a05d853a404a68a745c5f941986ba916d8dae62a3569cf903798d64a8b421ea96594525f71e16ffc1b010113c924cc7b48136ca3f7106f27d411cb933ec016f01be4b0b7aea57aa7515f5b71aa9a836ba9a628162f1753b250def39c192f5affca93a217f6909da2f866654d10308b640f151f2d4c3e916a53b3cd5ce41ceee58fef534fba8362717bdeec4d504bb729134542b6a343de24721a81e4a5012085e2e23525ec4fa41476de6a447c51795edc56acd2c0f2f24152e33ea9d566d387debd72e70986a03f99d16820ee49162eeba9662d80a7049bd3692fb3b17ac38573a788b188a4bc360eea55bd1a227c972222e18c881d821c554e466f03f505e6de3f9b8dba7f7137716bec6deffca87e5031a9912f9fcdb5cfa1b12da63934230c896a699c911e67111030d3a083a9f2bd6b6cba197688df1cdbcd4095ec38000209b66905bbb49f992308cfe3428016dbe851f66f9c17ea542a3fb4b59f68a07f746e08beb48e6223fa1a94d752996e56a980f3ac0ac1779e42c05578e8333c3bf189e18bf297d0bc314a883586712ee8fe098718563355de20b52be0b8194e241a0b10efde29cedb4dff76a4c1aab6230d84e9fb7cf9f58bf0ba8a42e5b5db65694a613c1c35c38528437f6d0fe7cfac80e92079868ef447a5eaa9fbb5e5f84e322040426600fb33d74c562723e8340a65acd5d3a4e7b220c0a1931b5b5697ca370a5cfbcb83fa8a0a1cd032d943f4c56a91f6fb9e6c225ba09e3a83bc8fda0c2170a711c75b150c615c679b9c9ed524d07a2eb4e6a3c3988a5139751a7997e8b7ebb7c4caa6baa2495fff4acb6c855a4538e4b4ad173d878ffe1b5434626b6781132540b8a188e26eb79c794680b2f7cd5348e7642d6be68b6a5439e60fe5b7718ac57477471c25402ec1e20ddc7718521a3a8d9ec6a5d84746d0a3d0deed77552f20eb5028a95ec5c1e33d4bb89e6cef9a2a93bbcbf43f47d948c1fa60433bfaf52c47c8d4a320c307a5dccc10f63251dfe820ec5ec30d2c722245885e2a1ab313691e53eaad4a81557d4772c15a23e7742db952cd5ae0bdd48e3c61a33afa96c0ebb55743d1265276af0a45fe2541daff801d69652f4e6ec1d22f0d2e974680ace0e7da049c10cc7f6b1cfdee4ac105620b1ce2b522097badf6ea790f5998fbf0d9892458e9495fe5c5ffc97f9fa357c32430015a176d38c695bc72788b49498028f27c38b9885299f259c24d05608911bee09ccaebed710e5cb3c9b67c43d7a2776de6bbce8d39586b3e72158bb6f251a186eb02a855bb473899093feed3a62e777251847cb33d24ecbd5ecded39a9eaf2242359e0d93bf9dd1df1e996b094b28fe6f6967368d7ef7f02076d01e2de13bc9a26402a2f138d8524e8c1f5829c9e6280291096892f331814b975d53256947efb00d19b818781dc0925419b6790058ddf58b2db9f446a9a55d0fc72f019db4a0fef51ead9e6883b9def7ba1ed9743a37f7f87f9c17e73dce246dde3acba4880dd29becbb3702d5ff9d69708a5901005d09d21b59f559c1b02f7c957bfc00c6dce84d8fced0eb7789ba581e071474b34eec36a3372dd2060238378186b9a0314e825c694b00bfe29e92ffdd985300cf9fd94562442004089070a8043fcbf3cc90424c57001048a0d19329f4e7f67af5da55ea13db601574319840ab00641ef3a3745b654831e960fecada3ff78d064c246b4a43d810fa653aff417fc339cdf6af91bfa77fb6ecfd067cc3ff147ad7f989f70ecd56b188b105cae9ddf335c6fa2415200211c3eabf762cfb42e7c4f50997b74dc244edc19c51283adceb0ec92b54d336c99c66845ab4479ea60a7ce2c2faab15a334d0d5df114c19203ceba5d7ebec40d8dc8b436587773fc150904aa2f59921961858fb4d5ce7fa2925f365ddb5855c8e8e9b9af9997eadbc6b7a51974b88d5afe0b2f1520983c34966ae13ee4db3c76329b2f8f7971476dad76d3e89d256f4d80542c74532fae270611619375a05eda4a541fafd2503d806a42928d20b5d0cf6efca3368324bf31b48e42213680e2c6194cb2f0ebb8163b13333499102c74227270d5c186cc7d5746d6ca4c5e63679409c5ffc06fe2fd18cd8f2f9f3de05f85f719eaa8b51d095d51ec18f76b7342e01e60fb1baf9dde0614b64a6272b5a402c4916f3cf37f769186bd6fe12c934e57d3de26bafb3fe7d0dd5aacc1ec55f91f883a04055c2667db56efd9063e179237d3b333d5f579ccf8e003187d5a9410d6ac32c487802cd49452a57ed83abcb59418a897676a7ea40ab669b44f5ee83712d17e1509bf397e30995016396dbbe325a4df77f48f09e128a3f83b09bd984e345131346b604f74aa9f00f27232c396d70b2bd0d6587d9503070b16a38fe2166bcdb51e6a7a20cfbed9358f612055f829816d80042b4eda48f591ffccee163a244d5f471194c6d2e9a90b9c15ea383aab31dad4ecc79668d6f5714baf33660d1b073afdf9438deb10ed4653d471d4d838caa8b6b570ade5f9bc1b3055c8ac1b3d68905634eea0fdcc9d5e6a2673ce699cea1482cf64652f04a60490830ec6663a3027dac083985aeae0660d622bbae668b181619097764c775d002b4f05e0195935b3ce36010bc59ac6870b68dabbb4b3a741339d802a57cf6617f12bf4528544280021541aaf9741d88865f245a1088318a364640375d18fb77eec0b765008d8e24c3130b9b3cf0b41d5a68da3ffba005f338b382899b6e6af4d6b3536fea3c1b64b29c80dc6dcec7f838ea9a2c02a6d60f6705d885983f290336607a5bf8644ee79c58637d3037fcf6ce9466b48f0799845857bc0541c223265cbb9c8d03afdc142e0c50fbc1c5ee6ee75f00e55bb9c8e75706a17245cb7c21fdb58c0f85ff9883807d6c3331d59ecba5f395b76b8524abb637371e1185ac5fc6544c6bf0ddcbb065c52aa20710e09bca7f0a83614909611a6a9418554829f2d7a9c2a3ca29af966da05b5b71d3c211ef4124ecfa0f3a890fc4f01a1049e092110ef743287182e0222938c6e0aeb8ef28f53737d0633e790532f85b5fbf6548e511fc7ea6b701814205467e40f8411dbde51acf6c0fca115bd1e0ccf03d4857c530c66e35cf0117ba9cbe1a098180503d63b21bdefe801a74473407cfbf2283aac9c6d9e1ecf13bf89c369a68fd15476b57f3bb89e1d4e0754555381520a10cb99a513732b1430dd9361af16626019f021dd3d65abe5d31be4f4c723411f3963fe3e42ecc9aee1ddb58fc3fa1d5f3b05afc5dae9f79953fb7c45f4c74a8491d8a796547f2825aef4f839ba679f391a8b3c89d81dbb0624f0fe25316b11ac4d864415f9141ec1ff36696bf02a5d9031053e544df86bea8dd09bccaebc1ac709a9d5b9af6b9717eb820a6322612087637cee6b35df7fe3029cbe075c74462869387fabef79eccb40ce8b583c411141f3e6a9fd28d2d7bce73134e6a83cb5481b2ebeb5ccbd665b7f1d7090dd26042d1ca01435b318f1257a6b16ab8adcd7b0cd77f4123db43e5d5baea65473453b86ee6e3e8a972dc1a17f4b400264423d72ec23ecb7142af16cca9172656195377c84bbed95109100fcade7eaf9b30bfcfb4f295086c9df24a86f1c0b5725d2b07547fa55920e5a7d96a3170b67c78d30d35e81ad8cb5dc09abfb6b3f0df91d2a1cf38251b0c7effa263adae2c8e29227567382f8fc07620a06dcd56c68f200576a79a2f117a7c682c6a0dee3bba88e7844810012fdd17828d36d3df903dd6ba03c98e5ce20b18954cac518dd0e2f9081da43957c88dcb3fbf2e7d0a0621b7de531af9313fee0c0c32d99fc741568d3b0e9acde9ab99c722b1d55ef96e983b46f77d4ae7f32a99f5bab31b7c26668794ffbb9931fd66248d75dec24b624155eb2fd1e5edee0191bce8803a7db4bff5a205cfd60591efa159a72f39b0437bcd01c02fd1913ac52aa35ac06e530f7628ea6876008c79072f5ec5fa51c02e7e6b618153aa0153a25fb9c747ce0768ff8f47c83154dc1b1237fb626de83909d7a8715e5640c6317929dd7057210d44db50120c531a8e24b5694c1ddc855db3d6c597a4e7498ce825bf8c33887469bb520b6caaf28b0ebc536447b717bccbb0ff2c9f4c30e384598fd4bad2a318572e5f1dc8823fa54b17d4f9de94c68c56bf04ff05e57d5e70b2e7cda1a4ad9fab805499c33895215420a96d483ae8f8db9218855e8a70c7ae255cfda21713a6e5d16229e7f3dc9cfe473e922be191088930c0c5452866ede40337e51f89e555cc76a2037418fbf0d03998f021b74d831ca3f318b2d0981d891428d3833709dca85f921991ac0fb958cbb44158a97a2ccc20be88e67e2de2643ef61464ff3635fcb00fcd0d8ff589c61872c5ac6d1886c131fe4f7fd2b800eddb455a5b2a5d7e23f0b4c71de488766c308af10d4b10ca39d87e486b34541a92f017576946b6c481a5ede9feda35fab2d897d402b2a1fac2794bbfceddfc0b573e649e8c7ccd507e68be034533e9bb6cec1e4b67678bbf40474f67fc211548cc8dcb91aa3a783cf43bde0fd9cab146461bd6f39539f9763cd11c475b1e9a9315222e57c13f477b136b2f06c54e87585833efd3f8bc2f40c995d8b64d052b5942f699f578620de7c13f465d4aabf993b2722df240fea35f83bc22b6fd16e52250206a34063489725e9356858a2cfc2d659fcd9351757d2fd2ae7ed69144ab1143ea16ff1563c45e19eee4c31c0dd220e388d59e6967edc42b83c4043f75c8cdf6c79949bd2d26ff4946a8530917a15debe9d39db5dcaa43046a3a1e103c367c68eb2da13fe028336df6290774e518ef79a10b94ecaa5a096847c4b93cc367b292d4191dbf4683d5dd57df81556712b26c1bf5d3fdc9060452fd1e16f462f9acc25d6936c19c59040550d1733ad0cc8e40150519adacba37b7e6a6157b08f9fe2def907dc80f86cf299fde16de3fadd707f916342067ccf34decc9b98785bd76b31912cc36a7fad5182d15b008fafa9c66f17eeed50ace4210f9823ba868bcd5e82d57fbe8196d795e9dc66fa274f0d7c3d6b97af7da177d6f003958620351dd703fa8f56cc0e491916d902e856bc17811625ca9227b26a3022bbfb365f11e77d923a1a0e9bbb296639cb51f574d71f12691fbe3aca481ac1caa7e548a1b56d46ba3930d2971c1201cbc252417b2b7b47fed962829890d23fed474b705a5e331cf422e2f718d886aa80f78f562703222d5e738f8610f04acb46ff76e712d3cb27d3d3991d71807a89e6dc31bd9cad47e9639cfe7ce274dfd3f8c5bf1e1af4c744120539cd6f09026661081d3a9e595d3b77741eefd4cf306c5bf17a6c2107fdd3e3826816e85f25106126673d284cbf30a8ad869f18002df1790c1369714bd44d1b8246204baee18e0e7d9e8b47a4610aff3e34657d5f6625d50f76b7007b736e2c8b3a012fc45330f54f3f2702acdf10fb1c2eb19bd810076c795616cd091477262bf49edf1c35f934b7b634406e2d53e352fec28c458ee5073dd5adacec3c6b83e9cf70187ea57230b65ff9d28b7e840ba59553204b8905cafd34e2d2c2341528b29a0e69004ceec1ed575e9e1959a120b314b277d4b71ad9b796453d30700de63ce313f9f7a9947a28a82dfc3de367c5b1df4f16052954a362ca375d688ee56d79a95d3dcc35cd35c7143c1f255b94e08cf4c3cdb1ceee3e206fc477eb826b5bee68fbba1499eb095fa8123e0e61ec55ee35de72efa87d5e716447db583ee8d935b9f37b5137736fc86e4fed707ed9da70aa6337b097cf7404583996e6be637dcd32619c12c66d7e80b7679bb28fa81e119cf7ac0daef62151478d0844754fb32eee81e3785f1604772457f4b230e22aad84bd32460e9b356842c7f75395eca6b472736b9ada0aa87f73dd0b6b97c2510b20cccaa975e630e9aa43e35256d262e0d010ea95e28c008239f7562d87ef462714e116f8cf1d8cd71893efc19abde9b05a463040f1d09fb34a11ffa30afa39be24696ad34ffda782564cdfad355656c92fa7e8d03a465018b6b7be14c5c43317d2e62fadebda0b9c6f89e32cfbbeca8ebbdf167a79e5902bbf17db734c619e3eba996a883a93aec4cd36be86ae7f07b5b8d13183144df164099cbe2ee1159031fe01a1a4f1e377aae93146a903f772cc3cce90cac217a944d6c02d8167a1849f6b6f39bf866c1439343d627848a9b407becc46dd9de42032ee990918fdccbd236d1d4c0bbc3a20ee54a42e765514fdaf6e225339c23b8b37770e64c206c06c32bc1335040e68dbf578acf70bf6336da9055d5ca01d6b3d6bda7d918726beb83c5a61d4633c4a5f15c84aa63dddbca05639d181562aa886ab66a7d3a86310488edce5f5cc722d9cfae11a735c1d14a78049ef0fa18e2f62cf6989840b67f5b4f35b25c4ed1955b658f4694eb0b67385b208818af5ed3ea82612cfbcd0d8a1a729d9709186ccb5ddfcbfcf1dc7f8b84438b0b1cc86c43ca4a4c3ee96549823fb9dbc21744dd809c0cfd7989e8457bc23109e3f7eb41ef2b49c01103f1620967ff093e786a6a556b2e1f74fab9c26f7a8d23946c0204369171a742d14835a4a3584705e6a1da6681ad1a973aadb339d3c31224b301c94e3d458217b0460e9b650db6468a4b4be7f9d0e8664c6c86f1f794967041fc37b44fd1c91dd2b8fa6e2e59b29be6e2df1802b34abd7e8780f7a51d95af794952b4a750e2d9cd115fcf6f2bf157fdf94222c3789a2846b2b771687d4d9c76912d35ebaa01263d9f5cce7199438763a08135ce6099dcbd8536a3fcec74ca51593f1bf6a2ee7d0cf1a78736792d858f5e74fed4e45eed426496d96c0923da2b67ef455d2581954c0f6fc415047d303b5283afbd016237a7963db241f969fda312ef245c98897fbbc161a6f9c6488af3ce1f5b93e65c206c2853b223350c047fb70b96962e95c2b66a166a8998d278b571dacc5dbeeac9c845c1e95a41532676deb1c944d79984e06cd68fdf4ad208f0ff2db68922f6ff8ee160db049385bf33a8ecf063cfa21a7578c5f6158ca990dc48cc518aaba7f37e5ac690abf4ca18897ee7b28c40e819e9794e910221211c24e6e7dd949c10203d47c995d77fced5e4bf740a10b806c4af63183bd343e9f327f8bcf0190ca50250854cd1cce93762b8991f30248cd73ac1a856a8f3d81416e9cd057b05276322b70ce9f6b67505db6422457e846667e0a82804ee6c052e90705a4e536c902083f1781a734b7a4cf88c5d4dde4ff002c022b884d847792a0eae46f7c7cb4223ef4e8be69ea0da73cc00cf00804fba550c176a60c1cc0d30ede4219f0c7a7560177f6729983e17d494e16c15b451fe80395906f6534011847b4994d2c0d8e0a61ff487c210d1ca7818deb902757e2b12cc0ba8a1a35cac1521e40747a65bd4829a3b8a22597b4ce67e3967dfb27494ca7b3186c35d3b5fcbdb9081f530ba89cb1ad165f73453c71798d1b1b47785cb161e265bb05e486e566b7e2b421f17a9fff78b011eb8dbf16ccfc0e32b0e2104bb115f223b5b1f79bb44ec16a7b427e4e3e24b60b9205944ae18fa1a6bff032fa028b0689bbf7fb6c051b049ea7f1ee64ddde48236fe62a178dc7bcc7d916f8c87709e2367fd7c0438c2c5164a9b616be0dfdba1b118d09732ee121b6153ca7bfe1306e5f812874c9bfde838c377c7110a1d07fe993facb92c6d5812f6a8027d10c394de4e78ccd584452cc025c29acf0e0fd928a7c0f6ec82d1605b3527291b9f1df1b4ced08063b711ef208a228f52f6b33d4e93b069d01fee1a9be9f00e0c8b1ae614f03799cbedcdbbff90df361c9d300f996da84675af14a491c2de13d727083aa987063e79b31b95e58c94b73e8128ad1057f48a580bca9d2cbb64a171e74079a3ec05dab9ed30c12b1d7975098173171fa1967a1dc9293aee9caa400bfb09de6ee04f505943a6f263860e359fe42e7db53cefbe73b5db8595868bae4cf60bb732bd392e66e6ee738f2421dcd53e2769f39a12e6183e5f3a54aad48f30145a39f1a264326d46da6c0d0d76f3bb8a795136e3efc7ef828af07200e174258a31d8da05eb1c06106a12e86e81c02f0aca23ae4cae181a4180f4f92bcfc25c2e634845c6d0f154e337dbf8d80b2f584de390c27c3df34964ba9da9ba3530da1990bd92eb28a690343d35896fafa5e65cf8ebe24a7c5b1b2fbcf8df3778132053fcb90c639bf2af829deafcbab2ebf0b5c72f2622948850d90a6a0c25a6015f992406663dc534451c3d8393ac5a73fba11e1ad82f51b73265e6554687aa7b9c5ca7a6e748826d19f45558d7d38f0431e8c6be1c480abda8f04ba9973c5b474da9666f0c4ab139c856e53f1a37dcd8f0626d4793e12feca9135a8096bf9a38d9e26d595739f02b98a2d8a41d08de7627e8ef64b0e4a64fe453734406bafcd93c2fb46fe87f12d8f6db323c2b0d51f43ff97a6cd319fc7db0c425884cc85b3bcd9c24e837f333a5b92bcbcf49ca65d247cdec579379a2ba201141704953aa6f3011c6273c7d4b596be2e1a2e004ce29ec50d3bec4cb0279eba7bc604b9f722ddefa1016b176f92da2b8b148b174bb16b7ecd117087fa0b2ad5fc24ab7d1cc63a5d1690fc4a112d943c6980dcd3f049b8c0e4ab92eb2046e4db8e932ab52dc48ee9c74d50cc8db7d91f57af0d2b984d633780e547d93d37dc46697e2e21afcd4f4544ead3a1943e4f0da57a90a7daec4ddc4f0491d18c22e57c2198d5dd45263dbcf2885e41a01bcfeb1c9b4772df121d7fd8b5e016d44f23a0d0f18a5b59b45c0e4c7c868136f62d2fb163cdf5cef6cf30bae4bca5e91e892c40f5303a4f78412a1c26d65be16f5139439c3c908ea1751e126fa0d1e8cc841f8b75705630f604a946f80f8c66972b10787008064aacb973b3607e87b272da03cfe6daef30267f304b9fed970b58b047bd197dc1aaa94e8533bebd016b00ae6c2cd0dc1d1b326cc7622dd28947c5e9ad5b819d5d0ffc0519646f00b7e3c46fb96a007b8c2719c4797b26c218472ff2ef1295f18e9b60c41d9dd65420e7d2dec3d3a4137452d3559eb722fc7029a14ed6ed8103fd72dbac7b277c227c3993f89e0c604915a517da1dc14fffde199fcafd4226e8f4f929d9adf78260b8e70bcbc5ecd8f27db098dc295c9937263511e7445f96110e1d842069c3970ea025880be7ce6c8a88658367a78b7e485f7c6e5d8cbc31e8722c7e7e6deafed8c57557534d1b1beefe935ab76197ef4eb77398f4e0b145f8ef594913e3b927a6981665a8dc575e324c8d9a9bea933d8575ffc3967a0c556b569f569417c761a380b193377ddc6e155d715d3f86bff5fa2a633e6f85e1ec9559dc25074674e900256c350ab66d35ac0225cf3b6e11d9427a2e40f24761dab5baece278702f9d545ffe47e7074e1410182e230f438442e526fc84957967c33f5f556151812410f2e931162f8b1ec80c06301b9418cfae100ad974d555581acb182070ccda0139349c6c0e1285edfa82a49f376a2be6ce02ab0b49dbd43ccd373e0c8f5e8e4fd905d4d3ceb267691258b63701a76fcc356c6fcead255ff7761bae9b01daa1216f83e0467883287c0de5b4aa5cb0213599cd8193cf2ee1852c6efdf8f2d7797bbd78998d4fb467772355a90e8b496a8907e96622521b78f871c8362f51fddb75f1a27ef009c47567a0b1d1932d3b2d0e2dd6e0679258460dfa6b15ec2c23ed11ef6eeebb2453b50b693da278ac0da4d6f8e9429ddc0d90ada615f61dadcc4131cb33ad473b8c023edea4593a92c2def1c5684628f72c23874f13348d3bf30f0714bd732c8c3769d71990ae0e4f39e8cba836bb807ceb09fe1177be55d7d1f9fd3cd0eae96657ebb8425ac84a939660dc9f12bbe7240a5d4d70c06808af8e5b0d2f1735545b6add77c8b3533e225d6048bde80e2db2ed96d2566fd6378392fe7a637c16de66ed4e20bab712c2efe902863fa5cf4c86ac430b0651e6370ac493f0092e89803e47cc08eb0fb821d62919528ba951e9aad029dd8982add713c18fb1fbbe943fc282aa36a64b2d5423a053e209ea23b65681ae033daa3242f951cf64338d11ed35b88516b6ba450414501dbf3ce4951cbad6bfee113bd68598a6a9d2f211332deaf54cbeac2e85f69567c754a61231ea46da86cecc560e1e0b22bdb4b1dde4474ac79f2d32116f1b97ca11ceeebc06155948bd845c914755350bbfdb32dc727513ba6436e065070b9e8baaed2ebe5ee977aa9f740a03b9ed636c21048308ba1e3338df2ef69035344cf06e87af9185dbcae16b8d970efc1c76ad4e3777b8aca32f6c12c1011ec99c1470e8d9fd0f52e38049a4674860ae34f93cbbb308cc2ee9ed061d20e6dbbfe1b6422bc8ae2b24ea841758fee11cff7f51faeec704707878a23594b713ddd1d66faab5104e9ee8bd1c51a4bae7e618105178001e8a8a594020af53dff92e7ff1d4a389193f2bcf4ef09d07f51676d3d5773fdb7af47157932368681a67bbb25661ead1f0b4db0310692905894138bcba85711124f4f492dcc37cde4e0a92c5b103b39827ca33171e25f3489c61cf3818b595eff13266712df5a14ffe4791594cc9e0f0c36b1e5d7ff5cfca8ec2a66d8ffc24e3c96fc684a4eac9e8fcee5add7ded4baafa64fdbc28680a7c902bdd3b96d83f0c972b01332acd3794388e2d46dbde35a8eeeeaf38bb9b12ca6cc6f9de95a39926968a7998e937c6c6e45bb6ec84bd3ca98827ce286b80562e270db638ee04d72ef8023c643e1eff0e2f4f760ebb7e5ae4834497e6e93508b609ca25f2623c42792c803ccc5a634a93f71651d6830d5ec34be8025be9f109317a0b506c19eeb5f37f60eb49fc6e2bf8a0c6ece0f0a6a7ca3499c8dfbbbc21b1364dbdbcbc94a7d191cbcf4ecadd4658362473ade224b723da295446dae7552284e2d1beb47054ed0eae13c95514143684909510565fa84fb8c5855d402f64511098c6f486cc9292ec91a004c0599542ed1703fba6e961c45d0dff823dd568acc4453e3c75104025264d51b29bb6c64df4db09e15aa7f6d82721d4ec71656d2a5f1e2bf17847dad6b882733c8471d797d8fbf446f1e078c662a86b20198e192f119faba9ee645910b9bd033b14289fedac479afcba6068e76219876a0c1cbc0b606fce6ae89b8f15f4ed7a30a52a980a32e2e66aa5f5f6ab085d0030b4d103eabc57fa551c0ded7fbdf2aec3fdc9b290a5728eaec6f7d63dd742d47265698bf5cff2cdf5be76ec8755aead526374612fd3eebf1dc1a69847a0b9824e86818267dfc08ec1551986025a3a051c2d2a0f50b1d8474e2b45c86f156dc2e68467dc728b0e224dfb221bc31a2bdec9c2a9842883dff945e639315842fbe430e2a1a87cdd0da10ee5b76d423bd636e81492a31fbd7282d5532e976c19c2ed138d8bf302e6bc06af8c1c57727333e0817f1489fee01468cea6b903d23b586e0ebe1698bdd07338ae7874d18d6cbb1608dce221cf8cd1f8a315112407826d1d522b5d935c1e48d3f57ea4e621d12fe460ff189ddbdd150a80b93aae27c5115b092547edef19d63e20c0684fe72bfb04872c69fbfe54d5dbc5c27be1f84a8c8be562d4af68d62b7f0f08f055c31626fe0ab4f240be33a01568a6d96880b919575de6970b305eb88fff03bf48a51b1e462e7d2583658fc1029d734811be8ee690bfe92e43017603c6d3faa083689b3865ead49f5ae37eb8108d0ed1d5b47ef5b641b4416392daca74a255586bebeb03a1661c8cd3744411bdd0cbb5f7986f0dee66c0994d9c3a6419ee2259656bf8a6e504cc442610a15c53714869373adeb74920d7ef0f148e89acf6dabe33338a47811ecfd0c0e728158efd4b70c27c6dca5140d7f0a7b89d4b4b25eee32d0b545691a30d52af42e80a6fa2b2304230b65c89ab9e8aedaac2195c208220f3fa6e554e8f6f47b0d3cad050d990e638ae8a4df6efe1428bf4df43f06f317503005120e2c59091a4a95553fd9d3dd82a26024391bf7a07727bf2832e2f278b8adf53bca3c81c7e3dd5a556f4959e7630b91267f3bd1af739ca7407bc6ba37864e40da895e2e4351c4962c6ed616716eb98477ff180609d68178e9b83a6fe5e4f29260f9dc9e229ec55d0a6aeab2efa7e8ff941e5a9812d3973e32284c22391b6cdcd86a493d5989442c20b991e224555d242a0e8c69b75b62512c4e2dbd67ccd3fe4c9484e06961e898c2147010bfa150d783af549bc68f6f19286385b3e22902beeffb26d31dbb0761dd8b988d377a1aa0f38d426076fb95626292681327a1ae7e9ccdf4d1bc4325e256d307bc2d30521a9e2869c82d99a45c5e756629fddfd74a121f50a4afc9013dcfaf0e47eba914b6770e7518267279a9ac9f809315b06522e0ec987cf756e2bc4852d4354e3cc3762fe8d26ca1603db5c0cde47736e3bfe83d06888f2cb4094149f03863a31d48fe4a2ece573eab546b420f002c601a1275da1f8bb51ad9b31c5f8b0ab23b85e8c9058b3cf37509f1c0603840e7552d89df33f612a5f37403a5934c93da4c2bbc7febad1fbe84d6ee470fe42085be245e0d11958191517f824eb01c1f44445d4a277a8c04ce840e19c21a49893fefea94d5497879af9a15271fa1c0346a2fc637c2cc1a74443e7cf17daeb7f4c1021614dff9d9a91ddfd446fdded6df0d56994be54f8dd7027c577d49d6c547e9bf65e9f15ea38b7694a2cb85a175107e20abe2429cbf3e410045ca1a94780ab8d68486d14472d6872747d8b42d3cf292535c1efb36920f48a2f779b3b4391806c689ab7f7f4971ddcb07f8a24f00009a1e025feff35db74f6f4297f34b3c10a7583de6a2fae9e680cc66f029bd0eb160f122dca8d30bb04ad4dac7e6102da12fca6811dbb1f6da5ca94a575086562ceb00db63e3a70897da47e0cd291184a940dd97c2b914de6b4faec3041e3899ce6f5981382ac62b572943220bd914e17f10daa3e9589c71783979d1526cb83c9f76dc69bf5ffac02b2871a2b9ccbb544dc7a46cdeea4b500d098c1b37adc3e20f1ae2c4db194cf22c3cc23745f059a1fcffb5b4975c515c5bc6e6f9cfd7b6a03e165f709f4171ae6f5be5fa726addc3c639d3385c49340a8c7705c5f81fac1e455297e54530860ea58a839903d01b62acb880964f0ef73f30e48b462af9fc2dd2f7d0d0c916d28429e3bb63e823f6e3b4feeace706c7691c63a1d939f64f0d96f2226388d410a9e1f038ec7b4500667150010fedde36738d8fb9661833b206bad2b4c1c815beb2c1322bf98a85ef32d4659c777446c000af1ee8dea4179dfb1ef2b72dbf946cc6feeaac7c6dbb28589aea405558b5a36574281c55f39a8560ca36d0fdbd87d42f28b169a3881a7c65de5c0ca75cbe9f4c11cdbb73b6649a7b26e9ef06e3a6d1b81fe1678f2a84ba82bd48e098572d6aad5403fc63bdd434da10113ba1424b04c6ad4372e2c82c9105b2297a16961106f2e32a5467762d6279832aecab5580a0b03fea90f6287223cbee1be2a2ea030589b0c8ccf866bec80f6a62c09e369bf8e8edd0698b90bed2e06af094a0572faf27ed8d23a0888f873bddf4a4e2ed10ec1365a427fe441f35474e9372efc362c0c6a1e7e926a122c4ee5f95347dcde9915719995f16f5baef6d07eec2ffa3671712e52cb2af62df898e597f70d1fb49c7c7d3dd1b264e2c9f8424e58a4d2b727aad254aff1d5a5e74dba51d00d9c086014adbee8f981052714e096477c3889042bad3f6a40cb92f2395f7e7ea7a339f6de97f992f6d034773dbed0038ba2534d18f660c4f9cccfc26ffd9e0ed2d2535ab578a2bcf92f060322bc90a9d4f9e62951896ebe8a1a6d34cf5d7f9b5395110bfd518209c8c149b5067fde381ac6515ea03197644ae0aa8cadc8a071f31acead02f940bfb233c1687eb638b7ba498b3c6a1d9aa3412325397e0bf33c33fbe8778927b54919f4875e3696a506c91253ed72ca51369f117466caa572f4ba59f59d59eaa4034a18184a5e67dd337e116db9faf93800818f66f0e04ad8a5e7bf1ad29ea86a8da399c16df393e90cd946525e6b478dfbe7642083dd38e8db6f1c2a851c2469fd32342fa9b90447eadb0f4f40bf9149820d8e4fc89ee0a09d317a4cfe3e83122d4574260fbf0cb8b1ae0f9b905d784d5113b32095e7f7075af8432e9f2296c67642175a3c49aca3277a9338cbe38ae156f4a71f6c17f64a2a8d45265ce7c11dea18373b7fcb68cb2e96cfe8b911ad0367d27335af8c402e9847080007c8036337c1b1be1768680eb899a9f1b6edd6a83084b3acc71733f27af96b72ee89456c738afbac6d94bbbc5ca31c45d5ee510eeff51163ae81223d7131a7f2fec683a854edb66da3633582e389d78de84c0c3d5491c71d70fd177e8d7c86c9bd19120c2f1fac7a82f4a47bfa0d73865b46d4b311ca40fac5d08abd9d3c30fc5ecdf4c78395f9dc4093cbe02c5e2af4d305b62d449d338569fd9604bbd7f8bbadf6a8525529b29a1abc356fcbbfed3499cb769f62ce1dd4ce73a77427d514f817d5a5d6ce88f9a56480f816a5912a1e2ee642f5f38cc10e6c72256c7099bcb1d2089d1175be62e0ee95172398852c1d273397125fb1a116dd9bd92feea376f67ca20232c697890ac1540747d3d76604922de9b6ca1783a70b5a84a92090b8a6c15c2e0a403df3e600d7bb27702ceb2b89a0b9232d0f5950d23d19c0845248ad70be93df09736260ffbe87d588b96672bf19658928f3c86c8f297fb66765a6fce8d1a6f1801c44fe5e792ae6af5df18ec053ede97606900b4d10be51fed6c06a482d17474baa9663862b3c2c98a94242bed1a667a93aa94327c36b260778184ef8435e106c7fa35e6c980d2c437e456fa7ac9d00450917d99d1cef413973802a64d0eb5d431f4488d65ff6c6c291af80bd7839f08fe6f46203068ac623f62f961d61714111c4870bfab28e9e26b9516cb48be06af4abb28ba9e0522230434f13ce847d3a654ad2b7ba97d452cac54b6948b63044d70973193dfab01d0f46a31378113dcd76484cdf31dc056f793a9d962a967cc51c408715135b37b3313d1c8ddbc4933266695091a4b64f41e453f576f540806dad192f4585ee9f11d5459623d50fdb1b888a36cb0cec6a083a3f8796013e32cdec0071963b094f7f854b821b399ee25b54d685955fd354873afc7e15ceec44d0cfa7570d1ba51eef1ac87ef9fe4ca1677c9b0fdadd329b547cfa36d8a7ceb6370496f3d453d2e4446dd965db94917a2c28d7799ed28c4f48282f9e0994ef893bc06c556b15d5b78789bf51c529536684ccfb4f01a86731243e8873b83559618a52b2efdcf25b24da6f19926b7b91be2bc0006817607dad2bd556c522d5902a96894d50cd3e5d7ba2ad35d825a877b61cee01959b0f359c5aab1cb700943e9530aa82331097e43bd72018a468caf25ff3c237f294d8e8ce6f4157c4f1bce543aba07407ca004ba9053f3a75967b30beb4646e68b372cc240ae0fec33d031acb59aee25d86f6f8c7d702e8b5d1ee642341f6778cad564b6ef185f689ca7189cf3213b21a3fbb95630aff3219b4f0f1926bab831fcea3480be6fb66a282c1fe9ad7be4dc93ac195492ec4f35fc844db65550bc9ccd7aa777f0c4f8d122601ff25984e72cfeb92b642e51f08d7a5149229e241044cf6ab08f6cea6058012157b93270f3a11ae44f86305e9979d59aaeb6f2fc3f2ed2e4fda9392910f1e3666535994675dce871fd1fb83b1e27a96d2d62da5bd6d24a42d22ca4bc8e381b9c9b805db9859948bc90ac59a27a85e88d5d63f9621744be6c72745f4f96240c30ef781e7529bcfae26ab1cabd2e277fb25f4990d97d62d08d25f716054bb29ca75f631e7672af9a25629cb9642f084f122f3ffcabe04290de77b98c3030a6c7e504e5e2adbb996c5fcf58e98482a4ca558acf13b6c15d9c753578e3215773624902e73b388d9ee1eaea4a4854c2da390ae9354d700e65fe819e961f4b71009cb6d4af879868b6163fdedf40421fcc7deee3e0fdb2a168accb98627e2cc386cf2c8e1ba49bd22383dcaf95d5e3e05580c73af6cf58ca5cdd026d73f657706a07ef7be88fa0d7b80a8faeffeb5aa2339ae14a30184ef45d4863d46b03758a6ef0144e4c15e21236599d21e0b319aa52b9a7a24c3c22a97515fedf53fa2ef5112cef733db6df67222857a985a7700ee1bc21bb32578717c967bb6c5a1a1875b9a2dfc370d782889c8318151d00a27b85b58bcb3c933b910de9d7e1523aa65827fb549255119b33b40ded3fc8f6b72b6898fd8d6d1b5056506f66fb2837810548a1da1e314bbacf1821c7c792bca38a443a1e02d2a0b14974fe18944f393fe98e8c6b08a30e7a3743fbb1fa5523d58e21fac9580d6cefde137300970e11c23cbf4e33f25b5ab77dc01df376caa5d4b9e5353b7aad56744fd51e33843ca6ca20bff9c9d58471d268e3f66464791a2504411b56d1789ae7fade4f75187cb0e02bc914214e66dbb825249a5c9ad47ca77e3b46e9cd63ee14607dcf821c6198b0e13961ce02b550b216a3afe69742241c5c17140b1865920312f4fdee7f473efc0b4a4e4aa2b9649e5ad9f41cb20e369847ca1d4ec7ce67ec1d9483477e109d12c9cf2343aca84099a86dfbc23b33669bb2b9f5c85cbef681257943cdab857777bc0142a010b4f086eb025f971761a6f61a97b60b4e7e702ee080d0656ad1651d399bf6ef0c6fe6700f895d84f5870106c1825f5bfb3efccc870938fb1e752a60b81c6b7ee7f018ad7c07b9d1bef797d3dd51c4fce4c79e10a96c62ebfcfc330ec3daafe26ea151a620fd52904f750fcf31e3917b9a16c43c455834f2baba1502f4a2bd77b6c3fe02f1a21521d65061acd698db5309099b92792cdec2bb2a5078a3b3f6b9fe5b2551f075394189406b3363c37643707ccb4f3d1c8e5a884b1136de0fd4b425bd4447c4eea20ddc89edf9b3080629c285d479252a55d140300bf023827159ea62f887498258da0f0c607f3855e81658e2f3937970ac4a7122ce67ac4a735a213b1e11caa961f81858233e79dda62b167477fc76a81ec8dd5759233613d21624488727ca17bebe9e0efef1e795ec9a4a0f6d35b05529e7c983000b7e1026968af30c5fea7a69ba07ba6b2cdc60bb4ce39f93297e88bc5f43ab0def30a837a7b06861d1254173d97de377ecd2316586db8feb72f09d3d33dcc598683118d51a0e54cd77c16a4454e1dffbc931ee7d44cdb92085d1984403de4f9c3c461a954fc6eaffc587a5b98a7056da0fa84d3519f0b6c9d8f05e26be3ead9e9d66f2e1d2b69f048ca9aa2d113d96669498b73547a8c399da4ba238811137112e3979be5ffd95e19c1f756d720f1031a15c282afeecebef93782d44408da6aa8f317dde64726a64f8bc656a4b36966fed702710cbcb51b628f98cd3619fe619873dc1869924807bdd85f8461efb5318d3861a2dc41492aa11eb78ef7a2eda3bbdf2d8313d5d3f6e1a69bba35aee041d056c31a76ae2f3ddee6d98e79a8e303a0a8db46004d3bd3464d9206afff0dd1b495977563d3b02cc136e1ad0e41a83c6c614e4f5fee6893504febe3e046a12ff900e0db7c23c1c17e35def70da866fb01dcc238ea9bf99d0b23b2d802611a5dbad90d9009045eac53534b433f8632e0abfdecaaedf84c53280f82e39e756afdbc6d005d9e756b42f4ed165cdcc35bf6a468c314ef9be24a7d5f59a858a8db3dadf52fa0d2901ba5df0f505d10fffde4b6042e9bcda405ce254a48f15324ef8c979eaff03965fdb7ba8f2382cace27a0718b38a3724bcec5d6a6e6b03507f6f7ef89d281cd23d371dc136492b6e55dcac8feb572f494a9d97e51ec12b62c3e1831b80e942dabe09ba83334333b194d63b4512faae8af9c858168b0449ed93ec899f7953474f04d28ea8eaecd8a5093cd26daafaed0e2363fe8898bed7b18fb1c351faeb57ff84b216a89348cffb7075422319beebdaa4fcecd6238899ad632ef097d06c0eeff89d4473e0a9701c2ca6206a3c704c6a20ef9a079266e4c86f39af907ac12f19f72ba91c0d96bd23ccd19e7a093329794e64419b335b77bb39f0408f324c00835bd278297408a018de25c36c702a3e0d5eec586409579a7ca832116571222a6a5ef72e2e7165236df19979717c4b8053b079f5348112cbf4de5282a847aac5cfe43293e9900aed71ec682af19f6372bcf274b89713a87cfbdfd01370749739c310ec86d0580d615b757ed45ac3c40684712346c97289f32293761d3d5de194c39f9d244f6e835f1f3c6338c6a3cc872f5fa8675bd67f7bb4470bd669a4c217200567e1c99d0aedd2e0ff5c57abbf3a8dcdaabaa3e1b4c62c2fddb8bca75660d2d6c9f9c967d25a9e4ed316f3365e5c1008c0759e8f9d28ef12aceed5df524c63d74857ca7d0b6af026ceac1e3c05c5ec5bfbe95828a254957a0c7961e571187c050bdb1abcfb1919ae4943c0304a58423fb0a19c22b7a1d2fae89d61a599039200fda7c70e669fe23099573f01338d794aba26dd46cf928e4506cd058b3800c0a6f3b9efc6f5092062a7d31a9b055bd7ea2ec547cb75f7050bbc6de76f6023a08b6105fe9993c5022b510c6b96ac2c0a8c4aaa16f2cb1f2c6324cee72ef1dcb043b7214a50b8166e84e5160b318a8311a0f2b8e038a8b65e6ccc0e9375eab42df18f3366d0dfd9dc4aa57acff584b1e2cea35dabd9c9b5e83f67c6204f278c92fda10ae8f443a200e07df4a3b7217536895e2c5a9b8451ea2c532a5e615be0b77672e034408a4a43efcfdb5342d65138272f268594cfc4defaf742adec4944589388d5f8a102f95bc892c0d193bcac9d098bd34f138e7de4bb7be32dd91da30533412b16d5e157e338d8fd52d8200a9285be6e669216fd4d27f2f17830ada0611c257098e7f4d18f901128a9e10407e08e400c5862c5181cc27fc96cc0da30a0f9c0bc5ab9b6a7b626d52073e5709135e21a3762c5d17a6eb15c4cceabc642302fa7f33ca72a70caff08d53a09573bb3f0b8c05a2e80ece9bc70e82f396a613a6c6964cccae5be4d6efc3672ab03b346aaddb7b1a19634dd6fe88d52ae6f6525618eebc40f62c564bef377d92b60c5cc9b1e3dd44ae687d9da14f6eab62bd1495d8cf98b0129e8366628decefed0032382d21fbefe15b44c56b0b92ad4ebc9a1c80ec771b009942e0e554b64a4e82bd6bfe8c35c3c93b1670644813105185f37b3bb63f0813244a3f5f0cb69383bc4f224f878af08067fda85f647fed1b369fb5cd029206a45075cdf31b60bb1e0ca718af94b4e1ac2b59008872db48a3f676a07631fb7569c4fa2578490403669deaa26576bda46b86a904b5056bca62e911b02490f108d5bb376fe10e63ae2e04e73978d63b0e43b268205fe8ff30280f0be93fe5d30cd0c2c8cc3965c257350d31027b3a47e9e1702c6d264fbcb123b286ea6e9384354e6eac378ec3dbfab1111a262a90f9861ed47312472ebe06190a902290fabf4a9e49882622949b4e1690f64d09de193d4af3b2218c0ce84a1290a77139f0e6d3fb7d336a335eace290efd90f6cba66edff3917cec8c736b947c860d3570e5d57b55b34f9b5ff273d8d324dac138cf8cb467711f685ec043f4a4c6f53292b601efe69f5fabc2d937779cb63991d06078836c9ad01e941ed678aa8f9330e4791cd3ad980a718eedd2e5ba7cd9efed62fe6a3d2028e8a68267fe678ea4fbd061ec849c4f14f16e62192c0ee0a89471e68e3a5e765e74e0689d1a9d281ad0ae6d588c803bd8b95caa63f3d939b982d5a19a07a2fcbf5c8b299e8d6c74f1e38395bd2c72da0024e63d708834549b5890da6b82ff1fc566e4d97f2e57f677f4b5348d9134ed10c95d090ab9c44d6c387619d78ce512cb55fbc2d56bd226f808a82a21fd6cd996f31d4c142ea424f7da13433defd550ac74adc261afc97eecebe7fb1b95c681358a6668a732e985669b5c24a3494ff07cfca0301ce7de1973d1737d01327e715346772229ca6760c8abbe855d28f1c9cfe79870770b4e6fd722354808c5445e0f6cb0839b49e5dfd8185fd9381b4bb009f8119b6924030d5b81d15dfac30028e99c7217968f201a859ec7c236fe8bf3e996c41a26f2783170895a0a20af5491078f9b37861f4ae077e203393da736eee04d6e3c19460ee16ff3fbf741b3a1b6a39ad0689342aedb33cba08b59b09c4d6a13743f55175456c4dddf1075780bdf05a640d6bd31fd656d47548e3c92b6a6882d933f7d3d319a5f13152e3041cc67e821feab5b8c6ee884eab9ab2ad71e451a73253291fa394ef21f527da1f02da13c91f67895999442ee1b2d3d7cd02146fefa8f312ef755fa66c1d49a600c1ce78d89ce27bff7ea901a69c106ef0a822e4ca3f4b49ac7694b195424b7cf56fb3b08f924bdd06e4084ef8fd632a8383af192e4f55dfe0df36119274724b2c4406de325cc8f3419f77997a23dbf2d0252ce5b6cc0e06e4b693b095c301b026723ac9d543f57266b1c986c036a548ff8873f2a39c4572771c2a2b5f8d515c4db8d135fcf8b20a146d42c7b75eff99e2793162414289bbd208289d77e220a5d1ca23efa26fc841e1bf4450937d9f49029cac0cdff6be0e097b5ab8767efab795a1a6b54b44c35f51b1e95a79a8e04859e8e7dc69744095ebc1c9addea759c4ade146194914be036a1d6e64a3db089395af405700baa34fea8ab21f36b4be2ddd8f2ba6f75c2d6cbbfbb376c44f4f4d795067fe685c34d6263969eb12adea6eb16e75f9addb7ebbba82a20e7e6865a0d46f19d793fee497bf6983f0152643749f768ebcc5244d730cb7ba50f6c14d3f2aa33a6df01f56d064a0039dcb4311934afabdd6c18ed6bac9b5ae806d03be86691837681e4a98b8eafb30239963aa26b04d75735af71d3efed080db4104c00b2872b38e12ff3d17b1d69783cad4d0c6cf9e758ce2975f4c5dac4a60e52e7f0afa60754133ed0727d290e3c8f7e87d952217c6a324c781d3967ba3f5639a61f5394b134da7978cb87b4184ed6eaa32974a6e0ac0cc4c175af71c89a5eba43f6a7ab0b041af49164aef5380e3b1ee751d2538c54595e7f21f31d0d60075fe47acf89dd125bfcd2888731ff14543fecff9b5fc68fe2faee50a28b34809ce9891c50d40b4a795ae8f830dc157a8adbdb1ad5cd9bf9554ada1b7a3c8803e64930483b2efe82411c3582f33d3a706aefa476b60363fd91ed64d5bc2afe6ba3e8038e6e387dc66a132f9f518c4137a6eaef72310f679e3046fe31fedd4c053fa02d10a6725186f22527a351de8e0a6d60c7e55c7a39ebc4136e605151b1aafb382fc97a6b1e61a1021e463a3a93e8775e5fea79ffb7b35a4918e8292a71a9662d17e2cd9d2b7accf694dac75b7ea765b8224c82ab6b8e63a6962705438feb961c9b08f0baaa6bbede1f4409ccb82ee41a354ab0553f612cce2a9f1cbdfebad1d23fe900d49be9109a153fa0380590352979a7de9cd9006b4392a94d75e80fb910d4144cfbe663692e5af2848fd6cf562f9fa50b349ea9d21042fff394e3d3b280ce005c054b30549a661c766e8d9eb2015e0691c581a84fa8298b7a2c8bc6c8bc554c6bc696f0fb9577e43d4e03b5131d69da55400bcd54e2f947edab33c264042b043824f87e2767d988143d833d6093f6fdbe8d30c2043d3d4fed00dd7ae32127c6c7117009baedb08e3f27a24d6afd9459affe885a346fba680b56671d9a129b7aaa394fa2a215131d7c63e7beaef21259a515116dfd748970301761825b6fdb2cb5648f7a7d9af53302ce17420e0b423b62f096252228877aa87286e3a8ca4fe779f39c2ae2e869d772078b5d0559434bcff802f15dd2d385c60dcf1501b4e6477833b388a7466c0801464c7a8aee34e30ec14501fe028e58df731f0e6e64e47e6174c21cc0aa576e598e470db33c8e4ab6e26a08c115b0610af1245468086d49124e6657905a0980ec92f70e5ec1cac055e8195576368253b424d47d2aea11318cf5d69750c98f346ba82a75ade7f82a48ce7a5abfc4541a87926fc2afd9d351f7fc406f2154f477ab91373509f0d42f2c1359735b2acbfff60ce1e240fae25147fa49cf5fa53583cc03f687fc4bca0962277e3130d470cc97b2c11296b89a495b58128c269d60a576330809e580ff0fd6467cb5e398d87c782893b05d19564cf6d451b792add06422259615caa55d5f08979afb9a0ca2d58726384fcd8fc60d5defa4013df8cfff2ee0c243b1997462e68df565890b8c1246a4b3659d97e17943132df24d01dadc26a61dd12a7eecbdad0d4f035bd4830a5959955b9507935d734bb9a6d1d5ff55ba7bdac91f8f85b3c069ef2fc4a13504422af2820bc7c47d624f5fbff6d680dbaf60e77522a909ed1f9454133c1f20cefa34f55e16a94b10c6906c064ffdfeab5fdff2dc709abd9b3d6e49ce5942a8c924e91b127662727b24bc92ce7570cf8a4b61ef4ad61a9393beefbfefb4d8c9d2280ddf52bb4326aae50a953b50703eeaeb50f001954df2301105cdbee1c77a4ee994d172edae6ee6304c672128c651d7b55dcd95adb0f66dae892580d1f2497288372fbe21da168e5fda3bc379495772cfdffe214c7be4be81fa5be334a48d0f950ec69f0f56afa0cf61b0b0c204b2daf7f60cf94f9fd4d2b7088870f0b83a3bc591666e4da37210b33c3e30f7ae24bb57421ca734d5047e72c1413d25418e3dc042672ad4ae155b2ee8f02c5da56dacf70e8439e4dc6010ef58b6ec94d72de6c66dba2a2cf4f5ca333d2560c7d84585fec36295910cf12a2a9e6c259602289f94cd5b4903d42bd68de118a79a2160ffd2020af3cbe2713af3e7ca532322dc1e1c397952fa27a7782a161b6c8284231ed0a326dd98ae7332d1cde7886308c9289e7e8b76eab76b452ec33e63a8209491b681311416cc6903c02f2f61463f9f20f1d138b5d2b766a6aa1098321f4257a59266c89577bb6b415163b3a12d1c881b55417966bd3beb9738d76b00689f4acfadfa762f4599667fbd2f6d8356061281caa333b1d4a2d2f0711e5ced0dcaa815a0e4d86d21d4790201ae82a761a8727178674285dd9008a8336e18b09a5ea86c2c33f7fea1f979acf7832e200d2f2129089849f70944ac88744fb2b2e261e7cd9373db6d4eb0fe4a353be2ac164ebef8423d5578fd42de3f65980dd990eaffab9a0c74164d1eb5177e8cbc75fe10d0fcfa9605cc2d94e9687f3804859ea766b69b0987ad0d7b939a8ce5af8bb564caa9ce3ccbb866c188009925afcc5e198e70c1843fe1cf917282b68c6b0b62e93d5f9fc957f7a6d16c6b1d357c704765ba7cf674cd36547f626f73da835c05b654f9dd03d32a643bece698be0373c40316de782a77d726307994cb4e7013f41f4a90d9fc1799b5622313f7697304447d3327db9940d7016fb22977be75428ab63757656c26476c04150e1b4afa73f3cc42fa5234851652f764a44b8b6eb79e63394f88ed201647b8577d224716f9cf7d36953117713519a20c545afc686a60d8ec948ac40030b685579914657d2e5c21e7f27eef973634a040e2ea7161527725cd6d4b9c1a7a9c42e674e5c1d0fbd3edd33c1e8c2930c33d74383491b9ff39286c5424212cb05d3f69a892e2f2a4776ae99698e70486d55c22cac5f84a848d8b676923bd57a2c51394199ce55b5619407bcf0ced80cc5fa5bca25153f41b86b57ef69c180c9423c2d76e32067d03770f928921e7dc6382c62be1e6777323bd3865ed4724087c04692d6c0b1fd2b44d5c73c25dd55653c068d7618e93bd4b89c2ba882f83a68366557021d048ab3146a9b8b867c666cf01bc78d29b40650fe6a2301143bb5f1745fb39b40701628538ab5c4f343add1f3c9f188390d0f1f39bbee6f04ecf5f8b51e6d35a38870ae180345d65da5b9bbc52e929c180bbf253e617e484b8677a0f2022e77f16d585e08eed6c4c7b1d758a0542d6d6159b790e31f652d8e6c8760e129412ae96afe285239169f3fbf0ab62fab0ac485387504cdfcf5353d21aadf344e7db6f304ae4e6d4292546c6e75f070fbb063af31fc60eea5a51a4358af07d6b07d7909c83720d2540bc43e4ca94882e7fd7eb082a6addb015b2dd275ff0207cb3939301e94df77d0d14b9158d8529397887609f5dedf9d93e086af256e33ba617cff854cb12058f87fc3bbc0f8042404a4c3c5c47f041cb7f4c16203961a547fcdd055ab27a8651288febea1fdf0e5a20c2c77d82ef6a209a849d6912366bbab26e5e29540800c0d7af46fcefae0b890ed350354f07d6fd88016045fca6bf8fda057daa6fce04fa36679ca35c4004e615df56412eb9d8b88aa4c0f1449fd6b6587eedb8528578810a6ef71be03142a8c55ea6acfdcc0954c51e454e9e1ebf318b8f604e86d0e6af97925d36f75f424548ba671b96e7395b4f89cbb18fb0c82c7b923f66680eab9460ddf6aea3a5634a572a056bdbd0d6540eb503d48189feee2a72a8a3f79d694c4c8f53c5f1a3f0176d2db9ee0e98ec46db68fb0f15d68b89ba71317159988b8e78e678336aa691b973092f4c1f887a3b484e50f54d28aac9a6048df9f16c127d7722aaae565877bc94112ff4f33ca4f9d495f634e461d4f71bc3c3563fdf16e620d7acf698e21e594fda7393cfc821bce71ecab8748609d618d129187ed3a8a31ea926a1837e072d39fc82e27f1625ab01e581ffd50788a566b7392dc764197b4a4303d88537bad649274200420dd0dfdc0dccaecee9c7fa7baef180b0ead17e67456a42c8082f4d3fc46facc20dc390181aa1a64c4f60436b373c2af088fb7028bfce60f06867242d0b11e171ada7688dd5807c1918339b6706a3bbcf75240865ef6a2c9701b652e7f8b61ac134ed79462e89e1a1932069d0d58ea376e3b87e8127ee32612687e8b4ec4ba463dc7840f998f671f461ae587f7e7cb09543f2b5a32d050e3854276a9622bbbf3a4d48693e20321f568f63991f805f9c210093d9f7eadf505862a41e678a0a671cc81a0488675205e2a6b01738e6973797f7d1d127cdba714c76bfc94028aaa52058b27f48015fa01ae749e2814cd683d671f41b41d1abcba76916d6f24d9bb9feb4ae5503ad9bcfe2b4f445572d9a07685aa9b91e20ac90966da0d8d6fd5caa686eda157466f8258a931cb684327fb7c605f5cb6ed2e5547d3b82e34867396d657cfbb33fb94d08769ecf98b235144f8428d9e2ba1dcf9cb422ba1924c054b844d90ab4ecf623d17dda42e34c5c97bb3a8ceffa0efede5429103e862216985b9c0d93e664a32305801a8683b313c76c9f7a518868d95ae824ff5fd96042d8d097e64d3f854c085f7fe5ef8bb515fd20e326b212f0dc9bd6a2e33236454c8bbee51c7f8e0cc8795e08d6956d6962f01b0b5cb3e0d85320d154da3989d72515a3c19bdfb19fcf0a9807832c5ba18544ef0404a0b3a35167aa6055915cd5c422ac8a28b099b38ec8aab507b80ca8992380cdbdb1b551c4fe3cb6a9c23d33de283946f92357d445d8db8073b9d15600bfa9c5d5a7366025bbdfd7b672025b33afc6234ae964e0bdb08558ab9fd07fbdc44b1f8b9aec61285698e68f33c05491e75fa597e42e62119c5b64239216c61f5cd5e2e6595a5bb13a95f0f1cc077c3f7d9e379e113442ad9bac9d9488febc789e7fc9303f7c9916506bbaceb63584c92d42185dc732e73793143d2d1f494a4272c35826b515d24430e9696f62f3101f7c1b3ea84a74e2c0b2a256607e0cd1ba878a57b6576823d0016131c7c89fc2dad33eac0d2a08b0d88ef89b9ee418a7048bea2a174979488bc8235800346aa07a9c1fff5e2ad523b59c05cc81526d8f19d60f03ac9e95296cfe91592564d388c7f8e26a708cf872fcbeddc4a628e1b642b9caf6b10ad7378f201700749e81d2e55c151e57b5205565d7ce20a02119b85694ff35366eed19bad3921ef6785b19e95d1de2ed71c32c5816c32f4a8f0d82c18ca588083bdc762f4856a32b962142c04e22ac19fcaf5a194e5513f18cd9773bb224934696245d276d8cd6e1e0e7fbdf55c2703977ab5c2cef1862d4684db3408f161d2f65e76fdd3cb5b590e38f745e7c8d18ec06692631265463204040258689d73fcd04c5a9d6eef6668ea4e8ce5c3a34c1bad9e2de5d7604065ec18dab9e07a89c47d8ec5be62430253acebcdffe66eb4142f4b5bd91255b6a0091713c72ff5d46c4d8155c9f044215cb6f8487c4f6de5ac0876293b9d5919a4c7ede022e61431044cfd0f61383e7d1479b242c21bc622cb938b1553ccaf1e33ed5c050db342bd85147d82e3eb6763249e5379ca1f1ef162e3bdbb76378428dc57541073c9f92e89a87129ce3fb2b1062c9c73ed68f79b980e2833cc6d6c2e56e553ac3d41359d8e0ea7e5b00c733a9fed8a426f88733c5301c8d409df75aff059b4016305496ba755825796d4a17313e22e9af7167d90d60b7d14fcad9728a05f3f30e164c45d64d999e84ad71e4b0777eed032fd40079b67957c02012a61e3d6f5d76549b6dd022939f6e25355e3167f9500e25242e79bd126fdcb5f8b54bef19aac2d1a8082fc674051303de47c570283f35d6a523e63230825f8b69e1b10569f2762cc303514f974c2b8e6f505bd783fb1c2b12fa1483d7c59001f64e3f3a8cf8e2279c1f7bac665dbd69b33cf95ef4b71e3f63332c05c64bcf5145b57d2643251bfc65d5a03139ae52d282053fdb8878d4c4f6fc8b952650f4516175d67b8ff1f7c4518664c19c462e7b07b6cc4dc559e68ba8872076e026e57af99268becf5e9c4120b28931233be1a4dde968fc69c27db6a790418cc4fac363cd903d3fd331eb6dfd82648074c04461a022c6b1505001ebcc9b87940507f93886d0e8baab0f1aec01de634359978d82ac92e0ca27eec33b5567b43cc981df5b232994af0d48ef099f2399eb8f2b389aeccd6fc85dac7516d00136f3d9d20556bb607c8ab2e45182e19e79388b2bdf161c1c6d72d70d1419e2d8b78499a93527328ef8aaf744a2a0b97cca052dcb809ab77e9f3853de3dfc334386ee0bf022b9610b2a8cf6815bcffffa519dbb6ba6c1cc9e20e9810c5312b4d24e5fd47c6bdb6ef1ca4e3bbedea0e5cb7fefb12fd0dc6fe811a3a98bcdeb6f27fb2ff2bbe6414ac199d491e73e3491bb26c3e4ade2571f052ce90437075d23500556d3230460704e993fb2c34b183ed6922f40da021ab0be9db7198d1696b23aa479c850625026ea8e95a80512ec480244d85b443580b58699828d8aebc17c8358af24be0965b85988353e37c4a65a5a7d2cbb8b9e5ce1e51baef505c2e4d47090e84e5c28ef9d4ad7f4f6351968b983e5fad84b8100919661336c392b14e20f86206fcc8b88d36e4584772600d3d8deaef38c67bccd1a503615160a5096b8b979f1cf52064c444f73a3a76c0f1e982cd0d072ce74b07b1307328e66e768512129fbac1447ae878d2de766ad579efa5b9482d458aa9e5aade5454c5c1463c3cec0e64b369d381178a464362dac2b3b54016525e652921f6159acc92f9eb939b8c53b1528a7b824d76716df81ef267b9a45ee4ec001f7be3e675ca0e0c589dd6867a09c6799dc9b798028c11f37d0c6dd9350bf731c3b7dcfb69cd5ada8e4ae227ca6f4efaa9f21d484c3cb5e7eece4ed76643dce545dce0703158b5603722f95db5b0ba3f8ea3a7342dbafa5505ea18ceea11ae969a6651b5c385a38c719910a492e9e0cd400a2aa8ad9cd5fc5cb74ddc855a154fb2e90965b5c97e75fba39a396e9b9a4735545b36e02f1fa00e444f9e7cfc0d5289ea3fb5173df1399dd011e11d6f5291e883bfb8c7f7ba14f9d49687a340dba0e34cbdd47df5532be6741e1a84e9737711080dc4300d964921aa4f023ce85ccc3cfcbf6a7a9511caab180d5737a5a51c5fbcc0ed3c0c2ea25e4766be1c2a6ff12c8a152c72fab5b982c6324c266ff97a01e0ff35882c3d41057a58fc94f39bad18e910b4fe34f129cd3779326c0a4f9af54bb43a29e27f733574c6155513eb08c91b4897df78319190b6170113e6d39732500a373e02aee8b88b257a78e4c90a17ab64790d5cdc78c29def7379caeb989f082da30e282b4fc020684f83a9efe0d9f11396962fea2a3371e939faf2514c33074ad8caf517b0704e50150f7592565c023e8d65398727340242a97b8685f2a686e702ce2d828fda17aeb9a1a141d125466f03674835c545b1ba084e045aa329a2907f45674bae26c6e42c70bffcf3042663772c148fde0dc99ff81c76d71689f628388b072be7e4d0e35f2636c430a1cac0fd4d6ddcdb923742c3e10fb57fbadffce57c73e1639f00d3d42cee8064fb10efaa6cfc2ee57d9003a68fc5a5bea787a154a5b91fdc8433478f0dac6079489d2c7d483028bd80edd7f7fabb9fa883144e011ce91dee4a0bf5d02f018d89333fb5107e848f79dfbe6bdb776328357b9d14b46a77cc7b2f2732fe271c4403edea01144cb4c77d7680671c5a87e4453e0080917f52a639c6de4a5281c1505cde357028554073df351c82e4fcd15120c82126f645ed813179ac1feae6a97934d7ce22a9e919c1809dacade089231426ebd06234ed3255ba436809e50aabfc22e42775a687b312efb2d329ffa21a3e6c29a4b54c59a27e0618331240f169d17c0825cfc60b4c8dd14895b250aeb6714e1cbccdc577a8df5a8b8da90c0c59940a1cfaa4f3303098dd35649458aa1a2658c182b375207ec6ff6660b89640a2111600405fad801dbbd8827b4e1da9197542d4e104d451f09d53999a156da97881f778d618a693f96c979c2ebde1f4c3fa3f82cf41090bf11d58ce03f2534ac86e6e178ad187158765115703de3df6c9e1bea2bfa305e31ee3c270ee2d0187a89d80018bb59edddf41acf1cb5001110e1dadcbde853fb8771208d6540c5ba0ad3166467e92c407a2ab4d6040fb01f6cba4dfa6b12ed4d49a70f6c0923736d1d43af45f1e92e1664fbcd763685720b7a46993093c945ec4fe9aa0693b790c70ce2d35317198e6343798172b72034f67d1188017042e73439ce057e7eedad1745e57260840e724d829ad22faf3a813fc725cc446be05654311e24a9c71e995bf00db1b21f59901212ff942edf70e53d7abdff08c91d9324a2e9c67a4299a44265ea5ac6aeff28cb06c4d44a9d5cbeff0b791b994add55265543403c642eac4d89629aadb8f59ee086fd56ac440ce5b5948a95ffae86540f2b679fad493bd5dd5036f27e6c77249187011311a60b9cf2c9f690eec6ae9eb5437785ae7c518ed0b93b65484a5a53a1167b39906d1d6bd5ff536d62cef37b8da9335f4d0cf70b308195ce861dd53c68c914fd7483397d379623a4a152077bc2e50265e34437eff3876e09541438f60ae1336033c3a64ea7446f55ff31a99deac2130c8d5ab23bf588feaf3d36f84d1bec421a049525676bb0160f75bb7c028ab527a62fa5b7a82acfa8f11f15f73914706dfb37da94f950860bea115f3f8495729e76bc5901d0f8e39991545d8bfe9a937192eba2e4a6683e33c4f6174def74d5e2f8d759567fac217c121436023b20525935dc39f78c5f4c381cefd109fcdef8872751b021bd44d585756e9f4278946b68ff8a5ea0639e2f4010bc915ef8f2c47e57c72dac3e326d723bf546db97967ef2cf61dd5b8bf73456e7b53ff2f8157787eb01ae5fc99cd627bf8bc26060270c7519d5c957c90e93d64fb40c8bcb8bb4b797867b728a5e46c0b73710f565f8949eb52b75ff24f4a7774307e592e87fddb56f76ffb32e65c4ce5a3a968087f5572b106d1857bcbcecef0206c5992e312c0c7742f70e586d2c963c2c6373fca45d40525991e7519881b7f1601528de4be156ab0ef61fecd0ab952524a5b9ef592da881c3e97bb80502736750a72216c76db729329d08454504909c0f0678b8f3a1409108f369792ae80f850e4f70558683a00c4a3962c561a3e5b413a3a5be642209d8e43ea693a17b797973403dad4ff195c1be313030c320bb27b5da8841d0592307a19bb418b2446d9c3e6a6f69f72f792b537ebd81b1b9e0d38e6dc1e3525fc7a30a79665723427f1288e00df9947c0f28d286b01c0f330d6441acf023dd8b90c6d93d7bf929cf93ef7bfd1fdbc2ce835334dbbdfcc9e28085f97deb237f95ac76e27cd3399c6637a513e67b4db807e0df146f31daac63ad2101dcf3b4bd2f0565deeccba60e3260cf73d826e83b509aaf4f19c2fcd6f9e5d83bc40fa7a92b1f9afb0e417f1ffe264634055da0b5c24cecf73df91e931042142ab19dd8626a774003447c421cb807b9e58b7c67b6e7a25151f3a7fac8335a111a0057078cf954c14e0d8757b13b0200627fcd93656898d90d3b03197c201091f5cf610522a7f7601428bcbaa04694e8da40d4f803b4f69bfba9e8a942d1780ba69d05afd8f5170ea58895863e7450786c01808ea1811d00cc4a582d06e1cc80aba9c8e1e3406162cdccc7cee2dcce5312934e675e48d7c9e055fc1068a3890b8aba593f6c8a753f616011b0cfde4ca5e3bc12bcb36e5d7298d03b8dd038732d8ca31da79c74d2424fad9679387026717ff56776e2b8e727f079d5ede5d38932b8a6677439fff7c9c38bf981e005ad6dadea8030e45bbdc63f36fc8dfad93bde8a6ff9add518101f0df16da0264a35283b706692ad9f64841bc0816af95cd3aefb76544577c7b99c6be927fb830d8a8f55efe1d784cb96c47592e84aa8c3b12a2dbe5c34c7e7857cf67793a8181ed291abcf78d9e782801e624116772e61521ec345156bc44b03c15e3d0c37f6de7b3cef495601ae954420fb721b17797ef04af3b2d43663861d56b98de56f37954bd0bd4357ee1cfc5287b4cacc55a5605399a888c7ec19e43623a6fd2deb8f15d2d1ba88a3f9d44c89fcb0f5ff61f4a4fbba982320a362e41a717222de35a343d5ec29d04b51aee2d7aad9da010f8e0d711588655a56b37de63677fb3a8de1208da41d310f75dba422e045d01231abc83f0819c77dd18604f2c8562ad0c19a8ed0255dc320b91d101cfdb3df086744ad12f9ef34181175cbf3b9c6a33e5f8db569ee73c9cb5da00063506793457ff3f3660ceb5a69399a7ac0b113bd5ca2081a611078dc8956ceed3a558b263b7230aa3de710f77b8ff347bd52a6958bdcaf18060f293240721c1f881de15ef7ec382255e598f85746a60af03ae7e7955f0a3a7a8fe59c1972a4ed57fd3bde7beb8b7bbdf2814432d61756e88bba149310118e88232638eb4e2a6717e9f30ec099c6c73e65c765334c3562d7a84f5250572b216260452e81c56ab0b99d8dc1b9c62e1e6f5063994b62669f7839b1f7425d0ae85c63be20c6c5d5b7342fb61fa52b0bbe30aa705ba73623dc7c85b07c879f341510e46f9844a6c1e4646144b6995b45037b502d2f312432da2e3d19f159ecbad8dcaab6b1ee29e6ce2eb216a28e5bbff31425e2a778f76a0017a441484f97e63dfeea7bb9638ae02e28d2fb9c1be51156e3d416f0216868539fcbc16958291a8ecf369f07c8b22d08b20a06b90c244e37aa2e9a91d4551310b0f1fffb756c143d5cf8c0fd4e08fbe9803a6bf9f52b070bb703d580b336adbba437a6254d46d36c476ba8a4e78beda9c1f59fbf428baac9b3639ddb06ffa6bb28cb23de04a9c1b4e88db597e89cabdc4b9fa3329f48f080abc70dabf2c3e7c654c44ce277aa46ff1dda9890514b931e0e8a0d2619e2d2edfeba431a927031a75dd5d43ff3371f67a83e043e47f95d95d51b1dd1aedd5e5f57c3372bc61350c0562715da6a54272ae364cc1c6a1247f133b4262f03644cc2d996cd992fe0262dfb67153d3c1a7d58f5e32a5fa8967b82094d969084b8b941ef36ef7e15203560797b8c807876bbfd37bdc44942e35f45a2cdf232f41785a8948f20125735a0abfc36c81184543810a46f5cbdc6cad1b600dacddd1f633eb32ccbc8d39e04598f4c39a37945f634fa68a628960d26c044fd0687cee7046b229d28a8b6bf3bce0265928f3b4c577494a0ebfeaa68dd83795cc8183cafbcf880173bb3deddf6cebca366fd05ada40cbc95cec828d0d15b2f1f6de05e1751380c82c1fe42211be8db7025bd5dff41ec58601254cb6d9b34a5d646ea1085134d2a456d67fa9cb0662e363e74e26b5c11319847e08a92723209f0ecc288a02f87fb36e688557f70c97b8da8283423eb865992cde548537cb5a20210e4127f6ac30b20f729f7947d64d87d0a4189392a7813ac6837c83ea1d58bac11b600df575a7d370ec405e6b0fc03724fff49d76530577f7fc6c4b5fe2b02024bb2f80239d898654cabd715c5367bde8fc634f1c174aa2d48404840bc064c1a9e4c3ba1234b535d08dc25f230afea497852df2f7d6fb5fc25d1df401a9d468a650e421297a9c3c8eaf9ec42d36cc1a1053afec3231bb313af1b76a1cff8edd18609e9d66c69d912c8fe91abef91e4884665f66a23d0296c5f2cd130611b4292ac02ee4768d7ea839b6db345c007a59cbe5d0044c0fd643de6858ae4008a3001a84329f7d0a30021c07304edb0a71147f5a4c2668bf356195850a6f07ad348d9ee05b1c758032f793ad87ccd85494eacf9907d334f8d80a4997c6382d16dbd9c5e08e044e5e4a0739d81d103cb5eccdb4bb308804e26f50e52a9ad3c4da667a7ef62c3282133eadffb1928078a70602f1ffcbf54d4695bf7316b4e81a80d0af218e841bd70b77031fd92d6ad6b55f10063c10a93913dc5bf908ceef0a56623ec423c232f0859872c9c4cec44fc3a6699ef8c826d7c24f23fb75c4cf30516f2234ec93da4fd172430714839f0a3ac727ce295db908b778ea91e42cb0db2cf4965fc320e669c29dedd5d8d3f81eb1ab0a6712ccc2c7135a0afc4b78881e4121bba75ba86035939d4961eb591ad1f5d417fd256979935baa95cef40e71f5ca20b62b9a1d40ccfe6ade2d2662382eaaf9eb9f7ff9b00f40e5176f946f053f0b13a980a7cf8e5c00cfdfb0916d8774cd5bdae6647bd9bbbfaa960c03c73c63eaa493624a62ffab82e442cd49f1712f4d141d28799d56e524e9f525ffcf0ec0d82b46e43c1c568511e940ffbfebbb324c5c1cedc4fe00cdf5735ab6af3d1b87da4fe0d556f9e829dbe5f24c7ce647bd94580e367beeeebd30d72779af259cafd54288c51518a8b343c4512da00546cc6ca5c54eb09550ce37fae1fa952af9c43d10c18eea5184d30eb2151fbebca9c5690b6a7869816c2bfd0531877ac66208f014a05530c01bd66cc12f258e323cf22080b33f01a9d81ab51a7cddd057d419bd44fe34f9e4f79e244b5bd65c86f963f49fd1e604f6bd659083e81ce4a9f04413c5bf1af1b69ce1450bdbb91cb4802f6f22040fe7309f57332214c94e975728682fb579052e2c8e7880f92f8338fa03be4c60dab4bc6e4a06a6b9b2d30a67fb729d731aa8388d6774a6a6b08a622256e99fa335d8990651f5e1dccb10c464b91a593a378a4b561485e817e180555df608f90368b1d394a4b9fcfb221e479fcb6f75102dbb225800f3ac19b0e77635654a7b43864e6e1c84b80128d3db6ec55320ce49fd9b9af174720f71cf83ea7c78ec45f0dbe2d109d96164f4ae79a78d42ded744bab7d88c5e2b464920fad8c8783a6f93560112f19c8de2594e415a6d761e210df310772ec59d0a73df57cae93e50eb3a3ed7a762c58c781ae032749ee798cce8fa66dd0dde4fb26535d441b25ebbf07f195ae8db5124000f4aedb12efa30cc39eb55f5125a949f2371aed23d511feef2ed71b311f66cf58f79331fe0c7e491a0a6bb7c2cf66983cd9587755f7e7f32317d8ac51c44ec41d56bde21bbdec9f327602a50b9b41d49390f8db6c452ce76a15908753977931e16dd020f8d94240f79ac9ae96d6e5018ecfcf0b93038edd5d55c9298bb605fd42c24584824027e1fc058292bd238094219e87d0bc9371dfe24bd0d32338b6b537834f34ce3c64c67d4036df03b9d088b2a6de040ac88d1ce2f675cd2c93e539926231ee5c93c9a4fd6557454d4177cc86fbb6a39ffeba6892caf7d0fbdd777a46b4c9089eb2777043f5796c0db3bf3f2784abeaf03446ea169b274d8de763428563c553a730a1bcc13dd6c6f479bb2c269312593a90a548a375f3e981e6c2d6fbea8240b5d7030b63a6a367cc955ea38b7f9832f4d0de22f684f6565e93f224246dec7fc3b94428a889b955ac8a228bed24b931ed908d1780ee26ce302420f45e6ddf6977a3862b9fd7d018bdadee8b00ee99b91488b58bcb6f5f4408c73c3f81f77826d14773a3e9ee7a5491bb799abf3652bcfec9ba1761ec7394e9557addc77e677989384582ad53a8264d9843984fe26ba4dfeb7e87189554c75ea9fac07ff3d69a2f82d931633c4caf33032af65f02a96252be145371d4f7bc0a2a1e98fbb0a56421e096527c3f6e6e31cc9da4acf096352ab4f6467c2656b13f759b4843c4afcce47a42e63349d8f270d7c3aeda0a4d6458a47806f3e26841aa2669b2763252233212207f668bcaf820276c2369783eb22a07ae2975fe31fcf37a7d77409abe09e9eadac3c950ebb2075cabeae29136a8d050a9eb38ea8f87d0426469da64253b7a1243fa7800cc27d05cafed62c8204c8315d20ddd3aca649c833ae30251bed2d4279e55e3b11a9b30f86fe93c0b329720ddd44cfe3574215a21322edb7d935333d6f3918e3a72a82c4d3774b23a139a7ccf68776b6f267a3603b6ed890ea2818c40f6ca69086ad75ffa64b70f6aeac72cfdb7538243c0753323926d55484ceeba58d8625780d8b8dabe773909d6d96ec127a8ff21ac2b6db3ea4b745c109276346552df2f641e45fcf9544b191f11068bd89f2d73612796fbfda8da9c19d4d852237a415fc668c7d2c6af71e452c02bc150cb0069d7b73c30679f6469f9b7d59d09c49e860d64424ae8ce889201e115560decf681248612a7aee652d99d199d1560a7fd4454b377de216384663e1da64759bfd22727ef419fd28dfa96e5ffca68933f3d876031d81700705682f8002510681449c0e4d45a33f43c410bfd311ce0ca6261e98119802c02d4c26bd7428323b889d4e64c8e4dcb6ac85413c703cb63050975641839364c050fd601617a531def00052719f046cbbf3e301e28cd82fd634f7a1340ef6298c76c301173201054600a9dcb873b44eb638f38fcb6f1b9df1e5c68b645dd1abbef8ed3ace9e8adad4c818d0261ab27aa361c0d92183747efe2d254e6d01758667eab8e9d718565c6d071cb338af32215f17b9a249566b4cb31af2b11ae650c78529548276fdd1713794497772811250305d2a95811fecd89480bca16bc84024f9bf982e1f2e7834446880c0663168fec666f7519be4fff676994ca0726396b6463d6aae879f71c51d9cb92bcf471ad9b1a493b8fcd11678f2875e706096dbf2b71b86be71019cc78c7fa079aac5883e310a9b617857c4a5e8cfa7c854ce6f838e85dcef8c0c1d10981120c93a0265841c3315811326ffc487dc2dfec4da8044d9db55780c0bbf23e79140224a51584955e75b9fe1570e599c7fd8921b1faf8d024d8a490f9a7c20cb2c1c063bf292618a199d47d947940fec7c0086dbe95b407c9273f50fa5df71ab2179bd15145d212fd112b3e3cdd36941c11f8ae62a111e38671568c94de98c58e187575f7a31121949ae2a25c12170d23c07ac41cf0cc2ab787953ef04fc7d7eb89a7eee682001cf5607521ffaef149000ce592df1b6aaeff2df84687fdf560d8603b54939ba6c7a71247acf36ca5428bc049036ce075bfa1b223c75e6b16d0184cccbd74b5a18a3ae7285aa6121b7d15b8e70840125ee751acdfd2f99622ba930783133ae2cba7deceb15d22aa4ecf834e4ce038a83b1e379974fe55bd9c19cf334893465fb5554e9fe1d23283e470cbce6d2f61b0f16c755c917d13111581b9266fe54483321151240f5a438866b775b5ea9920352aadb3e0d9603c0c7a7e3ddc0efaf0e639fbf95bc78ba200cb003fe4fcddadf361cab71e5d19eaca24768ba37fec75ce14b37686279ea47bb0ba6fb77983375d5abd8ed37325d42e59b8466db01103649bc8a179c566624d7536fd2f30c84cf6a35668ab6e79e8d57d5f9762ca5e9f99cfa21c7a470476f6b16a5368df671b4c82ee4f5c9af7c7b78cffc903e130286ce50480528226a21bad7a5b2a3b060b75f0f500d2e1d34de352bfda92a59a1dd14bfc152a22178c7da2847c6893ed1fce7d57352673c7bcfc0322e942933b80870086a412ee45a3cf37ac1db7bfa7eb5516fd5dd9b7278d0d3afc63691f6cc5a81310500a57e835a8c20276af0b70994bd60617ec554b3538730e8f4342b7aca4f039272e8bdb6fd573199a38d58f2edd010d643ab72aee26b227da3de535845b426e7653a48041d93ab020d51b03b1560f0f9834fdfbc29861b6a7449aba6694aeec400fa7af52c4d8ad3d0eef1b8527a34085abafb7d83699fafac521726ff2e1726c623f6a05aa72b6b3c9c3fe247a6c7c630423237bd82ff299ce1ef7ad9f7363d7d2cdb8f6a54969e6ba0eb9fe174d8f38d2f95bf13b1510f36f6969350fccffd9de7d6fe7ab1757184610a82b65cdb00dda0735af8f9dffb20ad5d65a80d9d3701d5bab75e4545cc42e49f16c30a3ab89e50609ac3731fdcf73bc8737cb26c1b924327e6d82475514addfba13324c0703e7d349fff7712cdad1983545c93d9ef4a368344bca9aa82126317b51d8d6dcc7ab458780af970cf1afc8060048f7dec6aad703f0b60e83c29d12e333f333cfcfb57b4a8460bf013090be2820f494e0963359bd4a547e4865c32a414ce5f1e23daa178b120f155384f5e950d28a79eda13154a233814c421fad379994f2802b364b23d706781b2238d396e831da2b6c2ddf60c3783483627ba60172f80c60ad9075d4f8bb0907f729a0734ea2e1981daf8ac22cb815265ae9d275870170df67796a2d9e0e3463f4757718b061c7005b9baa86b3321e9aee81be75d84e75b5372268ea2d9c1d6a116eab3ffead288bfae5846bcb718d5e66412f3899198661552787e94a6f8a4b713476f28f992d3db1b0088f62967f082f840736bb7b18e9f2cdcdf3d998e59f58f5b4416fcf1dd0bb135b00161ad088c5f70c5ccecf907310ee3acf303f97c5d5f8f3e4d3d96b10e96b2f470850369be12d51873e6b19deb10e290cbf76928b7485d82aa99c6659c2ed895660fe69fc8fde5aa09a3d7f20308cfd4fd90352726cc8e87e6df67828e723c3f30a1fe8c2e2df505a73263fb3342330b936cbc4a1d880329c79fa305780adde4c46904e729f2f958bb3fde4b28d2ca774f92f847a267ced464a24b9416b7620b50234b457b55eb883f23b1d87414cf52558291c31e318dacba27144eba01b1d8bf1cc24936bd14109a2874d972eb1d24990ab6a28833333474150f23c06b347570a2f979b8e2d079fb8c96cb2261417093af15905b33113bc22ad35e6c188cd9717976f0d49984e52ea088a073b953482596cea1959db79f5754480611e08b2c4c9180e1788671edda148c92d3e3e09bfd2e41f4af5fd7baf3ec281adc41f1d7c447f2259c1adc69a3f7062a9b8e644eeb6da105dd94901e7667910435019b0b96a5a334661d90eecaca0cd86372d7b85c85e2fea997d5158bf8d3c8e123e631fe0041a1383dfd156a23b0762bc205a3509108feae26d9af6b276a5c82012076674a8735bc7d8bcba5a8a375bda531540d4ce62333aadee5b21e43ddc36502417399e05e67569a1657443da60c403624c54dcff12ba33654cb15aff8db1c12bf7cdbf8790aae17e3380282cce8e54db30c6352e7a0c583cece7f820287ac225d2b0214a6536ed862119749e32cc23119af7ecf02c33eac7ba34979c718c5e5badbf5de7686db6d6fcd5716f20dc0421617c343a9b412f32fdbcd2fc94a7b9bcf4b7069c44c9da7aa05d06121ccaa91637f02fe1da17589776ff848a482f581e7bdb4693999df3183d64ba97ce6472c32215fe823fdc157ad65133830ae385af8bf9ccf2300c4cbfeaaadcf9283097aac7d8ada8d1e5aaad5a46b4d68d4166d69f6eca18937f1677e5c125c51e337f9a41ac7d1d71b3c03c179c965410f5f465604f03a602a0bbd177d73b644d566b26c985f0b2fd240993a2ded763f77a7f145dca666a17425244e1700f5ebfb75951df172a1b97b5433d9a1f14aee68053e44cdc8c978b952eb0bf7bf723004a4800fa932a7677355e5f18d4889c7a4b652fef17924a1e30bde8b66950bd9896e61931fa6e898c7f0813f368590e3fa07d59c63bf5e17b13788dd460102191f3d300cd3f7515585fab35845909a62b796f30aeb3be55cb22cb2118be347e43af0e1c9eca989905cc0ccca7a97984f94b741d28c8a31acef3eafa54dc560ec78fa50e193b43f7291c2335a97fa7ed787b3ea65dd0887202f993de674cae89ae25ddafc5719dc6980e10ed4e582e504cef28db071d4d71cc1e6f5941fc728230edfd97f829fb6fd1a34d629f12f0314b448facf05e177f27ce84306c0c0c6d94d2d75bffe20a964aa5354777048f9508b0e67b3a8309a27a9fc58da8d3f3de7fbf8cd0f3fe4b0ae17dbb7e1fc30a2c399936ba042bf4ee9339557b47ec17463a6fbf3f96f8c6afc9f4b7070fa7d29f94fea71a231349246ac15ceb863cc6038fca4ff12ee27b4808562736e528b8dd34e7233d67b1f7a01d366c68468c14f5eadfa11e9e8806fb2a6d801e69a48feca9e4e65ef815401e5df25f48168c6c7bedcdb96d2de955f5f0256cf4c07c2ee88d9d3235503172a1ac34895640a61571760acb2243511bc5c9d32ab242739ffb4fc4c41351ee99ec4ab0b1b3733274b62df6751b033042ca680aa6b24fbf1c973c871e43c3b39ab88ca15c2b4e27b3cd5dad7417e5c41635f50ff2580622fd1d5e63ff915d00507583d5aa0e057b9c3370165d5b1181874392ac8aef6840629b238ebe7b117b02a20d88816fb2c5fd8be5b145763f25e9c73df7be5b65862d8cfa11a6d8ec9275d6952f9e057c293156c8f06a049a5d10e296d6359d805de631d9eec5b3a6a9a46461f5b98d8d2b6827c1fc597610206a7b49b94570b0569f2b5fc9a91e6d9fd866a2f30e64e96f6ff0af44b5c2006e825b0d37c5d29c87e57425e5e36ad7a7d3ef948bc11edd207950341054dc9f62acc3f19fb10c476ea298de21d8929d8323e32003c1fc75ad6f8788979f3aea8593968bb6f239bd31666a05f3075c0755039339c23f3d03398247d195ff13292fbcb9b13882bb62ae1d54165ef9cf59e040edfe19279995dc6bfde4cc98c9ed9cc80ad2fbe02fd51035e7dccdd1ddc85ebb0de32fefd3f9b7685ea22a4604d416d7bc5a2f8bfd0791018e02b878b75e98368ef5bead4728cbdfffad737cad6a47d7add46be4cedc68a1e6fea70f756c100a99a83d28f0ad060256a61e2cce82112a0cf3dae4f6ceeb4cffa30c230a9e82ff80ca981f18da67ccf2af920d0f89f7d9a91fed3327025a00ba99606330b28261eaa4e4c46f3c39e0390a32953eaebdd92fcb17fa2064afc78a255c76f4bf0c0622ac5f949844920c80920b4ef4fd233f2912666fdd2f19431a4ab8157782c3d8eab03009b7e7a4c26cbd70d15d15d1175ff232468064b9ec309d256f37012f14a7fa9c62ee372817380c104d07df8d24e9b0e9ffe203aa0c6a8aace70f1d409302054c7831090600b94d4fb2db371388fc90a989fe3be27867fb079f04c8b6b5fd2415ce406d0fa8f08eb7eec4b9ef878d01a9d9063227b791770794cd0870c75605b6c020a742c0fcd19472b0338c067b710b2fd5070e310be6e757811e85c262ce83be74b201a572fc8939b38462b353901935b0b7286382919d7cfa745405b3ff2370cc8b5f2d9c54f578a8a304356a1f4717147a13090a54f92f3d9fd006968f062bfbc49745d4313e377e0854f51c7c5d7f07d10134cb6f31f18bd7a93b8601ee9cba87f5957bc51f0d07e5976b97e1f344edcbf439a23d0640a3e324f183679bdb58abb9c0e541fa77a737e39ebf24179823a879ca4b57de0a934e7ba42441233394c0180faee46b3468a48b5c2b4f3a39ffb3473d65c85d6dca75800e7e18f94ede525b0c99c0678fa9077d2d816c5beb1aff5bf1fa59dc3fbc08e94ea80faf17ce4da0f1c8f737b9a4c38e8d102ced3bd3f6de43c002832b0d32a320886118850c36e46774435bc43a7ae31f44178f7b7a2fc238ba0ee84b725c2c459cea88cdeaf6833c0f8fdf8dbb4fe2184193cfc1c1dac439d9250f3f782303d3d1470ccdcd5e7d020e21d317645c1bde28e6629302245ffa908cf68c78f7ef4ac5ce8acc5ed68314da90aff6da6e7d1b4fd876afce8a5ccca2273e3ee3761354f12c86fac4e1e0befcde0b812180395922a375ab44709ad8e9d0c37b5337895708f29fb6fe2a7a1e24abacde6bd6865a9e22c8e172f4258e7b54e54049e88f78cee0e5e280a84e0d12e5046bbd180720c55f46b0254803e6fb57b2861141baddf3eba5b297ad01d516457a2041919dcc8c94bff0633880a4289a5a3aa73ee8b95dab3859690b279f26241d4670a4901eb791cc57cffca68f658e089a9a1d67bd23a5f320a7611a0710442918b4de1191e71940c0af417ad5ed1d9004a500cf5949033635b2992521d5976aea30d0eaf0b8ec7cc6782ddac538f8d4e586b8fc5d051e9e7a855fb97435ae2a980eb1fc8af739de24f3d185e62e99710125f4ba7f5a93457a1d9e0645b44140038e2f2850a4215aa55fb7a4fab490674fbd972df02b8a429d22eae9329223a661ba0dd332ac6c64942e0fc85f25aebed4260fe707468a2a735fa8bd9d011a5f24f71bfbbf122213a381817ab618bc159110a88415de409cfa85bef4e48dcaf92209bdf9b3bd3257e5d687f45d5f0d0fe9f9ae2ad343a2805c2782d1e2b73d6d613dccd771d5d1b86e2109fc251aa119da65cbd3e7d358f5229a8f6b3f90d47e14ef567a45b1738a8a114168b921d52ff24906434031f134c2f60ac1b675a17d0ef7ba5c9235834c57dac5b8ac1c9ba1be25653444fde528cb60e86a8a01dcf915eb22e03655bee4b4fa4644924a01c63b24ac745b60af9fb3d1ec8e23fb20da09c75a4a6366d791ec21ebe0dc28054192fffa78e60b60a1080187fff481235bdd33f743f244b79c64ca6d542b5af08f803b36c6fc59357cca26fd99f74343e629940bc33ba03047bd6c10df04776809c16b0c95118b6800d165bd78481816ab1489ee07fabc1daa8f1d143db00626bd47b5415eae1632d69cf3f18a6dd9a982b7520eecf62971fca7c7b1ee13574db0803e83ae63fa7eb2659920596354b4e6878f92dca08b45e0ca3df86c55c825b5092ea581164ba35d1deb040919b2f626b1bfa287bc7c590dfae62f2a7545286ec2172991dabbfe5c9cd697d4b75e2d555f0da6458d34523339f577abe79075d57999d3c21ede6aa4a1f253e75217052bd90a4ec536c5ee0a24ae54ea44b3567230239ec939471230a3c656cade323228fcdd21e055cd3c4f35fd5c7ff38b0e213e730a4e2ae1ec0ffc4faf3d365727963c0ae96235a8ee0fbcdc7d769ca43553e28de9d6c38248f3968058d164f883868e234c35962522c9c1fe65c18cf9c1da78270de78993a7eeacaf171bb994d3db603cac59dd9f558fe9e306dd8a4d2b02772f9fdced0b219ce8332955437a560a0fd7b12751ee53ba4ef95ac37dc95d8108664cae3b307ca866c6068603e9fd9b84457cdab808f444f1d8b289ae5350abd98f9cf6654349d0452068a0df36e94b87da2755b95bc93532c5cff8f5079b5da5758a06a8e03f2090d302ba1939c8958e239ebd1137b704516c029e10b379a4b56285b707c6c673236695539e049f201bdfa01b84bb0634a444e2b7df46312703d918d1b30317d42ff3810023c29c0c921d6821bfba4abbb3ca1b6566a5dfa5025c319fc5c42f80a44df38d52d07d4e37f9b5a1a3bd2590883e3c142de91f3ffa4c6d5ea96c38e6509a978ccde1d96a886cb09f87b8a8d3cbf374f8924129345e42a85146e0eef227ccdb95880c0403ae365aca1a51736e84e199ff83898b895d36d0abb3fc7fba32a8dc63d9e027d5cf1efe60a14e6656515ff3d2cd87d2301f1156f7dc5d54c96e7b2f7a6d960789104c46873f08f0f0192afa7accbceb344ee95bd695a43b1dd858bb3bfbe46732d27d7c5b36e2642ae157fccaf5caba18d4a0f075357e339313a368e9221eb95859b8ab620bf1b932314bc1fcf4ebc389fff90fbebe242a353dab140a9fb9ff1a7434d8c00bc2f48a525b7e45630fa8b030554c77b6ad3c4a36fbb0f0c2336270ec800c25cc3f50ae608c0414a5cad51b6524b74dd0d631f186469ee0ff0e649df4d27f61799b6e4059e937a45e49aa70d43acf2a203d0071bc388e9f04a910a26f00fc3057b0b9906266d5540c42fc7050a4b61f3ab46a8bb2a08d4958e472862b445ff2f2da720df8661e3da089ea2c746ad89b36fdc78c982ec1ba5f0b7000efff2a39fbe71b759e6b92b45d68c15564ae18ab7d264657605c27082ce50954070f4fa0b26e8417ff9507a94e059173de21e8e85425d5bab00494f2f9aca4b120af2b54687c50299006218bac832bcd0563f749b59d7bfd792fe03fd433af7d2b5e6e74997374a1c6c732f96094102ae09ee1712744943cd158225e3877b29a6b9d648f5a50d2554800036d0c9525ef321bb28a5da735d0bb7616e95b63b7d90893a090650b2f201f6e6297c01cd29d57c7fc95fe93b92480ccfc8f9685b83c08ef76b02a39d1f4079623b40d0a7d0f53d13085dae2810a76ea8a9e32197cbaeb0d98324ba4456078cd396f4b945dd56646c530a9782091c034b3705fb7376956ffeabc0162682d7f46eb5d4c881d4404188e9c103acdaa52680ac56ccdaa0ef83845a7dd6f3fa19e79f7f98b68b7ac78288d856402aed1c857559518ea31a1855791584a1d88e53ae33ee83567e58dfa42c9a0bebec0df88798d7f70ce0e64621f30ea080605c2b4df4c9c7829a3095a25727e6ead86140fb91c10ad878c80757a7bb50a7d218457b1199201786315cb07961f04a2924ee69e8451920526d95e108d617bc77eeec320eae1be6ed3c9860a3faa22a3edf36c7f6b4ff2801a4d045f3728b272da03459550bf22ed8c56adf2c09ac4e0c05a8c3703f9986e048210437b1262ab39e530e505240d2dc9484d8fe579b1cf7f58a79cd6b5a46414075b18bd803a84fab26caf1fb79828126525080293be2238fd341bd318eeb267aad221123e7f50c6165bb1f5c8ab4aa907c6573a729386f52c0bf92686b25247bb66b53c4b1dcaaecba1780352112e1299445ee79684f62583fcb6ed63cbacc4063e3dbf5c47e8ca88e28b1f24ea10cbfa28d76a3d2f6b6ac0718f36d9e3e4415a1d00a248926353a71d70ec1c0ca9cd9be5a66e38ec2f8978912cb6b0cdbd08344e7727d360781ab33d0f6869603b049f95d5c00cea03b8052af9650ede0c5e8d1cc2ee226d2e7b763f1c2b8010884464f49d20ba84c4bdfcaabcd733338e38dd638c79fa5dde9f153196228912444db67fefb1dcc4e3f73c5788593fbc93ee1f176cc67fbf2d9da3b78de0603175aadc7349276638cd5b9213f1b6adc23c1ffe2a8ad0ed6d8184bedaf7c3df7444810029184485fba1487cc5ddd87e7077167db96e86b98fb735aa7b67a9b6d937b42817f93122eaa7cac3c3bccd7af2bcece03d076e84b24eaf8a46311acf698f350751e8161ec371d21538cc03d840461d4b687fdfd8be6f1c07795b55b8a16972bcb43e492905faad287744e9b6bfbdd894be1a5cdf5dc6ae0df393100bd22c998a3b9c80d444cb2a0541340362014ab090fd3e4802cae8b0207ab24450e076708bc6e494df7af51ac7d90e399a683583a408731fa3d281f1b2f94572f98602421c95dda0c2092873213709cc953a07b842cf341bde091671014e9384e73662673703fe5e461c5315c63cab7b502b3d1b9b63137bdce6d7317d470ddb6c8cd77de55fcb6f7d5013e73bde5ec45dad22977f0b48c438acd07b5775f54a2651b6adb8a966f814cbedff43f951015779f3d2c81313caec69bea10ccac9119bdf40a1538ec3f947c432541a5302352ffdda6771c889dd0d235a892964cbeed202774233c11470d09e6d705df15cec316191ac818fafb5978c2a42cb87e2246b39fca55d3ae7a31c21a2997d68249086cd1d4d013b7414a47c2a9d9b2df6d87969e11380aa44d54820ff17fc694232e50bc0711dcddc57fea10900be828baa203ed0a24bd27a25f610ec961835ec77c201f909da37a425f36aa058efa7a1573c691510421e501b6382f18790b5e69d811b0e6fb962bd0d00f6cfc52c707312e55b9927a67810b4975bdc7b50b06bba92191119604312e4c726c868248c8028529b3d0a74a7ab9db2afffc7920cd1a7833ec021af4d4a55ee8f5fd26b9b44d493d083196498ad3b125a5b0c2ddbf417472f551e6b2f04ab2514153dcc03ee583c19ffa63857a6a5596fa09d53ac971821ff6df22412f785e1d7a7e537872b238a66864a568cd3c876eac6b9fc11902d4e2b50a75dc91e197d2352bac7fc9ff61640405442591c5a2d3563ecb5d056b46f731df2b9a040f6d12a2696be9ef23e0ea708204e705e4dcf45d93093947700ac8a0cab82ea5fa7d3b8fda4fa7638fb64222695ea569d61c1c722f08791c998e645b6aa1923370a3cd5a9c71557d94d2ade26e261f78703df6e464b2eaf077f90388077e504d6647e10bfed7a1813994e40bc79f78776ccd15aac971dc49cb93deabfad0d9e823e7dd5a2a3ee507d1668b720b7e9263eb37150634fdb9a815f45378d8e9f7cf76d1607b1a60738648ff0e16f9e5e5839677d473d21e1196a6be47b5c7acc73d746afd38d48733343b7d6a454c222e80890cd24b9aa5a4a002de2f41ff0f14fce2ef7d3794049ad70249ce09314a82b1153a0523cbe900bdf91ecb0ac14b9f57b0dbe45644c042e7f1ccac848ccbfd0a3e331ae435e934396bc3d76108dbe0382025a86e738e26962ad1007a4556be64638621cbce44e0bab6f44287b28aaf34f06c0f3f75e54a1d8f0560e70f95e299afcbe799510aa825a07a6e010d40860e790432c66ce00b43c4786142d238fe3ea93d3580af99c9b78a90170792fad011577cdea5992ce906303f5400070dc6d154ba3ab9237824c8e40bd853ef64a955601e763650870a5738ad974ef42073679b9d88489ff81c97e396b8600dfa54dc92ac07f419e60452267ead906404b77ed918a210ae05a659f3d083604d131f767e9f034ac807210536bf52c5f7df49154a342dbef98102f0c5d12d493034c087c7558286999c7bea7c431c6f133023dadc6d3749170c9922c38723661ed59ebe310378c24d2e6213c6d66c5818207746e11248baf9065fdede5a35e61f0a547681dc120bb55c70eae505f7156deff10f9bda631516c9f023263b3af1dac0ab069412974670b400f943b0a23f00837d4bf75f64cfa936ddf91755108dca67d5ec4255294ded7ee63f2185211b4f6ad9aa4a1c5fa4728c8fe91063b6ae637e164d7fa469baa485bf69b8848803624e9798c8e9581415b603f854b4d0de831abf76b2e371c0e750b4f02bf57967804b6e125b5a3f92e31dbfc36f476ce9600eb7319ca0743ba690b1b713b0e616ac5c151581ab2008c79ae3c5cf07f58d76c49097bc6096e5ac745bee0d84318bf33977ff8c0d8d273d0468ef2689460b3406b89285b7b678550428377895936e2c1f4909fcad04ba1fac24074a009e916c9e1fb91c6ce23b2a98bb2da8928f2db3a07739614854146b670d0f07fc134f24d1ed3c3261cb1465e8febe0ead8a742786ddaa4baa9991113fdf040248d4ca182531ed7586c83fbf4317500b14b1513050d2533744b9af0bcb26d43c33c2fd3c475ac2a510407ab34e1e02305925215ed081e6e01b56581494e56103a4682a70ce9f58a20e381a7b8840592714e7d69d0d7286af416fac17e4d0ec607e8187f23d3acb02caaadf9f488e28e7ddfa3560d2852f82bd7226961aef2906c4b06de8a376a170db0796b8b5622667ba44a5e82159d65ad648cff7225cfa78278f2db45f39430383e60dc31e413b8e94a811a7bcc1d0af0f9905b8338145b962a3809fc64087e94b67b8cae2cd393d126117f250aa2de8f4e6a88f09fad667452f46412c857d879f1613144cd8b5eb63585239519a4d29dac649a4c57db294a190e0b395b0a2337fab933852ebd1bd65312b332b3950f34128874845cdae70289e0d16bb6e3bef77fdf9adbeb06335b52285fddba7fa271111e86ffd1975dde8efb9a4861fc8327ca5b3db09336a6644f55058666011efc87777af285553eb340b7419eccd80c5bb64e077e0617149a905e6fed563753555bb9ed57241c99c39fe1cfd4cf34761df1d743325f951beff12c969d822ead2e02c4b87e1ff041cbac1595dca4b9f8959913a81fb671d834869091e214b9d2ce9bbd0b637d7a5b23a70df034248ceeee3c759e57b9f7dbfe32be7659e7d7f046efda6db2e882c632d69473051ea9b0349e165715d918a55538d1e5b794ad8fbb4c0d37489e0a2fd87cb47bfbd87c9a0872fc6fcbf406e18e83cf90c92bfe0726445168607e9b6809ad2ba0a0fee2511b9e3b0bf41bdd08a9a71891810dbaf13f49e826061284e31b37263c6bc0ea0a3155f5ca47c79eb3de9ca1279ef83dbfd93c2f206b620a742c38424b3dbc2d8470c28e3982f3a40775ea2327ec09297d76cfb2029b6f870d23fce129c73e7a63f72f1505e748cc8cb3aa51887e53a6e0df1bd0e432249fdd625d4bc5a3de64825f484ec35488704eead077e664eb44b76232a87e65ff2f2c4904035405c770cac4c9bde4edd0933a9af6c3a7fddbba42b2f28d8d9c235ddc8c5cef1aa575d17b1119dedbe62ccb6cce26a4bd68c8611ece0494a236e7b146489188449d26ad285dc68b3f23b99d66583f38aa46368919fb43b5c1f272e30ceb120aa572ab52545ba14be066a410a2858be322562a66c089aa02eabde0ada357e8d89c39be5e2c0f02aea6b8084fbf8e385c95c6eac81417ab8f612c8ed3fd40a89d4663891f31e2d068315a8f3e56ecf39e4c0fc047eeeaed604d36463c6994d63ed6e8d0e5ccd6ac84ba4e2dcdb98596059edb2795b397d9232eb6168f436153835317168aa7b393f4dcace086d20b714169003ce1395ccc3069b1c76bbda7543b8a78479a7fd250ad82109e84928d6e505be53ae5abe5699fa5fad9cb5a2d823c45326f2b6affed034e723339801b8e72defcebe87f3bebab80f584e73a1d39259d793bb734ab67ff860319df4782a11ff15df5932d2ad5e9e3b5308228ce6c059592551b3ed57eeaf858d8bf5263c13f47a2dd742c629cda84b7769595340cceeb88d58b177cd85d8f38ba67561c9d0b588fcf780fb1f7b57683398a400956ef73df079f7b4549202a97300fc56479eb037a76445be89111f336febf91ff81cb003b15beba175fd81a5d6dec77d1e0a1d6edaf63077bddc806b57e4655c20f4de16f7d3f16eb6d92084e5036504817bd5333d10c6a550a7ae208dc545493a2efd39f650c138ce6a1ac2ea2b27326f26fb4417090d60c1afcc98d658d778260f0b0bf32417f8d97866282805cc524a05763c94896dbffefea93c47fd91ab79e018342c26977f0b1afaf85787757561baa753f76e030a98fc07d5401dff93619077ae7b378fe11f23d22c650ced1de052d53b4dd5decdcec6f607ec2244d8793c615d5ca647b8e32dc4bff14484ac57fda79998750c5fad0a3e3f1d1746d397b2181a2d372e0c21d72c4b86c93a04f7cae105d51206254c225a1880ed839390507123bcd8758a45f32faa5bae96d8d1efce38816ac503db850151d6a8ca5f3ad685f2df642a55f4b36f6a5f75572d34c52be15547bca691eaaee5402f76525f462b487af8d55d0a737fe63dfa530e0a60a0df6680c9885f8cc78756bcb86c850c064e95e86e6b30b3f6584e3b4aed3536924461a6d84b676cc50aa2b764a95f32c63f66706509e1e36bb9046bdd17017f4db9b6674f6feddef415f56de8be06fd6958dabb311b4dbcf0a70d777e9c2507e3de4140d1484953d6e8db29bf7041d705cf47ac2c873fd6ed62bab30b5b5a87bcae00ec6b278d96204a70514246d2acfe831d05854e452b83a1d53bd0b03c4e0c6cdfd61100d791f9299e0433739ff5940f135dc97d3ec8f36bff772cea9610c24f861290419441405019dcc52289ada1b0c3823ab366e1e2ff50c41b073321de64fa3b5c6a5e4d32af20d902a6eae1a0c20b118d25e8666620ee2361d1547cdeb10fe3152b4dc361d7afa3b055e4752cf6f0523b39aab2a049318af458155259460c1c96f100d02840e3197fdac7f14eac1324e566b2d1c6affeb17bd09ebb56881d5160c56f0dadaf190949cdfde794435e859cbb0b193056ab03ff9e987015b3fbeecc63b9be369b06b9f9b9a4dcf7dc68088d9edd9bde96cb9014d8d965676745fdb8c16f6f56b4b50d4753c7fb3e122654c1ae379c0a979ef29ed848b6a3973a76a28ee2042eb124ebcba1a231fe0612a2051f217384c71bbc1edbd5f2208f45ec721b42e9bb658c5b75f33effd367e0a6e14af3cead5effdc24ded9bcb3f1bb883995a2f80f79a81133c03932c8ca2d79bedc5d7d68905c7e29cd12da033f75ab4e0f3d5a4bf91b39f59d7a881b297cd8f6502226e2c4d568ea90b3611dae73b8fad5ef613d25d947dac8ede6e57d96133aa0db5fb78f95fcb3de600999a495c9351c1860e59dfc0e0fcb0ca5b6b21aacee5277a4d403cc322eb94ca49e94e34401b983375f1eed6bee075eb3f0939046bf176a4de7e6c251fd7e8788422bf58e8e1a6ede6150d1511fa848752bae8b3c955305e50fff84288097d95530fe273a0b1699e21bae02fadf976de80ee9dffdf1cfd3d50d3cdd7147feb5e9a15bf5ced4a317f5047fe270c01cfdaa156dc684b58906678acbb1133ca02138425a518efb871a3e9fbf5fd7a3acbecf1a15b931a872aafb37bad47690d14b686e3ad187c05d7c3eafaa356714e82d4155105bd92f835961396a21de8e3ac610cc8cfbc41d25fc460508f8ad187ea4329e728a59b1ae3b47f3850efaf6ecc444e082fde78c326441103b074e9a972102781acc97d9e5b9964c18afb01374def06dfe4a59e99d182d24aeb2fef7911e5739a1078ba3194ae72df13f3447e1b86db9e1f014391f45787b4fe86970c5aa9d40f540f30ed4f806b933431c4946acd5d042929d08052a4a0590e561e8665a6f68f4432d34a283697b320ebf10b48fcf62d3b6c2ddff2eb34e71e3ff33a3fd14a24bfaadb1c4dd3ff8570ff41e95a24ff565a4352edf845d48e52087632618c0ff7bfef635959c4682a0294155c4c256a3972c5db4a9da5f4db68b2b9a723bc8603a801326ae7a9896560cd1c097567862c27cb5a7e076aa55b64021203712d94b3cc3fad55092e994e65da5909d2cac38694c09d2035d0ce04173369c10d914756a8caa9d6e172bd8b79eb077f36fe77a08c49e9af7202ce512e28221c56aaf67fe35eee40a16c2b30963f3dbf5d5f8f62d352b74dcef4149e4b3adca1fb649b4b4f9034729fd2e519a5b8e57d98c9c19b4a6819dca09090dd39d63e65bb8cb24240714581305b349c7822de432f1ed7021c0943b0347a3db2a529ffaea284313eef1f36567139d50f7a01b5eb2ba2c630c927d4e0ee0df2a16e7c14af3938cb31e74b500a81126ed778a2f8e061267f3e4c5fa3d247de3d89448f28875049caba7447fa94ea6864e889b155d298b693204b2885b351f6c86f2709dd20713018255c8e5b9743529d0a08d4836d3e659e66347119a3228f48c4f92b4cc3d9d5f1d3177dc5c8bf04fe0130577e318ba5768dcdf0609f5447b322c2d0514ad577e08334c6bca69a63abc708e4bf7d2f17980c2b03e877746be67cf5bf4f5a6fd8184cd4e1517107e2e297c9184992423a2d16906bd8ccfc8733ea27619132712471ce54c24ebcf6520a858cbbc2c2b247a5faef3b05cbfd5d5e9788f4000b0d3a2b65a63e8f3aa10b636da8a8e63c0585aec81fa9185d994f18646ae3adf5e80e15bad788bc85090550f4b1827286125ab336e9f2c600dc2d3635693475e51412b5c3af8d687ab9e9a5ba94749704ad2a7f6df04268e540a52330ae62a9d172d2e949b46fd2d32764c97497862bc2775a5b5b0cedcb8b66a5976cd05bfc124540c412746c2b02d20e17027c19095f5e5d8cac7dbe837964d776ff4827792ce06ec55becbf7ca1fee386638658b98358e902b2e31be4e412bded53c463eb8929177e3b8cdf0efb32da6013faf2fd3ecba4d6bf7386a7362b12aa8ffd5499db54d59c1f3872db64511d0364d2850f420da88a267c2e53bfa10ec7f7ccf59095818bd23992794533efc6237830dc98a493ea1f4798eb1cebc0574532db3e67818e340cae8ad7084d620cdff2d3e134045bb0ac0ab43ae511057163e5e31aa3b8b987a7628643e17c4f0445a800dafb4ac9f321cf22c17ab027202a2c4d42c53e9a7e1db2aa9167ea881738553738da494f32ce8d3cc4ca927be1327acc0178dc770cbcf2df20437318f2144eae4460ccd3dfc933b567e7a2b2016fb8574b3a4c86e3c10843867862431576b17b8724363eae251300666184ef68bf76f8c211111f34734b7f1fa7b0aade03267083aec4cc079896055d6a7aceb1332105e3c36b788b2891ea139feda0eede86ad59a9f3985f3b5fd2d2d1f4a133a842f466fa480b978216c873cd5dacbaa05c6773d6648f630a97a9d32fd817b9102d0c09236ea71aee85795ae3e281a26118b5187d6f8a8eebeb248132b5361648d59903816cd6cf770edb8d12d179dda571d9778472ed628386f1c27080599d5bcf25b8bd53100977ea1c54fbded21bd386a20b35e6fa946dd1bf91b8b5bac6cd6a21d4a645396c53ca1189b2c1ed75d1d71cb3676d7170e0e3364ad9978c5ef869658ce9e37b473c8622866aa2f264de756f420d38dc5bebe8f4de077c86f9a071eb17a378d16c85c575a44f7c89487e0b82df5db03566baa3d041ee2d23a6200d243aa93f1f7a937811dbc9b9dfd64f2712fb0c1cd9bc8e3a9efe3d945edf8c792d5ad5e19b29577be39332a18abf428d8f48f0c74873030cecdd4c64c943781cdecfbbe9a07779c29be5c19a1b3845a20b3f4fd8823db69723345de2343717c0d4df2e94a187ff7593c7258a62148f7dea714fb285cb70480ebfd51988f32bb26df37d3fcceb45ead3954a019ede518d44d33b90d5c4cea2c1824f1e20eb8101583dc6c6a4ba522216dab077d7d1242346d07faecccfaa57b8603d7a13413eb8f7d48ecb86d1e264d1c4364632be5b73e760ddf9c7bde5bdcc30534702911eb301de3149af99bdb2c8163d5ad3d79a879406009fd19ae1e63b73b64f950a5b9b1b3911f05900137d8bac6210378074c8974c2e4c04ec86810d0f5302dadbecafe4609887991d0decc0136b36f88b114e4a6a4e607c25cb6dadbc427dd1d246205cc58cdf11141a7a65c4131d2a2f202e90a664bf33e043a40c74e03f28762a35d67ef1ac26943ea0081f39b6909c79eb857e3d4a4605074e597467686e8a37c14b6488388285c0f1f4a5f9670266b782d99c85b170e5028098446ae547c4a358737c64107bdebe082ca3bc2597be1167f4ee9dcca8cb141223efbf37c3a3930a2b8c5fb4c6dfe0019da1cd9c24611f77b9082b44e263d9e941e01996415d4066eb32c351a428bb818a2802ef83f5367aac9cd92aef19d1ec04ad84f231d85b941f83954dd873288b1d05e55b0758cede66d7b10b60c0e32536f8ce304001b1df2911d00d384449ee133e3d32e2d332c61e53b1e24b5ac2244f39cb6a330f6b04c18decc87d18d848ba70126746f6147967ff985f93cf9a537fd5b06b177633506bc7d3f34f374c0f248d6ba3def7d7f578ebcbb2bff11db37e382f88a8121991b0f374152547e8355983454b8464a8fd6e6fd462f6896ef4b29fc5ed6f0ebcd4ea0de0547d00d37044797339e1bfc789b82c57dceae831dec1a5c475b608cd18adb187cc9a57d95594e2380d411cc5c146356337026e04feaa75e952d98ede1661548188406e125517f2272f4df7cd4b008184acea03299afd5aee424692153b127b2c5f2cb62bba07098969424cd632f2a140ef8e2ba49233984f556bb78c406f40bdcc97a9e329c7eb49e9f6bb85e8b5f1e1d3cf96de1440931467196cdee4b6b9b5460ee676cb13f7fb8452e109a4031dbe25c93883dc4a5ddd4fd765e47e963168e1d1455784c4df31a898027a911309c7203a132576ba5781e78b30a44937bf0fac2e9d3af603cc2eb323819bfc8cc1f20a4215f7a5328b422791a07bf1f95a6ed48aef2db19b14800567e56ef0e88120a0e36b4d9f0fbb20ab57de3afc6e0fd4d1f20c060d92bf657d52b17b261c2db27aaf0bc6ad5ff8a6b27b0f924e124f1e93ef8d031afbf192dd716f17d6b2e0e8b44c4a0cb6fe6e4b8693fc097e649853ebe6b7d3dda481dc57775b9d9af11997b1549a90ddc05635db3fb1c8f89496e76395b68386e748fb2b84119cd79d777f06008ce42cf6b191cd93b06638157f3bd7d2a793520f053fe14ecbd882f1bc7c3fc3c8ef81a9128c905083e4a0794e8a8d97e8b2a575f45a588020a1dde0599de3baf53599e2adb0126b325f149e208ffa00134af0b7d00194d2b1e06b3bc14f13108dcce7625bc54b6d0a83da854909d74b2fa8f7132f3b68cb7dc31c84aad5d13d1092056a48212267eec683cd7bf73cb49bbceb7423ed7ad8d78fdfe76961bdca8459369dc9cbb0ecd925c311409de957f4c3321653e13d82da5731f0ca66932042c9b6769a3d6873d152a427949b817efd17b8dad9bb79b05e9510925c4998c0bfbea70bb3be44514e9c260532f43d2e1a4655d8ecda1a2e4b823e1b2276e25da06315c4d08d9ead4644da7410a6bfae3d39ee2626b1c093e16382fc7dae3bd4b06a4fe3976337542e961e18c1a1ccfade5a9ca8f28b0504197576e0e2fd5b6d21345478542c9745a1451fa7d50dfd24c7f280f7667422abad07501ec2fc45560b1eea454cc7353aced92801668b9e5b92d7cd442fc653dd802670db3cc48113d5d780a5f2a03c595e4f42f14942d7d5151dcb1ee26daf89bdbf073e272213328adc94c36daad175e669c1fab7c4611b802c7493aa366688aecaec7212070c51f46d381bf53eb430fdcc2012f0912a00e38e8b6fceba087687e0a127610ee116e6e036c96688b3d4c66ba8a97d54aef89938a2f89780473e982336e55acb32000efceb5f55675437b607aee4a9fdf906aec1c496629b47d4fd0ec522047f1899308ad7018a61fbb8305a0b9539f366f457b7e6b371a0bdcd78c35e1a4200fa2f8bd9ce8da89b2b11cff1c12807c5ba7fe6cce821eb997988d9a3fdbed8a02465998b399ba6df8508fe9ac270e78a793a6b7f18effd3dcb037efe9c3b8d53ed3ea49dcd4eb844d0dcf955af1cda77704185957eb7188ab7e06d2746d21efd56c6bfb0f26764a5337a17e3ac76feb186e9e400eacb664c279ca43c94bef6e9171232578ea0d91be2215cf6c968b490f5ae83828487ee36b26354c76470fdcdc6f618c46716acf1bd3ea89e79e0de804dcd01164179873a1b3da7e3ecc2460bf21ea99a85881782a0c59b7b59fcb808d9d41c32fe592d1695d17bf35a17c5d8d6901aadb987e21b03ec84e6901acd32c0eea21254dd742fac09bcedd2027e411d65e38b190d20c17ca021272d78ab6856edcfc2a8b1eb06ecc9d5ebe075fa00d4d37dfcb41131b710e14943e3702701323ced4695ff4aac44161ef825bbeaa7f9dab8bdc6baf3c48c477acbacf4131f3f6bc85fd00523155cdf9cc757eee25fc6b33b384fdbe8fc5d4f1224b8083dd61da6ef86515441d7fa2990ced9f7b3824fc3f339545e28550f51e50b6615b751f4dd63601bce85c69140f8a73143d72c242c4cf9ac4aef36fec2b880c34b4d0c9aba7cc5ddc2c83bb63b130a1a004138d4df03d39b6e471adcb65cf65443c976ff28c7fb1b241f45edae48e98cc8e6779653e39cdc77fe9b0fe81994e720c1df8f2808e4a1ef922376366033ab1c413a27a7b07dbd45c060cdd76e6a2b3c40a81425afba25c3c1095d51d22f2e2a7af14ec8b6ccb3360bdbfd1f92619e93544ea54a73500c1762744d887d6385bfbee1a3b375cd5b31242b47cedb7232cda83005d72d6365407b9764dc46c53b8ef5935dcb00f33925e9be3c57f6698a94f197e5e6f4cc5db68316a155528c690586bcfd111c5a831a554570856bce8febafdd12065d6d1f226d1e666f7fdbbab972684d4b30ad45babb318b9e6ee67e4563c143ab8d2e61a26499a8397880283c2f6bc270f56dd6c80d95c47bc025528de40945fe29371d0597f65b73539f3180e048c5019c55689c31b48cf26726e40ed8930f00738771806179831bb822fdf334a85c9277cca0bd5cd6563387f1c7f52490f05b0d88328d3f31b1188d1c1d4af5c97258dce69e47f6415769950c164f7d4478f20e21ae25689709de34b27a2ce0a208dbf98e0a949b9dffbd95f49d1f8c76042e4bafbfaba3aed460f1819406a6c782783d107cffb8e0fff29cb0932982d8f4f650881a4e6071095452579687ff8c29b33643f94063e8d6ee5d7898f3d0da696b5f695ec0e95026da868dd43c6777d3f3e173a414612a19aab7da5bac75998a6793b478560a39f4bedd659b19e7b3d9cd1b677ca0bf201329497e4e2f74816cb42fde3e2b948548b15cf61a75a648e7afbd00741a2d88f40d4e949e32a9d185f75f76048fd87babed40d2c0fe7b82434d413cbef630decc86a950290d8c723cba27f25751b1184a7577ef712f3d16940a89343c24eb30adc28bc4ccd0545c1a42dc8997b3191c0aeaa3504e52aae265f4c5b5f9568e5402e5c03ac76f4a19af2dc35cf82bc70fa2d57c1c5ac0683587cfe66b6a523953b5197a1b9960fb387585ed12067ee19bc40df2076d210a3d1760e98c08dcac3e616695c52ad7b05553b9c27e9b1ed89956a52d314b65fa6c5f9167f1e2838bfca9a791f5dbd875cad28d17fc61c3a68195f9effa32ea688118d204ec02c6441e07736023d225b84761ac6bb203df7e5a860cd74aeceea9833c0ebc5b18483af87770516241b9613809dfd8e4836b3a2a5fca01e9b5bf01ac5aa62cd12d00e84cd4d68a5f8573ac7d7e11fbfb9608ecf63f4e17d5b68eea07669702ed3950d3c00cb4d76b9c60e2f38b493f1d32e16bd8b1f309ffc8699f188b1e07709accb74d836f0abbb504ebeda0b9dde8a04ddfd55d34f3ee87facd397a7bdbf461e73e510f340bd7d7f47f8f20b1e6a49720758fc86cff7a3b1ec616b7de27e1bf9914b2a0632d6e7d5f0b403a37c89b4a430f5c3a0949bac94b729a0e9d69076313d4404678af784b8468098a350d30b608c953fdafb3890ab6a03be93befbe99148225a49f91b8ec99f743cb2d481be161946f8cb9139190a52e13473405c886fe252aa22e6f4914421bba7b83f7a79a378778836c8bd84ca4a95cef16e61eb2b3d7e9f470eca4d9f2744c5f201e7f482538f15726e5c112555de757faf0f6e0f40c6e2bbb9f0c91d4beb81264aaa9cd9a2825451eb560bfdb0b0ef6c1c945cfabd4b7beb614027a81c56d4acc0bd82eb0f559fd71e5793643cfc37ce7615a23600f755edf1445ca7b287ffbbb170f4a135b057cb13db961ca5469b07c38cf38dc493878d88c712e7ad7b8b1afdfd34776c7f9f2787c0c5320acca7194ed2016703c4798ed8aa88de2c77f3cb3e2721a77e24e94f95ba118873d3ac220785e776422052922ef574878441137504011e151d7627979791a8fd90f7eed44886eaf2079d3049bbc7300f59b737d5320b1d30f58a5813206ae307d3f0caf055dab6c1eae5951e89f79bfb89d91d019f499217238fdd96843c11348eaec77d4a61c8fd61751db28132aafe38c2f4e67e823e9c8130f95b568504e5f9ad93b1c210a822b0d424c09aad0cfffd15a1152465cbb3dced0d7e410ef52801f5d18d82038514c58d46cfd6879cdc63999bfce5ba93775496d0daa78837d29bd17009085922251c745b29e56d0534409e7d4424e28077b9f4e5d86f0824e73c65d16a5e53d35fa8554d70bcabf9411d9cc4c642b86812bb8b9895cfa4d8bd8d9910ba338cafd124cde2ff6dbedd8969f1ca5f672f335885710d23a27c9983bfca97a618db359733632532efe4fe7feede21e5183207833a49cece3513846cfcdb19e2c259e00308cf64a6ae9dd325a356f380c5e3326befd360402b02b8510ed47c45af32f785afcb7d913894d24fbc19ca49f2fe480396d5a7314cc091aa542ad21b5cbdc35c4d10c9ae7e98bdc07174dc4461be653175146e1f9e71890ec8e96ab35970cd998e02ec2b87fb57a254dc4646f7b7724f90c279f58ff8f6817227a5c88b49a593af6c82ddd41194706f2217dcce22664e377f46386ce63a36dff305486eb2a51e4eea1fdc9f807a1a72a3748a12cd71dddb76aac3436fe8c2e70c2a044802520ef15554af4fc19d275edd616ce7a2f6bb6767298a0ebb2055d92424356951554848da26c42641564a0451bfa76f4b85508637052c4d3b771f4f784439c57f96b58d12f4606d27b07edec44062e491437ebdd0fca1ac29556863b44645f165c78a564018a202f65dba870b2cfb9db3ecd2aee4e95cee6d31d742018a05baa273c7dcced98bf3b11262ca70aa9724f34a35cfa10f844b602c0c8a592f27a75f9c87d6a5297ce77c3205a85e90a4fc4b795d409eaf4419f9a31a02b869ad4ba2d17cccf377608de661cc2c0a13b119f2e9d6660d2e9c37946651aab9a01490c76e43640a3da53091a09c9e685f6b7974c1ab0506e5cfc563730e9f381895dd990b315d636ab5e7c0cb173ce1de079de943b70c43cfc784fe377372860a47e301547fb573e59b61421b72327ea2bc41512de9023d70463cc3b7cef011ce0c78d547fb988a08c88008ff820de36579faa42a8caf23b051ef1c90bd1a536d9e39b7f46cac6bf8246ca3563c26c37b8b95e0fe377d07378e73acce4ab297a120b06b2897efbb1d069b3b5b5a04e480f1dad7cde673ce0876257272f441d159b6d30abfc14bfd352511734c0a5a9645b4e3e55ab85b4779601fd9bfdb289bfdac0b8af83b590072d005a63ec8088911a61b722e79e9a6aa33687e92d3942116abbad0bef7a45f1b0c8d3d8a45bb49c77b0503d04764a634cbdcf7e7ee944def878759607b1f1e152aed4d0fcac8189bf9a53021ba4ea9801454dd007cadb09de42521b528f92060f0dc04a016bc3e1c8a0413ea8efdf43e04f726ca7bfb15675418faee959476e81b0212885f5d7c231c3cd08750fd3d32b216f997924c503843030132d4c241690a55b5d183e3571138bab71201ba7c4541f56699fcede2e98347d9fe1de9aa64a5481569290db6506771c10329a5012da1ca733cc92a57789fd4a29372d4d5e64a2868fb8c4e3d62a9e8bfc20e0b990f1fcbd33765cb83df4f8df4d0ead4f5cc6c7bd42a722ae31907f3d645a0ac520fc9dcf3920265c1bfceffbab5209d5960f9907c7e2ad694ce0c36295efbf658c38174c56f30e1a32ee4b7ccbe446bb94f35aa965fc9147d352058057307b26689efe5424f8fca4d5cd04bb25e8ee3074e0deb94755d0dd32de882fde98afa2f92e3eb0c033da6e4056986a0cdaed443fc143c2997019f68f7db0d80cec792706861618fa98c53126f584dea99b33cb5c6809b88500be19ed1044d3af0cf210db307aaf654958bb182afa0761f45a753119f5857bf912d88cb82ea98910e3418014ee2cff50c0ba23f9a0f057fce7c5ad0cbad1177d3f0d075ecb5386555ba18ce075abaff795a8e15b86f8b2e5b7cbf3d5b50cf94fdec1ef96864c812e248709e643342f2b8da6c646429bc494b5f69dcd35432ccfc286292dcc36c722f32f6c393b1a0712cec7f60482ffb14ee4935e8a7c1a0abe20f0f9c2a7a1555705e13df1a708a4ce66b39e31735c87722dd3f839c66dd3a012ac54eaff24b42f9193af2d7224f0b88307dfe20a2762a2ba87f5d51ccd4742b5e1e3e52faafb7904d718f5f93baa747ff6843978b7499db8216b02ff3847f0e696480a7775382e7bd3825f79582189a690efccdd8228cb318ab717a6a97a06771a1876f84e53cff4e7af4628c937a999ad41af650c16053a791c3e4f4b24429f7d212b429ce513e2666e0de21345c095e0a5fdfed5cb2c4fac2134a014fed172b67c822806609a303e5ff18c9b5e5ebd960b3b2b301c6a9f6ca135bced83e09304dabade77fa81b74dca5f8bd7dda6da6060b03c7c5dbc5e43c4d34f59b7ed066f09bffc39829dcb2545007a0902ea6c66d7974be5e6fa31915bb11f6d13f727f4407981d5e7bda57135b5d8b019c7a6f4bb5f629486295df04dcea03f0ae9dba6066aa39495157616c5dd5326ba0f22cce0764abe6beacfa81e31179db2c3d0333b576afbbf0b8fa3460edad9c753518734e7a14958ff809f02ac4db8cced49bc6ec6b4ec1b8939d4bc4d80637177a9092d5087fd925610d778f27b9173df3f5e1f601171a8c1fa2289bdc0a59a2b5bc99c87bb7fe2ea221fdc57c50dbe050e0193d88c30e73547db5f4f7430c20a34f2fca3cbf77d011eac1f3047c25ce96fe6d63a053ebd78ba994862446471643d1c65d3633067dbfb0117d84c43419cffbf39a9b8035d4e2c57848ec0bf1c713adaf978531e84d1107fffd753f93c9a565bd75ebbbecf1d28f658a19daf391ee607b2f6371bc0280acee4fcedbb4d7ec9a3dbdf24fdbf3feba0024e76fcbb406f16c6e571900cb455c20da4bc946ba835b2e567fd6689fe9cce16b20ed52bc8999f8806a0007536cef35dd800e09b6975275dd069831d41edd82a1de227e267bdfc61274d2567fddb487dc1311815c3a2678fcf462a86ffc1f004d05070d9fae8e9d8d25e0be5ed5ec0256ffd4c8deecda6a94dfae91a4f2b85e37499e1a0128cb7836366398fdf2f1866d11117a983642c03e940f84cbecd46c5df94a26f0e901a068e8ec3134c4ebc7f6d7f2cac9c6d82a3166afcf80d5d327a4c2df3d54159a8db731e9ebe884f527d9275fce79d8d5c0abd4c5cef6007f44f7e12e60209eae91476241c797292225dee4e1695a579ee900d8b694500752e4928e0fa196eed9ceceb3e61c8e1f2836b833fc5fbdf98df6db8f714f17bb400b8c7901f69b55cacc46237effd3eb41327ec177f499c05465579fa1dda52e9c531f8c3eef744084d2551099ba5094151b4329b3a8e29a479266b23e8438d0702a5ad0d6c5bc4d17cff41f0fa8f7f1ff0563615dd72e5c0e1d93b62e0cfef8a5cac9891c506d40991dbfd27b97115d834b9bc8764579dc3ed532d5277dee3cdaa3c2992cb012bd6aeb0b778f261cb5c755f48ffd369396c2634b9a96e2a562c6a9d4bda5a51e8eea87ca3aa70e5475e5b18487bbfac9e0942d359bac0ed4846775885ad411c481daad967d72f9c81b0935461877782c745fc6f288e4145c2b8ceaf79cee8fdb6f8ebfceda87920d94568f18971cc1082864bac16387ab95f1793eba0817d209672eeb958a753294339a62fdc515e3cee4ee211f3b3e873f620968cc54fa2a03c013d72ca57d4e57186515cd287a5fcef90f90d16687582c9379c2a61bf8c61763a86e970dadd60e37ad17798378390b292cb34a14179661c337b83d6e86ba92e264483cfb46685436c5d35d77828218701311614beee909af06296869db67899110c08f8e6883fd14c2d9a2a3a8701ef5ec85c059ebff29137bbd53ad343f191233c86a0ddb6afdd88d116ff152045f958d219e65f1556ebc37c8a7b79c7a6b5b801e476a1fb621fd9cad14ba2c24440447b3d718160dd8c8b97ca5f3e5a3abcf54463650d15b0b1b36a874338b8522b15569914227303638dca99efcbbae0b64456fdc17e893397786320a520ce4adc26429163231fb0656ab45cbf2056163c89ede7adde6a71ee56e2bd6641255de61daeb4351c21e8ebc84a13c959590dede1efabe7f776edac20986423d99661d3ce8ec86070fe0ec5e56445baa20fbd5e161766a5eb74b290c97803c92342491d7da8fab712ba8f167255d937124a025d1ab78ede03c334ff261569bbb0cbdc31d2a58199b12983116cd70c4f8961eaafadc709eabd58b272fed63a8d167fe89bf7023f0bf96ec6f883ad2c2a676883cec1649ac0f03968436d353403e34678ccc1ca384c61e6e653f60aa5edf01d5e59b2835b2f22371611f0834a2eef150efab41d4fbe545615b2bf5039a660be466b369107dbef59c73ebc3c96b3950fa72c8dcc7adcafcf1c14a0fd7ccbbfc5cfeca85d360609a6f90b53bc2dbeba17f96568ed2e5daaa8313b07e7879b552d4e230a3120276489f50e79a18d266cf82433d856be7df31c29a7afbb504061cc053e33a993e9d9e6339b614847b21f07e017abb7dfbb4a6c686d13d13086a2329b586d3d0c51aaabb3e3adcda69e972e537bdbba07a577fcf3d355fb68f3135b5b04a92a2fac49156753beec78bc47846b41c57bc613e761a0c4d96b6a78b4dc76f6fad5ac399b59036f3281e9839904bcd5dc3f7cf5448d50743fec7d14d75a8f5ed345682e56a76b67bedf527e1967217f8483a45f0616a1eedb799619da9f417103ac54be4c7a4e4268ecdd3bd9495ab147ed34aa2d1ebaada351da82b2f99e270d2db6e4460b7458d0a75f28ab8356033e4ed3e73a6ce82d3b4a8b4c79d69562f4093e2a839657061fe086b74a7c5be5d757c45490d12c876351a532147adddba5f15e05ae6e2349678192061af9f2b4229925562aa6e1bbaa1810856541b086246edd0223781c1b13d9e526bc1a87a78c3092796f71a231d8664dd62e0eaec33aa0ce43d4043950e37799559fbe6c6b69c375ba7b3fc746cd4a7dfc35cfabc313fdfcb91d46c2fb2d30d7fefc956468b2872bd9ccdb17713f49c6389d4994bcfac749f557f154671909c6d278390ad39f6d02b12e9da0a75fd536ca3820808d36f6080c4013ce75470992cd56480549cb1ec290f1ae707a09a8af69213418a8eba96ce695b78e45cd85c733e6d74e967c91059b0dc0efab3ea74d8578656f4de65f92a8d0e371e4ed0f265743849a1d4bda07bbf93b1cf24f5d240f840742b98c0ed35a9521de7471e3f4abd32510aaf98233ac9f5f91d560115e6fe718df6c48a35705a07875d6a49b8fdc3e3054e6165ab1a440cc85fb9e68f804de3ac40505c7030b6905803b9436696eaee0947580be5a92ddcdb21f0ec15f972a26ffe044f0735f7dfc3da06f02c1f8e798f3a0c378bc2ceb436e6eb32c1bdc3954ff537580a2d33abca5a8dd31258e320b82312822c778e81b4663516df51b764f4d26a8d5416b4c2414b6ff8cc8470c069714762d2b6207dba8b946eefde09a5901d8450ec95b74537d2383f3c844b00011d5f32474a537aab00c50e1972934e290b8038f982a2836463669f738b63aa577b4f688494cc037131f2f814da493932bd755f80959c778401cb6b24590888f18ca0d309cfb602902a5a0a6bd677a8de85e050d112fbeca4ce82bb22395415bec853f438e534e8562cc565087f17dce373410bce6197f4ce80d6be78e376576f8a1b42a81d64e5247f49ee9c38a72900e4a10add9e8b84b366d92092a7105ec0ccce19029d179aa6dff87b72045cac7cca90e9eb9039e3b9d814abd03350f0ac9baff16c5e4962c0d483a13bd46a502ff4a581243a15f1924905015378d139560e7fd9c9223d857c7c0f479a575818a86a1216fd3d3f134fb9ee34a11f687b7409473fa7b23e14299799144fa952bd6d684be78b969c66e9a960285a52cc8afac530a7de82c6bba419ad9b7b15372b0b277c06db5d50bb6ebfc73062870a99d616c3a3e1bb9f6800a7f7ff6a64987415a080636fbee13abb8ae812d36a3137e05e634f2e349886a725ea42075a342e8992468409128d1de4dc14f1d34a21dc3de55aa6f8673310dd3914b0baa788df18e3ef07a33668bac10f7e948e71ec63abc6cdba2173b8084d6eb3c2ff1c37ce5537d25e28e0a3f4692357375922f1d351031ff1ab1117b00bf8de2cb3aee75dcd283a6c9b0f4823d50e36dea9fa5f32a9d558cb0f7f98076612bbeddaa16cd1c048b01d34022fc30ec8ba662437525f6cb946131bbee153f59aed315b0c70f6aa79c1719dcece7d879fb157cc624f95304a3680552b3ae005f3f9787ab24079491b9c93e860e75bbfa5ee8b00f12db06d2fb85cf82b191c3a1126e6cc749fa24daa6259c289af5b9a704ea8394c8bb9687804fd89d425300e4988c69822112bfd68afcf84d1980ca325932d4926267077004ffbac71ebd03d565928dfdd2e1964d64e682dc41715e8191a10531545b473ae3e1522cdfccc0bb96c217eedddc4bdb80e93c7e75045f126b6767c14212fa4df5a25f0876c325cbdf361386dc144af5948fb2ab4c552ecbe8e5a2ddc699f1bec0de467bf7cc2e152af7b115564258aec01d3951b36a199402eb55361808f9db8295ac20f918923a9dc2da305844711904742ff4a8bd8a18352416f8628ab9d53c6c5163b66f272e9833342bc97073ccd0a23b8ce65b6b08e54f7929da2ee57695524407871075f9dda2d9ad76a0af3c326fa9b49a4e3dd3a6b41a30a71cefe5897918f000174faa214f5625752e816cb59b815a97d0b4f62afbe0567e6a92475cf76c1865d0f94ee7397abc0473a9c3fad48c8b9eaf15f6d6418cd3a11fb94e6e6c67ab8e5ca9b1ac675288729f1773e1a76f1fa4258b02798307ccf6d0ffe0dad6c813113b4712419a5ca5135526c73e5645a800a2fc5f93e49733160f3009760d02a51c0b4e15899359265c1b52d13d9d72d40906a5d642fdd2b6db42572f006fbd0f3f0a3f81135cf1b15b9552c8d176f8ce512bb2ccba7418dc428aaa4a14607ba86016e97b00719381df5ac2eea059cb1c2bf589dee2156e3ea1c26f4583d3c704728d86045bb3b7d8ca4e99a2028a1ef48809d0f0e995c923230112ffc45deb25d34bd5eb1291fefc640b62c0bb0675f9a02386040debed0291ac98457999e8e1611e7069f74365affa8ab3727bff27b7453b202838130576c11212ed05144f06e49c46bd07b522d63a8a3cf74fb6dbd072527d05e940233433558f0c6429d0729e1a36e8d36429adc5276ff6d3ff987b87eac4a53d0faed4b511614d853d34c1fd2b6e91c06870ad8bf2d25b589ce7b452fc2bbc9a876f2d653ea5643bf5f7393b63312b7d9611c513b3e0b0c89ec71280d6fa6fff2a55628f1cd93cb5c47f5308b7c3bc210092b6acea91398fbc1c46a529210fcba2ffd8ea7720f52338f5117591bbf766f25b936fbd1f2424f1189ab8ac8db86eb07d394c376fcec2ce0d9bd9084bd4ae9c02ebe04bb123d792d9b74854a5cc1d278fa4d619410752014a9aae14fd82bc7997912c2e713b849590b78c9b49749c803f45e6adff19c96aa4f6c91b7db6fc6e1c5d50f25b49124873</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsè¿ç»´ç¯‡</title>
    <url>/2019/10/22/jenkins%E8%BF%90%E7%BB%B4%E7%AF%87/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="jenkins-å¯è§†åŒ–æ„å»º"><a href="#jenkins-å¯è§†åŒ–æ„å»º" class="headerlink" title="jenkins å¯è§†åŒ–æ„å»º"></a>jenkins å¯è§†åŒ–æ„å»º</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ä¹‹å‰é‡åˆ°è¿‡å¼€å‘æäº¤ä»£ç åï¼Œå®Œå…¨ä¸ç®¡æäº¤çš„ä»£ç æ˜¯å¦å‘å¸ƒæˆåŠŸï¼ŒåŠæ—¶åæ¥åŠ å…¥äº†ä¼ä¸šå¾®ä¿¡çš„å‘Šè­¦æœºåˆ¶ï¼Œä½†æ˜¯ä¾ç„¶æœ‰äººä¸ä¼šå»å…³æ³¨è¿™ä¸ªã€‚<a id="more"></a> åªæœ‰åœ¨æµ‹è¯•äººå‘˜åœ¨åé¦ˆxxxä½ çš„ä»£ç æäº¤äº†æ²¡æœ‰ï¼Œè¿™æ—¶å€™ç ”å‘äººå‘˜æ‰å›å»çœ‹ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªè§¦å‘æ„å»ºå¤±è´¥äº†ï¼Œæ‘†åœ¨é‚£é‡Œå¾ˆä¹…ï¼Œå¦‚æœ‰ä¸‹ä¸€ä¸ªå¼€å‘äººå‘˜è¦å¯¹è¿™ä¸ªå·¥ç¨‹ä¿®æ”¹æäº¤çš„æ—¶å€™å‘ç°è¿‡ä¸äº†ï¼Œè¿™æ—¶å€™å†æ¥è§£å†³ï¼Œæˆæœ¬å°±æœ‰ç‚¹å¤§ã€‚è¿™é‡Œå¯ä»¥å€ŸåŠ©çœ‹æ¿çš„å½¢å¼è®©ç ”å‘äººå‘˜å¯ä»¥éšæ—¶å…³æ³¨åˆ°è‡ªå·±çš„æäº¤çš„å·¥ç¨‹ï¼Œç»“åˆå‘Šè­¦æ¥åšï¼Œæ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚</p><h4 id="æ’ä»¶å®‰è£…"><a href="#æ’ä»¶å®‰è£…" class="headerlink" title="æ’ä»¶å®‰è£…"></a>æ’ä»¶å®‰è£…</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®‰è£…Build Monitor View æ’ä»¶ï¼Œç„¶ååœ¨ä¸»é¡µé¢æ·»åŠ <code>+</code>ä¸€ä¸ªè§†å›¾<br><img src="https://img.xxlaila.cn/1571707794737.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥æ ¹æ®jobçš„ç±»å‹æˆ–è€…æ ¹æ®è‡ªå·±çš„æ¡ä»¶è¿›è¡Œ<a href="https://xxlaila.github.io/2019/08/09/jenkins-job%E7%AE%A1%E7%90%86/" target="_blank" rel="noopener">è¿‡æ»¤job</a>æ¥ç”Ÿæˆçœ‹æ¿ã€‚</p><ul><li>Build Monitor - View Settings: æ ¹æ®jobçš„ä¸€äº›çŠ¶æ€æ¥è¿›è¡Œæ’åº<br><img src="https://img.xxlaila.cn/1571708048469.jpg" alt="img"></li></ul><h3 id="jenkins-ç›‘æ§"><a href="#jenkins-ç›‘æ§" class="headerlink" title="jenkins ç›‘æ§"></a>jenkins ç›‘æ§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰æ—¶å€™æˆ‘ä»¬æ²¡æœ‰ç›‘æ§ï¼Œä½†æ˜¯æœ‰æ—¶å€™éœ€è¦çœ‹çœ‹jenkinsçš„ä¸€äº›ç›‘æ§ä¿¡æ¯ï¼Œå¦‚ï¼šå†…å­˜ã€cpuã€ç³»ç»Ÿè´Ÿå€ºã€httpå“åº”æ—¶é—´ã€ç³»ç»Ÿè¿›ç¨‹æ•°ã€çº¿ç¨‹æ•°ç­‰ï¼Œæœ‰æ‡’å¾—å®‰è£…ç›‘æ§ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å€ŸåŠ©jenkinsè‡ªå¸¦çš„ä¸€ä¸ªæ’ä»¶<code>Monitoring</code>ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ’ä»¶å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç³»ç»Ÿç®¡ç†èœå•ä¸‹é¢çœ‹åˆ°<code>Monitoring of Jenkins master</code><br><img src="https://img.xxlaila.cn/1571708499625.jpg" alt="img"></p><p>ç‚¹å‡»è¿›å…¥ä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571708561404.jpg" alt="img"><br>é¡µé¢æ˜¾ç¤ºä¹±ç ï¼Œè¿™ä¸ªå¯ä»¥è‡ªå·±googleè§£å†³</p><h3 id="Build-Trigger-Badge"><a href="#Build-Trigger-Badge" class="headerlink" title="Build Trigger Badge"></a>Build Trigger Badge</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤æ’ä»¶ç›´æ¥åœ¨æ„å»ºå†å²è®°å½•ä¸­æ˜¾ç¤ºä»£è¡¨æ„å»ºåŸå› çš„å›¾æ ‡ã€‚å®ƒå¯ä»¥è®©æ‚¨å¿«é€ŸçŸ¥é“æ˜¯å“ªä¸ªåŸå› è§¦å‘äº†æ„å»ºã€‚å¦‚æœæ²¡æœ‰æ­¤æ’ä»¶ï¼Œæ‚¨æœ‰æ—¶å¯èƒ½ä¼šæƒ³çŸ¥é“æ˜¯ä»€ä¹ˆè§¦å‘äº†æ„å»ºå†å²ä¸­æ˜¾ç¤ºçš„&gt;&gt;ç‰¹å®šæ„å»ºã€‚è¦çŸ¥é“è¿™ä¸€ç‚¹ï¼Œæ‚¨å¿…é¡»å•ç‹¬æ‰“å¼€æ¯ä¸ªé“¾æ¥ï¼Œè¿™å¯èƒ½å¾ˆéº»çƒ¦ã€‚<br><img src="https://img.xxlaila.cn/1572059619062.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineè¯­æ³•</title>
    <url>/2019/10/21/pipeline%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ€è¿‘åœ¨æµ‹è¯•k8sä¸Šçš„ci/cdï¼Œä¹‹å‰çš„ci/cdå…¶å®ä¹Ÿèƒ½æ»¡è¶³ç›®å‰å…ˆä¸šåŠ¡çš„éœ€æ±‚ï¼Œä½†æ˜¯æƒ³å°è¯•æ”¹è¿›ä¸€ä¸‹ï¼Œä¼˜åŒ–ä»¥å‰çš„jobï¼Œå¸Œæœ›åœ¨ç™»å½•ciçš„æ—¶å€™æ›´åŠ çš„ç®€æ´ï¼Œ<a id="more"></a> è€Œä¸”æŸ¥æ‰¾jobçš„æ—¶å€™ï¼Œç‚¹å‡»ä¸€ä¸ªjobå°±èƒ½æŸ¥çœ‹å®Œæ•´çš„ä¿¡æ¯ï¼Œä¸éœ€è¦jobä¹‹é—´çš„æ¥å›åˆ‡æ¢ï¼Œç­‰ç­‰å„ç§ç†ç”±ï¼ŒğŸ˜ğŸ˜ã€‚è¿™é‡Œä½¿ç”¨jenkins pipelineï¼Œèµ·åˆæµ‹è¯•çš„æ—¶å€™ä½¿ç”¨pipelineï¼Œæ²¡é—®é¢˜ä»¥åï¼Œä½¿ç”¨jenkinsfileã€‚</p><h3 id="pipeline-å¸¸ç”¨ä»‹ç»"><a href="#pipeline-å¸¸ç”¨ä»‹ç»" class="headerlink" title="pipeline å¸¸ç”¨ä»‹ç»"></a>pipeline å¸¸ç”¨ä»‹ç»</h3><h4 id="æ¸…ç†å†å²build"><a href="#æ¸…ç†å†å²build" class="headerlink" title="æ¸…ç†å†å²build"></a>æ¸…ç†å†å²build</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ™®é€šjobçš„æ—¶å€™æ¸…ç†å’Œä¿ç•™å†å²jobçš„build å¾ˆç®€å•ï¼Œå‹¾å‹¾å°±å¯ä»¥å•¦ï¼Œä½†æ˜¯pipelineå°±çš„ä½¿ç”¨ä¸€ä¸‹æ–¹å¼ï¼Œè€Œä¸”è¿˜çš„å†™åœ¨æœ€å‰é¢ï¼Œä¸ç„¶è¯†åˆ«ä¸äº†ï¼Œä¼šæŠ¥é”™çš„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        buildDiscarder(logRotar(numToKeepStr: <span class="string">'8'</span>))</span><br><span class="line">        disableConcurrentBuilds()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>buildDiscarder: ä¿æŒæ„å»ºçš„æœ€å¤§ä¸ªæ•°</li><li>disableConcurrentBuilds: ç¦æ­¢å¹¶å‘æ„å»º</li></ul><p>è¯¦ç»†å‚æ•°:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">buildDiscarder(logRotator(numToKeepStr: <span class="string">'8'</span>, artifactNumToKeepStr: <span class="string">'8'</span>, daysToKeepStr: <span class="string">'8'</span>, artifactDaysToKeepStr: <span class="string">'7'</span>))</span><br></pre></td></tr></table></figure><ul><li>artifactDaysToKeepStr: å‘å¸ƒåŒ…ä¿ç•™å¤©æ•°</li><li>artifactNumToKeepStr: å‘å¸ƒåŒ…æœ€å¤§ä¿ç•™#ä¸ªæ„å»º</li><li>daysToKeepStr: ä¿æŒæ„å»ºçš„å¤©æ•°</li><li>numToKeepStr: ä¿æŒæ„å»ºçš„æœ€å¤§ä¸ªæ•°</li></ul><h4 id="gitlabäº‹ä»¶è§¦å‘"><a href="#gitlabäº‹ä»¶è§¦å‘" class="headerlink" title="gitlabäº‹ä»¶è§¦å‘"></a>gitlabäº‹ä»¶è§¦å‘</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰çš„æˆ‘ä»¬çš„ci/cdéƒ½æ˜¯å¼€å‘æäº¤åˆ°æŸä¸€ä¸ªåˆ†æ”¯ï¼Œç„¶åjenkinsä¼šè‡ªåŠ¨è§¦å‘ç¼–è¯‘ã€å‘å¸ƒï¼Œè€Œä¸”é…ç½®è¿™ä¸ªæ­¥éª¤ä¹Ÿéœ€è¦å¥½å‡ æ­¥æ‰èƒ½å®ç°ï¼Œä½†åœ¨pipelineä¸­ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç å½¢å¼æœ€è¿™ç§è§¦å‘å™¨(å‹¾å­)è¿›è¡Œé…ç½®ã€‚è¿™æ ·è®©æ¯ä¸ªé¡¹ç›®éƒ½å’Œjenkinsè¿›è¡Œè€¦åˆï¼›è¿ç»´äººå‘˜åªéœ€è¦ä¸“æ³¨çš„ç»´æŠ¤Jenkinsfileï¼Œåˆ›å»ºå¯¹åº”çš„é¡¹ç›®å³å¯ã€‚gitlabè§¦å‘jenkinsçš„æ„å»ºéœ€è¦ä¾èµ–Gitlabæ’ä»¶ã€‚è¿™é‡Œéœ€è¦è‡ªè¡Œå®‰è£…</p><ul><li><p>æ¥å—å›ºå®šçš„åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">        gitlab(triggersOnPush: <span class="literal">true</span>,</span><br><span class="line">              triggersOnMergeRequest: <span class="literal">true</span>,</span><br><span class="line">              branchFilterType: <span class="string">"NameBasedFilter"</span>,</span><br><span class="line">              includeBranchesSpec: <span class="string">"dev,test,master"</span>,</span><br><span class="line">              secretToken: <span class="string">"<span class="variable">$&#123;env.git_token&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>triggerOnPush: å½“Gitlabè§¦å‘pushäº‹ä»¶æ—¶ï¼Œæ˜¯å¦æ‰§è¡Œæ„å»º</p></li><li><p>triggerOnMergeRequest: å½“Gitlabè§¦å‘mergeRequestäº‹ä»¶æ—¶ï¼Œæ˜¯å¦æ‰§è¡Œæ„å»º</p></li><li><p>branchFilterType: åªæœ‰ç¬¦åˆæ¡ä»¶çš„åˆ†æ”¯æ‰ä¼šè§¦å‘æ„å»ºï¼Œå¿…é€‰ï¼Œå¦åˆ™æ— æ³•å®ç°è§¦å‘ã€‚</p><ul><li>All: æ‰€æœ‰åˆ†æ”¯</li><li>NameBasedFilter: åŸºäºåˆ†æ”¯åè¿›è¡Œè¿‡æ»¤ï¼Œå¤šä¸ªåˆ†æ”¯åä½¿ç”¨é€—å·åˆ†éš”<ul><li>includeBranchesSpec: åŸºäºbranchFilterTypeå€¼ï¼Œè¾“å…¥æœŸæœ›åŒ…æ‹¬çš„åˆ†æ”¯çš„è§„åˆ™</li><li>excludeBranchesSpec: åŸºäºbranchFilterTypeå€¼ï¼Œè¾“å…¥æœŸæœ›æ’é™¤çš„åˆ†æ”¯çš„è§„åˆ™</li></ul></li><li>RegexBasedFilter: åŸºäºæ­£åˆ™è¡¨è¾¾å¼å¯¹åˆ†æ”¯åè¿›è¡Œè¿‡æ»¤<ul><li>sourceBranchRegex: å®šä¹‰æœŸæœ›çš„é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼é™åˆ¶çš„åˆ†æ”¯è§„åˆ™</li></ul></li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰€ä»¥åˆ†æ”¯ä¸é˜è¿°ï¼Œå…¶ä»–çš„ä¸¤ä¸ªé€‰é¡¹æ˜¯æœ€å®ç”¨çš„ï¼Œæˆ‘ä»¬åœ¨æ­£å¼ä½¿ç”¨çš„æ—¶å€™ä¸€å®šä¼šç”¨åˆ°è¿™ä¸ªï¼Œä¸Šé¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªæ¥å—å›ºå®šçš„å‡ ä¸ªåˆ†æ”¯</p><ul><li>åŒ¹é…çš„æ–¹å¼<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">        gitlab(triggersOnPush: <span class="literal">true</span>,</span><br><span class="line">              triggersOnMergeRequest: <span class="literal">true</span>,</span><br><span class="line">              branchFilterType: <span class="string">"RegexBasedFilter"</span>,</span><br><span class="line">              sourceBranchRegex: <span class="string">"dev.*"</span>,</span><br><span class="line">              secretToken: <span class="string">"<span class="variable">$&#123;env.git_token&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œçš„git_tokenéœ€è¦åœ¨jenkinsçš„å…¨å±€å˜é‡é‡Œé¢æ·»åŠ ä¸€ä¸ª<code>Environment variables</code>å¯¹åº”çš„ä¸€ä¸ªé”®å€¼å³å¯ã€‚</p><p><strong>æ³¨</strong>: æ‰€æœ‰çš„è§¦å‘å™¨éƒ½éœ€è¦å…ˆæ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ï¼Œè®©jenkinså®¶åœ¨å…¶ä¸­çš„é…ç½®ï¼Œå¯¹åº”çš„æŒ‡ä»¤æ‰ä¼šç”Ÿæ•ˆã€‚</p><ul><li><p>jenkins éªŒè¯<br><img src="https://img.xxlaila.cn/1571644117201.jpg" alt="img"></p></li><li><p>gitlabéªŒè¯<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éœ€è¦å°†é¡¹ç›®å›è°ƒåœ°å€å†™å…¥åˆ°Gitlabé’©å­å½“ä¸­æ‰å¯ä»¥ã€‚ç»è¿‡æµ‹è¯•ä¸€ä¸ªpipelineçš„jobå¯ä»¥ç®¡ç†å¤šä¸ªåˆ†æ”¯çš„è§¦å‘ï¼Œé¿å…ä¹‹å‰çš„æ¯ä¸€ä¸ªåˆ†æ”¯çš„jobè¿›è¡Œè§¦å‘ã€‚</p></li></ul><h4 id="parameters-æ¨¡å—"><a href="#parameters-æ¨¡å—" class="headerlink" title="parameters æ¨¡å—"></a>parameters æ¨¡å—</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥æ¨¡å—éœ€è¦å®‰è£…ï¼ŒparametersæŒ‡ä»¤æä¾›ç”¨æˆ·åœ¨è§¦å‘Pipelineæ—¶åº”æä¾›çš„å‚æ•°åˆ—è¡¨ã€‚è¿™äº›ç”¨æˆ·æŒ‡å®šçš„å‚æ•°çš„å€¼é€šè¿‡è¯¥paramså¯¹è±¡å¯ç”¨äºPipelineæ­¥éª¤ã€‚ç ”å‘ç»å¸¸ä¼šæœ‰æ‰“å‡ºä¸€ä¸ªç‰¹æ€§åˆ†æ”¯ï¼Œè¿™ä¸ªåˆ†æ”¯ç”¨äºhotfixï¼Œè¿™ä¸ªæ—¶å€™å°±è¦ç»™ç ”å‘æäº¤ä¸€ä¸ªå¯ä»¥é€‰æ‹©çš„åˆ†æ”¯ï¼Œç„¶ä»–ä»¬å»éƒ¨ç½²åˆ°å¯¹åº”çš„ç¯å¢ƒã€‚</p><ul><li><p>å­—ç¬¦ä¸²å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥åœ¨Jenkins UIä¸Šè¾“å…¥å­—ç¬¦ä¸²ï¼Œå¸¸è§ä½¿ç”¨è¿™ä¸ªå‚æ•°çš„åœºæ™¯æœ‰ï¼Œç”¨æˆ·åï¼Œæ”¶ä»¶äººé‚®ç®±ï¼Œæ–‡ä»¶ç½‘ç»œè·¯å¾„ï¼Œä¸»æœºåç§°çš„æˆ–è€…urlç­‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    string(name: <span class="string">'DEPLOY_ENV'</span>, defaultValue: <span class="string">'staging'</span>, description: <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¸ƒå°”å€¼å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå¸ƒå°”ç±»å‹å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥åœ¨Jenkins UIä¸Šé€‰æ‹©æ˜¯è¿˜æ˜¯å¦ï¼Œé€‰æ‹©æ˜¯è¡¨ç¤ºä»£ç ä¼šæ‰§è¡Œè¿™éƒ¨åˆ†ï¼Œå¦‚æœé€‰æ‹©å¦ï¼Œä¼šè·³è¿‡è¿™éƒ¨åˆ†ã€‚ä¸€èˆ¬éœ€è¦ä½¿ç”¨å¸ƒå°”å€¼çš„åœºæ™¯æœ‰ï¼Œæ‰§è¡Œä¸€äº›ç‰¹å®šé›†æˆçš„è„šæœ¬æˆ–åˆ™å·¥ä½œï¼Œæˆ–è€…äº‹åæ¸…é™¤ç¯å¢ƒï¼Œä¾‹å¦‚æ¸…æ¥šJenkinsçš„workspaceè¿™æ ·çš„åŠ¨ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    booleanParam(name: <span class="string">'DEBUG_BUILD'</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€‰æ‹©å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€‰æ‹©ï¼ˆchoiceï¼‰çš„å‚æ•°å°±æ˜¯æ”¯æŒç”¨æˆ·ä»å¤šä¸ªé€‰æ‹©é¡¹ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªå€¼ç”¨æ¥è¡¨ç¤ºè¿™ä¸ªå˜é‡çš„å€¼ã€‚å·¥ä½œä¸­å¸¸ç”¨çš„åœºæ™¯ï¼Œæœ‰é€‰æ‹©æœåŠ¡å™¨ç±»å‹ï¼Œé€‰æ‹©ç‰ˆæœ¬å·ç­‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    choice(name: <span class="string">'ENV_TYPE'</span>, choices: [<span class="string">'dev'</span>, <span class="string">'test'</span>, <span class="string">'product'</span>], description: <span class="string">'dev env test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“ç„¶parametersæ¨¡å—æˆ‘ä»¬ç”¨çš„æœ€å¤šçš„æ˜¯åœ¨æ‰‹åŠ¨çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»è¿›è¡Œæ„å»ºéƒ¨ç½²ï¼Œè‡³äºå…¶ä»–çš„ç›®å‰æˆ‘æš‚æ—¶æœªç”¨åˆ°</p><ul><li>é€‰æ‹©åˆ†æ”¯éƒ¨ç½²<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;label <span class="string">'agent-node'</span>&#125;</span><br><span class="line">    parameters &#123;</span><br><span class="line">        gitParameter branchFilter: <span class="string">'origin/(.*)'</span>, defaultValue: <span class="string">'dev'</span>, name: <span class="string">'BRANCH'</span>, <span class="built_in">type</span>: <span class="string">'PT_BRANCH'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'gitlib code'</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                git branch:<span class="string">"<span class="variable">$&#123;params.BRANCH&#125;</span>"</span>, credentialsId:<span class="string">'gitlabUser'</span>, url: <span class="string">"http://gitlab.xxlaila.cn/xxx/kxl-eureka.git"</span></span><br><span class="line">                script &#123;</span><br><span class="line">                    build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>parameters<a href="https://wiki.jenkins.io/display/JENKINS/Git+Parameter+Plugin" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a>ï¼Œä»‹ç»å¾—æŒºè¯¦ç»†çš„ï¼Œ<a href="https://mohamicorp.atlassian.net/wiki/spaces/DOC/pages/136740885/Triggering+Jenkins+Based+on+New+Tags" target="_blank" rel="noopener">è¾…åŠ©å‚è€ƒ</a><br><img src="https://img.xxlaila.cn/1571651950634.jpg" alt="img"></p><ul><li>è¿˜å¯ä»¥å†™æˆ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    gitParameter(</span><br><span class="line">        branch: <span class="string">''</span>,</span><br><span class="line">        branchFilter: <span class="string">'origin/(.*)'</span>,</span><br><span class="line">        defaultValue: <span class="string">'dev'</span>,</span><br><span class="line">        description: <span class="string">'test code'</span>,</span><br><span class="line">        name: <span class="string">'BRANCH'</span>,</span><br><span class="line">        quickFilterEnabled: <span class="literal">false</span>,</span><br><span class="line">        selectedValue: <span class="string">'NONE'</span>,</span><br><span class="line">        sortMode: <span class="string">'NONE'</span>,</span><br><span class="line">        tagFilter: <span class="string">'*'</span>,</span><br><span class="line">        <span class="built_in">type</span>: <span class="string">'PT_BRANCH'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå½“è¿™é‡Œè®¾ç½®äº†å¯ä»¥é€‰æ‹©åˆ†æ”¯çš„æ—¶å€™ï¼Œç„¶ååœ¨ä¹‹å‰çš„è‡ªåŠ¨è§¦å‘å°±ä¼šæœ‰é—®é¢˜ï¼Œå°±æ˜¯åœ¨å»åˆ†æ”¯æ‹‰å»ä»£ç çš„æ—¶å€™å°±ä¸€åªæ˜¯devåˆ†æ”¯ï¼Œè€Œä¸æ˜¯å…¶ä»–çš„åˆ†æ”¯ï¼Œè¿™é‡Œä»ç„¶åœ¨æ¢ç´¢çš„æµ‹è¯•ä¸­ã€‚<br>ç¼–è¾‘jobå¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571903055002.jpg" alt="img"></p><h3 id="å¤šåˆ†æ”¯pipeline"><a href="#å¤šåˆ†æ”¯pipeline" class="headerlink" title="å¤šåˆ†æ”¯pipeline"></a>å¤šåˆ†æ”¯pipeline</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æŒ‰ç…§ä¸Šé¢çš„åˆè¦æ”¯æŒç”¨æˆ·å¯ä»¥é€‰æ‹©åˆ†æ”¯ï¼Œåˆè¦é€‚åˆè‡ªåŠ¨è§¦å‘åŠŸèƒ½ã€‚ç”¨å•åˆ†æ”¯pipelineæ¥ç®¡ç†é¡¹ç›®ï¼Œåˆè¦å›åˆ°æˆ‘ä»¬æœ€åˆçš„æ¨¡å¼ï¼Œè€Œåœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åˆ°å¤šåˆ†æ”¯åŒæ—¶è¿›è¡Œå¼€å‘ã€‚è¿™æ ·å°±æ»¡è¶³äº†æˆ‘ä»¬çš„å®é™…éœ€æ±‚ã€‚å¤šåˆ†æ”¯ä»»åŠ¡è¿™é‡Œä¸åšè¿‡å¤šçš„è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œé˜è¿°ä¸¤ä¸ªåŠŸèƒ½ç‚¹ï¼›åˆ†åˆ«æ˜¯åˆ†æ”¯çš„æ‰«æç­–ç•¥å’Œå­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)ã€‚</p><h4 id="åˆ†æ”¯çš„æ‰«æç­–ç•¥"><a href="#åˆ†æ”¯çš„æ‰«æç­–ç•¥" class="headerlink" title="åˆ†æ”¯çš„æ‰«æç­–ç•¥"></a>åˆ†æ”¯çš„æ‰«æç­–ç•¥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ†æ”¯æ‰«ææ˜¯jenkinsæ ¹æ®ä¸€å®šçš„ç­–ç•¥å»ä»£ç ä»“åº“æ‰«æåˆ†æ”¯ï¼Œå¦‚æœæœ‰æ–°åˆ†æ”¯å°±åˆ›å»ºä¸€ä¸ªä»¥æ–°åˆ†æ”¯å‘½åçš„ä»»åŠ¡ï¼Œå¦‚æœå‘ç°åˆ†æ”¯è¢«åˆ é™¤ï¼Œå°±åˆ é™¤å¯¹åº”çš„jenkinsä»»åŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨â€æ‰«æå¤šåˆ†æ”¯æµæ°´çº¿è§¦å‘å™¨(Scan Multibranch Pipeline Triggers)â€ä¸‹æœ‰ä¸€ä¸ª: Periodically if not otherwise runï¼ˆæ²¡æœ‰æ‰‹åŠ¨è§¦å‘ï¼Œå°±å®šæœŸæ‰«æåˆ†æ”¯ï¼‰ã€‚é€‰æ‹©æ­¤é¡¹ï¼Œè®¾ç½®ä¸€ä¸ªæ‰«æé—´éš”æ—¶é•¿ã€‚å¯ä»¥æ ¹æ®é¡¹ç›®åˆ†æ”¯çš„é¢‘ç¹ç¨‹åº¦è®¾ç½®å‘¨æœŸçš„é•¿çŸ­ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡é¡µé¢æ‰‹åŠ¨è§¦å‘jenkinsè¿›è¡Œæ‰«æã€‚<br><img src="https://img.xxlaila.cn/1571973819297.jpg" alt="img"></p><h4 id="å­¤å„¿é¡¹ç­–ç•¥-Orphaned-Item"><a href="#å­¤å„¿é¡¹ç­–ç•¥-Orphaned-Item" class="headerlink" title="å­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)"></a>å­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥åŠŸèƒ½æ˜¯åœ¨ä»£ç ä»“åº“ä¸­åˆ é™¤äº†releaseåˆ†æ”¯ï¼Œé‚£ä¹ˆåœ¨å¤šä»»åŠ¡é¡µé¢ä¸Šï¼Œè¯¥åˆ†æ”¯åœ¨jenkinsä¸Šçš„ä»»åŠ¡ä¹Ÿåº”è¯¥å¯¹åº”åˆ é™¤ã€‚ä»€ä¹ˆæ—¶å€™åˆ é™¤ï¼Œå–å†³äºä¸‹æ¬¡åˆ†æ”¯æ‰«ææ—¶é—´ã€‚å¦‚æœä»£ç ä»“åº“ä¸­çš„åˆ†æ”¯è¢«åˆ é™¤ï¼Œè€Œjenkinsä¸Šå“åº”çš„ä»»åŠ¡æ²¡æœ‰è¢«åˆ é™¤ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°±æ˜¯æ‰€è¯´çš„å­¤å„¿ä»»åŠ¡ã€‚å¯¹äºåˆ†æ”¯ä»»åŠ¡çš„å†å²è®°å½•ï¼Œä¿å­˜å¤šé•¿æ—¶é—´è®¾ç½®</p><ul><li><p>ç•Œé¢é…ç½®<br><img src="https://img.xxlaila.cn/1571974190710.jpg" alt="img"></p></li><li><p>pipeline å†™æ³•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">orphanedItemStrategy &#123;</span><br><span class="line">    discardolditems &#123;</span><br><span class="line">        daysTokeep(10)</span><br><span class="line">        numToKeep(5)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>æ³¨</strong>: è¿™é‡Œå­¤å„¿ç­–ç•¥pipeline éœ€è¦å¦å¤–ä¸€ç§æ–¹å¼æ¥æ”¯æŒï¼Œ<a href="https://gitee.com/jenkins-zh/gitlab-branch-source-plugin" target="_blank" rel="noopener">Setting up GitLab Server Configuration on Jenkins</a>ï¼Œè¿™é‡Œæ²¡æœ‰ç”¨åˆ°è¿™ä¸ªï¼Œä¸åšè¿‡å¤šçš„é˜è¿°ã€‚<a href="https://github.com/jenkinsci/job-dsl-plugin/wiki/Migration" target="_blank" rel="noopener">githubå‚è€ƒ</a></p><h3 id="å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘"><a href="#å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘" class="headerlink" title="å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘"></a>å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ†æ”¯çš„è§¦å¥½å¤„æ˜¯å¤šå¤šçš„ï¼Œè‡ªç„¶åœ¨å¤šåˆ†æ”¯é¢å‰è‡ªåŠ¨è§¦å‘è‚¯å®šä¹Ÿå°‘ä¸äº†ã€‚å¤šåˆ†æ”¯çš„è§¦å‘æœ‰ä¸¤ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯å‰é¢æåˆ°çš„Gitlab triggerå’ŒGeneric Webhook Triggerã€‚ä¸‹é¢åˆ†åˆ«å¯¹ä¸¤ç§æ¨¡å¼è¿›è¡Œé˜è¿°å’Œå®é™…çš„æµ‹è¯•</p><h4 id="Generic-Webhook-Trigger"><a href="#Generic-Webhook-Trigger" class="headerlink" title="Generic Webhook Trigger"></a>Generic Webhook Trigger</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Generic Webhook Trigger æ’ä»¶éœ€è¦æå‰å®‰è£…ï¼ŒGenericTriggerè§¦å‘æ¡ä»¶æ˜¯ç”±GWTæ’ä»¶æä¾›ï¼ŒGenericTriggerè§¦å‘çš„æ¡ä»¶åˆ†ä¸º5ä¸ªéƒ¨åˆ†ã€‚<a href="https://wiki.jenkins.io/display/JENKINS/Generic+Webhook+Trigger+Plugin" target="_blank" rel="noopener">GenericTriggerå®˜æ–¹å‚è€ƒ</a></p><ul><li>ä»HTTP POSTè¯·æ±‚ä¸­æå–å‚æ•°</li><li>tokenï¼ŒGWTæ’ä»¶ç”¨äºæ ‡è¯†jenkinsé¡¹ç›®çš„å”¯ä¸€æ€§</li><li>æ ¹æ®è¯·æ±‚å‚æ•°å€¼åˆ¤æ–­æ˜¯å¦è§¦å‘Jenkinsé¡¹ç›®æ‰§è¡Œ</li><li>æ—¥å¿—æ§åˆ¶æ‰“å°</li><li>webhookå“åº”æ§åˆ¶</li></ul><h4 id="GerenericTrigger-çš„å†™æ³•"><a href="#GerenericTrigger-çš„å†™æ³•" class="headerlink" title="GerenericTrigger çš„å†™æ³•"></a>GerenericTrigger çš„å†™æ³•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">    GenericTrigger(</span><br><span class="line">        genericVariables:[</span><br><span class="line">            [key: <span class="string">'ref'</span>, value: <span class="string">'$.ref'</span>]</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        token: env.JOB_NAME,</span><br><span class="line">        regexpFilterText: <span class="string">'$ref'</span>,</span><br><span class="line">        regexpFilterExpression: <span class="string">'refs/heads/'</span> + env.BRANCH_NAME</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env.BRANCH_NAME è¿™é‡ŒæŒ‡çš„æ˜¯åˆ†æ”¯åã€‚å½“ç„¶è¿™æ ·ä¿®æ”¹ä»¥åæ˜¯ä¸è¡Œçš„ï¼Œæ˜¯è¾¾ä¸åˆ°è‡ªåŠ¨è§¦å‘çš„ï¼Œéœ€è¦è‡ªè¡Œå»gitlabä¸Šæ·»åŠ é’©å­ï¼Œè¿™é‡Œç»è¿‡æµ‹è¯•æµç¨‹ï¼šç”¨æˆ·ä¿®æ”¹devåˆ†æ”¯ï¼Œpushåˆ°gitlab devåˆ†æ”¯å¯ä»¥è§¦å‘ä»»åŠ¡çš„devåˆ†æ”¯è‡ªåŠ¨æ„å»ºï¼›åˆå¹¶åˆ°teståˆ†æ”¯ï¼Œä¹Ÿå¯ä»¥è§¦å‘teståˆ†æ”¯è‡ªåŠ¨æ„å»ºï¼›åœ¨åˆå¹¶åˆ°masteråˆ†æ”¯ä¹Ÿèƒ½è‡ªåŠ¨è§¦å‘ä»»åŠ¡çš„masteråˆ†æ”¯è‡ªåŠ¨æ„å»ºã€‚<br><img src="https://img.xxlaila.cn/1571984557618.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è¦å®ç°è¿™å—ï¼Œè¦ç†è§£çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œé¦–å…ˆè¦çŸ¥é“gitlab push æ•°æ®çš„æ ¼å¼ï¼ŒçŸ¥é“äº†gitlab pushæ ¼å¼ï¼Œæˆ‘ä»¬æ‰çŸ¥é“åº”è¯¥æ€ä¹ˆæ“ä½œï¼Œ<a href="https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#webhooks" target="_blank" rel="noopener">gitlab pushæ•°æ®çš„æ ¼å¼å‚è€ƒ</a>ï¼Œ</p><ul><li>å‚è€ƒ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"object_kind"</span>: <span class="string">"push"</span>,</span><br><span class="line">  <span class="string">"before"</span>: <span class="string">"95790bf891e76fee5e1747ab589903a6a1f80f22"</span>,</span><br><span class="line">  <span class="string">"after"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">  <span class="string">"ref"</span>: <span class="string">"refs/heads/master"</span>,</span><br><span class="line">  <span class="string">"checkout_sha"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">  <span class="string">"user_id"</span>: 4,</span><br><span class="line">  <span class="string">"user_name"</span>: <span class="string">"John Smith"</span>,</span><br><span class="line">  <span class="string">"user_username"</span>: <span class="string">"jsmith"</span>,</span><br><span class="line">  <span class="string">"user_email"</span>: <span class="string">"john@example.com"</span>,</span><br><span class="line">  <span class="string">"user_avatar"</span>: <span class="string">"https://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=8://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=80"</span>,</span><br><span class="line">  <span class="string">"project_id"</span>: 15,</span><br><span class="line">  <span class="string">"project"</span>:&#123;</span><br><span class="line">    <span class="string">"id"</span>: 15,</span><br><span class="line">    <span class="string">"name"</span>:<span class="string">"Diaspora"</span>,</span><br><span class="line">    <span class="string">"description"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="string">"web_url"</span>:<span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"avatar_url"</span>:null,</span><br><span class="line">    <span class="string">"git_ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"git_http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"namespace"</span>:<span class="string">"Mike"</span>,</span><br><span class="line">    <span class="string">"visibility_level"</span>:0,</span><br><span class="line">    <span class="string">"path_with_namespace"</span>:<span class="string">"mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"default_branch"</span>:<span class="string">"master"</span>,</span><br><span class="line">    <span class="string">"homepage"</span>:<span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"repository"</span>:&#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"Diaspora"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"description"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"homepage"</span>: <span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"git_http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"git_ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"visibility_level"</span>:0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"commits"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327"</span>,</span><br><span class="line">      <span class="string">"message"</span>: <span class="string">"Update Catalan translation to e38cb41."</span>,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2011-12-12T14:27:31+02:00"</span>,</span><br><span class="line">      <span class="string">"url"</span>: <span class="string">"http://example.com/mike/diaspora/commit/b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327"</span>,</span><br><span class="line">      <span class="string">"author"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"Jordi Mallach"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"jordi@softcatala.org"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"added"</span>: [<span class="string">"CHANGELOG"</span>],</span><br><span class="line">      <span class="string">"modified"</span>: [<span class="string">"app/controller/application.rb"</span>],</span><br><span class="line">      <span class="string">"removed"</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">      <span class="string">"message"</span>: <span class="string">"fixed readme"</span>,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2012-01-03T23:36:29+02:00"</span>,</span><br><span class="line">      <span class="string">"url"</span>: <span class="string">"http://example.com/mike/diaspora/commit/da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">      <span class="string">"author"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"GitLab dev user"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"gitlabdev@dv6700.(none)"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"added"</span>: [<span class="string">"CHANGELOG"</span>],</span><br><span class="line">      <span class="string">"modified"</span>: [<span class="string">"app/controller/application.rb"</span>],</span><br><span class="line">      <span class="string">"removed"</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"total_commits_count"</span>: 4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸åŒçš„åˆ†æ”¯æäº¤æ¥è§¦å‘jenkinsçš„æ„å»ºï¼Œé‚£å°±åº”è¯¥çŸ¥é“postæ•°æ®å“ªä¸€ä¸ªå±æ€§ä»£è¡¨äº†ä¸åŒçš„åˆ†æ”¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¬¬å››è¡Œçœ‹åˆ°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">"ref"</span>: <span class="string">"refs/heads/master"</span>,</span><br></pre></td></tr></table></figure><p><strong>æ³¨é‡Š</strong>: ä¹Ÿå¯ä»¥é€šè¿‡IDEAå·¥å…·æäº¤çš„æ—¶å€™çœ‹åˆ°æäº¤çš„é€‰é¡¹ã€‚å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”¨refå¯ä»¥å¾ˆå¥½çš„åŒºåˆ†ä¸åŒåˆ†æ”¯ï¼Œè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆè¦å¡«å†™refçš„åŸå› ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡pipelineä»£ç çš„ç”Ÿæˆå™¨æ¥ç”Ÿæˆ</p><ul><li>pipeline ä»£ç ç”Ÿæˆå™¨<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">  GenericTrigger causeString: <span class="string">'Generic Cause'</span>, genericVariables: [[defaultValue: <span class="string">''</span>, key: <span class="string">'ref'</span>, regexpFilter: <span class="string">''</span>, value: <span class="string">'$.ref'</span>]], printContributedVariables: <span class="literal">true</span>, printPostContent: <span class="literal">true</span>, regexpFilterExpression: <span class="string">'\'</span>refs/heads/\<span class="string">' + evn.BRANCH_NAME'</span>, regexpFilterText: <span class="string">'$ref'</span>, token: <span class="string">'env.JOB_NAME'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1571982583457.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571982622070.jpg" alt="img"></p><p><strong>æ³¨</strong>: tokenå‚æ•°çš„ä½œç”¨æ˜¯æ ‡è¯†ä¸€ä¸ªpipelineåœ¨jenkinsä¸­çš„å”¯ä¸€æ€§ï¼Œè¿™ä¸ªå‚æ•°çš„é‡è¦æ€§å°±å¾—æèµ·GWTæ’ä»¶çš„åŸç†ã€‚å½“jenkinsæ”¶åˆ°generic-webhook-trgger/invokeæ¥å£çš„è¯·æ±‚æ—¶ï¼Œä¼šå°†è¯·æ±‚ä»£ç†ç»™GWTæ’ä»¶å¤„ç†ï¼ŒGWTæ’ä»¶å†…å®¹ä¼šä»jenkinså®ä¾‹å¯¹è±¡ä¸­å–å‡ºæ‰€æœ‰çš„å‚æ•°åŒ–jenkinsé¡¹ç›®ï¼ŒåŒ…æ‹¬pipelineï¼Œç„¶åè¿›è¡Œéå†ã€‚å¦‚æœæˆ‘ä»¬åœ¨å‚æ•°åŒ–é¡¹ç›®ä¸­Generic Triggeré…ç½®tokençš„å€¼ä¸webhookè¯·æ±‚æ—¶çš„tokenä¸€è‡´ï¼Œå°±ä¼šè§¦å‘æ”¹é¡¹ç›®ã€‚å¦‚æœå¤šä¸ªå‚æ•°åŒ–é¡¹ç›®çš„tokenä¸€æ ·ï¼Œåˆ™éƒ½ä¼šè¿›è¡Œè§¦å‘ï¼Œæ‰€ä»¥è¿™é‡Œçš„tokenæœ€å¥½æ—¶JOB_NAMEé¡¹ç›®åï¼Œå› ä¸ºè¿™ä¸ªæ˜¯åœ¨é¡¹ç›®æˆ–è€…æ˜¯åœ¨ä¸ºæœåŠ¡é¢†åŸŸä»–éƒ½æ˜¯å”¯ä¸€çš„ã€‚</p><ul><li>å‚æ•°ä»‹ç»:<ul><li>regexpFilterText: éœ€è¦è¿›è¡ŒåŒ¹é…çš„keyï¼Œä¾‹å­ä¸­ï¼Œä½¿ç”¨ä»post bodyä¸­æå–çš„refå˜é‡å€¼ã€‚</li><li>regexpFilterExpression: <a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html" target="_blank" rel="noopener">æ­£åˆ™è¡¨è¾¾å¼</a>ï¼›å¦‚æœregexpFilterTextå‚æ•°ç¬¦åˆregexpFilterExpressionå‚æ•°çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ™è§¦å‘æ‰§è¡Œã€‚</li><li>printPostContent: å¸ƒå°”å€¼ï¼Œå°†webhookè¯·æ±‚ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—ä¸Š</li><li>printContributedVariables: å¸ƒå°”å€¼ï¼Œå°†æå–åçš„å˜é‡ååŠå˜é‡å€¼æ‰“å°å‡ºæ¥</li><li>causeString: å­—ç¬¦ä¸²å‹ï¼Œè§¦å‘åŸå› ï¼Œå¯ä»¥ç›´æ¥åº”ç”¨æå–åçš„å˜é‡ï¼Œå¦‚ causeString: â€˜Triggered on $msgâ€™</li><li>Silent response: å¸ƒå°”å‹ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“webhookè¯·æ±‚æˆåŠŸåï¼ŒGWTæ’ä»¶ä¼šè¿”å›HTTP 200çŠ¶æ€ç å’Œè§¦å‘ç»“æœç»™å¯¹æ–¹è°ƒç”¨ï¼Œä½†æ˜¯å½“Silentresponseè®¾ç½®ä¸ºtrueæ—¶ï¼Œå°±åªè¿”å›HTTP 200çŠ¶æ€ç ï¼Œä¸åæ‚”è§¦å‘ç»“æœ</li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢çš„çœ‹çš„å‡ºæ¥ï¼Œæˆ‘ä»¬åªè¦æ˜¯æäº¤äº†åˆ†æ”¯éƒ½å¯ä»¥è¿›è¡Œè§¦å‘æ„å»ºï¼Œä½†æ˜¯å‘¢ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†devâ€”â€”&gt;testâ€”â€”master åˆ†æ”¯ï¼Œå°±æ˜¯åªæƒ³è¦è¿™å‡ ä¸ªè¿›è¡Œè§¦å‘æ„å»ºï¼Œå…¶ä»–çš„ä¸è¿›è¡Œè§¦å‘ï¼Œè®©å¼€å‘è‡ªå·±å»ç‚¹å‡»ã€‚</p><ul><li><p>æŒ‡å®šåˆ†æ”¯æ„å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">  GenericTrigger causeString: <span class="string">'Triggered on $msg'</span>, genericVariables: [[defaultValue: <span class="string">''</span>, key: <span class="string">'ref'</span>, regexpFilter: <span class="string">''</span>, value: <span class="string">'$.ref'</span>]], printContributedVariables: <span class="literal">true</span>, printPostContent: <span class="literal">true</span>, regexpFilterExpression: <span class="string">'\'</span>refs/heads/(dev|<span class="built_in">test</span>|master)\<span class="string">''</span>, regexpFilterText: <span class="string">'$ref'</span>, token: <span class="string">'env.JOB_NAME'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¤šåˆ†æ”¯Gitlab trigger<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤šåˆ†æ”¯çš„Gitlab triggerå’Œæˆ‘ä»¬å‰é¢ä»‹ç»çš„gitlabäº‹ä»¶è§¦å‘ä¸€æ ·çš„ï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œè¿™é‡Œæˆ‘æµ‹è¯•äº†ä¸€ä¸ªjobï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚åŒæ—¶æ–°å»ºäº†ä¸€ä¸ªåˆ†æ”¯ï¼Œjenkinsä¼šè‡ªåŠ¨çš„æ‰«ææ–°å»ºä¸€ä¸ªä»¥åˆ†æ”¯ä¸ºåçš„ä»»åŠ¡ï¼Œè¿›è¡Œè‡ªåŠ¨è§¦å‘ã€‚å½“æˆ‘åˆ é™¤äº†æŸä¸€ä¸ªåˆ†æ”¯ï¼Œå°±ä¼šè§¦å‘è‡ªåŠ¨æ‰«æï¼Œç„¶åæŸ¥çœ‹åˆ†æ”¯ä¸ºåˆ é™¤ã€‚</p></li><li><p>åˆ é™¤åˆ†æ”¯<br><img src="https://img.xxlaila.cn/1571996378764.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571996257688.jpg" alt="img"></p></li><li><p>æ•´ä½“æ•ˆæœå›¾<br><img src="https://img.xxlaila.cn/1571990331005.jpg" alt="img"></p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä»‹ç»ä¸€ä¸‹éƒ¨ç½²è¿™å—ï¼Œæ ¹æ®branchæ¥è¿›è¡Œåˆ¤æ–­ï¼Œä¸åŒçš„branchéƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒï¼Œå½“è®¾å®šçš„å€¼ä¸åœ¨branchèŒƒå›´å†…ï¼Œå°±éœ€è¦äººä¸ºçš„åˆ¶å®šéƒ¨ç½²ç¯å¢ƒã€‚å½“äººå‘˜ä¸‰åˆ†é’Ÿå†…æ²¡æœ‰æ¥è¿›è¡Œç¯å¢ƒéƒ¨ç½²çš„é€‰æ‹©ï¼Œç³»ç»Ÿå°±ä¼šæ–­å¼€ï¼Œå¯¹è¯¥åˆ†æ”¯æ ‡è®°ä¸ºç»“æŸã€‚</p><p><a href="http://xxlaila.github.io/2019/10/25/pipeline%E5%A4%9A%E5%88%86%E6%94%AFgitlab%E8%A7%A6%E5%8F%91/" target="_blank" rel="noopener">å®Œæ•´æ–‡ä»¶</a><br><a href="https://jenkinsci.github.io/job-dsl-plugin/#path/buildPipelineView" target="_blank" rel="noopener">æ¨èå­¦ä¹ å‚è€ƒåœ°å€</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>elasticserch</title>
    <url>/2019/10/17/elasticserch%E6%97%A5%E5%B8%B8%E7%BB%B4%E6%8A%A4/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="days-1"><a href="#days-1" class="headerlink" title="days 1"></a>days 1</h3><a id="more"></a><h4 id="elasticserch-ç´¢å¼•å’Œæ•°æ®æ“ä½œ"><a href="#elasticserch-ç´¢å¼•å’Œæ•°æ®æ“ä½œ" class="headerlink" title="elasticserch ç´¢å¼•å’Œæ•°æ®æ“ä½œ"></a>elasticserch ç´¢å¼•å’Œæ•°æ®æ“ä½œ</h4><ul><li><p>æŸ¥çœ‹ç´¢å¼•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/indices?v'</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ç´¢å¼•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/indices?v' |grep "red"|awk '&#123;print $3&#125;'|uniq &gt;l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in `cat a`;do  curl -XDELETE http://127.0.0.1:9200/$&#123;i&#125;;done</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹shards</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET http://127.0.0.1:9200/_cat/shards</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shards æœ‰å‡ ç§ç±»å‹ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹<code>UNASSIGNED</code>ï¼Œes é›†ç¾¤é‡Œé¢çš„åˆ†ç‰‡æ˜¯åˆ†é…åœ¨å¤šå°nodeä¸Šçš„ï¼Œä¸ºçš„å°±æ˜¯é«˜å¯ç”¨ï¼Œæ¯”å¦‚ä½ çš„æŸå°æœºå™¨crashäº†ï¼Œé‚£ä¹ˆé›†ç¾¤å°±ä¼šè®©å…¶ä»–å‰¯æœ¬é¡¶ä¸Šæ¥ï¼Œé¿å…å‡ºç°æŸä¸ªåˆ†ç‰‡ä¸èƒ½æä¾›æœåŠ¡çš„æƒ…å†µï¼Œä½†æ˜¯éš¾å…è¿˜æ˜¯ä¼šå‡ºç° UNASSIGNED shards çš„é”™è¯¯ã€‚</p><ul><li>åˆ é™¤shards UNASSIGNED<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/shards'|grep "UNASSIGNED"|awk '&#123;print $1&#125;'|uniq &gt;l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in `cat l`;do curl -XDELETE http://127.0.0.1:9200/$i;done</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="elasticserchéªŒè¯é›†ç¾¤"><a href="#elasticserchéªŒè¯é›†ç¾¤" class="headerlink" title="elasticserchéªŒè¯é›†ç¾¤"></a>elasticserchéªŒè¯é›†ç¾¤</h4><ul><li><p>é›†ç¾¤ç›¸å…³API</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat</span><br><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/tasks</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br><span class="line">/_cat/count</span><br><span class="line">/_cat/count/&#123;index&#125;</span><br><span class="line">/_cat/recovery</span><br><span class="line">/_cat/recovery/&#123;index&#125;</span><br><span class="line">/_cat/health</span><br><span class="line">/_cat/pending_tasks</span><br><span class="line">/_cat/aliases</span><br><span class="line">/_cat/aliases/&#123;<span class="built_in">alias</span>&#125;</span><br><span class="line">/_cat/thread_pool</span><br><span class="line">/_cat/thread_pool/&#123;thread_pools&#125;</span><br><span class="line">/_cat/plugins</span><br><span class="line">/_cat/fielddata</span><br><span class="line">/_cat/fielddata/&#123;fields&#125;</span><br><span class="line">/_cat/nodeattrs</span><br><span class="line">/_cat/repositories</span><br><span class="line">/_cat/snapshots/&#123;repository&#125;</span><br><span class="line">/_cat/templates</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤åç§°ç­‰ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"elk_elasticsearch_data_2"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elk_elasticsearch"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"T47wQwa6TT-6MHJVFM40Tw"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"6.4.0"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"rpm"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"595516e"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2018-08-17T23:18:47.308994Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"7.4.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"5.6.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"5.0.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/nodes?v</span><br><span class="line">ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">172.21.16.198           29          85   0    0.10    0.04     0.05 mdi       -      elk_elasticsearch_data_2</span><br><span class="line">172.21.16.187           48          85   0    0.00    0.01     0.05 mdi       *      elk_elasticsearch_master</span><br><span class="line">172.21.16.206           25          86   0    0.08    0.03     0.05 mdi       -      elk_elasticsearch_data_3</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯é›†ç¾¤ç£ç›˜åˆ†é…æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/allocation?v</span><br><span class="line">shards disk.indices disk.used disk.avail disk.total disk.percent host          ip            node</span><br><span class="line">    98          1gb     3.6gb     96.3gb     99.9gb            3 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2</span><br><span class="line">    99      887.1mb     4.5gb     95.4gb     99.9gb            4 172.21.16.187 172.21.16.187 elk_elasticsearch_master</span><br><span class="line">    99        957mb     3.5gb     96.4gb     99.9gb            3 172.21.16.206 172.21.16.206 elk_elasticsearch_data_3</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯é›†ç¾¤å¥åº·çŠ¶å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/health?v </span><br><span class="line">epoch      timestamp cluster           status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1571648406 17:00:06  elk_elasticsearch green           3         3    296 148    0    0        0             0                  -                100.0%</span><br><span class="line"></span><br><span class="line">$</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ä¸Šè¢«fielddataæ‰€ä½¿ç”¨çš„å †å†…å­˜å¤§å°ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/fielddata?v</span><br><span class="line">id                     host          ip            node                     field                    size</span><br><span class="line">VNcRqM30T3axzVjiPkDTmA 172.21.16.187 172.21.16.187 elk_elasticsearch_master event.resultCode.keyword 352b</span><br><span class="line">VNcRqM30T3axzVjiPkDTmA 172.21.16.187 172.21.16.187 elk_elasticsearch_master <span class="built_in">type</span>                     720b</span><br><span class="line">HNc5BrMWQcummBeAskQc4A 172.21.16.206 172.21.16.206 elk_elasticsearch_data_3 event.resultCode.keyword 704b</span><br><span class="line">z3zUA8KxTH6B7C8CmVRUIQ 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2 <span class="built_in">type</span>                     720b</span><br><span class="line">z3zUA8KxTH6B7C8CmVRUIQ 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2 event.resultCode.keyword 704b</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>elasticserch</category>
      </categories>
      <tags>
        <tag>elasticserch</tag>
      </tags>
  </entry>
  <entry>
    <title>nexusé…ç½®ldap</title>
    <url>/2019/10/15/nexus%E9%85%8D%E7%BD%AEldap/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="é…ç½®nexus"><a href="#é…ç½®nexus" class="headerlink" title="é…ç½®nexus"></a>é…ç½®nexus</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•nexusåœ¨è®¾ç½®é¡µï¼Œç‚¹å‡»ldapï¼Œ</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1571131890608.jpg" alt="img"><br>å‚æ•°ä»‹ç»:</p><ul><li>Name: éšä¾¿å†™</li><li>LDAP server address: æ”¯æŒldapså’Œldap,è€Œç«¯å£åˆ™å–å†³äºé…ç½®ã€‚ å¦‚æœæ²¡æœ‰ç‰¹æ®Šé…ç½®ï¼Œldapé»˜è®¤ç«¯å£æ˜¯389</li><li>Search base: åªéœ€è¦å¡«DCå³å¯ï¼Œæ¯”å¦‚DC=example,DC=comã€‚ å…¶å®ƒå†…å®¹ï¼Œæ¯”å¦‚CNã€OUç­‰ï¼Œä¸éœ€è¦å¡«å†™</li><li>Authentication methodæœ‰ä»¥ä¸‹é€‰é¡¹:<ul><li>Simple Authentication</li><li>Anonymous Authentication</li><li>DIGEST-MD5</li><li>CRAM-MD5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šå¸¸é€‰æ‹©Simple Authenticationå³å¯ã€‚Username or DNã€Passwordé‡Œå¡«å†™è´¦æˆ·ã€å¯†ç ï¼Œè€Œ Connection rulesæ— éœ€ä¿®æ”¹ã€‚å¡«å†™å®Œæ¯•åï¼Œç‚¹å‡»ã€Verify connectionã€‘æŒ‰é’®ï¼Œå¯ä»¥éªŒè¯ä¿¡æ¯ã€‚ å¦‚æœæˆåŠŸï¼Œå³å¯ä¿å­˜ã€‚</li></ul></li></ul><h4 id="Choose-Users-and-Groups"><a href="#Choose-Users-and-Groups" class="headerlink" title="Choose Users and Groups"></a>Choose Users and Groups</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é¡¹æ•…åæ€ä¹‰å°±æ˜¯é…ç½®ç”¨æˆ·å’Œç»„çš„ï¼Œåœ¨æœ€å¼€å¤´çš„Configuration templateä¸­ï¼Œæœ‰å››ç§æ¨¡æ¿å¯é€‰ï¼š</p><ul><li>Active Directory</li><li>Generic Ldap Server</li><li>Posix with Dynamic Groups</li><li>Posix with Static Groups</li></ul><p>è¿™é‡Œé€‰æ‹©<code>Generic Ldap Server</code></p><ul><li>Base DN åœ¨LDAPä¸­æ‰¾åˆ°ç”¨æˆ·çš„åŸºæœ¬ä½ç½®ã€‚è¿™æ˜¯ç›¸å¯¹äºæœç´¢åŸºç¡€çš„ï¼ˆä¾‹å¦‚ou = peopleï¼‰ã€‚</li><li>User subtreeé€šå¸¸éœ€è¦å‹¾é€‰ã€‚ å¦‚æœæŠŠLDAPçš„Treeæ¯”ä½œç›®å½•çš„è¯ï¼Œå‹¾é€‰ä»¥åç›¸å½“äºé€’å½’æŸ¥æ‰¾å­ç›®å½•ã€‚</li><li>User filteré€šè¿‡è¿‡æ»¤è§„åˆ™ï¼Œå‡å°‘æœç´¢ä¿¡æ¯ï¼Œç”¨äºæå‡æ€§èƒ½ã€‚ ä»…ä»…åªæ˜¯æå‡æ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä¸æ‡‚å®ƒç‰¹æ®Šçš„åŒ¹é…è§„åˆ™ï¼Œä¹Ÿå¯ä»¥ä¸å¡«ã€‚</li><li>ä¹‹å‰é€‰æ‹©äº†<code>Generic Ldap Server</code>æ¨¡ç‰ˆåï¼ŒUser ID attributeé»˜è®¤ä¸ºuidï¼ŒReal name attributeé»˜è®¤ä¸ºcnã€Email attributeé»˜è®¤ä¸ºmailã€Password attributeä¸ºç©ºã€‚</li><li>Map LDAP groups as roleså¦‚æœä¸å‹¾é€‰ï¼Œå°±ä¸ä¼šåŒæ­¥ç”¨æˆ·ç»„ä¿¡æ¯ã€‚ å¦‚æœå‹¾é€‰ï¼Œåˆ™å¯ä»¥é€‰æ‹©Group typeå’ŒGroup member of attributeã€‚ è‹¥æ— å¿…è¦ï¼Œä¿æŒé»˜è®¤å³å¯ï¼Œé»˜è®¤æ˜¯å‹¾é€‰çš„ã€‚<br><img src="https://img.xxlaila.cn/1571133103461.jpg" alt="img"></li><li>å¡«å†™å®Œæˆåï¼Œé€šè¿‡ã€Verify user mappingã€‘å¯ä»¥éªŒè¯æŸ¥è¯¢ç»“æœ<br><img src="https://img.xxlaila.cn/1571133221971.jpg" alt="img"><br>ç‚¹å‡»åˆ›å»º<br><img src="https://img.xxlaila.cn/1571133286829.jpg" alt="img"></li></ul><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°èµ·ä¸€ä¸ªçª—å£åˆ©ç”¨ldapé‡Œé¢çš„è´¦å·è¿›è¡Œç™»å½•ï¼Œå¯ä»¥ç™»å½•ï¼Œæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ç™»å½•ä¹‹åç”¨æˆ·æ²¡æœ‰ä»»ä½•æƒé™ï¼Œè¿™å¯¹äºç ”å‘æ¥è¯´åˆæ˜¯ä¸€ä¸ªä¸å¯æ¥å—çš„äº‹æƒ…ã€‚æ¥ä¸‹æ¥é…ç½®æƒé™</p><h5 id="ç¦æ­¢åŒ¿åè®¿é—®"><a href="#ç¦æ­¢åŒ¿åè®¿é—®" class="headerlink" title="ç¦æ­¢åŒ¿åè®¿é—®"></a>ç¦æ­¢åŒ¿åè®¿é—®</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ˜¯ä¸å…è®¸åŒ¿åç”¨æˆ·ä¸å¯ä»¥ç™»å½•å°±èƒ½è®¿é—®çš„ï¼Œè¿™æ ·æˆ‘ä»¬ldapå°±æ²¡æœ‰ä»»ä½•æ„ä¹‰äº†<br><img src="https://img.xxlaila.cn/1571133691247.jpg" alt="img"></p><ul><li>ç¦æ­¢åŒ¿åç”¨æˆ·<br><img src="https://img.xxlaila.cn/1571133811908.jpg" alt="img"></li></ul><h5 id="åˆ›å»ºè§’è‰²"><a href="#åˆ›å»ºè§’è‰²" class="headerlink" title="åˆ›å»ºè§’è‰²"></a>åˆ›å»ºè§’è‰²</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨Securityâ€”â€”&gt;Rolesâ€”â€”&gt;Create roleï¼Œè¿™é‡Œåˆ›å»ºè§’è‰²æœ‰ä¸¤ç§ã€‚ä¸€ç§æ˜¯nexus relosæœ¬åœ°è§’è‰²ï¼Œä¸€ç§æ˜¯External roles mappingå¤–éƒ¨æ˜ å°„çš„å½¢å¼ã€‚ä¸ºäº†æ»¡è¶³æˆ‘ä»¬ldapè´¦æˆ·ç™»å½•è¿›æ¥æœ‰æµè§ˆåº“çš„æƒé™ï¼Œç ”å‘åˆå¯ä»¥ä¸Šä¼ ç¬¬ä¸‰æ–¹ä¾èµ–åº“çš„æƒé™ï¼Œä½†æ˜¯ä¸èƒ½åˆ é™¤å’Œç§ä¸‹å¢åŠ åº“Repositoriesã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å•ç‹¬å»ºç«‹ä¸€ä¸ªæœ¬åœ°çš„relosï¼Œç„¶ååœ¨æ˜ å°„å¤–éƒ¨çš„ldapåˆ°è¿™ä¸ªæœ¬åœ°çš„rolesï¼Œè¿™æ ·ldapè´¦æˆ·ç™»å½•è¿›æ¥å°±èƒ½å®ç°æ—¥å¸¸çš„åŸºæœ¬æ“ä½œã€‚</p><ul><li><p>åˆ›å»ºnexus relosæœ¬åœ°è§’è‰²<br><img src="https://img.xxlaila.cn/1571296771150.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä»–èµ‹äºˆæƒé™ï¼Œå¯¹ç”¨æˆ·è¿›è¡Œæƒé™æ§åˆ¶ï¼Œæ²¡æœ‰æƒé™æ§åˆ¶ï¼Œå°±æ²¡åŠæ³•è¾¾æˆæˆ‘ä»¬ä¸Šé¢çš„ç›®æ ‡ã€‚ä¸‹é¢æ˜¯æˆ‘èµ‹äºˆçš„æƒé™ï¼Œå¯ä»¥ç»“åˆå®é™…éœ€æ±‚æ¥è¿›è¡Œèµ‹äºˆã€‚</p></li><li><p>æƒé™ä»‹ç»:</p><ul><li>ng-component-upload: æœ‰ä¸Šä¼ çš„æƒé™ï¼Œæ¯”å¦‚javaä¾èµ–çš„ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œç ”å‘å¯ä»¥è‡ªå·±è¿›è¡Œä¸Šä¼ </li><li>ng-repository-admin-<em>-</em>-browse: æµè§ˆæ‰€æœ‰çš„repository</li><li>ng-repository-admin-<em>-</em>-read: å¯ä»¥æ‰€æœ‰è¯»å–repositoryçš„é…ç½®ä¿¡æ¯</li><li>ng-repository-view-maven2-maven-central-browse: å…·æœ‰æµè§ˆmaven-centralå†…å®¹</li><li>ng-repository-view-maven2-maven-central-read: è¯»å–maven-centralå†…å®¹ï¼Œåœ¨mavenç¼–è¯‘çš„æ—¶å€™å…·æœ‰ä¸‹è½½çš„æƒé™ï¼Œ(åé¢ä¸ä¸€ä¸€ä»‹ç»)</li><li>ng-repository-view-maven2-maven-public-browse</li><li>ng-repository-view-maven2-maven-public-read</li><li>ng-repository-view-maven2-maven-releases-browse</li><li>ng-repository-view-maven2-maven-releases-read</li><li>ng-repository-view-maven2-maven-snapshots-browse</li><li>ng-repository-view-maven2-maven-snapshots-read</li><li>ng-repository-view-npm-npm-kxl-all-browse: ä»¥ä¸‹æ˜¯è‡ªå·±åšçš„npmä»£ç†ç¼“å­˜ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://xxlaila.github.io/2019/08/23/nexus3æ­å»ºnpmç§æœ/" target="_blank" rel="noopener">nexus3æ­å»ºnpmç§æœ</a></li><li>ng-repository-view-npm-npm-kxl-all-read</li><li>ng-repository-view-npm-npm-external-browse</li><li>ng-repository-view-npm-npm-external-read</li><li>ng-repository-view-npm-npm-internal-browse</li><li>ng-repository-view-npm-npm-internal-read</li><li>ng-search-read: è®©ç”¨æˆ·å…·æœ‰æ‰€æœ‰æƒé™ï¼Œæ²¡æœ‰æ­¤æƒé™ï¼Œç ”å‘æŸ¥æ‰¾ä¸€ä¸ªåŒ…ï¼Œä¼°è®¡ä¼šæ­»</li></ul></li><li><p>åˆ›å»ºæ˜¯External roles mappingå¤–éƒ¨æ˜ å°„<br><img src="https://img.xxlaila.cn/1571134166780.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571297568491.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¿›è¡ŒRoles ID è¿™æ ç›®ï¼Œéœ€è¦å¡«å†™çš„æ˜¯Usersï¼Œè¿™ä¸ªUsersä¼šåœ¨ldapä¸ŠåŒæ­¥Usersçš„ä¸€ä¸ªç”¨æˆ·ç»„ã€‚æ ¹æ®è‡ªå·±çš„ldapè´¦æˆ·ç»„è®¾ç½®æ¥è¿›è¡Œå¡«å†™ã€‚ä¸‹å›¾æ˜¯ldapçš„ç»„è®¾ç½®<br><img src="https://img.xxlaila.cn/1571298567078.jpg" alt="img"></p></li></ul><p><strong>æ³¨</strong>: å…¶å®åœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›è¡ŒPrivilegesçš„æƒé™èµ‹äºˆï¼Œä½†æ˜¯æˆ‘é€‰æ‹©çš„æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªæœ¬åœ°çš„nexus relosã€‚ç„¶åæˆ‘ä»¬åœ¨Rolesæ å…³è”ä¹‹å‰åˆ›å»ºçš„<code>Developer</code>ï¼Œå®Œæˆä»¥åé€šè¿‡ldapè´¦æˆ·ç™»å½•è¿›è¡Œæµ‹è¯•</p><h5 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä¸»è¦æ˜¯ä»å››ä¸ªæ–¹é¢æ¥æµ‹è¯•ldapè´¦æˆ·ã€‚åˆ†åˆ«æ˜¯: ç™»å½•é»˜è®¤çš„æƒé™ã€æµè§ˆæ‰€æœ‰åº“çš„æƒé™ã€Browseçš„æµè§ˆã€Browseåº“çš„ä¸Šä¼ </p><ul><li><p>ç™»å½•é»˜è®¤çš„æƒé™<br><img src="https://img.xxlaila.cn/1571297962563.jpg" alt="img"></p></li><li><p>æµè§ˆæ‰€æœ‰åº“çš„æƒé™<br><img src="https://img.xxlaila.cn/1571298121188.jpg" alt="img"></p></li><li><p>Browseçš„æµ<br><img src="https://img.xxlaila.cn/1571298018356.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571298167348.jpg" alt="img"></p></li><li><p>Browseåº“çš„ä¸Šä¼ <br><img src="https://img.xxlaila.cn/1571298224331.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571298260091.jpg" alt="img"></p></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nexus</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsé…ç½®å¤‡ä»½</title>
    <url>/2019/10/15/jenkins%E9%85%8D%E7%BD%AE%E5%A4%87%E4%BB%BD/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="jenkins-å¤‡ä»½"><a href="#jenkins-å¤‡ä»½" class="headerlink" title="jenkins å¤‡ä»½"></a>jenkins å¤‡ä»½</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“jenkinsåœ¨ç”¨èµ·æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éš¾ä¿ä»–ä¸ä¼šå‡ºæ•…éšœï¼Œä½†æ˜¯å‡ºäº†æ•…éšœæˆ‘ä»¬æ€ä¹ˆåšåˆ°å¿«é€Ÿçš„æ¢å¤å‘¢ï¼Œè¿™æ—¶å¤‡ä»½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚ä½†jenkinsæœ¬èº«ä¸æä¾›å¤‡ä»½çš„åŠŸèƒ½ï¼Œ<a id="more"></a> æ‰€ä»¥è¿™é‡Œå°±éœ€è¦å€ŸåŠ©å¤–åŠ›ã€‚å¤‡ä»½å¯ä»¥å¤šæ ·åŒ–ï¼Œä¸€ç§æ˜¯æˆ‘ä»¬ç›´æ¥åˆ°jenkinsçš„ç›®å½•ä¸‹é¢æ‰‹åŠ¨å¤‡ä»½jenkinsç›®å½•ã€‚ä¸€ç§æ˜¯æˆ‘ä»¬å°±jenkinsè‡ªå¸¦çš„æ’ä»¶<code>thinBackup</code>å’Œ<code>Periodic Backup</code>è¿›è¡Œå¤‡ä»½æ¢å¤ï¼Œä¸‹é¢è¿›è¡Œåˆ†åˆ«ä»‹ç»</p><h3 id="thinBackupå¤‡ä»½"><a href="#thinBackupå¤‡ä»½" class="headerlink" title="thinBackupå¤‡ä»½"></a>thinBackupå¤‡ä»½</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;æ’ä»¶ç®¡ç†<br><img src="https://img.xxlaila.cn/1571101180571.jpg" alt="img"><br>å®‰è£…å®Œæˆä¹‹åé‡å¯jenkinsæœåŠ¡ï¼Œç™»å½•jenkinsåœ¨ç³»ç»Ÿç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571101557754.jpg" alt="img"></p><h4 id="é…ç½®ThinBackup"><a href="#é…ç½®ThinBackup" class="headerlink" title="é…ç½®ThinBackup"></a>é…ç½®ThinBackup</h4><ul><li>ç‚¹å‡»ThinBackup<br><img src="https://img.xxlaila.cn/1571101640273.jpg" alt="img"><br>å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªé€‰é¡¹:</li><li>Backup Now: æ‰‹åŠ¨ç«‹å³å¤‡ä»½</li><li>Restore: æ¢å¤å¤‡ä»½</li><li>Settings: å¤‡ä»½å‚æ•°çš„è®¾ç½®</li></ul><h5 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹é¢æ˜¯æˆ‘çš„å¤‡ä»½å‚æ•°ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è‡ªå·±è®¾å®šå¤‡ä»½å‚æ•°ï¼Œè®¾ç½®å¥½å‹saveå³å¯ï¼Œ<code>Backup schedule for full backups</code>æ„æ€æ˜¯å‘¨ä¸€åˆ°å‘¨äº”æ¯å¤©å‡Œæ™¨ä¸¤ç‚¹è¿›è¡Œå¤‡ä»½<br><img src="https://img.xxlaila.cn/1571102057919.jpg" alt="img"></p><h5 id="Restore"><a href="#Restore" class="headerlink" title="Restore"></a>Restore</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤‡ä»½æ–‡ä»¶æ˜¯ä»¥æ—¥æœŸ+æ—¶é—´èŠ‚ç‚¹ç»„æˆçš„æ–‡ä»¶åï¼Œæˆ‘ä»¬æ¢å¤ä»€ä¹ˆæ—¶é—´æ®µçš„ï¼Œç‚¹å‡»è¿›è¡Œæ¢å¤ï¼Œ<br><img src="https://img.xxlaila.cn/1571102188007.jpg" alt="img"></p><h3 id="Periodic-Backup"><a href="#Periodic-Backup" class="headerlink" title="Periodic Backup"></a>Periodic Backup</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤‡ä»½é™¤äº†ä¸Šé¢æåˆ°çš„æ’ä»¶è¿˜æœ‰ä¸€ä¸ªæ’ä»¶æ˜¯<code>Periodic Backup</code>ï¼Œå®‰è£…<code>Periodic Backup</code>ä¸é˜è¿°ï¼Œå®‰è£…å®Œæˆåå¯ä»¥åœ¨ç³»ç»Ÿç®¡ç†èœå•ä¸‹é¢æœ‰ä¸€ä¸ª<code>Periodic Backup Manager</code>èœå•<br><img src="https://img.xxlaila.cn/1571709136813.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰“å¼€<code>Periodic Backup Manager</code>ï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€æ˜¯æ²¡æœ‰ä»»ä½•ä¸œè¥¿çš„ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å»å»ºç«‹ä¸€ä¸ªè§„åˆ™ï¼Œç‚¹å‡»<code>Configure</code><br><img src="https://img.xxlaila.cn/1571709270639.jpg" alt="img"></p><p>é…ç½®é¡¹å¾ˆç®€å•:</p><ul><li>Temporary Directory: ä¸´æ—¶ç›®å½•</li><li>Backup schedule (cron): è¿›è¡Œå¤‡ä»½cronçš„è¡¨è¾¾å¼ï¼Œå¡«å†™å®Œæˆåç‚¹å‡»<code>Validate cron syntax</code>è¿›è¡ŒéªŒè¯</li><li>Maximum backups in location: æœ€å¤§ä½ç½®å¤‡ä»½ï¼Œä¿ç•™å¤šå°‘ä¸ªå¤‡ä»½æ–‡ä»¶</li><li>Store no older than (days): ä¿ç•™çš„æ—¶é—´</li><li>File Management Strategy: å¤‡ä»½ç­–ç•¥<ul><li>ConfigOnly: åªå¤‡ä»½é…ç½®æ–‡ä»¶</li><li>FullBackup: è¿›è¡Œå…¨é‡å¤‡ä»½ï¼Œå¯ä»¥é€šè¿‡Excludes listä¸­å¡«å…¥Anté£æ ¼è¡¨è¾¾å¼ï¼Œæ’é™¤ä¸å¸Œæœ›å¤‡ä»½çš„æ–‡ä»¶ï¼Œå¤šä¸ªè¡¨è¾¾å¼ä½¿ç”¨åˆ†å·åˆ†éš”</li></ul></li><li>Storage Strategy: å­˜å‚¨ç­–ç•¥ï¼Œå°±æ˜¯æ˜¯å¦éœ€è¦è¿›è¡Œå‹ç¼©å­˜å‚¨</li><li>Backup Location: å¤‡ä»½çš„ä½ç½®ï¼Œéƒ½æ˜¯æœ¬åœ°ç›®å½•<br><img src="https://img.xxlaila.cn/1571709879768.jpg" alt="img"></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsé…ç½®ldap</title>
    <url>/2019/10/14/jenkins%E9%85%8D%E7%BD%AEldap/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸ç ”å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜ï¼Œè¿˜æœ‰è¿ç»´äººå‘˜æœ‰æ—¶å€™ç™»å½•jenkinså»æŸ¥çœ‹ä¸€äº›jobçš„çŠ¶æ€æˆ–è€…æ˜¯å…¶ä»–çš„ä¸œè¥¿ï¼Œè™½ç„¶æœ‰ä¼ä¸šå¾®ä¿¡çš„é€šçŸ¥ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯ä¸èƒ½æ»¡è¶³ï¼Œ<a id="more"></a> æ¯”å¦‚jobé”™è¯¯äº†ï¼Œä¼ä¸šå¾®ä¿¡è™½ç„¶å§é”™è¯¯å‘ç»™äº†ç ”å‘äººå‘˜ï¼Œä½†æ˜¯ç ”å‘è¿˜æ˜¯è¦ç™»å½•jenkinsä¸Šå»çœ‹ï¼Œå°±æ„Ÿè§‰è¦èˆ’æœä¸€ç‚¹ï¼Œæµ‹è¯•ä¸Šåšçš„ä¸€äº›è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæœ‰æ—¶å€™å¤±è´¥äº†ä»–ä»¬ä¹Ÿä¼šå»çœ‹æˆ–è€…æ˜¯å»å»ºç«‹ä¸€äº›è‡ªåŠ¨åŒ–çš„jobã€‚ä¹‹å‰å»ºç«‹äº†å…¬å…±çš„è´¦å·ï¼Œå¼€å‘å’Œæµ‹è¯•äººå‘˜éƒ½å»ç™»å½•ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä»–ä»¬è¯¯æ“ä½œäº†ï¼Œå¯¼è‡´ä¸€äº›å…¶ä»–çš„ä¸œè¥¿å¤±è´¥æˆ–è€…é”™è¯¯ï¼Œè™½ç„¶åšäº†æƒé™æ§åˆ¶ï¼Œä½†æ˜¯ä»–ä»¬è¿˜æ˜¯æ­»ä¸æ‰¿è®¤ï¼Œæ‰€ä»¥è¿™é‡Œä»‹å…¥ldapã€‚è°åŠ¨çš„å°±çŸ¥é“äº†ï¼Œè¿™æ ·å°±ä¸æ€•äº†ã€‚</p><h3 id="å¼€å§‹é…ç½®"><a href="#å¼€å§‹é…ç½®" class="headerlink" title="å¼€å§‹é…ç½®"></a>å¼€å§‹é…ç½®</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®<br><img src="https://img.xxlaila.cn/1571025388007.jpg" alt="img"><br>è®¿é—®æ§åˆ¶â€”â€”&gt;LDAP<br><img src="https://img.xxlaila.cn/1571027524602.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆä»¥åæˆ‘ä»¬éœ€è¦æµ‹è¯•ä¸€ä¸‹è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œç‚¹å‡»<code>Test LDAP setttings</code>ï¼Œè¾“å…¥åœ¨ldapçš„å…¶ä¸­ä¸€ä¸ªè´¦æˆ·æ¥è¿›è¡ŒéªŒè¯ï¼Œæ²¡é—®é¢˜çš„ç»“æœå¦‚ä¸‹:<br><img src="https://img.xxlaila.cn/1571027696951.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆå¹¶æµ‹è¯•é€šè¿‡åå°±å¯ä»¥ç”¨LDAPç›´æ¥ç™»å½•äº†<br><strong>æ³¨</strong>: å¯ç”¨äº†LDAPç™»å½•åå°†æ— æ³•å†ç”¨ä¹‹å‰çš„ç™»å½•æ–¹å¼ï¼ˆæœ¬åœ°è®¤è¯å°†æ— æ³•åœ¨ä½¿ç”¨ï¼‰ç™»å½•ï¼Œç™»å½•è¿›æ¥çš„ä»»ä½•ä¸€ä¸ªè´¦å·éƒ½æ˜¯ç®¡ç†å‘˜ï¼Œéƒ½æ˜¯ç®¡ç†ç€è‚¯å®šæ¥è¯´ä¸å®‰å…¨ï¼Œæƒé™é…ç½®è¯·ä¸‹çœ‹</p><p><a href="https://wiki.jenkins.io/display/JENKINS/LDAP+Plugin" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a></p><h3 id="é…ç½®ldapçš„è´¦æˆ·æƒé™"><a href="#é…ç½®ldapçš„è´¦æˆ·æƒé™" class="headerlink" title="é…ç½®ldapçš„è´¦æˆ·æƒé™"></a>é…ç½®ldapçš„è´¦æˆ·æƒé™</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢æˆ‘ä»¬è™½ç„¶å§ldapé…ç½®å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å¯¹ç”¨æˆ·è¿›è¡Œæƒé™çš„é…ç½®ï¼Œä¸å¯èƒ½æ¯ä¸ªäººç™»å½•éƒ½èƒ½å¯¹æˆ‘ä»¬jenkinsè¿›è¡Œæ— é™åˆ¶çš„æ“ä½œï¼Œè¿™ä¸ç¬¦åˆæˆ‘ä»¬ä¹‹å‰çš„æ„å›¾ã€‚å®‰è£…<code>Role-based Authorization Strategy</code>æ’ä»¶</p><ul><li>åœ¨ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®,å¯ä»¥çœ‹åˆ°ä¸‹é¢é€‰é¡¹ï¼Œæ¯é¡¹ä»‹<a href="https://xxlaila.github.io/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" target="_blank" rel="noopener">å‚è€ƒ</a><br><img src="https://img.xxlaila.cn/1571034253089.jpg" alt="img"></li></ul><p>ä¿å­˜ä»¥åï¼Œè¿”å›ç³»ç»Ÿç®¡ç†ç•Œé¢å°±å¯ä»¥çœ‹åˆ°å¤šå¤„ä¸€ä¸ª<code>Manage and Assign Roles</code><br><img src="https://img.xxlaila.cn/1571034433352.jpg" alt="img"><br>ç‚¹å‡»è¿›å»</p><p><img src="https://img.xxlaila.cn/1571034507945.jpg" alt="img"></p><ul><li><strong>Manage Roles</strong>: è§’è‰²åˆ†ä¸ºGlobalå’ŒProjectï¼Œå¯åˆ›å»ºè§’è‰²åˆ†ç»„å’Œæ·»åŠ é¡¹ç›®ã€‚</li><li><strong>Assign Roles</strong>: å¢åŠ å…·ä½“çš„ç”¨æˆ·ï¼Œåˆ†é…åˆ°è§’è‰²ç»„ï¼ŒæŒ‡å®šé¡¹ç›®æƒé™ã€‚</li></ul><p><a href="https://xxlaila.github.io/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" target="_blank" rel="noopener">æƒé™è®¾ç½®</a></p><ul><li>ä¸‹é¢æˆ‘çš„é…ç½®ï¼Œå’Œä¹‹å‰çš„å¤§åŒå°å¼‚<br><img src="https://img.xxlaila.cn/1571038684383.jpg" alt="img"></li></ul><p><strong>æ³¨</strong>: è¿™é‡Œæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œè¿™æ ·é…ç½®ä»¥åï¼Œæ–°ç”¨æˆ·ç™»å½•è¿›æ¥ä»¥åå°±ä¼šæç¤ºæ²¡æœ‰æƒé™ï¼Œ<code>Access Denied,xxxxæ²¡æœ‰å…¨éƒ¨/Readæƒé™</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ‰“å¼€jenkinsåï¼Œæ²¡æœ‰åˆ›å»ºç”¨æˆ·å‰ï¼Œå…ˆä¸è¦å‹¾é€‰ç³»ç»Ÿè®¾ç½®ä¸­å¯ç”¨å®‰å…¨é€‰é¡¹ï¼Œå¦‚æœå‹¾é€‰äº†ï¼Œå°±ä¼šå‡ºç°æ— æ³•è¿›å…¥jenkinsçš„ç°è±¡<br><img src="https://img.xxlaila.cn/1571037187865.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ç½‘ä¸Šçœ‹åˆ°æœ‰è¿™ç§çš„è§£å†³åŠæ³•ï¼Œæœ‰å‡ ç§æ–¹æ¡ˆï¼Œä¸€ä¸ªæ˜¯ä¿®æ”¹confing.xmlçš„æ–‡ä»¶ï¼Œä¿®æ”¹config.xmlæ–‡ä»¶çš„ä¸‰ç§æ–¹å¼æ„Ÿè§‰éƒ½ä¸å¤ªåˆ‡åˆå®é™…çš„ä¸šåŠ¡ï¼›ä¸‹é¢æ˜¯æˆ‘åšçš„ä¸¤ç§åŠæ³•ï¼Œæ¨èä½¿ç”¨ç¬¬äºŒç§</p><ul><li><p>Role-Based Strategy<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨<code>Assign Roles</code>å§ç”¨æˆ·æ·»åŠ è¿›æ¥ï¼Œç„¶åå‹¾é€‰æƒé™ï¼Œ<br>ç³»ç»Ÿç®¡ç†â€”â€”&gt;Manage and Assign Rolesâ€”â€”&gt;Assign Roles<br><img src="https://img.xxlaila.cn/1571037604678.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½†æ˜¯è¿™æœ‰ä¸€ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯æ¯æ¬¡æ–°æ¥ä¸€ä¸ªç”¨æˆ·å°±å¾—å»æ·»åŠ ä¸€æ¬¡ç”¨æˆ·æƒé™ï¼Œè™½ç„¶æ»¡è¶³äº†ä¸šåŠ¡éœ€æ±‚ï¼Œä½†æ˜¯ä¸ç§‘å­¦</p></li><li><p>é¡¹ç›®çŸ©é˜µæˆæƒç­–ç•¥<br><img src="https://img.xxlaila.cn/1571041499340.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æ˜¯ä¸€ä¸ªå…¨å±€çš„é…ç½®ï¼Œç‰¹å®šç»„åªèƒ½æŒ‰ç…§æœ€å°çš„æƒé™æˆæƒï¼Œé¢å¤–çš„æƒé™å¯ä»¥åœ¨å…·ä½“çš„é¡¹ç›®æƒé™çŸ©é˜µé‡Œé¢åœ¨æ·»åŠ ã€‚ é»˜è®¤åªæœ‰<code>Anonymous Users</code>å’Œ<code>Authenticated Users</code>ï¼Œç®¡ç†å‘˜ç»„æ˜¯éœ€è¦æ·»åŠ çš„<code>admin</code></p></li><li><p>Anonymous Users: åŒ¿åç”¨æˆ·ï¼Œæ˜¾ç„¶ä¸èƒ½</p></li><li><p>Authenticated Users: è®¤è¯ç”¨æˆ·ï¼Œå°±æ˜¯åªè¦æ˜¯è®¤è¯çš„è´¦å·éƒ½å¯ä»¥æ‹¥æœ‰çš„æƒé™</p></li><li><p>admin: å°±æ˜¯æ‹¥æœ‰æ‰€æœ‰çš„æƒé™äº†ï¼Œè¿™ä¸ªç»„ä¸€èˆ¬åªèƒ½è¿ç»´äººå‘˜å’Œéƒ¨é—¨è€å¤§åŠ å…¥ã€‚</p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ å…¥adminç»„ä»¥åï¼Œä»–ä¼šè‡ªåŠ¨å»åŒæ­¥ldapçš„ç»„ç”¨æˆ·ï¼Œå¦‚æœç”¨æˆ·åœ¨ldapæ˜¯adminç»„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°±ä¼šæ˜¯ç®¡ç†å‘˜æƒé™ï¼Œå¦‚æœç”¨æˆ·æ˜¯æ™®é€šç»„ï¼Œé‚£ä¹ˆå°±æ˜¯<code>Authenticated Users</code>ç»„èµ‹äºˆçš„æƒé™ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼åªè¦ç”¨æˆ·æ˜¯ldapé‡Œé¢çš„ï¼Œå°±å¯ä»¥ç™»å½•æŸ¥çœ‹ã€‚è¿™æ ·å°±æ»¡è¶³äº†ä¸šåŠ¡åœºæ™¯éœ€æ±‚</p><h3 id="æ—¥å¿—è®°å½•"><a href="#æ—¥å¿—è®°å½•" class="headerlink" title="æ—¥å¿—è®°å½•"></a>æ—¥å¿—è®°å½•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è®°å½•ç”¨æˆ·æ—¥å¿—éœ€è¦å•ç‹¬çš„å®‰è£…<code>Audit Trail</code>æ’ä»¶ï¼Œè¯¥æ’ä»¶åœ¨Jenkinsä¸»é…ç½®é¡µé¢ä¸­æ·»åŠ äº†ä¸€ä¸ªé…ç½®éƒ¨åˆ†ï¼Œå¯ä»¥åœ¨æ­¤å¤„é…ç½®æ—¥å¿—ä½ç½®å’Œè®¾ç½®ï¼ˆæ–‡ä»¶å¤§å°å’Œå¾ªç¯æ—¥å¿—æ–‡ä»¶çš„æ•°é‡ï¼‰ï¼Œä»¥åŠç”¨äºè®°å½•è¯·æ±‚çš„URIæ¨¡å¼ã€‚é»˜è®¤é€‰é¡¹é€‰æ‹©æ•ˆæœæ˜¾ç€çš„å¤§å¤šæ•°æ“ä½œï¼Œä¾‹å¦‚åˆ›å»º/é…ç½®/åˆ é™¤ä½œä¸šå’Œè§†å›¾æˆ–æ°¸ä¹…åˆ é™¤/ä¿å­˜/å¼€å§‹æ„å»ºã€‚æ—¥å¿—å°†æŒ‰ç…§é…ç½®å†™å…¥ç£ç›˜ï¼Œæœ€è¿‘çš„æ¡ç›®ä¹Ÿå¯ä»¥åœ¨â€œç®¡ç†/ç³»ç»Ÿæ—¥å¿—â€éƒ¨åˆ†ä¸­æŸ¥çœ‹ã€‚<br><img src="https://img.xxlaila.cn/1572057054289.jpg" alt="img"><br><a href="https://plugins.jenkins.io/audit-trail" target="_blank" rel="noopener">Audit Trailå®˜æ–¹å‚è€ƒ</a></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé…ç½®ä»¥åè¿˜ä¸èƒ½è®°å½•jobçš„æ—¥å¿—ï¼Œéœ€è¦å¯¹jobè¿›è¡Œè®°å½•éœ€è¦å¦å¤–çš„å®‰è£…<a href="https://wiki.jenkins.io/display/JENKINS/JobConfigHistory+Plugin" target="_blank" rel="noopener">Job Configuration Historyæ’ä»¶</a>ï¼Œæ ¹æ®å®˜æ–¹çš„ä»‹ç»ï¼Œå¯ç”¨äºæŸ¥çœ‹æ‰€æœ‰ä½œä¸šé…ç½®å†å²è®°å½•æˆ–ä»…æŸ¥çœ‹å·²åˆ é™¤çš„ä½œä¸šæˆ–æ‰€æœ‰ç±»å‹çš„é…ç½®å†å²è®°å½•æ¡ç›®ã€‚åŒæ—¶ï¼Œå¦‚æœé…ç½®äº†å®‰å…¨ç­–ç•¥ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹å“ªä¸ªç”¨æˆ·è¿›è¡Œäº†å“ªäº›æ›´æ”¹ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬åœ¨jobé‡Œé¢å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>Job Config History</code>çš„èœå•ã€‚æœ€å¼€å§‹æ²¡æœ‰æ²¡æœ‰ä»»ä½•è®°å½•ï¼Œåªæœ‰å½“æ„å»ºjobæˆ–è€…ä¿®æ”¹è¿‡jobä»¥åæ‰ä¼šæœ‰è®°å½•<br><img src="https://img.xxlaila.cn/1572057782047.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1572057958019.jpg" alt="img"></p><ul><li>ç‚¹å‡»Show Diffs å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å…·ä½“ä¿®æ”¹äº†ä»€ä¹ˆä¸œè¥¿<br><img src="https://img.xxlaila.cn/1572058118436.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬å®‰è£…å¥½è¿™ä¸ªæ’ä»¶ä»¥åï¼Œä¹Ÿæµ‹è¯•å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½è®©æ‰€æœ‰çš„jobæ—¥å¿—è®°å½•ä¿å­˜å†å²è¿‡ä¹…ï¼Œå¦‚æœjobè¿‡å¤šï¼Œè®°å½•è¿‡å¤šï¼Œè¿™ä¼šå¯¹æˆ‘ä»¬çš„ç£ç›˜ç©ºé—´æ¥è¯´ï¼Œè‚¯å®šæ˜¯ä¸€ä¸ªå‹åŠ›ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦è¿›è¡Œé…ç½®ï¼Œä¿å­˜å¤šå°‘æ¬¡çš„è®°å½•ï¼Œè€Œä¸”è¿˜å¯ä»¥è®¾ç½®æ’é™¤çš„æ–‡ä»¶ã€‚<br><img src="https://img.xxlaila.cn/1572058857084.jpg" alt="img"></p><p><a href="https://wiki.jenkins.io/display/JENKINS/JobConfigHistory+Plugin" target="_blank" rel="noopener">Job Configuration Historyå®˜æ–¹</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>javaåº”ç”¨éƒ¨ç½²</title>
    <url>/2019/10/12/java%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="Welcome to my blog, enter password to read." />
    <label for="hbePass">Welcome to my blog, enter password to read.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="f6ad35764ea5b8e37ce1880576c42bcdf428050cf41e8ac238b3b9298d4f5537">d69a90776b8106231e3f5503e1ddcc13376254b97345feb73ace3f396649992630ffdbfd4d523e701abe00b6ccbfa8c9c55ba161d404eb570400424bd472062da452630f56925e4377c452329054926de45ae2a0fe9f194a6c6032cfc2c832e0fa47bdc1ab6c67e59d6220d70175cc13636a005a28df16c5742a2f2608f68cc61d9042ffd032fedb271619f5358dbc1a2b9cb7884dd75d01f190e1e6a05133098026c0385891c0d1c65b6f53b4f3f462ef4108fe50e41adb2cc22ca7c14ef7ff5fc020c0402b41cad6ddbd113e1e15713d8bf3cc7be3cb1249ae8217e9905c5a54dc5566ed58b791dc82bafa2b61cfa30e08bb741eb75d288d357f56c8837edc49d82c1198677cd8ddf0e9d73030b08f2880a4c2664d07bc60bc769d380575935a0cefaa6041eeb66d68f1c51e53fa6a8b001703c87177ffe245c51caa1ea57c17706264ce004be3db3c6f4ab48885536974c3d7611f216e0d69777283cb1ec12c1500bb62c59e81e991c0b7f1b52627299e82e544ed10781d4147158671a163aa8e852df2a3069e70ad24305d00df47622be43a4fa4fd21652ff858abbde101fad7ce72f4e8139512ec9d6b83b9066af2c8ebff0f7eaa946d58f29ff073df6ef1e46b805424956342606b60d326e2a1fa0851adb20d8740080c9cb24a59dfb537c002a39ad69f6f6f0eeb5dd9fb25e50143d3a97cc8d0563399b139a050c90e2c2ee15e1e223e9c6757dbfb4631dd4792220a3ed9050acb7145d4ef2ab2046420e7fa4e9aa146d088b10fc0801f29a44337989d7a26f145433184cd83ed415b52f0e4cdd452735bc4435de6ae61df20f324d748e659dc336b0ad0079d4d0bf85c9a801b2dba866d4eceaa937bf769213fea87d3b71c3927ef25a70d45e5ef7d08ae5abd737a9ff0a8e044e00a5f9ca2894afe2c2bc081bca50f75c345f7b1142a8cdbf08a46b52fad0bea9c3bd1cb10dad4e538cebcbf68d0805ff8bfb67e50c30de3805ac55c92b81554fb65287541cd0eb05abac2f6997d92d19f27806bea7c0e92810c0ee0d1d2c58e0cc928d05ba44465cd6d9a272817505410790f457300394d016b573bd00760a876a912c6622047431587de044ecd12793704d9803836c05087563578c16bebc4ddb9e2b483881923de385ab4c6672b8f11cc8d0d7dbaced21ea534bd495b1fef344ef0f3f1131096c27e7db7c328dba42b393c9af38a4fbfda86b06c28069f2dd6fc230bd8e5817168bf05a427be8d534d456177d88a948f5242b03ef64dd7e1042dfcc1038659001a2cbe7a1e862165ca0bfb3fe185a13583eb4b453ca984bb45cf5e4e4edb8ce088843b8f6c3f80db63ab7c0be8302f34ca4041b66008c8ce172900ee0e75d03ed1a3f2f6404dab9be9702c6a9b074c94a4464018acf0bf018c6374dc75a3e2e7bdba720afcb1d4acf9e380f0c520f90640fbbce5cf3e4daa9ea1ac0142757bd804e0e6ce7830e365f2577a5868f986d51ef39e436681ed83d23113483fbd511133b583c6c35ce4f046b91730c4777ed142ad2740e66b0c0c63764ed999f1343e0faf9216e5c65ccd5da6ad96a42eb23afe1bcf1c225041626d6125ad890e0face36263f3fbfacbb83af2d8cc0feaa60003cf12757e2db3a7958cb1237d701ecfc32ee671c871c691b48d80cf832d30868a503d33bfc78ec583199861d7a5ebf7be9045c86afae00b114571de69900c923ef2a9b9f4fbde1337ff014010ef6a853f81acccf16afa525568c5e96543eba1143d91d70691468f63abbeafa7e29d98ff62db923982353244c6acb10c5143c9055fbded3023add85abf73e7d1095ff21cbf469e964a179f89027df387a2ca5497e0c1f3721f23e2b6c849ff14bbf728e47816c2e402210b0ab7c11ecce1ef6dc04ca364b01d323c0d4674710cf898d78d091af7881c97ad92dbe1ebdd682f8d06af7fe8a4e9d245fd1d7cb0c1f4b201666e6d9eea3729f5a95d089905ef94f39d20d3accc376d3637055e0a9159240c9d7e7692cfb117ee0f0a19d159126b08b3fd857f086a6b62408753fa58629523507f5d26b30a1f236116aa5ef12607e8efef84eb8c58c202143050923e742009bce2b881a657bdc45d51e2418e374258520d87d3c021959194a18aa349ae6ba668ffe0bb9811a5963fc66edb90ead76d0ad4add608e24a2b125042a22cea93492274beafd29fc30caf52e11b6b5e82dba11df3d264d6452427bdf7dc1b2231658f6618edbda80dc64a86b92909539744d694916179f956fea40d21c674861f8d4ce77e9bf192bb06b71e3b40b12c0ee1358e73f7e6c33cb5210b344b0aa1e5994bea70c61035e33d54181f6833c0af4c15a7f9556cca217749e4afd3499ba620ad9123c07db78ff1210701e13fdca4f7fb68b96b041db765c41e440a80fb08f6a43acc0fbfd6dd940c0c64a894b6c7ed68212d2a14bc13dbd02dce343ecc3e7a6e74f9a85a9d91d3853317809e9a3fd1116930515fa5e5a5aca0d87945eb8fa14cb693c20122f88347eb638fb27783fd10715fb2d6507453712060147af6a0cf5238f746d1f84290d4b9f0ec8de9ae43f2329a03529ed3bbcf610ca7e4ff307486a668f69a6385cf99c1ef08c437493bd19a57434b756aa5024ccb7ffe7480794f380f8837f40ccf946e4846d3df052bbcd93eff1f53abfae4f0d987018c602f7c0b226d972591db7d7e766734bfca97120944f83996b17aaa578eef3e573c03ffafef3b05ab6c4a1a4cb80265f0223a93e56c1795f414876aa314adbd99bde1a4c3bf4a1b315067192de1875f8935865df3db2488303efc9f3dbb3fa9e89f42466bf2d77d6cc350affb5b6019de94b3236d634fcdfe6f7bd30c6afcdfd3746dff6d1660a3fbc6c5ca82946bf99531b895d89b4ea00124ab5c888e707e29c5c9f643926807b709cf713a5e5b9525dcccadf6459e7c49485f2ba171fe7c656a02d5ba0be489074626d4221f57a2d82f587acf0f8fc1ac034439e56b38ca8af78e7e203d56d6e80953b9508fcee95c5bbd372c5a003665d86335ea445c1b5a6a3b86b9de25719d602fb9293a56994ea4e4b94ebd6ea88eb74fd2c2ae0b2a11a60b15de39eeb4118ebe3f7d31e6b4cbcaa6c000a4f53345ff80547898fbdca861ca1d64f2a57381df6cd11a9c4934d922afa46f908acbffad1c156940202775ab38dffdc099964557ef12a94353be80111ad13fdeeeac4da3c8c0f73605a0f41eb8cad611efec270c9dc67f8189971b35bd72cda841ed2ba4bff5f3409e4a400764c90bf762f7d51c347a1721377557de4f637cf1bd112cad017f81c24f31957ed09a06b645a189a060f612f8f0667e7d7594c2740facc5c91b6fd061064643c093b4db2086b3aade17cccbca64a31ca10d225a4daf7422d1a4f176f67c5c15a0fef9719fd47107ddff7245d3d1eaf4692543f6d05c9d198c8619365a8c9e2ba08d75421def55e879553f430a553c40ce20c5ccb89e3a5cefc37cfab1cc3c9da9c2d9f31e50004ab3c0092ce6cf6d694857fce796e2194b2e5e53bd5788d0053d0ecbf1d04964ea46e2eb59b9c27bd7ab0eba2c279ff9b0343c549541ec364e45200c82711e8bdedecb14881ae2ae6b4c2e431d29d52ef2468391cd56ea18035159ba797cabd1aa50f9c7c0907f19a2c0164f3db12e43e4b52dff996670536c371c76a243f6a5c31ff49e5a65e39ef77c7f08d76f056cf03cc0bea9be7288f1974ea832f93bc3ccbc94900b12a1211996145a30079f35c2ee7e309aca89b76fd5c60e64748f11da9266e0425b907f5d105234d8e67a050689ce33e17a938f77d6de66d9310bf721c67a2c5ac1720b1df6b50bd9138e314a8fc79df523d7256e5a7a2bd7fa16ff14cb2b7f74e40621cbf11101b92ccda603f975c0c74f63c914d658f842fe1cd2044f10efb2da6fea395473d6ffcc2e36d85c28f08562d7a1eb69e1a83af9a041e0a8cd3e10bfe7959a959f0d635cfcd5272860139289d21949863db596c1520a27fdb390e963f2bb9b7e3f08515143285ead2e274adcf006c38e6a70ea23598d5d71c9ae32a95af705e20e3563d22db4406aafa8d244fcfba6b7582931cfabb35603cbbe58e838d45c1534fad98021209d5fe208d45b6e123e8091d0178c5b2b5e903ee5b7231f9bd5afcb1589ce6f86ccc40ba9dd56d73b71551a30ef17a03df3e8eb921250f29962cb31ec7bb0bceddecfa371ae95259dabae78309875890e25f98ab1b876b9b12962efd00c614dcc1a3eb785c96f872b4297f17c959aea888a11e3498291eb1ee67471b32796764d5e160dfcdce715f10237f8352594b623e209764b03af1f072286cf65c1415e0fdae54318ceea70095ce9ba9615fa421bb17b2116dc8ec70fc406a53647adfdcb3d1e6af56909aa15e2a9d222e542296a20e5ffbcdfcb48a5efd3328a92763235ef8b9b3cc62c6d51a01c4c8c0eeea37f51d41b9ae5c543e7208c29f9dc80ccbff20b21f5c7978bc9f2de46c268973de0a78491cb90d419ee4d7cb93c156ff1092f3db7e4089657fecb751320ea2756d8b3bce8c531b2502fbb8b0714cd65fb35baa1985155579d6933b8a1c56e43f956d22d148fdad235a99435cbf934cd85505d2c3e9865e6388ce076e3788dfaf337ee8d70531ff1c84842f2228ad819eb77882f07a528e60b7c7de6ca93fdc1227a99f871bc35b5747a475e14fc99d7d33f2bf3665995151e6874c54619779b652c2b00c95c67b8b034f156022cc356106a6b161f567881bfa7f37d7199298a23ec123af36b9ed43c4b5bd865447414943135ec8a6a405abe956dba8f3cb797e372eb551802639d2ce35e6acc796b693bcc554eb87f1d1d6d3a70afeb0c2a7f56e2239bf429358afec5e59fd70325168bc4a115f1256d943618e711bcc500dfe91e215e47b23d86fa76a6f81d5a93780a6aec39dfd0ef5cdd107b8a0843a6531d9dc9f76dbdf0f443e1dc3b9f94c6091930bd8544656d55040282af2a45b60b41ed5c440f6174d8b877b262fa2a10ed0b04f5df92d7c7c6c67c8720d09575c8eff894378382c5c2ac05aea11dfa7986dae291edf5e512c160b6ece4f02f83ade2118e7f94e4f3e0c1c743f4982e829d6ccfdc92f361272b2cc2a53faf6c821da163ab8839ea6b758440d34a3bdb5de3fc40b8b77ba8dbddf59adbd20e50609ca964c32884a766b88f761f74ae404a2c7f05774443576cce406317717c90c66998bd4018d8c49e496540bc7723fe124150ee9fafe1c8cffc3e7b2a45a002179774e0dcfccd5b9b6826b5b7f02a8c56b57de89045599c2f1b065de954504414dc9db1a3f08141850adf739064efe6b802976fd47ade28079f968b5721fc00f9f2ae0fdd11109361253538dc03bc195aacd00dfa49a58d764b5ee75c1565528f1bd387fd5aba719710d95c044bf5c5f8da3c8c12f8ae5a0d3e75e6c9827773228c33768dae95c5cd123bb0c2daf36c22a65e3e942246aadadb9c0f93641ac43e899f2b42d5218256ffd686ae0b7123cbda30ba8019f68cd7328872e680e13f49e0a893a41f43d4c030f0b38c8922def3f5e4cc2e286d93da461247b07681927a3f49a1423e5f32fcece05c017cb1ae8bfea95fed2e8fedc908179fcc0f62c1dd04cedb2f65658eaa200310378767a1b5509a7c7020f7555e2204b5dec97743c3a4beba427ac914ac0e818f47db7daf55c6d1e010860e9199c8dd1656c0004a7b06ea07c574e80d45e5c9de75a17eecfd15b43f50bda263b8e4271d7ebcc93d42a372b2a4dc1da50c4aced7bf34853e260135dd5601ceee6d3eb70836104e4d862471d2dba8252351a6efff4f008d0802e98b0548beb8e727f17dd6c70a8dbaa5d84fbf0242b7f16913bf01ba040a4e8276d063d5f30acaee2b618c8c46f7c2a5220830bc3051af583ff527ae45d73ec3055786f9091ed4c8f60890f2c6c539d45c0f2f2778f11ec6ee1a4b747176c391c50fdd6730a87ce711bf750946f57f29e5fc19019a62a0537557b663291395ec5d5345bed0e4401be09bbb74e28beb63e63e058c4fd4b7228865ea694b45014cafe1faa5b1c1c852284807eb623653fcf288d167c9f3fad1d6f26d9ae2b48fb7688b30455b5de516ac854df1f0f3ad5dc21137ea0ab8905ebc337bf5f3dca6a15758410d05a5c003abc39de816f4d401477dc6481ef60b86f3fee142979053f72a810c92ae0890150b73e77994ae182f8e53ee92057f3765bc0e58611d9634c17b75f0b6b5d1545fc2649e6075836492f23c3515b6dfc8dd523f4e2a6dd140d081e4f90c0d8634fb0613afa4b02e7992894f97b92c269ab3221b556072d01837febb8ccb234d2f2178871c1e8db80f05af5c22548563b9637aa0fea6664985fb4297384a4688d3e492ff5be0fc2d6df26f6781a1f763be61ead1c91e1bf02a1d370d9ca356782f67d83081ec64e20febb798897f3765b81f97a17e6b63160b31f5d255892934dafc623792727a59fdc33fa96fa245a1e83d2d9a6bd10b36cd6aa50ced43d822f4059c887a9c0d94ee93b1bb86ecf448992ccd88da9f11e367e62889f387a6e5dd68d59fb4174dd00563118196e07f38c5bd65f28ca5c9f0f8bfc5ca953c569446927d9738bf7d20efa7a0b3179d27d6924c8c0cd3ce7d2d2584ea3ac5dd5b9a51a55582c26d402f8d606f1f5707603a541349d0938392a766da6c126cc94c004c02862a68b8fae1dccc6fe53a177065fb601f82d0a54f7cde334162093e8738343cf418024e92a6ac847794cdad68166f52946359c15e90d9124e8057025fc3c2430696cc859e815f3762893d4cafcb8b2dbc936d0124d78290e990d2d97a47dd0f8197e2adac814f8fd4938e9232d87c8e0dcf06d3ad0a6d84ac1d1a68e44d2cdc382d0b6f8cf91e0f71aa9c47dca6beef80a0594d4b8b593fbed0847f6f6a1e750d9e3227c5730074ea9d2ca961d3b377fcecdb2ffb4c2423e959a8b33d531ace9a74f836ef2665dea8af52e050508148ce1d58e5f484e5253caca7114b0bb2cb9ecde238527a23d180019a263bf3e45c8575c4bf03b5597d000c0ca36419b93fc5cef2a20b923d47932b26c82f741bfdea84b5d9f613f2746cf06fec58500d56562c922d5c4a3f870a1dc47d122706b5673b32e20b85c6ada51a6582698a0795b586c6a39b7286234e3918e7c6f377a9bb4e30156e65e7348c9fd864a3cb3aef10c5922506d5e8714f3a9404fb47ffd8af076082bbc4e016f8a405b80ab7ffc038c5a1ba2da15e4a7f12673874b97fc996e0e56ed58348c85637c65dc31477a34a43439a3ea13d98eac5a98bd652cf0d69eb13bdc02e4a3da37cc3769b831ac27394b80709335688967dd0aded0d9650708d00ec75e70969bda01f0adf1132cc970de1ad59cfa21689c42e84bbfb8e5a193a0be3f110266dcf7068a9b2de42cd4d57c48f7b4f4ad05a602ed294aa2cce592b36072ccdf820de27b7b5c31c9118e0f7d6bbf627b4e70d0909d97907974f60494ff2bf0cf3eb7a906d2f1ba8cfbedfe82a47db10e94c54ab2c4f6a2be67ef07e43a6eaf6ce1ff147bc8b42054dce9c033ff273d03bcb2f8a27717de2cd5dbe829ec138c9f2b286e2fc6e22d29ce9c2a1eb0d86be61f67d7ce7a96be28bc3a92f252b19cb53cd52222a490155acf1986e87848287693d94051c0ecd3b8ce3c1f99bb1b47af773e65b79c8b7ff01391415dd707b074c055c160803cbbf7c4f708706120cf56f0458882d94ad935b8567ce37400027dc9442767af874ab46faad5b3d33874cc9b6cb97fb4ff79e0d9c4edfdffc12de5c68e89eb9b749af5707c0b4058892ccf7dd3d4c9b011e075e74e9421691181890daa9189ec3c76a9d84a39002e01390e1a05a1f22888e226a24320630a150caac8291d7ccef74164150c30e189df1bef85f91e5def75bd0cce1ce12c4bccf9bf5ffa4bed4a680c4752b1fce6d65772f993f666b151afcb664a38df44bb15e7dff450d414a1d32dc3afd8f84a98046d790c1ca66e377a78a852442bec3a742f831920d6aed2ffc8af45e83859ab4aa4fc2ff7356b8e7294166a11cd898c18e4c45a4ab7f8ca0e16833a9e2147f208adc1338f6b594db9485864d469d77742f295fd35b923a60a56d658730ccf3cb13143b44234c3ec18e504bb5a577150079d0b922a88112a16915c103b8910f877c53332df509bbda56d65eafaa0b0a161b95f95ab06de8ab3be82d2a39100c53332cd66e46132e0342101c1e888149d5bed9a48a3fabb6e970b75e2d8b59445848285a0343c18e4316b134e764b9fbb6a1b71a63cb1d00f4adf8da859b7f660087e1e6dedb0717ae63bf712a709b2a6a1c43fa4d79e1c6a5345227e5206ce59ae14b8295637acd513a3ab0288d26119b92174ede67e7e4cd9c6db27e80399f24245bcabec0850c73f89985b97bc3445cedf4381651473dd07b9dae0766fd9ea29bf290d243492c94dbea4a4e221b30389c9d0e5877adc009b3f279de8fd742aa9ef7906ecb160aa4a8a6456919d73a92814946886502c67e26cb93119178795fa3bfdf3f92a1ebdcec4c070cc28f8a3c55d6e5b017fd75108f3f4570a0b331df6dee864d6826f3a1d71c0dc1b48dd381616fc219274ced3113e7378e8e5abf2ddf8ad6b827c985fe667f142bd177d2d43de878442376c55d5835e34e2e8b94d7e91026fae77b11fe35f4cf1ec91ab0fb4450a967c638fff30cd92dab76ae59c82cbc7887b42018ca8a0d191599267e68ab772ad4312c44fbc5c11a118fc4b5052cde7a03622a87006591b5c7f3e43dfd9e742f0db82bdaeff6f3805c7a220702214a486ed09b6d1f0f40827046b35118a0254de875ff7a62fcb34beb9b98c9359358c25e8accad7dad8925652306403a49d5e3fd8df29462cfe16fffec157a889a2233e384887fd7b57605a9647b1bd5f0d067a63d31f41239f7082134817ce179604360490dd08db8ad057c1ef0fbbdc3f1f4e69623c1e2f2f1930706f3d54ca2b0e10248751f242186519a26adc41eb84a6fd5f41b295ba30625188f176f17ff1bd3bd0512d5f6699d276493f1e752d067dde2a5266cae60bc11d4115ed42db8d766e506ff0b8fad4ea810570cb7f34e7732d2a6573cce020f8bae37e3e7360b742fa9ab2d6a04e26bf0b1f13a82bfa412e1a546af686cae5bdc0ff24a9b3798ba31cbc76d8e381107480fe752a2a1d164b78fd508420cb6e245fd5229dd451d23a0c0f826c27380b467c80f7b193fae8303d2421f19abda8c2021d1de4c54a8e419536834920180e9c2c9402bf7991fda718667abd14895c8e6cabb0aef0aef26698d1265630bb4475734a46cf0f8648b22d67e229dd235c7ef7bd82539bbc50fa03f3a542be83155c196b70930baaccd072d5487d81b005dff1fdceb56af188cd458b9c7fe572434f381252811ebd641f1a16a3a5c7752f03cf64df4c42a664982bfd40d52403d52ca436b8aab7ba8154159d990882ebe28c0a99eca448f1128b892460e06fc1e5d85a6f70396cf1f1e5394d19e0ea702e1c79d21ff6e02aea568c5651854831bfddc09a6f9170cf60f963c88f2176b728ae0a6c9cbd35e97e7e1c9c462950a52b273f4f500ee3907c409e61afe5254fffd37d9a07dc9b3e1e46232d2e50f333b0b1723e86b5fa80649d6c7486d73f5d6d81a729d80dc60fdd6b0e2c226390b1291c2ad1a207479ff3031f3c1ac9cd5e1caf51dc7f0518b517fbc79648caf76a5afec4b1f9c6b82e34c5f10444b18385022d2535d2afe8012aedcadd7da3cf57f5694f7898d5b5e38e7c0e567edf49ab653fedb2a3c0ed001b9c4e8ac14025b24e9d4f1820f7776fa22b92d4a2d7846b3a1a27932ae8a3b66f15c94703c7a0e74169a1e7b0f1b67429d28fffb84a237b6b9d32a795d3a09aa6c4f54e3f26f5266a119616934c2411ca7343c98af31c3e117d7afd039d5e4fb5977ebb1953a8da4260a08330dc379cb6e3319a9c248f4c9416f0e71afaca52565d48cfe3f20be4aed8ae04476ece06277c379a909661e9205e248eb1b3185163d408fa2697d2a63d507474e4c72d39ef9d03123951aaf49e07f52853b26d553f8aba221ec03718a3dba9e58f6c2e08a2fdfa0c9c1d3d0f2cda4f90c86b1a37709b3c114759c18fe6cd820421516c8e38e367113e2117d87c5f50db379a9afd23c6f1ec811a4dfd5caea8e905e145ebfd8c93f6dcd7787a473944a49374e46873b37d1fb1f13d6a180cecdb651fc00779c02ac7167339f5e4d5a2f4c314486c39fbbfb9345d5a4597351170dfedd06a7f395a21f4f05037ceb19aee91e431aa3dfba32a82a0b332f55842ef87090e2a35d65547930e6941b7edc7686549b4cf86d0860a9c9744576566c67088e640ab6bfdaaba85928597bf1e68246e0f759189de7aca436ecc4ba009969e1e99c6d11fa35d80e1e91b3a17c28b3761913a2164a24eb91c8b094b3c8d63273cc45e3221fbdbd8bf08317f4b10e7b4c18fad74f1b7ef90cd739674f6179bbfaecb9d9ae6eda3a9919d5693526593beee1546a5ecff45cd5e22df4e53ade6a972681216eb56b3720c31f411131cf9748c2411b5d25ac4b997954e8511dcea623bddb408bbd2d4d469c5f3b1a663af13eb7b9f37d2ad6f05303f1b41ed1cd0cb1899060aaaf72e04382b3409449bd776202de58ddc56d22a9ec4474c29640a32935098b6e4de25845bac68215b9348df2d5e11c8a4568d28f790db07bf5e7bb66720c890cebd2dd18f213d01588d0fee75c32461aa22671033c645f463c05a5990791fef282a86aa2589a762eda61deea0150d08aa0f1dd264261d12228bec4ee4eea49efec984dc88047568a0e5ed8deb3096fac8822b141c9209e0c838670a022e23151ff237b0b4f07a2910b8c3d80704ba1c38d4e62e10770d52e431e3d2ae9754b85e2c6df19b126fa93c4e95823af95ffdfac81f8438c8518bd3fe20e691ba23c93a63bcae4320784f75ad445ecae0920af77d4da9273fd50a38c13492c2e8e29346d63c815159d90b9e970d98f2513a078d637a6c95c50fbad7f09e7c0bda1e520b69eeb8c72edb113c75309c8a4552d4ba47d79c3ffd857e992b007d759a866e2e324d1148c9cbd811d5598224bdd31ff117e26e9da0ff312c91f67bf47296a078e1adfec3e5f9b997a34261f3306859026dd79f5ced4c2a83b7df176f7441a37d3a66807b9aa0664287c974164d05460b8dc998182c895ae5854f2e29840e907ecad457160dc0c67dc492b98f96c41b0ba1af81f41a9085672b413be7baf6cc35fb0b4b613b829d3892d1abda97a64613b4a54fa7ba885745d568ca5ffa36c1fdbb2f877a07fa34609e7163dd77ef7c908729ee64d200e004ceff9a26f57b5c10df3cadb0c4871acceecc42cadff991e740798dbd8b691c9f9e45e24d0b20aaebfdd8993e043c740f8ef8b00e2ef2acc91bad8faf7a73ff80b686c4dcd8c5764f3c1858ec19d65faa61df1cf9367cc05cb61473a6fb865f169de7096ae126fa2ae6410e77961512f6f02d5f7da099306dd20cbe2149f4a7861a45aba4ba4f6b050ca5b3d3c89cacfe6eab26de3277250e02c6c96a3c19a131f1a2e9e6249f14d341f07f696fdd8340e9359b6f1886d70bbd6f75358637ed9c641938d840f9d2ef9a983355fe3ab1cf05fc537beb002eba71bf647043ab461478e63d78fb4e48cbe3d95b1a35e7e17d2986490885f19c28339ea0f0854ccaf95486f0a0b8e58937ea1fd90502d5f43c9ab8932d003eae8bab6601e80b280afd7bd3a5b88a9ef1270023636ee92fea5d375f729a73483d4f283f35e9a77241f8804f069ba425d5abdbe9437ebc4f68dfeb828990fb293d45114e24033afd336510d43b12d8d88991a169a9177c117a6cd61b000eb36df3466a2d76dfa3c9524eb793ec78b85bc3e36ace3604b75f95dc52ac7eb20194fd0041dac5f6b2716b9c19a5a493c979f4637aa538bb23716909c84a829d1b63c19a145bad9ab5c1277a53de6eb02c495242a582440f91b98244d20a4166e2cbf42021f7934af5b649e89e230bf1eb3b74052dd43864a6d5323f8a55487fc2f729fcf457ac8cd2395522f0c5ac2ccf306ae1ac1e2cd1feca2d3a5bd1cf6c0f73ee542a00d501a316131a37f5993e53671f79389b8bfa1cddcddfca4cf63f3823c9badb716a9cbf333fa0c8fefd90e5579fabc0ed54cdbb263babc101b425d9f932d7df33ea25aeab568338ddac6c74f82f69c89b3179b408c3cebe199df64a3ec6a70a177c073cb950b4c75d0bafccf9f2207ad34872aff7e448adafa39ee0bc5453df9b737a6e51b73064292cf450e4aea90ebd2e6af21691843fef5f44e360b7a18a71804226644f4a4c4d5c531c5ca558950b5d4de8b3dca944e1ede2baea0ccbcb4e7b8a7e37199113ba358240948e4f1b3a020b29e350a4b03301841d7601fa61a703d67e17b2d2e0128ba66c3f1dba844d960fc3f06b81278e157c9873974210a6484ced1049c20a22ac0aeda04ec2919d1ec92f7fab111723e51d845788eac8cb918ff51940ab411769ab2d2358f1b3a37b53f336dde257955d22a7612443f312dfbb51becb4a1b3a1569a6c17192421676cc51496194cd6c409ceb7066739bec0f14e0525f55791c035118ec3a0a5fea6dae31c5f066cc60281d596ea5c19e768cc418e863274520f73350532b2948d4d0b892686bb3271e9afd8dbf8e66965d4316a64e8528a35b4fb41bfb90b14ba07310b3317c8b5317fd599484d2e4d8f3973282436b9b78b746ebd64339fd4e9937eaea23fa7a3c1e8c8c875e088790247b71d5982eda810666890ca4195d924af750b0fd7878467268003c8acd76a30f50dba1e969b860700e30a271d4163990866ffc4da02b17f77c68f90f61818337d852e7d2a7631149e83b3f5ee75019aec0729a18d1466b02347740975f73e73e185ac7eec65905ec2356a1cc03fef98fb1f02308f6719de9ce32ca96c179e215998dbab9a9e9a23c497ce7c87518e530e0349642de2a5772fcb62d84dcb1e5d035d4192c6f5c02f5a061a214cb664d9d6528f462b760a6fb07e010aee4cafc61265d00779d36fe4daaadf83f2a37d6a98d4510d5af1456c36d9a9fd5fe4ba86e9f78e19e36eeba7253842f8ef15d4b889a5b459ef214af1e6fe794ea87f8a639a11b6c5fa7472167f07282008d5681a59dfd0bebb8b2482c3245830b60928f9a34b8f420fb69c26e8f7aa4f9a5a64fc6802a662f13658c7a09976cb6912d825d227e7775f2fe1ad7656b700e414131d43e8d575142c8001b2f22d0ccc09174afcb9e842a8323fec80f57c3626af30c318e413b6541d81a5498c8e220cac76590e71f0acd7f83d7668df691e1f25dbbf72d8a25c429db439f0bd7fcedcb9a6a4675e4394e58cd22d2cce854549f9e9da8288d189d99b94dba186411fff2e9dde7c4f6f184b2c6d55961e25b46610bc82c75b3b21d70e8ed053e4e1e6baa52e0880581447e57bf1fbdbb81b6644af1d6cc490316421995099980daa84cea3edbfdf2e2f0a6d59bbfa02318f54aa8d5d073dc5afffda099c9446da53ebc15cfd3d7399d3689d82adabbe2976a2d559801b76286c538dfff04b774bdd22edf990484551df243aeb52bba0a05fdd313742ce4bf16e6ca87e64a82902333c31f7cbf68413458054e63677be2354f6ee5c90bf402e5a3bbfe4d1c5fab2251494afe2c9af4e69a74e41a200f35b66b5af882fed509a4ef43d22a33a4f5cc7dc82d4498475bfa416d72f4cc06a17136e52c66410a11950d5ccd8f63dcf13cc6b337a48704957c4d806d49408364c0f29847745d1d632692d65f51658ad18b63162bdb7f0de394b8b9f23c6c06fa9a1082e2d7f94ab5a881716a656e701d7aa5f9eea4a090b8c855de77cb48223a8918fa1b2ba20875366083fc74469af155f23834cbc08c1bc97cfdcf56eafb3fc45ed2d1c387285bd2262741caca22c5da0db6b9bd4f33c9916314ab6af5f5c2167f4164cbb55b3024a6baa1e1a3b4e28eefb215057ea82c4e7075ba169b727b39fb5f95a558231fb20f5d9540007ea7dcc5b85840a5ca357c9b101d944dda3ffe9f911a2d6d40ca51911f792ea5d0081f05b9f541969530a92decd21fa86930a94f7827a70adedf9e3916ffd650e77c166e7984d9d98593193808e05c0079103561cfa67609de42b0e67e169b93a0697be9b3d3c0010e002c22c100b40089258907ce0dd986fb89370c755d8bf4ca2b20a94efacb3d42fff3a957e3a04bcdafa4566d03cff7c4dd1f8f10bb3d2599d7f5499d6f9cf356e4dd664e560a1bc74d7e0d804f5a1897c19942a6998c8fdb26f056dea2ccd3c8e20c8910b0ca414776f627f6bdce71ca3639c051d87a1ab2ac1106b7bcb040dd52de07771428345b73be121d404c1fcc9a378ce52b7aab51000ab65d4a1c0087fc3c79ba565dcc46426295b543e879c7192905e4df5d90c10aeac9a881d4a7b4ed7f042db57111cb653484cef83e315000efcdad0096ff4c0ab89f3fd83bc02577203b69444b2cecc3d80315640e71c214472f88bcda790f728da8d060fdbf980db48e3b156aa7c46ecf22c774d21d43b877d93d4e2030941b400eed078eaa8f6d263241554d0ce72a86e502b91e6bc4b6eb75d8a50ed042cb5254f9e31a13098cb0fe604d98fe4b80c5234350944afa09c7e6b971bb54c36ded02bce1583f126d5a14614dd0a56a7e9553b4b3fe47ab052cfc2af5d5482c0743de05c478cd6199b3354ab0937b57f89e831bc8d5171a8ac04b1c431dfd164dc99f75b9baed68959dbbc2f94cf1db2196e86aea30789360e0b75b28eb6df7128af6b454f0bff3d974c24643ced978ae76c4ca5b9c12528ee53c1a9650ace01c89d56f706278c18c8174ce733b0b8ec6669de5a683339383983d9f187a26a9aa4ec1b6cadbaca0e53a5d0919fc7ba9398581046cef280ebc7643ace064aea77681c45f8e2baf925a06a4c8407fcbb04b47feb3334082f6e227d3b86fda5a06113770b967b89836f702cc6b832ccb010703c8d14afaab414e58867a5523decd5f5cdbc7f5900f9d6bdc6e3fcdd7f3e52505afff58a5d9accf192f15f79044a5533c3d72ed95d44dfa7d33602ceca27fa82169c4b4cbda4d40373b8a3b8b6b26e6fdb9a1b39cc950e338c9f1b99bf507c20bf2a933147c764dc1456f42e9638963065e28793756a14fc4b902878a86590a967e10a2c49834df8ab812375caa6e4c6d9b9189ba33271a4b9893911aed111369c0f6f7ac91ec4683dd44edcc6426726554c05e319a5025a0e5d9a0136c657d2725f70d5f12ec15762760e96aa239ea681fd6d7549f9e7dfd40e43aacb5030bbaf665fc73fb5a8441ca37a3e66c625a1cbf376ed552396e31d8470fcdf56d488f32661fc0205417b56ab6c3ed53c1bb3b89e3e20d4513c31d05adf644947168707e168c0de71ee0eb2bed7366bd538d1278dc1928a19d4ef0d7d8c7375a2798f88780a6e4daab5c76908960fb242fdcd0b2d77ee2c3be38a627e08a465194d306e05800ad3b88cf2ec92054ae5364d311b57a8f234e4eba9f584711dcbdd5b94401e2ac7d600a037d96c04497607e76ced4e6eafb7931f5258ec964690cda8fab8811df32f835b1becc35bc934b717e31e4046094c427b7c4228a3815a19e15f644f271919ac925b63d2bc1eeb5a4f89d7bf8931eb83be0b051de83691ca4152d0928fcfc0236200e4fe6c41130c0ce77a91eb5bf728819f2537eb4642f3912ad73ef16111aab187be1f870af3c780d598997f87f23da7ef2d54394c5f9b2b0c203c27cc9a17c77bfd495c956df17e6c9161d194211c882c5042db27e37a2a7f20d45c337f02595304c8ab35a6ff3c9ed99b02e4225af7d9e01e66238d7e610bb2ca7777f752b64be47b5e2aa787f0231d32ecd2ae4c0841deb51a0a6d2688f1082d9e84c81dcb047c99d7b45d4712ccc8b6f15643e8f4a5e2b3cfb3dbacd4d1772b53a4e6f75739580b2c79772b618a31bbbea144e5de0f74484bfb398ff6376fd5a55e95dbaf9d97a44f6ed8c9246c28f7e2257da774d25abe62dd814bd43549df6c40c75466740c233e21a98831956b6abc6029194a90c4a2a51980d59f216e43542b865841f770fd0eecdf2e3a7dd131815fb08539b9927650885b6b2bdab3e1750b68483c99f4e7a9f78ece593862ae287a14797163dac7c89951e186d4271c0e4f4638ff7bf1cce437dbf8a673af711afd00ab73bc474fcc4e16e673b3ff3be613b91db6c502f51091b575d3986bf7800c6f8dfd1a58c94877c3daa07b5d9f38eaca17554f6b5e14e1dccfefc9eb4a6fa27ac348af649034d3f9364418ec091f6f2cb6ad47c3f90348244fbcc456ef87f3786a9d97222dd43c20ada8169f5365e2a09022aa8945bd40559f080665469430969575827a631c783a01c372972a9b5d487c8d18c1373a87be59dd678b203fcb4633f2f4efcef1c5737d8ac09b2e6313efa4b2b702bbb3ed7ebbb52cb89fa2a44f4bc2c22cea67fb1ee4830d0a170b91fa09f97889bc27df103955cdb8e51a103c4815879c8da807b3a1c1897a243907fa74cf0e6b2423eaafc7b10ee7e8d7a21854f81d5b804ba765e898c07b4e7340fa357e2c26e77f30204faa987ee1e7e4e3e00f1c2ae80d4f95b7daf6fba1d0ed52c153d60f7adeb3b9dbb2c210c97f552ea39a51d3a3a7baecffe68799975da5b3c25da19d7bab392a92b81d252843bd9ed1048f84a7cd1b115ae8bcdaf754828f1e0e9bff1a20092504c48b178486a064209a9ce1151ff958e9cc8d0e58e8c6e6c8918d36e7b1caec1d82fab5bb830c7f0153b0a720bd2fa2def3d31cb126b28db731fdbf40727f6d46f286e643faa37cd0cdc68f531d7f3d063fe8b8c5cf2cf27fe8e20872cc9cc50e4dd719d7834153a0df39794eefd03a2b22cddb7c6ef3bb5b8a30f476c98c0f1945b76b305964bb31def33949b672c9a7a9038e4481ba23a748a842749e37dd4031e293b1a7217a366b250b9082e53b477c40b8c53ba4b9610dc3c0edd2b77dd3681f25d68e2731c9b7f225d6b96cbb50fabc0ed9bde6d79b96f7d2ed1af28ca47dbeac80ac0c9ecdc77e1e24d5b01a6147b88e1ed4e95c6c7213b31541b4524a1895a8409bd05caf92e77a953795aa7952024150c36cf70d88447b406637979c9250bb803959799d47b7363f765eb0603f82d16a10e4bc0e51ed723e2538c08e892c08ab3c18fe155bf3cc4b5b4ca6d308a3ae43b37c7d9eb2575ebf7d50ab52edbacd10dfdda38702afccac5104d79bd1d60a1d3d4b12496dddbadf0306bc2d5b3c2c16202302ad3f1a76af7affebaa74476a972986162a4e0b76325e8432b23e19d8efefe2fc83f3cc72e575a13efafeb12541258b18a8b3a5f12de01edd3487cfd0b0a0ce9d265fc8b920e314a4cf87d876d5f6dbb4f605859cadfc74c9dbda284aa53be330dc35a6aa944ac04a5a95ae9400f2fdc73b88fbaa7ee3306367d6296a2927ca3debba1a6fe683732da4f15adc181684eccbbf362379e2b166a8ca1be0ec0875f2c1edfec144770feff09c37f176abceabb1ef8b41de164e0a136e9dabf97350c1a3ed85c8af1d0c36044382670b1f33cd0f0053f7873d958fabf55897c78ace8e4a2ccbf5de06c376b4940a6558fdb6439ec2947e008b02860d6e7cb2e86c113c182d27f6dbd6a7d50f3a16a59690ccbd71d82e9272a459331ebe69e813965848751f3593ed643739f2896151a728fdd9028b75452c21b78be1d3bf02a1ee40236228ed41d378199da30b98c05c27f4986d31034d9a5ad94f541f8ea4c5fd6a6289df3132da23330dfbcf9d64da132cb04b3d14de439c8506486a17e6a99a50a7be4f8d9c8fb21ccbe1d7db2e3bbd15f7d835b9dd085e5a33ea6c5520b5847e41725d56a86228cf8a52731b6f35fdc2c03dab9cab11d0d313c765f15b9945241b14f0339ab3073f26fd3fe427de9c6e76d405f93e97e56369f7f6d1fccc1c1f8dab9a384902dfeeb2119797f898d99869b999fef93270ae4e2009ad8b363d4b0a562052f8b273d75538766bf9ae696dd2caca6f48ec6c0827dbee2a429d04ce5ba2d5aca9b25cd03ccba02c10c2daea835f5a088e6cf7a5ce06725eceb4b6b052048bd9400dc436496cc3da083119d2eeab9f8d334dd58828059b3fc0df34e0f492008d59dc60f4c403ce88bec31e71a5d6550d47f58f475ad5c183afa9bd0c4486192c9bf255950b6fcbc255dbb8c588c8b4191c7cf30d021a69b9a51f722612c93631ebfe5effdcad0989d082d36a4c98771c85bd9609c055e1209df388836e8237c7a12fde7bc631968cee25784e5da6079f7a286283dd31eb5e4b7d3829fdedf7b51a3e9617219da9cf77d0c5e0078d5f3392850434389ffb56cc32e9fc3414124c454ef81bfc3ca1e780cfe3e81082fbcb2525156aae6f11e906b3bbb130f7a741a03868e7c5bfb39e29947b52245cb666a9ec130784618d7526dda7f9aad0d1bf798d3d1beaf9c31d95fb0d1d232f1b4503f6ce452c7040ad4e48f30d63d6fa24ef7a7dfe76507a779d4f5aba56bab656543b6267904fa7e8fb881399004de1a986c2dd501b8f837c02fafba47161f328ae43e29338b2c6f97fb220a6b8cbd2805ab0558e5814a209688270bd6d4ba06afa4d0c5699f0f2208cacf18f1a9756abd6c817c3ff3bb70a5f4c4c75121d971326ed154910839b94e19f23e78f5ba6a17429eb9710cdf0fdb7dc82e1d36b5dec80b532f07d62b248544ea4439cd4d1b1432c36ab272cb78df6160842150d028317239b556602c769d36014a5bb29c8b07d04432eef5f41d83b77c02c3596aa8fbf2fe33433e6f7c9aa3f0f5a7d13a34d5a61d064ef7af88ec11dc51da3439b1f14a9a00512b55509e2e77552fd56e3e6fc17e81534eb4970a2b708450ff957cb67f46fb7ed58c3c5a2643df1253902756d32fd4dd4454a6c28f3ba378afa0b9b7f6a0436f5b406b30441c804ab7723e8fd93d74009e7ba91798f1dfc3f4dd595e344149441ebe97dffbf478c9f2edfd04f3af155e27d1e00fba791572d093ac88087e6cec0c0989bab7ede3f7ed074b30847d4cd9b6f31b7b72e2cdabde37a51736bd182f5386149fb80b9e763e6851d1f993a812b2f08114c363abf2059014b5d14122b4ac65be94dffce88b9bbd125adebafafed689bd0511266dfb60dcb6a2a3623caa8744b60f377e79ab79913a96ea0fa8bb1f008fc71890d2e8fe50c42ad45afb18a8bb7942183a4235ffe95ec7dc7ba0c4d39264067eff6955197b8102d54028494351193ab5df7388ba39070b55f2252e43f1b21429642f0114395bc7273d4a013298b4a6615f25a4ef9610e6d0fda8339abcde1122ca986148fccee61a4d4dcd618718f82788a88cc84ee5dd63c82647c5852494aea8bb012ff15cc38b2c38afd9ca41320e4b25297c0987419653004fc1acb3cd324f6b11320a0e78d4eafd27f4eb9f89638d266c2f459cd87f1ac85627ee52ba45d0a335189418ddf7f444c58622a57f2aed52968b15216bbb3646bcb4f32b18e258b253cc9a9792d7e28e059b95b4ed81eddede110313960529fe755a71b79d21ddb690d3a72b249a665f73d78c11cffc8789428fc9e2aa6428d5ec2c794e0e06309cc5a816de6471045db414b89cd6ed61acff8be47d2adfe6120102430f783ba3b085876fff98282629cb0eb4b57ddd99101bc969c5813f8a9f4cd706844bcb3814a4f13e18895da4d05421db19049b5575dc577aa3bb119a9ad4c1d5b2ad69e5e16626ebead5223ba08d5c46cb4a0cd308038f7c523856862da19a8172b3e3f923de3477de2f4a1b62a04bce390e58c4b2325484b7a9b01577e2495e811702e58866e87e051e84dfb3aea535889ed3fac8652ecbd0a5a5016ead225d2f79d17052a8994b7b1960347d9bb04752a2d1288724677ca01a29d36bf55fbbdc0b2beeaeb2b166a8a326d3bd084d2cd893e4e970c788baa6d272c673d9cd9ac94d7160bf25de94e2f95aaff33f68db19643ff782a595de4f3b0f64c13b3fe9d6efc3260cc2c8af4f38fcf40c44fc8cde3ceb41def3c33c35b63108c71ffd3864904dea7e0433c36b4cd7cf73cc9523b72e91d1df31d37c5798cc79e3430fd585d3898c259a38acc4b3b8958095e0928cfa5180bfa31e068d55b348e68316e43a6d5e7fc5d04733a0f22d04fccea36ae61591aa9a56beeeeeac699b319b6b0a856372c7feeb653d5204f49c85120e61757ee5c40a82d5035801cb2e02b6fbd589093c6dd6aaec99f9e75fcd6bd3adb3b1ff85cf7f9648bc54e1daeaa65cde1b7bd81234be5dbc0e5481b42a389d4b35a512269a88686560137e571671ac8c444a62fcdbe03eabbdae494992eb91aedc808746c2c526848b4af27e6e106268ea0842baa5b20522eb991129cf3fa4245eb0c9d982ece9073cd26d04d6f37dd7b2fafc1edfde1b741767172b29719c7d71e801e497e1cde6d3cfb15f15dc7ce179a56be15650968a4e6a3ccf8dafcb6e7a65b4f4d4d85314673a948939fde97f7fe38c8f0cbf5aecb9cb036f0c231df9252e646c33835e43e7a076b796f52b9ea52dfe4366f0e3677f701549b3c41d7f9bb21911561f8bb851f08775d1bfb2ef87b71623310e6967a08ca6f68390876cea6b6dceaa1bd65e24612a057f1fb66487c96d2eb851fb003991d5b2996fa4676286b4be5ba492c360e192528aa99a6fe3adf4c208b6bc6b734e9094a6397fc65956513eaaf258eec9961f992ca0e49119bad9fdb19d5b29e2f5214ca64c7a22cab00f5070ce3948fc50d785a9b115cf1d8a7d00831e576e05a890a1ff3a87c2a5aca917f92aea3c832ba142df80cadc212bae413f78b335e17c414d96cc3adfde2c5bb32347fed1f65606ba4705ffbd55e3a9b9b77baeda5cc8d39368c852cbe36c389e3a7bdbcd96eae6ccd97110019f9ed98190208d204bc7f03657b4044e62ae7cf73bf3d2dc14e325308550e51f5b310534fc28a91d3a3fad8c96943df24e81ad591abdd62730a790387fe0d142e29dd8c5568e61b8016652e1b3e68542ee5a77cfd28f7e917e2a4733b0d281f3dbaf14e9bd191f7fd1d8225b414b5f61de1ade289bbea642ceefb0521a5c2abacf2058989c2b53fd119dcbc372bf0f93aa92b12bfedcaaf6ddcd5e049a196f6f76ae137bd116531c1b41dc06423dd38499b95c2301d61d44e23695fc9bb4dcb530e72138021b5536b69b47ee1c7d0e52ea6ad54ffd66f2dad9df0918bf0910366c8d507e9ba1a91b9857c0ebbbfda2e4a5f97f0b519bbd7b0d043566ef1e26250c7bbe974e5bbfcef12a95e9ff47e8d99d3c5656907e28ee8c531d0c1ab05e5eedb91f3830cc07640b9af630ec19f983c2b4ebf1920f02d777e057d2160a5d073453ddd8539c600d8c0b1869f184275a857e6deb4803f0f39a97b735413966620d41d012f45f6f2871a9d26a9806d40eaf36a2b08812ef67cb2af2febb09faa42e178e26baaed16b3e3d16e725357a72de1ac8962d3d5d41560f52f862b5b10ea94b54c28d97b95f6e6d8f9de9bfb4c0fe616348bcd16704f5c4821b3d2affc6aa609739bdf1c7291f481f644ebec64937e4596e9acbc5b3828a99c388beca470a3475f0c465a78f05bab5a374b82439012ae8761f963080d3950db18bf6afbfa1f1f1869f3be5f31a18186817ef06a8c581f2636265de1d4fd658f40409f53aa9bed68bff365d375afd658f7a07b50da5ad143f19a80e11b975a56ebc5ff136a416ff4f5734b7380fc309afb46194a7417bc1760d6042b486b6bbaf71f963fcb8409656ab748dc9c4e9eeb7210474ecb9df3c727e509d74a55e6ec46eaeb7ff4509c213a52f13dcc2053324f7638815ff873609047ef3a81ae738818d8e2ade417fc052f25d74cecde8035f86c562a91f7fb2462c407dfe6b4ccc2b5c9a705774ea45d35da21bd87db001c498c314b36e9a42e72f01e69f0d0839d5562c5e20062b0151635b14bd7e20c28b1910146187570e678dadc4d686e8dac4b88f50d5bc092e76fab0467e032bfa5cabe7ba638aaf9c3089e7d8d7ce8b5fe155a96604fdeb2d0867121990be95090ef664369f210b82db64fd493b9a2413e1ce819946bdbfb4d8cc7497c69cad793084ccd66f552e5588c1b12976dfc094bac0fec088c84c57fbc8d5af5fc612597628f96dc7c955c5fa63ccd6f0101dbe3113ab0075246ebb6e1c2177f1278c80f552a8a6250f74a021b73d30e15f3972a0aa79dbbbd75c6f0d5d159ef74433cb040ea49d43b542795dfb1b25ebcfb4239652e92efae8e18d012f7f2c8235788198e7a2d03d854f249e9b1653a6477a78f45673147edc0787359c13e4f9e21576cdf1efb72cae3fe414715a3618b0317c95f048506681fee24d45865c6fad7689405a6c90b80243fc69fa713c28514e406a91cffd0c9699e1f329faf4628b89f3fc2f560e7668daa8de0</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>harbor ä½¿ç”¨</title>
    <url>/2019/10/10/harbor-%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h4 id="days-2019-10-10"><a href="#days-2019-10-10" class="headerlink" title="days(2019-10-10)"></a>days(2019-10-10)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢æ–‡ç« ä»‹ç»äº†harborçš„éƒ¨ç½²ï¼Œä»Šå¤©ç¬¬ä¸€æ¬¡å­¦ä¹ å…¥é—¨ä½¿ç”¨ã€‚</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœåŠ¡å™¨å®‰è£…dockerä»¥åï¼Œæˆ‘ä»¬æ€ä¹ˆå§é•œåƒpushåˆ°æˆ‘ä»¬çš„ç§æœ‰ä»“åº“ï¼Œå’Œæ€ä¹ˆå§é•œåƒpullåˆ°æœ¬åœ°ï¼Œé¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šè£…å¤‡dockerç¯å¢ƒ</p><h5 id="è¿æ¥harbor"><a href="#è¿æ¥harbor" class="headerlink" title="è¿æ¥harbor"></a>è¿æ¥harbor</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker login reg.xxlaila.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Error response from daemon: Get https://172.21.16.90/v1/users/: dial tcp reg.xxlaila.cn:443: connect: connection refused</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œç¬¬ä¸€æ¬¡è¿æ¥æŠ¥é”™ï¼ŒDockerè‡ªä»1.3.Xä¹‹ådocker registryäº¤äº’é»˜è®¤ä½¿ç”¨çš„æ˜¯HTTPSï¼Œä½†æ˜¯æˆ‘ä»¬æ­å»ºç§æœ‰é•œåƒé»˜è®¤ä½¿ç”¨çš„æ˜¯HTTPæœåŠ¡ï¼Œæ‰€ä»¥ä¸ç§æœ‰é•œåƒäº¤æ—¶å‡ºç°ä»¥ä¸Šé”™è¯¯ã€‚</p><h5 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h5><ul><li><p>æ–¹æ³•ä¸€: ä¿®æ”¹æˆ–æ·»åŠ é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"insecure-registries"</span> : [<span class="string">"reg.xxlaila.cn"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é‡æ–°å¯åŠ¨dockerï¼Œå¹¶é‡æ–°ç™»å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl restart docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  docker login reg.xxlaila.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure></li><li><p>æ–¹æ³•äºŒï¼šä¿®æ”¹å¯åŠ¨æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/lib/systemd/system/docker.service  </span></span><br><span class="line">ExecStart=/usr/bin/dockerd --insecure-registry reg.xxlaila.cn <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨"><a href="#Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨" class="headerlink" title="Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨"></a>Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨</h5><p><img src="https://img.xxlaila.cn/1570697850857.jpg" alt="img"></p><h5 id="DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾"><a href="#DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾" class="headerlink" title="DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾"></a>DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                     TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/xxlaila/kxl-eureka   v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker tag docker.io/xxlaila/kxl-eureka:v2 reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/xxlaila/kxl-eureka    v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br><span class="line">reg.xxlaila.cn/kxl/kxl-eureka   v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br></pre></td></tr></table></figure><h5 id="ä¸Šä¼ é•œåƒ"><a href="#ä¸Šä¼ é•œåƒ" class="headerlink" title="ä¸Šä¼ é•œåƒ"></a>ä¸Šä¼ é•œåƒ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker push reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line">The push refers to a repository [reg.xxlaila.cn/kxl/kxl-eureka]</span><br><span class="line">f6026bf67b63: Pushed </span><br><span class="line">1489a4b0f1dd: Pushed </span><br><span class="line">2af6e035aa36: Pushed </span><br><span class="line">472cfce4528e: Pushed </span><br><span class="line">071d8bd76517: Pushed </span><br><span class="line">v2: digest: sha256:20d3bc74fdcb2fc4cdfc9066f742c828898c728f7e3f2114498ebe2848b71653 size: 1368</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1570698233987.jpg" alt="img"></p><h5 id="ä¸‹è½½é•œåƒ"><a href="#ä¸‹è½½é•œåƒ" class="headerlink" title="ä¸‹è½½é•œåƒ"></a>ä¸‹è½½é•œåƒ</h5><ul><li><p>åˆ é™¤æœ¬åœ°é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker rmi reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker rmi docker.io/xxlaila/kxl-eureka:v2</span></span><br></pre></td></tr></table></figure></li><li><p>ä¸‹è½½harborä¸Šçš„é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker pull reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line">Trying to pull repository reg.xxlaila.cn/kxl/kxl-eureka ... </span><br><span class="line">v2: Pulling from reg.xxlaila.cn/kxl/kxl-eureka</span><br><span class="line">a02a4930cb5d: Pull complete </span><br><span class="line">6ea3dcbee0db: Extracting [==================================================&gt;]  81.4 MB/81.4 MB</span><br><span class="line">6ea3dcbee0db: Pull complete </span><br><span class="line">c423a7a79cc1: Pull complete </span><br><span class="line">7418081934c1: Pull complete </span><br><span class="line">f89b73853622: Pull complete </span><br><span class="line">Digest: sha256:20d3bc74fdcb2fc4cdfc9066f742c828898c728f7e3f2114498ebe2848b71653</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> reg.xxlaila.cn/kxl/kxl-eureka:v2</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1570698681073.jpg" alt="img"></p><h4 id="days-2019-10-12"><a href="#days-2019-10-12" class="headerlink" title="days(2019-10-12)"></a>days(2019-10-12)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºå…¬å¸éœ€æ±‚ï¼Œå¼€å‘äººå‘˜æ¯”è¾ƒå¤šï¼Œåˆä¸æƒ³ç ”å‘ç”¨ä¸€ä¸ªè´¦å·ï¼Œä¹Ÿä¸æƒ³ç»™ç ”å‘ä¸€ä¸ªä¸ªçš„å¼€è´¦å·ï¼Œä½ç½®harboræ”¯æŒäº†ldapã€‚æœ‰äº†è¿™ä¹ˆä¸€ä¸ªä¸œè¥¿ï¼Œæˆ‘ä»¬å°±èƒ½å¾ˆå¥½çš„ä¸ºç ”å‘åˆ›å»ºè´¦å·æ”¯æŒç ”å‘éšæ—¶æŸ¥çœ‹dockerçš„é•œåƒã€‚</p><h4 id="é…ç½®harbor-ldap"><a href="#é…ç½®harbor-ldap" class="headerlink" title="é…ç½®harbor ldap"></a>é…ç½®harbor ldap</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°ç‰ˆæœ¬çš„harborå¾ˆå¤šä¸œè¥¿éƒ½å¯ä»¥ç›´æ¥åœ¨ç•Œé¢é…ç½®ï¼Œä¸éœ€è¦å»ä¿®æ”¹æ–‡ä»¶ï¼Œçœå»äº†å¤§é‡çš„å·¥ä½œï¼Œwebç•Œé¢é…ç½®æ›´åŠ æ–¹ä¾¿å¿«æ·ï¼Œç™»å½•harborå¹³å°ï¼Œç‚¹å‡»é…ç½®ç®¡ç†â€”â€”&gt;ä¿®æ”¹è®¤è¯æ¨¡å¼ï¼Œè®¤è¯æ¨¡å¼æ”¯æŒå¾ˆå¤šç±»å‹ï¼Œè¿™é‡Œé€‰æ‹©ldapã€‚<br><img src="https://img.xxlaila.cn/1571019665079.jpg" alt="img"><br><strong>æ³¨</strong>: åœ¨å¯†ç è¿™æ å¡«å†™éœ€è¦å¡«å†™ç®¡ç†å‘˜çš„å¯†ç ï¼Œæ™®é€šç”¨æˆ·çš„å¯†ç æ˜¯ä¸è¡Œçš„ï¼Œå³ä½¿æ˜¯åœ¨ç®¡ç†å‘˜çš„ç”¨æˆ·ä¹Ÿæ˜¯ä¸è¡Œçš„ã€‚<br>ç‚¹å‡»æµ‹è¯•ldapï¼Œæç¤ºè¿æ¥æˆåŠŸåä¿å­˜<br><img src="https://img.xxlaila.cn/1571019741060.jpg" alt="img"></p><h4 id="é…ç½®é‚®ç®±"><a href="#é…ç½®é‚®ç®±" class="headerlink" title="é…ç½®é‚®ç®±"></a>é…ç½®é‚®ç®±</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨é…ç½®ldapé¡µé¢æ—è¾¹æœ‰ä¸€ä¸ªé‚®ç®±é…ç½®ï¼Œé‚®ä»¶æœåŠ¡å™¨ç”¨äºå‘è¯·æ±‚é‡è®¾å¯†ç çš„ç”¨æˆ·å‘é€å“åº”ã€‚<br><img src="https://img.xxlaila.cn/1570873497729.jpg" alt="img"><br>ç‚¹å‡»æµ‹è¯•ï¼Œæµ‹è¯•æ²¡é—®é¢˜ä¹‹åç‚¹å‡»ä¿å­˜ã€‚</p><h4 id="æµ‹è¯•ladpè¿æ¥"><a href="#æµ‹è¯•ladpè¿æ¥" class="headerlink" title="æµ‹è¯•ladpè¿æ¥"></a>æµ‹è¯•ladpè¿æ¥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°æ‰“å¼€ä¸€ä¸ªä¸€ä¸ªæµè§ˆå™¨çª—å£ï¼Œåˆ©ç”¨ladpè´¦æˆ·è¿›è¡Œç™»å½•ã€‚<br><img src="https://img.xxlaila.cn/1571019859287.jpg" alt="img"><br><strong>æ³¨é‡Š</strong>: æ–°ç‰ˆæœ¬çš„åœ¨ç™»å½•ç•Œé¢æ²¡æœ‰ä»€ä¹ˆé€‰æ‹©ldapç™»å½•ï¼Œç›´æ¥ä½¿ç”¨ldapè´¦å·ç™»å½•å°±ok</p><h4 id="å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP-ADç»„"><a href="#å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP-ADç»„" class="headerlink" title="å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP / ADç»„"></a>å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP / ADç»„</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¿®æ”¹ä¹‹å‰çš„ldapé…ç½®ï¼Œå¢åŠ ç»„çš„é…ç½®<br><img src="https://img.xxlaila.cn/1571023069387.jpg" alt="img"><br>åœ¨é¡¹ç›®-&gt;æˆå‘˜-&gt; +ç»„ä¸­ã€‚<br><img src="https://img.xxlaila.cn/1571023177214.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571023223796.jpg" alt="img"></p><h4 id="è®¾ç½®ldapè´¦æˆ·çš„æƒé™"><a href="#è®¾ç½®ldapè´¦æˆ·çš„æƒé™" class="headerlink" title="è®¾ç½®ldapè´¦æˆ·çš„æƒé™"></a>è®¾ç½®ldapè´¦æˆ·çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“ldapé…ç½®ä»¥åï¼Œldapè´¦æˆ·ç™»å½•æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œæˆ‘ä»¬ç®¡ç†harborè¿˜çš„ä½¿ç”¨<code>harbor</code>çš„adminè´¦æˆ·ç™»å½•ï¼Œè¿™æ ·æ— ç–‘å¯¹è¿ç»´äººå‘˜ç»´æŠ¤å¸¦æ¥äº†ä¸ä¾¿åˆ©ã€‚å½“ldapç”¨æˆ·ç™»å½•ï¼Œharborå°±ä¼šè®°å½•è¯¥ç”¨æˆ·ï¼Œæˆ‘ä»¬è®¾ç½®è¿ç»´ç”¨æˆ·ä¸ºè¶…çº§ç®¡ç†å‘˜ï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªè´¦å·ç™»å½•ï¼Œç»´æŠ¤çš„æ—¶å€™ä¹Ÿä¸ç”¨è´¦å·åˆ‡æ¢<br><img src="https://img.xxlaila.cn/1571023451423.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>harbor</tag>
      </tags>
  </entry>
  <entry>
    <title>HPAè®¤è¯†</title>
    <url>/2019/10/09/hpa/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="Pod-è‡ªåŠ¨æ‰©ç¼©å®¹"><a href="#Pod-è‡ªåŠ¨æ‰©ç¼©å®¹" class="headerlink" title="Pod è‡ªåŠ¨æ‰©ç¼©å®¹"></a>Pod è‡ªåŠ¨æ‰©ç¼©å®¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesæä¾›äº†è¿™æ ·ä¸€ä¸ªèµ„æºå¯¹è±¡: <code>Horizontal Pod Autoscaling</code> Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼‰ï¼Œç®€ç§°HPAã€‚HAPé€šè¿‡ç›‘æ§åˆ†æRCæˆ–è€…Deploymentæ§åˆ¶çš„æ‰€æœ‰Podçš„è´Ÿè½½å˜åŒ–æƒ…å†µæ¥ç¡®å®šæ˜¯å¦éœ€è¦è°ƒæ•´Podçš„å‰¯æœ¬æ•°é‡ï¼Œè¿™æ˜¯HPAæœ€åŸºæœ¬çš„åŸç†ã€‚</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1570605234009.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HPAåœ¨kubernetesé›†ç¾¤ä¸­è¢«è®¾è®¡æˆä¸€ä¸ªKubernetes APIèµ„æºå’Œæ§åˆ¶å™¨ï¼Œå¯ä»¥é€šè¿‡kubectl autoscaleå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªHPAèµ„æºå¯¹è±¡ï¼ŒHPA Controlleré»˜è®¤15sè½®è¯¢ä¸€æ¬¡ï¼ˆå¯é€šè¿‡kube-controller-managerçš„æ ‡å¿—â€“horizontal-pod-autoscaler-sync-periodè¿›è¡Œè®¾ç½®ï¼‰ï¼ŒæŸ¥è¯¢æŒ‡å®šçš„èµ„æºï¼ˆRCæˆ–è€…Deploymentï¼‰ä¸­Podçš„èµ„æºä½¿ç”¨ç‡ï¼Œå¹¶ä¸”ä¸åˆ›å»ºæ—¶è®¾å®šçš„å€¼å’ŒæŒ‡æ ‡åšå¯¹æ¯”ï¼Œä»è€Œå®ç°è‡ªåŠ¨ä¼¸ç¼©çš„åŠŸèƒ½ã€‚<br><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener">è¯¦ç»†ä»‹ç»</a></p><h3 id="Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ "><a href="#Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ " class="headerlink" title="Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ "></a>Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ </h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºHorizontal Pod Autoscalerä½¿ç”¨æ­¤APIæ”¶é›†æŒ‡æ ‡ï¼Œå› æ­¤éœ€è¦åœ¨ç¾¤é›†ä¸­éƒ¨ç½²metrics-serverç›‘è§†ä»¥é€šè¿‡èµ„æºæŒ‡æ ‡APIæä¾›æŒ‡æ ‡,</p><h4 id="è¿è¡Œphp-apacheæœåŠ¡å™¨"><a href="#è¿è¡Œphp-apacheæœåŠ¡å™¨" class="headerlink" title="è¿è¡Œphp-apacheæœåŠ¡å™¨"></a>è¿è¡Œphp-apacheæœåŠ¡å™¨</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†å¼€å§‹è¿è¡Œè¯¥æ˜ åƒçš„éƒ¨ç½²ï¼Œå¹¶å°†å…¶æœåŠ¡å…¬å¼€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run php-apache --image=0layfolk0/hpa-example --requests=cpu=200m --limits=cpu=500m --expose --port=80</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">service/php-apache created</span><br><span class="line">deployment.apps/php-apache created</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨"><a href="#åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨" class="headerlink" title="åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨"></a>åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æœåŠ¡è¿è¡Œä»¥åã€‚æˆ‘ä»¬å°†ä½¿ç”¨kubectl autoscaleåˆ›å»ºè‡ªåŠ¨ ç¼©æ”¾å™¨ã€‚ä»¥ä¸‹å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œè¯¥ç¼©æ”¾å™¨å°†ç»´æŠ¤ç”±æˆ‘ä»¬åœ¨è¿™äº›è¯´æ˜çš„ç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„php-apacheéƒ¨ç½²æ§åˆ¶çš„Podçš„1è‡³10ä¸ªå‰¯æœ¬ã€‚ç²—ç•¥åœ°è¯´ï¼ŒHPAå°†ï¼ˆé€šè¿‡éƒ¨ç½²ï¼‰å¢åŠ æˆ–å‡å°‘å‰¯æœ¬æ•°ï¼Œä»¥å°†æ‰€æœ‰Podçš„å¹³å‡CPUåˆ©ç”¨ç‡ç»´æŒåœ¨50ï¼…ï¼ˆå› ä¸ºæ¯ä¸ªpodé€šè¿‡kubectlè¿è¡Œè¯·æ±‚200æ¯«æ ¸ï¼Œè¿™æ„å‘³ç€å¹³å‡CPUåˆ©ç”¨ç‡ä¸º100æ¯«-æ ¸å¿ƒï¼‰ã€‚<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#algorithm-details" target="_blank" rel="noopener">ç®—æ³•æ›´å¤šä¿¡æ¯</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span><br><span class="line">horizontalpodautoscaler.autoscaling/php-apache autoscaled</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥è‡ªåŠ¨å®šæ ‡å™¨çš„å½“å‰çŠ¶æ€:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         10        1          14s</span><br></pre></td></tr></table></figure><p><strong>æ³¨é‡Š</strong>: ç”±äºæˆ‘ä»¬æ²¡æœ‰å‘æœåŠ¡å™¨å‘é€ä»»ä½•è¯·æ±‚ï¼Œå› æ­¤å½“å‰CPUæ¶ˆè€—ä¸º0ï¼…ï¼ˆâ€œ CURRENTâ€åˆ—æ˜¾ç¤ºäº†ç”±ç›¸åº”éƒ¨ç½²æ§åˆ¶çš„æ‰€æœ‰Podçš„å¹³å‡å€¼ï¼‰ã€‚</p><h4 id="å¢åŠ å‹åŠ›æµ‹è¯•"><a href="#å¢åŠ å‹åŠ›æµ‹è¯•" class="headerlink" title="å¢åŠ å‹åŠ›æµ‹è¯•"></a>å¢åŠ å‹åŠ›æµ‹è¯•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨æˆ‘ä»¬è¦å¯¹<code>php-apache</code>åšå‹åŠ›æµ‹è¯•æ¥è§‚çœ‹è‡ªåŠ¨ç¼©æ”¾å¦‚ä½•å¯¹å¢åŠ çš„è´Ÿè½½åšå‡ºååº”ï¼Œæˆ‘ä»¬å°†å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶å°†æ— é™å¾ªç¯çš„æŸ¥è¯¢å‘é€åˆ°php-apacheæœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty load-generator --image=busybox /bin/sh</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # while true; do wget -q -O- http://php-apache.default.svc.cluster.local; done</span></span><br><span class="line"><span class="string">OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!O</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸€åˆ†é’Ÿå·¦å³çš„æ—¶é—´å†…ï¼Œæˆ‘ä»¬åº”è¯¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥çœ‹åˆ°æ›´é«˜çš„CPUè´Ÿè½½ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   250%/50%   1         10        1          9m12s</span><br><span class="line"></span><br><span class="line">$ kubectl get deployment php-apache</span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   3/5     5            3           88m</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”±äºç½‘ç»œé—®é¢˜å’Œpull é•œåƒå¤ªæ…¢äº†ï¼Œæˆ‘å°±ç›´æ¥ç»“æŸäº†æµ‹è¯•</p><h4 id="åœæ­¢å‹åŠ›æµ‹è¯•"><a href="#åœæ­¢å‹åŠ›æµ‹è¯•" class="headerlink" title="åœæ­¢å‹åŠ›æµ‹è¯•"></a>åœæ­¢å‹åŠ›æµ‹è¯•</h4><p>æˆ‘ä»¬åœ¨<code>busybox</code>å®¹å™¨çš„ç»ˆç«¯é‡Œé¢æ‰§è¡Œ<code>&lt;Ctrl&gt; + C</code>æ¥ç»“æŸå‹åŠ›æµ‹è¯•ï¼Œç„¶åæˆ‘ä»¬åœ¨è§‚å¯Ÿç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   91%/50%   1         10        5          10m</span><br><span class="line"></span><br><span class="line">$ kubectl get deployment php-apache</span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   2/2     2            2           99m</span><br></pre></td></tr></table></figure><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener">è‡ªåŠ¨ç¼©æ”¾å¤šä¸ªæŒ‡æ ‡å’Œè‡ªå®šä¹‰æŒ‡æ ‡</a></p><h3 id="nginx-æµ‹è¯•"><a href="#nginx-æµ‹è¯•" class="headerlink" title="nginx æµ‹è¯•"></a>nginx æµ‹è¯•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ©ç”¨ä¹‹å‰<a href="https://xxlaila.github.io/2019/10/09/Deployment%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">Deployment</a>é‡Œé¢çš„nginxåšæµ‹è¯•ï¼Œæˆ‘ä»¬åªéœ€è¦å§ä¹‹å‰çš„yamlæ–‡ä»¶ç¨ä½œä¿®æ”¹å³å¯</p><h4 id="ä¿®æ”¹nginx-deployment-yaml"><a href="#ä¿®æ”¹nginx-deployment-yaml" class="headerlink" title="ä¿®æ”¹nginx-deployment.yaml"></a>ä¿®æ”¹nginx-deployment.yaml</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-deploy</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-deploy</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"200Mi"</span></span><br><span class="line">            cpu: <span class="string">"200m"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="æ–°å»ºç«‹nginx-deploy-hpa-yaml"><a href="#æ–°å»ºç«‹nginx-deploy-hpa-yaml" class="headerlink" title="æ–°å»ºç«‹nginx-deploy-hpa.yaml"></a>æ–°å»ºç«‹nginx-deploy-hpa.yaml</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deploy-hpa.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 5</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: extensions/v1beta1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx-deploy</span><br><span class="line">  targetCPUUtilizationPercentage: 10</span><br><span class="line">status:</span><br><span class="line">  currentCPUUtilizationPercentage: 8</span><br><span class="line">  currentReplicas: 1</span><br><span class="line">  desiredReplicas: 0</span><br></pre></td></tr></table></figure><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">$ kubectl apply -f kubectl apply -f nginx-deploy-hpa.yaml</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   0%/10%    1         5         2          45s</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       8m28s</span><br><span class="line">nginx-deploy-d494b9564      2         2         2       13m</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œå‹åŠ›æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty load-generator --image=busybox /bin/sh</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # while true; do wget -q -O- http://172.30.224.5:80; done</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ•ˆæœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   28%/10%   1         5         4          4m48s</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       12m</span><br><span class="line">nginx-deploy-d494b9564      5         5         5       18m</span><br><span class="line"></span><br><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   16%/10%   1         5         5          5m39s</span><br></pre></td></tr></table></figure></li><li><p>ç»“æŸå‹æµ‹<br>ç­‰å¾…ä¸€ä¼šæŸ¥çœ‹ç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   0%/10%    1         5         1          12m</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       19m</span><br><span class="line">nginx-deploy-d494b9564      1         1         1       25m</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>hpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Deploymentä½¿ç”¨</title>
    <url>/2019/10/09/Deployment%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="Deploymentå’Œrcçš„å¯¹æ¯”"><a href="#Deploymentå’Œrcçš„å¯¹æ¯”" class="headerlink" title="Deploymentå’Œrcçš„å¯¹æ¯”"></a>Deploymentå’Œrcçš„å¯¹æ¯”</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆRCæ˜¯Kubernetesçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå½“æˆ‘ä»¬æŠŠåº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤ä¹‹åï¼Œéœ€è¦ä¿è¯åº”ç”¨èƒ½å¤ŸæŒç»­ç¨³å®šçš„è¿è¡Œï¼ŒRCå°±æ˜¯è¿™ä¸ªä¿è¯çš„å…³é”®ï¼Œä¸»è¦åŠŸèƒ½å¦‚:</p><ul><li>ç¡®ä¿Podæ•°é‡: å®ƒä¼šç¡®ä¿Kubernetesä¸­æœ‰æŒ‡å®šæ•°é‡çš„Podåœ¨è¿è¡Œï¼Œå¦‚æœå°‘äºæŒ‡å®šæ•°é‡çš„Podï¼ŒRCå°±ä¼šåˆ›å»ºæ–°çš„ï¼Œåä¹‹è¿™ä¼šåˆ é™¤å¤šä½™çš„ï¼Œä¿è¯Podçš„å‰¯æœ¬æ•°é‡ä¸å˜ã€‚</li><li>ç¡®ä¿Podå¥åº·: å½“Podä¸å¥åº·ï¼Œæ¯”å¦‚è¿è¡Œå‡ºé”™äº†ï¼Œæ€»ä¹‹æ— æ³•æä¾›æ­£å¸¸æœåŠ¡æ—¶ï¼ŒRCä¹Ÿä¼šæ€æ­»ä¸å¥åº·çš„Podï¼Œé‡æ–°åˆ›å»ºæ–°çš„ã€‚</li><li>å¼¹æ€§ä¼¸ç¼©: åœ¨ä¸šåŠ¡é«˜å³°æˆ–è€…ä½å³°çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨è¿‡RCæ¥åŠ¨æ€çš„è°ƒæ•´Podæ•°é‡æ¥æä¾›èµ„æºçš„åˆ©ç”¨ç‡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡å¦‚æœä½¿ç”¨HPAè¿™ç§èµ„æºå¯¹è±¡çš„è¯å¯ä»¥åšåˆ°è‡ªåŠ¨ä¼¸ç¼©ã€‚</li><li>æ»šåŠ¨å‡çº§: æ»šåŠ¨å‡çº§æ˜¯ä¸€ç§å¹³æ»‘çš„å‡çº§æ–¹å¼ï¼Œé€šè¿‡é€æ­¥æ›¿æ¢çš„ç­–ç•¥ï¼Œä¿è¯æ•´ä½“ç³»ç»Ÿçš„ç¨³å®šæ€§</li></ul><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeploymentåŒæ ·ä¹Ÿæ˜¯Kubernetesç³»ç»Ÿçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œä¸»è¦èŒè´£å’ŒRCä¸€æ ·çš„éƒ½æ˜¯ä¿è¯Podçš„æ•°é‡å’Œå¥åº·ï¼ŒäºŒè€…å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªå‡çº§ç‰ˆçš„RCæ§åˆ¶å™¨ï¼ŒDeploymentå…·å¤‡çš„æ–°ç‰¹æ€§</p><ul><li>RCçš„å…¨éƒ¨åŠŸèƒ½: Deploymentå…·å¤‡ä¸Šé¢æè¿°çš„RCçš„å…¨éƒ¨åŠŸèƒ½</li><li>äº‹ä»¶å’ŒçŠ¶æ€æŸ¥çœ‹: å¯ä»¥æŸ¥çœ‹Deploymentçš„å‡çº§è¯¦ç»†è¿›åº¦å’ŒçŠ¶æ€</li><li>å›æ»š: å½“å‡çº§Podçš„æ—¶å€™å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å›æ»šæ“ä½œå›æ»šåˆ°ä¹‹å‰çš„ä»»ä¸€ç‰ˆæœ¬</li><li>ç‰ˆæœ¬è®°å½•: æ¯ä¸€æ¬¡å¯¹Deploymentçš„æ“ä½œï¼Œéƒ½èƒ½å¤Ÿä¿å­˜ä¸‹æ¥ï¼Œè¿™ä¹Ÿæ˜¯ä¿è¯å¯ä»¥å›æ»šåˆ°ä»»ä¸€ç‰ˆæœ¬çš„åŸºç¡€</li><li>æš‚åœå’Œå¯åŠ¨: å¯¹äºæ¯ä¸€æ¬¡å‡çº§éƒ½èƒ½å¤Ÿéšæ—¶æš‚åœå’Œå¯åŠ¨</li></ul><p><strong>å¯¹æ¯”</strong>: Deploymentä½œä¸ºæ–°ä¸€ä»£çš„RCï¼Œåœ¨åŠŸèƒ½ä¸Šæ›´ä¸ºä¸°å¯Œï¼ŒåŒæ—¶å®˜æ–¹ä¹Ÿæ˜¯æ¨èä½¿ç”¨Deploymentæ¥ç®¡ç†Podï¼Œæ¯”å¦‚ä¸€äº›å®˜æ–¹ç»„ä»¶kube-dnsã€kube-proxyä¹Ÿéƒ½æ˜¯ä½¿ç”¨çš„Deploymentæ¥ç®¡ç†çš„ï¼Œæ‰€ä»¥æœ€å¥½ä½¿ç”¨Deploymentæ¥ç®¡ç†Podã€‚</p><h3 id="Deployment-ä»‹ç»"><a href="#Deployment-ä»‹ç»" class="headerlink" title="Deployment ä»‹ç»"></a>Deployment ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Deploymentæ‹¥æœ‰å¤šä¸ªReplica Setï¼Œè€Œä¸€ä¸ªReplica Setæ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªPodã€‚ä¸€ä¸ªDeploymentæ§åˆ¶å¤šä¸ªrsä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒå›æ»šæœºåˆ¶ï¼Œæ¯å½“Deploymentæ“ä½œæ—¶ï¼ŒKubernetesä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªReplica Setå¹¶ä¿ç•™ï¼Œä»¥åæœ‰éœ€è¦çš„è¯å°±å¯ä»¥å›æ»šè‡³ä¹‹å‰çš„çŠ¶æ€ã€‚</p><p><strong>å®ä¾‹</strong>: åˆ›å»ºä¸€ä¸ªDeploymentï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªReplica Setæ¥å¯åŠ¨3ä¸ªnginx podï¼Œyamlæ–‡ä»¶å¦‚ä¸‹:</p><ul><li><p>nginx-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f nginx-deployment.yaml</span><br><span class="line">deployment.apps/nginx-deploy created</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œä¸€ä¸‹å‘½ä»¤æŸ¥çœ‹åˆšåˆšåˆ›å»ºçš„Deployment</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   0/3     3            0           12s</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡æ‰§è¡Œä¸Šé¢å‘½ä»¤</span></span><br><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   1/3     3            1           35s</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥çœ‹åˆ°Deploymentå·²ç»åˆ›å»ºäº†1ä¸ªReplica Setäº†ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹rså’Œpod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get rs</span><br><span class="line">NAME                     DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d   3         3         2       70s</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ kubectl get pod --show-labels</span><br><span class="line">NAME                           READY   STATUS              RESTARTS   AGE   LABELS</span><br><span class="line">nginx-deploy-6dd86d77d-9n9vf   1/1     Running             0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br><span class="line">nginx-deploy-6dd86d77d-bhrsk   0/1     ContainerCreating   0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br><span class="line">nginx-deploy-6dd86d77d-jdnrh   1/1     Running             0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br></pre></td></tr></table></figure></li></ul><p>ä¸Šé¢çš„Deploymentçš„yamlæ–‡ä»¶ä¸­çš„replicas:3å°†ä¼šä¿è¯æˆ‘ä»¬å§‹ç»ˆæœ‰3ä¸ªPODåœ¨è¿è¡Œã€‚</p><h3 id="æ»šåŠ¨å‡çº§"><a href="#æ»šåŠ¨å‡çº§" class="headerlink" title="æ»šåŠ¨å‡çº§"></a>æ»šåŠ¨å‡çº§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¿®æ”¹ä¹‹å‰ä½¿ç”¨çš„nginx-deployment.yamlæ–‡ä»¶ä¸­çš„nginxé•œåƒä¿®æ”¹ä¸ºnginx:1.13.3ï¼Œç„¶ååœ¨specä¸‹é¢æ·»åŠ æ»šåŠ¨å‡çº§ç­–ç•¥ï¼š</p><ul><li><p>nginx-deploments.yml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure></li><li><p>minReadySeconds:</p><ul><li>æ»šåŠ¨å‡çº§æ—¶5såè®¤ä¸ºè¯¥podå°±ç»ª</li><li>å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼ŒKubernetesä¼šå‡è®¾è¯¥å®¹å™¨å¯åŠ¨èµ·æ¥åå°±æä¾›æœåŠ¡äº†</li><li>å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼Œåœ¨æŸäº›æç«¯æƒ…å†µä¸‹å¯èƒ½ä¼šé€ æˆæœåŠ¡ä¸æ­£å¸¸è¿è¡Œ</li></ul></li><li><p>rollingUpdate:</p><ul><li>äºreplicasä¸º3,åˆ™æ•´ä¸ªå‡çº§,podä¸ªæ•°åœ¨2-4ä¸ªä¹‹é—´</li></ul></li><li><p>maxSurge:</p><ul><li>å‡çº§è¿‡ç¨‹ä¸­æœ€å¤šå¯ä»¥æ¯”åŸå…ˆè®¾ç½®å¤šå‡ºçš„PODæ•°é‡</li><li>ä¾‹å¦‚ï¼šmaxSurage=1ï¼Œreplicas=3,åˆ™è¡¨ç¤ºKubernetesä¼šå…ˆå¯åŠ¨1ä¸€ä¸ªæ–°çš„Podåæ‰åˆ æ‰ä¸€ä¸ªæ—§çš„PODï¼Œæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰3+1ä¸ªPODã€‚</li></ul></li><li><p>maxUnavaible:</p><ul><li>å‡çº§è¿‡ç¨‹ä¸­æœ€å¤šæœ‰å¤šå°‘ä¸ªPODå¤„äºæ— æ³•æä¾›æœåŠ¡çš„çŠ¶æ€</li><li>å½“maxSurgeä¸ä¸º0æ—¶ï¼Œè¯¥å€¼ä¹Ÿä¸èƒ½ä¸º0</li><li>ä¾‹å¦‚ï¼šmaxUnavaible=1ï¼Œåˆ™è¡¨ç¤ºKubernetesæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰1ä¸ªPODå¤„äºæ— æ³•æœåŠ¡çš„çŠ¶æ€ã€‚</li></ul></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">deployment.apps/nginx-deploy configured</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨rolloutå‘½ä»¤</span></span><br><span class="line">$ kubectl rollout status deployment/nginx-deploy</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line"></span><br><span class="line"><span class="comment"># æš‚åœå‡çº§</span></span><br><span class="line">$ kubectl rollout pause deployment deployment/nginx-deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­å‡çº§</span></span><br><span class="line">$ kubectl rollout resume deployment deployment/nginx-deploy</span><br></pre></td></tr></table></figure></li></ul><p>å‡çº§ç»“æŸåï¼Œç»§ç»­æŸ¥çœ‹rsçš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    0         0         0       21m</span><br><span class="line">nginx-deploy-799d666985   3         3         3       10m</span><br></pre></td></tr></table></figure><p>æ ¹æ®AGEæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¦»æˆ‘ä»¬æœ€è¿‘çš„å½“å‰çŠ¶æ€æ˜¯ï¼š3ï¼Œå’Œæˆ‘ä»¬çš„yamlæ–‡ä»¶æ˜¯ä¸€è‡´çš„ï¼Œè¯æ˜å‡çº§æˆåŠŸäº†ã€‚ç”¨describeå‘½ä»¤å¯ä»¥æŸ¥çœ‹å‡çº§çš„å…¨éƒ¨ä¿¡æ¯:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe deploy nginx-deploy</span><br><span class="line">Name:                   nginx-deploy</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Wed, 09 Oct 2019 10:12:56 +0800</span><br><span class="line">Labels:                 k8s-app=nginx-demo</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 2</span><br><span class="line">                        kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                          &#123;<span class="string">"apiVersion"</span>:<span class="string">"apps/v1beta1"</span>,<span class="string">"kind"</span>:<span class="string">"Deployment"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"labels"</span>:&#123;<span class="string">"k8s-app"</span>:<span class="string">"nginx-demo"</span>&#125;,<span class="string">"name"</span>:<span class="string">"nginx-deploy"</span>,<span class="string">"nam...</span></span><br><span class="line"><span class="string">Selector:               app=nginx</span></span><br><span class="line"><span class="string">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span></span><br><span class="line"><span class="string">StrategyType:           RollingUpdate</span></span><br><span class="line"><span class="string">MinReadySeconds:        5</span></span><br><span class="line"><span class="string">RollingUpdateStrategy:  1 max unavailable, 1 max surge</span></span><br><span class="line"><span class="string">Pod Template:</span></span><br><span class="line"><span class="string">  Labels:  app=nginx</span></span><br><span class="line"><span class="string">  Containers:</span></span><br><span class="line"><span class="string">   nginx:</span></span><br><span class="line"><span class="string">    Image:        nginx:1.13.3</span></span><br><span class="line"><span class="string">    Port:         80/TCP</span></span><br><span class="line"><span class="string">    Host Port:    0/TCP</span></span><br><span class="line"><span class="string">    Environment:  &lt;none&gt;</span></span><br><span class="line"><span class="string">    Mounts:       &lt;none&gt;</span></span><br><span class="line"><span class="string">  Volumes:        &lt;none&gt;</span></span><br><span class="line"><span class="string">Conditions:</span></span><br><span class="line"><span class="string">  Type           Status  Reason</span></span><br><span class="line"><span class="string">  ----           ------  ------</span></span><br><span class="line"><span class="string">  Available      True    MinimumReplicasAvailable</span></span><br><span class="line"><span class="string">  Progressing    True    NewReplicaSetAvailable</span></span><br><span class="line"><span class="string">OldReplicaSets:  &lt;none&gt;</span></span><br><span class="line"><span class="string">NewReplicaSet:   nginx-deploy-799d666985 (3/3 replicas created)</span></span><br><span class="line"><span class="string">Events:</span></span><br><span class="line"><span class="string">  Type    Reason             Age   From                   Message</span></span><br><span class="line"><span class="string">  ----    ------             ----  ----                   -------</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  23m   deployment-controller  Scaled up replica set nginx-deploy-6dd86d77d to 3</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 1</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 2</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 2</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 1</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 3</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  10m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 0</span></span><br></pre></td></tr></table></figure><h3 id="å›æ»šDeployment"><a href="#å›æ»šDeployment" class="headerlink" title="å›æ»šDeployment"></a>å›æ»šDeployment</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢å·²ç»æ»šåŠ¨å¹³æ»‘çš„å‡çº§Deploymentï¼Œä½†æ˜¯å¦‚æœå‡çº§åçš„PODå‡ºäº†é—®é¢˜è¯¥æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬èƒ½å¤Ÿæƒ³åˆ°çš„æœ€å¥½æœ€å¿«çš„æ–¹å¼å½“ç„¶æ˜¯å›é€€åˆ°ä¸Šä¸€æ¬¡èƒ½å¤Ÿæä¾›æ­£å¸¸å·¥ä½œçš„ç‰ˆæœ¬ï¼ŒDeploymentå°±ä¸ºæˆ‘ä»¬æä¾›äº†å›æ»šæœºåˆ¶ã€‚</p><ul><li>é¦–å…ˆï¼ŒæŸ¥çœ‹Deploymentçš„å‡çº§å†å²:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment nginx-deploy</span><br><span class="line">deployment.extensions/nginx-deploy </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºåœ¨æ‰§è¡ŒDeploymentå‡çº§çš„æ—¶å€™æœ€å¥½å¸¦ä¸Šrecordå‚æ•°ï¼Œä¾¿äºæˆ‘ä»¬æŸ¥çœ‹å†å²ç‰ˆæœ¬ä¿¡æ¯ã€‚<code>kubectl apply --filename=nginx-deployment.yaml --record=true</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰é€šè¿‡kubectl xxxx â€“recordéƒ½ä¼šè¢«kubernetesè®°å½•åˆ°etcdè¿›è¡ŒæŒä¹…åŒ–ï¼Œè¿™æ— ç–‘ä¼šå ç”¨èµ„æºï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæ—¶é—´ä¹…äº†ï¼Œå½“ä½ kubectl get rsæ—¶ï¼Œä¼šæœ‰æˆç™¾ä¸Šåƒçš„åƒåœ¾RSè¿”å›ï¼Œè¿™å¯¹äºè¿ç»´æ¥è¯´ç»´æŠ¤å¾ˆä¸ä¾¿åˆ©ï¼Œ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬åœ¨ä¸Šç”Ÿäº§æ—¶ï¼Œæˆ‘ä»¬æœ€å¥½é€šè¿‡è®¾ç½®Deploymentçš„.spec.revisionHistoryLimitæ¥é™åˆ¶æœ€å¤§ä¿ç•™çš„revision numberï¼Œæ¯”å¦‚15ä¸ªç‰ˆæœ¬ï¼Œå›æ»šçš„æ—¶å€™ä¸€èˆ¬åªä¼šå›æ»šåˆ°æœ€è¿‘çš„å‡ ä¸ªç‰ˆæœ¬å°±è¶³å¤Ÿäº†ã€‚å…¶å®rollout historyä¸­è®°å½•çš„revisionéƒ½å’ŒReplicaSetsä¸€ä¸€å¯¹åº”ã€‚å¦‚æœæ‰‹åŠ¨deleteæŸä¸ªReplicaSetï¼Œå¯¹åº”çš„rollout historyå°±ä¼šè¢«åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯è¿˜è¯´ä½ æ— æ³•å›æ»šåˆ°è¿™ä¸ªrevisonã€‚rollout historyå’ŒReplicaSetçš„å¯¹åº”å…³ç³»ï¼Œå¯ä»¥åœ¨kubectl describe rs $RSNAMEè¿”å›çš„revisionå­—æ®µä¸­å¾—åˆ°ï¼Œè¿™é‡Œçš„revisionå°±å¯¹åº”ç€rollout historyè¿”å›çš„revisonã€‚</p><ul><li><p>yamlä¾‹å­</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat nginx-deployment.yaml </span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å•ä¸ªrevisonçš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment nginx-deploy --revision=2</span><br><span class="line">deployment.extensions/nginx-deploy with revision <span class="comment">#2</span></span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:	app=nginx</span><br><span class="line">	pod-template-hash=799d666985</span><br><span class="line">  Annotations:	kubernetes.io/change-cause: kubectl apply --filename=nginx-deployment.yaml --record=<span class="literal">true</span></span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:	nginx:1.13.3</span><br><span class="line">    Port:	80/TCP</span><br><span class="line">    Host Port:	0/TCP</span><br><span class="line">    Environment:	&lt;none&gt;</span><br><span class="line">    Mounts:	&lt;none&gt;</span><br><span class="line">  Volumes:	&lt;none&gt;</span><br></pre></td></tr></table></figure></li><li><p>ç›´æ¥å›é€€åˆ°å½“å‰ç‰ˆæœ¬çš„å‰ä¸€ä¸ªç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout undo deployment nginx-deploy</span><br><span class="line">deployment.extensions/nginx-deploy rolled back</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥ç”¨revisionå›é€€åˆ°æŒ‡å®šçš„ç‰ˆæœ¬</span></span><br><span class="line">$ kubectl rollout undo deployment nginx-deploy --to-revision=1</span><br><span class="line">deployment.extensions/nginx-deploy rolled back</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹Deploymentç°åœ¨çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   2/3     3            2           56m</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    1         1         1       56m</span><br><span class="line">nginx-deploy-799d666985   3         3         1       46m</span><br><span class="line"></span><br><span class="line">$ kubectl rollout status deployment/nginx-deploy</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 of 3 updated replicas are available...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 of 3 updated replicas are available...</span><br><span class="line">deployment <span class="string">"nginx-deploy"</span> successfully rolled out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ŒæˆåæŸ¥çœ‹</span></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    0         0         0       57m</span><br><span class="line">nginx-deploy-799d666985   3         3         3       47m</span><br></pre></td></tr></table></figure></li></ul><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Deployment</tag>
      </tags>
  </entry>
  <entry>
    <title>harborç§æœ‰ä»“åº“éƒ¨ç½²</title>
    <url>/2019/09/30/harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Harboræ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨å’Œåˆ†å‘Dockeré•œåƒçš„ä¼ä¸šçº§RegistryæœåŠ¡å™¨ï¼Œé€šè¿‡æ·»åŠ ä¸€äº›ä¼ä¸šå¿…éœ€çš„åŠŸèƒ½ç‰¹æ€§ï¼Œä¾‹å¦‚å®‰å…¨ã€æ ‡è¯†å’Œç®¡ç†ç­‰ï¼Œæ‰©å±•äº†å¼€æºDocker Distributionã€‚ä½œä¸ºä¸€ä¸ªä¼ä¸šçº§ç§æœ‰RegistryæœåŠ¡å™¨ï¼ŒHarboræä¾›äº†æ›´å¥½çš„æ€§èƒ½å’Œå®‰å…¨ã€‚æå‡ç”¨æˆ·ä½¿ç”¨Registryæ„å»ºå’Œè¿è¡Œç¯å¢ƒä¼ è¾“é•œåƒçš„æ•ˆç‡ã€‚Harboræ”¯æŒå®‰è£…åœ¨å¤šä¸ªRegistryèŠ‚ç‚¹çš„é•œåƒèµ„æºå¤åˆ¶ï¼Œé•œåƒå…¨éƒ¨ä¿å­˜åœ¨ç§æœ‰Registryä¸­ï¼Œ ç¡®ä¿æ•°æ®å’ŒçŸ¥è¯†äº§æƒåœ¨å…¬å¸å†…éƒ¨ç½‘ç»œä¸­ç®¡æ§ã€‚å¦å¤–ï¼ŒHarborä¹Ÿæä¾›äº†é«˜çº§çš„å®‰å…¨ç‰¹æ€§ï¼Œè¯¸å¦‚ç”¨æˆ·ç®¡ç†ï¼Œè®¿é—®æ§åˆ¶å’Œæ´»åŠ¨å®¡è®¡ç­‰ã€‚</p><a id="more"></a><h3 id="éƒ¨ç½²ç¯å¢ƒå‡†å¤‡"><a href="#éƒ¨ç½²ç¯å¢ƒå‡†å¤‡" class="headerlink" title="éƒ¨ç½²ç¯å¢ƒå‡†å¤‡"></a>éƒ¨ç½²ç¯å¢ƒå‡†å¤‡</h3><h4 id="æœåŠ¡å™¨é…ç½®"><a href="#æœåŠ¡å™¨é…ç½®" class="headerlink" title="æœåŠ¡å™¨é…ç½®"></a>æœåŠ¡å™¨é…ç½®</h4><table><thead><tr><th>ç³»ç»Ÿ</th><th>é…ç½®</th><th>ip</th></tr></thead><tbody><tr><td>centos 7.4</td><td>4/8G/200G</td><td>172.21.16.90</td></tr></tbody></table><h4 id="ä¸‹è½½æ‰€éœ€æ–‡ä»¶"><a href="#ä¸‹è½½æ‰€éœ€æ–‡ä»¶" class="headerlink" title="ä¸‹è½½æ‰€éœ€æ–‡ä»¶"></a>ä¸‹è½½æ‰€éœ€æ–‡ä»¶</h4><h5 id="docker-compose-ä¸‹è½½"><a href="#docker-compose-ä¸‹è½½" class="headerlink" title="docker-compose ä¸‹è½½"></a>docker-compose ä¸‹è½½</h5><p>docker compose <a href="https://github.com/docker/compose/releases" target="_blank" rel="noopener">å‘å¸ƒé¡µé¢</a>ä¸‹è½½æœ€æ–°çš„ docker-compose äºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/docker/compose/releases/download/1.24.1/docker-compose-Linux-x86_64</span></span><br><span class="line"><span class="comment"># mv ~/docker-compose-Linux-x86_64 /usr/bin/docker-compose </span></span><br><span class="line"><span class="comment"># chmod a+x  /ur/bin/docker-compose</span></span><br></pre></td></tr></table></figure><ul><li>å®˜æ–¹çš„å®‰è£…<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class="line"><span class="comment"># chmod +x /usr/local/bin/docker-compose</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="harbor-ä¸‹è½½"><a href="#harbor-ä¸‹è½½" class="headerlink" title="harbor ä¸‹è½½"></a>harbor ä¸‹è½½</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harbor å®‰è£…æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨çº¿å®‰è£…ï¼Œä¸€ç§æ˜¯ç¦»çº¿å®‰è£…ï¼Œè¿™é‡Œç”±äºç½‘ç»œä¸å¥½ï¼Œä½¿ç”¨çš„æ˜¯ç¦»çº¿å®‰è£…ï¼Œharbor<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">å‘å¸ƒé¡µé¢</a>ä¸‹è½½æœ€æ–°çš„ harbor ç¦»çº¿å®‰è£…åŒ…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://storage.googleapis.com/harbor-releases/release-1.9.0/harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line"><span class="comment"># tar -zxvf harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹å®‰è£…"><a href="#å¼€å§‹å®‰è£…" class="headerlink" title="å¼€å§‹å®‰è£…"></a>å¼€å§‹å®‰è£…</h3><h4 id="docker-å®‰è£…"><a href="#docker-å®‰è£…" class="headerlink" title="docker å®‰è£…"></a>docker å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum-config-manager   --add-repo   https://download.docker.com/linux/centos/docker-ce.repo</span></span><br><span class="line"><span class="comment"># sudo yum -y install docker-ce-18.09.6-3.el7.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables: 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables: 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># sysctl -p /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="comment"># systemctl  start docker</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>: ä¸æ·»åŠ <code>/etc/sysctl.d/k8s.conf</code> å¯åŠ¨dockerä¼šæç¤º<code>WARNING: bridge-nf-call-iptables is disabled WARNING: bridge-nf-call-ip6tables is disabled</code></p><h4 id="å¯¼å…¥-docker-images"><a href="#å¯¼å…¥-docker-images" class="headerlink" title="å¯¼å…¥ docker images"></a>å¯¼å…¥ docker images</h4><p>å¯¼å…¥ç¦»çº¿å®‰è£…åŒ…ä¸­harborç›¸å…³çš„ docker imagesï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd harbor</span></span><br><span class="line"><span class="comment"># docker load -i harbor.v1.9.0.tar.gz </span></span><br><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                      TAG                        IMAGE ID            CREATED             SIZE</span><br><span class="line">goharbor/chartmuseum-photon     v0.9.0-v1.9.0              00c12627cbd7        2 weeks ago         131MB</span><br><span class="line">goharbor/harbor-migrator        v1.9.0                     75d4de5e0f16        2 weeks ago         362MB</span><br><span class="line">goharbor/redis-photon           v1.9.0                     3249afaa9965        2 weeks ago         109MB</span><br><span class="line">goharbor/clair-photon           v2.0.9-v1.9.0              e54ad567c58f        2 weeks ago         165MB</span><br><span class="line">goharbor/notary-server-photon   v0.6.1-v1.9.0              2cdecba59f38        2 weeks ago         138MB</span><br><span class="line">goharbor/notary-signer-photon   v0.6.1-v1.9.0              973378593def        2 weeks ago         135MB</span><br><span class="line">goharbor/harbor-registryctl     v1.9.0                     30a01bf0f4df        2 weeks ago         99.6MB</span><br><span class="line">goharbor/registry-photon        v2.7.1-patch-2819-v1.9.0   32571099a9fe        2 weeks ago         82.3MB</span><br><span class="line">goharbor/nginx-photon           v1.9.0                     f933d62f9952        2 weeks ago         43.9MB</span><br><span class="line">goharbor/harbor-log             v1.9.0                     28e27d511335        2 weeks ago         82.6MB</span><br><span class="line">goharbor/harbor-jobservice      v1.9.0                     f3cd0b181a89        2 weeks ago         141MB</span><br><span class="line">goharbor/harbor-core            v1.9.0                     f2814ed8aadd        2 weeks ago         155MB</span><br><span class="line">goharbor/harbor-portal          v1.9.0                     0778d4c5d27e        2 weeks ago         51.3MB</span><br><span class="line">goharbor/harbor-db              v1.9.0                     a809e14d2d49        2 weeks ago         147MB</span><br><span class="line">goharbor/prepare                v1.9.0                     aa594772c1e8        2 weeks ago         147MB</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-harbor-yml-æ–‡ä»¶"><a href="#ä¿®æ”¹-harbor-yml-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ harbor.yml æ–‡ä»¶"></a>ä¿®æ”¹ harbor.yml æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim harbor.yml</span></span><br><span class="line">hostname: reg.xxlaila.cn</span><br><span class="line"></span><br><span class="line"><span class="comment"># email configure</span></span><br><span class="line">email_server: smtp.exmail.qq.com</span><br><span class="line">email_server_port: 465</span><br><span class="line">email_username: admin@xxlaila.cn</span><br><span class="line">email_password: 123</span><br><span class="line">email_from: admin&lt;admin@xxlaila.cn&gt;</span><br><span class="line">email_ssl: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User registration is prohibited</span></span><br><span class="line">self_registration: off</span><br><span class="line"></span><br><span class="line"><span class="comment"># LDAP authentication configuration item</span></span><br><span class="line"><span class="comment">#ldap_url: ldaps://ldap.xxlaila.cn</span></span><br><span class="line"><span class="comment">#ldap_searchdn: uid=username,ou=people,dc=xxlaila,dc=com</span></span><br><span class="line"><span class="comment">#ldap_search_pwd: password</span></span><br><span class="line"><span class="comment">#ldap_basedn: ou=people,dc=xxlaila,dc=com</span></span><br><span class="line"><span class="comment">#ldap_filter: (objectClass=person)</span></span><br><span class="line"><span class="comment">#ldap_uid: uid </span></span><br><span class="line"><span class="comment">#ldap_scope: 3 </span></span><br><span class="line"><span class="comment">#ldap_timeout: 5</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨</strong>: æ–°ç‰ˆæœ¬çš„é‚®ç®±ã€ldapç°åœ¨éƒ½ä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ¥æ·»åŠ é…ç½®äº†ï¼Œç›´æ¥é€šè¿‡webç•Œé¢æ¥è¿›è¡Œé…ç½®å³å¯ï¼Œè¿™é‡Œæˆ‘åªæ˜¯æ·»åŠ è¿›æ¥ï¼Œä¿ç•™ï¼ŒğŸ˜ğŸ˜ğŸ˜</p><h4 id="åŠ è½½å’Œå¯åŠ¨-harbor-é•œåƒ"><a href="#åŠ è½½å’Œå¯åŠ¨-harbor-é•œåƒ" class="headerlink" title="åŠ è½½å’Œå¯åŠ¨ harbor é•œåƒ"></a>åŠ è½½å’Œå¯åŠ¨ harbor é•œåƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /data</span></span><br><span class="line"><span class="comment"># chmod 777 /var/run/docker.sock /data</span></span><br><span class="line"><span class="comment"># ./install.sh </span></span><br><span class="line"></span><br><span class="line">[Step 0]: checking installation environment ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 19.03.2</span><br><span class="line"></span><br><span class="line">Note: docker-compose version: 1.24.1</span><br><span class="line"></span><br><span class="line">[Step 1]: loading Harbor images ...</span><br><span class="line">Loaded image: goharbor/harbor-portal:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-core:v1.9.0</span><br><span class="line">Loaded image: goharbor/nginx-photon:v1.9.0</span><br><span class="line">Loaded image: goharbor/notary-signer-photon:v0.6.1-v1.9.0</span><br><span class="line">Loaded image: goharbor/registry-photon:v2.7.1-patch-2819-v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-migrator:v1.9.0</span><br><span class="line">Loaded image: goharbor/chartmuseum-photon:v0.9.0-v1.9.0</span><br><span class="line">Loaded image: goharbor/prepare:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-log:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-db:v1.9.0</span><br><span class="line">Loaded image: goharbor/clair-photon:v2.0.9-v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-jobservice:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-registryctl:v1.9.0</span><br><span class="line">Loaded image: goharbor/redis-photon:v1.9.0</span><br><span class="line">Loaded image: goharbor/notary-server-photon:v0.6.1-v1.9.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 2]: preparing environment ...</span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /opt/harbor</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated and saved secret to file: /secret/keys/secretkey</span><br><span class="line">Generated certificate, key file: /secret/core/private_key.pem, cert file: /secret/registry/root.crt</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 3]: starting Harbor ...</span><br><span class="line">Creating network <span class="string">"harbor_harbor"</span> with the default driver</span><br><span class="line">Creating harbor-log ... <span class="keyword">done</span></span><br><span class="line">Creating registryctl   ... <span class="keyword">done</span></span><br><span class="line">Creating redis         ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-portal ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-db     ... <span class="keyword">done</span></span><br><span class="line">Creating registry      ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-core   ... <span class="keyword">done</span></span><br><span class="line">Creating nginx             ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-jobservice ... <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">âœ” ----Harbor has been installed and started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able to visit the admin portal at http://reg.xxlaila.cn. </span><br><span class="line">For more details, please visit https://github.com/goharbor/harbor .</span><br></pre></td></tr></table></figure><h4 id="è®¿é—®ç®¡ç†ç•Œé¢"><a href="#è®¿é—®ç®¡ç†ç•Œé¢" class="headerlink" title="è®¿é—®ç®¡ç†ç•Œé¢"></a>è®¿é—®ç®¡ç†ç•Œé¢</h4><p>ç¡®è®¤æ‰€æœ‰ç»„ä»¶éƒ½å·¥ä½œæ­£å¸¸ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker-compose  ps</span></span><br><span class="line">      Name                     Command                       State                     Ports          </span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-core         /harbor/harbor_core              Up (healthy)                                     </span><br><span class="line">harbor-db           /docker-entrypoint.sh            Up (healthy)            5432/tcp                 </span><br><span class="line">harbor-jobservice   /harbor/harbor_jobservice  ...   Up (health: starting)                            </span><br><span class="line">harbor-log          /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up (healthy)            127.0.0.1:1514-&gt;10514/tcp</span><br><span class="line">harbor-portal       nginx -g daemon off;             Up (healthy)            8080/tcp                 </span><br><span class="line">nginx               nginx -g daemon off;             Up (healthy)            0.0.0.0:80-&gt;8080/tcp     </span><br><span class="line">redis               redis-server /etc/redis.conf     Up (healthy)            6379/tcp                 </span><br><span class="line">registry            /entrypoint.sh /etc/regist ...   Up (healthy)            5000/tcp                 </span><br><span class="line">registryctl         /harbor/start.sh                 Up (healthy)</span><br></pre></td></tr></table></figure><h5 id="harbor-ç»„å»ºä»‹ç»"><a href="#harbor-ç»„å»ºä»‹ç»" class="headerlink" title="harbor ç»„å»ºä»‹ç»"></a>harbor ç»„å»ºä»‹ç»</h5><ul><li>harbor-core: Harborçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸»è¦æä¾›ä»¥ä¸‹æœåŠ¡ï¼š<ul><li>UIï¼šæä¾›å›¾å½¢åŒ–ç•Œé¢ï¼Œå¸®åŠ©ç”¨æˆ·ç®¡ç†registryä¸Šçš„é•œåƒï¼ˆimageï¼‰, å¹¶å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒã€‚</li><li>webhookï¼šä¸ºäº†åŠæ—¶è·å–registry ä¸ŠimageçŠ¶æ€å˜åŒ–çš„æƒ…å†µï¼Œ åœ¨Registryä¸Šé…ç½®webhookï¼ŒæŠŠçŠ¶æ€å˜åŒ–ä¼ é€’ç»™UIæ¨¡å—ã€‚</li><li>token æœåŠ¡ï¼šè´Ÿè´£æ ¹æ®ç”¨æˆ·æƒé™ç»™æ¯ä¸ªdocker push/pullå‘½ä»¤ç­¾å‘token. Docker å®¢æˆ·ç«¯å‘RegiÃ¸stryæœåŠ¡å‘èµ·çš„è¯·æ±‚,å¦‚æœä¸åŒ…å«tokenï¼Œä¼šè¢«é‡å®šå‘åˆ°è¿™é‡Œï¼Œè·å¾—tokenåå†é‡æ–°å‘Registryè¿›è¡Œè¯·æ±‚ã€‚</li></ul></li><li>harbor-db: ä¸ºcore servicesæä¾›æ•°æ®åº“æœåŠ¡ï¼Œè´Ÿè´£å‚¨å­˜ç”¨æˆ·æƒé™ã€å®¡è®¡æ—¥å¿—ã€Docker imageåˆ†ç»„ä¿¡æ¯ç­‰æ•°æ®ã€‚</li><li>harbor-jobservice: harbor-jobservice æ˜¯harborçš„jobç®¡ç†æ¨¡å—ï¼Œjobåœ¨harboré‡Œé¢ä¸»è¦æ˜¯ä¸ºäº†é•œåƒä»“åº“ä¹‹å‰åŒæ­¥ä½¿ç”¨çš„;</li><li>harbor-log: ä¸ºäº†å¸®åŠ©ç›‘æ§Harborè¿è¡Œï¼Œè´Ÿè´£æ”¶é›†å…¶ä»–ç»„ä»¶çš„logï¼Œä¾›æ—¥åè¿›è¡Œåˆ†æã€‚</li><li>nginx: nginxè´Ÿè´£æµé‡è½¬å‘å’Œå®‰å…¨éªŒè¯ï¼Œå¯¹å¤–æä¾›çš„æµé‡éƒ½æ˜¯ä»nginxä¸­è½¬ï¼Œæ‰€ä»¥å¼€æ”¾httpsçš„443ç«¯å£ï¼Œå®ƒå°†æµé‡åˆ†å‘åˆ°åç«¯çš„uiå’Œæ­£åœ¨dockeré•œåƒå­˜å‚¨çš„docker registryã€‚</li><li>redis: å­˜å‚¨ç¼“å­˜ä¿¡æ¯</li><li>registry: è´Ÿè´£å‚¨å­˜Dockeré•œåƒï¼Œå¹¶å¤„ç†docker push/pull å‘½ä»¤ã€‚ç”±äºæˆ‘ä»¬è¦å¯¹ç”¨æˆ·è¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œå³ä¸åŒç”¨æˆ·å¯¹Docker imageæœ‰ä¸åŒçš„è¯»å†™æƒé™ï¼ŒRegistryä¼šæŒ‡å‘ä¸€ä¸ªtokenæœåŠ¡ï¼Œå¼ºåˆ¶ç”¨æˆ·çš„æ¯æ¬¡docker pull/pushè¯·æ±‚éƒ½è¦æºå¸¦ä¸€ä¸ªåˆæ³•çš„token, Registryä¼šé€šè¿‡å…¬é’¥å¯¹token è¿›è¡Œè§£å¯†éªŒè¯ã€‚</li><li>registryctl: æ˜¯harborçš„ç®¡ç†å‘˜é…ç½®harborçš„ä¸€äº›å¸¸ç”¨é…ç½®å’Œé«˜çº§é…ç½®</li></ul><p>åœ¨æµè§ˆå™¨è®¿é—®<a href="http://reg.xxlaila.cnï¼Œ" target="_blank" rel="noopener">http://reg.xxlaila.cnï¼Œ</a> ç”¨è´¦å· admin å’Œ harbor.yml é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å¯†ç  Harbor12345 ç™»é™†ç³»ç»Ÿ<br><img src="https://img.xxlaila.cn/8095d05-b9b7-4bdc-b0fc-7810db649e23.png" alt="img"><br><img src="https://img.xxlaila.cn/4bfab8be-e5de-4165-9268-fa591c5f12f8.png" alt="img"></p><h4 id="harbor-è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•"><a href="#harbor-è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•" class="headerlink" title="harbor è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•"></a>harbor è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harbor å°†æ—¥å¿—æ‰“å°åˆ° /var/log/harbor çš„ç›¸å…³ç›®å½•ä¸‹ï¼Œä¼ ç»Ÿçš„docker logs XXX æˆ– docker-compose logs XXX çœ‹ä¸åˆ°å®¹å™¨çš„æ—¥å¿—ã€‚åªæœ‰ä½¿ç”¨å¸¸ç”¨ç³»ç»Ÿå‘½ä»¤æ¥è¿›è¡Œæ—¥å¿—çš„æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># # æ—¥å¿—ç›®å½•</span></span><br><span class="line"><span class="comment"># ls /var/log/harbor</span></span><br><span class="line">core.log  jobservice.log  portal.log  postgresql.log  proxy.log  redis.log  registryctl.log  registry.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># # æ•°æ®ç›®å½•ï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€é•œåƒä»“åº“</span></span><br><span class="line"><span class="comment"># ls /data/</span></span><br><span class="line">ca_download  database  job_logs  psc  redis  registry  secret</span><br></pre></td></tr></table></figure><h4 id="å…¶å®ƒæ“ä½œ"><a href="#å…¶å®ƒæ“ä½œ" class="headerlink" title="å…¶å®ƒæ“ä½œ"></a>å…¶å®ƒæ“ä½œ</h4><p>ä¸‹åˆ—æ“ä½œçš„å·¥ä½œç›®å½•å‡ä¸ºè§£å‹ç¦»çº¿å®‰è£…æ–‡ä»¶åç”Ÿæˆçš„ harbor ç›®å½•ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># # åœæ­¢ harbor</span></span><br><span class="line"><span class="comment"># docker-compose down -v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # å¯åŠ¨ harbor</span></span><br><span class="line"><span class="comment"># docker-compose up -d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # æ›´ä¿®æ”¹çš„é…ç½®æ›´æ–°åˆ° docker-compose.yml æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># ./prepare</span></span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /opt/harbor</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Clearing the configuration file: /config/nginx/nginx.conf</span><br><span class="line">Clearing the configuration file: /config/core/env</span><br><span class="line">Clearing the configuration file: /config/core/app.conf</span><br><span class="line">Clearing the configuration file: /config/registry/config.yml</span><br><span class="line">Clearing the configuration file: /config/registry/root.crt</span><br><span class="line">Clearing the configuration file: /config/registryctl/env</span><br><span class="line">Clearing the configuration file: /config/registryctl/config.yml</span><br><span class="line">Clearing the configuration file: /config/db/env</span><br><span class="line">Clearing the configuration file: /config/jobservice/env</span><br><span class="line">Clearing the configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">loaded secret from file: /secret/keys/secretkey</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>harbor</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s podå¥åº·æ£€æµ‹</title>
    <url>/2019/09/27/k8s-pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="Podå¥åº·æ£€æµ‹æœºåˆ¶"><a href="#Podå¥åº·æ£€æµ‹æœºåˆ¶" class="headerlink" title="Podå¥åº·æ£€æµ‹æœºåˆ¶"></a>Podå¥åº·æ£€æµ‹æœºåˆ¶</h3><p>å¯¹äºPodçš„å¥åº·çŠ¶æ€æ£€æµ‹ï¼Œkubernetesæä¾›äº†ä¸¤ç±»æ¢é’ˆ(Probe)æ¥æ‰§è¡Œå¯¹Podçš„å¥åº·çŠ¶æ€æ£€æµ‹:</p><ul><li><strong>LivenessProbeæ¢é’ˆ</strong>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå³Podæ˜¯å¦ä¸ºrunningçŠ¶æ€ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†killæ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥æ˜¯å¦é‡å¯ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œåˆ™Kubeletè®¤ä¸ºå®¹å™¨çš„LivenessProbeæ¢é’ˆçš„è¿”å›å€¼æ°¸è¿œæˆåŠŸ.</li></ul><a id="more"></a><ul><li><strong>ReadinessProbeæ¢é’ˆ</strong>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œå³å®¹å™¨çš„Readyæ˜¯å¦ä¸ºTrueï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœReadinessProbeæ¢æµ‹å¤±è´¥ï¼Œåˆ™å®¹å™¨çš„Readyå°†ä¸ºFalseï¼Œæ§åˆ¶å™¨å°†æ­¤Podçš„Endpointä»å¯¹åº”çš„serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»æ­¤ä¸å†å°†ä»»ä½•è¯·æ±‚è°ƒåº¦æ­¤Podä¸Šï¼Œç›´åˆ°ä¸‹æ¬¡æ¢æµ‹æˆåŠŸã€‚</li></ul><!--more--><p>æ¯ç±»æ¢é’ˆéƒ½æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹æ³•:</p><ul><li><strong>ExecAction</strong>: é€šè¿‡æ‰§è¡Œå‘½ä»¤æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œé’ˆå¯¹å¤æ‚æ£€æµ‹æˆ–æ— HTTPæ¥å£çš„æœåŠ¡ï¼Œå‘½ä»¤è¿”å›å€¼ä¸º0åˆ™è¡¨ç¤ºå®¹å™¨å¥åº·ã€‚</li><li><strong>HTTPGetAction</strong>: é€šè¿‡å‘é€httpè¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œè¿”å›200-399çŠ¶æ€ç åˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li><li><strong>TCPSocketAction</strong>: é€šè¿‡å®¹å™¨çš„IPå’ŒPortæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li></ul><p>æ¢é’ˆæ¢æµ‹çš„ç»“æœæœ‰ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€:</p><ul><li><strong>Success</strong>: Containeré€šè¿‡äº†æ£€æŸ¥</li><li><strong>Failure</strong>: Containeræœªé€šè¿‡æ£€æŸ¥</li><li><strong>Unknown</strong>: æœªèƒ½æ‰§è¡Œæ£€æŸ¥ï¼Œå› æ­¤ä¸é‡‡å–ä»»ä½•æªæ–½</li></ul><h3 id="LivenessProbeæ¢é’ˆé…ç½®"><a href="#LivenessProbeæ¢é’ˆé…ç½®" class="headerlink" title="LivenessProbeæ¢é’ˆé…ç½®"></a>LivenessProbeæ¢é’ˆé…ç½®</h3><h4 id="ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹</h4><ul><li>exec-liveness.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; <span class="built_in">exec</span>-liveness.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">test</span>: liveness</span><br><span class="line">  name: liveness-exec</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">    - /bin/sh</span><br><span class="line">    - -c</span><br><span class="line">    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><br><span class="line">    livenessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - cat</span><br><span class="line">        - /tmp/healthy</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 5</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹å®¹å™¨æ‰§è¡ŒlivenessProbeæ£€æŸ¥ï¼ŒperiodSecondså­—æ®µæŒ‡å®škubeletæ¯5sæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œæ£€æŸ¥çš„å‘½ä»¤ä¸ºcat /tmp/healthyï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletåº”è¯¥åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ä¹‹å‰ç­‰å¾…5ç§’ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›0ï¼Œé‚£ä¹ˆkubeletå°±è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸ºé0ï¼Œåˆ™Kubeletä¼šKillæ‰å®¹å™¨å¹¶æ ¹æ®é‡å¯ç­–ç•¥æ¥å†³å®šæ˜¯å¦éœ€è¦é‡å¯ã€‚</p><ul><li>å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/bin/sh -c <span class="string">"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯¹äºå®¹å™¨çš„å‰30ç§’ï¼Œæœ‰ä¸€ä¸ª/tmp/healthyæ–‡ä»¶ã€‚å› æ­¤ï¼Œåœ¨å‰30ç§’å†…ï¼Œè¯¥å‘½ä»¤cat /tmp/healthyè¿”å›æˆåŠŸä»£ç ã€‚30ç§’åï¼Œcat /tmp/healthyè¿”å›å¤±è´¥ä»£ç ã€‚</p><ul><li><p>åˆ›å»ºPod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl create -f  <span class="built_in">exec</span>-liveness.yaml </span><br><span class="line">pod/liveness-exec created</span><br></pre></td></tr></table></figure></li><li><p>åœ¨30ç§’å†…ï¼ŒæŸ¥çœ‹Podäº‹ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                   Message</span><br><span class="line">  ----    ------     ----  ----                   -------</span><br><span class="line">  Normal  Scheduled  23s   default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Normal  Pulling    20s   kubelet, 172.21.17.34  Pulling image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Pulled     2s    kubelet, 172.21.17.34  Successfully pulled image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Created    2s    kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal  Started    1s    kubelet, 172.21.17.34  Started container liveness</span><br></pre></td></tr></table></figure></li><li><p>35ç§’åï¼Œå†æ¬¡æŸ¥çœ‹Podäº‹ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age              From                   Message</span><br><span class="line">  ----     ------     ----             ----                   -------</span><br><span class="line">  Normal   Scheduled  58s              default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Normal   Pulling    55s              kubelet, 172.21.17.34  Pulling image <span class="string">"busybox"</span></span><br><span class="line">  Normal   Pulled     37s              kubelet, 172.21.17.34  Successfully pulled image <span class="string">"busybox"</span></span><br><span class="line">  Normal   Created    37s              kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal   Started    36s              kubelet, 172.21.17.34  Started container liveness</span><br><span class="line">  Warning  Unhealthy  0s (x2 over 5s)  kubelet, 172.21.17.34  Liveness probe failed: cat: can<span class="string">'t open '</span>/tmp/healthy<span class="string">': No such file or directory</span></span><br></pre></td></tr></table></figure></li><li><p>å†ç­‰30ç§’ï¼Œç¡®è®¤Containerå·²é‡æ–°å¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod liveness-exec</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-exec   1/1     Running   1          115s</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                 From                   Message</span><br><span class="line">  ----     ------     ----                ----                   -------</span><br><span class="line">  Normal   Scheduled  2m7s                default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Warning  Unhealthy  64s (x3 over 74s)   kubelet, 172.21.17.34  Liveness probe failed: cat: can<span class="string">'t open '</span>/tmp/healthy<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">  Normal   Killing    64s                 kubelet, 172.21.17.34  Container liveness failed liveness probe, will be restarted</span></span><br><span class="line"><span class="string">  Normal   Pulling    34s (x2 over 2m4s)  kubelet, 172.21.17.34  Pulling image "busybox"</span></span><br><span class="line"><span class="string">  Normal   Pulled     25s (x2 over 106s)  kubelet, 172.21.17.34  Successfully pulled image "busybox"</span></span><br><span class="line"><span class="string">  Normal   Created    25s (x2 over 106s)  kubelet, 172.21.17.34  Created container liveness</span></span><br><span class="line"><span class="string">  Normal   Started    25s (x2 over 105s)  kubelet, 172.21.17.34  Started container liveness</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; http-liveness.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">test</span>: liveness</span><br><span class="line">  name: liveness-http</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: carlziess/liveness</span><br><span class="line">    args:</span><br><span class="line">    - /server</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /healthz</span><br><span class="line">        port: 8080</span><br><span class="line">        httpHeaders:</span><br><span class="line">        - name: X-Custom-Header</span><br><span class="line">          value: Awesome</span><br><span class="line">      initialDelaySeconds: 3</span><br><span class="line">      periodSeconds: 3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ªPodï¼Œå…¶ä¸­periodSecondså­—æ®µæŒ‡å®škubeletæ¯3ç§’æ‰§è¡Œä¸€æ¬¡æ¢æµ‹ï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletå»¶è¿Ÿç­‰å¾…3ç§’ï¼Œæ¢æµ‹æ–¹å¼ä¸ºå‘å®¹å™¨ä¸­è¿è¡Œçš„æœåŠ¡å‘é€HTTP GETè¯·æ±‚ï¼Œè¯·æ±‚8080ç«¯å£ä¸‹çš„/healthz, ä»»ä½•å¤§äºæˆ–ç­‰äº200ä¸”å°äº400çš„ä»£ç è¡¨ç¤ºæˆåŠŸã€‚ä»»ä½•å…¶ä»–ä»£ç è¡¨ç¤ºå¤±è´¥ã€‚</p><ul><li><p>åˆ›å»ºpod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f http-liveness.yaml </span><br><span class="line">pod/liveness-http created</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-http</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                   From                   Message</span><br><span class="line">  ----     ------     ----                  ----                   -------</span><br><span class="line">  Normal   Scheduled  2m59s                 default-scheduler      Successfully assigned default/liveness-http to 172.21.17.34</span><br><span class="line">  Normal   Pulled     119s (x3 over 2m46s)  kubelet, 172.21.17.34  Successfully pulled image <span class="string">"carlziess/liveness"</span></span><br><span class="line">  Normal   Created    119s (x3 over 2m46s)  kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal   Started    118s (x3 over 2m45s)  kubelet, 172.21.17.34  Started container liveness</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-http   1/1     Running   0          26s</span><br></pre></td></tr></table></figure></li><li><p><strong>httpGet</strong>æ¢æµ‹æ–¹å¼æœ‰å¦‚ä¸‹å¯é€‰çš„æ§åˆ¶å­—æ®µ</p><ul><li>host: è¦è¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤ä¸ºPod IPï¼Œå¯ä»¥åœ¨http request headä¸­è®¾ç½®hostå¤´éƒ¨ã€‚</li><li>scheme: ç”¨äºè¿æ¥hostçš„åè®®ï¼Œé»˜è®¤ä¸ºHTTPã€‚</li><li>path: httpæœåŠ¡å™¨ä¸Šçš„è®¿é—®URL</li><li>httpHeaders: è‡ªå®šä¹‰HTTPè¯·æ±‚headersï¼ŒHTTPå…è®¸é‡å¤headers</li><li>port: å®¹å™¨ä¸Šè¦è®¿é—®ç«¯å£å·æˆ–åç§°</li></ul></li></ul><h4 id="ä¾‹ä¸‰-é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹ä¸‰-é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹ä¸‰: é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹ä¸‰: é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹</h4><p>Kubeletå°†å°è¯•åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šæ‰“å¼€å®¹å™¨ä¸Šçš„å¥—æ¥å­—ï¼Œå¦‚æœèƒ½å»ºç«‹è¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; tcp-liveness-readiness.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: goproxy</span><br><span class="line">  labels:</span><br><span class="line">    app: goproxy</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: goproxy</span><br><span class="line">    image: goproxy/goproxy</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    readinessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      periodSeconds: 20</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCPæ£€æŸ¥æ–¹å¼å’ŒHTTPæ£€æŸ¥æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œç¤ºä¾‹ä¸­ä¸¤ç§æ¢é’ˆéƒ½ä½¿ç”¨äº†ï¼Œåœ¨å®¹å™¨å¯åŠ¨5ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªreadinessProbeæ¢é’ˆï¼Œè¿™å°†è¿æ¥åˆ°å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœæ¢æµ‹æˆåŠŸï¼Œåˆ™è¯¥Podå°†è¢«æ ‡è¯†ä¸ºreadyï¼Œ10ç§’åï¼Œkubeletå°†è¿›è¡Œç¬¬äºŒæ¬¡è¿æ¥ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é™¤æ­¤ï¼Œé…ç½®è¿˜åŒ…å«äº†livenessProbeæ¢é’ˆï¼Œåœ¨å®¹å™¨å¯åŠ¨15ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªlivenessProbeæ¢é’ˆï¼Œä»ç„¶å°è¯•è¿æ¥å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœè¿æ¥å¤±è´¥åˆ™é‡å¯å®¹å™¨ã€‚</p><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f tcp-liveness-readiness.yaml</span><br><span class="line">pod/goproxy created</span><br></pre></td></tr></table></figure></li><li><p>15ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ä»¥éªŒè¯æ´»åŠ¨æ¢æµ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod goproxy</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                    Message</span><br><span class="line">  ----    ------     ----  ----                    -------</span><br><span class="line">  Normal  Scheduled  26s   default-scheduler       Successfully assigned default/goproxy to 172.21.16.231</span><br><span class="line">  Normal  Pulling    22s   kubelet, 172.21.16.231  Pulling image <span class="string">"goproxy/goproxy"</span></span><br></pre></td></tr></table></figure></li></ul><p>å½“å®¹å™¨æœ‰å¤šä¸ªç«¯å£æ—¶ï¼Œé€šå¸¸ä¼šç»™æ¯ä¸ªç«¯å£å‘½åï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ¢é’ˆæ¢æµ‹æ—¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™è‡ªå®šä¹‰çš„ç«¯å£åç§°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- name: liveness-port</span><br><span class="line">  containerPort: 8080</span><br><span class="line">  hostPort: 8080</span><br><span class="line">livenessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /healthz</span><br><span class="line">    port: liveness-port</span><br></pre></td></tr></table></figure><h3 id="ReadinessProbeæ¢é’ˆé…ç½®"><a href="#ReadinessProbeæ¢é’ˆé…ç½®" class="headerlink" title="ReadinessProbeæ¢é’ˆé…ç½®"></a>ReadinessProbeæ¢é’ˆé…ç½®</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeæ¢é’ˆçš„ä½¿ç”¨åœºæ™¯livenessProbeç¨æœ‰ä¸åŒï¼Œæœ‰çš„æ—¶å€™åº”ç”¨ç¨‹åºå¯èƒ½æš‚æ—¶æ— æ³•æ¥å—è¯·æ±‚ï¼Œæ¯”å¦‚Podå·²ç»Runningäº†ï¼Œä½†æ˜¯å®¹å™¨å†…åº”ç”¨ç¨‹åºå°šæœªå¯åŠ¨æˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰ReadinessProbeï¼Œåˆ™Kubernetesè®¤ä¸ºå®ƒå¯ä»¥å¤„ç†è¯·æ±‚äº†ï¼Œç„¶è€Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ç¨‹åºè¿˜æ²¡å¯åŠ¨æˆåŠŸæ˜¯ä¸èƒ½æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¸å¸Œæœ›kubernetesæŠŠè¯·æ±‚è°ƒåº¦ç»™å®ƒï¼Œåˆ™ä½¿ç”¨ReadinessProbeæ¢é’ˆã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeå’ŒlivenessProbeå¯ä»¥ä½¿ç”¨ç›¸åŒæ¢æµ‹æ–¹å¼ï¼Œåªæ˜¯å¯¹Podçš„å¤„ç½®æ–¹å¼ä¸åŒï¼ŒReadinessProbeæ˜¯å°†Pod IP:Portä»å¯¹åº”çš„EndPointåˆ—è¡¨ä¸­åˆ é™¤ï¼Œè€ŒlivenessProbeåˆ™Killå®¹å™¨å¹¶æ ¹æ®Podçš„é‡å¯ç­–ç•¥æ¥å†³å®šä½œå‡ºå¯¹åº”çš„æªæ–½ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢é’ˆæ¢æµ‹å®¹å™¨æ˜¯å¦å·²å‡†å¤‡å°±ç»ªï¼Œå¦‚æœæœªå‡†å¤‡å°±ç»ªåˆ™kubernetesä¸ä¼šå°†æµé‡è½¬å‘ç»™æ­¤Podã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeæ¢é’ˆä¸livenessProbeä¸€æ ·ä¹Ÿæ”¯æŒexecã€httpGetã€TCPçš„æ¢æµ‹æ–¹å¼ï¼Œé…ç½®æ–¹å¼ç›¸åŒï¼Œåªä¸è¿‡æ˜¯å°†livenessProbeå­—æ®µä¿®æ”¹ä¸ºReadinessProbeã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">readinessProbe:</span><br><span class="line">  <span class="built_in">exec</span>:</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - cat</span><br><span class="line">    - /tmp/healthy</span><br><span class="line">  initialDelaySeconds: 5</span><br><span class="line">  periodSeconds: 5</span><br></pre></td></tr></table></figure><p>ReadinessProbeæ¢é’ˆçš„HTTPã€TCPçš„æ¢æµ‹æ–¹å¼ä¹Ÿä¸livenessProbeçš„åŸºæœ¬ä¸€è‡´ã€‚</p><h4 id="ä¾‹å››-ReadinessProbeç¤ºä¾‹"><a href="#ä¾‹å››-ReadinessProbeç¤ºä¾‹" class="headerlink" title="ä¾‹å››: ReadinessProbeç¤ºä¾‹"></a>ä¾‹å››: ReadinessProbeç¤ºä¾‹</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ å…¥ReadinessProbeæ¢é’ˆå’Œä¸€ä¸ªæ²¡æœ‰ReadinessProbeæ¢é’ˆçš„ç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªdeployï¼Œåä¸ºJavaAppï¼Œå¯åŠ¨çš„å®¹å™¨è¿è¡Œä¸€ä¸ªjavaåº”ç”¨ç¨‹åºï¼Œç¨‹åºç›‘å¬ç«¯å£ä¸º9093ã€‚</p><ul><li><p>æ²¡æœ‰ReadinessProbe</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; k8s.yaml &lt;&lt; EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  labels:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9093</span><br><span class="line">    name: biz-gateway</span><br><span class="line">  selector:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: biz-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: biz-gateway</span><br><span class="line">        image: docker.io/xxlaila/biz-gateway:dev-08c8a4e</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9093</span><br><span class="line">        env:</span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: dev</span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.cn</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f k8s.yaml </span><br><span class="line">service/biz-gateway created</span><br><span class="line">deployment.extensions/biz-gateway created</span><br></pre></td></tr></table></figure></li><li><p>åˆšåˆ›å»ºåï¼Œç­‰ä¸€ä¼šåï¼ŒæŸ¥çœ‹PodçŠ¶æ€ï¼Œè®°ç€è¦ç»™imageç•™ä¸‹pullçš„æ—¶é—´</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods  |grep <span class="string">"biz-gateway"</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">biz-gateway-95f6b677f-rnz22   1/1     Running   0          2m8s</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªè¿‡ç¨‹Podç”¨äº†2m8sï¼Œè‡ªèº«çŠ¶æ€å·²Runningï¼Œå…¶READå­—æ®µï¼Œ1/1 è¡¨ç¤º1ä¸ªå®¹å™¨çŠ¶æ€å·²å‡†å¤‡å°±ç»ªäº†ï¼Œæ­¤æ—¶ï¼Œå¯¹äºkubernetesè€Œè¨€ï¼Œå·²ç»å¯ä»¥æ¥æ”¶è¯·æ±‚äº†,è€Œå®é™…ä¸ŠæœåŠ¡è¿˜æ— æ³•è®¿é—®ï¼Œå› ä¸ºJAVAç¨‹åºè¿˜å°šå¯åŠ¨èµ·æ¥ï¼Œ2m8ssåæ–¹å¯æ­£å¸¸è®¿é—®ï¼Œæ‰€ä»¥é’ˆå¯¹æ­¤ç±»ç¨‹åºï¼Œå¿…é¡»é…ç½®ReadinessProbeã€‚</p><ul><li>åŠ å…¥readinessProbe<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; k8s.yaml &lt;&lt; EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  labels:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 9093</span><br><span class="line">    name: biz-gateway</span><br><span class="line">  selector:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: biz-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: biz-gateway</span><br><span class="line">        image: docker.io/xxlaila/biz-gateway:dev-08c8a4e</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9093</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9093</span><br><span class="line">          initialDelaySeconds: 140</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        env:</span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: dev</span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.cn</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼ŒReadinessProbeæ¢é’ˆçš„æ¢æµ‹æ–¹å¼ä¸ºtcpSocketï¼Œå› ä¸ºç¨‹åºç›‘å¬åœ¨9093ç«¯å£ï¼Œæ‰€ä»¥è¿™é‡Œæ¢æµ‹ä¸ºå¯¹9093å»ºç«‹è¿æ¥,è¿™é‡Œç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æ˜¯åœ¨Pod Runingå140ç§’åï¼Œé—´éš”10ç§’åæ‰§è¡Œç¬¬äºŒæ¬¡æ¢æµ‹ã€‚</p><ul><li><p>åˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f ./</span><br><span class="line">service/biz-gateway created</span><br><span class="line">deployment.extensions/biz-gateway created</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåç­‰å¾…äº†60s</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP            NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">biz-gateway-f69cc8678-qs8s7   0/1     Running   0          60s   172.30.56.6   172.21.17.40   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­ç­‰å¾…ä¸€ä¼š</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">biz-gateway-f69cc8678-qs8s7   1/1     Running   0          2m36s   172.30.56.6   172.21.17.40   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°åœ¨2m36ç§’åï¼Œpodå¯åŠ¨okï¼Œåœ¨ç¬¬ä¸€æ¬¡æŸ¥çœ‹çš„æ—¶å€™ï¼ŒPodè™½ç„¶å·²å¤„äºRunnigçŠ¶æ€ï¼Œä½†æ˜¯ç”±äºç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æœªåˆ°ï¼Œæ‰€ä»¥READYå­—æ®µä¸º0/1ï¼Œå³å®¹å™¨çš„çŠ¶æ€ä¸ºæœªå‡†å¤‡å°±ç»ªï¼Œåœ¨æœªå‡†å¤‡å°±ç»ªçš„æƒ…å†µä¸‹ï¼Œå…¶Podå¯¹åº”çš„Serviceä¸‹çš„Endpointä¹Ÿä¸ºç©ºï¼Œæ‰€ä»¥æ‰ä¸ä¼šæœ‰ä»»ä½•è¯·æ±‚è¢«è°ƒåº¦è¿›æ¥ã€‚</p><ul><li>æŸ¥çœ‹Endpoint<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ¬¡æ‰§è¡Œ</span></span><br><span class="line">$ kubectl get endpoints</span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">biz-gateway                                                            57s</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   13d</span><br><span class="line"></span><br><span class="line">åœ¨2m36sååœ¨æ¬¡æ‰§è¡Œ</span><br><span class="line">$ kubectl get endpoints</span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">biz-gateway   172.30.56.6:9093                                         2m41s</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   13d</span><br></pre></td></tr></table></figure></li></ul><h3 id="é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§"><a href="#é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§" class="headerlink" title="é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§"></a>é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢é’ˆ(Probe)æœ‰è®¸å¤šå¯é€‰å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æ›´åŠ ç²¾ç¡®çš„æ§åˆ¶Livenesså’ŒReadinessä¸¤ç§æ¢é’ˆçš„è¡Œä¸º(Probe)ï¼š</p><ul><li>initialDelaySecondsï¼šPodå¯åŠ¨åå»¶è¿Ÿå¤šä¹…æ‰è¿›è¡Œæ£€æŸ¥ï¼Œå•ä½ï¼šç§’</li><li>periodSecondsï¼šæ£€æŸ¥çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º10ï¼Œå•ä½ï¼šç§’ã€‚</li><li>timeoutSecondsï¼šæ¢æµ‹çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º1ï¼Œå•ä½ï¼šç§’ã€‚</li><li>successThresholdï¼šæ¢æµ‹å¤±è´¥åè®¤ä¸ºæˆåŠŸçš„æœ€å°è¿æ¥æˆåŠŸæ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œåœ¨Livenessæ¢é’ˆä¸­å¿…é¡»ä¸º1ï¼Œæœ€å°å€¼ä¸º1ã€‚</li><li>failureThresholdï¼šæ¢æµ‹å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•ä¸€å®šæ¬¡æ•°åå°†è®¤ä¸ºå¤±è´¥ï¼Œåœ¨readinessæ¢é’ˆä¸­ï¼ŒPodä¼šè¢«æ ‡è®°ä¸ºæœªå°±ç»ªï¼Œé»˜è®¤ä¸º3ï¼Œæœ€å°å€¼ä¸º1ã€‚</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>ä¹‹å‰é”™è¯¯å‚è€ƒæ’æŸ¥ä»‹ç»</strong>: åœ¨ä¹‹å‰å®‰è£…jenkinsçš„æ—¶å€™ï¼Œåˆ›å»ºpodå°±ä¸€å€¼å¤„äº<code>running</code>,ä½†æ˜¯è¿‡ä¸€ä¼šï¼Œç•Œé¢å°±æŠ¥é”™ï¼Œé”™è¯¯å¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/15008WechatIMG.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç„¶åæŸ¥çœ‹podæ—¥å¿—å’Œç³»ç»Ÿç³»ç»Ÿï¼Œéƒ½æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œpodæ—¥å¿—å¦‚ä¸‹ï¼Œç„¶åå°±é—®äº†æœ‹å‹ï¼Œå°±è¯´æœ‰å¯èƒ½æ˜¯podçš„å¥åº·æ£€æµ‹æœºåˆ¶ï¼Œæœ€åå°±ä¿®æ”¹äº†podçš„å¥åº·æ£€æµ‹æœºåˆ¶ï¼ŒjenkinsæœåŠ¡å™¨éƒ¨ç½²okã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">log</span> $(kubectl get pods -n kube-ops | awk <span class="string">'&#123;print $1&#125;'</span> | grep jenkins) -n kube-ops</span><br><span class="line"><span class="built_in">log</span> is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use logs instead.</span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size: 3.00G</span><br><span class="line">    Ergonomics Machine Class: server</span><br><span class="line">    Using VM: OpenJDK 64-Bit Server VM</span><br><span class="line"></span><br><span class="line">Running from: /usr/share/jenkins/jenkins.war</span><br><span class="line">webroot: EnvVars.masterEnvVars.get(<span class="string">"JENKINS_HOME"</span>)</span><br><span class="line">2019-09-27 03:02:24.133+0000 [id=1] INFO org.eclipse.jetty.util.log.Log<span class="comment">#initialized: Logging initialized @429ms to org.eclipse.jetty.util.log.JavaUtilLog</span></span><br><span class="line">2019-09-27 03:02:24.247+0000 [id=1] INFO winstone.Logger<span class="comment">#logInternal: Beginning extraction from war file</span></span><br></pre></td></tr></table></figure><p><strong>åç»­</strong>: è™½ç„¶å¥åº·æ£€æµ‹å¯ä»¥å–æ¶ˆï¼Œä¸åŠ å…¥ï¼Œä½†æ˜¯å½“æˆ‘ä»¬åœ¨ä¸Šç”Ÿäº§ç¯å¢ƒçš„æ—¶å€™è¿˜æ˜¯è¦åŠ ä¸Šï¼Œæ­£å¦‚ä¾‹å››ä»‹ç»çš„é‚£æ ·ã€‚å¦‚æœæˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒé”™æ•…éšœè‡ªæ„ˆã€è½®è¯¢å‘å¸ƒç­‰ã€‚éƒ½éœ€è¦è¿™ä¸ªä¸œè¥¿ï¼ŒåŠ å…¥å†å‡çº§çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨éƒ½è¿˜æ²¡èµ·æ¥ï¼Œk8så°±å§æµé‡ç»™è°ƒåº¦è¿‡æ¥ï¼Œå‡çº§ä¸‹ä¸€ä¸ªpodï¼Œå¤–éƒ¨ç”¨æˆ·è®¿é—®å°±ä¼šæŠ¥é”™ï¼Œé‚£å°±æ˜¯å¾ˆå°´å°¬</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pod</tag>
      </tags>
  </entry>
  <entry>
    <title>EFK</title>
    <url>/2019/09/25/EFK/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡"><a href="#åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡" class="headerlink" title="åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡"></a>åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚<code>kubernetes/cluster/addons/fluentd-elasticsearch</code>è¿™æ˜¯æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;es æ•°æ®é»˜è®¤çš„å­˜å‚¨åœ¨dockeré‡Œé¢ï¼Œåœ¨ç”¨çš„æ˜¯nodeèŠ‚ç‚¹çš„ç©ºé—´ï¼Œè€ŒnodeèŠ‚ç‚¹æˆ‘ä»¬ä¸å¯èƒ½éƒ½å‡†å¤‡å¾ˆå¤§çš„ç©ºé—´ï¼Œé‚£æ ·å¾ˆæµªè´¹èµ„æºï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å‡†å¤‡å¤–éƒ¨çš„nfså­˜å‚¨ç©ºé—´ï¼Œç„¶åé€šè¿‡<a href="https://xxlaila.github.io/2019/09/24/%E5%88%A9%E7%94%A8NFS%E5%8A%A8%E6%80%81%E6%8F%90%E4%BE%9BKubernetes%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8%E5%8D%B7/" target="_blank" rel="noopener">pv</a>çš„æ¨¡å¼è¿›è¡ŒæŒ‚è½½ï¼Œæ•°æ®å­˜å‚¨åˆ°nfsæœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·ä¿éšœäº†esæ”¶é›†æ•°æ®çš„å¯ç”¨æ€§ã€‚</p><a id="more"></a><h3 id="åˆ›å»ºå­˜å‚¨ä»‹è´¨"><a href="#åˆ›å»ºå­˜å‚¨ä»‹è´¨" class="headerlink" title="åˆ›å»ºå­˜å‚¨ä»‹è´¨"></a>åˆ›å»ºå­˜å‚¨ä»‹è´¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; pvc.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: es-nfs-data</span><br><span class="line">provisioner: fuseim.pri/ifs</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc.yaml</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><ul><li><p>es-statefulset.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># RBAC authn and authz</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - <span class="string">"services"</span></span><br><span class="line">  - <span class="string">"namespaces"</span></span><br><span class="line">  - <span class="string">"endpoints"</span></span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">"get"</span></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># Elasticsearch deployment itself</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    version: v6.6.1</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  serviceName: elasticsearch-logging</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: elasticsearch-logging</span><br><span class="line">      version: v6.6.1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: elasticsearch-logging</span><br><span class="line">        version: v6.6.1</span><br><span class="line">        kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: elasticsearch-logging</span><br><span class="line">      containers:</span><br><span class="line">      - image: elasticsearch:6.6.1</span><br><span class="line">        name: elasticsearch-logging</span><br><span class="line">        resources:</span><br><span class="line">          <span class="comment"># need more cpu upon initialization, therefore burstable class</span></span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9200</span><br><span class="line">          name: db</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9300</span><br><span class="line">          name: transport</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: elasticsearch-logging</span><br><span class="line">          mountPath: /data</span><br><span class="line">        env:</span><br><span class="line">        - name: <span class="string">"NAMESPACE"</span></span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">      <span class="comment"># Elasticsearch requires vm.max_map_count to be at least 262144.</span></span><br><span class="line">      <span class="comment"># If your OS already sets up this number to a higher value, feel free</span></span><br><span class="line">      <span class="comment"># to remove this init container.</span></span><br><span class="line">      initContainers:</span><br><span class="line">      - image: alpine:3.6</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">"/sbin/sysctl"</span>, <span class="string">"-w"</span>, <span class="string">"vm.max_map_count=262144"</span>]</span><br><span class="line">        name: elasticsearch-logging-init</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: <span class="literal">true</span></span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: elasticsearch-logging</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteMany"</span> ]</span><br><span class="line">      storageClassName: <span class="string">"es-nfs-data"</span></span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 30Gi</span><br></pre></td></tr></table></figure></li><li><p>fluentd-es-ds.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - <span class="string">"namespaces"</span></span><br><span class="line">  - <span class="string">"pods"</span></span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">"get"</span></span><br><span class="line">  - <span class="string">"watch"</span></span><br><span class="line">  - <span class="string">"list"</span></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es-v2.4.0</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    version: v2.4.0</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: fluentd-es</span><br><span class="line">      version: v2.4.0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: fluentd-es</span><br><span class="line">        kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">        version: v2.4.0</span><br><span class="line">      <span class="comment"># This annotation ensures that fluentd does not get evicted if the node</span></span><br><span class="line">      <span class="comment"># supports critical pod annotation based priority scheme.</span></span><br><span class="line">      <span class="comment"># Note that this does not guarantee admission on the nodes (#40573).</span></span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'docker/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-node-critical</span><br><span class="line">      serviceAccountName: fluentd-es</span><br><span class="line">      containers:</span><br><span class="line">      - name: fluentd-es</span><br><span class="line">        image: docker.io/xxlaila/fluentd-elasticsearch:v2.4.0</span><br><span class="line">        env:</span><br><span class="line">        - name: FLUENTD_ARGS</span><br><span class="line">          value: --no-supervisor -q</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: varlog</span><br><span class="line">          mountPath: /var/<span class="built_in">log</span></span><br><span class="line">        - name: varlibdockercontainers</span><br><span class="line">          mountPath: /var/lib/docker/containers</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/fluent/config.d</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: varlog</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/<span class="built_in">log</span></span><br><span class="line">      - name: varlibdockercontainers</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/lib/docker/containers</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: fluentd-es-config-v0.2.0</span><br></pre></td></tr></table></figure></li><li><p>kibana-deployment.yaml<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ³¨é‡Šé‡Œé¢çš„ä¸¤è¡Œé…ç½®,ä¸æ³¨é‡Šçš„è¯ï¼Œæ‰“å¼€kibanaçš„æ—¶å€™ä¼šæç¤º<code>kibana {&quot;statusCode&quot;:404,&quot;error&quot;:&quot;Not Found&quot;,&quot;message&quot;:&quot;Not Found&quot;}</code>,å‚è€ƒ<a href="https://github.com/kubernetes-sigs/kubespray/issues/3322" target="_blank" rel="noopener">è§£å†³æ–¹æ¡ˆ</a>,æ³¨é‡Šé…ç½®å¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- name: SERVER_BASEPATH</span><br><span class="line">  value: /api/v1/namespaces/kube-system/services/kibana-logging/proxy</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f ./</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹åˆ›å»º"><a href="#æŸ¥çœ‹åˆ›å»º" class="headerlink" title="æŸ¥çœ‹åˆ›å»º"></a>æŸ¥çœ‹åˆ›å»º</h4><ul><li><p>æŸ¥çœ‹pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system |egrep <span class="string">"kibana|elasticsearch|fluentd"</span></span><br><span class="line">elasticsearch-logging-0                       1/1     Running   0          65m</span><br><span class="line">elasticsearch-logging-1                       1/1     Running   0          61m</span><br><span class="line">fluentd-es-v2.4.0-4fp28                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-b7k67                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-f8jzp                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-shwzm                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-ww8r8                       1/1     Running   0          30m</span><br><span class="line">kibana-logging-57b55f58bc-xh5lp               1/1     Running   0          6m35s</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹service</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc -n kube-system |egrep <span class="string">"kibana|elasticsearch"</span></span><br><span class="line">elasticsearch-logging     ClusterIP   10.254.30.110    &lt;none&gt;        9200/TCP                 9s</span><br><span class="line">kibana-logging            ClusterIP   10.254.188.5     &lt;none&gt;        5601/TCP                 16h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹pvï¼Œpvc</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl get pv,pvc -n kube-system</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                                       STORAGECLASS   REASON   AGE</span><br><span class="line">persistentvolume/pvc-65fdd14e-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            Delete           Bound    kube-system/elasticsearch-logging-elasticsearch-logging-0   es-nfs-data             21m</span><br><span class="line">persistentvolume/pvc-fe818f55-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            Delete           Bound    kube-system/elasticsearch-logging-elasticsearch-logging-1   es-nfs-data             16m</span><br><span class="line"></span><br><span class="line">NAME                                                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">persistentvolumeclaim/elasticsearch-logging-elasticsearch-logging-0   Bound    pvc-65fdd14e-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            es-nfs-data    21m</span><br><span class="line">persistentvolumeclaim/elasticsearch-logging-elasticsearch-logging-1   Bound    pvc-fe818f55-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            es-nfs-data    17m</span><br></pre></td></tr></table></figure></li></ul><h3 id="åˆ›å»ºwebè®¿é—®"><a href="#åˆ›å»ºwebè®¿é—®" class="headerlink" title="åˆ›å»ºwebè®¿é—®"></a>åˆ›å»ºwebè®¿é—®</h3><ul><li><p>kibana-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; kibana-Ingress.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: kibana.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kibana-logging</span><br><span class="line">          servicePort: 5601</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>es-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; es-Ingress &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: es-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: es.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: elasticsearch-logging</span><br><span class="line">          servicePort: 9200</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f es-Ingress.yaml kibana-Ingress.yaml</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æµè§ˆå™¨è®¿é—®es<br><img src="https://img.xxlaila.cn/1569462606884.jpg" alt="img"></p></li><li><p>æµè§ˆå™¨è®¿é—®kibana<br><img src="https://img.xxlaila.cn/1569464839630.jpg" alt="img"><br>å»ºç«‹ç´¢å¼•ï¼Œé»˜è®¤çš„ç´¢å¼•æ˜¯æ ¹æ®å¤©æ¥è‡ªåŠ¨åˆ›å»ºåœ¨esé‡Œé¢ï¼Œè¿™é‡Œæˆ‘æ˜¯åœ¨kibanaé‡Œé¢æ˜¯æ ¹æ®æœˆæ¥å´åˆ†çš„<br><img src="https://img.xxlaila.cn/1569464950776.jpg" alt="img"></p></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>efk</tag>
      </tags>
  </entry>
  <entry>
    <title>ç½‘ç»œçŠ¶æ€ç›‘æ§</title>
    <url>/2019/09/25/%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›‘æ§IDCæœºæˆ¿ç½‘ç»œè´¨é‡æƒ…å†µï¼Œæœ¬åœ°åŒºåˆ°å…¶ä»–åœ°åŒºï¼Œå…¶ä»–åœ°åŒºåˆ°æœ¬èŠ‚ç‚¹ï¼Œæˆ–è€…å„çœå¸‚æ—¶é—´ç½‘ç»œã€è¿è¥å•†ç½‘ç»œçŠ¶æ€ï¼Œç›‘è§†ç½‘ç»œæ€§èƒ½ï¼ŒåŒ…æ‹¬å¸¸è§„çš„ pingï¼Œç”¨ fpingã€echopingã€tracert ç›‘è§† www æœåŠ¡å™¨æ€§èƒ½ï¼Œç›‘è§† dns æŸ¥è¯¢æ€§èƒ½ï¼Œç›‘è§† ssh æ€§èƒ½ç­‰ã€‚åº•å±‚ä¹Ÿæ˜¯ rrdtool åšæ”¯æŒï¼Œç‰¹ç‚¹æ˜¯ç”»çš„å›¾éå¸¸æ¼‚äº®ï¼Œç½‘ç»œä¸¢åŒ…å’Œå»¶è¿Ÿç”¨é¢œè‰²å’Œé˜´å½±æ¥è¡¨ç¤ºã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Smokepingã€‚æœ€æ–°ç‰ˆæœ¬çš„ Smokeping æ”¯æŒå¤šä¸ªèŠ‚ç‚¹çš„æ£€æµ‹ç»“æœä»ä¸€ä¸ªå›¾ä¸Šç”»å‡ºæ¥</p><a id="more"></a><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><h4 id="å®‰è£…yumæº"><a href="#å®‰è£…yumæº" class="headerlink" title="å®‰è£…yumæº"></a>å®‰è£…yumæº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm               </span></span><br><span class="line"><span class="comment"># rpm â€“Uvh http://mirrors.neusoft.edu.cn/epel/6/i386/epel-release-6-8.noarch.rpm</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ä¾èµ–åŒ…"><a href="#å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="å®‰è£…ä¾èµ–åŒ…"></a>å®‰è£…ä¾èµ–åŒ…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum â€“y install perl perl-Net-Telnet perl-Net-DNS perl-LDAP perl-libwww-perl perl-RadiusPerl perl-IO-Socket-SSL perl-Socket6 perl-CGI-SpeedyCGI perl-FCGI perl-CGI-SpeedCGI perl-Time-HiRes perl-ExtUtils-MakeMaker perl-RRD-Simple rrdtool rrdtool-perl curl fping echo</span></span><br><span class="line">ping  httpd httpd-devel gcc make  wget libxml2-devel libpng-devel glib pango pango-devel freetype freetype-devel fontconfig cairo cairo-devel libart_lgpl libart_lgpl-devel mod_fastcgi</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…smokeping"><a href="#å®‰è£…smokeping" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h3><h4 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget http://oss.oetiker.ch/smokeping/pub/smokeping-2.6.11.tar.gz è¿™é‡Œä¸‹è½½çš„æœ€æ–°ç‰ˆ</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…FCGI"><a href="#å®‰è£…FCGI" class="headerlink" title="å®‰è£…FCGI"></a>å®‰è£…FCGI</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf CGI-4.33.tar.gz</span></span><br><span class="line"><span class="comment"># cd CGI-4.33</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Config-Grammar"><a href="#å®‰è£…Config-Grammar" class="headerlink" title="å®‰è£…Config-Grammar"></a>å®‰è£…Config-Grammar</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Config-Grammar-1.10.tar.gz</span></span><br><span class="line"><span class="comment"># cd Config-Grammar-1.10</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ExtUtils-MakeMaker"><a href="#å®‰è£…ExtUtils-MakeMaker" class="headerlink" title="å®‰è£…ExtUtils-MakeMaker"></a>å®‰è£…ExtUtils-MakeMaker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf ExtUtils-MakeMaker-7.24.tar.gz</span></span><br><span class="line"><span class="comment"># cd ExtUtils-MakeMaker</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Simple"><a href="#å®‰è£…Simple" class="headerlink" title="å®‰è£…Simple"></a>å®‰è£…Simple</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Test-Simple-1.302056.tar.gz</span></span><br><span class="line"><span class="comment"># cd Test-Simple-1.302056</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">`</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-OpenSSH"><a href="#å®‰è£…Net-OpenSSH" class="headerlink" title="å®‰è£…Net-OpenSSH"></a>å®‰è£…Net-OpenSSH</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Net-OpenSSH-0.73.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-OpenSSH-0.73</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-SNMP"><a href="#å®‰è£…Net-SNMP" class="headerlink" title="å®‰è£…Net-SNMP"></a>å®‰è£…Net-SNMP</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar Net-SNMP-v6.0.1.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-SNMP-v6.0.1</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…perl-ldap"><a href="#å®‰è£…perl-ldap" class="headerlink" title="å®‰è£…perl-ldap"></a>å®‰è£…perl-ldap</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf perl-ldap-0.65.tar.gz</span></span><br><span class="line"><span class="comment"># cd perl-ldap-0.65</span></span><br><span class="line"><span class="comment"># ./install-nomake</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-DNS"><a href="#å®‰è£…Net-DNS" class="headerlink" title="å®‰è£…Net-DNS"></a>å®‰è£…Net-DNS</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Net-DNS-1.06.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-DNS-1.06</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…IO-Tty"><a href="#å®‰è£…IO-Tty" class="headerlink" title="å®‰è£…IO-Tty"></a>å®‰è£…IO-Tty</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar IO-Tty-1.12.tar.gz</span></span><br><span class="line"><span class="comment"># cd IO-Tty-1.12</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…libwww-perl"><a href="#å®‰è£…libwww-perl" class="headerlink" title="å®‰è£…libwww-perl"></a>å®‰è£…libwww-perl</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf libwww-perl-6.15.tar.gz</span></span><br><span class="line"><span class="comment"># cd libwww-perl-6.15</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…smokeping-1"><a href="#å®‰è£…smokeping-1" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf smokeping-2.6.11.tar.gz</span></span><br><span class="line"><span class="comment"># cd smokeping-2.6.11</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/smokeping</span></span><br><span class="line"><span class="comment"># /usr/bin/gmake install</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œé’ˆå¯¹ç½‘ç»œä¸èƒ½ç¿»å¢™ã€‚ä¹Ÿå¯ä»¥é‡‡å–smokepingä¸€é”®å®‰è£…çš„æ–¹å¼è¿›è¡Œå®‰è£…</p><h3 id="smokepingä¸€é”®å®‰è£…"><a href="#smokepingä¸€é”®å®‰è£…" class="headerlink" title="smokepingä¸€é”®å®‰è£…"></a>smokepingä¸€é”®å®‰è£…</h3><h4 id="å®‰è£…smokeping-2"><a href="#å®‰è£…smokeping-2" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf smokeping-2.6.11.tar.gz</span></span><br><span class="line"><span class="comment"># cd smokeping-2.6.11</span></span><br><span class="line"><span class="comment"># ./setup/build-perl-modules.sh /usr/local/smokeping/thirdparty</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/smokeping</span></span><br><span class="line"><span class="comment"># /usr/bin/gmake install</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®smkeping"><a href="#é…ç½®smkeping" class="headerlink" title="é…ç½®smkeping"></a>é…ç½®smkeping</h3><h4 id="åˆ›å»ºcacheã€dataã€varç›®å½•"><a href="#åˆ›å»ºcacheã€dataã€varç›®å½•" class="headerlink" title="åˆ›å»ºcacheã€dataã€varç›®å½•"></a>åˆ›å»ºcacheã€dataã€varç›®å½•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/smokeping/</span></span><br><span class="line"><span class="comment"># mkdir &#123;cache,data,var&#125;</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ—¥å¿—æ–‡ä»¶"><a href="#åˆ›å»ºæ—¥å¿—æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæ—¥å¿—æ–‡ä»¶"></a>åˆ›å»ºæ—¥å¿—æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># touch /var/log/smokeping.log</span></span><br></pre></td></tr></table></figure><h4 id="èµ‹æƒé™"><a href="#èµ‹æƒé™" class="headerlink" title="èµ‹æƒé™"></a>èµ‹æƒé™</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chown apache:apache cache/ data/ var/</span></span><br><span class="line"><span class="comment"># chown  apache:apache /var/log/smokeping.log</span></span><br><span class="line"><span class="comment"># chmod 755 cache/ data/ var/    #è¿™é‡Œä¹Ÿè¦èµ‹æƒé™ï¼Œä¼šå½±å“å›¾ç‰‡æ— æ³•åŠ è½½</span></span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/local/smokeping/htdocs</span></span><br><span class="line"><span class="comment"># cp -arp smokeping.fcgi.dist smokeping.fcgi</span></span><br><span class="line"><span class="comment"># cd ../etc/</span></span><br><span class="line"><span class="comment"># cp -arp config.dist config</span></span><br><span class="line"><span class="comment"># chmod 600 /usr/local/smokeping/etc/smokeping_secrets.dist</span></span><br><span class="line"><span class="comment"># vim config</span></span><br><span class="line">*** General ***</span><br><span class="line">owner    = Peter Random</span><br><span class="line">contact  = some@address.nowhere</span><br><span class="line">mailhost = my.mail.host</span><br><span class="line">sendmail = /usr/sbin/sendmail</span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> do not put the Image Cache below cgi-bin</span></span><br><span class="line"><span class="comment"># since all files under cgi-bin will be executed ... this is not</span></span><br><span class="line"><span class="comment"># good for images.</span></span><br><span class="line">imgcache = /usr/<span class="built_in">local</span>/smokeping/cache</span><br><span class="line">imgurl   = http://172.16.1.100/cache                                                      <span class="comment">#è¿™é‡Œå¦‚æœä¸é…ç½®æ­£ç¡®ï¼Œä¼šå½±å“åé¢å‡ºå›¾ï¼Œè¿™é‡Œä¸€ä¸ªå‘</span></span><br><span class="line">datadir  = /usr/<span class="built_in">local</span>/smokeping/data</span><br><span class="line">piddir  = /usr/<span class="built_in">local</span>/smokeping/var</span><br><span class="line">cgiurl   = http://172.16.1.100/smokeping/smokeping.cgi</span><br><span class="line"><span class="comment">#cgiurl   = http://some.url/smokeping.cgi</span></span><br><span class="line">smokemail = /usr/<span class="built_in">local</span>/smokeping/etc/smokemail.dist</span><br><span class="line">tmail = /usr/<span class="built_in">local</span>/smokeping/etc/tmail.dist</span><br><span class="line"><span class="comment"># specify this to get syslog logging</span></span><br><span class="line">syslogfacility = local0</span><br><span class="line"><span class="comment"># each probe is now run in its own process</span></span><br><span class="line"><span class="comment"># disable this to revert to the old behaviour</span></span><br><span class="line"><span class="comment"># concurrentprobes = no</span></span><br><span class="line">*** Alerts ***</span><br><span class="line">to = alertee@address.somewhere</span><br><span class="line">from = smokealert@company.xy</span><br><span class="line">+someloss</span><br><span class="line"><span class="built_in">type</span> = loss</span><br><span class="line"><span class="comment"># in percent</span></span><br><span class="line">pattern = &gt;0%,*12*,&gt;0%,*12*,&gt;0%</span><br><span class="line">comment = loss 3 <span class="built_in">times</span>  <span class="keyword">in</span> a row</span><br><span class="line">*** Database ***</span><br><span class="line">step     = 60                                              <span class="comment">#æ£€æµ‹æ—¶é—´ï¼Œé»˜è®¤300</span></span><br><span class="line">pings    = 20</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸Šè¿°ä¿®æ”¹å¸¦æœ‰æ³¨è§†éƒ¨åˆ†ï¼Œå…¶ä»–å‚æ•°å‚è€ƒå®˜æ–¹ï¼Œè€Œä¸”éƒ½èƒ½çœ‹æ‡‚ã€‚åé¢æœ‰å¾ˆå¤šé…ç½®ä¸å…¨éƒ¨è´´å‡ºæ¥</p><h3 id="é…ç½®apache"><a href="#é…ç½®apache" class="headerlink" title="é…ç½®apache"></a>é…ç½®apache</h3><h4 id="é…ç½®httpd-conf"><a href="#é…ç½®httpd-conf" class="headerlink" title="é…ç½®httpd.conf"></a>é…ç½®httpd.conf</h4><p>åœ¨DocumentRoot â€œ/var/www/htmlâ€è¿™è¡Œå¢åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">Alias /cache <span class="string">"/usr/local/smokeping/cache"</span></span><br><span class="line">Alias /cropper <span class="string">"/usr/local/smokeping/htdocs/cropper"</span></span><br><span class="line">Alias /smokeping <span class="string">"/usr/local/smokeping/htdocs/smokeping.fcgi"</span></span><br><span class="line">&lt;Directory <span class="string">"/usr/local/smokeping"</span>&gt;</span><br><span class="line">        AllowOverride None</span><br><span class="line">        Options All</span><br><span class="line">        AddHandler cgi-script .fcgi .cgi</span><br><span class="line">        Order allow,deny</span><br><span class="line">        Allow from all</span><br><span class="line">        AuthName <span class="string">"Smokeping"</span></span><br><span class="line">        AuthType Basic</span><br><span class="line">        AuthUserFile /usr/<span class="built_in">local</span>/smokeping/htdocs/htpasswd</span><br><span class="line">        Require valid-user</span><br><span class="line">        DirectoryIndex smokeping.fcgi</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure><h4 id="apacheç™»å½•è®¤è¯"><a href="#apacheç™»å½•è®¤è¯" class="headerlink" title="apacheç™»å½•è®¤è¯"></a>apacheç™»å½•è®¤è¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/local/smokeping/htdocs</span></span><br><span class="line"><span class="comment"># htpasswd -c /usr/local/smokeping/htdocs/htpasswd admin                   #å›è½¦è®¾ç½®adminè´¦æˆ·çš„å¯†ç </span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“"><a href="#å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“" class="headerlink" title="å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“"></a>å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install wqy-zenhei-fonts.noarch</span></span><br></pre></td></tr></table></figure><h4 id="smokepingå¼€æœºè„šæœ¬"><a href="#smokepingå¼€æœºè„šæœ¬" class="headerlink" title="smokepingå¼€æœºè„šæœ¬"></a>smokepingå¼€æœºè„šæœ¬</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/init.d/smokeping</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">PIDFILE=/usr/<span class="built_in">local</span>/smokeping/var/smokeping.pid</span><br><span class="line">SMOKEPING=/usr/<span class="built_in">local</span>/smokeping/bin/smokeping</span><br><span class="line">ERROR=0</span><br><span class="line">RUNNING=0</span><br><span class="line">ARGV=<span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x<span class="variable">$ARGV</span>"</span> = <span class="string">"x"</span> ] ; <span class="keyword">then</span></span><br><span class="line">ARGS=<span class="built_in">help</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">for</span> ARG <span class="keyword">in</span> <span class="variable">$@</span> <span class="variable">$ARGS</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$PIDFILE</span> ] ; <span class="keyword">then</span></span><br><span class="line">PID=`cat <span class="variable">$PIDFILE</span>`</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> -0 <span class="variable">$PID</span> 2&gt;/dev/null ; <span class="keyword">then</span></span><br><span class="line"><span class="comment"># smokeping is running</span></span><br><span class="line">RUNNING=1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># smokeping not running but PID file exists =&gt; delete PID file</span></span><br><span class="line">rm -f <span class="variable">$PIDFILE</span></span><br><span class="line">RUNNING=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># smokeping (no pid file) not running</span></span><br><span class="line">RUNNING=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$ARG</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 0 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$SMOKEPING</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping started"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be started"</span></span><br><span class="line">ERROR=1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is running with PID <span class="variable">$PID</span>"</span></span><br><span class="line">ERROR=2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> <span class="variable">$PID</span> ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping (<span class="variable">$PID</span>) stopped"</span></span><br><span class="line">rm <span class="variable">$PIDFILE</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be stopped"</span></span><br><span class="line">ERROR=3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping not running"</span></span><br><span class="line">ERROR=4</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$SMOKEPING</span> --restart &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping restarted"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be started"</span></span><br><span class="line">ERROR=5</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="variable">$0</span> start</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">strace_debug)</span><br><span class="line">rm -f /tmp/strace_smokeping</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> strace -o/tmp/strace_smokeping <span class="variable">$SMOKEPING</span> --restart &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping restarted with strace debug in /tmp/strace_smokeping"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping strace debug could not be started"</span></span><br><span class="line">ERROR=6</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">if</span> strace -o/tmp/strace_smokeping <span class="variable">$SMOKEPING</span> &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping started with strace debug in /tmp/strace_smokeping"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping strace debug could not be started"</span></span><br><span class="line">ERROR=7</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is running with PID (<span class="variable">$PID</span>)"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is not running"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$0</span> (start|stop|restart|status|strace_debug|help)"</span></span><br><span class="line">cat</span><br><span class="line">start - start smokeping</span><br><span class="line">stop - stop smokeping</span><br><span class="line">restart - restart smokeping <span class="keyword">if</span> running or start <span class="keyword">if</span> not running</span><br><span class="line">status - show status <span class="keyword">if</span> smokeping is running or not</span><br><span class="line"><span class="built_in">help</span> - this screen</span><br><span class="line">EOF</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$ERROR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod +x /etc/init.d/smokeping</span></span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service httpd start</span></span><br><span class="line"><span class="comment"># /etc/init.d/smokeping start</span></span><br></pre></td></tr></table></figure><p>æ‰“å¼€æµè§ˆå™¨æµ‹è¯•http://{ip}/smokeping ä¼šæç¤ºè¾“å…¥ç”¨æˆ·å’Œå¯†ç <br><img src="https://img.xxlaila.cn/74D2C8DE-129F-4219-87C5-D6A771D19484.png" alt="img"><br><img src="https://img.xxlaila.cn/91D9FA70-65B1-4752-8F15-68A158E72A49.png" alt="img"></p><h4 id="é…ç½®æ–‡ä»¶æ·»åŠ "><a href="#é…ç½®æ–‡ä»¶æ·»åŠ " class="headerlink" title="é…ç½®æ–‡ä»¶æ·»åŠ "></a>é…ç½®æ–‡ä»¶æ·»åŠ </h4><p>é…ç½®æ–‡ä»¶æ·»ä»‹ç»ï¼Œåœ¨é…ç½®æ–‡ä»¶é‡Œé¢+è¡¨ç¤ºä¸€çº§++è¡¨ç¤ºäºŒçº§+++ä¸‰çº§<br>æœ¬æ¬¡æ·»åŠ çš„å†…å®¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">+ Other</span><br><span class="line">menu = å…¶ä»–ç½‘ç»œç›‘æ§</span><br><span class="line">title = å…¶ä»–æ‰€æœ‰ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">++ dianxin</span><br><span class="line">menu = ç”µä¿¡ç½‘ç»œç›‘æ§</span><br><span class="line">title = ç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/dianxin/dianxin-hlj /Other/dianxin/dianxin-gd /Other/dianxin/dianxin-gs /Other/dianxin/dianxin-sh /Other/dianxin/dianxin-sc /Other/dianxin/dianxin-cq /Other/dianxin/dianxin-gz /Other/dianxin/dianxin-ln /Other/dianxin/dianxin-zj /Other/dianxin/dianxin-sd /Other/dianxin/dianxin-hib /Other/dianxin/dianxin-ah /Other/dianxin/dianxin-hb /Other/dianxin/dianxin-jl /Other/dianxin/dianxin-jx</span><br><span class="line">+++ dianxin-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿç”µä¿¡</span><br><span class="line">title = é»‘é¾™æ±Ÿç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 219.150.32.132</span><br><span class="line">+++ dianxin-gd</span><br><span class="line">menu = å¹¿ä¸œç”µä¿¡</span><br><span class="line">title = å¹¿ä¸œç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.96.134.133</span><br><span class="line">+++ dianxin-gs</span><br><span class="line">menu = ç”˜è‚ƒç”µä¿¡</span><br><span class="line">title = ç”˜è‚ƒç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.100.64.68</span><br><span class="line">+++ dianxin-sh</span><br><span class="line">menu = ä¸Šæµ·ç”µä¿¡</span><br><span class="line">title = ä¸Šæµ·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.96.209.5</span><br><span class="line">+++ dianxin-sc</span><br><span class="line">menu = å››å·ç”µä¿¡</span><br><span class="line">title = å››å·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.6.145.111</span><br><span class="line">+++ dianxin-cq</span><br><span class="line">menu = é‡åº†ç”µä¿¡</span><br><span class="line">title = é‡åº†ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 61.128.128.68</span><br><span class="line">+++ dianxin-gz</span><br><span class="line">menu = è´µå·ç”µä¿¡</span><br><span class="line">title = è´µå·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.98.192.68</span><br><span class="line">+++ dianxin-ln</span><br><span class="line">menu = è¾½å®ç”µä¿¡</span><br><span class="line">title = è¾½å®ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 219.149.6.99</span><br><span class="line">+++ dianxin-zj</span><br><span class="line">menu = æµ™æ±Ÿç”µä¿¡</span><br><span class="line">title = æµ™æ±Ÿç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.96.96.68</span><br><span class="line">+++ dianxin-sd</span><br><span class="line">menu = å±±ä¸œç”µä¿¡</span><br><span class="line">title = å±±ä¸œç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 222.173.95.53</span><br><span class="line">+++ dianxin-hib</span><br><span class="line">menu = æ¹–åŒ—ç”µä¿¡</span><br><span class="line">title = æ¹–åŒ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.103.0.68</span><br><span class="line">+++ dianxin-ah</span><br><span class="line">menu = å®‰å¾½ç”µä¿¡</span><br><span class="line">title = å®‰å¾½ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 220.178.75.134</span><br><span class="line">+++ dianxin-hb</span><br><span class="line">menu = æ²³åŒ—ç”µä¿¡</span><br><span class="line">title = æ²³åŒ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.99.160.68</span><br><span class="line">+++ dianxin-jl</span><br><span class="line">menu = å‰æ—ç”µä¿¡</span><br><span class="line">title = å‰æ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host =  219.149.194.55</span><br><span class="line">+++ dianxin-jx</span><br><span class="line">menu = æ±Ÿè¥¿ç”µä¿¡</span><br><span class="line">title = æ±Ÿè¥¿ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.101.224.68</span><br><span class="line"><span class="comment">#+++ dianxin-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/dianxin/dianxin-hlj /Other/dianxin/dianxin-gd /Other/dianxin/dianxin-gs /Other/dianxin/dianxin-sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">++ liantong</span><br><span class="line">menu = è”é€šç½‘ç»œç›‘æ§</span><br><span class="line">title = è”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/liantong/liantong-hlj /Other/liantong/liantong-gd /Other/liantong/liantong-gs /Other/liantong/liantong-sh /Other/liantong/liantong-sc /Other/liantong/liantong-cq /Other/liantong/liantong-gz /Other/liantong/liantong-ln /Other/liantong/liantong-zj /Other/liantong/liantong-sd /Other/liantong/liantong-hib /Other/liantong/liantong-ah /Other/liantong/liantong-hb /Other/liantong/liantong-jl /Other/liantong/liantong-jx</span><br><span class="line">+++ liantong-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿè”é€š</span><br><span class="line">title = é»‘é¾™æ±Ÿè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.97.224.68</span><br><span class="line">+++ liantong-gd</span><br><span class="line">menu = å¹¿ä¸œè”é€š</span><br><span class="line">title = å¹¿ä¸œè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 221.4.66.66</span><br><span class="line">+++ liantong-gs</span><br><span class="line">menu = ç”˜è‚ƒè”é€š</span><br><span class="line">title = ç”˜è‚ƒè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 221.7.34.10</span><br><span class="line">+++ liantong-sh</span><br><span class="line">menu = ä¸Šæµ·è”é€š</span><br><span class="line">title = ä¸Šæµ·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 210.22.70.3</span><br><span class="line">+++ liantong-sc</span><br><span class="line">menu = å››å·è”é€š</span><br><span class="line">title = å››å·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 119.6.6.6</span><br><span class="line">+++ liantong-cq</span><br><span class="line">menu = é‡åº†è”é€š</span><br><span class="line">title = é‡åº†è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.7.92.98</span><br><span class="line">+++ liantong-gz</span><br><span class="line">menu = è´µå·è”é€š</span><br><span class="line">title = è´µå·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.13.30.242</span><br><span class="line">+++ liantong-ln</span><br><span class="line">menu = è¾½å®è”é€š</span><br><span class="line">title = è¾½å®è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 124.161.97.234</span><br><span class="line">+++ liantong-zj</span><br><span class="line">menu = æµ™æ±Ÿè”é€š</span><br><span class="line">title = æµ™æ±Ÿè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.12.33.227</span><br><span class="line">+++ liantong-sd</span><br><span class="line">menu = å±±ä¸œè”é€š</span><br><span class="line">title = å±±ä¸œè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.102.152.3</span><br><span class="line">+++ liantong-hib</span><br><span class="line">menu = æ¹–åŒ—è”é€š</span><br><span class="line">title = æ¹–åŒ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.104.111.114</span><br><span class="line">+++ liantong-ah</span><br><span class="line">menu = å®‰å¾½è”é€š</span><br><span class="line">title = å®‰å¾½è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.91.88.129</span><br><span class="line">+++ liantong-hb</span><br><span class="line">menu = æ²³åŒ—è”é€š</span><br><span class="line">title = æ²³åŒ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.99.160.68</span><br><span class="line">+++ liantong-jl</span><br><span class="line">menu = å‰æ—è”é€š</span><br><span class="line">title = å‰æ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.98.5.6</span><br><span class="line">+++ liantong-jx</span><br><span class="line">menu = æ±Ÿè¥¿è”é€š</span><br><span class="line">title = æ±Ÿè¥¿è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 220.248.192.12</span><br><span class="line"><span class="comment">#+++ liantong-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªè”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªè”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/liantong/liantong-hlj /Other/liantong/liantong-gd /Other/liantong/liantong-gs /Other/liantong/liantong-sh</span></span><br><span class="line">++ yidong</span><br><span class="line">menu = ç§»åŠ¨ç½‘ç»œç›‘æ§</span><br><span class="line">title = ç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/yidong/yidong-hlj /Other/yidong/yidong-gd /Other/yidong/yidong-gs /Other/yidong/yidong-sh /Other/yidong/yidong-sc /Other/yidong/yidong-cq /Other/yidong/yidong-gz /Other/yidong/yidong-ln /Other/yidong/yidong-zj /Other/yidong/yidong-sd /Other/yidong/yidong-hib /Other/yidong/yidong-ah /Other/yidong/yidong-hb</span><br><span class="line">+++ yidong-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿç§»åŠ¨</span><br><span class="line">title = é»‘é¾™æ±Ÿç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 211.137.241.34</span><br><span class="line">+++ yidong-gd</span><br><span class="line">menu = å¹¿ä¸œç§»åŠ¨</span><br><span class="line">title = å¹¿ä¸œç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 211.137.241.34</span><br><span class="line">+++ yidong-gs</span><br><span class="line">menu = ç”˜è‚ƒç§»åŠ¨</span><br><span class="line">title = ç”˜è‚ƒç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 218.203.160.194</span><br><span class="line">+++ yidong-sh</span><br><span class="line">menu = ä¸Šæµ·ç§»åŠ¨</span><br><span class="line">title = ä¸Šæµ·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 117.131.0.22</span><br><span class="line">+++ yidong-sc</span><br><span class="line">menu = å››å·ç§»åŠ¨</span><br><span class="line">title = å››å·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.96.205</span><br><span class="line">+++ yidong-cq</span><br><span class="line">menu = é‡åº†ç§»åŠ¨</span><br><span class="line">title = é‡åº†ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.201.4.3</span><br><span class="line">+++ yidong-gz</span><br><span class="line">menu = è´µå·ç§»åŠ¨</span><br><span class="line">title = è´µå·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.139.1.3</span><br><span class="line">+++ yidong-ln</span><br><span class="line">menu = è¾½å®ç§»åŠ¨</span><br><span class="line">title = è¾½å®ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.59.181.182</span><br><span class="line">+++ yidong-zj</span><br><span class="line">menu = æµ™æ±Ÿç§»åŠ¨</span><br><span class="line">title = æµ™æ±Ÿç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.140.10.2</span><br><span class="line">+++ yidong-sd</span><br><span class="line">menu = å±±ä¸œç§»åŠ¨</span><br><span class="line">title = å±±ä¸œç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.191.26</span><br><span class="line">+++ yidong-hib</span><br><span class="line">menu = æ¹–åŒ—ç§»åŠ¨</span><br><span class="line">title = æ¹–åŒ—ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.76.68</span><br><span class="line">+++ yidong-ah</span><br><span class="line">menu = å®‰å¾½ç§»åŠ¨</span><br><span class="line">title = å®‰å¾½ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.138.180.2</span><br><span class="line">+++ yidong-hb</span><br><span class="line">menu = æ²³åŒ—ç§»åŠ¨</span><br><span class="line">title = æ²³åŒ—ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.98.2.4</span><br><span class="line"><span class="comment">#+++ yidong-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/yidong/yidong-hlj /Other/yidong/yidong-gd /Other/yidong/yidong-gs /Other/yidong/yidong-sh</span></span><br><span class="line">++ jiaoyu</span><br><span class="line">menu = æ•™è‚²ç½‘ç»œç›‘æ§</span><br><span class="line">title = æ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/jiaoyu/jiaoyu-qh /Other/jiaoyu/jiaoyu-sh /Other/jiaoyu/jiaoyu-wh /Other/jiaoyu/jiaoyu-hn</span><br><span class="line">+++ jiaoyu-qh</span><br><span class="line">menu = æ¸…åå¤§å­¦</span><br><span class="line">title = æ¸…åå¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 166.111.8.28</span><br><span class="line">+++ jiaoyu-sh</span><br><span class="line">menu = ä¸Šæµ·äº¤å¤§</span><br><span class="line">title = ä¸Šæµ·äº¤å¤§</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.112.26.34</span><br><span class="line">+++ jiaoyu-wh</span><br><span class="line">menu = æ­¦æ±‰ç§‘æŠ€å¤§å­¦</span><br><span class="line">title = æ­¦æ±‰ç§‘æŠ€å¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.114.240.6</span><br><span class="line">+++ jiaoyu-hn</span><br><span class="line">menu = åå—å†œä¸šå¤§å­¦</span><br><span class="line">title = åå—å†œä¸šå¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.116.160.33</span><br><span class="line"><span class="comment">#+++ jiaoyu-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªæ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªæ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/jiaoyu/jiaoyu-qh /Other/jiaoyu/jiaoyu-sh /Other/jiaoyu/jiaoyu-wh /Other/jiaoyu/jiaoyu-hn</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Smokeping</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux å¸¸ç”¨å‘½ä»¤å­¦ä¹ </title>
    <url>/2019/09/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h4 id="æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤"><a href="#æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤" class="headerlink" title="æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤"></a>æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤</h4><ul><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹é¢å¤§å°è¶…è¿‡5Mçš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ -size +5M</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹100å¤©ä¹‹å‰ä¿®æ”¹è¿‡çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ -mtime +100</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹60å¤©æœªè¢«è®¿é—®è¿‡çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ \! atime -60</span><br></pre></td></tr></table></figure></li></ul><a id="more"></a><ul><li>æŸ¥æ‰¾ç›®å½•ä¸‹é¢æ–‡ä»¶â€œcoreâ€œï¼Œå¦‚æœå‘ç°æ— éœ€æç¤ºç›´æ¥åˆ é™¤ã€‚<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find / -name core -<span class="built_in">exec</span> rm &#123;&#125; \</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾æ’é™¤æŸä¸€ä¸ªæ–‡ä»¶ç„¶åè¿›è¡Œåˆ é™¤</span></span><br><span class="line">$ find / -<span class="built_in">type</span> f ! -name <span class="string">"test"</span> -<span class="built_in">exec</span> rm &#123;&#125; \;</span><br><span class="line">$ find ./ -mtime +3 -name <span class="string">"*.log"</span> -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br><span class="line">$ find /tmp -mtime +30 -<span class="built_in">type</span> f -name <span class="string">"*.sh[ab]"</span> -<span class="built_in">exec</span> rm -f &#123;&#125; \;</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨ä¸€ä¸ªç›®å½•ä¸­ä¿ç•™æœ€è¿‘30å¤©çš„æ–‡ä»¶ï¼Œ30å¤©å‰çš„æ–‡ä»¶è‡ªåŠ¨åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /tmp -mtime +30 -<span class="built_in">type</span> f -name <span class="string">"*.sh[ab]"</span> -<span class="built_in">exec</span> rm -f &#123;&#125; \;</span><br></pre></td></tr></table></figure><ul><li>/tmp â€“è®¾ç½®æŸ¥æ‰¾çš„ç›®å½•ï¼›</li><li>-mtime +30 â€“è®¾ç½®æ—¶é—´ä¸º30å¤©å‰ï¼›</li><li>-type f â€“è®¾ç½®æŸ¥æ‰¾çš„ç±»å‹ä¸ºæ–‡ä»¶ï¼›</li><li>-name *.sh[ab] â€“è®¾ç½®æ–‡ä»¶åç§°ä¸­åŒ…å«shaæˆ–è€…shbï¼›</li><li>-exec rm -f â€“æŸ¥æ‰¾å®Œæ¯•åæ‰§è¡Œåˆ é™¤æ“ä½œï¼›</li><li><strong>æç¤º</strong>ï¼šå°†æ­¤å‘½ä»¤å†™å…¥crontabåå³å¯è‡ªåŠ¨å®ŒæˆæŸ¥æ‰¾å¹¶åˆ é™¤çš„å·¥ä½œ</li></ul><ul><li>æ˜¾ç¤ºç›®å½•æ–‡ä»¶çš„æ–‡ä»¶åå’Œå®ƒä»¬çš„æ‹¥æœ‰è€…<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ll | awk <span class="string">'&#123;print $3,"owns",$9&#125;'</span></span><br></pre></td></tr></table></figure></li></ul><p>æ˜¾ç¤ºä½ çš„ç³»ç»Ÿä¸ŠPCIæ€»çº¿å’Œé™„åŠ è®¾å¤‡çš„ä¿¡æ¯ã€‚æŒ‡å®š-vï¼Œ-vvæˆ–-vvvæ¥è·å–è¶Šæ¥è¶Šè¯¦ç»†çš„è¾“å‡º</p><ul><li><p>lspci å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum whatprovides */lspci</span><br><span class="line">pciutils-3.5.1-2.el7.x86_64 : PCI bus related utilities</span><br><span class="line">Repo        : base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /usr/sbin/lspci</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pciutils-3.5.1-3.el7.x86_64 : PCI bus related utilities</span><br><span class="line">Repo        : base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /usr/sbin/lspci</span><br><span class="line"></span><br><span class="line">$ sudo yum install pciutils</span><br><span class="line"></span><br><span class="line">lspci æ›´å¤š[è¯¦ç»†ä½¿ç”¨](https://blog.csdn.net/styshoo/article/details/51281437)</span><br><span class="line"></span><br><span class="line">$ lspci -vvvvv</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å½“å‰çš„LinuxæœåŠ¡å™¨çš„è¿è¡Œçº§åˆ«</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ who -r</span><br><span class="line">$ who -b </span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿæœ€åä¸€æ¬¡å¯åŠ¨çš„æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">$ last reboot</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿå†å²å¯åŠ¨çš„æ—¶é—´</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿè¿è¡Œäº†å¤šé•¿æ—¶é—´</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /proc/uptime| awk -F. <span class="string">'&#123;run_days=$1 / 86400;run_hour=($1 % 86400)/3600;run_minute=($1 % 3600)/60;run_second=$1 % 60;printf("ç³»ç»Ÿå·²è¿è¡Œï¼š%då¤©%dæ—¶%dåˆ†%dç§’",run_days,run_hour,run_minute,run_second)&#125;'</span></span><br><span class="line">$ w</span><br><span class="line">$ uptime</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿå¯åŠ¨çš„æ—¥æœŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ date -d <span class="string">"<span class="variable">$(awk -F. '&#123;print $1&#125;' /proc/uptime)</span> second ago"</span> +<span class="string">"%Y-%m-%d %H:%M:%S"</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶å†…å®¹æ²¡æœ‰åŒ…æ‹¬â€œnginxâ€ã€â€œmsgTypeâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep -r -l -v <span class="string">"nginx"</span> /data/</span><br><span class="line">$ grep -r  -v <span class="string">"msgType"</span> /data/</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶å†…å®¹åŒ…æ‹¬â€nginxâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep -r <span class="string">"nginx"</span> /data/                                             ä¼šæŠŠ<span class="string">"nginx"</span>å­—ç¬¦ä¸²æ‰€åœ¨è¿™è¡Œçš„å†…å®¹æ˜¾ç¤ºå‡ºæ¥</span><br><span class="line">$ grep -o â€œnginxâ€ /data/</span><br><span class="line">$ grep -r -l <span class="string">"nginx"</span> /data/                                          ä¸æ˜¾ç¤º<span class="string">"nginx"</span>å­—ç¬¦ä¸²æ‰€åœ¨è¡Œï¼Œæ˜¯æ˜¾ç¤ºæ–‡ä»¶</span><br></pre></td></tr></table></figure></li><li><p>catä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat sentry.conf.py |grep -v <span class="string">"^#"</span>          æŸ¥çœ‹é…ç½®æ–‡ä»¶ä¸åŒ…æ‹¬æ³¨é‡Šå†…å®¹</span><br><span class="line">$ cat -b `find /var/<span class="built_in">log</span>/httpd/ -cmin -60 -<span class="built_in">print</span> |sed <span class="string">"1d"</span>`\ |awk <span class="string">'&#123;print $2&#125;'</span>|sort |uniq -c |sort -n -k 1 -r |head -n 1               ç»Ÿè®¡å½“å‰ç›®å½•ä¸‹æ—¥å¿—æ–‡ä»¶é‡Œé¢Iå¹³è®¿é—®é‡æœ€å¤šçš„ä¸€ä¸ªIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŸä¸€ä¸ªæ—¶é—´æ®µçš„IPåœ°å€è®¿é—®æ’åå‰10</span></span><br><span class="line">$ cat nginx_access.log|grep <span class="string">'+0800'</span>|awk <span class="string">'&#123;split($1,array,"[");if(array[2]&gt;="25/Jul/2017:14:17:30" &amp;&amp; array[2]&lt;="25/Jul/2017:20:17:30")&#123;print $0&#125;&#125;'</span>|awk -F<span class="string">"^`"</span> &amp;&amp; <span class="string">"-"</span> &amp;&amp; <span class="string">"^`"</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å½“å‰æ—¥å¿—ipè®¿é—®å‰10</span></span><br><span class="line">$ cat nginx_access.log |awk -F<span class="string">"^"</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br></pre></td></tr></table></figure></li><li><p>è·å–IPåœ°å€é€šç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig |sed -n 2p |awk <span class="string">'&#123;print $1$2&#125;'</span>|sed <span class="string">'s/^.*[^0-9]\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)$/\1\.\2\.\3\.\4/g'</span></span><br></pre></td></tr></table></figure></li><li><p>curlä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›‘æ§ç½‘é¡µçš„å“åº”æ—¶é—´</span></span><br><span class="line">$ curl -o /dev/null -s -w <span class="string">"time_connect: %&#123;time_connect&#125;\ntime_starttransfer: %&#123;time_starttransfer&#125;\ntime_total: %&#123;time_total&#125;\n"</span> <span class="string">"http://www.baidu.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›‘æ§ç«™ç‚¹å¯ç”¨æ€§</span></span><br><span class="line">$ curl -o /dev/null -s -w %&#123;http_code&#125; <span class="string">"http://www.baidu.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯gzipè¯·æ±‚</span></span><br><span class="line">$ curl -I http://www.sina.com.cn/ -H Accept-Encoding:gzip,defalte</span><br></pre></td></tr></table></figure></li><li><p>æ¯10ç§’æ˜¾ç¤ºä¸€æ¬¡å¤åˆ¶çš„å¤§å°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ watch -n 10 du -sh /root</span><br></pre></td></tr></table></figure></li><li><p>ç»Ÿè®¡ç›®å½•(åŒ…æ‹¬å­ç›®å½•)ä¸‹é¢æ–‡ä»¶ä¸ªæ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find ./ -<span class="built_in">type</span> f | wc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨findå‘½ä»¤æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ˜¯æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶ï¼Œç„¶åç”¨wcæ¥è®¡æ•°</span></span><br><span class="line">$ ls -lR|grep <span class="string">"^-"</span>|wc -l</span><br><span class="line"><span class="comment"># lså‘½ä»¤åŠ Rå‚æ•°ï¼Œåˆ—å‡ºä¸‹çº§å­ç›®å½•ï¼Œä½¿ç”¨grepå‘½ä»¤è¿‡æ»¤ä»¥â€œ-â€å¼€å¤´çš„ï¼Œå¦‚æœæ˜¯ç›®å½•å°±æ”¹æˆâ€œ^dâ€ï¼Œåé¢ç”¨wcè®¡æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line">$ find ./ -name <span class="string">"*.*"</span> |xargs cat|grep -v ^$|wc -l</span><br><span class="line">$ find . \( ! -name <span class="string">'*.png'</span> ! -name <span class="string">'*.gif'</span> ! -name <span class="string">'*.jpg'</span> ! -name <span class="string">'*.swf'</span> \) -<span class="built_in">type</span> f |wc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„çš„è¡Œæ•°ï¼Œå»æ‰ç©ºè¡Œ</span></span><br><span class="line">$ find ./ -name <span class="string">"*.*"</span> |xargs cat|wc -l   </span><br><span class="line">$ find . \( ! -name <span class="string">'*.png'</span> ! -name <span class="string">'*.gif'</span> ! -name <span class="string">'*.jpg'</span> ! -name <span class="string">'*.swf'</span> \) -<span class="built_in">type</span> f |xargs cat|wc -l</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿtcpè¿æ¥ä¸­å„ä¸ªçŠ¶æ€çš„è¿æ¥æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -an | awk '/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºæ¯ä¸ªIPçš„è¿æ¥æ•°ï¼Œä»¥åŠæ€»çš„å„ä¸ªçŠ¶æ€çš„è¿æ¥æ•°</span></span><br><span class="line">$ netstat -n | awk <span class="string">'/^tcp/ &#123;n=split($(NF-1),array,":");if(n&lt;=2)++S[array[(1)]];else++S[array[(4)]];++s[$NF];++N&#125; END &#123;for(a in S)&#123;printf("%-20s %s\n", a, S[a]);++I&#125;printf("%-20s %s\n","TOTAL_IP",I);for(a in s) printf("%-20s %s\n",a, s[a]);printf("%-20s %s\n","TOTAL_LINK",N);&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å½“å‰tcp/ipé“¾æ¥æ•°æ’åå‰10çš„IP</span></span><br><span class="line">$ netstat -n|awk <span class="string">'/^tcp/ &#123;print $5&#125;'</span>|awk -F<span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨grepç»Ÿè®¡å½“å‰æ–‡ä»¶é‡Œé¢æ‰€æœ‰çš„IPåœ°å€</span></span><br><span class="line">$ grep -E -o <span class="string">"(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"</span> nginx_access.log</span><br></pre></td></tr></table></figure></li></ul><p>æŸ¥çœ‹ç³»ç»Ÿå½“å‰è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„æ•°ï¼ŒæŒ‰ç…§æœ€å¤§çš„è¿›è¡Œæ’åº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lsof -n | awk <span class="string">'&#123;print $2&#125;'</span> | sort | uniq -c | sort -nr | more</span><br></pre></td></tr></table></figure><ul><li>pingå‘½ä»¤æ˜¾ç¤ºæ—¶é—´ä»¥åŠæ—¥æœŸ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping www.sina.com.cn -i 3 | awk <span class="string">'&#123; print $0"\t" strftime("%Y-%m-%d %H:%M:%S",systime()) &#125; '</span> &gt; /opt/sina.log &amp;</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>iptables</title>
    <url>/2019/09/25/iptables/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="Iptables"><a href="#Iptables" class="headerlink" title="Iptables"></a>Iptables</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iptalbes æ˜¯ç”¨æ¥è®¾ç½®ã€ç»´æŠ¤å’Œæ£€æŸ¥Linuxå†…æ ¸çš„IPåŒ…è¿‡æ»¤è§„åˆ™çš„ã€‚å¯ä»¥å®šä¹‰ä¸åŒçš„è¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½åŒ…å«å‡ ä¸ªå†…éƒ¨çš„é“¾ï¼Œä¹Ÿèƒ½åŒ…å«ç”¨æˆ·å®šä¹‰çš„é“¾ã€‚æ¯ä¸ªé“¾éƒ½æ˜¯ä¸€ä¸ªè§„åˆ™åˆ—è¡¨ï¼Œå¯¹å¯¹åº”çš„åŒ…è¿›è¡ŒåŒ¹é…ï¼šæ¯æ¡è§„åˆ™æŒ‡å®šåº”å½“å¦‚ä½•å¤„ç†ä¸ä¹‹ç›¸åŒ¹é…çš„åŒ…ã€‚è¿™è¢«ç§°ä½œâ€™targetâ€™ï¼ˆç›®æ ‡ï¼‰ï¼Œä¹Ÿå¯ä»¥è·³å‘åŒä¸€ä¸ªè¡¨å†…çš„ç”¨æˆ·å®šä¹‰çš„é“¾ã€‚</p><a id="more"></a><h4 id="iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£"><a href="#iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£" class="headerlink" title="iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£"></a>iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£</h4><ul><li><p>å…è®¸æŸä¸ªIP ï¼ˆ192.168.6.100ï¼‰çš„æœºå™¨è¿›è¡ŒSSHè¿æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 192.168.6.100 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.100 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li><li><p>å…è®¸æŸä¸€æ®µçš„IP è®¿é—®SSH</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 192.168.6.0/24 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.0/24 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li><li><p>é™åˆ¶æŸä¸€IP è®¿é—®SSH</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp -s ! 192.168.6.100 --dport 22 -j ACCEPT --æ³¨æ„ï¼å·æœ‰ä¸ªç©ºæ ¼</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.0/24 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li></ul><h3 id="é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™"><a href="#é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™" class="headerlink" title="é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™"></a>é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™</h3><ul><li><p>é˜²æ­¢å¤–ç½‘ç”¨å†…ç½‘IPæ¬ºéª—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 10.0.0.0/8 -j DROP</span><br><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 172.16.0.0/12 -j DROP</span><br><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 192.168.0.0/16 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>ç¦æ­¢ä¸211.101.46.253çš„æ‰€æœ‰è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -d 211.101.46.253 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>ç¦ç”¨FTP(21)ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 21 -j DROP</span><br><span class="line"><span class="comment"># è¿™æ ·å†™èŒƒå›´å¤ªå¤§äº†,æˆ‘ä»¬å¯ä»¥æ›´ç²¾ç¡®çš„å®šä¹‰.</span></span><br><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 21 -d 211.101.46.253 -j DROP</span><br><span class="line"><span class="comment"># è¿™æ ·åªç¦ç”¨211.101.46.253åœ°å€çš„FTPè¿æ¥,å…¶ä»–è¿æ¥è¿˜å¯ä»¥.å¦‚web(80ç«¯å£)è¿æ¥.</span></span><br></pre></td></tr></table></figure></li><li><p>iptablesç™½åå•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 80 -j DROP</span><br><span class="line"><span class="comment"># æ‹’ç»æ‰€æœ‰IPé“¾æ¥80ç«¯å£</span></span><br><span class="line"></span><br><span class="line">$ iptables -A INPUT -s 58.17.245.222 -p tcp --dport 80 -j ACCEPT</span><br><span class="line"><span class="comment"># å…è®¸æŒ‡å®šIPè®¿é—®80ç«¯å£</span></span><br></pre></td></tr></table></figure></li><li><p>å…è®¸æ‰€æœ‰å·²ç»å»ºç«‹çš„å’Œç›¸å…³çš„è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p>dropéæ³•è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state INVALID -j DROP</span><br><span class="line">$ iptables -A OUTPUT -m state --state INVALID -j DROP</span><br><span class="line">$ iptables -A FORWARD -m state --state INVALID -j DROP</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç«¯å£æ˜ å°„"><a href="#ç«¯å£æ˜ å°„" class="headerlink" title="ç«¯å£æ˜ å°„"></a>ç«¯å£æ˜ å°„</h3><ul><li>è¿™é‡Œä½¿ç”¨çš„æ˜¯FTPæœåŠ¡(36542)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 36542 -j DNAT --to 192.168.50.2:36542</span><br><span class="line">$ iptables -t nat -A POSTROUTING -p tcp --dport 36542 -j MASQUERADE</span><br><span class="line"><span class="comment"># å› ä¸ºFTPä½¿ç”¨äº†ä¸¤ä¸ªç«¯å£21å’Œ20ï¼Œ21åªæ˜¯ç”¨äºè¿æ¥ï¼Œ20æ˜¯æ‰§è¡Œå‘½ä»¤çš„ã€‚20æ²¡åŠæ³•ä¿®æ”¹ï¼Œè¿™é‡Œä½¿ç”¨äº†è¢«åŠ¨æ¨¡å¼è¿æ¥ã€‚</span></span><br><span class="line"></span><br><span class="line">$ iptables -t nat -I PREROUTING -p tcp --dport 60000:65000 -j DNAT --to 192.168.50.2</span><br><span class="line"><span class="comment"># è¢«åŠ¨è¿æ¥ç«¯å£60000-65000å…¨éƒ¨è½¬å‘ç»™50.2</span></span><br><span class="line"></span><br><span class="line">$ iptables -t nat -I POSTROUTING -p tcp --dport 60000:65000 -j MASQUERADE</span><br><span class="line"><span class="comment"># éœ€è¦å¼€æ”¾60000:65000ç«¯å£ï¼Œ</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ç«¯å£è½¬å‘"><a href="#ç«¯å£è½¬å‘" class="headerlink" title="ç«¯å£è½¬å‘"></a>ç«¯å£è½¬å‘</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸æœ‰ä¸€å°æœåŠ¡å™¨è¿æ¥å¤–ç½‘ï¼Œå…¶ä»–çš„æœåŠ¡å™¨éƒ½ä¸èƒ½ä¸Šå¤–ç½‘ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå¤–ç½‘æœåŠ¡å™¨ç”¨ä½œç½‘å…³æœåŠ¡å™¨ï¼Œåšç«¯å£è½¬å‘ï¼Œè¿æ¥åˆ°å†…ç½‘æœåŠ¡å™¨</p><ul><li><p>è¿™é‡Œä½¿ç”¨æ•°æ®åº“çš„3306æ˜ å°„åˆ°å¤–ç½‘çš„çš„36544</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING  -m tcp -p tcp --dport 36544 -j DNAT --to-destination 172.16.1.11:3306</span><br><span class="line">$ iptables -t nat -A POSTROUTING -m tcp -p tcp --dport 3306 -d 172.16.1.11 -j SNAT --to-source 172.16.1.1</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ è¿ç»­ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp --dport 60000:65000 -j ACCEPT</span><br><span class="line"><span class="comment"># å†’å·è¡¨ç¤ºæ·»åŠ ä¸€ä¸ªè¿ç»­çš„ç«¯å£</span></span><br><span class="line"></span><br><span class="line">$ iptables -A INPUT -p tcp -m multiport â€“dport 21:25,135:139 -j DROP</span><br><span class="line"><span class="comment">#ä½¿ç”¨multiportå‚æ•°é…ç½®ä¸è¿ç»­ç«¯å£å’Œå¤šä¸ªç«¯å£</span></span><br></pre></td></tr></table></figure></li><li><p>ä»£ç†ä¸Šç½‘<br>å†…ç½‘æœºå­æ— æ³•ä¸Šç½‘ï¼Œé€šè¿‡ä¸€å°å¯ä»¥ä¸Šç½‘çš„ç”µè„‘ï¼Œåœ¨å¯ä»¥è®¿é—®å¤–ç½‘çš„serverä¸Šiptablesè®©å…¶ä¸€ä¸ªç½‘æ®µå†…çš„æœºå­è®¿é—®å¤–ç½‘ï¼Œè¿™é‡Œæ˜¯é˜¿é‡Œäº‘ç¯å¢ƒæ¥åšçš„ï¼Œå¼€å¯IPè½¬å‘åŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sed -i <span class="string">'s/net.ipv4.ip_forward = 0/net.ipv4.ip_forward = 1/g'</span> /etc/sysctl.conf</span><br><span class="line">$ iptables -t nat -I POSTROUTING -s 172.16.3.0/24 -j SNAT --to-source 172.16.3.2</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ“ä½œiptablesçš„natè§„åˆ™"><a href="#æ“ä½œiptablesçš„natè§„åˆ™" class="headerlink" title="æ“ä½œiptablesçš„natè§„åˆ™"></a>æ“ä½œiptablesçš„natè§„åˆ™</h4><ul><li><p>æŸ¥çœ‹è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -nvL -t nat</span><br><span class="line">$ iptables -t nat -L -n --line-numbers</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -D POSTROUTING 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptablesçš„è§„åˆ™å·</span></span><br><span class="line">$ iptables -nL --line-number</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹/æ›¿æ¢è§„åˆ™</span></span><br><span class="line">$ iptbales -R INPUT &#123;1&#125; -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è§„åˆ™</span></span><br><span class="line">$ iptables -D INPUT &#123;1&#125;</span><br></pre></td></tr></table></figure></li><li><p>iptalesç«¯å£é€šè¿‡ä¸€å¼ ç½‘å¡å‡ºå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLESHED -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p>æœ¬æœºç«¯å£ï¼Œæ˜ å°„åˆ°æœ¬æœºç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 25 -j REDIRECT --to-port 2525</span><br><span class="line">$ iptables -t nat -I PREROUTING --src 0/0 --dst 192.168.1.5 -p tcp --dport 80 -j REDIRECT --to-ports 8123</span><br><span class="line">$ iptables -t nat -I OUTPUT --src 0/0 --dst 192.168.1.5 -p tcp --dport 80 -j REDIRECT --to-ports 8123</span><br></pre></td></tr></table></figure></li><li><p>ä¿å­˜é˜²ç«å¢™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo /usr/libexec/iptables/iptables.init save</span><br></pre></td></tr></table></figure></li><li><p>å¥‡è‘©éœ€æ±‚ï¼Œå¼€æ”¾sshç«¯å£æŒ‡å®šçš„IPåœ°å€è®¿é—®ï¼Œå…¶ä»–ç«¯å£å¤ªå¤šä¸æƒ³æ·»åŠ èƒ½å¯¹å¤–è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"><span class="comment"># sample configuration for iptables service</span></span><br><span class="line"><span class="comment"># you can edit this manually or use system-config-firewall</span></span><br><span class="line"><span class="comment"># please do not ask us to add additional ports/services to this default configuration</span></span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT -s 192.168.10.1/32 -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m tcp --dport 22 -j  REJECT --reject-with icmp-port-unreachable</span><br><span class="line"><span class="comment">#-A INPUT -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line"><span class="comment">#-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>iptables</tag>
      </tags>
  </entry>
  <entry>
    <title>äº¤æ¢æœºåšç«¯å£èšåˆ</title>
    <url>/2019/09/25/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%81%9A%E7%AB%AF%E5%8F%A3%E8%81%9A%E5%90%88/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šh3c s5500 (Switch A)ã€‚huawei s5720S-SI-ACï¼ˆSwitch Bï¼‰</p><p>Switch A ä½œä¸ºä¸Šè¡Œäº¤æ¢æœºï¼ŒSwitch Bä½œä¸ºä¸‹è¡Œäº¤æ¢æœº</p><p><strong>ç»„ç½‘</strong>ï¼šä¸¤ä¸ªäº¤æ¢æœºçš„idã€vlanå·è¿™é‡Œä½¿ç”¨çš„æ˜¯ç›¸åŒ</p><a id="more"></a><p><img src="https://img.xxlaila.cn/2846sjdhausiy84yhks.png" alt="img"></p><h3 id="Switch-Aé…ç½®"><a href="#Switch-Aé…ç½®" class="headerlink" title="Switch Aé…ç½®"></a>Switch Aé…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]vlan 50</span><br><span class="line">[Switch A-SW-vlan50]quit</span><br><span class="line">[Switch A-SW]interface Bridge-Aggregation 50</span><br><span class="line">[Switch A-SW-Bridge-Aggregation50]port access vlan 50</span><br><span class="line">[Switch A-SW]interface GigabitEthernet 1/0/19</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/19]port link-aggregation group 50</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/19] port access vlan 50</span><br><span class="line">[Switch A-SW]interface GigabitEthernet 1/0/20</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/20]port link-aggregation group 50</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/20]port access vlan 50</span><br><span class="line">[Switch A-SW]link-aggregation load-sharing mode <span class="built_in">source</span>-mac destination-mac</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ç«¯å£èšåˆ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]dis link-aggregation verbose</span><br></pre></td></tr></table></figure></li></ul><h3 id="Switch-Bé…ç½®"><a href="#Switch-Bé…ç½®" class="headerlink" title="Switch Bé…ç½®"></a>Switch Bé…ç½®</h3><h4 id="1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜"><a href="#1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜" class="headerlink" title="1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜"></a>1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] interface eth-trunk 50</span><br><span class="line">[Switch B-Eth-Trunk1] trunkport gigabitethernet 0/0/1 to 0/0/3</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h4 id="2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan"><a href="#2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan" class="headerlink" title="2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan"></a>2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] vlan batch 50</span><br><span class="line">[Switch B] interface eth-trunk 50</span><br><span class="line">[Switch B-Eth-Trunk1] port link-type trunk</span><br><span class="line">[Switch B-Eth-Trunk1] port trunk allow-pass vlan 50</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h4 id="3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼"><a href="#3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼" class="headerlink" title="3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼"></a>3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] interface eth-trunk 1</span><br><span class="line">[Switch B-Eth-Trunk1] load-balance src-dst-mac</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h3 id="Switch-Aé…ç½®åœ°å€æ®µ"><a href="#Switch-Aé…ç½®åœ°å€æ®µ" class="headerlink" title="Switch Aé…ç½®åœ°å€æ®µ"></a>Switch Aé…ç½®åœ°å€æ®µ</h3><p>åœ¨vlané‡Œé¢èµ·ä¸€ä¸ªç½‘ç»œï¼Œä½†ä¸å¯ç”¨dhcpæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]int vlan 50</span><br><span class="line">[Switch A-SW-Vlan-interface50]ip ad 172.21.16.1 20</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>äº¤æ¢æœº</tag>
      </tags>
  </entry>
  <entry>
    <title>pv pvc</title>
    <url>/2019/09/25/pv-pvc/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="1ã€ä»‹ç»"><a href="#1ã€ä»‹ç»" class="headerlink" title="1ã€ä»‹ç»"></a>1ã€ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PersistentVolumeï¼ˆpvï¼‰å’ŒPersistentVolumeClaimï¼ˆpvcï¼‰æ˜¯k8sæä¾›çš„ä¸¤ç§APIèµ„æºï¼Œç”¨äºæŠ½è±¡å­˜å‚¨ç»†èŠ‚ã€‚ç®¡ç†å‘˜å…³æ³¨äºå¦‚ä½•é€šè¿‡pvæä¾›å­˜å‚¨åŠŸèƒ½è€Œæ— éœ€å…³æ³¨ç”¨æˆ·å¦‚ä½•ä½¿ç”¨ï¼ŒåŒæ ·çš„ç”¨æˆ·åªéœ€è¦æŒ‚è½½pvcåˆ°å®¹å™¨ä¸­è€Œä¸éœ€è¦å…³æ³¨å­˜å‚¨å·é‡‡ç”¨ä½•ç§æŠ€æœ¯å®ç°ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pvcå’Œpvçš„å…³ç³»ä¸podå’Œnodeå…³ç³»ç±»ä¼¼ï¼Œå‰è€…æ¶ˆè€—åè€…çš„èµ„æºã€‚pvcå¯ä»¥å‘pvç”³è¯·æŒ‡å®šå¤§å°çš„å­˜å‚¨èµ„æºå¹¶è®¾ç½®è®¿é—®æ¨¡å¼,è¿™å°±å¯ä»¥é€šè¿‡Provision -&gt; Claim çš„æ–¹å¼ï¼Œæ¥å¯¹å­˜å‚¨èµ„æºè¿›è¡Œæ§åˆ¶ã€‚</p><a id="more"></a><h3 id="2ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#2ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2ã€ç”Ÿå‘½å‘¨æœŸ"></a>2ã€ç”Ÿå‘½å‘¨æœŸ</h3><p>pvå’Œpvcéµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸ:</p><ul><li>ä¾›åº”å‡†å¤‡ã€‚é€šè¿‡é›†ç¾¤å¤–çš„å­˜å‚¨ç³»ç»Ÿæˆ–è€…äº‘å¹³å°æ¥æä¾›å­˜å‚¨æŒä¹…åŒ–æ”¯æŒã€‚<ul><li><strong>é™æ€æä¾›</strong>: ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¤šä¸ªPVï¼Œä¾›PVCä½¿ç”¨ã€‚</li><li><strong>åŠ¨æ€æä¾›</strong>: åŠ¨æ€åˆ›å»ºPVCç‰¹å®šçš„PVï¼Œå¹¶ç»‘å®šã€‚</li></ul></li><li>ç»‘å®šã€‚ç”¨æˆ·åˆ›å»ºpvcå¹¶æŒ‡å®šéœ€è¦çš„èµ„æºå’Œè®¿é—®æ¨¡å¼ã€‚åœ¨æ‰¾åˆ°å¯ç”¨pvä¹‹å‰ï¼Œpvcä¼šä¿æŒæœªç»‘å®šçŠ¶æ€ã€‚</li><li>ä½¿ç”¨ã€‚ç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvcã€‚</li><li>é‡Šæ”¾ã€‚ç”¨æˆ·åˆ é™¤pvcæ¥å›æ”¶å­˜å‚¨èµ„æºï¼Œpvå°†å˜æˆâ€œreleasedâ€çŠ¶æ€ã€‚ç”±äºè¿˜ä¿ç•™ç€ä¹‹å‰çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†ï¼Œå¦åˆ™è¿™äº›å­˜å‚¨èµ„æºæ— æ³•è¢«å…¶ä»–pvcä½¿ç”¨ã€‚</li><li>å›æ”¶(Reclaiming)ã€‚pvå¯ä»¥è®¾ç½®ä¸‰ç§å›æ”¶ç­–ç•¥ï¼šä¿ç•™ï¼ˆRetainï¼‰ï¼Œå›æ”¶ï¼ˆRecycleï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</li></ul><ul><li><strong>ä¿ç•™ç­–ç•¥</strong>: å…è®¸äººå·¥å¤„ç†ä¿ç•™çš„æ•°æ®ã€‚</li><li><strong>åˆ é™¤ç­–ç•¥</strong>: å°†åˆ é™¤pvå’Œå¤–éƒ¨å…³è”çš„å­˜å‚¨èµ„æºï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</li><li><strong>å›æ”¶ç­–ç•¥</strong>: å°†æ‰§è¡Œæ¸…é™¤æ“ä½œï¼Œä¹‹åå¯ä»¥è¢«æ–°çš„pvcä½¿ç”¨ï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›®å‰åªæœ‰NFSå’ŒHostPathç±»å‹å·æ”¯æŒå›æ”¶ç­–ç•¥ï¼ŒAWS EBS,GCE PD,Azure Diskå’ŒCinderæ”¯æŒåˆ é™¤(Delete)ç­–ç•¥ã€‚</p><h4 id="2-1ã€Provisioning"><a href="#2-1ã€Provisioning" class="headerlink" title="2.1ã€Provisioning"></a>2.1ã€Provisioning</h4><p>ä¸¤ç§æ–¹å¼æä¾›çš„PVèµ„æºä¾›ç»™ï¼š</p><ul><li><p>static:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡é›†ç¾¤ç®¡ç†è€…åˆ›å»ºå¤šä¸ªPVï¼Œä¸ºé›†ç¾¤â€œä½¿ç”¨è€…â€æä¾›å­˜å‚¨èƒ½åŠ›è€Œéšè—çœŸå®å­˜å‚¨çš„ç»†èŠ‚ã€‚å¹¶ä¸”å­˜åœ¨äºkubenretes apiä¸­ï¼Œå¯è¢«ç›´æ¥ä½¿ç”¨ã€‚</p></li><li><p>dynamic:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ¨æ€å·ä¾›ç»™æ˜¯kubernetesç‹¬æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¸€åŠŸèƒ½å…è®¸æŒ‰éœ€åˆ›å»ºå­˜å‚¨å»ºã€‚åœ¨æ­¤ä¹‹å‰ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦äº‹å…ˆåœ¨é›†ç¾¤å¤–ç”±å­˜å‚¨æä¾›è€…æˆ–è€…äº‘æä¾›å•†åˆ›å»º<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å­˜å‚¨å·ï¼ŒæˆåŠŸä¹‹åå†åˆ›å»ºPersistentVolumeå¯¹è±¡ï¼Œæ‰èƒ½å¤Ÿåœ¨kubernetesä¸­ä½¿ç”¨ã€‚åŠ¨æ€å·ä¾›ç»™èƒ½è®©é›†ç¾¤ç®¡ç†å‘˜ä¸å¿…è¿›è¡Œé¢„å…ˆåˆ›å»ºå­˜å‚¨å·ï¼Œè€Œæ˜¯éšç€ç”¨æˆ·éœ€æ±‚è¿›è¡Œåˆ›å»ºã€‚åœ¨1.5ç‰ˆæœ¬æé«˜äº†åŠ¨æ€å·çš„å¼¹æ€§å’Œå¯ç”¨æ€§ã€‚</p></li></ul><h3 id="PVç±»å‹"><a href="#PVç±»å‹" class="headerlink" title="PVç±»å‹"></a>PVç±»å‹</h3><p>pvæ”¯æŒä»¥ä¸‹ç±»å‹:</p><ul><li>GCEPersistentDisk</li><li>AWSElasticBlockStore</li><li>NFS</li><li>iSCSI</li><li>RBD (Ceph Block Device)</li><li>Glusterfs</li><li>AzureFile</li><li>AzureDisk</li><li>CephFS</li><li>cinder</li><li>FC</li><li>FlexVolume</li><li>Flocker</li><li>PhotonPersistentDisk</li><li>Quobyte</li><li>VsphereVolume</li><li>HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</li></ul><h4 id="3-1ã€PVå±æ€§"><a href="#3-1ã€PVå±æ€§" class="headerlink" title="3.1ã€PVå±æ€§"></a>3.1ã€PVå±æ€§</h4><ul><li>è®¿é—®æ¨¡å¼,ä¸pvçš„è¯­ä¹‰ç›¸åŒã€‚åœ¨è¯·æ±‚èµ„æºæ—¶ä½¿ç”¨ç‰¹å®šæ¨¡å¼ã€‚</li><li>èµ„æº,ç”³è¯·çš„å­˜å‚¨èµ„æºæ•°é¢ã€‚</li></ul><h4 id="3-2ã€PVå·é˜¶æ®µçŠ¶æ€"><a href="#3-2ã€PVå·é˜¶æ®µçŠ¶æ€" class="headerlink" title="3.2ã€PVå·é˜¶æ®µçŠ¶æ€"></a>3.2ã€PVå·é˜¶æ®µçŠ¶æ€</h4><ul><li>Available â€“ èµ„æºå°šæœªè¢«claimä½¿ç”¨</li><li>Bound â€“ å·å·²ç»è¢«ç»‘å®šåˆ°claimäº†</li><li>Released â€“ claimè¢«åˆ é™¤ï¼Œå·å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æœªè¢«é›†ç¾¤å›æ”¶ã€‚</li><li>Failed â€“ å·è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pv, pvc</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ©ç”¨NFSåŠ¨æ€æä¾›Kubernetesåç«¯å­˜å‚¨å·</title>
    <url>/2019/09/24/%E5%88%A9%E7%94%A8NFS%E5%8A%A8%E6%80%81%E6%8F%90%E4%BE%9BKubernetes%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8%E5%8D%B7/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nfs-client-provisioneræ˜¯ä¸€ä¸ªautomatic provisionerï¼Œä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œè‡ªåŠ¨åˆ›å»ºPVå’Œå¯¹åº”çš„PVCï¼Œæœ¬èº«ä¸æä¾›NFSå­˜å‚¨ï¼Œéœ€è¦å¤–éƒ¨å…ˆæœ‰ä¸€å¥—NFSå­˜å‚¨æœåŠ¡ã€‚</p><ul><li>PVä»¥ ${namespace}-${pvcName}-${pvName}çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">å®˜æ–¹è®¿é—®åœ°å€</a></p><a id="more"></a><h3 id="1ã€æƒé™ä½“ç³»æ„å»º"><a href="#1ã€æƒé™ä½“ç³»æ„å»º" class="headerlink" title="1ã€æƒé™ä½“ç³»æ„å»º"></a>1ã€æƒé™ä½“ç³»æ„å»º</h3><h4 id="1-1ã€åˆ›å»ºserviceaccount"><a href="#1-1ã€åˆ›å»ºserviceaccount" class="headerlink" title="1.1ã€åˆ›å»ºserviceaccount"></a>1.1ã€åˆ›å»ºserviceaccount</h4><p>ServiceAccountä¹Ÿæ˜¯ä¸€ç§è´¦å·, ä¾›è¿è¡Œåœ¨podä¸­çš„è¿›ç¨‹ä½¿ç”¨, ä¸ºpodä¸­çš„è¿›ç¨‹æä¾›å¿…è¦çš„èº«ä»½è¯æ˜</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; serviceaccount.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-2ã€åˆ›å»ºrole"><a href="#1-2ã€åˆ›å»ºrole" class="headerlink" title="1.2ã€åˆ›å»ºrole"></a>1.2ã€åˆ›å»ºrole</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt;clusterrole.yaml&lt;&lt;EOF</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    resources: [<span class="string">"storageclasses"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"events"</span>]</span><br><span class="line">    verbs: [<span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services"</span>, <span class="string">"endpoints"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>,<span class="string">"list"</span>, <span class="string">"watch"</span>,<span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"podsecuritypolicies"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"nfs-client-provisioner"</span>]</span><br><span class="line">    verbs: [<span class="string">"use"</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"><a href="#1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š" class="headerlink" title="1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"></a>1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt;clusterrolebinding.yaml &lt;&lt;EOF</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: kube-ops</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-4ã€æ‰§è¡Œåˆ›å»º"><a href="#1-4ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="1.4ã€æ‰§è¡Œåˆ›å»º"></a>1.4ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f serviceaccount.yaml -f clusterrole.yaml -f clusterrolebinding.yaml</span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span><br></pre></td></tr></table></figure><h3 id="2ã€å®‰è£…éƒ¨ç½²"><a href="#2ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="2ã€å®‰è£…éƒ¨ç½²"></a>2ã€å®‰è£…éƒ¨ç½²</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹è½½deployment.yamlæ–‡ä»¶,éœ€è¦ä¿®æ”¹NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ10.10.10.60ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/ifs/kubernetesï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><h4 id="2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"><a href="#2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·" class="headerlink" title="2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"></a>2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·</h4><p>æ ¹æ®PVCçš„è¯·æ±‚, åŠ¨æ€åˆ›å»ºPVå­˜å‚¨.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: quay.io/external_storage/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.21.17.39</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /opt</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: /opt</span><br><span class="line">            path: 172.21.17.39</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²class.yaml</li></ul><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´</p><h4 id="2-2ã€åˆ›å»ºstorageclass"><a href="#2-2ã€åˆ›å»ºstorageclass" class="headerlink" title="2.2ã€åˆ›å»ºstorageclass"></a>2.2ã€åˆ›å»ºstorageclass</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; class.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-3ã€æ‰§è¡Œåˆ›å»º"><a href="#2-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="2.3ã€æ‰§è¡Œåˆ›å»º"></a>2.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f deployment.yaml </span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">deployment.extensions/nfs-client-provisioner created</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f class.yaml </span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage created</span><br></pre></td></tr></table></figure><h5 id="2-3-1ã€æŸ¥çœ‹StorageClass"><a href="#2-3-1ã€æŸ¥çœ‹StorageClass" class="headerlink" title="2.3.1ã€æŸ¥çœ‹StorageClass"></a>2.3.1ã€æŸ¥çœ‹StorageClass</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get storageclass</span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   18s</span><br></pre></td></tr></table></figure><h5 id="2-3-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"><a href="#2-3-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨" class="headerlink" title="2.3.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"></a>2.3.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨</h5><p>è®¾ç½®è¿™ä¸ªdefaultåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl patch storageclass managed-nfs-storage -p <span class="string">'&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage patched</span><br></pre></td></tr></table></figure><ul><li>storage.yaml (å’Œä¸Šé¢ä¸€æ ·)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; storage.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">  annotations:</span><br><span class="line">    storageclass.kubernetes.io/is-default-class: <span class="string">"true"</span></span><br><span class="line">provisioner: fuseim.pri/ifs</span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-3-3ã€æŸ¥çœ‹éªŒè¯"><a href="#2-3-3ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="2.3.3ã€æŸ¥çœ‹éªŒè¯"></a>2.3.3ã€æŸ¥çœ‹éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get all -n kube-ops</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-77f678858b-8d2d6   1/1     Running   0          26m</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nfs-client-provisioner   1/1     1            1           29m</span><br><span class="line"></span><br><span class="line">NAME                                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nfs-client-provisioner-77f678858b   1         1         1       26m</span><br></pre></td></tr></table></figure><h3 id="3ã€éªŒè¯æµ‹è¯•"><a href="#3ã€éªŒè¯æµ‹è¯•" class="headerlink" title="3ã€éªŒè¯æµ‹è¯•"></a>3ã€éªŒè¯æµ‹è¯•</h3><h4 id="3-1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨"><a href="#3-1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨" class="headerlink" title="3.1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨"></a>3.1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; <span class="built_in">test</span>-claim.yaml &lt;&lt;EOF</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-claim</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2ã€å¯åŠ¨æµ‹è¯•POD"><a href="#3-2ã€å¯åŠ¨æµ‹è¯•POD" class="headerlink" title="3.2ã€å¯åŠ¨æµ‹è¯•POD"></a>3.2ã€å¯åŠ¨æµ‹è¯•POD</h4><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat  &gt; <span class="built_in">test</span>-pod.yaml &lt;&lt;EOF</span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-pod</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: <span class="built_in">test</span>-pod</span><br><span class="line">    image: docker.io/busybox:1.24</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"/bin/sh"</span></span><br><span class="line">    args:</span><br><span class="line">      - <span class="string">"-c"</span></span><br><span class="line">      - <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        mountPath: <span class="string">"/mnt"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: <span class="built_in">test</span>-claim</span><br></pre></td></tr></table></figure><h4 id="3-3ã€æ‰§è¡Œåˆ›å»º"><a href="#3-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="3.3ã€æ‰§è¡Œåˆ›å»º"></a>3.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f ./</span><br><span class="line">persistentvolumeclaim/<span class="built_in">test</span>-claim created</span><br><span class="line">pod/<span class="built_in">test</span>-pod created</span><br></pre></td></tr></table></figure><h4 id="3-4ã€æŸ¥çœ‹éªŒè¯"><a href="#3-4ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="3.4ã€æŸ¥çœ‹éªŒè¯"></a>3.4ã€æŸ¥çœ‹éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod,pv -n kube-ops</span><br><span class="line">NAME                                          READY   STATUS      RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-77f678858b-8d2d6   1/1     Running     0          3h26m</span><br><span class="line">pod/<span class="built_in">test</span>-pod                                  0/1     Completed   0          172m</span><br><span class="line"></span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">persistentvolume/pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Retain           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            172m</span><br></pre></td></tr></table></figure><ul><li>ç™»å½•nfsæœåŠ¡å™¨æŸ¥çœ‹æ˜¯å¦æˆåŠŸçš„åˆ›å»ºç›®å½•<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /opt/</span><br><span class="line">kube-ops-test-claim-pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-5ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"><a href="#3-5ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥" class="headerlink" title="3.5ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"></a>3.5ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥</h4><ul><li><p>æŸ¥çœ‹é›†ç¾¤ä¸­PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pv -n kube-ops</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Delete           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            3m6s</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl patch pv pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8  -p <span class="string">'&#123;"spec":&#123;"persistentVolumeReclaimPolicy":"Retain"&#125;&#125;'</span></span><br><span class="line">persistentvolume/pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8 patched</span><br><span class="line"></span><br><span class="line">$ kubectl get pv -n kube-ops</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Retain           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            3m54s</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pvc,pv</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 prometheus</title>
    <url>/2019/09/20/k8s-v1-14-prometheus/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h1 id="Prometheusã€Grafana-éƒ¨ç½²"><a href="#Prometheusã€Grafana-éƒ¨ç½²" class="headerlink" title="Prometheusã€Grafana éƒ¨ç½²"></a>Prometheusã€Grafana éƒ¨ç½²</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Grafanaæ˜¯ä¸€ä¸ªå¼€æºçš„åº¦é‡åˆ†æä¸å¯è§†åŒ–å¥—ä»¶ã€‚ç»å¸¸è¢«ç”¨ä½œåŸºç¡€è®¾æ–½çš„æ—¶é—´åºåˆ—æ•°æ®å’Œåº”ç”¨ç¨‹åºåˆ†æçš„å¯è§†åŒ–ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨å®ƒæ¥åšKubernetesé›†ç¾¤ç›‘æ§æ•°æ®çš„å¯è§†åŒ–ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆªè‡³å½“å‰ï¼Œprometheusã€grafanaå‡é‡‡ç”¨æœ€æ–°çš„é•œåƒåŒ…ï¼Œåœ¨åœ¨ç¬¬ä¸€æ¬¡éƒ¨ç½²çš„æ—¶å€™grafanaæŠ¥äº†ä¸€ä¸ªé”™è¯¯<code>mkdir: cannot create directory &#39;/var/lib/grafana/plugins&#39;: No such file or directory</code>,è¿™æ˜¯å› ä¸ºGrafanaå¯åŠ¨ä½¿ç”¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„éƒ½æ˜¯472ï¼Œé€ æˆå¯¹å¤–æŒ‚å­˜å‚¨æ²¡æœ‰æƒé™ã€‚<a href="https://grafana.com/docs/installation/docker/#migration-from-a-previous-version-of-the-docker-container-to-5-1-or-later" target="_blank" rel="noopener">å‚è€ƒå®˜æ–¹</a></p><a id="more"></a><h3 id="å¼€å§‹éƒ¨ç½²"><a href="#å¼€å§‹éƒ¨ç½²" class="headerlink" title="å¼€å§‹éƒ¨ç½²"></a>å¼€å§‹éƒ¨ç½²</h3><p>æ–°å»ºyamlæ–‡ä»¶</p><ul><li>monitor-namespace.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat  monitor-namespace.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring</span><br></pre></td></tr></table></figure></li></ul><p>å…¶ä»–çš„æ–‡ä»¶å‡é‡‡ç”¨ä»¥å‰å†å²çš„ï¼Œç„¶åç¨åŠ ä¿®æ”¹ï¼Œå…¶ä»–<a href="https://github.com/xxlaila/kubernetes-yaml.git" target="_blank" rel="noopener">yaml</a>æ–‡ä»¶,ç§»é™¤<code>grafana-ingress.yaml</code>ã€<code>prometheus-ingress.yaml</code></p><h3 id="æ–‡ä»¶ä¿®æ”¹"><a href="#æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="æ–‡ä»¶ä¿®æ”¹"></a>æ–‡ä»¶ä¿®æ”¹</h3><ul><li><p>grafana-deploy.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-core</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: grafana</span><br><span class="line">        component: core</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: grafana/grafana:latest</span><br><span class="line">        name: grafana-core</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment"># env:</span></span><br><span class="line">        resources:</span><br><span class="line">          <span class="comment"># keep request = limit to keep this container in guaranteed class</span></span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        env:</span><br><span class="line">          <span class="comment"># The following env variables set up basic auth twith the default admin user and admin password.</span></span><br><span class="line">          - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">            value: <span class="string">"true"</span></span><br><span class="line">          - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">            value: <span class="string">"false"</span></span><br><span class="line">          <span class="comment"># - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span></span><br><span class="line">          <span class="comment">#   value: Admin</span></span><br><span class="line">          <span class="comment"># does not really work, because of template variables in exported dashboards:</span></span><br><span class="line">          <span class="comment"># - name: GF_DASHBOARDS_JSON_ENABLED</span></span><br><span class="line">          <span class="comment">#   value: "true"</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 3000</span><br><span class="line">          <span class="comment"># initialDelaySeconds: 30</span></span><br><span class="line">          <span class="comment"># timeoutSeconds: 1</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: grafana-persistent-storage</span><br><span class="line">          mountPath: /var/lib/grafana</span><br><span class="line">      volumes:</span><br><span class="line">      - name: grafana-persistent-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>prometheus-deploy.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/prometheus:latest</span><br><span class="line">        name: prometheus</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - <span class="string">"/bin/prometheus"</span></span><br></pre></td></tr></table></figure></li><li><p>prometheus-svc.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    targetPort: 9090</span><br><span class="line">    <span class="comment">#nodePort: 30005</span></span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br></pre></td></tr></table></figure></li><li><p>grafana-svc.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line">  ports:</span><br><span class="line">    - port: 3000</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šæ‰§è¡Œå‡ æ¬¡</span></span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deploy -n monitoring</span></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/grafana-core-7b5989cf9d-snbk5   1/1     Running   0          2m31s</span><br><span class="line">pod/node-exporter-dddv7             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-fhfp6             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-m46bf             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-xkrzp             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-zfcxh             1/1     Running   0          12m</span><br><span class="line">pod/prometheus-67bcf457db-999ns     1/1     Running   0          12m</span><br><span class="line"></span><br><span class="line">NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/grafana         ClusterIP   10.254.95.151    &lt;none&gt;        3000/TCP         12m</span><br><span class="line">service/node-exporter   ClusterIP   10.254.114.12    &lt;none&gt;        9100/TCP         12m</span><br><span class="line">service/prometheus      ClusterIP   10.254.104.216   &lt;none&gt;        9090/TCP         12m</span><br><span class="line"></span><br><span class="line">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.extensions/grafana-core   1/1     1            1           12m</span><br><span class="line">deployment.extensions/prometheus     1/1     1            1           12m</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºIngress"><a href="#åˆ›å»ºIngress" class="headerlink" title="åˆ›å»ºIngress"></a>åˆ›å»ºIngress</h3><h4 id="prometheus-Ingress"><a href="#prometheus-Ingress" class="headerlink" title="prometheus Ingress"></a>prometheus Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat prometheus-Ingress.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-web-ui</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br></pre></td></tr></table></figure><h4 id="grafana-Ingress"><a href="#grafana-Ingress" class="headerlink" title="grafana Ingress"></a>grafana Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana-Ingress.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-web-ui</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br></pre></td></tr></table></figure><h4 id="æ‰§è¡Œåˆ›å»º-1"><a href="#æ‰§è¡Œåˆ›å»º-1" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f prometheus-Ingress.yaml </span></span><br><span class="line">ingress.extensions/prometheus-web-ui created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f grafana-Ingress.yaml </span></span><br><span class="line">ingress.extensions/grafana-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨è¾“å…¥prometheus.xxlaila.cnè®¿é—®prometheusï¼Œè¾“å…¥grafana.xxlaila.cnè®¿é—®grafanaã€‚</p><h3 id="è®¿é—®prometheus"><a href="#è®¿é—®prometheus" class="headerlink" title="è®¿é—®prometheus"></a>è®¿é—®prometheus</h3><p><img src="https://img.xxlaila.cn/1569218750254.jpg" alt="img"></p><h3 id="é…ç½®grafana"><a href="#é…ç½®grafana" class="headerlink" title="é…ç½®grafana"></a>é…ç½®grafana</h3><p><img src="https://img.xxlaila.cn/1568968344227.jpg" alt="img"></p><p>åˆ°grafanaçš„å®˜æ–¹ä¸‹è½½å¯¹åº”çš„æ¨¡ç‰ˆæ–‡ä»¶å¯¼å…¥ï¼Œå°±å¯ä»¥å‡ºå›¾å•¦<br><img src="https://img.xxlaila.cn/1568968420655.jpg" alt="img"></p><p><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/prometheus" target="_blank" rel="noopener">åç»­åˆ©ç”¨pvc</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14,prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 weave-scope</title>
    <url>/2019/09/20/k8s-v1-14-weave-scope/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="å‰æ²¿"><a href="#å‰æ²¿" class="headerlink" title="å‰æ²¿"></a>å‰æ²¿</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes é›†ç¾¤å¹¶éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨åªæ˜¯ç¬¬ä¸€æ­¥ã€‚ä¸€æ—¦é›†ç¾¤è¿è¡Œèµ·æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ä¸€èµ·æ­£å¸¸ï¼Œæ‰€æœ‰å¿…è¦ç»„ä»¶å°±ä½å¹¶å„å¸å…¶èŒï¼Œæœ‰è¶³å¤Ÿçš„èµ„æºæ»¡è¶³åº”ç”¨çš„éœ€æ±‚ã€‚Kubernetes æ˜¯ä¸€ä¸ªå¤æ‚ç³»ç»Ÿï¼Œè¿ç»´å›¢é˜Ÿéœ€è¦æœ‰ä¸€å¥—å·¥å…·å¸®åŠ©ä»–ä»¬è·çŸ¥é›†ç¾¤çš„å®æ—¶çŠ¶æ€ï¼Œå¹¶ä¸ºæ•…éšœæ’æŸ¥æä¾›åŠæ—¶å’Œå‡†ç¡®çš„æ•°æ®æ”¯æŒã€‚</p><h3 id="weave-scope-ä»‹ç»"><a href="#weave-scope-ä»‹ç»" class="headerlink" title="weave scope ä»‹ç»"></a>weave scope ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Weave Scopeæ˜¯Dockerå’ŒKubernetesçš„å¯è§†åŒ–å’Œç›‘æ§å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€ä¸ªè‡ªä¸Šè€Œä¸‹çš„åº”ç”¨ç¨‹åºä»¥åŠæ•´ä¸ªåŸºç¡€æ¶æ„è§†å›¾ï¼Œå¹¶å…è®¸æ‚¨åœ¨éƒ¨ç½²åˆ°äº‘æä¾›å•†æ—¶å®æ—¶è¯Šæ–­åˆ†å¸ƒå¼å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ä»»ä½•é—®é¢˜ã€‚</p><a id="more"></a><h3 id="åŠŸèƒ½ä»‹ç»"><a href="#åŠŸèƒ½ä»‹ç»" class="headerlink" title="åŠŸèƒ½ä»‹ç»"></a>åŠŸèƒ½ä»‹ç»</h3><ul><li>podæ‹“æ‰‘æ˜ å°„</li><li>å›¾å½¢æˆ–è¡¨æ ¼æ¨¡å¼</li><li>çµæ´»è¿‡æ»¤</li><li>å¼ºå¤§çš„æœç´¢åŠŸèƒ½</li><li>å®æ—¶åº”ç”¨å’Œå®¹å™¨æŒ‡æ ‡</li><li>æ’é™¤æ•…éšœå¹¶ç®¡ç†å®¹å™¨</li><li>ä½¿ç”¨Plugin APIç”Ÿæˆè‡ªå®šä¹‰æŒ‡æ ‡</li></ul><p><a href="https://www.weave.works/docs/scope/latest/features/" target="_blank" rel="noopener">ä»‹ç»å‚è€ƒ</a></p><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>åœ¨ K8s é›†ç¾¤ä¸­å®‰è£… Scope çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f "https://cloud.weave.works/k8s/scope.yaml?k8s-version=$(kubectl version | base64 | tr -d '\n')"</span></span><br><span class="line">namespace/weave created</span><br><span class="line">serviceaccount/weave-scope created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">deployment.apps/weave-scope-app created</span><br><span class="line">service/weave-scope-app created</span><br><span class="line">deployment.apps/weave-scope-cluster-agent created</span><br><span class="line">daemonset.extensions/weave-scope-agent created</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥"><a href="#æ£€æŸ¥" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deploy -n weave</span></span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/weave-scope-agent-2t4m5                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-6tfp5                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-fxj5f                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-gkxc6                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-qnbbv                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-app-b99fb9585-wld6n              1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-cluster-agent-77bc946585-8fcjj   1/1     Running   0          15m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/weave-scope-app   ClusterIP   10.254.184.106   &lt;none&gt;        80/TCP    15m</span><br><span class="line"></span><br><span class="line">NAME                                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.extensions/weave-scope-app             1/1     1            1           15m</span><br><span class="line">deployment.extensions/weave-scope-cluster-agent   1/1     1            1           15m</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºweave-scope-ingress"><a href="#åˆ›å»ºweave-scope-ingress" class="headerlink" title="åˆ›å»ºweave-scope ingress"></a>åˆ›å»ºweave-scope ingress</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat weave-scope.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: weave-web-ui</span><br><span class="line">  namespace: weave</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: weave-scope.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: weave-scope-app</span><br><span class="line">          servicePort: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f weave-scope.yaml </span></span><br><span class="line">ingress.extensions/weave-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆè¾“å…¥<code>weave-scope.xxlaila.cn</code>å³å¯è®¿é—®<br><img src="https://img.xxlaila.cn/1568958836846.jpg" alt="img"></p><h4 id="æ‹“æ‰‘ç»“æ„"><a href="#æ‹“æ‰‘ç»“æ„" class="headerlink" title="æ‹“æ‰‘ç»“æ„"></a>æ‹“æ‰‘ç»“æ„</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scope ä¼šè‡ªåŠ¨æ„å»ºåº”ç”¨å’Œé›†ç¾¤çš„é€»è¾‘æ‹“æ‰‘ã€‚æ¯”å¦‚ç‚¹å‡»é¡¶éƒ¨ Podsï¼Œä¼šæ˜¾ç¤ºæ‰€æœ‰ Pod ä»¥åŠ Pod ä¹‹é—´çš„ä¾èµ–å…³ç³»<br><img src="https://img.xxlaila.cn/1568958666089.jpg" alt="img"><br>ç‚¹å‡» Hostsï¼Œä¼šæ˜¾ç¤ºå„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œå¯ä»¥åœ¨ Scope ä¸­æŸ¥çœ‹èµ„æºçš„ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚<br><img src="https://img.xxlaila.cn/1568958913275.jpg" alt="img"></p><h3 id="åœ¨çº¿æ“ä½œ"><a href="#åœ¨çº¿æ“ä½œ" class="headerlink" title="åœ¨çº¿æ“ä½œ"></a>åœ¨çº¿æ“ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scope è¿˜æä¾›äº†ä¾¿æ·çš„åœ¨çº¿æ“ä½œåŠŸèƒ½ï¼Œæ¯”å¦‚é€‰ä¸­æŸä¸ª Hostï¼Œç‚¹å‡» &gt;_æŒ‰é’®å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€èŠ‚ç‚¹çš„å‘½ä»¤è¡Œç»ˆç«¯ï¼š<br><img src="https://img.xxlaila.cn/1568959004395.jpg" alt="img"></p><ul><li><p>ç‚¹å‡» Deployment çš„ + å¯ä»¥æ‰§è¡Œæ–°å¢ä¸€ä¸ªpodå®åˆ—<br><img src="https://img.xxlaila.cn/1568959269040.jpg" alt="img"></p></li><li><p>æŸ¥çœ‹podçš„æ—¥å¿—<br><img src="https://img.xxlaila.cn/1568959359334.jpg" alt="img"></p></li><li><p>attachã€restartã€stop å®¹å™¨ï¼Œä»¥åŠç›´æ¥åœ¨ Scope ä¸­æ’æŸ¥é—®é¢˜<br><img src="https://img.xxlaila.cn/1568959467442.jpg" alt="img"></p></li></ul><p>æ›´å¤šåŠŸå‘¢ä¸ªè¯·<a href="https://www.weave.works/docs/scope/latest/plugins/" target="_blank" rel="noopener">å‚è€ƒå®˜æ–¹</a>,æˆ–è€…å®æ“</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14, weave-scope</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 traefikéƒ¨ç½²</title>
    <url>/2019/09/20/k8s-v1-14-traefik%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefix å‰ç¯‡æ˜¯å¯ä»¥ä½¿ç”¨ï¼Œè¿™é‡Œk8s v1.14 ä¹‹å‰çš„æ‹¿æ¥ç”¨ä¸ä¸Šï¼Œç„¶åæŠ˜è…¾äº†ä¸€ä¸‹ï¼Œå‚è€ƒå®˜æ–¹çš„æŠ˜è…¾èµ·æ¥äº†</p><h3 id="åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes-1-6-ï¼‰"><a href="#åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes-1-6-ï¼‰" class="headerlink" title="åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes 1.6+ï¼‰"></a>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes 1.6+ï¼‰</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesåœ¨1.6+ä¸­å¼•å…¥äº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼Œä»¥å…è®¸å¯¹Kubernetesèµ„æºå’ŒAPIè¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚ç¾¤é›†é…ç½®äº†RBACï¼Œåˆ™éœ€è¦æˆæƒTraefikä½¿ç”¨Kubernetes APIã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®¾ç½®é€‚å½“çš„æƒé™ï¼šé€šè¿‡ç‰¹å®šäºå‘½åç©ºé—´çš„RoleBindingsæˆ–å•ä¸ªå…¨å±€ClusterRoleBindingã€‚</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¯ä¸ªå‘½åç©ºé—´çš„RoleBindingå¯ä»¥é™åˆ¶æˆäºˆæƒé™ï¼Œåªæœ‰Traefikæ­£åœ¨ç›‘è§†çš„åç§°ç©ºé—´æ‰èƒ½ä½¿ç”¨ï¼Œä»è€Œéµå¾ªæœ€å°æƒé™åŸåˆ™ã€‚å¦‚æœTraefikä¸åº”è¯¥ç›‘è§†æ‰€æœ‰åç§°ç©ºé—´ï¼Œå¹¶ä¸”åç§°ç©ºé—´é›†ä¸ä¼šåŠ¨æ€æ›´æ”¹ï¼Œé‚£ä¹ˆè¿™æ˜¯é¦–é€‰æ–¹æ³•ã€‚å¦åˆ™ï¼Œå¿…é¡»ä½¿ç”¨å•ä¸ªClusterRoleBindingã€‚</p><p><a href="https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">traefikå­¦ä¹ </a><br><a href="https://docs.traefik.io/v1.7/user-guide/kubernetes/" target="_blank" rel="noopener">traefikå®˜æ–¹</a></p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>ä¸‹è½½trarfixä»£ç ï¼Œç„¶ååˆ‡æ¢åˆ°v1.7çš„åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/containous/traefik.git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git branch --all</span></span><br><span class="line">* master</span><br><span class="line">  remotes/origin/HEAD -&gt; origin/master</span><br><span class="line">  remotes/origin/add-plugin-support</span><br><span class="line">  remotes/origin/gh-pages</span><br><span class="line">  remotes/origin/master</span><br><span class="line">  remotes/origin/v1.0</span><br><span class="line">  remotes/origin/v1.1</span><br><span class="line">  remotes/origin/v1.2</span><br><span class="line">  remotes/origin/v1.3</span><br><span class="line">  remotes/origin/v1.4</span><br><span class="line">  remotes/origin/v1.5</span><br><span class="line">  remotes/origin/v1.6</span><br><span class="line">  remotes/origin/v1.7</span><br><span class="line">  remotes/origin/v2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># git checkout v1.7</span></span><br><span class="line">Branch <span class="string">'v1.7'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'v1.7'</span> from <span class="string">'origin'</span>.</span><br><span class="line">Switched to a new branch <span class="string">'v1.7'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /root/traefik/examples/k8s</span></span><br></pre></td></tr></table></figure><h3 id="å®‰è£…éƒ¨ç½²"><a href="#å®‰è£…éƒ¨ç½²" class="headerlink" title="å®‰è£…éƒ¨ç½²"></a>å®‰è£…éƒ¨ç½²</h3><h4 id="ä½¿ç”¨ClusterRoleBinding"><a href="#ä½¿ç”¨ClusterRoleBinding" class="headerlink" title="ä½¿ç”¨ClusterRoleBinding"></a>ä½¿ç”¨ClusterRoleBinding</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik-rbac.yaml </span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br></pre></td></tr></table></figure><p>å¯¹äºå‘½åç©ºé—´é™åˆ¶ï¼Œæ¯ä¸ªç›‘è§†å‘½åç©ºé—´éœ€è¦ä¸€ä¸ªRoleBindingä»¥åŠTraefik kubernetes.namespaceså‚æ•°çš„ç›¸åº”é…ç½®ã€‚</p><h4 id="ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet"><a href="#ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet" class="headerlink" title="ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet"></a>ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet</h4><p>å¯ä»¥å°†Traefikä¸Deploymentæˆ–DaemonSetå¯¹è±¡ä¸€èµ·ä½¿ç”¨ï¼Œè€Œè¿™ä¸¤ä¸ªé€‰é¡¹å„æœ‰åˆ©å¼Šï¼š</p><ul><li>ä½¿ç”¨éƒ¨ç½²æ—¶ï¼Œå¯ä¼¸ç¼©æ€§å¯ä»¥æ›´å¥½ï¼Œå› ä¸ºåœ¨ä½¿ç”¨DaemonSetæ—¶æ‚¨å°†æ‹¥æœ‰æ¯ä¸ªèŠ‚ç‚¹çš„Single-Podæ¨¡å‹ï¼Œè€Œåœ¨ä½¿ç”¨éƒ¨ç½²æ—¶ï¼Œå¯èƒ½éœ€è¦æ›´å°‘çš„åŸºäºç¯å¢ƒçš„å‰¯æœ¬ã€‚</li><li>å½“èŠ‚ç‚¹åŠ å…¥ç¾¤é›†æ—¶ï¼ŒDaemonSetä¼šè‡ªåŠ¨æ‰©å±•åˆ°æ–°èŠ‚ç‚¹ï¼Œè€Œéƒ¨ç½²çª—æ ¼ä»…åœ¨éœ€è¦æ—¶åœ¨æ–°èŠ‚ç‚¹ä¸Šè¿›è¡Œè°ƒåº¦ã€‚</li><li>DaemonSetsç¡®ä¿åªæœ‰ä¸€ä¸ªpodå‰¯æœ¬åœ¨ä»»ä½•å•ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚å¦‚æœè¦ç¡®ä¿ä¸¤ä¸ªpodä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œåˆ™éƒ¨ç½²éœ€è¦å…³è”è®¾ç½®</li><li>å¯ä»¥ä½¿ç”¨è¯¥NET_BIND_SERVICEåŠŸèƒ½è¿è¡ŒDaemonSet ï¼Œè¿™å°†å…è®¸å®ƒç»‘å®šåˆ°æ¯ä¸ªä¸»æœºä¸Šçš„ç«¯å£80/443 / etcã€‚è¿™å°†å…è®¸ç»•è¿‡kube-proxyï¼Œå¹¶å‡å°‘æµé‡è·³è·ƒã€‚è¯·æ³¨æ„ï¼Œè¿™è¿åäº†Kubernetesæœ€ä½³å®è·µæŒ‡å—ï¼Œå¹¶æå‡ºäº†è°ƒåº¦/æ‰©å±•é—®é¢˜çš„å¯èƒ½æ€§ã€‚å°½ç®¡å­˜åœ¨æ½œåœ¨é—®é¢˜ï¼Œä½†è¿™ä»ç„¶æ˜¯å¤§å¤šæ•°å…¥å£æ§åˆ¶å™¨çš„é€‰æ‹©ã€‚</li></ul><h4 id="Deploymentséƒ¨ç½²"><a href="#Deploymentséƒ¨ç½²" class="headerlink" title="Deploymentséƒ¨ç½²"></a>Deploymentséƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  apply -f  traefik-deployment.yaml</span></span><br><span class="line">serviceaccount/traefik-ingress-controller created</span><br><span class="line">deployment.extensions/traefik-ingress-controller created</span><br><span class="line">service/traefik-ingress-service created</span><br></pre></td></tr></table></figure><h4 id="DaemonSets-éƒ¨ç½²-å¯é€‰"><a href="#DaemonSets-éƒ¨ç½²-å¯é€‰" class="headerlink" title="DaemonSets éƒ¨ç½²(å¯é€‰)"></a>DaemonSets éƒ¨ç½²(å¯é€‰)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik-ds.yaml</span></span><br></pre></td></tr></table></figure><ul><li>Deploymentså’ŒDaemonSetsä¹‹é—´å­˜åœ¨ä¸€äº›æ˜¾ç€å·®å¼‚:<ul><li>éƒ¨ç½²å…·æœ‰æ›´å®¹æ˜“çš„å‘ä¸Šå’Œå‘ä¸‹æ‰©å±•å¯èƒ½æ€§ã€‚å®ƒå¯ä»¥å®ç°å®Œæ•´çš„podç”Ÿå‘½å‘¨æœŸï¼Œå¹¶æ”¯æŒKubernetes 1.2çš„æ»šåŠ¨æ›´æ–°ã€‚è¿è¡Œéƒ¨ç½²è‡³å°‘éœ€è¦ä¸€ä¸ªPodã€‚</li><li>DaemonSetä¼šè‡ªåŠ¨æ‰©å±•åˆ°æ»¡è¶³ç‰¹å®šé€‰æ‹©å™¨çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶ä¿è¯ä¸€æ¬¡å¡«å……ä¸€ä¸ªèŠ‚ç‚¹ã€‚Kubernetes 1.7ä¹Ÿå®Œå…¨æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œé€‚ç”¨äºDaemonSets</li></ul></li></ul><h3 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h3><ul><li><p>æŸ¥çœ‹pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl --namespace=kube-system get pods</span></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5579b8778b-xw8m9                     1/1     Running   2          3d21h</span><br><span class="line">kubernetes-dashboard-65dfbf6f4f-hcgbb        1/1     Running   0          2d16h</span><br><span class="line">metrics-server-94ff5d4cc-b97l5               1/1     Running   1          3d</span><br><span class="line">tiller-deploy-5cbcf75545-rbzld               1/1     Running   0          17h</span><br><span class="line">traefik-ingress-controller-c595665d6-cm7kh   1/1     Running   0          3m20s</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹services</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services --namespace=kube-system</span></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                       AGE</span><br><span class="line">kube-dns                  ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP        3d21h</span><br><span class="line">kubernetes-dashboard      NodePort    10.254.214.153   &lt;none&gt;        443:32533/TCP                 3d21h</span><br><span class="line">metrics-server            ClusterIP   10.254.61.132    &lt;none&gt;        443/TCP                       3d</span><br><span class="line">tiller-deploy             ClusterIP   10.254.207.227   &lt;none&gt;        44134/TCP                     17h</span><br><span class="line">traefik-ingress-service   NodePort    10.254.246.158   &lt;none&gt;        80:32146/TCP,8080:30455/TCP   3m53s</span><br></pre></td></tr></table></figure></li></ul><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯nodeportæ¨¡å¼è¿›è¡Œéƒ¨ç½²çš„ï¼Œå¯ä»¥çœ‹åˆ°ç«¯å£ä¸º32146ï¼Œè¿™é‡Œè®¿é—®ä¼šè¿”å›<code>404 page not found</code>,é‚£æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ç»™Traefikä»»ä½•é…ç½®ã€‚</p><h3 id="åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik-Web-UIçš„Ingres"><a href="#åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik-Web-UIçš„Ingres" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik Web UIçš„Ingres"></a>åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik Web UIçš„Ingres</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ui.yaml </span></span><br><span class="line">service/traefik-web-ui created</span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨/etc/hosts æ–‡ä»¶è®¾ç½®ä¸€ä¸ªè·¯ç”±æ¡ç›®<code>traefik-ui.minikube</code></p><p>åœ¨æµè§ˆå™¨è¿›è¡Œè®¿é—®å¯ä»¥çœ‹åˆ°Traefik Web UI</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14, traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 metrics-server</title>
    <url>/2019/09/17/k8s-v1-14-metrics-server/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>metrics-serverè¿™é‡Œä¸è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/metrics-serverå®‰è£…å­£/" target="_blank" rel="noopener">metrics-serverå®‰è£…å­£</a></p><h3 id="å®‰è£…metrics-server"><a href="#å®‰è£…metrics-server" class="headerlink" title="å®‰è£…metrics-server"></a>å®‰è£…metrics-server</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œå®‰è£…å’Œä¹‹å‰çš„<strong>metrics-serverå®‰è£…å­£</strong>ç¨å¾®æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œä¹‹å‰é›†ç¾¤å®‰è£…æ²¡æœ‰ä½¿ç”¨httpsè¯ä¹¦ï¼Œåé¢å»å„ç§ç”Ÿæˆçš„è¯ä¹¦å’Œè¸©å‘ï¼Œè¿™é‡Œæ˜¯åœ¨å®‰è£…çš„æ—¶å€™ä¸€å¼€å§‹å°±ä½¿ç”¨äº†httpså…¨è¯ä¹¦,æ‰€æœ‰ç¨å¾®æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œè¿™é‡Œåªåˆ—å‡ºæœ‰åŒºåˆ«çš„åœ°æ–¹ï¼Œå…¶ä»–çš„å®Œå…¨å¯ä»¥å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/metrics-serverå®‰è£…å­£/" target="_blank" rel="noopener">metrics-serverå®‰è£…å­£</a>ï¼Œè¿™é‡Œhttpsè¯ä¹¦<strong>ä¸éœ€è¦</strong>é‡æ–°ç”Ÿæˆï¼›</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®æ–‡ä»¶ä¹Ÿä¸éœ€è¦æ·»åŠ ï¼Œåœ¨v1.14å®‰è£…çš„æ—¶å€™å°±å·²ç»å§é…ç½®æ–‡ä»¶æ·»åŠ è¿›å»äº†ï¼Œæ‰€ä»¥è¿™é‡Œé…ç½®æ–‡ä»¶ä¹Ÿä¸éœ€è¦å¢åŠ </p><h3 id="æ–‡ä»¶çš„ä¿®æ”¹"><a href="#æ–‡ä»¶çš„ä¿®æ”¹" class="headerlink" title="æ–‡ä»¶çš„ä¿®æ”¹"></a>æ–‡ä»¶çš„ä¿®æ”¹</h3><ul><li><p>ä¿®æ”¹ metrics-server-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat metrics-server-deployment.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      hostNetwork: <span class="literal">true</span> è¿™ä¸ªè¿˜æ˜¯éœ€è¦å¢åŠ </span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span><br><span class="line">      - name: tmp-dir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: mirrorgooglecontainers/metrics-server-amd64:v0.3.4</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        args:  <span class="comment"># è¿™é‡Œä¸ä¸€æ ·</span></span><br><span class="line">        - --metric-resolution=30s</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp-dir</span><br><span class="line">          mountPath: /tmp</span><br></pre></td></tr></table></figure></li><li><p>â€“metric-resolution=30sï¼šä» kubelet é‡‡é›†æ•°æ®çš„å‘¨æœŸï¼›</p></li><li><p>â€“kubelet-preferred-address-typesï¼šä¼˜å…ˆä½¿ç”¨ InternalIP æ¥è®¿é—® kubeletï¼Œè¿™æ ·å¯ä»¥é¿å…èŠ‚ç‚¹åç§°æ²¡æœ‰ DNS è§£æè®°å½•æ—¶ï¼Œé€šè¿‡èŠ‚ç‚¹åç§°è°ƒç”¨èŠ‚ç‚¹ kubelet API å¤±è´¥çš„æƒ…å†µï¼ˆæœªé…ç½®æ—¶é»˜è®¤çš„æƒ…å†µï¼‰ï¼›</p></li><li><p><strong>hostNetwork: true:</strong> è¿™ä¸ªä¸å¢åŠ çš„ä¼šæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Error from server (ServiceUnavailable): the server is currently unable to handle the request</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ resource-reader.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat resource-reader.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/stats</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups: <span class="comment"># å¢åŠ </span></span><br><span class="line">  - <span class="string">"extensions"</span></span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹è¿è¡Œæƒ…å†µ"><a href="#æŸ¥çœ‹è¿è¡Œæƒ…å†µ" class="headerlink" title="æŸ¥çœ‹è¿è¡Œæƒ…å†µ"></a>æŸ¥çœ‹è¿è¡Œæƒ…å†µ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods -l k8s-app=metrics-server</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-94ff5d4cc-b97l5   1/1     Running   0          21m</span><br><span class="line"></span><br><span class="line"><span class="comment">#  kubectl get svc -n kube-system  metrics-server</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">metrics-server   ClusterIP   10.254.61.132   &lt;none&gt;        443/TCP   27m</span><br></pre></td></tr></table></figure><h3 id="è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯"><a href="#è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯" class="headerlink" title="è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯"></a>è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get apiservice</span></span><br><span class="line">NAME                                   SERVICE                      AVAILABLE   AGE</span><br><span class="line">v1.                                    Local                        True        23h</span><br><span class="line">v1.apps                                Local                        True        23h</span><br><span class="line">v1.authentication.k8s.io               Local                        True        23h</span><br><span class="line">v1.authorization.k8s.io                Local                        True        23h</span><br><span class="line">v1.autoscaling                         Local                        True        23h</span><br><span class="line">v1.batch                               Local                        True        23h</span><br><span class="line">v1.coordination.k8s.io                 Local                        True        23h</span><br><span class="line">v1.networking.k8s.io                   Local                        True        23h</span><br><span class="line">v1.rbac.authorization.k8s.io           Local                        True        23h</span><br><span class="line">v1.scheduling.k8s.io                   Local                        True        23h</span><br><span class="line">v1.storage.k8s.io                      Local                        True        23h</span><br><span class="line">v1alpha1.auditregistration.k8s.io      Local                        True        23h</span><br><span class="line">v1alpha1.node.k8s.io                   Local                        True        23h</span><br><span class="line">v1alpha1.rbac.authorization.k8s.io     Local                        True        23h</span><br><span class="line">v1alpha1.scheduling.k8s.io             Local                        True        23h</span><br><span class="line">v1alpha1.settings.k8s.io               Local                        True        23h</span><br><span class="line">v1alpha1.storage.k8s.io                Local                        True        23h</span><br><span class="line">v1beta1.admissionregistration.k8s.io   Local                        True        23h</span><br><span class="line">v1beta1.apiextensions.k8s.io           Local                        True        23h</span><br><span class="line">v1beta1.apps                           Local                        True        23h</span><br><span class="line">v1beta1.authentication.k8s.io          Local                        True        23h</span><br><span class="line">v1beta1.authorization.k8s.io           Local                        True        23h</span><br><span class="line">v1beta1.batch                          Local                        True        23h</span><br><span class="line">v1beta1.certificates.k8s.io            Local                        True        23h</span><br><span class="line">v1beta1.coordination.k8s.io            Local                        True        23h</span><br><span class="line">v1beta1.events.k8s.io                  Local                        True        23h</span><br><span class="line">v1beta1.extensions                     Local                        True        23h</span><br><span class="line">v1beta1.metrics.k8s.io                 kube-system/metrics-server   True        27m</span><br><span class="line">v1beta1.networking.k8s.io              Local                        True        23h</span><br><span class="line">v1beta1.node.k8s.io                    Local                        True        23h</span><br><span class="line">v1beta1.policy                         Local                        True        23h</span><br><span class="line">v1beta1.rbac.authorization.k8s.io      Local                        True        23h</span><br><span class="line">v1beta1.scheduling.k8s.io              Local                        True        23h</span><br><span class="line">v1beta1.storage.k8s.io                 Local                        True        23h</span><br><span class="line">v1beta2.apps                           Local                        True        23h</span><br><span class="line">v2alpha1.batch                         Local                        True        23h</span><br><span class="line">v2beta1.autoscaling                    Local                        True        23h</span><br><span class="line">v2beta2.autoscaling                    Local                        True        23h</span><br></pre></td></tr></table></figure><h3 id="metrics-server-çš„å‘½ä»¤è¡Œå‚æ•°"><a href="#metrics-server-çš„å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="metrics-server çš„å‘½ä»¤è¡Œå‚æ•°"></a>metrics-server çš„å‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec --namespace kube-system -it metrics-server-94ff5d4cc-b97l5 -- /metrics-server --help</span></span><br><span class="line">Launch metrics-server</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">   [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --alsologtostderr                                         <span class="built_in">log</span> to standard error as well as files</span><br><span class="line">      --authentication-kubeconfig string                        kubeconfig file pointing at the <span class="string">'core'</span> kubernetes server with enough rights to create tokenaccessreviews.authentication.k8s.io.</span><br><span class="line">      --authentication-skip-lookup                              If <span class="literal">false</span>, the authentication-kubeconfig will be used to lookup missing authentication configuration from the cluster.</span><br><span class="line">      --authentication-token-webhook-cache-ttl duration         The duration to cache responses from the webhook token authenticator. (default 10s)</span><br><span class="line">      --authentication-tolerate-lookup-failure                  If <span class="literal">true</span>, failures to look up missing authentication configuration from the cluster are not considered fatal. Note that this can result <span class="keyword">in</span> authentication that treats all requests as anonymous.</span><br><span class="line">      --authorization-always-allow-paths strings                A list of HTTP paths to skip during authorization, i.e. these are authorized without contacting the <span class="string">'core'</span> kubernetes server.</span><br><span class="line">      --authorization-kubeconfig string                         kubeconfig file pointing at the <span class="string">'core'</span> kubernetes server with enough rights to create subjectaccessreviews.authorization.k8s.io.</span><br><span class="line">      --authorization-webhook-cache-authorized-ttl duration     The duration to cache <span class="string">'authorized'</span> responses from the webhook authorizer. (default 10s)</span><br><span class="line">      --authorization-webhook-cache-unauthorized-ttl duration   The duration to cache <span class="string">'unauthorized'</span> responses from the webhook authorizer. (default 10s)</span><br><span class="line">      --<span class="built_in">bind</span>-address ip                                         The IP address on <span class="built_in">which</span> to listen <span class="keyword">for</span> the --secure-port port. The associated interface(s) must be reachable by the rest of the cluster, and by CLI/web clients. If blank, all interfaces will be used (0.0.0.0 <span class="keyword">for</span> all IPv4 interfaces and :: <span class="keyword">for</span> all IPv6 interfaces). (default 0.0.0.0)</span><br><span class="line">      --cert-dir string                                         The directory <span class="built_in">where</span> the TLS certs are located. If --tls-cert-file and --tls-private-key-file are provided, this flag will be ignored. (default <span class="string">"apiserver.local.config/certificates"</span>)</span><br><span class="line">      --client-ca-file string                                   If <span class="built_in">set</span>, any request presenting a client certificate signed by one of the authorities <span class="keyword">in</span> the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.</span><br><span class="line">      --contention-profiling                                    Enable lock contention profiling, <span class="keyword">if</span> profiling is enabled</span><br><span class="line">  -h, --<span class="built_in">help</span>                                                    <span class="built_in">help</span> <span class="keyword">for</span> this <span class="built_in">command</span></span><br><span class="line">      --http2-max-streams-per-connection int                    The <span class="built_in">limit</span> that the server gives to clients <span class="keyword">for</span> the maximum number of streams <span class="keyword">in</span> an HTTP/2 connection. Zero means to use golang<span class="string">'s default.</span></span><br><span class="line"><span class="string">      --kubeconfig string                                       The path to the kubeconfig used to connect to the Kubernetes API server and the Kubelets (defaults to in-cluster config)</span></span><br><span class="line"><span class="string">      --kubelet-certificate-authority string                    Path to the CA to use to validate the Kubelet'</span>s serving certificates.</span><br><span class="line">      --kubelet-insecure-tls                                    Do not verify CA of serving certificates presented by Kubelets.  For testing purposes only.</span><br><span class="line">      --kubelet-port int                                        The port to use to connect to Kubelets. (default 10250)</span><br><span class="line">      --kubelet-preferred-address-types strings                 The priority of node address types to use when determining <span class="built_in">which</span> address to use to connect to a particular node (default [Hostname,InternalDNS,InternalIP,ExternalDNS,ExternalIP])</span><br><span class="line">      --<span class="built_in">log</span>-flush-frequency duration                            Maximum number of seconds between <span class="built_in">log</span> flushes (default 5s)</span><br><span class="line">      --log_backtrace_at traceLocation                          when logging hits line file:N, emit a stack trace (default :0)</span><br><span class="line">      --log_dir string                                          If non-empty, write <span class="built_in">log</span> files <span class="keyword">in</span> this directory</span><br><span class="line">      --log_file string                                         If non-empty, use this <span class="built_in">log</span> file</span><br><span class="line">      --logtostderr                                             <span class="built_in">log</span> to standard error instead of files (default <span class="literal">true</span>)</span><br><span class="line">      --metric-resolution duration                              The resolution at <span class="built_in">which</span> metrics-server will retain metrics. (default 1m0s)</span><br><span class="line">      --profiling                                               Enable profiling via web interface host:port/debug/pprof/ (default <span class="literal">true</span>)</span><br><span class="line">      --requestheader-allowed-names strings                     List of client certificate common names to allow to provide usernames <span class="keyword">in</span> headers specified by --requestheader-username-headers. If empty, any client certificate validated by the authorities <span class="keyword">in</span> --requestheader-client-ca-file is allowed.</span><br><span class="line">      --requestheader-client-ca-file string                     Root certificate bundle to use to verify client certificates on incoming requests before trusting usernames <span class="keyword">in</span> headers specified by --requestheader-username-headers. WARNING: generally <span class="keyword">do</span> not depend on authorization being already <span class="keyword">done</span> <span class="keyword">for</span> incoming requests.</span><br><span class="line">      --requestheader-extra-headers-prefix strings              List of request header prefixes to inspect. X-Remote-Extra- is suggested. (default [x-remote-extra-])</span><br><span class="line">      --requestheader-group-headers strings                     List of request headers to inspect <span class="keyword">for</span> groups. X-Remote-Group is suggested. (default [x-remote-group])</span><br><span class="line">      --requestheader-username-headers strings                  List of request headers to inspect <span class="keyword">for</span> usernames. X-Remote-User is common. (default [x-remote-user])</span><br><span class="line">      --secure-port int                                         The port on <span class="built_in">which</span> to serve HTTPS with authentication and authorization.If 0, don<span class="string">'t serve HTTPS at all. (default 443)</span></span><br><span class="line"><span class="string">      --skip_headers                                            If true, avoid header prefixes in the log messages</span></span><br><span class="line"><span class="string">      --stderrthreshold severity                                logs at or above this threshold go to stderr</span></span><br><span class="line"><span class="string">      --tls-cert-file string                                    File containing the default x509 Certificate for HTTPS. (CA cert, if any, concatenated after server cert). If HTTPS serving is enabled, and --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to the directory specified by --cert-dir.</span></span><br><span class="line"><span class="string">      --tls-cipher-suites strings                               Comma-separated list of cipher suites for the server. If omitted, the default Go cipher suites will be use.  Possible values: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_RC4_128_SHA,TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_RC4_128_SHA,TLS_RSA_WITH_3DES_EDE_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA256,TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_RC4_128_SHA</span></span><br><span class="line"><span class="string">      --tls-min-version string                                  Minimum TLS version supported. Possible values: VersionTLS10, VersionTLS11, VersionTLS12</span></span><br><span class="line"><span class="string">      --tls-private-key-file string                             File containing the default x509 private key matching --tls-cert-file.</span></span><br><span class="line"><span class="string">      --tls-sni-cert-key namedCertKey                           A pair of x509 certificate and private key file paths, optionally suffixed with a list of domain patterns which are fully qualified domain names, possibly with prefixed wildcard segments. If no domain patterns are provided, the names of the certificate are extracted. Non-wildcard matches trump over wildcard matches, explicit domain patterns trump over extracted names. For multiple key/certificate pairs, use the --tls-sni-cert-key multiple times. Examples: "example.crt,example.key" or "foo.crt,foo.key:*.foo.com,foo.com". (default [])</span></span><br><span class="line"><span class="string">  -v, --v Level                                                 number for the log level verbosity</span></span><br><span class="line"><span class="string">      --vmodule moduleSpec                                      comma-separated list of pattern=N settings for file-filtered logging</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>metrics-server</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 dashboard</title>
    <url>/2019/09/16/k8s-v1-14-dashboard/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>kuberntes è‡ªå¸¦æ’ä»¶çš„ manifests yaml æ–‡ä»¶ä½¿ç”¨ gcr.io çš„ docker registryï¼Œå›½å†…è¢«å¢™ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä¸ºå…¶å®ƒ registry åœ°å€</p><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-src.tar.gz</span></span><br></pre></td></tr></table></figure><p>dashboard å¯¹åº”çš„ç›®å½•æ˜¯ï¼šcluster/addons/dashboardï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd cluster/addons/dashboard</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ service å®šä¹‰ï¼ŒæŒ‡å®šç«¯å£ç±»å‹ä¸º NodePortï¼Œè¿™æ ·å¤–ç•Œå¯ä»¥é€šè¿‡åœ°å€ NodeIP:NodePort è®¿é—® dashboardï¼›</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat dashboard-service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort <span class="comment"># å¢åŠ è¿™ä¸€è¡Œ</span></span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat dashboard-controller.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'docker/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: docker.io/xxlaila/kubernetes-dashboard-amd64:v1.10.0  <span class="comment">#ä¿®æ”¹è¿™ä¸€è¡Œ</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶"><a href="#æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶" class="headerlink" title="æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶"></a>æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls *.yaml</span></span><br><span class="line">dashboard-configmap.yaml  dashboard-controller.yaml  dashboard-rbac.yaml  dashboard-secret.yaml  dashboard-service.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f  .</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹åˆ†é…çš„-NodePort"><a href="#æŸ¥çœ‹åˆ†é…çš„-NodePort" class="headerlink" title="æŸ¥çœ‹åˆ†é…çš„ NodePort"></a>æŸ¥çœ‹åˆ†é…çš„ NodePort</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get deployment kubernetes-dashboard  -n kube-system</span></span><br><span class="line">NAME                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kubernetes-dashboard   1/1     1            1           5h10m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl --namespace kube-system get pods -o wide</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP             NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-5579b8778b-xw8m9                1/1     Running   1          5h15m   172.30.232.3   172.21.16.204   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-6cc78dfc99-hb4l5   1/1     Running   0          5h10m   172.30.176.3   172.21.16.240   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get services kubernetes-dashboard -n kube-system</span></span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.254.214.153   &lt;none&gt;        443:32533/TCP   5h10m</span><br></pre></td></tr></table></figure><ul><li>NodePort 32533 æ˜ å°„åˆ° dashboard pod 443 ç«¯å£ï¼›</li></ul><h3 id="æŸ¥çœ‹-dashboard-æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°"><a href="#æŸ¥çœ‹-dashboard-æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="æŸ¥çœ‹ dashboard æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°"></a>æŸ¥çœ‹ dashboard æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec --namespace kube-system -it kubernetes-dashboard-6cc78dfc99-hb4l5  -- /dashboard --help</span></span><br><span class="line">2019/09/16 09:51:33 Starting overwatch</span><br><span class="line">Usage of /dashboard:</span><br><span class="line">      --alsologtostderr                  <span class="built_in">log</span> to standard error as well as files</span><br><span class="line">      --api-log-level string             Level of API request logging. Should be one of <span class="string">'INFO|NONE|DEBUG'</span>. Default: <span class="string">'INFO'</span>. (default <span class="string">"INFO"</span>)</span><br><span class="line">      --apiserver-host string            The address of the Kubernetes Apiserver to connect to <span class="keyword">in</span> the format of protocol://address:port, e.g., http://localhost:8080. If not specified, the assumption is that the binary runs inside a Kubernetes cluster and <span class="built_in">local</span> discovery is attempted.</span><br><span class="line">      --authentication-mode strings      Enables authentication options that will be reflected on login screen. Supported values: token, basic. Default: token.Note that basic option should only be used <span class="keyword">if</span> apiserver has <span class="string">'--authorization-mode=ABAC'</span> and <span class="string">'--basic-auth-file'</span> flags <span class="built_in">set</span>. (default [token])</span><br><span class="line">      --auto-generate-certificates       When <span class="built_in">set</span> to <span class="literal">true</span>, Dashboard will automatically generate certificates used to serve HTTPS. Default: <span class="literal">false</span>.</span><br><span class="line">      --<span class="built_in">bind</span>-address ip                  The IP address on <span class="built_in">which</span> to serve the --secure-port (<span class="built_in">set</span> to 0.0.0.0 <span class="keyword">for</span> all interfaces). (default 0.0.0.0)</span><br><span class="line">      --default-cert-dir string          Directory path containing <span class="string">'--tls-cert-file'</span> and <span class="string">'--tls-key-file'</span> files. Used also when auto-generating certificates flag is <span class="built_in">set</span>. (default <span class="string">"/certs"</span>)</span><br><span class="line">      --<span class="built_in">disable</span>-settings-authorizer      When enabled, Dashboard settings page will not require user to be logged <span class="keyword">in</span> and authorized to access settings page.</span><br><span class="line">      --<span class="built_in">disable</span>-skip                     When enabled, the skip button on the login page will not be shown. Default: <span class="literal">false</span>.</span><br><span class="line">      --<span class="built_in">enable</span>-insecure-login            When enabled, Dashboard login view will also be shown when Dashboard is not served over HTTPS. Default: <span class="literal">false</span>.</span><br><span class="line">      --heapster-host string             The address of the Heapster Apiserver to connect to <span class="keyword">in</span> the format of protocol://address:port, e.g., http://localhost:8082. If not specified, the assumption is that the binary runs inside a Kubernetes cluster and service proxy will be used.</span><br><span class="line">      --insecure-bind-address ip         The IP address on <span class="built_in">which</span> to serve the --port (<span class="built_in">set</span> to 0.0.0.0 <span class="keyword">for</span> all interfaces). (default 127.0.0.1)</span><br><span class="line">      --insecure-port int                The port to listen to <span class="keyword">for</span> incoming HTTP requests. (default 9090)</span><br><span class="line">      --kubeconfig string                Path to kubeconfig file with authorization and master location information.</span><br><span class="line">      --log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace (default :0)</span><br><span class="line">      --log_dir string                   If non-empty, write <span class="built_in">log</span> files <span class="keyword">in</span> this directory</span><br><span class="line">      --logtostderr                      <span class="built_in">log</span> to standard error instead of files</span><br><span class="line">      --metric-client-check-period int   Time <span class="keyword">in</span> seconds that defines how often configured metric client health check should be run. Default: 30 seconds. (default 30)</span><br><span class="line">      --port int                         The secure port to listen to <span class="keyword">for</span> incoming HTTPS requests. (default 8443)</span><br><span class="line">      --stderrthreshold severity         logs at or above this threshold go to stderr (default 2)</span><br><span class="line">      --system-banner string             When non-empty displays message to Dashboard users. Accepts simple HTML tags. Default: <span class="string">''</span>.</span><br><span class="line">      --system-banner-severity string    Severity of system banner. Should be one of <span class="string">'INFO|WARNING|ERROR'</span>. Default: <span class="string">'INFO'</span>. (default <span class="string">"INFO"</span>)</span><br><span class="line">      --tls-cert-file string             File containing the default x509 Certificate <span class="keyword">for</span> HTTPS.</span><br><span class="line">      --tls-key-file string              File containing the default x509 private key matching --tls-cert-file.</span><br><span class="line">      --token-ttl int                    Expiration time (<span class="keyword">in</span> seconds) of JWE tokens generated by dashboard. Default: 15 min. 0 - never expires (default 900)</span><br><span class="line">  -v, --v Level                          <span class="built_in">log</span> level <span class="keyword">for</span> V logs</span><br><span class="line">      --vmodule moduleSpec               comma-separated list of pattern=N settings <span class="keyword">for</span> file-filtered logging</span><br><span class="line">pflag: <span class="built_in">help</span> requested</span><br><span class="line"><span class="built_in">command</span> terminated with <span class="built_in">exit</span> code 2</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashboard çš„ â€“authentication-mode æ”¯æŒ tokenã€basicï¼Œé»˜è®¤ä¸º tokenã€‚å¦‚æœä½¿ç”¨ basicï¼Œåˆ™ kube-apiserver å¿…é¡»é…ç½® â€“authorization-mode=ABAC å’Œ â€“basic-auth-file å‚æ•°</p><h3 id="è®¿é—®-dashboard"><a href="#è®¿é—®-dashboard" class="headerlink" title="è®¿é—® dashboard"></a>è®¿é—® dashboard</h3><p>ä½¿ç”¨httpsåè®®ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ä»»æ„nodeçš„ipåŠ ç«¯å£å³å¯è®¿é—®<br><img src="https://img.xxlaila.cn/1568961339763.jpg" alt="img"></p><h3 id="åˆ›å»ºç™»å½•-Dashboard-çš„-token-å’Œ-kubeconfig-é…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºç™»å½•-Dashboard-çš„-token-å’Œ-kubeconfig-é…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºç™»å½• Dashboard çš„ token å’Œ kubeconfig é…ç½®æ–‡ä»¶"></a>åˆ›å»ºç™»å½• Dashboard çš„ token å’Œ kubeconfig é…ç½®æ–‡ä»¶</h3><p>dashboard é»˜è®¤åªæ”¯æŒ token è®¤è¯ï¼ˆä¸æ”¯æŒ client è¯ä¹¦è®¤è¯ï¼‰ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨ Kubeconfig æ–‡ä»¶ï¼Œéœ€è¦å°† token å†™å…¥åˆ°è¯¥æ–‡ä»¶ã€‚</p><h4 id="åˆ›å»ºç™»å½•-token"><a href="#åˆ›å»ºç™»å½•-token" class="headerlink" title="åˆ›å»ºç™»å½• token"></a>åˆ›å»ºç™»å½• token</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create sa dashboard-admin -n kube-system</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span></span><br><span class="line"><span class="comment"># ADMIN_SECRET=$(kubectl get secrets -n kube-system | grep dashboard-admin | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># DASHBOARD_LOGIN_TOKEN=$(kubectl describe secret -n kube-system $&#123;ADMIN_SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;DASHBOARD_LOGIN_TOKEN&#125;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¾“å‡ºçš„ token ç™»å½• Dashboardã€‚</p><h3 id="åˆ›å»ºä½¿ç”¨-token-çš„-KubeConfig-æ–‡ä»¶"><a href="#åˆ›å»ºä½¿ç”¨-token-çš„-KubeConfig-æ–‡ä»¶" class="headerlink" title="åˆ›å»ºä½¿ç”¨ token çš„ KubeConfig æ–‡ä»¶"></a>åˆ›å»ºä½¿ç”¨ token çš„ KubeConfig æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°ï¼Œä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ Token</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials dashboard_user \</span><br><span class="line">  --token=<span class="variable">$&#123;DASHBOARD_LOGIN_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=dashboard_user \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context default --kubeconfig=dashboard.kubeconfig</span><br></pre></td></tr></table></figure><p>å¦‚å›¾:<br><img src="https://img.xxlaila.cn/1568961447890.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨ç”Ÿæˆçš„ dashboard.kubeconfig ç™»å½• Dashboardã€‚ç”±äºk8s é»˜è®¤çš„Dashboard 15åˆ†é’Ÿåå°±ä¼šå¼¹å‡ºï¼Œåˆè¦é‡æ–°ç™»å½•å’Œè·å–tokenéº»çƒ¦ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://xxlaila.github.io/2019/08/29/k8sé…ç½®Dashboard/" target="_blank" rel="noopener">k8sé…ç½®Dashboard</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 dnsæ’ä»¶</title>
    <url>/2019/09/16/k8s-v1-14-dns%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="éƒ¨ç½²-coredns-æ’ä»¶"><a href="#éƒ¨ç½²-coredns-æ’ä»¶" class="headerlink" title="éƒ¨ç½² coredns æ’ä»¶"></a>éƒ¨ç½² coredns æ’ä»¶</h3><p><strong>æ³¨æ„:</strong></p><ul><li>kuberntes è‡ªå¸¦æ’ä»¶çš„ manifests yaml æ–‡ä»¶ä½¿ç”¨ gcr.io çš„ docker registryï¼Œå›½å†…è¢«å¢™ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä¸ºå…¶å®ƒ registry åœ°å€;</li></ul><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-src.tar.gz</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li>coredns ç›®å½•æ˜¯ cluster/addons/dns<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd cluster/addons/dns/coredns</span></span><br><span class="line"><span class="comment"># cp coredns.yaml.base coredns.yaml</span></span><br><span class="line"><span class="comment"># sed -i -e "s/__PILLAR__DNS__DOMAIN__/cluster.local/" -e "s/__PILLAR__DNS__SERVER__/10.254.0.2/" coredns.yaml</span></span><br><span class="line"><span class="comment"># sed -i "s/k8s.gcr.io/coredns/" coredns.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f coredns.yaml</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="æ£€æŸ¥-coredns-åŠŸèƒ½"><a href="#æ£€æŸ¥-coredns-åŠŸèƒ½" class="headerlink" title="æ£€æŸ¥ coredns åŠŸèƒ½"></a>æ£€æŸ¥ coredns åŠŸèƒ½</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get all -n kube-system</span></span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-5579b8778b-xw8m9                1/1     Running   1          5h7m</span><br><span class="line"></span><br><span class="line">NAME                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/kube-dns               ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   5h7m</span><br><span class="line"></span><br><span class="line">NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/coredns                1/1     1            1           5h7m</span><br><span class="line"></span><br><span class="line">NAME                                              DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/coredns-5579b8778b                1         1         1       5h7m</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-9fb46   1/1     Running   0          5h14m</span><br><span class="line">nginx-ds-bgfzt   1/1     Running   0          5h14m</span><br><span class="line">nginx-ds-t22wj   1/1     Running   0          5h14m</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -it exec nginx-ds-9fb46 bash</span></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># cat /etc/resolv.conf</span></span><br><span class="line">nameserver 10.254.0.2</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local openstacklocal novalocal</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping www.baidu.com</span></span><br><span class="line">PING www.wshifen.com (104.193.88.77): 48 data bytes</span><br><span class="line">56 bytes from 104.193.88.77: icmp_seq=0 ttl=45 time=191.953 ms</span><br><span class="line">56 bytes from 104.193.88.77: icmp_seq=1 ttl=45 time=191.680 ms</span><br><span class="line">^C--- www.wshifen.com ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 191.680/191.817/191.953/0.137 ms</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.120 ms</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=1 ttl=64 time=0.116 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.116/0.118/0.120/0.000 ms</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.079 ms</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=1 ttl=64 time=0.152 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.079/0.115/0.152/0.037 ms</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc.cluster.local.</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.080 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.080/0.080/0.080/0.000 ms</span><br><span class="line">`</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14 coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14é›†ç¾¤éªŒè¯</title>
    <url>/2019/09/16/k8s-v1-14%E9%9B%86%E7%BE%A4%E9%AA%8C%E8%AF%81/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="éªŒè¯é›†ç¾¤åŠŸèƒ½"><a href="#éªŒè¯é›†ç¾¤åŠŸèƒ½" class="headerlink" title="éªŒè¯é›†ç¾¤åŠŸèƒ½"></a>éªŒè¯é›†ç¾¤åŠŸèƒ½</h3><h3 id="æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€"><a href="#æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€"></a>æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   5h50m   v1.14.6</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   5h48m   v1.14.6</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   5h45m   v1.14.6</span><br></pre></td></tr></table></figure><p>éƒ½ä¸º Ready æ—¶æ­£å¸¸ã€‚</p><a id="more"></a><h3 id="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"><a href="#åˆ›å»ºæµ‹è¯•æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"></a>åˆ›å»ºæµ‹è¯•æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat nginx-ds.yml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f nginx-ds.yml</span></span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥å„èŠ‚ç‚¹çš„-Pod-IP-è¿é€šæ€§"><a href="#æ£€æŸ¥å„èŠ‚ç‚¹çš„-Pod-IP-è¿é€šæ€§" class="headerlink" title="æ£€æŸ¥å„èŠ‚ç‚¹çš„ Pod IP è¿é€šæ€§"></a>æ£€æŸ¥å„èŠ‚ç‚¹çš„ Pod IP è¿é€šæ€§</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods  -o wide|grep nginx-ds</span></span><br><span class="line">nginx-ds-9fb46   1/1     Running   0          5h2m   172.30.232.2   172.21.16.204   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-bgfzt   1/1     Running   0          5h2m   172.30.128.2   172.21.16.87    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-t22wj   1/1     Running   0          5h2m   172.30.176.2   172.21.16.240   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥æœåŠ¡-IP-å’Œç«¯å£å¯è¾¾æ€§"><a href="#æ£€æŸ¥æœåŠ¡-IP-å’Œç«¯å£å¯è¾¾æ€§" class="headerlink" title="æ£€æŸ¥æœåŠ¡ IP å’Œç«¯å£å¯è¾¾æ€§"></a>æ£€æŸ¥æœåŠ¡ IP å’Œç«¯å£å¯è¾¾æ€§</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc |grep nginx-ds</span></span><br><span class="line">nginx-ds     NodePort    10.254.232.104   &lt;none&gt;        80:30349/TCP   5h2m</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨åœ¨30349è¿›è¡Œè®¿é—®å¯ä»¥çœ‹åˆ°neinxçš„æ¬¢è¿ç•Œé¢</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-v1.14 nodeå®‰è£…</title>
    <url>/2019/09/16/kubernetes-v1-14-node%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="1ã€å®‰è£…docker"><a href="#1ã€å®‰è£…docker" class="headerlink" title="1ã€å®‰è£…docker"></a>1ã€å®‰è£…docker</h3><h4 id="1-1ã€å¢åŠ docker-æº"><a href="#1-1ã€å¢åŠ docker-æº" class="headerlink" title="1.1ã€å¢åŠ docker æº"></a>1.1ã€å¢åŠ docker æº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">  --add-repo \</span><br><span class="line">  https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h4 id="1-2ã€å®‰è£…docker"><a href="#1-2ã€å®‰è£…docker" class="headerlink" title="1.2ã€å®‰è£…docker"></a>1.2ã€å®‰è£…docker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  yum -y install docker-ce</span></span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-3ã€ä¿®æ”¹docker-systemd-unit-æ–‡ä»¶"><a href="#1-3ã€ä¿®æ”¹docker-systemd-unit-æ–‡ä»¶" class="headerlink" title="1.3ã€ä¿®æ”¹docker systemd unit æ–‡ä»¶"></a>1.3ã€ä¿®æ”¹docker systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/docker.service |egrep -Ev "^$|^#"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">BindsTo=containerd.service</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/run/flannel/docker</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>dockerd è¿è¡Œæ—¶ä¼šè°ƒç”¨å…¶å®ƒ docker å‘½ä»¤ï¼Œå¦‚ docker-proxyï¼Œæ‰€ä»¥éœ€è¦å°† docker å‘½ä»¤æ‰€åœ¨çš„ç›®å½•åŠ åˆ° PATH ç¯å¢ƒå˜é‡ä¸­ï¼›</li><li>flanneld å¯åŠ¨æ—¶å°†ç½‘ç»œé…ç½®å†™å…¥ /run/flannel/docker æ–‡ä»¶ä¸­ï¼Œdockerd å¯åŠ¨å‰è¯»å–è¯¥æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡ DOCKER_NETWORK_OPTIONS ï¼Œç„¶åè®¾ç½® docker0 ç½‘æ¡¥ç½‘æ®µï¼›</li><li>å¦‚æœæŒ‡å®šäº†å¤šä¸ª EnvironmentFile é€‰é¡¹ï¼Œåˆ™å¿…é¡»å°† /run/flannel/docker æ”¾åœ¨æœ€å(ç¡®ä¿ docker0 ä½¿ç”¨ flanneld ç”Ÿæˆçš„ bip å‚æ•°)ï¼›</li><li>docker éœ€è¦ä»¥ root ç”¨äºè¿è¡Œï¼›</li></ul><h4 id="1-4ã€å¯åŠ¨-docker-æœåŠ¡"><a href="#1-4ã€å¯åŠ¨-docker-æœåŠ¡" class="headerlink" title="1.4ã€å¯åŠ¨ docker æœåŠ¡"></a>1.4ã€å¯åŠ¨ docker æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable docker &amp;&amp; systemctl restart docker &amp;&amp; systemctl status docker</span></span><br></pre></td></tr></table></figure><h4 id="1-5ã€æ£€æŸ¥-docker0-ç½‘æ¡¥"><a href="#1-5ã€æ£€æŸ¥-docker0-ç½‘æ¡¥" class="headerlink" title="1.5ã€æ£€æŸ¥ docker0 ç½‘æ¡¥"></a>1.5ã€æ£€æŸ¥ docker0 ç½‘æ¡¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/sbin/ip addr show flannel.1 &amp;&amp; /usr/sbin/ip addr show docker0</span></span><br><span class="line">3: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether 8a:be:12:b9:ab:b8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.128.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:eb:ec:ae:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.128.1/21 brd 172.30.135.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h4 id="1-5ã€æŸ¥çœ‹-docker-çš„çŠ¶æ€ä¿¡æ¯"><a href="#1-5ã€æŸ¥çœ‹-docker-çš„çŠ¶æ€ä¿¡æ¯" class="headerlink" title="1.5ã€æŸ¥çœ‹ docker çš„çŠ¶æ€ä¿¡æ¯"></a>1.5ã€æŸ¥çœ‹ docker çš„çŠ¶æ€ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ps -elfH|grep docker</span></span><br><span class="line">0 S root      1436   975  0  80   0 - 28167 -      10:54 pts/0    00:00:00                 grep --color=auto docker</span><br><span class="line">4 S root      1265     1  1  80   0 - 122095 futex_ 10:54 ?       00:00:00   /usr/bin/dockerd --bip=172.30.112.1/21 --ip-masq=<span class="literal">false</span> --mtu=1450</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker info</span></span><br><span class="line">vClient:</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 0</span><br><span class="line">  Running: 0</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 0</span><br><span class="line"> Images: 0</span><br><span class="line"> Server Version: 18.09.6</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: xfs</span><br><span class="line">  Supports d_type: <span class="literal">true</span></span><br><span class="line">  Native Overlay Diff: <span class="literal">true</span></span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: <span class="built_in">local</span></span><br><span class="line">  Network: bridge host macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk syslog</span><br><span class="line"> Swarm: inactive</span><br><span class="line"> Runtimes: runc</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version: 894b81a4b802e4eb2a91d1ce216b8817763c29fb</span><br><span class="line"> runc version: 425e105d5a03fabd737a126ad93d62a9eeede87f</span><br><span class="line"> init version: fec3683</span><br><span class="line"> Security Options:</span><br><span class="line">  seccomp</span><br><span class="line">   Profile: default</span><br><span class="line"> Kernel Version: 4.4.193-1.el7.elrepo.x86_64</span><br><span class="line"> Operating System: CentOS Linux 7 (Core)</span><br><span class="line"> OSType: linux</span><br><span class="line"> Architecture: x86_64</span><br><span class="line"> CPUs: 4</span><br><span class="line"> Total Memory: 7.796GiB</span><br><span class="line"> Name: k8s-node-2.kxl</span><br><span class="line"> ID: GJEA:U6PT:NMHM:KWD2:DOIJ:U6XW:6N3U:4QZN:F5PT:CQXH:MZKU:VATL</span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Registry: https://index.docker.io/v1/</span><br><span class="line"> Labels:</span><br><span class="line"> Experimental: <span class="literal">false</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Live Restore Enabled: <span class="literal">false</span></span><br><span class="line"> Product License: Community Engine</span><br></pre></td></tr></table></figure><h3 id="2ã€éƒ¨ç½²-kubelet-ç»„ä»¶"><a href="#2ã€éƒ¨ç½²-kubelet-ç»„ä»¶" class="headerlink" title="2ã€éƒ¨ç½² kubelet ç»„ä»¶"></a>2ã€éƒ¨ç½² kubelet ç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet è¿è¡Œåœ¨æ¯ä¸ª worker èŠ‚ç‚¹ä¸Šï¼Œæ¥æ”¶ kube-apiserver å‘é€çš„è¯·æ±‚ï¼Œç®¡ç† Pod å®¹å™¨ï¼Œæ‰§è¡Œäº¤äº’å¼å‘½ä»¤ï¼Œå¦‚ execã€runã€logs ç­‰ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨æ—¶è‡ªåŠ¨å‘ kube-apiserver æ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œå†…ç½®çš„ cadvisor ç»Ÿè®¡å’Œç›‘æ§èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºç¡®ä¿å®‰å…¨ï¼Œéƒ¨ç½²æ—¶å…³é—­äº† kubelet çš„éå®‰å…¨ http ç«¯å£ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒï¼Œæ‹’ç»æœªæˆæƒçš„è®¿é—®(å¦‚ apiserverã€heapster çš„è¯·æ±‚)ã€‚</p><h4 id="2-1ã€åˆ›å»º-kubelet-bootstrap-kubeconfig-æ–‡ä»¶"><a href="#2-1ã€åˆ›å»º-kubelet-bootstrap-kubeconfig-æ–‡ä»¶" class="headerlink" title="2.1ã€åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶"></a>2.1ã€åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶</h4><p>NODE_NAMES é‡Œé¢çš„å€¼æ˜¯nodeçš„ä¸»æœºå</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># NODE_NAMES=(node-01 node-02 node-03)</span></span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»º token</span></span><br><span class="line">    <span class="built_in">export</span> BOOTSTRAP_TOKEN=$(kubeadm token create \</span><br><span class="line">      --description kubelet-bootstrap-token \</span><br><span class="line">      --groups system:bootstrappers:<span class="variable">$&#123;node_name&#125;</span> \</span><br><span class="line">      --kubeconfig ~/.kube/config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">      --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">      --embed-certs=<span class="literal">true</span> \</span><br><span class="line">      --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</span><br><span class="line">      --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">      --cluster=kubernetes \</span><br><span class="line">      --user=kubelet-bootstrap \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">    kubectl config use-context default --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for node_name in $&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">    scp kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig root@<span class="variable">$&#123;node_name&#125;</span>:/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li><p>å‘ kubeconfig å†™å…¥çš„æ˜¯ tokenï¼Œbootstrap ç»“æŸå kube-controller-manager ä¸º kubelet åˆ›å»º client å’Œ server è¯ä¹¦ï¼›</p></li><li><p>æŸ¥çœ‹ kubeadm ä¸ºå„èŠ‚ç‚¹åˆ›å»ºçš„ token:<br>master èŠ‚ç‚¹æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm token list --kubeconfig ~/.kube/config</span></span><br><span class="line">TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION               EXTRA GROUPS</span><br><span class="line">016e9x.306t91l832suzg8i   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-03</span><br><span class="line">4l4tcx.juy6qs9rmrnfpbig   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-01</span><br><span class="line">64pk36.vbhvbmtojpskyclt   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-02</span><br></pre></td></tr></table></figure><ul><li>token æœ‰æ•ˆæœŸä¸º 1 å¤©ï¼Œè¶…æœŸåå°†ä¸èƒ½å†è¢«ç”¨æ¥ boostrap kubeletï¼Œä¸”ä¼šè¢« kube-controller-manager çš„ tokencleaner æ¸…ç†ï¼›</li><li>kube-apiserver æ¥æ”¶ kubelet çš„ bootstrap token åï¼Œå°†è¯·æ±‚çš„ user è®¾ç½®ä¸º system:bootstrap:<token>ï¼Œgroup è®¾ç½®ä¸º system:bootstrappersï¼Œåç»­å°†ä¸ºè¿™ä¸ª group è®¾ç½® ClusterRoleBindingï¼›</token></li></ul></li><li><p>æŸ¥çœ‹å„ token å…³è”çš„ Secretï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get secrets  -n kube-system|grep bootstrap-token</span></span><br><span class="line">bootstrap-token-016e9x                           bootstrap.kubernetes.io/token         7      4h25m</span><br><span class="line">bootstrap-token-4l4tcx                           bootstrap.kubernetes.io/token         7      4h25m</span><br><span class="line">bootstrap-token-64pk36                           bootstrap.kubernetes.io/token         7      4h25m</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2ã€åˆ›å»ºå’Œåˆ†å‘-kubelet-å‚æ•°é…ç½®æ–‡ä»¶"><a href="#2-2ã€åˆ›å»ºå’Œåˆ†å‘-kubelet-å‚æ•°é…ç½®æ–‡ä»¶" class="headerlink" title="2.2ã€åˆ›å»ºå’Œåˆ†å‘ kubelet å‚æ•°é…ç½®æ–‡ä»¶"></a>2.2ã€åˆ›å»ºå’Œåˆ†å‘ kubelet å‚æ•°é…ç½®æ–‡ä»¶</h4><p>ä» v1.10 å¼€å§‹ï¼Œéƒ¨åˆ† kubelet å‚æ•°éœ€åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œkubelet â€“help ä¼šæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DEPRECATED: This parameter should be <span class="built_in">set</span> via the config file specified by the Kubelet<span class="string">'s --config flag</span></span><br></pre></td></tr></table></figure><ul><li><p>åˆ›å»º kubelet å‚æ•°é…ç½®æ–‡ä»¶æ¨¡æ¿</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kubelet-config.yaml</span></span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: <span class="string">"0.0.0.0"</span></span><br><span class="line">staticPodPath: <span class="string">""</span></span><br><span class="line">syncFrequency: 1m</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">staticPodURL: <span class="string">""</span></span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 0</span><br><span class="line">rotateCertificates: <span class="literal">true</span></span><br><span class="line">serverTLSBootstrap: <span class="literal">true</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">registryPullQPS: 0</span><br><span class="line">registryBurst: 20</span><br><span class="line">eventRecordQPS: 0</span><br><span class="line">eventBurst: 20</span><br><span class="line">enableDebuggingHandlers: <span class="literal">true</span></span><br><span class="line">enableContentionProfiling: <span class="literal">true</span></span><br><span class="line">healthzPort: 10248</span><br><span class="line">healthzBindAddress: <span class="string">"172.21.16.87"</span> <span class="comment"># nodeèŠ‚ç‚¹ip</span></span><br><span class="line">clusterDomain: <span class="string">"cluster.local"</span></span><br><span class="line">clusterDNS:</span><br><span class="line">  - <span class="string">"10.254.0.2"</span></span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">nodeStatusReportFrequency: 1m</span><br><span class="line">imageMinimumGCAge: 2m</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">volumeStatsAggPeriod: 1m</span><br><span class="line">kubeletCgroups: <span class="string">""</span></span><br><span class="line">systemCgroups: <span class="string">""</span></span><br><span class="line">cgroupRoot: <span class="string">""</span></span><br><span class="line">cgroupsPerQOS: <span class="literal">true</span></span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">runtimeRequestTimeout: 10m</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">maxPods: 100</span><br><span class="line">podCIDR: <span class="string">"172.30.0.0/16"</span></span><br><span class="line">podPidsLimit: -1</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">kubeAPIQPS: 1000</span><br><span class="line">kubeAPIBurst: 2000</span><br><span class="line">serializeImagePulls: <span class="literal">false</span></span><br><span class="line">evictionHard:</span><br><span class="line">  memory.available:  <span class="string">"100Mi"</span></span><br><span class="line">nodefs.available:  <span class="string">"10%"</span></span><br><span class="line">nodefs.inodesFree: <span class="string">"5%"</span></span><br><span class="line">imagefs.available: <span class="string">"15%"</span></span><br><span class="line">evictionSoft: &#123;&#125;</span><br><span class="line">enableControllerAttachDetach: <span class="literal">true</span></span><br><span class="line">failSwapOn: <span class="literal">true</span></span><br><span class="line">containerLogMaxSize: 20Mi</span><br><span class="line">containerLogMaxFiles: 10</span><br><span class="line">systemReserved: &#123;&#125;</span><br><span class="line">kubeReserved: &#123;&#125;</span><br><span class="line">systemReservedCgroup: <span class="string">""</span></span><br><span class="line">kubeReservedCgroup: <span class="string">""</span></span><br><span class="line">enforceNodeAllocatable: [<span class="string">"pods"</span>]</span><br></pre></td></tr></table></figure><ul><li>addressï¼škubelet å®‰å…¨ç«¯å£ï¼ˆhttpsï¼Œ10250ï¼‰ç›‘å¬çš„åœ°å€ï¼Œä¸èƒ½ä¸º 127.0.0.1ï¼Œå¦åˆ™ kube-apiserverã€heapster ç­‰ä¸èƒ½è°ƒç”¨ kubelet çš„ APIï¼›</li><li>readOnlyPort=0ï¼šå…³é—­åªè¯»ç«¯å£(é»˜è®¤ 10255)ï¼Œç­‰æ•ˆä¸ºæœªæŒ‡å®šï¼›</li><li>authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åï¿½è®¿é—® 10250 ç«¯å£ï¼›</li><li>authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTP è¯ä¹¦è®¤è¯ï¼›</li><li>authentication.webhook.enabled=trueï¼šå¼€å¯ HTTPs bearer token è®¤è¯ï¼›</li><li>å¯¹äºæœªé€šè¿‡ x509 è¯ä¹¦å’Œ webhook è®¤è¯çš„è¯·æ±‚(kube-apiserver æˆ–å…¶ä»–å®¢æˆ·ç«¯)ï¼Œå°†è¢«æ‹’ç»ï¼Œæç¤º Unauthorizedï¼›</li><li>authroization.mode=Webhookï¼škubelet ä½¿ç”¨ SubjectAccessReview API æŸ¥è¯¢ kube-apiserver æŸ userã€group æ˜¯å¦å…·æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</li><li>featureGates.RotateKubeletClientCertificateã€featureGates.RotateKubeletServerCertificateï¼šè‡ªåŠ¨ rotate è¯ä¹¦ï¼Œè¯ä¹¦çš„æœ‰æ•ˆæœŸå–å†³äº kube-controller-manager çš„ â€“experimental-cluster-signing-duration å‚æ•°ï¼›</li><li>éœ€è¦ root è´¦æˆ·è¿è¡Œï¼›</li></ul></li></ul><h4 id="2-3ã€åˆ›å»ºkubelet-systemd-unit-æ–‡ä»¶"><a href="#2-3ã€åˆ›å»ºkubelet-systemd-unit-æ–‡ä»¶" class="headerlink" title="2.3ã€åˆ›å»ºkubelet systemd unit æ–‡ä»¶"></a>2.3ã€åˆ›å»ºkubelet systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kubelet.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kubelet</span><br><span class="line">ExecStart=/usr/bin/kubelet \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \</span><br><span class="line">  --cert-dir=/etc/kubernetes/ssl \</span><br><span class="line">  --cni-conf-dir=/etc/cni/net.d \</span><br><span class="line">  --container-runtime=docker \</span><br><span class="line">  --container-runtime-endpoint=unix:///var/run/dockershim.sock \</span><br><span class="line">  --root-dir=/var/lib/kubelet \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  --config=/etc/kubernetes/kubelet-config.yaml \</span><br><span class="line">  --hostname-override=172.21.16.87 \ <span class="comment"># node èŠ‚ç‚¹ip</span></span><br><span class="line">  --pod-infra-container-image=registry.cn-beijing.aliyuncs.com/images_k8s/pause-amd64:3.1 \</span><br><span class="line">  --image-pull-progress-deadline=15m \</span><br><span class="line">  --volume-plugin-dir=/var/lib/kubelet/kubelet-plugins/volume/<span class="built_in">exec</span>/ \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœè®¾ç½®äº† â€“hostname-override é€‰é¡¹ï¼Œåˆ™ kube-proxy ä¹Ÿéœ€è¦è®¾ç½®è¯¥é€‰é¡¹ï¼Œå¦åˆ™ä¼šå‡ºç°æ‰¾ä¸åˆ° Node çš„æƒ…å†µï¼›</li><li>â€“bootstrap-kubeconfigï¼šæŒ‡å‘ bootstrap kubeconfig æ–‡ä»¶ï¼Œkubelet ä½¿ç”¨è¯¥æ–‡ä»¶ä¸­çš„ç”¨æˆ·åå’Œ token å‘ kube-apiserver å‘é€ TLS Bootstrapping è¯·æ±‚ï¼›</li><li>K8S approve kubelet çš„ csr è¯·æ±‚åï¼Œåœ¨ â€“cert-dir ç›®å½•åˆ›å»ºè¯ä¹¦å’Œç§é’¥æ–‡ä»¶ï¼Œç„¶åå†™å…¥ â€“kubeconfig æ–‡ä»¶ï¼›</li><li>â€“pod-infra-container-image ä¸ä½¿ç”¨ redhat çš„ pod-infrastructure:latest é•œåƒï¼Œå®ƒä¸èƒ½å›æ”¶å®¹å™¨çš„åƒµå°¸ï¼›</li></ul><h4 id="2-4ã€Bootstrap-Token-Auth-å’Œæˆäºˆæƒé™"><a href="#2-4ã€Bootstrap-Token-Auth-å’Œæˆäºˆæƒé™" class="headerlink" title="2.4ã€Bootstrap Token Auth å’Œæˆäºˆæƒé™"></a>2.4ã€Bootstrap Token Auth å’Œæˆäºˆæƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨æ—¶æŸ¥æ‰¾ â€“kubeletconfig å‚æ•°å¯¹åº”çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ â€“bootstrap-kubeconfig æŒ‡å®šçš„ kubeconfig æ–‡ä»¶å‘ kube-apiserver å‘é€è¯ä¹¦ç­¾åè¯·æ±‚ (CSR)ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-apiserver æ”¶åˆ° CSR è¯·æ±‚åï¼Œå¯¹å…¶ä¸­çš„ Token è¿›è¡Œè®¤è¯ï¼Œè®¤è¯é€šè¿‡åå°†è¯·æ±‚çš„ user è®¾ç½®ä¸º system:bootstrap:<token>ï¼Œgroup è®¾ç½®ä¸º system:bootstrappersï¼Œè¿™ä¸€è¿‡ç¨‹ç§°ä¸º Bootstrap Token Authã€‚</token></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ª user å’Œ group æ²¡æœ‰åˆ›å»º CSR çš„æƒé™ï¼Œkubelet å¯åŠ¨å¤±è´¥ï¼Œé”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.858672   20385 reflector.go:126] k8s.io/client-go/informers/factory.go:133: Failed to list *v1beta1.RuntimeClass: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.860429   20385 reflector.go:126] k8s.io/client-go/informers/factory.go:133: Failed to list *v1beta1.CSIDriver: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.903098   20385 kubelet.go:2244] node <span class="string">"172.21.16.240"</span> not found</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.985568   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/kubelet.go:442: Failed to list *v1.Service: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.986781   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: Failed to list *v1.Pod: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.987454   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/kubelet.go:451: Failed to list *v1.Node: Unauthorized</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•æ˜¯ï¼šåˆ›å»ºä¸€ä¸ª clusterrolebindingï¼Œå°† group system:bootstrappers å’Œ clusterrole system:node-bootstrapper ç»‘å®šï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span></span><br></pre></td></tr></table></figure><h4 id="2-5ã€å¯åŠ¨-kubelet-æœåŠ¡"><a href="#2-5ã€å¯åŠ¨-kubelet-æœåŠ¡" class="headerlink" title="2.5ã€å¯åŠ¨ kubelet æœåŠ¡"></a>2.5ã€å¯åŠ¨ kubelet æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kubelet</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet &amp;&amp; systemctl status kubelet</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æœåŠ¡å‰å¿…é¡»å…ˆåˆ›å»ºå·¥ä½œç›®å½•ï¼›</li><li>å…³é—­ swap åˆ†åŒºï¼Œå¦åˆ™ kubelet ä¼šå¯åŠ¨å¤±è´¥ï¼›</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨åä½¿ç”¨ â€“bootstrap-kubeconfig å‘ kube-apiserver å‘é€ CSR è¯·æ±‚ï¼Œå½“è¿™ä¸ª CSR è¢« approve åï¼Œkube-controller-manager ä¸º kubelet åˆ›å»º TLS å®¢æˆ·ç«¯è¯ä¹¦ã€ç§é’¥å’Œ â€“kubeletconfig æ–‡ä»¶ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>æ³¨æ„</strong>ï¼škube-controller-manager éœ€è¦é…ç½® â€“cluster-signing-cert-file å’Œ â€“cluster-signing-key-file å‚æ•°ï¼Œæ‰ä¼šä¸º TLS Bootstrap åˆ›å»ºè¯ä¹¦å’Œç§é’¥ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                 CONDITION</span><br><span class="line">csr-bwcbm   82s     system:bootstrap:016e9x   Pending</span><br><span class="line">csr-gqdhf   105s    system:bootstrap:64pk36   Pending</span><br><span class="line">csr-q995g   6m57s   system:bootstrap:4l4tcx   Pending</span><br><span class="line">csr-xx45v   7m33s   system:bootstrap:4l4tcx   Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure><h4 id="2-6ã€è‡ªåŠ¨-approve-CSR-è¯·æ±‚"><a href="#2-6ã€è‡ªåŠ¨-approve-CSR-è¯·æ±‚" class="headerlink" title="2.6ã€è‡ªåŠ¨ approve CSR è¯·æ±‚"></a>2.6ã€è‡ªåŠ¨ approve CSR è¯·æ±‚</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/csr-crb.yaml</span></span><br><span class="line"><span class="comment"># Approve all CSRs for the group "system:bootstrappers"</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: auto-approve-csrs-for-group</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:bootstrappers</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own credentials</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: node-client-cert-renewal</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:nodes</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="comment"># serving cert matching its client cert.</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: approve-node-server-renewal-csr</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  resources: [<span class="string">"certificatesigningrequests/selfnodeserver"</span>]</span><br><span class="line">  verbs: [<span class="string">"create"</span>]</span><br><span class="line">---</span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own server credentials</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: node-server-cert-renewal</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:nodes</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: approve-node-server-renewal-csr</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure><ul><li>auto-approve-csrs-for-groupï¼šè‡ªåŠ¨ approve node çš„ç¬¬ä¸€æ¬¡ CSRï¼› æ³¨æ„ç¬¬ä¸€æ¬¡ CSR æ—¶ï¼Œè¯·æ±‚çš„ Group ä¸º system:bootstrappersï¼›</li><li>node-client-cert-renewalï¼šè‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ client è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodes;</li><li>node-server-cert-renewalï¼šè‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ server è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodes;</li></ul><h4 id="2-6ã€ç­‰æŸ¥çœ‹-kubelet-çš„æƒ…å†µ"><a href="#2-6ã€ç­‰æŸ¥çœ‹-kubelet-çš„æƒ…å†µ" class="headerlink" title="2.6ã€ç­‰æŸ¥çœ‹ kubelet çš„æƒ…å†µ"></a>2.6ã€ç­‰æŸ¥çœ‹ kubelet çš„æƒ…å†µ</h4><p>å¾…ä¸€æ®µæ—¶é—´(1-10 åˆ†é’Ÿ)ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„ CSR éƒ½è¢«è‡ªåŠ¨ approvedï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                   CONDITION</span><br><span class="line">csr-2t4bj   2m58s   system:node:172.21.16.240   Pending</span><br><span class="line">csr-2z2mq   4m14s   system:node:172.21.16.204   Pending</span><br><span class="line">csr-bwcbm   6m6s    system:bootstrap:016e9x     Approved,Issued</span><br><span class="line">csr-gqdhf   6m29s   system:bootstrap:64pk36     Approved,Issued</span><br><span class="line">csr-q995g   11m     system:bootstrap:4l4tcx     Approved,Issued</span><br><span class="line">csr-xx45v   12m     system:bootstrap:4l4tcx     Pending</span><br></pre></td></tr></table></figure><ul><li>æ‰€æœ‰èŠ‚ç‚¹å‡ readyï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   4m17s   v1.14.6</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   3m2s    v1.14.6</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   3s      v1.14.6</span><br></pre></td></tr></table></figure></li></ul><p>kube-controller-manager ä¸ºå„ node ç”Ÿæˆäº† kubeconfig æ–‡ä»¶å’Œå…¬ç§é’¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -l /etc/kubernetes/kubelet.kubeconfig</span></span><br><span class="line">-rw------- 1 root root 2311 Sep 16 11:31 /etc/kubernetes/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls -l /etc/kubernetes/ssl/|grep kubelet</span></span><br><span class="line">-rw------- 1 root root 1281 Sep 16 11:43 kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:43 kubelet-client-current.pem -&gt; /etc/kubernetes/ssl/kubelet-client-2019-09-16-11-43-20.pem</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆ kubelet server è¯ä¹¦ï¼›</p><h4 id="2-8ã€æ‰‹åŠ¨-approve-server-cert-csr"><a href="#2-8ã€æ‰‹åŠ¨-approve-server-cert-csr" class="headerlink" title="2.8ã€æ‰‹åŠ¨ approve server cert csr"></a>2.8ã€æ‰‹åŠ¨ approve server cert csr</h4><p>åŸºäº<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#kubelet-configuratio" target="_blank" rel="noopener">å®‰å…¨æ€§è€ƒè™‘</a>ï¼ŒCSR approving controllers ä¸ä¼šè‡ªåŠ¨ approve kubelet server è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œéœ€è¦æ‰‹åŠ¨ approveï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                   CONDITION</span><br><span class="line">csr-2t4bj   3m5s    system:node:172.21.16.240   Pending</span><br><span class="line">csr-2z2mq   4m21s   system:node:172.21.16.204   Pending</span><br><span class="line">csr-bwcbm   6m13s   system:bootstrap:016e9x     Approved,Issued</span><br><span class="line">csr-gqdhf   6m36s   system:bootstrap:64pk36     Approved,Issued</span><br><span class="line">csr-gtkrt   7s      system:node:172.21.16.87    Pending</span><br><span class="line">csr-q995g   11m     system:bootstrap:4l4tcx     Approved,Issued</span><br><span class="line">csr-xx45v   12m     system:bootstrap:4l4tcx     Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-2t4bj</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-2t4bj approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-2z2mq </span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-2z2mq approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-gtkrt</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-gtkrt approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls -l /etc/kubernetes/ssl/|grep kubelet</span></span><br><span class="line">-rw------- 1 root root 1281 Sep 16 11:43 kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:43 kubelet-client-current.pem -&gt; /etc/kubernetes/ssl/kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">-rw------- 1 root root 1305 Sep 16 11:44 kubelet-server-2019-09-16-11-44-12.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:44 kubelet-server-current.pem -&gt; /etc/kubernetes/ssl/kubelet-server-2019-09-16-11-44-12.pem</span><br></pre></td></tr></table></figure><h4 id="2-9ã€kubelet-æä¾›çš„-API-æ¥å£"><a href="#2-9ã€kubelet-æä¾›çš„-API-æ¥å£" class="headerlink" title="2.9ã€kubelet æä¾›çš„ API æ¥å£"></a>2.9ã€kubelet æä¾›çš„ API æ¥å£</h4><p>kubelet å¯åŠ¨åç›‘å¬å¤šä¸ªç«¯å£ï¼Œç”¨äºæ¥æ”¶ kube-apiserver æˆ–å…¶å®ƒå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kubelet</span></span><br><span class="line">tcp        0      0 127.0.0.1:43042         0.0.0.0:*               LISTEN      22726/kubelet       </span><br><span class="line">tcp        0      0 172.21.16.87:10248      0.0.0.0:*               LISTEN      22726/kubelet       </span><br><span class="line">tcp6       0      0 :::10250                :::*                    LISTEN      22726/kubelet</span><br></pre></td></tr></table></figure><ul><li>10248: healthz http æœåŠ¡ï¼›</li><li>10250: https æœåŠ¡ï¼Œè®¿é—®è¯¥ç«¯å£æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼ˆå³ä½¿è®¿é—® /healthz ä¹Ÿéœ€è¦ï¼‰ï¼›</li><li>æœªå¼€å¯åªè¯»ç«¯å£ 10255ï¼›</li><li>ä» K8S v1.10 å¼€å§‹ï¼Œå»é™¤äº† â€“cadvisor-port å‚æ•°ï¼ˆé»˜è®¤ 4194 ç«¯å£ï¼‰ï¼Œä¸æ”¯æŒè®¿é—® cAdvisor UI &amp; APIã€‚</li></ul><p>ç”±äºå…³é—­äº†åŒ¿åè®¤è¯ï¼ŒåŒæ—¶å¼€å¯äº† webhook æˆæƒï¼Œæ‰€æœ‰è®¿é—® 10250 ç«¯å£ https API çš„è¯·æ±‚éƒ½éœ€è¦è¢«è®¤è¯å’Œæˆæƒã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¢„å®šä¹‰çš„ ClusterRole system:kubelet-api-admin æˆäºˆè®¿é—® kubelet æ‰€æœ‰ API çš„æƒé™(kube-apiserver ä½¿ç”¨çš„ kubernetes è¯ä¹¦ User æˆäºˆäº†è¯¥æƒé™)ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kubelet-api-admin</span></span><br><span class="line">Name:         system:kubelet-api-admin</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources      Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------      -----------------  --------------  -----</span><br><span class="line">  nodes/<span class="built_in">log</span>      []                 []              [*]</span><br><span class="line">  nodes/metrics  []                 []              [*]</span><br><span class="line">  nodes/proxy    []                 []              [*]</span><br><span class="line">  nodes/spec     []                 []              [*]</span><br><span class="line">  nodes/stats    []                 []              [*]</span><br><span class="line">  nodes          []                 []              [get list watch proxy]</span><br></pre></td></tr></table></figure><h4 id="2-10ã€kubelet-api-è®¤è¯å’Œæˆæƒ"><a href="#2-10ã€kubelet-api-è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.10ã€kubelet api è®¤è¯å’Œæˆæƒ"></a>2.10ã€kubelet api è®¤è¯å’Œæˆæƒ</h4><p>kubelet é…ç½®äº†å¦‚ä¸‹è®¤è¯å‚æ•°:</p><ul><li>authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åè®¿é—® 10250 ç«¯å£ï¼›</li><li>authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTPs è¯ä¹¦è®¤è¯ï¼›</li><li>authentication.webhook.enabled=trueï¼šå¼€å¯ HTTPs bearer token è®¤è¯ï¼›</li></ul><p>åŒæ—¶é…ç½®äº†å¦‚ä¸‹æˆæƒå‚æ•°:</p><ul><li>authroization.mode=Webhookï¼šå¼€å¯ RBAC æˆæƒ</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ clientCAFile å¯¹è¯ä¹¦ç­¾åè¿›è¡Œè®¤è¯ï¼Œæˆ–è€…æŸ¥è¯¢ bearer token æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœä¸¤è€…éƒ½æ²¡é€šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚ï¼Œæç¤º Unauthorizedï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line">Unauthorized</span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem -H "Authorization: Bearer 123456"  https://172.21.16.87:10250/metrics</span></span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡è®¤è¯åï¼Œkubelet ä½¿ç”¨ SubjectAccessReview API å‘ kube-apiserver å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢è¯ä¹¦æˆ– token å¯¹åº”çš„ userã€group æ˜¯å¦æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</p><h4 id="2-11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ"><a href="#2-11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ"></a>2.11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æƒé™ä¸è¶³çš„è¯ä¹¦ï¼›</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/kube-controller-manager.pem --key /etc/kubernetes/ssl/kube-controller-manager-key.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line">Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼›</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><ul><li>â€“cacertã€â€“certã€â€“key çš„å‚æ•°å€¼å¿…é¡»æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ä¸Šé¢çš„ ./admin.pem ä¸èƒ½çœç•¥ ./ï¼Œå¦åˆ™è¿”å› 401 Unauthorizedï¼›</li></ul><h4 id="2-12ã€bear-token-è®¤è¯å’Œæˆæƒ"><a href="#2-12ã€bear-token-è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.12ã€bear token è®¤è¯å’Œæˆæƒ"></a>2.12ã€bear token è®¤è¯å’Œæˆæƒ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ª ServiceAccountï¼Œå°†å®ƒå’Œ ClusterRole system:kubelet-api-admin ç»‘å®šï¼Œä»è€Œå…·æœ‰è°ƒç”¨ kubelet API çš„æƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create sa kubelet-api-test</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding kubelet-api-test --clusterrole=system:kubelet-api-admin --serviceaccount=default:kubelet-api-test</span></span><br><span class="line"><span class="comment"># SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># TOKEN=$(kubectl describe secret $&#123;SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;TOKEN&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem -H "Authorization: Bearer $&#123;TOKEN&#125;" https://172.21.16.87:10250/metrics|head</span></span><br></pre></td></tr></table></figure><h3 id="3ã€cadvisor-å’Œ-metrics"><a href="#3ã€cadvisor-å’Œ-metrics" class="headerlink" title="3ã€cadvisor å’Œ metrics"></a>3ã€cadvisor å’Œ metrics</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cadvisor æ˜¯å†…åµŒåœ¨ kubelet äºŒè¿›åˆ¶ä¸­çš„ï¼Œç»Ÿè®¡æ‰€åœ¨èŠ‚ç‚¹å„å®¹å™¨çš„èµ„æº(CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘å¡)ä½¿ç”¨æƒ…å†µçš„æœåŠ¡ã€‚<br>æµè§ˆå™¨è®¿é—® <a href="https://172.21.16.87:10250/metrics" target="_blank" rel="noopener">https://172.21.16.87:10250/metrics</a> å’Œ <a href="https://172.21.16.87:10250/metrics/cadvisor" target="_blank" rel="noopener">https://172.21.16.87:10250/metrics/cadvisor</a> åˆ†åˆ«è¿”å› kubelet å’Œ cadvisor çš„ metricsã€‚<br><img src="https://img.xxlaila.cn/1568624798589.jpg" alt="img"></p><p><strong>æ³¨æ„:</strong></p><ul><li>kubelet.config.json è®¾ç½® authentication.anonymous.enabled ä¸º falseï¼Œä¸å…è®¸åŒ¿åè¯ä¹¦è®¿é—® 10250 çš„ https æœåŠ¡ï¼›</li><li>å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/kubeletæä¾›apiè¯·æ±‚æ¥å£/" target="_blank" rel="noopener">kubeletæä¾›apiè¯·æ±‚æ¥å£</a>ï¼Œåˆ›å»ºå’Œå¯¼å…¥ç›¸å…³è¯ä¹¦ï¼Œç„¶åè®¿é—®ä¸Šé¢çš„ 10250 ç«¯å£ï¼›</li></ul><h4 id="3-1ã€è·å–-kubelet-çš„é…ç½®"><a href="#3-1ã€è·å–-kubelet-çš„é…ç½®" class="headerlink" title="3.1ã€è·å– kubelet çš„é…ç½®"></a>3.1ã€è·å– kubelet çš„é…ç½®</h4><p>ä» kube-apiserver è·å–å„èŠ‚ç‚¹ kubelet çš„é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼›</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -sSL --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem $&#123;KUBE_APISERVER&#125;/api/v1/nodes/172.21.16.87/proxy/configz | jq  '.kubeletconfig|.kind="KubeletConfiguration"|.apiVersion="kubelet.config.k8s.io/v1beta1"'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"syncFrequency"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"fileCheckFrequency"</span>: <span class="string">"20s"</span>,</span><br><span class="line">  <span class="string">"httpCheckFrequency"</span>: <span class="string">"20s"</span>,</span><br><span class="line">  <span class="string">"address"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">  <span class="string">"port"</span>: 10250,</span><br><span class="line">  <span class="string">"rotateCertificates"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"serverTLSBootstrap"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"authentication"</span>: &#123;</span><br><span class="line">    <span class="string">"x509"</span>: &#123;</span><br><span class="line">      <span class="string">"clientCAFile"</span>: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"cacheTTL"</span>: <span class="string">"2m0s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"anonymous"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"authorization"</span>: &#123;</span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"Webhook"</span>,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"cacheAuthorizedTTL"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">      <span class="string">"cacheUnauthorizedTTL"</span>: <span class="string">"30s"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"registryPullQPS"</span>: 0,</span><br><span class="line">  <span class="string">"registryBurst"</span>: 20,</span><br><span class="line">  <span class="string">"eventRecordQPS"</span>: 0,</span><br><span class="line">  <span class="string">"eventBurst"</span>: 20,</span><br><span class="line">  <span class="string">"enableDebuggingHandlers"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"enableContentionProfiling"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"healthzPort"</span>: 10248,</span><br><span class="line">  <span class="string">"healthzBindAddress"</span>: <span class="string">"172.21.16.87"</span>,</span><br><span class="line">  <span class="string">"oomScoreAdj"</span>: -999,</span><br><span class="line">  <span class="string">"clusterDomain"</span>: <span class="string">"cluster.local"</span>,</span><br><span class="line">  <span class="string">"clusterDNS"</span>: [</span><br><span class="line">    <span class="string">"10.254.0.2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"streamingConnectionIdleTimeout"</span>: <span class="string">"4h0m0s"</span>,</span><br><span class="line">  <span class="string">"nodeStatusUpdateFrequency"</span>: <span class="string">"10s"</span>,</span><br><span class="line">  <span class="string">"nodeStatusReportFrequency"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"nodeLeaseDurationSeconds"</span>: 40,</span><br><span class="line">  <span class="string">"imageMinimumGCAge"</span>: <span class="string">"2m0s"</span>,</span><br><span class="line">  <span class="string">"imageGCHighThresholdPercent"</span>: 85,</span><br><span class="line">  <span class="string">"imageGCLowThresholdPercent"</span>: 80,</span><br><span class="line">  <span class="string">"volumeStatsAggPeriod"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"cgroupsPerQOS"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"cgroupDriver"</span>: <span class="string">"cgroupfs"</span>,</span><br><span class="line">  <span class="string">"cpuManagerPolicy"</span>: <span class="string">"none"</span>,</span><br><span class="line">  <span class="string">"cpuManagerReconcilePeriod"</span>: <span class="string">"10s"</span>,</span><br><span class="line">  <span class="string">"runtimeRequestTimeout"</span>: <span class="string">"10m0s"</span>,</span><br><span class="line">  <span class="string">"hairpinMode"</span>: <span class="string">"promiscuous-bridge"</span>,</span><br><span class="line">  <span class="string">"maxPods"</span>: 100,</span><br><span class="line">  <span class="string">"podCIDR"</span>: <span class="string">"172.30.0.0/16"</span>,</span><br><span class="line">  <span class="string">"podPidsLimit"</span>: -1,</span><br><span class="line">  <span class="string">"resolvConf"</span>: <span class="string">"/etc/resolv.conf"</span>,</span><br><span class="line">  <span class="string">"cpuCFSQuota"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"cpuCFSQuotaPeriod"</span>: <span class="string">"100ms"</span>,</span><br><span class="line">  <span class="string">"maxOpenFiles"</span>: 1000000,</span><br><span class="line">  <span class="string">"contentType"</span>: <span class="string">"application/vnd.kubernetes.protobuf"</span>,</span><br><span class="line">  <span class="string">"kubeAPIQPS"</span>: 1000,</span><br><span class="line">  <span class="string">"kubeAPIBurst"</span>: 2000,</span><br><span class="line">  <span class="string">"serializeImagePulls"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"evictionHard"</span>: &#123;</span><br><span class="line">    <span class="string">"memory.available"</span>: <span class="string">"100Mi"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"evictionPressureTransitionPeriod"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">  <span class="string">"enableControllerAttachDetach"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"makeIPTablesUtilChains"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"iptablesMasqueradeBit"</span>: 14,</span><br><span class="line">  <span class="string">"iptablesDropBit"</span>: 15,</span><br><span class="line">  <span class="string">"failSwapOn"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"containerLogMaxSize"</span>: <span class="string">"20Mi"</span>,</span><br><span class="line">  <span class="string">"containerLogMaxFiles"</span>: 10,</span><br><span class="line">  <span class="string">"configMapAndSecretChangeDetectionStrategy"</span>: <span class="string">"Watch"</span>,</span><br><span class="line">  <span class="string">"enforceNodeAllocatable"</span>: [</span><br><span class="line">    <span class="string">"pods"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"KubeletConfiguration"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"kubelet.config.k8s.io/v1beta1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4ã€éƒ¨ç½²-kube-proxy-ç»„ä»¶"><a href="#4ã€éƒ¨ç½²-kube-proxy-ç»„ä»¶" class="headerlink" title="4ã€éƒ¨ç½² kube-proxy ç»„ä»¶"></a>4ã€éƒ¨ç½² kube-proxy ç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-proxy è¿è¡Œåœ¨æ‰€æœ‰ worker èŠ‚ç‚¹ä¸Šï¼Œå®ƒç›‘å¬ apiserver ä¸­ service å’Œ endpoint çš„å˜åŒ–æƒ…å†µï¼Œåˆ›å»ºè·¯ç”±è§„åˆ™ä»¥æä¾›æœåŠ¡ IP å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p><h4 id="4-1ã€åˆ›å»º-kube-proxy-è¯ä¹¦"><a href="#4-1ã€åˆ›å»º-kube-proxy-è¯ä¹¦" class="headerlink" title="4.1ã€åˆ›å»º kube-proxy è¯ä¹¦"></a>4.1ã€åˆ›å»º kube-proxy è¯ä¹¦</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><p>CNï¼šæŒ‡å®šè¯¥è¯ä¹¦çš„ User ä¸º system:kube-proxyï¼›</p></li><li><p>é¢„å®šä¹‰çš„ RoleBinding system:node-proxier å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼›</p></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kube-proxy å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ls kube-proxy*.pem</span></span><br><span class="line">kube-proxy-key.pem  kube-proxy.pem</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#4-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="4.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>4.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials kube-proxy \</span></span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br></pre></td></tr></table></figure><ul><li>â€“embed-certs=trueï¼šå°† ca.pem å’Œ admin.pem è¯ä¹¦å†…å®¹åµŒå…¥åˆ°ç”Ÿæˆçš„ kubectl-proxy.kubeconfig æ–‡ä»¶ä¸­(ä¸åŠ æ—¶ï¼Œå†™å…¥çš„æ˜¯è¯ä¹¦æ–‡ä»¶è·¯å¾„)</li></ul><h4 id="4-3ã€åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶"><a href="#4-3ã€åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶" class="headerlink" title="4.3ã€åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶"></a>4.3ã€åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kube-proxy-config.yaml</span></span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-proxy.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">healthzBindAddress: 172.21.16.87:10256 <span class="comment">#node</span></span><br><span class="line">metricsBindAddress: 172.21.16.87:10249 <span class="comment">#node</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">clusterCIDR: 172.30.0.0/16</span><br><span class="line">hostnameOverride: 172.21.16.87 <span class="comment">#node </span></span><br><span class="line">mode: <span class="string">"ipvs"</span></span><br><span class="line">portRange: <span class="string">""</span></span><br><span class="line">kubeProxyIPTablesConfiguration:</span><br><span class="line">  masqueradeAll: <span class="literal">false</span></span><br><span class="line">kubeProxyIPVSConfiguration:</span><br><span class="line">  scheduler: rr</span><br><span class="line">  excludeCIDRs: []</span><br></pre></td></tr></table></figure><ul><li>bindAddress: ç›‘å¬åœ°å€ï¼›</li><li>clientConnection.kubeconfig: è¿æ¥ apiserver çš„ kubeconfig æ–‡ä»¶ï¼›</li><li>clusterCIDR: kube-proxy æ ¹æ® â€“cluster-cidr åˆ¤æ–­é›†ç¾¤å†…éƒ¨å’Œå¤–éƒ¨æµé‡ï¼ŒæŒ‡å®š â€“cluster-cidr æˆ– â€“masquerade-all é€‰é¡¹å kube-proxy æ‰ä¼šå¯¹è®¿é—® Service IP çš„è¯·æ±‚åš SNATï¼›</li><li>hostnameOverride: å‚æ•°å€¼å¿…é¡»ä¸ kubelet çš„å€¼ä¸€è‡´ï¼Œå¦åˆ™ kube-proxy å¯åŠ¨åä¼šæ‰¾ä¸åˆ°è¯¥ Nodeï¼Œä»è€Œä¸ä¼šåˆ›å»ºä»»ä½• ipvs è§„åˆ™ï¼›</li><li>mode: ä½¿ç”¨ ipvs æ¨¡å¼ï¼›</li></ul><h4 id="4-4ã€åˆ›å»ºkube-proxy-systemd-unit-æ–‡ä»¶"><a href="#4-4ã€åˆ›å»ºkube-proxy-systemd-unit-æ–‡ä»¶" class="headerlink" title="4.4ã€åˆ›å»ºkube-proxy systemd unit æ–‡ä»¶"></a>4.4ã€åˆ›å»ºkube-proxy systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-proxy.service </span></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-proxy</span><br><span class="line">ExecStart=/usr/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy-config.yaml \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="4-5ã€å¯åŠ¨-kube-proxy-æœåŠ¡"><a href="#4-5ã€å¯åŠ¨-kube-proxy-æœåŠ¡" class="headerlink" title="4.5ã€å¯åŠ¨ kube-proxy æœåŠ¡"></a>4.5ã€å¯åŠ¨ kube-proxy æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy &amp;&amp; systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure><h4 id="4-5ã€æ£€æŸ¥"><a href="#4-5ã€æ£€æŸ¥" class="headerlink" title="4.5ã€æ£€æŸ¥"></a>4.5ã€æ£€æŸ¥</h4><ul><li><p>æŸ¥çœ‹ç›‘å¬ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kube-prox</span></span><br><span class="line">tcp        0      0 172.21.16.87:10256      0.0.0.0:*               LISTEN      27423/kube-proxy    </span><br><span class="line">tcp        0      0 172.21.16.87:10249      0.0.0.0:*               LISTEN      27423/kube-proxy</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ ipvs è·¯ç”±è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ipvsadm -ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.254.0.1:443 rr</span><br><span class="line">  -&gt; 172.21.17.30:6443            Masq    1      0          0         </span><br><span class="line">  -&gt; 172.21.17.31:6443            Masq    1      0          0 </span><br><span class="line">  -&gt; 172.21.16.110:6443           Masq    1      0          0</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14 nodeå®‰è£…</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-v1.14å®‰è£…</title>
    <url>/2019/09/11/kubernetes-v1-14%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="1ã€ç¯å¢ƒå‡†å¤‡"><a href="#1ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ç¯å¢ƒå‡†å¤‡"></a>1ã€ç¯å¢ƒå‡†å¤‡</h3><table><thead><tr><th>ip</th><th>type</th><th>docker</th><th>os</th><th>k8s version</th></tr></thead><tbody><tr><td>172.21.17.30</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td>v1.14.6</td></tr><tr><td>172.21.17.31</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.110</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.87</td><td>node,flanneld</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.240</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.204</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.45</td><td>vip</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr></tbody></table><h3 id="2ã€åˆå§‹åŒ–ç³»ç»Ÿ"><a href="#2ã€åˆå§‹åŒ–ç³»ç»Ÿ" class="headerlink" title="2ã€åˆå§‹åŒ–ç³»ç»Ÿ"></a>2ã€åˆå§‹åŒ–ç³»ç»Ÿ</h3><h4 id="2-1ã€å®‰è£…ä¾èµ–åŒ…"><a href="#2-1ã€å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="2.1ã€å®‰è£…ä¾èµ–åŒ…"></a>2.1ã€å®‰è£…ä¾èµ–åŒ…</h4><a id="more"></a><p>æ¯å°æœåŠ¡å™¨å‡æ“ä½œ,å…³é—­é˜²ç«å¢™,å…³é—­selinux</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y epel-release</span></span><br><span class="line"><span class="comment"># yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget</span></span><br></pre></td></tr></table></figure><h4 id="2-2ã€å…³é—­-swap-åˆ†åŒº"><a href="#2-2ã€å…³é—­-swap-åˆ†åŒº" class="headerlink" title="2.2ã€å…³é—­ swap åˆ†åŒº"></a>2.2ã€å…³é—­ swap åˆ†åŒº</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœå¼€å¯äº† swap åˆ†åŒºï¼Œkubelet ä¼šå¯åŠ¨å¤±è´¥(å¯ä»¥é€šè¿‡å°†å‚æ•° â€“fail-swap-on è®¾ç½®ä¸º false æ¥å¿½ç•¥ swap on)ï¼Œæ•…éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šå…³é—­ swap åˆ†åŒºã€‚åŒæ—¶æ³¨é‡Š /etc/fstab ä¸­ç›¸åº”çš„æ¡ç›®ï¼Œé˜²æ­¢å¼€æœºè‡ªåŠ¨æŒ‚è½½ swap åˆ†åŒºã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># swapoff -a</span></span><br><span class="line"><span class="comment"># sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab</span></span><br></pre></td></tr></table></figure><h4 id="2-3ã€åŠ è½½å†…æ ¸æ¨¡å—"><a href="#2-3ã€åŠ è½½å†…æ ¸æ¨¡å—" class="headerlink" title="2.3ã€åŠ è½½å†…æ ¸æ¨¡å—"></a>2.3ã€åŠ è½½å†…æ ¸æ¨¡å—</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># modprobe ip_vs_rr</span></span><br><span class="line"><span class="comment"># modprobe br_netfilter</span></span><br></pre></td></tr></table></figure><h5 id="2-3-1-åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨"><a href="#2-3-1-åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨" class="headerlink" title="2.3.1 åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨"></a>2.3.1 åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; /etc/rc.local  &lt;&lt; EOF</span></span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h5 id="2-3-2-ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—"><a href="#2-3-2-ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—" class="headerlink" title="2.3.2 ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—"></a>2.3.2 ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; /etc/modules-load.d/ipvs.conf &lt;&lt; EOF</span></span><br><span class="line"> ip_vs_rr</span><br><span class="line"> br_netfilter</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># systemctl enable --now systemd-modules-load.service</span></span><br></pre></td></tr></table></figure><h5 id="2-3-3-éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ"><a href="#2-3-3-éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ" class="headerlink" title="2.3.3 éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ"></a>2.3.3 éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># lsmod |egrep " ip_vs_rr|br_netfilter"</span></span><br><span class="line">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨IPVS,ä»k8sçš„1.8ç‰ˆæœ¬å¼€å§‹ï¼Œkube-proxyå¼•å…¥äº†IPVSæ¨¡å¼ï¼ŒIPVSæ¨¡å¼ä¸iptablesåŒæ ·åŸºäºNetfilterï¼Œä½†æ˜¯é‡‡ç”¨çš„<span class="built_in">hash</span>è¡¨ï¼Œå› æ­¤å½“serviceæ•°é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼Œ<span class="built_in">hash</span>æŸ¥è¡¨çš„é€Ÿåº¦ä¼˜åŠ¿å°±ä¼šæ˜¾ç°å‡ºæ¥ï¼Œä»è€Œæé«˜serviceçš„æœåŠ¡æ€§èƒ½ã€‚</span><br></pre></td></tr></table></figure><h4 id="2-4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°"><a href="#2-4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°" class="headerlink" title="2.4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°"></a>2.4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/sysctl.d/kubernetes.conf </span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line"><span class="comment"># sysctl -p /etc/sysctl.d/kubernetes.conf</span></span><br></pre></td></tr></table></figure><ul><li>å¿…é¡»å…³é—­ tcp_tw_recycleï¼Œå¦åˆ™å’Œ NAT å†²çªï¼Œä¼šå¯¼è‡´æœåŠ¡ä¸é€šï¼›</li><li>å…³é—­ IPV6ï¼Œé˜²æ­¢è§¦å‘ docker BUGï¼›</li></ul><h4 id="2-5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº"><a href="#2-5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº" class="headerlink" title="2.5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº"></a>2.5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># timedatectl set-timezone Asia/Shanghai</span></span><br><span class="line"><span class="comment"># timedatectl set-local-rtc 0</span></span><br><span class="line"><span class="comment"># systemctl restart rsyslog </span></span><br><span class="line"><span class="comment"># systemctl restart crond</span></span><br></pre></td></tr></table></figure><h4 id="2-6ã€å…³é—­æ— å…³çš„æœåŠ¡"><a href="#2-6ã€å…³é—­æ— å…³çš„æœåŠ¡" class="headerlink" title="2.6ã€å…³é—­æ— å…³çš„æœåŠ¡"></a>2.6ã€å…³é—­æ— å…³çš„æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl stop postfix &amp;&amp; systemctl disable postfix</span></span><br></pre></td></tr></table></figure><h3 id="3ã€å‡çº§å†…æ ¸"><a href="#3ã€å‡çº§å†…æ ¸" class="headerlink" title="3ã€å‡çº§å†…æ ¸"></a>3ã€å‡çº§å†…æ ¸</h3><p>ä»¥ä¸‹åœ¨masterèŠ‚ç‚¹æ“ä½œ<br>CentOS 7.x ç³»ç»Ÿè‡ªå¸¦çš„ 3.10.x å†…æ ¸å­˜åœ¨ä¸€äº› Bugsï¼Œå¯¼è‡´è¿è¡Œçš„ Dockerã€Kubernetes ä¸ç¨³å®šï¼Œä¾‹å¦‚:</p><ul><li>1.é«˜ç‰ˆæœ¬çš„ docker(1.13 ä»¥å) å¯ç”¨äº† 3.10 kernel å®éªŒæ”¯æŒçš„ kernel memory account åŠŸèƒ½(æ— æ³•å…³é—­)ï¼Œå½“èŠ‚ç‚¹å‹åŠ›å¤§å¦‚é¢‘ç¹å¯åŠ¨å’Œåœæ­¢å®¹å™¨æ—¶ä¼šå¯¼è‡´ cgroup memory leakï¼›</li><li>2.ç½‘ç»œè®¾å¤‡å¼•ç”¨è®¡æ•°æ³„æ¼ï¼Œä¼šå¯¼è‡´ç±»ä¼¼äºæŠ¥é”™ï¼šâ€kernel:unregister_netdevice: waiting for eth0 to become free. Usage count = 1â€;<br>è§£å†³æ–¹æ¡ˆå¦‚ä¸‹:</li><li>1.å‡çº§å†…æ ¸åˆ° 4.4.X ä»¥ä¸Š</li><li>2.æˆ–è€…ï¼Œæ‰‹åŠ¨ç¼–è¯‘å†…æ ¸ï¼Œdisable CONFIG_MEMCG_KMEM ç‰¹æ€§</li><li>æˆ–è€…ï¼Œå®‰è£…ä¿®å¤äº†è¯¥é—®é¢˜çš„ Docker 18.09.1 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚ä½†ç”±äº kubelet ä¹Ÿä¼šè®¾ç½® kmemï¼ˆå®ƒ vendor äº† runcï¼‰ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç¼–è¯‘ kubelet å¹¶æŒ‡å®š GOFLAGS=â€-tags=nokmemâ€</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --branch v1.14.1 --single-branch --depth 1 https://github.com/kubernetes/kubernetes</span><br><span class="line"><span class="built_in">cd</span> kubernetes</span><br><span class="line">KUBE_GIT_VERSION=v1.14.1 ./build/run.sh make kubelet GOFLAGS=<span class="string">"-tags=nokmem"</span></span><br></pre></td></tr></table></figure><h4 id="3-1ã€å†…æ ¸å‡çº§æ–¹æ³•"><a href="#3-1ã€å†…æ ¸å‡çº§æ–¹æ³•" class="headerlink" title="3.1ã€å†…æ ¸å‡çº§æ–¹æ³•"></a>3.1ã€å†…æ ¸å‡çº§æ–¹æ³•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span></span><br><span class="line"><span class="comment"># å®‰è£…å®Œæˆåæ£€æŸ¥ /boot/grub2/grub.cfg ä¸­å¯¹åº”å†…æ ¸ menuentry ä¸­æ˜¯å¦åŒ…å« initrd16 é…ç½®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å®‰è£…ä¸€æ¬¡ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yum --enablerepo=elrepo-kernel install -y kernel-lt</span></span><br><span class="line"><span class="comment"># è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨</span></span><br><span class="line"><span class="comment"># grub2-set-default 0</span></span><br></pre></td></tr></table></figure><h4 id="3-2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶"><a href="#3-2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶" class="headerlink" title="3.2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶"></a>3.2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum --enablerepo=elrepo-kernel install kernel-lt-devel-$(uname -r) kernel-lt-headers-$(uname -r)</span></span><br></pre></td></tr></table></figure><h4 id="3-3ã€å…³é—­-NUMA"><a href="#3-3ã€å…³é—­-NUMA" class="headerlink" title="3.3ã€å…³é—­ NUMA"></a>3.3ã€å…³é—­ NUMA</h4><p>åœ¨å…¶ä¸­ä¸€å°masterèŠ‚ç‚¹æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /etc/default/grub&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># åœ¨ GRUB_CMDLINE_LINUX ä¸€è¡Œæ·»åŠ  `numa=off` å‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤º</span></span><br><span class="line"><span class="comment"># cat /etc/default/grub</span></span><br><span class="line">GRUB_TIMEOUT=1</span><br><span class="line">GRUB_DISTRIBUTOR=<span class="string">"<span class="variable">$(sed 's, release .*$,,g' /etc/system-release)</span>"</span></span><br><span class="line">GRUB_DEFAULT=saved</span><br><span class="line">GRUB_DISABLE_SUBMENU=<span class="literal">true</span></span><br><span class="line">GRUB_TERMINAL=<span class="string">"serial console"</span></span><br><span class="line">GRUB_SERIAL_COMMAND=<span class="string">"serial --speed=115200"</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">"console=tty0 crashkernel=auto console=ttyS0,115200"</span></span><br><span class="line">numa=off</span><br><span class="line">GRUB_DISABLE_RECOVERY=<span class="string">"true"</span></span><br></pre></td></tr></table></figure><ul><li>é‡æ–°ç”Ÿæˆ grub2 é…ç½®æ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /boot/grub2/grub.cfg&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥"><a href="#4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥" class="headerlink" title="4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥"></a>4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºç¡®ä¿å®‰å…¨ï¼Œkubernetes ç³»ç»Ÿå„ç»„ä»¶éœ€è¦ä½¿ç”¨ x509 è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚CA (Certificate Authority) æ˜¯è‡ªç­¾åçš„æ ¹è¯ä¹¦ï¼Œç”¨æ¥ç­¾ååç»­åˆ›å»ºçš„å…¶å®ƒè¯ä¹¦ã€‚ä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl åˆ›å»ºæ‰€æœ‰è¯ä¹¦ï¼Œè¯ä¹¦å‡åœ¨ä¸€å°masterèŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œç„¶åé€šè¿‡è¿œç¨‹åˆ†å‘åˆ°å…¶ä»–çš„æœåŠ¡å™¨ä¸Šå»ã€‚</p><ul><li><strong>æ³¨æ„</strong>: æ¯ç”Ÿæˆçš„è¯ä¹¦å‡è¦è¿›è¡Œåˆ†å‘åˆ°å…¶ä»–çš„masterèŠ‚ç‚¹</li></ul><h4 id="4-1ã€å®‰è£…-cfssl-å·¥å…·é›†"><a href="#4-1ã€å®‰è£…-cfssl-å·¥å…·é›†" class="headerlink" title="4.1ã€å®‰è£… cfssl å·¥å…·é›†"></a>4.1ã€å®‰è£… cfssl å·¥å…·é›†</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -o cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="comment"># chmod +x * &amp;&amp;mv cfssl* /usr/bin/</span></span><br><span class="line"><span class="comment"># scp /usr/bin/cfssl* &#123;master-ip&#125;:/usr/bin</span></span><br></pre></td></tr></table></figure><h4 id="4-2ã€åˆ›å»ºæ ¹è¯ä¹¦-CA"><a href="#4-2ã€åˆ›å»ºæ ¹è¯ä¹¦-CA" class="headerlink" title="4.2ã€åˆ›å»ºæ ¹è¯ä¹¦ (CA)"></a>4.2ã€åˆ›å»ºæ ¹è¯ä¹¦ (CA)</h4><p>CA è¯ä¹¦æ˜¯é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹å…±äº«çš„ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ª CA è¯ä¹¦ï¼Œåç»­åˆ›å»ºçš„æ‰€æœ‰è¯ä¹¦éƒ½ç”±å®ƒç­¾åã€‚</p><h4 id="4-3ã€åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#4-3ã€åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="4.3ã€åˆ›å»ºé…ç½®æ–‡ä»¶"></a>4.3ã€åˆ›å»ºé…ç½®æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CA é…ç½®æ–‡ä»¶ç”¨äºé…ç½®æ ¹è¯ä¹¦çš„ä½¿ç”¨åœºæ™¯ (profile) å’Œå…·ä½“å‚æ•° (usageï¼Œè¿‡æœŸæ—¶é—´ã€æœåŠ¡ç«¯è®¤è¯ã€å®¢æˆ·ç«¯è®¤è¯ã€åŠ å¯†ç­‰)ï¼Œåç»­åœ¨ç­¾åå…¶å®ƒè¯ä¹¦æ—¶éœ€è¦æŒ‡å®šç‰¹å®šåœºæ™¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir k8s &amp;&amp; cd k8s#åé¢k8sç”Ÿæˆæ‰€éœ€è¦çš„è¯ä¹¦å‡åœ¨è¯¥ç›®å½•æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><ul><li><p>ca-config.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼Œç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼›</p></li><li><p>server authï¼šè¡¨ç¤º client å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ server æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p></li><li><p>client authï¼šè¡¨ç¤º server å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ client æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p></li></ul><h4 id="4-4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"><a href="#4-4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶" class="headerlink" title="4.4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"></a>4.4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</h4><ul><li><p>ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"ca"</span>: &#123;</span><br><span class="line">    <span class="string">"expiry"</span>: <span class="string">"876000h"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>CNï¼šCommon Nameï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼›</p></li><li><p>Oï¼šOrganizationï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼›</p></li><li><p>kube-apiserver å°†æå–çš„ Userã€Group ä½œä¸º RBAC æˆæƒçš„ç”¨æˆ·æ ‡è¯†ï¼›</p></li><li><p>ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span></span><br><span class="line"><span class="comment"># ls ca*</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/kubernetes/ssl &amp;&amp; cp ca*.pem ca-config.json /etc/kubernetes/ssl</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="5-éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·"><a href="#5-éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="5.éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·"></a>5.éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubectl é»˜è®¤ä» ~/.kube/config æ–‡ä»¶è¯»å– kube-apiserver åœ°å€å’Œè®¤è¯ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ‰§è¡Œ kubectl å‘½ä»¤æ—¶å¯èƒ½ä¼šå‡ºé”™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>:</li></ul><ul><li>1.å¦‚æœæ²¡æœ‰ç‰¹æ®ŠæŒ‡æ˜ï¼Œæœ¬æ–‡æ¡£çš„æ‰€æœ‰æ“ä½œå‡åœ¨ zhangjun-k8s01 èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œç„¶åè¿œç¨‹åˆ†å‘æ–‡ä»¶å’Œæ‰§è¡Œå‘½ä»¤ï¼›</li><li>2.æœ¬æ–‡æ¡£åªéœ€è¦éƒ¨ç½²ä¸€æ¬¡ï¼Œç”Ÿæˆçš„ kubeconfig æ–‡ä»¶æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥æ‹·è´åˆ°éœ€è¦æ‰§è¡Œ kubectl å‘½ä»¤çš„æœºå™¨ï¼Œé‡å‘½åä¸º ~/.kube/configï¼›</li></ul><h4 id="5-1ã€ä¸‹è½½å’Œåˆ†å‘-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#5-1ã€ä¸‹è½½å’Œåˆ†å‘-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="5.1ã€ä¸‹è½½å’Œåˆ†å‘ kubectl äºŒè¿›åˆ¶æ–‡ä»¶"></a>5.1ã€ä¸‹è½½å’Œåˆ†å‘ kubectl äºŒè¿›åˆ¶æ–‡ä»¶</h4><p>è¿™é‡Œå§æŠŠnodeå’Œmasteræ‰€éœ€è¦çš„åŒ…å‡ç»™ä¸€æ¬¡æ€§åˆ†å‘</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.14.6/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-client-linux-amd64.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># master èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp kubernetes/server/bin/&#123;apiextensions-apiserver,cloud-controller-manager,kube-apiserver,kube-controller-manager,kube-proxy,kube-scheduler,kubeadm,kubectl,kubelet,mounter&#125; &#123;master-ip&#125;:/usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># node èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; &#123;node-ip&#125;:/usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="5-2ã€åˆ›å»º-admin-è¯ä¹¦å’Œç§é’¥"><a href="#5-2ã€åˆ›å»º-admin-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="5.2ã€åˆ›å»º admin è¯ä¹¦å’Œç§é’¥"></a>5.2ã€åˆ›å»º admin è¯ä¹¦å’Œç§é’¥</h4><p>kubectl ä¸ apiserver https å®‰å…¨ç«¯å£é€šä¿¡ï¼Œapiserver å¯¹æä¾›çš„è¯ä¹¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚<br>kubectl ä½œä¸ºé›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œéœ€è¦è¢«æˆäºˆæœ€é«˜æƒé™ï¼Œè¿™é‡Œåˆ›å»ºå…·æœ‰<strong>æœ€é«˜æƒé™</strong>çš„ admin è¯ä¹¦ã€‚</p><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; admin-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>O ä¸º system:mastersï¼Œkube-apiserver æ”¶åˆ°è¯¥è¯ä¹¦åå°†è¯·æ±‚çš„ Group è®¾ç½®ä¸º system:mastersï¼›</p></li><li><p>é¢„å®šä¹‰çš„ ClusterRoleBinding cluster-admin å°† Group system:masters ä¸ Role cluster-admin ç»‘å®šï¼Œè¯¥ Role æˆäºˆæ‰€æœ‰ APIçš„æƒé™ï¼›</p></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kubectl å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json  -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></span><br><span class="line"><span class="comment"># ls admin*</span></span><br><span class="line"><span class="comment"># cp admin*.pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="5-3ã€åˆ›å»º-kubeconfig-æ–‡ä»¶"><a href="#5-3ã€åˆ›å»º-kubeconfig-æ–‡ä»¶" class="headerlink" title="5.3ã€åˆ›å»º kubeconfig æ–‡ä»¶"></a>5.3ã€åˆ›å»º kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubeconfig ä¸º kubectl çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«è®¿é—® apiserver çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¦‚ apiserver åœ°å€ã€CA è¯ä¹¦å’Œè‡ªèº«ä½¿ç”¨çš„è¯ä¹¦ï¼›</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤APIåœ°å€</span></span><br><span class="line"><span class="comment"># KUBE_APISERVER="https://172.21.16.45:8443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials admin \</span><br><span class="line">  --client-certificate=admin.pem \</span><br><span class="line">  --client-key=admin-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context kubernetes \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=admin \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=kubectl.kubeconfig</span><br></pre></td></tr></table></figure><ul><li><strong>æç¤º</strong>: åˆ†å‘<code>kubectl.kubeconfig</code>æ–‡ä»¶ï¼Œå§æ–‡ä»¶å‘½å<code>~/.kube/config</code>;</li><li>â€“certificate-authorityï¼šéªŒè¯ kube-apiserver è¯ä¹¦çš„æ ¹è¯ä¹¦ï¼›</li><li>â€“client-certificateã€â€“client-keyï¼šåˆšç”Ÿæˆçš„ admin è¯ä¹¦å’Œç§é’¥ï¼Œè¿æ¥ kube-apiserver æ—¶ä½¿ç”¨ï¼›</li><li>â€“embed-certs=trueï¼šå°† ca.pem å’Œ admin.pem è¯ä¹¦å†…å®¹åµŒå…¥åˆ°ç”Ÿæˆçš„ kubectl.kubeconfig æ–‡ä»¶ä¸­(ä¸åŠ æ—¶ï¼Œå†™å…¥çš„æ˜¯è¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼Œåç»­æ‹·è´ kubeconfig åˆ°å…¶å®ƒæœºå™¨æ—¶ï¼Œè¿˜éœ€è¦å•ç‹¬æ‹·è´è¯ä¹¦æ–‡ä»¶ï¼Œä¸æ–¹ä¾¿ã€‚)ï¼›</li></ul><h3 id="6ã€éƒ¨ç½²etcdé›†ç¾¤"><a href="#6ã€éƒ¨ç½²etcdé›†ç¾¤" class="headerlink" title="6ã€éƒ¨ç½²etcdé›†ç¾¤"></a>6ã€éƒ¨ç½²etcdé›†ç¾¤</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etcd æ˜¯åŸºäº Raft çš„åˆ†å¸ƒå¼ key-value å­˜å‚¨ç³»ç»Ÿï¼Œç”± CoreOS å¼€å‘ï¼Œå¸¸ç”¨äºæœåŠ¡å‘ç°ã€å…±äº«é…ç½®ä»¥åŠå¹¶å‘æ§åˆ¶ï¼ˆå¦‚ leader é€‰ä¸¾ã€åˆ†å¸ƒå¼é”ç­‰ï¼‰ã€‚kubernetes ä½¿ç”¨ etcd å­˜å‚¨æ‰€æœ‰è¿è¡Œæ•°æ®ã€‚</p><p>ä¸‰èŠ‚ç‚¹é«˜å¯ç”¨ etcd é›†ç¾¤çš„æ­¥éª¤ï¼š</p><ul><li>ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶ï¼›</li><li>åˆ›å»º etcd é›†ç¾¤å„èŠ‚ç‚¹çš„ x509 è¯ä¹¦ï¼Œç”¨äºåŠ å¯†å®¢æˆ·ç«¯(å¦‚ etcdctl) ä¸ etcd é›†ç¾¤ã€etcd é›†ç¾¤ä¹‹é—´çš„æ•°æ®æµï¼›</li><li>åˆ›å»º etcd çš„ systemd unit æ–‡ä»¶ï¼Œé…ç½®æœåŠ¡å‚æ•°</li><li>æ£€æŸ¥é›†ç¾¤å·¥ä½œçŠ¶æ€;</li></ul><ul><li><strong>æ³¨æ„</strong>: å‡åœ¨ä¸€å°master<code>[etcd]</code>èŠ‚ç‚¹æ“ä½œï¼Œå…¶ä»–master<code>[etcd]</code>èŠ‚ç‚¹é€šè¿‡åˆ†å‘</li></ul><h4 id="6-1ã€ä¸‹è½½å’Œåˆ†å‘-etcd-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#6-1ã€ä¸‹è½½å’Œåˆ†å‘-etcd-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="6.1ã€ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶"></a>6.1ã€ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir etcd &amp;&amp;cd etcd</span></span><br><span class="line"><span class="comment"># https://github.com/coreos/etcd/releases/download/v3.3.13/etcd-v3.3.13-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xvf etcd-v3.3.13-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># scp etcd* &#123;master-ip&#125;:/usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="6-2ã€åˆ›å»º-etcd-è¯ä¹¦å’Œç§é’¥"><a href="#6-2ã€åˆ›å»º-etcd-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="6.2ã€åˆ›å»º etcd è¯ä¹¦å’Œç§é’¥"></a>6.2ã€åˆ›å»º etcd è¯ä¹¦å’Œç§é’¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; etcd-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"172.21.17.30"</span>,</span><br><span class="line">    <span class="string">"172.21.17.31"</span>,</span><br><span class="line">    <span class="string">"172.21.16.110"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ etcd èŠ‚ç‚¹ IP æˆ–åŸŸååˆ—è¡¨ï¼Œéœ€è¦å°† etcd é›†ç¾¤çš„ä¸‰ä¸ªèŠ‚ç‚¹ IP éƒ½åˆ—åœ¨å…¶ä¸­ï¼›</li><li>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem cfssl gencert -ca=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span></span><br><span class="line"><span class="comment"># ls etcd*pem</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/etcd/ssl &amp;&amp; cp etcd*pem /etc/etcd/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="6-3ã€åˆ›å»º-etcd-çš„-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#6-3ã€åˆ›å»º-etcd-çš„-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="6.3ã€åˆ›å»º etcd çš„ systemd unit æ¨¡æ¿æ–‡ä»¶"></a>6.3ã€åˆ›å»º etcd çš„ systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/systemd/system/etcd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/data</span><br><span class="line">ExecStart=/usr/bin/etcd \</span><br><span class="line">  --data-dir=/var/lib/etcd/data \</span><br><span class="line">  --wal-dir=/var/lib/etcd/wal \</span><br><span class="line">  --name=etcd1 \<span class="comment">#æ ¹æ®èŠ‚ç‚¹åç§°è¿›è¡Œå˜åŒ–</span></span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --listen-peer-urls=https://172.21.17.30:2380 \</span><br><span class="line">  --initial-advertise-peer-urls=https://172.21.17.30:2380 \</span><br><span class="line">  --listen-client-urls=https://172.21.17.30:2379,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls=https://172.21.17.30:2379 \</span><br><span class="line">  --initial-cluster-token=etcd-cluster-0 \</span><br><span class="line">  --initial-cluster=etcd1=https://172.21.17.30:2380,etcd2=https://172.21.17.31:2380,etcd3=https://172.21.16.110:2380 \</span><br><span class="line">  --initial-cluster-state=new \</span><br><span class="line">  --auto-compaction-mode=periodic \</span><br><span class="line">  --auto-compaction-retention=1 \</span><br><span class="line">  --max-request-bytes=33554432 \</span><br><span class="line">  --quota-backend-bytes=6442450944 \</span><br><span class="line">  --heartbeat-interval=250 \</span><br><span class="line">  --election-timeout=2000</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /var/lib/etcd/&#123;data,wal&#125;</span></span><br></pre></td></tr></table></figure><ul><li>WorkingDirectoryã€â€“data-dirï¼šæŒ‡å®šå·¥ä½œç›®å½•å’Œæ•°æ®ç›®å½•ä¸º ${ETCD_DATA_DIR}ï¼Œéœ€åœ¨å¯åŠ¨æœåŠ¡å‰åˆ›å»ºè¿™ä¸ªç›®å½•ï¼›</li><li>â€“wal-dirï¼šæŒ‡å®š wal ç›®å½•ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œä¸€èˆ¬ä½¿ç”¨ SSD æˆ–è€…å’Œ â€“data-dir ä¸åŒçš„ç£ç›˜ï¼›</li><li>â€“nameï¼šæŒ‡å®šèŠ‚ç‚¹åç§°ï¼Œå½“ â€“initial-cluster-state å€¼ä¸º new æ—¶ï¼Œâ€“name çš„å‚æ•°å€¼å¿…é¡»ä½äº â€“initial-cluster åˆ—è¡¨ä¸­ï¼›</li><li>â€“cert-fileã€â€“key-fileï¼šetcd server ä¸ client é€šä¿¡æ—¶ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥ï¼›</li><li>â€“trusted-ca-fileï¼šç­¾å client è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œç”¨äºéªŒè¯ client è¯ä¹¦ï¼›</li><li>â€“peer-cert-fileã€â€“peer-key-fileï¼šetcd ä¸ peer é€šä¿¡ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥ï¼›</li><li>â€“peer-trusted-ca-fileï¼šç­¾å peer è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œç”¨äºéªŒè¯ peer è¯ä¹¦ï¼›</li></ul><h4 id="6-4ã€å¯åŠ¨-etcd-æœåŠ¡"><a href="#6-4ã€å¯åŠ¨-etcd-æœåŠ¡" class="headerlink" title="6.4ã€å¯åŠ¨ etcd æœåŠ¡"></a>6.4ã€å¯åŠ¨ etcd æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd &amp;&amp; systemctl status etcd</span></span><br></pre></td></tr></table></figure><h4 id="6-5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ"><a href="#6-5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ" class="headerlink" title="6.5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ"></a>6.5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ</h4><ul><li>ç¡®ä¿çŠ¶æ€ä¸º active (running)ï¼Œå¦åˆ™æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤åŸå› ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># journalctl -u etcd</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="6-6ã€éªŒè¯æœåŠ¡çŠ¶æ€"><a href="#6-6ã€éªŒè¯æœåŠ¡çŠ¶æ€" class="headerlink" title="6.6ã€éªŒè¯æœåŠ¡çŠ¶æ€"></a>6.6ã€éªŒè¯æœåŠ¡çŠ¶æ€</h4><p>éƒ¨ç½²å®Œ etcd é›†ç¾¤åï¼Œåœ¨ä»»ä¸€ etcd èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">    --endpoints=https://172.21.17.31:2379 \</span><br><span class="line">    --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-key.pem endpoint health</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥è¾“å‡ºå‡ä¸º healthy æ—¶è¡¨ç¤ºé›†ç¾¤æœåŠ¡æ­£å¸¸</p><h4 id="6-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#6-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="6.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>6.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCD_ENDPOINTS="https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379"</span></span><br><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">  -w table --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> endpoint status </span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|  https://172.21.17.30:2379 | 5d23ebc4382fa16f |  3.3.13 |  1.2 MB |     <span class="literal">false</span> |        83 |      58127 |</span><br><span class="line">|  https://172.21.17.31:2379 |  ceaae5134701946 |  3.3.13 |  1.2 MB |     <span class="literal">false</span> |        83 |      58127 |</span><br><span class="line">| https://172.21.16.110:2379 | 575020c8e15d3a06 |  3.3.13 |  1.2 MB |      <span class="literal">true</span> |        83 |      58128 |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></figure><ul><li>å½“å‰çš„ leader ä¸º 172.21.16.110</li></ul><h3 id="7ã€éƒ¨ç½²-flannel-ç½‘ç»œ"><a href="#7ã€éƒ¨ç½²-flannel-ç½‘ç»œ" class="headerlink" title="7ã€éƒ¨ç½² flannel ç½‘ç»œ"></a>7ã€éƒ¨ç½² flannel ç½‘ç»œ</h3><p>flannel ç½‘ç»œéƒ¨ç½²åœ¨nodeèŠ‚ç‚¹ï¼Œè¯ä¹¦åœ¨masterèŠ‚ç‚¹ç”Ÿæˆåˆ†å‘</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubernetes è¦æ±‚é›†ç¾¤å†…å„èŠ‚ç‚¹(åŒ…æ‹¬ master èŠ‚ç‚¹)èƒ½é€šè¿‡ Pod ç½‘æ®µäº’è”äº’é€šã€‚flannel ä½¿ç”¨ vxlan æŠ€æœ¯ä¸ºå„èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªå¯ä»¥äº’é€šçš„ Pod ç½‘ç»œï¼Œä½¿ç”¨çš„ç«¯å£ä¸º UDP 8472ï¼ˆéœ€è¦å¼€æ”¾è¯¥ç«¯å£ï¼‰<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flanneld ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œä» etcd è·å–é…ç½®çš„ Pod ç½‘æ®µä¿¡æ¯ï¼Œä¸ºæœ¬èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªæœªä½¿ç”¨çš„åœ°å€æ®µï¼Œç„¶ååˆ›å»º flannedl.1 ç½‘ç»œæ¥å£ï¼ˆä¹Ÿå¯èƒ½æ˜¯å…¶å®ƒåç§°ï¼Œå¦‚ flannel1 ç­‰ï¼‰<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flannel å°†åˆ†é…ç»™è‡ªå·±çš„ Pod ç½‘æ®µä¿¡æ¯å†™å…¥ /run/flannel/docker æ–‡ä»¶ï¼Œdocker åç»­ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡è®¾ç½® docker0 ç½‘æ¡¥ï¼Œä»è€Œä»è¿™ä¸ªåœ°å€æ®µä¸ºæœ¬èŠ‚ç‚¹çš„æ‰€æœ‰ Pod å®¹å™¨åˆ†é… IPã€‚</p><h4 id="7-1ã€ä¸‹è½½å’Œåˆ†å‘-flanneld-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#7-1ã€ä¸‹è½½å’Œåˆ†å‘-flanneld-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="7.1ã€ä¸‹è½½å’Œåˆ†å‘ flanneld äºŒè¿›åˆ¶æ–‡ä»¶"></a>7.1ã€ä¸‹è½½å’Œåˆ†å‘ flanneld äºŒè¿›åˆ¶æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir flannel &amp;&amp;cd flannel</span></span><br><span class="line"><span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzvf flannel-v0.11.0-linux-amd64.tar.gz -C flannel</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†å‘flanneld å¯æ‰§è¡Œæ–‡ä»¶åˆ°nodeèŠ‚ç‚¹</li></ul><h4 id="7-2ã€åˆ›å»º-flannel-è¯ä¹¦å’Œç§é’¥"><a href="#7-2ã€åˆ›å»º-flannel-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="7.2ã€åˆ›å»º flannel è¯ä¹¦å’Œç§é’¥"></a>7.2ã€åˆ›å»º flannel è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>flanneld-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; flanneld-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"flanneld"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kubectl å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld </span></span><br><span class="line"><span class="comment"># ls flanneld*pem</span></span><br><span class="line"><span class="comment"># scp flanneld*pem &#123;node-ip&#125;:/etc/flanneld/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="7-3ã€å‘-etcd-å†™å…¥é›†ç¾¤-Pod-ç½‘æ®µä¿¡æ¯"><a href="#7-3ã€å‘-etcd-å†™å…¥é›†ç¾¤-Pod-ç½‘æ®µä¿¡æ¯" class="headerlink" title="7.3ã€å‘ etcd å†™å…¥é›†ç¾¤ Pod ç½‘æ®µä¿¡æ¯"></a>7.3ã€å‘ etcd å†™å…¥é›†ç¾¤ Pod ç½‘æ®µä¿¡æ¯</h4><p><strong>æ³¨æ„</strong>ï¼šæœ¬æ­¥éª¤åªéœ€æ‰§è¡Œä¸€æ¬¡ã€‚åœ¨etcdé›†ç¾¤ä¸Šæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=flanneld.pem \</span><br><span class="line">  --key-file=flanneld-key.pem \</span><br><span class="line">  mk /kubernetes/network/config <span class="string">'&#123;"Network":"172.30.0.0/16", "SubnetLen": 21, "Backend": &#123;"Type": "vxlan"&#125;&#125;'</span></span><br></pre></td></tr></table></figure><ul><li>flanneld å½“å‰ç‰ˆæœ¬ (v0.11.0) ä¸æ”¯æŒ etcd v3ï¼Œæ•…ä½¿ç”¨ etcd v2 API å†™å…¥é…ç½® key å’Œç½‘æ®µæ•°æ®ï¼›</li><li>å†™å…¥çš„ Pod ç½‘æ®µ ${CLUSTER_CIDR} åœ°å€æ®µï¼ˆå¦‚ /16ï¼‰å¿…é¡»å°äº SubnetLenï¼Œå¿…é¡»ä¸ kube-controller-manager çš„ â€“cluster-cidr å‚æ•°å€¼ä¸€è‡´ï¼›</li></ul><h4 id="7-4ã€åˆ›å»º-flanneld-çš„-systemd-unit-æ–‡ä»¶"><a href="#7-4ã€åˆ›å»º-flanneld-çš„-systemd-unit-æ–‡ä»¶" class="headerlink" title="7.4ã€åˆ›å»º flanneld çš„ systemd unit æ–‡ä»¶"></a>7.4ã€åˆ›å»º flanneld çš„ systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/flanneld.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=etcd.service</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/flanneld \</span><br><span class="line">  -etcd-cafile=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  -etcd-certfile=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  -etcd-keyfile=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  -etcd-endpoints=https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379 \</span><br><span class="line">  -etcd-prefix=/kubernetes/network \</span><br><span class="line">  -iface=eth0 \</span><br><span class="line">  -ip-masq</span><br><span class="line">ExecStartPost=/usr/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">RequiredBy=docker.service</span><br></pre></td></tr></table></figure><ul><li>mk-docker-opts.sh è„šæœ¬å°†åˆ†é…ç»™ flanneld çš„ Pod å­ç½‘æ®µä¿¡æ¯å†™å…¥ /run/flannel/docker æ–‡ä»¶ï¼Œåç»­ docker å¯åŠ¨æ—¶ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡é…ç½® docker0 ç½‘æ¡¥ï¼›</li><li>flanneld ä½¿ç”¨ç³»ç»Ÿç¼ºçœè·¯ç”±æ‰€åœ¨çš„æ¥å£ä¸å…¶å®ƒèŠ‚ç‚¹é€šä¿¡ï¼Œå¯¹äºæœ‰å¤šä¸ªç½‘ç»œæ¥å£ï¼ˆå¦‚å†…ç½‘å’Œå…¬ç½‘ï¼‰çš„èŠ‚ç‚¹ï¼Œå¯ä»¥ç”¨ -iface å‚æ•°æŒ‡å®šé€šä¿¡æ¥å£;</li><li>flanneld è¿è¡Œæ—¶éœ€è¦ root æƒé™ï¼›</li><li>-ip-masq: flanneld ä¸ºè®¿é—® Pod ç½‘ç»œå¤–çš„æµé‡è®¾ç½® SNAT è§„åˆ™ï¼ŒåŒæ—¶å°†ä¼ é€’ç»™ Docker çš„å˜é‡ â€“ip-masqï¼ˆ/run/flannel/docker æ–‡ä»¶ä¸­ï¼‰è®¾ç½®ä¸º falseï¼Œè¿™æ · Docker å°†ä¸å†åˆ›å»º SNAT è§„åˆ™ï¼› Docker çš„ â€“ip-masq ä¸º true æ—¶ï¼Œåˆ›å»ºçš„ SNAT è§„åˆ™æ¯”è¾ƒâ€œæš´åŠ›â€ï¼šå°†æ‰€æœ‰æœ¬èŠ‚ç‚¹ Pod å‘èµ·çš„ã€è®¿é—®é docker0 æ¥å£çš„è¯·æ±‚åš SNATï¼Œè¿™æ ·è®¿é—®å…¶ä»–èŠ‚ç‚¹ Pod çš„è¯·æ±‚æ¥æº IP ä¼šè¢«è®¾ç½®ä¸º flannel.1 æ¥å£çš„ IPï¼Œå¯¼è‡´ç›®çš„ Pod çœ‹ä¸åˆ°çœŸå®çš„æ¥æº Pod IPã€‚ flanneld åˆ›å»ºçš„ SNAT è§„åˆ™æ¯”è¾ƒæ¸©å’Œï¼Œåªå¯¹è®¿é—®é Pod ç½‘æ®µçš„è¯·æ±‚åš SNATã€‚</li></ul><h4 id="7-5ã€å¯åŠ¨-flanneld-æœåŠ¡"><a href="#7-5ã€å¯åŠ¨-flanneld-æœåŠ¡" class="headerlink" title="7.5ã€å¯åŠ¨ flanneld æœåŠ¡"></a>7.5ã€å¯åŠ¨ flanneld æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable flanneld &amp;&amp; systemctl restart flanneld &amp;&amp; systemctl status flanneld</span></span><br></pre></td></tr></table></figure><h4 id="7-6ã€æ£€æŸ¥åˆ†é…ç»™å„-flanneld-çš„-Pod-ç½‘æ®µä¿¡æ¯"><a href="#7-6ã€æ£€æŸ¥åˆ†é…ç»™å„-flanneld-çš„-Pod-ç½‘æ®µä¿¡æ¯" class="headerlink" title="7.6ã€æ£€æŸ¥åˆ†é…ç»™å„ flanneld çš„ Pod ç½‘æ®µä¿¡æ¯"></a>7.6ã€æ£€æŸ¥åˆ†é…ç»™å„ flanneld çš„ Pod ç½‘æ®µä¿¡æ¯</h4><ul><li><p>æŸ¥çœ‹é›†ç¾¤ Pod ç½‘æ®µ(/16)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  get /kubernetes/network/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 21, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å·²åˆ†é…çš„ Pod å­ç½‘æ®µåˆ—è¡¨(/24):</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  ls /kubernetes/network/subnets</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">/kubernetes/network/subnets/172.30.232.0-21</span><br><span class="line">/kubernetes/network/subnets/172.30.128.0-21</span><br><span class="line">/kubernetes/network/subnets/172.30.176.0-21</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æŸä¸€ Pod ç½‘æ®µå¯¹åº”çš„èŠ‚ç‚¹ IP å’Œ flannel æ¥å£åœ°å€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  get /kubernetes/network/subnets/172.30.232.0-21</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"172.21.16.204"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"f6:50:05:5c:9a:20"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>172.30.232.0/21 è¢«åˆ†é…ç»™èŠ‚ç‚¹172.21.16.204ï¼‰ï¼›</p></li><li><p>VtepMAC ä¸º172.21.16.204èŠ‚ç‚¹çš„ flannel.1 ç½‘å¡ MAC åœ°å€ï¼›</p></li></ul><h4 id="7-7ã€æ£€æŸ¥èŠ‚ç‚¹-flannel-ç½‘ç»œä¿¡æ¯"><a href="#7-7ã€æ£€æŸ¥èŠ‚ç‚¹-flannel-ç½‘ç»œä¿¡æ¯" class="headerlink" title="7.7ã€æ£€æŸ¥èŠ‚ç‚¹ flannel ç½‘ç»œä¿¡æ¯"></a>7.7ã€æ£€æŸ¥èŠ‚ç‚¹ flannel ç½‘ç»œä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip addr show</span></span><br></pre></td></tr></table></figure><ul><li><p>flannel.1 ç½‘å¡çš„åœ°å€ä¸ºåˆ†é…çš„ Pod å­ç½‘æ®µçš„ç¬¬ä¸€ä¸ª IPï¼ˆ.0ï¼‰ï¼Œä¸”æ˜¯ /32 çš„åœ°å€ï¼›</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip route show |grep flannel.1</span></span><br><span class="line">172.30.128.0/21 via 172.30.128.0 dev flannel.1 onlink </span><br><span class="line">172.30.176.0/21 via 172.30.176.0 dev flannel.1 onlink</span><br></pre></td></tr></table></figure></li><li><p>åˆ°å…¶å®ƒèŠ‚ç‚¹ Pod ç½‘æ®µè¯·æ±‚éƒ½è¢«è½¬å‘åˆ° flannel.1 ç½‘å¡ï¼›</p></li><li><p>flanneld æ ¹æ® etcd ä¸­å­ç½‘æ®µçš„ä¿¡æ¯ï¼Œå¦‚/kubernetes/network/subnets/172.30.232.0-21 ï¼Œæ¥å†³å®šè¿›è¯·æ±‚å‘é€ç»™å“ªä¸ªèŠ‚ç‚¹çš„äº’è” IPï¼›</p></li><li><p>éªŒè¯å„èŠ‚ç‚¹èƒ½é€šè¿‡ Pod ç½‘æ®µäº’é€š</p></li></ul><h3 id="8ã€masterèŠ‚ç‚¹éƒ¨ç½²"><a href="#8ã€masterèŠ‚ç‚¹éƒ¨ç½²" class="headerlink" title="8ã€masterèŠ‚ç‚¹éƒ¨ç½²"></a>8ã€masterèŠ‚ç‚¹éƒ¨ç½²</h3><p>kubernetes master èŠ‚ç‚¹è¿è¡Œå¦‚ä¸‹ç»„ä»¶ï¼š</p><ul><li>kube-apiserver</li><li>kube-scheduler</li><li>kube-controller-manager<br>kube-apiserverã€kube-scheduler å’Œ kube-controller-manager å‡ä»¥å¤šå®ä¾‹æ¨¡å¼è¿è¡Œï¼š<br>1ã€kube-scheduler å’Œ kube-controller-manager ä¼šè‡ªåŠ¨é€‰ä¸¾äº§ç”Ÿä¸€ä¸ª leader å®ä¾‹ï¼Œå…¶å®ƒå®ä¾‹å¤„äºé˜»å¡æ¨¡å¼ï¼Œå½“ leader æŒ‚äº†åï¼Œé‡æ–°é€‰ä¸¾äº§ç”Ÿæ–°çš„ leaderï¼Œä»è€Œä¿è¯æœåŠ¡å¯ç”¨æ€§ï¼›<br>2ã€kube-apiserver æ˜¯æ— çŠ¶æ€çš„ï¼Œéœ€è¦é€šè¿‡<a href="https://xxlaila.github.io/2019/08/10/haproxy-keepalived/" target="_blank" rel="noopener">haproxy+keepalived</a>è¿›è¡Œä»£ç†è®¿é—®ï¼Œä»è€Œä¿è¯æœåŠ¡å¯ç”¨æ€§ï¼›</li></ul><h4 id="8-1ã€åˆ›å»º-kubernetes-è¯ä¹¦å’Œç§é’¥"><a href="#8-1ã€åˆ›å»º-kubernetes-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="8.1ã€åˆ›å»º kubernetes è¯ä¹¦å’Œç§é’¥"></a>8.1ã€åˆ›å»º kubernetes è¯ä¹¦å’Œç§é’¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kubernetes-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"172.21.17.30"</span>,</span><br><span class="line">    <span class="string">"172.21.17.31"</span>,</span><br><span class="line">    <span class="string">"172.21.16.110"</span>,</span><br><span class="line">    <span class="string">"172.21.16.45"</span>,</span><br><span class="line">    <span class="string">"10.254.0.1"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local."</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><p>hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ IP å’ŒåŸŸååˆ—è¡¨ï¼Œè¿™é‡Œåˆ—å‡ºäº† master èŠ‚ç‚¹ IPã€kubernetes æœåŠ¡çš„ IP å’ŒåŸŸå,ä»¥åŠVIPåœ°å€ï¼›</p></li><li><p>kubernetes æœåŠ¡ IP æ˜¯ apiserver è‡ªåŠ¨åˆ›å»ºçš„ï¼Œä¸€èˆ¬æ˜¯ â€“service-cluster-ip-range å‚æ•°æŒ‡å®šçš„ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIP,åç»­å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤è·å–ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc kubernetes</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.254.0.1   &lt;none&gt;        443/TCP   4h13m</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span></span><br><span class="line"><span class="comment"># ls kubernetes*pem</span></span><br><span class="line">kubernetes-key.pem  kubernetes.pem</span><br><span class="line"><span class="comment"># cp kubernetes*pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="8-2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶"><a href="#8-2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶" class="headerlink" title="8.2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶"></a>8.2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)</span></span><br><span class="line"><span class="comment"># cat &gt; encryption-config.yaml &lt;&lt;EOF</span></span><br><span class="line">kind: EncryptionConfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">resources:</span><br><span class="line">  - resources:</span><br><span class="line">      - secrets</span><br><span class="line">    providers:</span><br><span class="line">      - aescbc:</span><br><span class="line">          keys:</span><br><span class="line">            - name: key1</span><br><span class="line">              secret: <span class="variable">$&#123;ENCRYPTION_KEY&#125;</span></span><br><span class="line">      - identity: &#123;&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># cp encryption-config.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="8-3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"><a href="#8-3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶" class="headerlink" title="8.3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"></a>8.3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; audit-policy.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: audit.k8s.io/v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># The following requests were manually identified as high-volume and low-risk, so drop them.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">          - services</span><br><span class="line">          - services/status</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-proxy'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes</span><br><span class="line">          - nodes/status</span><br><span class="line">    userGroups:</span><br><span class="line">      - <span class="string">'system:nodes'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    namespaces:</span><br><span class="line">      - kube-system</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">      - <span class="string">'system:kube-scheduler'</span></span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:endpoint-controller'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - namespaces</span><br><span class="line">          - namespaces/status</span><br><span class="line">          - namespaces/finalize</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:apiserver'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log HPA fetching metrics.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log these read-only URLs.</span></span><br><span class="line">  - level: None</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">      - <span class="string">'/healthz*'</span></span><br><span class="line">      - /version</span><br><span class="line">      - <span class="string">'/swagger*'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log events requests.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - events</span><br><span class="line"></span><br><span class="line">  <span class="comment"># node and pod status calls from nodes are high-volume and can be large, don't log responses for expected updates from nodes</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes/status</span><br><span class="line">          - pods/status</span><br><span class="line">    users:</span><br><span class="line">      - kubelet</span><br><span class="line">      - <span class="string">'system:node-problem-detector'</span></span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:node-problem-detector'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes/status</span><br><span class="line">          - pods/status</span><br><span class="line">    userGroups:</span><br><span class="line">      - <span class="string">'system:nodes'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  <span class="comment"># deletecollection calls can be large, don't log responses for expected namespace deletions</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:namespace-controller'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - deletecollection</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span><br><span class="line">  <span class="comment"># so only log at the Metadata level.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - secrets</span><br><span class="line">          - configmaps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">        resources:</span><br><span class="line">          - tokenreviews</span><br><span class="line">  <span class="comment"># Get repsonses can be large; skip them.</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default level for known APIs</span></span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">      </span><br><span class="line">  <span class="comment"># Default level for all other requests.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp audit-policy.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="8-4ã€åˆ›å»ºåç»­è®¿é—®-metrics-server-ä½¿ç”¨çš„è¯ä¹¦"><a href="#8-4ã€åˆ›å»ºåç»­è®¿é—®-metrics-server-ä½¿ç”¨çš„è¯ä¹¦" class="headerlink" title="8.4ã€åˆ›å»ºåç»­è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦"></a>8.4ã€åˆ›å»ºåç»­è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; proxy-client-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"aggregator"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>CN åç§°éœ€è¦ä½äº kube-apiserver çš„ â€“requestheader-allowed-names å‚æ•°ä¸­ï¼Œå¦åˆ™åç»­è®¿é—® metrics æ—¶ä¼šæç¤ºæƒé™ä¸è¶³ã€‚</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem  -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes proxy-client-csr.json | cfssljson -bare proxy-client</span></span><br><span class="line"><span class="comment"># ls proxy-client*.pem</span></span><br><span class="line">proxy-client-key.pem  proxy-client.pem</span><br><span class="line"><span class="comment"># cp proxy-client*.pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="8-5ã€åˆ›å»º-kube-apiserver-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#8-5ã€åˆ›å»º-kube-apiserver-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="8.5ã€åˆ›å»º kube-apiserver systemd unit æ¨¡æ¿æ–‡ä»¶"></a>8.5ã€åˆ›å»º kube-apiserver systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-apiserver</span><br><span class="line">ExecStart=/usr/bin/kube-apiserver \</span><br><span class="line">  --advertise-address=172.21.17.30 \<span class="comment">#master èŠ‚ç‚¹çš„ip</span></span><br><span class="line">  --default-not-ready-toleration-seconds=360 \</span><br><span class="line">  --default-unreachable-toleration-seconds=360 \</span><br><span class="line">  --feature-gates=DynamicAuditing=<span class="literal">true</span> \</span><br><span class="line">  --max-mutating-requests-inflight=2000 \</span><br><span class="line">  --max-requests-inflight=4000 \</span><br><span class="line">  --default-watch-cache-size=200 \</span><br><span class="line">  --delete-collection-workers=2 \</span><br><span class="line">  --encryption-provider-config=/etc/kubernetes/encryption-config.yaml \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --etcd-servers=https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379 \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --insecure-port=0 \</span><br><span class="line">  --audit-dynamic-configuration \</span><br><span class="line">  --audit-log-maxage=15 \</span><br><span class="line">  --audit-log-maxbackup=3 \</span><br><span class="line">  --audit-log-maxsize=100 \</span><br><span class="line">  --audit-log-truncate-enabled \</span><br><span class="line">  --audit-log-path=/var/<span class="built_in">log</span>/k8s/kube-apiserver/audit.log \</span><br><span class="line">  --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span><br><span class="line">  --profiling \</span><br><span class="line">  --anonymous-auth=<span class="literal">false</span> \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --<span class="built_in">enable</span>-bootstrap-token-auth \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">"aggregator"</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --runtime-config=api/all=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">enable</span>-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,TaintNodesByCondition,Priority,DefaultTolerationSeconds,DefaultStorageClass,PersistentVolumeClaimResize,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --apiserver-count=3 \</span><br><span class="line">  --event-ttl=168h \</span><br><span class="line">  --kubelet-certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --kubelet-https=<span class="literal">true</span> \</span><br><span class="line">  --kubelet-timeout=10s \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/ssl/proxy-client.pem \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/ssl/proxy-client-key.pem \</span><br><span class="line">  --service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">  --service-node-port-range=30000-32767 \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">enable</span>-aggregator-routing=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-apiserver</span></span><br></pre></td></tr></table></figure><ul><li>â€“advertise-addressï¼šapiserver å¯¹å¤–é€šå‘Šçš„ IPï¼ˆkubernetes æœåŠ¡åç«¯èŠ‚ç‚¹ IPï¼‰ï¼›</li><li>â€“default-*-toleration-secondsï¼šè®¾ç½®èŠ‚ç‚¹å¼‚å¸¸ç›¸å…³çš„é˜ˆå€¼ï¼›</li><li>â€“max-*-requests-inflightï¼šè¯·æ±‚ç›¸å…³çš„æœ€å¤§é˜ˆå€¼ï¼›</li><li>â€“etcd-*ï¼šè®¿é—® etcd çš„è¯ä¹¦å’Œ etcd æœåŠ¡å™¨åœ°å€ï¼›</li><li>â€“experimental-encryption-provider-configï¼šæŒ‡å®šç”¨äºåŠ å¯† etcd ä¸­ secret çš„é…ç½®ï¼›</li><li>â€“bind-addressï¼š https ç›‘å¬çš„ IPï¼Œä¸èƒ½ä¸º 127.0.0.1ï¼Œå¦åˆ™å¤–ç•Œä¸èƒ½è®¿é—®å®ƒçš„å®‰å…¨ç«¯å£ 6443ï¼›</li><li>â€“secret-portï¼šhttps ç›‘å¬ç«¯å£ï¼›</li><li>â€“insecure-port=0ï¼šå…³é—­ç›‘å¬ http éå®‰å…¨ç«¯å£(8080)ï¼›</li><li>â€“tls-*-fileï¼šæŒ‡å®š apiserver ä½¿ç”¨çš„è¯ä¹¦ã€ç§é’¥å’Œ CA æ–‡ä»¶ï¼›</li><li>â€“audit-*ï¼šé…ç½®å®¡è®¡ç­–ç•¥å’Œå®¡è®¡æ—¥å¿—æ–‡ä»¶ç›¸å…³çš„å‚æ•°ï¼›</li><li>â€“client-ca-fileï¼šéªŒè¯ client (kue-controller-managerã€kube-schedulerã€kubeletã€kube-proxy ç­‰)è¯·æ±‚æ‰€å¸¦çš„è¯ä¹¦ï¼›</li><li>â€“enable-bootstrap-token-authï¼šå¯ç”¨ kubelet bootstrap çš„ token è®¤è¯ï¼›</li><li>â€“requestheader-*ï¼škube-apiserver çš„ aggregator layer ç›¸å…³çš„é…ç½®å‚æ•°ï¼Œproxy-client &amp; HPA éœ€è¦ä½¿ç”¨ï¼›</li><li>â€“requestheader-client-ca-fileï¼šç”¨äºç­¾å â€“proxy-client-cert-file å’Œ â€“proxy-client-key-file æŒ‡å®šçš„è¯ä¹¦ï¼›åœ¨å¯ç”¨äº† metric aggregator æ—¶ä½¿ç”¨ï¼›</li><li>â€“requestheader-allowed-namesï¼šä¸èƒ½ä¸ºç©ºï¼Œå€¼ä¸ºé€—å·åˆ†å‰²çš„ â€“proxy-client-cert-file è¯ä¹¦çš„ CN åç§°ï¼Œè¿™é‡Œè®¾ç½®ä¸º â€œaggregatorâ€ï¼›</li><li>â€“service-account-key-fileï¼šç­¾å ServiceAccount Token çš„å…¬é’¥æ–‡ä»¶ï¼Œkube-controller-manager çš„ â€“service-account-private-key-file æŒ‡å®šç§é’¥æ–‡ä»¶ï¼Œä¸¤è€…é…å¯¹ä½¿ç”¨ï¼›</li><li>â€“runtime-config=api/all=trueï¼š å¯ç”¨æ‰€æœ‰ç‰ˆæœ¬çš„ APIsï¼Œå¦‚ autoscaling/v2alpha1ï¼›</li><li>â€“authorization-mode=Node,RBACã€â€“anonymous-auth=falseï¼š å¼€å¯ Node å’Œ RBAC æˆæƒæ¨¡å¼ï¼Œæ‹’ç»æœªæˆæƒçš„è¯·æ±‚ï¼›</li><li>â€“enable-admission-pluginsï¼šå¯ç”¨ä¸€äº›é»˜è®¤å…³é—­çš„ pluginsï¼›</li><li>â€“allow-privilegedï¼šè¿è¡Œæ‰§è¡Œ privileged æƒé™çš„å®¹å™¨ï¼›</li><li>â€“apiserver-count=3ï¼šæŒ‡å®š apiserver å®ä¾‹çš„æ•°é‡ï¼›</li><li>â€“event-ttlï¼šæŒ‡å®š events çš„ä¿å­˜æ—¶é—´ï¼›</li><li>â€“kubelet-<em>ï¼šå¦‚æœæŒ‡å®šï¼Œåˆ™ä½¿ç”¨ https è®¿é—® kubelet APIsï¼›éœ€è¦ä¸ºè¯ä¹¦å¯¹åº”çš„ç”¨æˆ·(ä¸Šé¢ kubernetes</em>.pem è¯ä¹¦çš„ç”¨æˆ·ä¸º kubernetes) ç”¨æˆ·å®šä¹‰ RBAC è§„åˆ™ï¼Œå¦åˆ™è®¿é—® kubelet API æ—¶æç¤ºæœªæˆæƒï¼›</li><li>â€“proxy-client-*ï¼šapiserver è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦ï¼›</li><li>â€“service-cluster-ip-rangeï¼š æŒ‡å®š Service Cluster IP åœ°å€æ®µï¼›</li><li>â€“service-node-port-rangeï¼š æŒ‡å®š NodePort çš„ç«¯å£èŒƒå›´ï¼›</li><li>å¦‚æœ kube-apiserver æœºå™¨æ²¡æœ‰è¿è¡Œ kube-proxyï¼Œåˆ™è¿˜éœ€è¦æ·»åŠ  â€“enable-aggregator-routing=true å‚æ•°</li></ul><p><strong>æ³¨æ„</strong>:<br>1.requestheader-client-ca-file æŒ‡å®šçš„ CA è¯ä¹¦ï¼Œå¿…é¡»å…·æœ‰ client auth and server authï¼›<br>2.å¦‚æœ â€“requestheader-allowed-names ä¸ºç©ºï¼Œæˆ–è€… â€“proxy-client-cert-file è¯ä¹¦çš„ CN åç§°ä¸åœ¨ allowed-names ä¸­ï¼Œåˆ™åç»­æŸ¥çœ‹ node æˆ– pods çš„ metrics å¤±è´¥ï¼Œæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl top nodes</span></span><br><span class="line">Error from server (Forbidden): nodes.metrics.k8s.io is forbidden: User <span class="string">"aggregator"</span> cannot list resource <span class="string">"nodes"</span> <span class="keyword">in</span> API group <span class="string">"metrics.k8s.io"</span> at the cluster scope</span><br></pre></td></tr></table></figure><h4 id="8-6ã€å¯åŠ¨-kube-apiserver-æœåŠ¡"><a href="#8-6ã€å¯åŠ¨-kube-apiserver-æœåŠ¡" class="headerlink" title="8.6ã€å¯åŠ¨ kube-apiserver æœåŠ¡"></a>8.6ã€å¯åŠ¨ kube-apiserver æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver &amp;&amp;systemctl status kube-apiserver</span></span><br><span class="line"><span class="comment"># systemctl status kube-apiserver |grep 'Active:'</span></span><br><span class="line">   Active: active (running) since Mon 2019-09-16 14:38:31 CST; 1min 41s ago</span><br></pre></td></tr></table></figure><h4 id="8-6ã€æ‰“å°-kube-apiserver-å†™å…¥-etcd-çš„æ•°æ®"><a href="#8-6ã€æ‰“å°-kube-apiserver-å†™å…¥-etcd-çš„æ•°æ®" class="headerlink" title="8.6ã€æ‰“å° kube-apiserver å†™å…¥ etcd çš„æ•°æ®"></a>8.6ã€æ‰“å° kube-apiserver å†™å…¥ etcd çš„æ•°æ®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">    --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">    --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">    get /registry/ --prefix --keys-only</span><br></pre></td></tr></table></figure><h4 id="8-9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯"><a href="#8-9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯" class="headerlink" title="8.9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯"></a>8.9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl cluster-info</span></span><br><span class="line">Kubernetes master is running at https://172.21.16.45:8443</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get all --all-namespaces</span></span><br><span class="line">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default     service/kubernetes   ClusterIP   10.254.0.1   &lt;none&gt;        443/TCP   12m</span><br><span class="line"></span><br><span class="line"><span class="comment">#  kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused</span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused</span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œ kubectl get componentstatuses å‘½ä»¤æ—¶ï¼Œapiserver é»˜è®¤å‘ 127.0.0.1 å‘é€è¯·æ±‚ã€‚å½“ controller-managerã€scheduler ä»¥é›†ç¾¤æ¨¡å¼è¿è¡Œæ—¶ï¼Œæœ‰å¯èƒ½å’Œ kube-apiserver ä¸åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œè¿™æ—¶ controller-manager æˆ– scheduler çš„çŠ¶æ€ä¸º Unhealthyï¼Œä½†å®é™…ä¸Šå®ƒä»¬å·¥ä½œæ­£å¸¸ã€‚</li></ul><h4 id="8-10ã€æ£€æŸ¥-kube-apiserver-ç›‘å¬çš„ç«¯å£"><a href="#8-10ã€æ£€æŸ¥-kube-apiserver-ç›‘å¬çš„ç«¯å£" class="headerlink" title="8.10ã€æ£€æŸ¥ kube-apiserver ç›‘å¬çš„ç«¯å£"></a>8.10ã€æ£€æŸ¥ kube-apiserver ç›‘å¬çš„ç«¯å£</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kube</span></span><br><span class="line">tcp6       0      0 :::6443                 :::*                    LISTEN      10845/kube-apiserve</span><br></pre></td></tr></table></figure><ul><li>6443: æ¥æ”¶ https è¯·æ±‚çš„å®‰å…¨ç«¯å£ï¼Œå¯¹æ‰€æœ‰è¯·æ±‚åšè®¤è¯å’Œæˆæƒï¼›</li><li>ç”±äºå…³é—­äº†éå®‰å…¨ç«¯å£ï¼Œæ•…æ²¡æœ‰ç›‘å¬ 8080ï¼›</li></ul><h4 id="8-11ã€æˆäºˆ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™"><a href="#8-11ã€æˆäºˆ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™" class="headerlink" title="8.11ã€æˆäºˆ kube-apiserver è®¿é—® kubelet API çš„æƒé™"></a>8.11ã€æˆäºˆ kube-apiserver è®¿é—® kubelet API çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰§è¡Œ kubectl execã€runã€logs ç­‰å‘½ä»¤æ—¶ï¼Œapiserver ä¼šå°†è¯·æ±‚è½¬å‘åˆ° kubelet çš„ https ç«¯å£ã€‚è¿™é‡Œå®šä¹‰ RBAC è§„åˆ™ï¼Œæˆæƒ apiserver ä½¿ç”¨çš„è¯ä¹¦ï¼ˆkubernetes.pemï¼‰ç”¨æˆ·åï¼ˆCNï¼škuberntesï¼‰è®¿é—® kubelet API çš„æƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span><br></pre></td></tr></table></figure><h3 id="9ã€éƒ¨ç½²é«˜å¯ç”¨-kube-controller-manager"><a href="#9ã€éƒ¨ç½²é«˜å¯ç”¨-kube-controller-manager" class="headerlink" title="9ã€éƒ¨ç½²é«˜å¯ç”¨ kube-controller-manager"></a>9ã€éƒ¨ç½²é«˜å¯ç”¨ kube-controller-manager</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥é›†ç¾¤åŒ…å« 3 ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨åå°†é€šè¿‡ç«äº‰é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“ leader èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œé˜»å¡çš„èŠ‚ç‚¹å°†å†æ¬¡è¿›è¡Œé€‰ä¸¾äº§ç”Ÿæ–°çš„ leader èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚<br>ä¸ºä¿è¯é€šä¿¡å®‰å…¨ï¼Œæœ¬æ–‡æ¡£å…ˆç”Ÿæˆ x509 è¯ä¹¦å’Œç§é’¥ï¼Œkube-controller-manager åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥è¯ä¹¦ï¼š<br>1ã€ä¸ kube-apiserver çš„å®‰å…¨ç«¯å£é€šä¿¡;<br>2ã€åœ¨å®‰å…¨ç«¯å£(httpsï¼Œ10252) è¾“å‡º prometheus æ ¼å¼çš„ metricsï¼›</p><h4 id="9-1ã€åˆ›å»º-kube-controller-manager-è¯ä¹¦å’Œç§é’¥"><a href="#9-1ã€åˆ›å»º-kube-controller-manager-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="9.1ã€åˆ›å»º kube-controller-manager è¯ä¹¦å’Œç§é’¥"></a>9.1ã€åˆ›å»º kube-controller-manager è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.21.17.30"</span>,</span><br><span class="line">      <span class="string">"172.21.17.31"</span>,</span><br><span class="line">      <span class="string">"172.21.16.110"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>hosts åˆ—è¡¨åŒ…å«æ‰€æœ‰ kube-controller-manager èŠ‚ç‚¹ IPï¼›</p></li><li><p>CN å’Œ O å‡ä¸º system:kube-controller-managerï¼Œkubernetes å†…ç½®çš„ ClusterRoleBindings system:kube-controller-manager èµ‹äºˆ kube-controller-manager å·¥ä½œæ‰€éœ€çš„æƒé™ã€‚</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json   -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span><br><span class="line"><span class="comment"># ls kube-controller-manager*pem</span></span><br><span class="line">kube-controller-manager-key.pem  kube-controller-manager.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-controller-manager*pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="9-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#9-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="9.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>9.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-controller-manager ä½¿ç”¨ kubeconfig æ–‡ä»¶è®¿é—® apiserverï¼Œè¯¥æ–‡ä»¶æä¾›äº† apiserver åœ°å€ã€åµŒå…¥çš„ CA è¯ä¹¦å’Œ kube-controller-manager è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials system:kube-controller-manager \</span></span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context system:kube-controller-manager \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-controller-manager.kubeconfig /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="9-3ã€åˆ›å»º-kube-controller-manager-systemd-unitæ–‡ä»¶"><a href="#9-3ã€åˆ›å»º-kube-controller-manager-systemd-unitæ–‡ä»¶" class="headerlink" title="9.3ã€åˆ›å»º kube-controller-manager systemd unitæ–‡ä»¶"></a>9.3ã€åˆ›å»º kube-controller-manager systemd unitæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-controller-manager.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-controller-manager</span><br><span class="line">ExecStart=/usr/bin/kube-controller-manager \</span><br><span class="line">  --profiling \</span><br><span class="line">  --cluster-name=kubernetes \</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">  --kube-api-qps=1000 \</span><br><span class="line">  --kube-api-burst=2000 \</span><br><span class="line">  --leader-elect \</span><br><span class="line">  --use-service-account-credentials\</span><br><span class="line">  --concurrent-service-syncs=2 \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=10252 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span><br><span class="line">  --port=0 \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">""</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --experimental-cluster-signing-duration=876000h \</span><br><span class="line">  --horizontal-pod-autoscaler-sync-period=10s \</span><br><span class="line">  --horizontal-pod-autoscaler-use-rest-clients=<span class="literal">true</span> \</span><br><span class="line">  --concurrent-deployment-syncs=10 \</span><br><span class="line">  --concurrent-gc-syncs=30 \</span><br><span class="line">  --node-cidr-mask-size=24 \</span><br><span class="line">  --service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">  --pod-eviction-timeout=6m \</span><br><span class="line">  --terminated-pod-gc-threshold=10000 \</span><br><span class="line">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>â€“port=0ï¼šå…³é—­ç›‘å¬éå®‰å…¨ç«¯å£ï¼ˆhttpï¼‰ï¼ŒåŒæ—¶ â€“address å‚æ•°æ— æ•ˆï¼Œâ€“bind-address å‚æ•°æœ‰æ•ˆï¼›</li><li>â€“secure-port=10252ã€â€“bind-address=0.0.0.0: åœ¨æ‰€æœ‰ç½‘ç»œæ¥å£ç›‘å¬ 10252 ç«¯å£çš„ https /metrics è¯·æ±‚ï¼›</li><li>â€“kubeconfigï¼šæŒ‡å®š kubeconfig æ–‡ä»¶è·¯å¾„ï¼Œkube-controller-manager ä½¿ç”¨å®ƒè¿æ¥å’ŒéªŒè¯ kube-apiserverï¼›</li><li>â€“authentication-kubeconfig å’Œ â€“authorization-kubeconfigï¼škube-controller-manager ä½¿ç”¨å®ƒè¿æ¥ apiserverï¼Œå¯¹ client çš„è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚kube-controller-manager ä¸å†ä½¿ç”¨ â€“tls-ca-file å¯¹è¯·æ±‚ https metrics çš„ Client è¯ä¹¦è¿›è¡Œæ ¡éªŒã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™ä¸¤ä¸ª kubeconfig å‚æ•°ï¼Œåˆ™ client è¿æ¥ kube-controller-manager https ç«¯å£çš„è¯·æ±‚ä¼šè¢«æ‹’ç»(æç¤ºæƒé™ä¸è¶³)ã€‚</li><li>â€“cluster-signing-*-fileï¼šç­¾å TLS Bootstrap åˆ›å»ºçš„è¯ä¹¦ï¼›</li><li>â€“experimental-cluster-signing-durationï¼šæŒ‡å®š TLS Bootstrap è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼›</li><li>â€“root-ca-fileï¼šæ”¾ç½®åˆ°å®¹å™¨ ServiceAccount ä¸­çš„ CA è¯ä¹¦ï¼Œç”¨æ¥å¯¹ kube-apiserver çš„è¯ä¹¦è¿›è¡Œæ ¡éªŒï¼›</li><li>â€“service-account-private-key-fileï¼šç­¾å ServiceAccount ä¸­ Token çš„ç§é’¥æ–‡ä»¶ï¼Œå¿…é¡»å’Œ kube-apiserver çš„ â€“service-account-key-file æŒ‡å®šçš„å…¬é’¥æ–‡ä»¶é…å¯¹ä½¿ç”¨ï¼›</li><li>â€“service-cluster-ip-range ï¼šæŒ‡å®š Service Cluster IP ç½‘æ®µï¼Œå¿…é¡»å’Œ kube-apiserver ä¸­çš„åŒåå‚æ•°ä¸€è‡´ï¼›</li><li>â€“leader-elect=trueï¼šé›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œå¯ç”¨é€‰ä¸¾åŠŸèƒ½ï¼›è¢«é€‰ä¸º leader çš„èŠ‚ç‚¹è´Ÿè´£å¤„ç†å·¥ä½œï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ï¼›</li><li>â€“controllers=*,bootstrapsigner,tokencleanerï¼šå¯ç”¨çš„æ§åˆ¶å™¨åˆ—è¡¨ï¼Œtokencleaner ç”¨äºè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ Bootstrap tokenï¼›</li><li>â€“horizontal-pod-autoscaler-*ï¼šcustom metrics ç›¸å…³å‚æ•°ï¼Œæ”¯æŒ autoscaling/v2alpha1ï¼›</li><li>â€“tls-cert-fileã€â€“tls-private-key-fileï¼šä½¿ç”¨ https è¾“å‡º metrics æ—¶ä½¿ç”¨çš„ Server è¯ä¹¦å’Œç§˜é’¥ï¼›</li><li>â€“use-service-account-credentials=true: kube-controller-manager ä¸­å„ controller ä½¿ç”¨ serviceaccount è®¿é—® kube-apiserverï¼›</li></ul><h4 id="9-4ã€å¯åŠ¨-kube-controller-manager-æœåŠ¡"><a href="#9-4ã€å¯åŠ¨-kube-controller-manager-æœåŠ¡" class="headerlink" title="9.4ã€å¯åŠ¨ kube-controller-manager æœåŠ¡"></a>9.4ã€å¯åŠ¨ kube-controller-manager æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-controller-manager</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager &amp;&amp; systemctl status kube-controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # netstat -lnpt | grep kube-cont</span></span><br><span class="line">tcp6       0      0 :::10252                :::*                    LISTEN      8335/kube-controlle</span><br></pre></td></tr></table></figure><h4 id="9-5ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics"><a href="#9-5ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics" class="headerlink" title="9.5ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics"></a>9.5ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics</h4><p><strong>æ³¨æ„:</strong> ä»¥ä¸‹å‘½ä»¤åœ¨ kube-controller-manager èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.17.30:10252/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="9-6-kube-controller-manager-çš„æƒé™"><a href="#9-6-kube-controller-manager-çš„æƒé™" class="headerlink" title="9.6 kube-controller-manager çš„æƒé™"></a>9.6 kube-controller-manager çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusteRole system:kube-controller-manager çš„æƒé™å¾ˆå°ï¼Œåªèƒ½åˆ›å»º secretã€serviceaccount ç­‰èµ„æºå¯¹è±¡ï¼Œå„ controller çš„æƒé™åˆ†æ•£åˆ° ClusterRole system:controller:XXX ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kube-controller-manager</span></span><br><span class="line">Name:         system:kube-controller-manager</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                                  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                                  -----------------  --------------  -----</span><br><span class="line">  secrets                                    []                 []              [create delete get update]</span><br><span class="line">  endpoints                                  []                 []              [create get update]</span><br><span class="line">  serviceaccounts                            []                 []              [create get update]</span><br><span class="line">  events                                     []                 []              [create patch update]</span><br><span class="line">  tokenreviews.authentication.k8s.io         []                 []              [create]</span><br><span class="line">  subjectaccessreviews.authorization.k8s.io  []                 []              [create]</span><br><span class="line">  configmaps                                 []                 []              [get]</span><br><span class="line">  namespaces                                 []                 []              [get]</span><br><span class="line">  *.*                                        []                 []              [list watch]</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éœ€è¦åœ¨ kube-controller-manager çš„å¯åŠ¨å‚æ•°ä¸­æ·»åŠ  â€“use-service-account-credentials=true å‚æ•°ï¼Œè¿™æ · main controller ä¼šä¸ºå„ controller åˆ›å»ºå¯¹åº”çš„ ServiceAccount XXX-controllerã€‚å†…ç½®çš„ ClusterRoleBinding system:controller:XXX å°†èµ‹äºˆå„ XXX-controller ServiceAccount å¯¹åº”çš„ ClusterRole system:controller:XXX æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get clusterrole|grep controller</span></span><br><span class="line">system:controller:attachdetach-controller                              4h52m</span><br><span class="line">system:controller:certificate-controller                               4h52m</span><br><span class="line">system:controller:clusterrole-aggregation-controller                   4h52m</span><br><span class="line">system:controller:cronjob-controller                                   4h52m</span><br><span class="line">system:controller:daemon-set-controller                                4h52m</span><br><span class="line">system:controller:deployment-controller                                4h52m</span><br><span class="line">system:controller:disruption-controller                                4h52m</span><br><span class="line">system:controller:endpoint-controller                                  4h52m</span><br><span class="line">system:controller:expand-controller                                    4h52m</span><br><span class="line">system:controller:generic-garbage-collector                            4h52m</span><br><span class="line">system:controller:horizontal-pod-autoscaler                            4h52m</span><br><span class="line">system:controller:job-controller                                       4h52m</span><br><span class="line">system:controller:namespace-controller                                 4h52m</span><br><span class="line">system:controller:node-controller                                      4h52m</span><br><span class="line">system:controller:persistent-volume-binder                             4h52m</span><br><span class="line">system:controller:pod-garbage-collector                                4h52m</span><br><span class="line">system:controller:pv-protection-controller                             4h52m</span><br><span class="line">system:controller:pvc-protection-controller                            4h52m</span><br><span class="line">system:controller:replicaset-controller                                4h52m</span><br><span class="line">system:controller:replication-controller                               4h52m</span><br><span class="line">system:controller:resourcequota-controller                             4h52m</span><br><span class="line">system:controller:route-controller                                     4h52m</span><br><span class="line">system:controller:service-account-controller                           4h52m</span><br><span class="line">system:controller:service-controller                                   4h52m</span><br><span class="line">system:controller:statefulset-controller                               4h52m</span><br><span class="line">system:controller:ttl-controller                                       4h52m</span><br><span class="line">system:kube-controller-manager                                         4h52m</span><br></pre></td></tr></table></figure><ul><li>ä»¥ deployment controller ä¸ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:controller:deployment-controller</span></span><br><span class="line">Name:         system:controller:deployment-controller</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                          Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                          -----------------  --------------  -----</span><br><span class="line">  replicasets.apps                   []                 []              [create delete get list patch update watch]</span><br><span class="line">  replicasets.extensions             []                 []              [create delete get list patch update watch]</span><br><span class="line">  events                             []                 []              [create patch update]</span><br><span class="line">  pods                               []                 []              [get list update watch]</span><br><span class="line">  deployments.apps                   []                 []              [get list update watch]</span><br><span class="line">  deployments.extensions             []                 []              [get list update watch]</span><br><span class="line">  deployments.apps/finalizers        []                 []              [update]</span><br><span class="line">  deployments.apps/status            []                 []              [update]</span><br><span class="line">  deployments.extensions/finalizers  []                 []              [update]</span><br><span class="line">  deployments.extensions/status      []                 []              [update]</span><br></pre></td></tr></table></figure></li></ul><h4 id="9-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#9-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="9.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>9.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get endpoints kube-controller-manager --namespace=kube-system  -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"k8s-master-01-2.kxl_8890f530-d829-11e9-873f-fa163e5af833","leaseDurationSeconds":15,"acquireTime":"2019-09-16T06:00:15Z","renewTime":"2019-09-16T07:05:38Z","leaderTransitions":1&#125;'</span></span><br><span class="line">  creationTimestamp: <span class="string">"2019-09-16T02:27:06Z"</span></span><br><span class="line">  name: kube-controller-manager</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"25734"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager</span><br><span class="line">  uid: 7a5b872e-d829-11e9-9b67-fa163effd55b</span><br></pre></td></tr></table></figure><p>å½“å‰çš„ leader ä¸ºk8s-master-01-2èŠ‚ç‚¹ã€‚</p><p>æµ‹è¯• kube-controller-manager é›†ç¾¤çš„é«˜å¯ç”¨,åœæ‰ä¸€ä¸ªæˆ–ä¸¤ä¸ªèŠ‚ç‚¹çš„ kube-controller-manager æœåŠ¡ï¼Œè§‚å¯Ÿå…¶å®ƒèŠ‚ç‚¹çš„æ—¥å¿—ï¼Œçœ‹æ˜¯å¦è·å–äº† leader æƒé™ã€‚</p><h3 id="10ã€scheduleré›†ç¾¤"><a href="#10ã€scheduleré›†ç¾¤" class="headerlink" title="10ã€scheduleré›†ç¾¤"></a>10ã€scheduleré›†ç¾¤</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3 ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨åå°†é€šè¿‡ç«äº‰é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“ leader èŠ‚ç‚¹ä¸å¯ç”¨åï¼Œå‰©ä½™èŠ‚ç‚¹å°†å†æ¬¡è¿›è¡Œé€‰ä¸¾äº§ç”Ÿæ–°çš„ leader èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚</p><p>ä¸ºä¿è¯é€šä¿¡å®‰å…¨ï¼Œæœ¬æ–‡æ¡£å…ˆç”Ÿæˆ x509 è¯ä¹¦å’Œç§é’¥ï¼Œkube-scheduler åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥è¯ä¹¦ï¼š<br>1.ä¸ kube-apiserver çš„å®‰å…¨ç«¯å£é€šä¿¡;<br>2.åœ¨å®‰å…¨ç«¯å£(httpsï¼Œ10251) è¾“å‡º prometheus æ ¼å¼çš„ metricsï¼›</p><h4 id="10-1ã€åˆ›å»º-kube-scheduler-è¯ä¹¦å’Œç§é’¥"><a href="#10-1ã€åˆ›å»º-kube-scheduler-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="10.1ã€åˆ›å»º kube-scheduler è¯ä¹¦å’Œç§é’¥"></a>10.1ã€åˆ›å»º kube-scheduler è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.21.17.30"</span>,</span><br><span class="line">      <span class="string">"172.21.17.31"</span>,</span><br><span class="line">      <span class="string">"172.21.16.110"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>hosts åˆ—è¡¨åŒ…å«æ‰€æœ‰ kube-scheduler èŠ‚ç‚¹ IPï¼›</p></li><li><p>CN å’Œ O å‡ä¸º system:kube-schedulerï¼Œkubernetes å†…ç½®çš„ ClusterRoleBindings system:kube-scheduler å°†èµ‹äºˆ kube-scheduler å·¥ä½œæ‰€éœ€çš„æƒé™ï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ls kube-scheduler*pem</span></span><br><span class="line">kube-scheduler-key.pem  kube-scheduler.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler*pem  /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="10-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#10-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="10.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>10.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-scheduler ä½¿ç”¨ kubeconfig æ–‡ä»¶è®¿é—® apiserverï¼Œè¯¥æ–‡ä»¶æä¾›äº† apiserver åœ°å€ã€åµŒå…¥çš„ CA è¯ä¹¦å’Œ kube-scheduler è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials system:kube-scheduler \</span></span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context system:kube-scheduler \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler.kubeconfig /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="10-3ã€åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶"><a href="#10-3ã€åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶" class="headerlink" title="10.3ã€åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶"></a>10.3ã€åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;kube-scheduler.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeSchedulerConfiguration</span><br><span class="line">bindTimeoutSeconds: 600</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-scheduler.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">enableContentionProfiling: <span class="literal">false</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">hardPodAffinitySymmetricWeight: 1</span><br><span class="line">healthzBindAddress: 127.0.0.1:10251</span><br><span class="line">leaderElection:</span><br><span class="line">  leaderElect: <span class="literal">true</span></span><br><span class="line">metricsBindAddress: <span class="comment">##NODE_IP##:10251</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><ul><li>â€“kubeconfigï¼šæŒ‡å®š kubeconfig æ–‡ä»¶è·¯å¾„ï¼Œkube-scheduler ä½¿ç”¨å®ƒè¿æ¥å’ŒéªŒè¯ kube-apiserverï¼›</li><li>â€“leader-elect=trueï¼šé›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œå¯ç”¨é€‰ä¸¾åŠŸèƒ½ï¼›è¢«é€‰ä¸º leader çš„èŠ‚ç‚¹è´Ÿè´£å¤„ç†å·¥ä½œï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ï¼›</li></ul><h4 id="10-4ã€åˆ›å»º-kube-scheduler-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#10-4ã€åˆ›å»º-kube-scheduler-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="10.4ã€åˆ›å»º kube-scheduler systemd unit æ¨¡æ¿æ–‡ä»¶"></a>10.4ã€åˆ›å»º kube-scheduler systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-scheduler.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-scheduler</span><br><span class="line">ExecStart=/usr/bin/kube-scheduler \</span><br><span class="line">  --config=/etc/kubernetes/kube-scheduler.yaml \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=10259 \</span><br><span class="line">  --port=0 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">""</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="10-5ã€å¯åŠ¨-kube-scheduler-æœåŠ¡"><a href="#10-5ã€å¯åŠ¨-kube-scheduler-æœåŠ¡" class="headerlink" title="10.5ã€å¯åŠ¨ kube-scheduler æœåŠ¡"></a>10.5ã€å¯åŠ¨ kube-scheduler æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-scheduler</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler &amp;&amp; systemctl status kube-scheduler</span></span><br></pre></td></tr></table></figure><h4 id="10-6ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics"><a href="#10-6ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics" class="headerlink" title="10.6ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics"></a>10.6ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics</h4><p>kube-scheduler ç›‘å¬ 10251 å’Œ 10251 ç«¯å£ï¼š</p><ul><li>10251ï¼šæ¥æ”¶ http è¯·æ±‚ï¼Œéå®‰å…¨ç«¯å£ï¼Œä¸éœ€è¦è®¤è¯æˆæƒ</li><li>10259ï¼šæ¥æ”¶ https è¯·æ±‚ï¼Œå®‰å…¨ç«¯å£ï¼Œéœ€è¦è®¤è¯æˆæƒ</li></ul><p>ä¸¤ä¸ªæ¥å£éƒ½å¯¹å¤–æä¾› /metrics å’Œ /healthz çš„è®¿é—®ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt |grep kube-sch</span></span><br><span class="line">tcp        0      0 172.21.17.31:10251      0.0.0.0:*               LISTEN      8441/kube-scheduler </span><br><span class="line">tcp6       0      0 :::10259                :::*                    LISTEN      8441/kube-scheduler</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s http://172.21.17.30:10251/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.17.30:10259/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="10-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#10-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="10.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>10.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kubectl get endpoints kube-scheduler --namespace=kube-system  -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"k8s-master-01.kxl_2a6e0bf9-d82b-11e9-b946-fa163effd55b","leaseDurationSeconds":15,"acquireTime":"2019-09-16T06:00:28Z","renewTime":"2019-09-16T07:41:57Z","leaderTransitions":1&#125;'</span></span><br><span class="line">  creationTimestamp: <span class="string">"2019-09-16T02:38:55Z"</span></span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"29215"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-scheduler</span><br><span class="line">  uid: 20a04151-d82b-11e9-baf3-fa163e53d4c8</span><br></pre></td></tr></table></figure><h4 id="10-8-æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€"><a href="#10-8-æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€" class="headerlink" title="10.8 æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€"></a>10.8 æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get endpoints</span></span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   18h</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kuberntes v1.14</tag>
      </tags>
  </entry>
  <entry>
    <title>è·¯ç”±å™¨ç«¯å£æ˜ å°„</title>
    <url>/2019/09/10/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œh3c MSR3620è·¯ç”±å™¨åšç«¯å£æ˜ å°„åˆ°åç«¯æœåŠ¡å™¨,åŒ…å«å•ä¸ªç«¯å£å’Œç«¯å£æ®µçš„æ˜ å°„</p><a id="more"></a><h3 id="å•ä¸ªç«¯å£çš„æ˜ å°„"><a href="#å•ä¸ªç«¯å£çš„æ˜ å°„" class="headerlink" title="å•ä¸ªç«¯å£çš„æ˜ å°„"></a>å•ä¸ªç«¯å£çš„æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[router] interface GigabitEthernet0/2 å…¬ç½‘ipæ¥å£</span><br><span class="line">[router] nat server protocol tcp global å…¬ç½‘ip 80 inside å†…ç½‘ip 80</span><br></pre></td></tr></table></figure><h3 id="å¤šç«¯å£"><a href="#å¤šç«¯å£" class="headerlink" title="å¤šç«¯å£"></a>å¤šç«¯å£</h3><p>vsftpå¯ä»¥ä½¿ç”¨è¿™ä¸ª</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[router] interface GigabitEthernet0/2 å…¬ç½‘ipæ¥å£</span><br><span class="line">[router] nat server protocol tcp global current-interface 9000 9045 inside å†…ç½‘ip 9000 9045</span><br></pre></td></tr></table></figure><p><strong>å¤‡æ³¨:</strong> å¯ä»¥ä½¿ç”¨vsftpåœºæ™¯ï¼Œ<a href="https://xxlaila.github.io/2019/08/09/vsftpd%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">vsftpå®‰è£…</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>MSR3620</tag>
      </tags>
  </entry>
  <entry>
    <title>traefik httpsåº”ç”¨</title>
    <url>/2019/09/06/traefik-https%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰å·²ç»ä½¿ç”¨traefikæœåŠ¡ä½œä¸ºå…¥å£ï¼Œæµ‹è¯•å¹¶è®¿é—®äº†tomcatåº”ç”¨ï¼Œä¹‹å‰æ˜¯é€šè¿‡httpæ¥è®¿é—®çš„ï¼Œè€Œæˆ‘ä»¬åœ¨yamlæ–‡ä»¶é‡Œé¢ä¹Ÿæ·»åŠ 8443ç«¯å£ç”¨äºhttpsè®¿é—®ï¼Œåœ¨å®é™…ç¯å¢ƒä¸­æˆ‘ä»¬ä¹Ÿæ˜¯éœ€è¦httpsæ¥è¿›è¡Œè®¿é—®åº”ç”¨ï¼Œé€šè¿‡traefikå®ç°httpsï¼Œ<a href="https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">traefik httpåº”ç”¨</a></p><h3 id="æ“ä½œå®è·µ"><a href="#æ“ä½œå®è·µ" class="headerlink" title="æ“ä½œå®è·µ"></a>æ“ä½œå®è·µ</h3><ul><li>è¿™é‡Œæˆ‘ç”¨äº†å…¬å¸çš„è¯ä¹¦ï¼Œå°±æ˜¯ä¸ºäº†è´´è¿‘çœŸå®ï¼Œä¹Ÿæ»¡è¶³æµ‹è¯•éœ€æ±‚ï¼Œ</li><li>åˆ›å»ºä¸€ä¸ªsecretï¼Œä¿å­˜httpsè¯ä¹¦</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">1_test.xxlaila.cn_bundle.crt  2_test.xxlaila.cn.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create secret generic traefik-cert --from-file=1_test.xxlaila.cn_bundle.crt --from-file=2_test.xxlaila.cn.key -n kube-system</span></span><br><span class="line">secret/traefik-cert created</span><br></pre></td></tr></table></figure><p>æŠŠè¯ä¹¦æ‹·è´åˆ°k8s nodeèŠ‚ç‚¹ï¼Œå­˜æ”¾è·¯å¾„ä¸º/etc/kubernetes/certsã€‚</p><h3 id="åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®"><a href="#åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®" class="headerlink" title="åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®"></a>åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®</h3><p>traefixä¸­é…ç½®äº†æŠŠæ‰€æœ‰httpè¯·æ±‚å…¨éƒ¨rewriteä¸ºhttpsçš„è§„åˆ™ï¼Œå¹¶é…ç½®ç›¸åº”çš„è¯ä¹¦ä½ç½®</p><ul><li>traefik.toml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_test.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_test.xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line">$ kubectl create configmap traefik-conf --from-file=traefik.toml -n kube-system</span><br><span class="line">configmap/traefik-conf created</span><br></pre></td></tr></table></figure></li></ul><p>æŠŠtraefik.tomlæ–‡ä»¶æ‹·è´åˆ°k8s nodeèŠ‚ç‚¹,å­˜æ”¾è·¯å¾„ä¸º/etc/kubernetes/confã€‚</p><h3 id="é‡æ–°éƒ¨ç½²Traefix"><a href="#é‡æ–°éƒ¨ç½²Traefix" class="headerlink" title="é‡æ–°éƒ¨ç½²Traefix"></a>é‡æ–°éƒ¨ç½²Traefix</h3><p>ä¸»è¦æ˜¯è¦å…³è”åˆ›å»ºçš„secretå’ŒconfigMapï¼Œå¹¶æŒ‚è½½ç›¸å¯¹åº”çš„ä¸»æœºç›®å½•ã€‚</p><ul><li>deployment.yaml</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat deployment.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/certs"</span></span><br><span class="line">          name: <span class="string">"ssl"</span></span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/conf"</span></span><br><span class="line">          name: <span class="string">"config"</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --configFile=/etc/kubernetes/conf/traefik.toml</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f deployment.yaml </span><br><span class="line">deployment.extensions/traefik-ingress-lb configured</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•æ•ˆæœ"><a href="#æµ‹è¯•æ•ˆæœ" class="headerlink" title="æµ‹è¯•æ•ˆæœ"></a>æµ‹è¯•æ•ˆæœ</h3><p>ç™»é™†traefik-uiç•Œé¢,ç”¨åŸæœ¬httpçš„è®¿é—®ï¼Œtraefikä¼šç›´æ¥ç»™æˆ‘ä»¬é‡å®šå‘è‡³httpsã€‚<br><img src="https://img.xxlaila.cn/1567748749337.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºtraefik-uiä½¿ç”¨çš„åŸŸåä¸æ˜¯æˆ‘ä»¬è¯ä¹¦æ‰€æ”¯æŒçš„åŸŸåï¼Œæ‰€ä»¥è¿™é‡Œæç¤ºä¸å®‰å…¨ï¼Œä¿®æ”¹ä¹‹å‰åˆ›å»ºçš„ingressï¼Œä¿®æ”¹å…¶ä¸­çš„åŸŸåä¸ºæ”¯æŒè¯ä¹¦çš„åŸŸå</p><ul><li>traefik-ui.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system </span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8580</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f traefik-ui.yaml </span><br><span class="line">service/traefik-web-ui unchanged</span><br><span class="line">ingress.extensions/traefik-web-ui configured</span><br></pre></td></tr></table></figure></li></ul><p>ä¿®æ”¹hostsç‰ˆå®šçš„åŸŸåè¿›è¡Œè®¿é—®<br><img src="https://img.xxlaila.cn/1567749086159.jpg" alt="img"></p><ul><li><p>ä¿®æ”¹ä¹‹å‰éƒ¨ç½²çš„tomcatç¨‹åº</p></li><li><p>ingress-tomcat.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /test1/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line">      - path: /test2/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ingress-tomcat.yaml </span><br><span class="line">ingress.extensions/tomcat-test-web configured</span><br></pre></td></tr></table></figure></li></ul><p>è®¿é—®é“¾æ¥æµ‹è¯•<br><img src="https://img.xxlaila.cn/1567749278980.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567749309772.jpg" alt="img"></p><h3 id="å…¶ä»–éœ€æ±‚"><a href="#å…¶ä»–éœ€æ±‚" class="headerlink" title="å…¶ä»–éœ€æ±‚"></a>å…¶ä»–éœ€æ±‚</h3><p>åœ¨æˆ‘ä»¬çœŸå®çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œéœ€æ±‚è‚¯å®šæœ‰ä¸åŒçš„ï¼Œæ¯”å¦‚æˆ‘æ‰€åœ¨çš„å…¬å¸å¼€å‘ç¯å¢ƒå°±è¦åªæ˜¯httpå’Œhttpsï¼Œæµ‹è¯•ç¯å¢ƒä»¥ä¸Šçš„å°±å…¨éƒ¨å¼ºåˆ¶httpsã€‚è¿™å°±å¾—åˆ†å¼€è¿›è¡Œé…ç½®</p><h4 id="åŒæ—¶æ”¯æŒhttpå’Œhttps"><a href="#åŒæ—¶æ”¯æŒhttpå’Œhttps" class="headerlink" title="åŒæ—¶æ”¯æŒhttpå’Œhttps"></a>åŒæ—¶æ”¯æŒhttpå’Œhttps</h4><p>æŠŠhttpä¸­çš„rewriteä»£ç æ”¹æ‰</p><ul><li>traefik.toml</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_test.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_test.xxlaila.cn.key"</span></span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_dev.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_dev.xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line">[file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># rules</span></span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">      regex = <span class="string">"^http://traefix.test.xxlaila.cn/(.*)"</span></span><br><span class="line">      replacement = <span class="string">"https://traefix.test.xxlaila.cn/<span class="variable">$1</span>"</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>traefik ingressä½¿ç”¨</title>
    <url>/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="Traefikä»‹ç»"><a href="#Traefikä»‹ç»" class="headerlink" title="Traefikä»‹ç»"></a>Traefikä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç®€å•çš„è¯´ï¼Œingresså°±æ˜¯ä»kubernetesé›†ç¾¤å¤–è®¿é—®é›†ç¾¤çš„å…¥å£ï¼Œå°†ç”¨æˆ·çš„URLè¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„serviceä¸Šã€‚Ingressç›¸å½“äºnginxã€apacheç­‰è´Ÿè½½å‡è¡¡åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬è§„åˆ™å®šä¹‰ï¼Œå³URLçš„è·¯ç”±ä¿¡æ¯ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traefikæ˜¯ä¸€æ¬¾å¼€æºçš„åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å·¥å…·ã€‚å®ƒæœ€å¤§çš„ä¼˜ç‚¹æ˜¯èƒ½å¤Ÿä¸å¸¸è§çš„å¾®æœåŠ¡ç³»ç»Ÿç›´æ¥æ•´åˆï¼Œå®ç°è‡ªåŠ¨åŒ–åŠ¨æ€é…ç½®ã€‚Traefiké€šè¿‡ä¸æ–­åœ°è·Ÿ kubernetes API æ‰“äº¤é“ï¼Œå®æ—¶çš„æ„ŸçŸ¥åç«¯ serviceã€pod ç­‰å˜åŒ–ï¼Œæ¯”å¦‚podï¼Œservice å¢åŠ ä¸å‡å°‘ç­‰ï¼›å½“å¾—åˆ°è¿™äº›å˜åŒ–ä¿¡æ¯åï¼ŒIngressè‡ªåŠ¨æ›´æ–°é…ç½®å¹¶çƒ­é‡è½½ ï¼Œè¾¾åˆ°æœåŠ¡å‘ç°çš„ä½œç”¨ã€‚</p><a id="more"></a><p>traefix æ•´ä½“æ¶æ„å›¾å¦‚ä¸‹:<br><img src="https://img.xxlaila.cn/34238937snkhfskdy8923.png" alt="img"></p><h3 id="Traefikä¸»è¦ç‰¹æ€§è¯¦è§£"><a href="#Traefikä¸»è¦ç‰¹æ€§è¯¦è§£" class="headerlink" title="Traefikä¸»è¦ç‰¹æ€§è¯¦è§£"></a>Traefikä¸»è¦ç‰¹æ€§è¯¦è§£</h3><ul><li><p>è‡ªåŠ¨ç†”æ–­</p><ul><li>åœ¨é›†ç¾¤ä¸­ï¼Œå½“æŸä¸€ä¸ªæœåŠ¡å¤§é‡å‡ºç°è¯·æ±‚é”™è¯¯ï¼Œæˆ–è€…è¯·æ±‚å“åº”æ—¶é—´è¿‡ä¹…ï¼Œæˆ–è€…è¿”å›500+é”™è¯¯çŠ¶æ€ç æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥ä¸»åŠ¨å‰”é™¤è¯¥æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸åœ¨å°†è¯·æ±‚è½¬å‘åˆ°è¯¥æœåŠ¡ä¸Šï¼Œè€Œè¿™ä¸€ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦äººå·¥æ‰§è¡Œã€‚Traefik é€šè¿‡é…ç½®å¾ˆå®¹æ˜“å°±èƒ½å¸®æˆ‘ä»¬å®ç°ï¼ŒTraefik å¯ä»¥é€šè¿‡å®šä¹‰ç­–ç•¥æ¥ä¸»åŠ¨ç†”æ–­æœåŠ¡ã€‚</li><li>NetworkErrorRatio() &gt; 0.5ï¼šç›‘æµ‹æœåŠ¡é”™è¯¯ç‡è¾¾åˆ°50%æ—¶ï¼Œç†”æ–­</li><li>LatencyAtQuantileMS(50.0) &gt; 50ï¼šç›‘æµ‹å»¶æ—¶å¤§äº50msæ—¶ï¼Œç†”æ–­</li><li>ResponseCodeRatio(500, 600, 0, 600) &gt; 0.5ï¼šç›‘æµ‹è¿”å›çŠ¶æ€ç ä¸º[500-600]åœ¨[0-600]åŒºé—´å æ¯”è¶…è¿‡50%æ—¶ï¼Œç†”æ–­</li></ul></li><li><p>è´Ÿè½½å‡è¡¡ç­–ç•¥</p><ul><li>Traefik æä¾›ä¸¤ç§è´Ÿè½½å‡è¡¡ç­–ç•¥æ”¯æŒã€‚ä¸€ç§æ˜¯ wrrï¼ˆåŠ æƒè½®è®­è°ƒåº¦ç®—æ³•ï¼‰ï¼Œä¸€ç§æ˜¯ drrï¼ˆåŠ¨æ€åŠ æƒå¾ªç¯è°ƒåº¦ç®—æ³•ï¼‰</li><li>wrræ˜¯é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œæ–°åˆ›å»ºçš„ service æƒé‡éƒ½æ˜¯ä¸€æ ·ä¸º1ï¼Œè¿™æ ·çš„è¯ï¼Œè¯·æ±‚ä¼šå¹³å‡åˆ†ç»™æ¯ä¸ªæœåŠ¡ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå¤šæ—¶å€™ä¼šå‡ºç°èµ„æºåˆ†é…ä¸å‡è¡¡çš„é—®é¢˜ï¼Œæ¯”å¦‚ç”±äºé›†ç¾¤ä¸­æ¯ä¸ªæœºå™¨é…ç½®ä¸ä¸€æ ·ï¼Œè€Œä¸”æœåŠ¡æ¶ˆè€—ä¸ä¸€æ ·ï¼Œå‡è®¾ A èµ„æºä½¿ç”¨ç‡å·²ç»å¾ˆé«˜ï¼Œè€Œ B å±äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœè¿˜æ˜¯å‡æ‘Šåˆ°æ¯ä¸ªæœåŠ¡çš„è¯ï¼Œä¼šåŠ é‡ A çš„è´Ÿè·ï¼Œè¿™æ—¶å€™å› è¯¥æœ‰ä¸€ç§ç­–ç•¥èƒ½å¤Ÿä¸»åŠ¨è¯†åˆ«å¹¶åˆ†æ‹…æ›´å¤šæµé‡åˆ° B æ‰å¯¹</li><li>drr å°±æ›´åŠ æ™ºèƒ½ï¼Œå®ƒæ˜¯ä¸€ç§åŠ¨æ€åŠ æƒè½®è®­è°ƒåº¦æ–¹å¼ï¼Œå®ƒä¼šè®°å½•ä¸€æ®µæ—¶é—´å†…è½¬å‘åˆ° A çš„è¯·æ±‚æ•°ï¼Œè·Ÿè½¬å‘åˆ° B çš„è¯·æ±‚æ•°å¯¹æ¯”ï¼Œè½¬å‘æ•°é‡å¤šï¼Œè¯´æ˜å¤„ç†é€Ÿåº¦å¿«ï¼Œå“åº”æ—¶é—´å¿«ã€‚å¦‚æœ A å¤„ç†è¯·æ±‚é€Ÿåº¦æ¯” B å¿«ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒæ•´ A çš„æƒé‡ï¼Œæ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ï¼Œå°±ä¼šè½¬å‘æ›´å¤šè¯·æ±‚ç»™ Aï¼Œç›¸åº”çš„ B çš„è½¬å‘å°±å°‘ä¸€äº›ã€‚æ•´ä¸ªè¿‡ç¨‹éƒ½åœ¨ä¸æ–­çš„è°ƒæ•´æƒé‡ï¼Œå®ç°è¯·æ±‚çš„åˆç†åˆ†é…ï¼Œä»è€Œè¾¾åˆ°èµ„æºä½¿ç”¨æœ€å¤§åŒ–</li></ul></li></ul><h3 id="éƒ¨ç½²Traefik-ingress"><a href="#éƒ¨ç½²Traefik-ingress" class="headerlink" title="éƒ¨ç½²Traefik ingress"></a>éƒ¨ç½²Traefik ingress</h3><ul><li><p>åˆ›å»ºingress-rbac.yamlï¼Œå°†ç”¨äºservice accountéªŒè¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat ingress-rbac.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: ingress</span><br><span class="line">    namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºDepeloymentéƒ¨ç½²traefikï¼Œå¦‚æ–‡ä»¶åä¸ºdeployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>æ³¨æ„</strong>: æˆ‘ä»¬è¿™é‡Œç”¨çš„æ˜¯Deployç±»å‹ï¼Œæ²¡æœ‰é™å®šè¯¥podè¿è¡Œåœ¨å“ªä¸ªä¸»æœºä¸Šã€‚Traefikçš„ç«¯å£æ˜¯8580ã€‚</li></ul><ul><li>ç¼–å†™Traefik UIçš„ingresséƒ¨ç½²æ–‡ä»¶ï¼Œå¦‚æ–‡ä»¶åä¸ºtraefik-ui.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system <span class="comment">#å¢åŠ è¡Œ</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8580</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><ul><li><code>backend</code>ä¸­è¦é…ç½®default namespaceä¸­å¯åŠ¨çš„serviceåå­—ã€‚</li><li><code>path</code>å°±æ˜¯URLåœ°å€åçš„è·¯å¾„ï¼Œå¦‚<code>traefik.frontend.io/path</code>ï¼Œserviceå°†ä¼šæ¥å—pathè¿™ä¸ªè·¯å¾„</li><li><code>host</code>æœ€å¥½ä½¿ç”¨service-name.filed1.filed2.domain-nameè¿™ç§ç±»ä¼¼ä¸»æœºåç§°çš„å‘½åæ–¹å¼ï¼Œæ–¹ä¾¿åŒºåˆ†æœåŠ¡ã€‚</li></ul><ul><li><strong>é€¼é€¼ä¸€ä¸‹</strong>: ç›®å‰æˆ‘æ‰€åœ¨çš„å…¬å¸åç«¯å¾®æœåŠ¡100+ï¼Œå‰ç«¯60+ï¼Œå¦‚æœç”¨ä¼ ç»Ÿnginxçš„localæ¥åŒ¹é…ï¼Œä¼°è®¡è¦å†™æ­»äººï¼Œè€Œä¸”å¯¹äºè¿ç»´è‡ªåŠ¨åŒ–æ¥ä¹Ÿä¸æ˜¯å¾ˆå¥½åšï¼Œå†åˆ™æ˜¯å‡ºäº†é—®é¢˜ä¹Ÿè¿˜è¦å»çœ‹ä¸€ä¸‹æ˜¯å“ªä¸ªåº”ç”¨ï¼›æˆ‘ä»¬ç›®å‰æ˜¯é€šè¿‡æ¯ä¸ªæœåŠ¡æ¯ä¸€ä¸ªåŸŸåï¼ŒåŸŸåæ˜¯æ ¹æ®æœåŠ¡åæ¥è‡ªåŠ¨ç”Ÿæˆï¼Œé™¤äº†å‡ ä¸ªç‰¹å®šå¯¹å¤–å…¬å¼€çš„æ˜¯ç‰¹åˆ¶çš„åŸŸåï¼Œå…¶ä»–çš„å‡é‡‡ç”¨è¿™ç§æœºåˆ¶ï¼Œå½“æœ‰é—®é¢˜çš„æ—¶å€™ï¼Œä¸€ä¸‹å°±èƒ½åˆ¤æ–­å‡ºé‚£é‡Œå‡ºé—®é¢˜ï¼Œå¾ˆå¥½å®šä½ï¼Œæœ‰åŸŸåæœ‰ç‰¹æ®Šé…ç½®çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å•ç‹¬çš„è¿›è¡Œè®¾ç½®ï¼Œä½†æ˜¯æˆªæ­¢ç›®å‰ä¸¤å¹´å¤šæ¥ï¼Œè¿ç»´æ‹’ç»è¿™ç§ç‰¹æ®Šéœ€æ±‚(æœ‰è¿˜æœ‰ï¼Œå¾ˆå°‘ï¼Œåªæœ‰é‚£ä¹ˆä¸¤ä¸‰ä¸ª)</li></ul><ul><li><p>é…ç½®å®Œæˆåå°±å¯ä»¥å¯åŠ¨treafik ingressäº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line">deployment.extensions/traefik-ingress-lb created</span><br><span class="line">serviceaccount/ingress created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/ingress created</span><br><span class="line">service/traefik-web-ui created</span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system | grep traefik</span></span><br><span class="line"></span><br><span class="line">traefik-ingress-lb-5d7f658cfd-4vkjc     1/1     Running   0          29m</span><br><span class="line">traefik-ingress-lb-5d7f658cfd-7sszp     1/1     Running   0          19m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get ingress -o wide --all-namespaces </span></span><br><span class="line">NAMESPACE     NAME                HOSTS                ADDRESS   PORTS   AGE</span><br><span class="line">kube-system   traefik-web-ui      traefik.xxlaila.io             80      29m</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨æµè§ˆå™¨ç»‘å®šhostsåŸŸåè§£æï¼Œnodeçš„ipåœ°å€ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥traefik.xxlaila.ioå³å¯è®¿é—®äº†<br><img src="https://img.xxlaila.cn/1567676343800.jpg" alt="img"></p><p>å·¦ä¾§è“è‰²éƒ¨åˆ†åˆ—å‡ºçš„æ˜¯æ‰€æœ‰çš„å‰ç«¯(frontends)ï¼Œå³ä¾§ç»¿è‰²éƒ¨åˆ†æ˜¯æ‰€æœ‰çš„åç«¯(backend)ã€‚</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ä¸‹é¢æ¨¡æ‹Ÿéƒ¨ç½²ä¸€ä¸ªç¨‹åºï¼Œä»¥Nginx ä¸ºä¾‹ï¼Œå¹¶ä½¿ç”¨drråŠ¨æ€è½®è®­åŠ æƒç­–ç•¥ã€‚</p><ul><li><p>nginx-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.15.5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-service</span><br><span class="line">  annotations:</span><br><span class="line">    traefik.ingress.kubernetes.io/load-balancer-method: drr</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx-service</span><br><span class="line">        namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-pod</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: k8s.nginx.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx-service</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºnginx</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f nginx-deployment.yaml </span></span><br><span class="line">deployment.apps/nginx-pod created</span><br><span class="line">service/nginx-service created</span><br><span class="line">ingress.extensions/nginx-ingress created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰€æœ‰è®¿é—®è¿™äº›åœ°å€çš„æµé‡éƒ½ä¼šå‘é€ç»™172.16.0.180è¿™å°ä¸»æœºï¼Œå°±æ˜¯æˆ‘ä»¬å¯åŠ¨traefikçš„ä¸»æœºã€‚Traefikä¼šè§£æhttpè¯·æ±‚headeré‡Œçš„Hostå‚æ•°å°†æµé‡è½¬å‘ç»™Ingressé…ç½®é‡Œçš„ç›¸åº”serviceã€‚<br><img src="https://img.xxlaila.cn/1567676984150.jpg" alt="img"></p><p>å®¢æˆ·ç«¯ç»‘å®šhostï¼Œæµè§ˆå™¨è¿›è¡Œè®¿é—®: <a href="http://k8s.nginx.com" target="_blank" rel="noopener">http://k8s.nginx.com</a><br><img src="https://img.xxlaila.cn/1567677018297.jpg" alt="img"></p><p>åœ¨K8sé›†ç¾¤èŠ‚ç‚¹ä¸Šè®¿é—®æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -x 172.21.16.204 http://k8s.nginx.com</span></span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;503 Service Unavailable&lt;/h1&gt;</span><br><span class="line">No server is available to handle this request.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line">[root@k8s ~]<span class="comment"># curl -x 172.21.16.204:80 http://k8s.nginx.com</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h4 id="ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨"><a href="#ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨" class="headerlink" title="ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨"></a>ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¸æƒ³é…ç½®å¤ªå¤šçš„åŸŸåæ¥åŒºåˆ«åº”ç”¨ï¼Œä½¿ç”¨åŒåŸŸååˆ†è·¯å¾„çš„æ–¹å¼æ¥åŒºåˆ«åº”ç”¨å°±ç®€æ´æ–¹ä¾¿å¾ˆå¤šã€‚ingressä¹Ÿæä¾›äº†ç›¸å…³çš„é…ç½®ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‡è®¾ä¸¤ä¸ªåº”ç”¨tomcat-test1å’Œtomcat-test2ã€‚è¿™é‡Œå¯é…ç½®åŸŸåtomcat.xxlaila.ioï¼Œé€šè¿‡è·¯å¾„test1ã€test2æ¥åˆ†åˆ«ä»£ç†ä¸¤ä¸ªtomcatåº”ç”¨ã€‚å…¶ä¸­ï¼Œåˆ†è·¯å¾„é…ç½®éœ€æ·»åŠ é…ç½®ï¼štraefik.frontend.rule.type: PathPrefixStrip,é¦–å…ˆï¼Œæˆ‘å…ˆåˆ›å»ºtomcat-test1å’Œtomcat-test2çš„podå’Œserviceï¼Œå…¶ä¸­8080ä¸ºtomcatçš„httpç«¯å£ï¼Œ8443ä¸ºtomcatçš„httpsç«¯å£ï¼Œæœ¬ä¾‹ä¸­ä»…ä½¿ç”¨httpç«¯å£æµ‹è¯•ã€‚</p><ul><li><p>tomcat-test1.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1</span><br><span class="line">  labels: </span><br><span class="line">    app: tomcat-test1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1 </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-test1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-test1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-test1</span><br><span class="line">        image: tomcat</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1</span><br><span class="line">  labels:</span><br><span class="line">    name: tomcat-test1</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8443</span><br><span class="line">    targetPort: 8443</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test1</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080 </span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test1</span><br></pre></td></tr></table></figure></li><li><p>tomcat-test2.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test2</span><br><span class="line">  labels: </span><br><span class="line">    app: tomcat-test2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1 </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-test2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-test2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-test2</span><br><span class="line">        image: manjeetchauhan211/tomcat_test2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test2</span><br><span class="line">  labels:</span><br><span class="line">    name: tomcat-test2</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8443</span><br><span class="line">    targetPort: 8443</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080 </span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test2</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"></span><br><span class="line">$ kubectl get deployment</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-pod      2/2     2            2           17h</span><br><span class="line">tomcat-test1   1/1     1            1           42m</span><br><span class="line">tomcat-test2   1/1     1            1           42m</span><br><span class="line"></span><br><span class="line">$ kubectl get svc</span><br><span class="line">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kubernetes       ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP    5d23h</span><br><span class="line">nginx-service    ClusterIP   10.254.149.69    &lt;none&gt;        80/TCP     17h</span><br><span class="line">tomcat-test1     ClusterIP   10.254.195.108   &lt;none&gt;        8080/TCP   42m</span><br><span class="line">tomcat-test2     ClusterIP   10.254.6.88      &lt;none&gt;        8080/TCP   42m</span><br><span class="line">traefik-web-ui   ClusterIP   10.254.22.102    &lt;none&gt;        80/TCP     17h</span><br></pre></td></tr></table></figure></li></ul><p>åˆ›å»ºtest1çš„ingressï¼Œæ¥å‘å¸ƒtomcat-test1æœåŠ¡</p><ul><li>ingress-tomcat1.yam<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat ingress-tomcat1.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f ingress-tomcat.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>åœ¨traefix-uiç•Œé¢ä¸Šï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æœ‰äº†ä¸€ä¸ª<code>tomcat.xxlaila.io</code>çš„åŸŸåè§„åˆ™.<br><img src="https://img.xxlaila.cn/1567739051461.jpg" alt="img"></p><p>åœ¨hostsæ–‡ä»¶æ·»åŠ tomcat.xxlaila.ioç»‘å®šæ¥è¿›è¡Œè®¿é—®<br><img src="https://img.xxlaila.cn/1567739162707.jpg" alt="img"></p><h5 id="ingressé…ç½®åŒåŸŸåå¯¹åº”location"><a href="#ingressé…ç½®åŒåŸŸåå¯¹åº”location" class="headerlink" title="ingressé…ç½®åŒåŸŸåå¯¹åº”location"></a>ingressé…ç½®åŒåŸŸåå¯¹åº”location</h5><ul><li><p>ingress-tomcat.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /test1/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line">      - path: /test2/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test2</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºå¹¶æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f ingress-tomcat.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl describe ingress tomcat-test-web</span><br><span class="line">Name:             tomcat-test-web</span><br><span class="line">Namespace:        default</span><br><span class="line">Address:          </span><br><span class="line">Default backend:  default-http-backend:80 (&lt;none&gt;)</span><br><span class="line">Rules:</span><br><span class="line">  Host               Path  Backends</span><br><span class="line">  ----               ----  --------</span><br><span class="line">  tomcat.xxlaila.io  </span><br><span class="line">                     /test1/   tomcat-test1:8080 (&lt;none&gt;)</span><br><span class="line">                     /test2/   tomcat-test2:8080 (&lt;none&gt;)</span><br><span class="line">Annotations:</span><br><span class="line">  traefik.frontend.rule.type:                        PathPrefixStrip</span><br><span class="line">  kubectl.kubernetes.io/last-applied-configuration:  &#123;<span class="string">"apiVersion"</span>:<span class="string">"extensions/v1beta1"</span>,<span class="string">"kind"</span>:<span class="string">"Ingress"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;<span class="string">"kubernetes.io/ingress.class"</span>:<span class="string">"traefik"</span>,<span class="string">"traefik.frontend.rule.type"</span>:<span class="string">"PathPrefixStrip"</span>&#125;,<span class="string">"name"</span>:<span class="string">"tomcat-test-web"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"rules"</span>:[&#123;<span class="string">"host"</span>:<span class="string">"tomcat.xxlaila.io"</span>,<span class="string">"http"</span>:&#123;<span class="string">"paths"</span>:[&#123;<span class="string">"backend"</span>:&#123;<span class="string">"serviceName"</span>:<span class="string">"tomcat-test1"</span>,<span class="string">"servicePort"</span>:8080&#125;,<span class="string">"path"</span>:<span class="string">"/test1/"</span>&#125;,&#123;<span class="string">"backend"</span>:&#123;<span class="string">"serviceName"</span>:<span class="string">"tomcat-test2"</span>,<span class="string">"servicePort"</span>:8080&#125;,<span class="string">"path"</span>:<span class="string">"/test2/"</span>&#125;]&#125;&#125;]&#125;&#125;</span><br><span class="line"></span><br><span class="line">  kubernetes.io/ingress.class:  traefik</span><br><span class="line">Events:                         &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç»™èŠ‚ç‚¹è®¾ç½®label"><a href="#ç»™èŠ‚ç‚¹è®¾ç½®label" class="headerlink" title="ç»™èŠ‚ç‚¹è®¾ç½®label"></a>ç»™èŠ‚ç‚¹è®¾ç½®label</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºæ˜¯ Kubernetes DeamonSet è¿™ç§æ–¹å¼éƒ¨ç½² Traefikï¼Œæ‰€ä»¥éœ€è¦æå‰ç»™èŠ‚ç‚¹è®¾ç½® Labelï¼Œè¿™æ ·å½“ç¨‹åºéƒ¨ç½²æ—¶ Pod ä¼šè‡ªåŠ¨è°ƒåº¦åˆ°è®¾ç½® Label çš„ç‚¹ä¸Šã€‚</p><h4 id="èŠ‚ç‚¹è®¾ç½®-Label-æ ‡ç­¾"><a href="#èŠ‚ç‚¹è®¾ç½®-Label-æ ‡ç­¾" class="headerlink" title="èŠ‚ç‚¹è®¾ç½® Label æ ‡ç­¾"></a>èŠ‚ç‚¹è®¾ç½® Label æ ‡ç­¾</h4><ul><li>æ ¼å¼ï¼škubectl label nodes [èŠ‚ç‚¹å] [key=value]<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> kubectl get nodes</span><br><span class="line">NAME            STATUS   ROLES    AGE    VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   7d5h   v1.13.3</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   7d2h   v1.13.3</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   7d2h   v1.13.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl label nodes 172.21.16.204 IngressProxy=true</span></span><br><span class="line">node/172.21.16.204 labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹labelè®¾ç½®æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment"># kubectl get nodes --show-labels</span></span><br><span class="line">NAME            STATUS   ROLES    AGE    VERSION   LABELS</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   7d5h   v1.13.3   IngressProxy=<span class="literal">true</span>,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.204,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   7d2h   v1.13.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.240,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   7d2h   v1.13.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.87,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶"><a href="#ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶"></a>ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat deployment.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ssl</span><br><span class="line">        secret:</span><br><span class="line">          secretName: traefik-cert</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: traefik-conf</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/certs"</span></span><br><span class="line">          name: <span class="string">"ssl"</span></span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/conf"</span></span><br><span class="line">          name: <span class="string">"config"</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --configFile=/etc/kubernetes/conf/traefik.toml</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br><span class="line">      nodeSelector:</span><br><span class="line">        IngressProxy: <span class="string">"true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œéƒ¨ç½²å³å¯</span></span><br></pre></td></tr></table></figure><ul><li>traefix-uiç•Œé¢ä¸Šå¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1567739737385.jpg" alt="img"></li></ul><p>ä»describeä¿¡æ¯å’Œuiç•Œé¢ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œtomcat.test.k8såˆ†åˆ«æœ‰äº†/test1/å’Œ/test2/çš„åŸŸåä»£ç†ä»¥åŠç›¸å¯¹åº”çš„åç«¯<br><img src="https://img.xxlaila.cn/1567739822127.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567739856570.jpg" alt="img"></p><p><a href="https://xuchao918.github.io/2019/03/01/Kubernetes-traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®2</a><br><a href="https://blog.51cto.com/icenycmh/2124502" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®1</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s-helm</title>
    <url>/2019/09/04/k8s-helm/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helmç±»ä¼¼ä¸linuxä¸‹é¢çš„yumï¼ŒHelmæ˜¯ä¸€ä¸ªç”¨äºkubernetesçš„åŒ…ç®¡ç†å™¨ï¼Œæ¯ä¸€ä¸ªåŒ…ä¸ºä¸€ä¸ªchartï¼Œä¸€ä¸ªchartæ˜¯ä¸€ä¸ªç›®å½•ï¼Œå¸¸å¸¸ä¼šå¯¹ç›®å½•è¿›è¡Œæ‰“åŒ…å‹ç¼©ï¼Œå½¢æˆä¸€ä¸ª${name}-version.tgzçš„æ ¼å¼è¿›è¡Œä¼ è¾“å’Œå­˜å‚¨ã€‚</p><ul><li>å¯¹äºåº”ç”¨å‘å¸ƒè€…è€Œè¨€ï¼Œå¯ä»¥é€šè¿‡Helmæ‰“åŒ…åº”ç”¨ï¼Œç®¡ç†åº”ç”¨ä¾èµ–å…³ç³»ï¼Œç®¡ç†åº”ç”¨ç‰ˆæœ¬å¹¶å‘å¸ƒåº”ç”¨åˆ°è½¯ä»¶ä»“åº“ã€‚</li><li>å¯¹äºä½¿ç”¨è€…è€Œè¨€ï¼Œä½¿ç”¨Helmåä¸ç”¨éœ€è¦äº†è§£Kubernetesçš„Yamlè¯­æ³•å¹¶ç¼–å†™åº”ç”¨éƒ¨ç½²æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡Helmä¸‹è½½å¹¶åœ¨kubernetesä¸Šå®‰è£…éœ€è¦çš„åº”ç”¨ã€‚</li></ul><p>Helmè¿˜æä¾›äº†kubernetesä¸Šçš„è½¯ä»¶éƒ¨ç½²ï¼Œåˆ é™¤ï¼Œå‡çº§ï¼Œå›æ»šåº”ç”¨çš„å¼ºå¤§åŠŸèƒ½</p><a id="more"></a><h3 id="1ã€helmç»„ä»¶"><a href="#1ã€helmç»„ä»¶" class="headerlink" title="1ã€helmç»„ä»¶"></a>1ã€helmç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œä¸‹çš„å®¢æˆ·ç«¯å·¥å…·ã€‚ä¸»è¦ç”¨äº Kubernetes åº”ç”¨ç¨‹åº Chart çš„åˆ›å»ºã€æ‰“åŒ…ã€å‘å¸ƒä»¥åŠåˆ›å»ºå’Œç®¡ç†æœ¬åœ°å’Œè¿œç¨‹çš„ Chart ä»“åº“ã€‚</p><h4 id="1-1ã€Tiller"><a href="#1-1ã€Tiller" class="headerlink" title="1.1ã€Tiller"></a>1.1ã€Tiller</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tiller æ˜¯ Helm çš„æœåŠ¡ç«¯ï¼Œéƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­ã€‚Tiller ç”¨äºæ¥æ”¶ Helm çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ® Chart ç”Ÿæˆ Kubernetes çš„éƒ¨ç½²æ–‡ä»¶ï¼ˆ Helm ç§°ä¸º Release ï¼‰ï¼Œç„¶åæäº¤ç»™ Kubernetes åˆ›å»ºåº”ç”¨ã€‚Tiller è¿˜æä¾›äº† Release çš„å‡çº§ã€åˆ é™¤ã€å›æ»šç­‰ä¸€ç³»åˆ—åŠŸèƒ½ã€‚</p><h4 id="1-2ã€Chart"><a href="#1-2ã€Chart" class="headerlink" title="1.2ã€Chart"></a>1.2ã€Chart</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm çš„è½¯ä»¶åŒ…ï¼Œé‡‡ç”¨ TAR æ ¼å¼ã€‚ç±»ä¼¼äº APT çš„ DEB åŒ…æˆ–è€… YUM çš„ RPM åŒ…ï¼Œå…¶åŒ…å«äº†ä¸€ç»„å®šä¹‰ Kubernetes èµ„æºç›¸å…³çš„ YAML æ–‡ä»¶</p><h4 id="1-3ã€Repoistory"><a href="#1-3ã€Repoistory" class="headerlink" title="1.3ã€Repoistory"></a>1.3ã€Repoistory</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm çš„è½¯ä»¶ä»“åº“ï¼ŒRepository æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨ä¿å­˜äº†ä¸€ç³»åˆ—çš„ Chart è½¯ä»¶åŒ…ä»¥ä¾›ç”¨æˆ·ä¸‹è½½ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªè¯¥ Repository çš„ Chart åŒ…çš„æ¸…å•æ–‡ä»¶ä»¥ä¾›æŸ¥è¯¢ã€‚Helm å¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ªä¸åŒçš„ Repository</p><h4 id="1-4ã€Release"><a href="#1-4ã€Release" class="headerlink" title="1.4ã€Release"></a>1.4ã€Release</h4><p>ä½¿ç”¨ helm install å‘½ä»¤åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²çš„ Chart ç§°ä¸º Release</p><h3 id="2ã€helmå®‰è£…"><a href="#2ã€helmå®‰è£…" class="headerlink" title="2ã€helmå®‰è£…"></a>2ã€helmå®‰è£…</h3><ul><li>ä¸‹è½½helm<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://storage.googleapis.com/kubernetes-helm/helm-v2.14.3-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf helm-v2.14.3-linux-amd64.tar.gz &amp;&amp; mv linux-amd64/&#123;helm,tiller&#125; /usr/bin</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·"><a href="#2-1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·" class="headerlink" title="2.1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·"></a>2.1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount tiller --namespace kube-system</span></span><br><span class="line">serviceaccount/tiller created</span><br></pre></td></tr></table></figure><h4 id="2-2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"><a href="#2-2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²" class="headerlink" title="2.2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"></a>2.2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create clusterrolebinding tiller-admin-binding --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/tiller-admin-binding created</span><br></pre></td></tr></table></figure><h4 id="2-2ã€å®‰è£…tiller"><a href="#2-2ã€å®‰è£…tiller" class="headerlink" title="2.2ã€å®‰è£…tiller"></a>2.2ã€å®‰è£…tiller</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm init --service-account tiller --upgrade -i docker.io/sapcc/tiller:v2.14.3 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span><br></pre></td></tr></table></figure><h5 id="2-2-1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ"><a href="#2-2-1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ" class="headerlink" title="2.2.1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ"></a>2.2.1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods|grep tiller</span></span><br><span class="line">tiller-deploy-75b8f8575d-fplck          1/1     Running   0          17h</span><br><span class="line"></span><br><span class="line"><span class="comment"># helm version</span></span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.3"</span>, GitCommit:<span class="string">"0e7f3b6637f7af8fcfddb3d2941fcc7cbebb0085"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.3"</span>, GitCommit:<span class="string">"0e7f3b6637f7af8fcfddb3d2941fcc7cbebb0085"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é”™è¯¯</strong>: è¿™é‡Œå®‰è£…å®Œæˆåæ‰§è¡Œ<code>helm version</code>æç¤ºé”™è¯¯ï¼Œå†…å®¹å¦‚ä¸‹:<br><code>E0904 18:51:07.730671 22845 portforward.go:391] an error occurred forwarding 38767 -&gt; 44134: error forwarding port 44134 to pod b52064300cfa79e6d83795535584f89c97c33dc91ea39c024492b7b40e3fb68e, uid : unable to do port forwarding: socat not found.</code>è¿™ä¸ªé”™è¯¯éœ€è¦åœ¨å®¢æˆ·ç«¯å®‰è£…ä¸€ä¸ª<a href="https://github.com/helm/helm/issues/1371" target="_blank" rel="noopener">socatæ’ä»¶</a></li></ul><ul><li><p>åœ¨nodeå®‰è£…socat</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y socat</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹helmç¬¬ä¸‰æ–¹å­˜å‚¨åº“(å¯é€‰)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add stable https://burdenbear.github.io/kube-charts-mirror/</span></span><br><span class="line"><span class="comment"># helm repo list</span></span><br><span class="line">NAME     URL                                             </span><br><span class="line"><span class="built_in">local</span>    http://127.0.0.1:8879/charts                    </span><br><span class="line">monocular https://helm.github.io/monocular                </span><br><span class="line">stable   https://burdenbear.github.io/kube-charts-mirror/</span><br></pre></td></tr></table></figure></li></ul><h3 id="3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm-web"><a href="#3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm-web" class="headerlink" title="3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm web"></a>3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm web</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm list</span></span><br><span class="line"><span class="comment"># helm search</span></span><br><span class="line"><span class="comment"># helm search mysql --versions</span></span><br><span class="line"><span class="comment"># helm repo list</span></span><br><span class="line"><span class="comment"># helm serve --address 0.0.0.0:8879 &amp;</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567651293339.jpg" alt="img"></p><h3 id="4ã€helm-web-ui"><a href="#4ã€helm-web-ui" class="headerlink" title="4ã€helm web ui"></a>4ã€helm web ui</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;helmå®‰è£…ä»¥åï¼Œç»å¸¸ä½¿ç”¨helm cliå‘½æ¥è¿›è¡Œéƒ¨ç½²è¿˜æ˜¯æ¯”è¾ƒåƒåŠ›çš„ï¼Œè€Œä¸”å¯¹äºæœ‰äº›äººä¸å–œæ¬¢cliçš„æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç—›è‹¦çš„äº‹æƒ…ï¼Œè¿™é‡Œä»‹ç»ä¸€æ¬¾kubeappsï¼ŒKubeappsæ˜¯ä¸€ä¸ªåŸºäºWebçš„UIï¼Œç”¨äºåœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºã€‚ Kubeappså…è®¸æ‚¨ï¼š</p><ul><li>ä»å›¾è¡¨å­˜å‚¨åº“ä¸­æµè§ˆå’Œéƒ¨ç½²Helmå›¾è¡¨</li><li>æ£€æŸ¥ï¼Œå‡çº§å’Œåˆ é™¤ç¾¤é›†ä¸­å®‰è£…çš„åŸºäºHelmçš„åº”ç”¨ç¨‹åº</li><li>æ·»åŠ è‡ªå®šä¹‰å’Œç§æœ‰å›¾è¡¨å­˜å‚¨åº“ï¼ˆæ”¯æŒChartMuseumå’ŒJFrog Artifactory)</li><li>ä»æœåŠ¡ç›®å½•å’Œå¯ç”¨çš„Service Brokersæµè§ˆå’Œé…ç½®å¤–éƒ¨æœåŠ¡</li><li>ä½¿ç”¨æœåŠ¡ç›®å½•ç»‘å®šå°†åŸºäºHelmçš„åº”ç”¨ç¨‹åºè¿æ¥åˆ°å¤–éƒ¨æœåŠ¡</li><li>åŸºäºKubernetesåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶çš„å®‰å…¨èº«ä»½éªŒè¯å’Œæˆæƒ</li></ul><h4 id="4-1ã€å®‰è£…kubeapps"><a href="#4-1ã€å®‰è£…kubeapps" class="headerlink" title="4.1ã€å®‰è£…kubeapps"></a>4.1ã€å®‰è£…kubeapps</h4><p>ä½¿ç”¨Helmå›¾è¡¨å®‰è£…<a href="https://github.com/kubeapps/kubeapps" target="_blank" rel="noopener">æœ€æ–°ç‰ˆæœ¬çš„Kubeapps</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add bitnami https://charts.bitnami.com/bitnami</span></span><br><span class="line"><span class="comment"># helm install --name kubeapps --namespace kubeapps bitnami/kubeapps</span></span><br></pre></td></tr></table></figure><h4 id="4-2ã€å¯åŠ¨kubeappsDashboard"><a href="#4-2ã€å¯åŠ¨kubeappsDashboard" class="headerlink" title="4.2ã€å¯åŠ¨kubeappsDashboard"></a>4.2ã€å¯åŠ¨kubeappsDashboard</h4><p>å®‰è£…Kubeappsåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»ç³»ç»Ÿå®‰å…¨è®¿é—®Kubeapps Dashboard</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export POD_NAME=$(kubectl get pods --namespace kubeapps -l "app=kubeapps" -o jsonpath="&#123;.items[0].metadata.name&#125;")</span></span><br><span class="line"><span class="comment"># kubectl port-forward -n kubeapps $POD_NAME --address 0.0.0.0 8081:8080 &amp;</span></span><br><span class="line"><span class="comment"># æŠŠå®¹å™¨çš„8080 æ˜ å°„åˆ°æœ¬åœ°çš„8081ç«¯å£ï¼Œç”¨äºæµè§ˆå™¨è®¿é—®</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567650844980.jpg" alt="img"></p><h4 id="4-3ã€åˆ›å»ºtoken"><a href="#4-3ã€åˆ›å»ºtoken" class="headerlink" title="4.3ã€åˆ›å»ºtoken"></a>4.3ã€åˆ›å»ºtoken</h4><p>è®¿é—®ä»ªè¡¨æ¿éœ€è¦Kubernetes APIä»¤ç‰Œæ‰èƒ½é€šè¿‡Kubernetes APIæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount kubeapps-operator</span></span><br><span class="line">serviceaccount/kubeapps-operator created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding kubeapps-operator --clusterrole=cluster-admin --serviceaccount=default:kubeapps-operator</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubeapps-operator created</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–token</span></span><br><span class="line"><span class="comment"># kubectl get secret $(kubectl get serviceaccount kubeapps-operator -o jsonpath='&#123;.secrets[].name&#125;') -o jsonpath='&#123;.data.token&#125;' | base64 --decode</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567650971425.jpg" alt="img"></p><h5 id="4-3-1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬"><a href="#4-3-1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬" class="headerlink" title="4.3.1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬"></a>4.3.1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬</h5><p>æ¯æ¬¡è®¿é—®kubeappsçš„token éƒ½è¦è¾“å…¥ä¸€é•¿ä¸²ï¼Œè¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªshellè„šæœ¬ï¼Œæ”¾åœ¨<code>/usr/bin</code>ç›®å½•ï¼Œéœ€è¦çš„æ—¶å€™æ‰§è¡Œå‘½ä»¤å³å¯ï¼Œè¿™æ ·æ–¹ä¾¿ç”¨äºè®°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/bin/kubeapps</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">kubectl get secret $(kubectl get serviceaccount kubeapps-operator -o jsonpath=<span class="string">'&#123;.secrets[].name&#125;'</span>) -o jsonpath=<span class="string">'&#123;.data.token&#125;'</span> | base64 --decode</span><br><span class="line"><span class="comment"># chmod +x /usr/bin/kubeapps</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>helm</tag>
      </tags>
  </entry>
  <entry>
    <title>metrics-serverå®‰è£…å­£</title>
    <url>/2019/09/04/metrics-server%E5%AE%89%E8%A3%85%E5%AD%A3/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metrics-server é€šè¿‡ kube-apiserver å‘ç°æ‰€æœ‰èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨ kubelet APIsï¼ˆé€šè¿‡ https æ¥å£ï¼‰è·å¾—å„èŠ‚ç‚¹ï¼ˆNodeï¼‰å’Œ Pod çš„ CPUã€Memory ç­‰èµ„æºä½¿ç”¨æƒ…å†µã€‚Kubernetes 1.12 å¼€å§‹ï¼Œkubernetes çš„å®‰è£…è„šæœ¬ç§»é™¤äº† Heapsterï¼Œä» 1.13 å¼€å§‹å®Œå…¨ç§»é™¤äº†å¯¹ Heapster çš„æ”¯æŒï¼ŒHeapster ä¸å†è¢«ç»´æŠ¤ã€‚</p><ul><li>æ›¿ä»£æ–¹æ¡ˆå¦‚ä¸‹:<ul><li>ç”¨äºæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹çš„ CPU/memory HPA metricsï¼šmetrics-server</li><li>é€šç”¨çš„ç›‘æ§æ–¹æ¡ˆï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹å¯ä»¥è·å– Prometheus æ ¼å¼ç›‘æ§æŒ‡æ ‡çš„ç›‘æ§ç³»ç»Ÿï¼Œå¦‚ Prometheus Operator</li><li>äº‹ä»¶ä¼ è¾“ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æ¥ä¼ è¾“ã€å½’æ¡£ kubernetes events</li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨ metrics-server æ›¿ä»£ Heapsterï¼Œå°†æ— æ³•åœ¨ dashboard ä¸­ä»¥å›¾å½¢å±•ç¤º Pod çš„å†…å­˜å’Œ CPU æƒ…å†µï¼Œéœ€è¦é€šè¿‡ Prometheusã€Grafana ç­‰ç›‘æ§æ–¹æ¡ˆæ¥å¼¥è¡¥ã€‚</p><a id="more"></a><h4 id="1ã€ç›‘æ§æ¶æ„"><a href="#1ã€ç›‘æ§æ¶æ„" class="headerlink" title="1ã€ç›‘æ§æ¶æ„"></a>1ã€ç›‘æ§æ¶æ„</h4><p><img src="https://img.xxlaila.cn/2748678bdjsg848sd.png" alt="img"></p><h4 id="2ã€å®‰è£…-metrics-server"><a href="#2ã€å®‰è£…-metrics-server" class="headerlink" title="2ã€å®‰è£… metrics-server"></a>2ã€å®‰è£… metrics-server</h4><ul><li>ä» github clone æºç <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/metrics-server</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">aggregated-metrics-reader.yaml  auth-delegator.yaml  auth-reader.yaml  metrics-apiservice.yaml  metrics-server-deployment.yaml  metrics-server-service.yaml  resource-reader.yaml</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>æ³¨æ„</strong>: ä¹‹å‰åœ¨å®‰è£…çš„æ—¶å€™é‡åˆ°å¾ˆå¤šå‘ï¼Œè€Œä¸”ç½‘ä¸Šçœ‹äº†æ•™ç¨‹åŸºæœ¬ä¸Šä¸èƒ½ç”¨ï¼Œå¾ˆå‘ï¼Œè‡ªå·±çœ‹ç½‘ä¸Šæ•™ç¨‹ï¼Œç„¶åæ ¹æ®æ¯ä¸€ä¸ªé”™è¯¯æ¥è¿›è¡Œè§£å†³ï¼Œç»ˆäºï¼ŒåŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼ŒèŠ±äº†ä¸€å¤©åŠç»ˆäºæå®šå•¦ã€‚</li></ul><h4 id="3ã€metrics-server-æ–‡ä»¶ä¿®æ”¹"><a href="#3ã€metrics-server-æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="3ã€metrics-server æ–‡ä»¶ä¿®æ”¹"></a>3ã€metrics-server æ–‡ä»¶ä¿®æ”¹</h4><p>metrics-server yamlæ–‡ä»¶è¿™é‡Œæ–‡ä»¶å·²ç»ä¿®æ”¹å¥½äº†ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ï¼Œ<a href="https://github.com/kubernetes-incubator/metrics-server/issues/247" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a>ï¼Œ</p><h5 id="3-1ã€metrics-server-deployment-yaml"><a href="#3-1ã€metrics-server-deployment-yaml" class="headerlink" title="3.1ã€metrics-server-deployment.yaml"></a>3.1ã€metrics-server-deployment.yaml</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat metrics-server-deployment.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      hostNetwork: <span class="literal">true</span>   <span class="comment">#å¢åŠ è¡Œ</span></span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span><br><span class="line">      - name: tmp-dir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: mirrorgooglecontainers/metrics-server-amd64:v0.3.3</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/kubernetes/</span><br><span class="line">          name: ca-ssl</span><br><span class="line">        <span class="built_in">command</span>:   <span class="comment"># commandå†…å®¹å‡ä¸ºå¢åŠ </span></span><br><span class="line">        - /metrics-server</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br><span class="line">        - --requestheader-client-ca-file=/etc/ssl/kubernetes/front-proxy-ca.pem</span><br><span class="line">        - --kubelet-insecure-tls=<span class="literal">true</span></span><br><span class="line">      volumes:</span><br><span class="line">       - name: ca-ssl</span><br><span class="line">         hostPath:</span><br><span class="line">          path: /etc/kubernetes/ssl</span><br></pre></td></tr></table></figure><h5 id="3-2ã€"><a href="#3-2ã€" class="headerlink" title="3.2ã€"></a>3.2ã€</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat resource-reader.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/stats</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups: <span class="comment"># å¢åŠ </span></span><br><span class="line">  - <span class="string">"extensions"</span></span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure><h4 id="4ã€å‡†å¤‡è¯ä¹¦"><a href="#4ã€å‡†å¤‡è¯ä¹¦" class="headerlink" title="4ã€å‡†å¤‡è¯ä¹¦"></a>4ã€å‡†å¤‡è¯ä¹¦</h4><p>è¿™äº›è¯ä¹¦æ–‡ä»¶ä¸»è¦ç”¨åœ¨Metrics API aggregator ä¸Š,<a href="https://blog.51cto.com/ylw6006/2114338" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><ul><li><p>front-proxy-ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat front-proxy-ca-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>front-proxy-client-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"front-proxy-client"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="4-1ã€ç”Ÿæˆè¯ä¹¦"><a href="#4-1ã€ç”Ÿæˆè¯ä¹¦" class="headerlink" title="4.1ã€ç”Ÿæˆè¯ä¹¦"></a>4.1ã€ç”Ÿæˆè¯ä¹¦</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca</span></span><br><span class="line"><span class="comment"># cfssl gencert \</span></span><br><span class="line"> -ca=front-proxy-ca.pem \</span><br><span class="line"> -ca-key=front-proxy-ca-key.pem \</span><br><span class="line"> -config=/root/ssl/kubernetes-gencert.json \</span><br><span class="line"> -profile=kubernetes \</span><br><span class="line"> front-proxy-client-csr.json | cfssljson -bare front-proxy-client</span><br><span class="line"><span class="comment"># ls *.pem</span></span><br><span class="line">front-proxy-ca-key.pem  front-proxy-ca.pem  front-proxy-client-key.pem  front-proxy-client.pem</span><br></pre></td></tr></table></figure><ul><li>è¯ä¹¦ç”Ÿæˆå®Œæˆåï¼Œå§è¯ä¹¦å¤åˆ¶åˆ°æ‰€æœ‰çš„masterèŠ‚ç‚¹å’ŒnodeèŠ‚ç‚¹</li></ul><h4 id="5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶"></a>5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶</h4><h4 id="5-1ã€apiserver"><a href="#5-1ã€apiserver" class="headerlink" title="5.1ã€apiserver"></a>5.1ã€apiserver</h4><p>åœ¨apiserveré…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--runtime-config=api/all=<span class="literal">true</span> \</span><br><span class="line">--<span class="built_in">enable</span>-aggregator-routing=<span class="literal">true</span> \</span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/ssl/front-proxy-ca.pem \</span><br><span class="line">--requestheader-allowed-names=aggregator \</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \</span><br><span class="line">--requestheader-username-headers=X-Remote-User \</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/ssl/front-proxy-client.pem \</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/ssl/front-proxy-client-key.pem \</span><br></pre></td></tr></table></figure><ul><li>apiserveré…ç½®æ–‡ä»¶KUBE_API_ARGSå†…å®¹å¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBE_API_ARGS=<span class="string">" --allow-privileged=true \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --alsologtostderr \</span></span><br><span class="line"><span class="string">                --apiserver-count=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">                --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">                --enable-aggregator-routing=true \</span></span><br><span class="line"><span class="string">                --audit-log-path=/var/log/kube-audit/audit.log \</span></span><br><span class="line"><span class="string">                --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span></span><br><span class="line"><span class="string">                --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">                --enable-garbage-collector \</span></span><br><span class="line"><span class="string">                --enable-logs-handler \</span></span><br><span class="line"><span class="string">                --endpoint-reconciler-type=lease \</span></span><br><span class="line"><span class="string">                --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span></span><br><span class="line"><span class="string">                --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">                --etcd-compaction-interval=0s \</span></span><br><span class="line"><span class="string">                --event-ttl=168h0m0s \</span></span><br><span class="line"><span class="string">                --kubelet-https=true \</span></span><br><span class="line"><span class="string">                --kubelet-certificate-authority=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem \</span></span><br><span class="line"><span class="string">                --kubelet-timeout=3s \</span></span><br><span class="line"><span class="string">                --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">                --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">                --service-account-key-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">                --requestheader-client-ca-file=/etc/kubernetes/ssl/front-proxy-ca.pem \</span></span><br><span class="line"><span class="string">                --requestheader-allowed-names=aggregator \</span></span><br><span class="line"><span class="string">                --requestheader-extra-headers-prefix=X-Remote-Extra- \</span></span><br><span class="line"><span class="string">                --requestheader-group-headers=X-Remote-Group \</span></span><br><span class="line"><span class="string">                --requestheader-username-headers=X-Remote-User \</span></span><br><span class="line"><span class="string">                --proxy-client-cert-file=/etc/kubernetes/ssl/front-proxy-client.pem \</span></span><br><span class="line"><span class="string">                --proxy-client-key-file=/etc/kubernetes/ssl/front-proxy-client-key.pem \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="5-2ã€kube-control-manager"><a href="#5-2ã€kube-control-manager" class="headerlink" title="5.2ã€kube-control-manager"></a>5.2ã€kube-control-manager</h5><p>åœ¨controller-manageræ–‡ä»¶å¢åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--horizontal-pod-autoscaler-use-rest-clients=<span class="literal">true</span> \</span><br></pre></td></tr></table></figure><ul><li>kube-control-manageré…ç½®æ–‡ä»¶KUBE_CONTROLLER_MANAGER_ARGSå¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">                                --cluster-signing-cert-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --cluster-signing-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">                                --deployment-controller-sync-period=10s \</span></span><br><span class="line"><span class="string">                                --experimental-cluster-signing-duration=87600h0m0s \</span></span><br><span class="line"><span class="string">                                --enable-garbage-collector=true \</span></span><br><span class="line"><span class="string">                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --leader-elect=true \</span></span><br><span class="line"><span class="string">                                --node-monitor-grace-period=20s \</span></span><br><span class="line"><span class="string">                                --node-monitor-period=5s \</span></span><br><span class="line"><span class="string">                                --port=10252 \</span></span><br><span class="line"><span class="string">                                --pod-eviction-timeout=2m0s \</span></span><br><span class="line"><span class="string">                                --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --terminated-pod-gc-threshold=50 \</span></span><br><span class="line"><span class="string">                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">                                --root-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --secure-port=10257 \</span></span><br><span class="line"><span class="string">                                --service-cluster-ip-range=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                                --service-account-private-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">                                --horizontal-pod-autoscaler-use-rest-clients=true \</span></span><br><span class="line"><span class="string">                                --v=2"</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="5-3ã€é‡å¯æœåŠ¡"><a href="#5-3ã€é‡å¯æœåŠ¡" class="headerlink" title="5.3ã€é‡å¯æœåŠ¡"></a>5.3ã€é‡å¯æœåŠ¡</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl  restart kube-apiserver.service &amp;&amp;systemctl  restart kube-controller-manager</span></span><br></pre></td></tr></table></figure><h4 id="6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹"><a href="#6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹"></a>6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹</h4><p>node èŠ‚ç‚¹ä¿®æ”¹ä¿®æ”¹kubeletæ–‡ä»¶</p><ul><li><p>kubeleté…ç½®æ–‡ä»¶å®Œæˆçš„KUBELET_ARGSå‚æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBELET_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                --allow-privileged \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --authorization-mode=Webhook \</span></span><br><span class="line"><span class="string">                --authentication-token-webhook=true \</span></span><br><span class="line"><span class="string">                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --cgroup-driver=cgroupfs \</span></span><br><span class="line"><span class="string">                --cert-dir=/etc/kubernetes/ssl \</span></span><br><span class="line"><span class="string">                --cluster-dns=10.254.0.2 \</span></span><br><span class="line"><span class="string">                --cluster-domain=cluster.local \</span></span><br><span class="line"><span class="string">                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% \</span></span><br><span class="line"><span class="string">                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m \</span></span><br><span class="line"><span class="string">                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% \</span></span><br><span class="line"><span class="string">                --eviction-max-pod-grace-period=30 \</span></span><br><span class="line"><span class="string">                --image-gc-high-threshold=80 \</span></span><br><span class="line"><span class="string">                --image-gc-low-threshold=70 \</span></span><br><span class="line"><span class="string">                --image-pull-progress-deadline=30s \</span></span><br><span class="line"><span class="string">                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">                --max-pods=100 \</span></span><br><span class="line"><span class="string">                --minimum-image-ttl-duration=720h0m0s \</span></span><br><span class="line"><span class="string">                --node-labels=node.kubernetes.io/k8s-node=true \</span></span><br><span class="line"><span class="string">                --pod-infra-container-image=docker.io/kubernetes/pause:latest \</span></span><br><span class="line"><span class="string">                --port=10250 \</span></span><br><span class="line"><span class="string">                --read-only-port=0 \</span></span><br><span class="line"><span class="string">                --rotate-certificates \</span></span><br><span class="line"><span class="string">                --rotate-server-certificates \</span></span><br><span class="line"><span class="string">                --fail-swap-on=false \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯kubelet</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl restart kubelet</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="7ã€åˆ›å»ºmetrics"><a href="#7ã€åˆ›å»ºmetrics" class="headerlink" title="7ã€åˆ›å»ºmetrics"></a>7ã€åˆ›å»ºmetrics</h4><p>é€šè¿‡yamlæ–‡ä»¶åˆ›å»ºå¯¹åº”çš„èµ„æº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ./</span></span><br></pre></td></tr></table></figure><h5 id="7-1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ"><a href="#7-1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ" class="headerlink" title="7.1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ"></a>7.1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods -l k8s-app=metrics-server</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-84b786c9bb-7trdr   1/1     Running   0          62m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get svc -n kube-system  metrics-server</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">metrics-server   ClusterIP   10.254.45.238   &lt;none&gt;        443/TCP   3h6m</span><br></pre></td></tr></table></figure><h5 id="7-2ã€è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯"><a href="#7-2ã€è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯" class="headerlink" title="7.2ã€è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯"></a>7.2ã€è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰<code>v1beta1.metrics.k8s.io kube-system/metrics-server True 3h</code>å‚æ•°ä¸€ç›´æ˜¯<code>v1beta1.metrics.k8s.io kube-system/metrics-server False (FailedDiscoveryCheck) 16m</code>,</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kubectl get apiservice</span></span><br><span class="line">NAME                                    SERVICE                      AVAILABLE   AGE</span><br><span class="line">v1.                                     Local                        True        4d</span><br><span class="line">v1.apps                                 Local                        True        4d</span><br><span class="line">v1.authentication.k8s.io                Local                        True        4d</span><br><span class="line">v1.authorization.k8s.io                 Local                        True        4d</span><br><span class="line">v1.autoscaling                          Local                        True        4d</span><br><span class="line">v1.batch                                Local                        True        4d</span><br><span class="line">v1.networking.k8s.io                    Local                        True        4d</span><br><span class="line">v1.rbac.authorization.k8s.io            Local                        True        4d</span><br><span class="line">v1.storage.k8s.io                       Local                        True        4d</span><br><span class="line">v1alpha1.admissionregistration.k8s.io   Local                        True        4d</span><br><span class="line">v1alpha1.auditregistration.k8s.io       Local                        True        4d</span><br><span class="line">v1alpha1.rbac.authorization.k8s.io      Local                        True        4d</span><br><span class="line">v1alpha1.scheduling.k8s.io              Local                        True        4d</span><br><span class="line">v1alpha1.settings.k8s.io                Local                        True        4d</span><br><span class="line">v1alpha1.storage.k8s.io                 Local                        True        4d</span><br><span class="line">v1beta1.admissionregistration.k8s.io    Local                        True        4d</span><br><span class="line">v1beta1.apiextensions.k8s.io            Local                        True        4d</span><br><span class="line">v1beta1.apps                            Local                        True        4d</span><br><span class="line">v1beta1.authentication.k8s.io           Local                        True        4d</span><br><span class="line">v1beta1.authorization.k8s.io            Local                        True        4d</span><br><span class="line">v1beta1.batch                           Local                        True        4d</span><br><span class="line">v1beta1.certificates.k8s.io             Local                        True        4d</span><br><span class="line">v1beta1.coordination.k8s.io             Local                        True        4d</span><br><span class="line">v1beta1.events.k8s.io                   Local                        True        4d</span><br><span class="line">v1beta1.extensions                      Local                        True        4d</span><br><span class="line">v1beta1.metrics.k8s.io                  kube-system/metrics-server   True        3h</span><br><span class="line">v1beta1.policy                          Local                        True        4d</span><br><span class="line">v1beta1.rbac.authorization.k8s.io       Local                        True        4d</span><br><span class="line">v1beta1.scheduling.k8s.io               Local                        True        4d</span><br><span class="line">v1beta1.storage.k8s.io                  Local                        True        4d</span><br><span class="line">v1beta2.apps                            Local                        True        4d</span><br><span class="line">v2alpha1.batch                          Local                        True        4d</span><br><span class="line">v2beta1.autoscaling                     Local                        True        4d</span><br><span class="line">v2beta2.autoscaling                     Local                        True        4d</span><br></pre></td></tr></table></figure><h4 id="8ã€æŸ¥çœ‹-metrics-server-è¾“å‡ºçš„-metrics"><a href="#8ã€æŸ¥çœ‹-metrics-server-è¾“å‡ºçš„-metrics" class="headerlink" title="8ã€æŸ¥çœ‹ metrics-server è¾“å‡ºçš„ metrics"></a>8ã€æŸ¥çœ‹ metrics-server è¾“å‡ºçš„ metrics</h4><h5 id="8-1ã€é€šè¿‡-kube-apiserver-æˆ–-kubectl-proxy-è®¿é—®"><a href="#8-1ã€é€šè¿‡-kube-apiserver-æˆ–-kubectl-proxy-è®¿é—®" class="headerlink" title="8.1ã€é€šè¿‡ kube-apiserver æˆ– kubectl proxy è®¿é—®"></a>8.1ã€é€šè¿‡ kube-apiserver æˆ– kubectl proxy è®¿é—®</h5><ul><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes/" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes/</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/pods" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/pods</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/namespace//pods/" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/namespace//pods/</a></li></ul><h5 id="8-2ã€ç›´æ¥ä½¿ç”¨-kubectl-å‘½ä»¤è®¿é—®"><a href="#8-2ã€ç›´æ¥ä½¿ç”¨-kubectl-å‘½ä»¤è®¿é—®" class="headerlink" title="8.2ã€ç›´æ¥ä½¿ç”¨ kubectl å‘½ä»¤è®¿é—®"></a>8.2ã€ç›´æ¥ä½¿ç”¨ kubectl å‘½ä»¤è®¿é—®</h5><ul><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/nodes</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/pods</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/nodes/</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/namespace//pods/</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get --raw "/apis/metrics.k8s.io/v1beta1" | jq .</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"APIResourceList"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">  <span class="string">"groupVersion"</span>: <span class="string">"metrics.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"resources"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"nodes"</span>,</span><br><span class="line">      <span class="string">"singularName"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"namespaced"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"kind"</span>: <span class="string">"NodeMetrics"</span>,</span><br><span class="line">      <span class="string">"verbs"</span>: [</span><br><span class="line">        <span class="string">"get"</span>,</span><br><span class="line">        <span class="string">"list"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"pods"</span>,</span><br><span class="line">      <span class="string">"singularName"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"namespaced"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"kind"</span>: <span class="string">"PodMetrics"</span>,</span><br><span class="line">      <span class="string">"verbs"</span>: [</span><br><span class="line">        <span class="string">"get"</span>,</span><br><span class="line">        <span class="string">"list"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get --raw "/apis/metrics.k8s.io/v1beta1/nodes" | jq .</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"NodeMetricsList"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"metrics.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"metadata"</span>: &#123;</span><br><span class="line">    <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"items"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.204"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.204"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:40Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"63788460n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"1033152Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.240"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.240"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:40Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"41797865n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"837420Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.87"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.87"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:34Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"37347688n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"851232Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>/apis/metrics.k8s.io/v1beta1/nodes å’Œ /apis/metrics.k8s.io/v1beta1/pods è¿”å›çš„ usage åŒ…å« CPU å’Œ Memoryï¼›</li></ul><h4 id="ä½¿ç”¨-kubectl-top"><a href="#ä½¿ç”¨-kubectl-top" class="headerlink" title="ä½¿ç”¨ kubectl top"></a>ä½¿ç”¨ kubectl top</h4><p>ä½¿ç”¨ kubectl top å‘½ä»¤æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ,kubectl top å‘½ä»¤ä» metrics-server è·å–é›†ç¾¤èŠ‚ç‚¹åŸºæœ¬çš„æŒ‡æ ‡ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl top node</span></span><br><span class="line">NAME            CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">172.21.16.204   69m          1%     1008Mi          13%       </span><br><span class="line">172.21.16.240   41m          2%     817Mi           23%       </span><br><span class="line">172.21.16.87    39m          1%     831Mi           23%</span><br></pre></td></tr></table></figure><p>metricsåˆ°è¿™é‡Œå°±å·²ç»æˆåŠŸçš„éƒ¨ç½²ï¼Œå‚æ•°æ²¡æœ‰ä¸€ä¸€ä»‹ç»ï¼ŒåæœŸæœ‰æ—¶é—´åœ¨åˆ—å‡ºæ¥</p><p>è¿™é‡Œè¿˜æœ‰å¾ˆå¤šå‚è€ƒçš„æ–‡æ¡£æ²¡æœ‰ä¸€ä¸€åˆ—å‡ºæ¥ï¼Œä¸»è¦æ˜¯æµè§ˆå™¨è¢«å…³é—­å•¦ï¼Œæ„Ÿè°¢é‚£äº›å‚è€ƒçš„æ–‡æ¡£ï¼ŒğŸ˜ŠğŸ˜ŠğŸ˜Š</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>metrics-server</tag>
      </tags>
  </entry>
  <entry>
    <title>kubeletæä¾›apiè¯·æ±‚æ¥å£</title>
    <url>/2019/09/04/kubelet%E6%8F%90%E4%BE%9Bapi%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="kubelet-æä¾›çš„-API-æ¥å£è®¤è¯"><a href="#kubelet-æä¾›çš„-API-æ¥å£è®¤è¯" class="headerlink" title="kubelet æä¾›çš„ API æ¥å£è®¤è¯"></a>kubelet æä¾›çš„ API æ¥å£è®¤è¯</h3><p><a href="https://xxlaila.github.io/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">nodeå®‰è£…å‚è€ƒ</a></p><p>kubelet å¯åŠ¨åç›‘å¬å¤šä¸ªç«¯å£ï¼Œç”¨äºæ¥æ”¶ kube-apiserver æˆ–å…¶å®ƒå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-3 ~]<span class="comment">#  netstat -lnpt|grep kubelet</span></span><br><span class="line">tcp        0      0 127.0.0.1:46395         0.0.0.0:*               LISTEN      8941/kubelet        </span><br><span class="line">tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      8941/kubelet        </span><br><span class="line">tcp6       0      0 :::10250                :::*                    LISTEN      8941/kubelet</span><br></pre></td></tr></table></figure><ul><li><strong>10248</strong>: healthz http æœåŠ¡</li><li><strong>10250</strong>: https æœåŠ¡ï¼Œè®¿é—®è¯¥ç«¯å£æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼ˆå³ä½¿è®¿é—® /healthz ä¹Ÿéœ€è¦ï¼‰</li><li>æœªå¼€å¯åªè¯»ç«¯å£ 10255</li><li>ä» K8S v1.10 å¼€å§‹ï¼Œå»é™¤äº† â€“cadvisor-port å‚æ•°ï¼ˆé»˜è®¤ 4194 ç«¯å£ï¼‰ï¼Œä¸æ”¯æŒè®¿é—® cAdvisor UI &amp; API</li></ul><a id="more"></a><p>kubelet æ¥æ”¶ 10250 ç«¯å£çš„ https è¯·æ±‚ï¼Œå¯ä»¥è®¿é—®å¦‚ä¸‹èµ„æºï¼š</p><ul><li>/podsã€/runningpods</li><li>/metricsã€/metrics/cadvisorã€/metrics/probes</li><li>/spec</li><li>/statsã€/stats/container</li><li>/logs</li><li>/run/ã€/exec/, /attach/, /portForward/, /containerLogs/<br><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/server/server.go#L434:3" target="_blank" rel="noopener">è¯¦æƒ…å‚è€ƒ</a></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºå…³é—­äº†åŒ¿åè®¤è¯ï¼ŒåŒæ—¶å¼€å¯äº† webhook æˆæƒï¼Œæ‰€æœ‰è®¿é—® 10250 ç«¯å£ https API çš„è¯·æ±‚éƒ½éœ€è¦è¢«è®¤è¯å’Œæˆæƒã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;é¢„å®šä¹‰çš„ ClusterRole system:kubelet-api-admin æˆäºˆè®¿é—® kubelet æ‰€æœ‰ API çš„æƒé™(kube-apiserver ä½¿ç”¨çš„ kubernetes è¯ä¹¦ User æˆäºˆäº†è¯¥æƒé™)ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kubelet-api-admin</span></span><br><span class="line">Name:         system:kubelet-api-admin</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources      Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------      -----------------  --------------  -----</span><br><span class="line">  nodes/<span class="built_in">log</span>      []                 []              [*]</span><br><span class="line">  nodes/metrics  []                 []              [*]</span><br><span class="line">  nodes/proxy    []                 []              [*]</span><br><span class="line">  nodes/spec     []                 []              [*]</span><br><span class="line">  nodes/stats    []                 []              [*]</span><br><span class="line">  nodes          []                 []              [get list watch proxy]</span><br></pre></td></tr></table></figure><h3 id="kubelet-api-è®¤è¯å’Œæˆæƒ"><a href="#kubelet-api-è®¤è¯å’Œæˆæƒ" class="headerlink" title="kubelet api è®¤è¯å’Œæˆæƒ"></a>kubelet api è®¤è¯å’Œæˆæƒ</h3><p>kubelet é…ç½®äº†å¦‚ä¸‹è®¤è¯å‚æ•°:</p><ul><li><strong>â€“anonymous-auth=false</strong>: è®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åï¿½è®¿é—® 10250 ç«¯å£</li><li><strong>â€“authentication-token-webhook=true</strong>: æŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTPs è¯ä¹¦è®¤è¯</li><li><strong>â€“client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem</strong>: å¼€å¯ HTTPs bearer token è®¤è¯</li><li><strong>â€“authorization-mode=Webhook</strong>: å¼€å¯ RBAC æˆæƒ</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;kubelet æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ clientCAFile å¯¹è¯ä¹¦ç­¾åè¿›è¡Œè®¤è¯ï¼Œæˆ–è€…æŸ¥è¯¢ bearer token æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœä¸¤è€…éƒ½æ²¡é€šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚ï¼Œæç¤º Unauthorized</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 ~]<span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem https://172.21.16.204:10250/metrics</span></span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡è®¤è¯åï¼Œkubelet ä½¿ç”¨ SubjectAccessReview API å‘ kube-apiserver å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢è¯ä¹¦æˆ– token å¯¹åº”çš„ userã€group æ˜¯å¦æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</p><h3 id="è¯ä¹¦è®¤è¯å’Œæˆæƒ"><a href="#è¯ä¹¦è®¤è¯å’Œæˆæƒ" class="headerlink" title="è¯ä¹¦è®¤è¯å’Œæˆæƒ"></a>è¯ä¹¦è®¤è¯å’Œæˆæƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æƒé™ä¸è¶³</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem  --cert /etc/kubernetes/ssl/kube-controller-manager.pem --key /etc/kubernetes/ssl/kube-controller-manager-key.pem https://172.21.16.204:10250/metrics</span></span><br><span class="line">Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.16.204:10250/metrics|head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"21600"</span>&#125; 0</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>: â€“cacertã€â€“certã€â€“key çš„å‚æ•°å€¼å¿…é¡»æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦åˆ™è¿”å› 401 Unauthorizedï¼›</li></ul><h4 id="bear-token-è®¤è¯å’Œæˆæƒ"><a href="#bear-token-è®¤è¯å’Œæˆæƒ" class="headerlink" title="bear token è®¤è¯å’Œæˆæƒ"></a>bear token è®¤è¯å’Œæˆæƒ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ª ServiceAccountï¼Œå°†å®ƒå’Œ ClusterRole system:kubelet-api-admin ç»‘å®šï¼Œä»è€Œå…·æœ‰è°ƒç”¨ kubelet API çš„æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">horization.k8s.io/kubelet-api-test created</span><br><span class="line"><span class="comment"># SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># TOKEN=$(kubectl describe secret $&#123;SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;TOKEN&#125;</span></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6Imt1YmVsZXQtYXBpLXRlc3QtdG9rZW4tNGJra3MiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoia3ViZWxldC1hcGktdGVzdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6Ijk3MDRhZDEwLWNlYjQtMTFlOS04ZDIwLWZhMTYzZTVhZjgzMyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0Omt1YmVsZXQtYXBpLXRlc3QifQ.ishvOaC5tppYKDNpEOXIiVhVtgjyqzjySZjzndot5Z5U9MkY9LN8ZSMWRe6lNsB1UuTgEWTsHlG3OIRfExnHehYhWIt59V9e39KKbeY17hHoT-RZSaD6GoB449t_vUdIJedd1FGZ8DckQvDr6X5fMuD7MSU3vRL077j-uls-y4IW5kaJHeAGJfc6eWoCnv96DCbI8mQ8yuYbwLFpfIPLb4u6FPkwMQL2KXy6FhWPY1va6zAh4LdjGWhH6IAkKleq0aqfMwvmlnk1_OUmnmBoGJGuB96IwqBATP0jFzrd-Sv6af3RsSYz2r8YzJUj3kat9bd__HNCCXampYYr8ffu8YEdn-J9p6HK13FWU4O9QSIDrRONNIOpUXclJ-ov3z6N1hiIcVq5UJU6xR2z4ccvPXmH9Sj7p8CquqKEuobZxK97TFtECGlb2Ex43u4t0UHRo23UCQA-qP2Zs4-U2Zmf_qu3I-Lm7jzuYzXFCAb27yZx_XOUY-ycnKhtM6PpUfVKhkcHfWBOYY-QtBEbYf6yHRqCWcjrsZ63C_B56qAYaU5ca3hAcr6RBuHmmHISGESlLbmrpGgJ_ajd5mrJSh3Z_qdqu-Xt0Ya0NLfXgAcGi5n8xWJLztRTeyHrFTj7g82MqERUfFk9bdLHcz77xmrNLnhRZ87GW9sTZLw8QRUjF1g</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem -H "Authorization: Bearer $&#123;TOKEN&#125;" https://172.21.16.204:10250/metrics|head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"21600"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="cadvisor-å’Œ-metrics"><a href="#cadvisor-å’Œ-metrics" class="headerlink" title="cadvisor å’Œ metrics"></a>cadvisor å’Œ metrics</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;cadvisor æ˜¯å†…åµŒåœ¨ kubelet äºŒè¿›åˆ¶ä¸­çš„ï¼Œç»Ÿè®¡æ‰€åœ¨èŠ‚ç‚¹å„å®¹å™¨çš„èµ„æº(CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘å¡)ä½¿ç”¨æƒ…å†µçš„æœåŠ¡.</p><blockquote><p>åœ¨è®¿é—®api-serverå®‰å…¨ç«¯å£ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›æ“ä½œæ‰èƒ½è®¿é—®ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œè®¿é—®</p></blockquote><h5 id="åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£"><a href="#åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£" class="headerlink" title="åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£"></a>åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;æç¤ºè¯ä¹¦ä¸è¢«ä¿¡ä»»,è¿™æ˜¯å› ä¸º kube-apiserver çš„ server è¯ä¹¦æ˜¯æˆ‘ä»¬åˆ›å»ºçš„æ ¹è¯ä¹¦ ca.pem ç­¾åçš„ï¼Œéœ€è¦å°†æ ¹è¯ä¹¦ ca.pem å¯¼å…¥æ“ä½œç³»ç»Ÿï¼Œå¹¶è®¾ç½®æ°¸ä¹…ä¿¡ä»»ã€‚<br><img src="https://img.xxlaila.cn/1567564092242.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ç»™æµè§ˆå™¨ç”Ÿæˆä¸€ä¸ª client è¯ä¹¦ï¼Œè®¿é—® apiserver çš„ 6443 https ç«¯å£æ—¶ä½¿ç”¨ã€‚è¿™é‡Œä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ admin è¯ä¹¦ã€ç§é’¥å’Œä¸Šé¢çš„ ca è¯ä¹¦ï¼Œåˆ›å»ºä¸€ä¸ªæµè§ˆå™¨å¯ä»¥ä½¿ç”¨ PKCS#12/PFX æ ¼å¼çš„è¯ä¹¦ï¼š</p><ul><li><p>ä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œè¿™é‡Œå¯†ç éœ€è¦è®°ä½ï¼Œä¸€ä¼šå€’å…¥è¯ä¹¦åˆ°æµè§ˆå™¨çš„æ—¶å€™éœ€è¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl pkcs12 -export -out admin.pfx -inkey admin-key.pem -in admin.pem -certfile kubernetes-ca.pem</span></span><br><span class="line">Enter Export Password:</span><br><span class="line">Verifying - Enter Export Password:</span><br></pre></td></tr></table></figure></li><li><p>å°†åˆ›å»ºçš„ admin.pfx å¯¼å…¥åˆ°ç³»ç»Ÿçš„è¯ä¹¦ä¸­,<br><img src="https://img.xxlaila.cn/1567564289155.jpg" alt="img"></p></li></ul><p>å†æ¬¡è®¿é—® apiserver åœ°å€ï¼Œæç¤ºé€‰æ‹©ä¸€ä¸ªæµè§ˆå™¨è¯ä¹¦ï¼Œè¿™é‡Œé€‰ä¸­ä¸Šé¢å¯¼å…¥çš„ admin.pfx<br><img src="https://img.xxlaila.cn/1567564393274.jpg" alt="img"></p><ul><li><p>æç¤ºéœ€è¦è¾“å…¥ç³»ç»Ÿçš„å¯†ç ,è¿™é‡Œæ˜¯macçš„ç”µè„‘<br><img src="https://img.xxlaila.cn/1567564441293.jpg" alt="img"></p></li><li><p>è¢«æˆæƒè®¿é—® kube-apiserver çš„å®‰å…¨ç«¯å£<br><img src="https://img.xxlaila.cn/1567564526664.jpg" alt="img"></p></li></ul><h5 id="å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†"><a href="#å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†" class="headerlink" title="å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†"></a>å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†</h5><ul><li>è¯ä¹¦é€‰æ‹©æ˜¯åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ SSL/TLS æ¡æ‰‹åå•†é˜¶æ®µå•†å®šçš„ï¼›</li><li>æœåŠ¡ç«¯å¦‚æœè¦æ±‚å®¢æˆ·ç«¯æä¾›è¯ä¹¦ï¼Œåˆ™åœ¨æ¡æ‰‹æ—¶ä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå®ƒæ¥å—çš„ CA åˆ—è¡¨ï¼›</li><li>å®¢æˆ·ç«¯æŸ¥æ‰¾å®ƒçš„è¯ä¹¦åˆ—è¡¨(ä¸€èˆ¬æ˜¯æ“ä½œç³»ç»Ÿçš„è¯ä¹¦ï¼Œå¯¹äº Mac ä¸º keychain)ï¼Œçœ‹æœ‰æ²¡æœ‰è¢« CA ç­¾åçš„è¯ä¹¦ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†å®ƒä»¬æä¾›ç»™ç”¨æˆ·é€‰æ‹©ï¼ˆè¯ä¹¦çš„ç§é’¥ï¼‰ï¼›</li><li>ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªè¯ä¹¦ç§é’¥ï¼Œç„¶åå®¢æˆ·ç«¯å°†ä½¿ç”¨å®ƒå’ŒæœåŠ¡ç«¯é€šä¿¡ï¼›</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨è®¿é—® <a href="https://172.21.16.204:10250/metrics" target="_blank" rel="noopener">https://172.21.16.204:10250/metrics</a> å’Œ <a href="https://172.21.16.204:10250/metrics/cadvisor" target="_blank" rel="noopener">https://172.21.16.204:10250/metrics/cadvisor</a> åˆ†åˆ«è¿”å› kubelet å’Œ cadvisor çš„ metricsã€‚<br><img src="https://img.xxlaila.cn/1567563858215.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567564733531.jpg" alt="img"></p><ul><li><strong>åŸå› </strong>: kubeleté…ç½®æ–‡ä»¶è®¾ç½®<code>--anonymous-auth=false</code>ä¸å…è®¸åŒ¿åè¯ä¹¦è®¿é—® 10250 çš„ https æœåŠ¡,æ‰€ä»¥æˆ‘ä»¬æ‰éœ€è¦é…ç½®è¯ä¹¦æ¥è¿›è¡Œè®¿é—®</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubelet</tag>
      </tags>
  </entry>
  <entry>
    <title>centos-nfs-512é”™è¯¯</title>
    <url>/2019/09/03/centos-nfs-512%E9%94%99%E8%AF%AF/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>nfs é”™è¯¯kernel: NFS: nfs4_discover_server_trunking unhandled error -512. Exiting with error EIO</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¾ˆä¹…æ²¡æŒ‚è½½è¿‡nfsï¼Œå¿˜è®°å®¢æˆ·ç«¯æ€ä¹ˆæŒ‚åœ¨nfsçš„äº†ï¼ŒæœåŠ¡ç«¯å¾ˆæ—©å°±å®‰è£…å¥½äº†ï¼Œä»Šå¤©ä¸€å°å®¢æˆ·æœºéœ€è¦æŒ‚è½½nfsï¼Œç„¶åå±…ç„¶æŠ¥é”™äº†ï¼Œç„¶åæ‰¾äº†ä¸€åœˆå±…ç„¶æ²¡æ‰¾åˆ°æ€ä¹ˆè§£å†³ï¼Œç„¶ååˆé‡æ–°çœ‹äº†ä¸€æ¬¡centos nfsçš„é…ç½®ï¼Œäºæ˜¯ä¹å°±æå®šäº†</p><p>åœ¨æŒ‚è½½nfsçš„æç¤ºå¾ˆæ…¢ï¼Œé•¿æ—¶é—´æ— å“åº”ï¼Œå¼ºè¡Œç»“æŸçœ‹çœ‹æ˜¯ä»€ä¹ˆé—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo tail -f /var/<span class="built_in">log</span>/messages</span><br><span class="line">Sep  3 11:23:51 dev-application kernel: NFS: nfs4_discover_server_trunking unhandled error -512. Exiting with error EIO</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind-service"><a href="#1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind-service" class="headerlink" title="1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind.service"></a>1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind.service</h3><p>åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹<code>rpcbind.service</code>æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼Œæ²¡æœ‰æ­£å¸¸å¯åŠ¨ï¼Œå°±éœ€è¦å¯åŠ¨ï¼Œæ²¡æœ‰å®‰è£…æœåŠ¡ï¼Œå°±éœ€è¦å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum -y install rpcbind</span><br><span class="line">$ sudo systemctl start rpcbind.service &amp;&amp; sudo systemctl <span class="built_in">enable</span> rpcbind.service</span><br></pre></td></tr></table></figure><ul><li>å†æ¬¡æŒ‚è½½çš„æ—¶å€™è¿˜æ˜¯æŒ‚è½½è¡¥ä¸Šï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æŒ‚è½½çš„æ—¶å€™å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€äº†æ•°æ®è¯·æ±‚ï¼Œè€Œä¸”è¿˜æ²¡æœ‰æ­£å¸¸çš„æ–­å¼€é“¾æ¥ï¼Œå¯ä»¥åœ¨æœåŠ¡ç«¯ç”¨<code>netstat -anp|grep tcp</code>æŸ¥çœ‹æœ‰æ²¡æœ‰å®¢æˆ·ç«¯çš„é“¾æ¥ä¿¡æ¯,çŠ¶æ€æ˜¯<code>ESTABLISHED</code>ï¼Œæœ‰çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒç»“æŸæ‰</li></ul><h3 id="2ã€linux-ç»“æŸtcpä¼šè¯"><a href="#2ã€linux-ç»“æŸtcpä¼šè¯" class="headerlink" title="2ã€linux ç»“æŸtcpä¼šè¯"></a>2ã€linux ç»“æŸtcpä¼šè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›®å‰ä¸çŸ¥é“ä»€ä¹ˆå‘½ä»¤,åæœŸæ›´æ–°</span></span><br><span class="line"><span class="comment"># é‡å¯nfsæœåŠ¡</span></span><br><span class="line">$ sudo systemctl restart nfs.service</span><br></pre></td></tr></table></figure><h3 id="3ã€å®¢æˆ·ç«¯æŒ‚è½½"><a href="#3ã€å®¢æˆ·ç«¯æŒ‚è½½" class="headerlink" title="3ã€å®¢æˆ·ç«¯æŒ‚è½½"></a>3ã€å®¢æˆ·ç«¯æŒ‚è½½</h3><p>å†æ¬¡æ¥åˆ°å®¢æˆ·æœºæŒ‚è½½ï¼Œå¯ä»¥æˆåŠŸçš„æŒ‚è½½</p><h3 id="4ã€rpcbindæœåŠ¡ä»‹ç»"><a href="#4ã€rpcbindæœåŠ¡ä»‹ç»" class="headerlink" title="4ã€rpcbindæœåŠ¡ä»‹ç»"></a>4ã€rpcbindæœåŠ¡ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿéœ€è¦æœåŠ¡ï¼Œçº¢å¸½ä¼ä¸šLinuxä½¿ç”¨æ ¸å¿ƒçº§çš„æ”¯æŒå’Œå®ˆæŠ¤è¿›ç¨‹çš„ç»„åˆæ¥æä¾›NFSæ–‡ä»¶å…±äº«.NFSä¾é è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è·¯ç”±è¯·æ±‚ã€‚åœ¨Linuxä¸‹RPCæœåŠ¡ç”±portmapæœåŠ¡æ§åˆ¶ã€‚</p><h4 id="4-1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ"><a href="#4-1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ" class="headerlink" title="4.1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ:"></a>4.1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ:</h4><ul><li>nfs - å¯åŠ¨ç›¸åº”RPCæœåŠ¡è¿›ç¨‹æ¥æœåŠ¡å¯¹äºNFSæ–‡ä»¶ç³»ç»Ÿçš„è¯·æ±‚.</li><li>nfslock - ä¸€ä¸ªå¯é€‰çš„æœåŠ¡ï¼Œç”¨äºå¯åŠ¨ç›¸åº”çš„RPCè¿›ç¨‹ï¼Œå…è®¸NFSå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ä¸Šå¯¹æ–‡ä»¶åŠ é”.</li><li>portmap - Linuxçš„RPCæœåŠ¡,å®ƒå“åº”RPCæœåŠ¡çš„è¯·æ±‚å’Œä¸è¯·æ±‚çš„RPCæœåŠ¡å»ºç«‹è¿æ¥.</li></ul><h4 id="4-2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡"><a href="#4-2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡" class="headerlink" title="4.2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡"></a>4.2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡</h4><ul><li>rpc.mountd - è¿™ä¸ªè¿›ç¨‹æ¥å—æ¥è‡ªNFSå®¢æˆ·ç«¯çš„åŠ è½½è¯·æ±‚å’ŒéªŒè¯è¯·æ±‚çš„æ–‡ä»¶ç³»ç»Ÿæ­£åœ¨è¢«è¾“å‡º.è¿™ä¸ªè¿›ç¨‹ç”±NFSæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li><li>rpc.nfsd - è¿™ä¸ªè¿›ç¨‹æ˜¯NFSæœåŠ¡å™¨.å®ƒå’ŒLinuxæ ¸å¿ƒä¸€èµ·å·¥ä½œæ¥æ»¡è¶³NFSå®¢æˆ·ç«¯çš„åŠ¨æ€éœ€æ±‚ï¼Œä¾‹å¦‚æä¾›ä¸ºæ¯ä¸ªNFSå®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚æœåŠ¡å™¨çº¿ç¨‹.è¿™ä¸ªè¿›ç¨‹å¯¹åº”äºnfsæœåŠ¡.</li><li>rpc.lockd - ä¸€ä¸ªå¯é€‰çš„è¿›ç¨‹ï¼Œå®ƒå…è®¸NFSå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ä¸Šå¯¹æ–‡ä»¶åŠ é”.è¿™ä¸ªè¿›ç¨‹å¯¹åº”äºnfslockæœåŠ¡.</li><li>rpc.statd - è¿™ä¸ªè¿›ç¨‹å®ç°äº†ç½‘ç»œçŠ¶æ€ç›‘æ§(NSM)RPCåè®®,é€šçŸ¥NFSå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ä¸€ä¸ªNFSæœåŠ¡å™¨éæ­£å¸¸é‡å¯åŠ¨.è¿™ä¸ªè¿›ç¨‹è¢«nfslockæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li><li>rpc.rquotad - è¿™ä¸ªè¿›ç¨‹å¯¹äºè¿œç¨‹ç”¨æˆ·æä¾›ç”¨æˆ·é…é¢ä¿¡æ¯. è¿™ä¸ªè¿›ç¨‹è¢«nfsæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sé›†ç¾¤éƒ¨ç½²heapster</title>
    <url>/2019/09/02/k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2heapster/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>kubernetesé›†ç¾¤å¯ç”¨tlsè®¤è¯éƒ¨ç½²heapsterï¼Œåœ¨éƒ¨ç½²æœŸé—´é‡åˆ°äº†å¾ˆå¤šçš„å‘ï¼Œèµ°è¿‡å¾ˆå¤šé›·ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹,ä¸è¿‡åœ¨æ–°ç‰ˆæœ¬ä¸­heapsterè¢«metrics-serverä»£æ›¿äº†ï¼Œmetrics-serveråç¯‡ä»‹ç»å’Œä½¿ç”¨</p><h2 id="1ã€å‡†å¤‡å·¥ä½œ"><a href="#1ã€å‡†å¤‡å·¥ä½œ" class="headerlink" title="1ã€å‡†å¤‡å·¥ä½œ"></a>1ã€å‡†å¤‡å·¥ä½œ</h2><p>ä¸‹è½½éœ€è¦çš„æ–‡ä»¶ï¼Œè¿™é‡Œç”¨ä¹‹å‰k8s-heapsteréƒ¨ç½²çš„æ–‡ä»¶æ‹¿æ¥è¿›è¡Œä¿®æ”¹ï¼Œ<a href="https://github.com/xxlaila/kubernetes-yaml/" target="_blank" rel="noopener">æ–‡ä»¶åœ°å€</a></p><h3 id="2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º"><a href="#2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º" class="headerlink" title="2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º"></a>2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes-yaml/heapster-influxdb-grafana</span></span><br><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li><strong>é”™è¯¯æç¤º</strong>: è¿™é‡Œåœ¨æ‰§è¡Œåˆ›å»ºåï¼Œæ²¡æœ‰å›¾åƒæ˜¾ç¤ºï¼ŒæŸ¥çœ‹podsæ—¥å¿—å‘ç°é”™è¯¯<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system|grep he</span></span><br><span class="line">heapster-7b7b4754d-5p7tb                1/1     Running   0          17m</span><br><span class="line"><span class="comment"># kubectl logs heapster-7b7b4754d-5p7tb -n kube-system</span></span><br><span class="line">E0902 10:57:11.804543       1 reflector.go:190] k8s.io/heapster/metrics/processors/namespace_based_enricher.go:89: Failed to list *v1.Namespace: namespaces is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list resource <span class="string">"namespaces"</span> <span class="keyword">in</span> API group <span class="string">""</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br><span class="line">E0902 10:57:12.071117       1 reflector.go:190] k8s.io/heapster/metrics/util/util.go:30: Failed to list *v1.Node: nodes is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list resource <span class="string">"nodes"</span> <span class="keyword">in</span> API group <span class="string">""</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br></pre></td></tr></table></figure></li></ul><ul><li>æ’é”™<br>æŸ¥çœ‹ClusterRole: system:heapsterçš„æƒé™,å‘ç°å¹¶æ²¡æœ‰</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:heapster</span></span><br><span class="line">Error from server (NotFound): clusterroles.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br></pre></td></tr></table></figure><p>æç¤ºè¿™ä¸ªé”™è¯¯ï¼Œåº”è¯¥æ˜¯æˆ‘ä¹‹å‰éƒ¨ç½²è¿‡ï¼Œç„¶åä¿®æ”¹è¿‡æƒé™ï¼Œä¸å°å¿ƒç»™åˆ æ‰å•¦ï¼Œè¿™é‡Œéœ€è¦å§æƒé™é‡å»ºä¸€æ¬¡å°±å¥½äº†ï¼Œ<a href="https://www.cnblogs.com/vincenshen/p/9638162.html" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><ul><li>æ–°å»ºheapster-clusterrole.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster-clusterrole.yaml </span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:heapster</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  - namespaces</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br></pre></td></tr></table></figure></li></ul><p>å¹¶æ‰§è¡Œ kubectl apply -f heapster-clusterrole.yaml,åœ¨æ¬¡æŸ¥çœ‹æ—¥å¿—ï¼Œå‘ç°ä¹‹å‰çš„é”™è¯¯æ²¡æœ‰äº†ï¼Œä½†æ˜¯åˆå‡ºç°äº†ä¸€ä¸ªæ–°çš„é”™è¯¯<br><code>E0902 11:27:05.025300 1 manager.go:101] Error in scraping containers from kubelet:172.21.16.204:10250: failed to get all container stats from Kubelet URL &quot;https://172.21.16.204:10250/stats/container/&quot;: request failed - &quot;401 Unauthorized&quot;, response: &quot;Unauthorized&quot;</code></p><ul><li><p>ä¿®æ”¹heapster-clusterrole.yamlæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶é‡Œé¢æˆ‘ä»¬æ·»åŠ å‡ ä¸ªæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster-clusterrole.yaml </span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:heapster</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  - namespaces</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f heapster-clusterrole.yaml</span></span><br><span class="line"><span class="comment"># é‡æ–°åˆ›å»ºheapster</span></span><br><span class="line"><span class="comment"># kubectl delete -f heapster.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f heapster.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>å®Œæˆä»¥åæˆ‘ä»¬ç»§ç»­çœ‹heapster podçš„æ—¥å¿—ï¼Œå‘ç°æ—¥å¿—é‡Œé¢è¿˜æ˜¯å‡ºç°<code>401 Unauthorized&quot;, response: &quot;Unauthorized&quot;</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹nodeèŠ‚ç‚¹ kubelet å¯åŠ¨çš„é…ç½®å‚æ•°ï¼Œæ·»åŠ <code>--authentication-token-webhook</code>å‚æ•°: ä½¿ç”¨tokenreview APIæ¥è¿›è¡Œä»¤ç‰Œè®¤è¯ã€‚Kubelet åœ¨é…ç½®çš„ API server ä¸Šè°ƒç”¨ TokenReview API ä»¥ç¡®å®šæ¥è‡ª bearer token çš„ç”¨æˆ·ä¿¡æ¯ã€‚<a href="https://k8smeetup.github.io/docs/admin/kubelet-authentication-authorization/" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a>ï¼Œ<a href="https://github.com/kubernetes-retired/heapster/issues/1936" target="_blank" rel="noopener">githubä¸Šé”™è¯¯è§£å†³</a>ï¼Œ <a href="https://jimmysong.io/posts/user-authentication-in-kubernetes/" target="_blank" rel="noopener">å‚æ•°æ–‡ç« å­¦ä¹ </a></p><p>åˆ°æ­¤ä¸ºæ­¢: é”™è¯¯æ²¡æœ‰å•¦ï¼Œä½†æ˜¯ç•Œé¢æ•°æ®æ²¡å‡ºæ¥ï¼Œç¨ç­‰ç‰‡åˆ»</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>heapster</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sé…ç½®Dashboard</title>
    <url>/2019/08/29/k8s%E9%85%8D%E7%BD%AEDashboard/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;K8S Dashboardæ˜¯å®˜æ–¹çš„ä¸€ä¸ªåŸºäºWEBçš„ç”¨æˆ·ç•Œé¢ï¼Œä¸“é—¨ç”¨æ¥ç®¡ç†K8Sé›†ç¾¤ï¼Œå¹¶å¯å±•ç¤ºé›†ç¾¤çš„çŠ¶æ€ã€‚K8Sé›†ç¾¤å®‰è£…å¥½åé»˜è®¤æ²¡æœ‰åŒ…å«Dashboardï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–åˆ›å»ºå®ƒã€‚</p><h3 id="1ã€å®‰è£…dashboard"><a href="#1ã€å®‰è£…dashboard" class="headerlink" title="1ã€å®‰è£…dashboard"></a>1ã€å®‰è£…dashboard</h3><h4 id="1-1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶"><a href="#1-1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶" class="headerlink" title="1.1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶"></a>1.1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶</h4><p>ç»è¿‡ä¿®æ”¹è¿‡åçš„æ–‡ä»¶ï¼Œå·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„<a href="https://github.com/xxlaila/kubernetes-yaml/" target="_blank" rel="noopener">æ–‡ä»¶</a></p><a id="more"></a><ul><li>åˆ›å»ºdashboard<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl create -f kubernetes-dashboard.yaml </span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br></pre></td></tr></table></figure></li></ul><h4 id="1-2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod"><a href="#1-2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod" class="headerlink" title="1.2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod"></a>1.2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl get service --all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">default       kubernetes             ClusterIP   10.254.0.1      &lt;none&gt;        443/TCP         18h</span><br><span class="line">kube-system   coredns                ClusterIP   10.254.0.10     &lt;none&gt;        53/UDP,53/TCP   16h</span><br><span class="line">kube-system   kubernetes-dashboard   NodePort    10.254.51.226   &lt;none&gt;        443:30001/TCP   15h</span><br></pre></td></tr></table></figure><ul><li><p>æŸ¥çœ‹serviceæè¿°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl describe  service kubernetes-dashboard -n kube-system</span></span><br><span class="line">Name:                     kubernetes-dashboard</span><br><span class="line">Namespace:                kube-system</span><br><span class="line">Labels:                   k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 k8s-app=kubernetes-dashboard</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP:                       10.254.51.226</span><br><span class="line">Port:                     &lt;<span class="built_in">unset</span>&gt;  443/TCP</span><br><span class="line">TargetPort:               8443/TCP</span><br><span class="line">NodePort:                 &lt;<span class="built_in">unset</span>&gt;  30001/TCP</span><br><span class="line">Endpoints:                10.254.39.3:8443</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹podæè¿°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl describe pod kubernetes-dashboard-6c655d9445-6zntr --namespace=kube-system</span></span><br><span class="line">Name:           kubernetes-dashboard-6c655d9445-6zntr</span><br><span class="line">Namespace:      kube-system</span><br><span class="line">Node:           172.21.17.31/172.21.17.31</span><br><span class="line">Start Time:     Thu, 29 Aug 2019 17:47:20 +0800</span><br><span class="line">Labels:         k8s-app=kubernetes-dashboard</span><br><span class="line">                pod-template-hash=6c655d9445</span><br><span class="line">Annotations:    &lt;none&gt;</span><br><span class="line">Status:         Running</span><br><span class="line">IP:             10.254.39.3</span><br></pre></td></tr></table></figure></li></ul><h3 id="2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™"><a href="#2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™" class="headerlink" title="2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™"></a>2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™</h3><p>è‹¥æœä¸è¿›è¡Œæˆæƒæ“ä½œï¼Œæ‰“å¼€dashboardä¼šæŠ¥é”™ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/WechatIMG28864.png" alt="img"></p><ul><li><p>æ–°å»ºkubrnetes-dashboard-admin-rbac.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubernetes-dashboard-admin-rbac.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Create ClusterRoleBinding</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f kubernetes-dashboard-admin-rbac.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>æ‰¾åˆ°kubernete-dashboard-adminçš„tokenï¼Œå¤åˆ¶tokenåœ¨dashboardé¡µé¢è¿›è¡Œç™»å½•ï¼Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl -n kube-system get secret | grep admin-user</span></span><br><span class="line">admin-user-token-qv49g             kubernetes.io/service-account-token   3      15h</span><br><span class="line"></span><br><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '&#123;print $1&#125;')</span></span><br><span class="line">Name:         admin-user-token-qv49g</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: ea3f0e3f-ca42-11e9-8716-fa163effd55b</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1359 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXF2NDlnIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlYTNmMGUzZi1jYTQyLTExZTktODcxNi1mYTE2M2VmZmQ1NWIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.AbdsJdgi9d0rCYrmvoJkWf32HKSMT03OyOX55aRhPptjzIjDcGxxQYecT0w58N7Z_2L2RwTBfOrm4B3wTEDfFZKgYsnGJQOzJMtZDN9w5YJg2xGQ27E3KisTbbQzd_I5DgxSZWW75GwWf756_bIQpWuXNRO_KjheyWuNNv0tSEYRiXpcboSQpb-8R-Km-vP85mxke6s5cJFSk0WLMjFWow1vOF1ns23NZ5nslEmYOMZF3_Fxybh3LbiCyrpD4c0FtfRcXaBIBqACeyCPRriYMIIJq3OJjI-DzuqUedu1x2xH2prB4mNjxlKt2-7q0M1zCuvm5JhW_LzWgveu9ni2ig</span><br></pre></td></tr></table></figure><h3 id="3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜"><a href="#3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜" class="headerlink" title="3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜"></a>3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;dashboard æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œé»˜è®¤çš„tokenå¤±æ•ˆçš„æ—¶é—´æ˜¯900ç§’ï¼Œ15åˆ†é’Ÿï¼Œæ¯15åˆ†é’Ÿå°±è¦è¿›è¡Œä¸€æ¬¡è®¤è¯ï¼Œè¿™æ ·å¯¹äºè¿ç»´äººå‘˜æ¥è¯´å°±ä¸æ˜¯ç‰¹åˆ«çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹token-ttlå‚æ•°æ¥è®¾ç½®ï¼Œä¸»è¦æ˜¯ä¿®æ”¹dashboradçš„yamlæ–‡ä»¶ï¼Œå¹¶é‡æ–°å»ºç«‹å³å¯</p><h4 id="3-1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹-æ·»åŠ "><a href="#3-1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹-æ·»åŠ " class="headerlink" title="3.1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹/æ·»åŠ "></a>3.1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹/æ·»åŠ </h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- containerPort: 8443</span><br><span class="line">  protocol: TCP</span><br><span class="line">args:</span><br><span class="line">  - --auto-generate-certificates</span><br><span class="line">  - --token-ttl=43200</span><br></pre></td></tr></table></figure><ul><li>é‡å»ºpod<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl apply -f kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>æˆ‘ä»¬å¯ä»¥è¾“å…¥ä»»æ„èŠ‚ç‚¹çš„ipåŠ 30001ç«¯å£å°±å¯ä»¥è®¿é—®dashboard, https://{ip}:30001ã€‚</p><h3 id="å…¶ä»–æ“ä½œ"><a href="#å…¶ä»–æ“ä½œ" class="headerlink" title="å…¶ä»–æ“ä½œ"></a>å…¶ä»–æ“ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ¯å¤©æˆ‘ä»¬æ¥å…¬å¸è¦ç™»å½•dashboardçš„æ—¶å€™éƒ½è¦å»è¾“å…¥ä¸€æ¬¡tokenï¼Œæ¯æ¬¡å»è·å–tokençš„æ—¶å€™éƒ½è¦è¾“å…¥å¾ˆé•¿çš„ä¸€ä¸²ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥å†™ä¸€ä¸ªè„šæœ¬ï¼Œè¦tokençš„æ—¶å€™æ‰§è¡Œä¸€ä¸‹è„šæœ¬ï¼Œå°±å¯ä»¥ã€‚</p><ul><li><p>åˆ›å»ºè„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim kube-token</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®è„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chmod +x kube-token</span></span><br><span class="line"><span class="comment"># mv kube-token /usr/bin</span></span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>k8såˆ é™¤nodeé‡æ–°åŠ å…¥</title>
    <url>/2019/08/29/k8s%E5%88%A0%E9%99%A4node%E9%87%8D%E6%96%B0%E5%8A%A0%E5%85%A5/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;æœ‰æ—¶å€™k8s node åœ¨åŠ å…¥é›†ç¾¤çš„æ—¶å€™ä¸ç»æ„çš„æ—¶å€™å¼„é”™å•¦æŸäº›ä¸œè¥¿ï¼Œè¿™æ—¶å€™å¯ä»¥æŠŠè¿™ä¸ªnodeåˆ é™¤ï¼Œç„¶åé‡æ–°åŠ å…¥ï¼Œåˆ é™¤èŠ‚ç‚¹ä¹‹å‰æˆ‘ä»¬éœ€è¦åšä¸€ä¸‹å¸¸è§„åŒ–çš„æ“ä½œï¼Œæ¥ä¿éšœè¿è¡Œåœ¨è¯¥èŠ‚ç‚¹çš„podè¿ç§»åˆ°å…¶ä»–çš„nodeä¸Šã€‚</p><a id="more"></a><ul><li><p>1ã€å…ˆé©±èµ¶ä¸Šé¢çš„pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl drain 172.21.110 --delete-local-data</span></span><br><span class="line">node/172.21.110 cordoned</span><br><span class="line">node/172.21.110 drained</span><br></pre></td></tr></table></figure></li><li><p>2ã€åˆ é™¤èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl delete node 172.21.110</span></span><br><span class="line">node <span class="string">"172.21.110"</span> deleted</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>kubectl delete</code> å‘½ä»¤æœ¬èº«æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥è¿›è¡Œä»»ä½•èµ„æºçš„åˆ é™¤<code>kubectl delete type typename</code>ï¼Œtypeæ˜¯èµ„æºç±»å‹ï¼Œå¯ä»¥æ˜¯<code>node, pod, rs, rc, deployment, service</code>ç­‰ç­‰ï¼Œtypenameæ˜¯è¿™ä¸ªèµ„æºçš„åç§°</p><ul><li><p>3ã€æŸ¥çœ‹nodeæ˜¯å¦è¢«åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.17.30   Ready    &lt;none&gt;   20m   v1.13.3</span><br><span class="line">172.21.17.31   Ready    &lt;none&gt;   10m   v1.13.3</span><br></pre></td></tr></table></figure></li><li><p>4ã€å½»åº•åˆ é™¤node<br>è¿›å…¥è¯¥èŠ‚ç‚¹ã€‚åˆ é™¤<code>kubelet.kubeconfig</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-3 kubernetes]<span class="comment"># rm -rf  kubelet.kubeconfig</span></span><br></pre></td></tr></table></figure></li><li><p>4ã€nodeé‡æ–°åŠ å…¥é›†ç¾¤<br>&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬çš„nodeæ‰§è¡Œåˆ é™¤ä»¥åï¼Œé‡æ–°å¯åŠ¨kubeletæœåŠ¡ä»¥åã€‚nodeåˆä¼šè‡ªåŠ¨çš„åŠ å…¥åˆ°é›†ç¾¤é‡Œé¢æ¥ï¼Œæ€ä¹ˆå½»åº•çš„åˆ é™¤ï¼Œè®©åé‡å¯kubeletçš„æ—¶å€™é‡æ–°åƒé›†ç¾¤é‡Œé¢å‘å‡ºcsrè¯·æ±‚ï¼Œé›†ç¾¤é‡æ–°é€šè¿‡è¯¥èŠ‚ç‚¹çš„csrè¯·æ±‚å§è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤æ¥ï¼Œ<code>kubelet.kubeconfig</code>ä¹Ÿé‡æ–°ç”Ÿæˆ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE     REQUESTOR           CONDITION</span><br><span class="line">node-csr-H1CAqJw4VZYY67-tk4Akuso_uuPPwpj3d5jK3xcL88M   8m      kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-YPvpbITaxGBrOxuCpGiY7jrGpPNSZ4sdbKhSkUEcdnc   7m54s   kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek   5s      kubelet-bootstrap   Pending</span><br><span class="line">node-csr-u4oi5e0Upt-ZmejSDEFm9Q0RU3wZf9bThU_o51nclgg   17m     kubelet-bootstrap   Approved,Issued</span><br></pre></td></tr></table></figure></li><li><p>5ã€é‡æ–°é€šè¿‡csr</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl certificate approve node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek </span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek approved</span><br></pre></td></tr></table></figure></li><li><p>6ã€åœ¨é›†ç¾¤æŸ¥çœ‹èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.16.110   Ready    &lt;none&gt;   36s   v1.13.3</span><br><span class="line">172.21.17.30    Ready    &lt;none&gt;   28m   v1.13.3</span><br><span class="line">172.21.17.31    Ready    &lt;none&gt;   17m   v1.13.3</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>node</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos routeç­–ç•¥</title>
    <url>/2019/08/28/Centos-route%E7%AD%96%E7%95%A5/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸ä¸šåŠ¡åœ¨ä¸€ä¸ªæ–°çš„äº‘å¹³å°ä¸Šçº¿ï¼Œè¯¥äº‘å¹³å°ä½¿ç”¨çš„æ˜¯æ¯”è¾ƒä¼ ç»Ÿçš„VMware vSphereæ¥åšçš„è™šæ‹ŸåŒ–ï¼Œè€Œä¸”è¯¥äº‘å¹³å°ç½‘ç»œä¹Ÿæ˜¯æˆ‘ä»¬ä¸æ¸…æ¥šçš„ï¼Œåæ­£å°±æ˜¯ä¸èƒ½è®¾ç½®(ä¸èƒ½åƒç°åœ¨ä¸»æµäº‘å¹³å°è‡ªå®šä¹‰ç½‘ç»œæˆ–è€…æ˜¯åœ°å€æ®µ)ï¼Œæ˜¯ä¸€ä¸ªæ”¿åºœçš„äº‘å¹³å°ï¼Œå…·ä½“å„ç§å¥‡è‘©çš„é™åˆ¶å°±ä¸è¯´å•¦ï¼Œä½ æ‡‚çš„â€¦â€¦</p></blockquote><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;æ ¹æ®æˆ‘ä»¬è‡ªèº«ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå†…ç½‘åœ°å€æ®µï¼Œå’Œå¯¹æ–¹åå•†åç»™æˆ‘ä»¬å¼€äº†ä¸€ä¸ª10ç½‘æ®µï¼Œ20çš„å­ç½‘ï¼Œç„¶åè¦äº†ä¸¤å°å¸¦æœ‰å¤–ç½‘ipçš„æœåŠ¡å™¨ï¼Œä¸€ä¸ªç”¨æ¥åšè·³æ¿æœºï¼Œä¸€ä¸ªç”¨æ¥åšåå‘ä»£ç†ã€‚ç„¶åç­‰äº†ä¸¤å¤©å¯¹æ–¹å§æœåŠ¡å™¨ç»™æˆ‘ä»¬å¼€å¥½äº†ï¼Œæˆ‘ä»¬ç™»å½•è·³æ¿æœºï¼Œå‘ç°åªæœ‰å¤–ç½‘ipçš„æœåŠ¡å™¨æ‰èƒ½ä¸Šç½‘ï¼Œå…¶ä»–çš„å‡ä¸èƒ½ä¸Šç½‘ï¼Œåšnatä¹Ÿä¸èƒ½ä¸Šï¼Œä½†æ˜¯è·³æ¿æœºæ˜¯å…¬ç½‘ï¼Œæ²¡æœ‰å†…ç½‘ï¼Œå¯ä»¥é€šå†…ç½‘çš„ipæœåŠ¡å™¨ï¼Œæ‰€ä»¥çŒœæµ‹ç½‘ç»œç­–ç•¥è‚¯å®šæ˜¯ä»–ä»¬åœ¨äº¤æ¢æœºä¸Šåšçš„ã€‚ç„¶åæˆ‘ä»¬è‡ªå·±yumæºæ¥å®‰è£…ä¸€äº›ä¸­é—´ä»¶ã€‚ï¼ˆä¸è¯´äº†ï¼Œåé¢è¿˜æœ‰ä¸€å †çš„å¥‡è‘©é—®é¢˜ï¼Œè¿›å…¥æ­£é¢˜å§ï¼‰</p><h3 id="åæœŸé—®é¢˜"><a href="#åæœŸé—®é¢˜" class="headerlink" title="åæœŸé—®é¢˜"></a>åæœŸé—®é¢˜</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬æŠŠä¸šåŠ¡éƒ¨ç½²ä¸Šçº¿ä»¥åï¼Œè¿è¡Œä¸€æ®µæ—¶é—´åå‡ºç°å¾®æœåŠ¡ä¹‹é—´è°ƒç”¨è¶…æ—¶ï¼Œç„¶åæˆ‘ä»¬ç™»å½•æœåŠ¡å™¨æ’æŸ¥ç½‘ç»œé—®é¢˜ï¼Œåœ¨æœåŠ¡å™¨ä¹‹é—´pingå†…ç½‘æ²¡é—®é¢˜ï¼Œpingæ³¨å†Œä¸­å¿ƒã€æ•°æ®åº“éƒ½æ²¡é—®é¢˜ã€‚æœåŠ¡å™¨æœ‰å…¬ç½‘ï¼Œç„¶åå…¬ç½‘ä¹‹é—´pingéƒ½æ²¡é—®é¢˜ï¼Œç½‘ç»œå±‚é¢æ²¡æœ‰ä»»ä½•çš„é—®é¢˜ï¼ŒæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ä¹Ÿæœ‰å‘ç°é”™è¯¯ï¼Œç„¶åå•ç‹¬çš„å§å€Ÿå£åœ°å€æ‹¿å‡ºæ¥è¿›è¡Œ<code>curl</code>èƒ½è¿‡ä½†æ˜¯æœ‰ç‚¹æ…¢ï¼Œç„¶åå°±å§è¿™ä¸ªå‘½ä»¤å†™åœ¨è„šæœ¬é‡Œé¢ï¼Œè®©ä»–æ¯30ç§’è·‘ä¸€æ¬¡ï¼Œç„¶åè¿½åŠ æ—¥å¿—ï¼Œè·‘äº†ä¸¤ä¸‰ä¸ªå°æ—¶ï¼Œæˆ‘ä»¬æŸ¥çœ‹æ—¥å¿—ï¼Œæ—¥å¿—é‡Œé¢ä¹Ÿæœ‰è¶…æ—¶ç°è±¡ï¼Œå¥‡æ€ªäº†ï¼Œç„¶åå§è¿™ä¸ªé—®é¢˜è”ç³»å¯¹æ–¹äº‘å¹³å°çš„å·¥ç¨‹å¸ˆï¼Œç³»ç»Ÿå·¥ç¨‹å¸ˆã€ç½‘ç»œå·¥ç¨‹å¸ˆæ‹‰ç¾¤è®¨è®ºï¼Œæœ€åå¯¹æ–¹ç³»ç»Ÿå·¥ç¨‹å¸ˆæç¤ºæˆ‘ä»¬è®©æˆ‘ä»¬å§è·¯ç”±çš„<code>Metric</code>å€¼ä¸¤ä¸ªç½‘å¡ä¸è¦ä¸€æ ·ï¼Œå¯¹<code>Metric</code>åˆšå¼€å§‹ä¸€å¹´æ‡µé€¼ï¼Œå…ˆä¸ç®¡ï¼Œè§£å†³é—®é¢˜å†è¯´ï¼š</p><ul><li><p>ä¿®æ”¹Metric(å†…ç½‘å¡)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br><span class="line">$ sudo route add -net 10.10.20.0/22 dev ens160 metric 98</span><br><span class="line">$ sudo route  del -net 10.10.20.0/22 dev ens160 metric 100</span><br></pre></td></tr></table></figure></li><li><p>è®°ä½æ˜¯å…ˆæ·»åŠ åˆ é™¤ï¼Œé¡ºåºä¸è¦é¢ å€’</p></li><li><p>æŸ¥çœ‹è·¯ç”±</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         119.126.116.254 0.0.0.0         UG    100    0        0 ens192</span><br><span class="line">10.10.20.0      0.0.0.0         255.255.252.0   U     98     0        0 ens160</span><br><span class="line">119.126.116.128 0.0.0.0         255.255.255.128 U     100    0        0 ens192</span><br></pre></td></tr></table></figure></li><li><p>ens192(å¤–ç½‘å¡)</p></li><li><p>ens160(å†…ç½‘å¡)</p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;æ¶‰åŠåˆ°çš„ä¸šåŠ¡æœåŠ¡å™¨éƒ½ä¿®æ”¹ï¼Œä¿®æ”¹Metricå€¼ä»¥åï¼Œæˆ‘ä»¬<code>curl</code>ä¸€æ¬¡ï¼Œé€Ÿåº¦æ¯”ä»¥å‰å¿«å¤šäº†ï¼Œåˆè·‘äº†ä¸€æ¬¡è„šæœ¬ï¼Œè§‚å¯Ÿäº†å‡ ä¸ªå°æ—¶æ²¡é—®é¢˜ï¼Œè§‚å¯Ÿäº†ä¸¤å¤©ï¼Œä¸šåŠ¡æ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œæ—¥å¿—é‡Œé¢ä¹Ÿæ²¡æœ‰å‡ºç°è¶…æ—¶ï¼Œé—®é¢˜å¾—åˆ°è§£å†³</p><h3 id="Metric-ä»‹ç»"><a href="#Metric-ä»‹ç»" class="headerlink" title="Metric ä»‹ç»"></a>Metric ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºè·¯ç”±æŒ‡å®šæ‰€éœ€è·ƒç‚¹æ•°çš„æ•´æ•°å€¼ï¼ˆèŒƒå›´æ˜¯ 1 ~ 9999ï¼‰ï¼Œå®ƒç”¨æ¥åœ¨è·¯ç”±è¡¨é‡Œçš„å¤šä¸ªè·¯ç”±ä¸­é€‰æ‹©ä¸è½¬å‘åŒ…ä¸­çš„ç›®æ ‡åœ°å€æœ€ä¸ºåŒ¹é…çš„è·¯ç”±ã€‚æ‰€é€‰çš„è·¯ç”±å…·æœ‰æœ€å°‘çš„è·ƒç‚¹æ•°ã€‚è·ƒç‚¹æ•°èƒ½å¤Ÿåæ˜ è·ƒç‚¹çš„æ•°é‡ã€è·¯å¾„çš„é€Ÿåº¦ã€è·¯å¾„å¯é æ€§ã€è·¯å¾„ååé‡ä»¥åŠç®¡ç†å±æ€§ã€‚Metricçš„å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼›å¦‚æœä¸¤å—ç½‘å¡çš„Metricçš„å€¼ç›¸åŒï¼Œå°±ä¼šå‡ºç°æŠ¢å ä¼˜å…ˆçº§ç»§è€Œç½‘å¡å†²çªï¼Œå°†ä¼šæœ‰ä¸€å—ç½‘å¡æ— æ³•è¿æ¥</p><p>æ›´å¤šä»‹ç»<a href="https://www.cyberciti.biz/faq/what-is-a-routing-table/" target="_blank" rel="noopener">å‚è€ƒ</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>route</tag>
        <tag>Metric</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²ingress</title>
    <url>/2019/08/26/k8s%E9%83%A8%E7%BD%B2ingress/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>åœ¨kubernetes é›†ç¾¤ä¸­ï¼Œä¸€ä¸ªæœåŠ¡å®‰è£…ä»¥åæ€ä¹ˆå¯¹å¤–æä¾›è®¿é—®ï¼Œå¤–éƒ¨ç”¨æˆ·æ€ä¹ˆæ¥è®¿é—®æˆ‘ä»¬å®¹å™¨ä¸­ä¸šåŠ¡ã€‚</p><p><img src="https://img.xxlaila.cn/2373874sds43.png" alt="img"></p><h3 id="1ã€Ingress-ä»‹ç»"><a href="#1ã€Ingress-ä»‹ç»" class="headerlink" title="1ã€Ingress ä»‹ç»"></a>1ã€Ingress ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes æš´éœ²æœåŠ¡çš„æ–¹å¼ç›®å‰åªæœ‰ä¸‰ç§ï¼šLoadBlancer Serviceã€NodePort Serviceã€Ingressï¼›æœ¬æ–‡ä¸»è¦é€šè¿‡Ingressæ¥è®¿é—®</p><h3 id="2ã€Ingress-æ˜¯ä»€ä¹ˆ"><a href="#2ã€Ingress-æ˜¯ä»€ä¹ˆ" class="headerlink" title="2ã€Ingress æ˜¯ä»€ä¹ˆ"></a>2ã€Ingress æ˜¯ä»€ä¹ˆ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Ingress å°±æ˜¯èƒ½åˆ©ç”¨ Nginxã€Haproxy å•¥çš„è´Ÿè½½å‡è¡¡å™¨æš´éœ²é›†ç¾¤å†…æœåŠ¡çš„å·¥å…·é—®é¢˜æ¥äº†ï¼Œé›†ç¾¤å†…æœåŠ¡æƒ³è¦æš´éœ²å‡ºå»é¢ä¸´ç€å‡ ä¸ªé—®é¢˜ï¼š</p><a id="more"></a><ul><li><p>Pod æ¼‚ç§»é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¼—æ‰€å‘¨çŸ¥ Kubernetes å…·æœ‰å¼ºå¤§çš„å‰¯æœ¬æ§åˆ¶èƒ½åŠ›ï¼Œèƒ½ä¿è¯åœ¨ä»»æ„å‰¯æœ¬(Pod)æŒ‚æ‰æ—¶è‡ªåŠ¨ä»å…¶ä»–æœºå™¨å¯åŠ¨ä¸€ä¸ªæ–°çš„ï¼Œè¿˜å¯ä»¥åŠ¨æ€æ‰©å®¹ç­‰ï¼Œæ€»ä¹‹ä¸€å¥è¯ï¼Œè¿™ä¸ª Pod å¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»å‡ºç°åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»æ­»åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šï¼›é‚£ä¹ˆè‡ªç„¶éšç€ Pod çš„åˆ›å»ºå’Œé”€æ¯ï¼ŒPod IP è‚¯å®šä¼šåŠ¨æ€å˜åŒ–ï¼›é‚£ä¹ˆå¦‚ä½•æŠŠè¿™ä¸ªåŠ¨æ€çš„ Pod IP æš´éœ²å‡ºå»ï¼Ÿè¿™é‡Œå€ŸåŠ©äº Kubernetes çš„ Service æœºåˆ¶ï¼ŒService å¯ä»¥ä»¥æ ‡ç­¾çš„å½¢å¼é€‰å®šä¸€ç»„å¸¦æœ‰æŒ‡å®šæ ‡ç­¾çš„ Podï¼Œå¹¶ç›‘æ§å’Œè‡ªåŠ¨è´Ÿè½½ä»–ä»¬çš„ Pod IPï¼Œé‚£ä¹ˆæˆ‘ä»¬å‘å¤–æš´éœ²åªæš´éœ² Service IP å°±è¡Œäº†ï¼›è¿™å°±æ˜¯ NodePort æ¨¡å¼ï¼šå³åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¼€èµ·ä¸€ä¸ªç«¯å£ï¼Œç„¶åè½¬å‘åˆ°å†…éƒ¨ Service IP ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://img.xxlaila.cn/4dfs98347sdhsfs.png" alt="img"></p></li><li><p>ç«¯å£ç®¡ç†é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;é‡‡ç”¨ NodePort æ–¹å¼æš´éœ²æœåŠ¡é¢ä¸´ä¸€ä¸ªå‘çˆ¹çš„é—®é¢˜æ˜¯ï¼ŒæœåŠ¡ä¸€æ—¦å¤šèµ·æ¥ï¼ŒNodePort åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¼€å¯çš„ç«¯å£ä¼šåŠå…¶åºå¤§ï¼Œè€Œä¸”éš¾ä»¥ç»´æŠ¤ï¼›è¿™æ—¶å€™å¼•å‡ºçš„æ€è€ƒé—®é¢˜æ˜¯ â€œèƒ½ä¸èƒ½ä½¿ç”¨ Nginx å•¥çš„åªç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œæ¯”å¦‚ 80ï¼Œç„¶åæŒ‰ç…§åŸŸåå‘åè½¬å‘ï¼Ÿâ€ ç®€å•çš„å®ç°å°±æ˜¯ä½¿ç”¨ DaemonSet åœ¨æ¯ä¸ª node ä¸Šç›‘å¬ 80ï¼Œç„¶åå†™å¥½è§„åˆ™ï¼Œå› ä¸º Nginx å¤–é¢ç»‘å®šäº†å®¿ä¸»æœº 80 ç«¯å£(å°±åƒ NodePort)ï¼Œæœ¬èº«åˆåœ¨é›†ç¾¤å†…ï¼Œé‚£ä¹ˆå‘åç›´æ¥è½¬å‘åˆ°ç›¸åº” Service IP å°±è¡Œäº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://img.xxlaila.cn/85793kdfksdo43.png" alt="img"></p></li><li><p>åŸŸååˆ†é…åŠåŠ¨æ€æ›´æ–°é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢çš„æ€è·¯ï¼Œé‡‡ç”¨ Nginx ä¼¼ä¹å·²ç»è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯å…¶å®è¿™é‡Œé¢æœ‰ä¸€ä¸ªå¾ˆå¤§ç¼ºé™·ï¼šæ¯æ¬¡æœ‰æ–°æœåŠ¡åŠ å…¥æ€ä¹ˆæ”¹ Nginx é…ç½®ï¼Ÿæ€»ä¸èƒ½æ‰‹åŠ¨æ”¹æˆ–è€…æ¥ä¸ª Rolling Update å‰ç«¯ Nginx Pod å§ï¼Ÿè¿™æ—¶å€™ â€œä¼Ÿå¤§è€Œåˆæ­£ç›´å‹‡æ•¢çš„â€ Ingress ç™»åœºï¼Œå¦‚æœä¸ç®—ä¸Šé¢çš„ Nginxï¼ŒIngress åªæœ‰ä¸¤å¤§ç»„ä»¶ï¼šIngress Controller å’Œ Ingress<br>&nbsp;&nbsp;&nbsp;&nbsp;Ingress ç®€å•çš„ç†è§£å°±æ˜¯ ä½ åŸæ¥è¦æ”¹ Nginx é…ç½®ï¼Œç„¶åé…ç½®å„ç§åŸŸåå¯¹åº”å“ªä¸ª Serviceï¼Œç°åœ¨æŠŠè¿™ä¸ªåŠ¨ä½œæŠ½è±¡å‡ºæ¥ï¼Œå˜æˆä¸€ä¸ª Ingress å¯¹è±¡ï¼Œä½ å¯ä»¥ç”¨ yml åˆ›å»ºï¼Œæ¯æ¬¡ä¸è¦å»æ”¹ Nginx äº†ï¼Œç›´æ¥æ”¹ yml ç„¶ååˆ›å»º/æ›´æ–°å°±è¡Œäº†ï¼›é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šâ€Nginx å’‹æ•´ï¼Ÿâ€<br>&nbsp;&nbsp;&nbsp;&nbsp;Ingress Controller è¿™ä¸œè¥¿å°±æ˜¯è§£å†³ â€œNginx å’‹æ•´â€ çš„ï¼›Ingress Controoler é€šè¿‡ä¸ Kubernetes API äº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ Ingress è§„åˆ™å˜åŒ–ï¼Œç„¶åè¯»å–ä»–ï¼ŒæŒ‰ç…§ä»–è‡ªå·±æ¨¡æ¿ç”Ÿæˆä¸€æ®µ Nginx é…ç½®ï¼Œå†å†™åˆ° Nginx Pod é‡Œï¼Œæœ€å reload ä¸€ä¸‹ï¼Œå·¥ä½œæµç¨‹å¦‚ä¸‹å›¾:</p></li></ul><p><img src="https://img.xxlaila.cn/3248kjfiy4789wodjkshf3.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;å½“ç„¶åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæœ€æ–°ç‰ˆæœ¬ Kubernetes å·²ç»å°† Nginx ä¸ Ingress Controller åˆå¹¶ä¸ºä¸€ä¸ªç»„ä»¶ï¼Œæ‰€ä»¥ Nginx æ— éœ€å•ç‹¬éƒ¨ç½²ï¼Œåªéœ€è¦éƒ¨ç½² Ingress Controller å³å¯ã€‚</p><h3 id="3ã€Nginx-Ingress"><a href="#3ã€Nginx-Ingress" class="headerlink" title="3ã€Nginx Ingress"></a>3ã€Nginx Ingress</h3><h4 id="3-1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶"><a href="#3-1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶" class="headerlink" title="3.1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶"></a>3.1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶</h4><p>å®˜æ–¹çš„mandatory.yamlæ–‡ä»¶é‡Œé¢åŒ…å«äº†ingress RBACï¼Œé‡è¦çš„ç»„ä»¶ <a href="https://github.com/kubernetes/ingress-nginx/tree/nginx-0.20.0/deploy" target="_blank" rel="noopener">Nginx+Ingres Controller</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mandatory.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-configuration</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: udp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-serviceaccount</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - endpoints</span><br><span class="line">      - nodes</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - nodes</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">"extensions"</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - events</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">      - patch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">"extensions"</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses/status</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">      - namespaces</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    resourceNames:</span><br><span class="line">      <span class="comment"># Defaults to "&lt;election-id&gt;-&lt;ingress-class&gt;"</span></span><br><span class="line">      <span class="comment"># Here: "&lt;ingress-controller-leader&gt;-&lt;nginx&gt;"</span></span><br><span class="line">      <span class="comment"># This has to be adapted if you change either parameter</span></span><br><span class="line">      <span class="comment"># when launching the nginx-ingress-controller.</span></span><br><span class="line">      - <span class="string">"ingress-controller-leader-nginx"</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - endpoints</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role-nisa-binding</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">      app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: <span class="string">"10254"</span></span><br><span class="line">        prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx-ingress-controller</span><br><span class="line">          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.22.0</span><br><span class="line">          args:</span><br><span class="line">            - /nginx-ingress-controller</span><br><span class="line">            - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class="line">            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class="line">            - --publish-service=$(POD_NAMESPACE)/ingress-nginx</span><br><span class="line">            - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line">     --default-ssl-certificate=$(POD_NAMESPACE)/ingress-secret</span><br><span class="line">      --default-backend-service=$(POD_NAMESPACE)/default-http-backend</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: <span class="literal">true</span></span><br><span class="line">            capabilities:</span><br><span class="line">              drop:</span><br><span class="line">                - ALL</span><br><span class="line">              add:</span><br><span class="line">                - NET_BIND_SERVICE</span><br><span class="line">            <span class="comment"># www-data -&gt; 33</span></span><br><span class="line">            runAsUser: 33</span><br><span class="line">          env:</span><br><span class="line">            - name: POD_NAME</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.name</span><br><span class="line">            - name: POD_NAMESPACE</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.namespace</span><br><span class="line">          ports:</span><br><span class="line">            - name: http</span><br><span class="line">              containerPort: 80</span><br><span class="line">              hostPort: 80</span><br><span class="line">            - name: https</span><br><span class="line">              containerPort: 443</span><br><span class="line">              hostPort: 443</span><br><span class="line">          livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">          readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>hostNetwork: true</code>æ˜¯å¢åŠ çš„ï¼Œ å®˜æ–¹çš„ Ingress Controller æœ‰ä¸ªå‘ï¼Œé»˜è®¤æ³¨é‡Šäº†hostNetwork å·¥ä½œæ–¹å¼ã€‚ä»¥é˜²æ­¢ç«¯å£çš„åœ¨å®¿ä¸»æœºçš„å†²çªã€‚æ²¡æœ‰ç»‘å®šåˆ°å®¿ä¸»æœº 80 ç«¯å£ï¼Œä¹Ÿå°±æ˜¯è¯´å‰ç«¯ Nginx æ²¡æœ‰ç›‘å¬å®¿ä¸»æœº 80 ç«¯å£ï¼›æ‰€ä»¥éœ€è¦æŠŠé…ç½®æä¸‹æ¥è‡ªå·±åŠ ä¸€ä¸‹ hostNetworkã€‚</p><h4 id="3-2ã€éƒ¨ç½²é»˜è®¤åç«¯"><a href="#3-2ã€éƒ¨ç½²é»˜è®¤åç«¯" class="headerlink" title="3.2ã€éƒ¨ç½²é»˜è®¤åç«¯"></a>3.2ã€éƒ¨ç½²é»˜è®¤åç«¯</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬çŸ¥é“ å‰ç«¯çš„ Nginx æœ€ç»ˆè¦è´Ÿè½½åˆ°åç«¯ service ä¸Šï¼Œé‚£ä¹ˆå¦‚æœè®¿é—®ä¸å­˜åœ¨çš„åŸŸåå’‹æ•´ï¼Ÿå®˜æ–¹ç»™å‡ºçš„å»ºè®®æ˜¯éƒ¨ç½²ä¸€ä¸ª é»˜è®¤åç«¯ï¼Œå¯¹äºæœªçŸ¥è¯·æ±‚å…¨éƒ¨è´Ÿè½½åˆ°è¿™ä¸ªé»˜è®¤åç«¯ä¸Šï¼›è¿™ä¸ªåç«¯å•¥ä¹Ÿä¸å¹²ï¼Œå°±æ˜¯è¿”å› 404ï¼Œéƒ¨ç½²å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat default-backend.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: default-http-backend</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - name: default-http-backend</span><br><span class="line">        <span class="comment"># Any image is permissable as long as:</span></span><br><span class="line">        <span class="comment"># 1. It serves a 404 page at /</span></span><br><span class="line">        <span class="comment"># 2. It serves 200 on a /healthz endpoint</span></span><br><span class="line">        image: docker.io/xxlaila/defaultbackend:1.4</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line"><span class="comment">#      nodeSelector:</span></span><br><span class="line"><span class="comment">#        kubernetes.io/hostname: 172.21.16.231</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: default-http-backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: default-http-backend</span><br></pre></td></tr></table></figure><h4 id="3-3ã€æ‰§è¡Œåˆ›å»º-å®Œæˆåå¯ä»¥çœ‹åˆ°"><a href="#3-3ã€æ‰§è¡Œåˆ›å»º-å®Œæˆåå¯ä»¥çœ‹åˆ°" class="headerlink" title="3.3ã€æ‰§è¡Œåˆ›å»º,å®Œæˆåå¯ä»¥çœ‹åˆ°"></a>3.3ã€æ‰§è¡Œåˆ›å»º,å®Œæˆåå¯ä»¥çœ‹åˆ°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f mandatory.yaml </span></span><br><span class="line"><span class="comment"># kubectl create -f default-backend.yaml</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/34dnksjfh384yksfkjdsfsd.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n ingress-nginx</span></span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">default-http-backend-66cdcb6c7d-pb9sp      1/1     Running   0          8h</span><br><span class="line">nginx-ingress-controller-69585dbb4-m6fcm   1/1     Running   0          8h</span><br><span class="line"><span class="comment"># kubectl get svc -n ingress-nginx</span></span><br><span class="line">NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default-http-backend   ClusterIP   10.102.60.154   &lt;none&gt;        80/TCP    8h</span><br></pre></td></tr></table></figure><h3 id="4ã€éƒ¨ç½²-Ingress"><a href="#4ã€éƒ¨ç½²-Ingress" class="headerlink" title="4ã€éƒ¨ç½² Ingress"></a>4ã€éƒ¨ç½² Ingress</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢å¯ä»¥çŸ¥é“ Ingress å°±æ˜¯ä¸ªè§„åˆ™ï¼ŒæŒ‡å®šå“ªä¸ªåŸŸåè½¬å‘åˆ°å“ªä¸ª Serviceï¼Œæ‰€ä»¥è¯´é¦–å…ˆæˆ‘ä»¬å¾—æœ‰ä¸ª Serviceï¼Œå½“ç„¶ Service å»å“ªæ‰¾è¿™é‡Œå°±ä¸ç®¡äº†ï¼›è¿™é‡Œé»˜è®¤ä¸ºå·²ç»æœ‰äº†ä¸¤ä¸ªå¯ç”¨çš„ Serviceï¼Œä»¥ä¸‹ä»¥ jenkinsã€Dashboard ä¸ºä¾‹<br>&nbsp;&nbsp;&nbsp;&nbsp;å…ˆå†™ä¸€ä¸ª Ingress æ–‡ä»¶ï¼Œè¯­æ³•æ ¼å¼å•¥çš„è¯·å‚è€ƒ å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºæˆ‘çš„ jenkinsåœ¨kube-opsï¼ŒDashboard åœ¨kube-system è¿™ä¸ªå‘½åç©ºé—´ï¼Œæ‰€ä»¥è¦æŒ‡å®š namespace.å‚è€ƒä¸‹é¢å®ä¾‹</p><h4 id="4-1ã€éƒ¨ç½²jenkinså®ä¾‹"><a href="#4-1ã€éƒ¨ç½²jenkinså®ä¾‹" class="headerlink" title="4.1ã€éƒ¨ç½²jenkinså®ä¾‹"></a>4.1ã€éƒ¨ç½²jenkinså®ä¾‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-ingress</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: ci.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: jenkins2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"><span class="comment"># kubectl create -f jenkins-ingress.yaml</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒåŸŸåè§£æåˆ°ipåœ°å€ï¼Œè®¿é—®jenkins</p><p><img src="https://img.xxlaila.cn/1566808344775.jpg" alt="img"></p><h4 id="4-2ã€éƒ¨ç½²kubernetes-dashboard"><a href="#4-2ã€éƒ¨ç½²kubernetes-dashboard" class="headerlink" title="4.2ã€éƒ¨ç½²kubernetes-dashboard"></a>4.2ã€éƒ¨ç½²kubernetes-dashboard</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat nginx-kubernetes-dashboard.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/ingress.class: nginx</span><br><span class="line">    nginx.ingress.kubernetes.io/secure-backends: <span class="string">"true"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-passthrough: <span class="string">"true"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - k8s.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">    - host: dashboard.xxlaila.io</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: kubernetes-dashboard</span><br><span class="line">            servicePort: 443</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/786jg656iojhf0.png" alt="img"></p><h3 id="5ã€éƒ¨ç½²-Ingress-TLS"><a href="#5ã€éƒ¨ç½²-Ingress-TLS" class="headerlink" title="5ã€éƒ¨ç½² Ingress TLS"></a>5ã€éƒ¨ç½² Ingress TLS</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢å·²ç»åšå¥½äº† Ingressï¼Œæ¥ä¸‹æ¥é…ç½®TLS ï¼›å®˜æ–¹ç»™å‡ºçš„æ ·ä¾‹å¾ˆç®€å•ï¼Œå¤§è‡´æ­¥éª¤å°±ä¸¤æ­¥ï¼šåˆ›å»ºä¸€ä¸ªå«æœ‰è¯ä¹¦çš„ secretã€åœ¨ Ingress å¼€å¯è¯ä¹¦ï¼›ä½†æ˜¯å®˜æ–¹çš„æœ‰å‘ï¼Œä¸‹é¢æ˜¯æ“ä½œæ­¥éª¤</p><h4 id="5-1ã€åˆ›å»ºè¯ä¹¦"><a href="#5-1ã€åˆ›å»ºè¯ä¹¦" class="headerlink" title="5.1ã€åˆ›å»ºè¯ä¹¦"></a>5.1ã€åˆ›å»ºè¯ä¹¦</h4><p>é¦–å…ˆç¬¬ä¸€æ­¥å½“ç„¶è¦æœ‰ä¸ªè¯ä¹¦ï¼Œç”±äºæˆ‘è¿™ä¸ª Ingress æœ‰ä¸¤ä¸ªæœåŠ¡åŸŸåï¼Œæ‰€ä»¥è¯ä¹¦è¦æ”¯æŒä¸¤ä¸ªåŸŸåï¼›ç”Ÿæˆè¯ä¹¦å‘½ä»¤å¦‚ä¸‹ï¼š</p><ul><li><p>ç”ŸæˆCAè¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir cert &amp;&amp; cd cert</span></span><br></pre></td></tr></table></figure></li><li><p>ç¼–è¾‘ openssl é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /etc/pki/tls/openssl.cnf .</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ä¸»è¦é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi openssl.cnf</span></span><br><span class="line">	[req]</span><br><span class="line">	req_extensions = v3_req <span class="comment"># è¿™è¡Œé»˜è®¤æ³¨é‡Šå…³ç€çš„ æŠŠæ³¨é‡Šåˆ æ‰</span></span><br></pre></td></tr></table></figure></li><li><p>å¢åŠ é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi openssl.cnf</span></span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = dashboard.mritd.me		<span class="comment">#éœ€è¦å¢åŠ çš„åŸŸå</span></span><br><span class="line">DNS.2 = kibana.mritd.me</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆè¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl genrsa -out ingress-key.pem 2048</span></span><br><span class="line"><span class="comment"># openssl req -new -key ingress-key.pem -out ingress.csr -subj "/CN=kube-ingress" -config openssl.cnf</span></span><br><span class="line"><span class="comment"># openssl x509 -req -in ingress.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out ingress.pem -days 365 -extensions v3_req -extfile openssl.cnf</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç”Ÿæˆåçš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">ca-key.pem  ca.pem  ca.srl  ingress-key.pem  ingress.csr  ingress.pem  openssl.cnf</span><br></pre></td></tr></table></figure></li></ul><h4 id="5-2ã€åˆ›å»º-secret"><a href="#5-2ã€åˆ›å»º-secret" class="headerlink" title="5.2ã€åˆ›å»º secret"></a>5.2ã€åˆ›å»º secret</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå¥½è¯ä¹¦ä»¥åï¼Œéœ€è¦å°†è¯ä¹¦å†…å®¹æ”¾åˆ° secret ä¸­ï¼Œsecret ä¸­å…¨éƒ¨å†…å®¹éœ€è¦ base64 ç¼–ç ï¼Œç„¶åæ³¨æ„å»æ‰æ¢è¡Œç¬¦(å˜æˆä¸€è¡Œ)ï¼›ä»¥ä¸‹æ˜¯æˆ‘çš„ secret æ ·ä¾‹(ä¸Šä¸€æ­¥ä¸­ ingress.pem æ˜¯è¯ä¹¦crtï¼Œingress-key.pem æ˜¯è¯ä¹¦çš„ key)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ingress-secret.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  tls.crt: MIIDAjCCAeqgAwIBAgIJAIUNBpFKFrg4MA0GCSqGSIb3DQEBCwUAMBIxEDAOBgNVBAMMB2t1YmUtY2EwHhcNMTkwMTI5MTAzMzQ3WhcNMjAwMTI5MTAzMzQ3WjAXMRUwEwYDVQQDDAxrdWJlLWluZ3Jlc3MwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC0rLcpYHdqVjN84vCJYF2l61F+LYuPRczPNWyo8Rba4XpT6MMMqoGqgmI164r4of2klBEMPZ0dm1mJaYnjb1Zq/qzVUlqaednxfXsr6u8Xm0a6l7ep+Yr+XcRISZC9AjgyqlFtgjzbNJauHkHTy0i+jqV2A4SkVUT2whBqF00WEKC6kQLhw4Ab1XBG5aOK2Jz4TZdP+Mw4n3AsihycHgjhFvhGNixKl4mpfHfLvFeKxmBa8ZoWT+3AGgkX186EXhdhsfdYqHeLT2TvwsqbUJI8E8F7nleo5VMifr9KGHxaCJ+ynr/WFX1c+0wYAGmSKsw4CnXh4EE+IvaeQjBz8O2HAgMBAAGjVjBUMAkGA1UdEwQCMAAwCwYDVR0PBAQDAgXgMDoGA1UdEQQzMDGCFmNpLnp4Yy5raW5neHVubGlhbi5jb22CF2s4cy56eGMua2luZ3h1bmxpYW4uY29tMA0GCSqGSIb3DQEBCwUAA4IBAQCShThVXg3Fnkrm82sHowxCEc9UG9uzOY2LbxhVN7mcm8U0cXy3acAXdKWLHUwdZnOxNJytpaBBWb/6KFFKrIekaSK+tSD+oRISJf43c1tbt0QEpplUaDagQ35NANyQY2VHQntDdVK4/NNJULbHNEqsu19vDDvmDFi0aLHvqPFAvlGnEBPgO1Ac297pDR2thHyMCGBzRKTQOJy2q3HKexa1pItHjAVmv/k71HBeTJ1en2tFHLUlR0kEhYYPBeRclVZ1oYWn7THRaBW8NtugdM6mxVNFAWQTq5goP0VcW44lWYiUF6mX/UZa2c+5FwsGWdSwbTqmZj7ptA2QcveUcN2/</span><br><span class="line">  tls.key: MIIEowIBAAKCAQEAtKy3KWB3alYzfOLwiWBdpetRfi2Lj0XMzzVsqPEW2uF6U+jDDKqBqoJiNeuK+KH9pJQRDD2dHZtZiWmJ429Wav6s1VJamnnZ8X17K+rvF5tGupe3qfmK/l3ESEmQvQI4MqpRbYI82zSWrh5B08tIvo6ldgOEpFVE9sIQahdNFhCgupEC4cOAG9VwRuWjitic+E2XT/jMOJ9wLIocnB4I4Rb4RjYsSpeJqXx3y7xXisZgWvGaFk/twBoJF9fOhF4XYbH3WKh3i09k78LKm1CSPBPBe55XqOVTIn6/Shh8Wgifsp6/1hV9XPtMGABpkirMOAp14eBBPiL2nkIwc/DthwIDAQABAoIBACLj97sV1fnDC85iRPFCmtMfzmz/fqP8ZsDdIE6/wBok0OrDWGdpxgCXjT+8bOn23nSZ43DptR2ykmfm6anyJk4jQF0xui16uovYH6ErjWCRq+b8xYsdlanpka4kBr95XkDqgy8Sp43taevWDABKkZG7Gljf9Q2HKfo9H85dEZXg7RKKz77wahcHpZofthNo0s5kkH2ckVpjwh5svM+M/gm8KhZkKayndr1ezEAmndT+K/P4EVuYbpPQyk5A6E1G7Dh9M2TczZZa6oiR5etloDk2sOIYxysIZqAblyMN2IrIO0hf4nGqSmfe0TZMCKzSXoVOV2Qe+ckJ+mSyOPcdbIECgYEA3EMWrrr4oc9R8o35mQ2FDCG0FUyXrCo9SN/CyhScdeUx1IRV00CBwL340H1CwzEpj5g4bj6LGGSeEw2g8qfPoPdzr1yxNnCv43dhaGrWRrSxGL6kGfKmIlbgHTPIuzRkAXGWiCgo5JnzPjQtjmpUTmwmxXwqDih8kpRsBSTsmx0CgYEA0f1ORGtmrj/bRBQU0NF+ztTVFJQbPV3lTHl21Qgd8QcEIcOHqzpI2fmkeGZdyYQXIfODA/X+PFng+Z6J5ubtvplN5jPzpQuQRtIZ47NRmtgn4DoH+GAqxIb2hFbwXpXuSR/LelFtzxb91nGiVKpdizvuwnitgOuAIbgGHYbgpfMCgYAvvA5fYb/eeWq+EUzFgauS3H8FmqrIMgNEFtJFL0BVQI2TC/b5qGI2XjVdIbhlSvNB3nBkXAOTDsM/R9XYoMubi+UzXPg+3x8PQeEHWxgDDMfQoAg6Y17j1EYPrhhTkeAWfAJukZ2DJWYU1gQFeD+7Gy8v31/R365XqfjbCIyKdQKBgD+/3tr2oB2WVUK9tfQPJag1BNtSe1KOBubImULjS/O4ZZC6g51//E3wc/X5Xc+nwj4UZ1n0fFJmFt6xOrxWryaF9BhG/VjFwe8+KY3vCn8v0CtKctD8oP842e4jVqXgbo7UkDl6LxQHrthDdzys2+lBMKLpcAMLe8LA01pzcA/xAoGBAK3KXGXz0AsM+5FBbUFVZFOROUQLcd+N8esHnSqD8i7/J0PJsxm9irutuLht0cYK7Fcq65fYmZ4lrJO7bpiBRzONR78lMgm/rcKfCCNr4o4n6almvuFxA+jGgEM2W7iYb9pW+FFOqIOjl0cSHy2hsN7seGv3JBcz5StRjtwuSWf6</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-secret</span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºå®Œæˆå create<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ingress-secret.yml</span></span><br><span class="line">secret/ingress-secret created</span><br></pre></td></tr></table></figure></li></ul><h4 id="5-3ã€å¿«é€Ÿåˆ›å»º"><a href="#5-3ã€å¿«é€Ÿåˆ›å»º" class="headerlink" title="5.3ã€å¿«é€Ÿåˆ›å»º"></a>5.3ã€å¿«é€Ÿåˆ›å»º</h4><p>5.2æ­¥éª¤å¯ä»¥ç®€åŒ–åˆ›å»ºï¼Œå¯ä»¥æ‰§è¡Œä¸€æ¡å‘½ä»¤è¿›è¡Œåˆ›å»ºï¼Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create secret tls ingress-secret --key cert/ingress-key.pem --cert cert/ingress.pem</span></span><br></pre></td></tr></table></figure><h4 id="5-4ã€é‡æ–°éƒ¨ç½²-Ingress"><a href="#5-4ã€é‡æ–°éƒ¨ç½²-Ingress" class="headerlink" title="5.4ã€é‡æ–°éƒ¨ç½² Ingress"></a>5.4ã€é‡æ–°éƒ¨ç½² Ingress</h4><p>åœ¨tlsç”Ÿæˆå®Œæˆåï¼Œéœ€è¦é‡æ–°éƒ¨ç½²Ingressï¼Œè®©Ingressèƒ½å¤Ÿå®¶åœ¨tlsã€‚ä¿®æ”¹é…ç½®æ–‡ä»¶</p><h5 id="5-4-1ã€jenkins-tls"><a href="#5-4-1ã€jenkins-tls" class="headerlink" title="5.4.1ã€jenkins tls"></a>5.4.1ã€jenkins tls</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi jenkins-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-ingress</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ci.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ci.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: jenkins2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"><span class="comment"># kubect create -f jenkins-ingress.yaml</span></span><br></pre></td></tr></table></figure><p>è®¿é—®jenkinsåŸŸåï¼Œè¿™é‡Œè¾“å…¥httpè®¿é—®ä¼šå¼ºåˆ¶è·³è½¬åˆ°https<br><img src="https://img.xxlaila.cn/1566808668453.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566808711171.jpg" alt="img"></p><h5 id="5-4-2ã€kubernetes-dashboard-tls"><a href="#5-4-2ã€kubernetes-dashboard-tls" class="headerlink" title="5.4.2ã€kubernetes dashboard tls"></a>5.4.2ã€kubernetes dashboard tls</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim nginx-kubernetes-dashboard.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - k8s.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: k8s.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 80</span><br><span class="line"><span class="comment"># kubectl create -f nginx-kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure><h3 id="6ã€ingress-é«˜çº§ç”¨æ³•"><a href="#6ã€ingress-é«˜çº§ç”¨æ³•" class="headerlink" title="6ã€ingress é«˜çº§ç”¨æ³•"></a>6ã€ingress é«˜çº§ç”¨æ³•</h3><p><img src="https://img.xxlaila.cn/34324kjsdfh8234ks.png" alt="img"></p><ul><li>lvs åå‘ä»£ç†åˆ° ç‰©ç†nginxã€‚å®Œæˆhttpsæ‹†åŒ…ï¼Œç»§æ‰¿nginxæ‰€æœ‰åŠŸèƒ½</li><li>nginx åå‘ä»£ç†åˆ°ingress-controlã€‚ ingress-control æœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ ã€‚<ul><li>ingress-control ä½¿ç”¨nodePort æ–¹å¼æš´æ¼æœåŠ¡</li><li>ingress-control ä½¿ç”¨hostNetwork æ–¹å¼æš´æ¼æœåŠ¡</li></ul></li></ul><h3 id="7ã€æ€»ç»“åˆ†æ"><a href="#7ã€æ€»ç»“åˆ†æ" class="headerlink" title="7ã€æ€»ç»“åˆ†æ"></a>7ã€æ€»ç»“åˆ†æ</h3><ul><li>ingress-control åœ¨è‡ªå·±çš„æ‰€å±çš„namespace=ingress, æ˜¯å¯ä»¥å¤¸ä¸åŒnamespaceæä¾›åå‘ä»£ç†æœ.</li><li>å¦‚æœéœ€è¦æä¾›å¤¸NS è®¿é—®ingressï¼Œå…ˆç»™ ingress-controlåˆ›å»ºRBAC</li><li>ingress-control ä½¿ç”¨hostnetwork æ¨¡å¼ æ€§èƒ½æ¯”ä½¿ç”¨service nodePort æ€§èƒ½å¥½å¾ˆå¤šã€‚å› ä¸ºhostnetwork æ˜¯ç›´æ¥è·å–pod çš„IPï¼Ÿ</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Ingress</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²Weave Scope</title>
    <url>/2019/08/26/k8s%E9%83%A8%E7%BD%B2Weave-Scope/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="1ã€Weave-Scopeä»‹ç»"><a href="#1ã€Weave-Scopeä»‹ç»" class="headerlink" title="1ã€Weave Scopeä»‹ç»"></a>1ã€Weave Scopeä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;weave scope æ˜¯Dockerå’ŒKubernetesçš„æ•…éšœæ’é™¤å’Œç›‘æ§ï¼Œè‡ªåŠ¨ç”Ÿæˆåº”ç”¨ç¨‹åºçš„åœ°å›¾ï¼Œèƒ½å¤Ÿç›´è§‚åœ°äº†è§£ï¼Œç›‘æ§å’Œæ§åˆ¶åŸºäºå®¹å™¨çš„ï¼ŒåŸºäºå¾®æœåŠ¡çš„åº”ç”¨ç¨‹åºã€‚å¯ä»¥å®æ—¶çš„äº†è§£dockerå®¹å™¨ï¼Œé€‰æ‹©å®¹å™¨åŸºç¡€æ¶æ„çš„æ¦‚è¿°ï¼Œæˆ–å…³æ³¨ç‰¹å®šçš„å¾®æœåŠ¡ã€‚è½»æ¾è¯†åˆ«å’Œçº æ­£é—®é¢˜ï¼Œç¡®ä¿é›†è£…ç®±åŒ–åº”ç”¨çš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼ŒæŸ¥çœ‹å®¹å™¨çš„ä¸Šä¸‹æ–‡æŒ‡æ ‡ï¼Œæ ‡è®°å’Œå…ƒæ•°æ®ã€‚è½»æ¾åœ°åœ¨å®¹å™¨å†…çš„è¿›ç¨‹ä¹‹é—´å¯¼èˆªï¼Œä»¥è¿è¡Œå®¹å™¨ï¼Œåœ¨å¯æ‰©å±•çš„å¯æ’åºè¡¨ä¸­è¿›è¡Œæ’åˆ—ã€‚ä½¿ç”¨ç»™å®šä¸»æœºæˆ–æœåŠ¡çš„æœ€å¤§CPUæˆ–å†…å­˜è½»æ¾æ‰¾åˆ°å®¹å™¨ã€‚ç›´æ¥ä¸æ‚¨çš„å®¹å™¨äº¤äº’ï¼šæš‚åœï¼Œé‡æ–°å¯åŠ¨å’Œåœæ­¢å®¹å™¨ã€‚å¯åŠ¨å‘½ä»¤è¡Œã€‚å…¨éƒ¨ä¸ç¦»å¼€èŒƒå›´æµè§ˆå™¨çª—å£ã€‚</p><p><img src="https://img.xxlaila.cn/378246bsjfhsajkdq.png" alt="img"></p><h3 id="2ã€éƒ¨ç½²weave-scope"><a href="#2ã€éƒ¨ç½²weave-scope" class="headerlink" title="2ã€éƒ¨ç½²weave scope"></a>2ã€éƒ¨ç½²weave scope</h3><p>åˆæ¬¡å­¦ä¹ ï¼Œç›´æ¥ä¸‹è½½å®˜æ–¹é…ç½®æ–‡ä»¶ï¼Œæ²¡æœ‰ç»è¿‡ä»»ä½•ä¿®æ”¹ï¼Œä¸è¿‡ç›¸ä¿¡è‡ªå·±éšç€å­¦ä¹ çš„è¿›æ­¥ï¼Œä¼šé€æ¸æ·±å…¥ã€‚<a href="https://github.com/weaveworks/scope" target="_blank" rel="noopener">githubåœ°å€</a>ï¼Œ<a href="https://www.weave.works/docs/cloud/latest/overview/" target="_blank" rel="noopener">å®˜æ–¹åœ°å€</a></p><a id="more"></a><h4 id="2-1ã€ä¸‹è½½é…ç½®æ–‡ä»¶"><a href="#2-1ã€ä¸‹è½½é…ç½®æ–‡ä»¶" class="headerlink" title="2.1ã€ä¸‹è½½é…ç½®æ–‡ä»¶"></a>2.1ã€ä¸‹è½½é…ç½®æ–‡ä»¶</h4><p><a href="https://github.com/weaveworks/scope/tree/master/examples/k8s" target="_blank" rel="noopener">ä¸‹è½½é…ç½®æ–‡ä»¶</a>,é…ç½®æ–‡ä»¶å¦‚ä¸‹åˆ—è¡¨:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -l</span></span><br><span class="line">cluster-role-binding.yaml</span><br><span class="line">cluster-role.yaml</span><br><span class="line">deploy.yaml</span><br><span class="line">ds.yaml</span><br><span class="line">ns.yaml</span><br><span class="line">psp.yaml</span><br><span class="line">sa.yaml</span><br><span class="line">scope.yaml</span><br><span class="line">svc.yaml</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ›å»º<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ./</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2ã€æŸ¥çœ‹éƒ¨ç½²"><a href="#2-2ã€æŸ¥çœ‹éƒ¨ç½²" class="headerlink" title="2.2ã€æŸ¥çœ‹éƒ¨ç½²"></a>2.2ã€æŸ¥çœ‹éƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc,pods -n weave</span></span><br><span class="line">NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/weave-scope-app   ClusterIP   10.99.252.207   &lt;none&gt;        80/TCP    25m</span><br><span class="line"></span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/weave-scope-agent-gpwmw            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-lmf22            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-r8vft            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-rph5p            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-zfrnc            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-app-5c46dd7467-s8cp8   1/1     Running   0          24m</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/3489hdnsjkhd8324sd.png" alt="img"></p><h4 id="2-3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€"><a href="#2-3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€" class="headerlink" title="2.3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€"></a>2.3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services -n weave</span></span><br><span class="line">NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">weave-scope-app   ClusterIP   10.99.252.207   &lt;none&gt;        80/TCP    27m</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ°è¿™é‡Œweave-scopeéƒ¨ç½²å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œè®¿é—®ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¹‹å‰å­¦ä¹ çš„nginx Ingressæ¥å¯¹scopeé…ç½®ä¸€ä¸ªåŸŸåï¼Œç„¶åå§åŸŸåè§£æåˆ°åˆ¶å®šçš„ipåœ°å€ä¸Šè¿›è¡Œè®¿é—®</p><h3 id="3ã€é…ç½®scopeåŸŸå"><a href="#3ã€é…ç½®scopeåŸŸå" class="headerlink" title="3ã€é…ç½®scopeåŸŸå"></a>3ã€é…ç½®scopeåŸŸå</h3><p>æ–°å»ºç«‹ä¸€ä¸ªyamlæ–‡ä»¶ï¼Œå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat scope-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: scope-ingress</span><br><span class="line">  namespace: weave</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: scope.xxlaila.io</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: weave-scope-app</span><br><span class="line">            servicePort: 80</span><br><span class="line"><span class="comment"># kubectl create -f scope-ingress.yaml</span></span><br></pre></td></tr></table></figure><blockquote><p>é€šè¿‡åŸŸåè®¿é—®ï¼š<a href="http://scope.xxlaila.io" target="_blank" rel="noopener">http://scope.xxlaila.io</a></p></blockquote><p><img src="https://img.xxlaila.cn/287346jskbdjy784kjs.png" alt="img"><br><img src="https://img.xxlaila.cn/3o4wndk9234sd.png" alt="img"><br><img src="https://img.xxlaila.cn/34873i24dfsd.png" alt="img"><br><img src="https://img.xxlaila.cn/458dskjfhu2y4skdsds.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Weave Scope</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²zookeeperé›†ç¾¤</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2zookeeper%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>zkå±äºæœ‰çŠ¶æ€æœåŠ¡ï¼Œéœ€è¦è¿æ¥å¤–éƒ¨å­˜å‚¨ï¼Œå§æ•°æ®å­˜æ”¾åœ¨æ•°æ®ç›˜é‡Œé¢ï¼Œå¦åˆ™å®¹å™¨æŒ‚äº†ï¼Œæ•°æ®æ²¡æœ‰äº†</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å‡†å¤‡zkçš„yamlæ–‡ä»¶</p><a id="more"></a><h3 id="1ã€é…ç½®zk-dataæ–‡ä»¶"><a href="#1ã€é…ç½®zk-dataæ–‡ä»¶" class="headerlink" title="1ã€é…ç½®zk-dataæ–‡ä»¶"></a>1ã€é…ç½®zk-dataæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat zk-data.yaml</span></span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk1</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">---</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk2</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">---</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk3</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line"><span class="comment"># cat zookeeper.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-hs</span><br><span class="line">  labels:</span><br><span class="line">    app: zk</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2888</span><br><span class="line">    name: server</span><br><span class="line">  - port: 3888</span><br><span class="line">    name: leader-election</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-cs</span><br><span class="line">  labels:</span><br><span class="line">    app: zk</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2181</span><br><span class="line">    name: client</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodDisruptionBudget</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-pdb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  maxUnavailable: 1</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: zk</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  serviceName: zk-hs</span><br><span class="line">  replicas: 3</span><br><span class="line">  updateStrategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">  podManagementPolicy: Parallel</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: zk</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: <span class="string">"app"</span></span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                    - zk</span><br><span class="line">              topologyKey: <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-zookeeper</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        image: <span class="string">"xxlaila/kubernetes-zookeeper:1.0-3.4.10"</span></span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"1Gi"</span></span><br><span class="line">            cpu: <span class="string">"0.5"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 2181</span><br><span class="line">          name: client</span><br><span class="line">        - containerPort: 2888</span><br><span class="line">          name: server</span><br><span class="line">        - containerPort: 3888</span><br><span class="line">          name: leader-election</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - <span class="string">"start-zookeeper \</span></span><br><span class="line"><span class="string">          --servers=3 \</span></span><br><span class="line"><span class="string">          --data_dir=/var/lib/zookeeper/data \</span></span><br><span class="line"><span class="string">          --data_log_dir=/var/lib/zookeeper/data/log \</span></span><br><span class="line"><span class="string">          --conf_dir=/opt/zookeeper/conf \</span></span><br><span class="line"><span class="string">          --client_port=2181 \</span></span><br><span class="line"><span class="string">          --election_port=3888 \</span></span><br><span class="line"><span class="string">          --server_port=2888 \</span></span><br><span class="line"><span class="string">          --tick_time=2000 \</span></span><br><span class="line"><span class="string">          --init_limit=10 \</span></span><br><span class="line"><span class="string">          --sync_limit=5 \</span></span><br><span class="line"><span class="string">          --heap=512M \</span></span><br><span class="line"><span class="string">          --max_client_cnxns=60 \</span></span><br><span class="line"><span class="string">          --snap_retain_count=3 \</span></span><br><span class="line"><span class="string">          --purge_interval=12 \</span></span><br><span class="line"><span class="string">          --max_session_timeout=40000 \</span></span><br><span class="line"><span class="string">          --min_session_timeout=4000 \</span></span><br><span class="line"><span class="string">          --log_level=INFO"</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">            - -c</span><br><span class="line">            - <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        livenessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">            - -c</span><br><span class="line">            - <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: datadir</span><br><span class="line">          mountPath: /var/lib/zookeeper</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 1000</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: datadir</span><br><span class="line">      annotations:</span><br><span class="line">        volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 3Gi</span><br></pre></td></tr></table></figure><h3 id="2ã€æ‰§è¡Œéƒ¨ç½²"><a href="#2ã€æ‰§è¡Œéƒ¨ç½²" class="headerlink" title="2ã€æ‰§è¡Œéƒ¨ç½²"></a>2ã€æ‰§è¡Œéƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f zookeeper.yaml -n kube-dev</span></span><br></pre></td></tr></table></figure><h3 id="3ã€æŸ¥çœ‹éƒ¨ç½²"><a href="#3ã€æŸ¥çœ‹éƒ¨ç½²" class="headerlink" title="3ã€æŸ¥çœ‹éƒ¨ç½²"></a>3ã€æŸ¥çœ‹éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide -n kube-dev</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">zk-0                            1/1     Running   0          6m13s   10.254.62.4   172.21.17.15    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">zk-1                            1/1     Running   0          6m12s   10.254.21.4   172.21.16.96    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">zk-2                            1/1     Running   0          6m12s   10.254.96.4   172.21.16.193   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜"><a href="#4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜" class="headerlink" title="4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜"></a>4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv -o wide -n kube-dev</span></span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                             STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-d1cb6a1c-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-0             managed-nfs-storage            6m18s</span><br><span class="line">pvc-d20a95ec-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-1             managed-nfs-storage            6m18s</span><br><span class="line">pvc-d23577af-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-2             managed-nfs-storage            6m23s</span><br></pre></td></tr></table></figure><h3 id="5ã€æŸ¥çœ‹pvc"><a href="#5ã€æŸ¥çœ‹pvc" class="headerlink" title="5ã€æŸ¥çœ‹pvc"></a>5ã€æŸ¥çœ‹pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pvc -o wide -n kube-dev</span></span><br><span class="line">NAME                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">datadir-zk-0             Bound    pvc-d1cb6a1c-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m38s</span><br><span class="line">datadir-zk-1             Bound    pvc-d20a95ec-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m37s</span><br><span class="line">datadir-zk-2             Bound    pvc-d23577af-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m37s</span><br></pre></td></tr></table></figure><h3 id="6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸"><a href="#6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸" class="headerlink" title="6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸"></a>6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in 0 1 2; do kubectl exec zk-$i zkServer.sh status -n kube-dev; done</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><h3 id="7ã€é›†ç¾¤çš„è®¿é—®åœ°å€"><a href="#7ã€é›†ç¾¤çš„è®¿é—®åœ°å€" class="headerlink" title="7ã€é›†ç¾¤çš„è®¿é—®åœ°å€"></a>7ã€é›†ç¾¤çš„è®¿é—®åœ°å€</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server.1=zk-0.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br><span class="line">server.2=zk-1.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br><span class="line">server.3=zk-2.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²coredns</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2coredns/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;k8sé›†ç¾¤ä¸­çš„åº”ç”¨é€šå¸¸æ˜¯é€šè¿‡ingresså®ç°å¾®æœåŠ¡å‘å¸ƒçš„ï¼Œå‰æ–‡ä»‹ç»è¿‡åœ¨K8Sé›†ç¾¤ä¸­ä½¿ç”¨traefikå®ç°æœåŠ¡çš„è‡ªåŠ¨å‘å¸ƒï¼Œå…¶å®ç°æ–¹å¼æ˜¯traefiké€šè¿‡é›†ç¾¤çš„DNSæœåŠ¡æ¥è§£æserviceå¯¹åº”çš„é›†ç¾¤åœ°å€ï¼ˆclusteripï¼‰ï¼Œä»è€Œå°†ç”¨æˆ·çš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤åœ°å€ä¸Šã€‚å› æ­¤ï¼Œåœ¨éƒ¨ç½²å®Œé›†ç¾¤åçš„ç¬¬ä¸€ä»¶äº‹æƒ…åº”è¯¥æ˜¯é…ç½®DNSæœåŠ¡ï¼Œç›®å‰å¯é€‰çš„æ–¹æ¡ˆæœ‰skydns, kube-dns, corednsã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;kubednsæ˜¯Kubernetesä¸­çš„ä¸€ä¸ªå†…ç½®æ’ä»¶ï¼Œç›®å‰ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¼€æºé¡¹ç›®ç»´æŠ¤ï¼Œè§<a href="https://github.com/kubernetes/dnsã€‚è¯¥DNSæœåŠ¡å™¨åˆ©ç”¨SkyDNSçš„åº“æ¥ä¸ºKubernetes" target="_blank" rel="noopener">https://github.com/kubernetes/dnsã€‚è¯¥DNSæœåŠ¡å™¨åˆ©ç”¨SkyDNSçš„åº“æ¥ä¸ºKubernetes</a> podå’ŒæœåŠ¡æä¾›DNSè¯·æ±‚ã€‚CoreDNSé¡¹ç›®æ˜¯SkyDNS2çš„ä½œè€…ï¼ŒMiek Giebené‡‡ç”¨æ›´æ¨¡å—åŒ–ï¼Œå¯æ‰©å±•çš„æ¡†æ¶æ„å»º,å°†æ­¤DNSæœåŠ¡å™¨ä½œä¸ºKubeDNSçš„æ›¿ä»£å“ã€‚CoreDNSä½œä¸ºCNCFä¸­çš„æ‰˜ç®¡çš„ä¸€ä¸ªé¡¹ç›®ï¼Œåœ¨Kuberentes1.9ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨kubeadmæ–¹å¼å®‰è£…çš„é›†ç¾¤å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç›´æ¥å®‰è£…CoreDNSã€‚kubeadm init â€“feature-gates=CoreDNS=true</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å‡†å¤‡corednsçš„<a href="https://github.com/coredns/deployment.git" target="_blank" rel="noopener">yamlæ–‡ä»¶</a></p><a id="more"></a><p>é¦–å…ˆæˆ‘ä»¬çš„æŸ¥çœ‹<code>cat /etc/kubernetes/kubelet</code> dnsçš„ipåœ°å€æ˜¯å¤šå°‘ï¼Œè¿™é‡Œæˆ‘çš„æ˜¯<code>10.254.0.2</code>ï¼Œæ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œä¿®æ”¹</p><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./deploy.sh -i 10.254.0.2 | kubectl apply -f -</span></span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure></li><li><p>æ“¦çœ‹corednsä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deployment,rc -n kube-system|grep dns</span></span><br><span class="line">pod/coredns-799775f9b6-mgdc9                1/1     Running   0          12m</span><br><span class="line">pod/coredns-799775f9b6-v95lp                1/1     Running   0          12m</span><br><span class="line">service/kube-dns               ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   12m</span><br><span class="line"></span><br><span class="line">deployment.extensions/coredns                2/2     2            2           12m</span><br></pre></td></tr></table></figure></li></ul><h3 id="éƒ¨ç½²-DNS-è‡ªåŠ¨æ‰©å®¹"><a href="#éƒ¨ç½²-DNS-è‡ªåŠ¨æ‰©å®¹" class="headerlink" title="éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹"></a>éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å¤§è§„æ¨¡é›†ç¾¤çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦é›†ç¾¤ DNS è‡ªåŠ¨æ‰©å®¹ï¼Œå…·ä½“æ–‡æ¡£è¯·å‚è€ƒ DNS Horizontal Autoscalerï¼ŒDNS æ‰©å®¹ç®—æ³•å¯å‚è€ƒ Githubï¼Œå¦‚æœ‰éœ€è¦è¯·è‡ªè¡Œä¿®æ”¹ï¼›ä»¥ä¸‹ä¸ºå…·ä½“é…ç½®</p><ul><li><p>dns-horizontal-autoscaler.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kind: ServiceAccount</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns-autoscaler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"nodes"</span>]</span><br><span class="line">    verbs: [<span class="string">"list"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"replicationcontrollers/scale"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"deployments/scale"</span>, <span class="string">"replicasets/scale"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>]</span><br><span class="line"><span class="comment"># Remove the configmaps rule once below issue is fixed:</span></span><br><span class="line"><span class="comment"># kubernetes-incubator/cluster-proportional-autoscaler#16</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"configmaps"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>]</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kube-dns-autoscaler</span><br><span class="line">    namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns-autoscaler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns-autoscaler</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns-autoscaler</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns-autoscaler</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: autoscaler</span><br><span class="line">        image: gcr.azk8s.cn/google_containers/cluster-proportional-autoscaler-amd64:1.1.2-r2</span><br><span class="line">        resources:</span><br><span class="line">            requests:</span><br><span class="line">                cpu: <span class="string">"20m"</span></span><br><span class="line">                memory: <span class="string">"10Mi"</span></span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">          - /cluster-proportional-autoscaler</span><br><span class="line">          - --namespace=kube-system</span><br><span class="line">          - --configmap=kube-dns-autoscaler</span><br><span class="line">          <span class="comment"># Should keep target in sync with cluster/addons/dns/kube-dns.yaml.base</span></span><br><span class="line">          - --target=Deployment/coredns</span><br><span class="line">          <span class="comment"># When cluster is using large nodes(with more cores), "coresPerReplica" should dominate.</span></span><br><span class="line">          <span class="comment"># If using small nodes, "nodesPerReplica" should dominate.</span></span><br><span class="line">          - --default-params=&#123;<span class="string">"linear"</span>:&#123;<span class="string">"coresPerReplica"</span>:256,<span class="string">"nodesPerReplica"</span>:16,<span class="string">"preventSinglePointFailure"</span>:<span class="literal">true</span>&#125;&#125;</span><br><span class="line">          - --logtostderr=<span class="literal">true</span></span><br><span class="line">          - --v=2</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line">        operator: <span class="string">"Exists"</span></span><br><span class="line">      serviceAccountName: kube-dns-autoscaler</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f dns-horizontal-autoscaler.yaml </span></span><br><span class="line">serviceaccount/kube-dns-autoscaler created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:kube-dns-autoscaler created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:kube-dns-autoscaler created</span><br><span class="line">deployment.apps/kube-dns-autoscaler created</span><br></pre></td></tr></table></figure></li></ul><p>æ‰§è¡Œåˆ›å»ºä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°pod åˆ›å»ºäº†ä¸¤ä¸ªdns</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system|grep coredns</span></span><br><span class="line">coredns-68676b6b88-pw9c2                1/1     Running   0          7m18s</span><br><span class="line">coredns-68676b6b88-tgbbv                1/1     Running   0          100m</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²mysql</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2mysql/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;åç«¯å­˜å‚¨åˆ©ç”¨nfsæ¥è¿›è¡Œå­˜å‚¨æ•°æ®ï¼Œnfså®‰è£…ä¸é˜è¿°ï¼Œéœ€è¦æ³¨æ„æ³¨æ„çš„æ˜¯åœ¨åˆ›å»ºmysql çš„å…±äº«ç›®å½•çš„æ—¶å€™å‚æ•°è®¾å®š<code>/data/mysql *(rw,sync,no_root_squash,no_subtree_check)</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl  restart nfs.service</span><br><span class="line">$ sudo exportfs -arv</span><br></pre></td></tr></table></figure><h3 id="1ã€åˆ›å»ºmysqlå­˜å‚¨"><a href="#1ã€åˆ›å»ºmysqlå­˜å‚¨" class="headerlink" title="1ã€åˆ›å»ºmysqlå­˜å‚¨"></a>1ã€åˆ›å»ºmysqlå­˜å‚¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-pvc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc001</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  nfs:</span><br><span class="line">    server: 172.21.16.240</span><br><span class="line">    path: /data/mysql</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pvc</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 10Gi</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2ã€éƒ¨ç½²mysql"><a href="#2ã€éƒ¨ç½²mysql" class="headerlink" title="2ã€éƒ¨ç½²mysql"></a>2ã€éƒ¨ç½²mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-deploy.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-deploy</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: mysql-ops</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        name: mysql-ops</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: mysql</span><br><span class="line">          image: mysql:8.0.12</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          env:</span><br><span class="line">          - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">            value: <span class="string">"noc-mysql"</span></span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 3306</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: mysql-persistent-storage</span><br><span class="line">              mountPath: <span class="string">"/var/lib/mysql"</span></span><br><span class="line">      volumes:</span><br><span class="line">        - name: mysql-persistent-storage</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">            claimName: mysql-pvc</span><br></pre></td></tr></table></figure><h3 id="3ã€è®¾ç½®ç«¯å£æ˜ å°„"><a href="#3ã€è®¾ç½®ç«¯å£æ˜ å°„" class="headerlink" title="3ã€è®¾ç½®ç«¯å£æ˜ å°„"></a>3ã€è®¾ç½®ç«¯å£æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-svc</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  labels: </span><br><span class="line">    name: mysql-svc</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3306</span><br><span class="line">    name: http</span><br><span class="line">    nodePort: 30003</span><br><span class="line">  selector:</span><br><span class="line">    name: mysql-ops</span><br></pre></td></tr></table></figure><h3 id="4ã€æŸ¥çœ‹podéƒ¨ç½²"><a href="#4ã€æŸ¥çœ‹podéƒ¨ç½²" class="headerlink" title="4ã€æŸ¥çœ‹podéƒ¨ç½²"></a>4ã€æŸ¥çœ‹podéƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/8364iqhkdaskda.png" alt="img"></p><h3 id="5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹"><a href="#5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹" class="headerlink" title="5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹"></a>5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/42joud02jef24.png" alt="img"></p><h3 id="6ã€è¿›å…¥mysqlå®¹å™¨"><a href="#6ã€è¿›å…¥mysqlå®¹å™¨" class="headerlink" title="6ã€è¿›å…¥mysqlå®¹å™¨"></a>6ã€è¿›å…¥mysqlå®¹å™¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker ps -a</span><br><span class="line">$ sudo docker <span class="built_in">exec</span> -it ded7f2990db5 /bin/bash</span><br><span class="line">root@mysql-deploy-6dc5d9786b-lgkxk:/<span class="comment"># mysql -h127.0.0.1 -uroot -pnoc-mysql</span></span><br></pre></td></tr></table></figure><h4 id="6-1ã€è®¾ç½®mysql"><a href="#6-1ã€è®¾ç½®mysql" class="headerlink" title="6.1ã€è®¾ç½®mysql"></a>6.1ã€è®¾ç½®mysql</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter user <span class="string">'root'</span>@<span class="string">'%'</span> identified with mysql_native_password by<span class="string">'root'</span>;</span><br><span class="line">mysql&gt; alter  user <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'mysql'</span>;</span><br><span class="line">mysql&gt; alter  user <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'noc-mysql'</span>;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é€€å‡ºmysqlå’Œå®¹å™¨ï¼Œæ‰§è¡Œquit;é€€å‡ºmysqlï¼ŒæŒ‰ctrl+p+qä»å®¹å™¨ä¸­è¿”å›nodeä¸»æœºã€‚åˆ©ç”¨navicat é€šè¿‡nodeä¸»æœºçš„ipåœ°å€å’Œç«¯å£30003è¿æ¥mysqlæ•°æ®åº“<br><img src="https://img.xxlaila.cn/2348wndssmadklj3.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sè§’è‰²è®¿é—®RBAC</title>
    <url>/2019/08/24/k8s%E8%A7%92%E8%89%B2%E8%AE%BF%E9%97%AERBAC/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="1ã€rbacä»‹ç»"><a href="#1ã€rbacä»‹ç»" class="headerlink" title="1ã€rbacä»‹ç»"></a>1ã€rbacä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesä¸­çš„ä¸¤ä¸ªç”¨äºé…ç½®ä¿¡æ¯çš„é‡è¦èµ„æºå¯¹è±¡ï¼šConfigMapå’ŒSecretï¼Œå…¶å®åˆ°è¿™é‡Œæˆ‘ä»¬åŸºæœ¬ä¸Šå­¦ä¹ çš„å†…å®¹å·²ç»è¦†ç›–åˆ°Kubernetesä¸­ä¸€äº›é‡è¦çš„èµ„æºå¯¹è±¡äº†ï¼Œæ¥éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åºæ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„äº†ã€‚åœ¨æˆ‘ä»¬æ¼”ç¤ºä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»™å¤§å®¶è®²è§£ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼šRBAC - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;RBACä½¿ç”¨rbac.authorization.k8s.io API Group æ¥å®ç°æˆæƒå†³ç­–ï¼Œå…è®¸ç®¡ç†å‘˜é€šè¿‡ Kubernetes API åŠ¨æ€é…ç½®ç­–ç•¥ï¼Œè¦å¯ç”¨RBACï¼Œéœ€è¦åœ¨ apiserver ä¸­æ·»åŠ å‚æ•°â€“authorization-mode=RBACï¼Œå¦‚æœä½¿ç”¨çš„kubeadmå®‰è£…çš„é›†ç¾¤ï¼Œ1.6 ç‰ˆæœ¬ä»¥ä¸Šçš„éƒ½é»˜è®¤å¼€å¯äº†RBACï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ Master èŠ‚ç‚¹ä¸Š apiserver çš„é™æ€Podå®šä¹‰æ–‡ä»¶ï¼š</p><h3 id="2ã€-kubernetes-å…³äºç©ºé—´æƒé™èµ‹äºˆ"><a href="#2ã€-kubernetes-å…³äºç©ºé—´æƒé™èµ‹äºˆ" class="headerlink" title="2ã€ kubernetes å…³äºç©ºé—´æƒé™èµ‹äºˆ"></a>2ã€ kubernetes å…³äºç©ºé—´æƒé™èµ‹äºˆ</h3><h4 id="1ã€è·å–å¹¶æŸ¥çœ‹"><a href="#1ã€è·å–å¹¶æŸ¥çœ‹" class="headerlink" title="1ã€è·å–å¹¶æŸ¥çœ‹"></a>1ã€è·å–å¹¶æŸ¥çœ‹</h4><ul><li>Role</li><li>ClusterRole</li><li>RoleBinding</li><li>ClusterRoleBinding</li></ul><a id="more"></a><ul><li><p>1.1ã€æŸ¥çœ‹kube-system namespaceä¸‹çš„æ‰€æœ‰role</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get role -n kube-system</span><br></pre></td></tr></table></figure></li><li><p>1.2ã€æŸ¥çœ‹æŸä¸ªroleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get role &lt;role-name&gt; -n kube-system -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.3ã€æŸ¥çœ‹kube-system namespaceä¸‹æ‰€æœ‰çš„rolebinding</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get rolebinding -n kube-system</span><br></pre></td></tr></table></figure></li><li><p>1.4ã€æŸ¥çœ‹kube-system namespaceä¸‹çš„æŸä¸ªrolebindingè¯¦ç»†ä¿¡æ¯ï¼ˆç»‘å®šçš„Roleå’Œsubjectï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get rolebinding &lt;rolebind-name&gt; -n kube-system -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.5ã€æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰çš„clusterrole</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole</span><br></pre></td></tr></table></figure></li><li><p>1.6ã€æŸ¥çœ‹æŸä¸ªclusterroleå®šä¹‰çš„èµ„æºæƒé™è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole &lt;clusterrole-name&gt; -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.7ã€æŸ¥çœ‹æ‰€æœ‰çš„clusterrolebinding</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrolebinding</span><br></pre></td></tr></table></figure></li><li><p>1.8ã€æŸ¥çœ‹æŸä¸€clusterrolebindingçš„è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrolebinding &lt;clusterrolebinding-name&gt; -o yaml</span><br></pre></td></tr></table></figure></li></ul><h4 id="2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚"><a href="#2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚" class="headerlink" title="2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚"></a>2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚</h4><ul><li><p>åœ¨æŸä¸€ç‰¹å®šåå­—ç©ºé—´å†…æˆäºˆRoleæˆ–è€…ClusterRoleã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding</span><br></pre></td></tr></table></figure></li><li><p>åœ¨åä¸ºâ€acmeâ€çš„åå­—ç©ºé—´ä¸­å°†admin ClusterRoleæˆäºˆç”¨æˆ·â€bobâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding bob-admin-binding --clusterrole=admin --user=bob --namespace=acme</span><br></pre></td></tr></table></figure></li><li><p>åœ¨åä¸ºâ€acmeâ€çš„åå­—ç©ºé—´ä¸­å°†view ClusterRoleæˆäºˆæœåŠ¡è´¦æˆ·â€myappâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding myapp-view-binding --clusterrole=view --serviceaccount=acme:myapp --namespace=acme</span><br><span class="line">kubectl create clusterrolebinding</span><br></pre></td></tr></table></figure></li></ul><h4 id="3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š"><a href="#3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š" class="headerlink" title="3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š"></a>3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</h4><ul><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†cluster-admin ClusterRoleæˆäºˆç”¨æˆ·â€rootâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding root-cluster-admin-binding --clusterrole=cluster-admin --user=root</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†system:node ClusterRoleæˆäºˆç”¨æˆ·â€kubeletâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-node-binding --clusterrole=system:node --user=kubelet</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†view ClusterRoleæˆäºˆåå­—ç©ºé—´â€acmeâ€å†…çš„æœåŠ¡è´¦æˆ·â€myappâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding myapp-view-binding --clusterrole=view --serviceaccount=acme:myapp</span><br></pre></td></tr></table></figure></li></ul><h4 id="4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™"><a href="#4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™" class="headerlink" title="4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™"></a>4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™</h4><ul><li><p>æŸ¥çœ‹kube-ops ä¸‹é¢çš„è§’è‰²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role -n kube-ops</span></span><br><span class="line">NAME       AGE</span><br><span class="line">jenkins2   2d6h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹roleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role jenkins2 -n kube-ops -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2019-01-14T03:07:25Z"</span></span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  resourceVersion: <span class="string">"2389179"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/kube-ops/roles/jenkins2</span><br><span class="line">  uid: 84762132-17a9-11e9-8991-fa163e14c5bd</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">exec</span></span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">log</span></span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºjenkins2çš„æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test-3 ~]<span class="comment"># kubectl -n kube-system create sa jenkins2</span></span><br><span class="line">serviceaccount/jenkins2 created</span><br></pre></td></tr></table></figure></li><li><p>æˆæƒè®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test-3 ~]<span class="comment"># kubectl create clusterrolebinding jenkins2 --clusterrole cluster-admin --serviceaccount=kube-ops:jenkins2</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/jenkins2 created</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>RBAC</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s heapster</title>
    <url>/2019/08/24/k8s-heapster/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="1ã€heapster-ä»‹ç»"><a href="#1ã€heapster-ä»‹ç»" class="headerlink" title="1ã€heapster ä»‹ç»"></a>1ã€heapster ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Heapsteræ˜¯å®¹å™¨é›†ç¾¤ç›‘æ§å’Œæ€§èƒ½åˆ†æå·¥å…·,æ”¯æŒKuberneteså’ŒCoreOSã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesæœ‰ä¸ªç›‘æ§agentâ€”cAdvisorã€‚åœ¨æ¯ä¸ªkubernetes Nodeä¸Šéƒ½ä¼šè¿è¡ŒcAdvisor,å®ƒä¼šæ”¶é›†æœ¬æœºä»¥åŠå®¹å™¨çš„ç›‘æ§æ•°æ®(cpu,memory,filesystem,network,uptime)ã€‚åœ¨è¾ƒæ–°çš„ç‰ˆæœ¬ä¸­ï¼ŒK8Så·²ç»å°†cAdvisoråŠŸèƒ½é›†æˆåˆ°kubeletç»„ä»¶ä¸­ã€‚æ¯ä¸ªNodeèŠ‚ç‚¹å¯ä»¥ç›´æ¥è¿›è¡Œwebè®¿é—®ã€‚</p><h3 id="2ã€heapster-å®‰è£…"><a href="#2ã€heapster-å®‰è£…" class="headerlink" title="2ã€heapster å®‰è£…"></a>2ã€heapster å®‰è£…</h3><p>ä¸‹è½½heapsterçš„<a href="https://github.com/kubernetes-retired/heapster/tree/master/deploy/kube-config" target="_blank" rel="noopener">yamlæ–‡ä»¶</a>ï¼Œä¸‹è½½å®Œæˆåæˆ‘ä»¬éœ€è¦å¯¹æ–‡ä»¶ä¿®æ”¹ï¼Œä»¥æ»¡è¶³æˆ‘ä»¬çš„çš„éœ€æ±‚.</p><h4 id="2-1ã€grafanaä¿®æ”¹"><a href="#2-1ã€grafanaä¿®æ”¹" class="headerlink" title="2.1ã€grafanaä¿®æ”¹"></a>2.1ã€grafanaä¿®æ”¹</h4><p>grafanaæ·»åŠ nodePort: 30003è®©grafanaæ”¯æŒå¤–éƒ¨è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç«¯å£è¿›è¡Œä½†å•ç‹¬çš„é¡µé¢é…ç½®ã€‚</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: k8s.gcr.io/heapster-grafana-amd64:v5.0.4</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/certs</span><br><span class="line">          name: ca-certificates</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">        - mountPath: /var</span><br><span class="line">          name: grafana-storage</span><br><span class="line">        env:</span><br><span class="line">        - name: INFLUXDB_HOST</span><br><span class="line">          value: monitoring-influxdb</span><br><span class="line">        - name: GF_SERVER_HTTP_PORT</span><br><span class="line">          value: <span class="string">"3000"</span></span><br><span class="line">          <span class="comment"># The following env variables are required to make Grafana accessible via</span></span><br><span class="line">          <span class="comment"># the kubernetes api-server proxy. On production clusters, we recommend</span></span><br><span class="line">          <span class="comment"># removing these env variables, setup auth for grafana, and expose the grafana</span></span><br><span class="line">          <span class="comment"># service using a LoadBalancer or a public IP.</span></span><br><span class="line">        - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">          value: <span class="string">"false"</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class="line">          value: Admin</span><br><span class="line">        - name: GF_SERVER_ROOT_URL</span><br><span class="line">          <span class="comment"># If you're only using the API Server proxy, set this value instead:</span></span><br><span class="line">          <span class="comment"># value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span></span><br><span class="line">          value: /</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ca-certificates</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/ssl/certs</span><br><span class="line">      - name: grafana-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></span><br><span class="line">    kubernetes.io/name: monitoring-grafana</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># In a production setup, we recommend accessing Grafana through an external Loadbalancer</span></span><br><span class="line">  <span class="comment"># or through a public IP.</span></span><br><span class="line">  <span class="comment"># type: LoadBalancer</span></span><br><span class="line">  <span class="comment"># You could also use NodePort to expose the service at a randomly-generated port</span></span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 3000</span><br><span class="line">    nodePort: 30003</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: grafana</span><br></pre></td></tr></table></figure><h4 id="2-2ã€heapsteræ–‡ä»¶ä¿®æ”¹"><a href="#2-2ã€heapsteræ–‡ä»¶ä¿®æ”¹" class="headerlink" title="2.2ã€heapsteræ–‡ä»¶ä¿®æ”¹"></a>2.2ã€heapsteræ–‡ä»¶ä¿®æ”¹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- --<span class="built_in">source</span>=kubernetes:https://kubernetes.default?useServiceAccount=<span class="literal">true</span>&amp;kubeletHttps=<span class="literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="literal">true</span></span><br><span class="line">è¿æ¥k8s apiçš„åœ°å€ï¼Œé»˜è®¤æ˜¯kubernetes.defaultï¼Œåé¢ä¸€æ®µåŠ å…¥ç”¨æˆ·è®¤è¯ï¼Œç«¯å£ï¼Œä»¥åŠhttps;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</span><br><span class="line">æŒ‡å®š influxdbæ•°æ®åº“çš„åœ°å€ï¼Œè¿™ä¸ªåœ¨infuxdbæ–‡ä»¶é‡Œé¢æœ‰è¿™ä¸ªåŸŸå</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: heapster</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: k8s.gcr.io/heapster-amd64:v1.5.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - /heapster</span><br><span class="line">        - --<span class="built_in">source</span>=kubernetes:https://kubernetes.default?useServiceAccount=<span class="literal">true</span>&amp;kubeletHttps=<span class="literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="literal">true</span></span><br><span class="line">        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></span><br><span class="line">    kubernetes.io/name: Heapster</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: heapster</span><br></pre></td></tr></table></figure><h3 id="3ã€æ‰§è¡Œåˆ›å»ºheapster"><a href="#3ã€æ‰§è¡Œåˆ›å»ºheapster" class="headerlink" title="3ã€æ‰§è¡Œåˆ›å»ºheapster"></a>3ã€æ‰§è¡Œåˆ›å»ºheapster</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubect create -f ./</span></span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œåˆ›å»ºå®Œæˆåï¼Œç­‰å¾…ä¸€ä¼šæ˜¾ç¤ºå›¾åƒ<br><img src="https://img.xxlaila.cn/459348skndiy923s.png" alt="img"><br><img src="https://img.xxlaila.cn/34293knsdalsk0329.png" alt="img"></p><h4 id="3-1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸"><a href="#3-1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸" class="headerlink" title="3.1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸"></a>3.1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸</h4><p>å‰é¢åœ¨grafanaæ–‡ä»¶é‡Œé¢å¢åŠ äº†nodePoer: 30003çš„ç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»æ„èŠ‚ç‚¹ip:30003è¿›è¡Œè®¿é—®grafanaç•Œé¢ã€‚</p><p><img src="https://img.xxlaila.cn/453847sndkniuy234wds.png" alt="img"><br><strong>å¯ä»¥è¿›è¡Œé…ç½®grafanaã€‚</strong></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>heapster</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²eurekaé›†ç¾¤</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2eureka%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>eureka ä¸é˜è¿°ä»‹ç»ï¼Œè¿™é‡Œç›´æ¥å¼€å§‹åœ¨kubernetesä¸‹éƒ¨ç½²eurekaé›†ç¾¤</p><h3 id="1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ "><a href="#1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ " class="headerlink" title="1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ "></a>1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ </h3><p>eureka åªä¸€ä¸ªæœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œéƒ¨ç½²æœ‰çŠ¶æ€æœåŠ¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨StatefulSet</p><h4 id="1-1ã€å¢åŠ dockerfile"><a href="#1-1ã€å¢åŠ dockerfile" class="headerlink" title="1.1ã€å¢åŠ dockerfile"></a>1.1ã€å¢åŠ dockerfile</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat Dockerfile</span><br><span class="line">FROM docker.io/xxlaila/centos7.6-jdk1.8:latest</span><br><span class="line">MAINTAINER xxlaila <span class="string">"cq_xxlaila@163.com"</span></span><br><span class="line"><span class="comment"># Install dependent plugin</span></span><br><span class="line"></span><br><span class="line">ADD target/kxl-eureka.jar /opt/webapps/kxl-eureka.jar</span><br><span class="line">ADD application.yaml /opt/webapps/application.yaml</span><br><span class="line"></span><br><span class="line">WORKDIR /opt/webapps</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"-Dspring.profiles.active=dev"</span>, <span class="string">"kxl-eureka.jar"</span>]</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#1-2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="1.2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>1.2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><p>åœ¨åšeurekaé›†ç¾¤çš„æ—¶å€™ï¼Œapplication.yamlçš„é…ç½®æ–‡ä»¶å¾ˆé‡è¦ï¼Œé…ç½®æ–‡ä»¶åšä¸å¥½ï¼Œå°†ä¼šç›´æ¥å½±å“åˆ°eurekaçš„å¯åŠ¨ï¼Œè¿˜æœ‰é›†ç¾¤çš„æ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat application.yaml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: kxl-eureka</span><br><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line"><span class="comment">#    prefer-ip-address: true</span></span><br><span class="line">    hostname: <span class="variable">$&#123;EUREKA_HOST_NAME:peer1&#125;</span> <span class="comment">#æœåŠ¡ä¸»æœºå</span></span><br><span class="line">    appname: <span class="variable">$&#123;spring.application.name&#125;</span>  <span class="comment">#æœåŠ¡åç§°ï¼Œé»˜è®¤ä¸º unknow è¿™é‡Œç›´æ¥å– spring.application.name äº†</span></span><br><span class="line">    <span class="comment"># server ä»æœ€åä¸€æ¬¡æ”¶åˆ°å¿ƒè·³åˆ°ç§»é™¤åºŸå¼ƒæœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    lease-expiration-duration-in-seconds: 90</span><br><span class="line">    <span class="comment"># client ç»™ server å‘é€å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæ¯” lease-expiration-duration-in-seconds å°</span></span><br><span class="line">    lease-renewal-interval-in-seconds: 30</span><br><span class="line"></span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: <span class="variable">$&#123;EUREKA_URL_LIST:http://peer1:8761/eureka/&#125;</span> <span class="comment"># æŒ‡å®šæœåŠ¡ä¸­å¿ƒ eureka serverçš„åœ°å€</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦ä»eurekaä¸Šæ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    fetch-registry: <span class="variable">$&#123;BOOL_FETCH:true&#125;</span>   <span class="comment"># æ˜¯å¦æ‹‰å– eureka server çš„æ³¨å†Œä¿¡æ¯ã€‚ é»˜è®¤ä¸ºtrue</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦æ³¨å†Œåˆ°eurekaä¸Šï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    register-with-eureka: <span class="variable">$&#123;BOOL_REGISTER:true&#125;</span>  <span class="comment"># æ˜¯å¦æŠŠæœåŠ¡ä¸­å¿ƒæœ¬èº«å½“åšeureka client æ³¨å†Œã€‚é»˜è®¤ä¸ºtrue</span></span><br><span class="line">    <span class="comment"># client é—´éš”å¤šä¹…å»æ‹‰å»æœåŠ¡ä¿¡æ¯(ç§’)</span></span><br><span class="line">    registry-fetch-interval-seconds: 30</span><br><span class="line">  server:</span><br><span class="line">    <span class="comment"># è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåº”å¯¹ç½‘ç»œé—ªæ–­æƒ…å†µï¼Œå¤§é¢ç§¯ä¸¢å¤±è¿‡å¤šçš„clientï¼Œä¸åˆ é™¤æœåŠ¡</span></span><br><span class="line">    <span class="built_in">enable</span>-self-preservation: <span class="variable">$&#123;SELF_PRESERVATION:true&#125;</span>     <span class="comment"># æ˜¯å¦å¼€å¯è‡ªæˆ‘ä¿æŠ¤ã€‚ é»˜è®¤ä¸º true.</span></span><br><span class="line">    <span class="comment"># æ¯åˆ†é’Ÿå¿ƒè·³æ•° å®é™…/æœŸæœ›ï¼Œå¦‚æœå°äºé˜ˆå€¼(threshold)ï¼Œåˆ™è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</span></span><br><span class="line">    renewal-percent-threshold: 0.85</span><br><span class="line">    <span class="comment"># æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">    eviction-interval-timer-in-ms: 60000</span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: <span class="variable">$&#123;EUREKA_APPLICATION_NAME:eureka-server&#125;</span></span><br></pre></td></tr></table></figure><h4 id="1-3ã€åˆ›å»º-eureka-dockeré•œåƒ"><a href="#1-3ã€åˆ›å»º-eureka-dockeré•œåƒ" class="headerlink" title="1.3ã€åˆ›å»º eureka dockeré•œåƒ"></a>1.3ã€åˆ›å»º eureka dockeré•œåƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t xxlaila/kxl-eureka:v1 .</span><br><span class="line">$ docker push xxlaila/kxl-eureka:v1</span><br></pre></td></tr></table></figure><h3 id="2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤"><a href="#2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤" class="headerlink" title="2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤"></a>2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤</h3><h4 id="2-1ã€åˆ›å»ºeurekaé›†ç¾¤"><a href="#2-1ã€åˆ›å»ºeurekaé›†ç¾¤" class="headerlink" title="2.1ã€åˆ›å»ºeurekaé›†ç¾¤"></a>2.1ã€åˆ›å»ºeurekaé›†ç¾¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat kxl-eureka.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  labels:</span><br><span class="line">    app: eureka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8761</span><br><span class="line">    name: eureka</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"eureka"</span></span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: eureka</span><br><span class="line">        image:  docker.io/xxlaila/kxl-eureka:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8761</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">          <span class="comment"># Due to camelcase issues with "defaultZone" and "preferIpAddress", _JAVA_OPTIONS is used here</span></span><br><span class="line">        - name: eureka_client_serviceUrl_defaultZone</span><br><span class="line">          <span class="comment">#value: http://eureka-0.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/,http://eureka-1.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/</span></span><br><span class="line">          value: http://eureka-0.eureka:8761/eureka/,http://eureka-1.eureka:8761/eureka/,http://eureka-2.eureka:8761/eureka/</span><br><span class="line">        - name: EUREKA_CLIENT_REGISTERWITHEUREKA</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: EUREKA_CLIENT_FETCHREGISTRY</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">          <span class="comment"># In the docker image, this is set to localhost. Otherwise, we could leave this empty.</span></span><br><span class="line">          <span class="comment"># The hostnames must match with the the eureka serviceUrls, otherwise the replicas are reported as unavailable in the eureka dashboard</span></span><br><span class="line">        - name: EUREKA_INSTANCE_HOSTNAME</span><br><span class="line">          <span class="comment">#value: "$(MY_POD_NAME).eureka.&lt;namespace.svc.cluster.local"</span></span><br><span class="line">          value: <span class="string">"<span class="variable">$(MY_POD_NAME)</span>.eureka"</span></span><br><span class="line">          <span class="comment">#value: eureka</span></span><br><span class="line">          <span class="comment"># For the other (stateless) services, this should probably be set to true, since their pods have no DNS-resolvable  hostnames</span></span><br><span class="line">       <span class="comment">#- name: EUREKA_INSTANCE_PREFERIPADDRESS</span></span><br><span class="line">       <span class="comment">#  value: "false"</span></span><br><span class="line">  <span class="comment"># No need to start the pods in order. We just need the stable network identity</span></span><br><span class="line">  podManagementPolicy: <span class="string">"Parallel"</span></span><br></pre></td></tr></table></figure><p>åœ¨åšè¿™ä¸ªçš„æ—¶å€™å…¶å®é‡åˆ°äº†å¾ˆå¤šå‘ï¼Œä¹Ÿæ˜¯å‚è€ƒä¸€äº›æ–‡ç« æ‰å®Œæˆçš„,<a href="https://github.com/kingschan1204/blog/issues/5" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><h4 id="2-2ã€åˆ›å»ºeureka-Ingress"><a href="#2-2ã€åˆ›å»ºeureka-Ingress" class="headerlink" title="2.2ã€åˆ›å»ºeureka Ingress"></a>2.2ã€åˆ›å»ºeureka Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat eureka-ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka-ingress</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/secure-backends: <span class="string">"true"</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: eureka.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: eureka</span><br><span class="line">          servicePort: 8761</span><br></pre></td></tr></table></figure><h4 id="2-3ã€æ‰§è¡Œåˆ›å»º"><a href="#2-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="2.3ã€æ‰§è¡Œåˆ›å»º"></a>2.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f .</span><br><span class="line">$ kubectl get pods -n kube-dev</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">eureka-0   1/1     Running   0          21m</span><br><span class="line">eureka-1   1/1     Running   0          21m</span><br><span class="line">eureka-2   1/1     Running   0          21m</span><br><span class="line">$ kubectl get pods,svc,rs -n kube-dev</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/eureka-0   1/1     Running   0          21m</span><br><span class="line">pod/eureka-1   1/1     Running   0          21m</span><br><span class="line">pod/eureka-2   1/1     Running   0          21m</span><br><span class="line"></span><br><span class="line">NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/eureka   ClusterIP   None         &lt;none&gt;        8761/TCP   21m</span><br></pre></td></tr></table></figure><h4 id="2-4ã€è®¿é—®éªŒè¯"><a href="#2-4ã€è®¿é—®éªŒè¯" class="headerlink" title="2.4ã€è®¿é—®éªŒè¯"></a>2.4ã€è®¿é—®éªŒè¯</h4><p><img src="https://img.xxlaila.cn/34239uskdnksjda.png" alt="img"><br>é€šè¿‡åŸŸåè®¿é—®ï¼š<br><img src="https://img.xxlaila.cn/89745jkndklsajkdhsajkbfa.png" alt="img"></p><h3 id="3ã€eureka-ç¯å¢ƒ"><a href="#3ã€eureka-ç¯å¢ƒ" class="headerlink" title="3ã€eureka ç¯å¢ƒ"></a>3ã€eureka ç¯å¢ƒ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ ¹æ®2.4å°èŠ‚å¯ä»¥çœ‹åˆ°ï¼Œenviroonmentä¸ºtestï¼Œæˆ‘ä»¬åœ¨dockerfileæŒ‡å®šçš„ä¸ºdevï¼Œæ‰€ä»¥è¿™é‡Œå°±æœ‰ç‚¹å·®æ± ï¼Œä½†æ˜¯æŸ¥çœ‹äº†ä¸€ä¸‹èµ„æ–™ï¼Œè¿™ä¸ªè¦ä¹ˆå°±å†™å¤šä¸ªapplication.yamlçš„é…ç½®æ–‡ä»¶ï¼Œè¦ä¹ˆå°±æ‰“å¤šä¸ªåŒ…ï¼Œè¿™æ ·å°±æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”è€ƒè™‘åˆ°å…¬å¸å¾®æœåŠ¡çš„ç‰¹æ®Šæ€§ï¼Œæ—¢è¦æ»¡è¶³äºå…¬å¸çš„å¾®æœåŠ¡æ¶æ„ï¼Œæœ‰è¦è€ƒè™‘çš„æ¨¡ç‰ˆçš„é€šç”¨æ€§ï¼Œè¿˜éœ€è¦è€ƒè™‘è¿ç»´ç»´æŠ¤çš„ä¾¿æ·æ€§ã€‚ä¸‹é¢ä¸€èµ·æ¥çœ‹çœ‹åŸºäºå…¬å¸çš„å®šåˆ¶åŒ–æ¥æ”¹å˜è¿™ä¸ªå±€é™æ€§ã€‚</p><h4 id="3-1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡"><a href="#3-1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡" class="headerlink" title="3.1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡"></a>3.1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CONFIG_API_SERVER=http://api.conf.xxlaila.io</span><br><span class="line">RUN_CLUSTER=default</span><br><span class="line">RUN_MODE=AUTO</span><br><span class="line">RUN_ENV=demo</span><br><span class="line">CONFIG_API_SERVERï¼šå…¬å¸é…ç½®ä¸­å¿ƒapiçš„åœ°å€ï¼Œappæ‹‰å–é…ç½®ä¸­å¿ƒçš„é…ç½®</span><br><span class="line">RUN_CLUSTERï¼šé»˜è®¤é›†ç¾¤ï¼Œåšç°åº¦å‘å¸ƒä½¿ç”¨</span><br><span class="line">RUN_MODEï¼š</span><br><span class="line">RUN_ENVï¼šå½“å‰ç³»ç»Ÿæ‰€è¿è¡Œçš„ç¯å¢ƒ</span><br></pre></td></tr></table></figure><h4 id="3-2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶"><a href="#3-2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶" class="headerlink" title="3.2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶"></a>3.2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶</h4><p>å¢åŠ é…ç½®eureka:<code>environment: ${RUN_ENV}</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat application.yaml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: kxl-eureka</span><br><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  environment: <span class="variable">$&#123;RUN_ENV&#125;</span></span><br><span class="line">  instance:</span><br><span class="line"><span class="comment">#    prefer-ip-address: true</span></span><br><span class="line">    hostname: <span class="variable">$&#123;EUREKA_HOST_NAME:peer1&#125;</span></span><br><span class="line">    appname: <span class="variable">$&#123;spring.application.name&#125;</span></span><br><span class="line">    <span class="comment"># server ä»æœ€åä¸€æ¬¡æ”¶åˆ°å¿ƒè·³åˆ°ç§»é™¤åºŸå¼ƒæœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    lease-expiration-duration-in-seconds: 90</span><br><span class="line">    <span class="comment"># client ç»™ server å‘é€å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæ¯” lease-expiration-duration-in-seconds å°</span></span><br><span class="line">    lease-renewal-interval-in-seconds: 30</span><br><span class="line"></span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: <span class="variable">$&#123;EUREKA_URL_LIST:http://peer1:8761/eureka/&#125;</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦ä»eurekaä¸Šæ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    fetch-registry: <span class="variable">$&#123;BOOL_FETCH:true&#125;</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦æ³¨å†Œåˆ°eurekaä¸Šï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    register-with-eureka: <span class="variable">$&#123;BOOL_REGISTER:true&#125;</span></span><br><span class="line">    <span class="comment"># client é—´éš”å¤šä¹…å»æ‹‰å»æœåŠ¡ä¿¡æ¯(ç§’)</span></span><br><span class="line">    registry-fetch-interval-seconds: 30</span><br><span class="line">  server:</span><br><span class="line">    <span class="comment"># è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåº”å¯¹ç½‘ç»œé—ªæ–­æƒ…å†µï¼Œå¤§é¢ç§¯ä¸¢å¤±è¿‡å¤šçš„clientï¼Œä¸åˆ é™¤æœåŠ¡</span></span><br><span class="line">    <span class="built_in">enable</span>-self-preservation: <span class="variable">$&#123;SELF_PRESERVATION:true&#125;</span></span><br><span class="line">    <span class="comment"># æ¯åˆ†é’Ÿå¿ƒè·³æ•° å®é™…/æœŸæœ›ï¼Œå¦‚æœå°äºé˜ˆå€¼(threshold)ï¼Œåˆ™è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</span></span><br><span class="line">    renewal-percent-threshold: 0.85</span><br><span class="line">    <span class="comment"># æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">    eviction-interval-timer-in-ms: 60000</span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: <span class="variable">$&#123;EUREKA_APPLICATION_NAME:eureka-server&#125;</span></span><br></pre></td></tr></table></figure><h4 id="3-3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶"><a href="#3-3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶" class="headerlink" title="3.3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶"></a>3.3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat kxl-eureka.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  labels:</span><br><span class="line">    app: eureka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8761</span><br><span class="line">    name: eureka</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"eureka"</span></span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: eureka</span><br><span class="line">        image:  docker.io/xxlaila/kxl-eureka:v2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8761</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">          <span class="comment"># Due to camelcase issues with "defaultZone" and "preferIpAddress", _JAVA_OPTIONS is used here</span></span><br><span class="line">        - name: eureka_client_serviceUrl_defaultZone</span><br><span class="line">          <span class="comment">#value: http://eureka-0.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/,http://eureka-1.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/</span></span><br><span class="line">          value: http://eureka-0.eureka:8761/eureka/,http://eureka-1.eureka:8761/eureka/,http://eureka-2.eureka:8761/eureka/</span><br><span class="line">        - name: EUREKA_CLIENT_REGISTERWITHEUREKA</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: EUREKA_CLIENT_FETCHREGISTRY</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">          <span class="comment"># In the docker image, this is set to localhost. Otherwise, we could leave this empty.</span></span><br><span class="line">          <span class="comment"># The hostnames must match with the the eureka serviceUrls, otherwise the replicas are reported as unavailable in the eureka dashboard</span></span><br><span class="line">        - name: EUREKA_INSTANCE_HOSTNAME</span><br><span class="line">          <span class="comment">#value: "$(MY_POD_NAME).eureka.&lt;namespace.svc.cluster.local"</span></span><br><span class="line">          value: <span class="string">"<span class="variable">$(MY_POD_NAME)</span>.eureka"</span></span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: <span class="built_in">test</span></span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.io</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">          <span class="comment">#value: eureka</span></span><br><span class="line">          <span class="comment"># For the other (stateless) services, this should probably be set to true, since their pods have no DNS-resolvable  hostnames</span></span><br><span class="line">       <span class="comment">#- name: EUREKA_INSTANCE_PREFERIPADDRESS</span></span><br><span class="line">       <span class="comment">#  value: "false"</span></span><br><span class="line">  <span class="comment"># No need to start the pods in order. We just need the stable network identity</span></span><br><span class="line">  podManagementPolicy: <span class="string">"Parallel"</span></span><br></pre></td></tr></table></figure><h4 id="3-4ã€é‡å»ºpod"><a href="#3-4ã€é‡å»ºpod" class="headerlink" title="3.4ã€é‡å»ºpod"></a>3.4ã€é‡å»ºpod</h4><p>podé‡å»ºä»¥åæˆ‘ä»¬ç»è¿‡è®¿é—®å¯ä»¥çœ‹åˆ°</p><p><img src="https://img.xxlaila.cn/453khskdha324.png" alt="img"><br><img src="https://img.xxlaila.cn/3746dfnks324.png" alt="img"></p><p><em>åç»­æŒç»­ä¼˜åŒ–</em></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>eureka</tag>
      </tags>
  </entry>
  <entry>
    <title>jiraæ¥å…¥LDAP</title>
    <url>/2019/08/24/jira%E6%8E%A5%E5%85%A5LDAP/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰ä»‹ç»äº†jira å’Œconfluenceçš„è´¦æˆ·ç»“åˆï¼Œjiraå’Œconfluenceå¯ä»¥ä½¿ç”¨ä¸€ä¸ªè´¦æˆ·ï¼Œæœ‰äººå‘˜ç¦»èŒä¹‹åç›´æ¥åœ¨jiraå§ç”¨æˆ·ç¦ç”¨å³å¯ï¼Œä¸€ç«¯æ“ä½œï¼Œæ–¹ä¾¿ä¸¤ç«¯ï¼Œä½†æ˜¯éšç€å…¬å¸äººå‘˜è¶Šæ¥è¶Šå¤šï¼Œè¿™æ ·çš„æ–¹å¼å·²ç»ä¸åœ¨é€‚åˆè¿™ç§äº†ï¼Œæ¥ä¸€ä¸ªç”¨æˆ·å°±éœ€è¦å»åˆ›å»ºï¼Œå¯¹è¿ç»´æ¥è¯´ï¼Œè¿™æ˜¯é‡å¤çš„å·¥ä½œï¼Œæå‡ä¸äº†ä»»ä½•æ•ˆç‡ï¼Œè€Œä¸”æ¯è‰æ— å‘³ã€‚è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ldapï¼Œjiraå’Œconfluenceéƒ½æ˜¯æ”¯æŒldapï¼Œldapçš„å¥½å¤„ï¼Œè¿™é‡Œä¸é˜è¿°ï¼Œä¸‹é¢æ¥çœ‹çœ‹å¦‚ä½•é…ç½®jiraä»‹å…¥ldapã€‚confluenceè¿˜æ˜¯æ¥å…¥jiraï¼Œè¿™æ ·æˆ‘ä»¬å°±åªæ“ä½œladpå’Œjiraï¼Œç®€å•çœäº‹ã€‚</p></blockquote><blockquote><p>é—®é¢˜ç‚¹:<br>&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºåœ¨å»ºç«‹jiraå’Œconfluenceçš„æ—¶å€™è¿˜æ²¡æœ‰ldapï¼Œldapæ˜¯åæœŸæ‰æ¥å…¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±å­˜åœ¨äºæ€ä¹ˆå§ä»¥å‰æœ‰jiraç™»å½•çš„è´¦æˆ·è®¤è¯åˆ‡æ¢åˆ°ldapã€‚è€Œä¸”ä¸å½±å“ä¹‹å‰çš„æ–‡æ¡£ï¼Œä½†æ˜¯ç”¨æˆ·æƒé™ä¼šå½±å“ï¼Œé—®é¢˜ä¸å¤§ï¼Œå¯ä»¥æ·»åŠ ã€‚ä¸‹é¢å¼€å§‹æ“ä½œ</p></blockquote><a id="more"></a><h3 id="1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢"><a href="#1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢" class="headerlink" title="1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢"></a>1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢</h3><p><img src="https://img.xxlaila.cn/image2018-7-12_11-12-55.png" alt="img"></p><h3 id="2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢"><a href="#2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢" class="headerlink" title="2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢"></a>2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-32-32.png" alt="img"><br><img src="https://img.xxlaila.cn/image2019-6-12_15-32-48.png" alt="img"></p><h3 id="3ã€é«˜çº§è®¾ç½®"><a href="#3ã€é«˜çº§è®¾ç½®" class="headerlink" title="3ã€é«˜çº§è®¾ç½®"></a>3ã€é«˜çº§è®¾ç½®</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-17.png" alt="img"></p><h3 id="4ã€é…ç½®ç”¨æˆ·æ¨¡å¼"><a href="#4ã€é…ç½®ç”¨æˆ·æ¨¡å¼" class="headerlink" title="4ã€é…ç½®ç”¨æˆ·æ¨¡å¼"></a>4ã€é…ç½®ç”¨æˆ·æ¨¡å¼</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-35.png" alt="img"></p><h3 id="5ã€è®¾ç½®ç»„æ¨¡å¼"><a href="#5ã€è®¾ç½®ç»„æ¨¡å¼" class="headerlink" title="5ã€è®¾ç½®ç»„æ¨¡å¼"></a>5ã€è®¾ç½®ç»„æ¨¡å¼</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-55.png" alt="img"></p><h3 id="6ã€è®¾ç½®æˆå‘˜æ¨¡å¼"><a href="#6ã€è®¾ç½®æˆå‘˜æ¨¡å¼" class="headerlink" title="6ã€è®¾ç½®æˆå‘˜æ¨¡å¼"></a>6ã€è®¾ç½®æˆå‘˜æ¨¡å¼</h3><p>è¿™é‡Œldapä¸€å®šè¦å­˜åœ¨ä¸ladpçš„groupé‡Œé¢<br><img src="https://img.xxlaila.cn/image2019-6-12_15-34-23.png" alt="img"></p><h3 id="7ã€æµ‹è¯•å¹¶ä¿å­˜"><a href="#7ã€æµ‹è¯•å¹¶ä¿å­˜" class="headerlink" title="7ã€æµ‹è¯•å¹¶ä¿å­˜"></a>7ã€æµ‹è¯•å¹¶ä¿å­˜</h3><p>è¿™é‡Œæµ‹è¯•è´¦æˆ·ä¸€å®šæ˜¯ladpçš„è´¦æˆ·<br><img src="https://img.xxlaila.cn/image2019-6-12_15-34-58.png" alt="img"></p><h3 id="8ã€åŒæ­¥è´¦æˆ·"><a href="#8ã€åŒæ­¥è´¦æˆ·" class="headerlink" title="8ã€åŒæ­¥è´¦æˆ·"></a>8ã€åŒæ­¥è´¦æˆ·</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-35-50.png" alt="img"></p><h3 id="9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•"><a href="#9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•" class="headerlink" title="9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•"></a>9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-36-53.png" alt="img"></p><h2 id="jiraè´¦æˆ·åˆ‡æ¢è‡³ldap"><a href="#jiraè´¦æˆ·åˆ‡æ¢è‡³ldap" class="headerlink" title="jiraè´¦æˆ·åˆ‡æ¢è‡³ldap"></a>jiraè´¦æˆ·åˆ‡æ¢è‡³ldap</h2><blockquote><p>jiraé…ç½®ldapä»¥åé»˜è®¤æ˜¯æœ¬åœ°è´¦æˆ·å’Œldapæ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œç”¨æˆ·å¯ä»¥ç”¨ä»¥å‰çš„æœ¬åœ°è´¦æˆ·å’Œldapéƒ½ç™»å½•ï¼Œè¿™é‡Œå®ç°ldapç™»å½•ï¼Œç¦æ­¢æœ¬åœ°ç™»å½•ã€‚</p></blockquote><h3 id="å‰ç½®æ¡ä»¶"><a href="#å‰ç½®æ¡ä»¶" class="headerlink" title="å‰ç½®æ¡ä»¶"></a>å‰ç½®æ¡ä»¶</h3><ul><li>jiraçš„æœ¬åœ°è´¦æˆ·å’Œldapçš„è´¦æˆ·åç§°å¿…é¡»ä¸€æ ·</li><li>æ“ä½œå‰è¯·å¤‡ä»½æ•°æ®åº“</li><li>ç”¨æˆ·é‚®ç®±ä¿æŒä¸€è‡´</li><li>å¯†ç æ— æ‰€è°“ï¼Œä¸éœ€è¦ç»Ÿä¸€</li></ul><h3 id="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”"><a href="#æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”" class="headerlink" title="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”"></a>æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”</h3><p>ç™»å½•jiraçš„æ•°æ®åº“ã€‚ç„¶åæ‰¾åˆ°cwd_userè¡¨</p><h4 id="cwd-userè¡¨"><a href="#cwd-userè¡¨" class="headerlink" title="cwd_userè¡¨"></a>cwd_userè¡¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;jiraçš„å‰å°ä¸èƒ½ç›´æ¥å»æ›´æ”¹ï¼Œåªæœ‰æ›´æ”¹æ•°æ®åº“ï¼Œè¿›å…¥æ•°æ®åº“ï¼Œæ‰¾åˆ°ä¸€å¼ cwd_userçš„è¡¨ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰ç”¨æˆ·çš„ç™»å½•è´¦å·ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå­—æ®µdirectory_idçš„ï¼Œè¿™ä¸ªå­—æ®µæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ¬åœ°è´¦æˆ·çš„idæ˜¯1ï¼ŒldapåŒæ­¥è¿‡æ¥çš„è´¦æˆ·æ˜¯10001ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://img.xxlaila.cn/1566617986314.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ç»§ç»­çœ‹è¯¥è¡¨çš„credentialå­—æ®µï¼Œå¯†ç ä¹Ÿæœ‰åŒºåˆ«,æœ¬åœ°è´¦æˆ·æ˜¯æœ‰ä¸€ä¸²åŠ å¯†åçš„å­—ç¬¦ä¸²ï¼Œldapè®¤è¯çš„æ˜¯nopassï¼ŒåŒ…æ‹¬åé¢çš„external_id ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/1566618124910.jpg" alt="img"></p><h4 id="cwd-directoryè¡¨"><a href="#cwd-directoryè¡¨" class="headerlink" title="cwd_directoryè¡¨"></a>cwd_directoryè¡¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰“å¼€cwd_directoryè¡¨ï¼Œé‡Œé¢æœ‰ä¸¤æ¡æ•°æ®ï¼Œä¸€ä¸ªå¯¹åº”çš„æ˜¯ldapï¼Œä¸€ä¸ªå¯¹åº”çš„æœ¬åœ°ï¼Œå’Œcwd_useræ˜¯å¯¹åº”çš„ï¼Œå¦‚å›¾ï¼š<br><img src="https://img.xxlaila.cn/image2019-6-13_10-0-47.png" alt="img"></p><h4 id="ä¿®æ”¹æ•°æ®åº“"><a href="#ä¿®æ”¹æ•°æ®åº“" class="headerlink" title="ä¿®æ”¹æ•°æ®åº“"></a>ä¿®æ”¹æ•°æ®åº“</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;è®°ä½ldapç›®å½•çš„idï¼Œç„¶ååœ¨cwd_userè¡¨é‡Œé¢åˆ é™¤ldapçš„ç›¸åŒè´¦æˆ·çš„æ•´æ¡è®°å½•ï¼Œå› ä¸ºè¦ä¼ªè£…åŸæœ¬ç³»ç»Ÿè‡ªå¸¦çš„ç›®å½•æœåŠ¡å™¨ï¼ŒåŸæ¥ç¼–è¾‘çš„æ–‡ä»¶å’Œå†…å®¹ä¸ºåŸå…ˆè¿™ä¸ªç”¨æˆ·çš„idã€‚ä¿®æ”¹directory_id ä¸ºldapçš„idï¼Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦ä¿®æ”¹çš„åœ°æ–¹ä¸ºCREDENTIALçš„å­—æ®µï¼ŒæŠŠå®ƒä¿®æ”¹ä¸ºnopassã€‚ä¿®æ”¹å®Œæˆåéœ€è¦é‡å¯jiraï¼Œä¸é‡å¯ä¸ä¼šç”Ÿæ•ˆï¼Œè€Œä¸”ç™»å½•æœåŠ¡å™¨è¿˜ä¼šæŠ¥é”™ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œjiraå’Œconfluenceæ˜¯åšäº†å…³è”çš„ï¼Œjiraä¿®æ”¹ä»¥åï¼Œconfluenceä¹Ÿå¯ä»¥è¿›è¡Œç™»å½•ï¼Œæ— éœ€åœ¨confluenceåœ¨è®¾ç½®ä¸€æ¬¡ldap;ä¿®æ”¹å®Œæˆåï¼Œä»¥å‰ç”¨æˆ·çš„ç®¡ç†å‘˜æƒé™æœ‰é—®é¢˜ï¼Œé‡æ–°æ·»åŠ ä¸€æ¬¡å³å¯ã€‚ä¸ä¼šå½±å“å…¶ä»–çš„ã€‚è®¾ç½®æ–‡æ¡£ï¼Œldapæƒé™è¦é€‰æ‹©ä¸ºåªè¯»ï¼Œä¸”ä¸ºæœ¬åœ°ç»„ã€‚ç„¶åå§jiaå’Œconfluenceçš„æ™®é€šç»„æ·»åŠ è¿›å»ï¼Œå¦åˆ™ç”¨æˆ·è¿›æ¥æ²¡æœ‰æƒé™</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jira</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>confluenceä¸jiraè´¦æˆ·æ‰“é€š</title>
    <url>/2019/08/24/confluence%E4%B8%8Ejira%E8%B4%A6%E6%88%B7%E6%89%93%E9%80%9A/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p><a href="http://xxlaila.github.io/2019/08/24/confluence-install/" target="_blank" rel="noopener">confluence</a>å®‰è£…</p><h3 id="ç™»å½•confluence"><a href="#ç™»å½•confluence" class="headerlink" title="ç™»å½•confluence"></a>ç™»å½•confluence</h3><p>ç‚¹å‡»ç”¨æˆ·ç®¡ç†</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1566615435701.jpg" alt="img"></p><ul><li>ç‚¹å‡»ç”¨æˆ·ç›®å½•<br><img src="https://img.xxlaila.cn/1566615500778.jpg" alt="img"></li></ul><h3 id="å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥"><a href="#å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥" class="headerlink" title="å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥"></a>å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥</h3><ul><li>ç‚¹å‡»æ·»åŠ ç›®å½•</li></ul><p><img src="https://img.xxlaila.cn/1566615580951.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566616502650.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566616536151.jpg" alt="img"></p><p>ç‚¹å‡»æµ‹è¯•è¿æ¥ï¼Œè¿æ¥æˆåŠŸä»¥åï¼Œç‚¹å‡»æµ‹è¯•ä¿å­˜ã€‚å›åˆ°ç•Œé¢å¯ä»¥ç‚¹å‡»åŒæ­¥<br><img src="https://img.xxlaila.cn/1566616609967.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>confluence</category>
      </categories>
      <tags>
        <tag>confluence,jira</tag>
      </tags>
  </entry>
  <entry>
    <title>jiraå®‰è£…å’Œé…ç½®</title>
    <url>/2019/08/24/jira%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;JIRAæ˜¯Atlassianå…¬å¸å‡ºå“çš„é¡¹ç›®ä¸äº‹åŠ¡è·Ÿè¸ªå·¥å…·ï¼Œè¢«å¹¿æ³›åº”ç”¨äºç¼ºé™·è·Ÿè¸ªã€å®¢æˆ·æœåŠ¡ã€éœ€æ±‚æ”¶é›†ã€æµç¨‹å®¡æ‰¹ã€ä»»åŠ¡è·Ÿè¸ªã€é¡¹ç›®è·Ÿè¸ªå’Œæ•æ·ç®¡ç†ç­‰å·¥ä½œé¢†åŸŸã€‚</p><ul><li>ç¯å¢ƒå‡†å¤‡</li></ul><table><thead><tr><th>åº”ç”¨</th><th>æœåŠ¡å™¨é…ç½®</th><th>æ“ä½œç³»ç»Ÿ</th><th>æ’ä»¶</th></tr></thead><tbody><tr><td>mysql 5.6 +</td><td>2/4G/50G</td><td>centos 7.4</td><td></td></tr><tr><td>jira</td><td>4/8G/200G</td><td>centos 7.4</td><td>jdk1.8</td></tr></tbody></table><a id="more"></a><h3 id="å®‰è£…JIRA"><a href="#å®‰è£…JIRA" class="headerlink" title="å®‰è£…JIRA"></a>å®‰è£…JIRA</h3><ul><li>æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./atlassian-jira-software-7.2.2-x64.bin</span></span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1524710136913-900.png" alt="img"></p><ul><li><p>å®‰è£…å®Œæˆååœæ­¢JIRA</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒ/etc/init.d/jira stop</span><br></pre></td></tr></table></figure></li><li><p>å¤åˆ¶ç ´è§£åŒ…å’Œæ•°æ®åº“é©±åŠ¨è¿æ¥å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒcp mysql-connector-java-5.1.39-bin.jar atlassian-extras-3.1.2.jar /opt/atlassian/jira/atlassian-jira/WEB-INF/lib/</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨JIRA</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒ/etc/init.d/jira start</span><br></pre></td></tr></table></figure></li></ul><p>ç™»é™†ç½‘é¡µæ§åˆ¶å°è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œç•¥è¿‡ï¼Œè¿™é‡Œè¿™æ˜¯å®Œæˆï¼Œæ— æ³•æˆªå›¾(åæœŸæœ‰æœºä¼šå®‰è£…æˆªå›¾è¡¥ä¸Š)ï¼Œè®¾ç½®ä»¥åçš„æˆªå›¾<br><img src="https://img.xxlaila.cn/1524710090658-810.png" alt="img"></p><h3 id="é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨"><a href="#é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨" class="headerlink" title="é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨"></a>é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨</h3><p><img src="https://img.xxlaila.cn/1524710057086-739.png" alt="img"><br><img src="https://img.xxlaila.cn/1524710038583-516.png" alt="img"></p><p>é…ç½®å®Œæˆåç‚¹å‡»æœ€ä¸‹é¢çš„æµ‹è¯•è¿æ¥</p><p><img src="https://img.xxlaila.cn/1524710027432-202.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jira</category>
      </categories>
      <tags>
        <tag>jira</tag>
      </tags>
  </entry>
  <entry>
    <title>gitæ¸…ç©ºcommitè®°å½•æ–¹æ³•</title>
    <url>/2019/08/24/git%E6%B8%85%E7%A9%BAcommit%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><blockquote><p>è¯´æ˜:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¾‹å¦‚å°†ä»£ç æäº¤åˆ°gitä»“åº“ï¼Œå°†ä¸€äº›æ•æ„Ÿä¿¡æ¯æäº¤ï¼Œæ‰€ä»¥éœ€è¦åˆ é™¤æäº¤è®°å½•ä»¥å½»åº•æ¸…é™¤æäº¤ä¿¡æ¯ï¼Œä»¥å¾—åˆ°ä¸€ä¸ªå¹²å‡€çš„ä»“åº“ä¸”ä»£ç ä¸å˜</p></blockquote><h3 id="1-Checkout"><a href="#1-Checkout" class="headerlink" title="1.Checkout"></a>1.Checkout</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git checkout --orphan latest_branch</span><br></pre></td></tr></table></figure><h3 id="2-Add-all-the-files"><a href="#2-Add-all-the-files" class="headerlink" title="2. Add all the files"></a>2. Add all the files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add -A</span><br></pre></td></tr></table></figure><h3 id="3-Commit-the-changes"><a href="#3-Commit-the-changes" class="headerlink" title="3. Commit the changes"></a>3. Commit the changes</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git commit -am <span class="string">"commit message"</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="4-Delete-the-branch"><a href="#4-Delete-the-branch" class="headerlink" title="4. Delete the branch"></a>4. Delete the branch</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch -D master</span><br></pre></td></tr></table></figure><h3 id="5-Rename-the-current-branch-to-master"><a href="#5-Rename-the-current-branch-to-master" class="headerlink" title="5.Rename the current branch to master"></a>5.Rename the current branch to master</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch -m master</span><br></pre></td></tr></table></figure><h3 id="6-Finally-force-update-your-repository"><a href="#6-Finally-force-update-your-repository" class="headerlink" title="6.Finally, force update your repository"></a>6.Finally, force update your repository</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git push -f origin master</span><br></pre></td></tr></table></figure><h2 id="git-ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥"><a href="#git-ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥" class="headerlink" title="git ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥"></a>git ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥</h2><h3 id="1ã€è¿œç¨‹åˆ†æ”¯"><a href="#1ã€è¿œç¨‹åˆ†æ”¯" class="headerlink" title="1ã€è¿œç¨‹åˆ†æ”¯"></a>1ã€è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹å½“å‰çš„è¿œç¨‹åˆ†æ”¯</span><br><span class="line">$ git remote -v</span><br></pre></td></tr></table></figure><h3 id="2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯"><a href="#2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯" class="headerlink" title="2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯"></a>2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git remote add latest https://github.com/xxlaila/work.git</span><br></pre></td></tr></table></figure><h3 id="3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯"><a href="#3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯" class="headerlink" title="3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯"></a>3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ›´æ–°è¿œç¨‹åˆ†æ”¯</span><br><span class="line">$ git fetch latest</span><br></pre></td></tr></table></figure><h3 id="4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç "><a href="#4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç " class="headerlink" title="4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç "></a>4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç </h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç </span><br><span class="line">$ git rebase latest/dev</span><br></pre></td></tr></table></figure><h3 id="5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“"><a href="#5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“" class="headerlink" title="5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“"></a>5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ¨é€è¿œç¨‹ä»“åº“</span><br><span class="line">$ git push</span><br></pre></td></tr></table></figure><h2 id="git-ä»£ç ä¿¡æ¯ç»Ÿè®¡"><a href="#git-ä»£ç ä¿¡æ¯ç»Ÿè®¡" class="headerlink" title="git ä»£ç ä¿¡æ¯ç»Ÿè®¡"></a>git ä»£ç ä¿¡æ¯ç»Ÿè®¡</h2><blockquote><p>è¯´æ˜: å…¬å¸æ¯ä¸ªå­£åº¦éƒ½è¦å¯¹å…¬å¸å¼€å‘äººå‘˜çš„å·¥ä½œé‡è¿›è¡Œæ•´ä½“è¯„ä¼°ï¼Œè¯„ä¼°gitä¸Šæ‰€æœ‰ä»£ç åº“çš„commitæ•°é‡å’Œä¿®æ”¹æ–‡ä»¶çš„æ€»è¡Œæ•°</p></blockquote><h3 id="ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡"><a href="#ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡" class="headerlink" title="ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡"></a>ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline --since==2019-04-1 --until=2019-06-30 | wc -l</span><br></pre></td></tr></table></figure><h3 id="ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°"><a href="#ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°" class="headerlink" title="ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°"></a>ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span> --<span class="built_in">stat</span> --since=<span class="string">"2019-4-01"</span> --before=<span class="string">"2019-06-30"</span> |perl -ne <span class="string">'END &#123; print $c &#125; $c += $1 if /(\d+) insertions/'</span></span><br></pre></td></tr></table></figure><h2 id="git-stashä½¿ç”¨"><a href="#git-stashä½¿ç”¨" class="headerlink" title="git stashä½¿ç”¨"></a>git stashä½¿ç”¨</h2><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»Šå¤©é‡åˆ°ä¸€ä¸ªç‰¹æ®Šçš„åœºæ™¯ï¼Œå†™çš„ä¸€ä¸ªpythonç¨‹åºåˆ°æœåŠ¡å™¨ä¸Šæœ‰ä¸€ä¸ªå°bugè¿è¡ŒæŠ¥é”™ï¼Œç„¶åå°±ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šè°ƒè¯•ï¼Œä¿®æ”¹äº†ç¨‹åºï¼Œç¨‹åºæ­£å¸¸è·‘èµ·ï¼Œç„¶è€Œæœ¬åœ°ä¹Ÿè¦ä¿®æ”¹ï¼Œä¿®æ”¹çš„æ—¶å€™åŒæ—¶ä¿®æ”¹äº†å…¶ä»–çš„åœ°æ–¹ï¼Œç„¶åæäº¤äº†gitä¸Šï¼Œè¿™æ—¶ï¼Œéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šæ›´æ–°æœ€æ–°çš„ä»£ç ï¼Œä½†æ˜¯æœåŠ¡å™¨ä¸Šçš„ä»£ç å’Œgitä¸Šçš„ä¸ä¸€è‡´ï¼Œè¿™å°±ä¼šå¯¼è‡´é”™è¯¯ï¼Œè¿™æ—¶gitçš„å¼ºå¤§ä¹‹å¤„å°±ä½“ç°å‡ºæ¥äº†ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git status</span><br><span class="line">èƒ½å¤Ÿå°†æ‰€æœ‰æœªæäº¤çš„ä¿®æ”¹ï¼ˆå·¥ä½œåŒºå’Œæš‚å­˜åŒºï¼‰ä¿å­˜è‡³å †æ ˆä¸­ï¼Œç”¨äºåç»­æ¢å¤å½“å‰å·¥ä½œç›®å½•ã€‚</span><br></pre></td></tr></table></figure><ul><li>æ›´æ–°ä»£ç <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git pull</span><br></pre></td></tr></table></figure></li></ul><p>å°†å½“å‰stashä¸­çš„å†…å®¹å¼¹å‡ºï¼Œå¹¶åº”ç”¨åˆ°å½“å‰åˆ†æ”¯å¯¹åº”çš„å·¥ä½œç›®å½•ä¸Šã€‚</p><blockquote><p>æ³¨:<br>&nbsp;&nbsp;&nbsp;&nbsp;è¯¥å‘½ä»¤å°†å †æ ˆä¸­æœ€è¿‘ä¿å­˜çš„å†…å®¹åˆ é™¤ï¼ˆæ ˆæ˜¯å…ˆè¿›åå‡ºï¼‰</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git stash pop</span><br></pre></td></tr></table></figure><p>æ›´å¤šçš„git stash å‘½ä»¤è¯¦è§£è¯·<a href="https://git-scm.com/book/zh/v1/Git-%E5%B7%A5%E5%85%B7-%E5%82%A8%E8%97%8F%EF%BC%88Stashing%EF%BC%89" target="_blank" rel="noopener">ç‚¹å‡»</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>confluence_install</title>
    <url>/2019/08/24/confluence-install/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Confluenceæ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼ä¸šçŸ¥è¯†ç®¡ç†ä¸ååŒè½¯ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨äºæ„å»ºä¼ä¸šwikiã€‚ä½¿ç”¨ç®€å•ï¼Œä½†å®ƒå¼ºå¤§çš„ç¼–è¾‘å’Œç«™ç‚¹ç®¡ç†ç‰¹å¾èƒ½å¤Ÿå¸®åŠ©å›¢é˜Ÿæˆå‘˜ä¹‹é—´å…±äº«ä¿¡æ¯ã€æ–‡æ¡£åä½œã€é›†ä½“è®¨è®ºï¼Œä¿¡æ¯æ¨é€ã€‚ä¸ºå›¢é˜Ÿæä¾›ä¸€ä¸ªåä½œç¯å¢ƒã€‚åœ¨è¿™é‡Œï¼Œå›¢é˜Ÿæˆå‘˜é½å¿ƒååŠ›ï¼Œå„æ“…å…¶èƒ½ï¼ŒååŒåœ°ç¼–å†™æ–‡æ¡£å’Œç®¡ç†é¡¹ç›®ã€‚ä»æ­¤æ‰“ç ´ä¸åŒå›¢é˜Ÿã€ä¸åŒéƒ¨é—¨ä»¥åŠä¸ªäººä¹‹é—´ä¿¡æ¯å­¤å²›çš„åƒµå±€ï¼ŒConfluenceçœŸæ­£å®ç°äº†ç»„ç»‡èµ„æºå…±äº«ã€‚</p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ç³»ç»Ÿç‰ˆæœ¬</th><th>æ’ä»¶</th><th>è½¯ä»¶</th><th>ç‰ˆæœ¬</th><th>æœåŠ¡é…ç½®</th></tr></thead><tbody><tr><td>centos 7.4</td><td></td><td>mysql</td><td>5.6+</td><td>2/4G/50G</td></tr><tr><td>centos 7.4</td><td>jdk 1.8</td><td>confluence</td><td>6.12.2</td><td>4/8G/200G</td></tr></tbody></table><p>confluence 6.12.2å®‰è£…å¹¶ç ´è§£ï¼Œmysql ç‰ˆæœ¬è¿™é‡Œä½¿ç”¨çš„æ˜¯5.7.24</p><a id="more"></a><h2 id="å®‰è£…mysql-5-7-24-ç‰ˆæœ¬"><a href="#å®‰è£…mysql-5-7-24-ç‰ˆæœ¬" class="headerlink" title="å®‰è£…mysql 5.7.24 ç‰ˆæœ¬"></a>å®‰è£…mysql 5.7.24 ç‰ˆæœ¬</h2><h3 id="å®‰è£…mysql"><a href="#å®‰è£…mysql" class="headerlink" title="å®‰è£…mysql"></a>å®‰è£…mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -ivh http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum list |grep "mysql"</span></span><br><span class="line"><span class="comment"># yum install -y mysql-community-server</span></span><br></pre></td></tr></table></figure><ul><li><p>åŠ¨mysql</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysqld.service</span></span><br><span class="line"><span class="comment"># systemctl enable mysqld.service</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹myslqå¯†ç </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grep 'temporary password' /var/log/mysqld.log</span></span><br><span class="line">mysql&gt; SET PASSWORD = PASSWORD(<span class="string">'news password'</span>);</span><br><span class="line">mysql&gt; ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> PASSWORD EXPIRE NEVER;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚"><a href="#ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚" class="headerlink" title="ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚"></a>ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚</h3><blockquote><p>åœ¨my.cnfé…ç½®æ–‡ä»¶[mysqld]é‡Œé¢æ·»åŠ ä¸‹é¢é…ç½®å‚æ•°</p></blockquote><ul><li><p>å°†é»˜è®¤å­—ç¬¦é›†æŒ‡å®šä¸ºUTF-8</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_bin</span><br></pre></td></tr></table></figure></li><li><p>å°†é»˜è®¤å­˜å‚¨å¼•æ“è®¾ç½®ä¸ºInnoDB</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">default-storage-engine=INNODB</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šå€¼max_allowed_packetè‡³å°‘ä¸º256M</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">max_allowed_packet=512M</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šå€¼ innodb_log_file_size è‡³å°‘ä¸º2GB</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">innodb_log_file_size=2GB</span><br></pre></td></tr></table></figure></li><li><p>ç¡®ä¿æ•°æ®åº“çš„å…¨å±€äº‹åŠ¡éš”ç¦»çº§åˆ«å·²è®¾ç½®ä¸ºREAD-COMMITTED</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">transaction-isolation=READ-COMMITTED</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥äºŒè¿›åˆ¶æ—¥å¿—è®°å½•æ ¼å¼æ˜¯å¦é…ç½®ä¸ºä½¿ç”¨â€œåŸºäºè¡Œâ€çš„äºŒè¿›åˆ¶æ—¥å¿—è®°å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">binlog_format=row</span><br></pre></td></tr></table></figure></li><li><p>ç¡®ä¿sql_modeå‚æ•°æœªæŒ‡å®šNO_AUTO_VALUE_ON_ZERO</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sql_mode = <span class="string">"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯mysqlæ•°æ®åº“</p></li></ul><h3 id="ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“"><a href="#ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“" class="headerlink" title="ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“"></a>ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE confluence CHARACTER SET utf8 COLLATE utf8_bin;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON confluence.* TO confluence@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'password'</span></span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…Confluence"><a href="#å®‰è£…Confluence" class="headerlink" title="å®‰è£…Confluence"></a>å®‰è£…Confluence</h2><p>ä¸‹è½½Confluenceï¼Œè¿™é‡Œä¸‹è½½binæ–‡ä»¶è¿›è¡Œå®‰è£…ï¼Œ<a href="https://www.atlassian.com/software/confluence/download-archives" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a>,ä¸‹è½½çš„ç‰ˆæœ¬ä¸ºatlassian-confluence-6.12.2-x64.bin,åŒ…æœ‰ç‚¹å¤§ï¼Œéœ€è¦ç­‰å¾…â€¦â€¦</p><ul><li><p>èµ‹äºˆæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chmod a+x atlassian-confluence-6.12.2-x64.bin</span></span><br></pre></td></tr></table></figure></li><li><p>å¼€å§‹å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./atlassian-confluence-6.12.2-x64.bin</span></span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…è¿‡ç¨‹ä¸­éœ€è¦åšä¸€äº›åŸºæœ¬çš„é…ç½®ï¼Œè¯¦æƒ…æŸ¥çœ‹æˆ‘çš„é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Unpacking JRE ...</span><br><span class="line">Starting Installer ...</span><br><span class="line"></span><br><span class="line">This will install Confluence 6.12.2 on your computer.</span><br><span class="line">OK [o, Enter], Cancel [c]</span><br><span class="line">o ï¼ˆè¾“å…¥oåŒæ„ï¼‰</span><br><span class="line">Click Next to <span class="built_in">continue</span>, or Cancel to <span class="built_in">exit</span> Setup.</span><br><span class="line"></span><br><span class="line">Choose the appropriate installation or upgrade option.</span><br><span class="line">Please choose one of the following:</span><br><span class="line">Express Install (uses default settings) [1], </span><br><span class="line">Custom Install (recommended <span class="keyword">for</span> advanced users) [2, Enter], </span><br><span class="line">Upgrade an existing Confluence installation [3]</span><br><span class="line">2   (é€‰æ‹©2è‡ªå®šä¹‰å®‰è£…ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€äº›å®šåˆ¶çš„é…ç½®)</span><br></pre></td></tr></table></figure></li><li><p>å¼€å§‹è¿›è¡Œå®‰è£…å‚æ•°çš„é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Select the folder <span class="built_in">where</span> you would like Confluence 6.12.2 to be installed,</span><br><span class="line"><span class="keyword">then</span> click Next.</span><br><span class="line">Where should Confluence 6.12.2 be installed?</span><br><span class="line">[/opt/atlassian/confluence](å®‰è£…ç›®å½•,ç›®å½•å˜åŒ–å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥ï¼Œè¿™é‡Œç›´æ¥å›è½¦)</span><br><span class="line"></span><br><span class="line">Default location <span class="keyword">for</span> Confluence data</span><br><span class="line">[/var/atlassian/application-data/confluence]ï¼ˆæ•°æ®çš„å­˜æ”¾ç›®å½•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¿®æ”¹åˆ°æˆ‘ä»¬çš„æ•°æ®ç›˜ï¼‰</span><br><span class="line">/opt/atlassian/confluence-data/</span><br><span class="line"></span><br><span class="line">Configure <span class="built_in">which</span> ports Confluence will use.</span><br><span class="line">Confluence requires two TCP ports that are not being used by any other</span><br><span class="line">applications on this machine. The HTTP port is <span class="built_in">where</span> you will access</span><br><span class="line">Confluence through your browser. The Control port is used to Startup and</span><br><span class="line">Shutdown Confluence.</span><br><span class="line">Use default ports (HTTP: 8090, Control: 8000) - Recommended [1, Enter], Set custom value <span class="keyword">for</span> HTTP and Control ports [2]</span><br><span class="line">ï¼ˆè¿™é‡Œæ˜¯è®¾ç½®ä½¿ç”¨çš„ç«¯å£ï¼Œé»˜è®¤å³å¯ï¼‰</span><br><span class="line"></span><br><span class="line">Confluence can be run <span class="keyword">in</span> the background.</span><br><span class="line">You may choose to run Confluence as a service, <span class="built_in">which</span> means it will start</span><br><span class="line">automatically whenever the computer restarts.</span><br><span class="line">Install Confluence as Service?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y</span><br><span class="line"></span><br><span class="line">Extracting files ...</span><br><span class="line">                                                                           </span><br><span class="line"></span><br><span class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> we configure Confluence.</span><br><span class="line"></span><br><span class="line">Installation of Confluence 6.12.2 is complete</span><br><span class="line">Start Confluence now?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y</span><br><span class="line"></span><br><span class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> Confluence starts up.</span><br><span class="line">Launching Confluence ...</span><br><span class="line">è¾“å…¥yå›è½¦åConfluenceä¼šè¿›è¡Œåå°å®‰è£…ï¼Œè¿™é‡Œç­‰å¾…å®‰è£…å®Œæˆå³å¯</span><br><span class="line"></span><br><span class="line">Installation of Confluence 6.12.2 is complete</span><br><span class="line">Your installation of Confluence 6.12.2 is now ready and can be accessed via</span><br><span class="line">your browser.</span><br><span class="line">Confluence 6.12.2 can be accessed at http://localhost:8090</span><br><span class="line">å®‰è£…å®Œæˆ</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>é€šè¿‡æµè§ˆå™¨è®¿é—®è¯•ä¸€ä¸‹: <a href="http://ip:8090" target="_blank" rel="noopener">http://ip:8090</a></p></blockquote><h2 id="è¿›è¡Œè®¿é—®é…ç½®"><a href="#è¿›è¡Œè®¿é—®é…ç½®" class="headerlink" title="è¿›è¡Œè®¿é—®é…ç½®"></a>è¿›è¡Œè®¿é—®é…ç½®</h2><h3 id="å®‰è£…nginx-è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®"><a href="#å®‰è£…nginx-è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®" class="headerlink" title="å®‰è£…nginx è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®"></a>å®‰è£…nginx è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum install nginx -y</span></span><br><span class="line"><span class="comment"># systemctl start nginx.service</span></span><br><span class="line"><span class="comment"># systemctl enable nginx.service</span></span><br><span class="line">é…ç½®nginxçš„upstreamè¿™é‡Œå°†ä¸å†é˜è¿°</span><br></pre></td></tr></table></figure><h3 id="æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®"><a href="#æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®" class="headerlink" title="æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®"></a>æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®</h3><ul><li>æ‰“å¼€é¡µé¢</li></ul><p><img src="https://img.xxlaila.cn/1566609337530.jpg" alt="img"></p><ul><li>è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡å’Œäº§å“å®‰è£…</li></ul><p><img src="https://img.xxlaila.cn/1566609486131.jpg" alt="img"></p><p>åœ¨ä¸‹é¢çš„ä¸€ä¸ªç•Œé¢éœ€è¦è®°ä½æœåŠ¡å™¨çš„IDï¼Œè¿™ä¸ªipåœ¨åé¢ç ´è§£çš„æ—¶å€™éœ€è¦çš„</p><ul><li>åœæ­¢confluence<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/init.d/confluence stop</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ç ´è§£Confluence"><a href="#ç ´è§£Confluence" class="headerlink" title="ç ´è§£Confluence"></a>ç ´è§£Confluence</h3><ul><li>åœ¨æœ¬åœ°ä¸‹è½½ç ´è§£å™¨</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/xxlaila/work/blob/master/zip/confluence.zip</span></span><br><span class="line"><span class="comment"># unzip confluence.zip</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨æœåŠ¡å™¨ä¸ŠæŠŠatlassian-extras-decoder-v2-3.4.1.jarè¿›è¡Œå¦‚ä¸‹æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /opt/atlassian/confluence/confluence/WEB-INF/lib</span></span><br><span class="line"><span class="comment"># cp atlassian-extras-decoder-v2-3.4.1.jar /opt/atlassian-extras-2.4.jar</span></span><br><span class="line"><span class="comment"># mv atlassian-extras-decoder-v2-3.4.1.jar atlassian-extras-decoder-v2-3.4.1.jar.bak</span></span><br></pre></td></tr></table></figure></li><li><p>æŠŠ/opt/atlassian-extras-2.4.jarä¸‹è½½åˆ°æœ¬åœ°,åœ¨æœ¬åœ°å¯åŠ¨Confluenceç ´è§£å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ java -jar confluence_keygen.jar</span><br></pre></td></tr></table></figure><ul><li>ç‚¹å‡».patch! é€‰æ‹©ä¸‹è½½åˆ°æœ¬åœ°çš„atlassian-extras-2.4.jaråŒ…ï¼Œæ–‡ä»¶ç±»å‹ä¸å˜ï¼Œç‚¹å‡»æ‰“å¼€ï¼Œè‡ªåŠ¨ç”Ÿäº§ä¸€ä¸ªæ–°çš„atlassian-extras-2.4.jaråŒ…</li></ul><p><img src="https://img.xxlaila.cn/FA8682F205BB1655E20AAD392DF13417.jpg" alt="img"></p><ul><li>æŠŠæœåŠ¡å™¨idè¾“å…¥åˆ°server idï¼Œnameé¡¹éšä¾¿è¾“å…¥ï¼Œåç§°ä¸è¦è¿‡çŸ­ï¼Œåº—å®¶.gen!ç”Ÿæˆæˆæƒå—ï¼Œç„¶åæŠŠæˆæƒå¤åˆ¶åˆ°confluenceæ¡†é‡Œé¢</li></ul><p><img src="https://img.xxlaila.cn/CB99372F30342EBABC1125510FBC50B9.jpg" alt="img"></p><ul><li>æŠŠæ–°ç”Ÿæˆçš„åŒ…ä¸Šä¼ åˆ°/opt/atlassian/confluence/confluence/WEB-INF/lib/ç›®å½•ä¸‹é¢</li></ul><h3 id="ä¸‹è½½mysqlé©±åŠ¨"><a href="#ä¸‹è½½mysqlé©±åŠ¨" class="headerlink" title="ä¸‹è½½mysqlé©±åŠ¨"></a>ä¸‹è½½mysqlé©±åŠ¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.47.zip</span></span><br></pre></td></tr></table></figure><ul><li><p>å®Œæˆåè¿›è¡Œè§£å‹ï¼Œå¹¶æŠŠmysql-connector-java-5.1.47-bin.jar å¤åˆ¶åˆ°libç›®å½•ä¸‹é¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp mysql-connector-java-5.1.47-bin.jar /opt/atlassian/confluence/confluence/WEB-INF/lib</span></span><br><span class="line"><span class="comment"># /etc/init.d/confluence start</span></span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®æ•°æ®åº“</p></li></ul><p><img src="https://img.xxlaila.cn/EFF70DEA9DFBCA88E24BE83BEE9DFFC8.jpg" alt="img"><br><img src="https://img.xxlaila.cn/BF70624FCFA9E5ECFD4E121E02D08FD3.jpg" alt="img"></p><blockquote><p>è¿™æ˜¯å®Œæˆä»¥åè¿›è¡Œæµ‹è¯•ï¼Œæ˜¯å¦è”é€šï¼Œåœ¨ä¸‹ä¸€æ­¥ï¼ˆéœ€è¦è¿›è¡Œç­‰å¾…ï¼Œåå°åœ¨ç”Ÿæˆæ•°æ®åº“ï¼‰,ç”Ÿæˆå®Œæˆåï¼Œç³»ç»Ÿä¼šè·³è½¬åˆ°å¦å¤–ä¸€ä¸ªé¡µé¢ï¼Œè¿™é‡Œå¿˜è®°æˆªå›¾,æ˜¯è¿›è¡Œæ•°æ®å¯¼å…¥ã€ç«™ç‚¹æ¢å¤ç­‰</p></blockquote><ul><li><p>é‡æ–°æ‰“å¼€ç½‘å€è¿æ¥<br><img src="https://img.xxlaila.cn/BEE317A48B4CEE0407638F47CDBDF31F.jpg" alt="img"></p></li><li><p>ç”±äºè¿™é‡Œæ²¡æœ‰ladpå’Œjira,æ‰€ä»¥é€‰æ‹©åœ¨confluenceä¸­ç®¡ç†ç”¨æˆ·å’Œç»„</p></li><li><p>è®¾ç½®ç³»ç»Ÿç®¡ç†è´¦æˆ·</p></li></ul><p><img src="https://img.xxlaila.cn/93FDD95874C661340531C27CC77298FD.jpg" alt="img"><br><img src="https://img.xxlaila.cn/6B1F3A2EBF1B3DAF1A962317AA59DC15.jpg" alt="img"></p><blockquote><p>è¿™é‡Œè·³è¿‡ä¸ªäººå¤´åƒè®¾å®š,å¤´åƒè®¾å®šå®Œæˆåä¼šæç¤ºä½ æ–°å»ºä¸€ä¸ªç©ºé—´</p></blockquote><p><img src="https://img.xxlaila.cn/FCE130BD8B121A290010FEA2C2342898.jpg" alt="img"></p><ul><li>æŸ¥çœ‹æˆæƒæœŸé™</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è®¾ç½®â€”â€”&gt;ä¸€èˆ¬è®¾ç½®â€”â€”&gt;ç®¡ç†â€”â€”&gt;æˆæƒç»†èŠ‚</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/EEB25C9704F4C76C30E1DF32A2E1EDE0.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>confluence</category>
      </categories>
      <tags>
        <tag>confluence</tag>
      </tags>
  </entry>
  <entry>
    <title>nexus3æ­å»ºnpmç§æœ</title>
    <url>/2019/08/23/nexus3%E6%90%AD%E5%BB%BAnpm%E7%A7%81%E6%9C%8D/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸å‰ç«¯å…¨æ˜¯nodejsçš„ï¼Œnodejsåœ¨installçš„æ—¶å€™å¾€å¾€æ˜¯è¿æ¥å¤–ç½‘ï¼Œæˆ–è€…æ˜¯è®¾ç½®taobaoæºï¼Œå³ä½¿æ˜¯è®¾ç½®äº†taobaoæºï¼Œä½†æ˜¯è¿˜æ˜¯è§£å†³ä¸äº†æ…¢çš„é—®é¢˜ï¼Œä¸ºæ­¤æ­å»ºäº†ä¸€ä¸ªå†…éƒ¨çš„npmç§æœï¼Œè¿™é‡Œç”¨googleä¸€ä¸‹æœ‰å¾ˆå¤šéƒ½å¯ä»¥æ¥è¿›è¡Œæ­å»ºnpmç§æœï¼Œç„¶åä¹Ÿçœ‹åˆ°äº†nexusä¹Ÿå¯ä»¥æ¥åšï¼Œæ­£å¥½mavenç§æœä¹Ÿæ˜¯ç”¨çš„è¿™ä¸ªï¼Œéƒ½æ˜¯3ç‰ˆæœ¬ï¼Œä¸ºæ­¤é€‰æ‹©äº†nexusæ¥åšnpmçš„ç§æœï¼Œå’Œmavenä¸€å¥—ä¾¿äºç»´æŠ¤ã€‚</p><h3 id="nexuså®‰è£…"><a href="#nexuså®‰è£…" class="headerlink" title="nexuså®‰è£…"></a>nexuså®‰è£…</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸ä»‹ç»ï¼Œå®‰è£…å®Œæˆnexusåï¼Œåœ¨æµè§ˆå™¨æ‰“å¼€å¹¶è¿›è¡Œç™»å½•ï¼Œç¬¬ä¸€æ¬¡å®‰è£…ç™»å½•nexusçš„é»˜è®¤ç”¨æˆ·<code>admin</code>,é»˜è®¤å¯†ç æ˜¯<code>admin123</code></p><a id="more"></a><h3 id="1ã€åˆ›å»ºrepository"><a href="#1ã€åˆ›å»ºrepository" class="headerlink" title="1ã€åˆ›å»ºrepository"></a>1ã€åˆ›å»ºrepository</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Nexus Repository Manager 3 å¯ä»¥ç”¨äºå¤šç§ç±»å‹çš„åŒ…ç®¡ç†ã€‚æ­¤å¤„æˆ‘ä»¬è¦æ­å»ºçš„æ˜¯npmåŒ…ç®¡ç†ç§æœã€‚ç™»å½•åœ¨ç•Œé¢ç‚¹å‡»ä¸‹å›¾æ‰€ç¤ºæŒ‰é’®ã€‚<br><img src="https://img.xxlaila.cn/1566524933898.jpg" alt="img"></p><ul><li>è¿›å…¥è®¾ç½®ç•Œé¢<br><img src="https://img.xxlaila.cn/1566525058628.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šå›¾ä¸­å·¦é¢èœå•æœ‰å¾ˆå¤šåŠŸèƒ½ã€‚å¯ä»¥åœ¨ Security ä¸‹çš„ Users å¯ä»¥åˆ›å»ºç”¨æˆ·å¹¶è®¾ç½®ç”¨æˆ·æƒé™ï¼Œä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ã€‚Logging ä¸‹çš„ Log Viewer å¯ä»¥æŸ¥çœ‹è¿è¡Œæ—¥å¿—ã€‚è€Œæœ¬æ¬¡é…ç½®ä¸»è¦ç”¨åˆ°äº† Repository -&gt; Repositories å’Œ Security -&gt; Realms ä¸¤é¡¹</p><ul><li>é¦–å…ˆåœ¨ Repositories åˆ›å»ºä»“åº“</li></ul><p><img src="https://img.xxlaila.cn/1566526054409.jpg" alt="img"></p><ul><li><p>æ¥ä¸‹æ¥ä¼šè¿›å…¥åˆ° Repositorty çš„é€‰æ‹©ï¼šï¼ˆnpm æœ‰ä¸‰ç§ï¼‰<br><img src="https://img.xxlaila.cn/1566526144738.jpg" alt="img"></p></li><li><p>ç¬¬ä¸€ç§ï¼šä»£ç† npm ä»“åº“</p></li></ul><p><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Proxying npm Registries</a>å¯äº§çœ‹å®˜æ–¹æ–‡æ¡£</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å°†å…¬å…± npm æœåŠ¡å™¨çš„èµ„æºä»£ç†ç¼“å­˜ï¼Œå‡å°‘é‡å¤ä¸‹è½½ï¼ŒåŠ å¿«å¼€å‘äººå‘˜å’ŒCIæœåŠ¡å™¨çš„ä¸‹è½½é€Ÿåº¦ã€‚åˆ›å»ºæ—¶é€‰æ‹© npm(proxy) ï¼Œåªéœ€å¡«å†™ Name å’Œ Remote storage ï¼ˆå…¬æœ‰åº“åŸŸåï¼‰å³å¯ã€‚<br><img src="https://img.xxlaila.cn/1566526375641.jpg" alt="img"></p><ul><li>ç¬¬äºŒç§ï¼šç§æœ‰ npm ä»“åº“<br><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Private npm Registries</a>å®˜æ–¹æ–‡æ¡£</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äº ä¸Šä¼ è‡ªå·±çš„npmåŒ… ä»¥åŠç¬¬ä¸‰æ–¹npmåŒ…ã€‚åŒæ ·çš„åˆ›å»ºæ­¥éª¤ï¼Œåªä¸è¿‡é€‰æ‹©çš„ ä»“åº“ç±»å‹ä¸º npm(hosted)ã€‚ åªå¡«å†™ Name å³å¯</p><p><img src="https://img.xxlaila.cn/1566526835511.jpg" alt="img"></p><ul><li>ç¬¬ä¸‰ç§ï¼šnpm ä»“åº“ç»„<br><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Grouping npm Registries</a>å®˜æ–¹æ–‡æ¡£</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºå°†å¤šä¸ªå†…éƒ¨æˆ–å¤–éƒ¨ npm ä»“åº“ç»Ÿä¸€ä¸ºä¸€ä¸ª npmä»“åº“ã€‚è¢«æ·»åŠ åˆ° npmä»“åº“ç»„ ä¸­çš„ å…¶ä»–ä»“åº“å†…çš„åŒ…éƒ½èƒ½å¤Ÿé€šè¿‡è¯¥ npmä»“åº“ç»„ è®¿é—®åˆ°ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¾‹å¦‚ï¼šå¯ä»¥æ–°å»ºä¸€ä¸ªnpmä»“åº“ç»„å°† ä¸Šé¢ä¸¤ä¸ªåˆšåˆšåˆ›å»ºçš„ npm ä»“åº“éƒ½æ·»åŠ è¿›å»ã€‚è¿™æ ·å¯ä»¥é€šè¿‡è¿™ä¸ª npmä»“åº“ç»„ï¼Œæ—¢å¯ä»¥è®¿é—® å…¬æœ‰npmä»“åº“ åˆå¯ä»¥è®¿é—®è‡ªå·±çš„ ç§æœ‰npmä»“åº“ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»“åº“ç±»å‹ä¸º npm(group)ï¼Œèµ·ä¸€ä¸ªåå­— Nameï¼Œç„¶åé€‰æ‹©éœ€è¦æ·»åŠ åˆ°ç»„é‡Œçš„ å…¶ä»– npm ä»“åº“ã€‚æ­¤å¤„æˆ‘é€‰æ‹©çš„æ˜¯ npm-kxl-external å’Œ npm-kxl-internal</p><p><img src="https://img.xxlaila.cn/1566527053731.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»“åº“éƒ½åˆ›å»ºå®Œæ¯•äº†ã€‚æ¥ä¸‹æ¥éœ€è¦éªŒè¯ä¸€ä¸‹æ˜¯å¦å¯ç”¨,åœ¨ Repositories ä¸­ç‚¹å‡»åˆ›å»ºçš„ ä»“åº“ã€‚å¯ä»¥æŸ¥çœ‹è¯¥ä»“åº“çš„ URLã€‚<br>åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º .npmrc æ–‡ä»¶ã€‚æ–‡ä»¶å†…å®¹ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">registry=http://172.21.16.90:8081/repository/npm-kxl-all/</span><br></pre></td></tr></table></figure><p>ç„¶åéšä¾¿å®‰è£…ä¸€ä¸ª åŒ… è¯•è¯•ï¼ˆæ—¥å¿—çº§åˆ«è®¾ç½®ä¸º infoï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm --loglevel info install react</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1566528241640.jpg" alt="img"></p><p>å¦‚å›¾ã€‚ç¡®å®æ˜¯ä»è®¾ç½®çš„ npm ç§æœä¸‹è½½çš„reactã€‚æˆåŠŸ</p><h3 id="å‘å¸ƒåˆ°-npm-ç§æœ"><a href="#å‘å¸ƒåˆ°-npm-ç§æœ" class="headerlink" title="å‘å¸ƒåˆ° npm ç§æœ"></a>å‘å¸ƒåˆ° npm ç§æœ</h3><p>é™¤äº†ä» npm ä»“åº“å®‰è£…ä¾èµ–ã€‚æˆ‘ä»¬è¿˜éœ€è¦å°†å…¬å¸å†…éƒ¨çš„ ä»£ç æ‰“åŒ… å‘å¸ƒåˆ° npm çš„ç§æœã€‚è¿™é‡Œæ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå°±æ˜¯éœ€è¦è®¾ç½®ä¸€ä¸‹ Nexus Repository Manager çš„æƒé™ã€‚è¿™æ ·æ‰èƒ½ä½¿ç”¨ npm login è®¤è¯ç™»å½•åˆ°æˆ‘ä»¬çš„ç§æœã€‚</p><p><img src="https://img.xxlaila.cn/1566528346695.jpg" alt="img"></p><p>æ­¤å¤„åœ¨ Realms ä¸‹ã€‚å°† npm Bearer Token Realm æ·»åŠ åˆ° Active åˆ—è¡¨å†…ä¿å­˜å³å¯ã€‚<br>ç„¶åå¯ä»¥æ‰§è¡Œï¼ˆç™»å½• ç§æœ‰npmä»“åº“ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm login --registry=http://172.21.16.90:8081/repository/npm-kxl-internal/</span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Email: (this IS public) 1@qq.com</span><br><span class="line">Logged <span class="keyword">in</span> as admin on http://172.21.16.90:8081/repository/npm-kxl-internal/.</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤ï¼Œæç¤ºå¡«å†™è´¦å·å¯†ç å’Œé‚®ç®±ï¼ŒéªŒè¯é€šè¿‡åå°†ä¼šåœ¨ ç”¨æˆ·ä¸»ç›®å½•ä¸‹çš„ .npmrc æ–‡ä»¶ä¸­æ’å…¥ä¸€æ¡ æ­¤ä»“åº“ url å’Œå¯¹åº”çš„ tokenã€‚</p><p><img src="https://img.xxlaila.cn/1566528452423.jpg" alt="img"></p><p>åœ¨ç¡®ä¿é¡¹ç›®æœ‰ package.json å‰æä¸‹ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm publish --registry=http://172.21.16.90:8081/repository/npm-kxl-internal/</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œä½¿ç”¨ Nexus Repository Manager 3 æ­å»º npm ç§æœç»“æŸã€‚æ•´ä½“æµç¨‹å¹¶ä¸å¤æ‚ï¼Œæ–‡æ¡£å¾ˆè¯¦å°½,ç›´æ¥è¯»æ–‡æ¡£å¯èƒ½ä¼šé—æ¼ä¸€äº›ä¸œè¥¿ã€‚å¯ä»¥å‚è€ƒ<a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://xxlaila.github.io/2019/10/15/nexusé…ç½®ldap/" target="_blank" rel="noopener">nexus ldapé…ç½®</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nexus</category>
      </categories>
      <tags>
        <tag>npm</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx URL æ–œæ é—®é¢˜</title>
    <url>/2019/08/22/nginx-URL-%E6%96%9C%E6%9D%A0%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä»Šå¤©å…¬å¸æ–°ä¸Šçš„ä¸€ä¸ªå‰ç«¯åº”ç”¨é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯åœ¨å¾®ä¿¡ç™»å½•ç•Œé¢æ‰«ç ç™»å½•ä¹‹åï¼Œå¾®ä¿¡å›è°ƒç»™æˆ‘ä»¬çš„åœ°å€å¤šåŠ äº†ä¸€ä¸ªæ–œæ ;</p><blockquote><p>é”™è¯¯çš„åœ°å€:<a href="http://a.xxlaila.com/wx.html/?code=011amZet0h1IUf19Fvht0jg4ft0amZeN" target="_blank" rel="noopener">http://a.xxlaila.com/wx.html/?code=011amZet0h1IUf19Fvht0jg4ft0amZeN</a><br>æ­£ç¡®çš„åœ°å€:<a href="http://a.xxlaila.com/wx.html?code=011amZet0h1IUf19Fvht0jg4ft0amZeN" target="_blank" rel="noopener">http://a.xxlaila.com/wx.html?code=011amZet0h1IUf19Fvht0jg4ft0amZeN</a></p></blockquote><p>åœ¨nginxä¸Šé…ç½®éœ€è¦å§è¿™ä¸ªæ–œæ åˆ é™¤æ‰ã€‚ç”¨æˆ·æ‰èƒ½æ­£å¸¸çš„è®¿é—®ï¼›</p><h3 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><p>åœ¨é…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®é¡¹</p><a id="more"></a><ul><li>åˆ é™¤URLç»“å°¾çš„æ–œæ </li></ul><p><em>rewrite ^/(.</em>)/$ /$1 permanent;*</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  a.xxlaila.com;</span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)/$</span> /<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">  <span class="attribute">index</span> index.html index.htm index.jsp index.php;</span><br><span class="line">  <span class="attribute">root</span> /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> <span class="regexp">~* /</span> &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span>   /var/log/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨URLç»“å°¾æ·»åŠ æ–œæ <br>åœ¨é…ç½®æ–‡ä»¶å¢åŠ å¦‚ä¸‹é…ç½®é¡¹ç›®</li></ul><p><em>rewrite ^(.</em>[^/])$ $1/ permanent;*</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  a.xxlaila.com;</span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^(.*[^/])$</span> <span class="variable">$1</span>/ <span class="literal">permanent</span>;</span><br><span class="line">  <span class="attribute">index</span> index.html index.htm index.jsp index.php;</span><br><span class="line">  <span class="attribute">root</span> /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> <span class="regexp">~* /</span> &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span>   /var/log/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h2><p>åœ¨æµè§ˆå™¨è®¿é—®æŸä¸€ä¸ªurl/é¡µé¢çš„æ—¶å€™ï¼Œé€šå¸¸æœ‰æ—¶å€™å¸¦æœ‰.htmlçš„ä¸€ä¸ªæ‰©å±•åï¼Œç°éœ€æ±‚æ˜¯å¸¦<code>.html</code>å’Œä¸å¸¦<code>.html</code>éƒ½å¯ä»¥è®¿é—®</p><h3 id="ä¾‹"><a href="#ä¾‹" class="headerlink" title="ä¾‹"></a>ä¾‹</h3><p>å¢åŠ å¦‚ä¸‹é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;    </span><br><span class="line">       rewrite ^(.*)$ /<span class="variable">$1</span>.html last;</span><br><span class="line">       <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  charset utf-8;</span><br><span class="line">  server_name  a.xxlaila.com;</span><br><span class="line">  rewrite ^/(.*)/$ /<span class="variable">$1</span> permanent;</span><br><span class="line">  index index.html index.htm index.jsp index.php;</span><br><span class="line">  root /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  location ~* / &#123;</span><br><span class="line">    <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">       rewrite ^(.*)$ /<span class="variable">$1</span>.html last;</span><br><span class="line">       <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  access_log   /var/<span class="built_in">log</span>/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(å››)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E5%9B%9B/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h2 id="1ã€Blue-Ocean"><a href="#1ã€Blue-Ocean" class="headerlink" title="1ã€Blue Ocean"></a>1ã€Blue Ocean</h2><p>å®‰è£…Blue Oceanæ’ä»¶</p><h3 id="1-1ã€åˆ›å»ºpipeline"><a href="#1-1ã€åˆ›å»ºpipeline" class="headerlink" title="1.1ã€åˆ›å»ºpipeline"></a>1.1ã€åˆ›å»ºpipeline</h3><p><img src="https://img.xxlaila.cn/348knfnsdlds.png" alt="img"></p><ul><li>é…ç½®ä»£ç åº“çš„åœ°å€</li><li>ç„¶åé…ç½®æˆæƒè´¦æˆ·</li></ul><p><img src="https://img.xxlaila.cn/9857jksdhfjkhdsfds.png" alt="img"></p><p>åœ¨è¿™å„¿ä¹‹å‰gitåº“é‡Œé¢å¿…é¡»å­˜åœ¨äºjenkinsfileæ–‡ä»¶ï¼Œpipelineä¼šè‡ªåŠ¨å»æ‰«æä»£ç åº“é‡Œé¢çš„åˆ†æ”¯ï¼Œç„¶åæ ¹æ®æ¯ä¸€ä¸ªåˆ†æ”¯å»ºç«‹ä¸€ä¸ªç±»ä¼¼äºjobçš„å½¢å¼ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æ ¹æ®æ¯ä¸€ä¸ªåˆ†æ”¯è¿›è¡Œéƒ¨ç½²ï¼Œå¯ä»¥æ‰§è¡Œå®šæ—¶è§¦å‘ï¼Œéƒ¨ç½²</p><p><img src="https://img.xxlaila.cn/382dklfjdskjfs.png" alt="img"></p><p>è¿™å„¿ï¼Œåªæœ‰ä¸€ä¸ªåˆ†æ”¯å­˜åœ¨äºjenkinsfileï¼Œæ‰€ä»¥åªæ˜¾ç¤ºä¸€ä¸ªåˆ†æ”¯ï¼Œå¦‚ä¸‹å›¾ï¼š</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>jenkins, ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(ä¸‰)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E4%B8%89/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;jenkins é…ç½®å®Œæˆåï¼Œæœ€ç»ˆå®ç°çš„æ˜¯ci/cdï¼Œåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°åç«¯javaçš„ï¼Œå‰ç«¯nodejsçš„ï¼Œè¿™é‡Œå°±éœ€è¦è¿›è¡Œä¸€ä¸ªk8såœ¨è°ƒåº¦çš„æ—¶å€™ç”Ÿäº§podæ¥è¿›è¡ŒæŒ‡å®špodè¿›è¡Œç¼–è¯‘</p><h3 id="1ã€åˆ¶ä½œå®¹å™¨"><a href="#1ã€åˆ¶ä½œå®¹å™¨" class="headerlink" title="1ã€åˆ¶ä½œå®¹å™¨"></a>1ã€åˆ¶ä½œå®¹å™¨</h3><p>è‡ªå®šä¹‰ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢åŒ…å«äº† javaï¼Œnodejsçš„æ‰€éœ€è¦çš„ç¯å¢ƒï¼ŒåŒæ—¶éœ€è¦åŒæ­¥å®¹å™¨çš„æ—¶é—´ï¼ŒåŒ…å«æ¥jenkinsçš„node</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat Dockerfile</span></span><br><span class="line"><span class="attr">FROM</span> <span class="string">docker.io/centos:latest</span></span><br><span class="line"><span class="attr">MAINTAINER</span> <span class="string">xxlaila "cq_xxlaila@163.com"</span></span><br><span class="line"><span class="comment"># Install dependent plugin</span></span><br><span class="line"><span class="attr">ENV</span> <span class="string">VERSION v10.15.1</span></span><br><span class="line"><span class="attr">RUN</span> <span class="string">yum install -y wget \</span></span><br><span class="line">    <span class="attr">git</span> <span class="string">\</span></span><br><span class="line">    <span class="meta">java-1.8.0-openjdk.x86_64</span> <span class="string">\</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">curl -sL https://rpm.nodesource.com/setup_11.x | bash - \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum install -y gcc gcc-c++ make \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum install -y nodejs \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum clean all</span></span><br><span class="line"><span class="comment"># System variable setting</span></span><br><span class="line"><span class="attr">RUN</span> <span class="string">echo "LANG=zh_CN.UTF-8" &gt;&gt; /etc/locale.conf \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">source /etc/locale.conf \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">echo "Asia/shanghai" &gt;&gt; /etc/timezone \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">groupadd -g 10000 jenkins \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">useradd -g jenkins -u 10000 jenkins</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">EXPOSE</span> <span class="string">50000</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li><p>æ‰§è¡Œå®¹å™¨æ‰“åŒ…</p><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="attr"># docker build -t centos7</span><span class="number">.6</span>/<span class="symbol">node11</span>:latest .\</span><br></pre></td></tr></table></figure></li><li><p>æ¨é€å®¹å™¨åˆ°ç§æœ‰é•œåƒä»“åº“</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># docker tag centos7<span class="number">.6</span>/node11:latest docker.io/xxlaila/centos<span class="number">-7</span>-jdk1<span class="number">.8</span>-nodejs11<span class="number">.10</span>-jenkins:latest</span><br><span class="line"># docker push docker.io/xxlaila/centos<span class="number">-7</span>-jdk1<span class="number">.8</span>-nodejs11<span class="number">.10</span>-jenkins:latest</span><br></pre></td></tr></table></figure></li></ul><h3 id="2ã€jenkinsçš„é…ç½®"><a href="#2ã€jenkinsçš„é…ç½®" class="headerlink" title="2ã€jenkinsçš„é…ç½®"></a>2ã€jenkinsçš„é…ç½®</h3><h4 id="2-1ã€ç³»ç»Ÿé…ç½®"><a href="#2-1ã€ç³»ç»Ÿé…ç½®" class="headerlink" title="2.1ã€ç³»ç»Ÿé…ç½®"></a>2.1ã€ç³»ç»Ÿé…ç½®</h4><p>jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;ç³»ç»Ÿè®¾ç½®<br><strong>åç§°</strong>ï¼škubernetes<br><strong>åœ°å€</strong>ï¼š<a href="https://kubernetes.default.svc.cluster.local" target="_blank" rel="noopener">https://kubernetes.default.svc.cluster.local</a><br><strong>jenkinsåœ°å€</strong>ï¼š<a href="http://jenkins2.kube-ops.svc.cluster.local:8080" target="_blank" rel="noopener">http://jenkins2.kube-ops.svc.cluster.local:8080</a><br><img src="https://img.xxlaila.cn/489kdngkdhfkodsmf.png" alt="img"></p><h4 id="2-2ã€å¢åŠ ä¸€ä¸ªkubenetes-pod-templates"><a href="#2-2ã€å¢åŠ ä¸€ä¸ªkubenetes-pod-templates" class="headerlink" title="2.2ã€å¢åŠ ä¸€ä¸ªkubenetes pod templates"></a>2.2ã€å¢åŠ ä¸€ä¸ªkubenetes pod templates</h4><p><img src="https://img.xxlaila.cn/83jknfkdslfds.png" alt="img"></p><h4 id="2-3ã€é…ç½®å®¹å™¨ç¯å¢ƒ"><a href="#2-3ã€é…ç½®å®¹å™¨ç¯å¢ƒ" class="headerlink" title="2.3ã€é…ç½®å®¹å™¨ç¯å¢ƒ"></a>2.3ã€é…ç½®å®¹å™¨ç¯å¢ƒ</h4><p><img src="https://img.xxlaila.cn/42clkdsjfkldsfs.png" alt="img"></p><h4 id="2-4ã€é…ç½®æƒé™"><a href="#2-4ã€é…ç½®æƒé™" class="headerlink" title="2.4ã€é…ç½®æƒé™"></a>2.4ã€é…ç½®æƒé™</h4><p><img src="https://img.xxlaila.cn/3486238kmxnfksd.png" alt="img"></p><h3 id="3ã€æµ‹è¯•job"><a href="#3ã€æµ‹è¯•job" class="headerlink" title="3ã€æµ‹è¯•job"></a>3ã€æµ‹è¯•job</h3><p>å»ºç«‹ä¸€ä¸ªtest job çš„pipelineæ¥è¿›è¡Œå®¹å™¨æ˜¯å¦æ­£å¸¸</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node (<span class="string">'agent-node'</span>)&#123;</span><br><span class="line">    container(<span class="string">'nodejs'</span>) &#123;</span><br><span class="line">        sh <span class="string">'whoami'</span></span><br><span class="line">        sh <span class="string">'hostname'</span></span><br><span class="line">        sh <span class="string">'echo $PATH'</span></span><br><span class="line">        sh <span class="string">'npm version'</span></span><br><span class="line">        sh <span class="string">'node -v'</span></span><br><span class="line">        sh <span class="string">'npx -v'</span></span><br><span class="line">        sh <span class="string">'java -version'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1ã€å»ºç«‹pipeline"><a href="#3-1ã€å»ºç«‹pipeline" class="headerlink" title="3.1ã€å»ºç«‹pipeline"></a>3.1ã€å»ºç«‹pipeline</h4><h5 id="3-1-1ã€å»ºç«‹ä¸€ä¸ªåç«¯"><a href="#3-1-1ã€å»ºç«‹ä¸€ä¸ªåç«¯" class="headerlink" title="3.1.1ã€å»ºç«‹ä¸€ä¸ªåç«¯"></a>3.1.1ã€å»ºç«‹ä¸€ä¸ªåç«¯</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'agent-build'</span>) &#123;</span><br><span class="line">   stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git credentialsId:<span class="string">'gitlabUser'</span>, url: <span class="string">'http://gitlab.xxlaila.com/plat/middleware/kxl-eureka.git'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'build'</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2. Start build <span class="variable">$&#123;JOB_NAME&#125;</span>"</span></span><br><span class="line">        sh <span class="string">'/opt/bin/mvn clean package'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'show package'</span>) &#123;</span><br><span class="line">        sh <span class="string">'pwd'</span></span><br><span class="line">        sh <span class="string">'ls -ltrh target/'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1-2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯"><a href="#3-1-2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯" class="headerlink" title="3.1.2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯"></a>3.1.2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯</h4><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'agent-build'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git credentialsId:<span class="string">'gitlabUser'</span>, ur<span class="variable">l:</span> <span class="string">'http://gitlab.xxlaila.com/front-end/portal/kts-platform.git'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'install'</span>) &#123;</span><br><span class="line">        container(<span class="string">'nodejs'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"2. Start install $&#123;JOB_NAME&#125;"</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'node -v'</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'npm install'</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'npm run build production'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'show package'</span>) &#123;</span><br><span class="line">        <span class="keyword">sh</span> <span class="string">'pwd'</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">'ls -ltrh'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(äºŒ)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E4%BA%8C/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h1 id="åŸºäºjenkins-pipelineè¿›è¡Œéƒ¨ç½²"><a href="#åŸºäºjenkins-pipelineè¿›è¡Œéƒ¨ç½²" class="headerlink" title="åŸºäºjenkins  pipelineè¿›è¡Œéƒ¨ç½²"></a>åŸºäºjenkins pipelineè¿›è¡Œéƒ¨ç½²</h1><h2 id="1ã€jenkins-pipelineä»‹ç»"><a href="#1ã€jenkins-pipelineä»‹ç»" class="headerlink" title="1ã€jenkins pipelineä»‹ç»"></a>1ã€jenkins pipelineä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;è¦å®ç°åœ¨ Jenkins ä¸­çš„æ„å»ºå·¥ä½œï¼Œå¯ä»¥æœ‰å¤šç§æ–¹å¼ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨æ¯”è¾ƒå¸¸ç”¨çš„ Pipeline è¿™ç§æ–¹å¼ã€‚Pipelineï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸€å¥—è¿è¡Œåœ¨ Jenkins ä¸Šçš„å·¥ä½œæµæ¡†æ¶ï¼Œå°†åŸæ¥ç‹¬ç«‹è¿è¡Œäºå•ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ç‚¹çš„ä»»åŠ¡è¿æ¥èµ·æ¥ï¼Œå®ç°å•ä¸ªä»»åŠ¡éš¾ä»¥å®Œæˆçš„å¤æ‚æµç¨‹ç¼–æ’å’Œå¯è§†åŒ–çš„å·¥ä½œã€‚</p><p>Jenkins Pipeline æœ‰å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µ:</p><ul><li>Nodeï¼šèŠ‚ç‚¹ï¼Œä¸€ä¸ª Node å°±æ˜¯ä¸€ä¸ª Jenkins èŠ‚ç‚¹ï¼ŒMaster æˆ–è€… Agentï¼Œæ˜¯æ‰§è¡Œ Step çš„å…·ä½“è¿è¡Œç¯å¢ƒï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹‹å‰åŠ¨æ€è¿è¡Œçš„ Jenkins Slave å°±æ˜¯ä¸€ä¸ª Node èŠ‚ç‚¹</li><li>Stageï¼šé˜¶æ®µï¼Œä¸€ä¸ª Pipeline å¯ä»¥åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ª Stageï¼Œæ¯ä¸ª Stage ä»£è¡¨ä¸€ç»„æ“ä½œï¼Œæ¯”å¦‚ï¼šBuildã€Testã€Deployï¼ŒStage æ˜¯ä¸€ä¸ªé€»è¾‘åˆ†ç»„çš„æ¦‚å¿µï¼Œå¯ä»¥è·¨å¤šä¸ª Node</li><li>Stepï¼šæ­¥éª¤ï¼ŒStep æ˜¯æœ€åŸºæœ¬çš„æ“ä½œå•å…ƒï¼Œå¯ä»¥æ˜¯æ‰“å°ä¸€å¥è¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æ„å»ºä¸€ä¸ª Docker é•œåƒï¼Œç”±å„ç±» Jenkins æ’ä»¶æä¾›ï¼Œæ¯”å¦‚å‘½ä»¤ï¼šsh â€˜makeâ€™ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å¹³æ—¶ shell ç»ˆç«¯ä¸­æ‰§è¡Œ make å‘½ä»¤ä¸€æ ·ã€‚</li></ul><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åˆ›å»º Jenkins Pipline å‘¢ï¼Ÿ</p><ul><li>Pipeline è„šæœ¬æ˜¯ç”± Groovy è¯­è¨€å®ç°çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡å¿…è¦å•ç‹¬å»å­¦ä¹  Groovyï¼Œå½“ç„¶ä½ ä¼šçš„è¯æœ€å¥½</li><li>Pipeline æ”¯æŒä¸¤ç§è¯­æ³•ï¼šDeclarative(å£°æ˜å¼)å’Œ Scripted Pipeline(è„šæœ¬å¼)è¯­æ³•</li><li>Pipeline ä¹Ÿæœ‰ä¸¤ç§åˆ›å»ºæ–¹æ³•ï¼šå¯ä»¥ç›´æ¥åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­è¾“å…¥è„šæœ¬ï¼›ä¹Ÿå¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª Jenkinsfile è„šæœ¬æ–‡ä»¶æ”¾å…¥é¡¹ç›®æºç åº“ä¸­</li><li>ä¸€èˆ¬æˆ‘ä»¬éƒ½æ¨èåœ¨ Jenkins ä¸­ç›´æ¥ä»æºä»£ç æ§åˆ¶(SCMD)ä¸­ç›´æ¥è½½å…¥ Jenkinsfile Pipeline è¿™ç§æ–¹æ³•åˆ›å»ºä¸€ä¸ªç®€å•çš„ Pipeline<blockquote><p>æˆ‘ä»¬è¿™é‡Œæ¥ç»™å¤§å®¶å¿«é€Ÿåˆ›å»ºä¸€ä¸ªç®€å•çš„ Pipelineï¼Œç›´æ¥åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­è¾“å…¥è„šæœ¬è¿è¡Œã€‚</p></blockquote></li><li>æ–°å»º Jobï¼šåœ¨ Web UI ä¸­ç‚¹å‡» New Item -&gt; è¾“å…¥åç§°ï¼špipeline-demo -&gt; é€‰æ‹©ä¸‹é¢çš„ Pipeline -&gt; ç‚¹å‡» OK</li><li>é…ç½®ï¼šåœ¨æœ€ä¸‹æ–¹çš„ Pipeline åŒºåŸŸè¾“å…¥å¦‚ä¸‹ Script è„šæœ¬ï¼Œç„¶åç‚¹å‡»ä¿å­˜ã€‚</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell node &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span> </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span> </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"3.Build Stage"</span> </span><br><span class="line">        </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"4. Deploy Stage"</span> </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ„å»ºï¼šç‚¹å‡»å·¦ä¾§åŒºåŸŸçš„ Build Nowï¼Œå¯ä»¥çœ‹åˆ° Job å¼€å§‹æ„å»ºäº†<blockquote><p>éš”ä¸€ä¼šå„¿ï¼Œæ„å»ºå®Œæˆï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¾§åŒºåŸŸçš„ Console Outputï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºä¿¡æ¯ï¼š</p></blockquote></li></ul><p><img src="https://img.xxlaila.cn/sdsdsjid23874823ehsj.png" alt="img"></p><ul><li>åœ¨ Slave ä¸­æ„å»ºä»»åŠ¡<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ Pipeline ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªä»»åŠ¡å¹¶æ²¡æœ‰åœ¨ Jenkins çš„ Slave ä¸­è¿è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•è®©æˆ‘ä»¬çš„ä»»åŠ¡è·‘åœ¨ Slave ä¸­å‘¢ï¼Ÿè¿˜è®°å¾—ä¸ŠèŠ‚è¯¾æˆ‘ä»¬åœ¨æ·»åŠ  Slave Pod çš„æ—¶å€™ï¼Œä¸€å®šè¦è®°ä½æ·»åŠ çš„ label å—ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°è¿™ä¸ª labelï¼Œæˆ‘ä»¬é‡æ–°ç¼–è¾‘ä¸Šé¢åˆ›å»ºçš„ Pipeline è„šæœ¬ï¼Œç»™ node æ·»åŠ ä¸€ä¸ª label å±æ€§ï¼Œå¦‚ä¸‹:</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'jnlp-agent'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4. Deploy Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯ç»™ node æ·»åŠ äº†ä¸€ä¸ªjnlp-agentè¿™æ ·çš„ä¸€ä¸ªlabelï¼Œç„¶åæˆ‘ä»¬ä¿å­˜ï¼Œæ„å»ºä¹‹å‰æŸ¥çœ‹ä¸‹ kubernetes é›†ç¾¤ä¸­çš„ Podï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[<span class="built_in">test</span>] [root@k8s-zxc-test-3 ~]<span class="comment"># kubectl get pods -n kube-ops</span></span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">jenkins2-696b8fbdbb-q24nm   1/1     Running             0          45h</span><br><span class="line">jnlp-agent-342fv            0/1     ContainerCreating   0          0s</span><br><span class="line">[<span class="built_in">test</span>] [root@k8s-zxc-test-3 ~]<span class="comment"># kubectl get pods -n kube-ops</span></span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">jenkins2-696b8fbdbb-q24nm   1/1     Running             0          45h</span><br><span class="line">jnlp-agent-342fv            0/1     ContainerCreating   0          1s</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/dhf482390dsfjkdsg.png" alt="img"></p><ul><li><p>kubernetes ç•Œé¢æ˜¾ç¤º<br><img src="https://img.xxlaila.cn/9374hkdhskfjsdd.png" alt="img"></p></li><li><p>jenkinsæ‰§è¡Œç»“æœæ˜¾ç¤º<br><img src="https://img.xxlaila.cn/23cvkndiuyriens.png" alt="img"></p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp; è¯æ˜æˆ‘ä»¬å½“å‰çš„ä»»åŠ¡åœ¨è·‘åœ¨ä¸Šé¢åŠ¨æ€ç”Ÿæˆçš„è¿™ä¸ª Pod ä¸­ï¼Œä¹Ÿç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚æˆ‘ä»¬å›åˆ° Job çš„ä¸»ç•Œé¢ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°å¤§å®¶å¯èƒ½æ¯”è¾ƒç†Ÿæ‚‰çš„ Stage View ç•Œé¢ï¼š<br><img src="https://img.xxlaila.cn/45ksfh9whnkxa.png" alt="img"></p><h5 id="éƒ¨ç½²-Kubernetes-åº”ç”¨"><a href="#éƒ¨ç½²-Kubernetes-åº”ç”¨" class="headerlink" title="éƒ¨ç½² Kubernetes åº”ç”¨"></a>éƒ¨ç½² Kubernetes åº”ç”¨</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å·²ç»çŸ¥é“äº†å¦‚ä½•åœ¨ Jenkins Slave ä¸­æ„å»ºä»»åŠ¡äº†ï¼Œé‚£ä¹ˆå¦‚ä½•æ¥éƒ¨ç½²ä¸€ä¸ªåŸç”Ÿçš„ Kubernetes åº”ç”¨å‘¢ï¼Ÿ è¦éƒ¨ç½² Kubernetes åº”ç”¨ï¼Œæˆ‘ä»¬å°±å¾—å¯¹æˆ‘ä»¬ä¹‹å‰éƒ¨ç½²åº”ç”¨çš„æµç¨‹è¦éå¸¸ç†Ÿæ‚‰æ‰è¡Œï¼Œæˆ‘ä»¬ä¹‹å‰çš„æµç¨‹æ˜¯æ€æ ·çš„ï¼š</p><ul><li>1ã€ç¼–å†™ä»£ç </li><li>2ã€æµ‹è¯•</li><li>3ã€ç¼–å†™ Dockerfile</li><li>4ã€æ„å»ºæ‰“åŒ… Docker é•œåƒ</li><li>5ã€æ¨é€ Docker é•œåƒåˆ°ä»“åº“</li><li>6ã€ç¼–å†™ Kubernetes YAML æ–‡ä»¶</li><li>7ã€æ›´æ”¹ YAML æ–‡ä»¶ä¸­ Docker é•œåƒ TAG</li><li>8ã€åˆ©ç”¨ kubectl å·¥å…·éƒ¨ç½²åº”ç”¨</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬ä¹‹å‰åœ¨ Kubernetes ç¯å¢ƒä¸­éƒ¨ç½²ä¸€ä¸ªåŸç”Ÿåº”ç”¨çš„æµç¨‹åº”è¯¥åŸºæœ¬ä¸Šæ˜¯ä¸Šé¢è¿™äº›æµç¨‹å§ï¼Ÿç°åœ¨æˆ‘ä»¬å°±éœ€è¦æŠŠä¸Šé¢è¿™äº›æµç¨‹æ”¾å…¥ Jenkins ä¸­æ¥è‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆ(å½“ç„¶ç¼–ç é™¤å¤–)ï¼Œä»æµ‹è¯•åˆ°æ›´æ–° YAML æ–‡ä»¶å±äº CI æµç¨‹ï¼Œåé¢éƒ¨ç½²å±äº CD çš„æµç¨‹ã€‚å¦‚æœæŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬ç°åœ¨è¦æ¥ç¼–å†™ä¸€ä¸ª Pipeline çš„è„šæœ¬ã€‚</p><ul><li><p>ä¿®æ”¹test-spring-social-wechat-sample pipelineè„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'jnlp-agent'</span>) &#123;</span><br><span class="line">   stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'YAML'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"6. Deploy Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>1ï¼‰ã€å¢åŠ gitåœ°å€ï¼Œè¿›è¡Œä»£ç çš„clone</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Clone'</span>)</span></span> &#123;</span><br><span class="line">   echo <span class="string">"1.Clone Stage"</span></span><br><span class="line">   git url: <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>2ï¼‰ã€è¿›è¡Œæµ‹è¯•</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Test'</span>)</span></span> &#123;</span><br><span class="line">  echo <span class="string">"2.Test Stage"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>3ï¼‰ã€æ„å»ºä¸€ä¸ªdockeré•œåƒ</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Build'</span>)</span></span> &#123;</span><br><span class="line">  echo <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">  sh <span class="string">"docker build -t xxlaila/jenkins-demo:$&#123;build_tag&#125; ."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;å¹³æ—¶æ„å»ºçš„æ—¶å€™æ˜¯ä¸æ˜¯éƒ½æ˜¯ç›´æ¥ä½¿ç”¨docker buildå‘½ä»¤è¿›è¡Œæ„å»ºå°±è¡Œäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹å‘¢ï¼Ÿæˆ‘ä»¬ä¸ŠèŠ‚è¯¾ç»™å¤§å®¶æä¾›çš„ Slave Pod çš„é•œåƒé‡Œé¢æ˜¯ä¸æ˜¯é‡‡ç”¨çš„ Docker In Docker çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ Slave ä¸­ä½¿ç”¨ docker build å‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç›´æ¥ä½¿ç”¨ sh ç›´æ¥æ‰§è¡Œ docker build å‘½ä»¤å³å¯ï¼Œä½†æ˜¯é•œåƒçš„ tag å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬ä½¿ç”¨é•œåƒ tagï¼Œåˆ™æ¯æ¬¡éƒ½æ˜¯ latest çš„ tagï¼Œè¿™å¯¹äºä»¥åçš„æ’æŸ¥æˆ–è€…å›æ»šä¹‹ç±»çš„å·¥ä½œä¼šå¸¦æ¥å¾ˆå¤§éº»çƒ¦ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨å’Œgit commitçš„è®°å½•ä¸ºé•œåƒçš„ tagï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯é•œåƒçš„ tag å¯ä»¥å’Œ git æäº¤è®°å½•å¯¹åº”èµ·æ¥ï¼Œä¹Ÿæ–¹ä¾¿æ—¥åå¯¹åº”æŸ¥çœ‹ã€‚ä½†æ˜¯ç”±äºè¿™ä¸ª tag ä¸åªæ˜¯æˆ‘ä»¬è¿™ä¸€ä¸ª stage éœ€è¦ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªæ¨é€é•œåƒæ˜¯ä¸æ˜¯ä¹Ÿéœ€è¦ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æŠŠè¿™ä¸ª tag ç¼–å†™æˆä¸€ä¸ªå…¬å…±çš„å‚æ•°ï¼ŒæŠŠå®ƒæ”¾åœ¨ Clone è¿™ä¸ª stage ä¸­ï¼Œä¿®æ”¹å‰é¢ä¸¤ä¸ª stage:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git url: <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line">      script &#123;</span><br><span class="line">        build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">      sh <span class="string">"docker build -t xxlaila/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span> ."</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>4ï¼‰ã€æ¨é€é•œåƒ<br>&nbsp;&nbsp;&nbsp;&nbsp;é•œåƒæ„å»ºå®Œæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬å°±éœ€è¦å°†æ­¤å¤„æ„å»ºçš„é•œåƒæ¨é€åˆ°é•œåƒä»“åº“ä¸­å»ï¼Œå½“ç„¶å¦‚æœä½ æœ‰ç§æœ‰é•œåƒä»“åº“ä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰è‡ªå·±æ­å»ºç§æœ‰çš„ä»“åº“ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ docker hub å³å¯ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬çŸ¥é“ docker hub æ˜¯å…¬å…±çš„é•œåƒä»“åº“ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å–ä¸Šé¢çš„é•œåƒï¼Œä½†æ˜¯è¦å¾€ä¸Šæ¨é€é•œåƒæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°ä¸€ä¸ªå¸å·äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æå‰æ³¨å†Œä¸€ä¸ª docker hub çš„å¸å·ï¼Œè®°ä½ç”¨æˆ·åå’Œå¯†ç ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦ä½¿ç”¨ã€‚æ­£å¸¸æ¥è¯´æˆ‘ä»¬åœ¨æœ¬åœ°æ¨é€ docker é•œåƒçš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯éœ€è¦ä½¿ç”¨docker loginå‘½ä»¤ï¼Œç„¶åè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œè®¤è¯é€šè¿‡åï¼Œå°±å¯ä»¥ä½¿ç”¨docker pushå‘½ä»¤æ¥æ¨é€æœ¬åœ°çš„é•œåƒåˆ° docker hub ä¸Šé¢å»äº†ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬è¿™é‡Œçš„ Pipeline æ˜¯ä¸æ˜¯å°±è¯¥è¿™æ ·å†™äº†ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">      sh <span class="string">"docker login -u cq_xxlaila@163.com -p 111111"</span></span><br><span class="line">      sh <span class="string">"docker push xxlaila/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span>"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœåªæ˜¯åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡çš„è¯ï¼Œæˆ‘ä»¬è¿™é‡Œçš„ Pipeline æ˜¯å¯ä»¥è¿™æ ·å†™çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯ä¸æ˜¯æ¨èä½¿ç”¨ Jenkinsfile çš„å½¢å¼æ”¾å…¥æºç ä¸­è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬ç›´æ¥æŠŠ docker ä»“åº“çš„ç”¨æˆ·åå’Œå¯†ç æš´éœ²ç»™åˆ«äººè¿™æ ·å¾ˆæ˜¾ç„¶æ˜¯éå¸¸éå¸¸ä¸å®‰å…¨çš„ï¼Œæ›´ä½•å†µæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ github çš„å…¬å…±ä»£ç ä»“åº“ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥ç›´æ¥çœ‹åˆ°æˆ‘ä»¬çš„æºç ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ç”¨ä¸€ç§æ–¹å¼æ¥éšè—ç”¨æˆ·åå’Œå¯†ç è¿™ç§ç§å¯†ä¿¡æ¯ï¼Œå¹¸è¿çš„æ˜¯ Jenkins ä¸ºæˆ‘ä»¬æä¾›äº†è§£å†³æ–¹æ³•ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨é¦–é¡µç‚¹å‡» Credentials -&gt; Stores scoped to Jenkins ä¸‹é¢çš„ Jenkins -&gt; Global credentials (å‡­æ®) -&gt;system(ç³»ç»Ÿ)-&gt;å…¨å±€å‡­æ® (unrestricted)-&gt; å·¦ä¾§çš„ Add Credentials( æ·»åŠ å‡­æ®)ï¼šæ·»åŠ ä¸€ä¸ª Username with password ç±»å‹çš„è®¤è¯ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š<br><img src="https://img.xxlaila.cn/374kdjfkskfdsd.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;Add Credentials è¾“å…¥ docker hub çš„ç”¨æˆ·åå’Œå¯†ç ï¼ŒID éƒ¨åˆ†æˆ‘ä»¬è¾“å…¥dockerHubï¼Œæ³¨æ„ï¼Œè¿™ä¸ªå€¼éå¸¸é‡è¦ï¼Œåœ¨åé¢ Pipeline çš„è„šæœ¬ä¸­æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ª ID å€¼ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†ä¸Šé¢çš„ docker hub çš„ç”¨æˆ·åå’Œå¯†ç çš„è®¤è¯ä¿¡æ¯ï¼Œç°åœ¨ä¿®æ”¹ Pipeline ä¸­çš„ç¬¬å››éƒ¨ï¼Œä½¿ç”¨è¿™é‡Œçš„ç”¨æˆ·åå’Œå¯†ç ï¼š</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">stage('Push') &#123;</span><br><span class="line">     echo <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">     <span class="keyword">with</span><span class="constructor">Credentials([<span class="params">usernamePassword</span>(<span class="params">credentialsId</span>: '<span class="params">dockerHub</span>', <span class="params">passwordVariable</span>: '<span class="params">dockerHubPassword</span>', <span class="params">usernameVariable</span>: '<span class="params">dockerHubUser</span>')</span>]) &#123;</span><br><span class="line">         sh <span class="string">"docker login -u $&#123;dockerHubUser&#125; -p $&#123;dockerHubPassword&#125;"</span></span><br><span class="line">         sh <span class="string">"docker push xxlaila/jenkins-demo:$&#123;build_tag&#125;"</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><blockquote><p><em>æ³¨æ„</em>:<br>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è¿™é‡Œåœ¨ stage ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæ–°çš„å‡½æ•°withCredentialsï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªcredentialsIdå€¼å°±æ˜¯æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ ID å€¼ï¼Œç„¶åå°±å¯ä»¥åœ¨è„šæœ¬ä¸­ç›´æ¥ä½¿ç”¨è¿™é‡Œä¸¤ä¸ªå˜é‡å€¼æ¥ç›´æ¥æ›¿æ¢æ‰ä¹‹å‰çš„ç™»å½• docker hub çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿™æ ·æ“ä½œå°±ç›¸å¯¹æ¥è¯´å°±å¾ˆå®‰å…¨äº†ï¼Œåªæ˜¯ä¼ é€’è¿›å»äº†ä¸¤ä¸ªå˜é‡è€Œå·²ï¼Œåˆ«äººå¹¶ä¸çŸ¥é“çœŸæ­£ç”¨æˆ·åå’Œå¯†ç ï¼Œåªæœ‰æˆ‘ä»¬è‡ªå·±çš„ Jenkins å¹³å°ä¸Šæ·»åŠ çš„æ‰çŸ¥é“ã€‚<br><em>æµ‹è¯•ç»“æœ</em>:</p></blockquote><p><img src="https://img.xxlaila.cn/4ykjdbfjdshfkojdsl.png" alt="img"></p><ul><li>5ï¼‰ã€æ›´æ”¹ YAML<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢å·²ç»å®Œæˆäº†é•œåƒçš„æ‰“åŒ…ã€æ¨é€çš„å·¥ä½œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥æ›´æ–° Kubernetes ç³»ç»Ÿä¸­åº”ç”¨çš„é•œåƒç‰ˆæœ¬äº†ï¼Œå½“ç„¶ä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç”¨ YAML æ–‡ä»¶çš„å½¢å¼æ¥ç¼–å†™åº”ç”¨éƒ¨ç½²è§„åˆ™ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„ YAML æ–‡ä»¶ï¼š(k8s.yaml)<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cat k8s.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins-demo</span><br><span class="line"><span class="symbol">  namespace:</span> default</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      labels:</span></span><br><span class="line"><span class="symbol">        app:</span> jenkins-demo</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">      - image: xxlaila/jenkins-demo:<span class="params">&lt;BUILD_TAG&gt;</span></span><br><span class="line"><span class="symbol">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="symbol">        name:</span> jenkins-demo</span><br><span class="line"><span class="symbol">        env:</span></span><br><span class="line">        - name: branch</span><br><span class="line"><span class="symbol">          value:</span> <span class="params">&lt;BRANCH_NAME&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨ä¸€ä¸ª Deployment èµ„æºå¯¹è±¡æ¥ç®¡ç† Podï¼Œè¯¥ Pod ä½¿ç”¨çš„å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ¨é€çš„é•œåƒï¼Œå”¯ä¸€ä¸åŒçš„åœ°æ–¹æ˜¯ Docker é•œåƒçš„ tag ä¸æ˜¯æˆ‘ä»¬å¹³å¸¸è§çš„å…·ä½“çš„ tagï¼Œè€Œæ˜¯ä¸€ä¸ª çš„æ ‡è¯†ï¼Œå®é™…ä¸Šå¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªæ ‡è¯†æ›¿æ¢æˆä¸Šé¢çš„ Docker é•œåƒçš„ tagï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯æœ€ç»ˆæˆ‘ä»¬æœ¬æ¬¡æ„å»ºéœ€è¦ä½¿ç”¨åˆ°çš„é•œåƒï¼Ÿæ€ä¹ˆæ›¿æ¢å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªsedå‘½ä»¤å°±å¯ä»¥å®ç°äº†ï¼š</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'YAML'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">      sh <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>sed å‘½ä»¤å°±æ˜¯å°† k8s.yaml æ–‡ä»¶ä¸­çš„ æ ‡è¯†ç»™æ›¿æ¢æˆå˜é‡ build_tag çš„å€¼ã€‚</p></blockquote><ul><li>6ï¼‰ã€éƒ¨ç½²<br>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes åº”ç”¨çš„ YAML æ–‡ä»¶å·²ç»æ›´æ”¹å®Œæˆäº†ï¼Œä¹‹å‰æˆ‘ä»¬æ‰‹åŠ¨çš„ç¯å¢ƒä¸‹ï¼Œæ˜¯ä¸æ˜¯ç›´æ¥ä½¿ç”¨ kubectl apply å‘½ä»¤å°±å¯ä»¥ç›´æ¥æ›´æ–°åº”ç”¨ã€‚å½“ç„¶è¿™é‡Œåªæ˜¯å†™å…¥åˆ°äº† Pipeline é‡Œé¢ï¼Œæ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ï¼š</li></ul><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Deploy'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"6. Deploy Stage"</span></span><br><span class="line">      sh <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>ç‚¹å‡»jenkinsè¿›è¡Œæ„å»º<br><img src="https://img.xxlaila.cn/56hjkshdfdksnfkldsj.png" alt="img"></li></ul><blockquote><p>å½“ç„¶ï¼Œè¿™é‡Œéƒ¨ç½²å¤±è´¥ï¼Œå…ˆåˆ«ç®¡ï¼Œè¯æ˜æµç¨‹æ˜¯å¯¹çš„ï¼Œå¯ä»¥è¿™ä¹ˆèµ°</p></blockquote><p><img src="https://img.xxlaila.cn/3947dnfdsflskfjdsf.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»¥ä¸Šçš„é…ç½®åŸºæœ¬å·²ç»å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬çš„å®é™…é¡¹ç›®å®è·µè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€äº›äººå·¥å¹²é¢„çš„æ­¥éª¤ï¼Œæ¯”å¦‚æˆ‘ä»¬æäº¤äº†ä¸€æ¬¡ä»£ç ï¼Œæµ‹è¯•ä¹Ÿé€šè¿‡äº†ï¼Œé•œåƒä¹Ÿæ‰“åŒ…ä¸Šä¼ äº†ï¼Œä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬å¹¶ä¸ä¸€å®šå°±æ˜¯è¦ç«‹åˆ»ä¸Šçº¿åˆ°ç”Ÿäº§ç¯å¢ƒçš„ã€‚æˆ‘ä»¬å¯èƒ½éœ€è¦å°†è¯¥ç‰ˆæœ¬å…ˆå‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒã€QA ç¯å¢ƒã€æˆ–è€…é¢„è§ˆç¯å¢ƒä¹‹ç±»çš„ï¼Œæ€»ä¹‹ç›´æ¥å°±å‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒå»è¿˜æ˜¯æŒºå°‘è§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¢åŠ äººå·¥ç¡®è®¤çš„ç¯èŠ‚ï¼Œä¸€èˆ¬éƒ½æ˜¯åœ¨ CD çš„ç¯èŠ‚æ‰éœ€è¦äººå·¥å¹²é¢„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„æœ€åä¸¤æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å‰é¢åŠ ä¸Šç¡®è®¤ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'YAML'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">      def userInput = <span class="built_in">input</span>(</span><br><span class="line">          id: <span class="string">'userInput'</span>,</span><br><span class="line">          message: <span class="string">'Choose a deploy environment'</span>,</span><br><span class="line">          parameter<span class="variable">s:</span> [</span><br><span class="line">              [</span><br><span class="line">                  #clas<span class="variable">s:</span> <span class="string">'ChoiceParameterDefinition'</span>,</span><br><span class="line">                  choice<span class="variable">s:</span> <span class="string">"Dev\nTest\nUat\nDemo\nPord"</span>,</span><br><span class="line">                  name: <span class="string">'Env'</span></span><br><span class="line">                  ]</span><br><span class="line">              ]</span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"This is a deploy step to $&#123;userInput.Env&#125;"</span></span><br><span class="line">          <span class="keyword">sh</span> <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä½¿ç”¨äº† input å…³é”®å­—ï¼Œé‡Œé¢ä½¿ç”¨ä¸€ä¸ª Choice çš„åˆ—è¡¨æ¥è®©ç”¨æˆ·è¿›è¡Œé€‰æ‹©ï¼Œç„¶ååœ¨æˆ‘ä»¬é€‰æ‹©äº†éƒ¨ç½²ç¯å¢ƒåï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿå¯ä»¥é’ˆå¯¹ä¸åŒçš„ç¯å¢ƒå†åšä¸€äº›æ“ä½œï¼Œæ¯”å¦‚å¯ä»¥ç»™ä¸åŒç¯å¢ƒçš„ YAML æ–‡ä»¶éƒ¨ç½²åˆ°ä¸åŒçš„ namespace ä¸‹é¢å»ï¼Œå¢åŠ ä¸åŒçš„æ ‡ç­¾ç­‰ç­‰æ“ä½œï¼š</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Deploy'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"6. Deploy Stage"</span></span><br><span class="line">      <span class="keyword">if</span> (userInput<span class="selector-class">.Env</span> == <span class="string">"Dev"</span>)&#123;</span><br><span class="line">          <span class="comment">// deploy dev stuff</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userInput<span class="selector-class">.Env</span> == <span class="string">"Test"</span>)&#123;</span><br><span class="line">          <span class="comment">// deploy test stuff</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// deploy prod stuff</span></span><br><span class="line">      &#125;</span><br><span class="line">      sh <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸€æ­¥ä¹Ÿå±äºéƒ¨ç½²çš„èŒƒç•´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æœ€åä¸¤æ­¥éƒ½åˆå¹¶æˆä¸€æ­¥ï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ Pipeline è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'node-jnlp'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">        git ur<span class="variable">l:</span> <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line">        script &#123;</span><br><span class="line">            build_tag = <span class="keyword">sh</span>(returnStdou<span class="variable">t:</span> true, <span class="keyword">scrip</span><span class="variable">t:</span> <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"docker build -t xxlaila/jenkins-demo:$&#123;build_tag&#125; ."</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">        withCredentials([usernamePassword(credentialsId: <span class="string">'dockerHub'</span>, passwordVariable: <span class="string">'dockerHubPassword'</span>, usernameVariable: <span class="string">'dockerHubUser'</span>)]) &#123;</span><br><span class="line">            <span class="keyword">sh</span> <span class="string">"docker login -u $&#123;dockerHubUser&#125; -p $&#123;dockerHubPassword&#125;"</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">"docker push cnych/jenkins-demo:$&#123;build_tag&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"5. Deploy Stage"</span></span><br><span class="line">        def userInput = <span class="built_in">input</span>(</span><br><span class="line">            id: <span class="string">'userInput'</span>,</span><br><span class="line">            message: <span class="string">'Choose a deploy environment'</span>,</span><br><span class="line">            parameter<span class="variable">s:</span> [</span><br><span class="line">                [</span><br><span class="line">                    $clas<span class="variable">s:</span> <span class="string">'ChoiceParameterDefinition'</span>,</span><br><span class="line">                    choice<span class="variable">s:</span> <span class="string">"Dev\nQA\nProd"</span>,</span><br><span class="line">                    name: <span class="string">'Env'</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"This is a deploy step to $&#123;userInput&#125;"</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">"Dev"</span>) &#123;</span><br><span class="line">            // deploy dev stuff</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userInput == <span class="string">"QA"</span>)&#123;</span><br><span class="line">            // deploy <span class="keyword">qa</span> stuff</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            // deploy prod stuff</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>é”™è¯¯</em>: åœ¨jenkinsæ‰§è¡Œæ„å»ºçš„æ—¶å€™æç¤º:</p><p><img src="https://img.xxlaila.cn/2846djkfhklsdjdklsd.png" alt="img"></p><blockquote><p>æ²¡æœ‰æƒé™è¿›è¡Œéƒ¨ç½²ï¼Œä¸‹é¢è¿›è¡Œæƒé™çš„åˆ†é…ã€‚</p></blockquote><ul><li><p>æŸ¥çœ‹kube-ops ä¸‹é¢çš„è§’è‰²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role -n kube-ops</span></span><br><span class="line">NAME       AGE</span><br><span class="line">jenkins2   2d6h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹roleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role jenkins2 -n kube-ops -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2019-01-14T03:07:25Z"</span></span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  resourceVersion: <span class="string">"2389179"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/kube-ops/roles/jenkins2</span><br><span class="line">  uid: 84762132-17a9-11e9-8991-fa163e14c5bd</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">exec</span></span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">log</span></span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºjenkins2çš„æƒé™</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">[<span class="symbol">root@</span>k8s-zxc-test<span class="number">-3</span> ~]# kubectl -n kube-system create sa jenkins2</span><br><span class="line">serviceaccount/jenkins2 created</span><br></pre></td></tr></table></figure></li><li><p>æˆæƒè®¿é—®</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test<span class="number">-3</span> ~]# kubectl <span class="built_in">create</span> clusterrolebinding jenkins2 <span class="comment">--clusterrole cluster-admin --serviceaccount=kube-ops:jenkins2</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/jenkins2 created</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>zabbixä¼ä¸šå¾®ä¿¡å‘Šè­¦</title>
    <url>/2019/08/20/zabbix%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Zabbixå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼æŠŠå‘Šè­¦ä¿¡æ¯å‘é€åˆ°æŒ‡å®šäººï¼Œå¸¸ç”¨çš„æœ‰é‚®ä»¶ï¼ŒçŸ­ä¿¡æŠ¥è­¦æ–¹å¼ï¼Œä½†æ˜¯è¶Šæ¥è¶Šå¤šçš„ä¼ä¸šå¼€å§‹ä½¿ç”¨zabbixç»“åˆå¾®ä¿¡ä½œä¸ºä¸»è¦çš„å‘Šè­¦æ–¹å¼ï¼Œè¿™æ ·å¯ä»¥åŠæ—¶æœ‰æ•ˆçš„æŠŠå‘Šè­¦ä¿¡æ¯æ¨é€åˆ°æ¥æ”¶äººï¼Œæ–¹ä¾¿å‘Šè­¦çš„åŠæ—¶å¤„ç†ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;å¾®ä¿¡ä¼ä¸šå·éœ€è¦å…ˆåœ¨ä¼ä¸šé€šä¿¡å½•æ–°å»ºè¯¥å‘˜å·¥ï¼Œè¯¥å‘˜å·¥æ‰èƒ½å…³æ³¨è¯¥ä¼ä¸šå·ï¼Œè¿™æ ·å°±èƒ½å®ç°å‘Šè­¦ä¿¡æ¯çš„ç§å¯†æ€§ã€‚å¦‚æœä½¿ç”¨å…¬ä¼—å·ï¼Œåˆ™åªè¦æ‰€æœ‰å…³æ³¨äº†è¯¥å…¬ä¼—å·çš„äººéƒ½èƒ½æ”¶åˆ°å‘Šè­¦æ¶ˆæ¯ï¼Œå®¹æ˜“é€ æˆä¿¡æ¯æ³„éœ²ã€‚è€Œä¸”å‘˜å·¥æ•°å°‘äº200äººçš„ä¼ä¸šå·æ˜¯ä¸ç”¨é’±çš„ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ç”³è¯·é™åˆ¶.</p><h3 id="1ã€è„šæœ¬å­˜æ”¾ç›®å½•"><a href="#1ã€è„šæœ¬å­˜æ”¾ç›®å½•" class="headerlink" title="1ã€è„šæœ¬å­˜æ”¾ç›®å½•"></a>1ã€è„šæœ¬å­˜æ”¾ç›®å½•</h3><p>/usr/lib/zabbix/alertscriptsï¼Œè„šæœ¬çš„æƒé™æ˜¯zabbix è´¦æˆ·ï¼Œå…·æœ‰å¯æ‰§è¡Œæƒé™</p><a id="more"></a><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat wechat.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/python2.7</span></span><br><span class="line"><span class="comment">#_*_coding:utf-8 _*_</span></span><br><span class="line"><span class="built_in">import</span> requests,sys,json</span><br><span class="line"><span class="built_in">import</span> urllib3</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding('utf-<span class="number">8</span>')</span><br><span class="line">def GetToken(Corpid,Secret):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/gettoken"</span></span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"corpid"</span>:Corpid,</span><br><span class="line">        <span class="string">"corpsecret"</span>:Secret</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.get(<span class="attr">url=Url,params=Data,verify=False)</span></span><br><span class="line">    <span class="attr">Token</span> = r.json()['access_token']</span><br><span class="line">    return Token</span><br><span class="line">def SendMessage(Token,User,Agentid,Subject,Content):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s"</span> % Token</span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"touser"</span>: User,                                 <span class="comment"># ä¼ä¸šå·ä¸­çš„ç”¨æˆ·å¸å·ï¼Œåœ¨zabbixç”¨æˆ·Mediaä¸­é…ç½®ï¼Œå¦‚æœé…ç½®ä¸æ­£å¸¸ï¼Œå°†æŒ‰éƒ¨é—¨å‘é€ã€‚</span></span><br><span class="line">        <span class="comment">#"totag": Tagid,                                # ä¼ä¸šå·ä¸­çš„æ ‡ç­¾idï¼Œç¾¤å‘ä½¿ç”¨ï¼ˆæ¨èï¼‰</span></span><br><span class="line">        <span class="string">"toparty"</span>: <span class="string">"2"</span>,                            <span class="comment"># ä¼ä¸šå·ä¸­çš„éƒ¨é—¨idï¼Œç¾¤å‘æ—¶ä½¿ç”¨ã€‚</span></span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,                              <span class="comment"># æ¶ˆæ¯ç±»å‹ã€‚</span></span><br><span class="line">        <span class="string">"agentid"</span>: Agentid,                             <span class="comment"># ä¼ä¸šå·ä¸­çš„åº”ç”¨idã€‚</span></span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: Subject + '\n' + Content</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"safe"</span>: <span class="string">"0"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.post(<span class="attr">url=Url,data=json.dumps(Data),verify=False)</span></span><br><span class="line">    return r.text</span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == '__main__':</span><br><span class="line">    <span class="attr">User</span> = sys.argv[<span class="number">1</span>]                                                              <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Subject</span> = sys.argv[<span class="number">2</span>]                                                           <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Content</span> = sys.argv[<span class="number">3</span>]                                                           <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Corpid</span> = <span class="string">"wwa9c9999"</span>                                                   <span class="comment"># CorpIDæ˜¯ä¼ä¸šå·çš„æ ‡è¯†</span></span><br><span class="line">    <span class="attr">Secret</span> = <span class="string">"VGbZvXJ5RiLskdksh2dkhaskdu92uihsjdhjksadh"</span>     <span class="comment"># Secretæ˜¯ç®¡ç†ç»„å‡­è¯å¯†é’¥</span></span><br><span class="line">    <span class="comment">#Tagid = "1"                                                                     # é€šè®¯å½•æ ‡ç­¾ID</span></span><br><span class="line">    <span class="attr">Agentid</span> = <span class="string">"1000001"</span>                                                                   <span class="comment"># åº”ç”¨ID</span></span><br><span class="line">    <span class="comment">#Partyid = "1"                                                                  # éƒ¨é—¨ID</span></span><br><span class="line">    <span class="attr">Token</span> = GetToken(Corpid, Secret)</span><br><span class="line">    <span class="attr">Status</span> = SendMessage(Token,User,Agentid,Subject,Content)</span><br><span class="line">    print Status</span><br></pre></td></tr></table></figure><h3 id="2ã€é‡è¦å‚æ•°ä»‹ç»"><a href="#2ã€é‡è¦å‚æ•°ä»‹ç»" class="headerlink" title="2ã€é‡è¦å‚æ•°ä»‹ç»"></a>2ã€é‡è¦å‚æ•°ä»‹ç»</h3><ul><li>topartyï¼šâ€2â€ è¿™ä¸ªå‚æ•°æ˜¯åœ¨ä¼ä¸šå¾®ä¿¡é‡Œé¢éƒ¨é—¨çš„id</li><li>Corpidï¼šä¼ä¸šçš„CorpIDæ ‡ç¤º</li><li>Secretï¼šç®¡ç†ç»„çš„å¯†é’¥å‡­è¯</li><li>Agentidï¼šæ–°å»ºåº”ç”¨çš„id</li><li>åªéœ€è¦æ±‚ä¿®æ”¹ä»¥ä¸Šå‚æ•°å³å¯</li></ul><p><img src="https://img.xxlaila.cn/image2018-8-23_16-8-30.png" alt="img"></p><ul><li>ä»¥ä¸Šéƒ¨é—¨æ²¡æœ‰æ–°å»ºï¼Œåªæ˜¯åœ¨è¿™ä¸ªåº”ç”¨ä¸­æ–°å¢åŠ äº†å‡ ä¸ªç”¨æˆ·ã€‚æœ€å¥½çš„æ–¹å¼æ˜¯å¢åŠ ä¸€ä¸ªéƒ¨é—¨ç»„ï¼Œç”¨æˆ·æ·»åŠ åˆ°éƒ¨é—¨ç»„é‡Œé¢ï¼Œè¿™ç§æ–¹å¼æœ€ç§‘å­¦</li></ul><h3 id="3ã€ç™»é™†zabbix-è¿›è¡Œé…ç½®"><a href="#3ã€ç™»é™†zabbix-è¿›è¡Œé…ç½®" class="headerlink" title="3ã€ç™»é™†zabbix è¿›è¡Œé…ç½®"></a>3ã€ç™»é™†zabbix è¿›è¡Œé…ç½®</h3><h4 id="3-1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹"><a href="#3-1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹" class="headerlink" title="3.1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹"></a>3.1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-11-59.png" alt="img"></p><h4 id="3-2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«"><a href="#3-2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«" class="headerlink" title="3.2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«"></a>3.2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-12-53.png" alt="img"><br><img src="https://img.xxlaila.cn/image2018-8-23_16-13-9.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME}æ•…éšœ!</p><p>å‘Šè­¦ä¸»æœº:{HOST.NAME}<br>å‘Šè­¦åœ°å€:{HOST.IP}<br>ç›‘æ§é¡¹ç›®:{ITEM.NAME}<br>ç›‘æ§å–å€¼:{ITEM.LASTVALUE}<br>å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY}<br>å½“å‰çŠ¶æ€:{TRIGGER.STATUS}<br>å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME}<br>å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME}<br>äº‹ä»¶ID:{EVENT.ID}</p></blockquote><p><img src="https://img.xxlaila.cn/image2018-8-23_16-13-20.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME}å·²æ¢å¤!</p><p>å‘Šè­¦ä¸»æœº:{HOST.NAME}<br>å‘Šè­¦åœ°å€:{HOST.IP}<br>ç›‘æ§é¡¹ç›®:{ITEM.NAME}<br>ç›‘æ§å–å€¼:{ITEM.LASTVALUE}<br>å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY}<br>å½“å‰çŠ¶æ€:{TRIGGER.STATUS}<br>å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME}<br>å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME}<br>æ¢å¤æ—¶é—´:{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}<br>æŒç»­æ—¶é—´:{EVENT.AGE}<br>äº‹ä»¶ID:{EVENT.ID}</p></blockquote><p><img src="https://img.xxlaila.cn/image2018-8-23_16-13-28.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}: æŠ¥è­¦ç¡®è®¤</p><p>ç¡®è®¤äºº:{USER.FULLNAME}<br>æ—¶é—´:{ACK.DATE} {ACK.TIME}<br>ç¡®è®¤ä¿¡æ¯å¦‚ä¸‹:<br>â€œ{ACK.MESSAGE}â€<br>é—®é¢˜æœåŠ¡å™¨IP:{HOSTNAME1}<br>é—®é¢˜ID:{EVENT.ID}<br>å½“å‰çš„é—®é¢˜æ˜¯: {TRIGGER.NAME}</p></blockquote><h4 id="3-3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹"><a href="#3-3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹" class="headerlink" title="3.3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹"></a>3.3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-21-58.png" alt="img"><br>è¿™é‡Œä¸ºadminç”¨æˆ·æ·»åŠ çš„ å‘Šè­¦æ–¹å¼ã€‚æ³¨æ„ä¸€ä¸‹send to è¿™ä¸ªå‚æ•°ï¼Œè¿™é‡Œä¸€å®šè¦æ˜¯@allã€‚å¦åˆ™ä¸æˆåŠŸ</p><h3 id="4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•"><a href="#4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•" class="headerlink" title="4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•"></a>4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•</h3><p><img src="https://img.xxlaila.cn/image2018-8-23_16-23-14.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
      </tags>
  </entry>
  <entry>
    <title>å¸§ä¸­ç»§é…ç½®</title>
    <url>/2019/08/19/%E5%B8%A7%E4%B8%AD%E7%BB%A7%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="ç‚¹å¯¹ç‚¹é…ç½®"><a href="#ç‚¹å¯¹ç‚¹é…ç½®" class="headerlink" title="ç‚¹å¯¹ç‚¹é…ç½®"></a>ç‚¹å¯¹ç‚¹é…ç½®</h3><p><img src="https://img.xxlaila.cn/1566222269423.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">102</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li></ul><a id="more"></a><ul><li>FRAME-RELAYé…ç½®:<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching                 å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>pvc 201<span class="built_in"> interface </span>s0/0 102    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰"><a href="#ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰" class="headerlink" title="ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰"></a>ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222529208.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">102</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">103</span>                 </span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">103</span>  </span><br><span class="line">[RA-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>     é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCI</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">301</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">301</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching      å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰"><a href="#ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰" class="headerlink" title="ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰"></a>ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222807499.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA]int s0/<span class="number">0.1</span> multipoint</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">102</span>     è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">103</span>                 </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">103</span>  </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">301</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">301</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>    é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                    æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching    å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰"><a href="#ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰" class="headerlink" title="ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰"></a>ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222918549.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span> </span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh               æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RA]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">102</span>        è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·              </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br><span class="line">[RA]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RA-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">103</span>        è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·              </span><br><span class="line">[RA-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">103</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.2</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>    é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RB-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                   æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RB]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RB-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">201</span>     è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·             </span><br><span class="line">[RB-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>     é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RB-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">203</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·             </span><br><span class="line">[RB-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">203</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.3</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RC-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RC]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RC-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">301</span>         è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·                </span><br><span class="line">[RC-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.3</span><span class="number">.1</span> <span class="number">301</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.3</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RC-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">302</span>         è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·                </span><br><span class="line">[RC-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.2</span><span class="number">.1</span> <span class="number">302</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.2</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching                 å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201     é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301     é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay           å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>pvc 203<span class="built_in"> interface </span>s0/0 302    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay           å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>302<span class="built_in"> interface </span>s0/0 203    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>å¸§ä¸­ç»§</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes ci/cd(ä¸€)</title>
    <url>/2019/08/12/kubernetes-ci-cd-%E4%B8%80/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><blockquote><p>åŸºäºjenkinsçš„CI/CDå®‰è£…</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jenkinsä¸€ä¸ªæµè¡Œçš„æŒç»­é›†æˆ/å‘å¸ƒå·¥å…·ï¼Œåœ¨Kubernetesä½¿ç”¨,æŒç»­æ„å»ºä¸å‘å¸ƒæ˜¯æˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ­¥éª¤ï¼Œç›®å‰å¤§å¤šå…¬å¸éƒ½é‡‡ç”¨ Jenkins é›†ç¾¤æ¥æ­å»ºç¬¦åˆéœ€æ±‚çš„ CI/CD æµç¨‹ï¼Œç„¶è€Œä¼ ç»Ÿçš„ Jenkins Slave ä¸€ä¸»å¤šä»æ–¹å¼ä¼šå­˜åœ¨ä¸€äº›ç—›ç‚¹ï¼Œæ¯”å¦‚ï¼šä¸» Master å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ï¼Œæ•´ä¸ªæµç¨‹éƒ½ä¸å¯ç”¨äº†ï¼›æ¯ä¸ª Slave çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²ï¼›èµ„æºåˆ†é…ä¸å‡è¡¡ï¼Œæœ‰çš„ Slave è¦è¿è¡Œçš„ job å‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„ Slave å¤„äºç©ºé—²çŠ¶æ€ï¼›æœ€åèµ„æºæœ‰æµªè´¹ï¼Œæ¯å° Slave å¯èƒ½æ˜¯å®ä½“æœºæˆ–è€… VMï¼Œå½“ Slave å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æºã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æåˆ°åŸºäºKuberneteçš„CI/CDï¼Œå¯ä»¥ä½¿ç”¨çš„å·¥å…·æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚Jenkinsã€Gitlab CIå·²ç»æ–°å…´çš„droneä¹‹ç±»çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä¼šä½¿ç”¨å¤§å®¶æœ€ä¸ºç†Ÿæ‚‰çš„Jeninsæ¥åšCI/CDçš„å·¥å…·ã€‚</p><ul><li>ä¼˜ç‚¹:<ul><li>Jenkins å®‰è£…å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸ç”¨æ€¥ç€å°±å»ä½¿ç”¨ï¼Œæˆ‘ä»¬è¦äº†è§£ä¸‹åœ¨ Kubernetes ç¯å¢ƒä¸‹é¢ä½¿ç”¨ Jenkins æœ‰ä»€ä¹ˆå¥½å¤„ã€‚éƒ½çŸ¥é“æŒç»­æ„å»ºä¸å‘å¸ƒæ˜¯æˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ­¥éª¤ï¼Œç›®å‰å¤§å¤šå…¬å¸éƒ½é‡‡ç”¨ Jenkins é›†ç¾¤æ¥æ­å»ºç¬¦åˆéœ€æ±‚çš„ CI/CD æµç¨‹ï¼Œç„¶è€Œä¼ ç»Ÿçš„ Jenkins Slave ä¸€ä¸»å¤šä»æ–¹å¼ä¼šå­˜åœ¨ä¸€äº›ç—›ç‚¹ï¼Œæ¯”å¦‚:<ul><li>E ä¸» Master å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ï¼Œæ•´ä¸ªæµç¨‹éƒ½ä¸å¯ç”¨äº†ã€‚</li><li>E æ¯ä¸ª Slave çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²ã€‚</li><li>E èµ„æºåˆ†é…ä¸å‡è¡¡ï¼Œæœ‰çš„ Slave è¦è¿è¡Œçš„ job å‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„ Slave å¤„äºç©ºé—²çŠ¶æ€ã€‚</li><li>E èµ„æºæœ‰æµªè´¹ï¼Œæ¯å° Slave å¯èƒ½æ˜¯ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºï¼Œå½“ Slave å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æºã€‚</li></ul></li><li>æ­£å› ä¸ºè¿™äº›ç§ç§ç—›ç‚¹ï¼Œæˆ‘ä»¬æ¸´æœ›ä¸€ç§æ›´é«˜æ•ˆæ›´å¯é çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ª CI/CD æµç¨‹ï¼Œè€Œ Docker è™šæ‹ŸåŒ–å®¹å™¨æŠ€æœ¯èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªç—›ç‚¹ï¼Œåˆç‰¹åˆ«æ˜¯åœ¨ Kubernetes é›†ç¾¤ç¯å¢ƒä¸‹é¢èƒ½å¤Ÿæ›´å¥½æ¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä¸‹å›¾æ˜¯åŸºäº Kubernetes æ­å»º Jenkins é›†ç¾¤çš„ç®€å•ç¤ºæ„å›¾<br><img src="https://img.xxlaila.cn/xjfhs84we.png" alt="img"></li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ° Jenkins Master å’Œ Jenkins Slave ä»¥ Pod å½¢å¼è¿è¡Œåœ¨ Kubernetes é›†ç¾¤çš„ Node ä¸Šï¼ŒMaster è¿è¡Œåœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†å…¶é…ç½®æ•°æ®å­˜å‚¨åˆ°ä¸€ä¸ª Volume ä¸Šå»ï¼ŒSlave è¿è¡Œåœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”å®ƒä¸æ˜¯ä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå®ƒä¼šæŒ‰ç…§éœ€æ±‚åŠ¨æ€çš„åˆ›å»ºå¹¶è‡ªåŠ¨åˆ é™¤ã€‚</p><a id="more"></a><ul><li>è¿™ç§æ–¹å¼çš„å·¥ä½œæµç¨‹å¤§è‡´ä¸º<ul><li>å½“ Jenkins Master æ¥å—åˆ° Build è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®é…ç½®çš„ Label åŠ¨æ€åˆ›å»ºä¸€ä¸ªè¿è¡Œåœ¨ Pod ä¸­çš„ Jenkins Slave å¹¶æ³¨å†Œåˆ° Master ä¸Šï¼Œå½“è¿è¡Œå®Œ Job åï¼Œè¿™ä¸ª Slave ä¼šè¢«æ³¨é”€å¹¶ä¸”è¿™ä¸ª Pod ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤ï¼Œæ¢å¤åˆ°æœ€åˆçŠ¶æ€ã€‚é‚£ä¹ˆä½¿ç”¨è¿™ç§æ–¹å¼å¸¦æ¥äº†å“ªäº›å¥½å¤„å‘¢ï¼Ÿ</li><li>E æœåŠ¡é«˜å¯ç”¨ï¼Œå½“ Jenkins Master å‡ºç°æ•…éšœæ—¶ï¼ŒKubernetes ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Jenkins Master å®¹å™¨ï¼Œå¹¶ä¸”å°† Volume åˆ†é…ç»™æ–°åˆ›å»ºçš„å®¹å™¨ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä»è€Œè¾¾åˆ°é›†ç¾¤æœåŠ¡é«˜å¯ç”¨ã€‚</li><li>E åŠ¨æ€ä¼¸ç¼©ï¼Œåˆç†ä½¿ç”¨èµ„æºï¼Œæ¯æ¬¡è¿è¡Œ Job æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Jenkins Slaveï¼ŒJob å®Œæˆåï¼ŒSlave è‡ªåŠ¨æ³¨é”€å¹¶åˆ é™¤å®¹å™¨ï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸” Kubernetes ä¼šæ ¹æ®æ¯ä¸ªèµ„æºçš„ä½¿ç”¨æƒ…å†µï¼ŒåŠ¨æ€åˆ†é… Slave åˆ°ç©ºé—²çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œé™ä½å‡ºç°å› æŸèŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œè¿˜æ’é˜Ÿç­‰å¾…åœ¨è¯¥èŠ‚ç‚¹çš„æƒ…å†µã€‚</li><li>E æ‰©å±•æ€§å¥½ï¼Œå½“ Kubernetes é›†ç¾¤çš„èµ„æºä¸¥é‡ä¸è¶³è€Œå¯¼è‡´ Job æ’é˜Ÿç­‰å¾…æ—¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„æ·»åŠ ä¸€ä¸ª Kubernetes Node åˆ°é›†ç¾¤ä¸­ï¼Œä»è€Œå®ç°æ‰©å±•ã€‚</li></ul></li></ul><h2 id="1ã€å®‰è£…jenkins"><a href="#1ã€å®‰è£…jenkins" class="headerlink" title="1ã€å®‰è£…jenkins"></a>1ã€å®‰è£…jenkins</h2><h3 id="1-1ã€æ–°å»ºä¸€ä¸ª-Deployment"><a href="#1-1ã€æ–°å»ºä¸€ä¸ª-Deployment" class="headerlink" title="1.1ã€æ–°å»ºä¸€ä¸ª Deployment"></a>1.1ã€æ–°å»ºä¸€ä¸ª Deployment</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#cat  jenkins-deployment.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">jenkins/jenkins:lts</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">512</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">          subPath:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LIMITS_MEMORY</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">limits.memory</span></span><br><span class="line"><span class="attr">              divisor:</span> <span class="number">1</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="bullet">-Xmx$(LIMITS_MEMORY)m</span> <span class="attr">-XshowSettings:vm</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.initialDelay=0</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN=50</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN0=0.85</span> <span class="bullet">-Duser.timezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">        persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">          claimName:</span> <span class="string">opspvc</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30002</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">agent</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å¯¹è±¡èµ„æºéƒ½æ”¾ç½®åœ¨ä¸€ä¸ªåä¸º kube-ops çš„ namespace ä¸‹é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ åˆ›å»ºä¸€ä¸ª namespace,namespace è¯·å‚è€ƒnamspaceç« èŠ‚çš„å…·ä½“ä»‹ç»</p><figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line"># kubectl <span class="keyword">create</span> <span class="keyword">namespace</span> kube-ops</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä½¿ç”¨ä¸€ä¸ªåä¸º jenkins/jenkins:lts çš„å®˜æ–¹é•œåƒï¼Œè¿™æ˜¯ jenkins å®˜æ–¹çš„ Docker é•œåƒï¼Œç„¶åä¹Ÿæœ‰ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å®šåˆ¶ä¸€ä¸ªé•œåƒï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å°†ä¸€äº›æ’ä»¶æ‰“åŒ…åœ¨è‡ªå®šä¹‰çš„é•œåƒå½“ä¸­ï¼Œ<a href="https://github.com/jenkinsci/docker" target="_blank" rel="noopener">å¯ä»¥å‚è€ƒæ–‡æ¡£</a>ã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨é»˜è®¤çš„å®˜æ–¹é•œåƒå°±è¡Œï¼Œå¦å¤–ä¸€ä¸ªè¿˜éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å°†å®¹å™¨çš„ /var/jenkins_home ç›®å½•æŒ‚è½½åˆ°äº†ä¸€ä¸ªåä¸º opspvc çš„ PVC å¯¹è±¡ä¸Šé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ ·è¿˜å¾—æå‰åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ PVC å¯¹è±¡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ä»¬å‰é¢çš„ StorageClass å¯¹è±¡æ¥è‡ªåŠ¨åˆ›å»ºï¼š(jenkins-pvc.yaml)</p><h3 id="1-2-Jenkins-StorageClass-åˆ›å»º"><a href="#1-2-Jenkins-StorageClass-åˆ›å»º" class="headerlink" title="1.2 Jenkins StorageClass åˆ›å»º"></a>1.2 Jenkins StorageClass åˆ›å»º</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">opspv</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">172.21</span><span class="number">.16</span><span class="number">.231</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/jenkins</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">opspvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºpvcå¯¹è±¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-pvc.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–è¿™é‡Œè¿˜éœ€è¦ä½¿ç”¨åˆ°ä¸€ä¸ªæ‹¥æœ‰ç›¸å…³æƒé™çš„ serviceAccountï¼šjenkins2ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ç»™jenkins èµ‹äºˆäº†ä¸€äº›å¿…è¦çš„æƒé™ï¼Œå½“ç„¶å¦‚æœä½ å¯¹ serviceAccount çš„æƒé™ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯ï¼Œæˆ‘ä»¬ç»™è¿™ä¸ª sa ç»‘å®šä¸€ä¸ª cluster-admin çš„é›†ç¾¤è§’è‰²æƒé™ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå½“ç„¶è¿™æ ·å…·æœ‰ä¸€å®šçš„å®‰å…¨é£é™©ï¼šï¼ˆjenkins-rbac.yamlï¼‰</p><h3 id="1-3-Jenkins-serviceAccount"><a href="#1-3-Jenkins-serviceAccount" class="headerlink" title="1.3 Jenkins serviceAccount"></a>1.3 Jenkins serviceAccount</h3><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cat jenkins-rbac.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> ServiceAccount</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line"><span class="symbol">kind:</span> Role</span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"><span class="symbol">rules:</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"create"</span>,<span class="string">"delete"</span>,<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"patch"</span>,<span class="string">"update"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods/exec"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"create"</span>,<span class="string">"delete"</span>,<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"patch"</span>,<span class="string">"update"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods/log"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"secrets"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"get"</span>]</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="symbol">kind:</span> RoleBinding</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"><span class="symbol">roleRef:</span></span><br><span class="line"><span class="symbol">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="symbol">  kind:</span> Role</span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">subjects:</span></span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line"><span class="symbol">    name:</span> jenkins2</span><br><span class="line"><span class="symbol">namespace:</span> kube-ops</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»º rbac ç›¸å…³çš„èµ„æºå¯¹è±¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-rbac.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé€šè¿‡ ingressçš„å½¢å¼æ¥è®¿é—®Jenkins çš„ web æœåŠ¡ï¼ŒJenkins æœåŠ¡ç«¯å£ä¸º8080ï¼Œ50000 ç«¯å£ä¸ºagentï¼Œè¿™ä¸ªç«¯å£ä¸»è¦æ˜¯ç”¨äº Jenkins çš„ master å’Œ slave ä¹‹é—´é€šä¿¡ä½¿ç”¨çš„ã€‚(jenkins-ingress.yaml)</p><h3 id="1-4-Jenkins-å¯¹å¤–æä¾›è®¿é—®"><a href="#1-4-Jenkins-å¯¹å¤–æä¾›è®¿é—®" class="headerlink" title="1.4 Jenkins å¯¹å¤–æä¾›è®¿é—®"></a>1.4 Jenkins å¯¹å¤–æä¾›è®¿é—®</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">ci.xxlaila.cn</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»º Jenkins æœåŠ¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-deployment.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>åˆ›å»ºå®Œæˆådockeå›å»æ‹‰å»é•œåƒï¼Œéœ€è¦ç­‰å¾…ä¸€ä¼šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹jenkinsæ˜¯å¦éƒ¨ç½²æˆåŠŸ</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># kubectl <span class="keyword">get</span> pods -n kube-ops</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">jenkins2<span class="number">-84f</span>476cbb-vz4b2   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d19h</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å®Œæˆä»¥åæˆ‘ä¹ˆå¯ä»¥é€šè¿‡åœ¨jenkins-ingress.yamlé‡Œé¢ç»‘å®šè¿‡çš„åŸŸåè¿›è¡Œè®¿é—®ï¼Œç„¶åè¿›è¡Œå®‰è£…é…ç½®ï¼š<br><img src="https://img.xxlaila.cn/sfdsfdsf38432.png" alt="img"></p><blockquote><p>åˆå§‹åŒ–çš„å¯†ç æˆ‘ä»¬å¯ä»¥åœ¨ jenkins çš„å®¹å™¨çš„æ—¥å¿—ä¸­è¿›è¡ŒæŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ nfs çš„å…±äº«æ•°æ®ç›®å½•ä¸­æŸ¥çœ‹</p><p>$ cat /data/jenkins/jenkins2/secrets/initialAdminPassword</p></blockquote><p>å®Œæˆé…ç½®ï¼Œå°±å¯ä»¥åˆ°jenkinsçš„ç•Œé¢ï¼Œå°±å’Œæˆ‘ä»¬åœ¨vmä¸‹å®‰è£…çš„jenkinsæ²¡æœ‰ä»»ä½•çš„åŒºåˆ«ã€‚<br><img src="https://img.xxlaila.cn/isdy823723894324.png" alt="img"></p><h2 id="2-é…ç½®jenkins"><a href="#2-é…ç½®jenkins" class="headerlink" title="2 é…ç½®jenkins"></a>2 é…ç½®jenkins</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ¥é…ç½® Jenkinsï¼Œè®©ä»–èƒ½å¤ŸåŠ¨æ€çš„ç”Ÿæˆ Slave çš„ Podï¼Œå®‰è£…jenkinsçš„æ’ä»¶æ¸…å•</p><p><code>Kubernetes This plugin integrates Jenkins with Kubernetes</code><br>2.1 Kuberneteså’ŒJenkinsçš„ç»“åˆ<br>&nbsp;&nbsp;&nbsp;&nbsp;ç‚¹å‡» ç³»ç»Ÿç®¡ç†(Manage Jenkins) â€”&gt; ç³»ç»Ÿé…ç½®(Configure System) â€”&gt; (æ‹–åˆ°æœ€ä¸‹æ–¹)Add a new cloud â€”&gt; é€‰æ‹© Kubernetesï¼Œç„¶åå¡«å†™ Kubernetes å’Œ Jenkins é…ç½®ä¿¡æ¯ã€‚</p><p><img src="https://img.xxlaila.cn/di32sdsf.png" alt="img"></p><blockquote><p>æ³¨æ„ namespaceï¼Œæˆ‘ä»¬è¿™é‡Œå¡« kube-opsï¼Œç„¶åç‚¹å‡»Test Connectionï¼Œå¦‚æœå‡ºç° Connection test successful çš„æç¤ºä¿¡æ¯è¯æ˜Jenkins å·²ç»å¯ä»¥å’Œ Kubernetes ç³»ç»Ÿæ­£å¸¸é€šä¿¡äº†ï¼Œç„¶åä¸‹æ–¹çš„ Jenkins URL åœ°å€ï¼š<a href="http://jenkins2.kube-ops.svc.cluster.local:8080ï¼Œè¿™é‡Œçš„æ ¼å¼ä¸ºæœåŠ¡å.namespace.svc.cluster.local:8080ï¼Œæ ¹æ®ä¸Šé¢åˆ›å»ºçš„jenkinsçš„æœåŠ¡åå¡«å†™ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¹‹å‰åˆ›å»ºçš„åä¸ºjenkinsï¼Œå¦‚æœæ˜¯ç”¨ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å°±åº”è¯¥æ˜¯jenkins2" target="_blank" rel="noopener">http://jenkins2.kube-ops.svc.cluster.local:8080ï¼Œè¿™é‡Œçš„æ ¼å¼ä¸ºæœåŠ¡å.namespace.svc.cluster.local:8080ï¼Œæ ¹æ®ä¸Šé¢åˆ›å»ºçš„jenkinsçš„æœåŠ¡åå¡«å†™ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¹‹å‰åˆ›å»ºçš„åä¸ºjenkinsï¼Œå¦‚æœæ˜¯ç”¨ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å°±åº”è¯¥æ˜¯jenkins2</a></p></blockquote><h3 id="2-2ã€é…ç½®-Pod-Template"><a href="#2-2ã€é…ç½®-Pod-Template" class="headerlink" title="2.2ã€é…ç½® Pod Template"></a>2.2ã€é…ç½® Pod Template</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;é…ç½® Jenkins Slave è¿è¡Œçš„ Pod æ¨¡æ¿ï¼Œå‘½åç©ºé—´æˆ‘ä»¬åŒæ ·æ˜¯ç”¨kube-opsï¼ŒLabels è¿™é‡Œä¹Ÿéå¸¸é‡è¦ï¼Œå¯¹äºåé¢æ‰§è¡Œ Job çš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥å€¼ï¼Œç„¶åæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ cnych/jenkins:jnlp è¿™ä¸ªé•œåƒï¼Œè¿™ä¸ªé•œåƒæ˜¯åœ¨å®˜æ–¹çš„ jnlp é•œåƒåŸºç¡€ä¸Šå®šåˆ¶çš„ï¼ŒåŠ å…¥äº† kubectl ç­‰ä¸€äº›å®ç”¨çš„å·¥å…·ã€‚<br><img src="https://img.xxlaila.cn/897kdfhgdkjb4.png" alt="img"><br><img src="https://img.xxlaila.cn/kjgsadsad8234632.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–éœ€è¦æ³¨æ„æˆ‘ä»¬è¿™é‡Œéœ€è¦åœ¨ä¸‹é¢æŒ‚è½½ä¸€ä¸ªä¸»æœºç›®å½•ï¼Œä¸€ä¸ªæ˜¯ /var/run/docker.sockï¼Œè¯¥æ–‡ä»¶æ˜¯ç”¨äº Pod ä¸­çš„å®¹å™¨èƒ½å¤Ÿå…±äº«å®¿ä¸»æœºçš„ Dockerï¼Œè¿™å°±æ˜¯è¯´çš„ docker in docker çš„æ–¹å¼ï¼ŒDocker äºŒè¿›åˆ¶æ–‡ä»¶æˆ‘ä»¬å·²ç»æ‰“åŒ…åˆ°ä¸Šé¢çš„é•œåƒä¸­äº†ã€‚å¦‚æœåœ¨slave agentä¸­æƒ³è¦è®¿é—®kubernetes é›†ç¾¤ä¸­å…¶ä»–èµ„æºï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»‘å®šä¹‹å‰åˆ›å»ºçš„Service Account è´¦å·:jenkins2</p><p><img src="https://img.xxlaila.cn/khsdif28734knsdfkds.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–è¿˜æœ‰å‡ ä¸ªå‚æ•°éœ€è¦æ³¨æ„ï¼Œä¸Šå›¾æœ‰ä¸€ä¸ªpodå¯¿å‘½ä»£ç†çš„ç©ºé—²å­˜æ´»æ—¶é—´ï¼ˆåˆ†ï¼‰ï¼Œæ„æ€æ˜¯å½“å¤„äºç©ºé—²çŠ¶æ€çš„æ—¶å€™ä¿ç•™ Slave Podå¤šé•¿æ—¶é—´ï¼Œè¿™ä¸ªå‚æ•°æœ€å¥½æˆ‘ä»¬ä¿å­˜é»˜è®¤å°±è¡Œäº†ï¼Œå¦‚æœä½ è®¾ç½®è¿‡å¤§çš„è¯ï¼ŒJob ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå¯¹åº”çš„ Slave Pod å°±ä¸ä¼šç«‹å³è¢«é”€æ¯åˆ é™¤ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬çš„ Kubernetes Pluginæ’ä»¶å°±ç®—é…ç½®å®Œæˆäº†</p><h3 id="2-3-Jenkins-æµ‹è¯•"><a href="#2-3-Jenkins-æµ‹è¯•" class="headerlink" title="2.3 Jenkins æµ‹è¯•"></a>2.3 Jenkins æµ‹è¯•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes æ’ä»¶çš„é…ç½®å·¥ä½œå®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ·»åŠ ä¸€ä¸ª Job ä»»åŠ¡ï¼Œçœ‹æ˜¯å¦èƒ½å¤Ÿåœ¨ Slave Pod ä¸­æ‰§è¡Œï¼Œä»»åŠ¡æ‰§è¡Œå®Œæˆåçœ‹ Pod æ˜¯å¦ä¼šè¢«é”€æ¯åœ¨ Jenkins é¦–é¡µç‚¹å‡»create new jobsï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•çš„ä»»åŠ¡ï¼Œè¾“å…¥ä»»åŠ¡åç§°ï¼Œç„¶åæˆ‘ä»¬é€‰æ‹© Freestyle project ç±»å‹çš„ä»»åŠ¡<br>&nbsp;&nbsp;&nbsp;&nbsp;æ–°å»ºä¸€ä¸ªjobä¸ºsimple-testï¼Œå¢åŠ ä¸€ä¸ªshellæ¨¡å—ï¼Œshellæ¨¡å—é‡Œé¢å¢åŠ ç®€å•çš„echoæ¥æµ‹è¯•slaveçš„åŠ¨æ€éƒ¨ç½²ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"æµ‹è¯• Kubernetes åŠ¨æ€ç”Ÿæˆ jenkins slave"</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"==============docker in docker==========="</span></span><br><span class="line">docker info</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=============kubectl============="</span></span><br><span class="line">kubectl <span class="built_in">get</span> pods -n kube-<span class="built_in">system</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/s94uskljdslfd.png" alt="img"></p><p>ç°åœ¨æˆ‘ä»¬ç›´æ¥åœ¨é¡µé¢ç‚¹å‡»åšæˆçš„ Build now è§¦å‘æ„å»ºå³å¯ï¼Œç„¶åè§‚å¯Ÿ Kubernetes é›†ç¾¤ä¸­ Pod çš„å˜åŒ–</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl get pods -n kube-ops</span></span><br></pre></td></tr></table></figure><p>Kubernetes ç•Œé¢ä¹Ÿä¼šå‡ºç°jenkins agentçš„è¿›è¡Œpodçš„è¿›è¡Œéƒ¨ç½²ã€‚éƒ¨ç½²å®ŒæˆåéšåŠåˆ é™¤podã€‚</p><p><img src="https://img.xxlaila.cn/sakhd89234klmds.png" alt="img"><br><img src="https://img.xxlaila.cn/nslkfhio3rsd.png" alt="img"></p><h2 id="3ã€Jenkinsé”™è¯¯è§£å†³"><a href="#3ã€Jenkinsé”™è¯¯è§£å†³" class="headerlink" title="3ã€Jenkinsé”™è¯¯è§£å†³"></a>3ã€Jenkinsé”™è¯¯è§£å†³</h2><p>ç¬¬ä¸€æ¬¡å­¦ä¹ å®‰è£…jenkinsè¸©äº†å¾ˆå¤šå‘ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå­¦ä¹ äº†å¾ˆå¤šçš„ï¼Œä¸‹é¢æ˜¯åœ¨k8sä¸Šå®‰è£…jenkinsé‡åˆ°çš„ä¸€äº›é”™è¯¯ï¼š</p><ul><li>æ‰“å¼€jenkinsé¡µé¢çš„æ—¶å€™æç¤ºdnsä¸èƒ½è§£æï¼Œæ´é¢å¦‚ä¸‹å›¾ï¼š</li></ul><p><img src="https://img.xxlaila.cn/skajdh823648uesd.png" alt="img"></p><ul><li>æŸ¥çœ‹jenkinsçš„æ—¥å¿—æç¤º</li></ul><p><img src="https://img.xxlaila.cn/8243ihkdfnklsads.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¯¼è‡´çš„é—®é¢˜æœ‰httpsã€ç½‘ç»œè¿æ¥ä¸é€šç•…ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å§httpsä¿®æ”¹ä¸ºhttpï¼Œéœ€è¦ä¿®æ”¹jenkinsçš„é…ç½®æ–‡ä»¶ã€‚ç„¶åå†é‡æ–°å»ºç«‹jenkinsçš„podã€‚è¿›å…¥jenkinsçš„ç›®å½•ä¿®æ”¹hudson.model.UpdateCenter.xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">$ cat hudson.model.UpdateCenter.xml</span><br><span class="line"><span class="meta">&lt;?xml version='1.1' encoding='UTF-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sites</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">site</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://updates.jenkins.io/update-center.json<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨åšk8sçš„æ—¶å€™ä¸€å®šè¦ç”¨è¯ä¹¦ï¼Œä¸ç„¶åæœŸåœ¨åšå„ç§æœåŠ¡çš„æ—¶å€™éƒ½ä¼šé‡åˆ°é”™è¯¯ï¼Œå› ä¸ºdockeré»˜è®¤å»ç§æœ‰registoryè¦httpsï¼Œkuber-apiè¦httpsã€‚å½“ç„¶æ²¡æœ‰ä½¿ç”¨httpséƒ½å¯ä»¥æ¢æˆhttpï¼Œåœ¨æ¬¡é‡æ–°éƒ¨ç½²jenkinsä»¥åæç¤ºç³»åˆ—ä¿¡æ¯ã€‚è®¿é—®ç›®å½•æ²¡æœ‰æƒé™ã€‚</p><p><img src="https://img.xxlaila.cn/2864jksfhjdsh.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿›å…¥nfsç›®å½•ï¼Œéœ€è¦ä¿®æ”¹ä¸‹ç›®å½•æƒé™, å› ä¸ºå½“æ˜ å°„æœ¬åœ°æ•°æ®å·æ—¶ï¼Œ/home/docker/jenkinsç›®å½•çš„æ‹¥æœ‰è€…ä¸ºrootç”¨æˆ·ï¼Œè€Œå®¹å™¨ä¸­jenkins userçš„uidä¸º1000</p><p><code>$ sudo chown -R 1000:1000 /data/jenkins</code></p><blockquote><p>è¿™é‡Œå§httpsè§£å†³äº†è¿˜æ˜¯é‡åˆ°æç¤ºç½‘ç»œä¸é€šã€‚ä¸‹å›¾</p></blockquote><p><img src="https://img.xxlaila.cn/xnks94uoildsfs.png" alt="img"></p><blockquote><p>è¿™é‡Œæ˜¯dnsçš„ä¸èƒ½è§£æçš„é—®é¢˜ï¼Œä»¥ä¸‹æ’é”™æ€è·¯ï¼šç™»é™†jenkinsçš„å®¹å™¨é‡Œé¢æŸ¥çœ‹è·¯ç”±æ˜¯å¦æ­£ç¡®</p></blockquote><p><img src="https://img.xxlaila.cn/382468365324.png" alt="img"></p><blockquote><p>ç„¶ååœ¨ç¡®è®¤å®¹å™¨æ˜¯å¦å¯ä»¥è”é€šå¤–ç½‘ï¼Œè¿˜æ˜¯dnsä¸èƒ½è§£æ<br><img src="https://img.xxlaila.cn/fnijwy4nkdsfkhdsf.png" alt="img"></p></blockquote><blockquote><p>è¿™é‡Œping 114æ²¡æœ‰é—®é¢˜ï¼ŒpingåŸŸåä¸èƒ½è§£æï¼Œè¯´æ˜æ˜¯dnsè§£ææœ‰é—®é¢˜ã€‚æ¥ç€æˆ‘ä»¬åœ¨æŸ¥çœ‹å®¹å™¨çš„dnsé…ç½®</p></blockquote><p><img src="https://img.xxlaila.cn/dkjfsg328943242.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæ˜¯dnsé—®é¢˜ã€‚è¿™é‡Œä¸é˜è¿°dnsï¼Œå‚è€ƒç¬¬äºŒç« k8s dns,jenkins åœ¨æ‰§è¡Œç¼–è¯‘çš„æ—¶å€™æç¤º: <code>â€˜Jenkinsâ€™ doesnâ€™t have label â€˜jnlp-agentâ€™</code>,åœ¨ç³»ç»Ÿé…ç½®é…ç½®é‡Œé¢è¿›è¡Œæµ‹è¯•è¿æ¥k8s çš„apiæç¤ºå¦‚ä¸‹é”™è¯¯</p><p><img src="https://img.xxlaila.cn/324768ksdjsfhds.png" alt="img"></p><ul><li>æ·»åŠ jenkinsçš„secretè®¤è¯</li></ul><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"># kubectl get secret  -<span class="keyword">n</span> kube-ops</span><br><span class="line">NAME                     <span class="keyword">TYPE</span>                                  DATA   AGE</span><br><span class="line">default-<span class="keyword">token</span>-4gzkv      kubernetes.io/service-account-<span class="keyword">token</span>   3      13d</span><br><span class="line">jenkins2-<span class="keyword">token</span>-mjnw4     kubernetes.io/service-account-<span class="keyword">token</span>   3      14m</span><br><span class="line">prometheus-<span class="keyword">token</span>-84p87   kubernetes.io/service-account-<span class="keyword">token</span>   3      13d</span><br><span class="line"># kubectl <span class="keyword">describe</span> secret jenkins2-<span class="keyword">token</span>-mjnw4 -<span class="keyword">n</span> kube-ops</span><br><span class="line">Name:         jenkins2-<span class="keyword">token</span>-mjnw4</span><br><span class="line">Namespace:    kube-ops</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: jenkins2</span><br><span class="line">              kubernetes.io/service-account.uid: ffced652-2f6c-11e9-98a4-fa163e14c5bd</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span>:  kubernetes.io/service-account-<span class="keyword">token</span></span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line"><span class="keyword">ca</span>.crt:     1025 bytes</span><br><span class="line">namespace:  8 bytes</span><br><span class="line"><span class="keyword">token</span>:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLW9wcyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJqZW5raW5zMi10b2tlbi1tam53NCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJqZW5raW5zMiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImZmY2VkNjUyLTJmNmMtMTFlOS05OGE0LWZhMTYzZTE0YzViZCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLW9wczpqZW5raW5zMiJ9.PlPvO_AST4Q6tJJ2i2zGFfufFN1xjWLlHZ5ipTK0aU5CdR49OAropPQhQ0TjLRWf4Z66h847g28OCABmxO1cSG_-8UpwVsohFROTCOjx9Ka3KACmaIkw9Bvihm_lPQlaLykdyXxVDrfI6TobtG0Y5KnKPFj8CjkIFPk5ewTKpOm5pDKVDKu4W_4uOhSnISfLVUvHp8A_ojK_JCVnBBr0Py3UeuEF8vjJES0_yKNxPUtXQq-vkWEZecnAC_x5sfFJTA5aB18sEnxCaeMzgUxzi4IflNxxyVjdZrbq0UdS8llmfnGg5Ur7Zf-lu2ajdOlRdQp6VRPMcQmQaWoHUuoevg</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/2372837934232.png" alt="img"><br><img src="https://img.xxlaila.cn/djfjsr3897493432.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kube nfs åŠ¨æ€å­˜å‚¨</title>
    <url>/2019/08/12/kube-nfs-%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;nfs-client-provisioneræ˜¯ä¸€ä¸ªautomatic provisionerï¼Œä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œè‡ªåŠ¨åˆ›å»ºPVå’Œå¯¹åº”çš„PVCï¼Œæœ¬èº«ä¸æä¾›NFSå­˜å‚¨ï¼Œéœ€è¦å¤–éƒ¨å…ˆæœ‰ä¸€å¥—NFSå­˜å‚¨æœåŠ¡ã€‚</p><ul><li>PVä»¥ ${namespace}-${pvcName}-${pvName}çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">å®˜æ–¹è®¿é—®åœ°å€</a></p><h2 id="1ã€æƒé™ä½“ç³»æ„å»º"><a href="#1ã€æƒé™ä½“ç³»æ„å»º" class="headerlink" title="1ã€æƒé™ä½“ç³»æ„å»º"></a>1ã€æƒé™ä½“ç³»æ„å»º</h2><h3 id="1-1ã€åˆ›å»ºserviceaccount"><a href="#1-1ã€åˆ›å»ºserviceaccount" class="headerlink" title="1.1ã€åˆ›å»ºserviceaccount"></a>1.1ã€åˆ›å»ºserviceaccount</h3><p>ServiceAccountä¹Ÿæ˜¯ä¸€ç§è´¦å·, ä¾›è¿è¡Œåœ¨podä¸­çš„è¿›ç¨‹ä½¿ç”¨, ä¸ºpodä¸­çš„è¿›ç¨‹æä¾›å¿…è¦çš„èº«ä»½è¯æ˜.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat serviceaccount.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: kube-test</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1-2ã€åˆ›å»ºrole"><a href="#1-2ã€åˆ›å»ºrole" class="headerlink" title="1.2ã€åˆ›å»ºrole"></a>1.2ã€åˆ›å»ºrole</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat  clusterrole.yaml</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  namespace: kube-test</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    resources: [<span class="string">"storageclasses"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"events"</span>]</span><br><span class="line">    verbs: [<span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services"</span>, <span class="string">"endpoints"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>,<span class="string">"list"</span>, <span class="string">"watch"</span>,<span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"podsecuritypolicies"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"nfs-client-provisioner"</span>]</span><br><span class="line">    verbs: [<span class="string">"use"</span>]</span><br></pre></td></tr></table></figure><h3 id="1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"><a href="#1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š" class="headerlink" title="1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"></a>1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat clusterrolebinding.yaml </span></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: kube-test</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">æ‰§è¡Œåˆ›å»º</span><br><span class="line">kubectl create -f serviceaccount.yaml -f clusterrole.yaml -f clusterrolebinding.yaml</span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…éƒ¨ç½²"><a href="#2ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="2ã€å®‰è£…éƒ¨ç½²"></a>2ã€å®‰è£…éƒ¨ç½²</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹è½½deployment.yamlæ–‡ä»¶,éœ€è¦ä¿®æ”¹NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ10.10.10.60ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/ifs/kubernetesï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><h3 id="2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"><a href="#2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·" class="headerlink" title="2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"></a>2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·</h3><blockquote><p>æ ¹æ®PVCçš„è¯·æ±‚, åŠ¨æ€åˆ›å»ºPVå­˜å‚¨.</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat deployment.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: quay.io/external_storage/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.21.16.244</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /data</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 10.10.10.60</span><br><span class="line">            path: /ifs/kubernetes</span><br></pre></td></tr></table></figure><pre><code>* ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²class.yaml</code></pre><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´</p><h3 id="2-2ã€åˆ›å»ºstorageclass"><a href="#2-2ã€åˆ›å»ºstorageclass" class="headerlink" title="2.2ã€åˆ›å»ºstorageclass"></a>2.2ã€åˆ›å»ºstorageclass</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat class.yaml</span></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br></pre></td></tr></table></figure><h4 id="2-2-1ã€æŸ¥çœ‹StorageClass"><a href="#2-2-1ã€æŸ¥çœ‹StorageClass" class="headerlink" title="2.2.1ã€æŸ¥çœ‹StorageClass"></a>2.2.1ã€æŸ¥çœ‹StorageClass</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get sc</span></span><br><span class="line"><span class="comment"># kubectl get storageclass</span></span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   19h</span><br></pre></td></tr></table></figure><h4 id="2-2-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"><a href="#2-2-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨" class="headerlink" title="2.2.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"></a>2.2.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨</h4><p>è®¾ç½®è¿™ä¸ªdefaultåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch storageclass managed-nfs-storage -p '&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3ã€æµ‹è¯•åˆ›å»ºPVC"><a href="#2-2-3ã€æµ‹è¯•åˆ›å»ºPVC" class="headerlink" title="2.2.3ã€æµ‹è¯•åˆ›å»ºPVC"></a>2.2.3ã€æµ‹è¯•åˆ›å»ºPVC</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat test-claim.yaml </span></span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-claim</span><br><span class="line">  namespace: kube-test</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br></pre></td></tr></table></figure><h4 id="2-2-4ã€å¯åŠ¨æµ‹è¯•POD"><a href="#2-2-4ã€å¯åŠ¨æµ‹è¯•POD" class="headerlink" title="2.2.4ã€å¯åŠ¨æµ‹è¯•POD"></a>2.2.4ã€å¯åŠ¨æµ‹è¯•POD</h4><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat test-pod.yaml </span></span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-pod</span><br><span class="line">  namespace: kube-test</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: <span class="built_in">test</span>-pod</span><br><span class="line">    image: docker.io/busybox:1.24</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"/bin/sh"</span></span><br><span class="line">    args:</span><br><span class="line">      - <span class="string">"-c"</span></span><br><span class="line">      - <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        mountPath: <span class="string">"/mnt"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: <span class="built_in">test</span>-claim</span><br></pre></td></tr></table></figure><h4 id="2-2-5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ"><a href="#2-2-5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ" class="headerlink" title="2.2.5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ"></a>2.2.5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ</h4><p>å»NFSå…±äº«ç›®å½•æŸ¥çœ‹æœ‰æ²¡æœ‰SUCCESSæ–‡ä»¶<br><img src="https://img.xxlaila.cn/%E6%88%AA%E5%9B%BE.png" alt="img"><br><img src="https://img.xxlaila.cn/8934nsdlsa.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pvc -n kube-test</span></span><br><span class="line">NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line"><span class="built_in">test</span>-claim   Bound    pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd   1Mi        RWX            managed-nfs-storage   20h</span><br></pre></td></tr></table></figure><h3 id="2-3ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"><a href="#2-3ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥" class="headerlink" title="2.3ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"></a>2.3ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥</h3><ul><li><p>æŸ¥çœ‹é›†ç¾¤ä¸­PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch pv pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd -p '&#123;"spec":&#123;"persistentVolumeReclaimPolicy":"Retain"&#125;&#125;'</span></span><br><span class="line">persistentvolume/pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd patched</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ›´æ”¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>pvc pv</title>
    <url>/2019/08/12/pvc-pv/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h2 id="1ã€ä»‹ç»"><a href="#1ã€ä»‹ç»" class="headerlink" title="1ã€ä»‹ç»"></a>1ã€ä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;PersistentVolumeï¼ˆpvï¼‰å’ŒPersistentVolumeClaimï¼ˆpvcï¼‰æ˜¯k8sæä¾›çš„ä¸¤ç§APIèµ„æºï¼Œç”¨äºæŠ½è±¡å­˜å‚¨ç»†èŠ‚ã€‚ç®¡ç†å‘˜å…³æ³¨äºå¦‚ä½•é€šè¿‡pvæä¾›å­˜å‚¨åŠŸèƒ½è€Œæ— éœ€å…³æ³¨ç”¨æˆ·å¦‚ä½•ä½¿ç”¨ï¼ŒåŒæ ·çš„ç”¨æˆ·åªéœ€è¦æŒ‚è½½pvcåˆ°å®¹å™¨ä¸­è€Œä¸éœ€è¦å…³æ³¨å­˜å‚¨å·é‡‡ç”¨ä½•ç§æŠ€æœ¯å®ç°ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;pvcå’Œpvçš„å…³ç³»ä¸podå’Œnodeå…³ç³»ç±»ä¼¼ï¼Œå‰è€…æ¶ˆè€—åè€…çš„èµ„æºã€‚pvcå¯ä»¥å‘pvç”³è¯·æŒ‡å®šå¤§å°çš„å­˜å‚¨èµ„æºå¹¶è®¾ç½®è®¿é—®æ¨¡å¼,è¿™å°±å¯ä»¥é€šè¿‡Provision -&gt; Claim çš„æ–¹å¼ï¼Œæ¥å¯¹å­˜å‚¨èµ„æºè¿›è¡Œæ§åˆ¶ã€‚</p><h2 id="2ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#2ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2ã€ç”Ÿå‘½å‘¨æœŸ"></a>2ã€ç”Ÿå‘½å‘¨æœŸ</h2><p>pvå’Œpvcéµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š</p><ul><li>ä¾›åº”å‡†å¤‡ã€‚é€šè¿‡é›†ç¾¤å¤–çš„å­˜å‚¨ç³»ç»Ÿæˆ–è€…äº‘å¹³å°æ¥æä¾›å­˜å‚¨æŒä¹…åŒ–æ”¯æŒã€‚</li></ul><ul><li><p>é™æ€æä¾›ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¤šä¸ªPVï¼Œä¾›PVCä½¿ç”¨ã€‚</p></li><li><p>åŠ¨æ€æä¾›ï¼šåŠ¨æ€åˆ›å»ºPVCç‰¹å®šçš„PVï¼Œå¹¶ç»‘å®šã€‚</p><ul><li>ç»‘å®šã€‚ç”¨æˆ·åˆ›å»ºpvcå¹¶æŒ‡å®šéœ€è¦çš„èµ„æºå’Œè®¿é—®æ¨¡å¼ã€‚åœ¨æ‰¾åˆ°å¯ç”¨pvä¹‹å‰ï¼Œpvcä¼šä¿æŒæœªç»‘å®šçŠ¶æ€ã€‚</li><li>ä½¿ç”¨ã€‚ç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvcã€‚</li><li>é‡Šæ”¾ã€‚ç”¨æˆ·åˆ é™¤pvcæ¥å›æ”¶å­˜å‚¨èµ„æºï¼Œpvå°†å˜æˆâ€œreleasedâ€çŠ¶æ€ã€‚ç”±äºè¿˜ä¿ç•™ç€ä¹‹å‰çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†ï¼Œå¦åˆ™è¿™äº›å­˜å‚¨èµ„æºæ— æ³•è¢«å…¶ä»–pvcä½¿ç”¨ã€‚</li><li>å›æ”¶(Reclaiming)ã€‚pvå¯ä»¥è®¾ç½®ä¸‰ç§å›æ”¶ç­–ç•¥ï¼šä¿ç•™ï¼ˆRetainï¼‰ï¼Œå›æ”¶ï¼ˆRecycleï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</li></ul></li><li><p>ä¿ç•™ç­–ç•¥ï¼šå…è®¸äººå·¥å¤„ç†ä¿ç•™çš„æ•°æ®ã€‚</p></li><li><p>åˆ é™¤ç­–ç•¥ï¼šå°†åˆ é™¤pvå’Œå¤–éƒ¨å…³è”çš„å­˜å‚¨èµ„æºï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</p></li><li><p>å›æ”¶ç­–ç•¥ï¼šå°†æ‰§è¡Œæ¸…é™¤æ“ä½œï¼Œä¹‹åå¯ä»¥è¢«æ–°çš„pvcä½¿ç”¨ï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</p></li></ul><blockquote><p><em>ç›®å‰åªæœ‰NFSå’ŒHostPathç±»å‹å·æ”¯æŒå›æ”¶ç­–ç•¥ï¼ŒAWS EBS,GCE PD,Azure Diskå’ŒCinderæ”¯æŒåˆ é™¤(Delete)ç­–ç•¥ã€‚</em></p></blockquote><h3 id="2-1ã€Provisioning"><a href="#2-1ã€Provisioning" class="headerlink" title="2.1ã€Provisioning"></a>2.1ã€Provisioning</h3><p>ä¸¤ç§æ–¹å¼æä¾›çš„PVèµ„æºä¾›ç»™</p><a id="more"></a><p>static</p><ul><li>é€šè¿‡é›†ç¾¤ç®¡ç†è€…åˆ›å»ºå¤šä¸ªPVï¼Œä¸ºé›†ç¾¤â€œä½¿ç”¨è€…â€æä¾›å­˜å‚¨èƒ½åŠ›è€Œéšè—çœŸå®å­˜å‚¨çš„ç»†èŠ‚ã€‚å¹¶ä¸”å­˜åœ¨äºkubenretes apiä¸­ï¼Œå¯è¢«ç›´æ¥ä½¿ç”¨ã€‚</li></ul><p>dynamic</p><ul><li>åŠ¨æ€å·ä¾›ç»™æ˜¯kubernetesç‹¬æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¸€åŠŸèƒ½å…è®¸æŒ‰éœ€åˆ›å»ºå­˜å‚¨å»ºã€‚åœ¨æ­¤ä¹‹å‰ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦äº‹å…ˆåœ¨é›†ç¾¤å¤–ç”±å­˜å‚¨æä¾›è€…æˆ–è€…äº‘æä¾›å•†åˆ›å»º</li><li>å­˜å‚¨å·ï¼ŒæˆåŠŸä¹‹åå†åˆ›å»ºPersistentVolumeå¯¹è±¡ï¼Œæ‰èƒ½å¤Ÿåœ¨kubernetesä¸­ä½¿ç”¨ã€‚åŠ¨æ€å·ä¾›ç»™èƒ½è®©é›†ç¾¤ç®¡ç†å‘˜ä¸å¿…è¿›è¡Œé¢„å…ˆåˆ›å»ºå­˜å‚¨å·ï¼Œè€Œæ˜¯éšç€ç”¨æˆ·éœ€æ±‚è¿›è¡Œåˆ›å»ºã€‚åœ¨1.5ç‰ˆæœ¬æé«˜äº†åŠ¨æ€å·çš„å¼¹æ€§å’Œå¯ç”¨æ€§ã€‚</li></ul><h2 id="3ã€PVç±»å‹"><a href="#3ã€PVç±»å‹" class="headerlink" title="3ã€PVç±»å‹"></a>3ã€PVç±»å‹</h2><p>pvæ”¯æŒä»¥ä¸‹ç±»å‹:</p><pre><code>* GCEPersistentDisk
* AWSElasticBlockStore
* NFS
* iSCSI
* RBD (Ceph Block Device)
* Glusterfs
* AzureFile
* AzureDisk
* CephFS
* cinder
* FC
* FlexVolume
* Flocker
* PhotonPersistentDisk
* Quobyte
* VsphereVolume
* HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</code></pre><h3 id="3-1ã€PVå±æ€§"><a href="#3-1ã€PVå±æ€§" class="headerlink" title="3.1ã€PVå±æ€§"></a>3.1ã€PVå±æ€§</h3><ul><li>è®¿é—®æ¨¡å¼,ä¸pvçš„è¯­ä¹‰ç›¸åŒã€‚åœ¨è¯·æ±‚èµ„æºæ—¶ä½¿ç”¨ç‰¹å®šæ¨¡å¼ã€‚</li><li>èµ„æº,ç”³è¯·çš„å­˜å‚¨èµ„æºæ•°é¢ã€‚</li></ul><h3 id="3-2ã€PVå·é˜¶æ®µçŠ¶æ€"><a href="#3-2ã€PVå·é˜¶æ®µçŠ¶æ€" class="headerlink" title="3.2ã€PVå·é˜¶æ®µçŠ¶æ€"></a>3.2ã€PVå·é˜¶æ®µçŠ¶æ€</h3><ul><li>Available â€“ èµ„æºå°šæœªè¢«claimä½¿ç”¨</li><li>Bound â€“ å·å·²ç»è¢«ç»‘å®šåˆ°claimäº†</li><li>Released â€“ claimè¢«åˆ é™¤ï¼Œå·å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æœªè¢«é›†ç¾¤å›æ”¶ã€‚</li><li>Failed â€“ å·è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><h2 id="4ã€åˆ©ç”¨nfsåˆ›å»ºpv-pvc"><a href="#4ã€åˆ©ç”¨nfsåˆ›å»ºpv-pvc" class="headerlink" title="4ã€åˆ©ç”¨nfsåˆ›å»ºpv_pvc"></a>4ã€åˆ©ç”¨nfsåˆ›å»ºpv_pvc</h2><p>å‡†å¤‡ä¸€å°æœºå™¨ï¼Œæ­å»ºNFSæœåŠ¡ï¼Œnfsæ­å»ºè¿™é‡Œä¸é˜è¿°ï¼Œ</p><h3 id="4-1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv"><a href="#4-1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv" class="headerlink" title="4.1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv"></a>4.1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat pv.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: opspv</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/jenkins</span><br><span class="line">    server: 172.21.16.236</span><br><span class="line"><span class="comment"># kubectl create -f pv.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure><h3 id="4-2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc"><a href="#4-2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc" class="headerlink" title="4.2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc"></a>4.2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat pvc.yaml</span></span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: opspv</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line"><span class="comment"># kubectl create -f pvc.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pvc</span></span><br></pre></td></tr></table></figure><h3 id="4-3ã€åˆ›å»ºpodæŒ‚è½½pv-pvc"><a href="#4-3ã€åˆ›å»ºpodæŒ‚è½½pv-pvc" class="headerlink" title="4.3ã€åˆ›å»ºpodæŒ‚è½½pv_pvc"></a>4.3ã€åˆ›å»ºpodæŒ‚è½½pv_pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-deployment.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: jenkins2</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins</span><br><span class="line">        image: jenkins/jenkins:lts</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: web</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 50000</span><br><span class="line">          name: agent</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 512Mi</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: jenkinshome</span><br><span class="line">          subPath: jenkins2</span><br><span class="line">          mountPath: /var/jenkins_home</span><br><span class="line">        env:</span><br><span class="line">        - name: LIMITS_MEMORY</span><br><span class="line">          valueFrom:</span><br><span class="line">            resourceFieldRef:</span><br><span class="line">              resource: limits.memory</span><br><span class="line">              divisor: 1Mi</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx$(LIMITS_MEMORY)m -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85 -Duser.timezone=Asia/Shanghai</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">      volumes:</span><br><span class="line">      - name: jenkinshome</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: opspvc</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  labels:</span><br><span class="line">    app: jenkins2</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: jenkins2</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30002</span><br><span class="line">  - name: agent</span><br><span class="line">    port: 50000</span><br><span class="line">    targetPort: agent</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <tags>
        <tag>pvc,pv,kubernetes,å­˜å‚¨</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes å•æœºå®‰è£…</title>
    <url>/2019/08/12/kubernetes-%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h2 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1.ç¯å¢ƒå‡†å¤‡"></a>1.ç¯å¢ƒå‡†å¤‡</h2><blockquote><p>ä¸€ä¸ªmasterèŠ‚ç‚¹ï¼Œå››ä¸ªnodeèŠ‚ç‚¹<br>masterèŠ‚ç‚¹ip</p><ul><li>172.21.16.244<br>nodeèŠ‚ç‚¹ip</li><li>172.21.16.24</li><li>172.21.16.231</li><li>172.21.16.202</li><li>172.21.16.55</li></ul></blockquote><ul><li>ä»¥ä¸‹æ˜¯æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå‡è¿›è¡Œæ“ä½œ</li></ul><h2 id="2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº"><a href="#2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº" class="headerlink" title="2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº"></a>2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">  http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="3ã€é‡æ–°å»ºç«‹yumç¼“å­˜"><a href="#3ã€é‡æ–°å»ºç«‹yumç¼“å­˜" class="headerlink" title="3ã€é‡æ–°å»ºç«‹yumç¼“å­˜"></a>3ã€é‡æ–°å»ºç«‹yumç¼“å­˜</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install epel-release &amp;&amp;yum clean all &amp;&amp;yum makecach</span></span><br></pre></td></tr></table></figure><ul><li>è®°å¾—åŒæ­¥ç³»ç»Ÿçš„æ—¶é—´</li></ul><h2 id="3ã€é…ç½®è½¬å‘è¯·æ±‚"><a href="#3ã€é…ç½®è½¬å‘è¯·æ±‚" class="headerlink" title="3ã€é…ç½®è½¬å‘è¯·æ±‚"></a>3ã€é…ç½®è½¬å‘è¯·æ±‚</h2><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">å…³é—­swap</span><br><span class="line"><span class="comment"># sudo swapoff -a</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># sysctl --system</span></span><br></pre></td></tr></table></figure><h2 id="4ã€å®‰è£…docker"><a href="#4ã€å®‰è£…docker" class="headerlink" title="4ã€å®‰è£…docker"></a>4ã€å®‰è£…docker</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install docker</span></span><br><span class="line"><span class="comment"># systemctl enable docker &amp;&amp; systemctl start docker</span></span><br></pre></td></tr></table></figure><h2 id="5ã€å®‰è£…k8s-éœ€è¦çš„æ’ä»¶"><a href="#5ã€å®‰è£…k8s-éœ€è¦çš„æ’ä»¶" class="headerlink" title="5ã€å®‰è£…k8s éœ€è¦çš„æ’ä»¶"></a>5ã€å®‰è£…k8s éœ€è¦çš„æ’ä»¶</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install kubelet kubeadm kubectl kubernetes-cni</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet &amp;&amp; systemctl start kubelet</span></span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ä¸º kubelet ä¸ºCgroupæ¨¡å¼</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CGROUP_ARGS=--cgroup-driver=systemd"</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure><h2 id="6ã€æ‹‰å–é•œåƒ"><a href="#6ã€æ‹‰å–é•œåƒ" class="headerlink" title="6ã€æ‹‰å–é•œåƒ"></a>6ã€æ‹‰å–é•œåƒ</h2><p>æ–°å»ºä¸€ä¸ªshell æ‹‰å–é•œåƒåˆ°æœ¬åœ°(æ‰€æœ‰èŠ‚ç‚¹å‡æ“ä½œ)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">images=(kube-proxy:v1.13.0 kube-scheduler:v1.13.0 kube-controller-manager:v1.13.0 kube-apiserver:v1.13.0 etcd:3.2.24 coredns:1.2.6 pause:3.1 kubernetes-dashboard-amd64:v1.10.0 kubernetes-dashboard-init-amd64:v1.0.1  k8s-dns-sidecar-amd64:1.14.9 k8s-dns-kube-dns-amd64:1.14.9 k8s-dns-dnsmasq-nanny:1.15.0 heapster:v1.5.2 kubernetes-dashboard-arm:v1.10.0)</span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">docker pull xxlaila/<span class="variable">$imageName</span></span><br><span class="line">docker tag xxlaila/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">docker rmi xxlaila/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>ä»¥ä¸‹æ“ä½œæ˜¯åœ¨k8sçš„masterè¿›è¡Œæ“ä½œ</li></ul><h2 id="7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ"><a href="#7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ" class="headerlink" title="7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ"></a>7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm init --kubernetes-version=v1.13.0 --pod-network-cidr=10.244.0.0/16</span></span><br><span class="line"><span class="comment"># è®°ä¸‹è¿™å¥è¯ï¼Œåé¢nodeèŠ‚ç‚¹åŠ å…¥éœ€è¦</span></span><br><span class="line"><span class="comment"># kubeadm join 172.21.17.4:6443 --token 0mdk7x.du3cn19qm1jl2b0e --discovery-token-ca-cert-hash sha256:19bf79b41a931735b1f2f5138e1daa436ab26a4f19781ccf2015cff749ddb4b9</span></span><br></pre></td></tr></table></figure><h3 id="7-1ã€æ‰§è¡Œåˆ›å»ºç›®å½•"><a href="#7-1ã€æ‰§è¡Œåˆ›å»ºç›®å½•" class="headerlink" title="7.1ã€æ‰§è¡Œåˆ›å»ºç›®å½•"></a>7.1ã€æ‰§è¡Œåˆ›å»ºç›®å½•</h3><p>åé¢åœ¨ç”Ÿæˆè¯ä¹¦çš„æ—¶å€™éœ€è¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><h3 id="7-2ã€æŸ¥çœ‹éªŒè¯"><a href="#7-2ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="7.2ã€æŸ¥çœ‹éªŒè¯"></a>7.2ã€æŸ¥çœ‹éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatus</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br><span class="line"><span class="comment"># kubectl get cs</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="8ã€å®‰è£…flannel-ç½‘ç»œ"><a href="#8ã€å®‰è£…flannel-ç½‘ç»œ" class="headerlink" title="8ã€å®‰è£…flannel ç½‘ç»œ"></a>8ã€å®‰è£…flannel ç½‘ç»œ</h2><blockquote><p>(é…ç½®æ–‡ä»¶å’Œç›®å½•æ¯ä¸ªnodeéƒ½è¦å»ºç«‹)</p></blockquote><h3 id="8-1-åˆ›å»ºflannelé…ç½®æ–‡ä»¶"><a href="#8-1-åˆ›å»ºflannelé…ç½®æ–‡ä»¶" class="headerlink" title="8.1 åˆ›å»ºflannelé…ç½®æ–‡ä»¶"></a>8.1 åˆ›å»ºflannelé…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/cni/net.d/</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF&gt; /etc/cni/net.d/10-flannel.conf</span></span><br><span class="line">&#123;</span><br><span class="line">â€œnameâ€: â€œcbr0â€,</span><br><span class="line">â€œ<span class="built_in">type</span>â€: â€œflannelâ€,</span><br><span class="line">â€œdelegateâ€: &#123;</span><br><span class="line">â€œisDefaultGatewayâ€: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="8-2-åˆ›å»ºç½‘ç»œé…ç½®"><a href="#8-2-åˆ›å»ºç½‘ç»œé…ç½®" class="headerlink" title="8.2 åˆ›å»ºç½‘ç»œé…ç½®"></a>8.2 åˆ›å»ºç½‘ç»œé…ç½®</h3><blockquote><p>(åªéœ€è¦åœ¨ä¸»èŠ‚ç‚¹æ“ä½œå³å¯)</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-amd64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-ppc64le created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-s390x created</span><br></pre></td></tr></table></figure><h2 id="9ã€æŸ¥çœ‹å‘½åç©ºé—´"><a href="#9ã€æŸ¥çœ‹å‘½åç©ºé—´" class="headerlink" title="9ã€æŸ¥çœ‹å‘½åç©ºé—´"></a>9ã€æŸ¥çœ‹å‘½åç©ºé—´</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get ns</span></span><br><span class="line">NAME          STATUS   AGE</span><br><span class="line">default       Active   27m</span><br><span class="line">kube-public   Active   27m</span><br><span class="line">kube-system   Active   27m</span><br></pre></td></tr></table></figure><h2 id="10ã€æŸ¥çœ‹systemçš„pod"><a href="#10ã€æŸ¥çœ‹systemçš„pod" class="headerlink" title="10ã€æŸ¥çœ‹systemçš„pod"></a>10ã€æŸ¥çœ‹systemçš„pod</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-86c58d9df4-4gfvd                     1/1     Running   0          27m</span><br><span class="line">coredns-86c58d9df4-cxtz5                     1/1     Running   0          27m</span><br><span class="line">etcd-k8s-zxc-test-3.kxl                      1/1     Running   0          26m</span><br><span class="line">kube-apiserver-k8s-zxc-test-3.kxl            1/1     Running   0          26m</span><br><span class="line">kube-controller-manager-k8s-zxc-test-3.kxl   1/1     Running   0          26m</span><br><span class="line">kube-flannel-ds-nh95x                        1/1     Running   0          15m</span><br><span class="line">kube-proxy-kvlng                             1/1     Running   0          27m</span><br><span class="line">kube-scheduler-k8s-zxc-test-3.kxl            1/1     Running   0          27m</span><br></pre></td></tr></table></figure><h2 id="11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter"><a href="#11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter" class="headerlink" title="11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter"></a>11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter</h2><ul><li>ä»¥ä¸‹æ˜¯æ¯ä¸ªnodeèŠ‚ç‚¹æ‰§è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm join 172.21.17.4:6443 --token 0mdk7x.du3cn19qm1jl2b0e --discovery-token-ca-cert-hash sha256:19bf79b41a931735b1f2f5138e1daa436ab26a4f19781ccf2015cff749ddb4b9</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦åŠ å…¥</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨kubectl get podså‘½ä»¤æ¥æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€</span></span><br><span class="line"><span class="comment"># kubectl get pods --all-namespaces</span></span><br></pre></td></tr></table></figure><h2 id="12ã€å®‰è£…kubernetes-dashboard"><a href="#12ã€å®‰è£…kubernetes-dashboard" class="headerlink" title="12ã€å®‰è£…kubernetes dashboard"></a>12ã€å®‰è£…kubernetes dashboard</h2><p>ä¸‹è½½å®˜ç½‘çš„dashboardæ–‡ä»¶ä¿®æ”¹kubernetes-dashboard.yamlæ–‡ä»¶,ç”¨ä¿®æ”¹ä¹‹åçš„kubernetes-dashboard.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»ºdashboard</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/kubernetes-dashboard</span></span><br><span class="line"><span class="comment"># kubectl apply -f kubernetes-dashboard.yaml</span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br></pre></td></tr></table></figure><h2 id="13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ"><a href="#13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ" class="headerlink" title="13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ"></a>13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system</span></span><br></pre></td></tr></table></figure><h3 id="13-1ã€æŸ¥çœ‹dashboard-info"><a href="#13-1ã€æŸ¥çœ‹dashboard-info" class="headerlink" title="13.1ã€æŸ¥çœ‹dashboard info"></a>13.1ã€æŸ¥çœ‹dashboard info</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe svc kubernetes-dashboard -n kube-system</span></span><br></pre></td></tr></table></figure><h3 id="13-2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹"><a href="#13-2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹" class="headerlink" title="13.2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹"></a>13.2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get pods -n kube-system -o wide</span></span><br></pre></td></tr></table></figure><h3 id="13-3ã€æŸ¥çœ‹service-èŠ‚ç‚¹ç«¯å£"><a href="#13-3ã€æŸ¥çœ‹service-èŠ‚ç‚¹ç«¯å£" class="headerlink" title="13.3ã€æŸ¥çœ‹service èŠ‚ç‚¹ç«¯å£"></a>13.3ã€æŸ¥çœ‹service èŠ‚ç‚¹ç«¯å£</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get service -n kube-system -o wide</span></span><br></pre></td></tr></table></figure><h3 id="13-4ã€åˆ›å»ºdashboard-admin-è´¦æˆ·"><a href="#13-4ã€åˆ›å»ºdashboard-admin-è´¦æˆ·" class="headerlink" title="13.4ã€åˆ›å»ºdashboard admin è´¦æˆ·"></a>13.4ã€åˆ›å»ºdashboard admin è´¦æˆ·</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f admin-user.yaml</span></span><br><span class="line">è·å–tokens</span><br><span class="line"><span class="comment"># kubectl describe serviceaccount admin -n kube-system</span></span><br><span class="line">Name:                admin</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:         kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                       &#123;<span class="string">"apiVersion"</span>:<span class="string">"v1"</span>,<span class="string">"kind"</span>:<span class="string">"ServiceAccount"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"labels"</span>:&#123;<span class="string">"k8s-app"</span>:<span class="string">"kubernetes-dashboard"</span>&#125;,<span class="string">"name"</span>:<span class="string">"admin"</span>,<span class="string">"namesp...</span></span><br><span class="line"><span class="string">Image pull secrets:  &lt;none&gt;</span></span><br><span class="line"><span class="string">Mountable secrets:   admin-token-kxs6k</span></span><br><span class="line"><span class="string">Tokens:              admin-token-kxs6k</span></span><br><span class="line"><span class="string">Events:              &lt;none&gt;</span></span><br><span class="line"><span class="string">æŸ¥çœ‹token ä¿¡æ¯</span></span><br><span class="line"><span class="string"># kubectl describe secret admin-token-kxs6k -n kube-system</span></span><br></pre></td></tr></table></figure><h2 id="14ã€dashboard-è®¿é—®"><a href="#14ã€dashboard-è®¿é—®" class="headerlink" title="14ã€dashboard è®¿é—®"></a>14ã€dashboard è®¿é—®</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ©ç”¨èŠ‚ç‚¹ip+30001 ç«¯å£è¿›è¡Œè®¿é—®ã€‚è®¿é—®ä¹‹å‰éœ€è¦åœ¨masterèŠ‚ç‚¹ç”Ÿæˆè¯ä¹¦ï¼ŒæŠŠè¯ä¹¦(kubecfg.p12)ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè¿›è¡Œå¯¼å…¥åˆ°æµè§ˆå™¨ï¼Œè¿™é‡Œä½¿ç”¨ç«ç‹æµè§ˆå™¨ï¼Œgoogleæµè§ˆå™¨å¯¼å…¥,ä¸æˆåŠŸï¼Œç”Ÿäº§è¯ä¹¦ä¹‹å‰è®°å¾—ç¬¬9æ­¥å·²æ“ä½œ</p><h3 id="14-1ã€ç”Ÿæˆè¯ä¹¦"><a href="#14-1ã€ç”Ÿæˆè¯ä¹¦" class="headerlink" title="14.1ã€ç”Ÿæˆè¯ä¹¦"></a>14.1ã€ç”Ÿæˆè¯ä¹¦</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grep 'client-certificate-data' ~/.kube/config | head -n 1 | awk '&#123;print $2&#125;' | base64 -d &gt;&gt; kubecfg.crt</span></span><br><span class="line"><span class="comment"># grep 'client-key-data' ~/.kube/config | head -n 1 | awk '&#123;print $2&#125;' | base64 -d &gt;&gt; kubecfg.key</span></span><br><span class="line"><span class="comment"># openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name "kubernetes-client"</span></span><br></pre></td></tr></table></figure><h3 id="14-2ã€dashboard-é…ç½®ä¿®æ”¹"><a href="#14-2ã€dashboard-é…ç½®ä¿®æ”¹" class="headerlink" title="14.2ã€dashboard é…ç½®ä¿®æ”¹"></a>14.2ã€dashboard é…ç½®ä¿®æ”¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;kubernetes dashboard v1.10.0ä½¿ç”¨çš„æ˜¯åŒå› å­ç™»é™†ï¼Œé»˜è®¤tokenå¤±æ•ˆçš„æ—¶é—´æ˜¯900ç§’ï¼Œ15åˆ†é’Ÿï¼Œæ¯15åˆ†é’Ÿå°±è¦è¿›è¡Œä¸€æ¬¡è®¤è¯ã€‚æˆ‘ä»¬å¯ä»¥åŠŸè¿‡ä¿®æ”¹token-ttlå‚æ•°æ¥è®¾ç½®ï¼Œä¸»è¦æ˜¯ä¿®æ”¹dashboard.yamlæ–‡ä»¶ï¼Œå¹¶é‡æ–°å»ºç«‹å³å¯</p><ul><li>åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ·»åŠ <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- containerPort: 8443</span><br><span class="line">  protocol: TCP</span><br><span class="line">args:</span><br><span class="line">  - --auto-generate-certificates</span><br><span class="line">  - --token-ttl=43200</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>é‡å»ºdashboard,é€šè¿‡åˆ©ç”¨httpæ·»åŠ ç«¯å£30001ï¼Œç„¶ååˆ©ç”¨tonkenè¿›è¡ŒéªŒè¯ç™»é™†,å®‰è£…å¤±è´¥æ¸…ç†ç¯å¢ƒ</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm reset</span></span><br><span class="line">æŸ¥çœ‹åŠ å…¥é›†ç¾¤token</span><br><span class="line"><span class="comment"># kubeadm token list</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos 5.5 å®‰è£…DRBD</title>
    <url>/2019/08/11/Centos-5-5-%E5%AE%89%E8%A3%85DRBD/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>Centos5.5 32bitå®‰è£…DRBD</p><ul><li>å®‰è£…å‰å‡†å¤‡</li></ul><table><thead><tr><th>èŠ‚ç‚¹ç±»å‹</th><th>IPåœ°å€è§„åˆ’</th><th>ä¸»æœºå</th></tr></thead><tbody><tr><td>ä¸»ç”¨èŠ‚ç‚¹</td><td>192.168.1.101</td><td>node2</td></tr><tr><td>å¤‡ç”¨èŠ‚ç‚¹</td><td>192.168.1.102</td><td>node1</td></tr><tr><td>ç£ç›˜</td><td>ä¸¤å°10Gç£ç›˜</td><td></td></tr></tbody></table><h2 id="åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD"><a href="#åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD" class="headerlink" title="åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD"></a>åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># yum -y install kmod-drbd83 drbd83</span></span><br></pre></td></tr></table></figure><p>å®‰è£…æˆåŠŸä¹‹å/sbinç›®å½•ä¸‹é¢æœ‰drbdadmï¼Œdrbdmetaï¼Œdrbdsetupå‘½ä»¤ï¼Œä»¥åŠ/etc /init.d/drbdå¯åŠ¨è„šæœ¬ã€‚</p><ul><li>å¤‡ç”¨èŠ‚ç‚¹å®‰è£…DRBD</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># yum -y install kmod-drbd83 drbd83</span></span><br></pre></td></tr></table></figure><blockquote><p>å®‰è£…å®Œæˆåã€‚é»˜è®¤é…ç½®æ–‡ä»¶/etc/drbd.confï¼Œä»¥ä¸‹æ˜¯ä¸¤å°çš„ä¸»æœºé…ç½®å®ä¾‹:</p></blockquote><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># cat /etc/drbd.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># please have a a look at the example configuration file in</span></span><br><span class="line"><span class="comment"># /usr/share/doc/drbd83/drbd.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># drbd.conf</span></span><br><span class="line"><span class="comment"># create by dba.gao@gmail.com at 2010-10-11</span></span><br><span class="line">global &#123;</span><br><span class="line">    <span class="comment"># minor-count 64;</span></span><br><span class="line">    <span class="comment"># dialog-refresh 5; # 5 seconds</span></span><br><span class="line">    <span class="comment"># disable-ip-verification;</span></span><br><span class="line">usage-count no; <span class="comment">#æ˜¯å¦å‚åŠ DRBDä½¿ç”¨è€…ç»Ÿè®¡ï¼Œé»˜è®¤yes</span></span><br><span class="line">&#125;</span><br><span class="line">common &#123;</span><br><span class="line">    syncer &#123; rate <span class="comment">#è®¾ç½®ä¸»å¤‡èŠ‚ç‚¹åŒæ­¥æ—¶çš„ç½‘ç»œé€Ÿç‡æœ€å¤§å€¼ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚</span></span><br><span class="line">        200M; &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource r0 &#123;</span><br><span class="line">protocol C;</span><br><span class="line"><span class="comment"># ä½¿ç”¨drbdçš„ç¬¬ä¸‰ç§åŒæ­¥åè®®,è¡¨ç¤ºæ”¶åˆ°è¿œç¨‹ä¸»æœºçš„å†™å…¥ç¡®è®¤å,åˆ™è®¤ä¸ºå†™å…¥å®Œæˆ</span></span><br><span class="line">handlers &#123;</span><br><span class="line">    pri-on-incon-degr <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">    pri-lost-after-sb <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">    <span class="built_in">local</span>-io-error <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">fence-peer <span class="string">"/usr/lib64/heartbeat/drbd-peer-outdater -t 5"</span>;</span><br><span class="line">pri-lost <span class="string">"echo pri-lost. Have a look at the log files. | mail -s 'DRBD Alert' root"</span>;</span><br><span class="line">    split-brain <span class="string">"/usr/lib/drbd/notify-split-brain.sh root"</span>;</span><br><span class="line">    out-of-sync <span class="string">"/usr/lib/drbd/notify-out-of-sync.sh root"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">net &#123;</span><br><span class="line"><span class="comment"># timeout 60;</span></span><br><span class="line"><span class="comment"># connect-int 10;</span></span><br><span class="line"><span class="comment"># ping-int 10;</span></span><br><span class="line"><span class="comment"># max-buffers 2048;</span></span><br><span class="line"><span class="comment"># max-epoch-size 2048;</span></span><br><span class="line">cram-hmac-alg <span class="string">"sha1"</span>;</span><br><span class="line">shared-secret <span class="string">"MySQL-HA"</span>;</span><br><span class="line"><span class="comment"># DRBDåŒæ­¥æ—¶ä½¿ç”¨çš„éªŒè¯æ–¹å¼å’Œå¯†ç ä¿¡æ¯ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line">disk &#123;</span><br><span class="line">    on-io-error detach;</span><br><span class="line">fencing resource-only;</span><br><span class="line">&#125;</span><br><span class="line">startup &#123;</span><br><span class="line">    wfc-timeout 120;</span><br><span class="line">    degr-wfc-timeout 120;</span><br><span class="line">  &#125;</span><br><span class="line">  device        /dev/drbd0;</span><br><span class="line"><span class="comment">#è¿™é‡Œé…ç½®æ¡£æˆ‘ä»¬æŒ‚åœ¨çš„ç³»ç»Ÿçš„ç£ç›˜æ ‡ç¤ºé©±åŠ¨ç›˜ç¬¦; on node2 &#123;</span></span><br><span class="line"><span class="comment">#æ¯ä¸ªä¸»æœºçš„è¯´æ˜ä»¥onå¼€å¤´,åé¢æ˜¯hostname(uname - n)ï¼Œåœ¨åé¢çš„&#123;&#125;ä¸­ä¸ºè¿™ä¸ªä¸»æœºçš„é…ç½®ã€‚</span></span><br><span class="line">disk /dev/sdb5;</span><br><span class="line"><span class="comment">#/dev/drbd0ä½¿ç”¨çš„ç£ç›˜åˆ†åŒºæ˜¯/dev/sdb5</span></span><br><span class="line">address     192.168.1.101:7788;</span><br><span class="line">IPåœ°å€ä»¥åŠDRBDä½¿ç”¨çš„ç«¯å£ meta-disk internal;</span><br><span class="line">&#125;</span><br><span class="line">on node1 &#123;</span><br><span class="line">disk /dev/sdb5;</span><br><span class="line">address 192.168.1.102:7788; å’Œä¸Šè¿°ä¸€æ ·</span><br><span class="line">meta-disk internal; <span class="comment">#drbdçš„å…ƒæ•°æ®å­˜æ”¾æ–¹å¼ &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆåå¯åŠ¨èŠ‚ç‚¹ï¼Œåœ¨å¯åŠ¨DRBDä¹‹å‰,ä½ éœ€è¦åˆ†åˆ«åœ¨ä¸¤å°ä¸»æœºçš„hdåˆ†åŒºä¸Š,åˆ›å»ºä¾›DRBDè®°å½•ä¿¡æ¯çš„æ•°æ®å—.åˆ†åˆ«åœ¨ä¸¤å°ä¸»æœºä¸Šæ‰§è¡Œ(è¿™é‡Œæ³¨æ„:åœ¨åˆ›å»ºåˆ†åŒºä¹‹å‰æˆ‘ä»¬éœ€è¦å§ç£ç›˜çš„åˆ†åŒºåˆ†å¥½)</p><p><img src alt="img"></p><p>åˆ†åŒºåˆ†å¥½ä»¥åå…ˆä¸è¦æŒ‚åœ¨å’Œæ ¼å¼åŒ–(æŒ‚åœ¨ä»¥ååˆ›å»ºä¼šæŠ¥é”™)ï¼Œç„¶ååˆ›å»ºä¾›DRBDè®° å½•ä¿¡æ¯çš„æ•°æ®å—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># drbdadm create-md r0</span></span><br><span class="line">[root@node1 ~]<span class="comment"># drbdadm create-md r0</span></span><br><span class="line">æˆ–è€…æ‰§è¡Œdrbdadm create-md all</span><br></pre></td></tr></table></figure><ul><li><p>åœ¨ä¸¤ä¸ªèŠ‚ç‚¹å¯åŠ¨æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># /etc/init.d/drbd start</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /etc/init.d/drbd start</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨ä»»æ„èŠ‚ç‚¹æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</p></li></ul><blockquote><p>1: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C râ€”-<br>ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:2007644</p></blockquote><blockquote><p>å¯¹è¾“å‡ºçš„å«ä¹‰è§£é‡Šå¦‚ä¸‹:<br>roè¡¨ç¤ºè§’è‰²ä¿¡æ¯ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨drbdæ—¶ï¼Œä¸¤ä¸ªdrbdèŠ‚ç‚¹é»˜è®¤éƒ½å¤„äºSecondaryçŠ¶æ€,<br>dsæ˜¯ç£ç›˜çŠ¶æ€ä¿¡æ¯ï¼Œâ€œInconsistent/Inconsistenâ€ï¼Œå³ä¸ºâ€œä¸ä¸€è‡´/ä¸ä¸€è‡´â€ çŠ¶æ€ï¼Œè¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹çš„ç£ç›˜æ•°æ®å¤„äºä¸ä¸€è‡´çŠ¶æ€ã€‚<br>Nsè¡¨ç¤ºç½‘ç»œå‘é€çš„æ•°æ®åŒ…ä¿¡æ¯ã€‚</p></blockquote><h3 id="è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2"><a href="#è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2" class="headerlink" title="è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2"></a>è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># drbdsetup /dev/drbd1 primary â€“o æˆ–è€…æ‰§è¡Œä¸‹é¢å‘½ä»¤ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line">[root@node2 ~]<span class="comment">#drbdadm -- --overwrite-data-of-peer primary all</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæ­¤å‘½ä»¤åï¼Œåœ¨åé¢å¦‚æœéœ€è¦è®¾ç½®å“ªä¸ªæ˜¯ä¸»èŠ‚ç‚¹æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨å¦ å¤–ä¸€ä¸ªå‘½ä»¤:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment">#/sbin/drbdadm primary r0æˆ–è€…/sbin/drbdadm primary all</span></span><br></pre></td></tr></table></figure><blockquote><p>æ‰§è¡Œæ­¤å‘½ä»¤åï¼Œå¼€å§‹åŒæ­¥ä¸¤å°æœºå™¨å¯¹åº”ç£ç›˜çš„æ•°æ®</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ node2 ~]<span class="comment">#cat /proc/drbd</span></span><br><span class="line">1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r--- -</span><br><span class="line">ns:576224 nr:0 dw:0 dr:581760 al:0 bm:34 lo:84 pe:369 ua:256 ap:0 ep:1 wo:b oos:1443196</span><br><span class="line">[====&gt;...............] sync<span class="string">'ed: 28.4% (1443196/2007644)K delay_probe: 69</span></span><br><span class="line"><span class="string">finish: 0:03:56 speed: 6,024 (5,876) K/sec</span></span><br></pre></td></tr></table></figure><blockquote><p>æœ€åæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ,ç”±äºmountæ“ä½œåªèƒ½åœ¨ä¸»èŠ‚ç‚¹è¿›è¡Œï¼Œæ‰€ä»¥åªæœ‰è®¾ç½®äº†ä¸»èŠ‚ç‚¹åæ‰èƒ½æ ¼å¼åŒ–ç£ç›˜åˆ† åŒºï¼Œç„¶åæŒ‚è½½:</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># mkfs -t ext3 /dev/drbd0</span></span><br><span class="line">[root@node2 ~]<span class="comment"># mount /dev/drbd0 /data/</span></span><br><span class="line">[root@node2 ~]<span class="comment"># df -h</span></span><br><span class="line">Filesystem</span><br><span class="line">/dev/sda3</span><br><span class="line">/dev/sda1</span><br><span class="line">tmpfs</span><br><span class="line">/dev/drbd0</span><br><span class="line">Size  Used Avail Use% Mounted on</span><br><span class="line"> 28G  3.7G   23G  15% /</span><br><span class="line">487M   22M  440M   5% /boot</span><br><span class="line">125M     0  125M   0% /dev/shm</span><br><span class="line">9.9G  151M  9.2G   2% /data</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;Dwæ˜¯ç£ç›˜å†™ä¿¡æ¯;Dræ˜¯ç£ç›˜è¯»ä¿¡æ¯;å¯åŠ¨DRBDåè®¾ç½®ä¸»æ¬¡èŠ‚ç‚¹ï¼Œé€‰æ‹©éœ€è¦è®¾ç½®ä¸»æœºçš„ä¸»èŠ‚ç‚¹ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤: è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>å­˜å‚¨,Centos</category>
      </categories>
      <tags>
        <tag>drdb</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle ORA-12519</title>
    <url>/2019/08/10/oracle-ORA-12519/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><blockquote><p>oracle ORA-12519é”™è¯¯è§£å†³<br>ä»Šå¤©é‡åˆ°åšç³»ç»Ÿå‹åŠ›æµ‹è¯•çš„æ—¶å€™ï¼Œç³»ç»ŸæŠ¥äº†ä¸€ä¸ªé”™è¯¯<br>OERR: ORA-12519 TNS:no appropriate service handler found</p></blockquote><p><img src="https://img.xxlaila.cn/ORA-12519-error.png" alt="img"></p><p>åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€ä¸‹oralcçš„é”™è¯¯ä¿¡æ¯ORA-12519ï¼Œè§£å†³åŠæ³•æŒºå¤šçš„ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p><h3 id="ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“"><a href="#ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“" class="headerlink" title="ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“"></a>ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlplus <span class="string">"/as sysdba"</span></span><br></pre></td></tr></table></figure><blockquote><p>é¦–å…ˆæ£€æŸ¥processå’Œsessionçš„ä½¿ç”¨æƒ…å†µ</p></blockquote><p><img src="https://img.xxlaila.cn/parameter_%20processes_1.png" alt="img"><br><img src="https://img.xxlaila.cn/parameter_%20session_3.png" alt="img"></p><a id="more"></a><ul><li>è¿™é‡Œå¯ä»¥çœ‹åˆ°processå‡ ä¹å·²ç»æ»¡äº†</li></ul><h3 id="ä¿®æ”¹oracleçš„processå’Œsessionå€¼"><a href="#ä¿®æ”¹oracleçš„processå’Œsessionå€¼" class="headerlink" title="ä¿®æ”¹oracleçš„processå’Œsessionå€¼"></a>ä¿®æ”¹oracleçš„processå’Œsessionå€¼</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œæˆ‘ä»¬æŠŠè¿™äº›å€¼ä¿®æ”¹ä¸º1000å’Œ1135</span><br><span class="line">SQL&gt; alter system <span class="built_in">set</span> processes=1000 scope=spfile;</span><br><span class="line">ç³»ç»Ÿå·²æ›´æ”¹ã€‚</span><br><span class="line">SQL&gt; alter system <span class="built_in">set</span> sessions=1135 scope=spfile;</span><br><span class="line">ç³»ç»Ÿå·²æ›´æ”¹ã€‚</span><br></pre></td></tr></table></figure><h3 id="é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ"><a href="#é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ" class="headerlink" title="é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ"></a>é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; shutdown abort;</span><br><span class="line">ORACLE ä¾‹ç¨‹å·²ç»å…³é—­ã€‚</span><br><span class="line">SQL&gt; startup;</span><br><span class="line">ORACLE ä¾‹ç¨‹å·²ç»å¯åŠ¨ã€‚</span><br><span class="line">Total System Global Area  534462464 bytes</span><br><span class="line">Fixed Size                  2215064 bytes</span><br><span class="line">Variable Size             234881896 bytes</span><br><span class="line">Database Buffers          289406976 bytes</span><br><span class="line">Redo Buffers                7958528 bytes</span><br><span class="line">æ•°æ®åº“è£…è½½å®Œæ¯•ã€‚</span><br><span class="line">æ•°æ®åº“å·²ç»æ‰“å¼€ã€‚</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹å¹¶éªŒè¯"><a href="#æŸ¥çœ‹å¹¶éªŒè¯" class="headerlink" title="æŸ¥çœ‹å¹¶éªŒè¯"></a>æŸ¥çœ‹å¹¶éªŒè¯</h2><p><img src="https://img.xxlaila.cn/W.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>oracle</category>
      </categories>
      <tags>
        <tag>ORA-12519</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx https</title>
    <url>/2019/08/10/nginx-https/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>nginx http å¼ºåˆ¶è·³è½¬åˆ°https</p><h2 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$server_port</span> = 80 ) &#123;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$server_port</span> = 80 ) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123; <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>; &#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$host</span> != xxx.test.com) &#123; <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://xxx.test.com<span class="variable">$request_uri</span>; &#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123; <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$host</span> != xxx.test.com) &#123; <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://xxx.test.com<span class="variable">$request_uri</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•å››"><a href="#æ–¹æ³•å››" class="headerlink" title="æ–¹æ³•å››"></a>æ–¹æ³•å››</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    rewrite ^(.*) https://www.test.com<span class="variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¾‹å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    rewrite ^(.*) https://www.test.com<span class="variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    root ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•äº”"><a href="#æ–¹æ³•äº”" class="headerlink" title="æ–¹æ³•äº”"></a>æ–¹æ³•äº”</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>https</tag>
      </tags>
  </entry>
  <entry>
    <title>haproxy keepalived </title>
    <url>/2019/08/10/haproxy-keepalived/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>æœ¬æ–‡ä¸»è¦æ˜¯ä»£ç†kubernetes masterçš„é«˜å¯ç”¨ã€‚</p><h2 id="å®‰è£…haproxyå’Œkeepalived"><a href="#å®‰è£…haproxyå’Œkeepalived" class="headerlink" title="å®‰è£…haproxyå’Œkeepalived"></a>å®‰è£…haproxyå’Œkeepalived</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install keepalived.x86_64</span></span><br><span class="line"><span class="comment"># yum -y install haproxy18u.x86_64</span></span><br></pre></td></tr></table></figure><h2 id="2ã€é…ç½®haproxy"><a href="#2ã€é…ç½®haproxy" class="headerlink" title="2ã€é…ç½®haproxy"></a>2ã€é…ç½®haproxy</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/haproxy/haproxy.cfg</span></span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  uid 99</span><br><span class="line">  gid 99</span><br><span class="line">  <span class="comment">#daemon</span></span><br><span class="line">  nbproc 1</span><br><span class="line">  pidfile haproxy.pid</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  retries 3</span><br><span class="line">  timeout connect 5s</span><br><span class="line">  timeout client 30s</span><br><span class="line">  timeout server 30s</span><br><span class="line">  timeout check 2s</span><br><span class="line"></span><br><span class="line">listen admin_stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:1080</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  stats refresh 30s</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    admin:admin1</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats admin <span class="keyword">if</span> TRUE</span><br><span class="line"></span><br><span class="line">frontend k8s-https</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  default_backend k8s-http</span><br><span class="line"></span><br><span class="line">backend k8s-http</span><br><span class="line">  mode tcp</span><br><span class="line">  balance roundrobin</span><br><span class="line">  server k8s-master-01 172.21.17.4:6443</span><br><span class="line">  server k8s-master-02 172.21.16.230:6443</span><br><span class="line">  server k8s-master-03 172.21.240:6443</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="3ã€keepalivedé…ç½®"><a href="#3ã€keepalivedé…ç½®" class="headerlink" title="3ã€keepalivedé…ç½®"></a>3ã€keepalivedé…ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  notification_email &#123;</span><br><span class="line">    cq_xxlaila@163.com</span><br><span class="line">    &#125;</span><br><span class="line">  notification_email_from cq_xxlaila@163.com</span><br><span class="line">  smtp_server 127.0.0.1</span><br><span class="line">  smtp_connect_timeout 30</span><br><span class="line">  router_id haproxy-01</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/haproxy_check.sh"</span></span><br><span class="line">  interval 2</span><br><span class="line">  timeout 2</span><br><span class="line">  fall 3</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    dont_track_primary</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass 57D0BC82E074C9D6</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      172.21.16.45</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç›‘æµ‹è„šæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat haproxy_check.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">A=`ps -C haproxy --no-header | wc -l`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$A</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    systemctl start haproxy</span><br><span class="line">    sleep 3</span><br><span class="line">    <span class="keyword">if</span> [ `ps -C haproxy --no-header | wc -l ` -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        systemctl stop haproxy</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æœåŠ¡</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl enable haproxy &amp;&amp;systemctl enable keepalived</span></span><br><span class="line"><span class="comment"># systemctl start keepalived &amp;&amp;systemctl start haproxy</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>haproxy,keepalived,kubernetes</category>
      </categories>
      <tags>
        <tag>haproxy,keepalived</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s-prometheus</title>
    <url>/2019/08/10/k8s-prometheus/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p><a href="https://prometheus.io/" target="_blank" rel="noopener">Prometheus</a>æ˜¯ä¸€ä¸ªé›†æ•°æ®æ”¶é›†å­˜å‚¨ã€æ•°æ®æŸ¥è¯¢å’Œæ•°æ®å›¾è¡¨æ˜¾ç¤ºäºä¸€èº«çš„å¼€æºç›‘æ§ç»„ä»¶ã€‚æœ¬æ–‡ä¸»è¦è®²è§£å¦‚ä½•æ­å»ºPrometheusï¼Œå¹¶ä½¿ç”¨å®ƒç›‘æ§Kubernetesé›†ç¾¤ã€‚</p><h2 id="1ã€ä¸‹è½½ç›¸å…³yaml"><a href="#1ã€ä¸‹è½½ç›¸å…³yaml" class="headerlink" title="1ã€ä¸‹è½½ç›¸å…³yaml"></a>1ã€ä¸‹è½½ç›¸å…³yaml</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/xxlaila/kubernetes-yaml/tree/master/prometheus-grafana</span></span><br><span class="line"><span class="comment"># ls -l</span></span><br><span class="line">configmap.yaml</span><br><span class="line">grafana-deploy.yaml</span><br><span class="line">grafana-ingress.yaml</span><br><span class="line">grafana-svc.yaml</span><br><span class="line">node-exporter.yaml</span><br><span class="line">prometheus-deploy.yaml</span><br><span class="line">prometheus-svc.yaml</span><br><span class="line">rbac-setup.yaml</span><br><span class="line">prometheus-ingress.yaml</span><br></pre></td></tr></table></figure><h2 id="2ã€å¼€å§‹éƒ¨ç½²"><a href="#2ã€å¼€å§‹éƒ¨ç½²" class="headerlink" title="2ã€å¼€å§‹éƒ¨ç½²"></a>2ã€å¼€å§‹éƒ¨ç½²</h2><h3 id="2-1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶"><a href="#2-1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶" class="headerlink" title="2.1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶"></a>2.1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f  node-exporter.yaml</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2-2ã€éƒ¨ç½²prometheusç»„ä»¶"><a href="#2-2ã€éƒ¨ç½²prometheusç»„ä»¶" class="headerlink" title="2.2ã€éƒ¨ç½²prometheusç»„ä»¶"></a>2.2ã€éƒ¨ç½²prometheusç»„ä»¶</h3><h4 id="2-2-1ã€rbacæ–‡ä»¶"><a href="#2-2-1ã€rbacæ–‡ä»¶" class="headerlink" title="2.2.1ã€rbacæ–‡ä»¶"></a>2.2.1ã€rbacæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f rbac-setup.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶"><a href="#2-2-2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶" class="headerlink" title="2.2.2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶"></a>2.2.2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f configmap.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3ã€Prometheus-deployment-æ–‡ä»¶"><a href="#2-2-3ã€Prometheus-deployment-æ–‡ä»¶" class="headerlink" title="2.2.3ã€Prometheus deployment æ–‡ä»¶"></a>2.2.3ã€Prometheus deployment æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f  prometheus-deploy.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-4ã€Prometheus-serviceæ–‡ä»¶"><a href="#2-2-4ã€Prometheus-serviceæ–‡ä»¶" class="headerlink" title="2.2.4ã€Prometheus serviceæ–‡ä»¶"></a>2.2.4ã€Prometheus serviceæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f prometheus-svc.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-5ã€é…ç½®Ingress"><a href="#2-2-5ã€é…ç½®Ingress" class="headerlink" title="2.2.5ã€é…ç½®Ingress"></a>2.2.5ã€é…ç½®Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f prometheus-ingress.yaml</span></span><br></pre></td></tr></table></figure><h3 id="2-3ã€éƒ¨ç½²grafanaç»„ä»¶"><a href="#2-3ã€éƒ¨ç½²grafanaç»„ä»¶" class="headerlink" title="2.3ã€éƒ¨ç½²grafanaç»„ä»¶"></a>2.3ã€éƒ¨ç½²grafanaç»„ä»¶</h3><h4 id="2-3-1ã€grafana-deploymenté…ç½®æ–‡ä»¶"><a href="#2-3-1ã€grafana-deploymenté…ç½®æ–‡ä»¶" class="headerlink" title="2.3.1ã€grafana deploymenté…ç½®æ–‡ä»¶"></a>2.3.1ã€grafana deploymenté…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-deploy.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-3-2ã€grafana-serviceé…ç½®æ–‡ä»¶"><a href="#2-3-2ã€grafana-serviceé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.2ã€grafana serviceé…ç½®æ–‡ä»¶"></a>2.3.2ã€grafana serviceé…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-svc.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-3-3ã€grafana-ingressé…ç½®æ–‡ä»¶"><a href="#2-3-3ã€grafana-ingressé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.3ã€grafana ingressé…ç½®æ–‡ä»¶"></a>2.3.3ã€grafana ingressé…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-ingress.yaml</span></span><br></pre></td></tr></table></figure><h3 id="2-4ã€WEBç•Œé¢é…ç½®"><a href="#2-4ã€WEBç•Œé¢é…ç½®" class="headerlink" title="2.4ã€WEBç•Œé¢é…ç½®"></a>2.4ã€WEBç•Œé¢é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc,pods -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/46ds9824.png" alt="img"></p><h4 id="2-4-1-æŸ¥çœ‹node-exporter"><a href="#2-4-1-æŸ¥çœ‹node-exporter" class="headerlink" title="2.4.1 æŸ¥çœ‹node-exporter"></a>2.4.1 æŸ¥çœ‹node-exporter</h4><p><img src="https://img.xxlaila.cn/8764kjfnks.png" alt="img"></p><h4 id="2-4-2ã€æŸ¥çœ‹promethues"><a href="#2-4-2ã€æŸ¥çœ‹promethues" class="headerlink" title="2.4.2ã€æŸ¥çœ‹promethues"></a>2.4.2ã€æŸ¥çœ‹promethues</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;prometheuså¯¹åº”çš„nodeportç«¯å£ä¸º30005ï¼Œé€šè¿‡è®¿é—®<a href="http://172.21.17.4:30005/targets" target="_blank" rel="noopener">http://172.21.17.4:30005/targets</a> å¯ä»¥çœ‹åˆ°prometheuså·²ç»æˆåŠŸè¿æ¥ä¸Šäº†k8sçš„apiserver,è¿™é‡Œæˆ‘ä»¬å‰é¢å¢åŠ äº†prometheusçš„ingressï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥é€šè¿‡åŸŸåè¿›è¡Œè®¿é—®</p><p><img src="https://img.xxlaila.cn/skd9234342.png" alt="img"></p><h4 id="2-4-3ã€è®¿é—®grafana"><a href="#2-4-3ã€è®¿é—®grafana" class="headerlink" title="2.4.3ã€è®¿é—®grafana"></a>2.4.3ã€è®¿é—®grafana</h4><p>é€šè¿‡åŸŸåè®¿é—®grafanaï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç å‡ä¸ºadminï¼Œé…ç½®æ•°æ®æº<br><img src="https://img.xxlaila.cn/sld023423.png" alt="img"></p><ul><li>åˆ°grafanaå®˜æ–¹<a href="https://grafana.com/dashboards/315" target="_blank" rel="noopener">ä¸‹è½½æ¨¡ç‰ˆ</a>ï¼Œå¯¼å…¥jsonæ¨¡ç‰ˆ</li></ul><p><img src="https://img.xxlaila.cn/kf24skdsfds.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>kubednsæ’ä»¶é…ç½®</title>
    <url>/2019/08/10/kubedns%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h1 id="å®‰è£…å’Œé…ç½®kubednsæ’ä»¶"><a href="#å®‰è£…å’Œé…ç½®kubednsæ’ä»¶" class="headerlink" title="å®‰è£…å’Œé…ç½®kubednsæ’ä»¶"></a>å®‰è£…å’Œé…ç½®kubednsæ’ä»¶</h1><h2 id="1ã€é…ç½®æ–‡ä»¶å‡†å¤‡"><a href="#1ã€é…ç½®æ–‡ä»¶å‡†å¤‡" class="headerlink" title="1ã€é…ç½®æ–‡ä»¶å‡†å¤‡"></a>1ã€é…ç½®æ–‡ä»¶å‡†å¤‡</h2><p>ä¸‹è½½å®˜æ–¹çš„yamlæ–‡ä»¶ç›®å½•ï¼škubernetes/cluster/addons/dnsã€‚è¯¥æ’ä»¶ç›´æ¥ä½¿ç”¨kuberneteséƒ¨ç½²,yamlæ–‡ä»¶ç»è¿‡ä¿®æ”¹å®Œæˆéƒ¨ç½²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/coredns</span></span><br><span class="line"><span class="comment"># sed -i 's/10.96.0.10/10.254.0.2/g' coredns-service.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods,svc,rs -n kube-system</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-68676b6b88-l7b5g   1/1     Running   0          16m</span><br><span class="line"></span><br><span class="line">NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/coredns   ClusterIP   10.254.0.2   &lt;none&gt;        53/UDP,53/TCP   16m</span><br><span class="line"></span><br><span class="line">NAME                                       DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.extensions/coredns-68676b6b88   1         1         1       16m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-68676b6b88-l7b5g                1/1     Running   0          40m     10.254.28.2   172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…å’Œé…ç½®dashboard"><a href="#2ã€å®‰è£…å’Œé…ç½®dashboard" class="headerlink" title="2ã€å®‰è£…å’Œé…ç½®dashboard"></a>2ã€å®‰è£…å’Œé…ç½®dashboard</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;å®˜æ–¹é…ç½®æ–‡ä»¶kubernetes/cluster/addons/dashboardï¼Œè¿™é‡Œå·²ç»ä¿®æ”¹è¿‡äº†ï¼Œç»è¿‡æµ‹è¯•éƒ¨ç½²ï¼Œç›´æ¥è¿›å…¥dashboardç›®å½•ï¼Œä¿®æ”¹inageså‚æ•°è¿›è¡Œéƒ¨ç½²</p><a id="more"></a><h3 id="2-1ã€å®‰è£…dashboard"><a href="#2-1ã€å®‰è£…dashboard" class="headerlink" title="2.1ã€å®‰è£…dashboard"></a>2.1ã€å®‰è£…dashboard</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ../kubernetes-dashboard</span></span><br><span class="line"><span class="comment"># kubectl create -f kubernetes-dashboard.yaml </span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">kubernetes-dashboard-6c655d9445-4557x   1/1     Running   0          6m54s   10.254.90.2   172.21.16.110   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="2-2ã€é…ç½®è´¦æˆ·æˆæƒ"><a href="#2-2ã€é…ç½®è´¦æˆ·æˆæƒ" class="headerlink" title="2.2ã€é…ç½®è´¦æˆ·æˆæƒ"></a>2.2ã€é…ç½®è´¦æˆ·æˆæƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f admin-user.yaml </span></span><br><span class="line">serviceaccount/admin created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin created</span><br><span class="line"><span class="comment"># kubectl describe serviceaccount admin -n kube-system</span></span><br><span class="line">Name:                admin</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   admin-token-wwjw8</span><br><span class="line">Tokens:              admin-token-wwjw8</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"><span class="comment"># kubectl describe secret admin-token-wwjw8 -n kube-system</span></span><br><span class="line">åœ¨æµè§ˆå™¨è®¿é—®ä»»æ„èŠ‚ç‚¹IPåœ°å€http://&lt;node_ip&gt;:30001</span><br></pre></td></tr></table></figure><h2 id="3ã€ç›‘æ§å®‰è£…"><a href="#3ã€ç›‘æ§å®‰è£…" class="headerlink" title="3ã€ç›‘æ§å®‰è£…"></a>3ã€ç›‘æ§å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ../heapster-influxdb-grafana</span></span><br><span class="line"><span class="comment"># kubectl create -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE   IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">heapster-658646db69-lh5tx               1/1     Running   0          11m   10.254.28.3   172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">monitoring-grafana-7bfc56ffcd-kgh56     1/1     Running   0          11m   10.254.90.3   172.21.16.110   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">monitoring-influxdb-7478d7675c-9255v    1/1     Running   0          11m   10.254.85.2   172.21.16.244   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé‡åˆ°ä¸€ä¸ªæ€ªäº‹æƒ…ï¼›heapsterå®‰è£…ä»¥åå›¾å§‹ç»ˆæ— æ³•å‡ºæ¥ï¼Œè¿™é‡ŒæŠ˜è…¾å·®ä¸å¤šå¤§åŠå¤©ã€‚æœ€ååœ¨dashboardçš„yamlæ–‡ä»¶é‡Œé¢æ·»åŠ äº†ä»¥ä¸‹å‚æ•°ï¼Œå›¾å°±å¯ä»¥äº†ï¼Œ</p><p><img src="https://img.xxlaila.cn/4udfs93.png" alt="img"></p><p>args:<br>- â€“auto-generate-certificates<br>- â€“token-ttl=43200<br><em>- â€“heapster-host=<a href="http://heapster" target="_blank" rel="noopener">http://heapster</a></em></p><p><img src="https://img.xxlaila.cn/ds832948dk.png" alt="img"></p><p>Prometheusçš„å®‰è£…è¯·å‚è€ƒ<a href="http://xxlaila.github.io/2019/08/10/k8s-prometheus/" target="_blank" rel="noopener">ã€ŠPrometheus å…¥é—¨ã€‹</a>æ–‡ç« ï¼Œgrafanaä¸éœ€è¦é‡å¤éƒ¨ç½²ã€‚åªéœ€è¦åœ¨grafanaé‡Œé¢å¢åŠ ç›®å½•æŒ‚åœ¨ï¼Œå§kube-ops ä¿®æ”¹kube-systemå³å¯</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kube-dns,dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes nodeèŠ‚ç‚¹å®‰è£…</title>
    <url>/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>More: <a href="https://xxlaila.github.io/2019/08/09/kubernetes-v1-13-3%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">masterèŠ‚ç‚¹å®‰è£…è¯·å‚è€ƒ</a></p><h2 id="1ã€éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹"><a href="#1ã€éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹" class="headerlink" title="1ã€éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹"></a>1ã€éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹</h2><p>Kubernetes nodeèŠ‚ç‚¹åŒ…å«å¦‚ä¸‹ç»„ä»¶ï¼š</p><ul><li><strong>Flanneld</strong>: ä¹‹å‰å•æœºèŠ‚ç‚¹å®‰è£…æ²¡æœ‰é…ç½®TLSï¼Œç°åœ¨éœ€è¦åœ¨serviceé…ç½®æ–‡ä»¶ä¸­å¢åŠ TLSé…ç½®</li><li><strong>Docker</strong>: version 18.06.2-ce</li><li><strong>kubelet</strong></li><li><strong>kube-proxy</strong></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls /etc/kubernetes/</span></span><br><span class="line">bootstrap.kubeconfig  kubelet   kube-proxy.kubeconfig  proxy  ssl</span><br><span class="line"><span class="comment"># ls /etc/kubernetes/ssl</span></span><br><span class="line">admin-key.pem  kube-apiserver-key.pem  kube-controller-manager-key.pem  kubelet-api-admin-key.pem   kube-proxy-key.pem  kubernetes-ca-key.pem  kube-scheduler-key.pem</span><br><span class="line">admin.pem      kube-apiserver.pem      kube-controller-manager.pem      kubelet-api-admin.pem       kube-proxy.pem      kubernetes-ca.pem      kube-scheduler.pem</span><br></pre></td></tr></table></figure><h3 id="å¢åŠ docker-æº"><a href="#å¢åŠ docker-æº" class="headerlink" title="å¢åŠ docker æº"></a>å¢åŠ docker æº</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum-config-manager \</span></span><br><span class="line">  --add-repo \</span><br><span class="line">  https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><ul><li><p>æ ¹æ®å®é™…æŸ¥æ‰¾å½“å‰ç‰ˆæœ¬ (å¯é€‰)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum list docker-ce --showduplicates | sort -r</span></span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœç¡®å®šäº†ç‰ˆæœ¬,ç›´æ¥å®‰è£…,å¦‚æœè¦è£…17ã€‚03ç›´æ¥ä¿®æ”¹ä¸‹é¢æ•°å­—å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install docker-ce-18.06.2.ce-3.el7  # ä¸»æ„ç‰ˆæœ¬å¡«å†™åŒ…åçš„æ ¼å¼.</span></span><br></pre></td></tr></table></figure></li><li><p>å¯dockeræœåŠ¡,å’Œå¼€æœºå¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="1-1ã€å®‰è£…flanneld"><a href="#1-1ã€å®‰è£…flanneld" class="headerlink" title="1.1ã€å®‰è£…flanneld"></a>1.1ã€å®‰è£…flanneld</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mv kubernetes  /etc/ &amp;&amp; chown -R root: /etc/kubernetes</span></span><br><span class="line"><span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf flannel-v0.11.0-linux-amd64.tar.gz &amp;&amp; mv flanneld mk-docker-opts.sh /usr/bin/ &amp;&amp; rm -rf flannel-v0.11.0-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><h4 id="1-1-1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶"><a href="#1-1-1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶" class="headerlink" title="1.1.1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶"></a>1.1.1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/flanneld.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=etcd.service</span><br><span class="line">Before=docker.service</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/etc/sysconfig/flanneld</span><br><span class="line">ExecStart=/usr/bin/flanneld -etcd-endpoints=<span class="variable">$&#123;FLANNEL_ETCD&#125;</span> <span class="variable">$FLANNEL_OPTIONS</span></span><br><span class="line">ExecStartPost=/usr/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">RequiredBy=docker.service</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-1-2ã€flanneldé…ç½®æ–‡ä»¶"><a href="#1-1-2ã€flanneldé…ç½®æ–‡ä»¶" class="headerlink" title="1.1.2ã€flanneldé…ç½®æ–‡ä»¶"></a>1.1.2ã€flanneldé…ç½®æ–‡ä»¶</h4><p>flanneld é…ç½®æ–‡ä»¶è¿æ¥äº†etcdï¼Œè€Œåœ¨é…ç½®etcdçš„æ—¶å€™éœ€è¦è¯ä¹¦ï¼Œæ‰€ä»¥è®°çš„å§è¯ä¹¦copyåˆ°nodeèŠ‚ç‚¹ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/sysconfig/flanneld</span></span><br><span class="line"><span class="comment"># Flanneld configuration options</span></span><br><span class="line"><span class="comment"># etcd url location.  Point this to the server where etcd runs</span></span><br><span class="line">FLANNEL_ETCD=<span class="string">"https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379"</span></span><br><span class="line"><span class="comment"># etcd config key.  This is the configuration key that flannel queries</span></span><br><span class="line"><span class="comment"># For address range assignment</span></span><br><span class="line">FLANNEL_ETCD_PREFIX=<span class="string">"/coreos.com/network"</span></span><br><span class="line"><span class="comment"># Any additional options that you want to pass</span></span><br><span class="line">FLANNEL_OPTIONS=<span class="string">"-etcd-cafile=/etc/etcd/ssl/etcd-ca.pem -etcd-certfile=/etc/etcd/ssl/etcd.pem -etcd-keyfile=/etc/etcd/ssl/etcd-key.pem"</span></span><br></pre></td></tr></table></figure><ul><li>åœ¨å¯åŠ¨flanneldä¹‹å‰ï¼Œéœ€è¦åœ¨etcdä¸­æ·»åŠ ä¸€æ¡ç½‘ç»œé…ç½®è®°å½•ï¼Œè¿™ä¸ªé…ç½®å°†ç”¨äºflanneldåˆ†é…ç»™æ¯ä¸ªdockerçš„è™šæ‹Ÿipåœ°å€æ®µ,</li><li>åœ¨ä»»æ„ä¸€å°masteræ‰§è¡Œ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl set /coreos.com/network/config '&#123; "Network": "10.254.0.0/16" &#125;'</span></span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"10.254.0.0/16"</span> &#125;</span><br><span class="line"><span class="comment"># etcdctl get  /coreos.com/network/config </span></span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"10.254.0.0/16"</span> &#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰§è¡Œçš„æ—¶å€™æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºå‰é¢etcdæ˜¯å¯ç”¨äº†httpsçš„ï¼Œå¦åˆ™çš„è¯ï¼Œä¼šæŠ¥<code>Error: client: etcd cluster is unavailable or misconfigured; error #0: x509: certificate signed by unknown authority</code>çš„é”™è¯¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcd.rc</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_ENDPOINT=https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CERT_FILE=/etc/etcd/ssl/etcd.pem</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_KEY_FILE=/etc/etcd/ssl/etcd-key.pem</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CA_FILE=/etc/etcd/ssl/etcd-ca.pem</span><br></pre></td></tr></table></figure><h3 id="1-1-3ã€å¯åŠ¨flanneld"><a href="#1-1-3ã€å¯åŠ¨flanneld" class="headerlink" title="1.1.3ã€å¯åŠ¨flanneld"></a>1.1.3ã€å¯åŠ¨flanneld</h3><p>åœ¨å¯åŠ¨flanneldä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹dockerçš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/docker.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable flanneld &amp;&amp;systemctl start flanneld &amp;&amp;systemctl status flanneld</span></span><br></pre></td></tr></table></figure><p>é‡å¯äº†dockerå’Œflanneldä»¥åï¼Œæˆ‘ä»¬åœ¨ä»»æ„ä¸€å°nodeèŠ‚ç‚¹ä¸Šé€šè¿‡ip add så¯ä»¥æŸ¥çœ‹ã€‚flanneld å’Œdocker ç½‘ç»œç»‘å®šçš„æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip add s</span></span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…å’Œé…ç½®kubelet"><a href="#2ã€å®‰è£…å’Œé…ç½®kubelet" class="headerlink" title="2ã€å®‰è£…å’Œé…ç½®kubelet"></a>2ã€å®‰è£…å’Œé…ç½®kubelet</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;kubeletå¯åŠ¨æ—¶å‘kube-apiserverå‘é€tls bootstrappingè¯·æ±‚ï¼Œéœ€è¦å°†bootstrap tokenæ–‡ä»¶ä¸­kube-bootsrapç”¨æˆ·æˆäºˆsystem:node-bootstrapper clusterè§’è‰²ï¼ˆroleï¼‰ï¼Œç„¶åkubeletæ‰èƒ½æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚ï¼ˆcertificate signing requestsï¼‰</p><h3 id="2-1ã€å®‰è£…kubelet"><a href="#2-1ã€å®‰è£…kubelet" class="headerlink" title="2.1ã€å®‰è£…kubelet"></a>2.1ã€å®‰è£…kubelet</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.13.3/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzf kubernetes-server-linux-amd64.tar.gz &amp;&amp;cp -r ./kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; /usr/bin/ &amp;&amp; rm -rf ./kubernetes*</span></span><br></pre></td></tr></table></figure><h3 id="2-2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶"><a href="#2-2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶" class="headerlink" title="2.2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶"></a>2.2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kubelet.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kubelet</span><br><span class="line">ExecStart=/usr/bin/kubelet \</span><br><span class="line">           <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">           <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">           <span class="variable">$KUBELET_API_SERVER</span> \</span><br><span class="line">           <span class="variable">$KUBELET_ADDRESS</span> \</span><br><span class="line">           <span class="variable">$KUBELET_PORT</span> \</span><br><span class="line">           <span class="variable">$KUBELET_HOSTNAME</span> \</span><br><span class="line">           <span class="variable">$KUBE_ALLOW_PRIV</span> \</span><br><span class="line">           <span class="variable">$KUBELET_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="2-3ã€kubeleté…ç½®æ–‡ä»¶"><a href="#2-3ã€kubeleté…ç½®æ–‡ä»¶" class="headerlink" title="2.3ã€kubeleté…ç½®æ–‡ä»¶"></a>2.3ã€kubeleté…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kubelet</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes kubelet (minion) config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span></span><br><span class="line">KUBELET_ADDRESS=<span class="string">"--node-ip=&#123;node_ip&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The port for the info server to serve on</span></span><br><span class="line"><span class="comment"># KUBELET_PORT="--port=10250"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may leave this blank to use the actual hostname</span></span><br><span class="line">KUBELET_HOSTNAME=<span class="string">"--hostname-override=&#123;node_ip&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># location of the api-server</span></span><br><span class="line"><span class="comment"># KUBELET_API_SERVER=""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBELET_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                --allow-privileged \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --authorization-mode=Webhook \</span></span><br><span class="line"><span class="string">                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --cgroup-driver=cgroupfs \</span></span><br><span class="line"><span class="string">                --cert-dir=/etc/kubernetes/ssl \</span></span><br><span class="line"><span class="string">                --cluster-dns=10.254.0.2 \</span></span><br><span class="line"><span class="string">                --cluster-domain=cluster.local \</span></span><br><span class="line"><span class="string">                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% \</span></span><br><span class="line"><span class="string">                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m \</span></span><br><span class="line"><span class="string">                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% \</span></span><br><span class="line"><span class="string">                --eviction-max-pod-grace-period=30 \</span></span><br><span class="line"><span class="string">                --image-gc-high-threshold=80 \</span></span><br><span class="line"><span class="string">                --image-gc-low-threshold=70 \</span></span><br><span class="line"><span class="string">                --image-pull-progress-deadline=30s \</span></span><br><span class="line"><span class="string">                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">                --max-pods=100 \</span></span><br><span class="line"><span class="string">                --minimum-image-ttl-duration=720h0m0s \</span></span><br><span class="line"><span class="string">                --node-labels=node.kubernetes.io/k8s-node=true \</span></span><br><span class="line"><span class="string">                --pod-infra-container-image=docker.io/kubernetes/pause:latest \</span></span><br><span class="line"><span class="string">                --port=10250 \</span></span><br><span class="line"><span class="string">                --read-only-port=0 \</span></span><br><span class="line"><span class="string">                --rotate-certificates \</span></span><br><span class="line"><span class="string">                --rotate-server-certificates \</span></span><br><span class="line"><span class="string">                --fail-swap-on=false \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure><h3 id="2-4ã€å¯åŠ¨kubelet"><a href="#2-4ã€å¯åŠ¨kubelet" class="headerlink" title="2.4ã€å¯åŠ¨kubelet"></a>2.4ã€å¯åŠ¨kubelet</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /var/lib/kubelet -p</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet &amp;&amp;systemctl start kubelet &amp;&amp; systemctl status kubelet</span></span><br><span class="line"><span class="comment"># journalctl -fxeu kubelet</span></span><br></pre></td></tr></table></figure><h2 id="3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚"><a href="#3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚" class="headerlink" title="3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚"></a>3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚</h2><p>kubeleté¦–æ¬¡å¯åŠ¨æ—¶åƒkube-apiserverå‘é€è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œå¿…é¡»é€šè¿‡åkubernetesç³»ç»Ÿæ‰ä¼šå°†è¯¥nodeåŠ å…¥é›†ç¾¤ï¼š</p><h3 id="3-1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚"><a href="#3-1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚" class="headerlink" title="3.1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚"></a>3.1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚</h3><ul><li>ä»»æ„masterèŠ‚ç‚¹å‡å¯</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE   REQUESTOR                   CONDITION</span><br><span class="line">csr-kxfql                                              78m   system:node:172.21.16.204   Pending</span><br><span class="line">node-csr-QptfMgAu2y4GmUZX1Ph9B0XomA0Rg-fxcgs0Yzd-XRU   79m   system:bootstrap:ff90fd     Approved,Issued</span><br><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure><h3 id="3-2ã€é€šè¿‡csrè¯·æ±‚"><a href="#3-2ã€é€šè¿‡csrè¯·æ±‚" class="headerlink" title="3.2ã€é€šè¿‡csrè¯·æ±‚"></a>3.2ã€é€šè¿‡csrè¯·æ±‚</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl certificate approve csr-kxfql</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-kxfql approved</span><br></pre></td></tr></table></figure><ul><li>è‡ªåŠ¨ç”Ÿæˆkubelet kubeconfigæ–‡ä»¶å’Œå…¬ç§é’¥,æ–°ç‰ˆæœ¬ kubelet server çš„è¯ä¹¦è‡ªåŠ¨ç­¾å‘å·²ç»è¢«å…³é—­,æ‰€ä»¥å¯¹äº kubelet server çš„è¯ä¹¦ä»éœ€è¦æ‰‹åŠ¨ç­¾ç½²</li></ul><h2 id="4ã€é…ç½®kube-proxy"><a href="#4ã€é…ç½®kube-proxy" class="headerlink" title="4ã€é…ç½®kube-proxy"></a>4ã€é…ç½®kube-proxy</h2><h3 id="4-1ã€kupe-proxy-å¯åŠ¨æ–‡ä»¶"><a href="#4-1ã€kupe-proxy-å¯åŠ¨æ–‡ä»¶" class="headerlink" title="4.1ã€kupe-proxy å¯åŠ¨æ–‡ä»¶"></a>4.1ã€kupe-proxy å¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-proxy.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/proxy</span><br><span class="line">ExecStart=/usr/bin/kube-proxy \</span><br><span class="line">       <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">       <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">       <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">       <span class="variable">$KUBE_PROXY_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="4-2ã€kube-proxyé…ç½®æ–‡ä»¶"><a href="#4-2ã€kube-proxyé…ç½®æ–‡ä»¶" class="headerlink" title="4.2ã€kube-proxyé…ç½®æ–‡ä»¶"></a>4.2ã€kube-proxyé…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/proxy</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes proxy config</span></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_PROXY_ARGS=<span class="string">"   --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                    --cleanup-ipvs=true \</span></span><br><span class="line"><span class="string">                    --cluster-cidr=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                    --hostname-override=docker4.node \</span></span><br><span class="line"><span class="string">                    --healthz-bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                    --healthz-port=10256 \</span></span><br><span class="line"><span class="string">                    --masquerade-all=true \</span></span><br><span class="line"><span class="string">                    --proxy-mode=ipvs \</span></span><br><span class="line"><span class="string">                    --ipvs-min-sync-period=5s \</span></span><br><span class="line"><span class="string">                    --ipvs-sync-period=5s \</span></span><br><span class="line"><span class="string">                    --ipvs-scheduler=wrr \</span></span><br><span class="line"><span class="string">                    --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \</span></span><br><span class="line"><span class="string">                    --logtostderr=true \</span></span><br><span class="line"><span class="string">                    --v=2"</span></span><br></pre></td></tr></table></figure><h3 id="4-3ã€å¯åŠ¨kube-proxy"><a href="#4-3ã€å¯åŠ¨kube-proxy" class="headerlink" title="4.3ã€å¯åŠ¨kube-proxy"></a>4.3ã€å¯åŠ¨kube-proxy</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-proxy &amp;&amp; systemctl start kube-proxy &amp;&amp; systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure><h3 id="4-4-åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰"><a href="#4-4-åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰" class="headerlink" title="4.4 åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰"></a>4.4 åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰</h3><p>ç”±äº kubelet ç»„ä»¶æ˜¯é‡‡ç”¨ TLS Bootstrap å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆåˆ›å»ºç›¸å…³é…ç½®</p><ul><li>åˆ›å»ºç”¨äº tls bootstrap çš„ token secret<blockquote><p>masterèŠ‚ç‚¹æ“ä½œ</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f bootstrap.secret.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>ä¸ºäº†èƒ½è®© kubelet å®ç°è‡ªåŠ¨æ›´æ–°è¯ä¹¦ï¼Œéœ€è¦é…ç½®ç›¸å…³ clusterrolebinding</p><ul><li><p>å…è®¸ kubelet tls bootstrap åˆ›å»º csr è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding create-csrs-for-bootstrapping \</span><br><span class="line">    --clusterrole=system:node-bootstrapper \</span><br><span class="line">    --group=system:bootstrappers</span><br></pre></td></tr></table></figure></li><li><p>è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding auto-approve-csrs-for-group \</span><br><span class="line">    --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient \</span><br><span class="line">    --group=system:bootstrappers</span><br></pre></td></tr></table></figure></li><li><p>è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding auto-approve-renewals-for-nodes \</span><br><span class="line">    --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient \</span><br><span class="line">    --group=system:nodes</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ kubelet server å¼€å¯ api è®¤è¯çš„æƒ…å†µä¸‹ï¼Œapiserver åå‘è®¿é—® kubelet 10250 éœ€è¦æ­¤æˆæƒ(eg: kubectl logs)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding system:kubelet-api-admin \</span><br><span class="line">    --clusterrole=system:kubelet-api-admin \</span><br><span class="line">    --user=system:kubelet-api-admin</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>é—®é¢˜</strong>:<br>åœ¨å¯åŠ¨kubeletçš„æ—¶å€™ï¼ŒnodeèŠ‚ç‚¹åœ¨masterèŠ‚ç‚¹æ— æ³•æŸ¥çœ‹ï¼ŒæŸ¥çœ‹kubeletçš„æ—¥å¿—æç¤ºå¦‚ä¸‹ï¼š</li><li>æŸ¥çœ‹kubeletçš„æ—¥å¿—æ–¹å¼æœ‰ä¸¤ç§</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># journalctl -f -u kubelet</span></span><br><span class="line"><span class="comment"># systemctl  status kubelet -l</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹nodes<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.16.244   Ready    &lt;none&gt;   12m   v1.13.3</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>éªŒè¯æµ‹è¯•é›†ç¾¤</strong><br>åˆ›å»ºä¸€ä¸ªnginxæµ‹è¯•é›†ç¾¤æ˜¯å¦å¯ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl run nginx --image=docker.io/nginx:latest --replicas=2 --labels run=nginx</span></span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line"><span class="comment"># kubectl expose deployment nginx --port=80 --type=NodePort</span></span><br><span class="line">service/nginx exposed</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹podæƒ…å†µ</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                     READY   STATUS              RESTARTS   AGE   IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-766994fc9f-gcv4n   0/1     ContainerCreating   0          55s   &lt;none&gt;        172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-766994fc9f-w2j8p   1/1     Running             0          55s   10.254.45.2   172.21.16.83    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹å¯¹å¤–çš„æœåŠ¡</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc nginx</span></span><br><span class="line">NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">nginx   NodePort   10.254.11.147   &lt;none&gt;        80:48713/TCP   31s</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å®Œæˆåï¼Œé€šè¿‡ä»»æ„nodeèŠ‚ç‚¹IPçš„åœ°å€åŠ ç«¯å£48713å³å¯è®¿é—®<br><a href="http://node-ip:48713/" target="_blank" rel="noopener">http://node-ip:48713/</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes v13.3 node</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes v1.13.3å®‰è£…</title>
    <url>/2019/08/09/kubernetes-v1-13-3%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h2 id="1ã€-ç¯å¢ƒå‡†å¤‡"><a href="#1ã€-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ ç¯å¢ƒå‡†å¤‡"></a>1ã€ ç¯å¢ƒå‡†å¤‡</h2><table><thead><tr><th>ip</th><th>type</th><th>docker</th><th>os</th><th>k8s version</th></tr></thead><tbody><tr><td>172.21.17.4</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td>v1.13.3</td></tr><tr><td>172.21.16.230</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.240</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.244</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.248</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.45</td><td>vip</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr></tbody></table><h2 id="2ã€éƒ¨ç½²ETCé›†ç¾¤"><a href="#2ã€éƒ¨ç½²ETCé›†ç¾¤" class="headerlink" title="2ã€éƒ¨ç½²ETCé›†ç¾¤"></a>2ã€éƒ¨ç½²ETCé›†ç¾¤</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;etcdçš„æ­£å¸¸è¿è¡Œæ˜¯k8sé›†ç¾¤è¿è¡Œçš„æå‰æ¡ä»¶ï¼Œå› æ­¤éƒ¨ç½²k8sé›†ç¾¤é¦–å…ˆéƒ¨ç½²etcdé›†ç¾¤ã€‚å®‰è£…CAè¯ä¹¦ï¼Œå®‰è£…CFSSLè¯ä¹¦ç®¡ç†å·¥å…·ã€‚ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…</p><a id="more"></a><h3 id="2-1ã€ä¸‹è½½cfssl"><a href="#2-1ã€ä¸‹è½½cfssl" class="headerlink" title="2.1ã€ä¸‹è½½cfssl"></a>2.1ã€ä¸‹è½½cfssl</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -o cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="comment"># chmod +x * &amp;&amp;mv cfssl* /usr/bin/</span></span><br></pre></td></tr></table></figure><h3 id="2-2-ã€åˆ›å»ºetcdè¯ä¹¦"><a href="#2-2-ã€åˆ›å»ºetcdè¯ä¹¦" class="headerlink" title="2.2 ã€åˆ›å»ºetcdè¯ä¹¦"></a>2.2 ã€åˆ›å»ºetcdè¯ä¹¦</h3><ul><li><p>etcd-ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir etcd_ssl &amp;&amp; cd etcd_ssl</span></span><br><span class="line"><span class="comment"># cat etcd-ca-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd-ca"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 4096</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"etcd Security"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"ca"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>etcd-gencert.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat etcd-gencert.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">          <span class="string">"signing"</span>,</span><br><span class="line">          <span class="string">"key encipherment"</span>,</span><br><span class="line">          <span class="string">"server auth"</span>,</span><br><span class="line">          <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>etcd-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat etcd-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"etcd Security"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"172.21.17.4"</span>,</span><br><span class="line">        <span class="string">"172.21.16.231"</span>,</span><br><span class="line">        <span class="string">"172.21.16.240"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥æ‰§è¡Œç”Ÿæˆå³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert --initca=true etcd-ca-csr.json | cfssljson --bare etcd-ca</span></span><br><span class="line"><span class="comment"># cfssl gencert --ca etcd-ca.pem --ca-key etcd-ca-key.pem --config etcd-gencert.json etcd-csr.json | cfssljson --bare etcd</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/etcd/ssl &amp;&amp;mkdir -p /var/lib/etcd</span></span><br><span class="line"><span class="comment"># cp *.pem /etc/etcd/ssl</span></span><br><span class="line"><span class="comment"># ls /etc/etcd/ssl/</span></span><br><span class="line">etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem</span><br><span class="line"><span class="comment"># scp -r /etc/etcd k8s-master-02:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/etcd k8s-master-03:/etc</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="2-3ã€å¼€å§‹é…ç½®etcd"><a href="#2-3ã€å¼€å§‹é…ç½®etcd" class="headerlink" title="2.3ã€å¼€å§‹é…ç½®etcd"></a>2.3ã€å¼€å§‹é…ç½®etcd</h3><h4 id="2-3-1ã€ä¸‹è½½etcd"><a href="#2-3-1ã€ä¸‹è½½etcd" class="headerlink" title="2.3.1ã€ä¸‹è½½etcd"></a>2.3.1ã€ä¸‹è½½etcd</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.3.15/etcd-v3.3.15-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf etcd-v3.3.15-linux-amd64.tar.gz &amp;&amp;cd etcd-v3.3.15-linux-amd64 &amp;&amp;cp -arp etcd* /usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="2-3-2ã€åˆ›å»ºetcdçš„Systemd-unit-æ–‡ä»¶"><a href="#2-3-2ã€åˆ›å»ºetcdçš„Systemd-unit-æ–‡ä»¶" class="headerlink" title="2.3.2ã€åˆ›å»ºetcdçš„Systemd unit æ–‡ä»¶"></a>2.3.2ã€åˆ›å»ºetcdçš„Systemd unit æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;Etcd è¿™é‡Œé‡‡ç”¨æœ€æ–°çš„ 3.3.15 ç‰ˆæœ¬ï¼Œå®‰è£…æ–¹å¼ç›´æ¥å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ã€systemd service é…ç½®å³å¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„ç›¸å…³ç”¨æˆ·æƒé™é—®é¢˜ï¼Œä»¥ä¸‹è„šæœ¬é…ç½®ç­‰å‚è€ƒäº† etcd rpm å®‰è£…åŒ…</p><h4 id="2-3-3ã€é…ç½®etcd-conf"><a href="#2-3-3ã€é…ç½®etcd-conf" class="headerlink" title="2.3.3ã€é…ç½®etcd.conf"></a>2.3.3ã€é…ç½®etcd.conf</h4><ul><li>k8s-master-01<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd1</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.17.4:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.17.4:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.17.4:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.17.4:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p>k8s-master-02</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd2</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.16.231:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.16.231:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.16.231:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.16.231:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li><li><p>k8s-master-03</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd3</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.16.240:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.16.240:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-3-4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶"><a href="#2-3-4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶" class="headerlink" title="2.3.4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶"></a>2.3.4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/etcd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">User=etcd</span><br><span class="line"><span class="comment"># set GOMAXPROCS to number of processors</span></span><br><span class="line">ExecStart=/bin/bash -c <span class="string">"GOMAXPROCS=<span class="variable">$(nproc)</span> /usr/bin/etcd --name=\"<span class="variable">$&#123;ETCD_NAME&#125;</span>\" --data-dir=\"<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span>\" --listen-client-urls=\"<span class="variable">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>\""</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="2-3-5ã€etcdæˆæƒ"><a href="#2-3-5ã€etcdæˆæƒ" class="headerlink" title="2.3.5ã€etcdæˆæƒ"></a>2.3.5ã€etcdæˆæƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># groupadd -r etcd</span></span><br><span class="line"><span class="comment"># useradd -r -g etcd -d /var/lib/etcd -s /sbin/nologin -c "etcd user" etcd</span></span><br><span class="line"><span class="comment"># chown -R etcd:etcd /etc/etcd &amp;&amp; chmod -R 755 /etc/etcd/ssl &amp;&amp;chown -R etcd:etcd /var/lib/etcd</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp;systemctl start etcd &amp;&amp; systemctl status etcd</span></span><br></pre></td></tr></table></figure><h4 id="2-3-6ã€éªŒè¯etcd"><a href="#2-3-6ã€éªŒè¯etcd" class="headerlink" title="2.3.6ã€éªŒè¯etcd"></a>2.3.6ã€éªŒè¯etcd</h4><p>ç”±äºetcdä½¿ç”¨äº†è¯ä¹¦ï¼Œæ‰€ä»¥etcdå‘½ä»¤éœ€è¦å¸¦ä¸Šè¯ä¹¦</p><ul><li><p>æŸ¥çœ‹æˆå‘˜åˆ—è¡¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl --key-file /etc/etcd/ssl/etcd-key.pem --cert-file /etc/etcd/ssl/etcd.pem --ca-file /etc/etcd/ssl/etcd-ca.pem member list</span></span><br><span class="line">93c04a995ff8aa8: name=etcd3 peerURLs=https://172.21.16.240:2380 clientURLs=https://172.21.16.240:2379 isLeader=<span class="literal">false</span></span><br><span class="line">7cc4daf6e4db3a8a: name=etcd2 peerURLs=https://172.21.16.231:2380 clientURLs=https://172.21.16.231:2379 isLeader=<span class="literal">false</span></span><br><span class="line">ec7ea930930d012e: name=etcd1 peerURLs=https://172.21.17.4:2380 clientURLs=https://172.21.17.4:2379 isLeader=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl --key-file /etc/etcd/ssl/etcd-key.pem --cert-file /etc/etcd/ssl/etcd.pem --ca-file /etc/etcd/ssl/etcd-ca.pem cluster-health</span></span><br><span class="line">member 93c04a995ff8aa8 is healthy: got healthy result from https://172.21.16.240:2379</span><br><span class="line">member 7cc4daf6e4db3a8a is healthy: got healthy result from https://172.21.16.231:2379</span><br><span class="line">member ec7ea930930d012e is healthy: got healthy result from https://172.21.17.4:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure></li></ul><h2 id="3ã€éƒ¨ç½²kubernetes"><a href="#3ã€éƒ¨ç½²kubernetes" class="headerlink" title="3ã€éƒ¨ç½²kubernetes"></a>3ã€éƒ¨ç½²kubernetes</h2><h3 id="3-1-ä»‹ç»"><a href="#3-1-ä»‹ç»" class="headerlink" title="3.1 ä»‹ç»"></a>3.1 ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ–°ç‰ˆæœ¬å·²ç»è¶Šæ¥è¶Šè¶‹è¿‘å…¨é¢ TLS + RBAC é…ç½®ï¼Œæ‰€ä»¥æœ¬æ¬¡å®‰è£…å°†ä¼šå¯åŠ¨å¤§éƒ¨åˆ† TLS + RBAC é…ç½®ï¼ŒåŒ…æ‹¬ kube-controler-managerã€kube-scheduler ç»„ä»¶ä¸å†è¿æ¥æœ¬åœ° kube-apiserver çš„ 8080 éè®¤è¯ç«¯å£ï¼Œkubelet ç­‰ç»„ä»¶ API ç«¯ç‚¹å…³é—­åŒ¿åè®¿é—®ï¼Œå¯åŠ¨ RBAC è®¤è¯ç­‰ï¼›ä¸ºäº†æ»¡è¶³è¿™äº›è®¤è¯ï¼Œéœ€è¦ç­¾ç½²ä»¥ä¸‹è¯ä¹¦</p><h3 id="3-2ã€åˆ›å»ºCA"><a href="#3-2ã€åˆ›å»ºCA" class="headerlink" title="3.2ã€åˆ›å»ºCA"></a>3.2ã€åˆ›å»ºCA</h3><h4 id="3-2-1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶"><a href="#3-2-1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶" class="headerlink" title="3.2.1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶"></a>3.2.1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶</h4><ul><li><p>kubernetes-ca-csr.jsoné›†ç¾¤CAæ ¹è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir ssl &amp;&amp; cd ssl/</span></span><br><span class="line"><span class="comment"># cat kubernetes-ca-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 4096</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"ca"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>â€œCNâ€</strong>: Common Nameï¼Œkube-apiserver ä»è¯¥è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·åï¼ˆUser Nameï¼‰;æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™åˆæ³•æ€§ï¼›</li><li><strong>â€œOâ€</strong>: Organizationï¼Œkube-apiserverä»è¯¥è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±ç»„ï¼ˆGroupï¼‰ï¼›</li></ul></li><li><p>kubernetes-gencert.json<br>ç”¨äºç”Ÿæˆå…¶ä»–è¯ä¹¦çš„æ ‡å‡†</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubernetes-gencert.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"signing"</span>: &#123;</span><br><span class="line">        <span class="string">"default"</span>: &#123;</span><br><span class="line">            <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"profiles"</span>: &#123;</span><br><span class="line">            <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">                <span class="string">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"server auth"</span>,</span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-apiserver-csr.json<br>apiserver TLS è®¤è¯ç«¯å£éœ€è¦çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-apiserver-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"10.254.0.1"</span>,</span><br><span class="line">        <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"172.21.16.45"</span>,</span><br><span class="line">        <span class="string">"*.master.kubernetes.node"</span>,</span><br><span class="line">        <span class="string">"kubernetes"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>172.21.16.45</strong>: vipåœ°å€</li><li>å¦‚æœhostså­—æ®µä¸ä¸ºç©ºåˆ™éœ€è¦æŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ipæˆ–åŸŸååˆ—è¡¨,kube-apiserveræŒ‡å®šçš„service-cluster-ip-rangeç½‘æ®µçš„ç¬¬ä¸€ä¸ªipï¼Œå¦‚10.254.0.1</li></ul><ul><li><p>kube-controller-manager-csr.json<br>controller manager è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« 10257 ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-controller-manager-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"localhost"</span>,</span><br><span class="line">    <span class="string">"*.master.kubernetes.node"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-scheduler-csr.json<br>schedulerè¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« 10259 ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-scheduler-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"localhost"</span>,</span><br><span class="line">    <span class="string">"*.master.kubernetes.node"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-proxy-csr.json<br>proxy ç»„ä»¶è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-proxy-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kubelet-api-admin-csr.json<br>apiserver åå‘è¿æ¥ kubelet ç»„ä»¶ 10250 ç«¯å£éœ€è¦ä½¿ç”¨çš„è¯ä¹¦(ä¾‹å¦‚æ‰§è¡Œ kubectl logs)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubelet-api-admin-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kubelet-api-admin"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:kubelet-api-admin"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>admin-csr.json<br>é›†ç¾¤ç®¡ç†å‘˜(kubectl)è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat admin-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>æ³¨æ„</strong>: è¯ä¹¦æ–‡ä»¶é‡Œé¢çš„CNã€Oå­—æ®µï¼Œä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„å­—æ®µï¼ŒåŸºæœ¬éƒ½æ˜¯system:å¼€å¤´ï¼Œæ˜¯ä¸ºäº†åŒ¹é…RBACè§„åˆ™,<a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings" target="_blank" rel="noopener">è¯¦æƒ…å‚è€ƒ</a></p><h4 id="3-3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯"><a href="#3-3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯" class="headerlink" title="3.3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯"></a>3.3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert --initca=true kubernetes-ca-csr.json | cfssljson --bare kubernetes-ca</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for targetName in kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet-api-admin admin; do</span></span><br><span class="line">  cfssl gencert --ca kubernetes-ca.pem --ca-key kubernetes-ca-key.pem --config kubernetes-gencert.json --profile kubernetes <span class="variable">$targetName</span>-csr.json | cfssljson --bare <span class="variable">$targetName</span>; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="3-4ã€åˆ†å‘è¯ä¹¦"><a href="#3-4ã€åˆ†å‘è¯ä¹¦" class="headerlink" title="3.4ã€åˆ†å‘è¯ä¹¦"></a>3.4ã€åˆ†å‘è¯ä¹¦</h4><p>å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ï¼ˆåç¼€åä¸º.pemï¼‰æ‹·è´åˆ°æ‰€æœ‰æœºå™¨ï¼›kubernetesç³»ç»Ÿçš„å„ä¸ªç»„å»ºéœ€è¦ä½¿ç”¨tlsè¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†ã€‚</p><h5 id="1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š"><a href="#1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š" class="headerlink" title="1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š"></a>1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š</h5><ul><li>admin-key.pem</li><li>admin.pem</li><li>kube-apiserver-key.pem</li><li>kube-apiserver.pem</li><li>kube-controller-manager-key.pem</li><li>kube-controller-manager.pem</li><li>kubelet-api-admin-key.pem</li><li>kubelet-api-admin.pem</li><li>kube-proxy-key.pem</li><li>kube-proxy.pem</li><li>kubernetes-ca-key.pem</li><li>kubernetes-ca.pem</li><li>kube-scheduler-key.pem</li><li>kube-scheduler.pem</li></ul><h5 id="3ï¼‰ã€è¯ä¹¦æ‹·è´"><a href="#3ï¼‰ã€è¯ä¹¦æ‹·è´" class="headerlink" title="3ï¼‰ã€è¯ä¹¦æ‹·è´"></a>3ï¼‰ã€è¯ä¹¦æ‹·è´</h5><ul><li><p><strong>master èŠ‚ç‚¹æ‹·è´</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/kubernetes/ssl</span></span><br><span class="line"><span class="comment"># cp *.pem /etc/kubernetes/ssl/</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes k8s-master-02:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes k8s-master-03:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes node-01:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes node-02:/etc</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºç›®å½•</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/kube-audit &amp;&amp; mkdir /var/lib/kubelet -p &amp;&amp; mkdir /usr/libexec -p</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="4ã€åˆ›å»ºkube-configæ–‡ä»¶"><a href="#4ã€åˆ›å»ºkube-configæ–‡ä»¶" class="headerlink" title="4ã€åˆ›å»ºkube configæ–‡ä»¶"></a>4ã€åˆ›å»ºkube configæ–‡ä»¶</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;kubeletã€kube-proxyç­‰Nodeæœºå™¨ä¸Šçš„ç»å¸¸ä¸masteræœºå™¨çš„kube-apiserverè¿›ç¨‹é€šä¿¡æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼›kubernetes 1.4 å¼€å§‹æ”¯æŒæœ‰kube-apiserverä¸ºå®¢æˆ·ç«¯ç”Ÿæˆtlsè¯ä¹¦çš„ TLS BootstrappingåŠŸèƒ½ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦äº†ï¼Œè¯¥åŠŸèƒ½å½“å‰ä»…æ”¯æŒä¸ºkueletç”Ÿæˆè¯ä¹¦ï¼›</p><h3 id="4-1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶"><a href="#4-1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶" class="headerlink" title="4.1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶"></a>4.1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶</h3><ul><li>bootstrap.kubeconfig kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µéœ€è¦ä½¿ç”¨çš„é…ç½®æ–‡ä»¶</li><li>kube-controller-manager.kubeconfig controller manager ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li><li>kube-scheduler.kubeconfig scheduler ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li><li>kube-proxy.kubeconfig proxy ç»„ä»¶è¿æ¥ apiserver æ‰€éœ€é…ç½®æ–‡ä»¶</li><li>audit-policy.yaml apiserver RBAC å®¡è®¡æ—¥å¿—é…ç½®æ–‡ä»¶</li><li>bootstrap.secret.yaml kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µä½¿ç”¨ Bootstrap Token æ–¹å¼å¼•å¯¼ï¼Œéœ€è¦é¢„å…ˆåˆ›å»ºæ­¤ Token</li></ul><h3 id="4-2ã€åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶"><a href="#4-2ã€åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶" class="headerlink" title="4.2ã€åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶"></a>4.2ã€åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶</h3><p>åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦ä¸‹è½½kubernetes ç›¸å…³çš„äºŒè¿›åˆ¶åŒ…ï¼ŒæŠŠå¯¹åº”çš„å·¥å…·å’Œå‘½ä»¤æ‹·è´åˆ°/usr/binç›®å½•ä¸‹é¢;ä¸‹è½½äºŒè¿›åˆ¶åŒ…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.13.3/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf kubernetes-server-linux-amd64.tar.gz &amp;&amp; cd kubernetes/server/bin</span></span><br></pre></td></tr></table></figure><ul><li>masterèŠ‚ç‚¹æ‹·è´</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mv apiextensions-apiserver cloud-controller-manager hyperkube kube-apiserver kube-controller-manager kube-proxy kube-scheduler kubectl kubelet mounter kubeadm /usr/bin/ &amp;&amp; cd &amp;&amp;rm -rf kubernetes kubernetes-server-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><h4 id="4-2-1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping"><a href="#4-2-1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping" class="headerlink" title="4.2.1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping"></a>4.2.1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping</h4><ul><li>master-01<br>&nbsp;&nbsp;&nbsp;&nbsp;config æ˜¯ä¸€ä¸ªé€šç”¨é…ç½®æ–‡ä»¶è¦è¿æ¥æœ¬åœ°çš„ 6443 åŠ å¯†ç«¯å£ï¼›è€Œè¿™ä¸ªå˜é‡å°†ä¼šè¦†ç›– kubeconfig ä¸­æŒ‡å®šçš„master_vipåœ°å€172.21.16.45:6443 åœ°å€</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export KUBE_APISERVER="https://172.21.16.45:6443"</span></span><br></pre></td></tr></table></figure><ul><li>ç”Ÿæˆ Bootstrap Token<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># BOOTSTRAP_TOKEN_ID=$(head -c 6 /dev/urandom | md5sum | head -c 6)</span></span><br><span class="line"><span class="comment"># BOOTSTRAP_TOKEN_SECRET=$(head -c 16 /dev/urandom | md5sum | head -c 16)</span></span><br><span class="line"><span class="comment"># BOOTSTRAP_TOKEN="$&#123;BOOTSTRAP_TOKEN_ID&#125;.$&#123;BOOTSTRAP_TOKEN_SECRET&#125;"</span></span><br><span class="line"><span class="comment"># echo "Bootstrap Tokne: $&#123;BOOTSTRAP_TOKEN&#125;"</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="4-2-2ã€ç”Ÿæˆ-kubelet-tls-bootstrap-é…ç½®"><a href="#4-2-2ã€ç”Ÿæˆ-kubelet-tls-bootstrap-é…ç½®" class="headerlink" title="4.2.2ã€ç”Ÿæˆ kubelet tls bootstrap é…ç½®"></a>4.2.2ã€ç”Ÿæˆ kubelet tls bootstrap é…ç½®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:bootstrap:$&#123;BOOTSTRAP_TOKEN_ID&#125;" \</span></span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=<span class="string">"system:bootstrap:<span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span>"</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-3ã€ç”Ÿæˆ-kube-controller-manager-é…ç½®æ–‡ä»¶"><a href="#4-2-3ã€ç”Ÿæˆ-kube-controller-manager-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.3ã€ç”Ÿæˆ kube-controller-manager é…ç½®æ–‡ä»¶"></a>4.2.3ã€ç”Ÿæˆ kube-controller-manager é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-controller-manager" \</span></span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-4ã€ç”Ÿæˆ-kube-scheduler-é…ç½®æ–‡ä»¶"><a href="#4-2-4ã€ç”Ÿæˆ-kube-scheduler-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.4ã€ç”Ÿæˆ kube-scheduler é…ç½®æ–‡ä»¶"></a>4.2.4ã€ç”Ÿæˆ kube-scheduler é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-scheduler" \</span></span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-5ã€ç”Ÿæˆ-kube-proxy-é…ç½®æ–‡ä»¶"><a href="#4-2-5ã€ç”Ÿæˆ-kube-proxy-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.5ã€ç”Ÿæˆ kube-proxy é…ç½®æ–‡ä»¶"></a>4.2.5ã€ç”Ÿæˆ kube-proxy é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-proxy" \</span></span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-6ã€ç”Ÿæˆ-apiserver-RBAC-å®¡è®¡é…ç½®æ–‡ä»¶"><a href="#4-2-6ã€ç”Ÿæˆ-apiserver-RBAC-å®¡è®¡é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.6ã€ç”Ÿæˆ apiserver RBAC å®¡è®¡é…ç½®æ–‡ä»¶"></a>4.2.6ã€ç”Ÿæˆ apiserver RBAC å®¡è®¡é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; audit-policy.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="comment"># Log all requests at the Metadata level.</span></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">- level: Metadata</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-2-7ã€ç”Ÿæˆ-tls-bootstrap-token-secret-é…ç½®æ–‡ä»¶"><a href="#4-2-7ã€ç”Ÿæˆ-tls-bootstrap-token-secret-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.7ã€ç”Ÿæˆ tls bootstrap token secret é…ç½®æ–‡ä»¶"></a>4.2.7ã€ç”Ÿæˆ tls bootstrap token secret é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; bootstrap.secret.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># Name MUST be of form "bootstrap-token-&lt;token id&gt;"</span></span><br><span class="line">  name: bootstrap-token-<span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span></span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="comment"># Type MUST be 'bootstrap.kubernetes.io/token'</span></span><br><span class="line"><span class="built_in">type</span>: bootstrap.kubernetes.io/token</span><br><span class="line">stringData:</span><br><span class="line">  <span class="comment"># Human readable description. Optional.</span></span><br><span class="line">  description: <span class="string">"The default bootstrap token."</span></span><br><span class="line">  <span class="comment"># Token ID and secret. Required.</span></span><br><span class="line">  token-id: <span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span></span><br><span class="line">  token-secret: <span class="variable">$&#123;BOOTSTRAP_TOKEN_SECRET&#125;</span></span><br><span class="line">  <span class="comment"># Expiration. Optional.</span></span><br><span class="line">  expiration: $(date -d<span class="string">'+2 day'</span> -u +<span class="string">"%Y-%m-%dT%H:%M:%SZ"</span>)</span><br><span class="line">  <span class="comment"># Allowed usages.</span></span><br><span class="line">  usage-bootstrap-authentication: <span class="string">"true"</span></span><br><span class="line">  usage-bootstrap-signing: <span class="string">"true"</span></span><br><span class="line">  <span class="comment"># Extra groups to authenticate the token as. Must start with "system:bootstrappers:"</span></span><br><span class="line"><span class="comment">#  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-3ã€å¤åˆ¶æ–‡ä»¶"><a href="#4-3ã€å¤åˆ¶æ–‡ä»¶" class="headerlink" title="4.3ã€å¤åˆ¶æ–‡ä»¶"></a>4.3ã€å¤åˆ¶æ–‡ä»¶</h4><p>æŠŠåˆšç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°<code>/etc/kubernetes</code>ç›®å½•ä¸‹é¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># cp audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig /etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig k8s-master-02:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig k8s-master-03:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># node èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp -r  bootstrap.kubeconfig kube-proxy.kubeconfig node-01:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r  bootstrap.kubeconfig kube-proxy.kubeconfig node-02:/etc/kubernetes</span></span><br></pre></td></tr></table></figure><h4 id="4-4ã€å¤„ç†-ipvs-åŠä¾èµ–"><a href="#4-4ã€å¤„ç†-ipvs-åŠä¾èµ–" class="headerlink" title="4.4ã€å¤„ç† ipvs åŠä¾èµ–"></a>4.4ã€å¤„ç† ipvs åŠä¾èµ–</h4><p>&nbsp;&nbsp;&nbsp;&nbsp; æ–°ç‰ˆæœ¬ç›®å‰ kube-proxy ç»„ä»¶å…¨éƒ¨é‡‡ç”¨ ipvs æ–¹å¼è´Ÿè½½ï¼Œæ‰€ä»¥ä¸ºäº† kube-proxy èƒ½æ­£å¸¸å·¥ä½œéœ€è¦é¢„å…ˆå¤„ç†ä¸€ä¸‹ ipvs é…ç½®ä»¥åŠç›¸å…³ä¾èµ–(æ¯å° node éƒ½è¦å¤„ç†)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># sysctl -p</span></span><br></pre></td></tr></table></figure><p>kubernetes ä¸­å¯ç”¨ ipvs,è¯¦ç»†ä»‹ç»ï¼Œ<a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/proxy/ipvs" target="_blank" rel="noopener">å®˜æ–¹</a>,<a href="https://juejin.im/entry/5b7e409ce51d4538b35c03df" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install ipvsadm</span></span><br><span class="line"><span class="comment"># cat &gt;&gt; /etc/modules &lt;&lt;EOF</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver"><a href="#5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver" class="headerlink" title="5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver"></a>5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver</h2><h3 id="5-1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶"><a href="#5-1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶"></a>5.1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶</h3><ul><li><strong>kube-apiserver.service</strong><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service</span></span><br><span class="line">[Unit]</span><br><span class="line">  Description=Kubernetes API Service</span><br><span class="line">  Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">  After=network.target</span><br><span class="line">  After=etcd.service</span><br><span class="line">[Service]</span><br><span class="line">  EnvironmentFile=-/etc/kubernetes/apiserver</span><br><span class="line">  ExecStart=/usr/bin/kube-apiserver \</span><br><span class="line">          <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">          <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">          <span class="variable">$KUBE_ETCD_SERVERS</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_ADDRESS</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_PORT</span> \</span><br><span class="line">          <span class="variable">$KUBELET_PORT</span> \</span><br><span class="line">          <span class="variable">$KUBE_ALLOW_PRIV</span> \</span><br><span class="line">          <span class="variable">$KUBE_SERVICE_ADDRESSES</span> \</span><br><span class="line">          <span class="variable">$KUBE_ADMISSION_CONTROL</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_ARGS</span></span><br><span class="line">  Restart=on-failure</span><br><span class="line">  Type=notify</span><br><span class="line">  LimitNOFILE=65536</span><br><span class="line">[Install]</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-2ã€apiserveré…ç½®æ–‡ä»¶"><a href="#5-2ã€apiserveré…ç½®æ–‡ä»¶" class="headerlink" title="5.2ã€apiserveré…ç½®æ–‡ä»¶"></a>5.2ã€apiserveré…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/apiserver</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes system config</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The following values are used to configure the kube-apiserver</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address on the local server to listen to.</span></span><br><span class="line">KUBE_API_ADDRESS=<span class="string">"--advertise-address=172.21.17.4 --bind-address=0.0.0.0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The port on the local server to listen on.</span></span><br><span class="line">KUBE_API_PORT=<span class="string">"--secure-port=6443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port minions listen on</span></span><br><span class="line"><span class="comment"># KUBELET_PORT="--kubelet-port=10250"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Comma separated list of nodes in the etcd cluster</span></span><br><span class="line">KUBE_ETCD_SERVERS=<span class="string">"--etcd-servers=https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Address range to use for services</span></span><br><span class="line">KUBE_SERVICE_ADDRESSES=<span class="string">"--service-cluster-ip-range=10.254.0.0/16"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default admission control policies</span></span><br><span class="line">KUBE_ADMISSION_CONTROL=<span class="string">"--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,Priority,ResourceQuota"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_API_ARGS=<span class="string">" --allow-privileged=true \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --alsologtostderr \</span></span><br><span class="line"><span class="string">                --apiserver-count=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">                --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">                --audit-log-path=/var/log/kube-audit/audit.log \</span></span><br><span class="line"><span class="string">                --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span></span><br><span class="line"><span class="string">                --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">                --enable-garbage-collector \</span></span><br><span class="line"><span class="string">                --enable-logs-handler \</span></span><br><span class="line"><span class="string">                --endpoint-reconciler-type=lease \</span></span><br><span class="line"><span class="string">                --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span></span><br><span class="line"><span class="string">                --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">                --etcd-compaction-interval=0s \</span></span><br><span class="line"><span class="string">                --event-ttl=168h0m0s \</span></span><br><span class="line"><span class="string">                --kubelet-https=true \</span></span><br><span class="line"><span class="string">                --kubelet-certificate-authority=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem \</span></span><br><span class="line"><span class="string">                --kubelet-timeout=3s \</span></span><br><span class="line"><span class="string">                --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">                --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">                --service-account-key-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure><ul><li><strong>â€“client-ca-file</strong>: å®šä¹‰å®¢æˆ·ç«¯ CA</li><li><strong>â€“endpoint-reconciler-type</strong>: master endpoint ç­–ç•¥</li><li><strong>â€“kubelet-client-certificateã€â€“kubelet-client-key</strong>: master åå‘è¿æ¥ kubelet ä½¿ç”¨çš„è¯ä¹¦</li><li><strong>â€“service-account-key-file</strong>: service account ç­¾å key(ç”¨äºæœ‰æ•ˆæ€§éªŒè¯)</li><li><strong>â€“tls-cert-fileã€â€“tls-private-key-file</strong>: master apiserver 6443 ç«¯å£è¯ä¹¦<br>è¯¦ç»†å‚æ•°<a href="https://www.jianshu.com/p/36ad3028a710" target="_blank" rel="noopener">ä»‹ç»</a></li></ul><h3 id="5-2-1ã€å¯åŠ¨kube-apiserver"><a href="#5-2-1ã€å¯åŠ¨kube-apiserver" class="headerlink" title="5.2.1ã€å¯åŠ¨kube-apiserver"></a>5.2.1ã€å¯åŠ¨kube-apiserver</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-apiserver &amp;&amp;systemctl start kube-apiserver &amp;&amp;systemctl status kube-apiserver</span></span><br></pre></td></tr></table></figure><h3 id="5-3ã€é…ç½®kube-controller-manager"><a href="#5-3ã€é…ç½®kube-controller-manager" class="headerlink" title="5.3ã€é…ç½®kube-controller-manager"></a>5.3ã€é…ç½®kube-controller-manager</h3><p>åˆ›å»ºkube-controller-managerçš„serviceé…ç½®æ–‡ä»¶</p><h3 id="5-3-1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶"><a href="#5-3-1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.3.1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶"></a>5.3.1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-controller-manager.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/controller-manager</span><br><span class="line">ExecStart=/usr/bin/kube-controller-manager \</span><br><span class="line">	    <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">	    <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">	    <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">	    <span class="variable">$KUBE_CONTROLLER_MANAGER_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="5-3-2ã€é…ç½®controller-manageræ–‡ä»¶"><a href="#5-3-2ã€é…ç½®controller-manageræ–‡ä»¶" class="headerlink" title="5.3.2ã€é…ç½®controller-manageræ–‡ä»¶"></a>5.3.2ã€é…ç½®controller-manageræ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/controller-manager</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># The following values are used to configure the kubernetes controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defaults from config and apiserver should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">                                --cluster-signing-cert-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --cluster-signing-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">                                --deployment-controller-sync-period=10s \</span></span><br><span class="line"><span class="string">                                --experimental-cluster-signing-duration=87600h0m0s \</span></span><br><span class="line"><span class="string">                                --enable-garbage-collector=true \</span></span><br><span class="line"><span class="string">                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --leader-elect=true \</span></span><br><span class="line"><span class="string">                                --node-monitor-grace-period=20s \</span></span><br><span class="line"><span class="string">                                --node-monitor-period=5s \</span></span><br><span class="line"><span class="string">                                --port=10252 \</span></span><br><span class="line"><span class="string">                                --pod-eviction-timeout=2m0s \</span></span><br><span class="line"><span class="string">                                --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --terminated-pod-gc-threshold=50 \</span></span><br><span class="line"><span class="string">                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">                                --root-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --secure-port=10257 \</span></span><br><span class="line"><span class="string">                                --service-cluster-ip-range=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                                --service-account-private-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">                                --v=2"</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;controller manager å°†ä¸å®‰å…¨ç«¯å£ 10252 ç»‘å®šåˆ° 127.0.0.1 ç¡®ä¿ kuebctl get cs æœ‰æ­£ç¡®è¿”å›ï¼›å°†å®‰å…¨ç«¯å£ 10257 ç»‘å®šåˆ° 0.0.0.0 å…¬å¼€ï¼Œæä¾›æœåŠ¡è°ƒç”¨ï¼›ç”±äº controller manager å¼€å§‹è¿æ¥ apiserver çš„ 6443 è®¤è¯ç«¯å£ï¼Œæ‰€ä»¥éœ€è¦ â€“use-service-account-credentials é€‰é¡¹æ¥è®© controller manager åˆ›å»ºå•ç‹¬çš„ service account(é»˜è®¤ system:kube-controller-manager ç”¨æˆ·æ²¡æœ‰é‚£ä¹ˆé«˜æƒé™)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused   </span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused   </span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="5-3-3ã€å¯åŠ¨kube-controller-manager"><a href="#5-3-3ã€å¯åŠ¨kube-controller-manager" class="headerlink" title="5.3.3ã€å¯åŠ¨kube-controller-manager"></a>5.3.3ã€å¯åŠ¨kube-controller-manager</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl enable kube-controller-manager &amp;&amp;systemctl start kube-controller-manager &amp;&amp;systemctl status kube-controller-manager</span></span><br></pre></td></tr></table></figure><h3 id="5-4ã€é…ç½®kube-scheduler"><a href="#5-4ã€é…ç½®kube-scheduler" class="headerlink" title="5.4ã€é…ç½®kube-scheduler"></a>5.4ã€é…ç½®kube-scheduler</h3><p>åˆ›å»ºkube-schedulerçš„serviceé…ç½®æ–‡ä»¶</p><h4 id="5-4-1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶"><a href="#5-4-1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.4.1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶"></a>5.4.1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/kube-scheduler.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler Plugin</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/scheduler</span><br><span class="line">ExecStart=/usr/bin/kube-scheduler \</span><br><span class="line">	    <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">	    <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">	    <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">	    <span class="variable">$KUBE_SCHEDULER_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="5-4-2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶"><a href="#5-4-2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶" class="headerlink" title="5.4.2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶"></a>5.4.2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/scheduler </span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes scheduler config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_SCHEDULER_ARGS=<span class="string">"   --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                        --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                        --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                        --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                        --secure-port=10259 \</span></span><br><span class="line"><span class="string">                        --leader-elect=true \</span></span><br><span class="line"><span class="string">                        --port=10251 \</span></span><br><span class="line"><span class="string">                        --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \</span></span><br><span class="line"><span class="string">                        --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem \</span></span><br><span class="line"><span class="string">                        --v=2"</span></span><br></pre></td></tr></table></figure><p>shceduler åŒ controller manager ä¸€æ ·å°†ä¸å®‰å…¨ç«¯å£ç»‘å®šåœ¨æœ¬åœ°ï¼Œå®‰å…¨ç«¯å£å¯¹å¤–å…¬å¼€</p><h4 id="5-4-3ã€å¯åŠ¨kube-scheduler"><a href="#5-4-3ã€å¯åŠ¨kube-scheduler" class="headerlink" title="5.4.3ã€å¯åŠ¨kube-scheduler"></a>5.4.3ã€å¯åŠ¨kube-scheduler</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-scheduler &amp;&amp;systemctl start kube-scheduler &amp;&amp;systemctl status kube-scheduler</span></span><br></pre></td></tr></table></figure><h3 id="5-4ã€éªŒè¯masterèŠ‚ç‚¹"><a href="#5-4ã€éªŒè¯masterèŠ‚ç‚¹" class="headerlink" title="5.4ã€éªŒè¯masterèŠ‚ç‚¹"></a>5.4ã€éªŒè¯masterèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤masterèŠ‚ç‚¹éƒ¨ç½²å®Œæ¯•</p><p>kubernetesé«˜å¯ç”¨ä½¿ç”¨haproxyè¿›è¡Œä»£ç†,<a href="https://xxlaila.github.io/2019/08/10/haproxy-keepalived/" target="_blank" rel="noopener">haproxy</a>ä»£ç†å®‰è£…</p><p><a href="https://xxlaila.github.io/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">nodeèŠ‚ç‚¹å®‰è£…</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes v1.13.3</tag>
      </tags>
  </entry>
  <entry>
    <title>vsftpdå®‰è£…</title>
    <url>/2019/08/09/vsftpd%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Centosä¸‹ftpçš„å®‰è£…ä¸€èˆ¬é‡‡ç”¨çš„æ˜¯vsftpdï¼Œä½†æ˜¯åœ¨ftpçš„æ¨¡å¼ä¸­åˆæœ‰å‡ ä¸ªç”¨æˆ·é…ç½®é¡¹éœ€è¦æ³¨æ„ï¼Œæœ‰äº›äººå–œæ¬¢ç”¨æœ¬åœ°ç”¨æˆ·å»ç™»é™†FTPï¼Œè™½ç„¶åœ¨å»ºç«‹æœ¬åœ°ç”¨æˆ·çš„æ—¶å€™åŠ äº†/sbin/nologinå‚æ•°ï¼Œä½†æ˜¯è¿™ä¸ªè¿˜æ˜¯ä¸å¤Ÿå®‰å…¨ï¼Œè€Œä¸”è¿™æ ·æƒé™æ§åˆ¶ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼Œä»–ä»¬éƒ½æ˜¯ç»Ÿä¸€çš„æ§åˆ¶æƒé™ï¼Œè¿™é‡Œé‡‡ç”¨è™šæ‹Ÿç”¨æˆ·å‰æ¥é…ç½®ã€‚è™šæ‹Ÿç”¨æˆ·é…åˆé˜²ç«å¢™selinuxè¿˜æœ‰å•ä¸ªç”¨æˆ·çš„æƒé™ï¼Œè¿™ä½¿å¾—FTPæœ‰ç€è¶³å¤Ÿçš„å®‰å…¨ã€‚è€Œä¸”æƒé™æ§åˆ¶ç‰¹åˆ«çµæ´»ï¼Œä¿®æ”¹ä¸€ä¸ªç”¨æˆ·çš„æƒé™ä¸ä¼šå½±å“åˆ°å…¶ä»–ç”¨æˆ·ã€‚<br>centos ç³»ç»Ÿç‰ˆæœ¬(5.5ã€5.3ã€6.0ã€6.5)<br>centos 7.4 å·²ç»éªŒè¯</p><h3 id="é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd"><a href="#é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd" class="headerlink" title="é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd"></a>é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum â€“y install vsftpd</span></span><br></pre></td></tr></table></figure><h3 id="2ã€å¯åŠ¨å’ŒåŠ è½½vsftp"><a href="#2ã€å¯åŠ¨å’ŒåŠ è½½vsftp" class="headerlink" title="2ã€å¯åŠ¨å’ŒåŠ è½½vsftp"></a>2ã€å¯åŠ¨å’ŒåŠ è½½vsftp</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># service vsftpd restart</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chkconfig â€“level 35 vsftpd on</span></span><br></pre></td></tr></table></figure><h3 id="3ã€å¼€å§‹é…ç½®vsftpd"><a href="#3ã€å¼€å§‹é…ç½®vsftpd" class="headerlink" title="3ã€å¼€å§‹é…ç½®vsftpd"></a>3ã€å¼€å§‹é…ç½®vsftpd</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Vsftpdçš„é…ç½®æ–‡ä»¶åœ¨/etc/vsftpdä¸‹é¢ï¼Œåœ¨é…ç½®ä¹‹å‰æˆ‘ä»¬å…ˆcpä¸€ä»½åšå¤‡ä»½ç”¨ä»¥å…å‘ç”Ÿæ„å¤–(åšä»€ä¹ˆéƒ½è¦éšæ‰‹å¤‡ä»½ï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸‡ï¼Œåªæœ‰ä¸‡ä¸€ã€‚)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment">#  cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.bak</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vim /etc/vsftpd/vsftpd.conf</span></span><br></pre></td></tr></table></figure><ul><li><strong>vsftpdçš„å‚æ•°ä»‹ç»</strong></li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reverse_lookup_enable=NO <span class="comment">#æ·»åŠ æ­¤è¡Œï¼Œè§£å†³å®¢æˆ·ç«¯ç™»é™†ç¼“æ…¢é—®é¢˜ï¼é‡è¦ï¼é»˜è®¤vsftpdå¼€å¯äº†DNSåå“è§£æï¼è¿™é‡Œéœ€è¦å…³é—­ï¼Œå¦‚æœå¯åŠ¨æœ‰é”™è¯¯ï¼Œè¯·æ³¨é”€ï¼</span></span><br><span class="line">listen_port=21 <span class="comment">#é»˜è®¤æ— æ­¤è¡Œï¼Œftpç«¯å£ä¸º21ï¼Œæ·»åŠ listen_port=2222æŠŠé»˜è®¤ç«¯å£ä¿®æ”¹ä¸º2222ï¼Œæ³¨æ„ï¼šé˜²ç«å¢™åŒæ—¶è¦å¼€å¯2222ç«¯å£</span></span><br><span class="line">anonymous_enable=NOã€€ã€€ <span class="comment">#ç¦æ­¢åŒ¿åç”¨æˆ·</span></span><br><span class="line">local_enable=YES</span><br><span class="line">è®¾å®šæœ¬åœ°ç”¨æˆ·å¯ä»¥è®¿é—®ã€‚æ³¨æ„ï¼šä¸»è¦æ˜¯ä¸ºè™šæ‹Ÿå®¿ä¸»ç”¨æˆ·ï¼Œå¦‚æœè¯¥é¡¹ç›®è®¾å®šä¸ºNOé‚£ä¹ˆæ‰€æœ‰è™šæ‹Ÿç”¨æˆ·å°†æ— æ³•è®¿é—®</span><br><span class="line">write_enable=YES <span class="comment">#å…¨å±€è®¾ç½®ï¼Œæ˜¯å¦å®¹è®¸å†™å…¥ï¼ˆæ— è®ºæ˜¯åŒ¿åç”¨æˆ·è¿˜æ˜¯æœ¬åœ°ç”¨æˆ·ï¼Œè‹¥è¦å¯ç”¨ä¸Šä¼ æƒé™çš„è¯ï¼Œå°±è¦å¼€å¯ä»–ï¼‰</span></span><br><span class="line">local_umask=022 è®¾å®šä¸Šä¼ åæ–‡ä»¶çš„æƒé™æ©ç ã€‚</span><br><span class="line">anon_upload_enable=NO ç¦æ­¢åŒ¿åç”¨æˆ·ä¸Šä¼ ã€‚</span><br><span class="line">anon_mkdir_write_enable=NO ç¦æ­¢åŒ¿åç”¨æˆ·å»ºç«‹ç›®å½•ã€‚</span><br><span class="line">dirmessage_enable=YES è®¾å®šå¼€å¯ç›®å½•æ ‡è¯­åŠŸèƒ½ã€‚</span><br><span class="line">xferlog_enable=YES è®¾å®šå¼€å¯æ—¥å¿—è®°å½•åŠŸèƒ½ã€‚</span><br><span class="line">connect_from_port_20=YES è®¾å®šç«¯å£20è¿›è¡Œæ•°æ®è¿æ¥ã€‚</span><br><span class="line">chown_uploads=NO è®¾å®šç¦æ­¢ä¸Šä¼ æ–‡ä»¶æ›´æ”¹å®¿ä¸»ã€‚</span><br><span class="line">xferlog_file=/var/<span class="built_in">log</span>/vsftpd.log æ—¥å¿—ä¿å­˜è·¯å¾„ï¼ˆå…ˆåˆ›å»ºå¥½æ–‡ä»¶ï¼‰</span><br><span class="line">xferlog_std_format=YESã€€ã€€ <span class="comment">#ä½¿ç”¨æ ‡å‡†æ ¼å¼</span></span><br><span class="line">async_abor_enable=YES è®¾å®šæ”¯æŒå¼‚æ­¥ä¼ è¾“åŠŸèƒ½ã€‚</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES è®¾å®šæ”¯æŒASCIIæ¨¡å¼çš„ä¸Šä¼ å’Œä¸‹è½½åŠŸèƒ½ã€‚</span><br><span class="line">ftpd_banner=Welcome to Awei FTP servers è®¾å®šVsftpdçš„ç™»é™†æ ‡è¯­ã€‚</span><br><span class="line">chroot_local_user=YES ç¦æ­¢æœ¬åœ°ç”¨æˆ·ç™»å‡ºè‡ªå·±çš„FTPä¸»ç›®å½•ã€‚</span><br><span class="line">pam_service_name=vsftpd è®¾å®šPAMæœåŠ¡ä¸‹Vsftpdçš„éªŒè¯é…ç½®æ–‡ä»¶åã€‚å› æ­¤ï¼ŒPAMéªŒè¯å°†å‚è€ƒ/etc/pam.d/ä¸‹çš„vsftpdæ–‡ä»¶é…ç½®ã€‚</span><br><span class="line">userlist_enable=YES è®¾ä¸ºYESçš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·åæ˜¯åœ¨userlist_fileå‚æ•°æŒ‡å®šçš„æ–‡ä»¶ä¸­ï¼Œ</span><br><span class="line"> é‚£ä¹ˆåœ¨è¦æ±‚ä»–ä»¬è¾“å…¥å¯†ç ä¹‹å‰ï¼Œä¼šç›´æ¥æ‹’ç»ä»–ä»¬ç™»é™†ã€‚</span><br><span class="line">tcp_wrappers=YES æ˜¯å¦æ”¯æŒtcp_wrappers</span><br></pre></td></tr></table></figure><ul><li><strong>ä»¥ä¸‹æ˜¯æˆ‘ä½¿ç”¨çš„å‚æ•°,ä½¿ç”¨çš„æ˜¯è¢«åŠ¨æ¨¡å¼</strong><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">anonymous_enable=No</span><br><span class="line">listen_port=21</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"><span class="comment">#chown_uploads=YES</span></span><br><span class="line">xferlog_file=/var/<span class="built_in">log</span>/vsftpd.log</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">async_abor_enable=YES</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES</span><br><span class="line">ftpd_banner=Welcome to blah FTP service.</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">listen=YES</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line">reverse_lookup_enable=No</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=vsftpd</span><br><span class="line">user_config_dir=/etc/vsftpd/vconf</span><br><span class="line">virtual_use_local_privs=YES</span><br><span class="line">pasv_min_port=9000</span><br><span class="line">pasv_max_port=9045</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">allow_writeable_chroot=YES</span><br><span class="line"><span class="comment">#port_enable=YES</span></span><br><span class="line"><span class="comment">#connect_from_port_20=YES</span></span><br><span class="line">pasv_enable=yes</span><br></pre></td></tr></table></figure></li></ul><ul><li>å¤‡æ³¨: è¿™é‡Œvsftpé‡‡ç”¨çš„è¢«åŠ¨æ¨¡å¼ï¼Œè¢«åŠ¨æ¨¡å¼å¼€æ”¾äº†ä¸€ä¸ªç«¯å£æ®µï¼Œå…¬å¸è·¯ç”±å™¨ä¸Šéœ€è¦å¼€æ”¾è¿™ä¸€ä¸ªç«¯å£ç«¯ï¼Œ<a href="https://xxlaila.github.io/2019/09/10/è·¯ç”±å™¨ç«¯å£æ˜ å°„/" target="_blank" rel="noopener">è·¯ç”±å™¨ç«¯å£æ˜ å°„</a></li></ul><h3 id="4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶"><a href="#4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶" class="headerlink" title="4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶"></a>4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶</h3><p>ç¼–è¾‘è™šæ‹Ÿç”¨æˆ·çš„åå•ï¼šï¼ˆç¬¬ä¸€è¡Œç”¨æˆ·åã€‚ç¬¬äºŒè¡Œå¯†ç ã€‚ä¸èƒ½ä½¿ç”¨rootï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># vim /etc/vsftpd/xuniusers</span></span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">23123213</span><br><span class="line">test1</span><br><span class="line">34dsfds</span><br><span class="line">test2</span><br><span class="line">df43sd</span><br></pre></td></tr></table></figure><h3 id="5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶"><a href="#5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶" class="headerlink" title="5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶"></a>5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶</h3><p>è¿™é‡Œéœ€è¦å®‰è£…db4,è®¾ç½®PAMæ–‡ä»¶æƒé™ï¼Œå¹¶åˆ¶å®šè™šæ‹Ÿç”¨æˆ·æ•°æ®åº“æ–‡ä»¶è¯»å–</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum â€“y install db4-utils</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># db_load -T -t hash -f /etc/vsftpd/xuniusers /etc/vsftpd/xuniusers.db</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chmod 600 /etc/vsftpd/xuniusers.db</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨/etc/pam.d/vsftpdçš„æ–‡ä»¶å¤´éƒ¨åŠ å…¥ä»¥ä¸‹ä¿¡æ¯ï¼ˆæ³¨*è¿™é‡Œä¸€å®šè¦åœ¨å‰é¢ï¼Œä¸èƒ½å†åé¢ï¼Œåˆšå¼€å§‹æˆ‘ä¹ŸåŠ è½½åˆ°åé¢ç™»é™†çš„æ—¶å€™æç¤ºé”™è¯¯ï¼‰,ä¿®æ”¹å‰å…ˆå¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># cp /etc/pam.d/vsftpd /etc/pam.d/vsftpd.bak</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vi /etc/pam.d/vsftpd</span></span><br><span class="line">auth sufficient /lib/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br><span class="line">account sufficient /lib/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/%E5%9B%BE%E7%89%87%201.png" alt="img"></p><ul><li>æ³¨*64ä½çš„æ“ä½œç³»ç»Ÿï¼Œåˆ™ä¸Šé¢libæ”¹ä¸º64ã€‚ä¸ç„¶é…ç½®ä¹Ÿä¼šæ— æ•ˆ</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">auth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br><span class="line">account sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å»ºç«‹ä¸€ä¸ªç³»ç»Ÿç”¨æˆ·vsftpdï¼Œç”¨æˆ·çš„ä¸»ç›®å½•å¯ä»¥è‡ªå·±è®¾ç½®ï¼Œ/home/wwwrootï¼Œè®¾ç½®ç”¨æˆ·ç™»é™†çš„ç»ˆç«¯ä¸º/bin/false</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># useradd vsftpd -d /home/wwwroot -s /bin/false</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chown vsftpd:vsftpd /home/wwwroot -R</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chown www:www /home/wwwroot â€“R #å¦‚æœè™šæ‹Ÿç”¨æˆ·çš„å®¿ä¸»ç”¨æˆ·ä¸ºnginxï¼Œéœ€è¦è¿™æ ·è®¾ç½®ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶"><a href="#6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶" class="headerlink" title="6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶"></a>6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># mkdir /etc/vsftpd/vconf</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># cd /etc/vsftpd/vconf</span></span><br><span class="line">touch test1 test2 test3 <span class="comment">#è¿™é‡Œåˆ›å»ºä¸‰ä¸ªè™šæ‹Ÿç”¨æˆ·é…ç½®æ–‡ä»¶</span></span><br><span class="line">vi web1 <span class="comment">#ç¼–è¾‘ç”¨æˆ·test1é…ç½®æ–‡ä»¶ï¼Œå…¶ä»–çš„è·Ÿè¿™ä¸ªé…ç½®æ–‡ä»¶ç±»ä¼¼</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vim test1</span></span><br><span class="line">local_root=/home/wwwroot/test1/</span><br><span class="line">write_enable=YES</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod u-w /home/wwwroot</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;æœ€åé‡å¯vsftpdæœåŠ¡,ä¸å…³é—­Selinuxå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é€šè¿‡FTPã€‚é˜²ç«å¢™å¼€æ”¾ç«¯å£<code>setsebool -P ftpd_disable_trans 1</code><br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¿°é…ç½®å®Œæˆåè¿˜å¯ä»¥é€šè¿‡#adduser -d /ç›®å½•è·¯å¾„ -g vsftpd -s /sbin/nologin ç”¨æˆ·å è¿™ä¸ªå‘½ä»¤æ¥æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œä¸éœ€è¦é…ç½®ä»»ä½•æƒé™éƒ½å¯ä»¥è¿›è¡ŒFTPçš„è®¿é—®,æœ€åè¡¥å……è¯´æ˜ï¼Œéœ€è¦å®‰è£…çš„å…¶ä»–æ’ä»¶</p><ul><li><p>éœ€è¦å®‰è£…çš„çš„æ˜¯pan</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum install -y pam</span></span><br></pre></td></tr></table></figure></li><li><p>è¿™é‡Œæˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹æ—¥å¿—ï¼Œå¯ä»¥æ ¹æ®æç¤ºçš„æç¤ºæ¥åˆ¤æ–­ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># cat /var/log/secure</span></span><br></pre></td></tr></table></figure></li></ul><p>æµ‹è¯•ç”¨æˆ·ç™»å½•è™šæ‹Ÿç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±æœ¬èº«çš„ç›®å½• ï¼Œä¸èƒ½å»å…¶ä»–ç›®å½•æŸ¥çœ‹(åˆ°è¿™é‡Œvsftpdé…ç½®ç»“æŸ)</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>vsftpd</tag>
      </tags>
  </entry>
  <entry>
    <title>TeamViewer macç ´è§£</title>
    <url>/2019/08/09/TeamViewer-mac%E7%A0%B4%E8%A7%A3/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h2 id="TeamViewer14-4-MACç ´è§£"><a href="#TeamViewer14-4-MACç ´è§£" class="headerlink" title="TeamViewer14.4 MACç ´è§£"></a>TeamViewer14.4 MACç ´è§£</h2><h3 id="åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤"><a href="#åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤" class="headerlink" title="åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤"></a>åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo python TeamViewer-id-changer.py</span><br><span class="line">ä½¿ç”¨macè‡ªå¸¦python2.7 æ‰§è¡Œå³å¯</span><br></pre></td></tr></table></figure><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim TeamViewer-id-changer.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2019/8/1 14:57</span></span><br><span class="line"><span class="comment"># @Author  : xxlaila</span></span><br><span class="line"><span class="comment"># @Site    : </span></span><br><span class="line"><span class="comment"># @File    : TeamViewer-id-changer.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">import platform</span><br><span class="line">import random</span><br><span class="line">import re</span><br><span class="line">import string</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">--------------------------------</span></span><br><span class="line"><span class="string">TeamViewer 14 ID Changer for MAC OS</span></span><br><span class="line"><span class="string">Version: 0.2 2019</span></span><br><span class="line"><span class="string">--------------------------------</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> platform.system() != <span class="string">"Darwin"</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"This script can be run only on MAC OS."</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.geteuid() != 0:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"This script must be run form root."</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">"SUDO_USER"</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">    USERNAME = os.environ[<span class="string">"SUDO_USER"</span>]</span><br><span class="line">    <span class="keyword">if</span> USERNAME == <span class="string">"root"</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Can not find user name. Run this script via sudo from regular user"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Can not find user name. Run this script via sudo from regular user"</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line">HOMEDIRLIB = <span class="string">"/Users/"</span> + USERNAME + <span class="string">"/library/preferences/"</span></span><br><span class="line">GLOBALLIB = <span class="string">"/library/preferences/"</span></span><br><span class="line"></span><br><span class="line">CONFIGS = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Find config files</span></span><br><span class="line"></span><br><span class="line">def listdir_fullpath(d):</span><br><span class="line">    <span class="built_in">return</span> [os.path.join(d, f) <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(d)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> listdir_fullpath(HOMEDIRLIB):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'teamviewer'</span> <span class="keyword">in</span> file.lower():</span><br><span class="line">        CONFIGS.append(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> listdir_fullpath(GLOBALLIB):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'teamviewer'</span> <span class="keyword">in</span> file.lower():</span><br><span class="line">        CONFIGS.append(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not CONFIGS:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">            There is no TemViewer configs found.</span></span><br><span class="line"><span class="string">            Maybe you have deleted it manualy or never run TeamViewer after installation.</span></span><br><span class="line"><span class="string">            Nothing to delete.</span></span><br><span class="line"><span class="string">            '</span><span class="string">''</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Delete config files</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Configs found:\n"</span>)</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> CONFIGS:</span><br><span class="line">        <span class="built_in">print</span>(file)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">        This files will be DELETED permanently.</span></span><br><span class="line"><span class="string">        All TeamViewer settings will be lost</span></span><br><span class="line"><span class="string">        '</span><span class="string">''</span>)</span><br><span class="line">        raw_input(<span class="string">"Press Enter to continue or CTR+C to abort..."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> CONFIGS:</span><br><span class="line">        try:</span><br><span class="line">            os.remove(file)</span><br><span class="line">        except:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Cannot delete config files. Permission denied?"</span>)</span><br><span class="line">            sys.exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Done."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find binaryes</span></span><br><span class="line"></span><br><span class="line">TMBINARYES = [</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/MacOS/TeamViewer'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/MacOS/TeamViewer_Service'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/Helpers/TeamViewer_Desktop'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/Helpers/TeamViewer_Assignment'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> TMBINARYES:</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(file):</span><br><span class="line">        pass</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"File not found: "</span> + file)</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">"Install TeamViewer correctly"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Patch files</span></span><br><span class="line"></span><br><span class="line">def idpatch(fpath, platf, serial):</span><br><span class="line">    file = open(fpath, <span class="string">'r+b'</span>)</span><br><span class="line">    binary = file.read()</span><br><span class="line">    PlatformPattern = <span class="string">"IOPlatformExpert.&#123;6&#125;"</span></span><br><span class="line">    SerialPattern = <span class="string">"IOPlatformSerialNumber%s%s%s"</span></span><br><span class="line"></span><br><span class="line">    binary = re.sub(PlatformPattern, platf, binary)</span><br><span class="line">    binary = re.sub(SerialPattern % (chr(0), <span class="string">"[0-9a-zA-Z]&#123;8,8&#125;"</span>, chr(0)), SerialPattern % (chr(0), serial, chr(0)), binary)</span><br><span class="line"></span><br><span class="line">    file = open(fpath, <span class="string">'wb'</span>).write(binary)</span><br><span class="line">    <span class="built_in">return</span> True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def random_generator(size=8, chars=string.ascii_uppercase + string.ascii_lowercase + string.digits):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join(random.choice(chars) <span class="keyword">for</span> _ <span class="keyword">in</span> range(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RANDOMSERIAL = random_generator(8)</span><br><span class="line">RANDOMPLATFORM = <span class="string">"IOPlatformExpert"</span> + random_generator(6)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> TMBINARYES:</span><br><span class="line">    try:</span><br><span class="line">        idpatch(file, RANDOMPLATFORM, RANDOMSERIAL)</span><br><span class="line">    except:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Error: can not patch file "</span> + file)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"PlatformDevice: "</span> + RANDOMPLATFORM)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"PlatformSerial: "</span> + RANDOMSERIAL)</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">"sudo codesign -f -s - /Applications/TeamViewer.app/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">ID changed sucessfully.</span></span><br><span class="line"><span class="string">!!! Restart computer before using TeamViewer !!!!</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span>)</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>TeamViewer</category>
      </categories>
      <tags>
        <tag>TeamViewer</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkins jobç®¡ç†</title>
    <url>/2019/08/09/jenkins-job%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><ul><li><strong>ä»‹ç»</strong>: ç”±äºå…¬å¸çš„ciç”¨äºç¼–è¯‘çš„ç¯å¢ƒæ¯”è¾ƒå¤šï¼Œä¸ºäº†æ›´å¥½çš„åŒºåˆ†ï¼Œä¸ºæ¯ä¸€ä¸ªç¯å¢ƒå»ºç«‹äº†ä¸€ä¸ªview</li><li><strong>ç—›ç‚¹</strong>: è¿ç»´äººå‘˜åœ¨å»ºç«‹jobçš„æ—¶å€™éœ€è¦åˆ°å¯¹åº”çš„viewä¸‹é¢å»ºç«‹ï¼Œè™½ç„¶è¿™ä¸æ˜¯ç‹ ç—›è‹¦ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚</li><li><strong>è§£å†³</strong>: äººå‘˜ç™»é™†é»˜è®¤æ˜¯åœ¨all viewä¸‹é¢ï¼Œæ¯ä¸ªè¿ç»´äººå‘˜åœ¨è¿™ä¸‹é¢å»ºç«‹jobï¼Œç„¶åæ¯ä¸ªviewæ ¹æ®è‡ªå·±çš„è§„åˆ™å§å¯¹åº”çš„jobæ·»åŠ è¿›æ¥ã€‚jobè§„åˆ™è‡ªå·±æå‰å®šä¹‰å¥½</li></ul><h2 id="1ã€å®‰è£…jenkinsæ’ä»¶"><a href="#1ã€å®‰è£…jenkinsæ’ä»¶" class="headerlink" title="1ã€å®‰è£…jenkinsæ’ä»¶"></a>1ã€å®‰è£…jenkinsæ’ä»¶</h2><p>view job è¿‡æ»¤æ’ä»¶view-job-filtersï¼Œå®‰è£…è¿‡ç¨‹ä¸ç´¯èµ˜</p><h2 id="2ã€é…ç½®viewè§„åˆ™"><a href="#2ã€é…ç½®viewè§„åˆ™" class="headerlink" title="2ã€é…ç½®viewè§„åˆ™"></a>2ã€é…ç½®viewè§„åˆ™</h2><p>è¿™é‡Œè®¾ç½®ä¸¤ä¸ªå‰ç«¯å’Œä¸€ä¸ªåç«¯å®ä¾‹</p><a id="more"></a><h3 id="2-1ã€å‰ç«¯1"><a href="#2-1ã€å‰ç«¯1" class="headerlink" title="2.1ã€å‰ç«¯1"></a>2.1ã€å‰ç«¯1</h3><p><img src="https://img.xxlaila.cn/image2018-5-29_10-47-20.png" alt="img"></p><h3 id="2-2ã€å‰ç«¯test"><a href="#2-2ã€å‰ç«¯test" class="headerlink" title="2.2ã€å‰ç«¯test"></a>2.2ã€å‰ç«¯test</h3><p>test æˆ‘ä»¬ç”¨å®‰è£…çš„è¿™ä¸ªæ’ä»¶æ¥è¿›è¡Œé…ç½®,ç‚¹å‡»Add Job Filterâ€”â€”&gt;ä¼šæœ‰å¾ˆå¤šçš„è§„åˆ™ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„çŠ¶æ€ã€æ ç›®æ¥è¿›è¡Œå´åˆ†ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©</p><p><img src="https://img.xxlaila.cn/image2018-5-29_10-49-46.png" alt="img"><br><img src="https://img.xxlaila.cn/image2018-5-29_10-52-49.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæ·»åŠ äº†ä¸¤æ¡è§„åˆ™ï¼Œè¿™ä¸ªæ˜¯å»ºç«‹jobçš„æ—¶å€™æœ‰ç‚¹ç‰¹æ®Šæ€§ï¼Œç”¨ç¬¬ä¸€ç§æ–¹å¼å®ç°å°±ä¼šæœ‰é—®é¢˜ï¼Œç¬¬ä¸€æ¡è§„åˆ™æ˜¯ç°å®æ‰€æœ‰testç±»çš„jobï¼Œä½†æ˜¯å§ä¸‹é¢çš„ä¸€æ¡ç»™åŠ è¿›æ¥äº†ï¼Œä¸ç°å®è¿™ç±»jobã€‚ä¿æŒå³å¯</p><h2 id="åç«¯javaç¨‹åº"><a href="#åç«¯javaç¨‹åº" class="headerlink" title="åç«¯javaç¨‹åº"></a>åç«¯javaç¨‹åº</h2><p>devç¯å¢ƒä¸ºä¾‹å­</p><p><img src="https://img.xxlaila.cn/image2018-5-29_10-54-54.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins job</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsç”¨æˆ·æƒé™é…ç½®</title>
    <url>/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><h3 id="1ã€jenkinsç”¨æˆ·æƒé™"><a href="#1ã€jenkinsç”¨æˆ·æƒé™" class="headerlink" title="1ã€jenkinsç”¨æˆ·æƒé™"></a>1ã€jenkinsç”¨æˆ·æƒé™</h3><ul><li>å¯ä»¥é›†æˆgitlabã€jenkinsä¸“æœ‰è´¦æˆ·ã€LDAPã€Servletå®¹å™¨ä»£ç†ã€Unixç”¨æˆ·/ç»„æ•°æ®åº“</li></ul><h3 id="2ã€æˆæƒç­–ç•¥"><a href="#2ã€æˆæƒç­–ç•¥" class="headerlink" title="2ã€æˆæƒç­–ç•¥"></a>2ã€æˆæƒç­–ç•¥</h3><ul><li>Gitlab Commiter Authorization Strategy</li><li>Role-Based Strategy</li><li>ä»»ä½•ç”¨æˆ·å¯ä»¥åšä»»ä½•äº‹(æ²¡æœ‰ä»»ä½•é™åˆ¶)</li><li>å®‰å…¨çŸ©é˜µ</li><li>ç™»å½•ç”¨æˆ·å¯ä»¥åšä»»ä½•äº‹</li><li>é—ç•™æ¨¡å¼</li><li>é¡¹ç›®çŸ©é˜µæˆæƒç­–ç•¥</li></ul><h3 id="3ã€æ’ä»¶å®‰è£…"><a href="#3ã€æ’ä»¶å®‰è£…" class="headerlink" title="3ã€æ’ä»¶å®‰è£…"></a>3ã€æ’ä»¶å®‰è£…</h3><p>å®‰è£…æ’ä»¶ï¼šRole-based Authorization Strategy</p><a id="more"></a><h3 id="4ã€jenkinsè®¾ç½®"><a href="#4ã€jenkinsè®¾ç½®" class="headerlink" title="4ã€jenkinsè®¾ç½®"></a>4ã€jenkinsè®¾ç½®</h3><p>ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®â€”â€”&gt;<br><img src="https://img.xxlaila.cn/image2018-5-11_14-26-37.png" alt="img"></p><p>å›åˆ°ç³»ç»Ÿç®¡ç†ç•Œé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°å¤šå‡ºæ¥ä¸€ä¸ªæ’ä»¶: Mangge and Assing Roles</p><h3 id="5ã€æƒé™è®¾ç½®"><a href="#5ã€æƒé™è®¾ç½®" class="headerlink" title="5ã€æƒé™è®¾ç½®"></a>5ã€æƒé™è®¾ç½®</h3><p>è¿›å…¥Manager and Assign Rolesâ€”â€”&gt;Manage Roles,è¿™é‡Œå»ºç«‹äº†å››ä¸ªæƒé™ï¼Œåˆ†åˆ«æ¥å¯¹åº”ä¸åŒçš„äººå‘˜<br><img src="https://img.xxlaila.cn/image2018-5-24_11-35-15.png" alt="img"></p><ul><li>åˆ›å»ºé¡¹ç›®è§’è‰²:</li></ul><p><img src="https://img.xxlaila.cn/image2018-5-24_11-35-27.png" alt="img"></p><p>å›åˆ°Manage and Assign Rolesç•Œé¢</p><h3 id="6ã€é…ç½®è§’è‰²"><a href="#6ã€é…ç½®è§’è‰²" class="headerlink" title="6ã€é…ç½®è§’è‰²"></a>6ã€é…ç½®è§’è‰²</h3><p>é€‰æ‹©Assign Roles,ç”¨æˆ·æ–°å»ºä»¥åï¼Œæ ¹æ®ç”¨æˆ·ä¸åŒç±»å‹çš„å‹¾é€‰ä¸åŒçš„æƒé™,</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodbå‰¯æœ¬é›†</title>
    <url>/2019/08/09/mongodb%E5%89%AF%E6%9C%AC%E9%9B%86/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:42:28 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Mongodb replica setå®‰è£…åŠ è®¤è¯ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯keyFileè¿›è¡Œè®¤è¯ï¼Œä¹‹å‰çœ‹è¿‡å¾ˆå¤šæ–‡ç« ï¼Œå‘ä¸€å¤§å †ï¼Œè¿™é‡Œæ˜¯çœ‹äº†ä¸¤å¤©çš„å®˜æ–¹æ–‡æ¡£è¿›è¡Œçš„å®‰è£…ï¼Œå¹¶ç”¨æˆ·ç”Ÿäº§ï¼Œé…ç½®æ–‡ä»¶å‚æ•°è´´ä¸€éƒ¨åˆ†,ä¸‰ä¸ªå¸¦æœ‰æ•°æ®é›†çš„èŠ‚ç‚¹ç»„æˆçš„å¤åˆ¶é›†æ‹¥æœ‰ï¼Œæ¶æ„å›¾å¦‚ä¸‹ï¼Œå‚è€ƒå®˜æ–¹</p><p><img src="https://img.xxlaila.cn/image2018-8-13_15-27-53.png" alt="img"><br>ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ï¼Œè¿™ä¸¤ä¸ªä»èŠ‚ç‚¹éƒ½å¯ä»¥åœ¨é€‰ä¸¾ä¸­å‡çº§ä¸ºä¸»èŠ‚ç‚¹</p><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>ä¸‰å°æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">primary: 192.168.32.7</span><br><span class="line">secaodray: 192.168.32.11</span><br><span class="line">secondary: 192.168.32.14</span><br></pre></td></tr></table></figure><h2 id="1ã€å®‰è£…mongodb"><a href="#1ã€å®‰è£…mongodb" class="headerlink" title="1ã€å®‰è£…mongodb"></a>1ã€å®‰è£…mongodb</h2><h3 id="1-1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ"><a href="#1-1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ" class="headerlink" title="1.1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ"></a>1.1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo vim /etc/yum.repos.d/mongodb-enterprise.repo</span></span><br><span class="line">[mongodb-enterprise]</span><br><span class="line">name=MongoDB Enterprise Repository</span><br><span class="line">baseurl=https://repo.mongodb.com/yum/redhat/<span class="variable">$releasever</span>/mongodb-enterprise/3.4/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc   </span><br><span class="line"></span><br><span class="line"><span class="comment"># sudo yum install -y mongodb-enterprise</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå¦‚æœé‡‡ç”¨æºç åŒ…æ–¹å¼å®‰è£…éœ€è¦å®‰è£…ä¸€ä¸‹æ’ä»¶</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo yum install cyrus-sasl cyrus-sasl-plain cyrus-sasl-gssapi krb5-libs lm_sensors-libs net-snmp-agent-libs net-snmp openssl rpm-libs tcp_wrappers-libs libcurl</span></span><br></pre></td></tr></table></figure><h2 id="2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶-æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ"><a href="#2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶-æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ" class="headerlink" title="2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶(æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ)"></a>2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶(æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ)</h2><h3 id="è‡ªå®šä¹‰mongodbçš„ç›®å½•"><a href="#è‡ªå®šä¹‰mongodbçš„ç›®å½•" class="headerlink" title="è‡ªå®šä¹‰mongodbçš„ç›®å½•"></a>è‡ªå®šä¹‰mongodbçš„ç›®å½•</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /opt/mongodb/&#123;data,conf,logs&#125; -p</span></span><br><span class="line"><span class="comment"># sudo vim /etc/mongod.conf</span></span><br><span class="line"> systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /opt/mongodb/logs/mongod.log</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /opt/mongodb/data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  pidFilePath: /opt/mongodb/logs/mongod.pid</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0</span><br></pre></td></tr></table></figure><h3 id="3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶-åœ¨mong01ä¸Šæ“ä½œ"><a href="#3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶-åœ¨mong01ä¸Šæ“ä½œ" class="headerlink" title="3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶(åœ¨mong01ä¸Šæ“ä½œ)"></a>3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶(åœ¨mong01ä¸Šæ“ä½œ)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl rand -base64 756 &gt; ï¼opt/mongodb/conf/mongo-keyfile</span></span><br><span class="line"><span class="comment"># sudo chmod 400 /opt/mongo/mongo-keyfile</span></span><br><span class="line"><span class="comment"># scp â€“r mongo-keyfile user@192.168.32.11:/opt/mongodb/conf</span></span><br><span class="line"><span class="comment"># scp â€“r mongo-keyfile user@192.168.32.14:/opt/mongodb/conf</span></span><br></pre></td></tr></table></figure><h3 id="4ã€ä¿®æ”¹mongodbçš„é…ç½®"><a href="#4ã€ä¿®æ”¹mongodbçš„é…ç½®" class="headerlink" title="4ã€ä¿®æ”¹mongodbçš„é…ç½®"></a>4ã€ä¿®æ”¹mongodbçš„é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">security:</span><br><span class="line">  keyFile: /opt/mongodb/conf/mongo-keyfile</span><br><span class="line">replication:</span><br><span class="line">  replSetName: xxlaila01ï¼ˆå¯å˜åŒ–ï¼Œè‡ªå®šä¹‰ï¼‰</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«åœ¨ä¸‰å°æœåŠ¡å™¨ä¸Šå¯åŠ¨mongodb</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mongod --config /etc/mongod.conf</span></span><br></pre></td></tr></table></figure><h3 id="5ã€å»ºç«‹é›†ç¾¤"><a href="#5ã€å»ºç«‹é›†ç¾¤" class="headerlink" title="5ã€å»ºç«‹é›†ç¾¤"></a>5ã€å»ºç«‹é›†ç¾¤</h3><p>åœ¨ä½ éœ€è¦è®¤ä¸ºæ˜¯ä¸»èŠ‚ç‚¹çš„æœåŠ¡å™¨è¿›è¡Œmongodbçš„ç™»é™†ï¼Œå’Œè´¦æˆ·æƒé™çš„å»ºç«‹ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©çš„192.168.32.7</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongo --shell --host 127.0.0.1</span><br></pre></td></tr></table></figure><p>ç™»é™†è¿›å»ä»¥åå¯ä»¥è¿›è¡Œä¸€ä¸ªç®€å•çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹</p><p><img src="https://img.xxlaila.cn/image2018-8-13_15-37-2.png" alt="img"></p><h3 id="6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†"><a href="#6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†" class="headerlink" title="6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†"></a>6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise &gt; config = &#123; _id:<span class="string">"kxlprod01"</span>,members:[ &#123;_id:0,host:<span class="string">"192.168.32.7:27017"</span>&#125;,</span><br><span class="line">...   &#123;_id:1,host:<span class="string">"192.168.32.11:27017"</span>&#125; ,&#123;_id:2,host:<span class="string">"192.168.32.14:27017"</span>&#125;] &#125;</span><br></pre></td></tr></table></figure><p>config = { _id:â€kxlprod01â€,members:[ {_id:0,host:â€192.168.32.7:27017â€},{_id:1,host:â€192.168.32.11:27017â€} ,{_id:2,host:â€192.168.32.14:27017â€}] }ï¼Œå¢åŠ å†…å®¹</p><h4 id="6-1-çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€"><a href="#6-1-çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€" class="headerlink" title="6.1 çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€"></a>6.1 çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€</h4><p>åˆ©ç”¨rs.status()å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; rs.status()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæç¤ºé…ç½®è¿˜æ²¡æœ‰åŠ è½½åˆ°mongodbå‰¯æœ¬é‡Œé¢</p><h4 id="6-2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†"><a href="#6-2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†" class="headerlink" title="6.2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†"></a>6.2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; rs.initiate(config)</span><br></pre></td></tr></table></figure><p>å†æ¬¡æŸ¥çœ‹å‰¯æœ¬çš„çŠ¶æ€å°±å¯ä»¥çœ‹åˆ°mongodbçš„å‰¯æœ¬é›†å·²å»ºç«‹ï¼Œå¦‚æœæ­¤æ—¶ä¸»èŠ‚ç‚¹æœªè¢«é€‰ä¸¾å‡ºæ¥ï¼Œç¨å¾®ç­‰ä¸€ä¼šå°±æˆåŠŸ</p><h3 id="7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯"><a href="#7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯" class="headerlink" title="7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯"></a>7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯</h3><p>ä¸‹é¢ä¸¤è¡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡ä¸»èŠ‚ç‚¹æ²¡æœ‰é€‰ä¸¾æˆåŠŸï¼Œéšå³æˆ‘ä»¬åœ¨å›è½¦PRIMARYèŠ‚ç‚¹é€‰ä¸¾æˆåŠŸäº†ï¼Œä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise xxlaila01:SECONDARY&gt; admin = db.getSiblingDB(<span class="string">"admin"</span>)</span><br><span class="line">MongoDB Enterprise xxlaila01:PRIMARY&gt;</span><br><span class="line">admin.createUser(</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    user: <span class="string">"root"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"123456"</span>,</span><br><span class="line"></span><br><span class="line">    roles: [ &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"root"</span>, <span class="string">"123456"</span> )</span><br></pre></td></tr></table></figure><h4 id="7-1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·"><a href="#7-1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·" class="headerlink" title="7.1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·"></a>7.1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·</h4><p>åˆ›å»ºä¸€ä¸ªé›†ç¾¤ç®¡ç†è´¦æˆ·ï¼Œé›†ç¾¤è´¦æˆ·å…·æœ‰ç®¡ç†æ•´ä¸ªå‰¯æœ¬é›†çš„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo -u <span class="string">"root"</span> -p <span class="string">"123456"</span> --authenticationDatabase <span class="string">"admin"</span></span><br><span class="line"></span><br><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"user"</span> : <span class="string">"manger"</span>,</span><br><span class="line">    <span class="string">"pwd"</span> : <span class="string">"123456"</span>,</span><br><span class="line">    roles: [ &#123; <span class="string">"role"</span> : <span class="string">"clusterAdmin"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span> &#125; ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="7-2-åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·"><a href="#7-2-åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·" class="headerlink" title="7.2 åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·"></a>7.2 åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"user"</span> : <span class="string">"systemprod"</span>,</span><br><span class="line">    <span class="string">"pwd"</span> : <span class="string">"123456"</span>,</span><br><span class="line">    roles: [ &#123; <span class="string">"role"</span> : <span class="string">"root"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è‡³æ­¤mongodbçš„å‰¯æœ¬é›†åˆ›å»ºå®Œæˆã€‚æµ‹è¯•æ²¡æœ‰é—®é¢˜,ç™»é™†å…¶ä¸­ä¸€å°SECONDARYæœåŠ¡å™¨è¿›è¡Œæµ‹è¯•,è¿™é‡Œæµ‹è¯•192.168.32.11æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo</span><br><span class="line"></span><br><span class="line">&gt; rs.status()    <span class="comment"># è¿™é‡Œæç¤ºæ²¡æœ‰æƒé™ï¼ˆç™»å½•è¿›æ¥ä»¥åå¦‚æœä¸æ˜¯ä¸»å‡ ç‚¹ï¼Œmognodbå°±ä¼šé»˜è®¤æ˜¾ç¤ºæœªsecondaryï¼‰</span></span><br><span class="line"></span><br><span class="line">&gt; use admin 	<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">&gt; db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"manger"</span>, <span class="string">"123456"</span>)</span><br></pre></td></tr></table></figure><p>å®Œæˆåæˆ‘ä»¬åœ¨æ‰§è¡Œrs.status()å°±å¯ä»¥çœ‹åˆ°å‰¯æœ¬é›†çš„ä¿¡æ¯</p><h4 id="7-3-æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·"><a href="#7-3-æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·" class="headerlink" title="7.3 æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·"></a>7.3 æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise xxlaila01:SECONDARY&gt; db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"systemprod"</span>, <span class="string">"123456"</span> )</span><br><span class="line">&gt; show dbs;	<span class="comment">#ä¼šæç¤º â€œnot master and slaveok=falseâ€</span></span><br><span class="line"></span><br><span class="line">&gt; db.getMongo().setSlaveOk()</span><br><span class="line">&gt; show dbs;	<span class="comment">#åœ¨æ¬¡æ‰§è¡Œä¼šæ˜¾ç¤ºå‡ºç»“æœ</span></span><br></pre></td></tr></table></figure><p>å‰¯æœ¬é›†æ²¡æœ‰è¯»çš„æƒé™ï¼Œéœ€è¦æ‰§è¡Œdb.getMongo().setSlaveOk()</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>mongodb,mongodbå‰¯æœ¬é›†,mongodbé«˜å¯ç”¨</tag>
      </tags>
  </entry>
</search>
