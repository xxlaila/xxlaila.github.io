<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>mysql8.0 é”™è¯¯</title>
    <url>/2019/11/07/mysql8.0%E9%94%99%E8%AF%AF/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h4 id="mysql-8-0-å€’å…¥æ•°æ®æŠ¥é”™"><a href="#mysql-8-0-å€’å…¥æ•°æ®æŠ¥é”™" class="headerlink" title="mysql 8.0 å€’å…¥æ•°æ®æŠ¥é”™"></a>mysql 8.0 å€’å…¥æ•°æ®æŠ¥é”™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»Šå¤©æ•°æ®åº“ä»5.6åˆ‡æ¢åˆ°8.0æµ‹è¯•çš„æ—¶å€™ï¼Œå€’å…¥æ•°æ®åˆ°8.0ç‰ˆæœ¬æŠ¥é”™ï¼Œé”™è¯¯æç¤ºï¼š2006 mysql server has gone awayã€‚<a id="more"></a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç»è¿‡æŸ¥è¯¢å¾—çŸ¥ï¼Œå¯¼å…¥SQLæ•°æ®åº“ç»“æ„+æ•°æ®æ—¶ï¼Œå¦‚æœsqlæ“ä½œæ—¶é—´è¿‡é•¿ï¼›æˆ–è€…æ˜¯ä¼ é€çš„æ•°æ®å¤ªå¤§ï¼ˆå’§å¦‚ä½¿ç”¨insertâ€¦valuesçš„è¯­å¥è¿‡é•¿ï¼‰ï¼›å°±ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ã€‚ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹äº†æ•°æ®åº“è¿æ¥è¶…æ—¶çš„æ—¶é—´é»˜è®¤æ˜¯8å°æ—¶ï¼Œé—®é¢˜åº”è¯¥ä¸æ˜¯å‡ºç°åœ¨è¿™é‡Œã€‚ç™»å½•è€ç‰ˆæœ¬æ•°æ®æŸ¥çœ‹è¯¥æ•°æ®åº“è¡¨çš„æ•°æ®ï¼Œå‘ç°è¯¥è¡¨å­˜æ”¾æ˜¯jsonçš„æ•°æ®æ ¼å¼æ•°æ®ï¼Œè€Œä¸”å¾ˆå¤§ï¼Œå¾ˆé•¿ã€‚é‚£ä¹ˆé—®é¢˜ç‚¹å‡ºæ¥äº†ï¼Œå°±å¯ä»¥è§£å†³äº†</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡ä¿®æ”¹max_allowed_packedçš„é…ç½®å‚æ•°æ¥é¿å…ï¼Œä¿®æ”¹my.cnfåŠ å¤§max_allowed_packetçš„å€¼å³å¯ã€‚</p><ul><li>è§£å†³åŠæ³•<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰¾åˆ°ä½ çš„mysqlç›®å½•ä¸‹çš„my.inié…ç½®æ–‡ä»¶ï¼ŒåŠ å…¥ä»¥ä¸‹é…ç½®æˆ–è€…ä¿®æ”¹ä»¥ä¸‹é…ç½®<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">max_allowed_packet=300M</span><br></pre></td></tr></table></figure></li></ul><h4 id="å‚æ•°è¯¦è§£"><a href="#å‚æ•°è¯¦è§£" class="headerlink" title="å‚æ•°è¯¦è§£"></a>å‚æ•°è¯¦è§£</h4><ul><li><strong>max_allowed_packet</strong>: mysqlæ ¹æ®é…ç½®æ–‡ä»¶ä¼šé™åˆ¶serveræ¥å—çš„æ•°æ®åŒ…å¤§å°ã€‚å¦‚æœä¸€æ¬¡æ’å…¥æ•°æ®åº“ä¸­çš„æ•°æ®å¤ªå¤§çš„è¯å°±ä¼šå¤±è´¥ï¼Œ<a href="https://dev.mysql.com/doc/refman/8.0/en/packet-too-large.html" target="_blank" rel="noopener">å®˜æ–¹ä»‹ç»</a>ï¼Œ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæˆ‘åˆšå¼€å§‹ä¿®æ”¹çš„æ˜¯200Mï¼Œè¿˜æ˜¯å‡ºç°è¿™ä¸ªé”™è¯¯ï¼Œç„¶åæˆ‘çœ‹äº†ä¸€ä¸‹sqlæ–‡ä»¶å¤§å°æ˜¯åœ¨260å¤šMï¼Œç´¢æ€§æˆ‘å°±æŠŠè¿™ä¸ªå‚æ•°è°ƒæ•´ä¸º300Mï¼Œåœ¨æ‰§è¡Œå€’å…¥æ•°æ®okã€‚è¿™ä¸ªå‚æ•°è°ƒå¤§ä¸ä¼šå½±å“æœåŠ¡å™¨çš„æ€§èƒ½ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹è¯´æ˜ã€‚</li></ul><h4 id="mysql-1067-Invalid-default-value-for"><a href="#mysql-1067-Invalid-default-value-for" class="headerlink" title="mysql 1067 - Invalid default value for"></a>mysql 1067 - Invalid default value for</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mysql 8.0 åœ¨å€’å…¥æ•°æ®çš„æ—¶å€™æç¤º: 1067 - Invalid default value for â€˜xxx_dateâ€™ã€‚æŸ¥è¯¢ç»“æœå¾—çŸ¥è·¨ç‰ˆæœ¬å‡çº§å¼•èµ·çš„é»˜è®¤å€¼ä¸å…¼å®¹é—®é¢˜ï¼Œç™»å½•è€æœåŠ¡å™¨æŸ¥çœ‹è¯¥å­—æ®µæ˜¯ä¸€ä¸ªæ—¶é—´å­—æ®µï¼Œæ˜¯ä¸€ä¸ªdatetimeç±»å‹ï¼Œè€Œä¸”é»˜è®¤æ˜¯0ï¼Œç„¶åçœ‹äº†ä¸€ä¸‹å¯¼å‡ºçš„æ•°æ®æ•°æ®æ ¼å¼å±…ç„¶æ˜¯0000-00-00ï¼Œè¯¥ç±»å‹å¯èƒ½æ˜¯é»˜è®¤å€¼è¢«é™åˆ¶äº†ï¼ŒæŸ¥çœ‹ sql_modeã€‚</p><h5 id="æŸ¥çœ‹-sql-mode"><a href="#æŸ¥çœ‹-sql-mode" class="headerlink" title="æŸ¥çœ‹ sql_mode"></a>æŸ¥çœ‹ sql_mode</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'sql_mode'</span>;</span><br><span class="line">+---------------+-----------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                 |</span><br><span class="line">+---------------+-----------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+-----------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.02 sec)</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NO_ZERO_IN_DATE,NO_ZERO_DATEè¿™ä¸¤ä¸ªå‚æ•°é™åˆ¶æ—¶é—´ä¸èƒ½ä¸º0</p><h5 id="ä¸´æ—¶ä¿®æ”¹"><a href="#ä¸´æ—¶ä¿®æ”¹" class="headerlink" title="ä¸´æ—¶ä¿®æ”¹"></a>ä¸´æ—¶ä¿®æ”¹</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> session sql_mode=<span class="string">'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæˆ‘æ“ä½œäº†ï¼Œæ²¡æˆåŠŸï¼Œæˆ‘ç”¨çš„æ°¸ä¹…ä¿®æ”¹æˆåŠŸå¯¼å…¥çš„ã€‚ä¸çŸ¥é“ä¸ºå•¥ï¼Œå¯èƒ½æ˜¯å§¿åŠ¿ä¸å¯¹</p><h5 id="æ°¸ä¹…ä¿®æ”¹"><a href="#æ°¸ä¹…ä¿®æ”¹" class="headerlink" title="æ°¸ä¹…ä¿®æ”¹"></a>æ°¸ä¹…ä¿®æ”¹</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥ç›´æ¥ä¿®æ”¹my.cnfæ–‡ä»¶ï¼Œåœ¨[mysqld]ä¸‹é¢æ·»åŠ å¦‚ä¸‹åˆ—ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sql_mode=ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>istioéƒ¨ç½²</title>
    <url>/2019/10/29/istio%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><h3 id="Istioä»‹ç»"><a href="#Istioä»‹ç»" class="headerlink" title="Istioä»‹ç»"></a>Istioä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;istioä»£è¡¨çš„æ˜¯Service Meshçš„æ–¹æ¡ˆå®ç°ï¼ŒIstio æœ‰åŠ©äºé™ä½è¿™äº›éƒ¨ç½²çš„å¤æ‚æ€§ï¼Œå¹¶å‡è½»å¼€å‘å›¢é˜Ÿçš„å‹åŠ›ã€‚æä¾›ä¸€ç§ç®€å•çš„æ–¹å¼æ¥ä¸ºå·²éƒ¨ç½²çš„æœåŠ¡å»ºç«‹ç½‘ç»œï¼Œä¸”æä¾›å…·æœ‰è´Ÿè½½å‡è¡¡ã€æœåŠ¡é—´è®¤è¯ã€ç›‘æ§ã€æµé‡ç®¡ç†ç­‰åŠŸèƒ½ã€‚</p><a id="more"></a><h3 id="æœåŠ¡ç½‘æ ¼ï¼ˆService-Meshï¼‰"><a href="#æœåŠ¡ç½‘æ ¼ï¼ˆService-Meshï¼‰" class="headerlink" title="æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰"></a>æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰ç”¨äºæè¿°æ„æˆè¿™äº›åº”ç”¨ç¨‹åºçš„å¾®æœåŠ¡ç½‘ç»œä»¥åŠåº”ç”¨ä¹‹é—´çš„äº¤äº’ã€‚éšç€è§„æ¨¡å’Œå¤æ‚æ€§çš„å¢é•¿ï¼ŒæœåŠ¡ç½‘æ ¼è¶Šæ¥è¶Šéš¾ä»¥ç†è§£å’Œç®¡ç†ã€‚å®ƒçš„éœ€æ±‚åŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœæ¢å¤ã€æŒ‡æ ‡æ”¶é›†å’Œç›‘æ§ä»¥åŠé€šå¸¸æ›´åŠ å¤æ‚çš„è¿ç»´éœ€æ±‚ï¼Œä¾‹å¦‚ A/B æµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒã€é™æµã€è®¿é—®æ§åˆ¶å’Œç«¯åˆ°ç«¯è®¤è¯ç­‰ã€‚è€Œistioåˆšå¥½æä¾›äº†ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡æ§åˆ¶æ•´ä¸ªæœåŠ¡å™¨ç½‘æ ¼æä¾›è¡Œä¸ºæ´å¯Ÿå’Œæ“ä½œæ§åˆ¶æ¥æ»¡è¶³å¾®æœåŠ¡åº”ç”¨çš„å¤šæ ·åŒ–</p><h3 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio æœåŠ¡ç½‘æ ¼é€»è¾‘ä¸Šåˆ†ä¸ºæ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ã€‚</p><ul><li>æ•°æ®å¹³é¢ç”±ä¸€ç»„ä»¥ sidecar æ–¹å¼éƒ¨ç½²çš„æ™ºèƒ½ä»£ç†ï¼ˆEnvoyï¼‰ç»„æˆã€‚è¿™äº›ä»£ç†å¯ä»¥è°ƒèŠ‚å’Œæ§åˆ¶å¾®æœåŠ¡åŠ Mixer ä¹‹é—´æ‰€æœ‰çš„ç½‘ç»œé€šä¿¡ã€‚</li><li>æ§åˆ¶å¹³é¢è´Ÿè´£ç®¡ç†å’Œé…ç½®ä»£ç†æ¥è·¯ç”±æµé‡ã€‚æ­¤å¤–æ§åˆ¶å¹³é¢é…ç½® Mixer ä»¥å®æ–½ç­–ç•¥å’Œæ”¶é›†é¥æµ‹æ•°æ®ã€‚</li></ul><p>æ„æˆæ¯ä¸ªé¢æ¿çš„ä¸åŒç»„ä»¶:<br><img src="https://img.xxlaila.cn/1567136153850.jpg" alt="img"></p><h4 id="istio-ç»„ä»¶"><a href="#istio-ç»„ä»¶" class="headerlink" title="istio ç»„ä»¶"></a>istio ç»„ä»¶</h4><ul><li>Envoy: Istio ä½¿ç”¨ Envoy ä»£ç†çš„æ‰©å±•ç‰ˆæœ¬ï¼Œç”¨äºè°ƒè§£æœåŠ¡ç½‘æ ¼ä¸­æ‰€æœ‰æœåŠ¡çš„æ‰€æœ‰å…¥ç«™å’Œå‡ºç«™æµé‡ï¼Œå±äºæ•°æ®å±‚é¢ã€‚Istioåˆ©ç”¨Envoyçš„å†…ç½®åŠŸèƒ½å®ç°å¦‚ä¸‹æŒ‡æ ‡:<ul><li>åŠ¨æ€æœåŠ¡å‘ç°</li><li>è´Ÿè½½å‡è¡¡</li><li>TLSç»ˆæ­¢</li><li>HTTP/2å’ŒgRPCä»£ç†</li><li>æ–­è·¯å™¨</li><li>å¥åº·æ£€æŸ¥</li><li>åˆ†é˜¶æ®µæ¨å‡ºï¼ŒæŒ‰ç™¾åˆ†æ¯”åˆ†é…æµé‡</li><li>æ•…éšœæ³¨å…¥</li><li>ä¸°å¯Œçš„æŒ‡æ ‡</li></ul></li><li>Mixer: æ˜¯ä¸€ä¸ªç‹¬ç«‹äºå¹³å°çš„ç»„ä»¶ï¼Œè´Ÿè´£åœ¨æœåŠ¡ç½‘æ ¼ä¸Šæ‰§è¡Œè®¿é—®æ§åˆ¶å’Œä½¿ç”¨ç­–ç•¥ï¼Œå¹¶ä» Envoy ä»£ç†å’Œå…¶ä»–æœåŠ¡æ”¶é›†é¥æµ‹æ•°æ®</li><li>Pilot: ä¸º Envoy sidecar æä¾›æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œä¸ºæ™ºèƒ½è·¯ç”±ï¼ˆä¾‹å¦‚ A/B æµ‹è¯•ã€é‡‘ä¸é›€éƒ¨ç½²ç­‰ï¼‰å’Œå¼¹æ€§ï¼ˆè¶…æ—¶ã€é‡è¯•ã€ç†”æ–­å™¨ç­‰ï¼‰æä¾›æµé‡ç®¡ç†åŠŸèƒ½</li><li>Citadel: é€šè¿‡å†…ç½®èº«ä»½å’Œå‡­è¯ç®¡ç†èµ‹èƒ½å¼ºå¤§çš„æœåŠ¡é—´å’Œæœ€ç»ˆç”¨æˆ·èº«ä»½éªŒè¯ã€‚å¯ç”¨äºå‡çº§æœåŠ¡ç½‘æ ¼ä¸­æœªåŠ å¯†çš„æµé‡ï¼Œå¹¶ä¸ºè¿ç»´äººå‘˜æä¾›åŸºäºæœåŠ¡æ ‡è¯†è€Œä¸æ˜¯ç½‘ç»œæ§åˆ¶çš„å¼ºåˆ¶æ‰§è¡Œç­–ç•¥çš„èƒ½åŠ›</li><li>Galley: ä»£è¡¨å…¶ä»–çš„ Istio æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œç”¨æ¥éªŒè¯ç”¨æˆ·ç¼–å†™çš„ Istio API é…ç½®ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒGalley å°†æ¥ç®¡ Istio è·å–é…ç½®ã€ å¤„ç†å’Œåˆ†é…ç»„ä»¶çš„é¡¶çº§è´£ä»»</li></ul><h3 id="Istion-å®‰è£…"><a href="#Istion-å®‰è£…" class="headerlink" title="Istion å®‰è£…"></a>Istion å®‰è£…</h3><h4 id="ä¸‹è½½istioåŒ…"><a href="#ä¸‹è½½istioåŒ…" class="headerlink" title="ä¸‹è½½istioåŒ…"></a>ä¸‹è½½istioåŒ…</h4><p>æ‰§è¡Œä¸‹è½½å’Œè‡ªåŠ¨è§£å‹ç¼©</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://git.io/getLatestIstio | ISTIO_VERSION=1.2.8 sh -</span></span><br><span class="line"><span class="comment"># cd istio-1.2.8/bin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp istioctl /usr/bin/</span></span><br></pre></td></tr></table></figure><p>å®‰è£…ç›®å½•ä¸­åŒ…å«ï¼š</p><ul><li><code>åœ¨ install/</code>: ç›®å½•ä¸­åŒ…å«äº† Kubernetes å®‰è£…æ‰€éœ€çš„ .yaml æ–‡ä»¶</li><li><code>samples/</code>: ç›®å½•ä¸­æ˜¯ç¤ºä¾‹åº”ç”¨</li><li><code>istioctl</code>: istioctlå®¢æˆ·ç«¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ‰‹åŠ¨å°†Envoyä½œä¸ºSidecarä»£ç†æ³¨å…¥å¹¶åˆ›å»ºè·¯ç”±è§„åˆ™å’Œç­–ç•¥æ—¶ï¼Œå°†ä½¿ç”¨æ­¤å·¥å…·ã€‚</li><li><code>istio.VERSION</code>: é…ç½®æ–‡ä»¶</li></ul><h3 id="åœ¨kubernetes-é›†ç¾¤ä¸­å®‰è£…"><a href="#åœ¨kubernetes-é›†ç¾¤ä¸­å®‰è£…" class="headerlink" title="åœ¨kubernetes é›†ç¾¤ä¸­å®‰è£…"></a>åœ¨kubernetes é›†ç¾¤ä¸­å®‰è£…</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio ä¼šè¢«å®‰è£…åˆ°è‡ªå·±çš„ istio-system å‘½åç©ºé—´ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¯¹æ‰€æœ‰å…¶ä»–å‘½åç©ºé—´çš„æœåŠ¡è¿›è¡Œç®¡ç†ã€‚è¿™é‡Œé‡‡ç”¨helmè¿›è¡Œå®‰è£…ï¼Œ<a href="https://xxlaila.github.io/2019/09/04/k8s-helm/" target="_blank" rel="noopener">helmå®‰è£…å‚è€ƒ</a>ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºKialiè®¾ç½®èº«ä»½éªŒè¯å‡­æ®ï¼ˆç›‘è§†ï¼‰ã€‚ç”¨äºåé¢çš„ç™»å½•è®¤è¯</p><h4 id="è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡"><a href="#è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡" class="headerlink" title="è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡"></a>è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># KIALI_USERNAME=$(read -p 'Kiali Username: ' uval &amp;&amp; echo -n $uval | base64)</span></span><br><span class="line"><span class="comment"># KIALI_PASSPHRASE=$(read -sp 'Kiali Passphrase: ' pval &amp;&amp; echo -n $pval | base64)</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºå‘½åç©ºé—´"><a href="#åˆ›å»ºå‘½åç©ºé—´" class="headerlink" title="åˆ›å»ºå‘½åç©ºé—´"></a>åˆ›å»ºå‘½åç©ºé—´</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># NAMESPACE=istio-system</span></span><br><span class="line"><span class="comment"># kubectl create namespace $NAMESPACE</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºç”¨äºå­˜å‚¨ä¸Šé¢è®¾ç½®çš„ç”¨æˆ·å/å¯†ç çš„æœºå¯†<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: kiali</span><br><span class="line">  namespace: <span class="variable">$NAMESPACE</span></span><br><span class="line">  labels:</span><br><span class="line">    app: kiali</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  username: <span class="variable">$KIALI_USERNAME</span></span><br><span class="line">  passphrase: <span class="variable">$KIALI_PASSPHRASE</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="ä½¿ç”¨helmå®‰è£…istio-CRD"><a href="#ä½¿ç”¨helmå®‰è£…istio-CRD" class="headerlink" title="ä½¿ç”¨helmå®‰è£…istio CRD"></a>ä½¿ç”¨helmå®‰è£…istio CRD</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm install install/kubernetes/helm/istio-init --name istio-init --namespace istio-system</span></span><br><span class="line">NAME:   istio-init</span><br><span class="line">LAST DEPLOYED: Fri Nov  1 10:13:22 2019</span><br><span class="line">NAMESPACE: istio-system</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/ClusterRole</span><br><span class="line">NAME                     AGE</span><br><span class="line">istio-init-istio-system  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ClusterRoleBinding</span><br><span class="line">NAME                                        AGE</span><br><span class="line">istio-init-admin-role-binding-istio-system  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME          DATA  AGE</span><br><span class="line">istio-crd-10  1     0s</span><br><span class="line">istio-crd-11  1     0s</span><br><span class="line">istio-crd-12  1     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Job</span><br><span class="line">NAME                     COMPLETIONS  DURATION  AGE</span><br><span class="line">istio-init-crd-10-1.2.8  0/1          0s</span><br><span class="line">istio-init-crd-11-1.2.8  0/1          0s</span><br><span class="line">istio-init-crd-12-1.2.8  0/1          0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ServiceAccount</span><br><span class="line">NAME                        SECRETS  AGE</span><br><span class="line">istio-init-service-account  0        0s</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod"><a href="#æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod" class="headerlink" title="æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod"></a>æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¿°å®‰è£…ä¼šæŠŠistioçš„23ä¸ªcrdéƒ½æäº¤ç»™kubernetes api æœåŠ¡å™¨ã€‚å¦‚æœå¯ç”¨äº†è¯ä¹¦ç®¡ç†ï¼Œcrdè®¡æ•°å™¨ä¸º28ä¸ªã€‚æˆ‘è¿™é‡Œæœªå¯ç”¨è¯ä¹¦ç®¡ç†ï¼Œåªæœ‰23ä¸ªã€‚è¿˜ç”Ÿæˆä¸‰ä¸ªpod</p><ul><li><p>CRD</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get CustomResourceDefinition</span></span><br><span class="line">NAME                                   CREATED AT</span><br><span class="line">adapters.config.istio.io               2019-10-29T08:41:31Z</span><br><span class="line">attributemanifests.config.istio.io     2019-10-29T08:41:30Z</span><br><span class="line">authorizationpolicies.rbac.istio.io    2019-10-29T08:41:36Z</span><br><span class="line">certificates.certmanager.k8s.io        2019-10-29T08:41:38Z</span><br><span class="line">challenges.certmanager.k8s.io          2019-10-29T08:41:40Z</span><br><span class="line">clusterissuers.certmanager.k8s.io      2019-10-29T08:41:37Z</span><br><span class="line">clusterrbacconfigs.rbac.istio.io       2019-10-29T08:41:26Z</span><br><span class="line">destinationrules.networking.istio.io   2019-10-29T08:41:25Z</span><br><span class="line">envoyfilters.networking.istio.io       2019-10-29T08:41:26Z</span><br><span class="line">gateways.networking.istio.io           2019-10-29T08:41:26Z</span><br><span class="line">handlers.config.istio.io               2019-10-29T08:41:33Z</span><br><span class="line">httpapispecbindings.config.istio.io    2019-10-29T08:41:27Z</span><br><span class="line">httpapispecs.config.istio.io           2019-10-29T08:41:28Z</span><br><span class="line">instances.config.istio.io              2019-10-29T08:41:32Z</span><br><span class="line">issuers.certmanager.k8s.io             2019-10-29T08:41:37Z</span><br><span class="line">meshpolicies.authentication.istio.io   2019-10-29T08:41:27Z</span><br><span class="line">orders.certmanager.k8s.io              2019-10-29T08:41:40Z</span><br><span class="line">policies.authentication.istio.io       2019-10-29T08:41:27Z</span><br><span class="line">quotaspecbindings.config.istio.io      2019-10-29T08:41:28Z</span><br><span class="line">quotaspecs.config.istio.io             2019-10-29T08:41:29Z</span><br><span class="line">rbacconfigs.rbac.istio.io              2019-10-29T08:41:31Z</span><br><span class="line">rules.config.istio.io                  2019-10-29T08:41:30Z</span><br><span class="line">serviceentries.networking.istio.io     2019-10-29T08:41:25Z</span><br><span class="line">servicerolebindings.rbac.istio.io      2019-10-29T08:41:31Z</span><br><span class="line">serviceroles.rbac.istio.io             2019-10-29T08:41:31Z</span><br><span class="line">sidecars.networking.istio.io           2019-10-29T08:41:34Z</span><br><span class="line">templates.config.istio.io              2019-10-29T08:41:32Z</span><br><span class="line">virtualservices.networking.istio.io    2019-10-29T08:41:25Z</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get crds | grep 'istio.io\|certmanager.k8s.io' | wc -l</span></span><br><span class="line">23</span><br></pre></td></tr></table></figure></li><li><p>pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">NAME                            READY   STATUS      RESTARTS   AGE</span><br><span class="line">istio-init-crd-10-1.2.8-pbtb8   0/1     Completed   0          47s</span><br><span class="line">istio-init-crd-11-1.2.8-shx6q   0/1     Completed   0          47s</span><br><span class="line">istio-init-crd-12-1.2.8-zmh2w   0/1     Completed   0          47s</span><br></pre></td></tr></table></figure></li></ul><h4 id="ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶"><a href="#ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶" class="headerlink" title="ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶"></a>ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install install/kubernetes/helm/istio --<span class="built_in">wait</span> \</span><br><span class="line">    --name istio \</span><br><span class="line">    --namespace istio-system \</span><br><span class="line">    --<span class="built_in">set</span> global.mtls.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> tracing.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> grafana.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> servicegraph.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> global.k8sIngress.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> global.k8sIngress.gatewayName=ingressgateway \</span><br><span class="line">    --<span class="built_in">set</span> grafana.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.createDemoSecret=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.contextPath=/ \</span><br><span class="line">    --<span class="built_in">set</span> <span class="string">"kiali.dashboard.jaegerURL=http://jaeger-query:16686"</span> \</span><br><span class="line">    --<span class="built_in">set</span> <span class="string">"kiali.dashboard.grafanaURL=http://grafana:3000"</span> \</span><br><span class="line">    --<span class="built_in">set</span> gateways.istio-ingressgateway.type=NodePort \</span><br><span class="line">    --<span class="built_in">set</span> gateways.istio-egressgateway.type=NodePort \</span><br><span class="line">    --<span class="built_in">set</span> sidecarInjectorWebhook.enabled=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="éªŒè¯å®‰è£…"><a href="#éªŒè¯å®‰è£…" class="headerlink" title="éªŒè¯å®‰è£…"></a>éªŒè¯å®‰è£…</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éªŒè¯æ–‡ä»¶é‡Œé¢çš„æœåŠ¡æ˜¯å¦éƒ½éƒ¨ç½²åœ¨kubernetes æœåŠ¡ä¸­ã€‚ç¡®ä¿éƒ¨ç½²çš„pod åœ¨å¯¹åº”çš„kubernetes namespace é‡Œé¢ï¼Œå¹¶æ­£å¸¸å¯åŠ¨ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æœŸé—´å°†åˆ›å»ºæ‰€éœ€çš„RBACæƒé™ï¼Œå¹¶éƒ¨ç½²Istio-Pilotï¼ŒIstio-Mixerï¼ŒIstio-Ingressï¼ŒIstio-Egresså’ŒIstio-CAï¼ˆè¯ä¹¦é¢å‘æœºæ„ï¼‰ã€‚</p><h5 id="æœåŠ¡å™¨éªŒè¯"><a href="#æœåŠ¡å™¨éªŒè¯" class="headerlink" title="æœåŠ¡å™¨éªŒè¯"></a>æœåŠ¡å™¨éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®ä¿éƒ¨ç½²äº†ä»¥ä¸‹KubernetesæœåŠ¡ï¼šistio-pilotï¼Œistio-mixerï¼Œistio-ingressã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc -n istio-system</span></span><br><span class="line">NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                                                      AGE</span><br><span class="line">grafana                  ClusterIP   10.254.113.150   &lt;none&gt;        3000/TCP                                                                                                                                     3h22m</span><br><span class="line">istio-citadel            ClusterIP   10.254.27.143    &lt;none&gt;        8060/TCP,15014/TCP                                                                                                                           3h22m</span><br><span class="line">istio-galley             ClusterIP   10.254.155.177   &lt;none&gt;        443/TCP,15014/TCP,9901/TCP                                                                                                                   3h22m</span><br><span class="line">istio-ingressgateway     NodePort    10.254.170.109   &lt;none&gt;        15020:31952/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32532/TCP,15030:31518/TCP,15031:31525/TCP,15032:30404/TCP,15443:30309/TCP   3h22m</span><br><span class="line">istio-pilot              ClusterIP   10.254.228.182   &lt;none&gt;        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       3h22m</span><br><span class="line">istio-policy             ClusterIP   10.254.13.184    &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP                                                                                                                 3h22m</span><br><span class="line">istio-sidecar-injector   ClusterIP   10.254.154.169   &lt;none&gt;        443/TCP                                                                                                                                      3h22m</span><br><span class="line">istio-telemetry          ClusterIP   10.254.71.72     &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       3h22m</span><br><span class="line">jaeger-agent             ClusterIP   None             &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP                                                                                                                   3h22m</span><br><span class="line">jaeger-collector         ClusterIP   10.254.100.29    &lt;none&gt;        14267/TCP,14268/TCP                                                                                                                          3h22m</span><br><span class="line">jaeger-query             ClusterIP   10.254.18.117    &lt;none&gt;        16686/TCP                                                                                                                                    3h22m</span><br><span class="line">kiali                    ClusterIP   10.254.156.117   &lt;none&gt;        20001/TCP                                                                                                                                    3h22m</span><br><span class="line">prometheus               ClusterIP   10.254.145.181   &lt;none&gt;        9090/TCP                                                                                                                                     3h22m</span><br><span class="line">tracing                  ClusterIP   10.254.87.72     &lt;none&gt;        80/TCP                                                                                                                                       3h22m</span><br><span class="line">zipkin                   ClusterIP   10.254.39.22     &lt;none&gt;        9411/TCP                                                                                                                                     3h22m</span><br></pre></td></tr></table></figure><h5 id="pod-éªŒè¯"><a href="#pod-éªŒè¯" class="headerlink" title="pod éªŒè¯"></a>pod éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®ä¿å·²éƒ¨ç½²ç›¸åº”çš„Kubernetes Podï¼Œå¹¶ä¸”æ‰€æœ‰å®¹å™¨éƒ½å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">grafana-6fb9f8c5c7-n2plk                  1/1     Running     0          3h19m</span><br><span class="line">istio-citadel-7c9b84ddb6-n5h2n            1/1     Running     0          3h19m</span><br><span class="line">istio-galley-64f7d8cc97-zdbb6             1/1     Running     0          3h19m</span><br><span class="line">istio-grafana-post-install-1.2.8-98grv    0/1     Completed   0          3h19m</span><br><span class="line">istio-ingressgateway-65c7498b78-dfmfp     1/1     Running     0          3h19m</span><br><span class="line">istio-init-crd-10-1.2.8-wxxjn             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-11-1.2.8-brjhh             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-12-1.2.8-w8wnc             0/1     Completed   0          3h20m</span><br><span class="line">istio-pilot-569499d666-vhgn5              2/2     Running     0          3h19m</span><br><span class="line">istio-policy-5dbbc56db5-dmr4p             2/2     Running     3          3h19m</span><br><span class="line">istio-sidecar-injector-747cf74498-99drh   1/1     Running     0          3h19m</span><br><span class="line">istio-telemetry-7db5dd4c57-zngq7          2/2     Running     4          3h19m</span><br><span class="line">istio-tracing-5d8f57c8ff-vt2kn            1/1     Running     0          3h19m</span><br><span class="line">kiali-7d749f9dcb-68tlt                    1/1     Running     0          3h19m</span><br><span class="line">prometheus-776fdf7479-zbrxl               1/1     Running     0          3h19m</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio ä»¥ä¸€ä¸ªé¡¹ç›®çš„å½¢å¼éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œéƒ¨ç½²å¥½çš„ pods ä¸­ï¼Œé™¤äº†æœ‰ istio-citadelã€ã€istio-ingressgatewayã€istio-pilot ç­‰ Istio æœ¬èº«çš„åŠŸèƒ½ç»„ä»¶ï¼Œè¿˜é›†æˆäº†å¾®æœåŠ¡ç›¸å…³çš„ç›‘æ§å·¥å…·ï¼Œï¼Œå¦‚ï¼šgrafanaã€jaeger-queryã€kialiã€prometheusã€‚è¿™äº›åŠŸèƒ½ä¸°å¯Œä¸”å¼ºå¤§çš„ç›‘æ§å·¥å…·ï¼Œå¸®åŠ© Istioå®ç°äº†å¾®æœåŠ¡çš„å¯è§†åŒ–ç®¡ç†ã€‚</p><h3 id="éƒ¨ç½²BookInfoç”¨ç¨‹åº"><a href="#éƒ¨ç½²BookInfoç”¨ç¨‹åº" class="headerlink" title="éƒ¨ç½²BookInfoç”¨ç¨‹åº"></a>éƒ¨ç½²BookInfoç”¨ç¨‹åº</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨å¼€å§‹éƒ¨ç½² Bookinfo ç¤ºä¾‹ç¨‹åºã€‚éƒ¨ç½²Bookinfoæ¡ä»¶æ˜¯é›†ç¾¤ä¸­è‡³å°‘æœ‰4ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸”æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸å¾—ä½äº4Gã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥éƒ¨ç½²å®‰è£…éšé™„çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºä¹‹ä¸€-BookInfoã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿä¹¦åº—åº”ç”¨ç¨‹åºï¼Œç”±å››ä¸ªæœåŠ¡ç»„æˆï¼Œè¿™äº›æœåŠ¡æä¾›ä¸€ä¸ªWebäº§å“é¡µé¢ï¼Œä¹¦ç±è¯¦ç»†ä¿¡æ¯ï¼Œè¯„è®ºï¼ˆå¸¦æœ‰å¤šä¸ªç‰ˆæœ¬çš„è¯„è®ºæœåŠ¡ï¼‰å’Œè¯„åˆ†-æ‰€æœ‰è¿™äº›éƒ½ä½¿ç”¨Istioè¿›è¡Œç®¡ç†ã€‚</p><ul><li><p>BookInfoåº”ç”¨ç¨‹åºåˆ†ä¸ºå››ä¸ªå•ç‹¬çš„å¾®æœåŠ¡:</p><ul><li>productpage ï¼šproductpage å¾®æœåŠ¡ä¼šè°ƒç”¨ details å’Œ reviews ä¸¤ä¸ªå¾®æœåŠ¡ï¼Œç”¨æ¥ç”Ÿæˆé¡µé¢ã€‚</li><li>details ï¼šè¿™ä¸ªå¾®æœåŠ¡åŒ…å«äº†ä¹¦ç±çš„ä¿¡æ¯ã€‚</li><li>reviews ï¼šè¿™ä¸ªå¾®æœåŠ¡åŒ…å«äº†ä¹¦ç±ç›¸å…³çš„è¯„è®ºã€‚å®ƒè¿˜ä¼šè°ƒç”¨ ratings å¾®æœåŠ¡ã€‚</li><li>ratings ï¼šratings å¾®æœåŠ¡ä¸­åŒ…å«äº†ç”±ä¹¦ç±è¯„ä»·ç»„æˆçš„è¯„çº§ä¿¡æ¯ã€‚</li></ul></li><li><p>reviews å¾®æœåŠ¡æœ‰ 3 ä¸ªç‰ˆæœ¬ï¼š</p><ul><li>v1 ç‰ˆæœ¬ä¸ä¼šè°ƒç”¨ ratings æœåŠ¡.</li><li>v2 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªé»‘è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li><li>v3 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªçº¢è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li></ul></li><li><p>ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸ªåº”ç”¨çš„ç«¯åˆ°ç«¯æ¶æ„<br><img src="https://img.xxlaila.cn/1572576628250.jpg" alt="img"></p></li></ul><h4 id="æ‰“æ ‡ç­¾"><a href="#æ‰“æ ‡ç­¾" class="headerlink" title="æ‰“æ ‡ç­¾"></a>æ‰“æ ‡ç­¾</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸º default å‘½åç©ºé—´æ‰“ä¸Šæ ‡ç­¾ istio-injection=enabledï¼Œå®ç° Sidecar è‡ªåŠ¨æ³¨å…¥ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label namespace default istio-injection=enabled</span></span><br><span class="line">namespace/default labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get namespace --show-labels</span></span><br><span class="line">NAME              STATUS   AGE   LABELS</span><br><span class="line">default           Active   43d   istio-injection=enabled</span><br><span class="line">istio-system      Active   29m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   43d   &lt;none&gt;</span><br><span class="line">kube-public       Active   43d   &lt;none&gt;</span><br><span class="line">kube-system       Active   43d   &lt;none&gt;</span><br><span class="line">monitoring        Active   35d   &lt;none&gt;</span><br><span class="line">weave             Active   35d   &lt;none&gt;</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„:</strong> æ­¤æ­¥éª¤å…ˆä¸æ‰§è¡Œï¼Œå¦‚æœè¿™è¿™ä¸ªæ‰§è¡Œäº†ï¼Œåœ¨åé¢éƒ¨ç½²Bookinfoçš„æ—¶å€™ä¼šæç¤ºå¦‚ä¸‹é”™è¯¯<code>Error creating: Internal error occurred: failed calling webhook &quot;sidecar-injector.istio.io&quot;: Post https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</code>è¿™ä¸€æ­¥æœ‰æ‰§è¡Œçš„å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œåˆ é™¤</li></ul><ul><li>åˆ é™¤nsçš„label<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get ns --show-labels</span></span><br><span class="line">NAME              STATUS   AGE    LABELS</span><br><span class="line">default           Active   2d4h   istio-injection=enabled</span><br><span class="line">istio-system      Active   174m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-public       Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-system       Active   2d4h   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl label namespace default istio-injection-</span></span><br><span class="line">namespace/default labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get ns --show-labels</span></span><br><span class="line">NAME              STATUS   AGE    LABELS</span><br><span class="line">default           Active   2d4h   &lt;none&gt;</span><br><span class="line">istio-system      Active   175m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-public       Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-system       Active   2d4h   &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><h4 id="éƒ¨ç½²Bookinfo"><a href="#éƒ¨ç½²Bookinfo" class="headerlink" title="éƒ¨ç½²Bookinfo"></a>éƒ¨ç½²Bookinfo</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›´æ¥ä½¿ç”¨kubectl createå…¶å¸¸è§„çš„YAMLéƒ¨ç½²æ–‡ä»¶æ¥éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚å°†ä½¿ç”¨istioctlå°†Envoyå®¹å™¨æ³¨å…¥åˆ°åº”ç”¨ç¨‹åºå®¹å™¨ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)</span></span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥å‘½ä»¤å°†å¯åŠ¨bookinfoåº”ç”¨ç¨‹åºä½“ç³»ç»“æ„å›¾ä¸­æ˜¾ç¤ºçš„æ‰€æœ‰å››ä¸ªæœåŠ¡ã€‚å·²å¯åŠ¨è¯„è®ºæœåŠ¡çš„æ‰€æœ‰3ä¸ªç‰ˆæœ¬ï¼Œå³v1ï¼Œv2å’Œv3ã€‚è€Œåœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ä¼šéƒ¨ç½²æ–°ç‰ˆæœ¬çš„å¾®æœåŠ¡ï¼Œè€Œä¸æ˜¯åŒæ—¶éƒ¨ç½²æ‰€æœ‰ç‰ˆæœ¬ã€‚</p><h4 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®è®¤æ‰€æœ‰æœåŠ¡å’ŒPodå‡å·²æ­£ç¡®å®šä¹‰å¹¶æ­£åœ¨è¿è¡Œã€‚</p><ul><li><p>æ£€æŸ¥ services</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   10.254.61.113    &lt;none&gt;        9080/TCP   2m27s</span><br><span class="line">kubernetes    ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP    43d</span><br><span class="line">productpage   ClusterIP   10.254.130.5     &lt;none&gt;        9080/TCP   2m23s</span><br><span class="line">ratings       ClusterIP   10.254.186.181   &lt;none&gt;        9080/TCP   2m26s</span><br><span class="line">reviews       ClusterIP   10.254.200.107   &lt;none&gt;        9080/TCP   2m25s</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥ pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-c5b5f496d-lphgd        1/1     Running   0          15h</span><br><span class="line">load-generator-7fbcc7489f-vbpnx   1/1     Running   2          20d</span><br><span class="line">nginx-deploy-d494b9564-vx97s      1/1     Running   1          20d</span><br><span class="line">productpage-v1-c7765c886-97spj    1/1     Running   0          15h</span><br><span class="line">ratings-v1-f745cf57b-mdgxr        1/1     Running   0          15h</span><br><span class="line">reviews-v1-75b979578c-ghqqm       1/1     Running   0          15h</span><br><span class="line">reviews-v2-597bf96c8f-r659w       1/1     Running   0          15h</span><br><span class="line">reviews-v3-54c6c64795-tvsmq       1/1     Running   0          15h</span><br></pre></td></tr></table></figure></li><li><p>ç¡®è®¤Bookinfoåº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œè¯·é€šè¿‡curlæŸä¸ªpodä¸­çš„å‘½ä»¤å‘å…¶å‘é€è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec -it $(kubectl get pod -l app=ratings -o jsonpath='&#123;.items[0].metadata.name&#125;') -c ratings -- curl productpage:9080/productpage | grep -o "&lt;title&gt;.*&lt;/title&gt;"</span></span><br><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ¯ä¸ªæœåŠ¡æ—è¾¹éƒ½æ³¨å…¥äº†Envoyï¼Œæ¶æ„å°†å¦‚ä¸‹<br><img src="https://img.xxlaila.cn/1572577460804.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BookinfoæœåŠ¡å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œï¼Œæ‚¨éœ€è¦ä½¿è¯¥åº”ç”¨ç¨‹åºå¯ä»¥ä»Kubernetesé›†ç¾¤å¤–éƒ¨è®¿é—®ï¼Œä¾‹å¦‚ï¼Œä»æµè§ˆå™¨è®¿é—®ã€‚Istioç½‘å…³ç”¨äºæ­¤ç›®çš„ã€‚ä½†æ˜¯æˆ‘åœ¨éƒ¨ç½² bookinfo-gateway çš„æ—¶å€™å‡ºç°é”™è¯¯ï¼Œé”™è¯¯å¦‚ä¸‹ï¼›ç„¶åçœ‹äº†ä¸€ä¸‹ bookinfo-gatewayå°±æ˜¯æä¾›ä¸€ä¸ªwebè®¿é—®çš„ç¨‹åºï¼Œæ—¢ç„¶æ˜¯æä¾›çš„ä¸€ä¸ªwebè®¿é—®ï¼Œæˆ‘å°±ä½¿ç”¨äº†Traefixæ¥æä¾›è¿™ä¸ªæœåŠ¡ã€‚</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Timeout): <span class="builtin-name">error</span> when creating <span class="string">"samples/bookinfo/networking/bookinfo-gateway.yaml"</span>: Timeout: request did <span class="keyword">not</span> complete within requested timeout 30s</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Timeout): <span class="builtin-name">error</span> when creating <span class="string">"samples/bookinfo/networking/bookinfo-gateway.yaml"</span>: Timeout: request did <span class="keyword">not</span> complete within requested timeout 30s</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»º-bookinfo-gateway"><a href="#åˆ›å»º-bookinfo-gateway" class="headerlink" title="åˆ›å»º bookinfo-gateway"></a>åˆ›å»º bookinfo-gateway</h4><ul><li>istio-Ingress.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: istio-web-ui</span><br><span class="line">  namespace: </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: productpage</span><br><span class="line">          servicePort: 9080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨è¾“å…¥<code>http://istio.xxlaila.cn</code> æ¥è®¿é—®ã€‚ç”¨ productpageä»¥æŸ¥çœ‹BookInfoç½‘é¡µã€‚å¦‚æœæ‚¨å¤šæ¬¡åˆ·æ–°é¡µé¢ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°äº§å“é¡µé¢ä¸Šæ˜¾ç¤ºçš„è¯„è®ºç‰ˆæœ¬ä¸åŒï¼Œå¹¶ä»¥å¾ªç¯æ–¹å¼æ˜¾ç¤ºï¼ˆçº¢è‰²æ˜Ÿæ˜Ÿï¼Œé»‘è‰²æ˜Ÿæ˜Ÿï¼Œæ— æ˜Ÿæ˜Ÿï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬å°šæœªä½¿ç”¨Istioæ¥æ§åˆ¶ç‰ˆæœ¬è·¯ç”±<br><img src="https://img.xxlaila.cn/1572578398765.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1572578189667.jpg" alt="img"></p><p>åŸºæœ¬é“è¿™é‡Œï¼ŒåŠ¨æ€æ›´æ”¹è¯·æ±‚è·¯ç”±å­¦ä¹ ä¸­ï¼ŒğŸ˜‚ğŸ˜‚ğŸ˜‚</p><h3 id="ç›‘æ§æ–¹å¼"><a href="#ç›‘æ§æ–¹å¼" class="headerlink" title="ç›‘æ§æ–¹å¼"></a>ç›‘æ§æ–¹å¼</h3><h4 id="ç”ŸæˆæœåŠ¡å›¾"><a href="#ç”ŸæˆæœåŠ¡å›¾" class="headerlink" title="ç”ŸæˆæœåŠ¡å›¾"></a>ç”ŸæˆæœåŠ¡å›¾</h4><p>è¦éªŒè¯Kialiæ˜¯å¦åœ¨æ‚¨çš„é›†ç¾¤ä¸­è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n istio-system get svc kiali</span></span><br><span class="line">NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">kiali   ClusterIP   10.254.156.117   &lt;none&gt;        20001/TCP   4h38m</span><br></pre></td></tr></table></figure><p>æµé‡å‘é€åˆ°ç½‘æ ¼ï¼Œæœ‰ä¸‰ç§é€‰æ‹©:<br>1.åœ¨ç½‘ç»œæµè§ˆå™¨ä¸­è®¿é—®<a href="http://istio.xxlaila.cn/productpage" target="_blank" rel="noopener">http://istio.xxlaila.cn/productpage</a><br>2.å¤šæ¬¡ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl http://istio.xxlaila.cn/productpage</span></span><br></pre></td></tr></table></figure><p>3.ä½¿ç”¨ä»¥ä¸‹watchå‘½ä»¤è¿ç»­å‘é€è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># watch -n 1 curl -o /dev/null -s -w %&#123;http_code&#125; http://istio.xxlaila.cn/productpage</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œéœ€è¦é…ç½®Kiali UIï¼Œæˆ‘ä»¬åŒæ ·é€‚ç”¨Traefixæ¥è¿›è¡Œé…ç½®</p><ul><li>kialiâ€“Ingress.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kiali--Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kiali-web-ui</span><br><span class="line">  namespace: istio-system </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: istio-kiali.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kiali</span><br><span class="line">          servicePort: 20001</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://istio-kiali.xxlaila.cn" target="_blank" rel="noopener">http://istio-kiali.xxlaila.cn</a> ï¼Œ è¦ç™»å½•Kiali UIï¼Œè¯·è½¬åˆ°Kialiç™»å½•å±å¹•ï¼Œç„¶åè¾“å…¥å­˜å‚¨åœ¨Kialiæœºå¯†ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ã€‚è´¦æˆ·å¯†ç æ˜¯å‰é¢æˆ‘ä»¬è®¾ç½®çš„</p><h4 id="1-ç½‘æ ¼æ¦‚è¿°"><a href="#1-ç½‘æ ¼æ¦‚è¿°" class="headerlink" title="1.ç½‘æ ¼æ¦‚è¿°"></a>1.ç½‘æ ¼æ¦‚è¿°</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•åç«‹å³æ˜¾ç¤ºçš„â€œæ¦‚è¿°â€é¡µé¢ä¸­æŸ¥çœ‹ç½‘æ ¼çš„æ¦‚è¿°ã€‚â€œæ¦‚è¿°â€é¡µé¢æ˜¾ç¤ºäº†ç½‘æ ¼ä¸­å…·æœ‰æœåŠ¡çš„æ‰€æœ‰åç§°ç©ºé—´ã€‚ä»¥ä¸‹å±å¹•æˆªå›¾æ˜¾ç¤ºäº†ç±»ä¼¼çš„é¡µé¢<br><img src="https://img.xxlaila.cn/1572578943386.jpg" alt="img"></p><h4 id="2-ç©ºé—´å›¾"><a href="#2-ç©ºé—´å›¾" class="headerlink" title="2.ç©ºé—´å›¾"></a>2.ç©ºé—´å›¾</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¦æŸ¥çœ‹åç§°ç©ºé—´å›¾ï¼Œè¯·åœ¨bookinfoBookinfoåç§°ç©ºé—´å¡ä¸­å•å‡»å›¾å›¾æ ‡ã€‚å›¾å½¢å›¾æ ‡ä½äºåç§°ç©ºé—´å¡çš„å·¦ä¸‹æ–¹ï¼Œçœ‹èµ·æ¥åƒæ˜¯ä¸€ç»„ç›¸è¿çš„åœˆå­ã€‚è¯¥é¡µé¢ç±»ä¼¼äº<br><img src="https://img.xxlaila.cn/1572579048298.jpg" alt="img"></p><h3 id="åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ"><a href="#åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ" class="headerlink" title="åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ"></a>åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ç”¨Istioçš„åº”ç”¨ç¨‹åºå¯ä»¥é…ç½®ä¸ºä½¿ç”¨æµè¡Œçš„Jaegeråˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿæ¥æ”¶é›†è·Ÿè¸ªèŒƒå›´ã€‚åˆ†å¸ƒå¼è·Ÿè¸ªä½¿æ‚¨å¯ä»¥æŸ¥çœ‹ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­å‘å‡ºçš„è¯·æ±‚æµï¼Œè€ŒIstioçš„æ¨¡å‹åˆ™å…è®¸è¿™æ ·åšï¼Œè€Œä¸æ„å»ºåº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„è¯­è¨€/æ¡†æ¶/å¹³å°æ— å…³ã€‚ä½¿ç”¨Traefixæ¥æä¾›è¿™ä¸ªæœåŠ¡ã€‚</p><ul><li><p>Jaeger-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; Jaeger-Ingress.yaml  &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jaeger-web-ui</span><br><span class="line">  namespace: istio-system </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: jaeger.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: jaeger-query</span><br><span class="line">          servicePort: 16686</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f Jaeger-Ingress.yaml </span></span><br><span class="line">ingress.extensions/jaeger-web-ui unchanged</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://jaeger.xxlaila.cn" target="_blank" rel="noopener">http://jaeger.xxlaila.cn</a> ï¼Œ ä½¿ç”¨Bookinfoç¤ºä¾‹ç”Ÿæˆè·Ÿè¸ªï¼Œè¦æŸ¥çœ‹è·Ÿè¸ªæ•°æ®ï¼Œå¿…é¡»å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡ã€‚è¯·æ±‚æ•°é‡å–å†³äºIstioçš„é‡‡æ ·ç‡ã€‚æ‚¨åœ¨å®‰è£…Istioæ—¶è®¾ç½®æ­¤é€Ÿç‡ã€‚é»˜è®¤é‡‡æ ·ç‡ä¸º1ï¼…ã€‚æ‚¨éœ€è¦è‡³å°‘å‘é€100ä¸ªè¯·æ±‚ï¼Œæ‰èƒ½æ˜¾ç¤ºç¬¬ä¸€æ¡è·Ÿè¸ªã€‚è¦å°†100ä¸ªè¯·æ±‚å‘é€åˆ°productpageæœåŠ¡ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in `seq 1 100`; do curl -s -o /dev/null http://istio.xxlaila.cn/productpage; done</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨ä»ªè¡¨æ¿çš„å·¦ä¾§çª—æ ¼ä¸­ï¼Œä»â€œæœåŠ¡â€ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©productpage.defaultï¼Œç„¶åå•å‡»â€œæŸ¥æ‰¾è·Ÿè¸ªâ€<br><img src="https://img.xxlaila.cn/1572592255728.jpg" alt="img"></p></li><li><p>å•å‡»é¡¶éƒ¨çš„æœ€æ–°è·Ÿè¸ªä»¥æŸ¥çœ‹ä¸å¯¹/ productpageçš„æœ€æ–°è¯·æ±‚ç›¸å¯¹åº”çš„è¯¦ç»†ä¿¡æ¯<br><img src="https://img.xxlaila.cn/1572592385675.jpg" alt="img"></p></li></ul><h3 id="ç›‘è§†Istio"><a href="#ç›‘è§†Istio" class="headerlink" title="ç›‘è§†Istio"></a>ç›‘è§†Istio</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚ä½•è®¾ç½®å’Œä½¿ç”¨Istioä»ªè¡¨æ¿ç›‘è§†ç½‘æ ¼æµé‡ã€‚ä½œä¸ºç›‘æ§çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦å°†å®‰è£…Grafana Istioæ’ä»¶ï¼Œå¹¶ä½¿ç”¨åŸºäºWebçš„ç•Œé¢æŸ¥çœ‹æœåŠ¡ç½‘æ ¼æµé‡æ•°æ®ã€‚Grafanaå°†ç”¨äºå¯è§†åŒ–æ™®ç½—ç±³ä¿®æ–¯æ•°æ®ã€‚åœ¨æ‰§è¡Œéƒ¨ç½²çš„æ—¶å€™ä¹Ÿéƒ¨ç½²äº†è¿™ä¸¤ä¸ªæœåŠ¡ã€‚</p><h4 id="åˆ›å»ºgrafana-Ingress"><a href="#åˆ›å»ºgrafana-Ingress" class="headerlink" title="åˆ›å»ºgrafana Ingress"></a>åˆ›å»ºgrafana Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;grafana-istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-istio-web-ui</span><br><span class="line">  namespace: istio-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana-istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ›å»ºï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨ä»¥å‰çš„grafanaé‡Œé¢æ·»åŠ æ•°æ®åº“æºï¼Œå°±ä¸ç”¨åœ¨æ–°èµ·ä¸€ä¸ªåŸŸåæ¥è¿›è¡Œè®¿é—®<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†æ¬¡åŠ è½½Bookinfoåº”ç”¨ç¨‹åºï¼ˆ<a href="http://istio.xxlaila.cn/productpageï¼‰" target="_blank" rel="noopener">http://istio.xxlaila.cn/productpageï¼‰</a> ï¼Œ åˆ·æ–°é¡µé¢å‡ æ¬¡ï¼ˆæˆ–å‘é€å‘½ä»¤å‡ æ¬¡ï¼‰ä»¥äº§ç”Ÿå°‘é‡æµé‡ã€‚å†æ¬¡æŸ¥çœ‹Istioä»ªè¡¨æ¿ã€‚å®ƒåº”è¯¥åæ˜ æ‰€äº§ç”Ÿçš„æµé‡ã€‚<br><img src="https://img.xxlaila.cn/1572593852626.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;istio è¿˜æä¾›äº†ç½‘æ ¼çš„å…¨å±€è§†å›¾ä»¥åŠç½‘æ ¼ä¸­çš„æœåŠ¡å’Œå·¥ä½œè´Ÿè½½ã€‚æ‚¨å¯ä»¥é€šè¿‡å¯¼èˆªåˆ°ç‰¹å®šçš„ä»ªè¡¨æ¿æ¥è·å–æœ‰å…³æœåŠ¡å’Œå·¥ä½œè´Ÿè½½çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚<br><img src="https://img.xxlaila.cn/1572594150893.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æä¾›äº†æœ‰å…³æœåŠ¡æŒ‡æ ‡çš„è¯¦ç»†ä¿¡æ¯ï¼Œç„¶åæ˜¯è¯¥æœåŠ¡çš„å®¢æˆ·ç«¯å·¥ä½œè´Ÿè½½ï¼ˆæ­£åœ¨è°ƒç”¨æ­¤æœåŠ¡çš„å·¥ä½œè´Ÿè½½ï¼‰å’ŒæœåŠ¡å·¥ä½œè´Ÿè½½ï¼ˆæ­£åœ¨æä¾›è¯¥æœåŠ¡çš„å·¥ä½œè´Ÿè½½ï¼‰ã€‚<br><img src="https://img.xxlaila.cn/1572594261333.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio åœ¨grafana æä¾›äº†å¾ˆå¤šçš„ç›‘æ§æŒ‡æ ‡ï¼Œå¯ä»¥åˆ†åˆ«ç‚¹å‡»çœ‹çœ‹<br><img src="https://img.xxlaila.cn/1572594330246.jpg" alt="img"></p><h3 id="æŸ¥è¯¢IstioæŒ‡æ ‡"><a href="#æŸ¥è¯¢IstioæŒ‡æ ‡" class="headerlink" title="æŸ¥è¯¢IstioæŒ‡æ ‡"></a>æŸ¥è¯¢IstioæŒ‡æ ‡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istioçš„æ•°æ®æ˜¯å­˜å‚¨åœ¨prometheusé‡Œé¢çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡prometheusè¿›è¡Œç›´æ¥æ•°æ®çš„æŸ¥è¯¢</p><h4 id="æŸ¥çœ‹prometheusæœåŠ¡"><a href="#æŸ¥çœ‹prometheusæœåŠ¡" class="headerlink" title="æŸ¥çœ‹prometheusæœåŠ¡"></a>æŸ¥çœ‹prometheusæœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n istio-system get svc prometheus</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">prometheus   ClusterIP   10.254.145.181   &lt;none&gt;        9090/TCP   5h35m</span><br></pre></td></tr></table></figure><h4 id="prometheus-traefix"><a href="#prometheus-traefix" class="headerlink" title="prometheus traefix"></a>prometheus traefix</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡traefix æ¥ä»£ç†prometheusï¼Œç„¶åæˆ‘ä»¬å°†æµé‡å‘é€åˆ°ç½‘æ ¼ã€‚</p><ul><li><p>prometheus-istio.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; prometheus-istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-istio-web-ui</span><br><span class="line">  namespace: istio-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus-istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f prometheus-istio-Ingress.yaml </span></span><br><span class="line">ingress.extensions/prometheus-istio-web-ui created</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://prometheus-istio.xxlaila.cn" target="_blank" rel="noopener">http://prometheus-istio.xxlaila.cn</a> ï¼Œå¯ä»¥åœ¨è¾“å…¥æ¡†é‡Œé¢è¾“å…¥è¡¨è¾¾å¼æ¥è·å–æŒ‡ï¼Œè¾“å…¥æ–‡æœ¬ï¼šistio_requests_total<br><img src="https://img.xxlaila.cn/1572594888435.jpg" alt="img"></p><ul><li><p>å…¶ä»–æŸ¥è¯¢å°è¯•ï¼š</p><ul><li><p>å¯¹productpageæœåŠ¡çš„æ‰€æœ‰è¯·æ±‚æ€»æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">istio_requests_total&#123;destination_service=<span class="string">"productpage.default.svc.cluster.local"</span>&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯¹v3ç‰ˆæœ¬çš„è¯„è®ºæœåŠ¡çš„æ‰€æœ‰è¯·æ±‚æ€»æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">istio_requests_total&#123;destination_service=<span class="string">"reviews.default.svc.cluster.local"</span>, destination_version=<span class="string">"v3"</span>&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>è¯¥æŸ¥è¯¢å°†æ‰€æœ‰è¯·æ±‚çš„å½“å‰æ€»æ•°è¿”å›åˆ°è¯„è®ºæœåŠ¡çš„v3ã€‚</p><ul><li>è¿‡å»5åˆ†é’Ÿå†…å¯¹productpageæœåŠ¡æ‰€æœ‰å®ä¾‹çš„è¯·æ±‚ç‡ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rate(istio_requests_total&#123;destination_service=~<span class="string">"productpage.*"</span>, response_code=<span class="string">"200"</span>&#125;[5m])</span><br></pre></td></tr></table></figure></li></ul></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>istio</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineæ ¸å¿ƒé«˜çº§ç¯‡</title>
    <url>/2019/10/26/pipeline%E9%AB%98%E7%BA%A7%E7%AF%87/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢çš„ä¸¤ç¯‡æ–‡ç« ä»‹ç»äº†pipelineçš„åŸºæœ¬ä½¿ç”¨å’Œä¸€äº›å®é™…ä½¿ç”¨çš„ä¾‹å­ï¼Œçœ‹ä¼¼å¾ˆä¸é”™ï¼Œä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¹Ÿä¼šå‡ºç°å¾ˆå¤šçš„ä¸è¶³å’Œé—®é¢˜ï¼Œéšä¹‹ç³»ç»Ÿçš„åºå¤§ã€æœåŠ¡çš„å¢åŠ ã€äººå‘˜çš„å‚å·®ä¸é½ä¼šå¯¼è‡´å¾ˆå¤šçš„é—®é¢˜ã€‚<a id="more"></a>å±Šæ—¶ä¼šå¸¦æ¥å¾ˆå¤§çš„ç»´æŠ¤æˆæœ¬å’Œä¸€äº›æ”¹åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åšäº‹æƒ…ä¹‹å‰å°±è¦è€ƒè™‘è¿›å»ï¼Œä¸€äº›æ„å¤–äº‹ä»¶çš„å‘ç”Ÿã€æˆ–è€…æ˜¯åœ¨å°†æ¥å³å°†ä¼šå‘ç”Ÿå’Œéœ€è¦æ”¹å˜çš„äº‹æƒ…æˆ‘ä»¬éƒ½è¦æƒ³åˆ°æˆ–è€…æ˜¯é¢„ç•™å£å­ï¼Œè¿™æ ·æ‰åœ¨ä»Šåæ‰©å±•ã€ä¿®æ”¹ã€å¼•å…¥éƒ½èƒ½æœ‰å¾ˆå¥½å¯å¡‘æ€§ã€‚</p><h3 id="jenkins-jobä»‹ç»"><a href="#jenkins-jobä»‹ç»" class="headerlink" title="jenkins jobä»‹ç»"></a>jenkins jobä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨jenkinsçš„æ™®é€šjobï¼Œæ™®é€šçš„jobå¥½å¤„æ˜¯é…ç½®ç®€å•ï¼Œç»“æ„åŒ–å¯ä»¥å¤æ‚ï¼Œä¹Ÿå¯ä»¥å•ä¸€ã€‚åœ¨ä½¿ç”¨jenkins jobçš„æ—¶å€™æˆ‘ä»¬åˆ†ä¸ºä¸¤ç§ï¼šä¸€ç§æ˜¯å•ä¸€jobï¼Œä¸€ç§æ˜¯å…·æœ‰è€¦åˆæ€§çš„ã€‚ä¸‹é¢å¯¹ä¸¤ç§æƒ…å†µè¿›è¡Œå¯¹æ¯”å’Œæ¯”è¾ƒã€‚</p><h4 id="jenkins-å•ä¸€job"><a href="#jenkins-å•ä¸€job" class="headerlink" title="jenkins å•ä¸€job"></a>jenkins å•ä¸€job</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨jenkinsçš„ä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œå•ä¸€çš„çš„jobå¯ä»¥è®©ç»´æŠ¤äººå‘˜å¯ä»¥å¾ˆå¥½çš„æŸ¥çœ‹é‡Œé¢çš„é€»è¾‘æ­¥éª¤ï¼Œjobé‡Œé¢æ‰€æœ‰çš„ä»»åŠ¡éƒ½åœ¨è¿™ä¸ªæ‰€å±çš„ç©ºé—´é‡Œé¢æ‰§è¡Œï¼Œå®ƒé‡Œé¢åŒ…å«äº†ï¼šä»£ç pullã€ç¼–è¯‘ã€æ‰“åŒ…ã€å¤åˆ¶åŒ…ã€å‘å¸ƒåŒ…ï¼ˆä½¿ç”¨å†…ç½®çš„shellæ¨¡å—æ¥å†™shellï¼Œè¿™ç§åº”è¯¥ä¸å­˜åœ¨ï¼‰ã€‚ç§å•ä¸€jobæœåŠ¡ç®—å¾—ä¸Šæ˜¯æœåŠ¡å‘¨åˆ°ï¼Œä¸å½±å“å…¶ä»–äººï¼Œè‡ªå·±ç®¡ç†å¥½è‡ªå·±çš„ä¸€äº©ä¸‰åˆ†åœ°ã€‚å¥½å¤„æ˜¯å½“å‡ºé”™ä»¥åå½±å“èŒƒå›´å°ï¼Œå®¹æ˜“æ§åˆ¶ã€‚å¦‚ä¸‹å›¾ï¼š<br><img src="https://img.xxlaila.cn/1572064519037.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¿™ä¸­æ¨¡å¼ä¸‹ï¼Œç»´æŠ¤äººå‘˜å‰æœŸç”¨çœ‹ä¼¼æ¯”è¾ƒè½»æ¾çš„å·¥ä½œå»ºç«‹èµ·äº†æ•´ä¸ªå‘å¸ƒæµç¨‹ã€‚ä½†æ˜¯åˆ°äº†åæœŸå°±ä¸è¡Œäº†ã€‚ä¹‹å‰æˆ‘åœ¨çš„è¿™å®¶å…¬å¸å‰æœŸä¹Ÿæ˜¯è¿™ä¹ˆè¿™ä¹ˆåšçš„ã€‚å¼€å‘å®Œæˆåæäº¤gitï¼Œç„¶åè‡ªåŠ¨è§¦å‘ã€æ„å»ºã€åˆ¶å“åº“ã€å‘å¸ƒï¼Œåœ¨ä¸€ä¸ªjobé‡Œé¢å°±å®Œæˆäº†ã€‚åæ¥æˆ‘ä»¬å‡†å¤‡æ¨è¡Œæ›´å¥½çš„devopsæ–¹æ¡ˆçš„æ—¶å€™ï¼›å‘ç°ä»¥å‰çš„è¿™ä¸ªjobå»ºç«‹æœ‰é—®é¢˜ï¼Œä¸€æƒ³åˆ°å‡ ç™¾ä¸ªå¾®æœåŠ¡ï¼Œå‡ ç™¾ä¸ªjobéœ€è¦å»è¿›è¡Œæ”¹é€ ã€‚é¡¿æ—¶æˆ‘ä»¬è¿ç»´è„¸çº¿ä¸€é»‘ï¼Œè™½ç„¶æˆ‘ä»¬è‡ªå·±å†™äº†ä¸€ä¸ªå¿«é€Ÿåœ¨jenkinsä¸Šå»ºç«‹jobï¼Œä½†æ˜¯ä¸€æƒ³åˆ°å‡ ç™¾ä¸ªè¿˜æ˜¯ä¸å¥½ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†jobä¹‹é—´çš„ä»»åŠ¡å…³è”ï¼Œç„¶åé€šè¿‡å‚æ•°ä¼ é€’å®Œæˆæ•´ä¸ªæµç¨‹æœåŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™ç§æ¨¡å¼ä¸‹çš„å¼Šç«¯å°±å¦‚ä¸Šé¢æ‰€è¯´çš„ä¸€æ ·ï¼Œä½†ä»€ä¹ˆæ—¶å€™å¥½çš„æœåŠ¡å‘¢ï¼Ÿå¥½çš„æœåŠ¡åˆæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™é‡Œä¹Ÿå¯ä»¥åµŒå¥—ä¸€äº›å¾®æœåŠ¡çš„æ¦‚å¿µç†è®ºã€‚å¦‚æœæˆ‘ä»¬è¦åšåˆ°ä»€ä¹ˆæ—¶å€™å¥½çš„æœåŠ¡ï¼Œæˆ‘ä»¬å¾—äº†è§£äº†è§£ä¸€ä¸‹: ä½è€¦åˆå’Œé«˜å†…èšã€‚äº†è§£è¿™ä¸ªä¸œè¥¿æœ‰åŠ©äºæˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„pipeline æµæ°´çº¿çš„è®¾è®¡ï¼ŒåŒ…æ‹¬åœ¨åæœŸdevopsçš„è®¾è®¡ä»¥åŠæ’¸ç éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚</p><h3 id="è€¦åˆæ€§"><a href="#è€¦åˆæ€§" class="headerlink" title="è€¦åˆæ€§"></a>è€¦åˆæ€§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆæˆ‘ä»¬æ¥äº†è§£è¿™ä¸€æ¦‚å¿µ: â€œé«˜å†…èšä½è€¦åˆâ€ã€‚åœ¨è½¯ä»¶è®¾è®¡ä¸­é€šå¸¸ç”¨è€¦åˆåº¦å’Œå†…èšåº¦ä½œä¸ºè¡¡é‡æ¨¡å—ç‹¬ç«‹ç¨‹åº¦çš„æ ‡å‡†ã€‚åˆ’åˆ†æ¨¡å—çš„ä¸€ä¸ªå‡†åˆ™æ˜¯é«˜å†…èšä½è€¦åˆã€‚ä»æ¨¡å—ç²’åº¦æ¥çœ‹ï¼Œé«˜å†…èšï¼šå°½å¯èƒ½ç±»çš„æ¯ä¸ªæˆå‘˜æ–¹æ³•åªå®Œæˆä¸€ä»¶äº‹ï¼ˆæœ€å¤§é™åº¦çš„èšåˆï¼‰ï¼›ä½è€¦åˆï¼šå‡å°‘ç±»å†…éƒ¨ï¼Œä¸€ä¸ªæˆå‘˜æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæˆå‘˜æ–¹æ³•ã€‚ä»ç±»è§’åº¦æ¥çœ‹ï¼Œé«˜å†…èšä½è€¦åˆï¼šå‡å°‘ç±»å†…éƒ¨ï¼Œå¯¹å…¶ä»–ç±»çš„è°ƒç”¨ï¼›ä»åŠŸèƒ½å—æ¥çœ‹ï¼Œé«˜å†…èšä½è€¦åˆï¼šå‡å°‘æ¨¡å—ä¹‹é—´çš„äº¤äº’å¤æ‚åº¦ï¼ˆæ¥å£æ•°é‡ï¼Œå‚æ•°æ•°æ®ï¼‰å³æ¨ªå‘ï¼šç±»ä¸ç±»ä¹‹é—´ã€æ¨¡å—ä¸æ¨¡å—ä¹‹é—´ï¼›çºµå‘ï¼šå±‚æ¬¡ä¹‹é—´ï¼›å°½å¯èƒ½ï¼Œå†…å®¹å†…èšï¼Œæ•°æ®è€¦åˆã€‚</p><h4 id="ä½è€¦åˆ"><a href="#ä½è€¦åˆ" class="headerlink" title="ä½è€¦åˆ"></a>ä½è€¦åˆ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸åŒæ¨¡å—ç›¸äº’ä¾èµ–å¤šå°‘ï¼Ÿæ¨¡å—åº”å°½å¯èƒ½ç‹¬ç«‹äºå…¶ä»–æ¨¡å—ï¼Œä»¥ä½¿å¯¹æ¨¡å—çš„æ›´æ”¹ä¸ä¼šä¸¥é‡å½±å“å…¶ä»–æ¨¡å—ã€‚</p><h4 id="é«˜è€¦åˆ"><a href="#é«˜è€¦åˆ" class="headerlink" title="é«˜è€¦åˆ"></a>é«˜è€¦åˆ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é«˜è€¦åˆå°†æ„å‘³ç€æ‚¨çš„æ¨¡å—å¯¹å…¶ä»–æ¨¡å—çš„å†…éƒ¨è¿ä½œäº†è§£å¤ªå¤šã€‚å¯¹å…¶ä»–æ¨¡å—äº†è§£å¤ªå¤šçš„æ¨¡å—ä¼šä½¿æ›´æ”¹éš¾ä»¥åè°ƒï¼Œå¹¶ä½¿æ¨¡å—èƒ½åŠ›å˜å¼±ã€‚å¦‚æœæ¨¡å—Aå¯¹æ¨¡å—Bçš„äº†è§£è¿‡å¤šï¼Œåˆ™å¯¹æ¨¡å—Bå†…éƒ¨çš„æ›´æ”¹å¯èƒ½ä¼šç ´åæ¨¡å—Açš„åŠŸèƒ½ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡å®ç°ä½è€¦åˆï¼Œå¯ä»¥è½»æ¾æ›´æ”¹æ¨¡å—å†…éƒ¨ï¼Œä¸å¿…æ‹…å¿ƒå®ƒä»¬å¯¹ç³»ç»Ÿä¸­å…¶ä»–æ¨¡å—çš„å½±å“ã€‚ä½è€¦åˆè¿˜ä½¿æˆ‘ä»¬çš„æ¨¡å—å½¼æ­¤ä¹‹é—´ä¸ç›¸äº’ä¾èµ–ï¼Œå› æ­¤æ›´æ˜“äºè®¾è®¡ï¼Œç¼–å†™å’Œæµ‹è¯•ä»£ç ã€‚æˆ‘ä»¬è¿˜è·å¾—äº†æ˜“äºé‡ç”¨å’Œå¯ç»„åˆçš„æ¨¡å—çš„ä¼˜åŠ¿ã€‚é—®é¢˜ä¹Ÿè¢«éš”ç¦»åˆ°å°çš„ï¼Œç‹¬ç«‹çš„ä»£ç å•å…ƒä¸­ã€‚</p><p><strong>å¥½å¤„:</strong></p><ul><li>å¯ç»´æŠ¤æ€§: æ›´æ”¹é™åˆ¶åœ¨ä¸€ä¸ªæ¨¡å—ä¸­</li><li>å¯æµ‹è¯•æ€§: å•å…ƒæµ‹è¯•ä¸­æ¶‰åŠçš„æ¨¡å—å¯ä»¥é™åˆ¶åœ¨æœ€ä½é™åº¦</li><li>å¯è¯»æ€§: éœ€è¦åˆ†æçš„ç±»å‡å°‘</li></ul><h4 id="é«˜å†…èš"><a href="#é«˜å†…èš" class="headerlink" title="é«˜å†…èš"></a>é«˜å†…èš</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…èšæ€§é€šå¸¸æ˜¯æŒ‡æ¨¡å—çš„å…ƒç´ å¦‚ä½•ç›¸äº’ç»„åˆã€‚ç›¸å…³ä»£ç åº”å½¼æ­¤æ¥è¿‘ï¼Œä»¥ä½¿å…¶å…·æœ‰é«˜åº¦çš„å‡èšåŠ›ã€‚æ˜“äºç»´æŠ¤çš„ä»£ç é€šå¸¸å…·æœ‰å¾ˆé«˜çš„å†…èšæ€§ã€‚æ¨¡å—ä¸­çš„å…ƒç´ ä¸è¯¥æ¨¡å—è¦æä¾›çš„åŠŸèƒ½ç›´æ¥ç›¸å…³ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ï¼Œæœ€å¥½æ˜¯åœ¨ä¸€ä¸ªåœ°æ–¹è¿›è¡Œä¿®æ”¹ï¼Œç„¶åå¯ä»¥å°½å¿«çš„å‘å¸ƒã€‚å¦‚æœå¾ˆå¤šä¸åŒçš„åœ°æ–¹è¦è¿›è¡Œä¿®æ”¹ï¼Œå°±æœ‰å¯èƒ½éœ€è¦å‘å¸ƒå¤šä¸ªå¾®æœåŠ¡æ‰èƒ½äº¤äº’è¿™ä¸ªåŠŸèƒ½ã€‚åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œä¿®æ”¹ï¼Œä¸ä»…ä¿®æ”¹é€Ÿåº¦å¾ˆæ…¢ï¼ŒåŒæ—¶éƒ¨ç½²å¤šä¸ªå¾®æœåŠ¡ä¹Ÿæé«˜äº†é£é™©ã€‚æ‰€ä»¥åœ¨æ‰¾åˆ°é—®é¢˜åŸŸçš„è¾¹ç•ŒåŸŸåå¯ä»¥ç¡®ä¿ç›¸å…³çš„è¡Œä¸ºèƒ½æ”¾åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼Œå¹¶ä¸”å®ƒä»¬ä¼šå’Œå…¶å®ƒè¾¹ç•Œä»¥å°½é‡ä½è€¦åˆçš„å½¢å¼è¿›è¡Œé€šä¿¡ã€‚</p><p><strong>å¥½å¤„:</strong></p><ul><li>å¯è¯»æ€§: åŠŸèƒ½åŒ…å«åœ¨å•ä¸ªæ¨¡å—ä¸­</li><li>å¯ç»´æŠ¤æ€§: è°ƒè¯•å¾€å¾€åŒ…å«åœ¨å•ä¸ªæ¨¡å—ä¸­</li><li>å¯é‡ç”¨æ€§: å…·æœ‰é›†ä¸­åŠŸèƒ½ä¸ä¼šè¢«æ— ç”¨çš„å¹²æ‰°</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…èšæ€§ä½æ„å‘³ç€ç»„æˆæŸäº›åŠŸèƒ½çš„ä»£ç ä¼šæ•£å¸ƒåœ¨æ‚¨çš„æ•´ä¸ªä»£ç åº“ä¸­ã€‚ä¸ä»…å¾ˆéš¾å‘ç°ä¸æ‚¨çš„æ¨¡å—ç›¸å…³çš„ä»£ç ï¼Œè€Œä¸”å¾ˆéš¾åœ¨ä¸åŒçš„æ¨¡å—ä¹‹é—´è·³è½¬å¹¶è·Ÿè¸ªçš„æ‰€æœ‰ä»£ç ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šä¿—çš„æ¥è®²ï¼Œå†…èšæ˜¯ä»åŠŸèƒ½è§’åº¦æ¥åº¦é‡æ¨¡å—å†…çš„è”ç³»ï¼Œå¥½çš„å†…èšæ¨¡å—åº”æ°å¥½åšä¸€ä»¶äº‹ã€‚æè¿°çš„æ˜¯æ¨¡å—å†…çš„åŠŸèƒ½è”ç³»ã€‚è€¦åˆæ˜¯è½¯ä»¶ç»“æ„ä¸­å„æ¨¡å—ä¹‹é—´ç›¸äº’è¿æ¥çš„ä¸€ç§åº¦é‡ï¼Œè€¦åˆå¼ºå¼±å–å†³äºæ¨¡å—é—´æ¥å£çš„å¤æ‚ç¨‹åº¦ã€è¿›å…¥æˆ–è®¿é—®ä¸€ä¸ªæ¨¡å—ç‚¹ä»¥åŠé€šè¿‡æ¥å£çš„æ•°æ®ã€‚</p><h4 id="å¯ç»´æŠ¤çš„ä»£ç "><a href="#å¯ç»´æŠ¤çš„ä»£ç " class="headerlink" title="å¯ç»´æŠ¤çš„ä»£ç "></a>å¯ç»´æŠ¤çš„ä»£ç </h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸€èˆ¬åœ¨ç¼–å†™å¯ç»´æŠ¤çš„ä»£ç æœ‰åŠ©äºæé«˜å¼€å‘äººå‘˜çš„ç”Ÿäº§åŠ›ã€‚å…·æœ‰é«˜åº¦å¯ç»´æŠ¤çš„ä»£ç ä½¿è®¾è®¡æ–°åŠŸèƒ½å’Œç¼–å†™ä»£ç å˜å¾—æ›´åŠ å®¹æ˜“ã€‚æ¨¡å—åŒ–ï¼ŒåŸºäºç»„ä»¶çš„åˆ†å±‚ä»£ç å¯æé«˜ç”Ÿäº§ç‡å¹¶é™ä½è¿›è¡Œæ›´æ”¹æ—¶çš„é£é™©ã€‚é€šè¿‡ä½¿ä»£ç ä¿æŒæ¾æ•£è€¦åˆï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ¨¡å—å†…ç¼–å†™ä»£ç ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–æ¨¡å—ã€‚é€šè¿‡ä¿æŒä»£ç çš„å†…èšæ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ›´è½»æ¾åœ°ç¼–å†™æ˜“äºä½¿ç”¨çš„DRYä»£ç ã€‚</p><p><strong>é—®é¢˜</strong>: å½“æˆ‘ä»¬é‡åˆ°é—®é¢˜æ—¶ï¼Œè¯·è¯„ä¼°ä¿®å¤ã€ä¿®æ”¹ç¨‹åºçš„ç¨‹åº¦ã€‚æ˜¯æ›´æ”¹ä¸€ä¸ªæ¨¡å—ï¼Œè¿˜æ˜¯æ›´æ”¹åˆ†æ•£åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ï¼Ÿåœ¨è¿›è¡Œæ›´æ”¹æ—¶ï¼Œå®ƒæ˜¯å¦å¯ä»¥è§£å†³æ‰€æœ‰çš„é—®é¢˜ï¼Œè¿˜æ˜¯ä¼šäº§ç”Ÿå…¶ä»–ä¸€äº›ä¸å¯é¢„çŸ¥çš„é—®é¢˜ï¼Ÿ</p><p>åœ¨ç¼–å†™å’Œä½¿ç”¨ä»£ç åº“æ—¶:</p><ul><li>æˆ‘è¦ä¿®å¤å’Œåˆ›å»ºçš„æ­¤åŠŸèƒ½æ¨¡å—æ˜¯å¤šå°‘ï¼Ÿ</li><li>æ­¤æ›´æ”¹æ˜¯è¦åœ¨å‡ ä¸ªä¸åŒçš„åœ°æ–¹è¿›è¡Œï¼Ÿ</li><li>æˆ‘èƒ½å¦ç‹¬ç«‹æµ‹è¯•ä»£ç ï¼Œæµ‹è¯•æ•´ä¸ªä»£ç æœ‰å¤šéš¾ï¼Ÿ</li><li>æˆ‘ä»¬æ˜¯å¦å¯ä»¥ä½¿ä»£ç æ›´æ¾æ•£åœ°è€¦åˆæ¥æ”¹å–„ï¼Ÿå¯ä»¥ä½¿ç”¨é«˜å†…èšæ¥æ”¹å–„æˆ‘ä»¬çš„ä»£ç å—ï¼Ÿ</li></ul><h3 id="Jenkins-è®¾è®¡"><a href="#Jenkins-è®¾è®¡" class="headerlink" title="Jenkins è®¾è®¡"></a>Jenkins è®¾è®¡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†ä¸Šé¢çš„çš„ç†è®ºä¸æ¦‚å¿µã€‚æ ¹æ®è¿™é‡Œç†è®ºå’Œæ¦‚å¿µæˆ‘ä»¬å°±å¯ä»¥è®¾è®¡å‡ºä¸€å¥—æ›´å¥½çš„devopsæµç¨‹ã€‚æœ¬æ–‡å°†kuberneteså¹³å°ä¸Šæ¥åšè¿™ä¸€å¥—è®¾è®¡ï¼Œå¹¶åœ¨å®é™…çš„ç¯å¢ƒä¸­åº”ç”¨ã€‚æ¶‰åŠçš„åŠŸèƒ½å¦‚ä¸‹: æœåŠ¡ Jobã€Code Jobã€Releaseã€Noticeå››ä¸ªåŠŸèƒ½ä»»åŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¯ä¸€ä¸ªç¯å¢ƒæœ‰é”™è¯¯ï¼Œå°±ä¼šæ‰§è¡Œå‘Šè­¦ä»»åŠ¡æ¨¡å—ï¼Œå‘Šè­¦ç›®å‰ä½¿ç”¨çš„æ˜¯<a href="https://github.com/xxlaila/jenkins-wechat-notice" target="_blank" rel="noopener">ä¼ä¸šå¾®ä¿¡</a>ã€‚jobä¹‹é—´éœ€è¦ä¼ é€’JOB_NAMEï¼Œenvï¼Œversionä¸‰ä¸ªå‚æ•°ã€‚åœ¨ä¹‹å‰çš„devopsè®¾è®¡é‡Œé¢æ•´ä¸ªjobçš„è°ƒç”¨è®¾è®¡è¿˜è¦å¤šã€‚å½¢æˆäº†ä¸€ä¸ªé€šç”¨ä½“ç³»ã€‚åœ¨è¿™ä¸ªè®¾è®¡é‡Œé¢ï¼Œå½“è¿˜éœ€è¦å¢åŠ ä¸€ä¸ªä»»åŠ¡æµç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹pipelineï¼Œç„¶åå¢åŠ ä¸€ä¸ªjobï¼Œåœ¨ä¸‹æ¬¡æ„å»ºçš„æ—¶å€™å°±ä¼šæŠŠæˆ‘ä»¬æ–°å¢åŠ çš„æµç¨‹ç»™åŠ è¿›å»ï¼Œéå¸¸çš„æ–¹ä¾¿ã€‚è®¾è®¡å›¾å¦‚ä¸‹ï¼š<br><img src="https://img.xxlaila.cn/1572081425995.jpg" alt="img"></p><h4 id="Project-Name"><a href="#Project-Name" class="headerlink" title="Project Name"></a>Project Name</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤jobä¸€èˆ¬å°±æ˜¯æœåŠ¡ï¼Œjobåç§°ä»¥æœåŠ¡çš„åç§°è¿›è¡Œå‘½åã€‚é‡Œé¢åŒ…å«äº†å››ä¸ªåŠŸèƒ½.</p><ul><li>Clone Code: clone ä»£ç ã€‚</li><li>Build Code: å°±æ˜¯å¯¹å¼€å‘æäº¤çš„ä»£ç è¿›è¡Œç¼–è¯‘ã€‚</li><li>Env Version: è·å–æœ¬æ¬¡æäº¤çš„hashï¼Œä»¥hashä¸ºç‰ˆæœ¬ï¼Œç»“åˆç¯å¢ƒæ¥åšä¸€ä¸ªç‰ˆæœ¬è®°å½•ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œåˆ¤æ–­ã€‚uat/prodç¯å¢ƒä¸éœ€è¦envå‰ç¼€ã€‚</li><li>Build Docker: æŠŠç¼–è¯‘å®Œæˆåçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰“åŒ…æˆä¸€ä¸ªdockeré•œåƒã€‚</li></ul><h4 id="Code-Test"><a href="#Code-Test" class="headerlink" title="Code Test"></a>Code Test</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºæµ‹è¯•è¿›è¡Œå¯¹ä»£ç çš„è‡ªåŠ¨åŒ–æµ‹è¯•ï¼›è‡ªåŠ¨åŒ–æµç¨‹ã€æ€§èƒ½ç­‰æµ‹è¯•</p><h4 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸»è¦æ˜¯è¿›è¡Œå‘å¸ƒæœåŠ¡ã€‚å½“æ¥å—åˆ°ä¸Šæ¸¸jobä¼ é€’æ¥çš„å‚æ•°ä¿¡æ¯åï¼Œç»“åˆå‚æ•°ä¿¡æ¯æ¥è¿›è¡Œå¯¹åº”çš„å‘å¸ƒåˆ°kubernetesä¸­namespaceä¸­ï¼Œä¸»è¦åŒ…å«äº†ä»¥ä¸‹åŠŸèƒ½</p><ul><li>Push Docker: æŠŠå‰é¢æ‰“åŒ…çš„dockeré•œåƒæ¨é€åˆ°harbor</li><li>Edit Files: ä¿®æ”¹å‘å¸ƒçš„è„šæœ¬</li><li>Release: æ‰§è¡Œ<code>kubectl</code>è¿›è¡Œå‘å¸ƒ<ul><li>å½“å‘å¸ƒåˆ°kubernetesä¸­ï¼Œkubernetes ä¼šæ‰§è¡Œ<a href="https://xxlaila.github.io/2019/09/27/k8s-pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/" target="_blank" rel="noopener">healthæ£€æµ‹</a>ï¼Œå¦‚æœå¯åŠ¨å¤±è´¥ï¼Œä¼šè¿›è¡Œé€šçŸ¥</li></ul></li></ul><h4 id="Notice"><a href="#Notice" class="headerlink" title="Notice"></a>Notice</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤jobä¸»è¦ç”¨äºé€šçŸ¥ã€‚å½“æ¥å—åˆ°è§„åˆ™çš„å‘Šè­¦é€šçŸ¥ä»¥åï¼Œå°±ä¼šè¿›è¡Œè§¦å‘é€šçŸ¥ç›¸å…³çš„äººå‘˜ã€‚</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineå¤šåˆ†æ”¯gitlabè§¦å‘</title>
    <url>/2019/10/25/pipeline%E5%A4%9A%E5%88%86%E6%94%AFgitlab%E8%A7%A6%E5%8F%91/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="enter password to read." />
    <label for="hbePass">enter password to read.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="e534da8705854ba49f7704d5b23f7e512e8147e4eb6c1c59611559509c2690b4">d69a90776b8106231e3f5503e1ddcc13376254b97345feb73ace3f3966499926e7d0e26c436fd9bec97ab664ff6278d2abe2e9b807b38a6ec858abe132798b432e69daba875ff7be7a7c523f8f273d902e95a4d180456125efd258359242df4cdb8d214e0d7d656f657f38acca72109b8ee444f0313187bfaf8c394b184844fba190d334ca97b4f649b0878f7501843f6715e2d6c5b050645b55847a80807e2c3df5b866f16cbfe5627d5fb81c2cbcf05c510944cf75bdb3868b36104c6d6d0cd5ec4cbed377ae865a10c62736bad435e06f52622e7704f62a2f5856497549ae99548ba3002439920edf77fdcb33bd2275a288585867552ae085cb76836f63b261ed791af46dac0e1d16789454eb19e653748a8f42594b214eddf953b2150c7cd4ed7c733852ed2d0870127cda69e931419cdeb137e96470e2335a5c815b4eaf8c3063bbb7a0150c668037d38046e24e75f6cf47d6ecb11de0b6e2561709cd776aeb46291c5bde41ff549133bfeedfe030b483c4703e0cb3dc09138eae96260c8890486c83292b9e5b5b2e57b2f91163b90437a6d3a57f2f6c6df1b7bdcb1dc9530509d327153007774f89e95fa1276d9a8213015cd4043b283fab2c2a6092e24fa4639fe31f8d06066898939208cf6d726951d9bae661f290c9432723d0f846d194c8e206984acd08f2f0a7b346948de76f88c3b55c600c7e0cbef1dc857119d84c359e023a1d0e10fe8214585d82a4abfe51d8a4c29e564b1d51f10f0f1b90dac9aa787cc84a97372b931400038536648eaff56f0cccdf14f9160264f8a2708a70ef437d72dda93bc91b778cbd43d414277d9b1314ffbf91a46e8e3d8ef172878de7a77dea62ac72b55454e07e7fd528176734a65577c537ba29b8001ae7f8f58b31bebfffd55cd97665dd45ef6f22d9318fc71f79b10d11394203a235b3c9a4fdbd024f2519ec60364ff7bcd3d71c50cece12492fe3d11b9ff3392b666d60e4faf68eb525946030f316583e571ed7c7a41c0d0982f24cbae507701d45a6d317ecc63f5a463754f56cd5ca22b579a381528ec3902956b87a102af8d45183f3dfc8eb8ca416332f2525d7f0eb2e53e652c09c11120006952cd0fb1a2c54c83ee6202638ab4d61659bd4bcfbb4a6c0a1446960b320b95613e070a3a197a22decbaa8886ac657a34cde2d91ed5f739b4b68e8e8e4702acb0568079e2d7eb02e8fd4f868f62a682f943376682bd10ff8cafb63fd4561de5f3c24755e6fb48f4b0f7e2f338bce39fd51c4e8fe1585a45d0e13b976eb995a49aa463fc9346b750ab0cc8b86900e382a268645fb981cbf78e94defde14fece1facc375fe97edd674f0d4bd7a22576aca45c44a94765ae32e07c8b8e2daaab28c1c7e0000814a3d16c3e922a923d8ab707517ed20349ad6f135ea89d3a7e6e9ac560c6b7d8e5722413aa10cb5b387c4164e10ddd95080c95b2e1fb8831eb24dccdef936c9bd23851d9bfd3c200d2282a272a0ecf44c96b48e3f98e3646c4578c103ea5ef0035849d1884fc65a2ac38cb1c0cf266c9f89849aa48bd8e75d9131426357cc4a7da740b08d1d6ea43ca6f6b1e425529de31b3cd7a1d0c205e3a1487f8208ba2520dc6611eb327b51140b30a3425c9f198aa055e13690710940169a4d997f1e88675c7891488551b45c95e533a13bdbf7e6f4513fb1337e4f2360cdc8a1e30da3666119e7b644d6540206c365c2ba4ad7e756825a795a40a40e75c3ecbf755fa889109d8582eec494077d3319c0f9c37675384334d783c71d732533717a473109bc86dc86708a18e09c1a8b916268c77bf6db75063028218ef7f1ded1393fea63f1c1cf0c6528885ed1936b5ae40804c15bedd3e6e7c21061b886879213c434e15be6ecd4ac3f71fdf5bbe176a13321941822d0274439223559d60e56aaf2a11bd915e37db7cc7e575c1d2f47394bdb6cd62348e240611afa16a6b1dc5b6f56d0bb6a660e927e1b309754a4b5199026d3416c47435b958b9e8d9d7a13966c305ce2b820479fb33ef121dadfc63b7fb81f2ad9f8cc4d0af2ee6cd68591aa5eca39426d3e739856006202105657edc02ca29306c60b4ebdc9a772bcbdc4d6e8f9883febdc66c8677097a08070c2ef9438204ff465d748734598674ef3865aa0b5f12effb35ca7128e3336010060b648e0c781a748b96f4bd468d73417fb18f0b3d481359f028f45b99e0bc5793c26247652f150c5d5773b0f9e4929ba9230b46f5c9d01f5c285f859590331d1a824dabc4ee421872e14f065ab19b61cc906c778c016d4dce60385d7f520afbf1c17861536071b4bea23762ae2db412cb35a82da3c0b1821e509e8d3ac942161f2b70fc2cd356231be9ac1d94b894e1daae23c598de2af4f8c5bf8394b0291944dfda17b9b426994b9e22edabf016765fea294927528d3399ce71b81bccfb48a69cc9dbeef6bd3902cdd6b1e3d944b4cc4ab0c43451438676cde0055887caef109cc905e062eaa51036e95e6c276c36cfcb13c4fb8564e099aafb8109da79a3230afb40bcc3e60aa8fd759e02a856878079f578cf4bbd88102c235e14f0ea8ef8bc551867f87c4c7f6c747e026c875ec8dde3bdbe65dae7d99bd21ecd26483af21d83c5955ed53a4848007b93d5e10daf93b83f81d6cff410723acd5fa5f72716494aab2c22f10841e7bfd4694441f606c0f4caa6276e96251119ecc236cd40c47c9c186b706051dabc091ca0f20c20a45482a6ac967abc46f35caf7462a7821237960712aa2f9efa827625f5f05031c9f2053f901845d53cf57359d1e7d1b47d746a870822880be35ede239353033147821b96d0ca1bc10f90c215e4ee5ec907712bfd1fb4d8da61721fef827681de0bb95d825569c15b72d93cc4c862a27960f0762970481d0ef3f8b4beafcaf73f99c3149dcebec93725471b247f79b746d77fd1a53ba00f9ea23889befe296935147148a5a3c485900136722d4a58bb1ffd1a47911f339727f1753b7e6b0cb92e84786c1886644396c2aac9ff71b6831f395c27b70cf96ae549f570ef83a8d29c220a583a8de6da9ca8280de078fddf4e5d7f40efe3e1d18ea740d36170ebaa8a0e0fe56c9fc8298eddf17ab69b2e3c46b395be15d78465ec7fa81ef4c94dd29d17d343b14b7d9d7beb5a5d568f8852d8dbe74be773332199118dd29ccc63a108887015ce7c3803ac50dbd0228ddf9117a3c58416711a911d051259f0a624fc7125b1c406ff5ef7e018292ab5804f1328baa70d907f6e5e30b2ff9f42ad8af4657dc2114d7de10afcf9a8281935c9b2af692de0932b811d3c52ce26900c1971f8fff812d65a751c3242015fb7abfc1a1682cbf3cf0c44a6690bd93a691b4c97ce976da3e3f1cdd40cf72aef410dd4625c4a152fe49be4110d5c653e6de0231cacd552691e56ec44ae91e0e76c63aface131f13294dfb7defddac40dcc0e6176cfa6382c7848bcc00c78d76b6f78fc841e8984dc752d3e7eb343f53e84a396df8f6b8af73404a20fa7bd13486a4d99a0650f08fa835822df2d0efccdceacbbce7891b9ef236dc5ad61754324c26abd51747c5ad401640260bcbfb5ca9b4fc2ac021d05d95172da372469647bd776197cc6a0e5348830ca977ffe7d7e46a9dc80ba8d1f5d5d4681e962221c8f3f3d6a910ae88319eb9b1e572006e7eeecdc25402be3825fa26447affdc2a8c3db1ffa835b23863e74572295737e56e3416e8eba959c6fe6225b6dc1b3860e70c70816e655bbddddfe5ca28b2730b9be50774702c49781d77f4dd65ea56f7fda63d9c73ef0d6b0205ff9f5f3645470cb0cdbfc4247439972105076047b2c9d263aaeeb9ce9631d69d41cf53d039ab0efaf8fb7f7b7f2db1088a066cf1636f951c249881404414cc35cbec9144187ce3807bb34c32b8ce88098131db2165f39c689635d78f651668742acd7dcd8a0c0b796c2b115fe4d293766f6438c045617b0b229eda859993f833f3aeab3404296b6037db4596c6f34b7d6136b2957620db6ddf9ff8363e2ae3e9a6ee4e6fd2c3ae12efef0b6f0b017a985e5bdd3a79e3c612079731d6e34916175c5bf3ffece8a69e3b9ce31c7f723d6490bbe34d14e45030a8c26334ce71fedbb5fdd00a621b24d83d73505bd3af58b9fc3524b6d47ebf7802e462d97036daa19a23bb97c5a8929e73f6836d296ce2160385192ae70b9898e52bf47dac8952d4227bd8c990fa5e03d7934e12131176155d8cb7e0e30e5dd167817e904f815933629474c2b8a877cb11597b8f460e8d2f766b18ec87a15ad50eff3bd2a9eab13956d485da265060db523b6d50909602b21ff4c8d4d88672c76fbd8c3288ef5d413fae85df1162eec0f3ee914e0729a2b6e02902fb1c82a3d0e120190d55fc08672cdd7baf1e2c6545602937a54aebed38eb8f41a3c435d269539b1b6d5f10342bc13ae2e6b15c63d02ced1df3b425c0f3f2a4fc6eb2194fac8d540a5d52e1601cece995479b5ce4e4a6e2e2fe4857ff19226966f6959f56492d1ee62aa65eb45b7381bc70d363c5de6764a1c165632c9026ecba5513f529c580e904f5857e9359c813168602792bf02ac6828471701840ba340eaa6da218f589e309f940bfd98d8b3f34ea765d4af86e068783b96b56a32aeda4d419dc6daa47aaa0fb567ce2e5d0cc9d9d9fc0bd9d3e4bdd084fed3f1c7995962d5030eca67b79010126124f575ff71ce5120c7090e231b717a12a0173af1046f3ae448fbf7b27e4c02a7da94aeb922c734109241041bcf11bac287f49d1eb986c899c06083ec77a122b19112d79284de96a4494079c0833641694556dae8996984563c4a444c7e2475d2f1da375f53506e3272c634bd60ae337bb1e56458e1ac66ff6afa96beebb7f883f672c682cf6acfae2d7a96709b88b62f1a2b2cf76a86a47a1ade8022e7354ec498f206856da37022637f94815fe87169e8f28b38d8d592a0f08b7f2ce9bf9d5f9f174b06c240642dc1a9a7b6d1e6513d108b40edc25197d3e500c11ca166211dc2cf445f6a280e7432eab66cb11c225829aeab9c846c62a1526ee253205e2c390862fe95b29c6a99ca501d888ba1fb8735b87c402d223d820d209e948625a3d1a0d298d8591655f0fb66d2aadc6db99a56548ea23aa6e079f46ce8f3e31d4d8aa88aecc273da233fff0cb30d85322af78742deb009381379d603165a79fa5f7046162967d246294ff926154a8e2a4ca4e57653696f4693a791f54a18d9c4118ad2b08bc3fe17da7ee0981aff2c20495f158a58f9edab4caee0116f0ea30a72266fe60d8deea655d8e086188c0ad002a2a37bf978b6639faf588c892e3dcd3878042a91b633bd84e6fe81c891be0183e0f2bf3be313704d3ad02b3f87131f1a5cd62c5d543aed55ac5fa83ac64d4dffe036e4034c1c5203ce70951daba7838a874d80688b6f00b13d70755680bda58ce2d6498fa619945f79724cd31c1a8d9e56b001f412ca1346dc68bb00c1be95530e9ece4f029c8cc73f5e4f46f7f40547eb7cf07dfedcdbeefacec364528b6ad56caa69d6671de4c990e994482a8767f5b63baa39db571829fde3eb7d0b8b4665b05bb2d6a290cfa7fee3ad2130dfc0e18bb185f573e21f84ddf1e8fb45ce0c1c2f0410568626d1302169fa9748fd1025cd90201729d7e81bd91b3b78b8d3c6b7b5b34cc3e44a595620bbea768d571edf55a2e30c2d0b861b9637dbdee324129ef9fe18a6cbc2e773d0dd36b69147cf2d768511d9b8c2839854b335a0aed07ea2d74f92dffa8af31c16d9f546c29c89c260b039b89f820bd65afaae173f4456b7c5def679f56b1f4aa1ffb167d4b95693f4df5d6c7d4a666d0f5115215871cc718cfa2faadf13fde5053608745e195d6c0be7fb1a947f36d81fbfa60d4c99aedebdb9a121b1430b0cb7fe84b35f9eaa8df9d65bf013a0f0936251e142e0e230af6634e1a1e280bc29e739bc59a7b2713c31afd975b39d110b0fbab105f51b549a37ed6785ad0c8542e857aacc603104b50bfc534c2570fb2967d56d496f309cd1a08c6dc53e9b94d4b38b301d2e5849a8d41a3325b9521844f20daee327fdf2587952dd243472f8fe12aae1f4b87e88ab1e8fab60107f7eba9b81394409ce54b017c27cb777e14ce4d232b1e217a24aaf8bb42d033e09c6aed96991fa783adf9de56c5bfa224348d9f557caf2f7157bc09764ff13e6f8829b32373e7e49b904c00bf803c63694cdccede2f0e6d2c5b57fb1d8bd1241e1a86d6a267779fc4b9212a69b3c8f2a85c59ddf6515be3fda2855530d10443a6c2168959e911c4c221330b7c24235caa1e6fe94dd8177be950f0c2a1c828e3ab53da300f45485d8c552fe85e781a47e72a9fd3a354a7962a575ea824b0ec2045c42a159fef13b2ea664cf64aabaab36279c1ee847a4a583c37b58bcf952790e2af280c4606cfbbe19ef6095d458362911dc037cd17ce5788d88df0e0c696a7f739993ec92466bcbe2f1f6113d50d6b71825f950d9467ad4f01937e4df2cde9d64c8ac2b71da8692f7c0adc9ddedf26ef09545d92ce3b21778ea8be5c1ec1370ef408cf27c2ffb5f5e512401c427b4b60a20f2f73afba4d095c1af1332a580d5b56b89463a9b90302e6135c0ee6bb34bcdcf1e1b6f8724fbc5d688e59d58907cb8a8ef6c93eefd6852e8cfb38cdd468aa4300f4be4e5c73b0afd522995db30226950fb998de3dfb90aefa68acfbdd55d7836764dfd4fde860cdb117335e54a2c317165c65c4a75ca7ca912923ac892c30be8773fb92728e2423ef4498857dd543e507fa380c9553148aee634237ceafd155b9a466587878d208f24e16290d88b485cb33361c8e350cc4e3185acea5854e4ba5f08036b6fce95291699c91f3dfe4cabed67a178d32e34963ca01a9d6938623ea76ff9d249af87a707bc441f0f87d9996d557b4d5c3f652e24e2a80b0a9602454c5d4baebbc5f859c1021450063504cc665b726f547da93dfe4fdb26c4660ead918514c86a091cb4628eff7a273f38c542cca60adbba0c77babe292059008dbfc65ebf860ad119cc37856dfad5c2742ae360288d0e135ee1a956cc07518fd3be3b09bbdd6503fcd4d3100db109781607f232d07bca45f5fc4882da54889920ef29449b21eca7d13b76a7f4fcd3f7892eedd1eb32e6824f772e141decfcf78a8ac5d5ec3122bcd8719dbee1ff43b76b925d0f2c426be42284ac3c515723ceb0ffdcbf28f28b73931b467a0b536079abcd53e1bc9605230d2a58c8d9bd3710a8be622287943db08d47009360afc04a4dc1933d69c76f7384d8b6e33d50e2b1701782402ec6bf34f5cface95025543ecd937abc97ae5822d84bac10559aad2d079c963fbc2d5898dec3cfceb5fc2cf1663d6dadeaca29e986be50d31b2210779294ca60ab70a26981c3449d96fb7dd48568f6b5bbff86457fc37153967146b91fc30286c9ab9ac83f9668eb2ccc5a714fda6f62b324bbb4cb113318aaba0304b7692dd024f4ec263e37c4141caa377f64e55358e18d8bcf5ab231b9e5cbdf2b3a474d2314bebdaa90e18065cde73a45038de7eec4aaef39a0a8966be5fd32823d8d675b7bb0486ddc146f78c22c31db02b9222b2d8a21d2533028d6a86110ab6a72f41ef05c6fc08a4a5f7977bf41d6408c3788e17a4a6e44bec4b7aeb02dfd049072dd304485dc8789c17fef193e27a186ee8e2a60b40f396dfdb0553b635d0e204851ddf0dd685db4d680e8f9cfffc1e592166aa26a58fa6769770d389aa1093f053d2357d417837ca20e1fd51aff8b296297c51223e82dbb5ff16da7d2c71abd071195649c5a7f9ec0ca1006ee6cd0d0f7845b62e530b4148b8870c46cba402e9cae06d3b7b2fd9b0e477c87d910e15d47f49bc2013c0988fa0dcd851dc2988c7468bef1c8d6d0f4fe8dfc407f56117795eeaf417d3d6c384da76e091c633d170d070c6f6fbe25b455dece94bdf52930df5a4a802e412505edadecb6d293cf4841fb92129b05f4fb349f9d8ecc2574e0469039824955fec83132f5a5345bafa74a3427c601b679198f11b7100397158876fc68b07ec9343b9e10ba84cbed30470445c93a05a02c4222173f6df60cd4d0e1d068a05b9c0bf4d632606f84e08ba3d0bfc10a044db9ea97977d9b9e9eec9434d4ecf2e202a97aea12f2e0f86001b4937dea7d7d2d5f3c591358c5897a58de269e218aab6a147abccd6ee586674105d50633f38059b97b339701014421336f4f00b8666b8fb81f9549d65c771ba798016b17e157452844d4ca92d74f226cb0303ecc4cce51e8ea8e39bf8e8a7f057aadfe818b6cb57fc7c21276267a50c19af6bacc77616eceeea77b41791fe4ce41b33673522da7ec928f875f245ed849c07a41c4a33e2cc1cec6275c8b6036070bc2c63be62fe768ab1d0efe455a2e0ae9224ab1ae5fbacb09ecf3dd8d88791873ef26a39130316f11634195c2b1d726121d81ad4723c06a722eb620b04d890a8778cf959e4b5a42b2dbca0d85471a0963b4d6192078cca2b789e1cf1dd0f04f08dce7821fe2a3f4746deca7d506d8100cd0d4cc386b5ef31b592598acfcd61543ee27a40d12f5aa654349d0cbd8ffa2f63e743bb4b13cc7827015c1e8a7b0b67f61ae6ded893422892c409deaaf53b6c982584c0ee642d3b6f91ca915d28f144ef03378c2cbe4cfc515c83c940df3fc03ad3dfa8e643309273b33780c894a93d47700170c7b4dcd51d30dd9743a4879ec04de0b2e440bb11ae6d5af28f7efb0e218cd3056dd6b6634c5f5b5861c5a56b6610c03eb16f0d6b378827d21e3b0e2ced911fde49c63c5d126f7cdb0b40927788964b3ac97035235ca4abc10ef9749838af6fca60831c1a914fdb7703db0d57f7a6e959113fe92f04eea13653b647127f112f8f75b182b844f6411c64746ba0618a63ba7d42f7129a503eb5dbbe6f2902463aa30ef920d6d142bf3e04478441061ea58cff9ccda8b7a8efe1761d444b65449cf9ac396465a69a23a70085703708429de6a2eba40dd326554d0d4536bd20dacc89f7ffdf356d598a07dcbc1853bd6636dec00ae23bfc6147ad088cad423d040be07fb5a5f94c4f18b66a98315436e8587912937c82e1bdca781649af400ebc4ce44ad2d869cf4c8cfe4a791b2b45d7ad7a46054c495aee3ec61881ac0484cfd7d04c23f8ca5f6ec6afe5d29b9878d37c9c5c624635b069c75696c8751ddb9612a1f421ccf440cbb4769119981366e74bd6a060b2a23a42417102e2f23ef3b6719337aae2ce44e37893b7296160803b7993bd818e28439a9fe847282a328b33294ef282ae123e69aa0d8ee320f988f351175e3d9665523d1403897abca6190acb636a91347fd90dd76c25f0e6bde6ecf121f9a5e7bd5b8084c5c37a3eaa5bef03817da27c78e2459e1ace1f257eb78824c9368526b27bb00ef124cbfb092629d09f9d4de9af6cdb21e71d4d5302066178de71ecbf7927213e9ad7e64e6269534da5322d362ea5c5b89116ae6f8439d60d8f66cca5b7de989c555f9f5ca4b34169423684c224277160424f3687d9b75c3aec448a71bed2391a1be277ceaa258c3eff0980db74116a6e9a04848d638b40ec72ff76b05da27d8e151db02a56d3ddb8107431bde490e678230e5a0c5adca369489522c32435f003a37cea2d34ddd681f269ad9055240151c398aa1783c2b6799a9127f155ce1e200dc21c632d79faa6134cdc3ca5bc75a1b14571712e3cece3cea8210d338fc76ea75c99232c6284153548b110409cc0d98446de9df53c7de869deb4891530173e57e722943ecd335d88d92e07b8efbf5f35b603fc9cb03ae5506799b2547ed3063978ff5baa70f6ff39b776aee47182344219331e268138bf24d2a247a61f9c3bfffdf911c071a71a9421b44c393385898bf8ec793721b5aa2ab14b1d9d5d47a6d526e0aadd8dcf690737c8e3e737bae954b9e4a2cb553749e802c716b28a9426a7c83b4e01802aa9e79b92998858fb3166a7488dad9cc4da35ba3e46c2341211f1f8233abca1d01688c4051a3b469216de26aae1cb68879a2712df15eba2a97d4da5d290f4a88747b3bc972d967e5e0ee6c20c0a9a2215a3da5e096c74cd71b75b6018b3e6a24ed34da0b549192c6fe2b127c351c578612543cc73b9cce23ef8dd5955075f07ba7edbd4e1e3357674e70e35cad81c9c942cd183e4fb9e26ced7a97abbfcc132a1a7fd335ce9b52b17efceb0ef9efca0e7ed5332e86a863249d308df6ac5b67291c9b459c934ad96eb8306fe7464e3737f134f4b604cb1d20746b6b0f4e73b9fd0e5efe6c3ed2079028f1c128f5a0f27ce6b984df10b1f534edd74e4f1e1ee4722701ecc26f90cdfc8bde58379a8382f341043afb38298ed842c047b9998e33f8787cfaabaf100fceec72dfa2a59763c494f87f6a8d8daaae18dbaa56552e566ae5ee62d0152879dcc82fc322aedf759834dabc1e08f1fcea01490296f60907f4449d68622646d8036946ee180020a48f52610700505a54b68f1d53388c63c4f61c642dce2331b00e9ef5cca14ae761198b070a3439357436bf1aca24b1ae7351486492941fcbaefcdc20b13569dd690a383aabc0566a5b2d0e934f55da8a6be68c7d8d8d4f60178bb665fafaadf071f3fe5956b4dcba06f97b5c6fa0116137f6de19ab8d14548aadc83a9daf7d2a3befac1ad2560210a47b8493e737f9b86ed8acb173910b25de843b02b629212c411605f9d547f96d34633383246d288c8e81cc05b823d064e2d58c57d189d15965cb3467d18ea919b1793d2ac9bdcb0657da72184ad4a9850b24acff0d8cacd32f9dc3452fa7adfd6024df9de5c54a45f0455cac29c37c17edc8a1e11025a17a693d3f906539a5a22326cdc56bc91933cb03a80293d1fe447d450921799e2cb9621f88f1de7f9c638e7ab43e06e1218ff8bf9d3054bc25ff2b9b71e7dfb692ecda9a9f729ae7105ce726c2d6a433a97f6403d342f47f3e1c538a63403dab2030ebaf764ee8f8bfc84bd3b75d4eadab12b55aa0d990d62c8066c4e5a8c90d25cebeccd1e4fd39e445d37d0e2d448d9e2aab46a12561dbd17def77ca8571efa4a82b59aded0810a1b35d1aec06e327258953a01eead5376816f5151c05e5cb4df9aee644e394916cd8326a039a3397c2a422f0eaf243b8a116879c30a4eb727c67119d004a7b3f0476dac1fc80b10047b79b66736835355490a1b8b5b4f634d0bae984028225d3ca623da2b922de20ac118d176a40636647112f7bf83e9c5ced3a13be23acac2865e8bdd4481f3e76fdbaf7bdbd864352768a42b167a579de63284f175762c1b2775659943c3a61c1968a62c87b6065620626396c4b7d33f1d39c2ae04a3dfa17d0cef9ebe717ca573b24da1c6432cf0cd0e50756a94d0b0eb207c95305067bb45696d3b99ca38e9f72333cfdf964507878a65c1625ff60b8c81e870b8f6645c86ce2d4c9495ace70a2fa005063d6e96b35ab695058fbfbd4fc80fb65c72f28b0507d1c9286badd922302a0cb5b78271ce0b6a2c0318b951f3596a1b0e69be7900e8879ee9277aa009895c57ee13a71e446fd81ff105b50dbcff275d9f9644daea4c4183f5ed5828caa250125ab4543d3e9aa0cde8882243d9702e46f820250925dfa8d898a1c98e98b0d4bed9cdd9c9c7f9b82e56c4e00dadfa37a957f7b869dd00f69485ba6ddec6b8ed338962b7aed640bca1daaf8e21ab9aec6591270f4b3b65af671535a63f3db6dcf59a4088d2cb749b824cc41806ea7681d60492c9aac616e4164dcba7c227308e8c5bffdc5aa4621fa0b7fad7c4bfa49ba96d4ff6e77eddc2653441c687562bc89509d2aa0026ecbdf185870e8a423fe45541e6693702ada6dc2b302f97627479be6993502d47b67e178846fa55f23327c5863061426baa58681adeeb09460f88d8107f2e35623ea14eb7694cf29b2190765c64f63d00a048cefabe2a792d568d1699504bfa4e2cd0498bacd4f4bf84dce4730bb980ff2d6158302cfea43af734dfcc58ae5154af751153c66e5a2e788700fba7ab7b5527c100d175af07d35976bb57df8d0cfca3c779811b3c5db8e9b21fd5579b1b775fba2b410112b276e6fd240920c41a2ca6161d37973897656cd6aa16de34a48002192fd0564b1137ba7b4380261f3da01bc10cccaf8e5ff1af9ff327c9612a69ae65cec7cc4232df9fe2b2749be5e5962c259c688a2bbee5c7375617972b0ac02ee0c3144b07650f413dcf2799bf4f1bca1a309e764e13296c50e71d1c57e61ac90bf2dc4a0743acd2e68e75767755c038dc700f9e2b80fb91251b83c9de35cfd3e415a9a2c801d9ea471133dad85b4cf36be0db0e0338ba4062e36ac63b45daf34e54f71d4460165f86a76ce186c199ea9e4725de4860edd931f80fa6ddd72cf52ea21d865a9e649b60bd9bf2061896b3474f575f880f24d3f347957ace2a047f1baca0fb0a866b210064b9b1d549b97f8c95cf133e5c389dce029757ed504bbd5ee98515814461373a0976e5c80c299b907adc1bdff64581160a6426ef9458cf87cd8a07b1362375c9680f4c5987b80ae6f2e0f9ec8cc901a31294960a23457975953728432b17e25974faabb89d831a4b8311d655b6bb86560077040372d69796ceaf64e187bbceca1e14b903885d8a518526ec1da7d5019731b02c101c26f59e9dcecfc8cd9a91ea3e0212a89816994a1b686695bacf326576282eac1fa67ead2d18af8f4e16f455aad515202dd1f4bdeb52f4c739dee54ad1f705131a018da67a681c083e58c6cfda97dfc163431c0afa8bb1a2bda91e07de10c8a9f4bf87b88e98c1e2a0a22c84ec5b9ff77c73a99bb90c80fc2ddd5de90b4c07e2b032673c58c97f42744aab3b5f14c58188fdc89000374a2e5502f737f465dfb87326e22edba96c6cb8970f4bd111812fef4c1d1cfc0e9b085ef0c5940898c3daca14270cb5eacd4ec23b3e277e4b008ba125f23271279426e489a3766e57f116176657e1cbd93b6742b10403c87e0ab7144fa7d1b7c2aad9387ecb717b76b855ef9bb5da2cda78a8164d689f455021acd47d30791a4ae09e32b113be400eee0865a63eec595c0cca9a2e162bce9a19f02de6ab90dbdac7b66d44aca25b1cbb372dbd6dafd4db94493af75a0d6a485c891aaebfdb95fcdb342f34cee16672e415ea724e7a103b49f746990d0b6e8a262c8e0372bea1895aa45c545eeadd4271167b102b3e4fb3e627f40d0df800e2455af79947b615549c47ddd5c3805f9374a13b26eb453ba5f49c5c7d3a6ee59d4a2eb55a721ed2851c592dc80052046ce284d08549c9f5d9b6510d396b3230ccac0518c904555873ce58aa433c03a600d2f53571bd22deed987cbfde45c7063a4b3d9745117f8b4f9aea4d464ab841c4b23c1162e64ed9bdd9f39b25d17871a428b909b22360b17c708bd46806f4f82c23700193cfc3cf03ab18527d2b6f9f9e8a1227388c214931297efb8589a69e3dedd3fc8c922c2845420915a2d157b470bdeff042a186fb679b7c87c88a4c861543e012c7461abcbe3042bf86440e7f61d8f1a02addc9386096c1165ab76c227b4b189f8ceb42fa70703c130b0842414f2d32a17170c9e0130819d1316eaf4c736a0222081aa9153dd0a48f3e2e0999d90b3a507ed2259b3e38a6f777e610b00ef682d5418844aa2c0ca86805dd42f3bd283fbef0f624a955850fa89bd5817b48ec093cb19e7f57240334092d79f1cefe31af5bfac55aa57f56146cfcd8078ee212c20e1c5962593926f48be4c7d93607a344b0f0822b43a718fc19b516c09165393a7f607d0f6bb9d490cbf0f1dec90d037bb6c3cbde8b13c53364f8028eeacdcf2c83911af2f5d4b29d73504fb972c4c1ce5d10e4b187239be60ab081927e2ddd0ee8f550a6eb509a3076af2138a500438c3627420601e2dedc63c64c352d958509e90c4a7c2ef1411bcad27e7d7771a8ce09db000334d770ec54ff6f2f12d261da7f6c0b1e9f505881f4634e67208728c8be6d9eef7f8d61930f6a3a231c9888b20ac9622449f39536e9e7892d8d166d3c17812ee50b1cf66ac3c7a66cd882b9e5cf3f142e9103238bbf90dee9a602b35228b52af92cc3ac83de46dfc7ef0aaab938011c28221703a61f9c30c2cc506bb7aae1226397ace723e5195b4d3ed41e67b14f9ae974b64976f1a470baefd749fc1a083210bb52bd6b10fcf3295a08741b48de12ed7b9752b80302be4c84d82c390416863780436493380095059068228c2021a8ebd94f0978c52e30ab056409fdaaa62762808007c3ce6fcf7f3fa0f876ae61433c521e11ae3fd20b3ff65e204cb2da8d9c146c86eda945a28f6fb6bed9ed1dc44a81c637543e87057b1046d5fdfbb52a5fc2b186d7b91f7f5fccf5ac5f1eaf89cc43f2f7fc1f17b0ed1b2aac30662a5199fb47b532ffd9f1d83b738a60eb118221df9052ae5fa1200ceed933552248b68dbfaaa61ff9657bffcd2e55e45a1c886d482795eadacd4e7a2b43fa208bcaf77598fd07c3d2dd1f5ae0f27729b8efa84600f24fb0041fc7f1acb9c78c7f19422d995d1e34cfa55a5867238c79599607b33f82c923a66ab39e461b8c6bdef21c784a36184a34eac18b0d922aba1207fca80648627ec35f37f22d787024aa5d65be3e6edf28f56a08bd885e172cda2163abddd35e1fb4cdf5508240c48980e3726c9cc1310207fb2457cc676575f212cda035864640308370de52a7595b3d0f465cc409355d84fe215544847f2450a684d355666177c0e3c11803c873fb98eeeb63734bc86ded6e272ffcba743fd676b69d261a93947bfec5d320bc8849a9918ab15af5c94e6aa941faca768669720ed16a30075998b8dc2858e747d496ea3f68c5a6280dd9dfd70f11cd9ac7efa74dc08fa6c3a0f823075c7232fd09730229291542e150a5a2be171c95208f9dcc9c2cfdf621db182298fd648098ff67c5ad146b36fb146c1ff8463f615a6273a45a727348bf4f7118852a82491a5325620f9b4b7bcffb2809f1996cea4ae93688c4427a60816e1f5c9ebee8bad0a82b060427674b2cccb642f008912885f4d5a9a5899f93770b36df6605237e6d5710242ac363c46e8d846ac346c5f7d1b81f770070293b48cdba7fc810bf43f8b7c8870c06908a91c265201ec02fd86a974af4cf46f61930634711e22e62234f247eccf95e449e30648b09cc11ae7bb3a61505cf73758241ea08ed132b29dafe6c8d4d812388bf9052819b0d1a874251b75b0035bf7c51c42d7fa908bc4239a4095676ec86e858f253a8a9b1e19ce942eaeabb0ed59d3739700df39d5559ea81f9168e6415078b7d116e865c3c6613ecc1d9d34e287189c839ebac397dfeed406b9a18e71f9dbfa2e59c1df710c8c9ec7409a05d3f8c9513db3b7c2d4bd80d9fa99c68145b8e0c25291d49a5745e467486df1daeb61cf0f8b9037010c8cc25dc9073be009633a042f8a09d5e294844e079d9a12e5ffc527b8288249b586ab008316715a1f8a6535d387d02a61a542fde0cfd60eaa030aa0e666bfc88b2ff462565b1eb24ce6dc183129cf6698ed50ed4846e75d1c74743d6ba75ec4ef8a7261d70e7cd03c983f3398b96b2c6a22f21dcc00d702fec58eef7c7a00853eae4ef41e0dd8808df0310a46c76097123fefdf74d376dd743bb6d00aa2fbc9a6d61dddbdb210954402410e6f8373b1c2ba624eafcefbcadc55d4ee3f4e04f893c9e3e6204b9f021c3cdc53d7b5900023a17b3eeb00553e45bfdd76e4aeb410559b56327fad8f7423d1f669227a7f3c641f837622a34452bec70619f9a75867eadeff19ab7175a4f69ea35164122eb2491bf9239037bc10af063f532a61b47c8b02f09006e2807a6c85823c9f48204e697d241804824b34feecd4723b7e9525ae350eab738f53ee82bad8abc9b3b8fccaf6e1a669c0e53baeb15f00b22acac537da47f0fd4de73ccbfd141c17e65f6195daac194a453b2e46df64a690d85eaec9755e4260e001051d3c1c171f905f5b2d4db9260e76ca450ccebb2835e81c3c537b9b2e3e018c20a093427e4507c06c80785b9afcf2c130a09d53b7851c52a8a8b0db5e9a207869c1ea5aafc3352b73e7fcfd7f9489a2d5eecb6dd758f8e67b8069471b812ca49964c64cd83bc94a006a297ad9851463e466cb4569823f74bdf6019637b4c4790710ae78a5eb5cc4df64579f2f78710e7ccebff3be19dfae164d230fd05084d8122b2367364be6b05ef684a32b37e257da36f2227edc5894d9eef7a14ef0013ab238360d1f3c383c2e5818961bdd8bfd61e33826bedf96b5b49d0e90a340d6fb282bd25a185dbbf803db13c1373166af9e8f41683358fcd58ef325250c7f1d170b6b79325247d40182b50c6520eb99a63c4d3575cf7fdec342badff537f27f37475c1e7da56394b04d94da0a562e7fbf585939b5ceca497fb488aea03681f60055cefb585a32cd704f6274605ef108efd4a906c28288475c328d838f05b03cc4eb916162a5b23afc83afb00457b2b34d0a11f0fa213192fa23ef7b10a885cc5fff67f17ad05ef905de289cc4b9387ba021993dac37296d3e9bc99bc29ca28cef0ceceff453b2ae4c487bb927f0b21d73f1a2f5cd342bbf31821656467e223a380cb4ada0005d37979e566176bb997c10d3938e102f0eaa1c88b9dc3c779df532fbcf92e2694d923f8b5accea757e71c18d552cf653f6989268399ede23d6aea104dc716bcb1ae8a76088a5dd229ab865c41b42fc06a5972e2e58ac5f6d4c831fb8a554795df2d43e6c17d75b81b27312e0c4167151ab33f1f2eeffd76492bcfb2152465c0f2db01750cc91af8fe23b14d648f3bf034f0d14b139b1066ec5c6a9d0b99a9cf8a9260a069bfef7ab709682a94fe2769cf7e778b41bdec0bd205dbbedccaf11cbb89417f2f0aa63c538602391d4168085e43de23202fe0bb2d43869deb8636c7fb23b33ca6c66c476db357c4d56c3f231308a8086613fc87729b6724294bc6ef44fdf150809577f3de938109f45c688704f1a39ff454d11d1e008da207b8ac442c507578addf172b959ab1c8af96c35f3e77dea30e41d3273ce05224cf1ef51c08536ca12219bdec8515cd4d69e667b9a4dcdce723d1e94a1c78152819e731a5f0b1e98b5f03274a092fb0adb56eb930f05510f1ae4ef194285b4c3368742ef9f0735f11b3f4195a0ae1fe74a829357ff2ec764a63b51ab9ee6ff339e839b83284f4578a30d2298b846bd2721a7b215db90bf3683e9cba3a9f4e671e66ace139ad4f69beaf70e015110b9d0080d39db9e50684d5b9c52558a126616f7eff12e2b060653dca84ef14d45047ef331e677602de559925d23ac5d0013efe9db76be70c6cb65706531779e51381d1c85a18371a2899ee73f2bee26593caaed8c971d26ee48adb52945b35fa8f9f686672297a5c71a15c574538d9a82f5f821ac251963ae2bd1f0c79e4fd598ff56c92ab91e1b914b64fcae8cb947e1ab21f95640bafd53e3aaf37a5b5495930f32cff28b205b1e423d8cfc1911d4110ff5fcafc8f9c74b3866fb17a921a624fa7c88256791b9a1918d653fc8e2a35512b58ca702e9e91ce6b8382094393a5422eec44ebe27b1d6b66d2edbddb997ab15cceaeb44dacc232a2a7b6c3252ff818f63d6b9a5ec852e47ce6dc61f47c1f2c619bd44ff40ff8b16bc0e1daeec6b8f7cee1cb12518fb882c89c09484eb26ef84a23868206b3f947ad294d867a7888ccef3725899e8737a7045e311228731ad644e87eb0760a7ced5645e18d76cf32356b6da60f7332e6b3158e901121f669efa22c0184e7b0051abdec5839822fae835b3b94cf01c4c46ce48c46bf1a685b3c8cf56412018470390f400a1dad74ee441c98d93b9de11859aeb2789f1c3a1e688f55f93642197c18423e103019b9b8ebdf1292401972eeb9782d575bc14c2bcecaa71dad55b1f56b254370a0ba69138c5ab478940b4b0e857517d6705c1547db14b357caa2f5ba02c474c31902e067230acf10629c4c41187616bf3a63f81da0425c93c0c14be54be12e3bfcadaedd578adb804b66909eff6813684707e1ac74b3bef76c23f89e9caedc8d8ac5205aa9042bdf0a18cb2df48fff442e92880a955e08e488ec67b3707a2c27ad7117f6a3829393af28627614c6c8a6cdb4e22efda6e4012c55a1fa9f0dbcd0d1f7940d054f14f038627c9d014ad8a7e22f5d6257d53e8b99f4e8f2b5a90cfcf993529e132260fcbbd3d3d05664a47682043886b6c4504b525c5d4fce0e202711c961760788196add0456f6da4d223cf7469149c2212a0b1ab40673f1d886d4bab7737d277cf2bc26d53d55ab1966530b5e80c2ae5527285e6acf08ec6bf818bc1271c11217a8d2efa65f5b4b80b1f7384cfe67e8676cc2bd5baefba8a772997e40e6839c4854752faa47cea48f1eb4e028d0fcbf4a6202d647e4d76a8d83fb41e93b01483a6c6187b083b2acadc8ba81a407fcc6aeb4ff84df2b603fca11da4c31fc52ac32e77e134c507782d3e43576a375015579763c0bf2dd0a77848615c1fec25923d8e2f37fc366559f51ea5d69c132fd567c80bdd53fbbaaabdbb6763ccfaf71fabdc9dde40a2a02e62079236ec2b46f9c4f13f9cf5407cb7c1cc5820b498ebd0e0ac34cea0f6b524f5b816add87911b36545e71fa2406287b8f7f2def296781ae987a6b0144392ba09ac5cc112ac4a0121d85130e9f6907de0a8769a1fa5aacf78dc08b8dbb7a3a84c1722d4aefb4866c7a2356e228016a299ce2b3b11b3b5d64498b9efc6b95c8734a888d137d277ef9a6d5407096414726db973e8b08b17ff528f7d8bb8b587a2dbedafda653a8fdf7882e03b0e5d89f651c157d92d3e2d8bcfc88fabdb5e1d66d5f1ab02708efe31003bfa544d01141b6eda0d503ba89de342be26648d809de33fd66a2a45d20a24bd6efcb4cace7127447c998568dd492c53b173f27e84eb01697604532f2619721f83db0c83950550317edb227f2e258e02cf0c767c1a82596713a777a1ab3ae4860bd8b1db2b5492bbaa6857e9e6f3e0fe4b15ecc51f2fd6201cb4bd2e57d199cbbf22bf5860bdf5ff147519d94c52a28885349c1b31bdc51a3a566d82a7585ebbb6d6b1385b1b3888ed9bc73b4fcc7e717973b113afe34674a271f14ed0cad77da24f719e17401743f78049bf56b2702bc180c424065b510523a298afc10f617ebb07c5a6e4a70de15f05003932e891c962034b99fd931530d6509aebbf8a9c497bc6d3346e9b8a9c41999d88e3a103eda30c2b2dbcde19ec48e410d7f2503d1489799d9b207e6fc228fba4e21c2f115e72984b92d51afb8d2cb5351a3e5bd34bb2af0d256f34b9b6bae2e6dc3ec603043e06a0d0ba51002441089dec8d9d752277c9bd45128799cc93eff45a8d0cb58685d3c58ef83a9d9d78c1d4df72f235c9d1ff6fce7e585f3946b2d3d828316ec8eeec372e34c309b9f49183e9177503aa80e39e08997f9767c497e64ea630abb461fa4a2309b98a0b3604e631cf3cf8d9d6e262e71d6d6ffc45d9247f85f2cf9574646a6bad2baf2796938b4845d4bdd2fb19247972a3961717a0fba82ed6b4f49c96c78d10463b0cfdba494b5a2fcd9c5588d081ac5076040988e7c8af7cbbbb32c5d367e4d286c99dc752cc27aed1fbd7b13a6f0053cb86314d42181280d09e4505e3f7c5742aa524ddcc4b79d97b8ee36b7f11b49df472bad207b476c92473c8cfda30e2d8f9c01d9156a344fedb54ebfa35749bee50eac5f9c7ce0d6a1a63fcb9d35471481177175e3c1a28154617eda80d0c17cd8c0c5d3c6fda8c50dd768c460595ed324d9ad667bca42934c49ce3fc93572017ecde70a1d6b7518e5c782ebcb3dd5f544a1bedc135308af5bef12c6818fe19bcbfc57a6b19bd79335e0113cebf2afd3e8dd60556eab2c102de85461fa058ca21cc10daa21e63368e407f9a965ae9daf210e60bc62532862632685125818cdf6f39b69c4c34514e575e519d4c78d10552ff06c6291f957df18b374d790c7e539560d5bd60c99b29096a6af38de0a2394b92e75f3abd69ec0f464c438bf1c9f4a7e9015221c4ae3b795072ec5819b0a94e0f425b234d646a861a37ba57a1276358bb02e6e49b33639f4a743f59479bc3b0a50d05f042ca16803aec817a9285f57a168a51292f87f6ac9ccec1397afa3127144033582d929f7073f048d0a8ecc870664d6781fe22f9c96a59653925077455588bdb2974d0d30e1bbf76fad092e639460171b99ecf3f43bb7f599a8d7b6c28bbb9dcbcb76ea5f293dfd7cb8e926d38605acac15434d049b6f8f4f19c788197e7d4ad42f3d6bef8a19f555d31a34583acd838f46a67cadfe846050d041e59823b120be0c8e52913408038d70b0026eb1db72c16a9ea9a40c6ddda081f30794120efade4495726d09c432e9dcc66f0ccfbebe9f369b76c1fb9faab868e2c96b3d592f3551083414d31d077f53928523f1947ba4b72b40a3125ccea8c664745b19556c14c4a0b79da68e5b76362f436a1e6de08cc676b6ba18cc16027d228ce8a557eb2fa073f894367fbfe6131e248b78779557718b8a58a33043a03ea51bbdb2c77b7b1c720e8b3cd10d77386ef75b64da682d54aae91a9d2bd4f13409b922a07683f8b09d86a28b82db2246598adacd30fd1fa67f8d746af18a9a9559d63a83bec282ed74e54271cbb3f0a40e9d9ab189088498217b110433f6fd99956dcfaabae41e72b2487841216287913f39548ada082fd81d3182bf31126e37cd5e999c902b865305b5a138885c5ebb3e490309219b53b90a6444e97e3cf046353497f3933073cf06cdea78ebddf69be4d16ac1e5acc1648cab5e37888989c441139461e91ade553fd4596e2e8aa28b31fa3aa404a13f7c66ae41c68688f6749e952099bccb1064adee42e6bce309a931888f0b979c985a3f62bdf3ca4ab893b86699636c36896f4e67b52cf7fe0c908a1c43718e5f7a3acb00ca2031b06ab19ae41f19c939ae17a2e5e6b037662c4916759b57dcc9c09ed2faa18c0dd407e49ebb794cd49ca11b68d5b7fdacade3a3d994c0f688a7c53c4334f34dc91a81eec09514e30bb95b0d170a9b06ed055e147841ad8014fe1f8091a366f0e866365a2adaded9257404521ccfddc440b149a6b22a0e6ae240de60ec0a2c9d0105ad18168320df25c563e267480e8330f1d00bed528c3bb6f939bcacb30c149a9fb9a6fa47b4590577260b4fe3d7f5024e486eb087d5f222a2300fbbeb838b01cc4adee7a683e6374935e9b0009119a798ff691162af92623aa73096a710e534568a6d74e8f48b7afda9ec6b4a1eb7d124d22d3d3f8ca0fbec1981234101c51ac7dfe06e8d3ace623c8aa5ee32e2cb402032ffd56c98f206ab85daabaa52abd03e51bc5e8ef27201ae2d590061ec9e147784db197f742c7852b02b9c0eec44027b67d6530ff3601ee3ac23e8c50af5c078e871e0e0fba4e864f73cbfa18731841e039d997826c375e1907fa90f014ba86ec5cc08b6f6a98b5bd127fd09e2ec3d5ddc5d56b44cb99e8197675ac0478c2ee24a5302d50a1f245cbc78963f933cc07399e67cbeae297eb512a6369b000a6ea1dc73edf315f5d4013101782fcb4dba9b4522d31c2532f6a7f08474a49755719ded69fcf549373e7331008b4b6051f77f559872b4f3b2789c761940627d5ae5752f31d6d7c8f2f7157cda4a908b129d51c7d6649b3dacd723b3a1ab5b45eb51486ff511cc022e1a102a4dd4a85a9a9eeb9ef8036a22f68e571f977d06d5c6d23140b5e35058e218467f19d772897302c0028002495855627aa11e1298c033c4c5472403b28edd7e9543d1fef07d5759c623691ba117988886298db71c4ebf0ea6cb388def4d0181b315dab5fd2fddefa1b0fa427085bc9612ff8c647a1f35fcb0c396b08456c313efce626f4fbf931aa7a2d4f64bcba5d4474aba689fa823f98e5d49b3b23099c175d24e7f245ccb4719f0ff4af35d4aae84140294cd415d2a9780418662dc6e5b58eb442f5f94f642913999743448386b00c90a98779a1252d172ae94ed9ead8d7834e0696c9880a37db3f9b0b145ef1810729c504582ab87e7e803c4f5406f8757df3070ffe3e341bb4103b9c2137faedfa597596b95884e6f45864cf823b3fee1bc1a510903b9251ddea28eef84f21c3b9c2daa78decc082155e80ef6fa900b4271db6dada760770c204d6860d910ea2f246656a9e2be8fb9cd49aa9da78a4f284bb5621c14dd7b4c3210b749924ee80f7c2fb09db73e841e93b8b64ab7b0fd568ff62e154fdf64076cbc43514bb4a2c27a45f6c393e513a0ea6363a941a65faa424362dcbba5eccc7efec429e297b5731bc11783c5c1f029e93fb965119a7c058a6718ff19c4b88425d6d51a0bbfa4175f3b116097ff8f3da49d4492e29a108714d707c8da5104a3b396ded2ce4a314e941f58f30aff3e19f79d7015de921940b544963f63ccc984c07f7044a5bc2b1a2cb31b2753379c7bf2ef10805e0437e82f3033fa8d899301519dd9eeb8f0eb1c1f9007619740fcc167f8fd15d76ba90a5d118fec8423a4a6c3950587ce73d263fdf11bf77515544e68d6209907652667033a95f9aacd6c31ff1b81abc245aece039366466cacd848af6d3d2c8ae24afe2cbed87e155f8dd8e4335010b8222f1e81cf9622c707d6995a94df2c0cf6b9265a158a29ec568c85771cecc7ae92f0862137788f1f141a0bebc4adc082c5a2ba5e9f3e2708af14fd1bed781a8d928f26a3c71432cc9c41bb049419bb01fb39721b191542b378eacaf74234b50ec555cff7616b643540a80c38bd1cdf5e629f4a5fef0cf61a42760641798381ec845307fa5985171f7d65ccc64cccb1c43a039a34c11e271783348eb382a86816183fcd1916ddd03cab82d6c1ac78012ce2893aa5e8c36ae6344c5103218aedd30dd680ea8593d5754fdb08c37d46d02a78afe77b9564b2bccbf94199115763a993d494d6a4664019796da91dcbde9d5f0184a8edd475638b7837dd3d9ae584dc95eb9cf2d74445fd063c902da75fad31bba5751a13f5609d957a17ca9e5ea13462cf1866b83bdf15588862ea65c7b0565d5d5ecda9d9c8e1a7af1fb34800807474f710caeec9c53462ce436a7255782cbfcd114346a2ce8e05c45dc396562b66f97a378aab7a937102c888ab4b0f47551f63753f896d5faf968610ae1fab2bc0ddd759606e0e6f10bfa2250169abfada904e8355473792d3e696cba5c7cfea7ae32d847e4634eb6b1bcaa1be480d5a17c6b7540732bb97b6b7a8c1a717f4abb179d70a27b5b25a5428db0537b72f1d4d9778edc3f3dfcfb33ad7db5d4b067af52276cfda34506c406b487d17ecdfd4deb1cc36f2f03015cb0657a53221f6efca06b28d9652f50930b2cabba2d32479309c4ff0d13b7b615a5dd84dc12cfb073f7cd0552f22df226827dee443345a63b3c806fe8e27113af03582db93d21d0063302dbaedec0ab12a63d5a0717990f9a75feb17be8f08cf6860dcb7b0979a89046acba301dfdb980b3da42b051f4198102a9ccbc4318ac33d321c9e03bf833a3a616ca01727a48d5595b0548920875366fb7a095944f56b7bb6819d305ee53bfa7131dd07e72dbfd6e270a187e47858c544c87074ba560d4adbb898ab1bee0e3ab755839dc0483224ac678e3699a6d5e6c77458753801c64a66f9bff550a2709a67ae5dac08437e21721f22571e7e8af6f10b629f44b7319eed8acfee8b578eae036c9faeb36b7f2021a88bb2543fd8de72def1dddeb7490054ff4aee8f3886071fddc5ab6e40ecc01889e01dd963accd9a62b1af2cc36097e62f2ced30b3753d3f6439d933a351661e008099068964f6b84ac88446291230984e0784ec47da424366c5dbaeb9a91c88d30d8287966ff104babe97f8dc56a0ffeaf30aa7b6b92884be973cb89f0caff6bd26323fe868fdebbc140963954a0077f46db85f95f012f3283e7d6b49f66d8dedabb3cbb3b664199f7737dfcd9fb92bf6a3b928d6b98c52cc14648b38480fca120c724015f1af82bbfc969a54a2161c61afd57cd28a6fbbe38dcb398a634f57ce2a2b51886e925ce4f66af70eac617c7c71dac107e05c85f9d643b4662d82c0f9b6b50de0272b0d6772212844ef83c1d2dab55b02741c5aa07d292fe597ec250c4cc924b6b2061f308a6c8cb23dedff40b8441b8b4757d9abe99dee9fd221892ee841e0644ccad91f6f7ec7eb5d92448f08444cde9a7c1387f9d3eb4ec6c675a66d6d0f4cddf69266161754dac00482dc848c0159535d2964b8856ca5ac5754fe1971ba07e5ee3f1fdce6543276f8bff2e75ffd2515fc690b6fc2b41af49f2928c8db7578b8e6944e2a520ad072b0211495c2a091447069927411382e64515209d3498a8ce929a6793c97f1b5a2a8a5ae230c71f5a59d43aae783497bfcc75692871a7155277f303c6d380ba3c0829d24f946551abcad1b8c52e1c4dfda958db294ec01aa8e8854ca17a78f82e4c68a145f3ec567655651ddb8226f8243abd758c6f31d7c09c04088112f5744e979e6aa63f3c3c79e0496250e6661fc42b9405737260cd116d4edf3f1b07a00b014603126663a408e142b5b4fe76f9c640816782b779b6ab6181f808ec604c8e1cf648b0c0b69c5b9eb22ac6a28a3ee9a61763bb122aa5f281f6170cd61a75a1351ecfafec84c21400ffb20716f91406843fd1283819c3e9abdace12f5ce64aefaa74475732055fe9f4d5d61eec17e3a3e1370729d3a96b714d99dcef08f540ec47e8319e2bc38f50d58e35b316d7febda0ebedca603dbdf6d1c3012627a1996f23f207de86ed7c33e1114786c224fe5997cdba26c9513344c9010336b1873a8e0823b7b21a2c540d527bd8b7d375f2c30dfc9afd700f55f3651d5331fd527943be241ae7c315ec5699fd3374a806ea838de70fe3a252ff3227418253eb59dd0857a3201b948bf21c954e99dc7a09151c90066c85d836e150fdbc7e6f47d16a5a7a80ea58048dbb999592ba57fe3a52372354d9869c64976965fc7461c3a184ce756908dea5b599e592affb2b9c66d6aa54d1b2266e318db3395c4d57ff6b0d8b068e86d428a43954103c9941c78e7566edf2bec3a1e4155fe7dd641b32a44e4247d3dc1d3ac7953ed6c41a083fdf5768ff49da3036169011b7dd8cdab9dfdd99e140c9149693f72fdff7c1debfa069aff20d98330895d77f560d2c51bb139cd2ce6475b4eb0ef3ca274871aaf0fa64f3c3f43da1707250c6609ab9ed7ba75ead2c2f48f0d4d12005553e03ad5a83ee68be216446ca85419b7300b47c3c707a19fb2dfdad5ecbc319cb6538bf82e49fc08b573594bd67de296525ba80366b6a9591671e8ecc88086033d1b192721db65f920bf27a188f64631383a9150407bfcb6f2f5a6c2f1b98cdd1d5634b14b3a091260f57cefeec495e5cebcb1a0ac6ff57cf1428f4ca433d608bd170c19d73173092e721b9295f47c789fe3fbb1208c6fcdd622860a645f991f79bbceb218005e4aeb38ab8412f7d73af37a4e06afa8a625e6f2511035fadde02d29d691c1b2cc0f542658d91daf82bb0b4ecca94284c87056e655b9876e0fe85b5a64a97b7236902c40b6ab136cd79452e7acff53465a3b771e7baff0d4a9d6366e8cebcd9b22158064e4b20127e4663a36e1b478c2b8d5dae893dcd5b12b00ff9e18c6f98affe24fb64f5ed511f27556c2db5742cfb35233b72270e9079e62baea36ac1554f0684c9391c25897da5a974b34c0391041a91503e407b8468b105eca501c99d314093df8a8fc3878973f2418c87d2c4edcaae1907e70803f0e2a45e8cb25bbe656fe7f2319580e1e8ef9456039b0ee96b0c972a568856125033b530cb82823a526527a0b9834c0c1e312646afa39974577a3954b1a61b4273f1d81104aa30a1161b004b540ce8db157fd3a650e756e57139720bff8c67c8e826c1681bba34e0821c0280f5d0028b62e36703212e302b52a5793ac2025ed40cdf7990c7725238b0498741a8158cce71bebf46b563ad4214c1ff1a69945bda654e3845ff2db9d8796789770fbe8362fe44260a16e829816a31dcfc1988d8fb6dc18b288f5ddaec5de5e67c9795ef4761712708f7a6210eb20ca2b36de0dd274a7bd02013955f3731a047af579b2a2118c2d05e47a877cc5574bc1eb846b957a429f5a7ecab1b75dd48c0e8a2ad97c654967dd2e5090cc67e310afee3a0c703360c18ff3aa31b6c7f86e1e30a0376c0d36e2fcc487c54c170ba78efd561d72ab0297fa3310c9c2b3892699c15a9308858e31be1f202f18d42b4c7fcf3e04fc7c3269f5c622f7d35337fde036930b9830a2fe9f5d3fc8473b26d21b86c2abd8e6e1c1c8373a0d1f373637bd1e266794bea8e9ff9fd2b69bd8bdea7114cda5946d44dcda227e92d624f24753f80287f075f20fdf8035b4c84ea16fcc677ac5cec0fe002c9c26c10d43a5773abf922ea17149f4cbd5726d840ba1dd4532acccf67d45c4e7dfd3d6214450e2ff3f5fb76aac26626c2ada6da4cc4fc4a134c1b0b0f866f8a47ff1ffe235b0b5f90d86eacd5c3aa391e74854d6880d6bd1fea4cf4bad7c416f428c8c7ce3eb934d49ec76081361712558d7ab20fb42826120aa7f062f9e8096ec9404e82a9c712dc272861f95e15230ec665be21feb85ccf85501e66eaedf1723af35953599a58b10cf6cdaf6bafdc0da98a5edcab0d962393444ad25aa64b942b7e4d326a18925aaf54098acfdfc017cd9e034257d5c86b9a68013b9d5107d49d0f8fd02d19792033a40182e622d484833e39e5255ab088f023b0b715e80d27efb309d12d332dc4d767a8ff7ab04e8c621ea9c7ead20e68e563c259ee306655a7b28aa335280bcdde20601fcee02a765ced5a0ca7c09aa5fb48cf03e5ba446fc32922d9088e0049b44f1ee2ef4fd1c39bbe592558699fb22004445b54b0c4067c71649e92fcaf0be3c972c36f5eb0aa5d6c7acb0f9217ea642a7d851eee5d8cbeda3e1d776a7d4e59ed530ae98347d1ef19754c30732b4d5d20c294493148edc99d01a82e9cd865b610d6dcd1bb400c709d63f43f3cb5f813cc321d868c5aba7c57394b6b81500779e5a06b86cbe9c92be4dc3bc1bc00248b4fcfa4bbaacb25372e29c5df4f9e7919e9b0aeff952ea9685a33022c5ac5b4df0cccd6ce5cd6ba0d188d3beb070c54e1f518cef3a5a17362a238353b8508a71847ceac9918cd53bbbf6f0f905fa649027b9db37c54d124e7b5a0510dc49707f218320810c517c0de05ff3dda2fd02dddab5ae1ab5b5837bbf711405f7363a243e9c88e205d8969e120ede3da46fc478077ca2f85a407983a9a4524e0e63e8918e4f0cf5b0a8f99b5dd69502ebd450401ec52c599eebf700b29b508c455c0515524ed39781982e58b3420f88178841df6fc5e30120ccfa9d53f0ab746c87ee8e23f9db60089c033eafa9b18aa29cd046f49007be08d1c6cd6e45f06e0fb57e2f6031ab4e7448656ad484fe21c39fc1bdef8e1a0c6588286d6b085366b779dcdf9a56fc1fec1143178a65f97a19f1fe2d5a890053a6016d566119cdead653bae8bdedeb2228931179a943d0a4f2d5d53973e7a9b8f3444e4ad982bd511592f135e15c17219bb8719009b8afa964700804ef0815fb3feca40a25833859476d0166e06128afc7d197ecf191213da8a279050465c2f89f807cb2008eb0fdda066f7db7fb281947935f4f283c37a2735361c75e909a4ea628c34b37bace0bf7ad0b3d692a2722d47085c95c2118355f66deae2480e21e24088ccb9519764586a21e2b0c410729029fe22fead965efd0b4023d521b0db45c69d2cca8b62b3720b541d4fec94670f6a3ced07e95e814995044b7d16abd672727ad42abc58833090f81dd21790238ce3b04130f7f1c2e5577fbb3004e76327ad32fac5a8161cdd1081a8679d384f654ff229a793ed1c30d7d48ddaa2ad6a976c79f05ca1212dcc0d1b38c36252922c00b835b5a07ca4095e841e846c9310a80e88fc0d6556238c933e739cf6fc542ae3ee9bba22e2c5a8bb45a5110be28d3182215b3541c6ca8b0a9d8c9392c5060732ca7f1ff3936e72342e350ca57e08f73d39c4d5ee9382b7d2e10967377d45f751920e0297952f8a1991b24307c9285d3a8ffb9b9aa66ed5328c902ae899c7873159a3fef26593ef423e2f4ba2295148f7f026b57defd8925b1430362ebb0a2b8e15a6e6f3c1f58a1855073f0aaca6d932825f9d9ebdaf84987323fe01bc575f2372c0d62a3c800c47d5cb4a8de43a186bc072a5352424bb726295405e4b81f4318d924b7a7bef4031afc3de7c995d63f7c1c800baf888350da054fa737652a48ae5fe52d76579b5101ee06abdbd0c0d57ccff9bcc99a4de982deff14a66240540c8a651a4f89f1c94a241d231ef2b381d1de1a723ef13358b01fa8dbd12e7f028090b79901f8e524335d6d9517c7f763be700f29adee7e4e346b214d8da188524335ffc406b05c9c56670b71770465130118625571af2b6eecd315df8dc240bbd46a46d88f9395af24a830e0475389ecfb93902c455daf309b9af17cfaf0ee97a853d72f307c233c028b6e99d8511fda60f9a5be412efe0837d51856ebc73b365fbd7bebe5561d1461e93453421e630674fbe9402c0c7a9f0827274e06cdbaec7e53aadc9046fa53e04f266dbcad0cd9b1058811f7ce5cdbaada31358c7bf9e7d5e657812972cebd6faabb7dc1a3b9289393a7e8359f53805e793115ef480e98b82dc28f05ea5a946c2e4248e738f66e780a21c05a5e05d59f6849a159499057a5d143789c1cf189fd821839951824f776970fb186c479846ff10c3cff8e9981461282d171ad939c8d6261e790649092332509d9a8ea52d6040b3cc1081d48da898d2b48a6b32de0adeb98dbd32c12f056cb589d8cb3ce8a9f9b1ecafdd9677ad71e4c65ac95bf5efdd7837ad6fef3f5b3a5115bfdc60f3cb5cf3b50e68c7869e72f15cad371ad2bea3d22193e7a54b805d121de7405ab792c73d813fb0724fd859643caed6679431df76d8080806c3e7a210b77d5408791451445f0978918bb3e8cf2cb07d56506246b118d68e13292442162a8d2ac745f7c554f641d15c7a944b1d739577f23d56687f1e9d4edcd0c6c43fc2d95003bff065b0131f9b088ffe0bf911c8ae73dfa098b282ab7d0c295092436114382bff944fd7c49c8318d07ebfeb1db22993ca7954fdcea6d150ceea1f11e34c83de236e2586174dead49ed442d41de477af056de0f75ba5a31492eda4558869c2ebcc12f0c9698bf330e6f4db5608cdc79eba518d1fc701cededd67402a3b9a9afe0af2d5ef42e7c860c720b6b924ee834f1a77e1f644fec8bc86a1f517868b04522e45b2cefad837f343f1effc0f69d086ec0ea130de262fa36c7622c3b92fb22d583d09d1464dbaf9d33c709f06b1ae993dccbff89225f0689fc85162526380e1976adb24d54dbf421751e064741f9c51752644b8e9d108adae2f9217d4e5056ec0dd16d1dfd19f55413b7518fcebe545496613117f2f6bd205e0690252000bb9030f711579e99804daf11e1b8bb489e40b93495ee4d9ef40ed389256660b749b3c960ab64b76c400fdf54ded89895e6a59f1e1632597937e6aa74bd43dff852e33dd689028f4abaf738d9a25b704a824ae67bf6b4e59eca4e4e012e81fffcf6ae68cff7d7eeec8a2c061015ecc618c12508167316dae6fd6a878952248c6789e81113fc1f1123811ac1e382062e2a063b71c09883aff301f12d14cf9bb49e19776b2d38c0e471f41ec9227617cbf9dfe8d010647eb115738ed817679e65be9b7b663cc8debf8f5b89b2657ba0bdb688f1f4fb51880382d9c6c758957939499320365cc5e42040b0551f0a5b76fc09a109855653c9d752e2be293dd914d2cfd015d2d00922f4285895b2d47b19f6b420d96bb791365fdab4de47bdbaca51265065988b6dcd3cb6cfcb24cbe1e406470dd502e109b77032d75b5ffd857ef09fba768dc81418ccaad4113ee448f04a7a5fd8a0678e1d09f6aac6ea299e4200cd813d0d3216301ac65ef085dfbcb24ec9346d7a7e1d2d9b6156b9e435758a12af2065c23abb70458fac0ff0511dfbd4fda137cd482abc9e3028ed509bc582a1c20eb081e34699c16529c807e42558ee312ac3c481bdc07e188f71dd08fb0969c1123aa4e0ccefb7116407788f79a5f74cb3b6f5da7dc8c50eacc471be4b9ff89a9498c393e15228c9361bfcb973cdbfbbd22297ee9040229b18a856047fe9c7b8126bc9a86d07a8baf299a098e5159c555c004cb33e8afcaa3047889142f5a42c3a103cd36601a7570e553b16446e5ac37296d40934693490042f522b8f61b0c289ed1b299db1bfbc42107823958ac9ace2c0043445857a29f04f675686a944018f728e9f14c284581b336a362990b79b0638f412681b4346e2bd2dab337be23f7c4738deefd4b5501216d9a96d7b3c321e277dff026e5b52487cb26b9671aed039da997f8ed78356082431a09bc2804581dda7cb60d351484b0cd84e796446e0e9e010bcf8cb9ced702f2fa14013bdaaf9439ee146a3e944cdebf6efca03a940125a33afade76c72576641ff727384d94ee2d0d290f938de95fe1853ba8e721460373011e9283d20022dc5bfda95fed06c24e11caf8358ee295a6072d5178bddd9184df5d08be69ac8f466f7053ca4c15fcfda22eaf48c3677975e38a40adf604c4c74a1495ee580c6e8c20df87ae375da79b5008afd5f4702cf79508c7e74578037dac56b3a0910e8ef1b0b18f901001bf370a98df5d340de47ff386e8f763762e162d45e12370cb8d216fb6a45540b613aa3691723bb58ff5f9fe2c390994312b22495c96f58e000c6ef278b90780541546d4b8f00a69ff249e3ae76d6c9e31c4bafb36a420313476946e6c486dc7e0896072852ace7417d972d3e66448d7e1bd7b876f048108ebb6bb469591934e2f7b3aae4a7c1d12b24ae7ed195a3811415461b9492204cecb300a1ce2bf747dfc4852742a937a8c66179136857074505da837928fc9a112b0cc9e14e15cbae251f43a379220aabee8c94b8a4805d531f911c62d72494991d2092105fd40876ad9bbd1f00ca10c10838f80fd360e9e00a007985428f95f73de6bf5393880793c150cf779166f333893d1c9910d16173ca6c81a8cb749bdfb1bb2b58441502132fbb4e6b63fdc899fb061566ad01f46ab4b1c3864a2922600f952eb3dde0532f5e5964d9d0cb2165ffddc8ee5565f331fa21311ef38cb53c976bc96932bf27eb06ea45401b6c76bf916f48d2973ed03d99961f880b611a6daee32a189f4bb649447c96db4591313a671b9078456ce09e16fd24f2ff900b80e4a98628e20269a6509f8cf162ae3a69c378c2c4d435f107abf289bb48f4fddd40b50e1788350b7650da7100515083fb3c3674ac57406f8af7223ab7aafd4a002f09f78ab8459eaff444716b740f651ea521ebe727994e2f637392e570f1d0bb490d301bc585bd59c0e0e4a4e56b128d43f00482a5bfb5aa6518e65b6e67c48aceac8bff639437c308c6af4a8df49a7b7eb3ef5e6af39225aea66e18419f388680309952ba57308d9bc68163ca1e67a0a48bb0c19e92d1e60f0a41d72370f3d3ce75051265171b2e446fcd0723ad503c0d0a268b6a6cfd19c619197f02d1f8fd5f9ab8c33a067bacc85be3723313738ae7d48d61b1f9d4fb07aaba025f3c2df767a865dffb06a06fb5e6779a2058d2a4c862a1d305ddeae6821482d7772ace71dbcd7e79d98587a1949448f3af344c297d6490ca16456f15c54d8e6e20fa9dda445b0a89693478e985145415bc3ed50309cd6d9960d9d8eb3cc41242a8869e1fcc28ad1446d3364b0977d4419bd0db91d08a0a64434a814dda40ff4bc3362f6a3df3f63f4b755bb49e314f70eec88ee367d569771a87186da1b822dfa98d5c9158e1780b2dbfa31f6f9678580477187b9a50014e732e42ed8af9d2a9f56816522e5074a70bf756a65fd2bade5fe1e5b3b2fb00fb9ca21b9fa332d98e3bcabb61a479407cfc3216397519cf89dfa131b14eb93797c5d92fc6e468022752c49d295e64b61a6641441b937f26d7757649ea4ca40568524e7df0357ad1110972cc1d9c91c45e050b16df5eb96fe257c745481a9d41eb3765d55f4d743a96967ac1f37ecf2efe28acc8473084bcb0870aa6ab35b6b6e765dd598e5bf6b54bbfd05bddc356023e1e8a9c25748c3d2c0f317eb257da06cf85b97cfd94d31153920fcc6f94fdeba5c50c9c0f10a864fb27dec89e01706cd1f054b128e67acb4a0a56dd10b8950eb7e0331515f244ee97782f61b86fb7131ca80fa677823f3e3bbcd90261b8e823fa38ab55b24b102fd82eb5e1d7583ac9e605c3d34cce31a5bc7e0e35bca1b5042a0e2c0c329adb3a5737ffc7938e842823a3f51ccdd053901b427ff518060516abda069b5fa1cb7f64846cfb68fae518489163941227f8483c8345047b407671f9bee693a4090887f209b47ffe51502ceeda15c839743d992d57f03dd7a72242bca1cbfc7a996b791d362aaa2041da8233ba55c65ac6e545ade0da444a57f559ac6c7187690fc47933ddfe231a1d374578ef70f68c6b965be70a23ba3d71e2874afe8736da33968eef3986167f989f617268ec967fedecdbaa3347f0c9de875ec3bad5bde09ffeb516983ae8a2dfa14dce5c3735b5b83501d1a9266e6664fd19fbf3687ec9abfb76f27ede0c3ad3f54bbf6e023196c544f7da8775afe9069e382bc9e87ae0ad21f93ece0c6de2fcf412534984e383d4c7467332cec496b57fc62e5e694a01577784658287fae88903ac88c4294ddd1f1e1a5216625626c4e2664558defd02a8a3ab96352ceadd8860af18e923655229d852b2d767ffeb4e85e1ea5b746d5ff96279c14cf30d552e3371aa751946e7d3a97cf18a82f8f465b3acf844a2abceee6c2afdd8c287c26e12f781129b30f93ceac1f95e13444311aaa4625597e5bd35c01ce04bf924195ab40b97cb2bc0dafd2bb88282fdda3e595ee4efffd69039de1e3617379853e6de1836e51d0b3cc7078995b61eeb9fbde9ee154ec6a928f004343c3a0a55c80a29dd0876b110c2cbc2c867816475dfc28a2ae0fcf661a314131e45fe14b894cdad1f8c534cb434e57d23ef345465ba85f2a60f669c62cec8e48eab6f05abe3f2d5c0c4a0bf9b8c189c800140312971cb8d04fa0c4a125847efef3ec7c5ebec0552a6c030d49c5a4b559b97ea8d37246a89f362f7fbfb8c62db1a920f23be9bfc9d0c05509e71c995ceb33873b7743242227c3923b7c721560f5f386534f97934e7db7608434a7977b3cf1f448816bc5a0b0b834922c533cfd1f37fd88f8e4c56d60c9fcd7e42823bf0deafea4793c2b5613d62406797571ab04a7af92f4cdef4fede8243fe6cc13081d7b7e36ab9aa54976bd6f40a67e5729cf200b4ed05d87fb6ac28f722757c46069a5522af0a4eeff50a51bae5e408ec1ebf7efe0c8c7c1c528d53950a6b193419159be22c14bc23f272aa717b462e68c5ce415ff3cf239d80829eabf3a8d3fc1c0125bf920ebafb16bd46d0bee62ac9db1dc95c4674f3688dfe696dac453d4905a384b38401f43d0a83f7c25be9f05a2be7ca9ce76bdf7a6ccd0c6fc09755bc7d74768b0fdd9f9d34ab4a7373d15a69b92b8df1a7826d35c2a6fc298c170b2a7517453d3ed940a7cd55529288b1b7ee48027177cb8175d263a2094282d47374ce0de529cbb3abac415745de8065eebd742ccc9033317a035d5ca08cc203ac2b4b66b33191ba635bc9fac82880ee662c0ea405197728eeef0dc870eb6b72d96d7880284dbcb3c75c100caeabfe6533512229677edd4938405b00d7e0b4783ae91371b35deefcf90b40a4fc7c0d69c23909b8fd7ece0a5eec3d869c77235039b8b0c8dbf72b77538bcee035730aff02cf95bfa8af73136465e99dbdaa09ec26a8b3da5461e98273aa88abd7e1c93ec01f1dacce006aa242468c22c8ff7110533710e7349ad57e9a34e36deaf0d5812c8d5a235312d1be12655bc66afedb7e80ec0223427520907a7aadb9d9224c5ecc62eef0d5a1fc03b5a855a17234ecfd0bca9ab3e4f838f60ea606c266bf78b87c557df883282d0627fa3172fcf73b055f1dfbdd6c396f8123a3edd4c8a2e0ce18a9d97aca967c7453f543dd0682a30f0c744ca129d488790dc3268f68b4f850d61c91238b7d9063c42137e39ebfb8b90285e8f1b105c415be12470b1f1c398d7073d6a9d35aa4b376233b3b99b9828863b178082506c51c4d61e614f877355b4ea781bcb56a0871ad86117602685dbf4d366a7dcecc1337cf234e8192abd0d5986986363063d2b8efc3c45ad4ce7b10dad4c1ddb7766c8c5497395694ecaf5fbfd8432f907d12a3fecf408742e672b785824a66e8284293d77f63459a73b6e311a7f4109474e200e7c0b9ce1e1986ade4f96ec32847d090483f514ca78faec62722ca8b769fd368808e68de9c0eccf176842918791b9acaab57e1aee25bddcc9e4395af6df6e06c823d2d533fd8b8e64316dd18a8b4525aeaa3299f5d6b4e6e15b9eea88925189355e9ce3b1e4cb43452daf6ed10ff57710404c65f5929c2cd0109cb67ac03cdb4af5b35bdb753e955d84188ece04fb66abfb17cfeb12ea010f65f629d4ed920bb84935e8b698f8e694a47dfd118a12186a8c102ac83df443d6677ab168be9d44d7ae0930d8aceaf9d2c3567288fe47f157cd281757a1120573aad18d131c3ec9b2c81360954deb948a8c4c6ed5c123a29a1b33bd8e1bb3481c0c53f6c3b5bbf5b27f3b3444a1e529dbdbc0216a2fae974f8cd92ed8121baf9dffcd97076fd0d7fb3bbe7c85273ad7902416de9692aba8fcdcc9d8f5f735a6875c5d09a5ca60c27dce4a445422641f007073e68231366fa0904eea38c7d31b39c6cfd676815e4fcd00a99dc5b59b9a0bdc180cbec587164c4b62bf83bcc8c73b6fbe8f8f83a975a21a48486266099e535f0e2dfaa46e99fd3d198dc590c0f6cf771ef4db2be8df793a2a0b43b0c9e6ae44320e2a32a7290bdac16d5951b80f3a7d5a7114c30aac07b40bb4b8ef8a871289b926083820d1f9fed40b6329bd7ffec8e49c98d8941e44fbec472be99482ee82debcd5a1c35a9e7cb51654116fbad9d543b9ff0167bc12aabdbfd984b5843d672e8d673cb2b2c6836c7c9630a8935316028307e027f461b57f13c689b56bab29ba0531124fbb01bffe9d67277693489961c039db9a89b41ff81811fbdf4cbcddda12350f42249100ecaa2be888356d7ff466428ed95e79a1fc1712daabd925fc9bab4e7a44e77c339316295b5bde09d4bf90eeaec8b4fcdbfd0879d4828bf9d38972cd84c099e90174f47a8a7f5b06a72505ddcc72c9d830e9909a2adc3b06da4a72cf581bab242208b96baf1dd2e01eba7cf9c74996f13ba083df5b23d1f8c1357d44e65905a3bda841f3a1c4edd23454bd6f075d1b6e82c35def27db3cb948d334475d67d8fbabb44292d4d009ced1b9f39278db1e83deaad0a81d8568a2b6b4f47e9f65885625f48f734446c30999c8497e00299d5f0dd346d3f21c4f663f9269933b73a4c74809afb53a78614fef81f02b24e8164896d0c8fd8ed90c2bc6063102f723255a8c59442698f284296a3f20b453149855e09aae457bfe7053da8d560ffb656b211b125a7f5adb73c72ea1154970501c56ce1b03e225b4a87d45897845edc52ca0c0fa3bea2dfa7dbb2bd5ed739fd6c627959086ef0d5c10108d9a685f7554f6311e0e58b97e5f50524ea8076c13db35c989aaffc5ad4782b06e89f8efcb94da35e8b15f70543ab234bcba5678922340c853745a063f2cce82130e3d67fb11f205c8f644121fc0e35858ae9f3e6992b06229604e1ff272fe06be1f4a86bb92eb4e41664b0e93da1064d79c8f74f8b55a0a15a77fbf6080fc5fb41f0abf015a789df4a32f302d6d4216cf3ac30b138cd563cddc92fddb52f03ccbfae825a0139246eb001f596a69533fad0f9125895879fd71c3ab4f6ebe6235e2bc835689e50d1fdccd10a723b7b5c8d44d780278b1c5dc136e24ae63f2a487abf70f3b129f41f0c8fa3d029bc076f659220e97197f513d9cdff4c02207d7fd94e92f61e5abcc2ec7306b44ff1888510178f0a362b535d2a6420e75c592a0fb9d4293d015015a6d6e7a562e3a34a8eb440c29b8a4912bfe5b4268aa7996b48c6d389fabd7b336b18250f7ebe767e5365bd1a81ef2b7224a41c0ec4eaa3070a5eace050dd03b3cce8921b4fc92b27cef3c0689740729aa98f0b935e9601b9d3b00a2d37aac3499d878417d92f1efc70b42db31ec5d3b564da7c2ab5700302f1c66fb2f4f64066f2ab5e6dd7d350ffb5a559fb2a89c9a48deb9957a376bbe1b25bd5abc63add036bd1c98e07809d3699db5bff2552911e3898d6c917823a45e6b54d03c541506184b245458a98c8887c9ebb8d45d5f9043445844f5f5b64abb2c918464299fc829d429aca248234d477de06600669ad2ec5449e0ee2b886a581e8bb5660cbe45c3fa615e96805c36a57b4e807fc08ec2b9421b9f9a0694148936dd71cc998c63680cf1a020688c24ef6a114df6971dc2d14f6a047761b3b1c89e2b0ee909abaab3c9650bf7b181773c4a89e10ae2df9b2848eed4cadd53248450f0f920973707d4e5cbec401d06bc10044306bc995a11271d233ba64ea98bfe8a1d64c3b39f5fe607edb0d8d57457238604d7af6d58275fba03a57d5585f02388d68c0bc00d55ede4841f240db8a6381a2455d3c1be9beac1d9de1237258392919444293f438222492a37ca509053ce9a50329da5d7ecdc02df1b4463dc006134db1397a8d2e43a0781e73a3940fb3ae3df9a848aaa55d83d58c080643bb4ec275d876b83a38c127de2a0e663c9753ccb1f28c178e969880d9f324fca8a7a874f67f4e6a3dc0ab815f927e2cd4c358e597ab5a32048cd297d5e49698edb9d48003e5756fd85e9825e5122a1618078f1020eb1473d5fd26e981ae878f2ce3c4b3dc6530543d93ad2b740d79582e68e82f05c9304442f9ad273ae2823c6ccca4c216ecc7872c288dbc8ed7653b9b7cce4cc748f4cdf281575cecb02fe492d6ee5e2c5ce64b6f8831a11274f1fdf3513f167bf49ac3d10d0698aa343226d657b760bd0e2111923de12209d60965434e8cc5a4350bb6caef4c575614363b05cda9c010b046a600550bcdf47a3ac51f5dc8f8aa23e19f3405a1e4ee7f0937b6794f97d9b45ce8b5883ab03976d41d093ec4a3829c518a58ecead0476e3d38536e50aa7d16e21c17539f6acfd37845d79821ef1db9e2e0e474d3e61e964a53a5fc787f0a9f32071d54267db6c3ee2cac2914610ef1acf368d0b1b395ab4e59c58e8546577f0a99e0382b5ea875e1800f4240f5d88c0574ef01ed821d9def06231bbe869865859e9926c9b655790503ef4101fe8ed60bb56fead05945b2ffa996448d2a397d9a9d850e16f3c5fbe8fe608ab18121127bf09126c28fd4c323d5c1cacfdca158140ddcc828f9d2fe25b2456ff342a28ee604ce56975af5eadf2e7d757337f9cba45f1dcca4168afcd8da79db66dabd99d84a610c15116afdf27faa4b71d6a99c07d7303613d302ebf203d2a82a52d8b287df283dd0a8c2929ea9e5659329536185dde3dffd76cb1cae1ff8b743c9e896fc76146dff8d359fc98b40d11c9d7bf122fa6b1da244a2ecefe55ce86c5a3ede0c420b356515b46a07e1db0faeceb5d25a5e90ed1e3b88f911a153c4dbbacba283fbd8579cbbff74a2f5c5606baa20308232f666a5c82ff89092910dc6a9cb21aec44e0866f48e060b8ce981b65b82a119644b9c7e1f4d31f1f2d259e0d031695bbfb2192349f72f5206c025bc67fe9b7198f8b72f5b635fec03045f099b09cee94c570268d18773069fca6007c71a1d340a5a9c46a981ff1b58e0cdcdf9cfe6003973e4a34d6446e94d3efbff7213de9557d7b56c8151d1b36ce68a30792e0a2b360248a817dbde99de277286f05e4fe7f53d1fc721588268b8edf1a75af9dc943e5f820c4a1e6c1373c02f7d7eb9886a7e1f9721cdd4e6452b94ea5bdbfce786581b95f5b39d15b674e25404baa24e8e5d0f1cacb3fe40ae3bc68a594484e09a1e8be8d3fa8a691f7e963b5baa3fa3fe47ba87c8c77545075764611437cd607e2caecd9bf2fb0b1ad41035e3e6907adeafd5c524ed1ab1a10b15f838dc519a219c7f08b8bcdb4ed7ac0f19e34e9637fd46308194c9d0cea777dc2010227081b9553736dafc63a194b3fb290977497994a872495d7ae8cfdc53f67e1d055e13c2daae45bcc0c6ae42d016533ba873fde324ccf49bd68de5ab9562e42d84705aaaf23a8d404a96c08666251cf31daa6d9500f7cb71650077dca16dced731652caa44a61e617c5cfbf8e8009dcbaa494e2a1a9981de70697423b94420fd585f1e9cb654961d5af327692dba2d80a73cbdf3d85d4b6be7baf3f401cc42763eaca615b4619a646b71113eae424c9114cd7ed6f8b9524df4467a126699d504d44651fe4191b774d6a16a2508dbf1af424ec808476a69d4fd54aa2ca0c9bea470087ff946c89d1208551de77fd8f8fa7cf695f0c6dd11bf16cde1df1c56d811149f8e20f3d2424ea9bb057e96ee12ad71763309a9d1247e27f9e23c204bbe3a201c70d94b9c7be321c49a32a411dea2cfa7d98680ed4367313b6ed02f70ee6786f8960af94f298828b347552b98068cc7bcad8453e9973e41cac4c6904e1b76b52e73b042075aa4cc98f515c8f2a1be61b5d96c22c7617016aed23180b31824ff4e7b919f1aadbf0efa716ad5c6edab3dbcb6140772426462ad262bda8c6d08b5dc8310c77c2f13d4f8e9416920d5fd3eb87d808028297b6a10a6f43fc2a3eabb492e61228f64bfdbf3ddb238737e6b4143c611239a9efb6772647a32bd9902c14c1925c2e77493e28d7d5b39091e0799058af3661e12db186f7c7f3b39976bc3a002d1f3f937bd4bbbc920b4665b6471601fb5110a4417570b2a38aa5929701d987bc668e3841e99ab7888974c45d9470bae5206566ca3710f53784046e751a0a553a71c8191039a25549be1b067f2a124b8f1c0bb0b75c9d06dda940cb6616fc8132dc16ebfe85fe3b4126e50f2e65683a276f5ce35dcbcfb58ece89c952a48602e301285c53adb114d76221a9df83adee98197a1eef382c16a4eb5cce11a9153b494808bffbd15e344380a200a8e03541770b33b145457cd659a9d895c850fd5d70ac32305dba2cf5bf37035555342edaf4795c061430be74dc9409b64e71d4e24c7c1d1518b944928c5a336348fce17bb705726d9dac4bbf9ee0632ae7fe66ad748e45fdf509565bc374398cef73ce80db68444e45ad20064c4de742422d4c1a37cb305dc8743997f8ab0d6de998f6c21e54534a27c1961fb04a358624cd441981ab084edec53a92ba407c1120d415db6f0cfadbae57861d9c22bf20812567fc55d6a9067f0d66780fd818e53b77bcc8741d4b22e699947e58c44eb69d65bc3976dc95cac6408ef2a91098f2fcff086c94a6942aaf85bbe6569c858dfb14d43618cb15f11e0aedec10ee6517687f9419af8a0e2863d6348498cb6941e99bca3e6d9493dd00808641a2e07d4fb940f0073c856aa828006d1a68127b8fbcf3c626ff710b4a57c8e302d70b0e3bac727dc660c0455abfebddef9532cf4fec8f40912aff4ea3a10f43fd41a1aaeea7c16b98dd3b1d4027604ec02ca0d19814b28047b5c878b3e91f9cbb5f3b0df0a8ee9231a945c6ecf4e76d9ce1fd5018d3bc08645daf329fd1344b05c893fafa80af306844887f890468b8ad8c72e8a90b31abb95fcb6643c94470370880896be49932b720ebf2e14e0b9ed42d9a7aa9f395160ce70e69f309c175c10b21ecff06e37952ebbc64bbe53349afae58ce9ca58b41812274b0c9037d1b6944fb8cf8665df97d285838aadc5c02d2b9cbb60b90b5419d7ccfa6999871386ec17089c03109ba1f3d18a61a7f94a0db11e6d578c039d8608c2773a4570767190b350fc19d7a2d68379cb0f72e9ec55163c47fa4e2ef309f551c3ded31e6af1ad245c3e41f7b0172cd12385b3d18b2e0758be896eca6bc592dd5dc8e70cdd5985b2ed3c40038ce31d49eccbf94b1621b99133d66fe4b43fb6f8c21cccb966e28cf7c4be4d0d4b2928579c4824ce6dd8b39673ac40f57027977d64808a16034f36d866fa2d991b8190404a0044b37dda88a56176dc6a31997c9dd986a2b59854485ead4dd246532ba983dba1102aef99dc54008b06781e86e27ad8cb351eaf120e2c4375e9031d09e23d4d209dcc2c2ceb65a4407aa968d08dd439aa9d4c89b396214164bb14ee3372cab5b878170ca824c35c94c5be0c8d53a6cde9be41bf03020108b2df8c4e37881c891f94a3cf32ab16ae31fcef95cf44345599aa23e6d34b0c7d8e12beaf956bab21da4dee43321f697587b0cfddf48ae91c0e32811ea019044e37d4524a17e31c6f81ce5df005e549464c445ae75a9127c98bead3388ea3a299bc9476c6bfc546712473cdbd7069a18b7a6697704dee36e4fd561e05a95a6f623d0698121e16952faf5776a684f58321d1190fef754dc9e8590c6713ffe8323885b0b8139a1cf16619b59f90320fbf7729e5f07d684c957f39527cef07f2266c4df0ab2b1bc441fd1478793781a42c471bce9980c7e55e16cbcad5fcd9e88ad9c89e3229179e45a4ec2010bf381dca521a750040d048373d4c17ee7229e026a479be3d19ee22754dca8d34ae18386858c065fe8c4f5e2e00899a25a816e764fd470ba248082d963559b06624a5f57e597fc85c9f8e6f9476a209af628830c7844507df06a4afd2273303d3de12d9a6e665af3d1e33b7f6551aa863c47b505f01329fc9d88ec6074d2d125a9b03f22322b9649952d4d2923ebb937eef85145dc13e9c6aefdd5c53b4e0e4b982764ad346cb719899980761adfb5f7769d380f1517a77e3a4c13461081d22a6e62cf4f6f6b1bba799b3981dd727491874132c56fc59f456c9f532e3527fb724a33a5464692b0d1d53e1f1ba080478caa59fbf5b51d10b229c57c40c9caa8cb1713d7afcce0945170a08fd2c0f9ce8f533b86b1b73fc9780a85f8177daf95df16905cf27720b0c9309d7fa887d018245588d40e7ff633d9c751f56a27884fe85f91f2a29022df5508e1ba3fcd172977cc17bf65de7b85414c2f59de968c08e620e90c52206612e2d8e87743526e1840a817ff1f15d730bc5a06b3a02a2f331c637e02674a87cfab4c5749626e9d2f11748beba43814093022b5aa2d4908bebcef395695c5f264ffdbceb1381616155fa21a4a7dd665905227efb309bd95939c2e3f2cc928233db9a6f606a26a70ae86bed54b65b1f1c9056b8bacf6ae716b134de10134c370a0cc11c37cfcbceb30331f4fae39a5584948481f331d37ff24ae839e8e6320e847c4053e1aba8fb26f8432528bd6533d0e20041328ff75370d803c6e7e6db3396ae0fdbd874ffb0a45b29ee8355a6faf4c6037d0358ce5dfebe77ba1a5102218e0c35800aa2c444add326c3eca04eac3fafa16b33a54b952c444c38780442c39d430dde23580d525da33764e3a3a34e09ab919472017b15eee428a1b953cf2cb49cb613471f7852927e70bd1806e3584a8c45cfc79dc73092b334d285185209f582a4c806baa0b0217a107560842bc189550077d3e584fa19219c84ad3e3109afc735912ac6377455d2297c5975f792e3a7f9cae98e10cea5e11f6e93f4867ae7b4e30cb89b22b9b6ae68007889eb9a4dff3ac83b50e0c174a816bc587240e0c21528be99af7a4e39f673046226cc2a0e1b90b17deaa70a6bc0125e9e7013d7e1437484cf217b31c70ce6cb31a3a68537b45bb48ae56a5061c3bb9c4d0552de42625310a91801a56a5110c2907d2dbd70a4591037492e32f45a33e435210ea43ac23b97187812049421dbba24cd4aec8ceaedbf9c0ccb663d18d496331a888f440aa5f4e430202331078019f7fdd0874ba904ed3490320e9aa5fe8097a6b46ac9963ace51d970a2f3f18459e5991660c97bcd1390fb9774d517eb4b33ead25062d8f323aa88ed4078b2e26392dcd521be278f5050df4ab6717ca63c719c506ac98e896e210354fd4f7d1b1953e642740e302cb09f3dec9fd85772f4d626b9a4cd7cb5678a984ee96e2530b1857ab924706624d35e840749e5c770841b0c25063f2c8ebd624faaf2b5d20350ba026d723cc2ccba95e90237a86fc9cace616c542745fd0a27b739c8fb91f305810b689d382176befda963faf97722d4e04bc037df54272e8a2ab8648ab0cb9ef9e0e31c96c4e6ae1c478e7206c0bf4731c3c6dae89344b24df5c3c762b5c9269ed36707aaa4f66a548c74b3fcd597f987dd7961f97122120db1ad39c7c0fd69b7d3a826bd5c01237dfd3728ff48dc3a83880165899be366e5e57027220ab2a88972c13b285aa1891b508a4d333c5c61cfc000801f565a50308246a87739696b6834e53b44dff90575d07bf64347d62416fed1f3eb055f5c2171b813d975848f1343aafdeb9d1bd9457f081bc59567de3fcf00c1f2854471e07dd0c2b1340ad54f4eb64e52335d14ec345cf8fd8f9669c359971e6eaf207e1f96b858a5dcc97de6071edd7f2e0de6e5a14e483bd6c943f319f4e2a153db50b04ca5ef1bc801479721ddf1a17e66485c16d5d625f3989e94665447173abec280bf7c1ded2b8178ed1126c6d12c3d57e7ec96e2293735164ca89639a1a4d9d19f606f9b29ce1b516b3583df5aecc5d0b30f59c174b1d5f547fa1783bd57f0b5ab030d595afb497dd454d2449dfb89930de80b18fc06cedcbf4a9448f3637c4a4e241f8cb1bbc8f3b54aae3725a15572174935c8c2559f503be8600054e9a6d2117a6f0d47761e28bd2997b6dd6a528b0a49aac19f9bff8164ae406172b02b43981ee7e9f25711b63acfa0ab36d9961f32c7f98c413d0a236ebb87232c36739a9a98a056716eb657a30c2b88cd76ad77a439241a463cf6e236d11c69648b43aa6c47ed5f28d1b29b36eaf6da483b1bc2beb07202e21979c2a1349281806e722b7ed8a42ba705c46fa9a601f2b5eda4bb44c7ab10ff89e33e06ea547f544e604281aec8b5ba19ffb7c736e30f48ad3baa9a9afe98fac05f089eb578c0251fef92de84365c9106749a85bb83a2a393fcba76d065090f46b11a36e10660a24da6260d7f0d93e4eab0d6f926bb791d970c3a4a8d47ef9ca7a15c9a2bfbdca624929459606ef7972168df7c1278d300f09cb731e0bc0358629130e62b155426d7efd520b89c5e72e10f886647379cdc66b70fcb3cfc442c709abd6f90a40e62a33f4760f0d0c08b0fba80321d5d2209ae57c01fb7c5eea2624948c4ffa681414c65cfb5882b91296f28bb94ab20d6fb7bf98bc6d5bfd1bb5621d9220975ada4e0e5687d945b556df3b9bc5f87a8912a2b5262b356dafc4e3a1c5c710a83d01048d84fba0b65b9f4c97c303048b7244b65dc11c663978315a00ac2bc3d6de30dc326da2f96d61978523896b1d77d1afafa73af64db14f8bca7a2b614207ec5b7fa6b8a02d40ada382a981183e62a5765112f121e0c3f9b6a6a485d9d9ee3bcb633467c8e1e5dce0591dcfa65ae05d3801e8a516fa1265205ce57c8e8875e2a2b7b6c94c587853a3c0fc3eb4b5654ebc5b0f10faef698f3a03dedc97786b0510261548a4fadd406fd085af3f9d3314461d0ee44e2c7952e0423f3630a2c125a7983be3136df8ebf7efd0f4a9a785e114fca7ec5d6b64a2a987ed0dd4aa2297a0e7f851d239299b14ef079e1f02ed1d2999567f4a361c9f75960967386524f2cbd76f75374d2674a138a67f479c32037f84550437be0b67ff94bb4da4e92ea193d050f6aa823b889b4f0eaa0898666681ec364f7aa829e313c8114d2bf6c01d45ff4c894a1043606f69a18f78b56ec7872c63d5411e3d466c2d9f403d8635dcbcea228779cec046c607e4f4618cd31d584e6a58bb3e2ba934366fceccb6301adfeb365a98098ba449f8e58ba8726f48f7a605a3767b6f2b441ed4a7d8376cd78a926277b2c67d267975915758ec5bbca62f9f295204d326b40e4cca79aaf8964a6b4cf4373f0c52fac75336146b1e2d48bf03ff2e3f9baef1a0d10b8ff7c4a248efe0a87f96c283e83df379585aed91ce5af071f97df30e6c9b74582c15299fb2732900ff91e799a2b3d19170e9d683f478b83fbe37e94cfb39694c92b4537c0c111d633bd7d5e63e24cf8851e374bd3ad024d0f77173b3df53c7b184ab331d30ad418e42479f0f07d1d66ec9523e7bddeaae65a16a47b4493280b8d4d02653048efc1262129b32b3e509dcb88f3aeeae59e9a0442a522c971aadbef9414d6dcdec38a8017145e786ffc384ea57c46224467cfd9f146b8ce09cb4cbc404df254bc1e1ae9ce0e3e29458d2412a10c7b0264d7a651f316fbc6f4471d9d7480ca691d2b630753e4561164692eda6b0e107e9bb8cb4e6e97320a9fd91b0e54d69472bc8903127fab387409dd7b58743efb250eeaed301f45de8aebcd35de1f1f1729cb1566eed5c185e83dde1f123beabd5a72633134bce690c4677975c7bf805c9e5493df389e6430db7e5191d04f6df76b5fa9fa4b7bac1c41091ee13d005c9e300757480aa284a75f5d72d82711357265b8571e9001764e8053402a8b911708c17ba5f2a3bda395d852f9a380ace09fbca5a72a6164275a293e81d99c8f75bd6ca481cd9be04baf9d3f8fbfc96663114c5b32f9f120d280b17c1fbb097274eed9cc4f849206149538eba93988d41ba766580f31b05d70d4cbea10f9d114c88e00765544b3f139d40150e542d97767cd8df835a764a21f5a45cbbcf48c4d142ef3cb0c4009c51baf2bf83b39d06f4a1edd043dcc029b650ecacca6a050e2a449572a2fb7da928e78cab462d1593e470f73f2b7d9257b763f548c8f6b0d01add467ad2c403d48482ce6e9446602cb42dc061b817d2d71f0eb35df185efea2f4cb754887cb2907944a2c3cf4d54c743d0c4703af0ecf7bad4cf6e160bb154341cdf027e3992638bef4d340817689dd35780414b54406b232316c3fe1371dcc8143873dc6cdeac6904b1655f9536b328b2fd6dd65447b483106b11ae9e788b58f55e2984df22280e57cff0d6733861f7d7ec84c6a28f0a84c5a41e444dd25f7d2e07b1f3bc73fbbc3a71f446bc64b8ea0cd1a83135dc56de7a4f8f7d032a03fb4569d7ee3fd07bfbf1b68a93c0d3f8c689d4ba0e36ec74a163cacf0fedac776090b4fe03b84a48f278569122f743bd6fcb7628d8a4e9224a4ede69a4bc0c2dc0f05dfc549fe1c6f35a7f9eee2c2cfa89828bc43ed5ffe8a971698a94a61fb600cd107d78487498b5770e8416239e2fc9943e996e33370613288c1df9acd15e377febccb8c5c987cdb9343afa65985c3f181de0ce4fadb2305225c6c169fa4faaa441a70f771b476f646959d4afabd973f58620dcaae87db36a69cba8097e747c85c70150c1934dddf1cb427ae927e2b55c05c525f9406b4405d590853a941fc609097629f75546e9a9e3a1824e68c9e2cd78fac9793e0164be57f6917f42d3a7cf7fe54ab0e263d58500e6a72873d6425cb63bd379364a6c320e9ddc71544ab7d06e8369e9771c989b87723361059a42e74f8f8ad8b64938f80e4a5390d177a1ffe5786d1102bb4497745eeafe37ffdb3ef384b32a0d900070a91a8eaa3c1478fc45fed3799704de73c1537f798ecfd7231f25dfd6916d413ae56546801c5dd74f0040787a6edfc557920f4754359de049adcdd1b4b435fe2cfdaabc455f8cbff11959a4616f646af0f6714a2ac912e7c4564706017ae2189f7dfcc4cbd1279fa5f410e0514dc3800e7f9352401d27be939abc9eed7f99c037286e6bcfe60cb1213d717d8b29de82ce91c025ca8eba88356ccab8804faea1cdc3ec6c13fbf10210f884d0d6937840d53afb389509a70a71a73108fcfc2d338706fbe1d439fec25f348a29d023fa2c135a28379776d593bfbb55b9f5199d07e15eb33d3fdc96ebdee68f11fc2f0fc2150d594d78a429a2cdf583f7f9b42074d01461c6d44e5a02376b2a2350fe1d2337cacac47e29e83ed38350b400365eded82cf15f454f28e479f697f0cef67877360d7a1f26e7caeffe25a798a753a909ca0265ebea3cdc283f9fb283e8f2a411e1294b7c8ded8e36856a3d0ea1e130272fda6f52f1d51fd32c3fa73b5aff504cc340efcfbb8b5fc237f5594ce645d7070f000af1c6a52cac1866c240d6daa7d1762b63d3bfa25765cd24ac63fbe78ba61835713790f3f3266f1fede229a717911526835abdcb2ef69bf2b3c622d59e544cceff667bd1c374e66fad5a69315c1f9b43a0e3399f7d84e12e404e883f7244d1ae450698a1b342207e0159b7ec4fdd28d72e129b14d84250b1c2d7476c0ea4604139270550078c6a4810aa612652b9e3886314876a91a446f2cb6ef02d9c08e3469e324a080d3ede031fc917156f95310639ae3a7ed32e228f568f067abe011466522edba28c49962caebc09e9a6a5e5175b19d98e7ac6ae052be8462eb449707c7eb00b17a7714a57368eb52d37ab56b82a235a18c8b1ce12a47b6947c2bf72735f2d62d9cb569c8bf2c7b3ec3cca6752e76d564b6cebdedefc26db5bf0e7a081d9a6448c521263850eb93b9fed1054ed7f950570b0c0690a9b6ddc4a1bc139f9e26a7fb599f079b01f23024a6d4758b0162e90a7442b196d35b034e5ee26812a20199587b7197b59841f4bb95fec9a461f5f338a5a49dba9cea083874170ee990e55b5b69c0093ce80e3c78099ae2ea40fad0bc971fae2507bf657ab066b45eccdef075fa1cbd85d25485f935e04082b1e0e521f8fd3817e49fba1dbbe30dc6affb687e0d89b77722d29c42e0329a9a8e8904c540d01f807b40ccc2670ced612ce2437cf859258a8cac7c327f82c27bc654a90dbba671ec93d074e76354d84c50fcb11499cfb4f8a2114b8bd5c7fbc0d00dae65b6115788fd27beacd8df6a45028a12b85b03a7e69c54b08bff5021124a2e5351fd5b12b9c905760409c5d7c6012b1fc9638d44a7af4c449548f258d0e23ec7a7283b0e018bde539c39a54f3a0953e1b15313b3f7ca028c769d311e160c918f5acec77ba219e2e98772076996a39de10692a0ce989a2fbae53629a3e5e2c022a979154eaccfab5b1be1e5938efc9b54b29c399323e66d8dc31bb18722afe4e354f1f4e85c805537924f877c551926c6a00a5ecf1b5173c59ef0bf5b310e4ff1b03fb0c6263b4ad69ecdfdea0dcc5d778f1a855dad9358e7a4f2dea2ba834a2636373c46841b068fdac60a78756ef61d01d620b4faea0827e0253fdd9ea27dfbd035e8f0a3bc13ea388565986b2d92b94fc52782b31993e1818e903334fd3ff29222947740b2cb938a99f09f8f532c3b99feaaefe40061154b3f1581879cf8de189bf5734e5f946f1a54147bc65b8337b4e5afba88fcf9af243e36b39ca70b86147a9036b86394d4f6fd0b2057fac29e7839611db37af5edd1bd93fb3f4422e84578701535d79df00271df43dec590a53681f308b5ccc6fa6557e1e2d7a70f2778d2902756dad0fabb9e8b3c92ff7fccffb36e4e2892d8513ab2e24710de29379c99d06d988d200464e9edc2a785c18b150eaf0a0d86662e3f4274fe93e429b70905d984995270ea58eb9db1a722b123a137991ece42e3324190a145b9b684112b235f1b49ede27974b058e9195f8248bf9d8ae6eac7e3f4375b2802992b2ce62d821f577d492d112111b9fdd56a5b33cdfe8e006b4aea699d8eac6c4d08de8895c69f90ddf9a57d6096fba7d3a6ae3a835606b22059d0bbc72765bde123064d07465ff12b3ccbd3fcbcbbb853cc85b595298e291ac6b0be7c747ea419704a8225a05c5ae84802bd3ed405882dd6f9530d8c8494e1bf9fbf3a745485cc9c05d8acb235dacd1539dbff9588fd02803c0bd5c0ed8a54e779b0170801e901af5c83263db25619c23b663eca2d276fda3a33c89d03bac3ce0a140943748709ac088c169d4b54b5fa8b73fd7d2e8b54f599c0808eb97d23e26f257ab8ecc19e5dc82e04d9921b2c9614a076a9103d54b76e06714e04855bbe03a64a89bffa0d013658f3af2af1b66ab67c799eb200234aa349a2c17bd913dae626f8727c17f4f6be93d224c1b281469bd134926371265be466e3f34c802f6dbdcace1f943bff4b555630e9c44d6afc70278e526014958b65109c38f7c4ac598551f10074186693acfd3f9f6d87b1948c768f8e349f715ad71438228e15241bffe63cabf60a15b3827b9784516339518f004b693a3e34bc8653a32811ad4ae75b7ee32086fd0529605c35910759e2b7d629eb65778ec1ab98816ad44317eae2a5a9b2aaf2cfa998b5006e79eb2482a6db0a29f2b36a3d50e6dd0c07c8ed23c37d3fe6039622785da73876cb4fb049e15036f5e89bd507fd127cc6af22fcf5ce0a1e562da84b6ebb21357a8338be12bfc94b51cfcdf7c8c1e6eb191fa4ebe3adf92e121cc829b707c0cd615fac47a9356e7102f008ec5beb79da832405cadd8d366bdab38b07ad500795adec3dd485434ef19dd1f23215114d49d6e9a5c2310e0934a15facf2d3fb7e332a3b40ace87fa8de816d209968c3923fd0fa57a7a626bbf05a79524682244c7737a30a5fc91ee9f10771c41c012bad4bd103b3374615ebd0fdd30c94274a01770aef1ced977afbe181d71f0df105e8b8a0a7b972dd4c2bda48115d6fc8bbf40fc1872fbd8c4d1c1758036aee433a070799946a1f9ced98bb07ba133a143cca7be762daa88f678d6976bf055fbe681632a25d0cbc487204e34ce5b92099c54ba0d4a29bb0001203fc5093563d888c0cdaa89ea378bd96e3ab2a1c77b1a6849b338ec8868401b2cb0b6f66f59046895407a48146e2c95ee2769d75b3b1466284362786f119322c592334a65bfe6addcb1e186bb06979de176f122406f7e01a9cce2f743cc2a42bdaec707976767be3e6231efa87cb914b157578f7d2c84d6a345001dd91d790cf8153437aca5866ed3c19510aa3522cd1b33011608381fa5b8ca74eb4616f3588e0c0de20b93360af347ca25f0c9112f25c2166d68fe0a85b6f52b418fdc928659f3a2f5e6d3fd37efc2bd5f46425617d8ccb3590065fa085263a27f0911e9577f04d463978635cb99aa84e6a32b5b15f0fc1fec2c9e6f93c8041caee7c65802f5854bfbad646000a234ec6294173af04b3813396db3b301cd29b98cc32374d92d5286255c8b30341a16f0e1ef0d55a859215ecd1ff639beb6a49e7f5948ae5b3f4695cb0c9db35dc05e468705ec636457fe289040295ee0cdfdf897d95d43004948ca1428f7e6caa0401753cbeab9d0c5f0197efd024954ca0880a73a6977de349a9df7024427c4c77bfed34b2fe3632d3763ea85a994faa9a77d6d9c0ed97195a46e49a72bb22a7ed8045bef8ce7f11cd755d5db297d1bf8fed72b6fb90687736eb41f714eb5469b737a71a9854ebc454e0254d978d1d8ae2ec4847cf0a0afdbbf6f7932d9f2e9ef75558f3b57204f84b609bd4373b7a22a5687e25dbae3dd3ce930707aec4055f186a50d492e31b13d50f716f69bd226ef8eca7636afa11b15fad9cb9c734ceea09066a95a1393eb9b5974dad1b6daa291e4fe9e7d996565160513e0db1e46e3864c0a0b82d671b81e21921c6a893f8f5528d78f53d0830036b16a270defb0c527f4157203ae11480446d85129dd45f6ba3ce8665f24cb49ecf7fcc2584ae3b6fd876eca1c1b0c15b96f0eb9d1e6991389359aee9f731ff1b5ca070eaeda1282b563f12323d731e9dd82c5c0ff4c9d82ae70b9f61a4e67b86bb4ac94ecbfd4a8da7aa5f4db170a36a7ae011067adb978d7c826f5978349bdf5ae71ff6a407d9026988130acc576711b732cc885f29f4fd2706f5d75ceecf5368ab71a626af501c84dfe5c56d78befbc6b61d3d11e2e4505ce1bfe5cacb16df529e4613fa468018e2fbf00cbb8435bac4250834324a60159345760b13269e7f6f295a50a23f19dd2d22f02430604de750dd5a33e311c769669aac7231b16ef58566e7a863fd4a556f87239bc3c8c976e39f941c5f9aa0144493a6dab2d896fe41bc4fd74bede572dd32195a020a0ee4b62fb233dea2a44183c7c14077729a7e3df0a81109497156203fbc299f67e7d5418ba6a4e206b754ae07b355162c4ab157e98d824d3e1a80faa61493e914e4eb8a09fe53616883905e6e7989c837ff744f7ed80484e6f5ba99e26ad7c286cb04f75c92cfb023180a85fde1806eed25eb9f974ae427a20d7cfbfb931c1d1d30fc88f64ca05759e436fb2b4f3fe3954d59e2f9ba9eaf8d98e9e7296daa85327fbf37ca3a714d06577e9a7fa5f03dfa2018fb2aa04f08dbc28c57a2e3664c001f11c37845f9e1e2b0315295f3b9178c99a0366fe99e7e088fa25bc4e4277dae5d06ee42ec81c950b26cdcbfa339fc36140721bbb4222deb81bd2e0f3c64350c13e0613cb1d355183434e2cd23be38b00a51215abc9c26fbd181cff5c89c87fb44615c9c12c67fad718de95479b7f1104e0f971409fade52850e77290fc30b806edae1cc6e7afc3d3160483e7563a2592b6c92cb696f67be191106b4cd676054bc78553414d46b8a7dbfc29e7a77205fd4485927aeb7be1c734e148099823298ae0f41fe56358cd67a6b39a781bb97bde23ffbc5f030ac6ba3e702f8f2fa3aff3d163dc24b9deac6931f24f764ee72aeb8306634f9bb24ebc2b7fe908e38042f437ff3980ef72cd3f04dcf04bddb1db10f73fc7a82853920e272bf2406606c812f64ddab43d2def4477168a1568abf8b4d606694c1f8dc7c65d0b54c4252e45450e1a7a5b0ef6bb2e741dd2f85067dc39189843b4b299e1d307065e61041e7355fee92274017fafe2ccf35433bb0f5ed95138dcf0d0e21654825bdc835fe9444a55c1b6a20a5e88bc5c2de27e82765abd77502bd6c810763390358f04ddcd28f74a3f8c0f9ffa175abedbc49e5ebc2bd29c2801a745c6d45a9ede549e57243c00790f7eeb466cf282cf45dc6eb38e0e1d95d0badba7a84f63dd0fe90a539aa0b5ef9af885531e351a29a876518ac255aebb24fc927334513c7646baf8bc7144448be0684450254138ad027d6d6b43ba28ec3e0cd3c4bcb52ad759822af74e9db089d26b27ad5c60ba6d54c3be946bb0634ee16ef00573215262380e4a3160cdb21dcbf0b9913178e86275ac339fc8a1b8aa80be25f33a091d59bdd3508ef5929cafbdd82cb1729d184d97a5a7f71eef96103fc534d7971a8a08654f8645108faef44603e9aeb6c3875aee1669cd7da7476ca116bff7580499307f6abfe365f2f9442544a03e6429da047caf3cf68b0712d1eb7c528d3a577f4cbf91ea11c330a3fb61dc1c7dd682a54aa07b5d994e5552958cb5f08dad9cfc37a5e029ca63889fbcdf0006a98d2afe1385aff0e5506329229a7c9ff1a9592da080ab7b1d7630b1aaedfc67eb4330a57003719254b07f96d8e3f647c5ad50961c806a3c16cf976dc3fafff03263eaea1992db70037ed9310aee5782df850727ffb59567e165567ee784c9da657f418928f97f7d7f9f2a7cc36e6f32172439d2fc1937ceac117954af9f5b3cf2809ec7d952b9e4dc50982a20c88241e390b10600ec0bf86fdff327c1fe38e89c794539cb664c11785a9ae6d5be638bec1e4f7c1330d9cb3ed9c5fa050d699e5cebd9117336015de1716047f0ba8ccf2965cb4d6e8a8cfdc4d797016d09a512dc9397dffcf85989493f611649acd11584dc358af8718cee7baf5031a81bc06913679e5618fdd938ff862124c125647ce5bfd41cc618d75b02bba4f7dcf8da660335295964cd20b1d1864b256638f689462bb7c594f9c85e7288910dd00f966fda53161681d75fd1d16beda4506124031e83f18df34c3ca1eb2302ddf93e1e3670bbad9bc5648cfbbf0b682fbb13feae2e0fbd318f6e48cf505b1fc61ced39cb37f1bb120c8f349517eeec2c48c173cbfeed086b86fbb1a1f862301019bf771ed79e5d22dfc7f63ee242ff161d4dbe543f0388b0b6a6d3a73eaa4dd2857e44506ba1d6d37decea9686cf503eb355679a9ea9fcb4b699f2726040b1bfc6ed65ab9ccd119023c8da3e8e951a10d68a889b054faa7d78a63ff2f1043599e1318e9ff151448b1470fd32e671f8eb56614192125ac2cfb63d7960d918a007be9372c0f5f601ad3b452c9709024f563aa16c7d153fa77859933dc7cb11e33e9152123cb667e2ee5e37376efa1bffe86dcb44c5da0bc7d6a347340734f6b1810eaca208641a42fe61d71128c33e1f7856c29e559102ff13bba61bcf479bea66ce9f17d9f65dcb3f110f5cf1f5f1d79463bf329257a7c50a8d46eb44851a0b12c7a0e766cbc76c2271f45c2ef48a3e00ee2351fa7a5b97de3bf7030840f2145520ddc9f134831439374f768b252e99fbccaebb4c100dfaa59e8238775e6908439554b5d47e5b4b08cfa270d13b3065d8de9b35833a6a55e12cdce79fd47b6fd7d84af7abb682dc2786dad4e2131791455e6c7086524d3eb51d3329e703475940720c8eb85a4d8cab9416d78816527eb14b00a49efc3232773e8e07b22e2480b562084173a61f3363c0b7db9e623bf848f4e224a93f4f3d086dc4f486e6b9de9f0a80ef1a6d5f4017d51ebee5421b2f9e0cce4655c5219a23a701f7ebc526d01f65037aed91a563b7a883c39cc267ed6cd3de58f456703efa76b511d74bfb4369811935c51bed2b462d3aab0335db612738a52d9073f819cb44ce7f6e52f4eea21b628760f70430244a4fe2f13171e2684add5f20c46b1f8d607730752c7118cca8635e4f25edde5d4e44f454ff208bf4f0d825341cf9c62de13e94ee117d19de0d751b7220633e105a641b230eac507bf9d0575182bf7a69f98580696ab5bc1b0ed1f7a91aed1c6230b5579125fb342273bae12762503927cf825e448f98a43e67ada0f757d0084581b1fa39a5e9ff38f92a0fe5fbc87231a1f88fc34ca91a3f1d4970d0f466a5747a5cf5a031ee846f60089f22bb2fa2e872060f35664da18eab71d9af26b79fa37cc5986010b32fec65add0cd10a8e7e06cd84385a3941ced05f2f0b4f0e1cbfd734762c7c0d27dbb3fc891339d82752df110aa6c0432fc312ed37827e136fdca9e4776a5f0eb6c966345279e1f130c9728d90219acd54f879706980cdf93a81ae259170bc53d1adb159cf29335f46337634cbe353a4ff46236cef76d9e870a53620ab0d577a31940925894bb7eb0372d54b6d2adb3bcb77ca0492fef4a7b35ebbf61d6cc5a7d16658a9dc04bc4070a543b49bde26a2b338cfdde7cb88a435abad644c9628eeaca1487e0e0edbfa74b946b1e7dc9680b67deab8c0e5e84f97b0a556e6eddf7c3154a9428fe4a95cf91f528c7dd683675c5841694350cf2997fe8e7270776466035e418b759855846456cef664145dc4af5411fde0b98ea6b75ddcdf100021e2f37461f51a14491564622b0d8b8a2a16693635fb301bb08a45208a8047c80cf18f1dc3a53f823f217e291e80f95cf152e0c1a1c1e9691a47c90b5e480d305db38d8ce5a6b998f5ab5806c9c5f5022147c1c7592f194f7d3e04885c15e3ac17dbe79c26b62b7caca267489fbb6a611bf085ec740f1ea9e13677ad59c46df370d76070c83504713c127a3627c6c761089e6dd821b7f494a48d294f475177e549c74767e8f30014325314772721e60e7fd591a77e69292adeca514379ec12be3fcbc52c50f1e758e89e67aa14693d77d7b62a37346ffe3053f5f71ca1f31daa7541bedf612137d1b7a9516940866bbbdc3f13221e6578f27f7b9af8df176e9be942a571525650138565ea8d8117a10ea7fe5f7e4bdb8625406260fd18d121b5f3cee792b6e514ed169e1555e58aa3fd924d53b532afb0a3168011fef47ec72acc6faed446681afcad9548ec3bb299595dec2d97b1232180fbeb51f55a6011f412bb73b32139a3b783a6ef384de9261185d695494928c2155278b2670b86a7d202c2d05a5cc0ac3048d1e7dcd545356d8cbaf2c43a339939a172ba2fb39ab27d1d028ff23262c29cedf9d994bf4e187c7e4306fa3272455a9073672ba39605f53539bb1c6268e1f774e539d26f67907a181d05accaf8cf6733b7e5eba593fec40e31bf85f6b42d29a41a0515f276686e7cfa3df5894d0a9f42f2c58e8ced9a0c53f9f89a7d2e4cd8165fa5985fd41d93b83421b80e529f3d372c96affb26c3e27930dcbf4412b1b5bd2eab0d6a6b82e6e7cc3a5f7381f116d112a927db43549a2832a7fd257d463684fa7ecf27adb8316dec31d7b88658354c5c476ca4a4821203885ae7a3417e9c70a7677d018dda47e00dc8a91152624f7b361ddcfe27ee8a181599c4ba90489ec8774e8d0169046bf3a5285165942319b8a7f228e14564f5deba76aa6cd5a696f4be1e8e9942579f9aaebfb1b9611ec5161ea322818bef01841fa6e9a38dd2173a9b045eea36209030eff0e0172ec70d80e9088378ba35cc91844b6422febfbeedd97dc41d27234b86b58e06ac9e3c6d753d2a2c17753bb31e9a5700ec894d3ddc4d8c609c9ebe20b8502f07d50019905e2fbdb6c937ee91490d0227efaa7e313d0f1a90a1a70e698d73c4b1ddafb0d82060ad91305cda5d7d737a9499d8f4a440fd61ee73c45f6424d48ab75f031c73663e19b89401a0f24ef25ff3c37ab74963b408ddced76779b89256621ec0c79f06e2479f29b9a6e6bdc1529e5bda1383c9f5f6483122293628c120e769b339840c28aa2326faf459b0113666f3de8327788d0e7bb7fd5a20dcc0f99bbd7119ccab1a8725061214e35d5651c230fff6b4f439b4158f982e934b2a67f62da7501384879abe8f4575e2c9c2207229cc268c9861ff414c5fab9b4d9c1c0f919606b33b920f85ea6497ef91aca69318acdf1bb5c93715626020f077aeb507566691211a5fb63991b829d3de9ba47948da154031c1b96e456e48233c705df4ae18af3db6ec5d9164977b2a33a5f264fcf08c447e9d4ccda8a3bbb01a6cd287701f3fcbca958ce130fc40856192453b600cca008041d28bf7376ded1e636d8eef97dbf4cb106e87ec7f3c5a139b51d02ced63dd00ab0a7147dee790efb6b2767d9ced93b83bbe629443e4e169d0cf49bed635bb9c3c1fda74838c6cb6e1d45c1b35cfd3641b74087c085037c1ed9086ef0b70306dcafb70635f4a204a1ea098087f6d9f1ef88fe12d445f683d6cced3e6c522e354da4dc4ad401e1b2a05ec6e3d49c1e147dc7861a1c258957bfeee2183b4b01c50e4fa75ef389aa8e0a5e897bb769699a3218f422929293610bb05b4abaa4a4eea883e1a1d5fb18778cb238729d5560f6aa6c796add3fd138880aa1e71ada5c21b3742f77c4090b09750bdec3af2432d3f822072abe7df68a1a32baf472ab95593fae2790b99b535a0326e6cbafb91445b492b267f146fb8d137924279b561c602179d439a7e6af2558ac97bd4b47e88b0d116a3d37317f4ce57ac9c480b9f5120ef7fe29f876378648d9d3c098f3f66e4d221baa741b63ad517af39d32a8d9ecf011de839afaee9882a5ad5d7b55f67b6c2ba3b8826ac99516408afcbdda4e367986ea8bd57dbbe7fb36d88b62a59b42dff3021c384ff628a0f2a76354ab0814c0ae1079ea933edfc634a5aebcc08e698200d815f01d08904b318a38c9f1b743a1be7a8f11b4451f74e34a34b4acc03d6562503ba63dd1da6c9d0856cbdb20d750846859fa7f7b3942cbbd80be810ec1bae7b77e631af88f5d5a99464ae1454a4dfedea9b656d5cacb5874efab32a55005b082d019360718007e75eafba93b8d86ff023455bcbf4c82a19866999215392413ee47373b34996c065953f5e3d6e3ae2ae599275a57fe797bfcf525d38631777fcf01b6e916ccfd6c251fe1a330ac5f900c4a3792716733e64da00747b7a46818ca65ec690fd7b622bbe1158191763391de33c767633198c9c9740e34d0d114dbed5422b14aada52e87f5e42fefcbf48829fc52dd6ec6186c5930dd4b25d3c4dfe91785ea32ff46fd02d6dd25c075354826cab83ac3f54e818cedf6a2781d3b2edf03ab1c977c8ec83a5d88e3b1999e4254dddd3319ec166e756de979b47e8867a1250af5270ad76fb5b9164271692cf53e77fe64493e6281770052a17c7ce245c8ffea4caceb2029d504a18ec7ad6369eb6ea7e6a5d91535db2ecd88ffb296a10a2553554ce866651c80c5c6bdad06a30254dddf92743ca6941159f4f7c80a3f9c73388179a24b9efbf867a9bf9f32a5d284294928b4eb09197bd850de3eaab38d37d739d6fbe8b549b256ea88deaf5987975fbec4da89c78e978c6eee62e1ae8b2515c1619d5e4401ce9ff88ecd74c3c93eb7ba1304b04569654f94c7cc8be899e7e7c6927508ef28746e317f8763eb7e0c5cdd59e375f897a3667f3f9f38d09255103c21a8a882c12774dafafdf1ab238c2094a78a1b21bbf744341110d63eda4e337d613ed8ad949e07b30959523400152425af5391c1e8c82ab300f46f5cf0ffbc09e0d4e4e4277cb25bb12474e27a2d59f624cc9387569178a174bd187b04b015c03fae46201918c5976ff52f040d58e80a3e68b57544978b37269ffcccbb3e16039178bb3c93222c88d13d6681a2836ed980292323b99b1e6165a0ef7526573d8e6034c1258b381211bc1aa777a20c24188e48ae56029d4e12d46dad82dee854df0621db79113427100765ff0ba425c2a6b9c217187a53c94d4db78ea1741a725dddb45e7b501e87a0447d3fa70cc3b2aac54e0e045c82227be9fd4e14d08ee9025db53f65e78a2208d0895ffacc75e1faac0cbfdd7fadc32d53e580f488b3922a83a317784e724cebc923fe594ee22050b37de00fa24e4c95dd06f6b2d9afcc7ffd8eb58a2641bedae3d3f7406061841bb8fcbd575ccffe6b4d8577201a78a13645925b256694b5d86fd63d7dbbe109e73adece1088d8f01076b40cb2b9874adb0d8ac00f9dbf76a5cc351ab934d6b0565d0b10d415f7eead098f24fd704722b2d5661e904e6d02dad574f889af052b19542e6868bc514340a738710c4c8e82baf2bf2c41fde3947d97d8ba77e7a146946dd3007d17f6b7a54eacd3f42b34b82ac9393dcdebe05b0b292b97a8ec7f067abb8e8afe065db43d349be7656ce050902fa89df444a967cb1f5e65ac1c00ed5b87a6417e98ce9dda1058302412346b253b6811970ed9860734b56f7ec3b51e50d05d4a2858b6a69484fd4af5fda584bd15541ae1e7a755efadb339edba9800a9eba0802b3e92ff0bf209fc95e869d21511d863f2f27af9aeac66c809b56870a046ea3c95f6195934f56c50ea59e341442b03369440a9ed3d4cdebaa35a856f989866a1d24ef4e3f30dd87c12e5caa34d1e42da9e8f7d20378773bf5a9ed0f9324b8b18612b19ebe065ffb217be7417dabb9f7c0992c412a122934c0384411870bdc396619b0bde4b25110b726c8ea748d81ef5bc4c782883bfb8c3b746c1aca28068b4e06167e2b4dc7b8c1c2cd6a542f32eeec720892ba9b82fec1374c77410a4dc35cb86a128e2631752a0a969a54a02b76a495f88bc123298c7dd1596480a43fe9cf6563a34be25ef1073a6bc5331d178b5b6fead05d9f5ceb4ccb5faab207d867a8c10e25b75821f195fc4626ef11a33538c755f6fef96456fae767ab2a75a93c69c555c09c52cde0cdaa628d5f2a0e6c57b3da75dd9c7fa891efaa8178eb2cdbc16c2e92ac1c5d3bfb7d12bc993a2965fd62d8d78ec833ffbb1755e6b84de16e9cfbe781a0c21ae6df534e3913b8f6b306a9d7130378d55920c2106dcc7f0b8ac437036d759a6fa26a01c33393eba757c45f45ce67bff929fe22171c53e73f44294721d2329edcc39935fa048b7cf09eeac470fb0b95fe1f16eebd7c2110096f47d306181c63e842ee30c31a2f8b0bd6c254a01e8003f25d76c594338bd562508860c74b00cc4c604298552ecb2010898235a2d464279eb57e1fce920bc221e6bc3504d4d5f4d17f7160300af6c94768f2ad97f9b27e5848407b01c944c50904fdf697f4a95422d4302f8fe098a3b80ada2ed0ed60ef728b6061ab70f5153e6a64e6037f807afc3c4e0091f555f60fbe91a2f63ad340bbb825c8fcd3fa6997cab8377068860bce85ead0fa1cae005d5b9ad2ad348ef47fbc3e315dffaab4a8b1d2dfa9deeca0211097019386d5288d7174102bba08153b9267cbea38ffd8812b6e16054410323190439b6f27fb6cb11fe5fbe0427e793735317418e068274ee9a9174ef9a4a97e10e08adf5e63ec4bd32452fca64347c0b8c9ab840d52d238cad1cdd5d71315a15dde94c01f93b2fa5567b0532eee5eb18966500adadf020b85215e2277247583db9ea54b7952d7da8ddaf696affb6e9ecb5b6286fc2314c2fb7076f448937352399907c18a70887963994ed83712bf09bd2c862392a3802e4586c42a48a4dc8d96ad54763f1527e7bef69791682e88d7d1e7a88134593cdffe1993fbb49f1130341d41e8fe5cfe9afedce8b5c163f9f92cc0811ab173bb290b64c87fe17e3b1b1349a06dcfd3c4e8608166337f727e4e93a54a7a9c464f185ab18d3f198de5dc3271e1f9be9b29429c3591e21ef209d4b9a0e98114fa5cdf248159afc85a571fbf96e4d6d3a05e95a34d5bbebeb98a2234025f81a6688d62337be7885c365aea2bdf645e965d38abb0e309a99a009e0012267d5c8dd1d8d9c9abcc8c6803d6a8be670404964b33e97e1e84872d660e846f7db69fd9bac81b42129c33ab0c73d0d05515fbdc30a18a26faa5be2f2da3fd8f93efc3846f0282e508f149abbc8b164263d5060c1c17bf7edefc1bba3cda76d464f0553208a2d0ad8113234b3282ece335c101ba0b5dccdb69e21ad2365197f72d483fbb5d472d4904faa18e958116c2c47b5272536d330a9a6cfeb9e1623932b719b7f013e4ffc682b361566a7aaf2efbc5d58102d5a8cf5ba570697a14d604bb947d02d7988687200418712206f72d4a399e1730f45f4ee7c4b6437301acab814463398e0b801c4cc2a7af94890ff3d17c5894279acbc44c6c1553c28ded6ce6fd1f7cfe90ed10f9da0a6e2ab677e47a4630ad33acd889019be2e573ca6cf1a003c8a61d2e4c8e14b00d89c139651624b84da7b4fe51a4b0cba49f966a0febde56934cfdf37bc1bd9bc1705384a75135623e260836e2b772c87c26b70b2bebf709dcaeb59dc0773defbfaaca2a2e884c07ad9c4eb6d10890d98435c870f359891bf0e3fb0c379e92d6476b0a10b85c677024b3959c48b30273f9e8895dea578175ed3938edc09fadf3a36a796658a1e93f1d18046dfb52f7c6c56e843a33df2035700abe69b48a5ad7e60c5ffb6aea30f5adf9dca4660ba14b2467eba68aabb3ec2d2fcc2280c7636c9ca8a0d7f92d52a1c0faf12843ef24694ef17077e4cd994c3bbf60439ed61f17f4d43298eadae9daeecf02cebc4c5cd96f69eb26d235abaeb9abd557bff16c718f7b212f4b366de112470923594728e7189de3f9103434d86e8646d23e2362ffb8b2235f577f921a7cd9a94a14617d4e7506b64608d53fd9ecb7cd60f765bb6548c0a92d06051ae7af46aa2f0d27c94ba2ab3b7442f89f676a36d08dc9ac5dbff7f8594e4c26ed63e87d029390347fdafd00b97d148d3fe377a446710ceabc9935d750c1ee4ffd5a1c02c69ccd76a4d02bb214e1c34edb98d9fa2753e16409335c97647c8226ae185eb95e22c882865a8ad6b2c3a394d7e5baabcc75bd6f0ee6ecd45d93405d6dfc29ecbcfe95b79ebc68f9f8ddf3267e4734ac68db2f0430179f91991d0715b9638e89914c93d5b9eedb63f8282bab65d7fe4007ceb2af91bd1ecd3d3dcb305252e4f9457bb228bd2da0fe75d44c9ebdd7337592e527010ea31a2bd453fef938278186bf129c52d23cc77da99932803f64b90158af55f84da55fd8dca41d33379811246c033be14605b29c38b9b4f68457e42b7a4abfa886d4a61ba94ab5f285e8ba03d934058ea6facb7aab3e17745615846042f9f4fe0645662f726c812fa00dde2f3b928098a537154dd5a60e9126a0c614673913561a3a317c8a6a3ac3e1378dc7c5ccf1b2b094cdc366f7a6a8ac4093a240cf1fdbb192e470fe6af7045b2072faf1f67c2d4ec91e504023338c8538edcf23483441faa3afdce4f0a1a70aeb09a5a3d4c1281d8245d8b2ac1266b4d55da35dccc69fc7a580125b68def0ec28602fdbed5a3a90e77fb215d340bfc24b5984fd24e402d9304b638b1ca7556b08559641c2c5f189f2faf049d22d014b8a1acd11626695c8a1cd51065ae21aded840bc6da87bf2763d7b5aeadec985bbddc5f26b13f4b4dd44e40c03af88b6d45282b51e02366334c6877e281a981c8cf3cedaa3685d47106b58228041935602322ead1362affceaed10fe5a0eb81d7202f7b8a5d9d169cd7de70216e370d7ce8920d82984ef67c4a5d245d47c6f5ab3fc4d326f20624c1bb2c816b15ec18a25bfcf747f445709bdc2ac9c101164a8bd3fd9d7be8e8159c6ab32145de1db0bda1e7108a4e9faf73e66acd568b8e651dfed0b18c5db1fb40edbb6826eee22ddef4a46bc129040534b8a6ce6d70c6622e54e5f1b06cf893d6543d7af60ef5157a7fd12300e26746ad93e29495a493473b1d2b5bb7bad66b683b9c7153e446675638b0f12ecf8567a21ac78549f83f82932aa47da59f7031f051ce8239afefb3471a2d0a904110b7552ea078f06f23365aca3e3f63db880e264607cd5e0d3e15bd5ee8542a63e016ad876016c77cb67dc5f991fb1496f89485bda12b8509dd25c46702dcf5334ef75598db059ae740a2dfcab7335d38c81ff7b918561916c5eaec3b4f438e36ccff121dc625c7fde89be68868901315b8fad820ca667f8eb40c29d0a2af1a2210c7209bff045b1a5b8d2f9f42bb9e6cebd17d6f1126e47a59c0caccdd07be722cc9b21e185414f57f20bed8284da1d2884fc2d1d8e5f786c4cab1ea599b5f549ed147e524188c9c96d5732dfafd344706cec378c1c174be3cb9d3df54e6eb83c4522de43e70910b056f43784fd3b79ba99922827d43e9cbebcaf46614c4cfa3d499a8ddfaba9e5b9ab6be5eda4a4c523ab70bf104e2df94deafb7320944b7754422adf91a98991bae2e7ea89307f56ba045a47d86157b97b9b3700f86dad18e9592ab6c77589c2f2cb8f3447b05c4e627c4a4295274ce2aba0ec0115b6c9365c2d109f8ff120d686adc551403f1218933518e6fe6e0edf31b044ebc4e53ceb21bce90815e11724bcb19f8042fec52e8d671f18a9bcee5ea13fb40d3beff843021c5b2be87a4f920d38c3da3f833b60d2c038ea9bd2bc294c9473093edfe2bf1b5259904c422621bc556bc4afdebfa592ebd42982c1d8e585e74536f6a3d44738d322941b0ff9cec3a9eacaf19158c9b17bb2a0458cc74008a8f174f04f8265ea792042b24586b32b7900b8551731bfa6332db458da972c23c2962028307eea0d79d721c9ad34109acb7eeb27c37bdaaafb065c4046f7e60b4b288b37d4a351ee979f8a79ba4227876343f5a27e290870c9a7a4f17c16a56ffc7c4fef53646f6cfa1cfaff1872de0a20cf4e78c4bada4d83ce5eaabc7d46427813999e81e537611a4e2432f03613193fa15fc869b6dc7ad3e2ede9f650b36c52ebf8a146206bbc65b27c4eeb1bfa2b4e6ebcf9f2e621fc77ccac1ff090aada12f31a423909ab2e052820ceffa3a1b661be12bdc3975d017cf17acc80c485c9e3668f13441e842d30a65b2caa2f3c1f6c004a0a8c9ce4ab72af347b42dddc976ab32000e7c89e535e8444c2817d4b2bc6c0bdf18252de6dc2b1a53cf48f6a8f95d2458d3a8c77e033e62793725e9f720e3fd4bfbd72dd25f8c5a15b79729fac33b4272120b2219a44c7db173fc00ffc55e6edea7a7b29e757d43fb8d57ee8aee64b38b1a12064f9ab1470ef40380f64465fd6758f6451ef79094dd368d8741c0d29f9e41d9b830868868396a6a0fd8642899c24cdeb2c8a54996619d58ca25ce2602eb31128908fd35ebc7aecb3f999f540531c3cda0be68c2827c442dd7b5ea51c5038d67b3c3ed73c99d002fe54c1e0af109fcc4c1051a20b9418fe317897371df0b042177ffc505e7854e1befa05b516aab33845cbf61f25e2776755e540307f95be9f1020de746eee387507617c2439476b0bb10dfe4e3ddee56d1db72718a473f08f4ef1069cc2b20c4b0db6b2a3aae21a8372b74dafe459e4ff6736245d6801bde4ad8abd055a879f6247b937fe86ca1dd50129710fc799d92faac3e25262242075999d124d063a922a7c7ec8ed2b187fc08e89c18ae32a5a00dfc067cf4937b9edefbcba8240cb2fc0cc11919ac95e46aa16c2ea26627a39aed5b6a91cb78c11626894499ef81a9642c6da61b261ac1529b368246b6116c2ff2d9d685461369be82d6860346175c40ebc5ff19bbabee16ae1720d447e90104d680d9bc6fbf1d6619e2b887bd4e021b399f9594da252821d798c026063ac501e6dc309c5a06678bef64592bb42c56346acd90017b0ca171c61a200b0715586b55a1fb77d3f6855e331829609993d19e700afdaa7bb807da6eaeda611440d8e3e635ff17abdad498cb4b12e7229850a91585b2775f66114cc49b460c50010999362ad9fa50cf21750e77143c60f049535087f036ed6e2ff3471806a6d35570f67e63e794a7d6fdd847b75dcce944df98465536f662b032ca0ce0349ce80db6b28724d19127985223dbea973b9a6ebea332ca3a9e53c45e8a371bfd9516a5887ecd3b970580db0dd55cc5545aa6067861f1ee6c358a02a77025fd892b10c04e94ee47b6cb58ae8ae9921cfd11199481435359a42bedee38022ce1e60ae0d198f52550ce6e089ee68dacde054fea7c982aa11bf2d507e88717b3d5b98815df3789f27d7d13ff1b2b50432092d36b62525b0a15d22720f88e1409e421141649aff5978f4b5a2819e8c902641d91ebdaff3b697f117035d992ee8b1810ed4078f8e5fa420ae1c7a5078b9044077cf10e277903c1c0844806c66b22f748a460a2d452f2ce76e7aa62f8c96fea4f1ab3d49b69c907f855f9a19968386d969119e8a532775ff51eea74d629acc0ef795c18a4d95dce2b72346b56a591b96034bee66e7bdceede8bc1a4c8d8b6fac4db3318e170959d4bc13aca03ad9e0c295f6e4098cfc110ae1b6c2adccfd834f2ec6fead9f4e6a53c4a1ad449d47d7c3f21da0bd8541af67e5261549e13ce0269661bbb262d33c1d39c328a60920974ea31ef1b14a0b9405cf97ec842574283d812f0e63eaae09db733085c5c2b7df0152600289d6590a22186d507fca43a3a6e03c6fb63bd04494ac86a82dfd716f2a8776b7e74bd80b3d7cb91f003880d21ea3d7eed574e729993bcfa680742dfcdf03cc3c0c8d0cee004c2a10f4406fca1670fc25e0df607b60d1647cf4aa9853abe883d23f7542f81e752151f0568612b19cb7fab9d4409f38cf8755f34515986eb8cf61e4dcc8c94201b7932cf29ce5d21b5ad102e37a2e774b07d68e5cf305957e16da20ce222059adbe284b7171bc6ce3b82815c7c5a92faf695b23224a7b14a3312e6517b3cbef6f2af3904ca58f67a252cf85d0fbe790c15976376a94e89a35837a44d43c08024702f8ebe3d44c1d287c4c0ffce111c4d15bb0421446f9f24750e76a6d6f54f384f841d65393168a0e331735492335ab8d26b68499d59e8582e4d7a13954365c7e1bdf9494b5e62401c80a7cd84f8fa4d3a72f9a56cd78967330905991913aff1c6948e027b909f378c7c3c71bfa41e91301f7ab372f7470c2bc16f8fb654c889fc9f5f1d5730b0268f3afadc7eebdd766f14987f8d6aa018ac74f640ef6df0812c1aeed52ec64281beab3201ae7195fa166faac76eba177381da9edecf0bdccfab0765396e30aa6f7ce7d2694986e0fb4a01c3d487f80ba3858eb56708a16c52da7e3bbe5c6e08819d15a36675a57e71a82ee5fe1bcb66f551406d319d45375b5396bc847d894ccea1b04ffdf6891a2ce1df60b417b52d7af9a2117ac6121136d983d08fdcd4453db88c2b279f81f520abf807db98d205156312e8f6395d3105bdb10cfc681143f389fafaa89c05f3aeef3aefade707581d9e99d5a186039162944eef57e9a44506adc73e43052b68a410735385397b400f95e73fe4afb8af254ed3d65bbfe97601286b84ae8f894778bc2fa29510897084ed88fd80bfe5d6ed39f825868ae878c67f8af81efa8fbea1a0a7c656b06d159eef6ec97fc9797ce3a2b84aa18911782565ee451c83e4befdcbf84a00da11f7bf5eaf07d2b13399e95d0b709289ed78693b4bfae0c0fd5e29dba163de83f9f79caaa9420418827937535bcfeaeb1ca6ce3a7ec79171b647bf592a4e3e6d7470ca44cf6248ed6852c526afab8300a96094f2531184c7fb6deff3be3eff0d315982c1d92e073cfe3f02ae4ae877a1403190724223d81ec96e5137c56a7f6e9ac87d528303e39d8a95d50c298f640e4756cc590ba4f014ffb6d804fd4b7bfd3c90878202213fa264c7597cb18112570ee7bd9153e25bf0407cd0111360409befa27da55ded426be88ebf9efe473c70844124d514c0b7107465a4b25f98103507f5ae9ec338b0594fe692e035bb6b0503ee4446b23018d339de81787c8b3d49f69a29e3f6e1e30351734efd455a81f799772db624e7474c4d51b3fbbf3db9b6e51b015913b63f7d2c87740f4042736a912f3d7d173e804aad20ff323bf8115ad328e47b35d3f718fca33c65cad37debc82231505ef92eb0c7924321fde402a8a1af4e8e298fc53697be9d5c4acbe399fb4e13ab10392f5ddf85e83672e0e2cabbb75d2ac7703dad3965b1664225df4002be677032709c9726584756d70ac296d464f6a246c9fab123f255bcf24d9e21f92c45c75234c80128551b77838ab64047b2c5d8be5fbd1a099de4862ce86d3c79042ce1b26b91f7cdb1a3206e6a245054744ff6c114b58ed794bab128768e0fa2b90da9f6f2825655aea3ad90d6a2a534b914b12f28f9a64024953cec5e48ebced86debe4fd89763c4930e4ab58573ed80af4aeea440e7d619d2f4fd40087797dccc13283b53b975eb415cbc62d95850d8f45d98b4338190bd670f7a73bb1c36da6c64e4a913ff0aa2852cc107a45b0251a128a3e290c01ceca90711d6fec3e21ab4b5f1af72ef2a4ab7ca063ca992576ece98ae350072e3a9e0bc8dbc66b5fc6e7d3f2408821d096c8192e622d4d08c728dd6ec26b6750ecf344af1991a175e7f326cd2a218b7103f6f8c032c21c7870708e99dd900d36f464f7b69c1ed6594b3e55403cefbfef1c171b298a538130b9bfc076142b407ae57d6841acc7718f50f07619e146caa880570bf54418f0e12d449017f3caea4537fe73c18170cdd86a1cde6bfaa484ea6f3b0326996afbf09ba318996dc04865b6b1528cbf2e8905c3922b8b8f25ac37b548a09710362983da4dc01c8242aed9cd1f251bba6726a1049e7a4546ceedf5f556a8140ad401b3a4b5e7afcf4e78c11e81396510b93115c70ebf3cf9fb61d46ab327d37af6cd49157c395aec3b612634028e1e265024b15a11cf30dbbbc7bd0ea7e5103fd105485a48c47cec30cc39e2fb4c9f4bd316b849580c79be894ff8a10020824574e4ca72835a605b163b9f4530e98f62d997fa3f2cca9d50eb7e91fe6751bea6a75c17a8004863b3f3df572075001165bb0ec5ae42e8ef634a96451dd7f0d71177df8fe8ee27337264326e3b5f71ab1b5f7ec2c3797f647fa6a781fc4fa8d99c9df48ad1d022223e7821cb28eb48fa05690e5e4dcf409d7737b23a27f79e7c35c40c2f27fccb81c5f1d185b54e51e1d5a081563eb97d68f7fa873f99ceb21811d242bfd90b3bae45ab24e000191fa48d6f38ef68f318b19cb41c012010c9c008538e6adacb7ccec62d228b3ceb050afc626d9c7ed3bd3f5a3b3b9f79a01161d79c61b8c447bb8b97293a952bb3a88f58b93b5c8ce828e5689091700c9f317d2763897ddaa3ccbc7ca38247f4192f0f3315e8c0fc4697d6904653069d0e2eca071dc6342da16974b81f47f8748e08ea89890ce40ce62c9b995c1ef2f1c685d6c2dcd9cf43fbeaea1ee6dc1ef37f4e6e39c628d66cae9ca5ce4bf293a6c9a13d6392ed939c123e33e70653c914ef0b71b806882324469b30cbfb127e3cf6fbde3c8e33bdbfce61f13d17db63fac6524d2177e8542cd356638ef25936e821726403fd153fc8eff07229a255357a6acef75c592800addb1b3a604843787ee2f668768696093aa030e64823544939760ee1086ec04e882ce38f6115c1818cb87bdc678bfce2ac4afe018dab10b754ff39f3ac1d8025d933362bab1a263acbfe594d30660bd222fbc50448d829709b17350cddba0e92a5492d907263aa4524baf4d5918211429a7bc1bea2e11997f48f0685fc23afe4f2a51e8484d88ecb15d0e49947c0d3b40c4c77dec49a02564ac04ab5f29ec71bd5dcd68e301f3bf2d15e1f15ef81262f3d077839bf38ab08b880ad44860b8af2374d1baac338c9b48b6c6e6b066257317e3c24912a8b8071c6d4ffff9270e2918ccf27021d773a3ed7dd233a71a25af2629bedc5b4c5f0a7e5a87ed3c3f55f638c13b7a558dff194f1046b29dff112331571dc5885322aeefcd0e4bca24a1706515eb3fc78e9c91bf61bc6cdedf1d471d639aba0ac6c287bf6286839126ea419c6139002d613543670880cfd7b00daf60bcc6be444ae6946a0f5f5360e69da10fdafb50915d618aa7e246044473d9ad4507e82158c718fceb9da66b1aa45d481e2f27624d61df4cc6c627c1322b677e0230edaa4dcc632bd0c7d5fb9277e7aa05b5315bfc8a501bbd076da4cee01ae7245d4ebbbea7e5cde8456071fb73f36e5ea215a4318f76569d9abf7dd702cfde5a589350bf24d2dda930a48bc8af89273f95fd5ba7d6d77ef891adf48189ae6f24dcb386b64ea7ce988a1430ee2c36ac9f7dfb666d7ab811c7db487eb638078206f82eb5337cca5f7b3b364b9a7c2f8050b50dbec6d7eb1351e5d435e356ca5223cee3df2f1c803de9ceb6e81fe7621fd5ae66f76f889c245fb8c31b685deb06afac8189ef71236adf6dfa7cd54cc491d4234e19d1acfe8536d6083f6cb744b4edbaa39a54226f7bb14f96a58e4cdbd029eedf6bcc5ca797ce2045f016ee70d6c4f451f7f491eaa4be07ba11257420d77e1868e8386594bec11a55e628c0925c0aa9ef4e500be88d238ff6e4c55966ac406e159fd4f25c581a1e22f3b0ca2701dbceaede4839b7c68ebf9099b6bffd9a4fe5399e4c6292e2ab16281b4864ccb329405555c4a5bc6e4dd8febccc1448d6049ea46a0af37bc44caeea61d310a14bc9634ff45c75daeb8b338fedfc25984f30e3ceb5f0a37fdd519ef17e480697100433eae25c4747f6cd3eeadb8ebd86a279b8f3b3dd260a3e3ef8a48c91988ccc498b1b37b3b08e1825ac499b0e8a1033fca73e76b8f6931c9310d79d0e3a923a9982f64ee28261ed374ce15f27e198d73ed1c66925a642ea9943370c646bb9754c6b82152adf3ec9a5b48af6ae121f38a00f1504d8ac317e83d2c6f16535483776db982d6075928049fdd674cf7285915468dcfce40b0fd0ac50dba16f380ff1205b971f9503b5317f2150ef1b48f13a988141f5e43bf0859bf20b3f3d48c743a0772ead692d0bb6b1616345cd97582dc65dff992d63bc9063f4ba3f820d27f920ab60583344a57f25bcdcc63dff487f6c011d57cd30c2e71ba47b16450157c9165d9e21d71b48ba1dcc4df8c6afccb1dc463eeab5aae1f468ecf261ac5794604f9d5e79466c342271034673307860d97b1de35d862924fd05f05ce50023f0c1674ea977b7a3e7175cd788b0746fe176016a971298ade60f1c67ccfe28b0ac6135fb1999e2e37b262db09cdbb89d9165c92a8db11b308651a40e350465356bd65ee3ea8f7368ef26de00c6b5ea214032904e9955d55475e54b10bde4fd0dd01ec4de5206551ed7fae549aa89a0fdb68084d70d583173a3643b60e6000f0a4baf3818eefa0fd3a2eff161adbcd6bd25b157a6baecbfa18503a0f63b9915cc9245fe23b3e1e20d76f08d05c44128516a4e2ec6aeb1d616a157e160fff6dc64adf473a02110d8d92f48eea94735a01a13c6a73adc370dbe8c1e747f06018a77f7c92b72b5e7513ec6d88320633278fccfa098ea1c9ed8fe5a068ded261151b923a5c3719bbc04e0a41bf3d0c24d20433bc797d3885e2976fb2b35b6f86da7522250d329dc9823b685985088fda304ac900ac6efd20948cd904d9f9272ee74c674eaf5933764d3249307387674d7a4ad7d258cafac09fd00a9f62131ba0c2ad02377fc7a0c092ad8cf4cfa81494e588ecea78add78d08368985b43c5e12e627eb3bf607bda37075055ebd70a365518d59a437126bee49982929a4c0de78901e1aae9ef29866e565339ea98c7ac6e95facb7c3f289048f4b51c296b91f9eb0a69b5f7eacd77360ef6c12ec1ef10fea17a64dbba95bc9cc94c14004f55d6729ea9da840bee7dcb66e01156558aff906cdee022ad6a8f8d422968eab010a71ef9bef887cee42eb33eb11b2855c7425f0618d175c38ce65432a0f80f00c5aae886e91747170b09e502392562d598afe6a00cd20b100c77afb68c5e83475883568a8ec122be61f3be5399a09be11d4cdf537dc5593bf7e1a7dbc83f605ec4add8f6cc7d220d9aa9ed969d96c50fc9c879b4596d3cbb4f4b7000ab2e1911cdca944a267d7286ffe8b2a738fa686bf869b191d52f7063c81a00b722e98346097f74238cf4c79394942e90e1c4ce37660678ce1cf50a37637f7e50b564fbd11d10b42d3430d8da7a96f26220ca7e5757a90853eab33058f46cda46642f5979aeb3b499c0265b21b9fc4b6216d9fa52c4518690f55e58e0241f1dc2be47287baf4b40175986256c854152cd83106afab0041d21372bf2436da55380fec568a31dafc695b1932f03c67795561b0833a2474615d21f57e10aa61678c020d11fe2dfafb4a2fb9e5658bdcb2f806c690875e2cd3d869c7a60140e271327e94ef040abda6237b2d97cc30bbefa9dc745f13274c2480dbf80529bf74faab02f1431952f5cbd1a2b87c7280ca4992a858cd463bbe067f94a565115e98be523b1b3d4351a32b0126185295b7d3cccabc4be8d23ce7b0d0eeae34440f52de90486d370993fe61fc18a1a39bad1373cb580408f4a001ec3108df78edaa59ea4c23f8f898091c2ed1bd3b1a594cd38269aac92a9e9debc9d921be1e4c5dbee35fa453bfbe639ca0ca7fd4e456937776aeb6427e8c06b6d6635501825d4001709b623a069a0387c4354f87abea8c1246a14cec91745b9ef5799dd40fc9bf87adac8696f3de13dd98c2aa45807925f9e2de117f7dda1fd55881a883d13640f0b39eeb46b809ea587e755d12e8f6d575281371147cc3216d7d32a2d9c3f1a28df4d7b04a618b17220f3ab8244c246eeb5cf651b3943b9ccd4d571c5fa0a89a2ecf9e8434518406ce9eb3b7d527ca70cce620e3640dbb3a86490dd98570d8879f4d554ff293e3adb46e9f6f37bd275eeca95e736751f83599d18e6b69796c6df90a87673586f5a2e86f00dcbb970e7c3ec1c0464613c9f3dab0ed2dfbbefda8e54fc7a5f7bad4154eb55d7ed83e4eaf385a90ae28c3bcf75fd5af78ac9d2bfc98bee52b248b67aa3a9f02b8b25891669481318ca6c0b1ffe340883bacc0f898ec4c55f59061f4c5bc8fb1f6929ab09f201a39546dd6bccc911fc3c0a1d754ec0d10cc5b6eb2b24d447d65f67b411a8e54a92b51354ba24ace1ec1afe839312f02f3058798a02a2612e2b20765393ef8a36827516e57af85142dfd40e9745eb3edae815f76f606870fd62a69591f855bf86410f8c85b0620cf3d0b3bc619f776d63dfe96b5d2fe3cf6ea6c3ab8c50196a6518291bd5871d79645c6ce9aff517f2132c9dee89230b9f4664e36645bc4cedc3426b5bdee0ccd62b2ca0b3d09cb00b3153ec50eb7a09e78974e907f00a9cd699aede60756f0d783b1149ece11f5fcff768dd87f26c3b1b8a1df064f07b8634ed9d94e165962f6b20498f5521d7758494b042410c6f6e247506812fa578390878b5abc17ffcc765ade77fb1db92067fca1add0c4912579ebe97bca181d73abd51ec84505b859bad24b91f76466485502482abf90ea0319c881ba28a20b3ae33d712a566f4df20ffba78944fc9651bd78c0759b9bd29b4327d1748a028bf06fa8aa72c67f512c0aa9b700b34564bfaba57f149669c53d570e98241225a5696d33e6bf9ee88eaace08ef9f464e14d1e8997f84e8fa7844122975552b6ae411c2d9dd82180a71819bd4be68a3b0a8d68200d71876d9e055964570cc9a8423d739a90ae811974934ce0f596f210fe80ee90c511f07314864b8b5cf4145e0125ca57b4bc6a4884da876a2c876b34174b9d76cd33ee23f26aaec2c33538ac582882f056cbc8c8aecc13af0dc5f9e03135426d599658f83097b3e88b54bae09b2e59fcbd09c24f14a082b6f6fcf92ef6c8ca9871c247da3017025318aa3c3bc832fa864c33c54181adc21d477d236e8782d3f71346a484b482c1588c5011aa19aef87a72dbdb6170db87389b5b21e2fd763632164d77f83390b7aade814c78c85f267fc2baca132f0394372044512df04ad0cbe3d1a78c2b880e54028aff1d1e4869de703ef18af4ad3ede8e6a7c48f72b2e2a056b409e8e0316fd2cd9c8a0a64af9c2febe0b209e2caf964d5a78c1dff878f9e62a6c7034905cd5cc6b2b27b46baa1a8e2e26526e2294b70a42b8bff17d2040a00e0187ef1cdb3e3ca7cdd43aa53d4fb4a9e42c0975d92ffd91ce8d46b56e394ccc1f5e37a24bae0702af3c33816ad085921e1ca720829322af636886046703e59c3c93bec0f798c64b13c99fe50c34a50f4dd333f3bad1f01504fc07f2e5083b68fab488ad87204c74bf18adde637e69af057d8cc67826de38010bc51289b750c58222bfc94908082e599942ed94b8ae69f8f65a67b52686e5d1e230cbeed72c33fca0fbfff1bd14b42ae0b092743df003ef8e07b3594290723476f9349b53f5d780ce3a8e947ee3a51a63ebafc9a588d19896791c08f36efb2b94edd1fe2fcce989212bdfc369e29b3238824199a512adc793a8d16d9388818458b3f2c835ae7d4bb0e250bb2ea683761ca8191575ed251a057f3ecd926d3687f00d4fea59a7663803778ac7dfcfdf4c56e96c7d5329c3f4bc1781460c353cd95bc344ec8871281f1c0bf841db17d6d7b3daad37a6ab5ce98d3b0ed2085d95b52a5400089e8b05d39f5765a18feefbe1e88601a747b8fd31db085092d5ffd2d225b91430037cc979939ceb5fbf1c3579f857f4880e035cd2ada1551f06752672e5d2301a4603cad714214917b72640c1aaeb16938d15e92c4ff7b99a799463dc83d230cc229ea37a486df88150644fde888dc5a43d843bacd07227aaa64386a019b94e238b6e79c67c711d761cc3354d18514abaa3c1929f6be2ebf1c519365b06fd40f2f96f054e355dd0f53a799fa9e4732a498af525cb12e896992e9ef07a8631a1e8ed7393f36a50f7b1a56fe7c2dd8f187b4f836f805f654b65c3b2b85e2307ceb75f46713488b48aac9a7dc76d4d8de1c7692fb1338ba0b7fc3d55f69c382e92da6e2a9eb1d4fceba3b25071405c592fbb6fd5fca37c855bf21c1e0cae05592d09078ea55acb5aba4d365e94d59f180cac08307b87065848ad59484d50d95a2d93c0d7e09d8276400b4488c91aab756a0434aac799a3fd35c74d32b01503122764a29348a3fe9ec20f9576b0642ca4ea9558439106ee04a141975d1bfb9ed91a6661cd9f6aeb627f25757aa2381a70b4cbd657fb193ba0ebc86f8559c3876c52edd5315299860824122c5c92b2b8029a6a6fda9cf29eb778d5126a085fff7ed24cbf4e8dd494439ca8a1348eab51b18a4b16ae25394abf1f6e749c11b18ed1f53e663b3eaed2885ea8ec00da6db743e735a8f310d5fde66723ea964463aeb6341f98f124837fa9920972f2e0315e38ed8c12fff0047269ab803324af46383472396f8f56e1d43022d225d94ae8d19a17509a269f894bb348edb319d0307e91af40e4a6d42eae80ba8ce243dd7e6dc54bbe741a4c40b0bff646369974312b2b6db6e874fb062f218f02756c7cfc0f1cf94c563f4a0b76a1545f1299f09b02095d2bd03c06ed265619e49af0b5c6f68383b1c8cba3b0bd0e07df607b9fb04edf838bb069d5799e548a586f2a71c64f4f84585b4a51f7a1c6cd1c0b581632432fbdf8ce4c50180de722fa05a41f6fe0e07a465cb10de929cf6e145fe911627e47347bbdcfc9d9008550fc541102a8c4824ead79e22ace4306c8c1ad9ded532a476a3001d209dfb637bc9d54ee2bf0fca9a8b450fe898b680b27f140880bbdd7d085e941b665fe1f01b0b5e812fbdd48e33304607695a9b6b14976d7abdce0952aa17580c7f4bc78acfe5c11677726f160fa0ed29ab205e3badf9cdc5ee29d498c5e336e9cfe3490f861354ed2e20f79ee5becd352979cb2fdb4f27a6f63d31a91073c30f1ee1f2b8453ac938801236627103f729a5846779dfc0f5612923157d52f257c574cf36c7f892a24d9bdf60be84a6ab87c610c31b672149e289704d946c00b3e765b36e7940fe8ae75d40bf3f51e789f38f56df79e82c2a080fbdb2db5805ac268ddfd6c659479606f5e31e84505c2604d8bcf307fd385d9d4394b37e747c089afd574eca03090fb20d5c8be75e56c4d9adc701f77752c709fe04d14d856845c23b24a45ec21f999c1a54cfdfc0a7bec81eb5b857fc6912b8a0675348efc19ff4698c4ea23c2dbb264e499653c02cea12f8c5e2a0ed87a6f6420f0e2c1c5892701df66ab6ea9564aed9f99493f27292a30eff9895741314ca45f4a228a79bfeaa13cd2f6f341decac6dd61832c2f028879aa4a2a0f1b601a08a7e8a4a902d80f3bade739280e12021d87dd8767f2954d0862a566378bcb894ae9ecfcc37166c63f735f987584ab9d0081aa23a0b95e7a2f13682b74acdc88c3d54ad51f2e335c22f83ca913db318241494c58be043d86e51f49782877a08802d4399f3ddabbd64aff4bc3ac0ad0da8f54bbb24d6291f6bb4b96e87d5ae87c1fe9e2f4b87f29b2d75b9d15f739ff15490a2ec4ed39371dc5a94504ecbea61ad670019028a01cca19216d292d78bf64bb5f789549e88fb7ddcbd1cd768198f73b15978d1a92d5dd820bb484dae0edd42192c574dbb690948ca347f07896adf53e678572615664ffe62dbeefef0e43c52faf92078ba50eeb4380395a243af0eb6c880b44ca3f67349a0d30d71bddda68dc5449786ab98c20d88dc0c14a03feaf1aaaaaecdbcae06af5c44fcfae544edfdc88ed3b1ca58e613851999e217ceb90120bd8d7f0202469d9e16ff35900985233e1888d28a378043086b34ab1037eedee7785c63352a15565192769926885840722ea098cca96ae1640b1ed9f05c060e83b9d877fc55b85c2c345c652ec631aa084177090395988d17e1acf23b97ee43df082aac9ef5525c50e156b14f63038d95881eeb292a87db200971233d036bf9621479f1efd62e8dc221f68c38f1ec56ba6740c87ac975e84fb6d7ac27a3299a3ad7519a7b57aade405bd0745d45a89f0001f968458e89a6887a4636c1efd7d91b855184b15f44208de197791d94c4776ac615f4f8692fb8d56cf20f453cccc32e1e053a7710c857417887ab97bc8b8292dff5c3855d9e4bddd30babf1bd8998a61af1e3bf76cb512dfc980de5b1dbead0f35f721ec913796258a208a95e39f80805e445d041b2ed6875ffa7812effa271df1268eae9f37e214821236cd20d3e7f682bd0e0fc42c5a27feb5d3c1626435e9917fd9e4cd130a92a6e829a54e2fe643eddfb76451a6f893a23a8e5a4a025dfaccdc51a08116270d1d5df792a3674274fba42367d3324ebd8ff0089593995d9e4c33ebbcb89b65612106869383ae35778d16fb9b167854671e61e2336d4d77dffef0e5bdd66920f2c9c62c791128d73d6cbff2795c552dfffcfa93b6d617834425f485185d092d14b2757638fab4044f8bb2a54b1ca06edddc3e7fd15d2b9c8fabcd6fa44af9de5490bd802f76fbe87502a353c9784dfd97a60d80e152ff2e74e06f281859d48c9b7b454957eea7e3896a97a49b9fd2fc3660da0b6f9bb91ff09d0af6c1d3cc882042f058b91314c3d5defcdb25bba7988b145418eb43c8878997f208d30b15856d49325dcf3033b9fa288c0d3313ac7d3e7db7aae2e95be2173d05216560feb4b1aedd6eaaacff02ef04b1dd7819f29f99e7a21a58fc2dee4dca800b7a00ff51a8b57fb7fd500412bff650cd93a550cfd5737d29039cbf6deb412c48ca427113b1fe86b3eff27c8fc0838b15790a8f382f2a94d73fbf9021b02d47001e919fa18288d00fab66bc92e325e485759c6eb4a37524cbae532309194bd083d37a1b2a8ce2071385f2b857d70d4a999f8118f91a0d9a5a6182396c1e24bf42b29b9a4a638735505ac43b50c2aa2f0425f6ff0585659d02e89e5cd31c47019a1f6cac83a37addb15b887d6612f0f49298afdefdacf401e9bb56cda86d7fbc9e8871308585023eaf3faa311a0cca393ac0454424328595255a7e45f78bf30eb3ec8bbdec313b4f39452a76f6e4d72c72989f71dcc67d1c7849bfcea715a4004fe5a411c7240285a2520e5897e99fa049e218326054e648145dadbfbcbe468a13c53c2920727208115b0f1e2932cdae16c1bb0a0a207d8ffbad581fa0785bcd282a2bf01b130971b4905217f3aadd46f3ccff1555d60803b51db1787f1161b091552e84ac23d073880da406db8a53f16f4ebdf07604233d6a1476e56263668f743039b4a0b9120a4ff993055da5bd9e410b52744cfbbba1d83d73da26fa7ca6edd731d030e85f8ba9e659b8824986cde8153894efd190a79aaf2d05f55bf7b092501163517cc19c3d1bde2b021136fb876725b1af9b151d3b14ab94f4e17ef491efe98ad506fa02914a70fc0d4cee0bb88fc4a7490a55e2ea5d3f3660b516f176452336bd440b2f5f12d40065922b9dafd4f758fb43ecac03b902b64339660caa6012c79ef5de0cffb884e8c3e5892a8c5d7f91c8b135496d79523987efef74d63eccb6e5c53315cbc1c0fc51a488395c341d44489cf1ee399f46c3939d1ec0a163148efa9dff632da21c6aa49b6b7ae9e477cd88a4ca493d9323a2823d9c9aeec0ce420485d53509d97bf7e87b76ec606b35e1683d4d919f192361dc618bf01d6d1f080dfee379a6ed25a78b3ddc90094f24b8a5bae65c57e0250a5418dc52be93b69101b00ebea0cde072b630cdd780bbba05c2ba81bc5c9d58bc3af5da6912d08cdbb5d4ab9e2b7b9145ff442e2267f9f32d5547240ef5f543b172b7d837e6ac3914e58ac7741c79aba10981da8cb96f7559f45ff7d3f86d34f0a8779554a76611bae0a85966057df2d35e83ca8e4d58d7cf3f39df6e65de76227c2274731933558ee741a887bc6c3510c8f4ebe0f3d42920d87565071d05ef2abb8eb2e211e5787669fa7faf1232758082d8c639bc433966b3437c72c1094853fa4aa55b22254673e7c3dd0c7b9972544a527f8d8e2a1f1264cfbf97faa2128526aab105a0ee009f3e45e4e5220ff7f875de4d2b77e1157daa2d7c5fe6928636c9441a717d156f29a95ed528bfd4a579566bb06b0f00c9111e1a868c92027a2452b35cffa500b3811527b3331096e73838278f4bb5deeff08e16e8a2b4619e793c31387839c3388beb846d33b3e3bd38d217e6d1fa3df3901e9b3c36a2396a6317d5f28ea0c8dfd8fdb2e4bf75a6b9bc971378d79b0df6f42a0f1a8a3be7ea64c71cdcbf83db57fec829843ef3198af3f04018f377dba26b8353f2b6aaa6d6272c9813fbae2b9e0ba2cc35371c1a34722ff1b60896662e92005e702b5bd614dc87b7ef9d66a1395885017dbf49376820af17b94d94cb3680c28abd4e5971042f56c4ad952a777af0d335ef80d09ae622bb8cc4b14a2e861c496cc29eb17bc2e1785d76171ef214e24d73004bfaec719b57ef2e1c904e96be6d44b3a11d5c42d22700672b4e073a8ba2dc9a25fa6a9ce4edc7d33d7241c42935e04424b928cde1d7eb9a86f6a53e57d5767b8176a68b5563ea67735b6322b0beb818a91cdd68ebcd78cf5a15f5f0c81081f5bf02317868609c99354791713cb87ae29930a5718b1d2a58fb1607c0a4c8e2edcf93c77131d9e91c378db5d03ec83e9519986abbad32f5ac44fe41d257ed2e628b24349783fa7ed4f553eedb5c16c465622a6bfb80dbf0ba600990204b2b181caae333ec39690ef78213b31a53418267916a432d2fadbcfbf24ccfc32e2887cc95862d419890b3d43cafb1fc9a988842746186d347a5f9ddf8f838dcf8234960f371605792da0d0da42c4178d3bbcbaa34ef2de09e60975204b5c17662ce8836b8920904541527eec4bee62721a5ee725d15f85d01df34561ec9b35171274c31ef31e78a6aa1b66902902c0c94bf11c28fb31059887d0be2564e8469c999125ab94f571cffd7911822a78349bd6ce9c69553c503ef54fd17f27d084310dd51dc82e15b673f5d185cdb4c6ba12e7fa3a1985b3fedcf40f49a9bea03177aa2db9ecc78b20dfd05df0d145b06e3bf205809dc2909e813f273ab0974d09e32ccfb160c34d041a7f1294f1934bc6b7dd4c567f8ced7926cc9250a80123925625acf067d52961aff8ac456b8aecf7e4e506697bf2e42ef65df57777c2f9164964efeca9cb42294f0e3b19ed2541202e3efad3817b3054d2b3c614002670ec3b9010c03210e137fefbf7c117bccfe8ad8109a6c82a92665718a168b8c1a0d04b85d3aaf0370461fa7f127c02cea0f00d3fd7b66c532dfedb1f1a86c0244887ed706bee4036475d389bfa6ecc9ca665cde9a5dcede52023faafdbbb7fc455d0081748f037edb13e2bd978c887debe1e24698b4c34c05a2cf8d4294d2d20d286515caf528d1e56d3f2b679cb974e9625e4a12e843cc4b5efef069740404f786224d79f570ef8f8b9ddcacea715fa76667c31a1dde9098ba0cb3abce3d1db38aa065d16c69779ce083704592827317618422fbf8c2efad29c2176d62a31ac924f611adb2631f83824861e80d3d74a15239c337e20fe459fc8afc8a64438ff80a5be2e5e4cb6e606f426cb95c0cd99bb270209a76c9dd4d09e805d2cfbb5b76b7e74d3775077550968a16589f3e9c08b43aa043a559e36d9e42e75aa48b5b5e8b9af1b3450e6554072aaaad0f6be9073d3c0c458891ef2b55fbde1b25b9a85503ac511c2a98a0feef4bcc405a7c524ed65a85e5908352ed68ce11ba4ca6f005ee5924bed44b4f9c07a3e2a341cdc00a8a51af063cd3353127751e0f1112f23ac8d04e0504bffd458ab83098d89ac5d368f7125f7d62dba9a702c28260027fab1dbad9643bdf7705e9115c64253361065cf54f4f4704677d900b55ca12d2778177c7dcdd725faf2594ff6cdc23f04caa952f3cf678ef90e2af7f64cf4a841e1ae4b5931f015e165d44b53551485bb76ee15b4254538ee96f07d8ec7438ed632c74bf4a035daf0a4008c4b9bd3c9080d1390d2b2c509194eb5d1ad80c08d752862e994474d2c335acf4b9ee7a0dbe08c12a95968dde39ad0e589a70ff6623b79389168a55d5398f8da3c4946763c6c4402c161cdefebd469fe750587d69406cab70982769cf31ab8cd447b47ef316693d21eb2495216427ace0b11ee6a4b79c149ac2b5eb66650e20f744d68009b8c7ffa045926451bfd002bd2189b6a5a48e2123e02e4bc8b3d8f1e99f423b4c0391cfb34635a549bb9e34c633807241b62e5cd3fe2af22d73426548b2a695052bbc1bb3e4c235e4da969bb664e9097e4227c2c11651ea685bc1320ed8881d0f3f2148fb5d5cfa8e05b37f2cb186bba9c67e3c73ef525637405d5627132bb6db7c13e8e879c509c3bbf8d668507eb8dc1e89bf394f40ace44b980d6110ec5205d47cb55a2c3f1b58fcea8d2d6d13fce1cf29485f20db4e32663a4879a2063ebbe94b8938ee145c10f341b5c85725b3f5c6c6fb90538f89207fdfd81d71b8c4c3a8da2b0607bbd01d5e22bb7ddaa196ddf64340081d6134daf249a2d262a3ce2182c908e68b63fb9486fef7d2579ac452b4d5a1246b22220272e2869b8e301bc4d45a55e4563464be768e9f90353d0b10387fd59902aa25cfd096f560f4f1e383aaeafd2cf33725d502b4bf57fd3040039e8deb34dd917369e45674d866d421a20e7f18a3008ff57a22b52f3d22c8d233e24b3b2662ee6da49c70017fa4e9103586a2617ba209d620b59c0db4f1ef33d5ec6352700cc6ba432416449efd47211a1a4a13cfc56890291f89a5f071b67871742ae0c850e1b1df42825b9c36b1a865b3d5e6c96212380dba34d57b7e991c45c66110c963b16f2dc86a25263406444ae304b822577d7dfb3f8944c5605e836cd4d65f161b0b5ba949bd33f426603675266f59b969988b4e6ca6ab84e1b1550cefea9bbcfe3125e6cded29dbe54e4abf93c49f6359d1068af44ce8d98870fa1cc9df085e898da3fa686ea5a27b21aec969b191f1e9a17fde928e6af4953a389cd6bce4f20770f6238dcf4030af56e88d9670146559ca87e06293657a878c40388378fdfb2db15292659d76c64b64adfbdec735f1fa8495e6dcdea051745946a7a17d301fe23900b58a4ef0c399be2b9c2efc1a92a26f083609281c29e3c78e5498ac24f674eeb29f93717950c0a18e487cd81873318b001699b65d44af8b8a2743ab7ebef5c7e3ce9e44f8a46aebd304645f7be3fdb278e8bfb0361983142fae3512d4c4fa4bc03f78e4ae90b9e0c7f7d2dae0695f8831bcb83c90f615427cf7c275f97a185dadfd296aae4e54fae8df500b94025a20f54635a45b7df3d5b77325b589ae4ab9a70b40a710136b764b67350b88f2a28bf66993a0f746b5ff0d5496c8f7a0f2b4ff5cee15ae60b02ba44bb7fb50d3c7da58193da56687e80361cb65110b6aa6eb7d8c37b49b913d7d2819897ce9ef66ca11d9355daf327287ecb23da8c38be4f8ade455fe1a8dc69b2e7cd86997c236166347229337bb3790d9f0c7e3804fb6ee1929ab8924a8ed04de3c1eecaa171843584ffc0577ddab262d519af2534da977b132ce70c458f17abca60acbb97834cc4d73b4b389d6ee7af257b9acc9e0e61f0105b1a8e59aa08ccb9be5cb54661bd4680eee14b7ebe392d5d92775edea8568c3f6c22caa865e8d2044d0fbe8adc74bae26bba0315bb85009fe9f15d2113d0961c6d030f73b14ac8706d8576ce3e5b020016b26dc7d5628612b282ae69a5146f68cfba847bdc8803b4066752b4310e7d8c0bd63680a50873677c46a7a18a50ea3dfd04a1b7c9a530d38cd16cbc43a01abdbe1dc38a3b3f6bf5e544b9f510bdd365a6440159b97346063fd46563bde79e7128f2fcb8e69a829d2dbb9ea670d75a6cba9e8797868bc204d15324fdade63a4bb5cc739dc0e781364b1c693389eca6435de7e1b5b4907221215a39ba34e4ab57e40429ee91075959c0e1fd85a7bd709ffc2c5548f3da00fcb142a84e34d2fce7c9c84343e3d48d3a2131aafc0ebc4eed6ce5931a6a5ba1810891e635d693b5abfe6725737777179dea04b0d01800125a61503ac69b7fda6fe9558c13d0da973c44ce32c4d54fb192234e2061f2a9dab6fd5dc714ad4243949582f4559172b74999c98b11adaea198b9dd163a1539f6804a70ae852264232adec8758fc2c0b2868adadab7130a01729c3b41db1016dd2b9a802035340cf604ef2c04442bcad9a53cf48cab65e04b6d9569c2aba3b4866fee69061d33494571f8f34a53e73ccd879ddfdebcbe70d24685e5821df613090188e571d48372a654f272c21a6422ae4828009b3856d928f6c506ce31e2cf8e8b1121fac9c8cf36fa5c5ab37855b07153965262002d06ae5e6404aea109ba763b23ae3f9bfaedcb887fcceacf407517f935b548156815d29b0bfac4646938d1a8da416074d824e0c5ef33da42f5f6741278e4660c7524ef8f48037a74069dca5aaf2422312ecc8205da66c0c078f39d8a3431331dfa0b72eef5dfdde0fa1bdf82482f333c6f9aad046b00fa970c3676193a9c9b0fb7be3d7e6634984fc80c907bfdeaec4f1144c506545e754aaf0e48b07d1a93a7ce2a76b495451a9e8fe69329b9eb677670cdc9c0fffccfced30e9c615b018d75db941f431695e39016efc11d6e3d59b0cb217e7f20b6b1f2e0781c1f37a4a09f997af015f8bd9b5fa5fcf60fab24c58d5ee58b1868ee6a517a15313b96268793602f39a7161b4d36f06482f3ae8b9a18e2f231a6c13a40efc6fc245e99a7a89a17ab0ca6fd383a2b842baa2b248d4273ed2e6f9bc6f2d4169b41465bb3a7109a3de42f563f5c928226bb1a726fcfda373896fe34faa6008e2e0f00eeaa104feb680ccebe47b5ecc49f8033f4688471c1ea0af0394b0c883d11474a5bbde658c9080678b0ecdc941445e20defaf062319ac35dabd75df9438b1a49fea980d1cfcc8e5bdca9222e079d10189909d84eb8c24c013ba18e0a773af97f94289652964627c0f6fb0734c8f02aa7330744fb3c6ae0262d6e7fbe52db0bb679bbe27e1af60e95fee6da421017fcc6071e81724af5294c29e337546284d118de60af5bff178cdf9a872b42856bc2772c986ae3fd5ef07d4f1301a814fbd8ebc499773e1cedbd72044b9c7b4440c1cb63282e466a5d432c94389ddc0348653f1d56a83eb7e50d399e547ce2026aff81658bf7b57d84e19449de1d428a4fa3cead0416c2d4a7071f9450db57573d42a9a4b879c32437fa213ebd0ee8c4240ff1abe50cf48fdcdea99743df32e0e2b1fdc5b483ee84500c6d1ad193ce23b247908ae1391d02af3d3c66ce9a40edca5a750f0c695227a3192b7a3a33cf7729073eda81708344a9633391825fcd4e52f90cab904ed0fa6259b9086bc7755650cffe6fd94cd65977ef8129813ba91e58d381faa47df5cff09baeb1096c3c2670011bf8ea4507827a7debe75753248d5e53b731ed5327c967ffe7ead18146abfaa17a3363cb95e313737da8504705e8450f4e1dfe50e47fb40cf2d118f0fbd95b3851141a7e47d06954f4207a0bc57d6bbfa6e259e4e4e22a3cbb425701c2316cb4a3be866aab0d18453f837edf074d2cedee793b76e1c788d0093ea855f6d352776066380fa3497a695fc7d9246531086cefe6325aaaa4720b774383a7780ed8f48cca927e06d2124bf765c73dff7c0e08bd73b33511811a55594eff2e9626a744c4e7fb844a8c2bf0286c65ca6702e1f7aa0f8ab5f62c0fac2497843987e838bbe48991d737e8482822d6bb6107bd53d4bfb84a02e8c8717f7cc6b5a53f9e239f8cdb61d15ce586ec02ca927250af9e2a9789e0903975df09b1a1839b8ee0088b113dfae9893c8e0b65526175395bddbc9bc6130cef2a0e005fe15bd001b310e040875d75128b2ddb63c3f04d7d9416e1eb2da9a4f875a5ef57f326f8ac302fffac8c39b87c2b251121d1d906b93ddc51c4c8ea00345716b8301473224dc507afea3552b169dc4b2fd961f27bcf2d6c76c2c2f2c01d84c41b85a45439747eaaacbfa787c0562d2f290d60adc4e3aee3068c5cc10d5f3b259572bbb698e86fb9ace1e96d200aa0d73d44648cfadfd31ad414099df2c4589d689447510cae04e31df5be18e8899dc7c26427b89edea1adde45f76da8e6cadfc4e42db3e12a7f8952f8a551061a44a214db664e4928d0c2a67365abff4aded5c59111821be9e24e37bc2aaf38e9240e883638acb3f2e8b15d01441185e31642022f09841b8008d71924c84238f19b19099c083cf63a9d7fe626c3bbb1e776217d73ba42e76bddec5959c28c45e959f292b55321cae18dc13b8d2a4602f869043d03f6e9815dcd9f37ad68d52e73022995665f76d91b53afd457fe8c3269829ed568282bb72718060fa886efeb4f5ddd24e77e519f4e9abea61141caa6e286b88504558f6a340e2ee808ff4601e8a14e647f7a8ed55da3b22148fbc0c89b308fc5c52386040cdfcab85d91494bd303e03ba7f634b71581c339b82128522cfeb2de97302da7adc2c1fe07653a80a56599eb6c82f8efecf013e35bf5fadbd90832567bacbe8619c5ce44df86fa814a4aa09125207be772c8496d4ab4c6bb2fa787d89528b8324145bec78bbb660ef2480579a7fe164bb52552176cd365c410bb130cdb3d1e6508e2ab788de996c9da07d33443a29bbb0695ecd1c5ab91174c88290cca489864d87070a3f5eb7da7cadfa1697aacae8d32c9b9ff449ba813615aa0ff2bab61af3cc32cb68782e4366a3fe92d629f079b1d1bf94969dc84db6aaf88db1c58b923812158e7f03b029b4147f2e8aee51213aa227d1bb118e2e213d76fff433e0b86a13510924eacabcca3da9b399f29ad852c5fabce1e1e452a74cd7fe0fa0d56e07a5caf679b89548974f039ab2a35b9fe27223b9056c5d9187eae902a93630409aef889a6ab7eb80e28bf06c4cc899e0f5047c7c4922eecf065f64b8e128226c09007797e87652ce10d68b5a2a76adf749967f552bcb72e43e3340085874d61c0b1d37d4ea466ff1c927699a04b570b9959fe5f624ca81eff25c8ba36bd5f084d35c84ff76570ed7a18b02f589ecca80571eda752e1c6b9ef632d6f589881a3c49d575128b324e63eec4f76a3a10c570192d6ab70780e072daf55528ca15af12d9121ae08d5522b4654afc61f77dde9846c729c6f1c27963210fddb5315d340495726cc8f6e13371a9b1e58d4782f30d01e44cd886441646727db95b5bdf6b48fa4e44f5b5385a83cab4c0aa8b7efaef6a3a0ea5fe31a10a1ced83aba04342c9fbee54136672895a332aea55f31c3e02f59031a873b69ecd43c4571720918efa92ab06b9ea8e986bd7d4d1b972339d6e32cd2e3b4e1f6a6d2dfa90946c9f7a2ef182f2ecb95ffcaaac3aa26f4e3e0dff056e0eb5d8b954bd87604853a8b233d5f3a256d215d5061af3ad934dcefccfa961db2ced4de5c4c975bf450a405c849457af0ec88bd5f39355536f6d1a9592d690e031af7a56cb3582064f4031d9654f9aa65a246f8624d61f4a8e82e89bfa2e0949d64053c663bbc3d8abba03055af4677c1802d23b0d55a8ac63d50b6cb7ea33a1535fa8f0acc5e2ff9e3a111ec45550f9fbb776c06f5c772a9d80151632de15104d7dfaad8e2ed7b1368c9e81082cc6466401ebe56baaf39bed7a040fc98420b4d5a792e96cf614573289ee23cbb6345865a822fa4ef112a548b9331d3aa1b445b9d61543e01eed29b15a8333ea361f000f0280f87868e1de04417093686381c6aafbce91a6adab8da33c7f287f2f698641577a14da23f2fd254c26ac696d2737763525ad59fa033ce42fb8d1555b4d4789db5b19147cc3729d4da803664557085388ad447a8cab95a5badb88e96439bd38e3f505fb3006f817d7907789b97188c2985763d7dad25b6a20027f365b6a8370fa4a50fbdcef45b96445d4a2b6ddf5a2e450b17a69a4237e0d29bf682b64a265d4b0cd7d8def137e470f5c22b81ba90e10e40ebfd80dc8700481e6c06d89fad724466df29cdf2a899d68faf7bcad05d7da19f28778b87364cdca97b9f874c5f73aa817c6b6bcc3596eff9cef1e8c6b9d8a6143f6045033475c1d272ad0c5cf57ded62ee3032137387fd8b582e3fe88255d668866fe4fb1029a52c91effb868e2b2cb906025b653db1e220383ba82ba8992fc23d8ac8214bc8940c3fe5f20892a9d290255d8a402ba6368f8974899cd0f3231762c0bbe5b640b84b6172e958908acc7bf6f0a01ecaa894a62b41fcdc4ebbeca8ed1d8ad9cfa05dce71e612d8b33589c5b148b7adbdad3cfcc81683aa218c9f9fe4be00433874bd37835ddfaf85f650e535eb304c646103c88549d9aa7021e9d82d55988bfee20a8cac976b29f5df7b01b52dccf74c149587bbf13dcb07a65b14db994a6e39055bbe60b9c2bef642386cbb42e918b9cbebbfe1c5b38d1c1ec7609e1cd1b77445c44cb077a807cb41e8b9b9b267aa763987be70db829df4653120d0e98fc41d42884d7db684cb4fc37791fa237de4944a4a2f4bf265d6a1a3645b0b80b07986c79b2f407861c5499646e432da4aaf6ada3f009077f25762961c701a6a988efecf119d173aca575541a89a838fb16376e43f22d589c67a5c59393d57946416a985f9f2c15369e06c68d178987dcba0656de90a5eb6c204efb73ba495a01197f68abaf8322d92fb8b73991ea9fa293a0ea50ef8f46696399bdfe43abbc4511707701e3178c6daec495d26b89e76dfc1237ebdc19ed83e6da7c3aaecc3f05d4bd80ba37ab00607da6abeb68c6736dd6d654cbb5bd6786789aeaf477899c64a513bdaad8f7f65df08ec0f83a2d8e3a867462747139441a8512e1da4ffcc11b7b7bfc36ce126225ba9daf766ccf2658687ec47611ee00fd9ee439f42ebf424a07e583ba2df14ce6b4d8c2eabcf3aa22c3b40caaca7c6a6df10d00acddfd4cdab8dc724d1f0cd4b4482c2bffa24e8a4dbc614a30082f5858a514a680cb5bc7e2eb9e43fe4c02e0ade0610996c244ef56502b870da5996256e54bf32804fd361b364b9e771248c1024a82b9878a00673abe509835ce16654c1676851009b23a7d6235ba258a24a8e59ffd63524f6c8f4e8b0898ff0925b656e8bc3fdc621b23d5fb559c9ee84028c15f7e9792f98130ca78a6d85606157c3f73b40d58929584f36c1147ca1ca4277f10aebf6baadfce5844349bfbffc8eafe3b7aa2030bcff0da6c0e99bba1d530b82fc430423e894c313743aed8180dc26af67adc477ded7e5de213b13c499010eddedeea31727b7a7c93dc995922ca62a91f2ee497b18c0f015e510cfa62ca10eca3d626a28c70f306253b9b13422d5e8465cadd095ff34bb1f664651907a8e468bf80a179b1beca893d63be59334709fa8a3849bc23645dcecd65d9024e3bd6ef7a2061da6387b3d655a6aee0813e0a4909e4540ecc20af0aee3ac24ea8fd0836a925a9d916ce4b12a861532bf48865341ebd821c75fa48267f1decd51666ae3fe09d9e1e74dad496aba68a79864deb67c873fff34783038793056a52a9995ed3a69147ac6a2ce01dd36cf05b34bc36c42f68e95602aec5bce4907e6ac1d11805b3303cb00a7d124a7d56e18a7b44218cc697fcbf5076ab953bb2fcdff65d10193cdf41760016fa3144437f87c1ebb3572ea880b9eba1481c4d647435a2f6aa9420d9231708b9951fefc837b004f9a1cc06606f87b8ccb1c3634366b26c883df22939ca36f2b2bb2ec207e2c6ed15aca43a66633e40430400ac121b27b2fdac0df8b05c2377e70b255f761e1483f0de629535b8c4411d2a65d5a18aee45a94ae85c0ad9f2e5febff9c9452ffd37a840cc3180957f14c1c367759d9aba611d6da4f57d4a03643d031f1db13cdedbb2fff50b303d17d93aaec8098589aed77e2f7a44ff1041183c9aa313fbff8d5ed8d673a908123e20ae169078f3ed3f655e1c6281ca72c61498689f02beb5285adc783ce345d0a5be34372f1d77bf6ab163033fe0aa1d785c539f84578ec8af996709360a46e77bd1feedc8125e3d243e4187cbcef3f9789c25fba29dd40bd40e398e9768c2181a550149b5af726baf747c0e81b4c49f2237fa6e12559a00433f49ea478e15fa8df205511f270edc7918e21cc894affe217e1b2faf7569186920ad25823ee3430c515d5f415b6ddfee8fe687a00dca41a64557551a57ef96bbeb1ce8bd09d60ee9d7f3dc6b6151b76a77dd306b74f6228d6f4dee9b1d3145d2a4fbd2f4c7b0b281a6f77c9631d57ddee872f524fda32c03bf8780335c1729fcc2d3e82199e7158a4823c3b613addddced3b699f361bd10458baed95566882dc7be7fee23dc134caf967835f7fdbd371acfbf51ed99abbad5131d87d9da4346ed30522b44cf58c1bc2639ddcadb3c8d803f1ed74b7da50960289bec51457dbb8d71126b9f24be2750884329bc87585d82c343dc4d7dd2779fbda02bb94f2291e35344b087990b78c4d902b0862beef3c5eaff5f086b02b94c397e5e16447d47b40f6f75810ff6a2526b20e442b6fa41364853b6de5bbe5e3244b9e83deb6c9c8d077b86b89eefddcb8ad645130d9a56c0419a0f0617130df6575844bbd67e32f8dc20aa4539aeefe76c98d63bd6399c45e74b4f32191d7df411fd351b6c96a4ae35dc6cf5e698fa871d37f862df7a821a8590fe548e49b7fef7a97d0b73329c02bf5bd93b2722004f9aeebf090842a72fbbc5eae2f3f808c28500bc76855d5ae1d603873d43e2b7f3c88cd44ff0e9dfcc71bc359b1b152208eba979d174432732eb83c2f5eee8fb1f3d6bb9c949614495d172237f0d4069925639d1943a4e9152d4bf27f32d0e1842446c8e6ec41b3e99861b763fefa556ea646117f3e465730edbca44d9a38a3c91e77ed35b8f525e7e95fd27ba11c982c977e24d0b81d2ca62e3257069db8e0447d9f03fa0d7d2da218da08c186a107949a1173641ccd0cba14e64ebc973db6fed2774edcb21ec40c5259b0d7d0fa7935228e01004af80f31cbeba4741eecf256336f235f4f662f8f65633c46a9fb1b0fee890361be38674d741e3128aaca1a9856ab23c6d36199594fff0b32c2294f06066d2c6628ab468950d39e5af2cacbfff3ada4c12520264a03f0aee8a4a99b7bff53dd0afe6fb232300cb744cc114ec4bf2abaab136832d269270514fb35eb3d799d5bf4e9c51bcd869671135b04dd7ac490664c477cab85aa2f5924b50db95ba4516abd99cb4ac0d86c0b59e1e4cf33865330bb771678b18d97bf4b7ce1790ec8f9cb7a41152b7253be0327c7c1444f4ea2944edc34afcccf1908306f28bdf11f9b38b488c6bcdc83fd7e9c4ea08e8925659c7eb7b4b8661abf47d7d366636d74377e4bbef4d9f2de69929869cb630417cba563bf0ea738907f27249eb8482055dd4d62def10bd96324b3bff191c248b81d6380752e821e671e9a2133d6081f0680081aa65f63a577e82fc454e400fef7bffd011364ad2cec0388192df18cecbf63427efd0524ddbc4dfd8aedfb0f4f9dfd83d86d0922cac599fc0818d664c2d4f1ae4ca9e63da09ada739bf1b823f54f43f187da8e1e0c118c10d163d1106080cfab54b43891f5f1b767b09c0bf5f7f815e4a33bd05263ec00901cafb5969bfabcb1a7e193836b79b64c362088ce0cecbbc4df30eac7c9e665aa0e0ed3ee4159a819b9706f2cf6bcb265538e6fbdaa86a1d86949c4204c438cc1bab96fe35c583fc2acafc26009af56c085cc3997854d3afdae44eb9f7862b88ea05eb6b7f11cb86bc2b7e9df144656456b10919f248ff49e915787456e653d95d47346061873bafa4260ac217f655e2ddd677e90d70198f075bf82e12ef44d5f6e7535be3ea31363b2447ba4ad29eac505a743ac99a2fd3a940a1e675b75fb44b5cf7d544d6f43d27b9442460852c3768cca734b46608da3320b2b37af13910277c7b8c0aff07b34f6bd3d4b7e1971df4b9f328fe6fdfc1fef350ab8d1c5bb876bcf2a0609fbf06b2bef0627463b4b38d646b008cb41b07b92eead5c55ac4c79fe73f7c2cd5db2408182cd92888f873c17bb70f9ab4c511c7bbfa5cade29aa8b8dd6d9bdd514ef7bfc63d3151e1b5ccbebbfe4dc188c536d39e16ceb1defa2529637c489bc6328f1ecd0e00d4ee284ce367c5471d524feb729e742f364480798afd06e0fb3bf557b6abe7c6c1eda9dea3ea73841343353049d30fbdd68814d22937d84765f1eceb187729b9556316e69e5d691b7782b685951feecc1ace8179f06b93dec83a349e50129430bff9a789bc9e8bb032e3e40af656a679aaf860b37e9205919993fc8093c6e60efe1f5a6f038c3c8c39a9288f0cdf34cf494d5db203925abad04a6233b93a31a15aca9a43eb517a58b183bb5377902bf02ae381bd8cc5fc640f0c0efdfe547b75b5bc335a4e40bb2dcf09253a6889dcbf9d2b85d90e84618a7ff0ecdc85b0baaaf8814fba9d769ca8dfc3b73918af42eb95c56031976da76d2a2dc39589159d0794d72683c360115f62af1d343aa50c6d73afe0e2e451e2bdda7a3e5bc40a4adf93d35a17bcf4a07b057be867340d42af559f57f999068fab54f82546ece896ac5c87a3302d029f38a43ca3998d3a3da426ad3f6fc6a3b6a239b2138b9e150e8ed783219c3e2e979a7c19a69fa1af89a1429fe74c0375977191336ab642528af92a37b081939d12ab14ddfca3d0933ae40a06d925fda3144f9a37e2845de2114fb00adaaa081c481c8a5c5e101cb1650a2240f3b4674ab992564a6ff63f65710f63e235c2fbbcf131ac40f36f41e47934562347b81aa245470d26587097fb78798dc4a2015b2891004fff722b1bf97ca6dbed9a90aedffdb6488d45cdc349e6916e00e6bcbd55f4fd92a94f71e2c26d87086b3ddfbe0be1ef90fd67e0831d419da40851f7734ede9f019fb14eea9994336b33f61aa92666260219c493c9ef27cd337503239314c8c7061f4f02e84d85ff01d914c0b054603626354878c64d55cae449cc0e38680790391c14b949c1202b256976c8ff93c33bd59869a2a560ded243e7f99de08cce9f3bc9f96de8bb622ba894751189576d5e28eb66177f28b2dd3e527704154679a3f5ac64640e40a564cfea3cecc19a56e968ab980528753b41cb4e9a0e51428dc7ed3891bb25b6d02ec7261ad6285852671d1306ff379757fef5a2f20d57298014b99bdaa30e3788befbdcf0618e62c97e85fc73170ffe82f1fff1527de376a1515b6f9da430214cb04bacb096573e78d71dfc2c64ee67fd3fe20f044e3162a86b9a08b5779bf668abdf2a0f7312bc2445f20494ce00f9bf5e13d0025689daa911a2de3b155a84f95ae42178b153552e219a2c3735fdd81c6aa12d4e36a4cdb1043b63cbc7b480598377267</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsè¿ç»´ç¯‡</title>
    <url>/2019/10/22/jenkins%E8%BF%90%E7%BB%B4%E7%AF%87/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="jenkins-å¯è§†åŒ–æ„å»º"><a href="#jenkins-å¯è§†åŒ–æ„å»º" class="headerlink" title="jenkins å¯è§†åŒ–æ„å»º"></a>jenkins å¯è§†åŒ–æ„å»º</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ä¹‹å‰é‡åˆ°è¿‡å¼€å‘æäº¤ä»£ç åï¼Œå®Œå…¨ä¸ç®¡æäº¤çš„ä»£ç æ˜¯å¦å‘å¸ƒæˆåŠŸï¼ŒåŠæ—¶åæ¥åŠ å…¥äº†ä¼ä¸šå¾®ä¿¡çš„å‘Šè­¦æœºåˆ¶ï¼Œä½†æ˜¯ä¾ç„¶æœ‰äººä¸ä¼šå»å…³æ³¨è¿™ä¸ªã€‚<a id="more"></a> åªæœ‰åœ¨æµ‹è¯•äººå‘˜åœ¨åé¦ˆxxxä½ çš„ä»£ç æäº¤äº†æ²¡æœ‰ï¼Œè¿™æ—¶å€™ç ”å‘äººå‘˜æ‰å›å»çœ‹ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªè§¦å‘æ„å»ºå¤±è´¥äº†ï¼Œæ‘†åœ¨é‚£é‡Œå¾ˆä¹…ï¼Œå¦‚æœ‰ä¸‹ä¸€ä¸ªå¼€å‘äººå‘˜è¦å¯¹è¿™ä¸ªå·¥ç¨‹ä¿®æ”¹æäº¤çš„æ—¶å€™å‘ç°è¿‡ä¸äº†ï¼Œè¿™æ—¶å€™å†æ¥è§£å†³ï¼Œæˆæœ¬å°±æœ‰ç‚¹å¤§ã€‚è¿™é‡Œå¯ä»¥å€ŸåŠ©çœ‹æ¿çš„å½¢å¼è®©ç ”å‘äººå‘˜å¯ä»¥éšæ—¶å…³æ³¨åˆ°è‡ªå·±çš„æäº¤çš„å·¥ç¨‹ï¼Œç»“åˆå‘Šè­¦æ¥åšï¼Œæ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚</p><h4 id="æ’ä»¶å®‰è£…"><a href="#æ’ä»¶å®‰è£…" class="headerlink" title="æ’ä»¶å®‰è£…"></a>æ’ä»¶å®‰è£…</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®‰è£…Build Monitor View æ’ä»¶ï¼Œç„¶ååœ¨ä¸»é¡µé¢æ·»åŠ <code>+</code>ä¸€ä¸ªè§†å›¾<br><img src="https://img.xxlaila.cn/1571707794737.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥æ ¹æ®jobçš„ç±»å‹æˆ–è€…æ ¹æ®è‡ªå·±çš„æ¡ä»¶è¿›è¡Œ<a href="https://xxlaila.github.io/2019/08/09/jenkins-job%E7%AE%A1%E7%90%86/" target="_blank" rel="noopener">è¿‡æ»¤job</a>æ¥ç”Ÿæˆçœ‹æ¿ã€‚</p><ul><li>Build Monitor - View Settings: æ ¹æ®jobçš„ä¸€äº›çŠ¶æ€æ¥è¿›è¡Œæ’åº<br><img src="https://img.xxlaila.cn/1571708048469.jpg" alt="img"></li></ul><h3 id="jenkins-ç›‘æ§"><a href="#jenkins-ç›‘æ§" class="headerlink" title="jenkins ç›‘æ§"></a>jenkins ç›‘æ§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰æ—¶å€™æˆ‘ä»¬æ²¡æœ‰ç›‘æ§ï¼Œä½†æ˜¯æœ‰æ—¶å€™éœ€è¦çœ‹çœ‹jenkinsçš„ä¸€äº›ç›‘æ§ä¿¡æ¯ï¼Œå¦‚ï¼šå†…å­˜ã€cpuã€ç³»ç»Ÿè´Ÿå€ºã€httpå“åº”æ—¶é—´ã€ç³»ç»Ÿè¿›ç¨‹æ•°ã€çº¿ç¨‹æ•°ç­‰ï¼Œæœ‰æ‡’å¾—å®‰è£…ç›‘æ§ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å€ŸåŠ©jenkinsè‡ªå¸¦çš„ä¸€ä¸ªæ’ä»¶<code>Monitoring</code>ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ’ä»¶å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç³»ç»Ÿç®¡ç†èœå•ä¸‹é¢çœ‹åˆ°<code>Monitoring of Jenkins master</code><br><img src="https://img.xxlaila.cn/1571708499625.jpg" alt="img"></p><p>ç‚¹å‡»è¿›å…¥ä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571708561404.jpg" alt="img"><br>é¡µé¢æ˜¾ç¤ºä¹±ç ï¼Œè¿™ä¸ªå¯ä»¥è‡ªå·±googleè§£å†³</p><h3 id="Build-Trigger-Badge"><a href="#Build-Trigger-Badge" class="headerlink" title="Build Trigger Badge"></a>Build Trigger Badge</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤æ’ä»¶ç›´æ¥åœ¨æ„å»ºå†å²è®°å½•ä¸­æ˜¾ç¤ºä»£è¡¨æ„å»ºåŸå› çš„å›¾æ ‡ã€‚å®ƒå¯ä»¥è®©æ‚¨å¿«é€ŸçŸ¥é“æ˜¯å“ªä¸ªåŸå› è§¦å‘äº†æ„å»ºã€‚å¦‚æœæ²¡æœ‰æ­¤æ’ä»¶ï¼Œæ‚¨æœ‰æ—¶å¯èƒ½ä¼šæƒ³çŸ¥é“æ˜¯ä»€ä¹ˆè§¦å‘äº†æ„å»ºå†å²ä¸­æ˜¾ç¤ºçš„&gt;&gt;ç‰¹å®šæ„å»ºã€‚è¦çŸ¥é“è¿™ä¸€ç‚¹ï¼Œæ‚¨å¿…é¡»å•ç‹¬æ‰“å¼€æ¯ä¸ªé“¾æ¥ï¼Œè¿™å¯èƒ½å¾ˆéº»çƒ¦ã€‚<br><img src="https://img.xxlaila.cn/1572059619062.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineè¯­æ³•</title>
    <url>/2019/10/21/pipeline%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><h3 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ€è¿‘åœ¨æµ‹è¯•k8sä¸Šçš„ci/cdï¼Œä¹‹å‰çš„ci/cdå…¶å®ä¹Ÿèƒ½æ»¡è¶³ç›®å‰å…ˆä¸šåŠ¡çš„éœ€æ±‚ï¼Œä½†æ˜¯æƒ³å°è¯•æ”¹è¿›ä¸€ä¸‹ï¼Œä¼˜åŒ–ä»¥å‰çš„jobï¼Œå¸Œæœ›åœ¨ç™»å½•ciçš„æ—¶å€™æ›´åŠ çš„ç®€æ´ï¼Œ<a id="more"></a> è€Œä¸”æŸ¥æ‰¾jobçš„æ—¶å€™ï¼Œç‚¹å‡»ä¸€ä¸ªjobå°±èƒ½æŸ¥çœ‹å®Œæ•´çš„ä¿¡æ¯ï¼Œä¸éœ€è¦jobä¹‹é—´çš„æ¥å›åˆ‡æ¢ï¼Œç­‰ç­‰å„ç§ç†ç”±ï¼ŒğŸ˜ğŸ˜ã€‚è¿™é‡Œä½¿ç”¨jenkins pipelineï¼Œèµ·åˆæµ‹è¯•çš„æ—¶å€™ä½¿ç”¨pipelineï¼Œæ²¡é—®é¢˜ä»¥åï¼Œä½¿ç”¨jenkinsfileã€‚</p><h3 id="pipeline-å¸¸ç”¨ä»‹ç»"><a href="#pipeline-å¸¸ç”¨ä»‹ç»" class="headerlink" title="pipeline å¸¸ç”¨ä»‹ç»"></a>pipeline å¸¸ç”¨ä»‹ç»</h3><h4 id="æ¸…ç†å†å²build"><a href="#æ¸…ç†å†å²build" class="headerlink" title="æ¸…ç†å†å²build"></a>æ¸…ç†å†å²build</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ™®é€šjobçš„æ—¶å€™æ¸…ç†å’Œä¿ç•™å†å²jobçš„build å¾ˆç®€å•ï¼Œå‹¾å‹¾å°±å¯ä»¥å•¦ï¼Œä½†æ˜¯pipelineå°±çš„ä½¿ç”¨ä¸€ä¸‹æ–¹å¼ï¼Œè€Œä¸”è¿˜çš„å†™åœ¨æœ€å‰é¢ï¼Œä¸ç„¶è¯†åˆ«ä¸äº†ï¼Œä¼šæŠ¥é”™çš„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        buildDiscarder(logRotar(numToKeepStr: <span class="string">'8'</span>))</span><br><span class="line">        disableConcurrentBuilds()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>buildDiscarder: ä¿æŒæ„å»ºçš„æœ€å¤§ä¸ªæ•°</li><li>disableConcurrentBuilds: ç¦æ­¢å¹¶å‘æ„å»º</li></ul><p>è¯¦ç»†å‚æ•°:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">buildDiscarder(logRotator(numToKeepStr: <span class="string">'8'</span>, artifactNumToKeepStr: <span class="string">'8'</span>, daysToKeepStr: <span class="string">'8'</span>, artifactDaysToKeepStr: <span class="string">'7'</span>))</span><br></pre></td></tr></table></figure><ul><li>artifactDaysToKeepStr: å‘å¸ƒåŒ…ä¿ç•™å¤©æ•°</li><li>artifactNumToKeepStr: å‘å¸ƒåŒ…æœ€å¤§ä¿ç•™#ä¸ªæ„å»º</li><li>daysToKeepStr: ä¿æŒæ„å»ºçš„å¤©æ•°</li><li>numToKeepStr: ä¿æŒæ„å»ºçš„æœ€å¤§ä¸ªæ•°</li></ul><h4 id="gitlabäº‹ä»¶è§¦å‘"><a href="#gitlabäº‹ä»¶è§¦å‘" class="headerlink" title="gitlabäº‹ä»¶è§¦å‘"></a>gitlabäº‹ä»¶è§¦å‘</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰çš„æˆ‘ä»¬çš„ci/cdéƒ½æ˜¯å¼€å‘æäº¤åˆ°æŸä¸€ä¸ªåˆ†æ”¯ï¼Œç„¶åjenkinsä¼šè‡ªåŠ¨è§¦å‘ç¼–è¯‘ã€å‘å¸ƒï¼Œè€Œä¸”é…ç½®è¿™ä¸ªæ­¥éª¤ä¹Ÿéœ€è¦å¥½å‡ æ­¥æ‰èƒ½å®ç°ï¼Œä½†åœ¨pipelineä¸­ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç å½¢å¼æœ€è¿™ç§è§¦å‘å™¨(å‹¾å­)è¿›è¡Œé…ç½®ã€‚è¿™æ ·è®©æ¯ä¸ªé¡¹ç›®éƒ½å’Œjenkinsè¿›è¡Œè€¦åˆï¼›è¿ç»´äººå‘˜åªéœ€è¦ä¸“æ³¨çš„ç»´æŠ¤Jenkinsfileï¼Œåˆ›å»ºå¯¹åº”çš„é¡¹ç›®å³å¯ã€‚gitlabè§¦å‘jenkinsçš„æ„å»ºéœ€è¦ä¾èµ–Gitlabæ’ä»¶ã€‚è¿™é‡Œéœ€è¦è‡ªè¡Œå®‰è£…</p><ul><li><p>æ¥å—å›ºå®šçš„åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">        gitlab(triggersOnPush: <span class="literal">true</span>,</span><br><span class="line">              triggersOnMergeRequest: <span class="literal">true</span>,</span><br><span class="line">              branchFilterType: <span class="string">"NameBasedFilter"</span>,</span><br><span class="line">              includeBranchesSpec: <span class="string">"dev,test,master"</span>,</span><br><span class="line">              secretToken: <span class="string">"<span class="variable">$&#123;env.git_token&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>triggerOnPush: å½“Gitlabè§¦å‘pushäº‹ä»¶æ—¶ï¼Œæ˜¯å¦æ‰§è¡Œæ„å»º</p></li><li><p>triggerOnMergeRequest: å½“Gitlabè§¦å‘mergeRequestäº‹ä»¶æ—¶ï¼Œæ˜¯å¦æ‰§è¡Œæ„å»º</p></li><li><p>branchFilterType: åªæœ‰ç¬¦åˆæ¡ä»¶çš„åˆ†æ”¯æ‰ä¼šè§¦å‘æ„å»ºï¼Œå¿…é€‰ï¼Œå¦åˆ™æ— æ³•å®ç°è§¦å‘ã€‚</p><ul><li>All: æ‰€æœ‰åˆ†æ”¯</li><li>NameBasedFilter: åŸºäºåˆ†æ”¯åè¿›è¡Œè¿‡æ»¤ï¼Œå¤šä¸ªåˆ†æ”¯åä½¿ç”¨é€—å·åˆ†éš”<ul><li>includeBranchesSpec: åŸºäºbranchFilterTypeå€¼ï¼Œè¾“å…¥æœŸæœ›åŒ…æ‹¬çš„åˆ†æ”¯çš„è§„åˆ™</li><li>excludeBranchesSpec: åŸºäºbranchFilterTypeå€¼ï¼Œè¾“å…¥æœŸæœ›æ’é™¤çš„åˆ†æ”¯çš„è§„åˆ™</li></ul></li><li>RegexBasedFilter: åŸºäºæ­£åˆ™è¡¨è¾¾å¼å¯¹åˆ†æ”¯åè¿›è¡Œè¿‡æ»¤<ul><li>sourceBranchRegex: å®šä¹‰æœŸæœ›çš„é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼é™åˆ¶çš„åˆ†æ”¯è§„åˆ™</li></ul></li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰€ä»¥åˆ†æ”¯ä¸é˜è¿°ï¼Œå…¶ä»–çš„ä¸¤ä¸ªé€‰é¡¹æ˜¯æœ€å®ç”¨çš„ï¼Œæˆ‘ä»¬åœ¨æ­£å¼ä½¿ç”¨çš„æ—¶å€™ä¸€å®šä¼šç”¨åˆ°è¿™ä¸ªï¼Œä¸Šé¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªæ¥å—å›ºå®šçš„å‡ ä¸ªåˆ†æ”¯</p><ul><li>åŒ¹é…çš„æ–¹å¼<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">        gitlab(triggersOnPush: <span class="literal">true</span>,</span><br><span class="line">              triggersOnMergeRequest: <span class="literal">true</span>,</span><br><span class="line">              branchFilterType: <span class="string">"RegexBasedFilter"</span>,</span><br><span class="line">              sourceBranchRegex: <span class="string">"dev.*"</span>,</span><br><span class="line">              secretToken: <span class="string">"<span class="variable">$&#123;env.git_token&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œçš„git_tokenéœ€è¦åœ¨jenkinsçš„å…¨å±€å˜é‡é‡Œé¢æ·»åŠ ä¸€ä¸ª<code>Environment variables</code>å¯¹åº”çš„ä¸€ä¸ªé”®å€¼å³å¯ã€‚</p><p><strong>æ³¨</strong>: æ‰€æœ‰çš„è§¦å‘å™¨éƒ½éœ€è¦å…ˆæ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ï¼Œè®©jenkinså®¶åœ¨å…¶ä¸­çš„é…ç½®ï¼Œå¯¹åº”çš„æŒ‡ä»¤æ‰ä¼šç”Ÿæ•ˆã€‚</p><ul><li><p>jenkins éªŒè¯<br><img src="https://img.xxlaila.cn/1571644117201.jpg" alt="img"></p></li><li><p>gitlabéªŒè¯<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éœ€è¦å°†é¡¹ç›®å›è°ƒåœ°å€å†™å…¥åˆ°Gitlabé’©å­å½“ä¸­æ‰å¯ä»¥ã€‚ç»è¿‡æµ‹è¯•ä¸€ä¸ªpipelineçš„jobå¯ä»¥ç®¡ç†å¤šä¸ªåˆ†æ”¯çš„è§¦å‘ï¼Œé¿å…ä¹‹å‰çš„æ¯ä¸€ä¸ªåˆ†æ”¯çš„jobè¿›è¡Œè§¦å‘ã€‚</p></li></ul><h4 id="parameters-æ¨¡å—"><a href="#parameters-æ¨¡å—" class="headerlink" title="parameters æ¨¡å—"></a>parameters æ¨¡å—</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥æ¨¡å—éœ€è¦å®‰è£…ï¼ŒparametersæŒ‡ä»¤æä¾›ç”¨æˆ·åœ¨è§¦å‘Pipelineæ—¶åº”æä¾›çš„å‚æ•°åˆ—è¡¨ã€‚è¿™äº›ç”¨æˆ·æŒ‡å®šçš„å‚æ•°çš„å€¼é€šè¿‡è¯¥paramså¯¹è±¡å¯ç”¨äºPipelineæ­¥éª¤ã€‚ç ”å‘ç»å¸¸ä¼šæœ‰æ‰“å‡ºä¸€ä¸ªç‰¹æ€§åˆ†æ”¯ï¼Œè¿™ä¸ªåˆ†æ”¯ç”¨äºhotfixï¼Œè¿™ä¸ªæ—¶å€™å°±è¦ç»™ç ”å‘æäº¤ä¸€ä¸ªå¯ä»¥é€‰æ‹©çš„åˆ†æ”¯ï¼Œç„¶ä»–ä»¬å»éƒ¨ç½²åˆ°å¯¹åº”çš„ç¯å¢ƒã€‚</p><ul><li><p>å­—ç¬¦ä¸²å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥åœ¨Jenkins UIä¸Šè¾“å…¥å­—ç¬¦ä¸²ï¼Œå¸¸è§ä½¿ç”¨è¿™ä¸ªå‚æ•°çš„åœºæ™¯æœ‰ï¼Œç”¨æˆ·åï¼Œæ”¶ä»¶äººé‚®ç®±ï¼Œæ–‡ä»¶ç½‘ç»œè·¯å¾„ï¼Œä¸»æœºåç§°çš„æˆ–è€…urlç­‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    string(name: <span class="string">'DEPLOY_ENV'</span>, defaultValue: <span class="string">'staging'</span>, description: <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¸ƒå°”å€¼å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå¸ƒå°”ç±»å‹å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥åœ¨Jenkins UIä¸Šé€‰æ‹©æ˜¯è¿˜æ˜¯å¦ï¼Œé€‰æ‹©æ˜¯è¡¨ç¤ºä»£ç ä¼šæ‰§è¡Œè¿™éƒ¨åˆ†ï¼Œå¦‚æœé€‰æ‹©å¦ï¼Œä¼šè·³è¿‡è¿™éƒ¨åˆ†ã€‚ä¸€èˆ¬éœ€è¦ä½¿ç”¨å¸ƒå°”å€¼çš„åœºæ™¯æœ‰ï¼Œæ‰§è¡Œä¸€äº›ç‰¹å®šé›†æˆçš„è„šæœ¬æˆ–åˆ™å·¥ä½œï¼Œæˆ–è€…äº‹åæ¸…é™¤ç¯å¢ƒï¼Œä¾‹å¦‚æ¸…æ¥šJenkinsçš„workspaceè¿™æ ·çš„åŠ¨ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    booleanParam(name: <span class="string">'DEBUG_BUILD'</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€‰æ‹©å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€‰æ‹©ï¼ˆchoiceï¼‰çš„å‚æ•°å°±æ˜¯æ”¯æŒç”¨æˆ·ä»å¤šä¸ªé€‰æ‹©é¡¹ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªå€¼ç”¨æ¥è¡¨ç¤ºè¿™ä¸ªå˜é‡çš„å€¼ã€‚å·¥ä½œä¸­å¸¸ç”¨çš„åœºæ™¯ï¼Œæœ‰é€‰æ‹©æœåŠ¡å™¨ç±»å‹ï¼Œé€‰æ‹©ç‰ˆæœ¬å·ç­‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    choice(name: <span class="string">'ENV_TYPE'</span>, choices: [<span class="string">'dev'</span>, <span class="string">'test'</span>, <span class="string">'product'</span>], description: <span class="string">'dev env test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“ç„¶parametersæ¨¡å—æˆ‘ä»¬ç”¨çš„æœ€å¤šçš„æ˜¯åœ¨æ‰‹åŠ¨çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»è¿›è¡Œæ„å»ºéƒ¨ç½²ï¼Œè‡³äºå…¶ä»–çš„ç›®å‰æˆ‘æš‚æ—¶æœªç”¨åˆ°</p><ul><li>é€‰æ‹©åˆ†æ”¯éƒ¨ç½²<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;label <span class="string">'agent-node'</span>&#125;</span><br><span class="line">    parameters &#123;</span><br><span class="line">        gitParameter branchFilter: <span class="string">'origin/(.*)'</span>, defaultValue: <span class="string">'dev'</span>, name: <span class="string">'BRANCH'</span>, <span class="built_in">type</span>: <span class="string">'PT_BRANCH'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'gitlib code'</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                git branch:<span class="string">"<span class="variable">$&#123;params.BRANCH&#125;</span>"</span>, credentialsId:<span class="string">'gitlabUser'</span>, url: <span class="string">"http://gitlab.xxlaila.cn/xxx/kxl-eureka.git"</span></span><br><span class="line">                script &#123;</span><br><span class="line">                    build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>parameters<a href="https://wiki.jenkins.io/display/JENKINS/Git+Parameter+Plugin" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a>ï¼Œä»‹ç»å¾—æŒºè¯¦ç»†çš„ï¼Œ<a href="https://mohamicorp.atlassian.net/wiki/spaces/DOC/pages/136740885/Triggering+Jenkins+Based+on+New+Tags" target="_blank" rel="noopener">è¾…åŠ©å‚è€ƒ</a><br><img src="https://img.xxlaila.cn/1571651950634.jpg" alt="img"></p><ul><li>è¿˜å¯ä»¥å†™æˆ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    gitParameter(</span><br><span class="line">        branch: <span class="string">''</span>,</span><br><span class="line">        branchFilter: <span class="string">'origin/(.*)'</span>,</span><br><span class="line">        defaultValue: <span class="string">'dev'</span>,</span><br><span class="line">        description: <span class="string">'test code'</span>,</span><br><span class="line">        name: <span class="string">'BRANCH'</span>,</span><br><span class="line">        quickFilterEnabled: <span class="literal">false</span>,</span><br><span class="line">        selectedValue: <span class="string">'NONE'</span>,</span><br><span class="line">        sortMode: <span class="string">'NONE'</span>,</span><br><span class="line">        tagFilter: <span class="string">'*'</span>,</span><br><span class="line">        <span class="built_in">type</span>: <span class="string">'PT_BRANCH'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå½“è¿™é‡Œè®¾ç½®äº†å¯ä»¥é€‰æ‹©åˆ†æ”¯çš„æ—¶å€™ï¼Œç„¶ååœ¨ä¹‹å‰çš„è‡ªåŠ¨è§¦å‘å°±ä¼šæœ‰é—®é¢˜ï¼Œå°±æ˜¯åœ¨å»åˆ†æ”¯æ‹‰å»ä»£ç çš„æ—¶å€™å°±ä¸€åªæ˜¯devåˆ†æ”¯ï¼Œè€Œä¸æ˜¯å…¶ä»–çš„åˆ†æ”¯ï¼Œè¿™é‡Œä»ç„¶åœ¨æ¢ç´¢çš„æµ‹è¯•ä¸­ã€‚<br>ç¼–è¾‘jobå¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571903055002.jpg" alt="img"></p><h3 id="å¤šåˆ†æ”¯pipeline"><a href="#å¤šåˆ†æ”¯pipeline" class="headerlink" title="å¤šåˆ†æ”¯pipeline"></a>å¤šåˆ†æ”¯pipeline</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æŒ‰ç…§ä¸Šé¢çš„åˆè¦æ”¯æŒç”¨æˆ·å¯ä»¥é€‰æ‹©åˆ†æ”¯ï¼Œåˆè¦é€‚åˆè‡ªåŠ¨è§¦å‘åŠŸèƒ½ã€‚ç”¨å•åˆ†æ”¯pipelineæ¥ç®¡ç†é¡¹ç›®ï¼Œåˆè¦å›åˆ°æˆ‘ä»¬æœ€åˆçš„æ¨¡å¼ï¼Œè€Œåœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åˆ°å¤šåˆ†æ”¯åŒæ—¶è¿›è¡Œå¼€å‘ã€‚è¿™æ ·å°±æ»¡è¶³äº†æˆ‘ä»¬çš„å®é™…éœ€æ±‚ã€‚å¤šåˆ†æ”¯ä»»åŠ¡è¿™é‡Œä¸åšè¿‡å¤šçš„è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œé˜è¿°ä¸¤ä¸ªåŠŸèƒ½ç‚¹ï¼›åˆ†åˆ«æ˜¯åˆ†æ”¯çš„æ‰«æç­–ç•¥å’Œå­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)ã€‚</p><h4 id="åˆ†æ”¯çš„æ‰«æç­–ç•¥"><a href="#åˆ†æ”¯çš„æ‰«æç­–ç•¥" class="headerlink" title="åˆ†æ”¯çš„æ‰«æç­–ç•¥"></a>åˆ†æ”¯çš„æ‰«æç­–ç•¥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ†æ”¯æ‰«ææ˜¯jenkinsæ ¹æ®ä¸€å®šçš„ç­–ç•¥å»ä»£ç ä»“åº“æ‰«æåˆ†æ”¯ï¼Œå¦‚æœæœ‰æ–°åˆ†æ”¯å°±åˆ›å»ºä¸€ä¸ªä»¥æ–°åˆ†æ”¯å‘½åçš„ä»»åŠ¡ï¼Œå¦‚æœå‘ç°åˆ†æ”¯è¢«åˆ é™¤ï¼Œå°±åˆ é™¤å¯¹åº”çš„jenkinsä»»åŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨â€æ‰«æå¤šåˆ†æ”¯æµæ°´çº¿è§¦å‘å™¨(Scan Multibranch Pipeline Triggers)â€ä¸‹æœ‰ä¸€ä¸ª: Periodically if not otherwise runï¼ˆæ²¡æœ‰æ‰‹åŠ¨è§¦å‘ï¼Œå°±å®šæœŸæ‰«æåˆ†æ”¯ï¼‰ã€‚é€‰æ‹©æ­¤é¡¹ï¼Œè®¾ç½®ä¸€ä¸ªæ‰«æé—´éš”æ—¶é•¿ã€‚å¯ä»¥æ ¹æ®é¡¹ç›®åˆ†æ”¯çš„é¢‘ç¹ç¨‹åº¦è®¾ç½®å‘¨æœŸçš„é•¿çŸ­ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡é¡µé¢æ‰‹åŠ¨è§¦å‘jenkinsè¿›è¡Œæ‰«æã€‚<br><img src="https://img.xxlaila.cn/1571973819297.jpg" alt="img"></p><h4 id="å­¤å„¿é¡¹ç­–ç•¥-Orphaned-Item"><a href="#å­¤å„¿é¡¹ç­–ç•¥-Orphaned-Item" class="headerlink" title="å­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)"></a>å­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥åŠŸèƒ½æ˜¯åœ¨ä»£ç ä»“åº“ä¸­åˆ é™¤äº†releaseåˆ†æ”¯ï¼Œé‚£ä¹ˆåœ¨å¤šä»»åŠ¡é¡µé¢ä¸Šï¼Œè¯¥åˆ†æ”¯åœ¨jenkinsä¸Šçš„ä»»åŠ¡ä¹Ÿåº”è¯¥å¯¹åº”åˆ é™¤ã€‚ä»€ä¹ˆæ—¶å€™åˆ é™¤ï¼Œå–å†³äºä¸‹æ¬¡åˆ†æ”¯æ‰«ææ—¶é—´ã€‚å¦‚æœä»£ç ä»“åº“ä¸­çš„åˆ†æ”¯è¢«åˆ é™¤ï¼Œè€Œjenkinsä¸Šå“åº”çš„ä»»åŠ¡æ²¡æœ‰è¢«åˆ é™¤ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°±æ˜¯æ‰€è¯´çš„å­¤å„¿ä»»åŠ¡ã€‚å¯¹äºåˆ†æ”¯ä»»åŠ¡çš„å†å²è®°å½•ï¼Œä¿å­˜å¤šé•¿æ—¶é—´è®¾ç½®</p><ul><li><p>ç•Œé¢é…ç½®<br><img src="https://img.xxlaila.cn/1571974190710.jpg" alt="img"></p></li><li><p>pipeline å†™æ³•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">orphanedItemStrategy &#123;</span><br><span class="line">    discardolditems &#123;</span><br><span class="line">        daysTokeep(10)</span><br><span class="line">        numToKeep(5)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>æ³¨</strong>: è¿™é‡Œå­¤å„¿ç­–ç•¥pipeline éœ€è¦å¦å¤–ä¸€ç§æ–¹å¼æ¥æ”¯æŒï¼Œ<a href="https://gitee.com/jenkins-zh/gitlab-branch-source-plugin" target="_blank" rel="noopener">Setting up GitLab Server Configuration on Jenkins</a>ï¼Œè¿™é‡Œæ²¡æœ‰ç”¨åˆ°è¿™ä¸ªï¼Œä¸åšè¿‡å¤šçš„é˜è¿°ã€‚<a href="https://github.com/jenkinsci/job-dsl-plugin/wiki/Migration" target="_blank" rel="noopener">githubå‚è€ƒ</a></p><h3 id="å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘"><a href="#å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘" class="headerlink" title="å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘"></a>å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ†æ”¯çš„è§¦å¥½å¤„æ˜¯å¤šå¤šçš„ï¼Œè‡ªç„¶åœ¨å¤šåˆ†æ”¯é¢å‰è‡ªåŠ¨è§¦å‘è‚¯å®šä¹Ÿå°‘ä¸äº†ã€‚å¤šåˆ†æ”¯çš„è§¦å‘æœ‰ä¸¤ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯å‰é¢æåˆ°çš„Gitlab triggerå’ŒGeneric Webhook Triggerã€‚ä¸‹é¢åˆ†åˆ«å¯¹ä¸¤ç§æ¨¡å¼è¿›è¡Œé˜è¿°å’Œå®é™…çš„æµ‹è¯•</p><h4 id="Generic-Webhook-Trigger"><a href="#Generic-Webhook-Trigger" class="headerlink" title="Generic Webhook Trigger"></a>Generic Webhook Trigger</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Generic Webhook Trigger æ’ä»¶éœ€è¦æå‰å®‰è£…ï¼ŒGenericTriggerè§¦å‘æ¡ä»¶æ˜¯ç”±GWTæ’ä»¶æä¾›ï¼ŒGenericTriggerè§¦å‘çš„æ¡ä»¶åˆ†ä¸º5ä¸ªéƒ¨åˆ†ã€‚<a href="https://wiki.jenkins.io/display/JENKINS/Generic+Webhook+Trigger+Plugin" target="_blank" rel="noopener">GenericTriggerå®˜æ–¹å‚è€ƒ</a></p><ul><li>ä»HTTP POSTè¯·æ±‚ä¸­æå–å‚æ•°</li><li>tokenï¼ŒGWTæ’ä»¶ç”¨äºæ ‡è¯†jenkinsé¡¹ç›®çš„å”¯ä¸€æ€§</li><li>æ ¹æ®è¯·æ±‚å‚æ•°å€¼åˆ¤æ–­æ˜¯å¦è§¦å‘Jenkinsé¡¹ç›®æ‰§è¡Œ</li><li>æ—¥å¿—æ§åˆ¶æ‰“å°</li><li>webhookå“åº”æ§åˆ¶</li></ul><h4 id="GerenericTrigger-çš„å†™æ³•"><a href="#GerenericTrigger-çš„å†™æ³•" class="headerlink" title="GerenericTrigger çš„å†™æ³•"></a>GerenericTrigger çš„å†™æ³•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">    GenericTrigger(</span><br><span class="line">        genericVariables:[</span><br><span class="line">            [key: <span class="string">'ref'</span>, value: <span class="string">'$.ref'</span>]</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        token: env.JOB_NAME,</span><br><span class="line">        regexpFilterText: <span class="string">'$ref'</span>,</span><br><span class="line">        regexpFilterExpression: <span class="string">'refs/heads/'</span> + env.BRANCH_NAME</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env.BRANCH_NAME è¿™é‡ŒæŒ‡çš„æ˜¯åˆ†æ”¯åã€‚å½“ç„¶è¿™æ ·ä¿®æ”¹ä»¥åæ˜¯ä¸è¡Œçš„ï¼Œæ˜¯è¾¾ä¸åˆ°è‡ªåŠ¨è§¦å‘çš„ï¼Œéœ€è¦è‡ªè¡Œå»gitlabä¸Šæ·»åŠ é’©å­ï¼Œè¿™é‡Œç»è¿‡æµ‹è¯•æµç¨‹ï¼šç”¨æˆ·ä¿®æ”¹devåˆ†æ”¯ï¼Œpushåˆ°gitlab devåˆ†æ”¯å¯ä»¥è§¦å‘ä»»åŠ¡çš„devåˆ†æ”¯è‡ªåŠ¨æ„å»ºï¼›åˆå¹¶åˆ°teståˆ†æ”¯ï¼Œä¹Ÿå¯ä»¥è§¦å‘teståˆ†æ”¯è‡ªåŠ¨æ„å»ºï¼›åœ¨åˆå¹¶åˆ°masteråˆ†æ”¯ä¹Ÿèƒ½è‡ªåŠ¨è§¦å‘ä»»åŠ¡çš„masteråˆ†æ”¯è‡ªåŠ¨æ„å»ºã€‚<br><img src="https://img.xxlaila.cn/1571984557618.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è¦å®ç°è¿™å—ï¼Œè¦ç†è§£çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œé¦–å…ˆè¦çŸ¥é“gitlab push æ•°æ®çš„æ ¼å¼ï¼ŒçŸ¥é“äº†gitlab pushæ ¼å¼ï¼Œæˆ‘ä»¬æ‰çŸ¥é“åº”è¯¥æ€ä¹ˆæ“ä½œï¼Œ<a href="https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#webhooks" target="_blank" rel="noopener">gitlab pushæ•°æ®çš„æ ¼å¼å‚è€ƒ</a>ï¼Œ</p><ul><li>å‚è€ƒ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"object_kind"</span>: <span class="string">"push"</span>,</span><br><span class="line">  <span class="string">"before"</span>: <span class="string">"95790bf891e76fee5e1747ab589903a6a1f80f22"</span>,</span><br><span class="line">  <span class="string">"after"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">  <span class="string">"ref"</span>: <span class="string">"refs/heads/master"</span>,</span><br><span class="line">  <span class="string">"checkout_sha"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">  <span class="string">"user_id"</span>: 4,</span><br><span class="line">  <span class="string">"user_name"</span>: <span class="string">"John Smith"</span>,</span><br><span class="line">  <span class="string">"user_username"</span>: <span class="string">"jsmith"</span>,</span><br><span class="line">  <span class="string">"user_email"</span>: <span class="string">"john@example.com"</span>,</span><br><span class="line">  <span class="string">"user_avatar"</span>: <span class="string">"https://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=8://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=80"</span>,</span><br><span class="line">  <span class="string">"project_id"</span>: 15,</span><br><span class="line">  <span class="string">"project"</span>:&#123;</span><br><span class="line">    <span class="string">"id"</span>: 15,</span><br><span class="line">    <span class="string">"name"</span>:<span class="string">"Diaspora"</span>,</span><br><span class="line">    <span class="string">"description"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="string">"web_url"</span>:<span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"avatar_url"</span>:null,</span><br><span class="line">    <span class="string">"git_ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"git_http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"namespace"</span>:<span class="string">"Mike"</span>,</span><br><span class="line">    <span class="string">"visibility_level"</span>:0,</span><br><span class="line">    <span class="string">"path_with_namespace"</span>:<span class="string">"mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"default_branch"</span>:<span class="string">"master"</span>,</span><br><span class="line">    <span class="string">"homepage"</span>:<span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"repository"</span>:&#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"Diaspora"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"description"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"homepage"</span>: <span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"git_http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"git_ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"visibility_level"</span>:0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"commits"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327"</span>,</span><br><span class="line">      <span class="string">"message"</span>: <span class="string">"Update Catalan translation to e38cb41."</span>,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2011-12-12T14:27:31+02:00"</span>,</span><br><span class="line">      <span class="string">"url"</span>: <span class="string">"http://example.com/mike/diaspora/commit/b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327"</span>,</span><br><span class="line">      <span class="string">"author"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"Jordi Mallach"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"jordi@softcatala.org"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"added"</span>: [<span class="string">"CHANGELOG"</span>],</span><br><span class="line">      <span class="string">"modified"</span>: [<span class="string">"app/controller/application.rb"</span>],</span><br><span class="line">      <span class="string">"removed"</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">      <span class="string">"message"</span>: <span class="string">"fixed readme"</span>,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2012-01-03T23:36:29+02:00"</span>,</span><br><span class="line">      <span class="string">"url"</span>: <span class="string">"http://example.com/mike/diaspora/commit/da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">      <span class="string">"author"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"GitLab dev user"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"gitlabdev@dv6700.(none)"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"added"</span>: [<span class="string">"CHANGELOG"</span>],</span><br><span class="line">      <span class="string">"modified"</span>: [<span class="string">"app/controller/application.rb"</span>],</span><br><span class="line">      <span class="string">"removed"</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"total_commits_count"</span>: 4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸åŒçš„åˆ†æ”¯æäº¤æ¥è§¦å‘jenkinsçš„æ„å»ºï¼Œé‚£å°±åº”è¯¥çŸ¥é“postæ•°æ®å“ªä¸€ä¸ªå±æ€§ä»£è¡¨äº†ä¸åŒçš„åˆ†æ”¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¬¬å››è¡Œçœ‹åˆ°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">"ref"</span>: <span class="string">"refs/heads/master"</span>,</span><br></pre></td></tr></table></figure><p><strong>æ³¨é‡Š</strong>: ä¹Ÿå¯ä»¥é€šè¿‡IDEAå·¥å…·æäº¤çš„æ—¶å€™çœ‹åˆ°æäº¤çš„é€‰é¡¹ã€‚å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”¨refå¯ä»¥å¾ˆå¥½çš„åŒºåˆ†ä¸åŒåˆ†æ”¯ï¼Œè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆè¦å¡«å†™refçš„åŸå› ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡pipelineä»£ç çš„ç”Ÿæˆå™¨æ¥ç”Ÿæˆ</p><ul><li>pipeline ä»£ç ç”Ÿæˆå™¨<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">  GenericTrigger causeString: <span class="string">'Generic Cause'</span>, genericVariables: [[defaultValue: <span class="string">''</span>, key: <span class="string">'ref'</span>, regexpFilter: <span class="string">''</span>, value: <span class="string">'$.ref'</span>]], printContributedVariables: <span class="literal">true</span>, printPostContent: <span class="literal">true</span>, regexpFilterExpression: <span class="string">'\'</span>refs/heads/\<span class="string">' + evn.BRANCH_NAME'</span>, regexpFilterText: <span class="string">'$ref'</span>, token: <span class="string">'env.JOB_NAME'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1571982583457.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571982622070.jpg" alt="img"></p><p><strong>æ³¨</strong>: tokenå‚æ•°çš„ä½œç”¨æ˜¯æ ‡è¯†ä¸€ä¸ªpipelineåœ¨jenkinsä¸­çš„å”¯ä¸€æ€§ï¼Œè¿™ä¸ªå‚æ•°çš„é‡è¦æ€§å°±å¾—æèµ·GWTæ’ä»¶çš„åŸç†ã€‚å½“jenkinsæ”¶åˆ°generic-webhook-trgger/invokeæ¥å£çš„è¯·æ±‚æ—¶ï¼Œä¼šå°†è¯·æ±‚ä»£ç†ç»™GWTæ’ä»¶å¤„ç†ï¼ŒGWTæ’ä»¶å†…å®¹ä¼šä»jenkinså®ä¾‹å¯¹è±¡ä¸­å–å‡ºæ‰€æœ‰çš„å‚æ•°åŒ–jenkinsé¡¹ç›®ï¼ŒåŒ…æ‹¬pipelineï¼Œç„¶åè¿›è¡Œéå†ã€‚å¦‚æœæˆ‘ä»¬åœ¨å‚æ•°åŒ–é¡¹ç›®ä¸­Generic Triggeré…ç½®tokençš„å€¼ä¸webhookè¯·æ±‚æ—¶çš„tokenä¸€è‡´ï¼Œå°±ä¼šè§¦å‘æ”¹é¡¹ç›®ã€‚å¦‚æœå¤šä¸ªå‚æ•°åŒ–é¡¹ç›®çš„tokenä¸€æ ·ï¼Œåˆ™éƒ½ä¼šè¿›è¡Œè§¦å‘ï¼Œæ‰€ä»¥è¿™é‡Œçš„tokenæœ€å¥½æ—¶JOB_NAMEé¡¹ç›®åï¼Œå› ä¸ºè¿™ä¸ªæ˜¯åœ¨é¡¹ç›®æˆ–è€…æ˜¯åœ¨ä¸ºæœåŠ¡é¢†åŸŸä»–éƒ½æ˜¯å”¯ä¸€çš„ã€‚</p><ul><li>å‚æ•°ä»‹ç»:<ul><li>regexpFilterText: éœ€è¦è¿›è¡ŒåŒ¹é…çš„keyï¼Œä¾‹å­ä¸­ï¼Œä½¿ç”¨ä»post bodyä¸­æå–çš„refå˜é‡å€¼ã€‚</li><li>regexpFilterExpression: <a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html" target="_blank" rel="noopener">æ­£åˆ™è¡¨è¾¾å¼</a>ï¼›å¦‚æœregexpFilterTextå‚æ•°ç¬¦åˆregexpFilterExpressionå‚æ•°çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ™è§¦å‘æ‰§è¡Œã€‚</li><li>printPostContent: å¸ƒå°”å€¼ï¼Œå°†webhookè¯·æ±‚ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—ä¸Š</li><li>printContributedVariables: å¸ƒå°”å€¼ï¼Œå°†æå–åçš„å˜é‡ååŠå˜é‡å€¼æ‰“å°å‡ºæ¥</li><li>causeString: å­—ç¬¦ä¸²å‹ï¼Œè§¦å‘åŸå› ï¼Œå¯ä»¥ç›´æ¥åº”ç”¨æå–åçš„å˜é‡ï¼Œå¦‚ causeString: â€˜Triggered on $msgâ€™</li><li>Silent response: å¸ƒå°”å‹ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“webhookè¯·æ±‚æˆåŠŸåï¼ŒGWTæ’ä»¶ä¼šè¿”å›HTTP 200çŠ¶æ€ç å’Œè§¦å‘ç»“æœç»™å¯¹æ–¹è°ƒç”¨ï¼Œä½†æ˜¯å½“Silentresponseè®¾ç½®ä¸ºtrueæ—¶ï¼Œå°±åªè¿”å›HTTP 200çŠ¶æ€ç ï¼Œä¸åæ‚”è§¦å‘ç»“æœ</li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢çš„çœ‹çš„å‡ºæ¥ï¼Œæˆ‘ä»¬åªè¦æ˜¯æäº¤äº†åˆ†æ”¯éƒ½å¯ä»¥è¿›è¡Œè§¦å‘æ„å»ºï¼Œä½†æ˜¯å‘¢ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†devâ€”â€”&gt;testâ€”â€”master åˆ†æ”¯ï¼Œå°±æ˜¯åªæƒ³è¦è¿™å‡ ä¸ªè¿›è¡Œè§¦å‘æ„å»ºï¼Œå…¶ä»–çš„ä¸è¿›è¡Œè§¦å‘ï¼Œè®©å¼€å‘è‡ªå·±å»ç‚¹å‡»ã€‚</p><ul><li><p>æŒ‡å®šåˆ†æ”¯æ„å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">  GenericTrigger causeString: <span class="string">'Triggered on $msg'</span>, genericVariables: [[defaultValue: <span class="string">''</span>, key: <span class="string">'ref'</span>, regexpFilter: <span class="string">''</span>, value: <span class="string">'$.ref'</span>]], printContributedVariables: <span class="literal">true</span>, printPostContent: <span class="literal">true</span>, regexpFilterExpression: <span class="string">'\'</span>refs/heads/(dev|<span class="built_in">test</span>|master)\<span class="string">''</span>, regexpFilterText: <span class="string">'$ref'</span>, token: <span class="string">'env.JOB_NAME'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¤šåˆ†æ”¯Gitlab trigger<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤šåˆ†æ”¯çš„Gitlab triggerå’Œæˆ‘ä»¬å‰é¢ä»‹ç»çš„gitlabäº‹ä»¶è§¦å‘ä¸€æ ·çš„ï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œè¿™é‡Œæˆ‘æµ‹è¯•äº†ä¸€ä¸ªjobï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚åŒæ—¶æ–°å»ºäº†ä¸€ä¸ªåˆ†æ”¯ï¼Œjenkinsä¼šè‡ªåŠ¨çš„æ‰«ææ–°å»ºä¸€ä¸ªä»¥åˆ†æ”¯ä¸ºåçš„ä»»åŠ¡ï¼Œè¿›è¡Œè‡ªåŠ¨è§¦å‘ã€‚å½“æˆ‘åˆ é™¤äº†æŸä¸€ä¸ªåˆ†æ”¯ï¼Œå°±ä¼šè§¦å‘è‡ªåŠ¨æ‰«æï¼Œç„¶åæŸ¥çœ‹åˆ†æ”¯ä¸ºåˆ é™¤ã€‚</p></li><li><p>åˆ é™¤åˆ†æ”¯<br><img src="https://img.xxlaila.cn/1571996378764.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571996257688.jpg" alt="img"></p></li><li><p>æ•´ä½“æ•ˆæœå›¾<br><img src="https://img.xxlaila.cn/1571990331005.jpg" alt="img"></p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä»‹ç»ä¸€ä¸‹éƒ¨ç½²è¿™å—ï¼Œæ ¹æ®branchæ¥è¿›è¡Œåˆ¤æ–­ï¼Œä¸åŒçš„branchéƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒï¼Œå½“è®¾å®šçš„å€¼ä¸åœ¨branchèŒƒå›´å†…ï¼Œå°±éœ€è¦äººä¸ºçš„åˆ¶å®šéƒ¨ç½²ç¯å¢ƒã€‚å½“äººå‘˜ä¸‰åˆ†é’Ÿå†…æ²¡æœ‰æ¥è¿›è¡Œç¯å¢ƒéƒ¨ç½²çš„é€‰æ‹©ï¼Œç³»ç»Ÿå°±ä¼šæ–­å¼€ï¼Œå¯¹è¯¥åˆ†æ”¯æ ‡è®°ä¸ºç»“æŸã€‚</p><p><a href="http://xxlaila.github.io/2019/10/25/pipeline%E5%A4%9A%E5%88%86%E6%94%AFgitlab%E8%A7%A6%E5%8F%91/" target="_blank" rel="noopener">å®Œæ•´æ–‡ä»¶</a><br><a href="https://jenkinsci.github.io/job-dsl-plugin/#path/buildPipelineView" target="_blank" rel="noopener">æ¨èå­¦ä¹ å‚è€ƒåœ°å€</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>elasticserch</title>
    <url>/2019/10/17/elasticserch%E6%97%A5%E5%B8%B8%E7%BB%B4%E6%8A%A4/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="days-1"><a href="#days-1" class="headerlink" title="days 1"></a>days 1</h3><a id="more"></a><h4 id="elasticserch-ç´¢å¼•å’Œæ•°æ®æ“ä½œ"><a href="#elasticserch-ç´¢å¼•å’Œæ•°æ®æ“ä½œ" class="headerlink" title="elasticserch ç´¢å¼•å’Œæ•°æ®æ“ä½œ"></a>elasticserch ç´¢å¼•å’Œæ•°æ®æ“ä½œ</h4><ul><li><p>æŸ¥çœ‹ç´¢å¼•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/indices?v'</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ç´¢å¼•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/indices?v' |grep "red"|awk '&#123;print $3&#125;'|uniq &gt;l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in `cat a`;do  curl -XDELETE http://127.0.0.1:9200/$&#123;i&#125;;done</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹shards</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET http://127.0.0.1:9200/_cat/shards</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shards æœ‰å‡ ç§ç±»å‹ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹<code>UNASSIGNED</code>ï¼Œes é›†ç¾¤é‡Œé¢çš„åˆ†ç‰‡æ˜¯åˆ†é…åœ¨å¤šå°nodeä¸Šçš„ï¼Œä¸ºçš„å°±æ˜¯é«˜å¯ç”¨ï¼Œæ¯”å¦‚ä½ çš„æŸå°æœºå™¨crashäº†ï¼Œé‚£ä¹ˆé›†ç¾¤å°±ä¼šè®©å…¶ä»–å‰¯æœ¬é¡¶ä¸Šæ¥ï¼Œé¿å…å‡ºç°æŸä¸ªåˆ†ç‰‡ä¸èƒ½æä¾›æœåŠ¡çš„æƒ…å†µï¼Œä½†æ˜¯éš¾å…è¿˜æ˜¯ä¼šå‡ºç° UNASSIGNED shards çš„é”™è¯¯ã€‚</p><ul><li>åˆ é™¤shards UNASSIGNED<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/shards'|grep "UNASSIGNED"|awk '&#123;print $1&#125;'|uniq &gt;l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in `cat l`;do curl -XDELETE http://127.0.0.1:9200/$i;done</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="elasticserchéªŒè¯é›†ç¾¤"><a href="#elasticserchéªŒè¯é›†ç¾¤" class="headerlink" title="elasticserchéªŒè¯é›†ç¾¤"></a>elasticserchéªŒè¯é›†ç¾¤</h4><ul><li><p>é›†ç¾¤ç›¸å…³API</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat</span><br><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/tasks</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br><span class="line">/_cat/count</span><br><span class="line">/_cat/count/&#123;index&#125;</span><br><span class="line">/_cat/recovery</span><br><span class="line">/_cat/recovery/&#123;index&#125;</span><br><span class="line">/_cat/health</span><br><span class="line">/_cat/pending_tasks</span><br><span class="line">/_cat/aliases</span><br><span class="line">/_cat/aliases/&#123;<span class="built_in">alias</span>&#125;</span><br><span class="line">/_cat/thread_pool</span><br><span class="line">/_cat/thread_pool/&#123;thread_pools&#125;</span><br><span class="line">/_cat/plugins</span><br><span class="line">/_cat/fielddata</span><br><span class="line">/_cat/fielddata/&#123;fields&#125;</span><br><span class="line">/_cat/nodeattrs</span><br><span class="line">/_cat/repositories</span><br><span class="line">/_cat/snapshots/&#123;repository&#125;</span><br><span class="line">/_cat/templates</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤åç§°ç­‰ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"elk_elasticsearch_data_2"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elk_elasticsearch"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"T47wQwa6TT-6MHJVFM40Tw"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"6.4.0"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"rpm"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"595516e"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2018-08-17T23:18:47.308994Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"7.4.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"5.6.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"5.0.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/nodes?v</span><br><span class="line">ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">172.21.16.198           29          85   0    0.10    0.04     0.05 mdi       -      elk_elasticsearch_data_2</span><br><span class="line">172.21.16.187           48          85   0    0.00    0.01     0.05 mdi       *      elk_elasticsearch_master</span><br><span class="line">172.21.16.206           25          86   0    0.08    0.03     0.05 mdi       -      elk_elasticsearch_data_3</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯é›†ç¾¤ç£ç›˜åˆ†é…æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/allocation?v</span><br><span class="line">shards disk.indices disk.used disk.avail disk.total disk.percent host          ip            node</span><br><span class="line">    98          1gb     3.6gb     96.3gb     99.9gb            3 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2</span><br><span class="line">    99      887.1mb     4.5gb     95.4gb     99.9gb            4 172.21.16.187 172.21.16.187 elk_elasticsearch_master</span><br><span class="line">    99        957mb     3.5gb     96.4gb     99.9gb            3 172.21.16.206 172.21.16.206 elk_elasticsearch_data_3</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯é›†ç¾¤å¥åº·çŠ¶å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/health?v </span><br><span class="line">epoch      timestamp cluster           status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1571648406 17:00:06  elk_elasticsearch green           3         3    296 148    0    0        0             0                  -                100.0%</span><br><span class="line"></span><br><span class="line">$</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ä¸Šè¢«fielddataæ‰€ä½¿ç”¨çš„å †å†…å­˜å¤§å°ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/fielddata?v</span><br><span class="line">id                     host          ip            node                     field                    size</span><br><span class="line">VNcRqM30T3axzVjiPkDTmA 172.21.16.187 172.21.16.187 elk_elasticsearch_master event.resultCode.keyword 352b</span><br><span class="line">VNcRqM30T3axzVjiPkDTmA 172.21.16.187 172.21.16.187 elk_elasticsearch_master <span class="built_in">type</span>                     720b</span><br><span class="line">HNc5BrMWQcummBeAskQc4A 172.21.16.206 172.21.16.206 elk_elasticsearch_data_3 event.resultCode.keyword 704b</span><br><span class="line">z3zUA8KxTH6B7C8CmVRUIQ 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2 <span class="built_in">type</span>                     720b</span><br><span class="line">z3zUA8KxTH6B7C8CmVRUIQ 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2 event.resultCode.keyword 704b</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>elasticserch</category>
      </categories>
      <tags>
        <tag>elasticserch</tag>
      </tags>
  </entry>
  <entry>
    <title>nexusé…ç½®ldap</title>
    <url>/2019/10/15/nexus%E9%85%8D%E7%BD%AEldap/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="é…ç½®nexus"><a href="#é…ç½®nexus" class="headerlink" title="é…ç½®nexus"></a>é…ç½®nexus</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•nexusåœ¨è®¾ç½®é¡µï¼Œç‚¹å‡»ldapï¼Œ</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1571131890608.jpg" alt="img"><br>å‚æ•°ä»‹ç»:</p><ul><li>Name: éšä¾¿å†™</li><li>LDAP server address: æ”¯æŒldapså’Œldap,è€Œç«¯å£åˆ™å–å†³äºé…ç½®ã€‚ å¦‚æœæ²¡æœ‰ç‰¹æ®Šé…ç½®ï¼Œldapé»˜è®¤ç«¯å£æ˜¯389</li><li>Search base: åªéœ€è¦å¡«DCå³å¯ï¼Œæ¯”å¦‚DC=example,DC=comã€‚ å…¶å®ƒå†…å®¹ï¼Œæ¯”å¦‚CNã€OUç­‰ï¼Œä¸éœ€è¦å¡«å†™</li><li>Authentication methodæœ‰ä»¥ä¸‹é€‰é¡¹:<ul><li>Simple Authentication</li><li>Anonymous Authentication</li><li>DIGEST-MD5</li><li>CRAM-MD5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šå¸¸é€‰æ‹©Simple Authenticationå³å¯ã€‚Username or DNã€Passwordé‡Œå¡«å†™è´¦æˆ·ã€å¯†ç ï¼Œè€Œ Connection rulesæ— éœ€ä¿®æ”¹ã€‚å¡«å†™å®Œæ¯•åï¼Œç‚¹å‡»ã€Verify connectionã€‘æŒ‰é’®ï¼Œå¯ä»¥éªŒè¯ä¿¡æ¯ã€‚ å¦‚æœæˆåŠŸï¼Œå³å¯ä¿å­˜ã€‚</li></ul></li></ul><h4 id="Choose-Users-and-Groups"><a href="#Choose-Users-and-Groups" class="headerlink" title="Choose Users and Groups"></a>Choose Users and Groups</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é¡¹æ•…åæ€ä¹‰å°±æ˜¯é…ç½®ç”¨æˆ·å’Œç»„çš„ï¼Œåœ¨æœ€å¼€å¤´çš„Configuration templateä¸­ï¼Œæœ‰å››ç§æ¨¡æ¿å¯é€‰ï¼š</p><ul><li>Active Directory</li><li>Generic Ldap Server</li><li>Posix with Dynamic Groups</li><li>Posix with Static Groups</li></ul><p>è¿™é‡Œé€‰æ‹©<code>Generic Ldap Server</code></p><ul><li>Base DN åœ¨LDAPä¸­æ‰¾åˆ°ç”¨æˆ·çš„åŸºæœ¬ä½ç½®ã€‚è¿™æ˜¯ç›¸å¯¹äºæœç´¢åŸºç¡€çš„ï¼ˆä¾‹å¦‚ou = peopleï¼‰ã€‚</li><li>User subtreeé€šå¸¸éœ€è¦å‹¾é€‰ã€‚ å¦‚æœæŠŠLDAPçš„Treeæ¯”ä½œç›®å½•çš„è¯ï¼Œå‹¾é€‰ä»¥åç›¸å½“äºé€’å½’æŸ¥æ‰¾å­ç›®å½•ã€‚</li><li>User filteré€šè¿‡è¿‡æ»¤è§„åˆ™ï¼Œå‡å°‘æœç´¢ä¿¡æ¯ï¼Œç”¨äºæå‡æ€§èƒ½ã€‚ ä»…ä»…åªæ˜¯æå‡æ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä¸æ‡‚å®ƒç‰¹æ®Šçš„åŒ¹é…è§„åˆ™ï¼Œä¹Ÿå¯ä»¥ä¸å¡«ã€‚</li><li>ä¹‹å‰é€‰æ‹©äº†<code>Generic Ldap Server</code>æ¨¡ç‰ˆåï¼ŒUser ID attributeé»˜è®¤ä¸ºuidï¼ŒReal name attributeé»˜è®¤ä¸ºcnã€Email attributeé»˜è®¤ä¸ºmailã€Password attributeä¸ºç©ºã€‚</li><li>Map LDAP groups as roleså¦‚æœä¸å‹¾é€‰ï¼Œå°±ä¸ä¼šåŒæ­¥ç”¨æˆ·ç»„ä¿¡æ¯ã€‚ å¦‚æœå‹¾é€‰ï¼Œåˆ™å¯ä»¥é€‰æ‹©Group typeå’ŒGroup member of attributeã€‚ è‹¥æ— å¿…è¦ï¼Œä¿æŒé»˜è®¤å³å¯ï¼Œé»˜è®¤æ˜¯å‹¾é€‰çš„ã€‚<br><img src="https://img.xxlaila.cn/1571133103461.jpg" alt="img"></li><li>å¡«å†™å®Œæˆåï¼Œé€šè¿‡ã€Verify user mappingã€‘å¯ä»¥éªŒè¯æŸ¥è¯¢ç»“æœ<br><img src="https://img.xxlaila.cn/1571133221971.jpg" alt="img"><br>ç‚¹å‡»åˆ›å»º<br><img src="https://img.xxlaila.cn/1571133286829.jpg" alt="img"></li></ul><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°èµ·ä¸€ä¸ªçª—å£åˆ©ç”¨ldapé‡Œé¢çš„è´¦å·è¿›è¡Œç™»å½•ï¼Œå¯ä»¥ç™»å½•ï¼Œæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ç™»å½•ä¹‹åç”¨æˆ·æ²¡æœ‰ä»»ä½•æƒé™ï¼Œè¿™å¯¹äºç ”å‘æ¥è¯´åˆæ˜¯ä¸€ä¸ªä¸å¯æ¥å—çš„äº‹æƒ…ã€‚æ¥ä¸‹æ¥é…ç½®æƒé™</p><h5 id="ç¦æ­¢åŒ¿åè®¿é—®"><a href="#ç¦æ­¢åŒ¿åè®¿é—®" class="headerlink" title="ç¦æ­¢åŒ¿åè®¿é—®"></a>ç¦æ­¢åŒ¿åè®¿é—®</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ˜¯ä¸å…è®¸åŒ¿åç”¨æˆ·ä¸å¯ä»¥ç™»å½•å°±èƒ½è®¿é—®çš„ï¼Œè¿™æ ·æˆ‘ä»¬ldapå°±æ²¡æœ‰ä»»ä½•æ„ä¹‰äº†<br><img src="https://img.xxlaila.cn/1571133691247.jpg" alt="img"></p><ul><li>ç¦æ­¢åŒ¿åç”¨æˆ·<br><img src="https://img.xxlaila.cn/1571133811908.jpg" alt="img"></li></ul><h5 id="åˆ›å»ºè§’è‰²"><a href="#åˆ›å»ºè§’è‰²" class="headerlink" title="åˆ›å»ºè§’è‰²"></a>åˆ›å»ºè§’è‰²</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨Securityâ€”â€”&gt;Rolesâ€”â€”&gt;Create roleï¼Œè¿™é‡Œåˆ›å»ºè§’è‰²æœ‰ä¸¤ç§ã€‚ä¸€ç§æ˜¯nexus relosæœ¬åœ°è§’è‰²ï¼Œä¸€ç§æ˜¯External roles mappingå¤–éƒ¨æ˜ å°„çš„å½¢å¼ã€‚ä¸ºäº†æ»¡è¶³æˆ‘ä»¬ldapè´¦æˆ·ç™»å½•è¿›æ¥æœ‰æµè§ˆåº“çš„æƒé™ï¼Œç ”å‘åˆå¯ä»¥ä¸Šä¼ ç¬¬ä¸‰æ–¹ä¾èµ–åº“çš„æƒé™ï¼Œä½†æ˜¯ä¸èƒ½åˆ é™¤å’Œç§ä¸‹å¢åŠ åº“Repositoriesã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å•ç‹¬å»ºç«‹ä¸€ä¸ªæœ¬åœ°çš„relosï¼Œç„¶ååœ¨æ˜ å°„å¤–éƒ¨çš„ldapåˆ°è¿™ä¸ªæœ¬åœ°çš„rolesï¼Œè¿™æ ·ldapè´¦æˆ·ç™»å½•è¿›æ¥å°±èƒ½å®ç°æ—¥å¸¸çš„åŸºæœ¬æ“ä½œã€‚</p><ul><li><p>åˆ›å»ºnexus relosæœ¬åœ°è§’è‰²<br><img src="https://img.xxlaila.cn/1571296771150.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä»–èµ‹äºˆæƒé™ï¼Œå¯¹ç”¨æˆ·è¿›è¡Œæƒé™æ§åˆ¶ï¼Œæ²¡æœ‰æƒé™æ§åˆ¶ï¼Œå°±æ²¡åŠæ³•è¾¾æˆæˆ‘ä»¬ä¸Šé¢çš„ç›®æ ‡ã€‚ä¸‹é¢æ˜¯æˆ‘èµ‹äºˆçš„æƒé™ï¼Œå¯ä»¥ç»“åˆå®é™…éœ€æ±‚æ¥è¿›è¡Œèµ‹äºˆã€‚</p></li><li><p>æƒé™ä»‹ç»:</p><ul><li>ng-component-upload: æœ‰ä¸Šä¼ çš„æƒé™ï¼Œæ¯”å¦‚javaä¾èµ–çš„ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œç ”å‘å¯ä»¥è‡ªå·±è¿›è¡Œä¸Šä¼ </li><li>ng-repository-admin-<em>-</em>-browse: æµè§ˆæ‰€æœ‰çš„repository</li><li>ng-repository-admin-<em>-</em>-read: å¯ä»¥æ‰€æœ‰è¯»å–repositoryçš„é…ç½®ä¿¡æ¯</li><li>ng-repository-view-maven2-maven-central-browse: å…·æœ‰æµè§ˆmaven-centralå†…å®¹</li><li>ng-repository-view-maven2-maven-central-read: è¯»å–maven-centralå†…å®¹ï¼Œåœ¨mavenç¼–è¯‘çš„æ—¶å€™å…·æœ‰ä¸‹è½½çš„æƒé™ï¼Œ(åé¢ä¸ä¸€ä¸€ä»‹ç»)</li><li>ng-repository-view-maven2-maven-public-browse</li><li>ng-repository-view-maven2-maven-public-read</li><li>ng-repository-view-maven2-maven-releases-browse</li><li>ng-repository-view-maven2-maven-releases-read</li><li>ng-repository-view-maven2-maven-snapshots-browse</li><li>ng-repository-view-maven2-maven-snapshots-read</li><li>ng-repository-view-npm-npm-kxl-all-browse: ä»¥ä¸‹æ˜¯è‡ªå·±åšçš„npmä»£ç†ç¼“å­˜ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://xxlaila.github.io/2019/08/23/nexus3æ­å»ºnpmç§æœ/" target="_blank" rel="noopener">nexus3æ­å»ºnpmç§æœ</a></li><li>ng-repository-view-npm-npm-kxl-all-read</li><li>ng-repository-view-npm-npm-external-browse</li><li>ng-repository-view-npm-npm-external-read</li><li>ng-repository-view-npm-npm-internal-browse</li><li>ng-repository-view-npm-npm-internal-read</li><li>ng-search-read: è®©ç”¨æˆ·å…·æœ‰æ‰€æœ‰æƒé™ï¼Œæ²¡æœ‰æ­¤æƒé™ï¼Œç ”å‘æŸ¥æ‰¾ä¸€ä¸ªåŒ…ï¼Œä¼°è®¡ä¼šæ­»</li></ul></li><li><p>åˆ›å»ºæ˜¯External roles mappingå¤–éƒ¨æ˜ å°„<br><img src="https://img.xxlaila.cn/1571134166780.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571297568491.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¿›è¡ŒRoles ID è¿™æ ç›®ï¼Œéœ€è¦å¡«å†™çš„æ˜¯Usersï¼Œè¿™ä¸ªUsersä¼šåœ¨ldapä¸ŠåŒæ­¥Usersçš„ä¸€ä¸ªç”¨æˆ·ç»„ã€‚æ ¹æ®è‡ªå·±çš„ldapè´¦æˆ·ç»„è®¾ç½®æ¥è¿›è¡Œå¡«å†™ã€‚ä¸‹å›¾æ˜¯ldapçš„ç»„è®¾ç½®<br><img src="https://img.xxlaila.cn/1571298567078.jpg" alt="img"></p></li></ul><p><strong>æ³¨</strong>: å…¶å®åœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›è¡ŒPrivilegesçš„æƒé™èµ‹äºˆï¼Œä½†æ˜¯æˆ‘é€‰æ‹©çš„æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªæœ¬åœ°çš„nexus relosã€‚ç„¶åæˆ‘ä»¬åœ¨Rolesæ å…³è”ä¹‹å‰åˆ›å»ºçš„<code>Developer</code>ï¼Œå®Œæˆä»¥åé€šè¿‡ldapè´¦æˆ·ç™»å½•è¿›è¡Œæµ‹è¯•</p><h5 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä¸»è¦æ˜¯ä»å››ä¸ªæ–¹é¢æ¥æµ‹è¯•ldapè´¦æˆ·ã€‚åˆ†åˆ«æ˜¯: ç™»å½•é»˜è®¤çš„æƒé™ã€æµè§ˆæ‰€æœ‰åº“çš„æƒé™ã€Browseçš„æµè§ˆã€Browseåº“çš„ä¸Šä¼ </p><ul><li><p>ç™»å½•é»˜è®¤çš„æƒé™<br><img src="https://img.xxlaila.cn/1571297962563.jpg" alt="img"></p></li><li><p>æµè§ˆæ‰€æœ‰åº“çš„æƒé™<br><img src="https://img.xxlaila.cn/1571298121188.jpg" alt="img"></p></li><li><p>Browseçš„æµ<br><img src="https://img.xxlaila.cn/1571298018356.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571298167348.jpg" alt="img"></p></li><li><p>Browseåº“çš„ä¸Šä¼ <br><img src="https://img.xxlaila.cn/1571298224331.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571298260091.jpg" alt="img"></p></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nexus</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsé…ç½®å¤‡ä»½</title>
    <url>/2019/10/15/jenkins%E9%85%8D%E7%BD%AE%E5%A4%87%E4%BB%BD/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="jenkins-å¤‡ä»½"><a href="#jenkins-å¤‡ä»½" class="headerlink" title="jenkins å¤‡ä»½"></a>jenkins å¤‡ä»½</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“jenkinsåœ¨ç”¨èµ·æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éš¾ä¿ä»–ä¸ä¼šå‡ºæ•…éšœï¼Œä½†æ˜¯å‡ºäº†æ•…éšœæˆ‘ä»¬æ€ä¹ˆåšåˆ°å¿«é€Ÿçš„æ¢å¤å‘¢ï¼Œè¿™æ—¶å¤‡ä»½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚ä½†jenkinsæœ¬èº«ä¸æä¾›å¤‡ä»½çš„åŠŸèƒ½ï¼Œ<a id="more"></a> æ‰€ä»¥è¿™é‡Œå°±éœ€è¦å€ŸåŠ©å¤–åŠ›ã€‚å¤‡ä»½å¯ä»¥å¤šæ ·åŒ–ï¼Œä¸€ç§æ˜¯æˆ‘ä»¬ç›´æ¥åˆ°jenkinsçš„ç›®å½•ä¸‹é¢æ‰‹åŠ¨å¤‡ä»½jenkinsç›®å½•ã€‚ä¸€ç§æ˜¯æˆ‘ä»¬å°±jenkinsè‡ªå¸¦çš„æ’ä»¶<code>thinBackup</code>å’Œ<code>Periodic Backup</code>è¿›è¡Œå¤‡ä»½æ¢å¤ï¼Œä¸‹é¢è¿›è¡Œåˆ†åˆ«ä»‹ç»</p><h3 id="thinBackupå¤‡ä»½"><a href="#thinBackupå¤‡ä»½" class="headerlink" title="thinBackupå¤‡ä»½"></a>thinBackupå¤‡ä»½</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;æ’ä»¶ç®¡ç†<br><img src="https://img.xxlaila.cn/1571101180571.jpg" alt="img"><br>å®‰è£…å®Œæˆä¹‹åé‡å¯jenkinsæœåŠ¡ï¼Œç™»å½•jenkinsåœ¨ç³»ç»Ÿç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571101557754.jpg" alt="img"></p><h4 id="é…ç½®ThinBackup"><a href="#é…ç½®ThinBackup" class="headerlink" title="é…ç½®ThinBackup"></a>é…ç½®ThinBackup</h4><ul><li>ç‚¹å‡»ThinBackup<br><img src="https://img.xxlaila.cn/1571101640273.jpg" alt="img"><br>å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªé€‰é¡¹:</li><li>Backup Now: æ‰‹åŠ¨ç«‹å³å¤‡ä»½</li><li>Restore: æ¢å¤å¤‡ä»½</li><li>Settings: å¤‡ä»½å‚æ•°çš„è®¾ç½®</li></ul><h5 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹é¢æ˜¯æˆ‘çš„å¤‡ä»½å‚æ•°ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è‡ªå·±è®¾å®šå¤‡ä»½å‚æ•°ï¼Œè®¾ç½®å¥½å‹saveå³å¯ï¼Œ<code>Backup schedule for full backups</code>æ„æ€æ˜¯å‘¨ä¸€åˆ°å‘¨äº”æ¯å¤©å‡Œæ™¨ä¸¤ç‚¹è¿›è¡Œå¤‡ä»½<br><img src="https://img.xxlaila.cn/1571102057919.jpg" alt="img"></p><h5 id="Restore"><a href="#Restore" class="headerlink" title="Restore"></a>Restore</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤‡ä»½æ–‡ä»¶æ˜¯ä»¥æ—¥æœŸ+æ—¶é—´èŠ‚ç‚¹ç»„æˆçš„æ–‡ä»¶åï¼Œæˆ‘ä»¬æ¢å¤ä»€ä¹ˆæ—¶é—´æ®µçš„ï¼Œç‚¹å‡»è¿›è¡Œæ¢å¤ï¼Œ<br><img src="https://img.xxlaila.cn/1571102188007.jpg" alt="img"></p><h3 id="Periodic-Backup"><a href="#Periodic-Backup" class="headerlink" title="Periodic Backup"></a>Periodic Backup</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤‡ä»½é™¤äº†ä¸Šé¢æåˆ°çš„æ’ä»¶è¿˜æœ‰ä¸€ä¸ªæ’ä»¶æ˜¯<code>Periodic Backup</code>ï¼Œå®‰è£…<code>Periodic Backup</code>ä¸é˜è¿°ï¼Œå®‰è£…å®Œæˆåå¯ä»¥åœ¨ç³»ç»Ÿç®¡ç†èœå•ä¸‹é¢æœ‰ä¸€ä¸ª<code>Periodic Backup Manager</code>èœå•<br><img src="https://img.xxlaila.cn/1571709136813.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰“å¼€<code>Periodic Backup Manager</code>ï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€æ˜¯æ²¡æœ‰ä»»ä½•ä¸œè¥¿çš„ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å»å»ºç«‹ä¸€ä¸ªè§„åˆ™ï¼Œç‚¹å‡»<code>Configure</code><br><img src="https://img.xxlaila.cn/1571709270639.jpg" alt="img"></p><p>é…ç½®é¡¹å¾ˆç®€å•:</p><ul><li>Temporary Directory: ä¸´æ—¶ç›®å½•</li><li>Backup schedule (cron): è¿›è¡Œå¤‡ä»½cronçš„è¡¨è¾¾å¼ï¼Œå¡«å†™å®Œæˆåç‚¹å‡»<code>Validate cron syntax</code>è¿›è¡ŒéªŒè¯</li><li>Maximum backups in location: æœ€å¤§ä½ç½®å¤‡ä»½ï¼Œä¿ç•™å¤šå°‘ä¸ªå¤‡ä»½æ–‡ä»¶</li><li>Store no older than (days): ä¿ç•™çš„æ—¶é—´</li><li>File Management Strategy: å¤‡ä»½ç­–ç•¥<ul><li>ConfigOnly: åªå¤‡ä»½é…ç½®æ–‡ä»¶</li><li>FullBackup: è¿›è¡Œå…¨é‡å¤‡ä»½ï¼Œå¯ä»¥é€šè¿‡Excludes listä¸­å¡«å…¥Anté£æ ¼è¡¨è¾¾å¼ï¼Œæ’é™¤ä¸å¸Œæœ›å¤‡ä»½çš„æ–‡ä»¶ï¼Œå¤šä¸ªè¡¨è¾¾å¼ä½¿ç”¨åˆ†å·åˆ†éš”</li></ul></li><li>Storage Strategy: å­˜å‚¨ç­–ç•¥ï¼Œå°±æ˜¯æ˜¯å¦éœ€è¦è¿›è¡Œå‹ç¼©å­˜å‚¨</li><li>Backup Location: å¤‡ä»½çš„ä½ç½®ï¼Œéƒ½æ˜¯æœ¬åœ°ç›®å½•<br><img src="https://img.xxlaila.cn/1571709879768.jpg" alt="img"></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsé…ç½®ldap</title>
    <url>/2019/10/14/jenkins%E9%85%8D%E7%BD%AEldap/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸ç ”å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜ï¼Œè¿˜æœ‰è¿ç»´äººå‘˜æœ‰æ—¶å€™ç™»å½•jenkinså»æŸ¥çœ‹ä¸€äº›jobçš„çŠ¶æ€æˆ–è€…æ˜¯å…¶ä»–çš„ä¸œè¥¿ï¼Œè™½ç„¶æœ‰ä¼ä¸šå¾®ä¿¡çš„é€šçŸ¥ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯ä¸èƒ½æ»¡è¶³ï¼Œ<a id="more"></a> æ¯”å¦‚jobé”™è¯¯äº†ï¼Œä¼ä¸šå¾®ä¿¡è™½ç„¶å§é”™è¯¯å‘ç»™äº†ç ”å‘äººå‘˜ï¼Œä½†æ˜¯ç ”å‘è¿˜æ˜¯è¦ç™»å½•jenkinsä¸Šå»çœ‹ï¼Œå°±æ„Ÿè§‰è¦èˆ’æœä¸€ç‚¹ï¼Œæµ‹è¯•ä¸Šåšçš„ä¸€äº›è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæœ‰æ—¶å€™å¤±è´¥äº†ä»–ä»¬ä¹Ÿä¼šå»çœ‹æˆ–è€…æ˜¯å»å»ºç«‹ä¸€äº›è‡ªåŠ¨åŒ–çš„jobã€‚ä¹‹å‰å»ºç«‹äº†å…¬å…±çš„è´¦å·ï¼Œå¼€å‘å’Œæµ‹è¯•äººå‘˜éƒ½å»ç™»å½•ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä»–ä»¬è¯¯æ“ä½œäº†ï¼Œå¯¼è‡´ä¸€äº›å…¶ä»–çš„ä¸œè¥¿å¤±è´¥æˆ–è€…é”™è¯¯ï¼Œè™½ç„¶åšäº†æƒé™æ§åˆ¶ï¼Œä½†æ˜¯ä»–ä»¬è¿˜æ˜¯æ­»ä¸æ‰¿è®¤ï¼Œæ‰€ä»¥è¿™é‡Œä»‹å…¥ldapã€‚è°åŠ¨çš„å°±çŸ¥é“äº†ï¼Œè¿™æ ·å°±ä¸æ€•äº†ã€‚</p><h3 id="å¼€å§‹é…ç½®"><a href="#å¼€å§‹é…ç½®" class="headerlink" title="å¼€å§‹é…ç½®"></a>å¼€å§‹é…ç½®</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®<br><img src="https://img.xxlaila.cn/1571025388007.jpg" alt="img"><br>è®¿é—®æ§åˆ¶â€”â€”&gt;LDAP<br><img src="https://img.xxlaila.cn/1571027524602.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆä»¥åæˆ‘ä»¬éœ€è¦æµ‹è¯•ä¸€ä¸‹è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œç‚¹å‡»<code>Test LDAP setttings</code>ï¼Œè¾“å…¥åœ¨ldapçš„å…¶ä¸­ä¸€ä¸ªè´¦æˆ·æ¥è¿›è¡ŒéªŒè¯ï¼Œæ²¡é—®é¢˜çš„ç»“æœå¦‚ä¸‹:<br><img src="https://img.xxlaila.cn/1571027696951.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆå¹¶æµ‹è¯•é€šè¿‡åå°±å¯ä»¥ç”¨LDAPç›´æ¥ç™»å½•äº†<br><strong>æ³¨</strong>: å¯ç”¨äº†LDAPç™»å½•åå°†æ— æ³•å†ç”¨ä¹‹å‰çš„ç™»å½•æ–¹å¼ï¼ˆæœ¬åœ°è®¤è¯å°†æ— æ³•åœ¨ä½¿ç”¨ï¼‰ç™»å½•ï¼Œç™»å½•è¿›æ¥çš„ä»»ä½•ä¸€ä¸ªè´¦å·éƒ½æ˜¯ç®¡ç†å‘˜ï¼Œéƒ½æ˜¯ç®¡ç†ç€è‚¯å®šæ¥è¯´ä¸å®‰å…¨ï¼Œæƒé™é…ç½®è¯·ä¸‹çœ‹</p><p><a href="https://wiki.jenkins.io/display/JENKINS/LDAP+Plugin" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a></p><h3 id="é…ç½®ldapçš„è´¦æˆ·æƒé™"><a href="#é…ç½®ldapçš„è´¦æˆ·æƒé™" class="headerlink" title="é…ç½®ldapçš„è´¦æˆ·æƒé™"></a>é…ç½®ldapçš„è´¦æˆ·æƒé™</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢æˆ‘ä»¬è™½ç„¶å§ldapé…ç½®å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å¯¹ç”¨æˆ·è¿›è¡Œæƒé™çš„é…ç½®ï¼Œä¸å¯èƒ½æ¯ä¸ªäººç™»å½•éƒ½èƒ½å¯¹æˆ‘ä»¬jenkinsè¿›è¡Œæ— é™åˆ¶çš„æ“ä½œï¼Œè¿™ä¸ç¬¦åˆæˆ‘ä»¬ä¹‹å‰çš„æ„å›¾ã€‚å®‰è£…<code>Role-based Authorization Strategy</code>æ’ä»¶</p><ul><li>åœ¨ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®,å¯ä»¥çœ‹åˆ°ä¸‹é¢é€‰é¡¹ï¼Œæ¯é¡¹ä»‹<a href="https://xxlaila.github.io/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" target="_blank" rel="noopener">å‚è€ƒ</a><br><img src="https://img.xxlaila.cn/1571034253089.jpg" alt="img"></li></ul><p>ä¿å­˜ä»¥åï¼Œè¿”å›ç³»ç»Ÿç®¡ç†ç•Œé¢å°±å¯ä»¥çœ‹åˆ°å¤šå¤„ä¸€ä¸ª<code>Manage and Assign Roles</code><br><img src="https://img.xxlaila.cn/1571034433352.jpg" alt="img"><br>ç‚¹å‡»è¿›å»</p><p><img src="https://img.xxlaila.cn/1571034507945.jpg" alt="img"></p><ul><li><strong>Manage Roles</strong>: è§’è‰²åˆ†ä¸ºGlobalå’ŒProjectï¼Œå¯åˆ›å»ºè§’è‰²åˆ†ç»„å’Œæ·»åŠ é¡¹ç›®ã€‚</li><li><strong>Assign Roles</strong>: å¢åŠ å…·ä½“çš„ç”¨æˆ·ï¼Œåˆ†é…åˆ°è§’è‰²ç»„ï¼ŒæŒ‡å®šé¡¹ç›®æƒé™ã€‚</li></ul><p><a href="https://xxlaila.github.io/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" target="_blank" rel="noopener">æƒé™è®¾ç½®</a></p><ul><li>ä¸‹é¢æˆ‘çš„é…ç½®ï¼Œå’Œä¹‹å‰çš„å¤§åŒå°å¼‚<br><img src="https://img.xxlaila.cn/1571038684383.jpg" alt="img"></li></ul><p><strong>æ³¨</strong>: è¿™é‡Œæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œè¿™æ ·é…ç½®ä»¥åï¼Œæ–°ç”¨æˆ·ç™»å½•è¿›æ¥ä»¥åå°±ä¼šæç¤ºæ²¡æœ‰æƒé™ï¼Œ<code>Access Denied,xxxxæ²¡æœ‰å…¨éƒ¨/Readæƒé™</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ‰“å¼€jenkinsåï¼Œæ²¡æœ‰åˆ›å»ºç”¨æˆ·å‰ï¼Œå…ˆä¸è¦å‹¾é€‰ç³»ç»Ÿè®¾ç½®ä¸­å¯ç”¨å®‰å…¨é€‰é¡¹ï¼Œå¦‚æœå‹¾é€‰äº†ï¼Œå°±ä¼šå‡ºç°æ— æ³•è¿›å…¥jenkinsçš„ç°è±¡<br><img src="https://img.xxlaila.cn/1571037187865.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ç½‘ä¸Šçœ‹åˆ°æœ‰è¿™ç§çš„è§£å†³åŠæ³•ï¼Œæœ‰å‡ ç§æ–¹æ¡ˆï¼Œä¸€ä¸ªæ˜¯ä¿®æ”¹confing.xmlçš„æ–‡ä»¶ï¼Œä¿®æ”¹config.xmlæ–‡ä»¶çš„ä¸‰ç§æ–¹å¼æ„Ÿè§‰éƒ½ä¸å¤ªåˆ‡åˆå®é™…çš„ä¸šåŠ¡ï¼›ä¸‹é¢æ˜¯æˆ‘åšçš„ä¸¤ç§åŠæ³•ï¼Œæ¨èä½¿ç”¨ç¬¬äºŒç§</p><ul><li><p>Role-Based Strategy<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨<code>Assign Roles</code>å§ç”¨æˆ·æ·»åŠ è¿›æ¥ï¼Œç„¶åå‹¾é€‰æƒé™ï¼Œ<br>ç³»ç»Ÿç®¡ç†â€”â€”&gt;Manage and Assign Rolesâ€”â€”&gt;Assign Roles<br><img src="https://img.xxlaila.cn/1571037604678.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½†æ˜¯è¿™æœ‰ä¸€ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯æ¯æ¬¡æ–°æ¥ä¸€ä¸ªç”¨æˆ·å°±å¾—å»æ·»åŠ ä¸€æ¬¡ç”¨æˆ·æƒé™ï¼Œè™½ç„¶æ»¡è¶³äº†ä¸šåŠ¡éœ€æ±‚ï¼Œä½†æ˜¯ä¸ç§‘å­¦</p></li><li><p>é¡¹ç›®çŸ©é˜µæˆæƒç­–ç•¥<br><img src="https://img.xxlaila.cn/1571041499340.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æ˜¯ä¸€ä¸ªå…¨å±€çš„é…ç½®ï¼Œç‰¹å®šç»„åªèƒ½æŒ‰ç…§æœ€å°çš„æƒé™æˆæƒï¼Œé¢å¤–çš„æƒé™å¯ä»¥åœ¨å…·ä½“çš„é¡¹ç›®æƒé™çŸ©é˜µé‡Œé¢åœ¨æ·»åŠ ã€‚ é»˜è®¤åªæœ‰<code>Anonymous Users</code>å’Œ<code>Authenticated Users</code>ï¼Œç®¡ç†å‘˜ç»„æ˜¯éœ€è¦æ·»åŠ çš„<code>admin</code></p></li><li><p>Anonymous Users: åŒ¿åç”¨æˆ·ï¼Œæ˜¾ç„¶ä¸èƒ½</p></li><li><p>Authenticated Users: è®¤è¯ç”¨æˆ·ï¼Œå°±æ˜¯åªè¦æ˜¯è®¤è¯çš„è´¦å·éƒ½å¯ä»¥æ‹¥æœ‰çš„æƒé™</p></li><li><p>admin: å°±æ˜¯æ‹¥æœ‰æ‰€æœ‰çš„æƒé™äº†ï¼Œè¿™ä¸ªç»„ä¸€èˆ¬åªèƒ½è¿ç»´äººå‘˜å’Œéƒ¨é—¨è€å¤§åŠ å…¥ã€‚</p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ å…¥adminç»„ä»¥åï¼Œä»–ä¼šè‡ªåŠ¨å»åŒæ­¥ldapçš„ç»„ç”¨æˆ·ï¼Œå¦‚æœç”¨æˆ·åœ¨ldapæ˜¯adminç»„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°±ä¼šæ˜¯ç®¡ç†å‘˜æƒé™ï¼Œå¦‚æœç”¨æˆ·æ˜¯æ™®é€šç»„ï¼Œé‚£ä¹ˆå°±æ˜¯<code>Authenticated Users</code>ç»„èµ‹äºˆçš„æƒé™ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼åªè¦ç”¨æˆ·æ˜¯ldapé‡Œé¢çš„ï¼Œå°±å¯ä»¥ç™»å½•æŸ¥çœ‹ã€‚è¿™æ ·å°±æ»¡è¶³äº†ä¸šåŠ¡åœºæ™¯éœ€æ±‚</p><h3 id="æ—¥å¿—è®°å½•"><a href="#æ—¥å¿—è®°å½•" class="headerlink" title="æ—¥å¿—è®°å½•"></a>æ—¥å¿—è®°å½•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è®°å½•ç”¨æˆ·æ—¥å¿—éœ€è¦å•ç‹¬çš„å®‰è£…<code>Audit Trail</code>æ’ä»¶ï¼Œè¯¥æ’ä»¶åœ¨Jenkinsä¸»é…ç½®é¡µé¢ä¸­æ·»åŠ äº†ä¸€ä¸ªé…ç½®éƒ¨åˆ†ï¼Œå¯ä»¥åœ¨æ­¤å¤„é…ç½®æ—¥å¿—ä½ç½®å’Œè®¾ç½®ï¼ˆæ–‡ä»¶å¤§å°å’Œå¾ªç¯æ—¥å¿—æ–‡ä»¶çš„æ•°é‡ï¼‰ï¼Œä»¥åŠç”¨äºè®°å½•è¯·æ±‚çš„URIæ¨¡å¼ã€‚é»˜è®¤é€‰é¡¹é€‰æ‹©æ•ˆæœæ˜¾ç€çš„å¤§å¤šæ•°æ“ä½œï¼Œä¾‹å¦‚åˆ›å»º/é…ç½®/åˆ é™¤ä½œä¸šå’Œè§†å›¾æˆ–æ°¸ä¹…åˆ é™¤/ä¿å­˜/å¼€å§‹æ„å»ºã€‚æ—¥å¿—å°†æŒ‰ç…§é…ç½®å†™å…¥ç£ç›˜ï¼Œæœ€è¿‘çš„æ¡ç›®ä¹Ÿå¯ä»¥åœ¨â€œç®¡ç†/ç³»ç»Ÿæ—¥å¿—â€éƒ¨åˆ†ä¸­æŸ¥çœ‹ã€‚<br><img src="https://img.xxlaila.cn/1572057054289.jpg" alt="img"><br><a href="https://plugins.jenkins.io/audit-trail" target="_blank" rel="noopener">Audit Trailå®˜æ–¹å‚è€ƒ</a></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé…ç½®ä»¥åè¿˜ä¸èƒ½è®°å½•jobçš„æ—¥å¿—ï¼Œéœ€è¦å¯¹jobè¿›è¡Œè®°å½•éœ€è¦å¦å¤–çš„å®‰è£…<a href="https://wiki.jenkins.io/display/JENKINS/JobConfigHistory+Plugin" target="_blank" rel="noopener">Job Configuration Historyæ’ä»¶</a>ï¼Œæ ¹æ®å®˜æ–¹çš„ä»‹ç»ï¼Œå¯ç”¨äºæŸ¥çœ‹æ‰€æœ‰ä½œä¸šé…ç½®å†å²è®°å½•æˆ–ä»…æŸ¥çœ‹å·²åˆ é™¤çš„ä½œä¸šæˆ–æ‰€æœ‰ç±»å‹çš„é…ç½®å†å²è®°å½•æ¡ç›®ã€‚åŒæ—¶ï¼Œå¦‚æœé…ç½®äº†å®‰å…¨ç­–ç•¥ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹å“ªä¸ªç”¨æˆ·è¿›è¡Œäº†å“ªäº›æ›´æ”¹ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬åœ¨jobé‡Œé¢å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>Job Config History</code>çš„èœå•ã€‚æœ€å¼€å§‹æ²¡æœ‰æ²¡æœ‰ä»»ä½•è®°å½•ï¼Œåªæœ‰å½“æ„å»ºjobæˆ–è€…ä¿®æ”¹è¿‡jobä»¥åæ‰ä¼šæœ‰è®°å½•<br><img src="https://img.xxlaila.cn/1572057782047.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1572057958019.jpg" alt="img"></p><ul><li>ç‚¹å‡»Show Diffs å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å…·ä½“ä¿®æ”¹äº†ä»€ä¹ˆä¸œè¥¿<br><img src="https://img.xxlaila.cn/1572058118436.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬å®‰è£…å¥½è¿™ä¸ªæ’ä»¶ä»¥åï¼Œä¹Ÿæµ‹è¯•å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½è®©æ‰€æœ‰çš„jobæ—¥å¿—è®°å½•ä¿å­˜å†å²è¿‡ä¹…ï¼Œå¦‚æœjobè¿‡å¤šï¼Œè®°å½•è¿‡å¤šï¼Œè¿™ä¼šå¯¹æˆ‘ä»¬çš„ç£ç›˜ç©ºé—´æ¥è¯´ï¼Œè‚¯å®šæ˜¯ä¸€ä¸ªå‹åŠ›ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦è¿›è¡Œé…ç½®ï¼Œä¿å­˜å¤šå°‘æ¬¡çš„è®°å½•ï¼Œè€Œä¸”è¿˜å¯ä»¥è®¾ç½®æ’é™¤çš„æ–‡ä»¶ã€‚<br><img src="https://img.xxlaila.cn/1572058857084.jpg" alt="img"></p><p><a href="https://wiki.jenkins.io/display/JENKINS/JobConfigHistory+Plugin" target="_blank" rel="noopener">Job Configuration Historyå®˜æ–¹</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>javaåº”ç”¨éƒ¨ç½²</title>
    <url>/2019/10/12/java%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="Welcome to my blog, enter password to read." />
    <label for="hbePass">Welcome to my blog, enter password to read.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="11abbb0a22eeb32f17f6dd009ad39e4df6a5dc5023fe08dbad2224d16be54bd7">d69a90776b8106231e3f5503e1ddcc13376254b97345feb73ace3f39664999260288b98645f5d672c8b15dcf434b8efb50fed8cbb8aa3c6425fb32277ed9318843249d00df6ae0af9fde4365a489f7987292b585395484bbd3577af6de8926ca84952a5eac4c9a92ed87e516b59478d91f2be9a3d3d043cadca0f533e27ad27c50eb920d947206898c408ebe0a87a07d48b52f97f5becdff5d4613f727c5f29e915500e08a0fe6dc93a332a50e4be1b8c5f89f89f8807612a47abfb9b6fa4001200d38fffb27a7bf4ca3a9a8001cb128298629a37ca05445a1e259422fe40d43937e67b1b7db615c6880aba6b89822f550c677f23e097ff561b1de098cd5ceac33036117578371151daad8d0b3a42a414bf70bbc5cfba8e47422426c26f6e499cf58c0f2c58ca557fce1a893de88bcb89484d619f93274766d7c559107c905e1d02da85878d33a2c245ed3a9226c211cec3a54f9f89c008b883988a538936073abf2598ea8eff640ac458d9e6220a88baa14f474b35e192b4603572dcdf4b09b6807260f5d64b41c84081f4f6b4a665149d2be8ad7bc182564c1b9061c5fd671a0f89ee2b9e4d33caa7c041e1702bf7e49413d3b64f7829a3583bb7e514d001a7cdb31a4d2938a1a90ef48d9350885fb143c5013f237c942a9758e603bdb8110fdab1c25b269ef7b006aca52fbdc768f94f71202a21ac9d75a0f3f71739ee06c2bba71976d65b09977700a752d51366b3b24153b182d0effde65969da7d6a7efbc7bd43b2261f9c0aa3931f9c06e554012cf7005a9ce44a7b591cb48fd54f7f12768c812eb749a8c5f0b99a0bca5081cdb9f4c0a35233703133a468718c7233d5bf113a61781512bc676439f2da337e43dd1731eb42964ff36afec8f329855200a829bd5a227010c233f56a1e9889064293baadad35497d81ca73eafee848f5ba53850805325eecde2d1fb1c347f6e643eaf065f26468522395841b4d98ce5d996179f8974606f8ed54d44df24b3512e532f9b370ff8ddfbd808edec801b82e0bfd1568b47d245cfbaf02133946a2ccc7cac52b60099c8dc569cb371683d98254622c3414aad638088453997ecd749b07262550222318ad83fbfffd36959906955237f4954e044f6fe17f26e2b3354508398815cc86239271308c23792cd88d55bc5e2a9876dadb0497e93d28bdba55d9f6877bfcb0d8fc260a9260710ba57b3ad78bbad20607420125f880e707622c4cbd0b9645ee5561d4d686ec4e0ebf92b2ee066f7f42bbffc262d7139a80d3ad4d01520eeb3c1850bdc37a52209b1ac06808899fa83d826ea3c83f37d21c024f5aba0e015494a406659abda3059837b19a8e350ccbe0f1f1e58520f74feb86bf1b3999ea38d514390e6906dabb93a5b245007c082f0c7ff3e599660d2a77229fd89bb8b1d0c891809e0b3619e89577ddb617f9e69124a9eed4c70c6417a93b8160d85564bad4cab3ceebb21e6dd4ba54f0d786c3e5327e5e3b153c2eb2edd31eb0c382b47601b353b43c557bb37ad239c6b4f52d37acc4f9ba171bc93f3d728697694ec4d479acaf4e26dc622f0f5889e41c00e2ab90a5f15c12475e04240d6f8773930df04e7bf5b97567af51be49f9d202478c9a551d85de996b7b49afbd010117c9c8a1004b7e47c1982ad643baf5b76fd15699d9c695705601c90622154466517f144b98587964d2806f31f8e2a0af3ff6e2f14ceaf6e5a4118cc394598125271b7e7e154e85a4da6c6e8b01dccef211b9a6970c0b22e1d0e6c1e383a23d131bc4b3c59649a126e07486947120f957b468775659f589eb584b980c537f029e692ff32c62471a42464c4d380fd84f420f4885941f881cbf26a63b0bfd3ac784b382d1d7e7df1d1986308de207ce1ca4f65f9ce279ac070a6ec5b8c0d9112a093068939d33e0559fdf1d7ef06eb14da004f456b256afa06515ddc7074b2329b829f142569d295da235b315098d1da4cccbef5a8f815af72d9d43edaec57aee99c39f6dc1266e2308bfaf3adc0601f7aad60d3158effd6201bc0e680eaf12b9e9848ca753680e1a93ae551cf5b81c6be03c9c0b810782cb347550b8ebee0d3461de93ee33c6a90120df7aa1222492e4b8d03f1cfb8f6aa85450e219d87fbba342d5ea7e12e485ee2782d56e6ff6b12d71adeb2f210459b343e5b3ebc5c152a0f470a45654645535a01fd1c8bd4f7bfa4bb7d0b87d573365aae3cea23d06e1bf3b746e2b86fd1029a0e9af63cad082e4f8d88a1115cf376fc21ad2101b467d700ddf405eff8cd6000aca9687e9db1736d28486067e618696a7622911b01dac1aee5d4ec8176e97807decda351e24472a6d541661a05c5dc862a66976610a689ee233a2132d432f4c8d4d1d1dad1508fb4cb165a8ba3d41cf05da681731a942113c44a0bb52e3cc56f414aa7f6a62f66a04c25cabe609b47d4ac5a4cd16d00ce2e87488ff096aed89d3ae32dadc6c468d2487cf1354e7f87a33c037de4ca4513ee667d6ad237d324f8a43821a96f5ae3dee78fe27eac9246c9dde164ae0eac7fc774ade0ae0879dc9fced87446c08c87750e6aed91120d7e4a8b84e4531f26a8b16042029748a4ec1e64ddb9955b9481c547ad4e9d795bbef63349521cf9267cf10d95e77d975b5d65d84d61869b3a97e98528379f4c98f119c5d6ca563dad0478a3a788152be7b75727c35a66d6b297ebb4955dd28c0e6253eb6a07269e61e121a0db2607a05c06023cd7fe160858c25a1776c0dc3d65375f329a7c502dc01075efe3fb24e75bf433ab0872897dbd6340f6b026fe3833c935535c0e6f295d96e453d649393030c9a935abf7562c55575a5d787d200893ce96e4545b392e40b25a6ad0346ec17be0347a762ee46857a272987674ab17468e3fd3fd61930dcd20d940b21053192508ef434f53f5051d413451034c5e017090029b68bdb1dfe52162079d3a90a04c55a9f619ddc700df1fcacaf093c67d2bf593c233faa4be7092fd9dec7ab5005a2a41c86720b3d5779da7f55fd88ae17bd514b8a75c74c677233c3744b8b7ad5abdf6a89987e33b61bcafbf92dbeae955c59ef01c32ed8f799b6538a8f462b08dbd3a1d4b293f99ccede8667b75e8ad20a69af28d509f94961defaec298d0f03555693d8708576d3282be37008f635d6a47f8cff828201e84a263ac7d7bee7a4ee682fc7ea54f1c4f810199face62a9d5a5e17bc664e4355fc7a2af0c0188d54c177b953c6fe6ae59041f07370ce2bc726b9cdfd000809431ab5ab2acff9993b48b7d8bd20a89eaf6caffa5216f7782c06dbd0d3b39778ea6cbbc1f1b66553014f49f13b7c335fa393d2c85bc096508bc217d3b46f50acfe8514e6b2b6562fc055b4dd76c0a7445b3aaab32a92ae5cec9f7164d986869542649ea52a0cc66f9a28fddab94266e72e2b33182b897a779e5214681e130abf44790bdb113e67515ed58f48891072877152073a676ecb7fb995d7f8f13a23436e350b95728642d7094367121c35abce88c76a0031384bbc245e27dc43c3e7e5303124daf8c53682147120fd39768f977fde9d90cdc5cfb6c55a48d064c7da90f77e1c03c8b8b5aa704c40e7b77f7a8c689b08fc9e008964c0d1e3801768d151916556df1f80f6909d347acd5a8b04222d1df5c4fb02698aff3e753a5e97f8d10ed2dc1c6121865efbaac642cefb5f2de4ed59f986f1ddc04e5b8b738b77077086708d7b85597e1c52a59aa210b5a931b6f123d94a7c7ce19288717ea915fc51bfca66bb241d587d0fa6bbd8e913d18d4fee18abd0a293b29846e32b7a71c4c6b4831f6831886520f9a4d46eae0e6d3d49b28479b73e73edfa0cef83358b00ba89289e988a7307a87058e5b2e770278dec2ff0da0316973df6070241bbf10d58ebd69236d08d12a225acd38b65f2b1dd85cfd153ab2a1b45615dd15a619828264709eca2ed230b28b7d61a03feca5d5dbd48127d964ec3c52e97d358d4bb2e4e2784e872d5e9c56a0a177833035aed3334bff07a453983ed7c022b80cc92e77f5a581354817de4003ca5305bfdb1cdb31ae172a6027fec48cb080f149822a2673e6c645537f7ac94013f4881d7a2ff555eae551a711802cf22942a1996c4c0d8667d17b8bf89bc6396ff8877ea804d2ca219504532026c0defcccdbb614da0eb82a90e019096d7e69deaf55bacbdab3b96bf0e36adabdb83088ac4027d99f7d13154803aa42faaa273626151be9ef4d55dd41711aa37bf88abb7f1f47d690d772f66641e2661c3107ea5285fdd08570b61015ac61811e95df399fac3936dc9c74dd59e9f23333f8bf63dd83db68e6d29e93053d51eed96fd2ae8485cb8591b37c1dff06c7340818a4dcd9e97fbd923547a6e344a9f1a8ea5334ba147126ceb6d2be2ca301eda7f75e89a7e31f6a1423706ee1a7000545fc5fbf9894ac921c897a624fc0db3228b7e41b664cb53b5d3e4a0bc133624856a084e68e978004e28e504ca61961d042f3d4a6de19d23fbb57851773ac431f7d136f0de405afa6057e3a403066eb1d37c23ff10c0f7574a56b63fa8ef826fd875e2c037270cd2a350a20b25e096df4aee46d3c151e9cdce3b2e00b1c780f71b585f20ce2acce57518f16203aa397e8bb49aebb45ef4fe470e541287fa49686355e5996429de7828da2ae436345c26fa22e33323da48bb3650ad3544e5b8a2db5597cfebbb5028a0be3c5f93d89ad03653e00e65e342ab3177d43bb376fb0f0200bd63fee04a60d8af6c48908071ebe5ff04818ffb3079fb9dd222631050c4f9050f8951dd56d49187e246a90109862fb85bb0491167c9204b56f536141655fcf947ac8b474a2e7f1f31dc8131978f1464110ef62897d2ba592603321c6724117578d1a5b05b21fc75d2a0a7f3f75b59ec293df2c5699f78eba0baaf0a78f7ee88574327b6e4808e1fdbd462c0c09694ca386f5dd5b316e97fadb9d10850ba2536ca1f93609ee1534f5c8fd4e57fd7da7fc8f87f2a00ba9e2da08ecbc81b6379587806a343f20fedec280545c282dc6175adb1b7fbfb95c84753896234a065abfc1d4dd9a5f840c265ee9ab000ffb41ed17cf4c7693b78009b339cb1744e0d1ce98d1442b69787eb2ab8a0eb96b611fa74c426ddc1d0e73666b408cfe083db94a38a46b864c60232bc43eb46c1bb511d6b2dc495894e302f457429c864989c0c06e4ad4aabee6dddd892c66854419af11b33d183addf9ae10dcdb72229235d29e47fdfd2e6f4275059b676347a61e8cda650b910c972843cdfa53eb9411cb2d6e431d7e38cd4af004e623391f06d6131e5f24754f126ee86c30961beffe8bbbaa8955c43d1332af8c4bfaf56461ad185571f1b8a5c2e7fad1a9b603eeacf66a3e13042de5942ae88905d26e6f183eca8dfdc76778cbfdeaa61f72e1368c2368db89e5659ac203851079ee771ecde67887c46127a71a0f46ac9306efa18bf2e3fab7a9834f7f6a4257b2c4a93ae3745dd92238816ca4fb69bb14820111522a915bf98b28ac64711afca7e818ce16a61235c31b6e600514695a122da0725445c9858d09f6c75db91d0e9627df0bfdec3e1c7f03daf22abc7caeaf95a25fcf7a03fcb4dd1194865d35682be5f57e9384f814de4aecae21888a303ca342349cc83cf7bc0828a5ca8db69be1aa3bcce95ad37d6c0c340c3b1228a38f991d38aba0d1528dcad6c2027ecd60df7159c1ad920226fcd73a1dd93c3c73eda6ef0c368b3fff51d3d92a208b0478a590ddce9aedbdf1bce0d9ea8bfbd6c886ad7be2e788047115026079f2714515923b06608fa551d2aebae9a4c512a1f7923c5e37790da1811aeee39960c760c7ec28d0936ee68ff29bf08d32062cd1de561b582ac32039195f9d872f78c5668b74ac6e938b5420b00bdad96aafce71c6a44792cd923bb1fb4cc026a4404237b7e767faf19f97c21e032373cd349d46485146664c3e63c0f424a736973b930d9fa653ff997faf3f03ac7984af5ab205cbc8e9f7da43daf72cc1d107f8712d77da25f2dbbeae3843d17fe42353cb62021bfe0c95b95e2da57212a0271784f5711c2ef7225c73e5608c11232b5b29aaa9cf4cb620831ad3db23b75039b36ca231e97233129080a947cfec0a4933015ba8dc6cf4bc2c817d29937b29fc89d8ebecaac5c2c24425938560d73ce1a6c5224724b8e1c71f1e3f2557750e35ed4885009e51f2ed005f380f7dace8cd36ce503ef40562d7d42f866ffd0a49a992bac5913693316d6d66cd7b8d1944e3fe296041bc0c6add1fa6cc996fc402b98058390261a79309c6bad4f4f78a3938687ac9f431b02baf6a7b3e753f023a191b3c157533415f201cbc3504a409b8442344b7398380125dc09b245c9f124eb0dd8fc781377e8dc1dce4e4e2b680a1a14115d9c05682e31c30b3caa40f5daf73756a5e79f0e8aa6ebfaf50a41f28331ab521bd5204668cad9205eb047d8cad1ff8d760227965f7c52e9283b90e4e3622262d40c2858453289e49d36557a32da770610b6fbda2e8bec0e268708be1de8862044afbfa22cd9c91bd2396e67723d777f90bdbfcccf63342e508917b1140d890823fa840898ec48d078709f3b16202f96ba93981b0f75bb17f057f107fa55c5144872c7f42ca9fece6a06ad13277d9f78cad811d4231d18416ab96fa3e73888160727b804191b8e361c2aa23b50742114907ee99efbb0b51590b07dcc1fffd98f70545142e0f87b46bdd57d3b01656aee91466dc14be92f5f4569719673817b14a4e78c85a0a975ac1e451afd08fd390ae1221927a96ffe7426bac9a5f0a37455da95dd6338129429f062bc01c148a26e5d8f2195cb154fcb2b79503a9fe5ca5ac9832af51d7f85a39248b324e9fa663ff83356eb7ca3fb18db0a1787223df39188e748622e9837de557031cd54dfb7c51fd819c7e6455580a38218391a7048199ed233ba55b980d9453956ac91c27ce54cbcb25ed6fe8c621bfe39c219dcce7c58cab2d89c22500bd2028e6f51e1903e45c4103c2975e88d81ba1ad4971539313b57294525673422ad0289b53d0f4e7cc42d2eec08883186e82431af4feb4e047d7545ca3cbe5abaed0c2704698daffc1fe430927934376621abf5f6436554e859fba31da443373be4d566185cdef8d2b8a2cd83e335c9baa24380abd0c0e186932b6431027dd3b318a6140f73cd8f610250c4bb10ef20a2ac86eb304157ef76b190396e6ffdfcaac3bedea35a9864d8165692c85dd915f885f80542705876743f35ccc59b9b6c2567de498fee66f75d54e90e85971563760e67ea7bc710dac5917f72544e6560a2a19d0179f36fd9b9e9d9c590a14ec288d002b232cf323dd0892e6b1d62db374af5884a8e4280950ca8b4047e54387ba5bd74261afddc0d6354743b069f415c131bd6d03c09eb0bb5dfe51ec08e8e011bd25dbd9d5ff61129ababe948370da93b484cea4074c8c883fea6f6b635e9a1bd22631e3d05521fd41f0b6138f385c9661e4411a1c6e9fe15aea06e61c2a1a61ff77c0fced9273def3da647256570b8237b573f4bd03c114093c7768381c37ce99b26fffd9d59026679f777736a4e478b5d2a5e5b2ee118057d6aa2511485f8f37d0a37b48ff3bab7713cd7267fe700454101ebe4f0bc0c3ec5630195280a37a35b9a1ee41349dce8b6737a42053b04d9e1409bb6a5288f78d18dd119d7493773b1ce0210110d77c1377324bdec208d25d0510d9c353ca66b3f9dc9a0c9d3047e8805e340ff258659d085fdcb7f58b019ef5c0e3435019efae5b67c207ce116a6a155f657bb901d437043fc1b32ac3ff25a7a7a0041267fc9c5bc64220421cc81f960ff3feac971a727d042c7718ea5b6ec536e319cc161cffac06650d0564c7c4b73d5e17f7c77a5a877ba4d56f13019d783da9d94c8ca9fc0900dce62a2a67d8b0a034f59c1b673925fc710e029f1ea096e4f362575e8f1809c604fa3999246cd2c13ea1327da5c9e2e7907f21f8102eff7e41087efcdbb4a5d5defa0a71105b6111bb3ea7f6906db34b2f79e69df8ef5166c8a93f2a075ef3b18fed378a2f1fb16839a1f17f6c32bb9eaa489e40e101102065f50c015fbcb170e070e5dc39ea44d91b526ec75079de2f71bec524708ee098db3122f8ca7b3d47a29794d819deccf7f63f14ab149e35c21593ba26910703d869944999585fb286f6e0b7afe226741cadb649912fa52a1218ff1cae85b6431750278a196356954bf58d26ab8c84bf768683c48c941480d27e0f7245c2c2f14b71f1ceedc5c999b6be5b37c586b6aee32f280d46dc6e2cbec29ed12975d6314a5bb313e0b7c697801b58151e34976310aab2921aceef3da72114d80447dc5f5c68c96ae13fe76aefc9e89a0e7a377580d0d8e330aa4a1e695bbe8d176eaecce61e72703b71df7751cf0bd901308be244441efb1b4c47a6fa400cdd6e44e215697b8586c05745e624797e2f250fac10abdf872e8a8856d57b0b058299b587925f3ad81032aace813a5334d5c2211f03a1a732f07666c6d957b61691e17a89d4173c9b0ff873886deedbd64be835b44be57946d9522a825a100259ebde7757d2b15ab2c54f737f6af7acf5f35839e333af3b953abe9e1439fd76c9679389725be65d81b08ffcf254159485e0f7160184fe4a4b4514b14cf1787d074d4fa9149f279308993df717beaba8f127122267ca78c300e34fb8a28726870d7f01e57cd520265b0fa884f53af6486fbb649ed168ec78c338fc17ba768270ad1d25fedd5026b89d9d98bd9771554bf6318f67831b2060479312e004aa53066fd3848f41a564a2b10e1b5bcf23fd52525777f5f70786bef7bc440053aa472aec60e02ec2885ec2ed4e28c1c17c749ee2cb883dc9b21c38d57efceb16abba474526a7c26c0642378d389be28cf3a0d4c5610fbca704800d8b564beb68cb3dc121ac39b2f0a769d0b51fa1c0ad5c9f98628752c5963bd3c5e210469e4b67e9e04aa0e8cc0c9571d73433e400ce5f8682bf34041b967930604b4c12f6c0612eb87a9de783b2734a70a39a83bb39508ae3739ead45fdae13625f31da73e67743306001c89ba6d3c53e1fc0a2130ab5d04b31f116cc7ca21505d152b50db450f97c22bc7527421e59d97e14cb620f742069d2f3e0db55222e219ea7eb702daa0c256e0cfdc0f1211627100c230c8984b3b1e7859ac65afdfbe4684e4442ba26a0aacba301b57952b8d098239f7516cc97071a2b656d7c87102b98d56c87e0e2974e30488d1a5ea10c7f71f828f0b49ff6efb21f8cc33b7ec2cbcccfcf7a03c57b66889182ecf179e075250db365eb2c3d432628877741e1af84410cc95e49e61d5dcc4ad81b81abdf59e40e01c3ab90b003ec1ac658a1aa8c9764979d978f39957afddafe8e24d5440b3293aaa962b2d051057605150c2f0ba4b8c72992c9cfb59a6c9b46a7f42bb676f1cb807a9fed45b7400cd2b75cd6fff5915b811b976b7def736f8431e9f5279aae463ccd99e29e0d34fc865408ce0cf16015d8ee9e2b5169f3f631a0e02b752df85150404db624d6bd93d8dd86083c90b06862b894a65277f93bb243818a8712ed9bf80cd05f6daa8769f73af5d2e4ecd13c4041c6673b4bda6f7cd0face79ece22cdc175f61d36916bdd736dc46b8bc1bc398b219a7cc4ebc11ba4e7313e903642001ffe36a0c8271a8a828ee9ad61a2b8a27a36435d3e52b53695287ecb795f36b497287e603341af254ba318da7565b9423ab943f954494f6e3272e4b631c543f91c630f1042e3f9deb495b52aee1b90f58e0e5a46dbcfd0512f24575e23fd19b8d0282e43778dd8bb2aafda6bfacec820d9c6cb766f003a0db98c4a39e213fcd2297ed78c26d5a1d415d0aaf60c2e2e89eac1bd4a58db74cb304d878a482130236ec65f9ea0060052ec7eaa361cd9a0073f9cfe62ed7de02e1561c809ef1069b647fa1552eac5ff1acf5579a7353aec131f8bb2786febf16296a740e83ff43f4ce08ef15a523ee7711b5f00bf9dc53963788eb91c0acbb9b64b60f112d21aaac71a41161cdaaac1f5d0c8c760a27f1e1fdb8b217d1978390038e28ee1528cfbe5e6c0fc33fcf853293ac64dfcad1286b7d47b111af733e4b6def3c34be74b31b913f8565d4cfd4af608201d75febf9f3c57cdffb7dd642c39630a8f5cc4f457e06fedd9394d081f3895c7f1378819637e90a1163da30603dc9cf47e315d1b726636eb77f4aafa360ebdf1a06fdd28bd535e92c15a3d8f25cb3d9736303d8bd028131e92d049ec90a20798834eae094d1569ff86dda9c879ab0ddf5c853b0a56cce16dca2552ed385f89d73b1a92b38e686f046858cfd2c87e9f81b6a2ee5275b0ab2957ad323330fe8aae2afce8be5a3d690d4c7483d9a2e52dc6d03bc243e29136a92de6f74dec3f5d15a12b79e7dc78b46b0a12698c0bdbb139ad7982d9042bfc2fa3203232f1ff429cf46721c954170a7db513bf4617364ad8b0091301eb402e374a4ed24dd983d8951efb85845bda939367999af5350320defd03853f323df993888e731fc5098c9c62e7b6f74c361671fcf5180127f080fdb265b3906fb7ddbbb28c9351078a6eefb013cb859d4ad92c28df270f4ec28ff2cfd47ede3cd5243b45f206f7cef1e0575aec8a7dbc642b49dabbeb75ad2dbbda8b593b23c7adec3a70d5ae749eae028e347018fc760dc0f5db0c4cf468d1aa4b1497106a0b1da34894b07490b3b033212643a4569e0a3602fa38ba4267fa3f7fdf152b6ddb78fd357099804b2f328b4e51ceac2108394db3a4f5d60a5afcbc9b8b5839096613f9ae03b7e2a56b2bd7d667fd458820cdab8b0518a58ab4b14b75d8dbea001465456227ac5769c9844e4923462d5619f80f1998c895a20df6d91866b59d44b787d7b4c34c25bbc079864d8151943aa71f9d60e2b2dd602073cc9367e1198b524c837d1350c8f66f2402eb263e33be7fe36cbdfdfd255536f8b606351719f27024970f2afb6f7b1a7b73f831dbe917a1a265d4ed822248cb661b8ea643e90b3f4b85c18dbfe7b00b9e7a35f2d293e52c4df4ffdd3d12c62462ea68bcacb0703830b61aa7882545993b074bea304f7b055603dcbb20de3730e648c52d85f530743cd6f250b5321e710e1a6680b627ba87e27b196d7fd244aa4831f9eaa76785371fdd832f2ad96f994679247c71247b92e4e4f6289d8addafe388c39d909fd1ddc29707a7cfc7d0372346d40ece4b0cd7383d7abfc41f4425ece8ea75638dda1a8d3401a5f136aa322986f839fd171ddb7a7be436cefba49278fa99dff59eeef72af0957f57513506ec890612df5c26c4d039d579bf706c9a244beeb87855a8a0dd1b8817bbcfbea7623098fc5e8ec03e66c22b050bec7298b6adf8e1cc7a05142ddb2b17f85d5ec2b885eeaa8955a2e994c6274c4aa9ef596d88fc1ad3b031acd7e5e67355b33e3ef4f232d74022b1222808c0eb5fa7117098406b6e18bd430bedf88f3ce2d03970c9549443cc9f89ca9ff5a9e7b5b881c4c71e485611b27b95d8f8d398d538c6caeaa8a5d9dc6b534a917af370aa293b2888f73d91ff1f4320d7e49f73e1515b376c4f8c85d898aa00286c11d78a8ea4600c2821a93aa4a1344a92d144a9fddbc06b6e20129c79e914f00466f5f9a76c9d8872081bb62aec82f8ecdd66ccba5a3f6ef275b2056433b4e5ee9343e406d9265bb53e850f0522c4d16347494ec25476391dd3e5bf6b776575a9297dfcd60bc136d20b2bca12940b8712feec3eb67290641ca496cac4171e5618cfa7c1e70ced848a19a9a10a41ad56a8c5bee9efa753e910e353ef21a2159bfacdb6439b16c90f4db789ae91d33691d3a0498379bce13d58dab266627ca5cbaab91f436ff01876236887b78f9c369d4228400b23bb4a216e9cde88a1156fcae3f430ac96032a83cf840e1ae0846087fc36feb97d04fa0848d9fb0ea0295ecd02730429b2a3c63a87f87de56ed9ace88bbebe12b21c7a85793e92dcf2e7162f6db7a3a870dc273d558d97f814491c54484279fedf2d637c9d0909554fc7950605f3deb2536134e6473cdefe93d833cb3e3306fd36384832ec46bc0e93a80813a54a4bd10184523f5e2804a750eaea173f884dae96068cad3d71055167d995160447f826ce25251beace12cccc0a6920f3045e699f40168d5cda094c9a7d96101a01ff02a1ef984a066efeea4fd8541dd8dc594d8829cd8816e24a5ab8cc992837399f0f127a6e9d01b17c6235bbfed4b22a9f719af127f0a3854e3ad6f8af6cfd03a9c5716b91b0acaa342fa7107489dbe44ff4b451d1572d841f94d8ea44032558e1226c6bc0f0cba55a70e11e0428209586e21f95433c70c710e468d16084f5fb938412ebd100e41a189173effebf67219771a259e514119c0cb30648185d73d5e97d18a7f63534c8fe00143d057fa46afc6338a6889dbbab4f5a956260af85afc5cac51234152bd7545632370825ed4362826589c7aecd5f1f0ccb844075cc6a954fa02586b2a0faa470daf074d9c942f166a8003de5353358e7e45af9bab720d4368e19450f173507a561c4fac4df6a87ae15e5b311e3e5670a2628f6177df3e3ca9f9fa01cdd96954fb0e70141c5249f51d76b6acbb6fd7b16aac86a2e1df71585ee5bd0e53ccfd5e9aad13f2adc4343a2f1fa482758f3e5f69fe2070ba5a485ba01c60f3ee0df057c0fc0157e1ba83ecfba9c1b4b21cc8da6861395b7621b7f941714ab6db99c14803e26bcb3c548a7415654b594ffbd7a23d56f7fef0641156d61923262d33abb9db36f2a18968af7d4f9dce79431652d6e0ced4e0e53df5e16e0ad23021cb288e5bef6b69d429da6df1e80fdf71efae7588a8d3b5057544ad3403c8ca20492a9037c42b86b0b1e7b195e60a9692835b1a627f05bd4ef10248e5f87ae314bdcfa96d52133d92e39be15fe28aa6160e426f9f8bfef66b1ce388edcf461e346fea841c605772adc728cbb50a1e92e6f2d3c36fbffadcc9b7a1a846613bdf2d00f771afba9b35e81ebc3e77696ea3c303a487aed663aed5aabbf7330b161afb25aabb9bf734c2a636ebb0170fbcc9f9f93bc4190c8531ef3497348f5a44301965f1a33ac542584a68546fd138880b4d1d6d3fe5ab51f57b08cee38d142f46cbabe08d3a172a8e4321a3a46262228e870cfd3aaf17967516aa2ea957e26e9e65f18214017208c3c8b5e3f92a722f097dad90743cb6bf9e05dcdf56b3b61cf390d81a196b42be12f05edad5817de67fceff2751a9e5c8d7e90e86a80e453f53042c04f019be52a44137d5e9967de2aa1779faa44987b4eda5ff73245296b9558c88d7f9d8445d81b06a2b72832e3fe6a3eff76a298a2c7643533330165143e6bebc3a825f045a7ab5376343eb511e1832c98f862703ae774b2dfbb9d839f0afac9f584d059851a5a865f0d473b1b0f8c15852efd3f3b266426c2afb1d1ab0d26e8330ad463840e17e39b7c4f9d672a9694671b4774f90dd3c5d8c386b8e921d47f507f8570f0bc9f5f11086f85bf718325f725bd260c26e8e3abf611bb9bb7c06fcbbc4dd6a3abf51d0b543a354776daa036b625fddbcf1bffae1926499c83dfd822d624955ae967b85b621922c3881f1879c623ca348479e1d4a566db32af68ec45de27200a73e0b69568ba4c33dcc5cb48c25acb661a4d3c11c6a530a4ee8bb5e9096f619b479575cf93fb93740a314116f839b763c363cf6c0daa59337515ccddf5f817e1900e1de9dbcd1322cc04f2f3096495a8816d96ad758d22414664676f30f063cda5add912a4350ba0a0541f414e83c46042293d13902ba7518812b9a365877a18d7cea80a35cde6f2d878c793d58eaca117d5713c6d678f6d505655ec4835b9c04dc75e49f67d6d124b6ecab8a3c8c70dca25789403b5fc88be34d477079aad2cac8caf10a878fa1213bca55d02c80e123c0aa9beae89510f46bd41ebf9fe471c74cf676190042fbe56fc0544d49c0f0ae3b9c2c20acf589d6fa85b1a1dc8f1e1ebdc73ce2575b9a0591a4a6362ff009d35cb6eda4e022295abb7ee284657c1b79f535c6bbf36e26ff78e9d77b7b428e8b0b03d553a2133839ae730da72a3d94ddae105a26c656d0784385abd47bcedf2e74c5a845eaeb3ec3b47bf9e674eee4a67dd45a1a7a78a7bd57544bc2718456ee98e50ef48fdc954305b6f9675e802d4cf071abed82cd0809d777d89c501ea9aeab090f65dca13e4fc1dc67313091528fa6d3a8a826b393e39d0ff02d1ee3622b700220a7068d6fb1526fcbe460ec07e826c8f94f3e00bb824c04a000fa15bd3bb5bed67c76736b5ea9788f76a0d6065ed5f8eb5c955158628a803ff001378f32aef345c151c0b9fa17719d4885cbcd034bff1ba71bfcd8eed105d237198165be080243709acc913423c1f81625a62b83b10249dbbe79a245fed239a724e08d61a7d71b56a17936e882d4db65354f721a708e3952c9c14075f8a819654848e2ff316934aece6a6ed9784f11e59dd5c3ceed6fbd7b55859ff4284578824c059693d0d0b467c58e9f52a09d497511dc23295a92f129a0fa28a0f81670692ccfc4769c619243b2d20cc44fec6ab9efe00aecb2f67d78b0c733cbd0ee7eb7a25a79bcee29f8813680a2d56ff62b736a7e06883b101498d0910e657b90f85c0c77f7b87a493562f980387711ff2f55944110b0fd73aa04e6bde3cb84eb5c7179bc16ac07865f426b9d32443ec52507a8a909b615a504d82fcdb38ec3da4f0a0bd1bd8b0e756aa7e4454b6e752a8ddc0f480fcac4430eb669c4b71f9486c47c76d3fe9767947fa46aac753f1ac9ce02f6bfa487ea7de575f3d779f78937a41cc4a5d38603dbce4761c09ae2c797602c9064360157df3ab18920d684cf9e499a69589aea01a9ad9923efc4b7b958c28c3e36d632706eaf92991eb54399ff4542dfcc7b38c1300787d6e57b98f05e103ab866b7c3447190bb489cd13897a27b36af536b707921e3a440d7a5e6cdcdb66141b5d87bfef6c3c3b4496d3faf1f400256b951a819a9ec9352380ddecc626c54d1408e9aabd83354b21ebd1680b2ffc0cf634de84d9f739b2ac7abf1a3ff4d456b6d6d2b06d4568a910ed7ed615212a990ae5de46a696e716460f44b17d9c5f65b10ead14d9136c23575fbd6fa321ee2bb9fa29ee2ebcd4b94aa8ad61307c2614b2f8a87e059fd552cef31b7b5390a1a69c90286f96b4ce95774e69d02060a7788deb3a8498fcd534758a1e166a5986c377c89a3afdd315791f9173053ea207d2f77130c816114549ffa26e102fabaa2faba08893cc2320536762df40b876e3e3af82309cf588bc13894eddde8d55962ce52b462b73b89f86bedab2639e2babdb76aa02308262101e86ce715e6843dcaea66d02ed56aec5e1fc3fb83137e4a000c5a2cd59fbe15a19dc906bb7066d6aa3628b9ab25c6bbca0ebd67802510d3c19b6436cff4e383b15ca55435254bf1a7f3c4e2841c623bb21deade6a057eacadffa8c56da0b5fa41194bc006ee248c258ce912d9948237f1a2b804edb23802a50721f605948158ebcdd0c2121679493a69925b7930c910a89fc3469ac751713b50474ad1e866af1b2aeb1d551b7d4a27f8191feb9af19b4472db29cc331654468ec3d553911b34f7cd97a5b243b24951acd9286233bbe2cbaf4b84f681d7150b14ebe16eeae94b890fd9e7697ade5d4439c00013ce880378ab35630dc8c09b12fc30f36e807f050ff71cf1a399fb637d9a7959cef763756d9ee8455ef54e13b4291a71e9f6c9dd59f84959e84a2f15536a02deba7abcae371b12f7d1cc999fdecaa47da8c43924ef0a05cb60cbfd2dde2be867197e5d3087b2980d2eb5d213710dda2c70b8657efc0f0fcb29eb7d176338e438a72da5b98e6abdbe6ab65eac19caece0ebf70cb4ab3aa71deabef717cc48892618091f8f36fbbd3308beda9dfe10105f9df0c56ec9efeeb82d746adaa3cfb59849f97f3413183216ca3e6ccdb313088086af5de893060db904256188fe61b5a6c070f01bb237e22920fa17f91a088011f784d25cfe1df187ee959b1169644dd52bf6b2accf3d37e35bb4b0b38ef8d8db230c6f77dd8604f6f42a24778abf72873725c554474cbc0090d7de89ea012e699f4eb20a0d59c1f2ac3ee3543b2c40f5cb38e92a56882bf32d56e913f4ab6305778fcc06e3697dea47c945eecb1f8d451f73db1e129c4eb002422afc6097b4b7d4bd06d4e4ea1fc6e11a48ffe329fcdcda1fe9e9222762f24196ecd63f695b1454b314b148d4891127b028c196315c1f1c3a79b8be8f07b9c081e1d30368805660db58cbec1e445596e0c624c5a66e0478884a53660013ef60ab27c71cbe5723a6d71a423ea796acfceea28805a56ad5433c3d17494db759cc15850732040754737bfd5c0247ffad5f8807ed8d7919b81452c733ecaa21a3b86e9693a712351892a89cb1e81ffeeaefe44eabc36d9e611ba9762a5d78eebd1c49154b645fbe49061f8c09282d1e703ab86f467d2899dec23654d92c3a58fdeb753a4987a85099a0ebbb470367e6292fe3559107fe8dd980310031e1f4ed8855638ae72ecf535d0cca90a2714a485f9ecf2b1546002b6628811c58c4ad3fa427b62840bd393b9c0210664fad68ace305856ee306f6f1da35d0a544a3712d5a7d86da661f2c95112660f2b8a3f6346c47bd1f8c3a8c798ce734279553ec93a0e7ab2c453c8bd18a3b1e7ccc9d723a5f5beb7f09246c069b7339b432f52e72d34e9cd474e8bc1a7a59a8a68ab57335baabf6d8e898828937c5aacc3005e10329810cea9f592f451c3aec72bdc36f1313c5e38faff2564d4b1189171cbdbdb0d4213c0c0aa0b05953eb00b7ffee149f1c030c41b8584fb6d7f4ad3c5dfdcd4e7c476424d7715f844986707206ee9bb7a6edbbd84a99bce064c5c738e20235b456abe3ff2f881e47d1fc3f29914ec7a0f59db9408327a774d2b42c94725e3d11729602d22df8352f096ae82207667c98d5441d191fe2abc50e75e1d7918d81f6dc725e0602da682f29d05efae31837e897cef4d8fd289611067836531206b47f275850e7d3f93f004d9b9f27abbe5b94197a2f2d6ed98ae65973d519316133a373a475dff542bfd8398e36aa1780b4097fe50d9cc6c882240ce91908f764fde95a545316ce5b3af7bea79362679e4a12f95cf92bb159cea6f9c116dc65dd8a9e0d4dc0bdf7399f384aecdf3551f8e170ab804db556a1f5bf638ae2e968488f8506481276908c8968081eadc3a2ff9bd0cbc2ee29982449cc7037348504ef17d32c3376180c45a4cc32e5d608a5bfb172f9e0ab5e53a3a83926f30ab1933d0ccec13ff553b6e5f0fe98831727dbb28437c8df35b2dc7d74a4734440ec28aeec1783ca6c30c0047d692af1587f8f8410494b9bd99d9b81da8886a43439f7c4621811619ea58010ea0e599f63c9a2640de5f23cc47d192596c4fbe6c3f75d8f1525a3b6c6b455eccecbac7a341235600e5151f651452d5f2b32cc8fa0b1690d8be3d08385bcdec537a8c82bf10fbce89c456387f20053843093cd86aa7261f5a8f8d08ea60d5a84a36ac47f51d02b8f4baa0f9beaa3e3e8962606b5b57eb7411963e58972fc0adf2683a5beff6b2a74a9b712d03e7334203bf4e7dc603820a04980f9ac4d0273b0bf391df3743d6c739093df719f5a3880dc9bfad3fb0264e361e7e92df54e7334cb3f89684c9a963f00df103040950a065bdc836dd63d3eceeae45ea013724161bcff3939fd180a09198264e7ab52a25e99ee7921a4de2b1e48f083c08cadcf417eb56b4ef5d36ae5129b6861227d4f8d773d4220ddfe8c7102c3fd981c1828a109367b7edcb480c71b1e126368dd5d3866f6c14f8573e4159bceb9cc5494a70d0f1282ddcec81685572824bff433dc712747fbb5579d9fea9787be3a8c176d011ae8672baddeef5d0425a7400723d022736e1a6e37815afaf1be6766b84ce5ae8f22f3883e7b1c38dd87a98966787cc583047e3107c4a804a00f63e8d5ec1414a0a7e76c8000011627571ec9ee70c11b6656d7dfb1f9d4e9a391ec9e8506a173ab4242dbae6bf54db355d42617e58bf92beee081ed553dc37984ae77ffd0a660dd2cd3928b1c37ea487ff2112fee7889ab5ca46ad19c732e725ebebc167c2be5c093372e848a3a7c806f55c0425f504b52994f777cbfae115ba85bca0f731a487df252640b55e9206cb4c374a980611d68b5a8073e42c3d24f97746b1df00ac952d585ae6269634dbc6b73d7e22a96dcb2b62611fd0065977548a982b50b272ba0e5a879a1e11cc3b36107b9733b2c21ca0ba3cb87feb0b6be4b1df791cf41a8c3edcbda3e77979335c791f0cd7f1d2780fcdeb882a91191d8d88e57f69c343eb62e529fc3cb6591c395ebc238ce5d3d113023ae867a6f16a8cda3cfcf9fa623f6555a7d4aa6da49360f4d226b986aa158c9955aeaea5d8356b527ad0a9c64927c918ca435dec0fb7d32480ddd39bcbc322046487d11c3f591e508434fe944fef5ab4a51d27b98d4f6bac03f1bfe91393daff8a7ce39e0827cf8e3e43b81865d9a0db83976d5ee5fad3ad3be2ffd7e7ff0601cb2b67d192d10524e6b736e737d7c0a758ddb9368ac278e2718e970e61c5717c6d782e8b36a3b44865788ab4f1bae5f37a151037a0d1d4f0f9dd5be43e289838755d131bc9dd6085d91455ea8e350032d161f27e822c5594090aab52431f20593aeafdf1c786530f1c5ccb7a7a9b23ab675edecb9f91fadd02398ce9430a518b211d67aed33ad60a78334684c014f107207998bd9593f4886fdf76c5ffeaa801fe58c592ccad1da215e9c3e0ef4c596c15280c96b4e2233d57f4409a99f87d748febb68a4e37c9e2ca3f85a0b9b550573e44632ffb86a31ee9d3136584a001397d541df63303ff740d48b9731b30b17ff41d4fe4050c40a43eb1439c6b728b4f4f4f48df0a0a26dac44a390873151f637561331337ce35884ab2bcd9e7fe614a773bd4d1f3ebb1330e716f2db101a1694c08522d4539dd48165a7a12343307eeac1e5be22d2be41b8f294e660601cd419a3cf94e72281316c7c17684a02a7503e1df8e0ccb2286dd447485597bb2ee81538cad784798a9f0b02cea86bfc85aba50e22af46d517e87854284b2e94eece8a0810bdc5b2f57a7c70e69de3b2910b5a9dc7551252e0fd88212a4b4e0a864e488ac0237c9813a579b42d3330a081f23cd90f099921e82aba734d66cfbd1ca1a1ba5890c8d3a07b1847abbd29b6ff0168be74e95d7feec911c41624ea48bd808cebbb6b9700461eac19bad0410ed35cb5fcf8ad36b50d5e8ea561766b8a4a546d15a9012ae2ec255115e3162c6286d619b1a9a93b089eb997f8994c966a2034943474f190fdaff1893b75d71c97621c84ff0561471d894b454f02b3e0b7b3a8f0cda97e5ea7525ef1009458948bf9379d17a6720296eff1eeb2bae5be4f3c049107eee3eb15b6d79bfadf9ffc5af5c29da2bd1e91082c0844d4afc066ede1a7b549f972cc9276b4310e79a4d1510f6448b4bdb8090bc610c6442b748106b4dece5d041bbbedf8dcc9f302d03c33358329064247ad3f229b1aef723dd3d233da15f26f5a22315c3ea8a9b760e9ac52d0fb0ebcab4dad462a1768d64861291a484c36eba8012fc1c3d0e98a921411a688968b30bca9615aec83ffd6003a85b4fb36bbfc05b2a23f3c57e35c231656a22484642bf76a238f203f8be2635504f21da06e4de788ce4a71107749e0717833d476f164edf315bf445829d86a6a563fb787f6782d54f99b498b9b1f7b3c902cd621643940571f41373653644e651be1199a7f3ca5eea4ec2e79348042696e976b301aaf1f33a73b6570f749c94299ccdde4185a469145925c4594922aed3b9c799ea1420ca3e0d15d41f07c2491643f0f5f5e444e974c2777464e7e98234d112dff3b6851055c0db075326a72eac839b2a1c5517ad249762cee8e2ecb08a8a58b2f851f960bed53d0ae24d6a716b453a6b91e8dfb5d2be39ac4bd948d82f514aacfa79627940798ac864ed17fff81649290bee46f78b571d466f5207a69e797de1a4c9584c51dd2712e411cc42c4df70cd7b6df43ca284cbcbbe98a99f8d6227b8bd5e167c91e4a7c40b239f9215b28a2926c55e18d5bd341bc646cfe876527eb12f6bf34a7a604e858165f172f0f0d6b428b8b91df4d0d0a8876c3e9e9c3854b3120e45bffcad76a006eb2d9d614cab674fbf647eab1629157af062d4cf882f565def0b93091f3e3e4632180754eb711a9bc539ef0c00d6a0c4cd1f578e4838eafc8bfe7d5aa3563b815480f6f96a67eaeb9f421c22ef20a73a1b440456f7b83bca090ae0fa345002cfdb9c8a791e2c5a724380c3db4e79295154beb57cd5812ae7d5363d4d5814cbff101a56b5a3dc04d1fa12d55e58428c8c309990b567f87093acfc8d1f00f7d5dac3885840b5bfcf24c739ee610882304715c18fd37aa1803910f5c3c6252b0ad8eaae11542870e7dd7473a07deb9431386d283eae0b73103b5fcbde95915244790075e37b53f6ca2a126a8c5d07e2953c8f4eaf05ad7c3a46a5b10d6a73e842a49954b7e3ae5998a76207b18047159ae2e6b00c77e890d1db3e8ff3570ef3d5d20b2ce81004fc293f0d6f45c28dd8c6626a0af5d947b2bb4993996c7629209cb6b09a5f29d6e0729135ef069cfda793ce2576e84defb8be23427a643912f1eb1ac78a1aaedced2334feff6a369e2d5926627146fc6180b2b3ca6d37cfb336052a54700ef2bc26f5582ad1853cbf01f60ba75459e887cc19ed0dc412aa8b38d157d634ee5c25a5cf6cc1ad1df1f96d5749a5fd9432d4e448f4d60cb030b45fbb26ee3423d1d86cfe28eb54fdc07d09ae84d60ac084c770b781a29149a6d01b53bc219372310b55e49b84d6adc0c3d451c8b900603e5ac88035cc2ae6fb66e81b1f29bce368a917e2ffb13cd388540732b5c92496b564768a7854b0cc91b7038494d5615cbd8e8a29b28b3feaedf7f5ab0a61f50130587d77e150cd7b590bdee67a46d86abcafc093c27d552593ac0d12b31d21fbcb10c733ad33fd5d7f569cdbffe95516e3014e05b8a3ddab3f69390af2725ebdbb8e06cb8b45f437ecc8c910120dd69a77c086d6d8fa31cea636361c5fa457624995a7b9258871b55115571cab68589a54675ff09dc010e9934efb06a930d1c1717b53235bd1641220d9bfb499aff839d40f44206c3b42e8a657247cbbfdcfb3ff776c2b9e6cd0c4be766facb6e1dddd7c52c169d824cbaf94a70e38ef0b27f1d6014545ebe728530077647539adb152deabd3671c3192e57dde561f483694d04d9fc6fd1ebb0c9aff97abece005d3febc4905fed925aea4d73a01bb6fcb99131c90a0bb700eec849d5dab90c388dcccb32515b70327cedfb5c8e5b5a4b84dd4fe9ffc2358d34e2ea436a34e8243bdd161cec19386b1bb3447cd885f886c980829f5d62136e51ba74f1af234ae457f8cda7a48d2e9a21af1e60482c6c4d5047115b988c6ec54cd209d87ec7b2743c6e632673429a68fa1e6af56585abc7308e141ab5e64dfe6cf3da675a384843f157d4e8b82daaf66cf62d9ed483103802674a7b1c29646be4caee5b13122f681e9c4e0c3684e313bdb03da55142af73b894274a73209f268a2aa9c6f6cab88c6312724036ee8b2cc60c30d1a428191fadb8c65d204748faecfa43b3d550a7df76d767fb3178c1f2c29b9d6591599169540beb45fbf7547d2f2354e658b5fc67bd25ed1c18d82967861ba553e69d8d3bea23ef111537de9af9b747ad0d84db4b51a899110bbdbe39fb8cb3e9840d05d22c3b64e19cf59341aba8d38baf3c19f0a7cfcd9d22f4c379955713f8b19a2a169b16d4689ab2c05caa3072207ee8bce159f426736bb634c6a9c4f0068520bcf35de5f4d5abe30d3a4372845b163e7b2d4c8eecd9b73f73bce25fc0b0758bf65ba8eabc1bfeb46889de269b4fef6f5c99a68c1747a40483590c4c0979f3cf8d729f85889ff1bf4b18c5cd954add00aa6e4a5952a74e32132bb514d2c9160a19b3572e12bfe8a8b4543cdaf687988054ebab6a024c4d645aa9d39eebde8a75ade1822b942d3bc0e856ef952ec0005007544d73f8dc22dc3611e97c786817782c700641616fe6122576c89e695047e513db644e79a75971e421a51f62597297afb56a11b293422494ff0a980e7fa272e9880b8648d99ba1ac34be4d1dbc4ec26e3b8ee83c442b971a632e8f0081356c19c42050a3613d25004885c67c99e65c832699d0959c7f10eda64292c581eb96e894d4b96cf8812d8804c0bb6c51e484e539d0ca06deead3b18c3bb9f11f90deb8b14ca9d4fcd29edf246ff69cbf26ceb12559f064bafff9c62b55f6cc780d61230c9fa4f400862e4d0c8f23a6fcf1af426827dbbe475b9a0295ddd3c11c57f85a3e110804b5</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>harbor ä½¿ç”¨</title>
    <url>/2019/10/10/harbor-%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h4 id="days-2019-10-10"><a href="#days-2019-10-10" class="headerlink" title="days(2019-10-10)"></a>days(2019-10-10)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢æ–‡ç« ä»‹ç»äº†harborçš„éƒ¨ç½²ï¼Œä»Šå¤©ç¬¬ä¸€æ¬¡å­¦ä¹ å…¥é—¨ä½¿ç”¨ã€‚</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœåŠ¡å™¨å®‰è£…dockerä»¥åï¼Œæˆ‘ä»¬æ€ä¹ˆå§é•œåƒpushåˆ°æˆ‘ä»¬çš„ç§æœ‰ä»“åº“ï¼Œå’Œæ€ä¹ˆå§é•œåƒpullåˆ°æœ¬åœ°ï¼Œé¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šè£…å¤‡dockerç¯å¢ƒ</p><h5 id="è¿æ¥harbor"><a href="#è¿æ¥harbor" class="headerlink" title="è¿æ¥harbor"></a>è¿æ¥harbor</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker login reg.xxlaila.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Error response from daemon: Get https://172.21.16.90/v1/users/: dial tcp reg.xxlaila.cn:443: connect: connection refused</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œç¬¬ä¸€æ¬¡è¿æ¥æŠ¥é”™ï¼ŒDockerè‡ªä»1.3.Xä¹‹ådocker registryäº¤äº’é»˜è®¤ä½¿ç”¨çš„æ˜¯HTTPSï¼Œä½†æ˜¯æˆ‘ä»¬æ­å»ºç§æœ‰é•œåƒé»˜è®¤ä½¿ç”¨çš„æ˜¯HTTPæœåŠ¡ï¼Œæ‰€ä»¥ä¸ç§æœ‰é•œåƒäº¤æ—¶å‡ºç°ä»¥ä¸Šé”™è¯¯ã€‚</p><h5 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h5><ul><li><p>æ–¹æ³•ä¸€: ä¿®æ”¹æˆ–æ·»åŠ é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"insecure-registries"</span> : [<span class="string">"reg.xxlaila.cn"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é‡æ–°å¯åŠ¨dockerï¼Œå¹¶é‡æ–°ç™»å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl restart docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  docker login reg.xxlaila.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure></li><li><p>æ–¹æ³•äºŒï¼šä¿®æ”¹å¯åŠ¨æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/lib/systemd/system/docker.service  </span></span><br><span class="line">ExecStart=/usr/bin/dockerd --insecure-registry reg.xxlaila.cn <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨"><a href="#Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨" class="headerlink" title="Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨"></a>Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨</h5><p><img src="https://img.xxlaila.cn/1570697850857.jpg" alt="img"></p><h5 id="DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾"><a href="#DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾" class="headerlink" title="DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾"></a>DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                     TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/xxlaila/kxl-eureka   v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker tag docker.io/xxlaila/kxl-eureka:v2 reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/xxlaila/kxl-eureka    v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br><span class="line">reg.xxlaila.cn/kxl/kxl-eureka   v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br></pre></td></tr></table></figure><h5 id="ä¸Šä¼ é•œåƒ"><a href="#ä¸Šä¼ é•œåƒ" class="headerlink" title="ä¸Šä¼ é•œåƒ"></a>ä¸Šä¼ é•œåƒ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker push reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line">The push refers to a repository [reg.xxlaila.cn/kxl/kxl-eureka]</span><br><span class="line">f6026bf67b63: Pushed </span><br><span class="line">1489a4b0f1dd: Pushed </span><br><span class="line">2af6e035aa36: Pushed </span><br><span class="line">472cfce4528e: Pushed </span><br><span class="line">071d8bd76517: Pushed </span><br><span class="line">v2: digest: sha256:20d3bc74fdcb2fc4cdfc9066f742c828898c728f7e3f2114498ebe2848b71653 size: 1368</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1570698233987.jpg" alt="img"></p><h5 id="ä¸‹è½½é•œåƒ"><a href="#ä¸‹è½½é•œåƒ" class="headerlink" title="ä¸‹è½½é•œåƒ"></a>ä¸‹è½½é•œåƒ</h5><ul><li><p>åˆ é™¤æœ¬åœ°é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker rmi reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker rmi docker.io/xxlaila/kxl-eureka:v2</span></span><br></pre></td></tr></table></figure></li><li><p>ä¸‹è½½harborä¸Šçš„é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker pull reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line">Trying to pull repository reg.xxlaila.cn/kxl/kxl-eureka ... </span><br><span class="line">v2: Pulling from reg.xxlaila.cn/kxl/kxl-eureka</span><br><span class="line">a02a4930cb5d: Pull complete </span><br><span class="line">6ea3dcbee0db: Extracting [==================================================&gt;]  81.4 MB/81.4 MB</span><br><span class="line">6ea3dcbee0db: Pull complete </span><br><span class="line">c423a7a79cc1: Pull complete </span><br><span class="line">7418081934c1: Pull complete </span><br><span class="line">f89b73853622: Pull complete </span><br><span class="line">Digest: sha256:20d3bc74fdcb2fc4cdfc9066f742c828898c728f7e3f2114498ebe2848b71653</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> reg.xxlaila.cn/kxl/kxl-eureka:v2</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1570698681073.jpg" alt="img"></p><h4 id="days-2019-10-12"><a href="#days-2019-10-12" class="headerlink" title="days(2019-10-12)"></a>days(2019-10-12)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºå…¬å¸éœ€æ±‚ï¼Œå¼€å‘äººå‘˜æ¯”è¾ƒå¤šï¼Œåˆä¸æƒ³ç ”å‘ç”¨ä¸€ä¸ªè´¦å·ï¼Œä¹Ÿä¸æƒ³ç»™ç ”å‘ä¸€ä¸ªä¸ªçš„å¼€è´¦å·ï¼Œä½ç½®harboræ”¯æŒäº†ldapã€‚æœ‰äº†è¿™ä¹ˆä¸€ä¸ªä¸œè¥¿ï¼Œæˆ‘ä»¬å°±èƒ½å¾ˆå¥½çš„ä¸ºç ”å‘åˆ›å»ºè´¦å·æ”¯æŒç ”å‘éšæ—¶æŸ¥çœ‹dockerçš„é•œåƒã€‚</p><h4 id="é…ç½®harbor-ldap"><a href="#é…ç½®harbor-ldap" class="headerlink" title="é…ç½®harbor ldap"></a>é…ç½®harbor ldap</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°ç‰ˆæœ¬çš„harborå¾ˆå¤šä¸œè¥¿éƒ½å¯ä»¥ç›´æ¥åœ¨ç•Œé¢é…ç½®ï¼Œä¸éœ€è¦å»ä¿®æ”¹æ–‡ä»¶ï¼Œçœå»äº†å¤§é‡çš„å·¥ä½œï¼Œwebç•Œé¢é…ç½®æ›´åŠ æ–¹ä¾¿å¿«æ·ï¼Œç™»å½•harborå¹³å°ï¼Œç‚¹å‡»é…ç½®ç®¡ç†â€”â€”&gt;ä¿®æ”¹è®¤è¯æ¨¡å¼ï¼Œè®¤è¯æ¨¡å¼æ”¯æŒå¾ˆå¤šç±»å‹ï¼Œè¿™é‡Œé€‰æ‹©ldapã€‚<br><img src="https://img.xxlaila.cn/1571019665079.jpg" alt="img"><br><strong>æ³¨</strong>: åœ¨å¯†ç è¿™æ å¡«å†™éœ€è¦å¡«å†™ç®¡ç†å‘˜çš„å¯†ç ï¼Œæ™®é€šç”¨æˆ·çš„å¯†ç æ˜¯ä¸è¡Œçš„ï¼Œå³ä½¿æ˜¯åœ¨ç®¡ç†å‘˜çš„ç”¨æˆ·ä¹Ÿæ˜¯ä¸è¡Œçš„ã€‚<br>ç‚¹å‡»æµ‹è¯•ldapï¼Œæç¤ºè¿æ¥æˆåŠŸåä¿å­˜<br><img src="https://img.xxlaila.cn/1571019741060.jpg" alt="img"></p><h4 id="é…ç½®é‚®ç®±"><a href="#é…ç½®é‚®ç®±" class="headerlink" title="é…ç½®é‚®ç®±"></a>é…ç½®é‚®ç®±</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨é…ç½®ldapé¡µé¢æ—è¾¹æœ‰ä¸€ä¸ªé‚®ç®±é…ç½®ï¼Œé‚®ä»¶æœåŠ¡å™¨ç”¨äºå‘è¯·æ±‚é‡è®¾å¯†ç çš„ç”¨æˆ·å‘é€å“åº”ã€‚<br><img src="https://img.xxlaila.cn/1570873497729.jpg" alt="img"><br>ç‚¹å‡»æµ‹è¯•ï¼Œæµ‹è¯•æ²¡é—®é¢˜ä¹‹åç‚¹å‡»ä¿å­˜ã€‚</p><h4 id="æµ‹è¯•ladpè¿æ¥"><a href="#æµ‹è¯•ladpè¿æ¥" class="headerlink" title="æµ‹è¯•ladpè¿æ¥"></a>æµ‹è¯•ladpè¿æ¥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°æ‰“å¼€ä¸€ä¸ªä¸€ä¸ªæµè§ˆå™¨çª—å£ï¼Œåˆ©ç”¨ladpè´¦æˆ·è¿›è¡Œç™»å½•ã€‚<br><img src="https://img.xxlaila.cn/1571019859287.jpg" alt="img"><br><strong>æ³¨é‡Š</strong>: æ–°ç‰ˆæœ¬çš„åœ¨ç™»å½•ç•Œé¢æ²¡æœ‰ä»€ä¹ˆé€‰æ‹©ldapç™»å½•ï¼Œç›´æ¥ä½¿ç”¨ldapè´¦å·ç™»å½•å°±ok</p><h4 id="å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP-ADç»„"><a href="#å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP-ADç»„" class="headerlink" title="å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP / ADç»„"></a>å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP / ADç»„</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¿®æ”¹ä¹‹å‰çš„ldapé…ç½®ï¼Œå¢åŠ ç»„çš„é…ç½®<br><img src="https://img.xxlaila.cn/1571023069387.jpg" alt="img"><br>åœ¨é¡¹ç›®-&gt;æˆå‘˜-&gt; +ç»„ä¸­ã€‚<br><img src="https://img.xxlaila.cn/1571023177214.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571023223796.jpg" alt="img"></p><h4 id="è®¾ç½®ldapè´¦æˆ·çš„æƒé™"><a href="#è®¾ç½®ldapè´¦æˆ·çš„æƒé™" class="headerlink" title="è®¾ç½®ldapè´¦æˆ·çš„æƒé™"></a>è®¾ç½®ldapè´¦æˆ·çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“ldapé…ç½®ä»¥åï¼Œldapè´¦æˆ·ç™»å½•æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œæˆ‘ä»¬ç®¡ç†harborè¿˜çš„ä½¿ç”¨<code>harbor</code>çš„adminè´¦æˆ·ç™»å½•ï¼Œè¿™æ ·æ— ç–‘å¯¹è¿ç»´äººå‘˜ç»´æŠ¤å¸¦æ¥äº†ä¸ä¾¿åˆ©ã€‚å½“ldapç”¨æˆ·ç™»å½•ï¼Œharborå°±ä¼šè®°å½•è¯¥ç”¨æˆ·ï¼Œæˆ‘ä»¬è®¾ç½®è¿ç»´ç”¨æˆ·ä¸ºè¶…çº§ç®¡ç†å‘˜ï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªè´¦å·ç™»å½•ï¼Œç»´æŠ¤çš„æ—¶å€™ä¹Ÿä¸ç”¨è´¦å·åˆ‡æ¢<br><img src="https://img.xxlaila.cn/1571023451423.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>harbor</tag>
      </tags>
  </entry>
  <entry>
    <title>HPAè®¤è¯†</title>
    <url>/2019/10/09/hpa/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="Pod-è‡ªåŠ¨æ‰©ç¼©å®¹"><a href="#Pod-è‡ªåŠ¨æ‰©ç¼©å®¹" class="headerlink" title="Pod è‡ªåŠ¨æ‰©ç¼©å®¹"></a>Pod è‡ªåŠ¨æ‰©ç¼©å®¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesæä¾›äº†è¿™æ ·ä¸€ä¸ªèµ„æºå¯¹è±¡: <code>Horizontal Pod Autoscaling</code> Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼‰ï¼Œç®€ç§°HPAã€‚HAPé€šè¿‡ç›‘æ§åˆ†æRCæˆ–è€…Deploymentæ§åˆ¶çš„æ‰€æœ‰Podçš„è´Ÿè½½å˜åŒ–æƒ…å†µæ¥ç¡®å®šæ˜¯å¦éœ€è¦è°ƒæ•´Podçš„å‰¯æœ¬æ•°é‡ï¼Œè¿™æ˜¯HPAæœ€åŸºæœ¬çš„åŸç†ã€‚</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1570605234009.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HPAåœ¨kubernetesé›†ç¾¤ä¸­è¢«è®¾è®¡æˆä¸€ä¸ªKubernetes APIèµ„æºå’Œæ§åˆ¶å™¨ï¼Œå¯ä»¥é€šè¿‡kubectl autoscaleå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªHPAèµ„æºå¯¹è±¡ï¼ŒHPA Controlleré»˜è®¤15sè½®è¯¢ä¸€æ¬¡ï¼ˆå¯é€šè¿‡kube-controller-managerçš„æ ‡å¿—â€“horizontal-pod-autoscaler-sync-periodè¿›è¡Œè®¾ç½®ï¼‰ï¼ŒæŸ¥è¯¢æŒ‡å®šçš„èµ„æºï¼ˆRCæˆ–è€…Deploymentï¼‰ä¸­Podçš„èµ„æºä½¿ç”¨ç‡ï¼Œå¹¶ä¸”ä¸åˆ›å»ºæ—¶è®¾å®šçš„å€¼å’ŒæŒ‡æ ‡åšå¯¹æ¯”ï¼Œä»è€Œå®ç°è‡ªåŠ¨ä¼¸ç¼©çš„åŠŸèƒ½ã€‚<br><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener">è¯¦ç»†ä»‹ç»</a></p><h3 id="Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ "><a href="#Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ " class="headerlink" title="Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ "></a>Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ </h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºHorizontal Pod Autoscalerä½¿ç”¨æ­¤APIæ”¶é›†æŒ‡æ ‡ï¼Œå› æ­¤éœ€è¦åœ¨ç¾¤é›†ä¸­éƒ¨ç½²metrics-serverç›‘è§†ä»¥é€šè¿‡èµ„æºæŒ‡æ ‡APIæä¾›æŒ‡æ ‡,</p><h4 id="è¿è¡Œphp-apacheæœåŠ¡å™¨"><a href="#è¿è¡Œphp-apacheæœåŠ¡å™¨" class="headerlink" title="è¿è¡Œphp-apacheæœåŠ¡å™¨"></a>è¿è¡Œphp-apacheæœåŠ¡å™¨</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†å¼€å§‹è¿è¡Œè¯¥æ˜ åƒçš„éƒ¨ç½²ï¼Œå¹¶å°†å…¶æœåŠ¡å…¬å¼€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run php-apache --image=0layfolk0/hpa-example --requests=cpu=200m --limits=cpu=500m --expose --port=80</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">service/php-apache created</span><br><span class="line">deployment.apps/php-apache created</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨"><a href="#åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨" class="headerlink" title="åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨"></a>åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æœåŠ¡è¿è¡Œä»¥åã€‚æˆ‘ä»¬å°†ä½¿ç”¨kubectl autoscaleåˆ›å»ºè‡ªåŠ¨ ç¼©æ”¾å™¨ã€‚ä»¥ä¸‹å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œè¯¥ç¼©æ”¾å™¨å°†ç»´æŠ¤ç”±æˆ‘ä»¬åœ¨è¿™äº›è¯´æ˜çš„ç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„php-apacheéƒ¨ç½²æ§åˆ¶çš„Podçš„1è‡³10ä¸ªå‰¯æœ¬ã€‚ç²—ç•¥åœ°è¯´ï¼ŒHPAå°†ï¼ˆé€šè¿‡éƒ¨ç½²ï¼‰å¢åŠ æˆ–å‡å°‘å‰¯æœ¬æ•°ï¼Œä»¥å°†æ‰€æœ‰Podçš„å¹³å‡CPUåˆ©ç”¨ç‡ç»´æŒåœ¨50ï¼…ï¼ˆå› ä¸ºæ¯ä¸ªpodé€šè¿‡kubectlè¿è¡Œè¯·æ±‚200æ¯«æ ¸ï¼Œè¿™æ„å‘³ç€å¹³å‡CPUåˆ©ç”¨ç‡ä¸º100æ¯«-æ ¸å¿ƒï¼‰ã€‚<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#algorithm-details" target="_blank" rel="noopener">ç®—æ³•æ›´å¤šä¿¡æ¯</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span><br><span class="line">horizontalpodautoscaler.autoscaling/php-apache autoscaled</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥è‡ªåŠ¨å®šæ ‡å™¨çš„å½“å‰çŠ¶æ€:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         10        1          14s</span><br></pre></td></tr></table></figure><p><strong>æ³¨é‡Š</strong>: ç”±äºæˆ‘ä»¬æ²¡æœ‰å‘æœåŠ¡å™¨å‘é€ä»»ä½•è¯·æ±‚ï¼Œå› æ­¤å½“å‰CPUæ¶ˆè€—ä¸º0ï¼…ï¼ˆâ€œ CURRENTâ€åˆ—æ˜¾ç¤ºäº†ç”±ç›¸åº”éƒ¨ç½²æ§åˆ¶çš„æ‰€æœ‰Podçš„å¹³å‡å€¼ï¼‰ã€‚</p><h4 id="å¢åŠ å‹åŠ›æµ‹è¯•"><a href="#å¢åŠ å‹åŠ›æµ‹è¯•" class="headerlink" title="å¢åŠ å‹åŠ›æµ‹è¯•"></a>å¢åŠ å‹åŠ›æµ‹è¯•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨æˆ‘ä»¬è¦å¯¹<code>php-apache</code>åšå‹åŠ›æµ‹è¯•æ¥è§‚çœ‹è‡ªåŠ¨ç¼©æ”¾å¦‚ä½•å¯¹å¢åŠ çš„è´Ÿè½½åšå‡ºååº”ï¼Œæˆ‘ä»¬å°†å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶å°†æ— é™å¾ªç¯çš„æŸ¥è¯¢å‘é€åˆ°php-apacheæœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty load-generator --image=busybox /bin/sh</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # while true; do wget -q -O- http://php-apache.default.svc.cluster.local; done</span></span><br><span class="line"><span class="string">OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!O</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸€åˆ†é’Ÿå·¦å³çš„æ—¶é—´å†…ï¼Œæˆ‘ä»¬åº”è¯¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥çœ‹åˆ°æ›´é«˜çš„CPUè´Ÿè½½ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   250%/50%   1         10        1          9m12s</span><br><span class="line"></span><br><span class="line">$ kubectl get deployment php-apache</span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   3/5     5            3           88m</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”±äºç½‘ç»œé—®é¢˜å’Œpull é•œåƒå¤ªæ…¢äº†ï¼Œæˆ‘å°±ç›´æ¥ç»“æŸäº†æµ‹è¯•</p><h4 id="åœæ­¢å‹åŠ›æµ‹è¯•"><a href="#åœæ­¢å‹åŠ›æµ‹è¯•" class="headerlink" title="åœæ­¢å‹åŠ›æµ‹è¯•"></a>åœæ­¢å‹åŠ›æµ‹è¯•</h4><p>æˆ‘ä»¬åœ¨<code>busybox</code>å®¹å™¨çš„ç»ˆç«¯é‡Œé¢æ‰§è¡Œ<code>&lt;Ctrl&gt; + C</code>æ¥ç»“æŸå‹åŠ›æµ‹è¯•ï¼Œç„¶åæˆ‘ä»¬åœ¨è§‚å¯Ÿç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   91%/50%   1         10        5          10m</span><br><span class="line"></span><br><span class="line">$ kubectl get deployment php-apache</span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   2/2     2            2           99m</span><br></pre></td></tr></table></figure><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener">è‡ªåŠ¨ç¼©æ”¾å¤šä¸ªæŒ‡æ ‡å’Œè‡ªå®šä¹‰æŒ‡æ ‡</a></p><h3 id="nginx-æµ‹è¯•"><a href="#nginx-æµ‹è¯•" class="headerlink" title="nginx æµ‹è¯•"></a>nginx æµ‹è¯•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ©ç”¨ä¹‹å‰<a href="https://xxlaila.github.io/2019/10/09/Deployment%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">Deployment</a>é‡Œé¢çš„nginxåšæµ‹è¯•ï¼Œæˆ‘ä»¬åªéœ€è¦å§ä¹‹å‰çš„yamlæ–‡ä»¶ç¨ä½œä¿®æ”¹å³å¯</p><h4 id="ä¿®æ”¹nginx-deployment-yaml"><a href="#ä¿®æ”¹nginx-deployment-yaml" class="headerlink" title="ä¿®æ”¹nginx-deployment.yaml"></a>ä¿®æ”¹nginx-deployment.yaml</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-deploy</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-deploy</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"200Mi"</span></span><br><span class="line">            cpu: <span class="string">"200m"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="æ–°å»ºç«‹nginx-deploy-hpa-yaml"><a href="#æ–°å»ºç«‹nginx-deploy-hpa-yaml" class="headerlink" title="æ–°å»ºç«‹nginx-deploy-hpa.yaml"></a>æ–°å»ºç«‹nginx-deploy-hpa.yaml</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deploy-hpa.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 5</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: extensions/v1beta1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx-deploy</span><br><span class="line">  targetCPUUtilizationPercentage: 10</span><br><span class="line">status:</span><br><span class="line">  currentCPUUtilizationPercentage: 8</span><br><span class="line">  currentReplicas: 1</span><br><span class="line">  desiredReplicas: 0</span><br></pre></td></tr></table></figure><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">$ kubectl apply -f kubectl apply -f nginx-deploy-hpa.yaml</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   0%/10%    1         5         2          45s</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       8m28s</span><br><span class="line">nginx-deploy-d494b9564      2         2         2       13m</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œå‹åŠ›æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty load-generator --image=busybox /bin/sh</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # while true; do wget -q -O- http://172.30.224.5:80; done</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ•ˆæœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   28%/10%   1         5         4          4m48s</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       12m</span><br><span class="line">nginx-deploy-d494b9564      5         5         5       18m</span><br><span class="line"></span><br><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   16%/10%   1         5         5          5m39s</span><br></pre></td></tr></table></figure></li><li><p>ç»“æŸå‹æµ‹<br>ç­‰å¾…ä¸€ä¼šæŸ¥çœ‹ç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   0%/10%    1         5         1          12m</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       19m</span><br><span class="line">nginx-deploy-d494b9564      1         1         1       25m</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>hpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Deploymentä½¿ç”¨</title>
    <url>/2019/10/09/Deployment%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="Deploymentå’Œrcçš„å¯¹æ¯”"><a href="#Deploymentå’Œrcçš„å¯¹æ¯”" class="headerlink" title="Deploymentå’Œrcçš„å¯¹æ¯”"></a>Deploymentå’Œrcçš„å¯¹æ¯”</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆRCæ˜¯Kubernetesçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå½“æˆ‘ä»¬æŠŠåº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤ä¹‹åï¼Œéœ€è¦ä¿è¯åº”ç”¨èƒ½å¤ŸæŒç»­ç¨³å®šçš„è¿è¡Œï¼ŒRCå°±æ˜¯è¿™ä¸ªä¿è¯çš„å…³é”®ï¼Œä¸»è¦åŠŸèƒ½å¦‚:</p><ul><li>ç¡®ä¿Podæ•°é‡: å®ƒä¼šç¡®ä¿Kubernetesä¸­æœ‰æŒ‡å®šæ•°é‡çš„Podåœ¨è¿è¡Œï¼Œå¦‚æœå°‘äºæŒ‡å®šæ•°é‡çš„Podï¼ŒRCå°±ä¼šåˆ›å»ºæ–°çš„ï¼Œåä¹‹è¿™ä¼šåˆ é™¤å¤šä½™çš„ï¼Œä¿è¯Podçš„å‰¯æœ¬æ•°é‡ä¸å˜ã€‚</li><li>ç¡®ä¿Podå¥åº·: å½“Podä¸å¥åº·ï¼Œæ¯”å¦‚è¿è¡Œå‡ºé”™äº†ï¼Œæ€»ä¹‹æ— æ³•æä¾›æ­£å¸¸æœåŠ¡æ—¶ï¼ŒRCä¹Ÿä¼šæ€æ­»ä¸å¥åº·çš„Podï¼Œé‡æ–°åˆ›å»ºæ–°çš„ã€‚</li><li>å¼¹æ€§ä¼¸ç¼©: åœ¨ä¸šåŠ¡é«˜å³°æˆ–è€…ä½å³°çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨è¿‡RCæ¥åŠ¨æ€çš„è°ƒæ•´Podæ•°é‡æ¥æä¾›èµ„æºçš„åˆ©ç”¨ç‡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡å¦‚æœä½¿ç”¨HPAè¿™ç§èµ„æºå¯¹è±¡çš„è¯å¯ä»¥åšåˆ°è‡ªåŠ¨ä¼¸ç¼©ã€‚</li><li>æ»šåŠ¨å‡çº§: æ»šåŠ¨å‡çº§æ˜¯ä¸€ç§å¹³æ»‘çš„å‡çº§æ–¹å¼ï¼Œé€šè¿‡é€æ­¥æ›¿æ¢çš„ç­–ç•¥ï¼Œä¿è¯æ•´ä½“ç³»ç»Ÿçš„ç¨³å®šæ€§</li></ul><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeploymentåŒæ ·ä¹Ÿæ˜¯Kubernetesç³»ç»Ÿçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œä¸»è¦èŒè´£å’ŒRCä¸€æ ·çš„éƒ½æ˜¯ä¿è¯Podçš„æ•°é‡å’Œå¥åº·ï¼ŒäºŒè€…å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªå‡çº§ç‰ˆçš„RCæ§åˆ¶å™¨ï¼ŒDeploymentå…·å¤‡çš„æ–°ç‰¹æ€§</p><ul><li>RCçš„å…¨éƒ¨åŠŸèƒ½: Deploymentå…·å¤‡ä¸Šé¢æè¿°çš„RCçš„å…¨éƒ¨åŠŸèƒ½</li><li>äº‹ä»¶å’ŒçŠ¶æ€æŸ¥çœ‹: å¯ä»¥æŸ¥çœ‹Deploymentçš„å‡çº§è¯¦ç»†è¿›åº¦å’ŒçŠ¶æ€</li><li>å›æ»š: å½“å‡çº§Podçš„æ—¶å€™å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å›æ»šæ“ä½œå›æ»šåˆ°ä¹‹å‰çš„ä»»ä¸€ç‰ˆæœ¬</li><li>ç‰ˆæœ¬è®°å½•: æ¯ä¸€æ¬¡å¯¹Deploymentçš„æ“ä½œï¼Œéƒ½èƒ½å¤Ÿä¿å­˜ä¸‹æ¥ï¼Œè¿™ä¹Ÿæ˜¯ä¿è¯å¯ä»¥å›æ»šåˆ°ä»»ä¸€ç‰ˆæœ¬çš„åŸºç¡€</li><li>æš‚åœå’Œå¯åŠ¨: å¯¹äºæ¯ä¸€æ¬¡å‡çº§éƒ½èƒ½å¤Ÿéšæ—¶æš‚åœå’Œå¯åŠ¨</li></ul><p><strong>å¯¹æ¯”</strong>: Deploymentä½œä¸ºæ–°ä¸€ä»£çš„RCï¼Œåœ¨åŠŸèƒ½ä¸Šæ›´ä¸ºä¸°å¯Œï¼ŒåŒæ—¶å®˜æ–¹ä¹Ÿæ˜¯æ¨èä½¿ç”¨Deploymentæ¥ç®¡ç†Podï¼Œæ¯”å¦‚ä¸€äº›å®˜æ–¹ç»„ä»¶kube-dnsã€kube-proxyä¹Ÿéƒ½æ˜¯ä½¿ç”¨çš„Deploymentæ¥ç®¡ç†çš„ï¼Œæ‰€ä»¥æœ€å¥½ä½¿ç”¨Deploymentæ¥ç®¡ç†Podã€‚</p><h3 id="Deployment-ä»‹ç»"><a href="#Deployment-ä»‹ç»" class="headerlink" title="Deployment ä»‹ç»"></a>Deployment ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Deploymentæ‹¥æœ‰å¤šä¸ªReplica Setï¼Œè€Œä¸€ä¸ªReplica Setæ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªPodã€‚ä¸€ä¸ªDeploymentæ§åˆ¶å¤šä¸ªrsä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒå›æ»šæœºåˆ¶ï¼Œæ¯å½“Deploymentæ“ä½œæ—¶ï¼ŒKubernetesä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªReplica Setå¹¶ä¿ç•™ï¼Œä»¥åæœ‰éœ€è¦çš„è¯å°±å¯ä»¥å›æ»šè‡³ä¹‹å‰çš„çŠ¶æ€ã€‚</p><p><strong>å®ä¾‹</strong>: åˆ›å»ºä¸€ä¸ªDeploymentï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªReplica Setæ¥å¯åŠ¨3ä¸ªnginx podï¼Œyamlæ–‡ä»¶å¦‚ä¸‹:</p><ul><li><p>nginx-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f nginx-deployment.yaml</span><br><span class="line">deployment.apps/nginx-deploy created</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œä¸€ä¸‹å‘½ä»¤æŸ¥çœ‹åˆšåˆšåˆ›å»ºçš„Deployment</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   0/3     3            0           12s</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡æ‰§è¡Œä¸Šé¢å‘½ä»¤</span></span><br><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   1/3     3            1           35s</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥çœ‹åˆ°Deploymentå·²ç»åˆ›å»ºäº†1ä¸ªReplica Setäº†ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹rså’Œpod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get rs</span><br><span class="line">NAME                     DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d   3         3         2       70s</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ kubectl get pod --show-labels</span><br><span class="line">NAME                           READY   STATUS              RESTARTS   AGE   LABELS</span><br><span class="line">nginx-deploy-6dd86d77d-9n9vf   1/1     Running             0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br><span class="line">nginx-deploy-6dd86d77d-bhrsk   0/1     ContainerCreating   0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br><span class="line">nginx-deploy-6dd86d77d-jdnrh   1/1     Running             0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br></pre></td></tr></table></figure></li></ul><p>ä¸Šé¢çš„Deploymentçš„yamlæ–‡ä»¶ä¸­çš„replicas:3å°†ä¼šä¿è¯æˆ‘ä»¬å§‹ç»ˆæœ‰3ä¸ªPODåœ¨è¿è¡Œã€‚</p><h3 id="æ»šåŠ¨å‡çº§"><a href="#æ»šåŠ¨å‡çº§" class="headerlink" title="æ»šåŠ¨å‡çº§"></a>æ»šåŠ¨å‡çº§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¿®æ”¹ä¹‹å‰ä½¿ç”¨çš„nginx-deployment.yamlæ–‡ä»¶ä¸­çš„nginxé•œåƒä¿®æ”¹ä¸ºnginx:1.13.3ï¼Œç„¶ååœ¨specä¸‹é¢æ·»åŠ æ»šåŠ¨å‡çº§ç­–ç•¥ï¼š</p><ul><li><p>nginx-deploments.yml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure></li><li><p>minReadySeconds:</p><ul><li>æ»šåŠ¨å‡çº§æ—¶5såè®¤ä¸ºè¯¥podå°±ç»ª</li><li>å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼ŒKubernetesä¼šå‡è®¾è¯¥å®¹å™¨å¯åŠ¨èµ·æ¥åå°±æä¾›æœåŠ¡äº†</li><li>å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼Œåœ¨æŸäº›æç«¯æƒ…å†µä¸‹å¯èƒ½ä¼šé€ æˆæœåŠ¡ä¸æ­£å¸¸è¿è¡Œ</li></ul></li><li><p>rollingUpdate:</p><ul><li>äºreplicasä¸º3,åˆ™æ•´ä¸ªå‡çº§,podä¸ªæ•°åœ¨2-4ä¸ªä¹‹é—´</li></ul></li><li><p>maxSurge:</p><ul><li>å‡çº§è¿‡ç¨‹ä¸­æœ€å¤šå¯ä»¥æ¯”åŸå…ˆè®¾ç½®å¤šå‡ºçš„PODæ•°é‡</li><li>ä¾‹å¦‚ï¼šmaxSurage=1ï¼Œreplicas=3,åˆ™è¡¨ç¤ºKubernetesä¼šå…ˆå¯åŠ¨1ä¸€ä¸ªæ–°çš„Podåæ‰åˆ æ‰ä¸€ä¸ªæ—§çš„PODï¼Œæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰3+1ä¸ªPODã€‚</li></ul></li><li><p>maxUnavaible:</p><ul><li>å‡çº§è¿‡ç¨‹ä¸­æœ€å¤šæœ‰å¤šå°‘ä¸ªPODå¤„äºæ— æ³•æä¾›æœåŠ¡çš„çŠ¶æ€</li><li>å½“maxSurgeä¸ä¸º0æ—¶ï¼Œè¯¥å€¼ä¹Ÿä¸èƒ½ä¸º0</li><li>ä¾‹å¦‚ï¼šmaxUnavaible=1ï¼Œåˆ™è¡¨ç¤ºKubernetesæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰1ä¸ªPODå¤„äºæ— æ³•æœåŠ¡çš„çŠ¶æ€ã€‚</li></ul></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">deployment.apps/nginx-deploy configured</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨rolloutå‘½ä»¤</span></span><br><span class="line">$ kubectl rollout status deployment/nginx-deploy</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line"></span><br><span class="line"><span class="comment"># æš‚åœå‡çº§</span></span><br><span class="line">$ kubectl rollout pause deployment deployment/nginx-deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­å‡çº§</span></span><br><span class="line">$ kubectl rollout resume deployment deployment/nginx-deploy</span><br></pre></td></tr></table></figure></li></ul><p>å‡çº§ç»“æŸåï¼Œç»§ç»­æŸ¥çœ‹rsçš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    0         0         0       21m</span><br><span class="line">nginx-deploy-799d666985   3         3         3       10m</span><br></pre></td></tr></table></figure><p>æ ¹æ®AGEæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¦»æˆ‘ä»¬æœ€è¿‘çš„å½“å‰çŠ¶æ€æ˜¯ï¼š3ï¼Œå’Œæˆ‘ä»¬çš„yamlæ–‡ä»¶æ˜¯ä¸€è‡´çš„ï¼Œè¯æ˜å‡çº§æˆåŠŸäº†ã€‚ç”¨describeå‘½ä»¤å¯ä»¥æŸ¥çœ‹å‡çº§çš„å…¨éƒ¨ä¿¡æ¯:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe deploy nginx-deploy</span><br><span class="line">Name:                   nginx-deploy</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Wed, 09 Oct 2019 10:12:56 +0800</span><br><span class="line">Labels:                 k8s-app=nginx-demo</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 2</span><br><span class="line">                        kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                          &#123;<span class="string">"apiVersion"</span>:<span class="string">"apps/v1beta1"</span>,<span class="string">"kind"</span>:<span class="string">"Deployment"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"labels"</span>:&#123;<span class="string">"k8s-app"</span>:<span class="string">"nginx-demo"</span>&#125;,<span class="string">"name"</span>:<span class="string">"nginx-deploy"</span>,<span class="string">"nam...</span></span><br><span class="line"><span class="string">Selector:               app=nginx</span></span><br><span class="line"><span class="string">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span></span><br><span class="line"><span class="string">StrategyType:           RollingUpdate</span></span><br><span class="line"><span class="string">MinReadySeconds:        5</span></span><br><span class="line"><span class="string">RollingUpdateStrategy:  1 max unavailable, 1 max surge</span></span><br><span class="line"><span class="string">Pod Template:</span></span><br><span class="line"><span class="string">  Labels:  app=nginx</span></span><br><span class="line"><span class="string">  Containers:</span></span><br><span class="line"><span class="string">   nginx:</span></span><br><span class="line"><span class="string">    Image:        nginx:1.13.3</span></span><br><span class="line"><span class="string">    Port:         80/TCP</span></span><br><span class="line"><span class="string">    Host Port:    0/TCP</span></span><br><span class="line"><span class="string">    Environment:  &lt;none&gt;</span></span><br><span class="line"><span class="string">    Mounts:       &lt;none&gt;</span></span><br><span class="line"><span class="string">  Volumes:        &lt;none&gt;</span></span><br><span class="line"><span class="string">Conditions:</span></span><br><span class="line"><span class="string">  Type           Status  Reason</span></span><br><span class="line"><span class="string">  ----           ------  ------</span></span><br><span class="line"><span class="string">  Available      True    MinimumReplicasAvailable</span></span><br><span class="line"><span class="string">  Progressing    True    NewReplicaSetAvailable</span></span><br><span class="line"><span class="string">OldReplicaSets:  &lt;none&gt;</span></span><br><span class="line"><span class="string">NewReplicaSet:   nginx-deploy-799d666985 (3/3 replicas created)</span></span><br><span class="line"><span class="string">Events:</span></span><br><span class="line"><span class="string">  Type    Reason             Age   From                   Message</span></span><br><span class="line"><span class="string">  ----    ------             ----  ----                   -------</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  23m   deployment-controller  Scaled up replica set nginx-deploy-6dd86d77d to 3</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 1</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 2</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 2</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 1</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 3</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  10m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 0</span></span><br></pre></td></tr></table></figure><h3 id="å›æ»šDeployment"><a href="#å›æ»šDeployment" class="headerlink" title="å›æ»šDeployment"></a>å›æ»šDeployment</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢å·²ç»æ»šåŠ¨å¹³æ»‘çš„å‡çº§Deploymentï¼Œä½†æ˜¯å¦‚æœå‡çº§åçš„PODå‡ºäº†é—®é¢˜è¯¥æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬èƒ½å¤Ÿæƒ³åˆ°çš„æœ€å¥½æœ€å¿«çš„æ–¹å¼å½“ç„¶æ˜¯å›é€€åˆ°ä¸Šä¸€æ¬¡èƒ½å¤Ÿæä¾›æ­£å¸¸å·¥ä½œçš„ç‰ˆæœ¬ï¼ŒDeploymentå°±ä¸ºæˆ‘ä»¬æä¾›äº†å›æ»šæœºåˆ¶ã€‚</p><ul><li>é¦–å…ˆï¼ŒæŸ¥çœ‹Deploymentçš„å‡çº§å†å²:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment nginx-deploy</span><br><span class="line">deployment.extensions/nginx-deploy </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºåœ¨æ‰§è¡ŒDeploymentå‡çº§çš„æ—¶å€™æœ€å¥½å¸¦ä¸Šrecordå‚æ•°ï¼Œä¾¿äºæˆ‘ä»¬æŸ¥çœ‹å†å²ç‰ˆæœ¬ä¿¡æ¯ã€‚<code>kubectl apply --filename=nginx-deployment.yaml --record=true</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰é€šè¿‡kubectl xxxx â€“recordéƒ½ä¼šè¢«kubernetesè®°å½•åˆ°etcdè¿›è¡ŒæŒä¹…åŒ–ï¼Œè¿™æ— ç–‘ä¼šå ç”¨èµ„æºï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæ—¶é—´ä¹…äº†ï¼Œå½“ä½ kubectl get rsæ—¶ï¼Œä¼šæœ‰æˆç™¾ä¸Šåƒçš„åƒåœ¾RSè¿”å›ï¼Œè¿™å¯¹äºè¿ç»´æ¥è¯´ç»´æŠ¤å¾ˆä¸ä¾¿åˆ©ï¼Œ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬åœ¨ä¸Šç”Ÿäº§æ—¶ï¼Œæˆ‘ä»¬æœ€å¥½é€šè¿‡è®¾ç½®Deploymentçš„.spec.revisionHistoryLimitæ¥é™åˆ¶æœ€å¤§ä¿ç•™çš„revision numberï¼Œæ¯”å¦‚15ä¸ªç‰ˆæœ¬ï¼Œå›æ»šçš„æ—¶å€™ä¸€èˆ¬åªä¼šå›æ»šåˆ°æœ€è¿‘çš„å‡ ä¸ªç‰ˆæœ¬å°±è¶³å¤Ÿäº†ã€‚å…¶å®rollout historyä¸­è®°å½•çš„revisionéƒ½å’ŒReplicaSetsä¸€ä¸€å¯¹åº”ã€‚å¦‚æœæ‰‹åŠ¨deleteæŸä¸ªReplicaSetï¼Œå¯¹åº”çš„rollout historyå°±ä¼šè¢«åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯è¿˜è¯´ä½ æ— æ³•å›æ»šåˆ°è¿™ä¸ªrevisonã€‚rollout historyå’ŒReplicaSetçš„å¯¹åº”å…³ç³»ï¼Œå¯ä»¥åœ¨kubectl describe rs $RSNAMEè¿”å›çš„revisionå­—æ®µä¸­å¾—åˆ°ï¼Œè¿™é‡Œçš„revisionå°±å¯¹åº”ç€rollout historyè¿”å›çš„revisonã€‚</p><ul><li><p>yamlä¾‹å­</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat nginx-deployment.yaml </span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å•ä¸ªrevisonçš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment nginx-deploy --revision=2</span><br><span class="line">deployment.extensions/nginx-deploy with revision <span class="comment">#2</span></span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:	app=nginx</span><br><span class="line">	pod-template-hash=799d666985</span><br><span class="line">  Annotations:	kubernetes.io/change-cause: kubectl apply --filename=nginx-deployment.yaml --record=<span class="literal">true</span></span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:	nginx:1.13.3</span><br><span class="line">    Port:	80/TCP</span><br><span class="line">    Host Port:	0/TCP</span><br><span class="line">    Environment:	&lt;none&gt;</span><br><span class="line">    Mounts:	&lt;none&gt;</span><br><span class="line">  Volumes:	&lt;none&gt;</span><br></pre></td></tr></table></figure></li><li><p>ç›´æ¥å›é€€åˆ°å½“å‰ç‰ˆæœ¬çš„å‰ä¸€ä¸ªç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout undo deployment nginx-deploy</span><br><span class="line">deployment.extensions/nginx-deploy rolled back</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥ç”¨revisionå›é€€åˆ°æŒ‡å®šçš„ç‰ˆæœ¬</span></span><br><span class="line">$ kubectl rollout undo deployment nginx-deploy --to-revision=1</span><br><span class="line">deployment.extensions/nginx-deploy rolled back</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹Deploymentç°åœ¨çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   2/3     3            2           56m</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    1         1         1       56m</span><br><span class="line">nginx-deploy-799d666985   3         3         1       46m</span><br><span class="line"></span><br><span class="line">$ kubectl rollout status deployment/nginx-deploy</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 of 3 updated replicas are available...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 of 3 updated replicas are available...</span><br><span class="line">deployment <span class="string">"nginx-deploy"</span> successfully rolled out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ŒæˆåæŸ¥çœ‹</span></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    0         0         0       57m</span><br><span class="line">nginx-deploy-799d666985   3         3         3       47m</span><br></pre></td></tr></table></figure></li></ul><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Deployment</tag>
      </tags>
  </entry>
  <entry>
    <title>harborç§æœ‰ä»“åº“éƒ¨ç½²</title>
    <url>/2019/09/30/harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Harboræ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨å’Œåˆ†å‘Dockeré•œåƒçš„ä¼ä¸šçº§RegistryæœåŠ¡å™¨ï¼Œé€šè¿‡æ·»åŠ ä¸€äº›ä¼ä¸šå¿…éœ€çš„åŠŸèƒ½ç‰¹æ€§ï¼Œä¾‹å¦‚å®‰å…¨ã€æ ‡è¯†å’Œç®¡ç†ç­‰ï¼Œæ‰©å±•äº†å¼€æºDocker Distributionã€‚ä½œä¸ºä¸€ä¸ªä¼ä¸šçº§ç§æœ‰RegistryæœåŠ¡å™¨ï¼ŒHarboræä¾›äº†æ›´å¥½çš„æ€§èƒ½å’Œå®‰å…¨ã€‚æå‡ç”¨æˆ·ä½¿ç”¨Registryæ„å»ºå’Œè¿è¡Œç¯å¢ƒä¼ è¾“é•œåƒçš„æ•ˆç‡ã€‚Harboræ”¯æŒå®‰è£…åœ¨å¤šä¸ªRegistryèŠ‚ç‚¹çš„é•œåƒèµ„æºå¤åˆ¶ï¼Œé•œåƒå…¨éƒ¨ä¿å­˜åœ¨ç§æœ‰Registryä¸­ï¼Œ ç¡®ä¿æ•°æ®å’ŒçŸ¥è¯†äº§æƒåœ¨å…¬å¸å†…éƒ¨ç½‘ç»œä¸­ç®¡æ§ã€‚å¦å¤–ï¼ŒHarborä¹Ÿæä¾›äº†é«˜çº§çš„å®‰å…¨ç‰¹æ€§ï¼Œè¯¸å¦‚ç”¨æˆ·ç®¡ç†ï¼Œè®¿é—®æ§åˆ¶å’Œæ´»åŠ¨å®¡è®¡ç­‰ã€‚</p><a id="more"></a><h3 id="éƒ¨ç½²ç¯å¢ƒå‡†å¤‡"><a href="#éƒ¨ç½²ç¯å¢ƒå‡†å¤‡" class="headerlink" title="éƒ¨ç½²ç¯å¢ƒå‡†å¤‡"></a>éƒ¨ç½²ç¯å¢ƒå‡†å¤‡</h3><h4 id="æœåŠ¡å™¨é…ç½®"><a href="#æœåŠ¡å™¨é…ç½®" class="headerlink" title="æœåŠ¡å™¨é…ç½®"></a>æœåŠ¡å™¨é…ç½®</h4><table><thead><tr><th>ç³»ç»Ÿ</th><th>é…ç½®</th><th>ip</th></tr></thead><tbody><tr><td>centos 7.4</td><td>4/8G/200G</td><td>172.21.16.90</td></tr></tbody></table><h4 id="ä¸‹è½½æ‰€éœ€æ–‡ä»¶"><a href="#ä¸‹è½½æ‰€éœ€æ–‡ä»¶" class="headerlink" title="ä¸‹è½½æ‰€éœ€æ–‡ä»¶"></a>ä¸‹è½½æ‰€éœ€æ–‡ä»¶</h4><h5 id="docker-compose-ä¸‹è½½"><a href="#docker-compose-ä¸‹è½½" class="headerlink" title="docker-compose ä¸‹è½½"></a>docker-compose ä¸‹è½½</h5><p>docker compose <a href="https://github.com/docker/compose/releases" target="_blank" rel="noopener">å‘å¸ƒé¡µé¢</a>ä¸‹è½½æœ€æ–°çš„ docker-compose äºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/docker/compose/releases/download/1.24.1/docker-compose-Linux-x86_64</span></span><br><span class="line"><span class="comment"># mv ~/docker-compose-Linux-x86_64 /usr/bin/docker-compose </span></span><br><span class="line"><span class="comment"># chmod a+x  /ur/bin/docker-compose</span></span><br></pre></td></tr></table></figure><ul><li>å®˜æ–¹çš„å®‰è£…<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class="line"><span class="comment"># chmod +x /usr/local/bin/docker-compose</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="harbor-ä¸‹è½½"><a href="#harbor-ä¸‹è½½" class="headerlink" title="harbor ä¸‹è½½"></a>harbor ä¸‹è½½</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harbor å®‰è£…æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨çº¿å®‰è£…ï¼Œä¸€ç§æ˜¯ç¦»çº¿å®‰è£…ï¼Œè¿™é‡Œç”±äºç½‘ç»œä¸å¥½ï¼Œä½¿ç”¨çš„æ˜¯ç¦»çº¿å®‰è£…ï¼Œharbor<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">å‘å¸ƒé¡µé¢</a>ä¸‹è½½æœ€æ–°çš„ harbor ç¦»çº¿å®‰è£…åŒ…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://storage.googleapis.com/harbor-releases/release-1.9.0/harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line"><span class="comment"># tar -zxvf harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹å®‰è£…"><a href="#å¼€å§‹å®‰è£…" class="headerlink" title="å¼€å§‹å®‰è£…"></a>å¼€å§‹å®‰è£…</h3><h4 id="docker-å®‰è£…"><a href="#docker-å®‰è£…" class="headerlink" title="docker å®‰è£…"></a>docker å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum-config-manager   --add-repo   https://download.docker.com/linux/centos/docker-ce.repo</span></span><br><span class="line"><span class="comment"># sudo yum -y install docker-ce-18.09.6-3.el7.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables: 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables: 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># sysctl -p /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="comment"># systemctl  start docker</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>: ä¸æ·»åŠ <code>/etc/sysctl.d/k8s.conf</code> å¯åŠ¨dockerä¼šæç¤º<code>WARNING: bridge-nf-call-iptables is disabled WARNING: bridge-nf-call-ip6tables is disabled</code></p><h4 id="å¯¼å…¥-docker-images"><a href="#å¯¼å…¥-docker-images" class="headerlink" title="å¯¼å…¥ docker images"></a>å¯¼å…¥ docker images</h4><p>å¯¼å…¥ç¦»çº¿å®‰è£…åŒ…ä¸­harborç›¸å…³çš„ docker imagesï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd harbor</span></span><br><span class="line"><span class="comment"># docker load -i harbor.v1.9.0.tar.gz </span></span><br><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                      TAG                        IMAGE ID            CREATED             SIZE</span><br><span class="line">goharbor/chartmuseum-photon     v0.9.0-v1.9.0              00c12627cbd7        2 weeks ago         131MB</span><br><span class="line">goharbor/harbor-migrator        v1.9.0                     75d4de5e0f16        2 weeks ago         362MB</span><br><span class="line">goharbor/redis-photon           v1.9.0                     3249afaa9965        2 weeks ago         109MB</span><br><span class="line">goharbor/clair-photon           v2.0.9-v1.9.0              e54ad567c58f        2 weeks ago         165MB</span><br><span class="line">goharbor/notary-server-photon   v0.6.1-v1.9.0              2cdecba59f38        2 weeks ago         138MB</span><br><span class="line">goharbor/notary-signer-photon   v0.6.1-v1.9.0              973378593def        2 weeks ago         135MB</span><br><span class="line">goharbor/harbor-registryctl     v1.9.0                     30a01bf0f4df        2 weeks ago         99.6MB</span><br><span class="line">goharbor/registry-photon        v2.7.1-patch-2819-v1.9.0   32571099a9fe        2 weeks ago         82.3MB</span><br><span class="line">goharbor/nginx-photon           v1.9.0                     f933d62f9952        2 weeks ago         43.9MB</span><br><span class="line">goharbor/harbor-log             v1.9.0                     28e27d511335        2 weeks ago         82.6MB</span><br><span class="line">goharbor/harbor-jobservice      v1.9.0                     f3cd0b181a89        2 weeks ago         141MB</span><br><span class="line">goharbor/harbor-core            v1.9.0                     f2814ed8aadd        2 weeks ago         155MB</span><br><span class="line">goharbor/harbor-portal          v1.9.0                     0778d4c5d27e        2 weeks ago         51.3MB</span><br><span class="line">goharbor/harbor-db              v1.9.0                     a809e14d2d49        2 weeks ago         147MB</span><br><span class="line">goharbor/prepare                v1.9.0                     aa594772c1e8        2 weeks ago         147MB</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-harbor-yml-æ–‡ä»¶"><a href="#ä¿®æ”¹-harbor-yml-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ harbor.yml æ–‡ä»¶"></a>ä¿®æ”¹ harbor.yml æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim harbor.yml</span></span><br><span class="line">hostname: reg.xxlaila.cn</span><br><span class="line"></span><br><span class="line"><span class="comment"># email configure</span></span><br><span class="line">email_server: smtp.exmail.qq.com</span><br><span class="line">email_server_port: 465</span><br><span class="line">email_username: admin@xxlaila.cn</span><br><span class="line">email_password: 123</span><br><span class="line">email_from: admin&lt;admin@xxlaila.cn&gt;</span><br><span class="line">email_ssl: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User registration is prohibited</span></span><br><span class="line">self_registration: off</span><br><span class="line"></span><br><span class="line"><span class="comment"># LDAP authentication configuration item</span></span><br><span class="line"><span class="comment">#ldap_url: ldaps://ldap.xxlaila.cn</span></span><br><span class="line"><span class="comment">#ldap_searchdn: uid=username,ou=people,dc=xxlaila,dc=com</span></span><br><span class="line"><span class="comment">#ldap_search_pwd: password</span></span><br><span class="line"><span class="comment">#ldap_basedn: ou=people,dc=xxlaila,dc=com</span></span><br><span class="line"><span class="comment">#ldap_filter: (objectClass=person)</span></span><br><span class="line"><span class="comment">#ldap_uid: uid </span></span><br><span class="line"><span class="comment">#ldap_scope: 3 </span></span><br><span class="line"><span class="comment">#ldap_timeout: 5</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨</strong>: æ–°ç‰ˆæœ¬çš„é‚®ç®±ã€ldapç°åœ¨éƒ½ä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ¥æ·»åŠ é…ç½®äº†ï¼Œç›´æ¥é€šè¿‡webç•Œé¢æ¥è¿›è¡Œé…ç½®å³å¯ï¼Œè¿™é‡Œæˆ‘åªæ˜¯æ·»åŠ è¿›æ¥ï¼Œä¿ç•™ï¼ŒğŸ˜ğŸ˜ğŸ˜</p><h4 id="åŠ è½½å’Œå¯åŠ¨-harbor-é•œåƒ"><a href="#åŠ è½½å’Œå¯åŠ¨-harbor-é•œåƒ" class="headerlink" title="åŠ è½½å’Œå¯åŠ¨ harbor é•œåƒ"></a>åŠ è½½å’Œå¯åŠ¨ harbor é•œåƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /data</span></span><br><span class="line"><span class="comment"># chmod 777 /var/run/docker.sock /data</span></span><br><span class="line"><span class="comment"># ./install.sh </span></span><br><span class="line"></span><br><span class="line">[Step 0]: checking installation environment ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 19.03.2</span><br><span class="line"></span><br><span class="line">Note: docker-compose version: 1.24.1</span><br><span class="line"></span><br><span class="line">[Step 1]: loading Harbor images ...</span><br><span class="line">Loaded image: goharbor/harbor-portal:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-core:v1.9.0</span><br><span class="line">Loaded image: goharbor/nginx-photon:v1.9.0</span><br><span class="line">Loaded image: goharbor/notary-signer-photon:v0.6.1-v1.9.0</span><br><span class="line">Loaded image: goharbor/registry-photon:v2.7.1-patch-2819-v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-migrator:v1.9.0</span><br><span class="line">Loaded image: goharbor/chartmuseum-photon:v0.9.0-v1.9.0</span><br><span class="line">Loaded image: goharbor/prepare:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-log:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-db:v1.9.0</span><br><span class="line">Loaded image: goharbor/clair-photon:v2.0.9-v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-jobservice:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-registryctl:v1.9.0</span><br><span class="line">Loaded image: goharbor/redis-photon:v1.9.0</span><br><span class="line">Loaded image: goharbor/notary-server-photon:v0.6.1-v1.9.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 2]: preparing environment ...</span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /opt/harbor</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated and saved secret to file: /secret/keys/secretkey</span><br><span class="line">Generated certificate, key file: /secret/core/private_key.pem, cert file: /secret/registry/root.crt</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 3]: starting Harbor ...</span><br><span class="line">Creating network <span class="string">"harbor_harbor"</span> with the default driver</span><br><span class="line">Creating harbor-log ... <span class="keyword">done</span></span><br><span class="line">Creating registryctl   ... <span class="keyword">done</span></span><br><span class="line">Creating redis         ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-portal ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-db     ... <span class="keyword">done</span></span><br><span class="line">Creating registry      ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-core   ... <span class="keyword">done</span></span><br><span class="line">Creating nginx             ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-jobservice ... <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">âœ” ----Harbor has been installed and started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able to visit the admin portal at http://reg.xxlaila.cn. </span><br><span class="line">For more details, please visit https://github.com/goharbor/harbor .</span><br></pre></td></tr></table></figure><h4 id="è®¿é—®ç®¡ç†ç•Œé¢"><a href="#è®¿é—®ç®¡ç†ç•Œé¢" class="headerlink" title="è®¿é—®ç®¡ç†ç•Œé¢"></a>è®¿é—®ç®¡ç†ç•Œé¢</h4><p>ç¡®è®¤æ‰€æœ‰ç»„ä»¶éƒ½å·¥ä½œæ­£å¸¸ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker-compose  ps</span></span><br><span class="line">      Name                     Command                       State                     Ports          </span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-core         /harbor/harbor_core              Up (healthy)                                     </span><br><span class="line">harbor-db           /docker-entrypoint.sh            Up (healthy)            5432/tcp                 </span><br><span class="line">harbor-jobservice   /harbor/harbor_jobservice  ...   Up (health: starting)                            </span><br><span class="line">harbor-log          /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up (healthy)            127.0.0.1:1514-&gt;10514/tcp</span><br><span class="line">harbor-portal       nginx -g daemon off;             Up (healthy)            8080/tcp                 </span><br><span class="line">nginx               nginx -g daemon off;             Up (healthy)            0.0.0.0:80-&gt;8080/tcp     </span><br><span class="line">redis               redis-server /etc/redis.conf     Up (healthy)            6379/tcp                 </span><br><span class="line">registry            /entrypoint.sh /etc/regist ...   Up (healthy)            5000/tcp                 </span><br><span class="line">registryctl         /harbor/start.sh                 Up (healthy)</span><br></pre></td></tr></table></figure><h5 id="harbor-ç»„å»ºä»‹ç»"><a href="#harbor-ç»„å»ºä»‹ç»" class="headerlink" title="harbor ç»„å»ºä»‹ç»"></a>harbor ç»„å»ºä»‹ç»</h5><ul><li>harbor-core: Harborçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸»è¦æä¾›ä»¥ä¸‹æœåŠ¡ï¼š<ul><li>UIï¼šæä¾›å›¾å½¢åŒ–ç•Œé¢ï¼Œå¸®åŠ©ç”¨æˆ·ç®¡ç†registryä¸Šçš„é•œåƒï¼ˆimageï¼‰, å¹¶å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒã€‚</li><li>webhookï¼šä¸ºäº†åŠæ—¶è·å–registry ä¸ŠimageçŠ¶æ€å˜åŒ–çš„æƒ…å†µï¼Œ åœ¨Registryä¸Šé…ç½®webhookï¼ŒæŠŠçŠ¶æ€å˜åŒ–ä¼ é€’ç»™UIæ¨¡å—ã€‚</li><li>token æœåŠ¡ï¼šè´Ÿè´£æ ¹æ®ç”¨æˆ·æƒé™ç»™æ¯ä¸ªdocker push/pullå‘½ä»¤ç­¾å‘token. Docker å®¢æˆ·ç«¯å‘RegiÃ¸stryæœåŠ¡å‘èµ·çš„è¯·æ±‚,å¦‚æœä¸åŒ…å«tokenï¼Œä¼šè¢«é‡å®šå‘åˆ°è¿™é‡Œï¼Œè·å¾—tokenåå†é‡æ–°å‘Registryè¿›è¡Œè¯·æ±‚ã€‚</li></ul></li><li>harbor-db: ä¸ºcore servicesæä¾›æ•°æ®åº“æœåŠ¡ï¼Œè´Ÿè´£å‚¨å­˜ç”¨æˆ·æƒé™ã€å®¡è®¡æ—¥å¿—ã€Docker imageåˆ†ç»„ä¿¡æ¯ç­‰æ•°æ®ã€‚</li><li>harbor-jobservice: harbor-jobservice æ˜¯harborçš„jobç®¡ç†æ¨¡å—ï¼Œjobåœ¨harboré‡Œé¢ä¸»è¦æ˜¯ä¸ºäº†é•œåƒä»“åº“ä¹‹å‰åŒæ­¥ä½¿ç”¨çš„;</li><li>harbor-log: ä¸ºäº†å¸®åŠ©ç›‘æ§Harborè¿è¡Œï¼Œè´Ÿè´£æ”¶é›†å…¶ä»–ç»„ä»¶çš„logï¼Œä¾›æ—¥åè¿›è¡Œåˆ†æã€‚</li><li>nginx: nginxè´Ÿè´£æµé‡è½¬å‘å’Œå®‰å…¨éªŒè¯ï¼Œå¯¹å¤–æä¾›çš„æµé‡éƒ½æ˜¯ä»nginxä¸­è½¬ï¼Œæ‰€ä»¥å¼€æ”¾httpsçš„443ç«¯å£ï¼Œå®ƒå°†æµé‡åˆ†å‘åˆ°åç«¯çš„uiå’Œæ­£åœ¨dockeré•œåƒå­˜å‚¨çš„docker registryã€‚</li><li>redis: å­˜å‚¨ç¼“å­˜ä¿¡æ¯</li><li>registry: è´Ÿè´£å‚¨å­˜Dockeré•œåƒï¼Œå¹¶å¤„ç†docker push/pull å‘½ä»¤ã€‚ç”±äºæˆ‘ä»¬è¦å¯¹ç”¨æˆ·è¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œå³ä¸åŒç”¨æˆ·å¯¹Docker imageæœ‰ä¸åŒçš„è¯»å†™æƒé™ï¼ŒRegistryä¼šæŒ‡å‘ä¸€ä¸ªtokenæœåŠ¡ï¼Œå¼ºåˆ¶ç”¨æˆ·çš„æ¯æ¬¡docker pull/pushè¯·æ±‚éƒ½è¦æºå¸¦ä¸€ä¸ªåˆæ³•çš„token, Registryä¼šé€šè¿‡å…¬é’¥å¯¹token è¿›è¡Œè§£å¯†éªŒè¯ã€‚</li><li>registryctl: æ˜¯harborçš„ç®¡ç†å‘˜é…ç½®harborçš„ä¸€äº›å¸¸ç”¨é…ç½®å’Œé«˜çº§é…ç½®</li></ul><p>åœ¨æµè§ˆå™¨è®¿é—®<a href="http://reg.xxlaila.cnï¼Œ" target="_blank" rel="noopener">http://reg.xxlaila.cnï¼Œ</a> ç”¨è´¦å· admin å’Œ harbor.yml é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å¯†ç  Harbor12345 ç™»é™†ç³»ç»Ÿ<br><img src="https://img.xxlaila.cn/8095d05-b9b7-4bdc-b0fc-7810db649e23.png" alt="img"><br><img src="https://img.xxlaila.cn/4bfab8be-e5de-4165-9268-fa591c5f12f8.png" alt="img"></p><h4 id="harbor-è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•"><a href="#harbor-è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•" class="headerlink" title="harbor è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•"></a>harbor è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harbor å°†æ—¥å¿—æ‰“å°åˆ° /var/log/harbor çš„ç›¸å…³ç›®å½•ä¸‹ï¼Œä¼ ç»Ÿçš„docker logs XXX æˆ– docker-compose logs XXX çœ‹ä¸åˆ°å®¹å™¨çš„æ—¥å¿—ã€‚åªæœ‰ä½¿ç”¨å¸¸ç”¨ç³»ç»Ÿå‘½ä»¤æ¥è¿›è¡Œæ—¥å¿—çš„æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># # æ—¥å¿—ç›®å½•</span></span><br><span class="line"><span class="comment"># ls /var/log/harbor</span></span><br><span class="line">core.log  jobservice.log  portal.log  postgresql.log  proxy.log  redis.log  registryctl.log  registry.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># # æ•°æ®ç›®å½•ï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€é•œåƒä»“åº“</span></span><br><span class="line"><span class="comment"># ls /data/</span></span><br><span class="line">ca_download  database  job_logs  psc  redis  registry  secret</span><br></pre></td></tr></table></figure><h4 id="å…¶å®ƒæ“ä½œ"><a href="#å…¶å®ƒæ“ä½œ" class="headerlink" title="å…¶å®ƒæ“ä½œ"></a>å…¶å®ƒæ“ä½œ</h4><p>ä¸‹åˆ—æ“ä½œçš„å·¥ä½œç›®å½•å‡ä¸ºè§£å‹ç¦»çº¿å®‰è£…æ–‡ä»¶åç”Ÿæˆçš„ harbor ç›®å½•ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># # åœæ­¢ harbor</span></span><br><span class="line"><span class="comment"># docker-compose down -v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # å¯åŠ¨ harbor</span></span><br><span class="line"><span class="comment"># docker-compose up -d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # æ›´ä¿®æ”¹çš„é…ç½®æ›´æ–°åˆ° docker-compose.yml æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># ./prepare</span></span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /opt/harbor</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Clearing the configuration file: /config/nginx/nginx.conf</span><br><span class="line">Clearing the configuration file: /config/core/env</span><br><span class="line">Clearing the configuration file: /config/core/app.conf</span><br><span class="line">Clearing the configuration file: /config/registry/config.yml</span><br><span class="line">Clearing the configuration file: /config/registry/root.crt</span><br><span class="line">Clearing the configuration file: /config/registryctl/env</span><br><span class="line">Clearing the configuration file: /config/registryctl/config.yml</span><br><span class="line">Clearing the configuration file: /config/db/env</span><br><span class="line">Clearing the configuration file: /config/jobservice/env</span><br><span class="line">Clearing the configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">loaded secret from file: /secret/keys/secretkey</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>harbor</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s podå¥åº·æ£€æµ‹</title>
    <url>/2019/09/27/k8s-pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><h3 id="Podå¥åº·æ£€æµ‹æœºåˆ¶"><a href="#Podå¥åº·æ£€æµ‹æœºåˆ¶" class="headerlink" title="Podå¥åº·æ£€æµ‹æœºåˆ¶"></a>Podå¥åº·æ£€æµ‹æœºåˆ¶</h3><p>å¯¹äºPodçš„å¥åº·çŠ¶æ€æ£€æµ‹ï¼Œkubernetesæä¾›äº†ä¸¤ç±»æ¢é’ˆ(Probe)æ¥æ‰§è¡Œå¯¹Podçš„å¥åº·çŠ¶æ€æ£€æµ‹:</p><ul><li><strong>LivenessProbeæ¢é’ˆ</strong>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå³Podæ˜¯å¦ä¸ºrunningçŠ¶æ€ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†killæ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥æ˜¯å¦é‡å¯ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œåˆ™Kubeletè®¤ä¸ºå®¹å™¨çš„LivenessProbeæ¢é’ˆçš„è¿”å›å€¼æ°¸è¿œæˆåŠŸ.</li></ul><a id="more"></a><ul><li><strong>ReadinessProbeæ¢é’ˆ</strong>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œå³å®¹å™¨çš„Readyæ˜¯å¦ä¸ºTrueï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœReadinessProbeæ¢æµ‹å¤±è´¥ï¼Œåˆ™å®¹å™¨çš„Readyå°†ä¸ºFalseï¼Œæ§åˆ¶å™¨å°†æ­¤Podçš„Endpointä»å¯¹åº”çš„serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»æ­¤ä¸å†å°†ä»»ä½•è¯·æ±‚è°ƒåº¦æ­¤Podä¸Šï¼Œç›´åˆ°ä¸‹æ¬¡æ¢æµ‹æˆåŠŸã€‚</li></ul><!--more--><p>æ¯ç±»æ¢é’ˆéƒ½æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹æ³•:</p><ul><li><strong>ExecAction</strong>: é€šè¿‡æ‰§è¡Œå‘½ä»¤æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œé’ˆå¯¹å¤æ‚æ£€æµ‹æˆ–æ— HTTPæ¥å£çš„æœåŠ¡ï¼Œå‘½ä»¤è¿”å›å€¼ä¸º0åˆ™è¡¨ç¤ºå®¹å™¨å¥åº·ã€‚</li><li><strong>HTTPGetAction</strong>: é€šè¿‡å‘é€httpè¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œè¿”å›200-399çŠ¶æ€ç åˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li><li><strong>TCPSocketAction</strong>: é€šè¿‡å®¹å™¨çš„IPå’ŒPortæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li></ul><p>æ¢é’ˆæ¢æµ‹çš„ç»“æœæœ‰ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€:</p><ul><li><strong>Success</strong>: Containeré€šè¿‡äº†æ£€æŸ¥</li><li><strong>Failure</strong>: Containeræœªé€šè¿‡æ£€æŸ¥</li><li><strong>Unknown</strong>: æœªèƒ½æ‰§è¡Œæ£€æŸ¥ï¼Œå› æ­¤ä¸é‡‡å–ä»»ä½•æªæ–½</li></ul><h3 id="LivenessProbeæ¢é’ˆé…ç½®"><a href="#LivenessProbeæ¢é’ˆé…ç½®" class="headerlink" title="LivenessProbeæ¢é’ˆé…ç½®"></a>LivenessProbeæ¢é’ˆé…ç½®</h3><h4 id="ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹</h4><ul><li>exec-liveness.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; <span class="built_in">exec</span>-liveness.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">test</span>: liveness</span><br><span class="line">  name: liveness-exec</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">    - /bin/sh</span><br><span class="line">    - -c</span><br><span class="line">    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><br><span class="line">    livenessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - cat</span><br><span class="line">        - /tmp/healthy</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 5</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹å®¹å™¨æ‰§è¡ŒlivenessProbeæ£€æŸ¥ï¼ŒperiodSecondså­—æ®µæŒ‡å®škubeletæ¯5sæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œæ£€æŸ¥çš„å‘½ä»¤ä¸ºcat /tmp/healthyï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletåº”è¯¥åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ä¹‹å‰ç­‰å¾…5ç§’ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›0ï¼Œé‚£ä¹ˆkubeletå°±è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸ºé0ï¼Œåˆ™Kubeletä¼šKillæ‰å®¹å™¨å¹¶æ ¹æ®é‡å¯ç­–ç•¥æ¥å†³å®šæ˜¯å¦éœ€è¦é‡å¯ã€‚</p><ul><li>å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/bin/sh -c <span class="string">"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯¹äºå®¹å™¨çš„å‰30ç§’ï¼Œæœ‰ä¸€ä¸ª/tmp/healthyæ–‡ä»¶ã€‚å› æ­¤ï¼Œåœ¨å‰30ç§’å†…ï¼Œè¯¥å‘½ä»¤cat /tmp/healthyè¿”å›æˆåŠŸä»£ç ã€‚30ç§’åï¼Œcat /tmp/healthyè¿”å›å¤±è´¥ä»£ç ã€‚</p><ul><li><p>åˆ›å»ºPod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl create -f  <span class="built_in">exec</span>-liveness.yaml </span><br><span class="line">pod/liveness-exec created</span><br></pre></td></tr></table></figure></li><li><p>åœ¨30ç§’å†…ï¼ŒæŸ¥çœ‹Podäº‹ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                   Message</span><br><span class="line">  ----    ------     ----  ----                   -------</span><br><span class="line">  Normal  Scheduled  23s   default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Normal  Pulling    20s   kubelet, 172.21.17.34  Pulling image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Pulled     2s    kubelet, 172.21.17.34  Successfully pulled image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Created    2s    kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal  Started    1s    kubelet, 172.21.17.34  Started container liveness</span><br></pre></td></tr></table></figure></li><li><p>35ç§’åï¼Œå†æ¬¡æŸ¥çœ‹Podäº‹ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age              From                   Message</span><br><span class="line">  ----     ------     ----             ----                   -------</span><br><span class="line">  Normal   Scheduled  58s              default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Normal   Pulling    55s              kubelet, 172.21.17.34  Pulling image <span class="string">"busybox"</span></span><br><span class="line">  Normal   Pulled     37s              kubelet, 172.21.17.34  Successfully pulled image <span class="string">"busybox"</span></span><br><span class="line">  Normal   Created    37s              kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal   Started    36s              kubelet, 172.21.17.34  Started container liveness</span><br><span class="line">  Warning  Unhealthy  0s (x2 over 5s)  kubelet, 172.21.17.34  Liveness probe failed: cat: can<span class="string">'t open '</span>/tmp/healthy<span class="string">': No such file or directory</span></span><br></pre></td></tr></table></figure></li><li><p>å†ç­‰30ç§’ï¼Œç¡®è®¤Containerå·²é‡æ–°å¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod liveness-exec</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-exec   1/1     Running   1          115s</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                 From                   Message</span><br><span class="line">  ----     ------     ----                ----                   -------</span><br><span class="line">  Normal   Scheduled  2m7s                default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Warning  Unhealthy  64s (x3 over 74s)   kubelet, 172.21.17.34  Liveness probe failed: cat: can<span class="string">'t open '</span>/tmp/healthy<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">  Normal   Killing    64s                 kubelet, 172.21.17.34  Container liveness failed liveness probe, will be restarted</span></span><br><span class="line"><span class="string">  Normal   Pulling    34s (x2 over 2m4s)  kubelet, 172.21.17.34  Pulling image "busybox"</span></span><br><span class="line"><span class="string">  Normal   Pulled     25s (x2 over 106s)  kubelet, 172.21.17.34  Successfully pulled image "busybox"</span></span><br><span class="line"><span class="string">  Normal   Created    25s (x2 over 106s)  kubelet, 172.21.17.34  Created container liveness</span></span><br><span class="line"><span class="string">  Normal   Started    25s (x2 over 105s)  kubelet, 172.21.17.34  Started container liveness</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; http-liveness.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">test</span>: liveness</span><br><span class="line">  name: liveness-http</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: carlziess/liveness</span><br><span class="line">    args:</span><br><span class="line">    - /server</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /healthz</span><br><span class="line">        port: 8080</span><br><span class="line">        httpHeaders:</span><br><span class="line">        - name: X-Custom-Header</span><br><span class="line">          value: Awesome</span><br><span class="line">      initialDelaySeconds: 3</span><br><span class="line">      periodSeconds: 3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ªPodï¼Œå…¶ä¸­periodSecondså­—æ®µæŒ‡å®škubeletæ¯3ç§’æ‰§è¡Œä¸€æ¬¡æ¢æµ‹ï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletå»¶è¿Ÿç­‰å¾…3ç§’ï¼Œæ¢æµ‹æ–¹å¼ä¸ºå‘å®¹å™¨ä¸­è¿è¡Œçš„æœåŠ¡å‘é€HTTP GETè¯·æ±‚ï¼Œè¯·æ±‚8080ç«¯å£ä¸‹çš„/healthz, ä»»ä½•å¤§äºæˆ–ç­‰äº200ä¸”å°äº400çš„ä»£ç è¡¨ç¤ºæˆåŠŸã€‚ä»»ä½•å…¶ä»–ä»£ç è¡¨ç¤ºå¤±è´¥ã€‚</p><ul><li><p>åˆ›å»ºpod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f http-liveness.yaml </span><br><span class="line">pod/liveness-http created</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-http</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                   From                   Message</span><br><span class="line">  ----     ------     ----                  ----                   -------</span><br><span class="line">  Normal   Scheduled  2m59s                 default-scheduler      Successfully assigned default/liveness-http to 172.21.17.34</span><br><span class="line">  Normal   Pulled     119s (x3 over 2m46s)  kubelet, 172.21.17.34  Successfully pulled image <span class="string">"carlziess/liveness"</span></span><br><span class="line">  Normal   Created    119s (x3 over 2m46s)  kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal   Started    118s (x3 over 2m45s)  kubelet, 172.21.17.34  Started container liveness</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-http   1/1     Running   0          26s</span><br></pre></td></tr></table></figure></li><li><p><strong>httpGet</strong>æ¢æµ‹æ–¹å¼æœ‰å¦‚ä¸‹å¯é€‰çš„æ§åˆ¶å­—æ®µ</p><ul><li>host: è¦è¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤ä¸ºPod IPï¼Œå¯ä»¥åœ¨http request headä¸­è®¾ç½®hostå¤´éƒ¨ã€‚</li><li>scheme: ç”¨äºè¿æ¥hostçš„åè®®ï¼Œé»˜è®¤ä¸ºHTTPã€‚</li><li>path: httpæœåŠ¡å™¨ä¸Šçš„è®¿é—®URL</li><li>httpHeaders: è‡ªå®šä¹‰HTTPè¯·æ±‚headersï¼ŒHTTPå…è®¸é‡å¤headers</li><li>port: å®¹å™¨ä¸Šè¦è®¿é—®ç«¯å£å·æˆ–åç§°</li></ul></li></ul><h4 id="ä¾‹ä¸‰-é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹ä¸‰-é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹ä¸‰: é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹ä¸‰: é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹</h4><p>Kubeletå°†å°è¯•åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šæ‰“å¼€å®¹å™¨ä¸Šçš„å¥—æ¥å­—ï¼Œå¦‚æœèƒ½å»ºç«‹è¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; tcp-liveness-readiness.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: goproxy</span><br><span class="line">  labels:</span><br><span class="line">    app: goproxy</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: goproxy</span><br><span class="line">    image: goproxy/goproxy</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    readinessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      periodSeconds: 20</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCPæ£€æŸ¥æ–¹å¼å’ŒHTTPæ£€æŸ¥æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œç¤ºä¾‹ä¸­ä¸¤ç§æ¢é’ˆéƒ½ä½¿ç”¨äº†ï¼Œåœ¨å®¹å™¨å¯åŠ¨5ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªreadinessProbeæ¢é’ˆï¼Œè¿™å°†è¿æ¥åˆ°å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœæ¢æµ‹æˆåŠŸï¼Œåˆ™è¯¥Podå°†è¢«æ ‡è¯†ä¸ºreadyï¼Œ10ç§’åï¼Œkubeletå°†è¿›è¡Œç¬¬äºŒæ¬¡è¿æ¥ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é™¤æ­¤ï¼Œé…ç½®è¿˜åŒ…å«äº†livenessProbeæ¢é’ˆï¼Œåœ¨å®¹å™¨å¯åŠ¨15ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªlivenessProbeæ¢é’ˆï¼Œä»ç„¶å°è¯•è¿æ¥å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœè¿æ¥å¤±è´¥åˆ™é‡å¯å®¹å™¨ã€‚</p><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f tcp-liveness-readiness.yaml</span><br><span class="line">pod/goproxy created</span><br></pre></td></tr></table></figure></li><li><p>15ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ä»¥éªŒè¯æ´»åŠ¨æ¢æµ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod goproxy</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                    Message</span><br><span class="line">  ----    ------     ----  ----                    -------</span><br><span class="line">  Normal  Scheduled  26s   default-scheduler       Successfully assigned default/goproxy to 172.21.16.231</span><br><span class="line">  Normal  Pulling    22s   kubelet, 172.21.16.231  Pulling image <span class="string">"goproxy/goproxy"</span></span><br></pre></td></tr></table></figure></li></ul><p>å½“å®¹å™¨æœ‰å¤šä¸ªç«¯å£æ—¶ï¼Œé€šå¸¸ä¼šç»™æ¯ä¸ªç«¯å£å‘½åï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ¢é’ˆæ¢æµ‹æ—¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™è‡ªå®šä¹‰çš„ç«¯å£åç§°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- name: liveness-port</span><br><span class="line">  containerPort: 8080</span><br><span class="line">  hostPort: 8080</span><br><span class="line">livenessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /healthz</span><br><span class="line">    port: liveness-port</span><br></pre></td></tr></table></figure><h3 id="ReadinessProbeæ¢é’ˆé…ç½®"><a href="#ReadinessProbeæ¢é’ˆé…ç½®" class="headerlink" title="ReadinessProbeæ¢é’ˆé…ç½®"></a>ReadinessProbeæ¢é’ˆé…ç½®</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeæ¢é’ˆçš„ä½¿ç”¨åœºæ™¯livenessProbeç¨æœ‰ä¸åŒï¼Œæœ‰çš„æ—¶å€™åº”ç”¨ç¨‹åºå¯èƒ½æš‚æ—¶æ— æ³•æ¥å—è¯·æ±‚ï¼Œæ¯”å¦‚Podå·²ç»Runningäº†ï¼Œä½†æ˜¯å®¹å™¨å†…åº”ç”¨ç¨‹åºå°šæœªå¯åŠ¨æˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰ReadinessProbeï¼Œåˆ™Kubernetesè®¤ä¸ºå®ƒå¯ä»¥å¤„ç†è¯·æ±‚äº†ï¼Œç„¶è€Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ç¨‹åºè¿˜æ²¡å¯åŠ¨æˆåŠŸæ˜¯ä¸èƒ½æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¸å¸Œæœ›kubernetesæŠŠè¯·æ±‚è°ƒåº¦ç»™å®ƒï¼Œåˆ™ä½¿ç”¨ReadinessProbeæ¢é’ˆã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeå’ŒlivenessProbeå¯ä»¥ä½¿ç”¨ç›¸åŒæ¢æµ‹æ–¹å¼ï¼Œåªæ˜¯å¯¹Podçš„å¤„ç½®æ–¹å¼ä¸åŒï¼ŒReadinessProbeæ˜¯å°†Pod IP:Portä»å¯¹åº”çš„EndPointåˆ—è¡¨ä¸­åˆ é™¤ï¼Œè€ŒlivenessProbeåˆ™Killå®¹å™¨å¹¶æ ¹æ®Podçš„é‡å¯ç­–ç•¥æ¥å†³å®šä½œå‡ºå¯¹åº”çš„æªæ–½ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢é’ˆæ¢æµ‹å®¹å™¨æ˜¯å¦å·²å‡†å¤‡å°±ç»ªï¼Œå¦‚æœæœªå‡†å¤‡å°±ç»ªåˆ™kubernetesä¸ä¼šå°†æµé‡è½¬å‘ç»™æ­¤Podã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeæ¢é’ˆä¸livenessProbeä¸€æ ·ä¹Ÿæ”¯æŒexecã€httpGetã€TCPçš„æ¢æµ‹æ–¹å¼ï¼Œé…ç½®æ–¹å¼ç›¸åŒï¼Œåªä¸è¿‡æ˜¯å°†livenessProbeå­—æ®µä¿®æ”¹ä¸ºReadinessProbeã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">readinessProbe:</span><br><span class="line">  <span class="built_in">exec</span>:</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - cat</span><br><span class="line">    - /tmp/healthy</span><br><span class="line">  initialDelaySeconds: 5</span><br><span class="line">  periodSeconds: 5</span><br></pre></td></tr></table></figure><p>ReadinessProbeæ¢é’ˆçš„HTTPã€TCPçš„æ¢æµ‹æ–¹å¼ä¹Ÿä¸livenessProbeçš„åŸºæœ¬ä¸€è‡´ã€‚</p><h4 id="ä¾‹å››-ReadinessProbeç¤ºä¾‹"><a href="#ä¾‹å››-ReadinessProbeç¤ºä¾‹" class="headerlink" title="ä¾‹å››: ReadinessProbeç¤ºä¾‹"></a>ä¾‹å››: ReadinessProbeç¤ºä¾‹</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ å…¥ReadinessProbeæ¢é’ˆå’Œä¸€ä¸ªæ²¡æœ‰ReadinessProbeæ¢é’ˆçš„ç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªdeployï¼Œåä¸ºJavaAppï¼Œå¯åŠ¨çš„å®¹å™¨è¿è¡Œä¸€ä¸ªjavaåº”ç”¨ç¨‹åºï¼Œç¨‹åºç›‘å¬ç«¯å£ä¸º9093ã€‚</p><ul><li><p>æ²¡æœ‰ReadinessProbe</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; k8s.yaml &lt;&lt; EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  labels:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9093</span><br><span class="line">    name: biz-gateway</span><br><span class="line">  selector:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: biz-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: biz-gateway</span><br><span class="line">        image: docker.io/xxlaila/biz-gateway:dev-08c8a4e</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9093</span><br><span class="line">        env:</span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: dev</span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.cn</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f k8s.yaml </span><br><span class="line">service/biz-gateway created</span><br><span class="line">deployment.extensions/biz-gateway created</span><br></pre></td></tr></table></figure></li><li><p>åˆšåˆ›å»ºåï¼Œç­‰ä¸€ä¼šåï¼ŒæŸ¥çœ‹PodçŠ¶æ€ï¼Œè®°ç€è¦ç»™imageç•™ä¸‹pullçš„æ—¶é—´</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods  |grep <span class="string">"biz-gateway"</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">biz-gateway-95f6b677f-rnz22   1/1     Running   0          2m8s</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªè¿‡ç¨‹Podç”¨äº†2m8sï¼Œè‡ªèº«çŠ¶æ€å·²Runningï¼Œå…¶READå­—æ®µï¼Œ1/1 è¡¨ç¤º1ä¸ªå®¹å™¨çŠ¶æ€å·²å‡†å¤‡å°±ç»ªäº†ï¼Œæ­¤æ—¶ï¼Œå¯¹äºkubernetesè€Œè¨€ï¼Œå·²ç»å¯ä»¥æ¥æ”¶è¯·æ±‚äº†,è€Œå®é™…ä¸ŠæœåŠ¡è¿˜æ— æ³•è®¿é—®ï¼Œå› ä¸ºJAVAç¨‹åºè¿˜å°šå¯åŠ¨èµ·æ¥ï¼Œ2m8ssåæ–¹å¯æ­£å¸¸è®¿é—®ï¼Œæ‰€ä»¥é’ˆå¯¹æ­¤ç±»ç¨‹åºï¼Œå¿…é¡»é…ç½®ReadinessProbeã€‚</p><ul><li>åŠ å…¥readinessProbe<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; k8s.yaml &lt;&lt; EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  labels:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 9093</span><br><span class="line">    name: biz-gateway</span><br><span class="line">  selector:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: biz-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: biz-gateway</span><br><span class="line">        image: docker.io/xxlaila/biz-gateway:dev-08c8a4e</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9093</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9093</span><br><span class="line">          initialDelaySeconds: 140</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        env:</span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: dev</span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.cn</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼ŒReadinessProbeæ¢é’ˆçš„æ¢æµ‹æ–¹å¼ä¸ºtcpSocketï¼Œå› ä¸ºç¨‹åºç›‘å¬åœ¨9093ç«¯å£ï¼Œæ‰€ä»¥è¿™é‡Œæ¢æµ‹ä¸ºå¯¹9093å»ºç«‹è¿æ¥,è¿™é‡Œç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æ˜¯åœ¨Pod Runingå140ç§’åï¼Œé—´éš”10ç§’åæ‰§è¡Œç¬¬äºŒæ¬¡æ¢æµ‹ã€‚</p><ul><li><p>åˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f ./</span><br><span class="line">service/biz-gateway created</span><br><span class="line">deployment.extensions/biz-gateway created</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåç­‰å¾…äº†60s</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP            NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">biz-gateway-f69cc8678-qs8s7   0/1     Running   0          60s   172.30.56.6   172.21.17.40   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­ç­‰å¾…ä¸€ä¼š</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">biz-gateway-f69cc8678-qs8s7   1/1     Running   0          2m36s   172.30.56.6   172.21.17.40   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°åœ¨2m36ç§’åï¼Œpodå¯åŠ¨okï¼Œåœ¨ç¬¬ä¸€æ¬¡æŸ¥çœ‹çš„æ—¶å€™ï¼ŒPodè™½ç„¶å·²å¤„äºRunnigçŠ¶æ€ï¼Œä½†æ˜¯ç”±äºç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æœªåˆ°ï¼Œæ‰€ä»¥READYå­—æ®µä¸º0/1ï¼Œå³å®¹å™¨çš„çŠ¶æ€ä¸ºæœªå‡†å¤‡å°±ç»ªï¼Œåœ¨æœªå‡†å¤‡å°±ç»ªçš„æƒ…å†µä¸‹ï¼Œå…¶Podå¯¹åº”çš„Serviceä¸‹çš„Endpointä¹Ÿä¸ºç©ºï¼Œæ‰€ä»¥æ‰ä¸ä¼šæœ‰ä»»ä½•è¯·æ±‚è¢«è°ƒåº¦è¿›æ¥ã€‚</p><ul><li>æŸ¥çœ‹Endpoint<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ¬¡æ‰§è¡Œ</span></span><br><span class="line">$ kubectl get endpoints</span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">biz-gateway                                                            57s</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   13d</span><br><span class="line"></span><br><span class="line">åœ¨2m36sååœ¨æ¬¡æ‰§è¡Œ</span><br><span class="line">$ kubectl get endpoints</span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">biz-gateway   172.30.56.6:9093                                         2m41s</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   13d</span><br></pre></td></tr></table></figure></li></ul><h3 id="é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§"><a href="#é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§" class="headerlink" title="é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§"></a>é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢é’ˆ(Probe)æœ‰è®¸å¤šå¯é€‰å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æ›´åŠ ç²¾ç¡®çš„æ§åˆ¶Livenesså’ŒReadinessä¸¤ç§æ¢é’ˆçš„è¡Œä¸º(Probe)ï¼š</p><ul><li>initialDelaySecondsï¼šPodå¯åŠ¨åå»¶è¿Ÿå¤šä¹…æ‰è¿›è¡Œæ£€æŸ¥ï¼Œå•ä½ï¼šç§’</li><li>periodSecondsï¼šæ£€æŸ¥çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º10ï¼Œå•ä½ï¼šç§’ã€‚</li><li>timeoutSecondsï¼šæ¢æµ‹çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º1ï¼Œå•ä½ï¼šç§’ã€‚</li><li>successThresholdï¼šæ¢æµ‹å¤±è´¥åè®¤ä¸ºæˆåŠŸçš„æœ€å°è¿æ¥æˆåŠŸæ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œåœ¨Livenessæ¢é’ˆä¸­å¿…é¡»ä¸º1ï¼Œæœ€å°å€¼ä¸º1ã€‚</li><li>failureThresholdï¼šæ¢æµ‹å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•ä¸€å®šæ¬¡æ•°åå°†è®¤ä¸ºå¤±è´¥ï¼Œåœ¨readinessæ¢é’ˆä¸­ï¼ŒPodä¼šè¢«æ ‡è®°ä¸ºæœªå°±ç»ªï¼Œé»˜è®¤ä¸º3ï¼Œæœ€å°å€¼ä¸º1ã€‚</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>ä¹‹å‰é”™è¯¯å‚è€ƒæ’æŸ¥ä»‹ç»</strong>: åœ¨ä¹‹å‰å®‰è£…jenkinsçš„æ—¶å€™ï¼Œåˆ›å»ºpodå°±ä¸€å€¼å¤„äº<code>running</code>,ä½†æ˜¯è¿‡ä¸€ä¼šï¼Œç•Œé¢å°±æŠ¥é”™ï¼Œé”™è¯¯å¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/15008WechatIMG.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç„¶åæŸ¥çœ‹podæ—¥å¿—å’Œç³»ç»Ÿç³»ç»Ÿï¼Œéƒ½æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œpodæ—¥å¿—å¦‚ä¸‹ï¼Œç„¶åå°±é—®äº†æœ‹å‹ï¼Œå°±è¯´æœ‰å¯èƒ½æ˜¯podçš„å¥åº·æ£€æµ‹æœºåˆ¶ï¼Œæœ€åå°±ä¿®æ”¹äº†podçš„å¥åº·æ£€æµ‹æœºåˆ¶ï¼ŒjenkinsæœåŠ¡å™¨éƒ¨ç½²okã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">log</span> $(kubectl get pods -n kube-ops | awk <span class="string">'&#123;print $1&#125;'</span> | grep jenkins) -n kube-ops</span><br><span class="line"><span class="built_in">log</span> is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use logs instead.</span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size: 3.00G</span><br><span class="line">    Ergonomics Machine Class: server</span><br><span class="line">    Using VM: OpenJDK 64-Bit Server VM</span><br><span class="line"></span><br><span class="line">Running from: /usr/share/jenkins/jenkins.war</span><br><span class="line">webroot: EnvVars.masterEnvVars.get(<span class="string">"JENKINS_HOME"</span>)</span><br><span class="line">2019-09-27 03:02:24.133+0000 [id=1] INFO org.eclipse.jetty.util.log.Log<span class="comment">#initialized: Logging initialized @429ms to org.eclipse.jetty.util.log.JavaUtilLog</span></span><br><span class="line">2019-09-27 03:02:24.247+0000 [id=1] INFO winstone.Logger<span class="comment">#logInternal: Beginning extraction from war file</span></span><br></pre></td></tr></table></figure><p><strong>åç»­</strong>: è™½ç„¶å¥åº·æ£€æµ‹å¯ä»¥å–æ¶ˆï¼Œä¸åŠ å…¥ï¼Œä½†æ˜¯å½“æˆ‘ä»¬åœ¨ä¸Šç”Ÿäº§ç¯å¢ƒçš„æ—¶å€™è¿˜æ˜¯è¦åŠ ä¸Šï¼Œæ­£å¦‚ä¾‹å››ä»‹ç»çš„é‚£æ ·ã€‚å¦‚æœæˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒé”™æ•…éšœè‡ªæ„ˆã€è½®è¯¢å‘å¸ƒç­‰ã€‚éƒ½éœ€è¦è¿™ä¸ªä¸œè¥¿ï¼ŒåŠ å…¥å†å‡çº§çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨éƒ½è¿˜æ²¡èµ·æ¥ï¼Œk8så°±å§æµé‡ç»™è°ƒåº¦è¿‡æ¥ï¼Œå‡çº§ä¸‹ä¸€ä¸ªpodï¼Œå¤–éƒ¨ç”¨æˆ·è®¿é—®å°±ä¼šæŠ¥é”™ï¼Œé‚£å°±æ˜¯å¾ˆå°´å°¬</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pod</tag>
      </tags>
  </entry>
  <entry>
    <title>EFK</title>
    <url>/2019/09/25/EFK/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡"><a href="#åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡" class="headerlink" title="åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡"></a>åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚<code>kubernetes/cluster/addons/fluentd-elasticsearch</code>è¿™æ˜¯æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;es æ•°æ®é»˜è®¤çš„å­˜å‚¨åœ¨dockeré‡Œé¢ï¼Œåœ¨ç”¨çš„æ˜¯nodeèŠ‚ç‚¹çš„ç©ºé—´ï¼Œè€ŒnodeèŠ‚ç‚¹æˆ‘ä»¬ä¸å¯èƒ½éƒ½å‡†å¤‡å¾ˆå¤§çš„ç©ºé—´ï¼Œé‚£æ ·å¾ˆæµªè´¹èµ„æºï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å‡†å¤‡å¤–éƒ¨çš„nfså­˜å‚¨ç©ºé—´ï¼Œç„¶åé€šè¿‡<a href="https://xxlaila.github.io/2019/09/24/%E5%88%A9%E7%94%A8NFS%E5%8A%A8%E6%80%81%E6%8F%90%E4%BE%9BKubernetes%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8%E5%8D%B7/" target="_blank" rel="noopener">pv</a>çš„æ¨¡å¼è¿›è¡ŒæŒ‚è½½ï¼Œæ•°æ®å­˜å‚¨åˆ°nfsæœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·ä¿éšœäº†esæ”¶é›†æ•°æ®çš„å¯ç”¨æ€§ã€‚</p><a id="more"></a><h3 id="åˆ›å»ºå­˜å‚¨ä»‹è´¨"><a href="#åˆ›å»ºå­˜å‚¨ä»‹è´¨" class="headerlink" title="åˆ›å»ºå­˜å‚¨ä»‹è´¨"></a>åˆ›å»ºå­˜å‚¨ä»‹è´¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; pvc.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: es-nfs-data</span><br><span class="line">provisioner: fuseim.pri/ifs</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc.yaml</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><ul><li><p>es-statefulset.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># RBAC authn and authz</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - <span class="string">"services"</span></span><br><span class="line">  - <span class="string">"namespaces"</span></span><br><span class="line">  - <span class="string">"endpoints"</span></span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">"get"</span></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># Elasticsearch deployment itself</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    version: v6.6.1</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  serviceName: elasticsearch-logging</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: elasticsearch-logging</span><br><span class="line">      version: v6.6.1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: elasticsearch-logging</span><br><span class="line">        version: v6.6.1</span><br><span class="line">        kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: elasticsearch-logging</span><br><span class="line">      containers:</span><br><span class="line">      - image: elasticsearch:6.6.1</span><br><span class="line">        name: elasticsearch-logging</span><br><span class="line">        resources:</span><br><span class="line">          <span class="comment"># need more cpu upon initialization, therefore burstable class</span></span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9200</span><br><span class="line">          name: db</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9300</span><br><span class="line">          name: transport</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: elasticsearch-logging</span><br><span class="line">          mountPath: /data</span><br><span class="line">        env:</span><br><span class="line">        - name: <span class="string">"NAMESPACE"</span></span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">      <span class="comment"># Elasticsearch requires vm.max_map_count to be at least 262144.</span></span><br><span class="line">      <span class="comment"># If your OS already sets up this number to a higher value, feel free</span></span><br><span class="line">      <span class="comment"># to remove this init container.</span></span><br><span class="line">      initContainers:</span><br><span class="line">      - image: alpine:3.6</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">"/sbin/sysctl"</span>, <span class="string">"-w"</span>, <span class="string">"vm.max_map_count=262144"</span>]</span><br><span class="line">        name: elasticsearch-logging-init</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: <span class="literal">true</span></span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: elasticsearch-logging</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteMany"</span> ]</span><br><span class="line">      storageClassName: <span class="string">"es-nfs-data"</span></span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 30Gi</span><br></pre></td></tr></table></figure></li><li><p>fluentd-es-ds.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - <span class="string">"namespaces"</span></span><br><span class="line">  - <span class="string">"pods"</span></span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">"get"</span></span><br><span class="line">  - <span class="string">"watch"</span></span><br><span class="line">  - <span class="string">"list"</span></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es-v2.4.0</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    version: v2.4.0</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: fluentd-es</span><br><span class="line">      version: v2.4.0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: fluentd-es</span><br><span class="line">        kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">        version: v2.4.0</span><br><span class="line">      <span class="comment"># This annotation ensures that fluentd does not get evicted if the node</span></span><br><span class="line">      <span class="comment"># supports critical pod annotation based priority scheme.</span></span><br><span class="line">      <span class="comment"># Note that this does not guarantee admission on the nodes (#40573).</span></span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'docker/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-node-critical</span><br><span class="line">      serviceAccountName: fluentd-es</span><br><span class="line">      containers:</span><br><span class="line">      - name: fluentd-es</span><br><span class="line">        image: docker.io/xxlaila/fluentd-elasticsearch:v2.4.0</span><br><span class="line">        env:</span><br><span class="line">        - name: FLUENTD_ARGS</span><br><span class="line">          value: --no-supervisor -q</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: varlog</span><br><span class="line">          mountPath: /var/<span class="built_in">log</span></span><br><span class="line">        - name: varlibdockercontainers</span><br><span class="line">          mountPath: /var/lib/docker/containers</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/fluent/config.d</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: varlog</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/<span class="built_in">log</span></span><br><span class="line">      - name: varlibdockercontainers</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/lib/docker/containers</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: fluentd-es-config-v0.2.0</span><br></pre></td></tr></table></figure></li><li><p>kibana-deployment.yaml<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ³¨é‡Šé‡Œé¢çš„ä¸¤è¡Œé…ç½®,ä¸æ³¨é‡Šçš„è¯ï¼Œæ‰“å¼€kibanaçš„æ—¶å€™ä¼šæç¤º<code>kibana {&quot;statusCode&quot;:404,&quot;error&quot;:&quot;Not Found&quot;,&quot;message&quot;:&quot;Not Found&quot;}</code>,å‚è€ƒ<a href="https://github.com/kubernetes-sigs/kubespray/issues/3322" target="_blank" rel="noopener">è§£å†³æ–¹æ¡ˆ</a>,æ³¨é‡Šé…ç½®å¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- name: SERVER_BASEPATH</span><br><span class="line">  value: /api/v1/namespaces/kube-system/services/kibana-logging/proxy</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f ./</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹åˆ›å»º"><a href="#æŸ¥çœ‹åˆ›å»º" class="headerlink" title="æŸ¥çœ‹åˆ›å»º"></a>æŸ¥çœ‹åˆ›å»º</h4><ul><li><p>æŸ¥çœ‹pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system |egrep <span class="string">"kibana|elasticsearch|fluentd"</span></span><br><span class="line">elasticsearch-logging-0                       1/1     Running   0          65m</span><br><span class="line">elasticsearch-logging-1                       1/1     Running   0          61m</span><br><span class="line">fluentd-es-v2.4.0-4fp28                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-b7k67                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-f8jzp                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-shwzm                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-ww8r8                       1/1     Running   0          30m</span><br><span class="line">kibana-logging-57b55f58bc-xh5lp               1/1     Running   0          6m35s</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹service</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc -n kube-system |egrep <span class="string">"kibana|elasticsearch"</span></span><br><span class="line">elasticsearch-logging     ClusterIP   10.254.30.110    &lt;none&gt;        9200/TCP                 9s</span><br><span class="line">kibana-logging            ClusterIP   10.254.188.5     &lt;none&gt;        5601/TCP                 16h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹pvï¼Œpvc</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl get pv,pvc -n kube-system</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                                       STORAGECLASS   REASON   AGE</span><br><span class="line">persistentvolume/pvc-65fdd14e-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            Delete           Bound    kube-system/elasticsearch-logging-elasticsearch-logging-0   es-nfs-data             21m</span><br><span class="line">persistentvolume/pvc-fe818f55-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            Delete           Bound    kube-system/elasticsearch-logging-elasticsearch-logging-1   es-nfs-data             16m</span><br><span class="line"></span><br><span class="line">NAME                                                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">persistentvolumeclaim/elasticsearch-logging-elasticsearch-logging-0   Bound    pvc-65fdd14e-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            es-nfs-data    21m</span><br><span class="line">persistentvolumeclaim/elasticsearch-logging-elasticsearch-logging-1   Bound    pvc-fe818f55-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            es-nfs-data    17m</span><br></pre></td></tr></table></figure></li></ul><h3 id="åˆ›å»ºwebè®¿é—®"><a href="#åˆ›å»ºwebè®¿é—®" class="headerlink" title="åˆ›å»ºwebè®¿é—®"></a>åˆ›å»ºwebè®¿é—®</h3><ul><li><p>kibana-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; kibana-Ingress.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: kibana.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kibana-logging</span><br><span class="line">          servicePort: 5601</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>es-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; es-Ingress &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: es-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: es.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: elasticsearch-logging</span><br><span class="line">          servicePort: 9200</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f es-Ingress.yaml kibana-Ingress.yaml</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æµè§ˆå™¨è®¿é—®es<br><img src="https://img.xxlaila.cn/1569462606884.jpg" alt="img"></p></li><li><p>æµè§ˆå™¨è®¿é—®kibana<br><img src="https://img.xxlaila.cn/1569464839630.jpg" alt="img"><br>å»ºç«‹ç´¢å¼•ï¼Œé»˜è®¤çš„ç´¢å¼•æ˜¯æ ¹æ®å¤©æ¥è‡ªåŠ¨åˆ›å»ºåœ¨esé‡Œé¢ï¼Œè¿™é‡Œæˆ‘æ˜¯åœ¨kibanaé‡Œé¢æ˜¯æ ¹æ®æœˆæ¥å´åˆ†çš„<br><img src="https://img.xxlaila.cn/1569464950776.jpg" alt="img"></p></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>efk</tag>
      </tags>
  </entry>
  <entry>
    <title>ç½‘ç»œçŠ¶æ€ç›‘æ§</title>
    <url>/2019/09/25/%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><h3 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›‘æ§IDCæœºæˆ¿ç½‘ç»œè´¨é‡æƒ…å†µï¼Œæœ¬åœ°åŒºåˆ°å…¶ä»–åœ°åŒºï¼Œå…¶ä»–åœ°åŒºåˆ°æœ¬èŠ‚ç‚¹ï¼Œæˆ–è€…å„çœå¸‚æ—¶é—´ç½‘ç»œã€è¿è¥å•†ç½‘ç»œçŠ¶æ€ï¼Œç›‘è§†ç½‘ç»œæ€§èƒ½ï¼ŒåŒ…æ‹¬å¸¸è§„çš„ pingï¼Œç”¨ fpingã€echopingã€tracert ç›‘è§† www æœåŠ¡å™¨æ€§èƒ½ï¼Œç›‘è§† dns æŸ¥è¯¢æ€§èƒ½ï¼Œç›‘è§† ssh æ€§èƒ½ç­‰ã€‚åº•å±‚ä¹Ÿæ˜¯ rrdtool åšæ”¯æŒï¼Œç‰¹ç‚¹æ˜¯ç”»çš„å›¾éå¸¸æ¼‚äº®ï¼Œç½‘ç»œä¸¢åŒ…å’Œå»¶è¿Ÿç”¨é¢œè‰²å’Œé˜´å½±æ¥è¡¨ç¤ºã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Smokepingã€‚æœ€æ–°ç‰ˆæœ¬çš„ Smokeping æ”¯æŒå¤šä¸ªèŠ‚ç‚¹çš„æ£€æµ‹ç»“æœä»ä¸€ä¸ªå›¾ä¸Šç”»å‡ºæ¥</p><a id="more"></a><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><h4 id="å®‰è£…yumæº"><a href="#å®‰è£…yumæº" class="headerlink" title="å®‰è£…yumæº"></a>å®‰è£…yumæº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm               </span></span><br><span class="line"><span class="comment"># rpm â€“Uvh http://mirrors.neusoft.edu.cn/epel/6/i386/epel-release-6-8.noarch.rpm</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ä¾èµ–åŒ…"><a href="#å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="å®‰è£…ä¾èµ–åŒ…"></a>å®‰è£…ä¾èµ–åŒ…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum â€“y install perl perl-Net-Telnet perl-Net-DNS perl-LDAP perl-libwww-perl perl-RadiusPerl perl-IO-Socket-SSL perl-Socket6 perl-CGI-SpeedyCGI perl-FCGI perl-CGI-SpeedCGI perl-Time-HiRes perl-ExtUtils-MakeMaker perl-RRD-Simple rrdtool rrdtool-perl curl fping echo</span></span><br><span class="line">ping  httpd httpd-devel gcc make  wget libxml2-devel libpng-devel glib pango pango-devel freetype freetype-devel fontconfig cairo cairo-devel libart_lgpl libart_lgpl-devel mod_fastcgi</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…smokeping"><a href="#å®‰è£…smokeping" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h3><h4 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget http://oss.oetiker.ch/smokeping/pub/smokeping-2.6.11.tar.gz è¿™é‡Œä¸‹è½½çš„æœ€æ–°ç‰ˆ</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…FCGI"><a href="#å®‰è£…FCGI" class="headerlink" title="å®‰è£…FCGI"></a>å®‰è£…FCGI</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf CGI-4.33.tar.gz</span></span><br><span class="line"><span class="comment"># cd CGI-4.33</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Config-Grammar"><a href="#å®‰è£…Config-Grammar" class="headerlink" title="å®‰è£…Config-Grammar"></a>å®‰è£…Config-Grammar</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Config-Grammar-1.10.tar.gz</span></span><br><span class="line"><span class="comment"># cd Config-Grammar-1.10</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ExtUtils-MakeMaker"><a href="#å®‰è£…ExtUtils-MakeMaker" class="headerlink" title="å®‰è£…ExtUtils-MakeMaker"></a>å®‰è£…ExtUtils-MakeMaker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf ExtUtils-MakeMaker-7.24.tar.gz</span></span><br><span class="line"><span class="comment"># cd ExtUtils-MakeMaker</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Simple"><a href="#å®‰è£…Simple" class="headerlink" title="å®‰è£…Simple"></a>å®‰è£…Simple</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Test-Simple-1.302056.tar.gz</span></span><br><span class="line"><span class="comment"># cd Test-Simple-1.302056</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">`</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-OpenSSH"><a href="#å®‰è£…Net-OpenSSH" class="headerlink" title="å®‰è£…Net-OpenSSH"></a>å®‰è£…Net-OpenSSH</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Net-OpenSSH-0.73.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-OpenSSH-0.73</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-SNMP"><a href="#å®‰è£…Net-SNMP" class="headerlink" title="å®‰è£…Net-SNMP"></a>å®‰è£…Net-SNMP</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar Net-SNMP-v6.0.1.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-SNMP-v6.0.1</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…perl-ldap"><a href="#å®‰è£…perl-ldap" class="headerlink" title="å®‰è£…perl-ldap"></a>å®‰è£…perl-ldap</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf perl-ldap-0.65.tar.gz</span></span><br><span class="line"><span class="comment"># cd perl-ldap-0.65</span></span><br><span class="line"><span class="comment"># ./install-nomake</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-DNS"><a href="#å®‰è£…Net-DNS" class="headerlink" title="å®‰è£…Net-DNS"></a>å®‰è£…Net-DNS</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Net-DNS-1.06.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-DNS-1.06</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…IO-Tty"><a href="#å®‰è£…IO-Tty" class="headerlink" title="å®‰è£…IO-Tty"></a>å®‰è£…IO-Tty</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar IO-Tty-1.12.tar.gz</span></span><br><span class="line"><span class="comment"># cd IO-Tty-1.12</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…libwww-perl"><a href="#å®‰è£…libwww-perl" class="headerlink" title="å®‰è£…libwww-perl"></a>å®‰è£…libwww-perl</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf libwww-perl-6.15.tar.gz</span></span><br><span class="line"><span class="comment"># cd libwww-perl-6.15</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…smokeping-1"><a href="#å®‰è£…smokeping-1" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf smokeping-2.6.11.tar.gz</span></span><br><span class="line"><span class="comment"># cd smokeping-2.6.11</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/smokeping</span></span><br><span class="line"><span class="comment"># /usr/bin/gmake install</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œé’ˆå¯¹ç½‘ç»œä¸èƒ½ç¿»å¢™ã€‚ä¹Ÿå¯ä»¥é‡‡å–smokepingä¸€é”®å®‰è£…çš„æ–¹å¼è¿›è¡Œå®‰è£…</p><h3 id="smokepingä¸€é”®å®‰è£…"><a href="#smokepingä¸€é”®å®‰è£…" class="headerlink" title="smokepingä¸€é”®å®‰è£…"></a>smokepingä¸€é”®å®‰è£…</h3><h4 id="å®‰è£…smokeping-2"><a href="#å®‰è£…smokeping-2" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf smokeping-2.6.11.tar.gz</span></span><br><span class="line"><span class="comment"># cd smokeping-2.6.11</span></span><br><span class="line"><span class="comment"># ./setup/build-perl-modules.sh /usr/local/smokeping/thirdparty</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/smokeping</span></span><br><span class="line"><span class="comment"># /usr/bin/gmake install</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®smkeping"><a href="#é…ç½®smkeping" class="headerlink" title="é…ç½®smkeping"></a>é…ç½®smkeping</h3><h4 id="åˆ›å»ºcacheã€dataã€varç›®å½•"><a href="#åˆ›å»ºcacheã€dataã€varç›®å½•" class="headerlink" title="åˆ›å»ºcacheã€dataã€varç›®å½•"></a>åˆ›å»ºcacheã€dataã€varç›®å½•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/smokeping/</span></span><br><span class="line"><span class="comment"># mkdir &#123;cache,data,var&#125;</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ—¥å¿—æ–‡ä»¶"><a href="#åˆ›å»ºæ—¥å¿—æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæ—¥å¿—æ–‡ä»¶"></a>åˆ›å»ºæ—¥å¿—æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># touch /var/log/smokeping.log</span></span><br></pre></td></tr></table></figure><h4 id="èµ‹æƒé™"><a href="#èµ‹æƒé™" class="headerlink" title="èµ‹æƒé™"></a>èµ‹æƒé™</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chown apache:apache cache/ data/ var/</span></span><br><span class="line"><span class="comment"># chown  apache:apache /var/log/smokeping.log</span></span><br><span class="line"><span class="comment"># chmod 755 cache/ data/ var/    #è¿™é‡Œä¹Ÿè¦èµ‹æƒé™ï¼Œä¼šå½±å“å›¾ç‰‡æ— æ³•åŠ è½½</span></span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/local/smokeping/htdocs</span></span><br><span class="line"><span class="comment"># cp -arp smokeping.fcgi.dist smokeping.fcgi</span></span><br><span class="line"><span class="comment"># cd ../etc/</span></span><br><span class="line"><span class="comment"># cp -arp config.dist config</span></span><br><span class="line"><span class="comment"># chmod 600 /usr/local/smokeping/etc/smokeping_secrets.dist</span></span><br><span class="line"><span class="comment"># vim config</span></span><br><span class="line">*** General ***</span><br><span class="line">owner    = Peter Random</span><br><span class="line">contact  = some@address.nowhere</span><br><span class="line">mailhost = my.mail.host</span><br><span class="line">sendmail = /usr/sbin/sendmail</span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> do not put the Image Cache below cgi-bin</span></span><br><span class="line"><span class="comment"># since all files under cgi-bin will be executed ... this is not</span></span><br><span class="line"><span class="comment"># good for images.</span></span><br><span class="line">imgcache = /usr/<span class="built_in">local</span>/smokeping/cache</span><br><span class="line">imgurl   = http://172.16.1.100/cache                                                      <span class="comment">#è¿™é‡Œå¦‚æœä¸é…ç½®æ­£ç¡®ï¼Œä¼šå½±å“åé¢å‡ºå›¾ï¼Œè¿™é‡Œä¸€ä¸ªå‘</span></span><br><span class="line">datadir  = /usr/<span class="built_in">local</span>/smokeping/data</span><br><span class="line">piddir  = /usr/<span class="built_in">local</span>/smokeping/var</span><br><span class="line">cgiurl   = http://172.16.1.100/smokeping/smokeping.cgi</span><br><span class="line"><span class="comment">#cgiurl   = http://some.url/smokeping.cgi</span></span><br><span class="line">smokemail = /usr/<span class="built_in">local</span>/smokeping/etc/smokemail.dist</span><br><span class="line">tmail = /usr/<span class="built_in">local</span>/smokeping/etc/tmail.dist</span><br><span class="line"><span class="comment"># specify this to get syslog logging</span></span><br><span class="line">syslogfacility = local0</span><br><span class="line"><span class="comment"># each probe is now run in its own process</span></span><br><span class="line"><span class="comment"># disable this to revert to the old behaviour</span></span><br><span class="line"><span class="comment"># concurrentprobes = no</span></span><br><span class="line">*** Alerts ***</span><br><span class="line">to = alertee@address.somewhere</span><br><span class="line">from = smokealert@company.xy</span><br><span class="line">+someloss</span><br><span class="line"><span class="built_in">type</span> = loss</span><br><span class="line"><span class="comment"># in percent</span></span><br><span class="line">pattern = &gt;0%,*12*,&gt;0%,*12*,&gt;0%</span><br><span class="line">comment = loss 3 <span class="built_in">times</span>  <span class="keyword">in</span> a row</span><br><span class="line">*** Database ***</span><br><span class="line">step     = 60                                              <span class="comment">#æ£€æµ‹æ—¶é—´ï¼Œé»˜è®¤300</span></span><br><span class="line">pings    = 20</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸Šè¿°ä¿®æ”¹å¸¦æœ‰æ³¨è§†éƒ¨åˆ†ï¼Œå…¶ä»–å‚æ•°å‚è€ƒå®˜æ–¹ï¼Œè€Œä¸”éƒ½èƒ½çœ‹æ‡‚ã€‚åé¢æœ‰å¾ˆå¤šé…ç½®ä¸å…¨éƒ¨è´´å‡ºæ¥</p><h3 id="é…ç½®apache"><a href="#é…ç½®apache" class="headerlink" title="é…ç½®apache"></a>é…ç½®apache</h3><h4 id="é…ç½®httpd-conf"><a href="#é…ç½®httpd-conf" class="headerlink" title="é…ç½®httpd.conf"></a>é…ç½®httpd.conf</h4><p>åœ¨DocumentRoot â€œ/var/www/htmlâ€è¿™è¡Œå¢åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">Alias /cache <span class="string">"/usr/local/smokeping/cache"</span></span><br><span class="line">Alias /cropper <span class="string">"/usr/local/smokeping/htdocs/cropper"</span></span><br><span class="line">Alias /smokeping <span class="string">"/usr/local/smokeping/htdocs/smokeping.fcgi"</span></span><br><span class="line">&lt;Directory <span class="string">"/usr/local/smokeping"</span>&gt;</span><br><span class="line">        AllowOverride None</span><br><span class="line">        Options All</span><br><span class="line">        AddHandler cgi-script .fcgi .cgi</span><br><span class="line">        Order allow,deny</span><br><span class="line">        Allow from all</span><br><span class="line">        AuthName <span class="string">"Smokeping"</span></span><br><span class="line">        AuthType Basic</span><br><span class="line">        AuthUserFile /usr/<span class="built_in">local</span>/smokeping/htdocs/htpasswd</span><br><span class="line">        Require valid-user</span><br><span class="line">        DirectoryIndex smokeping.fcgi</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure><h4 id="apacheç™»å½•è®¤è¯"><a href="#apacheç™»å½•è®¤è¯" class="headerlink" title="apacheç™»å½•è®¤è¯"></a>apacheç™»å½•è®¤è¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/local/smokeping/htdocs</span></span><br><span class="line"><span class="comment"># htpasswd -c /usr/local/smokeping/htdocs/htpasswd admin                   #å›è½¦è®¾ç½®adminè´¦æˆ·çš„å¯†ç </span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“"><a href="#å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“" class="headerlink" title="å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“"></a>å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install wqy-zenhei-fonts.noarch</span></span><br></pre></td></tr></table></figure><h4 id="smokepingå¼€æœºè„šæœ¬"><a href="#smokepingå¼€æœºè„šæœ¬" class="headerlink" title="smokepingå¼€æœºè„šæœ¬"></a>smokepingå¼€æœºè„šæœ¬</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/init.d/smokeping</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">PIDFILE=/usr/<span class="built_in">local</span>/smokeping/var/smokeping.pid</span><br><span class="line">SMOKEPING=/usr/<span class="built_in">local</span>/smokeping/bin/smokeping</span><br><span class="line">ERROR=0</span><br><span class="line">RUNNING=0</span><br><span class="line">ARGV=<span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x<span class="variable">$ARGV</span>"</span> = <span class="string">"x"</span> ] ; <span class="keyword">then</span></span><br><span class="line">ARGS=<span class="built_in">help</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">for</span> ARG <span class="keyword">in</span> <span class="variable">$@</span> <span class="variable">$ARGS</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$PIDFILE</span> ] ; <span class="keyword">then</span></span><br><span class="line">PID=`cat <span class="variable">$PIDFILE</span>`</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> -0 <span class="variable">$PID</span> 2&gt;/dev/null ; <span class="keyword">then</span></span><br><span class="line"><span class="comment"># smokeping is running</span></span><br><span class="line">RUNNING=1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># smokeping not running but PID file exists =&gt; delete PID file</span></span><br><span class="line">rm -f <span class="variable">$PIDFILE</span></span><br><span class="line">RUNNING=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># smokeping (no pid file) not running</span></span><br><span class="line">RUNNING=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$ARG</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 0 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$SMOKEPING</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping started"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be started"</span></span><br><span class="line">ERROR=1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is running with PID <span class="variable">$PID</span>"</span></span><br><span class="line">ERROR=2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> <span class="variable">$PID</span> ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping (<span class="variable">$PID</span>) stopped"</span></span><br><span class="line">rm <span class="variable">$PIDFILE</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be stopped"</span></span><br><span class="line">ERROR=3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping not running"</span></span><br><span class="line">ERROR=4</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$SMOKEPING</span> --restart &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping restarted"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be started"</span></span><br><span class="line">ERROR=5</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="variable">$0</span> start</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">strace_debug)</span><br><span class="line">rm -f /tmp/strace_smokeping</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> strace -o/tmp/strace_smokeping <span class="variable">$SMOKEPING</span> --restart &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping restarted with strace debug in /tmp/strace_smokeping"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping strace debug could not be started"</span></span><br><span class="line">ERROR=6</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">if</span> strace -o/tmp/strace_smokeping <span class="variable">$SMOKEPING</span> &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping started with strace debug in /tmp/strace_smokeping"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping strace debug could not be started"</span></span><br><span class="line">ERROR=7</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is running with PID (<span class="variable">$PID</span>)"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is not running"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$0</span> (start|stop|restart|status|strace_debug|help)"</span></span><br><span class="line">cat</span><br><span class="line">start - start smokeping</span><br><span class="line">stop - stop smokeping</span><br><span class="line">restart - restart smokeping <span class="keyword">if</span> running or start <span class="keyword">if</span> not running</span><br><span class="line">status - show status <span class="keyword">if</span> smokeping is running or not</span><br><span class="line"><span class="built_in">help</span> - this screen</span><br><span class="line">EOF</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$ERROR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod +x /etc/init.d/smokeping</span></span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service httpd start</span></span><br><span class="line"><span class="comment"># /etc/init.d/smokeping start</span></span><br></pre></td></tr></table></figure><p>æ‰“å¼€æµè§ˆå™¨æµ‹è¯•http://{ip}/smokeping ä¼šæç¤ºè¾“å…¥ç”¨æˆ·å’Œå¯†ç <br><img src="https://img.xxlaila.cn/74D2C8DE-129F-4219-87C5-D6A771D19484.png" alt="img"><br><img src="https://img.xxlaila.cn/91D9FA70-65B1-4752-8F15-68A158E72A49.png" alt="img"></p><h4 id="é…ç½®æ–‡ä»¶æ·»åŠ "><a href="#é…ç½®æ–‡ä»¶æ·»åŠ " class="headerlink" title="é…ç½®æ–‡ä»¶æ·»åŠ "></a>é…ç½®æ–‡ä»¶æ·»åŠ </h4><p>é…ç½®æ–‡ä»¶æ·»ä»‹ç»ï¼Œåœ¨é…ç½®æ–‡ä»¶é‡Œé¢+è¡¨ç¤ºä¸€çº§++è¡¨ç¤ºäºŒçº§+++ä¸‰çº§<br>æœ¬æ¬¡æ·»åŠ çš„å†…å®¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">+ Other</span><br><span class="line">menu = å…¶ä»–ç½‘ç»œç›‘æ§</span><br><span class="line">title = å…¶ä»–æ‰€æœ‰ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">++ dianxin</span><br><span class="line">menu = ç”µä¿¡ç½‘ç»œç›‘æ§</span><br><span class="line">title = ç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/dianxin/dianxin-hlj /Other/dianxin/dianxin-gd /Other/dianxin/dianxin-gs /Other/dianxin/dianxin-sh /Other/dianxin/dianxin-sc /Other/dianxin/dianxin-cq /Other/dianxin/dianxin-gz /Other/dianxin/dianxin-ln /Other/dianxin/dianxin-zj /Other/dianxin/dianxin-sd /Other/dianxin/dianxin-hib /Other/dianxin/dianxin-ah /Other/dianxin/dianxin-hb /Other/dianxin/dianxin-jl /Other/dianxin/dianxin-jx</span><br><span class="line">+++ dianxin-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿç”µä¿¡</span><br><span class="line">title = é»‘é¾™æ±Ÿç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 219.150.32.132</span><br><span class="line">+++ dianxin-gd</span><br><span class="line">menu = å¹¿ä¸œç”µä¿¡</span><br><span class="line">title = å¹¿ä¸œç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.96.134.133</span><br><span class="line">+++ dianxin-gs</span><br><span class="line">menu = ç”˜è‚ƒç”µä¿¡</span><br><span class="line">title = ç”˜è‚ƒç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.100.64.68</span><br><span class="line">+++ dianxin-sh</span><br><span class="line">menu = ä¸Šæµ·ç”µä¿¡</span><br><span class="line">title = ä¸Šæµ·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.96.209.5</span><br><span class="line">+++ dianxin-sc</span><br><span class="line">menu = å››å·ç”µä¿¡</span><br><span class="line">title = å››å·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.6.145.111</span><br><span class="line">+++ dianxin-cq</span><br><span class="line">menu = é‡åº†ç”µä¿¡</span><br><span class="line">title = é‡åº†ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 61.128.128.68</span><br><span class="line">+++ dianxin-gz</span><br><span class="line">menu = è´µå·ç”µä¿¡</span><br><span class="line">title = è´µå·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.98.192.68</span><br><span class="line">+++ dianxin-ln</span><br><span class="line">menu = è¾½å®ç”µä¿¡</span><br><span class="line">title = è¾½å®ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 219.149.6.99</span><br><span class="line">+++ dianxin-zj</span><br><span class="line">menu = æµ™æ±Ÿç”µä¿¡</span><br><span class="line">title = æµ™æ±Ÿç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.96.96.68</span><br><span class="line">+++ dianxin-sd</span><br><span class="line">menu = å±±ä¸œç”µä¿¡</span><br><span class="line">title = å±±ä¸œç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 222.173.95.53</span><br><span class="line">+++ dianxin-hib</span><br><span class="line">menu = æ¹–åŒ—ç”µä¿¡</span><br><span class="line">title = æ¹–åŒ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.103.0.68</span><br><span class="line">+++ dianxin-ah</span><br><span class="line">menu = å®‰å¾½ç”µä¿¡</span><br><span class="line">title = å®‰å¾½ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 220.178.75.134</span><br><span class="line">+++ dianxin-hb</span><br><span class="line">menu = æ²³åŒ—ç”µä¿¡</span><br><span class="line">title = æ²³åŒ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.99.160.68</span><br><span class="line">+++ dianxin-jl</span><br><span class="line">menu = å‰æ—ç”µä¿¡</span><br><span class="line">title = å‰æ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host =  219.149.194.55</span><br><span class="line">+++ dianxin-jx</span><br><span class="line">menu = æ±Ÿè¥¿ç”µä¿¡</span><br><span class="line">title = æ±Ÿè¥¿ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.101.224.68</span><br><span class="line"><span class="comment">#+++ dianxin-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/dianxin/dianxin-hlj /Other/dianxin/dianxin-gd /Other/dianxin/dianxin-gs /Other/dianxin/dianxin-sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">++ liantong</span><br><span class="line">menu = è”é€šç½‘ç»œç›‘æ§</span><br><span class="line">title = è”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/liantong/liantong-hlj /Other/liantong/liantong-gd /Other/liantong/liantong-gs /Other/liantong/liantong-sh /Other/liantong/liantong-sc /Other/liantong/liantong-cq /Other/liantong/liantong-gz /Other/liantong/liantong-ln /Other/liantong/liantong-zj /Other/liantong/liantong-sd /Other/liantong/liantong-hib /Other/liantong/liantong-ah /Other/liantong/liantong-hb /Other/liantong/liantong-jl /Other/liantong/liantong-jx</span><br><span class="line">+++ liantong-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿè”é€š</span><br><span class="line">title = é»‘é¾™æ±Ÿè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.97.224.68</span><br><span class="line">+++ liantong-gd</span><br><span class="line">menu = å¹¿ä¸œè”é€š</span><br><span class="line">title = å¹¿ä¸œè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 221.4.66.66</span><br><span class="line">+++ liantong-gs</span><br><span class="line">menu = ç”˜è‚ƒè”é€š</span><br><span class="line">title = ç”˜è‚ƒè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 221.7.34.10</span><br><span class="line">+++ liantong-sh</span><br><span class="line">menu = ä¸Šæµ·è”é€š</span><br><span class="line">title = ä¸Šæµ·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 210.22.70.3</span><br><span class="line">+++ liantong-sc</span><br><span class="line">menu = å››å·è”é€š</span><br><span class="line">title = å››å·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 119.6.6.6</span><br><span class="line">+++ liantong-cq</span><br><span class="line">menu = é‡åº†è”é€š</span><br><span class="line">title = é‡åº†è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.7.92.98</span><br><span class="line">+++ liantong-gz</span><br><span class="line">menu = è´µå·è”é€š</span><br><span class="line">title = è´µå·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.13.30.242</span><br><span class="line">+++ liantong-ln</span><br><span class="line">menu = è¾½å®è”é€š</span><br><span class="line">title = è¾½å®è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 124.161.97.234</span><br><span class="line">+++ liantong-zj</span><br><span class="line">menu = æµ™æ±Ÿè”é€š</span><br><span class="line">title = æµ™æ±Ÿè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.12.33.227</span><br><span class="line">+++ liantong-sd</span><br><span class="line">menu = å±±ä¸œè”é€š</span><br><span class="line">title = å±±ä¸œè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.102.152.3</span><br><span class="line">+++ liantong-hib</span><br><span class="line">menu = æ¹–åŒ—è”é€š</span><br><span class="line">title = æ¹–åŒ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.104.111.114</span><br><span class="line">+++ liantong-ah</span><br><span class="line">menu = å®‰å¾½è”é€š</span><br><span class="line">title = å®‰å¾½è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.91.88.129</span><br><span class="line">+++ liantong-hb</span><br><span class="line">menu = æ²³åŒ—è”é€š</span><br><span class="line">title = æ²³åŒ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.99.160.68</span><br><span class="line">+++ liantong-jl</span><br><span class="line">menu = å‰æ—è”é€š</span><br><span class="line">title = å‰æ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.98.5.6</span><br><span class="line">+++ liantong-jx</span><br><span class="line">menu = æ±Ÿè¥¿è”é€š</span><br><span class="line">title = æ±Ÿè¥¿è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 220.248.192.12</span><br><span class="line"><span class="comment">#+++ liantong-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªè”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªè”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/liantong/liantong-hlj /Other/liantong/liantong-gd /Other/liantong/liantong-gs /Other/liantong/liantong-sh</span></span><br><span class="line">++ yidong</span><br><span class="line">menu = ç§»åŠ¨ç½‘ç»œç›‘æ§</span><br><span class="line">title = ç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/yidong/yidong-hlj /Other/yidong/yidong-gd /Other/yidong/yidong-gs /Other/yidong/yidong-sh /Other/yidong/yidong-sc /Other/yidong/yidong-cq /Other/yidong/yidong-gz /Other/yidong/yidong-ln /Other/yidong/yidong-zj /Other/yidong/yidong-sd /Other/yidong/yidong-hib /Other/yidong/yidong-ah /Other/yidong/yidong-hb</span><br><span class="line">+++ yidong-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿç§»åŠ¨</span><br><span class="line">title = é»‘é¾™æ±Ÿç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 211.137.241.34</span><br><span class="line">+++ yidong-gd</span><br><span class="line">menu = å¹¿ä¸œç§»åŠ¨</span><br><span class="line">title = å¹¿ä¸œç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 211.137.241.34</span><br><span class="line">+++ yidong-gs</span><br><span class="line">menu = ç”˜è‚ƒç§»åŠ¨</span><br><span class="line">title = ç”˜è‚ƒç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 218.203.160.194</span><br><span class="line">+++ yidong-sh</span><br><span class="line">menu = ä¸Šæµ·ç§»åŠ¨</span><br><span class="line">title = ä¸Šæµ·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 117.131.0.22</span><br><span class="line">+++ yidong-sc</span><br><span class="line">menu = å››å·ç§»åŠ¨</span><br><span class="line">title = å››å·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.96.205</span><br><span class="line">+++ yidong-cq</span><br><span class="line">menu = é‡åº†ç§»åŠ¨</span><br><span class="line">title = é‡åº†ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.201.4.3</span><br><span class="line">+++ yidong-gz</span><br><span class="line">menu = è´µå·ç§»åŠ¨</span><br><span class="line">title = è´µå·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.139.1.3</span><br><span class="line">+++ yidong-ln</span><br><span class="line">menu = è¾½å®ç§»åŠ¨</span><br><span class="line">title = è¾½å®ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.59.181.182</span><br><span class="line">+++ yidong-zj</span><br><span class="line">menu = æµ™æ±Ÿç§»åŠ¨</span><br><span class="line">title = æµ™æ±Ÿç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.140.10.2</span><br><span class="line">+++ yidong-sd</span><br><span class="line">menu = å±±ä¸œç§»åŠ¨</span><br><span class="line">title = å±±ä¸œç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.191.26</span><br><span class="line">+++ yidong-hib</span><br><span class="line">menu = æ¹–åŒ—ç§»åŠ¨</span><br><span class="line">title = æ¹–åŒ—ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.76.68</span><br><span class="line">+++ yidong-ah</span><br><span class="line">menu = å®‰å¾½ç§»åŠ¨</span><br><span class="line">title = å®‰å¾½ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.138.180.2</span><br><span class="line">+++ yidong-hb</span><br><span class="line">menu = æ²³åŒ—ç§»åŠ¨</span><br><span class="line">title = æ²³åŒ—ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.98.2.4</span><br><span class="line"><span class="comment">#+++ yidong-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/yidong/yidong-hlj /Other/yidong/yidong-gd /Other/yidong/yidong-gs /Other/yidong/yidong-sh</span></span><br><span class="line">++ jiaoyu</span><br><span class="line">menu = æ•™è‚²ç½‘ç»œç›‘æ§</span><br><span class="line">title = æ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/jiaoyu/jiaoyu-qh /Other/jiaoyu/jiaoyu-sh /Other/jiaoyu/jiaoyu-wh /Other/jiaoyu/jiaoyu-hn</span><br><span class="line">+++ jiaoyu-qh</span><br><span class="line">menu = æ¸…åå¤§å­¦</span><br><span class="line">title = æ¸…åå¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 166.111.8.28</span><br><span class="line">+++ jiaoyu-sh</span><br><span class="line">menu = ä¸Šæµ·äº¤å¤§</span><br><span class="line">title = ä¸Šæµ·äº¤å¤§</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.112.26.34</span><br><span class="line">+++ jiaoyu-wh</span><br><span class="line">menu = æ­¦æ±‰ç§‘æŠ€å¤§å­¦</span><br><span class="line">title = æ­¦æ±‰ç§‘æŠ€å¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.114.240.6</span><br><span class="line">+++ jiaoyu-hn</span><br><span class="line">menu = åå—å†œä¸šå¤§å­¦</span><br><span class="line">title = åå—å†œä¸šå¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.116.160.33</span><br><span class="line"><span class="comment">#+++ jiaoyu-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªæ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªæ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/jiaoyu/jiaoyu-qh /Other/jiaoyu/jiaoyu-sh /Other/jiaoyu/jiaoyu-wh /Other/jiaoyu/jiaoyu-hn</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Smokeping</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux å¸¸ç”¨å‘½ä»¤å­¦ä¹ </title>
    <url>/2019/09/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h4 id="æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤"><a href="#æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤" class="headerlink" title="æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤"></a>æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤</h4><ul><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹é¢å¤§å°è¶…è¿‡5Mçš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ -size +5M</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹100å¤©ä¹‹å‰ä¿®æ”¹è¿‡çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ -mtime +100</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹60å¤©æœªè¢«è®¿é—®è¿‡çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ \! atime -60</span><br></pre></td></tr></table></figure></li></ul><a id="more"></a><ul><li>æŸ¥æ‰¾ç›®å½•ä¸‹é¢æ–‡ä»¶â€œcoreâ€œï¼Œå¦‚æœå‘ç°æ— éœ€æç¤ºç›´æ¥åˆ é™¤ã€‚<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find / -name core -<span class="built_in">exec</span> rm &#123;&#125; \</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾æ’é™¤æŸä¸€ä¸ªæ–‡ä»¶ç„¶åè¿›è¡Œåˆ é™¤</span></span><br><span class="line">$ find / -<span class="built_in">type</span> f ! -name <span class="string">"test"</span> -<span class="built_in">exec</span> rm &#123;&#125; \;</span><br><span class="line">$ find ./ -mtime +3 -name <span class="string">"*.log"</span> -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br><span class="line">$ find /tmp -mtime +30 -<span class="built_in">type</span> f -name <span class="string">"*.sh[ab]"</span> -<span class="built_in">exec</span> rm -f &#123;&#125; \;</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨ä¸€ä¸ªç›®å½•ä¸­ä¿ç•™æœ€è¿‘30å¤©çš„æ–‡ä»¶ï¼Œ30å¤©å‰çš„æ–‡ä»¶è‡ªåŠ¨åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /tmp -mtime +30 -<span class="built_in">type</span> f -name <span class="string">"*.sh[ab]"</span> -<span class="built_in">exec</span> rm -f &#123;&#125; \;</span><br></pre></td></tr></table></figure><ul><li>/tmp â€“è®¾ç½®æŸ¥æ‰¾çš„ç›®å½•ï¼›</li><li>-mtime +30 â€“è®¾ç½®æ—¶é—´ä¸º30å¤©å‰ï¼›</li><li>-type f â€“è®¾ç½®æŸ¥æ‰¾çš„ç±»å‹ä¸ºæ–‡ä»¶ï¼›</li><li>-name *.sh[ab] â€“è®¾ç½®æ–‡ä»¶åç§°ä¸­åŒ…å«shaæˆ–è€…shbï¼›</li><li>-exec rm -f â€“æŸ¥æ‰¾å®Œæ¯•åæ‰§è¡Œåˆ é™¤æ“ä½œï¼›</li><li><strong>æç¤º</strong>ï¼šå°†æ­¤å‘½ä»¤å†™å…¥crontabåå³å¯è‡ªåŠ¨å®ŒæˆæŸ¥æ‰¾å¹¶åˆ é™¤çš„å·¥ä½œ</li></ul><ul><li>æ˜¾ç¤ºç›®å½•æ–‡ä»¶çš„æ–‡ä»¶åå’Œå®ƒä»¬çš„æ‹¥æœ‰è€…<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ll | awk <span class="string">'&#123;print $3,"owns",$9&#125;'</span></span><br></pre></td></tr></table></figure></li></ul><p>æ˜¾ç¤ºä½ çš„ç³»ç»Ÿä¸ŠPCIæ€»çº¿å’Œé™„åŠ è®¾å¤‡çš„ä¿¡æ¯ã€‚æŒ‡å®š-vï¼Œ-vvæˆ–-vvvæ¥è·å–è¶Šæ¥è¶Šè¯¦ç»†çš„è¾“å‡º</p><ul><li><p>lspci å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum whatprovides */lspci</span><br><span class="line">pciutils-3.5.1-2.el7.x86_64 : PCI bus related utilities</span><br><span class="line">Repo        : base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /usr/sbin/lspci</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pciutils-3.5.1-3.el7.x86_64 : PCI bus related utilities</span><br><span class="line">Repo        : base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /usr/sbin/lspci</span><br><span class="line"></span><br><span class="line">$ sudo yum install pciutils</span><br><span class="line"></span><br><span class="line">lspci æ›´å¤š[è¯¦ç»†ä½¿ç”¨](https://blog.csdn.net/styshoo/article/details/51281437)</span><br><span class="line"></span><br><span class="line">$ lspci -vvvvv</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å½“å‰çš„LinuxæœåŠ¡å™¨çš„è¿è¡Œçº§åˆ«</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ who -r</span><br><span class="line">$ who -b </span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿæœ€åä¸€æ¬¡å¯åŠ¨çš„æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">$ last reboot</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿå†å²å¯åŠ¨çš„æ—¶é—´</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿè¿è¡Œäº†å¤šé•¿æ—¶é—´</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /proc/uptime| awk -F. <span class="string">'&#123;run_days=$1 / 86400;run_hour=($1 % 86400)/3600;run_minute=($1 % 3600)/60;run_second=$1 % 60;printf("ç³»ç»Ÿå·²è¿è¡Œï¼š%då¤©%dæ—¶%dåˆ†%dç§’",run_days,run_hour,run_minute,run_second)&#125;'</span></span><br><span class="line">$ w</span><br><span class="line">$ uptime</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿå¯åŠ¨çš„æ—¥æœŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ date -d <span class="string">"<span class="variable">$(awk -F. '&#123;print $1&#125;' /proc/uptime)</span> second ago"</span> +<span class="string">"%Y-%m-%d %H:%M:%S"</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶å†…å®¹æ²¡æœ‰åŒ…æ‹¬â€œnginxâ€ã€â€œmsgTypeâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep -r -l -v <span class="string">"nginx"</span> /data/</span><br><span class="line">$ grep -r  -v <span class="string">"msgType"</span> /data/</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶å†…å®¹åŒ…æ‹¬â€nginxâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep -r <span class="string">"nginx"</span> /data/                                             ä¼šæŠŠ<span class="string">"nginx"</span>å­—ç¬¦ä¸²æ‰€åœ¨è¿™è¡Œçš„å†…å®¹æ˜¾ç¤ºå‡ºæ¥</span><br><span class="line">$ grep -o â€œnginxâ€ /data/</span><br><span class="line">$ grep -r -l <span class="string">"nginx"</span> /data/                                          ä¸æ˜¾ç¤º<span class="string">"nginx"</span>å­—ç¬¦ä¸²æ‰€åœ¨è¡Œï¼Œæ˜¯æ˜¾ç¤ºæ–‡ä»¶</span><br></pre></td></tr></table></figure></li><li><p>catä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat sentry.conf.py |grep -v <span class="string">"^#"</span>          æŸ¥çœ‹é…ç½®æ–‡ä»¶ä¸åŒ…æ‹¬æ³¨é‡Šå†…å®¹</span><br><span class="line">$ cat -b `find /var/<span class="built_in">log</span>/httpd/ -cmin -60 -<span class="built_in">print</span> |sed <span class="string">"1d"</span>`\ |awk <span class="string">'&#123;print $2&#125;'</span>|sort |uniq -c |sort -n -k 1 -r |head -n 1               ç»Ÿè®¡å½“å‰ç›®å½•ä¸‹æ—¥å¿—æ–‡ä»¶é‡Œé¢Iå¹³è®¿é—®é‡æœ€å¤šçš„ä¸€ä¸ªIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŸä¸€ä¸ªæ—¶é—´æ®µçš„IPåœ°å€è®¿é—®æ’åå‰10</span></span><br><span class="line">$ cat nginx_access.log|grep <span class="string">'+0800'</span>|awk <span class="string">'&#123;split($1,array,"[");if(array[2]&gt;="25/Jul/2017:14:17:30" &amp;&amp; array[2]&lt;="25/Jul/2017:20:17:30")&#123;print $0&#125;&#125;'</span>|awk -F<span class="string">"^`"</span> &amp;&amp; <span class="string">"-"</span> &amp;&amp; <span class="string">"^`"</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å½“å‰æ—¥å¿—ipè®¿é—®å‰10</span></span><br><span class="line">$ cat nginx_access.log |awk -F<span class="string">"^"</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br></pre></td></tr></table></figure></li><li><p>è·å–IPåœ°å€é€šç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig |sed -n 2p |awk <span class="string">'&#123;print $1$2&#125;'</span>|sed <span class="string">'s/^.*[^0-9]\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)$/\1\.\2\.\3\.\4/g'</span></span><br></pre></td></tr></table></figure></li><li><p>curlä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›‘æ§ç½‘é¡µçš„å“åº”æ—¶é—´</span></span><br><span class="line">$ curl -o /dev/null -s -w <span class="string">"time_connect: %&#123;time_connect&#125;\ntime_starttransfer: %&#123;time_starttransfer&#125;\ntime_total: %&#123;time_total&#125;\n"</span> <span class="string">"http://www.baidu.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›‘æ§ç«™ç‚¹å¯ç”¨æ€§</span></span><br><span class="line">$ curl -o /dev/null -s -w %&#123;http_code&#125; <span class="string">"http://www.baidu.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯gzipè¯·æ±‚</span></span><br><span class="line">$ curl -I http://www.sina.com.cn/ -H Accept-Encoding:gzip,defalte</span><br></pre></td></tr></table></figure></li><li><p>æ¯10ç§’æ˜¾ç¤ºä¸€æ¬¡å¤åˆ¶çš„å¤§å°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ watch -n 10 du -sh /root</span><br></pre></td></tr></table></figure></li><li><p>ç»Ÿè®¡ç›®å½•(åŒ…æ‹¬å­ç›®å½•)ä¸‹é¢æ–‡ä»¶ä¸ªæ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find ./ -<span class="built_in">type</span> f | wc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨findå‘½ä»¤æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ˜¯æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶ï¼Œç„¶åç”¨wcæ¥è®¡æ•°</span></span><br><span class="line">$ ls -lR|grep <span class="string">"^-"</span>|wc -l</span><br><span class="line"><span class="comment"># lså‘½ä»¤åŠ Rå‚æ•°ï¼Œåˆ—å‡ºä¸‹çº§å­ç›®å½•ï¼Œä½¿ç”¨grepå‘½ä»¤è¿‡æ»¤ä»¥â€œ-â€å¼€å¤´çš„ï¼Œå¦‚æœæ˜¯ç›®å½•å°±æ”¹æˆâ€œ^dâ€ï¼Œåé¢ç”¨wcè®¡æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line">$ find ./ -name <span class="string">"*.*"</span> |xargs cat|grep -v ^$|wc -l</span><br><span class="line">$ find . \( ! -name <span class="string">'*.png'</span> ! -name <span class="string">'*.gif'</span> ! -name <span class="string">'*.jpg'</span> ! -name <span class="string">'*.swf'</span> \) -<span class="built_in">type</span> f |wc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„çš„è¡Œæ•°ï¼Œå»æ‰ç©ºè¡Œ</span></span><br><span class="line">$ find ./ -name <span class="string">"*.*"</span> |xargs cat|wc -l   </span><br><span class="line">$ find . \( ! -name <span class="string">'*.png'</span> ! -name <span class="string">'*.gif'</span> ! -name <span class="string">'*.jpg'</span> ! -name <span class="string">'*.swf'</span> \) -<span class="built_in">type</span> f |xargs cat|wc -l</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿtcpè¿æ¥ä¸­å„ä¸ªçŠ¶æ€çš„è¿æ¥æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -an | awk '/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºæ¯ä¸ªIPçš„è¿æ¥æ•°ï¼Œä»¥åŠæ€»çš„å„ä¸ªçŠ¶æ€çš„è¿æ¥æ•°</span></span><br><span class="line">$ netstat -n | awk <span class="string">'/^tcp/ &#123;n=split($(NF-1),array,":");if(n&lt;=2)++S[array[(1)]];else++S[array[(4)]];++s[$NF];++N&#125; END &#123;for(a in S)&#123;printf("%-20s %s\n", a, S[a]);++I&#125;printf("%-20s %s\n","TOTAL_IP",I);for(a in s) printf("%-20s %s\n",a, s[a]);printf("%-20s %s\n","TOTAL_LINK",N);&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å½“å‰tcp/ipé“¾æ¥æ•°æ’åå‰10çš„IP</span></span><br><span class="line">$ netstat -n|awk <span class="string">'/^tcp/ &#123;print $5&#125;'</span>|awk -F<span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨grepç»Ÿè®¡å½“å‰æ–‡ä»¶é‡Œé¢æ‰€æœ‰çš„IPåœ°å€</span></span><br><span class="line">$ grep -E -o <span class="string">"(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"</span> nginx_access.log</span><br></pre></td></tr></table></figure></li></ul><p>æŸ¥çœ‹ç³»ç»Ÿå½“å‰è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„æ•°ï¼ŒæŒ‰ç…§æœ€å¤§çš„è¿›è¡Œæ’åº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lsof -n | awk <span class="string">'&#123;print $2&#125;'</span> | sort | uniq -c | sort -nr | more</span><br></pre></td></tr></table></figure><ul><li>pingå‘½ä»¤æ˜¾ç¤ºæ—¶é—´ä»¥åŠæ—¥æœŸ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping www.sina.com.cn -i 3 | awk <span class="string">'&#123; print $0"\t" strftime("%Y-%m-%d %H:%M:%S",systime()) &#125; '</span> &gt; /opt/sina.log &amp;</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>iptables</title>
    <url>/2019/09/25/iptables/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="Iptables"><a href="#Iptables" class="headerlink" title="Iptables"></a>Iptables</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iptalbes æ˜¯ç”¨æ¥è®¾ç½®ã€ç»´æŠ¤å’Œæ£€æŸ¥Linuxå†…æ ¸çš„IPåŒ…è¿‡æ»¤è§„åˆ™çš„ã€‚å¯ä»¥å®šä¹‰ä¸åŒçš„è¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½åŒ…å«å‡ ä¸ªå†…éƒ¨çš„é“¾ï¼Œä¹Ÿèƒ½åŒ…å«ç”¨æˆ·å®šä¹‰çš„é“¾ã€‚æ¯ä¸ªé“¾éƒ½æ˜¯ä¸€ä¸ªè§„åˆ™åˆ—è¡¨ï¼Œå¯¹å¯¹åº”çš„åŒ…è¿›è¡ŒåŒ¹é…ï¼šæ¯æ¡è§„åˆ™æŒ‡å®šåº”å½“å¦‚ä½•å¤„ç†ä¸ä¹‹ç›¸åŒ¹é…çš„åŒ…ã€‚è¿™è¢«ç§°ä½œâ€™targetâ€™ï¼ˆç›®æ ‡ï¼‰ï¼Œä¹Ÿå¯ä»¥è·³å‘åŒä¸€ä¸ªè¡¨å†…çš„ç”¨æˆ·å®šä¹‰çš„é“¾ã€‚</p><a id="more"></a><h4 id="iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£"><a href="#iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£" class="headerlink" title="iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£"></a>iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£</h4><ul><li><p>å…è®¸æŸä¸ªIP ï¼ˆ192.168.6.100ï¼‰çš„æœºå™¨è¿›è¡ŒSSHè¿æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 192.168.6.100 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.100 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li><li><p>å…è®¸æŸä¸€æ®µçš„IP è®¿é—®SSH</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 192.168.6.0/24 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.0/24 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li><li><p>é™åˆ¶æŸä¸€IP è®¿é—®SSH</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp -s ! 192.168.6.100 --dport 22 -j ACCEPT --æ³¨æ„ï¼å·æœ‰ä¸ªç©ºæ ¼</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.0/24 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li></ul><h3 id="é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™"><a href="#é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™" class="headerlink" title="é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™"></a>é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™</h3><ul><li><p>é˜²æ­¢å¤–ç½‘ç”¨å†…ç½‘IPæ¬ºéª—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 10.0.0.0/8 -j DROP</span><br><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 172.16.0.0/12 -j DROP</span><br><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 192.168.0.0/16 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>ç¦æ­¢ä¸211.101.46.253çš„æ‰€æœ‰è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -d 211.101.46.253 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>ç¦ç”¨FTP(21)ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 21 -j DROP</span><br><span class="line"><span class="comment"># è¿™æ ·å†™èŒƒå›´å¤ªå¤§äº†,æˆ‘ä»¬å¯ä»¥æ›´ç²¾ç¡®çš„å®šä¹‰.</span></span><br><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 21 -d 211.101.46.253 -j DROP</span><br><span class="line"><span class="comment"># è¿™æ ·åªç¦ç”¨211.101.46.253åœ°å€çš„FTPè¿æ¥,å…¶ä»–è¿æ¥è¿˜å¯ä»¥.å¦‚web(80ç«¯å£)è¿æ¥.</span></span><br></pre></td></tr></table></figure></li><li><p>iptablesç™½åå•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 80 -j DROP</span><br><span class="line"><span class="comment"># æ‹’ç»æ‰€æœ‰IPé“¾æ¥80ç«¯å£</span></span><br><span class="line"></span><br><span class="line">$ iptables -A INPUT -s 58.17.245.222 -p tcp --dport 80 -j ACCEPT</span><br><span class="line"><span class="comment"># å…è®¸æŒ‡å®šIPè®¿é—®80ç«¯å£</span></span><br></pre></td></tr></table></figure></li><li><p>å…è®¸æ‰€æœ‰å·²ç»å»ºç«‹çš„å’Œç›¸å…³çš„è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p>dropéæ³•è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state INVALID -j DROP</span><br><span class="line">$ iptables -A OUTPUT -m state --state INVALID -j DROP</span><br><span class="line">$ iptables -A FORWARD -m state --state INVALID -j DROP</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç«¯å£æ˜ å°„"><a href="#ç«¯å£æ˜ å°„" class="headerlink" title="ç«¯å£æ˜ å°„"></a>ç«¯å£æ˜ å°„</h3><ul><li>è¿™é‡Œä½¿ç”¨çš„æ˜¯FTPæœåŠ¡(36542)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 36542 -j DNAT --to 192.168.50.2:36542</span><br><span class="line">$ iptables -t nat -A POSTROUTING -p tcp --dport 36542 -j MASQUERADE</span><br><span class="line"><span class="comment"># å› ä¸ºFTPä½¿ç”¨äº†ä¸¤ä¸ªç«¯å£21å’Œ20ï¼Œ21åªæ˜¯ç”¨äºè¿æ¥ï¼Œ20æ˜¯æ‰§è¡Œå‘½ä»¤çš„ã€‚20æ²¡åŠæ³•ä¿®æ”¹ï¼Œè¿™é‡Œä½¿ç”¨äº†è¢«åŠ¨æ¨¡å¼è¿æ¥ã€‚</span></span><br><span class="line"></span><br><span class="line">$ iptables -t nat -I PREROUTING -p tcp --dport 60000:65000 -j DNAT --to 192.168.50.2</span><br><span class="line"><span class="comment"># è¢«åŠ¨è¿æ¥ç«¯å£60000-65000å…¨éƒ¨è½¬å‘ç»™50.2</span></span><br><span class="line"></span><br><span class="line">$ iptables -t nat -I POSTROUTING -p tcp --dport 60000:65000 -j MASQUERADE</span><br><span class="line"><span class="comment"># éœ€è¦å¼€æ”¾60000:65000ç«¯å£ï¼Œ</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ç«¯å£è½¬å‘"><a href="#ç«¯å£è½¬å‘" class="headerlink" title="ç«¯å£è½¬å‘"></a>ç«¯å£è½¬å‘</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸æœ‰ä¸€å°æœåŠ¡å™¨è¿æ¥å¤–ç½‘ï¼Œå…¶ä»–çš„æœåŠ¡å™¨éƒ½ä¸èƒ½ä¸Šå¤–ç½‘ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå¤–ç½‘æœåŠ¡å™¨ç”¨ä½œç½‘å…³æœåŠ¡å™¨ï¼Œåšç«¯å£è½¬å‘ï¼Œè¿æ¥åˆ°å†…ç½‘æœåŠ¡å™¨</p><ul><li><p>è¿™é‡Œä½¿ç”¨æ•°æ®åº“çš„3306æ˜ å°„åˆ°å¤–ç½‘çš„çš„36544</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING  -m tcp -p tcp --dport 36544 -j DNAT --to-destination 172.16.1.11:3306</span><br><span class="line">$ iptables -t nat -A POSTROUTING -m tcp -p tcp --dport 3306 -d 172.16.1.11 -j SNAT --to-source 172.16.1.1</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ è¿ç»­ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp --dport 60000:65000 -j ACCEPT</span><br><span class="line"><span class="comment"># å†’å·è¡¨ç¤ºæ·»åŠ ä¸€ä¸ªè¿ç»­çš„ç«¯å£</span></span><br><span class="line"></span><br><span class="line">$ iptables -A INPUT -p tcp -m multiport â€“dport 21:25,135:139 -j DROP</span><br><span class="line"><span class="comment">#ä½¿ç”¨multiportå‚æ•°é…ç½®ä¸è¿ç»­ç«¯å£å’Œå¤šä¸ªç«¯å£</span></span><br></pre></td></tr></table></figure></li><li><p>ä»£ç†ä¸Šç½‘<br>å†…ç½‘æœºå­æ— æ³•ä¸Šç½‘ï¼Œé€šè¿‡ä¸€å°å¯ä»¥ä¸Šç½‘çš„ç”µè„‘ï¼Œåœ¨å¯ä»¥è®¿é—®å¤–ç½‘çš„serverä¸Šiptablesè®©å…¶ä¸€ä¸ªç½‘æ®µå†…çš„æœºå­è®¿é—®å¤–ç½‘ï¼Œè¿™é‡Œæ˜¯é˜¿é‡Œäº‘ç¯å¢ƒæ¥åšçš„ï¼Œå¼€å¯IPè½¬å‘åŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sed -i <span class="string">'s/net.ipv4.ip_forward = 0/net.ipv4.ip_forward = 1/g'</span> /etc/sysctl.conf</span><br><span class="line">$ iptables -t nat -I POSTROUTING -s 172.16.3.0/24 -j SNAT --to-source 172.16.3.2</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ“ä½œiptablesçš„natè§„åˆ™"><a href="#æ“ä½œiptablesçš„natè§„åˆ™" class="headerlink" title="æ“ä½œiptablesçš„natè§„åˆ™"></a>æ“ä½œiptablesçš„natè§„åˆ™</h4><ul><li><p>æŸ¥çœ‹è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -nvL -t nat</span><br><span class="line">$ iptables -t nat -L -n --line-numbers</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -D POSTROUTING 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptablesçš„è§„åˆ™å·</span></span><br><span class="line">$ iptables -nL --line-number</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹/æ›¿æ¢è§„åˆ™</span></span><br><span class="line">$ iptbales -R INPUT &#123;1&#125; -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è§„åˆ™</span></span><br><span class="line">$ iptables -D INPUT &#123;1&#125;</span><br></pre></td></tr></table></figure></li><li><p>iptalesç«¯å£é€šè¿‡ä¸€å¼ ç½‘å¡å‡ºå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLESHED -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p>æœ¬æœºç«¯å£ï¼Œæ˜ å°„åˆ°æœ¬æœºç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 25 -j REDIRECT --to-port 2525</span><br><span class="line">$ iptables -t nat -I PREROUTING --src 0/0 --dst 192.168.1.5 -p tcp --dport 80 -j REDIRECT --to-ports 8123</span><br><span class="line">$ iptables -t nat -I OUTPUT --src 0/0 --dst 192.168.1.5 -p tcp --dport 80 -j REDIRECT --to-ports 8123</span><br></pre></td></tr></table></figure></li><li><p>ä¿å­˜é˜²ç«å¢™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo /usr/libexec/iptables/iptables.init save</span><br></pre></td></tr></table></figure></li><li><p>å¥‡è‘©éœ€æ±‚ï¼Œå¼€æ”¾sshç«¯å£æŒ‡å®šçš„IPåœ°å€è®¿é—®ï¼Œå…¶ä»–ç«¯å£å¤ªå¤šä¸æƒ³æ·»åŠ èƒ½å¯¹å¤–è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"><span class="comment"># sample configuration for iptables service</span></span><br><span class="line"><span class="comment"># you can edit this manually or use system-config-firewall</span></span><br><span class="line"><span class="comment"># please do not ask us to add additional ports/services to this default configuration</span></span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT -s 192.168.10.1/32 -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m tcp --dport 22 -j  REJECT --reject-with icmp-port-unreachable</span><br><span class="line"><span class="comment">#-A INPUT -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line"><span class="comment">#-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>iptables</tag>
      </tags>
  </entry>
  <entry>
    <title>äº¤æ¢æœºåšç«¯å£èšåˆ</title>
    <url>/2019/09/25/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%81%9A%E7%AB%AF%E5%8F%A3%E8%81%9A%E5%90%88/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šh3c s5500 (Switch A)ã€‚huawei s5720S-SI-ACï¼ˆSwitch Bï¼‰</p><p>Switch A ä½œä¸ºä¸Šè¡Œäº¤æ¢æœºï¼ŒSwitch Bä½œä¸ºä¸‹è¡Œäº¤æ¢æœº</p><p><strong>ç»„ç½‘</strong>ï¼šä¸¤ä¸ªäº¤æ¢æœºçš„idã€vlanå·è¿™é‡Œä½¿ç”¨çš„æ˜¯ç›¸åŒ</p><a id="more"></a><p><img src="https://img.xxlaila.cn/2846sjdhausiy84yhks.png" alt="img"></p><h3 id="Switch-Aé…ç½®"><a href="#Switch-Aé…ç½®" class="headerlink" title="Switch Aé…ç½®"></a>Switch Aé…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]vlan 50</span><br><span class="line">[Switch A-SW-vlan50]quit</span><br><span class="line">[Switch A-SW]interface Bridge-Aggregation 50</span><br><span class="line">[Switch A-SW-Bridge-Aggregation50]port access vlan 50</span><br><span class="line">[Switch A-SW]interface GigabitEthernet 1/0/19</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/19]port link-aggregation group 50</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/19] port access vlan 50</span><br><span class="line">[Switch A-SW]interface GigabitEthernet 1/0/20</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/20]port link-aggregation group 50</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/20]port access vlan 50</span><br><span class="line">[Switch A-SW]link-aggregation load-sharing mode <span class="built_in">source</span>-mac destination-mac</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ç«¯å£èšåˆ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]dis link-aggregation verbose</span><br></pre></td></tr></table></figure></li></ul><h3 id="Switch-Bé…ç½®"><a href="#Switch-Bé…ç½®" class="headerlink" title="Switch Bé…ç½®"></a>Switch Bé…ç½®</h3><h4 id="1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜"><a href="#1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜" class="headerlink" title="1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜"></a>1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] interface eth-trunk 50</span><br><span class="line">[Switch B-Eth-Trunk1] trunkport gigabitethernet 0/0/1 to 0/0/3</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h4 id="2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan"><a href="#2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan" class="headerlink" title="2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan"></a>2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] vlan batch 50</span><br><span class="line">[Switch B] interface eth-trunk 50</span><br><span class="line">[Switch B-Eth-Trunk1] port link-type trunk</span><br><span class="line">[Switch B-Eth-Trunk1] port trunk allow-pass vlan 50</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h4 id="3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼"><a href="#3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼" class="headerlink" title="3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼"></a>3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] interface eth-trunk 1</span><br><span class="line">[Switch B-Eth-Trunk1] load-balance src-dst-mac</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h3 id="Switch-Aé…ç½®åœ°å€æ®µ"><a href="#Switch-Aé…ç½®åœ°å€æ®µ" class="headerlink" title="Switch Aé…ç½®åœ°å€æ®µ"></a>Switch Aé…ç½®åœ°å€æ®µ</h3><p>åœ¨vlané‡Œé¢èµ·ä¸€ä¸ªç½‘ç»œï¼Œä½†ä¸å¯ç”¨dhcpæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]int vlan 50</span><br><span class="line">[Switch A-SW-Vlan-interface50]ip ad 172.21.16.1 20</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>äº¤æ¢æœº</tag>
      </tags>
  </entry>
  <entry>
    <title>pv pvc</title>
    <url>/2019/09/25/pv-pvc/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="1ã€ä»‹ç»"><a href="#1ã€ä»‹ç»" class="headerlink" title="1ã€ä»‹ç»"></a>1ã€ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PersistentVolumeï¼ˆpvï¼‰å’ŒPersistentVolumeClaimï¼ˆpvcï¼‰æ˜¯k8sæä¾›çš„ä¸¤ç§APIèµ„æºï¼Œç”¨äºæŠ½è±¡å­˜å‚¨ç»†èŠ‚ã€‚ç®¡ç†å‘˜å…³æ³¨äºå¦‚ä½•é€šè¿‡pvæä¾›å­˜å‚¨åŠŸèƒ½è€Œæ— éœ€å…³æ³¨ç”¨æˆ·å¦‚ä½•ä½¿ç”¨ï¼ŒåŒæ ·çš„ç”¨æˆ·åªéœ€è¦æŒ‚è½½pvcåˆ°å®¹å™¨ä¸­è€Œä¸éœ€è¦å…³æ³¨å­˜å‚¨å·é‡‡ç”¨ä½•ç§æŠ€æœ¯å®ç°ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pvcå’Œpvçš„å…³ç³»ä¸podå’Œnodeå…³ç³»ç±»ä¼¼ï¼Œå‰è€…æ¶ˆè€—åè€…çš„èµ„æºã€‚pvcå¯ä»¥å‘pvç”³è¯·æŒ‡å®šå¤§å°çš„å­˜å‚¨èµ„æºå¹¶è®¾ç½®è®¿é—®æ¨¡å¼,è¿™å°±å¯ä»¥é€šè¿‡Provision -&gt; Claim çš„æ–¹å¼ï¼Œæ¥å¯¹å­˜å‚¨èµ„æºè¿›è¡Œæ§åˆ¶ã€‚</p><a id="more"></a><h3 id="2ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#2ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2ã€ç”Ÿå‘½å‘¨æœŸ"></a>2ã€ç”Ÿå‘½å‘¨æœŸ</h3><p>pvå’Œpvcéµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸ:</p><ul><li>ä¾›åº”å‡†å¤‡ã€‚é€šè¿‡é›†ç¾¤å¤–çš„å­˜å‚¨ç³»ç»Ÿæˆ–è€…äº‘å¹³å°æ¥æä¾›å­˜å‚¨æŒä¹…åŒ–æ”¯æŒã€‚<ul><li><strong>é™æ€æä¾›</strong>: ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¤šä¸ªPVï¼Œä¾›PVCä½¿ç”¨ã€‚</li><li><strong>åŠ¨æ€æä¾›</strong>: åŠ¨æ€åˆ›å»ºPVCç‰¹å®šçš„PVï¼Œå¹¶ç»‘å®šã€‚</li></ul></li><li>ç»‘å®šã€‚ç”¨æˆ·åˆ›å»ºpvcå¹¶æŒ‡å®šéœ€è¦çš„èµ„æºå’Œè®¿é—®æ¨¡å¼ã€‚åœ¨æ‰¾åˆ°å¯ç”¨pvä¹‹å‰ï¼Œpvcä¼šä¿æŒæœªç»‘å®šçŠ¶æ€ã€‚</li><li>ä½¿ç”¨ã€‚ç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvcã€‚</li><li>é‡Šæ”¾ã€‚ç”¨æˆ·åˆ é™¤pvcæ¥å›æ”¶å­˜å‚¨èµ„æºï¼Œpvå°†å˜æˆâ€œreleasedâ€çŠ¶æ€ã€‚ç”±äºè¿˜ä¿ç•™ç€ä¹‹å‰çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†ï¼Œå¦åˆ™è¿™äº›å­˜å‚¨èµ„æºæ— æ³•è¢«å…¶ä»–pvcä½¿ç”¨ã€‚</li><li>å›æ”¶(Reclaiming)ã€‚pvå¯ä»¥è®¾ç½®ä¸‰ç§å›æ”¶ç­–ç•¥ï¼šä¿ç•™ï¼ˆRetainï¼‰ï¼Œå›æ”¶ï¼ˆRecycleï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</li></ul><ul><li><strong>ä¿ç•™ç­–ç•¥</strong>: å…è®¸äººå·¥å¤„ç†ä¿ç•™çš„æ•°æ®ã€‚</li><li><strong>åˆ é™¤ç­–ç•¥</strong>: å°†åˆ é™¤pvå’Œå¤–éƒ¨å…³è”çš„å­˜å‚¨èµ„æºï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</li><li><strong>å›æ”¶ç­–ç•¥</strong>: å°†æ‰§è¡Œæ¸…é™¤æ“ä½œï¼Œä¹‹åå¯ä»¥è¢«æ–°çš„pvcä½¿ç”¨ï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›®å‰åªæœ‰NFSå’ŒHostPathç±»å‹å·æ”¯æŒå›æ”¶ç­–ç•¥ï¼ŒAWS EBS,GCE PD,Azure Diskå’ŒCinderæ”¯æŒåˆ é™¤(Delete)ç­–ç•¥ã€‚</p><h4 id="2-1ã€Provisioning"><a href="#2-1ã€Provisioning" class="headerlink" title="2.1ã€Provisioning"></a>2.1ã€Provisioning</h4><p>ä¸¤ç§æ–¹å¼æä¾›çš„PVèµ„æºä¾›ç»™ï¼š</p><ul><li><p>static:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡é›†ç¾¤ç®¡ç†è€…åˆ›å»ºå¤šä¸ªPVï¼Œä¸ºé›†ç¾¤â€œä½¿ç”¨è€…â€æä¾›å­˜å‚¨èƒ½åŠ›è€Œéšè—çœŸå®å­˜å‚¨çš„ç»†èŠ‚ã€‚å¹¶ä¸”å­˜åœ¨äºkubenretes apiä¸­ï¼Œå¯è¢«ç›´æ¥ä½¿ç”¨ã€‚</p></li><li><p>dynamic:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ¨æ€å·ä¾›ç»™æ˜¯kubernetesç‹¬æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¸€åŠŸèƒ½å…è®¸æŒ‰éœ€åˆ›å»ºå­˜å‚¨å»ºã€‚åœ¨æ­¤ä¹‹å‰ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦äº‹å…ˆåœ¨é›†ç¾¤å¤–ç”±å­˜å‚¨æä¾›è€…æˆ–è€…äº‘æä¾›å•†åˆ›å»º<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å­˜å‚¨å·ï¼ŒæˆåŠŸä¹‹åå†åˆ›å»ºPersistentVolumeå¯¹è±¡ï¼Œæ‰èƒ½å¤Ÿåœ¨kubernetesä¸­ä½¿ç”¨ã€‚åŠ¨æ€å·ä¾›ç»™èƒ½è®©é›†ç¾¤ç®¡ç†å‘˜ä¸å¿…è¿›è¡Œé¢„å…ˆåˆ›å»ºå­˜å‚¨å·ï¼Œè€Œæ˜¯éšç€ç”¨æˆ·éœ€æ±‚è¿›è¡Œåˆ›å»ºã€‚åœ¨1.5ç‰ˆæœ¬æé«˜äº†åŠ¨æ€å·çš„å¼¹æ€§å’Œå¯ç”¨æ€§ã€‚</p></li></ul><h3 id="PVç±»å‹"><a href="#PVç±»å‹" class="headerlink" title="PVç±»å‹"></a>PVç±»å‹</h3><p>pvæ”¯æŒä»¥ä¸‹ç±»å‹:</p><ul><li>GCEPersistentDisk</li><li>AWSElasticBlockStore</li><li>NFS</li><li>iSCSI</li><li>RBD (Ceph Block Device)</li><li>Glusterfs</li><li>AzureFile</li><li>AzureDisk</li><li>CephFS</li><li>cinder</li><li>FC</li><li>FlexVolume</li><li>Flocker</li><li>PhotonPersistentDisk</li><li>Quobyte</li><li>VsphereVolume</li><li>HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</li></ul><h4 id="3-1ã€PVå±æ€§"><a href="#3-1ã€PVå±æ€§" class="headerlink" title="3.1ã€PVå±æ€§"></a>3.1ã€PVå±æ€§</h4><ul><li>è®¿é—®æ¨¡å¼,ä¸pvçš„è¯­ä¹‰ç›¸åŒã€‚åœ¨è¯·æ±‚èµ„æºæ—¶ä½¿ç”¨ç‰¹å®šæ¨¡å¼ã€‚</li><li>èµ„æº,ç”³è¯·çš„å­˜å‚¨èµ„æºæ•°é¢ã€‚</li></ul><h4 id="3-2ã€PVå·é˜¶æ®µçŠ¶æ€"><a href="#3-2ã€PVå·é˜¶æ®µçŠ¶æ€" class="headerlink" title="3.2ã€PVå·é˜¶æ®µçŠ¶æ€"></a>3.2ã€PVå·é˜¶æ®µçŠ¶æ€</h4><ul><li>Available â€“ èµ„æºå°šæœªè¢«claimä½¿ç”¨</li><li>Bound â€“ å·å·²ç»è¢«ç»‘å®šåˆ°claimäº†</li><li>Released â€“ claimè¢«åˆ é™¤ï¼Œå·å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æœªè¢«é›†ç¾¤å›æ”¶ã€‚</li><li>Failed â€“ å·è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pv, pvc</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ©ç”¨NFSåŠ¨æ€æä¾›Kubernetesåç«¯å­˜å‚¨å·</title>
    <url>/2019/09/24/%E5%88%A9%E7%94%A8NFS%E5%8A%A8%E6%80%81%E6%8F%90%E4%BE%9BKubernetes%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8%E5%8D%B7/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nfs-client-provisioneræ˜¯ä¸€ä¸ªautomatic provisionerï¼Œä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œè‡ªåŠ¨åˆ›å»ºPVå’Œå¯¹åº”çš„PVCï¼Œæœ¬èº«ä¸æä¾›NFSå­˜å‚¨ï¼Œéœ€è¦å¤–éƒ¨å…ˆæœ‰ä¸€å¥—NFSå­˜å‚¨æœåŠ¡ã€‚</p><ul><li>PVä»¥ ${namespace}-${pvcName}-${pvName}çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">å®˜æ–¹è®¿é—®åœ°å€</a></p><a id="more"></a><h3 id="1ã€æƒé™ä½“ç³»æ„å»º"><a href="#1ã€æƒé™ä½“ç³»æ„å»º" class="headerlink" title="1ã€æƒé™ä½“ç³»æ„å»º"></a>1ã€æƒé™ä½“ç³»æ„å»º</h3><h4 id="1-1ã€åˆ›å»ºserviceaccount"><a href="#1-1ã€åˆ›å»ºserviceaccount" class="headerlink" title="1.1ã€åˆ›å»ºserviceaccount"></a>1.1ã€åˆ›å»ºserviceaccount</h4><p>ServiceAccountä¹Ÿæ˜¯ä¸€ç§è´¦å·, ä¾›è¿è¡Œåœ¨podä¸­çš„è¿›ç¨‹ä½¿ç”¨, ä¸ºpodä¸­çš„è¿›ç¨‹æä¾›å¿…è¦çš„èº«ä»½è¯æ˜</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; serviceaccount.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-2ã€åˆ›å»ºrole"><a href="#1-2ã€åˆ›å»ºrole" class="headerlink" title="1.2ã€åˆ›å»ºrole"></a>1.2ã€åˆ›å»ºrole</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt;clusterrole.yaml&lt;&lt;EOF</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    resources: [<span class="string">"storageclasses"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"events"</span>]</span><br><span class="line">    verbs: [<span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services"</span>, <span class="string">"endpoints"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>,<span class="string">"list"</span>, <span class="string">"watch"</span>,<span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"podsecuritypolicies"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"nfs-client-provisioner"</span>]</span><br><span class="line">    verbs: [<span class="string">"use"</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"><a href="#1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š" class="headerlink" title="1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"></a>1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt;clusterrolebinding.yaml &lt;&lt;EOF</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: kube-ops</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-4ã€æ‰§è¡Œåˆ›å»º"><a href="#1-4ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="1.4ã€æ‰§è¡Œåˆ›å»º"></a>1.4ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f serviceaccount.yaml -f clusterrole.yaml -f clusterrolebinding.yaml</span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span><br></pre></td></tr></table></figure><h3 id="2ã€å®‰è£…éƒ¨ç½²"><a href="#2ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="2ã€å®‰è£…éƒ¨ç½²"></a>2ã€å®‰è£…éƒ¨ç½²</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹è½½deployment.yamlæ–‡ä»¶,éœ€è¦ä¿®æ”¹NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ10.10.10.60ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/ifs/kubernetesï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><h4 id="2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"><a href="#2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·" class="headerlink" title="2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"></a>2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·</h4><p>æ ¹æ®PVCçš„è¯·æ±‚, åŠ¨æ€åˆ›å»ºPVå­˜å‚¨.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: quay.io/external_storage/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.21.17.39</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /opt</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: /opt</span><br><span class="line">            path: 172.21.17.39</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²class.yaml</li></ul><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´</p><h4 id="2-2ã€åˆ›å»ºstorageclass"><a href="#2-2ã€åˆ›å»ºstorageclass" class="headerlink" title="2.2ã€åˆ›å»ºstorageclass"></a>2.2ã€åˆ›å»ºstorageclass</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; class.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-3ã€æ‰§è¡Œåˆ›å»º"><a href="#2-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="2.3ã€æ‰§è¡Œåˆ›å»º"></a>2.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f deployment.yaml </span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">deployment.extensions/nfs-client-provisioner created</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f class.yaml </span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage created</span><br></pre></td></tr></table></figure><h5 id="2-3-1ã€æŸ¥çœ‹StorageClass"><a href="#2-3-1ã€æŸ¥çœ‹StorageClass" class="headerlink" title="2.3.1ã€æŸ¥çœ‹StorageClass"></a>2.3.1ã€æŸ¥çœ‹StorageClass</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get storageclass</span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   18s</span><br></pre></td></tr></table></figure><h5 id="2-3-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"><a href="#2-3-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨" class="headerlink" title="2.3.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"></a>2.3.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨</h5><p>è®¾ç½®è¿™ä¸ªdefaultåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl patch storageclass managed-nfs-storage -p <span class="string">'&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage patched</span><br></pre></td></tr></table></figure><ul><li>storage.yaml (å’Œä¸Šé¢ä¸€æ ·)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; storage.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">  annotations:</span><br><span class="line">    storageclass.kubernetes.io/is-default-class: <span class="string">"true"</span></span><br><span class="line">provisioner: fuseim.pri/ifs</span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-3-3ã€æŸ¥çœ‹éªŒè¯"><a href="#2-3-3ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="2.3.3ã€æŸ¥çœ‹éªŒè¯"></a>2.3.3ã€æŸ¥çœ‹éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get all -n kube-ops</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-77f678858b-8d2d6   1/1     Running   0          26m</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nfs-client-provisioner   1/1     1            1           29m</span><br><span class="line"></span><br><span class="line">NAME                                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nfs-client-provisioner-77f678858b   1         1         1       26m</span><br></pre></td></tr></table></figure><h3 id="3ã€éªŒè¯æµ‹è¯•"><a href="#3ã€éªŒè¯æµ‹è¯•" class="headerlink" title="3ã€éªŒè¯æµ‹è¯•"></a>3ã€éªŒè¯æµ‹è¯•</h3><h4 id="3-1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨"><a href="#3-1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨" class="headerlink" title="3.1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨"></a>3.1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; <span class="built_in">test</span>-claim.yaml &lt;&lt;EOF</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-claim</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2ã€å¯åŠ¨æµ‹è¯•POD"><a href="#3-2ã€å¯åŠ¨æµ‹è¯•POD" class="headerlink" title="3.2ã€å¯åŠ¨æµ‹è¯•POD"></a>3.2ã€å¯åŠ¨æµ‹è¯•POD</h4><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat  &gt; <span class="built_in">test</span>-pod.yaml &lt;&lt;EOF</span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-pod</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: <span class="built_in">test</span>-pod</span><br><span class="line">    image: docker.io/busybox:1.24</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"/bin/sh"</span></span><br><span class="line">    args:</span><br><span class="line">      - <span class="string">"-c"</span></span><br><span class="line">      - <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        mountPath: <span class="string">"/mnt"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: <span class="built_in">test</span>-claim</span><br></pre></td></tr></table></figure><h4 id="3-3ã€æ‰§è¡Œåˆ›å»º"><a href="#3-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="3.3ã€æ‰§è¡Œåˆ›å»º"></a>3.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f ./</span><br><span class="line">persistentvolumeclaim/<span class="built_in">test</span>-claim created</span><br><span class="line">pod/<span class="built_in">test</span>-pod created</span><br></pre></td></tr></table></figure><h4 id="3-4ã€æŸ¥çœ‹éªŒè¯"><a href="#3-4ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="3.4ã€æŸ¥çœ‹éªŒè¯"></a>3.4ã€æŸ¥çœ‹éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod,pv -n kube-ops</span><br><span class="line">NAME                                          READY   STATUS      RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-77f678858b-8d2d6   1/1     Running     0          3h26m</span><br><span class="line">pod/<span class="built_in">test</span>-pod                                  0/1     Completed   0          172m</span><br><span class="line"></span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">persistentvolume/pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Retain           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            172m</span><br></pre></td></tr></table></figure><ul><li>ç™»å½•nfsæœåŠ¡å™¨æŸ¥çœ‹æ˜¯å¦æˆåŠŸçš„åˆ›å»ºç›®å½•<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /opt/</span><br><span class="line">kube-ops-test-claim-pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-5ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"><a href="#3-5ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥" class="headerlink" title="3.5ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"></a>3.5ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥</h4><ul><li><p>æŸ¥çœ‹é›†ç¾¤ä¸­PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pv -n kube-ops</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Delete           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            3m6s</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl patch pv pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8  -p <span class="string">'&#123;"spec":&#123;"persistentVolumeReclaimPolicy":"Retain"&#125;&#125;'</span></span><br><span class="line">persistentvolume/pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8 patched</span><br><span class="line"></span><br><span class="line">$ kubectl get pv -n kube-ops</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Retain           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            3m54s</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pvc,pv</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 prometheus</title>
    <url>/2019/09/20/k8s-v1-14-prometheus/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h1 id="Prometheusã€Grafana-éƒ¨ç½²"><a href="#Prometheusã€Grafana-éƒ¨ç½²" class="headerlink" title="Prometheusã€Grafana éƒ¨ç½²"></a>Prometheusã€Grafana éƒ¨ç½²</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Grafanaæ˜¯ä¸€ä¸ªå¼€æºçš„åº¦é‡åˆ†æä¸å¯è§†åŒ–å¥—ä»¶ã€‚ç»å¸¸è¢«ç”¨ä½œåŸºç¡€è®¾æ–½çš„æ—¶é—´åºåˆ—æ•°æ®å’Œåº”ç”¨ç¨‹åºåˆ†æçš„å¯è§†åŒ–ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨å®ƒæ¥åšKubernetesé›†ç¾¤ç›‘æ§æ•°æ®çš„å¯è§†åŒ–ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆªè‡³å½“å‰ï¼Œprometheusã€grafanaå‡é‡‡ç”¨æœ€æ–°çš„é•œåƒåŒ…ï¼Œåœ¨åœ¨ç¬¬ä¸€æ¬¡éƒ¨ç½²çš„æ—¶å€™grafanaæŠ¥äº†ä¸€ä¸ªé”™è¯¯<code>mkdir: cannot create directory &#39;/var/lib/grafana/plugins&#39;: No such file or directory</code>,è¿™æ˜¯å› ä¸ºGrafanaå¯åŠ¨ä½¿ç”¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„éƒ½æ˜¯472ï¼Œé€ æˆå¯¹å¤–æŒ‚å­˜å‚¨æ²¡æœ‰æƒé™ã€‚<a href="https://grafana.com/docs/installation/docker/#migration-from-a-previous-version-of-the-docker-container-to-5-1-or-later" target="_blank" rel="noopener">å‚è€ƒå®˜æ–¹</a></p><a id="more"></a><h3 id="å¼€å§‹éƒ¨ç½²"><a href="#å¼€å§‹éƒ¨ç½²" class="headerlink" title="å¼€å§‹éƒ¨ç½²"></a>å¼€å§‹éƒ¨ç½²</h3><p>æ–°å»ºyamlæ–‡ä»¶</p><ul><li>monitor-namespace.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat  monitor-namespace.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring</span><br></pre></td></tr></table></figure></li></ul><p>å…¶ä»–çš„æ–‡ä»¶å‡é‡‡ç”¨ä»¥å‰å†å²çš„ï¼Œç„¶åç¨åŠ ä¿®æ”¹ï¼Œå…¶ä»–<a href="https://github.com/xxlaila/kubernetes-yaml.git" target="_blank" rel="noopener">yaml</a>æ–‡ä»¶,ç§»é™¤<code>grafana-ingress.yaml</code>ã€<code>prometheus-ingress.yaml</code></p><h3 id="æ–‡ä»¶ä¿®æ”¹"><a href="#æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="æ–‡ä»¶ä¿®æ”¹"></a>æ–‡ä»¶ä¿®æ”¹</h3><ul><li><p>grafana-deploy.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-core</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: grafana</span><br><span class="line">        component: core</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: grafana/grafana:latest</span><br><span class="line">        name: grafana-core</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment"># env:</span></span><br><span class="line">        resources:</span><br><span class="line">          <span class="comment"># keep request = limit to keep this container in guaranteed class</span></span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        env:</span><br><span class="line">          <span class="comment"># The following env variables set up basic auth twith the default admin user and admin password.</span></span><br><span class="line">          - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">            value: <span class="string">"true"</span></span><br><span class="line">          - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">            value: <span class="string">"false"</span></span><br><span class="line">          <span class="comment"># - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span></span><br><span class="line">          <span class="comment">#   value: Admin</span></span><br><span class="line">          <span class="comment"># does not really work, because of template variables in exported dashboards:</span></span><br><span class="line">          <span class="comment"># - name: GF_DASHBOARDS_JSON_ENABLED</span></span><br><span class="line">          <span class="comment">#   value: "true"</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 3000</span><br><span class="line">          <span class="comment"># initialDelaySeconds: 30</span></span><br><span class="line">          <span class="comment"># timeoutSeconds: 1</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: grafana-persistent-storage</span><br><span class="line">          mountPath: /var/lib/grafana</span><br><span class="line">      volumes:</span><br><span class="line">      - name: grafana-persistent-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>prometheus-deploy.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/prometheus:latest</span><br><span class="line">        name: prometheus</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - <span class="string">"/bin/prometheus"</span></span><br></pre></td></tr></table></figure></li><li><p>prometheus-svc.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    targetPort: 9090</span><br><span class="line">    <span class="comment">#nodePort: 30005</span></span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br></pre></td></tr></table></figure></li><li><p>grafana-svc.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line">  ports:</span><br><span class="line">    - port: 3000</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šæ‰§è¡Œå‡ æ¬¡</span></span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deploy -n monitoring</span></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/grafana-core-7b5989cf9d-snbk5   1/1     Running   0          2m31s</span><br><span class="line">pod/node-exporter-dddv7             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-fhfp6             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-m46bf             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-xkrzp             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-zfcxh             1/1     Running   0          12m</span><br><span class="line">pod/prometheus-67bcf457db-999ns     1/1     Running   0          12m</span><br><span class="line"></span><br><span class="line">NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/grafana         ClusterIP   10.254.95.151    &lt;none&gt;        3000/TCP         12m</span><br><span class="line">service/node-exporter   ClusterIP   10.254.114.12    &lt;none&gt;        9100/TCP         12m</span><br><span class="line">service/prometheus      ClusterIP   10.254.104.216   &lt;none&gt;        9090/TCP         12m</span><br><span class="line"></span><br><span class="line">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.extensions/grafana-core   1/1     1            1           12m</span><br><span class="line">deployment.extensions/prometheus     1/1     1            1           12m</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºIngress"><a href="#åˆ›å»ºIngress" class="headerlink" title="åˆ›å»ºIngress"></a>åˆ›å»ºIngress</h3><h4 id="prometheus-Ingress"><a href="#prometheus-Ingress" class="headerlink" title="prometheus Ingress"></a>prometheus Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat prometheus-Ingress.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-web-ui</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br></pre></td></tr></table></figure><h4 id="grafana-Ingress"><a href="#grafana-Ingress" class="headerlink" title="grafana Ingress"></a>grafana Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana-Ingress.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-web-ui</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br></pre></td></tr></table></figure><h4 id="æ‰§è¡Œåˆ›å»º-1"><a href="#æ‰§è¡Œåˆ›å»º-1" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f prometheus-Ingress.yaml </span></span><br><span class="line">ingress.extensions/prometheus-web-ui created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f grafana-Ingress.yaml </span></span><br><span class="line">ingress.extensions/grafana-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨è¾“å…¥prometheus.xxlaila.cnè®¿é—®prometheusï¼Œè¾“å…¥grafana.xxlaila.cnè®¿é—®grafanaã€‚</p><h3 id="è®¿é—®prometheus"><a href="#è®¿é—®prometheus" class="headerlink" title="è®¿é—®prometheus"></a>è®¿é—®prometheus</h3><p><img src="https://img.xxlaila.cn/1569218750254.jpg" alt="img"></p><h3 id="é…ç½®grafana"><a href="#é…ç½®grafana" class="headerlink" title="é…ç½®grafana"></a>é…ç½®grafana</h3><p><img src="https://img.xxlaila.cn/1568968344227.jpg" alt="img"></p><p>åˆ°grafanaçš„å®˜æ–¹ä¸‹è½½å¯¹åº”çš„æ¨¡ç‰ˆæ–‡ä»¶å¯¼å…¥ï¼Œå°±å¯ä»¥å‡ºå›¾å•¦<br><img src="https://img.xxlaila.cn/1568968420655.jpg" alt="img"></p><p><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/prometheus" target="_blank" rel="noopener">åç»­åˆ©ç”¨pvc</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14,prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 weave-scope</title>
    <url>/2019/09/20/k8s-v1-14-weave-scope/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="å‰æ²¿"><a href="#å‰æ²¿" class="headerlink" title="å‰æ²¿"></a>å‰æ²¿</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes é›†ç¾¤å¹¶éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨åªæ˜¯ç¬¬ä¸€æ­¥ã€‚ä¸€æ—¦é›†ç¾¤è¿è¡Œèµ·æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ä¸€èµ·æ­£å¸¸ï¼Œæ‰€æœ‰å¿…è¦ç»„ä»¶å°±ä½å¹¶å„å¸å…¶èŒï¼Œæœ‰è¶³å¤Ÿçš„èµ„æºæ»¡è¶³åº”ç”¨çš„éœ€æ±‚ã€‚Kubernetes æ˜¯ä¸€ä¸ªå¤æ‚ç³»ç»Ÿï¼Œè¿ç»´å›¢é˜Ÿéœ€è¦æœ‰ä¸€å¥—å·¥å…·å¸®åŠ©ä»–ä»¬è·çŸ¥é›†ç¾¤çš„å®æ—¶çŠ¶æ€ï¼Œå¹¶ä¸ºæ•…éšœæ’æŸ¥æä¾›åŠæ—¶å’Œå‡†ç¡®çš„æ•°æ®æ”¯æŒã€‚</p><h3 id="weave-scope-ä»‹ç»"><a href="#weave-scope-ä»‹ç»" class="headerlink" title="weave scope ä»‹ç»"></a>weave scope ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Weave Scopeæ˜¯Dockerå’ŒKubernetesçš„å¯è§†åŒ–å’Œç›‘æ§å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€ä¸ªè‡ªä¸Šè€Œä¸‹çš„åº”ç”¨ç¨‹åºä»¥åŠæ•´ä¸ªåŸºç¡€æ¶æ„è§†å›¾ï¼Œå¹¶å…è®¸æ‚¨åœ¨éƒ¨ç½²åˆ°äº‘æä¾›å•†æ—¶å®æ—¶è¯Šæ–­åˆ†å¸ƒå¼å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ä»»ä½•é—®é¢˜ã€‚</p><a id="more"></a><h3 id="åŠŸèƒ½ä»‹ç»"><a href="#åŠŸèƒ½ä»‹ç»" class="headerlink" title="åŠŸèƒ½ä»‹ç»"></a>åŠŸèƒ½ä»‹ç»</h3><ul><li>podæ‹“æ‰‘æ˜ å°„</li><li>å›¾å½¢æˆ–è¡¨æ ¼æ¨¡å¼</li><li>çµæ´»è¿‡æ»¤</li><li>å¼ºå¤§çš„æœç´¢åŠŸèƒ½</li><li>å®æ—¶åº”ç”¨å’Œå®¹å™¨æŒ‡æ ‡</li><li>æ’é™¤æ•…éšœå¹¶ç®¡ç†å®¹å™¨</li><li>ä½¿ç”¨Plugin APIç”Ÿæˆè‡ªå®šä¹‰æŒ‡æ ‡</li></ul><p><a href="https://www.weave.works/docs/scope/latest/features/" target="_blank" rel="noopener">ä»‹ç»å‚è€ƒ</a></p><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>åœ¨ K8s é›†ç¾¤ä¸­å®‰è£… Scope çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f "https://cloud.weave.works/k8s/scope.yaml?k8s-version=$(kubectl version | base64 | tr -d '\n')"</span></span><br><span class="line">namespace/weave created</span><br><span class="line">serviceaccount/weave-scope created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">deployment.apps/weave-scope-app created</span><br><span class="line">service/weave-scope-app created</span><br><span class="line">deployment.apps/weave-scope-cluster-agent created</span><br><span class="line">daemonset.extensions/weave-scope-agent created</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥"><a href="#æ£€æŸ¥" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deploy -n weave</span></span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/weave-scope-agent-2t4m5                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-6tfp5                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-fxj5f                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-gkxc6                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-qnbbv                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-app-b99fb9585-wld6n              1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-cluster-agent-77bc946585-8fcjj   1/1     Running   0          15m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/weave-scope-app   ClusterIP   10.254.184.106   &lt;none&gt;        80/TCP    15m</span><br><span class="line"></span><br><span class="line">NAME                                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.extensions/weave-scope-app             1/1     1            1           15m</span><br><span class="line">deployment.extensions/weave-scope-cluster-agent   1/1     1            1           15m</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºweave-scope-ingress"><a href="#åˆ›å»ºweave-scope-ingress" class="headerlink" title="åˆ›å»ºweave-scope ingress"></a>åˆ›å»ºweave-scope ingress</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat weave-scope.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: weave-web-ui</span><br><span class="line">  namespace: weave</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: weave-scope.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: weave-scope-app</span><br><span class="line">          servicePort: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f weave-scope.yaml </span></span><br><span class="line">ingress.extensions/weave-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆè¾“å…¥<code>weave-scope.xxlaila.cn</code>å³å¯è®¿é—®<br><img src="https://img.xxlaila.cn/1568958836846.jpg" alt="img"></p><h4 id="æ‹“æ‰‘ç»“æ„"><a href="#æ‹“æ‰‘ç»“æ„" class="headerlink" title="æ‹“æ‰‘ç»“æ„"></a>æ‹“æ‰‘ç»“æ„</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scope ä¼šè‡ªåŠ¨æ„å»ºåº”ç”¨å’Œé›†ç¾¤çš„é€»è¾‘æ‹“æ‰‘ã€‚æ¯”å¦‚ç‚¹å‡»é¡¶éƒ¨ Podsï¼Œä¼šæ˜¾ç¤ºæ‰€æœ‰ Pod ä»¥åŠ Pod ä¹‹é—´çš„ä¾èµ–å…³ç³»<br><img src="https://img.xxlaila.cn/1568958666089.jpg" alt="img"><br>ç‚¹å‡» Hostsï¼Œä¼šæ˜¾ç¤ºå„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œå¯ä»¥åœ¨ Scope ä¸­æŸ¥çœ‹èµ„æºçš„ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚<br><img src="https://img.xxlaila.cn/1568958913275.jpg" alt="img"></p><h3 id="åœ¨çº¿æ“ä½œ"><a href="#åœ¨çº¿æ“ä½œ" class="headerlink" title="åœ¨çº¿æ“ä½œ"></a>åœ¨çº¿æ“ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scope è¿˜æä¾›äº†ä¾¿æ·çš„åœ¨çº¿æ“ä½œåŠŸèƒ½ï¼Œæ¯”å¦‚é€‰ä¸­æŸä¸ª Hostï¼Œç‚¹å‡» &gt;_æŒ‰é’®å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€èŠ‚ç‚¹çš„å‘½ä»¤è¡Œç»ˆç«¯ï¼š<br><img src="https://img.xxlaila.cn/1568959004395.jpg" alt="img"></p><ul><li><p>ç‚¹å‡» Deployment çš„ + å¯ä»¥æ‰§è¡Œæ–°å¢ä¸€ä¸ªpodå®åˆ—<br><img src="https://img.xxlaila.cn/1568959269040.jpg" alt="img"></p></li><li><p>æŸ¥çœ‹podçš„æ—¥å¿—<br><img src="https://img.xxlaila.cn/1568959359334.jpg" alt="img"></p></li><li><p>attachã€restartã€stop å®¹å™¨ï¼Œä»¥åŠç›´æ¥åœ¨ Scope ä¸­æ’æŸ¥é—®é¢˜<br><img src="https://img.xxlaila.cn/1568959467442.jpg" alt="img"></p></li></ul><p>æ›´å¤šåŠŸå‘¢ä¸ªè¯·<a href="https://www.weave.works/docs/scope/latest/plugins/" target="_blank" rel="noopener">å‚è€ƒå®˜æ–¹</a>,æˆ–è€…å®æ“</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14, weave-scope</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 traefikéƒ¨ç½²</title>
    <url>/2019/09/20/k8s-v1-14-traefik%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefix å‰ç¯‡æ˜¯å¯ä»¥ä½¿ç”¨ï¼Œè¿™é‡Œk8s v1.14 ä¹‹å‰çš„æ‹¿æ¥ç”¨ä¸ä¸Šï¼Œç„¶åæŠ˜è…¾äº†ä¸€ä¸‹ï¼Œå‚è€ƒå®˜æ–¹çš„æŠ˜è…¾èµ·æ¥äº†</p><h3 id="åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes-1-6-ï¼‰"><a href="#åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes-1-6-ï¼‰" class="headerlink" title="åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes 1.6+ï¼‰"></a>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes 1.6+ï¼‰</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesåœ¨1.6+ä¸­å¼•å…¥äº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼Œä»¥å…è®¸å¯¹Kubernetesèµ„æºå’ŒAPIè¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚ç¾¤é›†é…ç½®äº†RBACï¼Œåˆ™éœ€è¦æˆæƒTraefikä½¿ç”¨Kubernetes APIã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®¾ç½®é€‚å½“çš„æƒé™ï¼šé€šè¿‡ç‰¹å®šäºå‘½åç©ºé—´çš„RoleBindingsæˆ–å•ä¸ªå…¨å±€ClusterRoleBindingã€‚</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¯ä¸ªå‘½åç©ºé—´çš„RoleBindingå¯ä»¥é™åˆ¶æˆäºˆæƒé™ï¼Œåªæœ‰Traefikæ­£åœ¨ç›‘è§†çš„åç§°ç©ºé—´æ‰èƒ½ä½¿ç”¨ï¼Œä»è€Œéµå¾ªæœ€å°æƒé™åŸåˆ™ã€‚å¦‚æœTraefikä¸åº”è¯¥ç›‘è§†æ‰€æœ‰åç§°ç©ºé—´ï¼Œå¹¶ä¸”åç§°ç©ºé—´é›†ä¸ä¼šåŠ¨æ€æ›´æ”¹ï¼Œé‚£ä¹ˆè¿™æ˜¯é¦–é€‰æ–¹æ³•ã€‚å¦åˆ™ï¼Œå¿…é¡»ä½¿ç”¨å•ä¸ªClusterRoleBindingã€‚</p><p><a href="https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">traefikå­¦ä¹ </a><br><a href="https://docs.traefik.io/v1.7/user-guide/kubernetes/" target="_blank" rel="noopener">traefikå®˜æ–¹</a></p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>ä¸‹è½½trarfixä»£ç ï¼Œç„¶ååˆ‡æ¢åˆ°v1.7çš„åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/containous/traefik.git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git branch --all</span></span><br><span class="line">* master</span><br><span class="line">  remotes/origin/HEAD -&gt; origin/master</span><br><span class="line">  remotes/origin/add-plugin-support</span><br><span class="line">  remotes/origin/gh-pages</span><br><span class="line">  remotes/origin/master</span><br><span class="line">  remotes/origin/v1.0</span><br><span class="line">  remotes/origin/v1.1</span><br><span class="line">  remotes/origin/v1.2</span><br><span class="line">  remotes/origin/v1.3</span><br><span class="line">  remotes/origin/v1.4</span><br><span class="line">  remotes/origin/v1.5</span><br><span class="line">  remotes/origin/v1.6</span><br><span class="line">  remotes/origin/v1.7</span><br><span class="line">  remotes/origin/v2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># git checkout v1.7</span></span><br><span class="line">Branch <span class="string">'v1.7'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'v1.7'</span> from <span class="string">'origin'</span>.</span><br><span class="line">Switched to a new branch <span class="string">'v1.7'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /root/traefik/examples/k8s</span></span><br></pre></td></tr></table></figure><h3 id="å®‰è£…éƒ¨ç½²"><a href="#å®‰è£…éƒ¨ç½²" class="headerlink" title="å®‰è£…éƒ¨ç½²"></a>å®‰è£…éƒ¨ç½²</h3><h4 id="ä½¿ç”¨ClusterRoleBinding"><a href="#ä½¿ç”¨ClusterRoleBinding" class="headerlink" title="ä½¿ç”¨ClusterRoleBinding"></a>ä½¿ç”¨ClusterRoleBinding</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik-rbac.yaml </span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br></pre></td></tr></table></figure><p>å¯¹äºå‘½åç©ºé—´é™åˆ¶ï¼Œæ¯ä¸ªç›‘è§†å‘½åç©ºé—´éœ€è¦ä¸€ä¸ªRoleBindingä»¥åŠTraefik kubernetes.namespaceså‚æ•°çš„ç›¸åº”é…ç½®ã€‚</p><h4 id="ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet"><a href="#ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet" class="headerlink" title="ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet"></a>ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet</h4><p>å¯ä»¥å°†Traefikä¸Deploymentæˆ–DaemonSetå¯¹è±¡ä¸€èµ·ä½¿ç”¨ï¼Œè€Œè¿™ä¸¤ä¸ªé€‰é¡¹å„æœ‰åˆ©å¼Šï¼š</p><ul><li>ä½¿ç”¨éƒ¨ç½²æ—¶ï¼Œå¯ä¼¸ç¼©æ€§å¯ä»¥æ›´å¥½ï¼Œå› ä¸ºåœ¨ä½¿ç”¨DaemonSetæ—¶æ‚¨å°†æ‹¥æœ‰æ¯ä¸ªèŠ‚ç‚¹çš„Single-Podæ¨¡å‹ï¼Œè€Œåœ¨ä½¿ç”¨éƒ¨ç½²æ—¶ï¼Œå¯èƒ½éœ€è¦æ›´å°‘çš„åŸºäºç¯å¢ƒçš„å‰¯æœ¬ã€‚</li><li>å½“èŠ‚ç‚¹åŠ å…¥ç¾¤é›†æ—¶ï¼ŒDaemonSetä¼šè‡ªåŠ¨æ‰©å±•åˆ°æ–°èŠ‚ç‚¹ï¼Œè€Œéƒ¨ç½²çª—æ ¼ä»…åœ¨éœ€è¦æ—¶åœ¨æ–°èŠ‚ç‚¹ä¸Šè¿›è¡Œè°ƒåº¦ã€‚</li><li>DaemonSetsç¡®ä¿åªæœ‰ä¸€ä¸ªpodå‰¯æœ¬åœ¨ä»»ä½•å•ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚å¦‚æœè¦ç¡®ä¿ä¸¤ä¸ªpodä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œåˆ™éƒ¨ç½²éœ€è¦å…³è”è®¾ç½®</li><li>å¯ä»¥ä½¿ç”¨è¯¥NET_BIND_SERVICEåŠŸèƒ½è¿è¡ŒDaemonSet ï¼Œè¿™å°†å…è®¸å®ƒç»‘å®šåˆ°æ¯ä¸ªä¸»æœºä¸Šçš„ç«¯å£80/443 / etcã€‚è¿™å°†å…è®¸ç»•è¿‡kube-proxyï¼Œå¹¶å‡å°‘æµé‡è·³è·ƒã€‚è¯·æ³¨æ„ï¼Œè¿™è¿åäº†Kubernetesæœ€ä½³å®è·µæŒ‡å—ï¼Œå¹¶æå‡ºäº†è°ƒåº¦/æ‰©å±•é—®é¢˜çš„å¯èƒ½æ€§ã€‚å°½ç®¡å­˜åœ¨æ½œåœ¨é—®é¢˜ï¼Œä½†è¿™ä»ç„¶æ˜¯å¤§å¤šæ•°å…¥å£æ§åˆ¶å™¨çš„é€‰æ‹©ã€‚</li></ul><h4 id="Deploymentséƒ¨ç½²"><a href="#Deploymentséƒ¨ç½²" class="headerlink" title="Deploymentséƒ¨ç½²"></a>Deploymentséƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  apply -f  traefik-deployment.yaml</span></span><br><span class="line">serviceaccount/traefik-ingress-controller created</span><br><span class="line">deployment.extensions/traefik-ingress-controller created</span><br><span class="line">service/traefik-ingress-service created</span><br></pre></td></tr></table></figure><h4 id="DaemonSets-éƒ¨ç½²-å¯é€‰"><a href="#DaemonSets-éƒ¨ç½²-å¯é€‰" class="headerlink" title="DaemonSets éƒ¨ç½²(å¯é€‰)"></a>DaemonSets éƒ¨ç½²(å¯é€‰)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik-ds.yaml</span></span><br></pre></td></tr></table></figure><ul><li>Deploymentså’ŒDaemonSetsä¹‹é—´å­˜åœ¨ä¸€äº›æ˜¾ç€å·®å¼‚:<ul><li>éƒ¨ç½²å…·æœ‰æ›´å®¹æ˜“çš„å‘ä¸Šå’Œå‘ä¸‹æ‰©å±•å¯èƒ½æ€§ã€‚å®ƒå¯ä»¥å®ç°å®Œæ•´çš„podç”Ÿå‘½å‘¨æœŸï¼Œå¹¶æ”¯æŒKubernetes 1.2çš„æ»šåŠ¨æ›´æ–°ã€‚è¿è¡Œéƒ¨ç½²è‡³å°‘éœ€è¦ä¸€ä¸ªPodã€‚</li><li>DaemonSetä¼šè‡ªåŠ¨æ‰©å±•åˆ°æ»¡è¶³ç‰¹å®šé€‰æ‹©å™¨çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶ä¿è¯ä¸€æ¬¡å¡«å……ä¸€ä¸ªèŠ‚ç‚¹ã€‚Kubernetes 1.7ä¹Ÿå®Œå…¨æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œé€‚ç”¨äºDaemonSets</li></ul></li></ul><h3 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h3><ul><li><p>æŸ¥çœ‹pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl --namespace=kube-system get pods</span></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5579b8778b-xw8m9                     1/1     Running   2          3d21h</span><br><span class="line">kubernetes-dashboard-65dfbf6f4f-hcgbb        1/1     Running   0          2d16h</span><br><span class="line">metrics-server-94ff5d4cc-b97l5               1/1     Running   1          3d</span><br><span class="line">tiller-deploy-5cbcf75545-rbzld               1/1     Running   0          17h</span><br><span class="line">traefik-ingress-controller-c595665d6-cm7kh   1/1     Running   0          3m20s</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹services</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services --namespace=kube-system</span></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                       AGE</span><br><span class="line">kube-dns                  ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP        3d21h</span><br><span class="line">kubernetes-dashboard      NodePort    10.254.214.153   &lt;none&gt;        443:32533/TCP                 3d21h</span><br><span class="line">metrics-server            ClusterIP   10.254.61.132    &lt;none&gt;        443/TCP                       3d</span><br><span class="line">tiller-deploy             ClusterIP   10.254.207.227   &lt;none&gt;        44134/TCP                     17h</span><br><span class="line">traefik-ingress-service   NodePort    10.254.246.158   &lt;none&gt;        80:32146/TCP,8080:30455/TCP   3m53s</span><br></pre></td></tr></table></figure></li></ul><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯nodeportæ¨¡å¼è¿›è¡Œéƒ¨ç½²çš„ï¼Œå¯ä»¥çœ‹åˆ°ç«¯å£ä¸º32146ï¼Œè¿™é‡Œè®¿é—®ä¼šè¿”å›<code>404 page not found</code>,é‚£æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ç»™Traefikä»»ä½•é…ç½®ã€‚</p><h3 id="åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik-Web-UIçš„Ingres"><a href="#åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik-Web-UIçš„Ingres" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik Web UIçš„Ingres"></a>åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik Web UIçš„Ingres</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ui.yaml </span></span><br><span class="line">service/traefik-web-ui created</span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨/etc/hosts æ–‡ä»¶è®¾ç½®ä¸€ä¸ªè·¯ç”±æ¡ç›®<code>traefik-ui.minikube</code></p><p>åœ¨æµè§ˆå™¨è¿›è¡Œè®¿é—®å¯ä»¥çœ‹åˆ°Traefik Web UI</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14, traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 metrics-server</title>
    <url>/2019/09/17/k8s-v1-14-metrics-server/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>metrics-serverè¿™é‡Œä¸è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/metrics-serverå®‰è£…å­£/" target="_blank" rel="noopener">metrics-serverå®‰è£…å­£</a></p><h3 id="å®‰è£…metrics-server"><a href="#å®‰è£…metrics-server" class="headerlink" title="å®‰è£…metrics-server"></a>å®‰è£…metrics-server</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œå®‰è£…å’Œä¹‹å‰çš„<strong>metrics-serverå®‰è£…å­£</strong>ç¨å¾®æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œä¹‹å‰é›†ç¾¤å®‰è£…æ²¡æœ‰ä½¿ç”¨httpsè¯ä¹¦ï¼Œåé¢å»å„ç§ç”Ÿæˆçš„è¯ä¹¦å’Œè¸©å‘ï¼Œè¿™é‡Œæ˜¯åœ¨å®‰è£…çš„æ—¶å€™ä¸€å¼€å§‹å°±ä½¿ç”¨äº†httpså…¨è¯ä¹¦,æ‰€æœ‰ç¨å¾®æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œè¿™é‡Œåªåˆ—å‡ºæœ‰åŒºåˆ«çš„åœ°æ–¹ï¼Œå…¶ä»–çš„å®Œå…¨å¯ä»¥å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/metrics-serverå®‰è£…å­£/" target="_blank" rel="noopener">metrics-serverå®‰è£…å­£</a>ï¼Œè¿™é‡Œhttpsè¯ä¹¦<strong>ä¸éœ€è¦</strong>é‡æ–°ç”Ÿæˆï¼›</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®æ–‡ä»¶ä¹Ÿä¸éœ€è¦æ·»åŠ ï¼Œåœ¨v1.14å®‰è£…çš„æ—¶å€™å°±å·²ç»å§é…ç½®æ–‡ä»¶æ·»åŠ è¿›å»äº†ï¼Œæ‰€ä»¥è¿™é‡Œé…ç½®æ–‡ä»¶ä¹Ÿä¸éœ€è¦å¢åŠ </p><h3 id="æ–‡ä»¶çš„ä¿®æ”¹"><a href="#æ–‡ä»¶çš„ä¿®æ”¹" class="headerlink" title="æ–‡ä»¶çš„ä¿®æ”¹"></a>æ–‡ä»¶çš„ä¿®æ”¹</h3><ul><li><p>ä¿®æ”¹ metrics-server-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat metrics-server-deployment.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      hostNetwork: <span class="literal">true</span> è¿™ä¸ªè¿˜æ˜¯éœ€è¦å¢åŠ </span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span><br><span class="line">      - name: tmp-dir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: mirrorgooglecontainers/metrics-server-amd64:v0.3.4</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        args:  <span class="comment"># è¿™é‡Œä¸ä¸€æ ·</span></span><br><span class="line">        - --metric-resolution=30s</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp-dir</span><br><span class="line">          mountPath: /tmp</span><br></pre></td></tr></table></figure></li><li><p>â€“metric-resolution=30sï¼šä» kubelet é‡‡é›†æ•°æ®çš„å‘¨æœŸï¼›</p></li><li><p>â€“kubelet-preferred-address-typesï¼šä¼˜å…ˆä½¿ç”¨ InternalIP æ¥è®¿é—® kubeletï¼Œè¿™æ ·å¯ä»¥é¿å…èŠ‚ç‚¹åç§°æ²¡æœ‰ DNS è§£æè®°å½•æ—¶ï¼Œé€šè¿‡èŠ‚ç‚¹åç§°è°ƒç”¨èŠ‚ç‚¹ kubelet API å¤±è´¥çš„æƒ…å†µï¼ˆæœªé…ç½®æ—¶é»˜è®¤çš„æƒ…å†µï¼‰ï¼›</p></li><li><p><strong>hostNetwork: true:</strong> è¿™ä¸ªä¸å¢åŠ çš„ä¼šæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Error from server (ServiceUnavailable): the server is currently unable to handle the request</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ resource-reader.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat resource-reader.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/stats</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups: <span class="comment"># å¢åŠ </span></span><br><span class="line">  - <span class="string">"extensions"</span></span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹è¿è¡Œæƒ…å†µ"><a href="#æŸ¥çœ‹è¿è¡Œæƒ…å†µ" class="headerlink" title="æŸ¥çœ‹è¿è¡Œæƒ…å†µ"></a>æŸ¥çœ‹è¿è¡Œæƒ…å†µ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods -l k8s-app=metrics-server</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-94ff5d4cc-b97l5   1/1     Running   0          21m</span><br><span class="line"></span><br><span class="line"><span class="comment">#  kubectl get svc -n kube-system  metrics-server</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">metrics-server   ClusterIP   10.254.61.132   &lt;none&gt;        443/TCP   27m</span><br></pre></td></tr></table></figure><h3 id="è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯"><a href="#è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯" class="headerlink" title="è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯"></a>è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get apiservice</span></span><br><span class="line">NAME                                   SERVICE                      AVAILABLE   AGE</span><br><span class="line">v1.                                    Local                        True        23h</span><br><span class="line">v1.apps                                Local                        True        23h</span><br><span class="line">v1.authentication.k8s.io               Local                        True        23h</span><br><span class="line">v1.authorization.k8s.io                Local                        True        23h</span><br><span class="line">v1.autoscaling                         Local                        True        23h</span><br><span class="line">v1.batch                               Local                        True        23h</span><br><span class="line">v1.coordination.k8s.io                 Local                        True        23h</span><br><span class="line">v1.networking.k8s.io                   Local                        True        23h</span><br><span class="line">v1.rbac.authorization.k8s.io           Local                        True        23h</span><br><span class="line">v1.scheduling.k8s.io                   Local                        True        23h</span><br><span class="line">v1.storage.k8s.io                      Local                        True        23h</span><br><span class="line">v1alpha1.auditregistration.k8s.io      Local                        True        23h</span><br><span class="line">v1alpha1.node.k8s.io                   Local                        True        23h</span><br><span class="line">v1alpha1.rbac.authorization.k8s.io     Local                        True        23h</span><br><span class="line">v1alpha1.scheduling.k8s.io             Local                        True        23h</span><br><span class="line">v1alpha1.settings.k8s.io               Local                        True        23h</span><br><span class="line">v1alpha1.storage.k8s.io                Local                        True        23h</span><br><span class="line">v1beta1.admissionregistration.k8s.io   Local                        True        23h</span><br><span class="line">v1beta1.apiextensions.k8s.io           Local                        True        23h</span><br><span class="line">v1beta1.apps                           Local                        True        23h</span><br><span class="line">v1beta1.authentication.k8s.io          Local                        True        23h</span><br><span class="line">v1beta1.authorization.k8s.io           Local                        True        23h</span><br><span class="line">v1beta1.batch                          Local                        True        23h</span><br><span class="line">v1beta1.certificates.k8s.io            Local                        True        23h</span><br><span class="line">v1beta1.coordination.k8s.io            Local                        True        23h</span><br><span class="line">v1beta1.events.k8s.io                  Local                        True        23h</span><br><span class="line">v1beta1.extensions                     Local                        True        23h</span><br><span class="line">v1beta1.metrics.k8s.io                 kube-system/metrics-server   True        27m</span><br><span class="line">v1beta1.networking.k8s.io              Local                        True        23h</span><br><span class="line">v1beta1.node.k8s.io                    Local                        True        23h</span><br><span class="line">v1beta1.policy                         Local                        True        23h</span><br><span class="line">v1beta1.rbac.authorization.k8s.io      Local                        True        23h</span><br><span class="line">v1beta1.scheduling.k8s.io              Local                        True        23h</span><br><span class="line">v1beta1.storage.k8s.io                 Local                        True        23h</span><br><span class="line">v1beta2.apps                           Local                        True        23h</span><br><span class="line">v2alpha1.batch                         Local                        True        23h</span><br><span class="line">v2beta1.autoscaling                    Local                        True        23h</span><br><span class="line">v2beta2.autoscaling                    Local                        True        23h</span><br></pre></td></tr></table></figure><h3 id="metrics-server-çš„å‘½ä»¤è¡Œå‚æ•°"><a href="#metrics-server-çš„å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="metrics-server çš„å‘½ä»¤è¡Œå‚æ•°"></a>metrics-server çš„å‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec --namespace kube-system -it metrics-server-94ff5d4cc-b97l5 -- /metrics-server --help</span></span><br><span class="line">Launch metrics-server</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">   [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --alsologtostderr                                         <span class="built_in">log</span> to standard error as well as files</span><br><span class="line">      --authentication-kubeconfig string                        kubeconfig file pointing at the <span class="string">'core'</span> kubernetes server with enough rights to create tokenaccessreviews.authentication.k8s.io.</span><br><span class="line">      --authentication-skip-lookup                              If <span class="literal">false</span>, the authentication-kubeconfig will be used to lookup missing authentication configuration from the cluster.</span><br><span class="line">      --authentication-token-webhook-cache-ttl duration         The duration to cache responses from the webhook token authenticator. (default 10s)</span><br><span class="line">      --authentication-tolerate-lookup-failure                  If <span class="literal">true</span>, failures to look up missing authentication configuration from the cluster are not considered fatal. Note that this can result <span class="keyword">in</span> authentication that treats all requests as anonymous.</span><br><span class="line">      --authorization-always-allow-paths strings                A list of HTTP paths to skip during authorization, i.e. these are authorized without contacting the <span class="string">'core'</span> kubernetes server.</span><br><span class="line">      --authorization-kubeconfig string                         kubeconfig file pointing at the <span class="string">'core'</span> kubernetes server with enough rights to create subjectaccessreviews.authorization.k8s.io.</span><br><span class="line">      --authorization-webhook-cache-authorized-ttl duration     The duration to cache <span class="string">'authorized'</span> responses from the webhook authorizer. (default 10s)</span><br><span class="line">      --authorization-webhook-cache-unauthorized-ttl duration   The duration to cache <span class="string">'unauthorized'</span> responses from the webhook authorizer. (default 10s)</span><br><span class="line">      --<span class="built_in">bind</span>-address ip                                         The IP address on <span class="built_in">which</span> to listen <span class="keyword">for</span> the --secure-port port. The associated interface(s) must be reachable by the rest of the cluster, and by CLI/web clients. If blank, all interfaces will be used (0.0.0.0 <span class="keyword">for</span> all IPv4 interfaces and :: <span class="keyword">for</span> all IPv6 interfaces). (default 0.0.0.0)</span><br><span class="line">      --cert-dir string                                         The directory <span class="built_in">where</span> the TLS certs are located. If --tls-cert-file and --tls-private-key-file are provided, this flag will be ignored. (default <span class="string">"apiserver.local.config/certificates"</span>)</span><br><span class="line">      --client-ca-file string                                   If <span class="built_in">set</span>, any request presenting a client certificate signed by one of the authorities <span class="keyword">in</span> the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.</span><br><span class="line">      --contention-profiling                                    Enable lock contention profiling, <span class="keyword">if</span> profiling is enabled</span><br><span class="line">  -h, --<span class="built_in">help</span>                                                    <span class="built_in">help</span> <span class="keyword">for</span> this <span class="built_in">command</span></span><br><span class="line">      --http2-max-streams-per-connection int                    The <span class="built_in">limit</span> that the server gives to clients <span class="keyword">for</span> the maximum number of streams <span class="keyword">in</span> an HTTP/2 connection. Zero means to use golang<span class="string">'s default.</span></span><br><span class="line"><span class="string">      --kubeconfig string                                       The path to the kubeconfig used to connect to the Kubernetes API server and the Kubelets (defaults to in-cluster config)</span></span><br><span class="line"><span class="string">      --kubelet-certificate-authority string                    Path to the CA to use to validate the Kubelet'</span>s serving certificates.</span><br><span class="line">      --kubelet-insecure-tls                                    Do not verify CA of serving certificates presented by Kubelets.  For testing purposes only.</span><br><span class="line">      --kubelet-port int                                        The port to use to connect to Kubelets. (default 10250)</span><br><span class="line">      --kubelet-preferred-address-types strings                 The priority of node address types to use when determining <span class="built_in">which</span> address to use to connect to a particular node (default [Hostname,InternalDNS,InternalIP,ExternalDNS,ExternalIP])</span><br><span class="line">      --<span class="built_in">log</span>-flush-frequency duration                            Maximum number of seconds between <span class="built_in">log</span> flushes (default 5s)</span><br><span class="line">      --log_backtrace_at traceLocation                          when logging hits line file:N, emit a stack trace (default :0)</span><br><span class="line">      --log_dir string                                          If non-empty, write <span class="built_in">log</span> files <span class="keyword">in</span> this directory</span><br><span class="line">      --log_file string                                         If non-empty, use this <span class="built_in">log</span> file</span><br><span class="line">      --logtostderr                                             <span class="built_in">log</span> to standard error instead of files (default <span class="literal">true</span>)</span><br><span class="line">      --metric-resolution duration                              The resolution at <span class="built_in">which</span> metrics-server will retain metrics. (default 1m0s)</span><br><span class="line">      --profiling                                               Enable profiling via web interface host:port/debug/pprof/ (default <span class="literal">true</span>)</span><br><span class="line">      --requestheader-allowed-names strings                     List of client certificate common names to allow to provide usernames <span class="keyword">in</span> headers specified by --requestheader-username-headers. If empty, any client certificate validated by the authorities <span class="keyword">in</span> --requestheader-client-ca-file is allowed.</span><br><span class="line">      --requestheader-client-ca-file string                     Root certificate bundle to use to verify client certificates on incoming requests before trusting usernames <span class="keyword">in</span> headers specified by --requestheader-username-headers. WARNING: generally <span class="keyword">do</span> not depend on authorization being already <span class="keyword">done</span> <span class="keyword">for</span> incoming requests.</span><br><span class="line">      --requestheader-extra-headers-prefix strings              List of request header prefixes to inspect. X-Remote-Extra- is suggested. (default [x-remote-extra-])</span><br><span class="line">      --requestheader-group-headers strings                     List of request headers to inspect <span class="keyword">for</span> groups. X-Remote-Group is suggested. (default [x-remote-group])</span><br><span class="line">      --requestheader-username-headers strings                  List of request headers to inspect <span class="keyword">for</span> usernames. X-Remote-User is common. (default [x-remote-user])</span><br><span class="line">      --secure-port int                                         The port on <span class="built_in">which</span> to serve HTTPS with authentication and authorization.If 0, don<span class="string">'t serve HTTPS at all. (default 443)</span></span><br><span class="line"><span class="string">      --skip_headers                                            If true, avoid header prefixes in the log messages</span></span><br><span class="line"><span class="string">      --stderrthreshold severity                                logs at or above this threshold go to stderr</span></span><br><span class="line"><span class="string">      --tls-cert-file string                                    File containing the default x509 Certificate for HTTPS. (CA cert, if any, concatenated after server cert). If HTTPS serving is enabled, and --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to the directory specified by --cert-dir.</span></span><br><span class="line"><span class="string">      --tls-cipher-suites strings                               Comma-separated list of cipher suites for the server. If omitted, the default Go cipher suites will be use.  Possible values: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_RC4_128_SHA,TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_RC4_128_SHA,TLS_RSA_WITH_3DES_EDE_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA256,TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_RC4_128_SHA</span></span><br><span class="line"><span class="string">      --tls-min-version string                                  Minimum TLS version supported. Possible values: VersionTLS10, VersionTLS11, VersionTLS12</span></span><br><span class="line"><span class="string">      --tls-private-key-file string                             File containing the default x509 private key matching --tls-cert-file.</span></span><br><span class="line"><span class="string">      --tls-sni-cert-key namedCertKey                           A pair of x509 certificate and private key file paths, optionally suffixed with a list of domain patterns which are fully qualified domain names, possibly with prefixed wildcard segments. If no domain patterns are provided, the names of the certificate are extracted. Non-wildcard matches trump over wildcard matches, explicit domain patterns trump over extracted names. For multiple key/certificate pairs, use the --tls-sni-cert-key multiple times. Examples: "example.crt,example.key" or "foo.crt,foo.key:*.foo.com,foo.com". (default [])</span></span><br><span class="line"><span class="string">  -v, --v Level                                                 number for the log level verbosity</span></span><br><span class="line"><span class="string">      --vmodule moduleSpec                                      comma-separated list of pattern=N settings for file-filtered logging</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>metrics-server</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 dashboard</title>
    <url>/2019/09/16/k8s-v1-14-dashboard/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>kuberntes è‡ªå¸¦æ’ä»¶çš„ manifests yaml æ–‡ä»¶ä½¿ç”¨ gcr.io çš„ docker registryï¼Œå›½å†…è¢«å¢™ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä¸ºå…¶å®ƒ registry åœ°å€</p><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-src.tar.gz</span></span><br></pre></td></tr></table></figure><p>dashboard å¯¹åº”çš„ç›®å½•æ˜¯ï¼šcluster/addons/dashboardï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd cluster/addons/dashboard</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ service å®šä¹‰ï¼ŒæŒ‡å®šç«¯å£ç±»å‹ä¸º NodePortï¼Œè¿™æ ·å¤–ç•Œå¯ä»¥é€šè¿‡åœ°å€ NodeIP:NodePort è®¿é—® dashboardï¼›</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat dashboard-service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort <span class="comment"># å¢åŠ è¿™ä¸€è¡Œ</span></span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat dashboard-controller.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'docker/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: docker.io/xxlaila/kubernetes-dashboard-amd64:v1.10.0  <span class="comment">#ä¿®æ”¹è¿™ä¸€è¡Œ</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶"><a href="#æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶" class="headerlink" title="æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶"></a>æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls *.yaml</span></span><br><span class="line">dashboard-configmap.yaml  dashboard-controller.yaml  dashboard-rbac.yaml  dashboard-secret.yaml  dashboard-service.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f  .</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹åˆ†é…çš„-NodePort"><a href="#æŸ¥çœ‹åˆ†é…çš„-NodePort" class="headerlink" title="æŸ¥çœ‹åˆ†é…çš„ NodePort"></a>æŸ¥çœ‹åˆ†é…çš„ NodePort</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get deployment kubernetes-dashboard  -n kube-system</span></span><br><span class="line">NAME                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kubernetes-dashboard   1/1     1            1           5h10m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl --namespace kube-system get pods -o wide</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP             NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-5579b8778b-xw8m9                1/1     Running   1          5h15m   172.30.232.3   172.21.16.204   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-6cc78dfc99-hb4l5   1/1     Running   0          5h10m   172.30.176.3   172.21.16.240   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get services kubernetes-dashboard -n kube-system</span></span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.254.214.153   &lt;none&gt;        443:32533/TCP   5h10m</span><br></pre></td></tr></table></figure><ul><li>NodePort 32533 æ˜ å°„åˆ° dashboard pod 443 ç«¯å£ï¼›</li></ul><h3 id="æŸ¥çœ‹-dashboard-æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°"><a href="#æŸ¥çœ‹-dashboard-æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="æŸ¥çœ‹ dashboard æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°"></a>æŸ¥çœ‹ dashboard æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec --namespace kube-system -it kubernetes-dashboard-6cc78dfc99-hb4l5  -- /dashboard --help</span></span><br><span class="line">2019/09/16 09:51:33 Starting overwatch</span><br><span class="line">Usage of /dashboard:</span><br><span class="line">      --alsologtostderr                  <span class="built_in">log</span> to standard error as well as files</span><br><span class="line">      --api-log-level string             Level of API request logging. Should be one of <span class="string">'INFO|NONE|DEBUG'</span>. Default: <span class="string">'INFO'</span>. (default <span class="string">"INFO"</span>)</span><br><span class="line">      --apiserver-host string            The address of the Kubernetes Apiserver to connect to <span class="keyword">in</span> the format of protocol://address:port, e.g., http://localhost:8080. If not specified, the assumption is that the binary runs inside a Kubernetes cluster and <span class="built_in">local</span> discovery is attempted.</span><br><span class="line">      --authentication-mode strings      Enables authentication options that will be reflected on login screen. Supported values: token, basic. Default: token.Note that basic option should only be used <span class="keyword">if</span> apiserver has <span class="string">'--authorization-mode=ABAC'</span> and <span class="string">'--basic-auth-file'</span> flags <span class="built_in">set</span>. (default [token])</span><br><span class="line">      --auto-generate-certificates       When <span class="built_in">set</span> to <span class="literal">true</span>, Dashboard will automatically generate certificates used to serve HTTPS. Default: <span class="literal">false</span>.</span><br><span class="line">      --<span class="built_in">bind</span>-address ip                  The IP address on <span class="built_in">which</span> to serve the --secure-port (<span class="built_in">set</span> to 0.0.0.0 <span class="keyword">for</span> all interfaces). (default 0.0.0.0)</span><br><span class="line">      --default-cert-dir string          Directory path containing <span class="string">'--tls-cert-file'</span> and <span class="string">'--tls-key-file'</span> files. Used also when auto-generating certificates flag is <span class="built_in">set</span>. (default <span class="string">"/certs"</span>)</span><br><span class="line">      --<span class="built_in">disable</span>-settings-authorizer      When enabled, Dashboard settings page will not require user to be logged <span class="keyword">in</span> and authorized to access settings page.</span><br><span class="line">      --<span class="built_in">disable</span>-skip                     When enabled, the skip button on the login page will not be shown. Default: <span class="literal">false</span>.</span><br><span class="line">      --<span class="built_in">enable</span>-insecure-login            When enabled, Dashboard login view will also be shown when Dashboard is not served over HTTPS. Default: <span class="literal">false</span>.</span><br><span class="line">      --heapster-host string             The address of the Heapster Apiserver to connect to <span class="keyword">in</span> the format of protocol://address:port, e.g., http://localhost:8082. If not specified, the assumption is that the binary runs inside a Kubernetes cluster and service proxy will be used.</span><br><span class="line">      --insecure-bind-address ip         The IP address on <span class="built_in">which</span> to serve the --port (<span class="built_in">set</span> to 0.0.0.0 <span class="keyword">for</span> all interfaces). (default 127.0.0.1)</span><br><span class="line">      --insecure-port int                The port to listen to <span class="keyword">for</span> incoming HTTP requests. (default 9090)</span><br><span class="line">      --kubeconfig string                Path to kubeconfig file with authorization and master location information.</span><br><span class="line">      --log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace (default :0)</span><br><span class="line">      --log_dir string                   If non-empty, write <span class="built_in">log</span> files <span class="keyword">in</span> this directory</span><br><span class="line">      --logtostderr                      <span class="built_in">log</span> to standard error instead of files</span><br><span class="line">      --metric-client-check-period int   Time <span class="keyword">in</span> seconds that defines how often configured metric client health check should be run. Default: 30 seconds. (default 30)</span><br><span class="line">      --port int                         The secure port to listen to <span class="keyword">for</span> incoming HTTPS requests. (default 8443)</span><br><span class="line">      --stderrthreshold severity         logs at or above this threshold go to stderr (default 2)</span><br><span class="line">      --system-banner string             When non-empty displays message to Dashboard users. Accepts simple HTML tags. Default: <span class="string">''</span>.</span><br><span class="line">      --system-banner-severity string    Severity of system banner. Should be one of <span class="string">'INFO|WARNING|ERROR'</span>. Default: <span class="string">'INFO'</span>. (default <span class="string">"INFO"</span>)</span><br><span class="line">      --tls-cert-file string             File containing the default x509 Certificate <span class="keyword">for</span> HTTPS.</span><br><span class="line">      --tls-key-file string              File containing the default x509 private key matching --tls-cert-file.</span><br><span class="line">      --token-ttl int                    Expiration time (<span class="keyword">in</span> seconds) of JWE tokens generated by dashboard. Default: 15 min. 0 - never expires (default 900)</span><br><span class="line">  -v, --v Level                          <span class="built_in">log</span> level <span class="keyword">for</span> V logs</span><br><span class="line">      --vmodule moduleSpec               comma-separated list of pattern=N settings <span class="keyword">for</span> file-filtered logging</span><br><span class="line">pflag: <span class="built_in">help</span> requested</span><br><span class="line"><span class="built_in">command</span> terminated with <span class="built_in">exit</span> code 2</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashboard çš„ â€“authentication-mode æ”¯æŒ tokenã€basicï¼Œé»˜è®¤ä¸º tokenã€‚å¦‚æœä½¿ç”¨ basicï¼Œåˆ™ kube-apiserver å¿…é¡»é…ç½® â€“authorization-mode=ABAC å’Œ â€“basic-auth-file å‚æ•°</p><h3 id="è®¿é—®-dashboard"><a href="#è®¿é—®-dashboard" class="headerlink" title="è®¿é—® dashboard"></a>è®¿é—® dashboard</h3><p>ä½¿ç”¨httpsåè®®ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ä»»æ„nodeçš„ipåŠ ç«¯å£å³å¯è®¿é—®<br><img src="https://img.xxlaila.cn/1568961339763.jpg" alt="img"></p><h3 id="åˆ›å»ºç™»å½•-Dashboard-çš„-token-å’Œ-kubeconfig-é…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºç™»å½•-Dashboard-çš„-token-å’Œ-kubeconfig-é…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºç™»å½• Dashboard çš„ token å’Œ kubeconfig é…ç½®æ–‡ä»¶"></a>åˆ›å»ºç™»å½• Dashboard çš„ token å’Œ kubeconfig é…ç½®æ–‡ä»¶</h3><p>dashboard é»˜è®¤åªæ”¯æŒ token è®¤è¯ï¼ˆä¸æ”¯æŒ client è¯ä¹¦è®¤è¯ï¼‰ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨ Kubeconfig æ–‡ä»¶ï¼Œéœ€è¦å°† token å†™å…¥åˆ°è¯¥æ–‡ä»¶ã€‚</p><h4 id="åˆ›å»ºç™»å½•-token"><a href="#åˆ›å»ºç™»å½•-token" class="headerlink" title="åˆ›å»ºç™»å½• token"></a>åˆ›å»ºç™»å½• token</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create sa dashboard-admin -n kube-system</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span></span><br><span class="line"><span class="comment"># ADMIN_SECRET=$(kubectl get secrets -n kube-system | grep dashboard-admin | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># DASHBOARD_LOGIN_TOKEN=$(kubectl describe secret -n kube-system $&#123;ADMIN_SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;DASHBOARD_LOGIN_TOKEN&#125;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¾“å‡ºçš„ token ç™»å½• Dashboardã€‚</p><h3 id="åˆ›å»ºä½¿ç”¨-token-çš„-KubeConfig-æ–‡ä»¶"><a href="#åˆ›å»ºä½¿ç”¨-token-çš„-KubeConfig-æ–‡ä»¶" class="headerlink" title="åˆ›å»ºä½¿ç”¨ token çš„ KubeConfig æ–‡ä»¶"></a>åˆ›å»ºä½¿ç”¨ token çš„ KubeConfig æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°ï¼Œä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ Token</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials dashboard_user \</span><br><span class="line">  --token=<span class="variable">$&#123;DASHBOARD_LOGIN_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=dashboard_user \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context default --kubeconfig=dashboard.kubeconfig</span><br></pre></td></tr></table></figure><p>å¦‚å›¾:<br><img src="https://img.xxlaila.cn/1568961447890.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨ç”Ÿæˆçš„ dashboard.kubeconfig ç™»å½• Dashboardã€‚ç”±äºk8s é»˜è®¤çš„Dashboard 15åˆ†é’Ÿåå°±ä¼šå¼¹å‡ºï¼Œåˆè¦é‡æ–°ç™»å½•å’Œè·å–tokenéº»çƒ¦ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://xxlaila.github.io/2019/08/29/k8sé…ç½®Dashboard/" target="_blank" rel="noopener">k8sé…ç½®Dashboard</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 dnsæ’ä»¶</title>
    <url>/2019/09/16/k8s-v1-14-dns%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="éƒ¨ç½²-coredns-æ’ä»¶"><a href="#éƒ¨ç½²-coredns-æ’ä»¶" class="headerlink" title="éƒ¨ç½² coredns æ’ä»¶"></a>éƒ¨ç½² coredns æ’ä»¶</h3><p><strong>æ³¨æ„:</strong></p><ul><li>kuberntes è‡ªå¸¦æ’ä»¶çš„ manifests yaml æ–‡ä»¶ä½¿ç”¨ gcr.io çš„ docker registryï¼Œå›½å†…è¢«å¢™ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä¸ºå…¶å®ƒ registry åœ°å€;</li></ul><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-src.tar.gz</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li>coredns ç›®å½•æ˜¯ cluster/addons/dns<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd cluster/addons/dns/coredns</span></span><br><span class="line"><span class="comment"># cp coredns.yaml.base coredns.yaml</span></span><br><span class="line"><span class="comment"># sed -i -e "s/__PILLAR__DNS__DOMAIN__/cluster.local/" -e "s/__PILLAR__DNS__SERVER__/10.254.0.2/" coredns.yaml</span></span><br><span class="line"><span class="comment"># sed -i "s/k8s.gcr.io/coredns/" coredns.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f coredns.yaml</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="æ£€æŸ¥-coredns-åŠŸèƒ½"><a href="#æ£€æŸ¥-coredns-åŠŸèƒ½" class="headerlink" title="æ£€æŸ¥ coredns åŠŸèƒ½"></a>æ£€æŸ¥ coredns åŠŸèƒ½</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get all -n kube-system</span></span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-5579b8778b-xw8m9                1/1     Running   1          5h7m</span><br><span class="line"></span><br><span class="line">NAME                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/kube-dns               ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   5h7m</span><br><span class="line"></span><br><span class="line">NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/coredns                1/1     1            1           5h7m</span><br><span class="line"></span><br><span class="line">NAME                                              DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/coredns-5579b8778b                1         1         1       5h7m</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-9fb46   1/1     Running   0          5h14m</span><br><span class="line">nginx-ds-bgfzt   1/1     Running   0          5h14m</span><br><span class="line">nginx-ds-t22wj   1/1     Running   0          5h14m</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -it exec nginx-ds-9fb46 bash</span></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># cat /etc/resolv.conf</span></span><br><span class="line">nameserver 10.254.0.2</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local openstacklocal novalocal</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping www.baidu.com</span></span><br><span class="line">PING www.wshifen.com (104.193.88.77): 48 data bytes</span><br><span class="line">56 bytes from 104.193.88.77: icmp_seq=0 ttl=45 time=191.953 ms</span><br><span class="line">56 bytes from 104.193.88.77: icmp_seq=1 ttl=45 time=191.680 ms</span><br><span class="line">^C--- www.wshifen.com ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 191.680/191.817/191.953/0.137 ms</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.120 ms</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=1 ttl=64 time=0.116 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.116/0.118/0.120/0.000 ms</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.079 ms</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=1 ttl=64 time=0.152 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.079/0.115/0.152/0.037 ms</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc.cluster.local.</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.080 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.080/0.080/0.080/0.000 ms</span><br><span class="line">`</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14 coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14é›†ç¾¤éªŒè¯</title>
    <url>/2019/09/16/k8s-v1-14%E9%9B%86%E7%BE%A4%E9%AA%8C%E8%AF%81/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="éªŒè¯é›†ç¾¤åŠŸèƒ½"><a href="#éªŒè¯é›†ç¾¤åŠŸèƒ½" class="headerlink" title="éªŒè¯é›†ç¾¤åŠŸèƒ½"></a>éªŒè¯é›†ç¾¤åŠŸèƒ½</h3><h3 id="æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€"><a href="#æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€"></a>æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   5h50m   v1.14.6</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   5h48m   v1.14.6</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   5h45m   v1.14.6</span><br></pre></td></tr></table></figure><p>éƒ½ä¸º Ready æ—¶æ­£å¸¸ã€‚</p><a id="more"></a><h3 id="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"><a href="#åˆ›å»ºæµ‹è¯•æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"></a>åˆ›å»ºæµ‹è¯•æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat nginx-ds.yml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f nginx-ds.yml</span></span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥å„èŠ‚ç‚¹çš„-Pod-IP-è¿é€šæ€§"><a href="#æ£€æŸ¥å„èŠ‚ç‚¹çš„-Pod-IP-è¿é€šæ€§" class="headerlink" title="æ£€æŸ¥å„èŠ‚ç‚¹çš„ Pod IP è¿é€šæ€§"></a>æ£€æŸ¥å„èŠ‚ç‚¹çš„ Pod IP è¿é€šæ€§</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods  -o wide|grep nginx-ds</span></span><br><span class="line">nginx-ds-9fb46   1/1     Running   0          5h2m   172.30.232.2   172.21.16.204   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-bgfzt   1/1     Running   0          5h2m   172.30.128.2   172.21.16.87    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-t22wj   1/1     Running   0          5h2m   172.30.176.2   172.21.16.240   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥æœåŠ¡-IP-å’Œç«¯å£å¯è¾¾æ€§"><a href="#æ£€æŸ¥æœåŠ¡-IP-å’Œç«¯å£å¯è¾¾æ€§" class="headerlink" title="æ£€æŸ¥æœåŠ¡ IP å’Œç«¯å£å¯è¾¾æ€§"></a>æ£€æŸ¥æœåŠ¡ IP å’Œç«¯å£å¯è¾¾æ€§</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc |grep nginx-ds</span></span><br><span class="line">nginx-ds     NodePort    10.254.232.104   &lt;none&gt;        80:30349/TCP   5h2m</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨åœ¨30349è¿›è¡Œè®¿é—®å¯ä»¥çœ‹åˆ°neinxçš„æ¬¢è¿ç•Œé¢</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-v1.14 nodeå®‰è£…</title>
    <url>/2019/09/16/kubernetes-v1-14-node%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><h3 id="1ã€å®‰è£…docker"><a href="#1ã€å®‰è£…docker" class="headerlink" title="1ã€å®‰è£…docker"></a>1ã€å®‰è£…docker</h3><h4 id="1-1ã€å¢åŠ docker-æº"><a href="#1-1ã€å¢åŠ docker-æº" class="headerlink" title="1.1ã€å¢åŠ docker æº"></a>1.1ã€å¢åŠ docker æº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">  --add-repo \</span><br><span class="line">  https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h4 id="1-2ã€å®‰è£…docker"><a href="#1-2ã€å®‰è£…docker" class="headerlink" title="1.2ã€å®‰è£…docker"></a>1.2ã€å®‰è£…docker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  yum -y install docker-ce</span></span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-3ã€ä¿®æ”¹docker-systemd-unit-æ–‡ä»¶"><a href="#1-3ã€ä¿®æ”¹docker-systemd-unit-æ–‡ä»¶" class="headerlink" title="1.3ã€ä¿®æ”¹docker systemd unit æ–‡ä»¶"></a>1.3ã€ä¿®æ”¹docker systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/docker.service |egrep -Ev "^$|^#"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">BindsTo=containerd.service</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/run/flannel/docker</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>dockerd è¿è¡Œæ—¶ä¼šè°ƒç”¨å…¶å®ƒ docker å‘½ä»¤ï¼Œå¦‚ docker-proxyï¼Œæ‰€ä»¥éœ€è¦å°† docker å‘½ä»¤æ‰€åœ¨çš„ç›®å½•åŠ åˆ° PATH ç¯å¢ƒå˜é‡ä¸­ï¼›</li><li>flanneld å¯åŠ¨æ—¶å°†ç½‘ç»œé…ç½®å†™å…¥ /run/flannel/docker æ–‡ä»¶ä¸­ï¼Œdockerd å¯åŠ¨å‰è¯»å–è¯¥æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡ DOCKER_NETWORK_OPTIONS ï¼Œç„¶åè®¾ç½® docker0 ç½‘æ¡¥ç½‘æ®µï¼›</li><li>å¦‚æœæŒ‡å®šäº†å¤šä¸ª EnvironmentFile é€‰é¡¹ï¼Œåˆ™å¿…é¡»å°† /run/flannel/docker æ”¾åœ¨æœ€å(ç¡®ä¿ docker0 ä½¿ç”¨ flanneld ç”Ÿæˆçš„ bip å‚æ•°)ï¼›</li><li>docker éœ€è¦ä»¥ root ç”¨äºè¿è¡Œï¼›</li></ul><h4 id="1-4ã€å¯åŠ¨-docker-æœåŠ¡"><a href="#1-4ã€å¯åŠ¨-docker-æœåŠ¡" class="headerlink" title="1.4ã€å¯åŠ¨ docker æœåŠ¡"></a>1.4ã€å¯åŠ¨ docker æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable docker &amp;&amp; systemctl restart docker &amp;&amp; systemctl status docker</span></span><br></pre></td></tr></table></figure><h4 id="1-5ã€æ£€æŸ¥-docker0-ç½‘æ¡¥"><a href="#1-5ã€æ£€æŸ¥-docker0-ç½‘æ¡¥" class="headerlink" title="1.5ã€æ£€æŸ¥ docker0 ç½‘æ¡¥"></a>1.5ã€æ£€æŸ¥ docker0 ç½‘æ¡¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/sbin/ip addr show flannel.1 &amp;&amp; /usr/sbin/ip addr show docker0</span></span><br><span class="line">3: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether 8a:be:12:b9:ab:b8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.128.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:eb:ec:ae:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.128.1/21 brd 172.30.135.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h4 id="1-5ã€æŸ¥çœ‹-docker-çš„çŠ¶æ€ä¿¡æ¯"><a href="#1-5ã€æŸ¥çœ‹-docker-çš„çŠ¶æ€ä¿¡æ¯" class="headerlink" title="1.5ã€æŸ¥çœ‹ docker çš„çŠ¶æ€ä¿¡æ¯"></a>1.5ã€æŸ¥çœ‹ docker çš„çŠ¶æ€ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ps -elfH|grep docker</span></span><br><span class="line">0 S root      1436   975  0  80   0 - 28167 -      10:54 pts/0    00:00:00                 grep --color=auto docker</span><br><span class="line">4 S root      1265     1  1  80   0 - 122095 futex_ 10:54 ?       00:00:00   /usr/bin/dockerd --bip=172.30.112.1/21 --ip-masq=<span class="literal">false</span> --mtu=1450</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker info</span></span><br><span class="line">vClient:</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 0</span><br><span class="line">  Running: 0</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 0</span><br><span class="line"> Images: 0</span><br><span class="line"> Server Version: 18.09.6</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: xfs</span><br><span class="line">  Supports d_type: <span class="literal">true</span></span><br><span class="line">  Native Overlay Diff: <span class="literal">true</span></span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: <span class="built_in">local</span></span><br><span class="line">  Network: bridge host macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk syslog</span><br><span class="line"> Swarm: inactive</span><br><span class="line"> Runtimes: runc</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version: 894b81a4b802e4eb2a91d1ce216b8817763c29fb</span><br><span class="line"> runc version: 425e105d5a03fabd737a126ad93d62a9eeede87f</span><br><span class="line"> init version: fec3683</span><br><span class="line"> Security Options:</span><br><span class="line">  seccomp</span><br><span class="line">   Profile: default</span><br><span class="line"> Kernel Version: 4.4.193-1.el7.elrepo.x86_64</span><br><span class="line"> Operating System: CentOS Linux 7 (Core)</span><br><span class="line"> OSType: linux</span><br><span class="line"> Architecture: x86_64</span><br><span class="line"> CPUs: 4</span><br><span class="line"> Total Memory: 7.796GiB</span><br><span class="line"> Name: k8s-node-2.kxl</span><br><span class="line"> ID: GJEA:U6PT:NMHM:KWD2:DOIJ:U6XW:6N3U:4QZN:F5PT:CQXH:MZKU:VATL</span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Registry: https://index.docker.io/v1/</span><br><span class="line"> Labels:</span><br><span class="line"> Experimental: <span class="literal">false</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Live Restore Enabled: <span class="literal">false</span></span><br><span class="line"> Product License: Community Engine</span><br></pre></td></tr></table></figure><h3 id="2ã€éƒ¨ç½²-kubelet-ç»„ä»¶"><a href="#2ã€éƒ¨ç½²-kubelet-ç»„ä»¶" class="headerlink" title="2ã€éƒ¨ç½² kubelet ç»„ä»¶"></a>2ã€éƒ¨ç½² kubelet ç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet è¿è¡Œåœ¨æ¯ä¸ª worker èŠ‚ç‚¹ä¸Šï¼Œæ¥æ”¶ kube-apiserver å‘é€çš„è¯·æ±‚ï¼Œç®¡ç† Pod å®¹å™¨ï¼Œæ‰§è¡Œäº¤äº’å¼å‘½ä»¤ï¼Œå¦‚ execã€runã€logs ç­‰ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨æ—¶è‡ªåŠ¨å‘ kube-apiserver æ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œå†…ç½®çš„ cadvisor ç»Ÿè®¡å’Œç›‘æ§èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºç¡®ä¿å®‰å…¨ï¼Œéƒ¨ç½²æ—¶å…³é—­äº† kubelet çš„éå®‰å…¨ http ç«¯å£ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒï¼Œæ‹’ç»æœªæˆæƒçš„è®¿é—®(å¦‚ apiserverã€heapster çš„è¯·æ±‚)ã€‚</p><h4 id="2-1ã€åˆ›å»º-kubelet-bootstrap-kubeconfig-æ–‡ä»¶"><a href="#2-1ã€åˆ›å»º-kubelet-bootstrap-kubeconfig-æ–‡ä»¶" class="headerlink" title="2.1ã€åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶"></a>2.1ã€åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶</h4><p>NODE_NAMES é‡Œé¢çš„å€¼æ˜¯nodeçš„ä¸»æœºå</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># NODE_NAMES=(node-01 node-02 node-03)</span></span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»º token</span></span><br><span class="line">    <span class="built_in">export</span> BOOTSTRAP_TOKEN=$(kubeadm token create \</span><br><span class="line">      --description kubelet-bootstrap-token \</span><br><span class="line">      --groups system:bootstrappers:<span class="variable">$&#123;node_name&#125;</span> \</span><br><span class="line">      --kubeconfig ~/.kube/config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">      --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">      --embed-certs=<span class="literal">true</span> \</span><br><span class="line">      --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</span><br><span class="line">      --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">      --cluster=kubernetes \</span><br><span class="line">      --user=kubelet-bootstrap \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">    kubectl config use-context default --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for node_name in $&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">    scp kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig root@<span class="variable">$&#123;node_name&#125;</span>:/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li><p>å‘ kubeconfig å†™å…¥çš„æ˜¯ tokenï¼Œbootstrap ç»“æŸå kube-controller-manager ä¸º kubelet åˆ›å»º client å’Œ server è¯ä¹¦ï¼›</p></li><li><p>æŸ¥çœ‹ kubeadm ä¸ºå„èŠ‚ç‚¹åˆ›å»ºçš„ token:<br>master èŠ‚ç‚¹æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm token list --kubeconfig ~/.kube/config</span></span><br><span class="line">TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION               EXTRA GROUPS</span><br><span class="line">016e9x.306t91l832suzg8i   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-03</span><br><span class="line">4l4tcx.juy6qs9rmrnfpbig   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-01</span><br><span class="line">64pk36.vbhvbmtojpskyclt   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-02</span><br></pre></td></tr></table></figure><ul><li>token æœ‰æ•ˆæœŸä¸º 1 å¤©ï¼Œè¶…æœŸåå°†ä¸èƒ½å†è¢«ç”¨æ¥ boostrap kubeletï¼Œä¸”ä¼šè¢« kube-controller-manager çš„ tokencleaner æ¸…ç†ï¼›</li><li>kube-apiserver æ¥æ”¶ kubelet çš„ bootstrap token åï¼Œå°†è¯·æ±‚çš„ user è®¾ç½®ä¸º system:bootstrap:<token>ï¼Œgroup è®¾ç½®ä¸º system:bootstrappersï¼Œåç»­å°†ä¸ºè¿™ä¸ª group è®¾ç½® ClusterRoleBindingï¼›</token></li></ul></li><li><p>æŸ¥çœ‹å„ token å…³è”çš„ Secretï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get secrets  -n kube-system|grep bootstrap-token</span></span><br><span class="line">bootstrap-token-016e9x                           bootstrap.kubernetes.io/token         7      4h25m</span><br><span class="line">bootstrap-token-4l4tcx                           bootstrap.kubernetes.io/token         7      4h25m</span><br><span class="line">bootstrap-token-64pk36                           bootstrap.kubernetes.io/token         7      4h25m</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2ã€åˆ›å»ºå’Œåˆ†å‘-kubelet-å‚æ•°é…ç½®æ–‡ä»¶"><a href="#2-2ã€åˆ›å»ºå’Œåˆ†å‘-kubelet-å‚æ•°é…ç½®æ–‡ä»¶" class="headerlink" title="2.2ã€åˆ›å»ºå’Œåˆ†å‘ kubelet å‚æ•°é…ç½®æ–‡ä»¶"></a>2.2ã€åˆ›å»ºå’Œåˆ†å‘ kubelet å‚æ•°é…ç½®æ–‡ä»¶</h4><p>ä» v1.10 å¼€å§‹ï¼Œéƒ¨åˆ† kubelet å‚æ•°éœ€åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œkubelet â€“help ä¼šæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DEPRECATED: This parameter should be <span class="built_in">set</span> via the config file specified by the Kubelet<span class="string">'s --config flag</span></span><br></pre></td></tr></table></figure><ul><li><p>åˆ›å»º kubelet å‚æ•°é…ç½®æ–‡ä»¶æ¨¡æ¿</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kubelet-config.yaml</span></span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: <span class="string">"0.0.0.0"</span></span><br><span class="line">staticPodPath: <span class="string">""</span></span><br><span class="line">syncFrequency: 1m</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">staticPodURL: <span class="string">""</span></span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 0</span><br><span class="line">rotateCertificates: <span class="literal">true</span></span><br><span class="line">serverTLSBootstrap: <span class="literal">true</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">registryPullQPS: 0</span><br><span class="line">registryBurst: 20</span><br><span class="line">eventRecordQPS: 0</span><br><span class="line">eventBurst: 20</span><br><span class="line">enableDebuggingHandlers: <span class="literal">true</span></span><br><span class="line">enableContentionProfiling: <span class="literal">true</span></span><br><span class="line">healthzPort: 10248</span><br><span class="line">healthzBindAddress: <span class="string">"172.21.16.87"</span> <span class="comment"># nodeèŠ‚ç‚¹ip</span></span><br><span class="line">clusterDomain: <span class="string">"cluster.local"</span></span><br><span class="line">clusterDNS:</span><br><span class="line">  - <span class="string">"10.254.0.2"</span></span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">nodeStatusReportFrequency: 1m</span><br><span class="line">imageMinimumGCAge: 2m</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">volumeStatsAggPeriod: 1m</span><br><span class="line">kubeletCgroups: <span class="string">""</span></span><br><span class="line">systemCgroups: <span class="string">""</span></span><br><span class="line">cgroupRoot: <span class="string">""</span></span><br><span class="line">cgroupsPerQOS: <span class="literal">true</span></span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">runtimeRequestTimeout: 10m</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">maxPods: 100</span><br><span class="line">podCIDR: <span class="string">"172.30.0.0/16"</span></span><br><span class="line">podPidsLimit: -1</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">kubeAPIQPS: 1000</span><br><span class="line">kubeAPIBurst: 2000</span><br><span class="line">serializeImagePulls: <span class="literal">false</span></span><br><span class="line">evictionHard:</span><br><span class="line">  memory.available:  <span class="string">"100Mi"</span></span><br><span class="line">nodefs.available:  <span class="string">"10%"</span></span><br><span class="line">nodefs.inodesFree: <span class="string">"5%"</span></span><br><span class="line">imagefs.available: <span class="string">"15%"</span></span><br><span class="line">evictionSoft: &#123;&#125;</span><br><span class="line">enableControllerAttachDetach: <span class="literal">true</span></span><br><span class="line">failSwapOn: <span class="literal">true</span></span><br><span class="line">containerLogMaxSize: 20Mi</span><br><span class="line">containerLogMaxFiles: 10</span><br><span class="line">systemReserved: &#123;&#125;</span><br><span class="line">kubeReserved: &#123;&#125;</span><br><span class="line">systemReservedCgroup: <span class="string">""</span></span><br><span class="line">kubeReservedCgroup: <span class="string">""</span></span><br><span class="line">enforceNodeAllocatable: [<span class="string">"pods"</span>]</span><br></pre></td></tr></table></figure><ul><li>addressï¼škubelet å®‰å…¨ç«¯å£ï¼ˆhttpsï¼Œ10250ï¼‰ç›‘å¬çš„åœ°å€ï¼Œä¸èƒ½ä¸º 127.0.0.1ï¼Œå¦åˆ™ kube-apiserverã€heapster ç­‰ä¸èƒ½è°ƒç”¨ kubelet çš„ APIï¼›</li><li>readOnlyPort=0ï¼šå…³é—­åªè¯»ç«¯å£(é»˜è®¤ 10255)ï¼Œç­‰æ•ˆä¸ºæœªæŒ‡å®šï¼›</li><li>authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åï¿½è®¿é—® 10250 ç«¯å£ï¼›</li><li>authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTP è¯ä¹¦è®¤è¯ï¼›</li><li>authentication.webhook.enabled=trueï¼šå¼€å¯ HTTPs bearer token è®¤è¯ï¼›</li><li>å¯¹äºæœªé€šè¿‡ x509 è¯ä¹¦å’Œ webhook è®¤è¯çš„è¯·æ±‚(kube-apiserver æˆ–å…¶ä»–å®¢æˆ·ç«¯)ï¼Œå°†è¢«æ‹’ç»ï¼Œæç¤º Unauthorizedï¼›</li><li>authroization.mode=Webhookï¼škubelet ä½¿ç”¨ SubjectAccessReview API æŸ¥è¯¢ kube-apiserver æŸ userã€group æ˜¯å¦å…·æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</li><li>featureGates.RotateKubeletClientCertificateã€featureGates.RotateKubeletServerCertificateï¼šè‡ªåŠ¨ rotate è¯ä¹¦ï¼Œè¯ä¹¦çš„æœ‰æ•ˆæœŸå–å†³äº kube-controller-manager çš„ â€“experimental-cluster-signing-duration å‚æ•°ï¼›</li><li>éœ€è¦ root è´¦æˆ·è¿è¡Œï¼›</li></ul></li></ul><h4 id="2-3ã€åˆ›å»ºkubelet-systemd-unit-æ–‡ä»¶"><a href="#2-3ã€åˆ›å»ºkubelet-systemd-unit-æ–‡ä»¶" class="headerlink" title="2.3ã€åˆ›å»ºkubelet systemd unit æ–‡ä»¶"></a>2.3ã€åˆ›å»ºkubelet systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kubelet.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kubelet</span><br><span class="line">ExecStart=/usr/bin/kubelet \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \</span><br><span class="line">  --cert-dir=/etc/kubernetes/ssl \</span><br><span class="line">  --cni-conf-dir=/etc/cni/net.d \</span><br><span class="line">  --container-runtime=docker \</span><br><span class="line">  --container-runtime-endpoint=unix:///var/run/dockershim.sock \</span><br><span class="line">  --root-dir=/var/lib/kubelet \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  --config=/etc/kubernetes/kubelet-config.yaml \</span><br><span class="line">  --hostname-override=172.21.16.87 \ <span class="comment"># node èŠ‚ç‚¹ip</span></span><br><span class="line">  --pod-infra-container-image=registry.cn-beijing.aliyuncs.com/images_k8s/pause-amd64:3.1 \</span><br><span class="line">  --image-pull-progress-deadline=15m \</span><br><span class="line">  --volume-plugin-dir=/var/lib/kubelet/kubelet-plugins/volume/<span class="built_in">exec</span>/ \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœè®¾ç½®äº† â€“hostname-override é€‰é¡¹ï¼Œåˆ™ kube-proxy ä¹Ÿéœ€è¦è®¾ç½®è¯¥é€‰é¡¹ï¼Œå¦åˆ™ä¼šå‡ºç°æ‰¾ä¸åˆ° Node çš„æƒ…å†µï¼›</li><li>â€“bootstrap-kubeconfigï¼šæŒ‡å‘ bootstrap kubeconfig æ–‡ä»¶ï¼Œkubelet ä½¿ç”¨è¯¥æ–‡ä»¶ä¸­çš„ç”¨æˆ·åå’Œ token å‘ kube-apiserver å‘é€ TLS Bootstrapping è¯·æ±‚ï¼›</li><li>K8S approve kubelet çš„ csr è¯·æ±‚åï¼Œåœ¨ â€“cert-dir ç›®å½•åˆ›å»ºè¯ä¹¦å’Œç§é’¥æ–‡ä»¶ï¼Œç„¶åå†™å…¥ â€“kubeconfig æ–‡ä»¶ï¼›</li><li>â€“pod-infra-container-image ä¸ä½¿ç”¨ redhat çš„ pod-infrastructure:latest é•œåƒï¼Œå®ƒä¸èƒ½å›æ”¶å®¹å™¨çš„åƒµå°¸ï¼›</li></ul><h4 id="2-4ã€Bootstrap-Token-Auth-å’Œæˆäºˆæƒé™"><a href="#2-4ã€Bootstrap-Token-Auth-å’Œæˆäºˆæƒé™" class="headerlink" title="2.4ã€Bootstrap Token Auth å’Œæˆäºˆæƒé™"></a>2.4ã€Bootstrap Token Auth å’Œæˆäºˆæƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨æ—¶æŸ¥æ‰¾ â€“kubeletconfig å‚æ•°å¯¹åº”çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ â€“bootstrap-kubeconfig æŒ‡å®šçš„ kubeconfig æ–‡ä»¶å‘ kube-apiserver å‘é€è¯ä¹¦ç­¾åè¯·æ±‚ (CSR)ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-apiserver æ”¶åˆ° CSR è¯·æ±‚åï¼Œå¯¹å…¶ä¸­çš„ Token è¿›è¡Œè®¤è¯ï¼Œè®¤è¯é€šè¿‡åå°†è¯·æ±‚çš„ user è®¾ç½®ä¸º system:bootstrap:<token>ï¼Œgroup è®¾ç½®ä¸º system:bootstrappersï¼Œè¿™ä¸€è¿‡ç¨‹ç§°ä¸º Bootstrap Token Authã€‚</token></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ª user å’Œ group æ²¡æœ‰åˆ›å»º CSR çš„æƒé™ï¼Œkubelet å¯åŠ¨å¤±è´¥ï¼Œé”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.858672   20385 reflector.go:126] k8s.io/client-go/informers/factory.go:133: Failed to list *v1beta1.RuntimeClass: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.860429   20385 reflector.go:126] k8s.io/client-go/informers/factory.go:133: Failed to list *v1beta1.CSIDriver: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.903098   20385 kubelet.go:2244] node <span class="string">"172.21.16.240"</span> not found</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.985568   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/kubelet.go:442: Failed to list *v1.Service: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.986781   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: Failed to list *v1.Pod: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.987454   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/kubelet.go:451: Failed to list *v1.Node: Unauthorized</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•æ˜¯ï¼šåˆ›å»ºä¸€ä¸ª clusterrolebindingï¼Œå°† group system:bootstrappers å’Œ clusterrole system:node-bootstrapper ç»‘å®šï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span></span><br></pre></td></tr></table></figure><h4 id="2-5ã€å¯åŠ¨-kubelet-æœåŠ¡"><a href="#2-5ã€å¯åŠ¨-kubelet-æœåŠ¡" class="headerlink" title="2.5ã€å¯åŠ¨ kubelet æœåŠ¡"></a>2.5ã€å¯åŠ¨ kubelet æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kubelet</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet &amp;&amp; systemctl status kubelet</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æœåŠ¡å‰å¿…é¡»å…ˆåˆ›å»ºå·¥ä½œç›®å½•ï¼›</li><li>å…³é—­ swap åˆ†åŒºï¼Œå¦åˆ™ kubelet ä¼šå¯åŠ¨å¤±è´¥ï¼›</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨åä½¿ç”¨ â€“bootstrap-kubeconfig å‘ kube-apiserver å‘é€ CSR è¯·æ±‚ï¼Œå½“è¿™ä¸ª CSR è¢« approve åï¼Œkube-controller-manager ä¸º kubelet åˆ›å»º TLS å®¢æˆ·ç«¯è¯ä¹¦ã€ç§é’¥å’Œ â€“kubeletconfig æ–‡ä»¶ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>æ³¨æ„</strong>ï¼škube-controller-manager éœ€è¦é…ç½® â€“cluster-signing-cert-file å’Œ â€“cluster-signing-key-file å‚æ•°ï¼Œæ‰ä¼šä¸º TLS Bootstrap åˆ›å»ºè¯ä¹¦å’Œç§é’¥ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                 CONDITION</span><br><span class="line">csr-bwcbm   82s     system:bootstrap:016e9x   Pending</span><br><span class="line">csr-gqdhf   105s    system:bootstrap:64pk36   Pending</span><br><span class="line">csr-q995g   6m57s   system:bootstrap:4l4tcx   Pending</span><br><span class="line">csr-xx45v   7m33s   system:bootstrap:4l4tcx   Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure><h4 id="2-6ã€è‡ªåŠ¨-approve-CSR-è¯·æ±‚"><a href="#2-6ã€è‡ªåŠ¨-approve-CSR-è¯·æ±‚" class="headerlink" title="2.6ã€è‡ªåŠ¨ approve CSR è¯·æ±‚"></a>2.6ã€è‡ªåŠ¨ approve CSR è¯·æ±‚</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/csr-crb.yaml</span></span><br><span class="line"><span class="comment"># Approve all CSRs for the group "system:bootstrappers"</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: auto-approve-csrs-for-group</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:bootstrappers</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own credentials</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: node-client-cert-renewal</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:nodes</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="comment"># serving cert matching its client cert.</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: approve-node-server-renewal-csr</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  resources: [<span class="string">"certificatesigningrequests/selfnodeserver"</span>]</span><br><span class="line">  verbs: [<span class="string">"create"</span>]</span><br><span class="line">---</span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own server credentials</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: node-server-cert-renewal</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:nodes</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: approve-node-server-renewal-csr</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure><ul><li>auto-approve-csrs-for-groupï¼šè‡ªåŠ¨ approve node çš„ç¬¬ä¸€æ¬¡ CSRï¼› æ³¨æ„ç¬¬ä¸€æ¬¡ CSR æ—¶ï¼Œè¯·æ±‚çš„ Group ä¸º system:bootstrappersï¼›</li><li>node-client-cert-renewalï¼šè‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ client è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodes;</li><li>node-server-cert-renewalï¼šè‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ server è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodes;</li></ul><h4 id="2-6ã€ç­‰æŸ¥çœ‹-kubelet-çš„æƒ…å†µ"><a href="#2-6ã€ç­‰æŸ¥çœ‹-kubelet-çš„æƒ…å†µ" class="headerlink" title="2.6ã€ç­‰æŸ¥çœ‹ kubelet çš„æƒ…å†µ"></a>2.6ã€ç­‰æŸ¥çœ‹ kubelet çš„æƒ…å†µ</h4><p>å¾…ä¸€æ®µæ—¶é—´(1-10 åˆ†é’Ÿ)ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„ CSR éƒ½è¢«è‡ªåŠ¨ approvedï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                   CONDITION</span><br><span class="line">csr-2t4bj   2m58s   system:node:172.21.16.240   Pending</span><br><span class="line">csr-2z2mq   4m14s   system:node:172.21.16.204   Pending</span><br><span class="line">csr-bwcbm   6m6s    system:bootstrap:016e9x     Approved,Issued</span><br><span class="line">csr-gqdhf   6m29s   system:bootstrap:64pk36     Approved,Issued</span><br><span class="line">csr-q995g   11m     system:bootstrap:4l4tcx     Approved,Issued</span><br><span class="line">csr-xx45v   12m     system:bootstrap:4l4tcx     Pending</span><br></pre></td></tr></table></figure><ul><li>æ‰€æœ‰èŠ‚ç‚¹å‡ readyï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   4m17s   v1.14.6</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   3m2s    v1.14.6</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   3s      v1.14.6</span><br></pre></td></tr></table></figure></li></ul><p>kube-controller-manager ä¸ºå„ node ç”Ÿæˆäº† kubeconfig æ–‡ä»¶å’Œå…¬ç§é’¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -l /etc/kubernetes/kubelet.kubeconfig</span></span><br><span class="line">-rw------- 1 root root 2311 Sep 16 11:31 /etc/kubernetes/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls -l /etc/kubernetes/ssl/|grep kubelet</span></span><br><span class="line">-rw------- 1 root root 1281 Sep 16 11:43 kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:43 kubelet-client-current.pem -&gt; /etc/kubernetes/ssl/kubelet-client-2019-09-16-11-43-20.pem</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆ kubelet server è¯ä¹¦ï¼›</p><h4 id="2-8ã€æ‰‹åŠ¨-approve-server-cert-csr"><a href="#2-8ã€æ‰‹åŠ¨-approve-server-cert-csr" class="headerlink" title="2.8ã€æ‰‹åŠ¨ approve server cert csr"></a>2.8ã€æ‰‹åŠ¨ approve server cert csr</h4><p>åŸºäº<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#kubelet-configuratio" target="_blank" rel="noopener">å®‰å…¨æ€§è€ƒè™‘</a>ï¼ŒCSR approving controllers ä¸ä¼šè‡ªåŠ¨ approve kubelet server è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œéœ€è¦æ‰‹åŠ¨ approveï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                   CONDITION</span><br><span class="line">csr-2t4bj   3m5s    system:node:172.21.16.240   Pending</span><br><span class="line">csr-2z2mq   4m21s   system:node:172.21.16.204   Pending</span><br><span class="line">csr-bwcbm   6m13s   system:bootstrap:016e9x     Approved,Issued</span><br><span class="line">csr-gqdhf   6m36s   system:bootstrap:64pk36     Approved,Issued</span><br><span class="line">csr-gtkrt   7s      system:node:172.21.16.87    Pending</span><br><span class="line">csr-q995g   11m     system:bootstrap:4l4tcx     Approved,Issued</span><br><span class="line">csr-xx45v   12m     system:bootstrap:4l4tcx     Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-2t4bj</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-2t4bj approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-2z2mq </span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-2z2mq approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-gtkrt</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-gtkrt approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls -l /etc/kubernetes/ssl/|grep kubelet</span></span><br><span class="line">-rw------- 1 root root 1281 Sep 16 11:43 kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:43 kubelet-client-current.pem -&gt; /etc/kubernetes/ssl/kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">-rw------- 1 root root 1305 Sep 16 11:44 kubelet-server-2019-09-16-11-44-12.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:44 kubelet-server-current.pem -&gt; /etc/kubernetes/ssl/kubelet-server-2019-09-16-11-44-12.pem</span><br></pre></td></tr></table></figure><h4 id="2-9ã€kubelet-æä¾›çš„-API-æ¥å£"><a href="#2-9ã€kubelet-æä¾›çš„-API-æ¥å£" class="headerlink" title="2.9ã€kubelet æä¾›çš„ API æ¥å£"></a>2.9ã€kubelet æä¾›çš„ API æ¥å£</h4><p>kubelet å¯åŠ¨åç›‘å¬å¤šä¸ªç«¯å£ï¼Œç”¨äºæ¥æ”¶ kube-apiserver æˆ–å…¶å®ƒå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kubelet</span></span><br><span class="line">tcp        0      0 127.0.0.1:43042         0.0.0.0:*               LISTEN      22726/kubelet       </span><br><span class="line">tcp        0      0 172.21.16.87:10248      0.0.0.0:*               LISTEN      22726/kubelet       </span><br><span class="line">tcp6       0      0 :::10250                :::*                    LISTEN      22726/kubelet</span><br></pre></td></tr></table></figure><ul><li>10248: healthz http æœåŠ¡ï¼›</li><li>10250: https æœåŠ¡ï¼Œè®¿é—®è¯¥ç«¯å£æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼ˆå³ä½¿è®¿é—® /healthz ä¹Ÿéœ€è¦ï¼‰ï¼›</li><li>æœªå¼€å¯åªè¯»ç«¯å£ 10255ï¼›</li><li>ä» K8S v1.10 å¼€å§‹ï¼Œå»é™¤äº† â€“cadvisor-port å‚æ•°ï¼ˆé»˜è®¤ 4194 ç«¯å£ï¼‰ï¼Œä¸æ”¯æŒè®¿é—® cAdvisor UI &amp; APIã€‚</li></ul><p>ç”±äºå…³é—­äº†åŒ¿åè®¤è¯ï¼ŒåŒæ—¶å¼€å¯äº† webhook æˆæƒï¼Œæ‰€æœ‰è®¿é—® 10250 ç«¯å£ https API çš„è¯·æ±‚éƒ½éœ€è¦è¢«è®¤è¯å’Œæˆæƒã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¢„å®šä¹‰çš„ ClusterRole system:kubelet-api-admin æˆäºˆè®¿é—® kubelet æ‰€æœ‰ API çš„æƒé™(kube-apiserver ä½¿ç”¨çš„ kubernetes è¯ä¹¦ User æˆäºˆäº†è¯¥æƒé™)ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kubelet-api-admin</span></span><br><span class="line">Name:         system:kubelet-api-admin</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources      Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------      -----------------  --------------  -----</span><br><span class="line">  nodes/<span class="built_in">log</span>      []                 []              [*]</span><br><span class="line">  nodes/metrics  []                 []              [*]</span><br><span class="line">  nodes/proxy    []                 []              [*]</span><br><span class="line">  nodes/spec     []                 []              [*]</span><br><span class="line">  nodes/stats    []                 []              [*]</span><br><span class="line">  nodes          []                 []              [get list watch proxy]</span><br></pre></td></tr></table></figure><h4 id="2-10ã€kubelet-api-è®¤è¯å’Œæˆæƒ"><a href="#2-10ã€kubelet-api-è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.10ã€kubelet api è®¤è¯å’Œæˆæƒ"></a>2.10ã€kubelet api è®¤è¯å’Œæˆæƒ</h4><p>kubelet é…ç½®äº†å¦‚ä¸‹è®¤è¯å‚æ•°:</p><ul><li>authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åè®¿é—® 10250 ç«¯å£ï¼›</li><li>authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTPs è¯ä¹¦è®¤è¯ï¼›</li><li>authentication.webhook.enabled=trueï¼šå¼€å¯ HTTPs bearer token è®¤è¯ï¼›</li></ul><p>åŒæ—¶é…ç½®äº†å¦‚ä¸‹æˆæƒå‚æ•°:</p><ul><li>authroization.mode=Webhookï¼šå¼€å¯ RBAC æˆæƒ</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ clientCAFile å¯¹è¯ä¹¦ç­¾åè¿›è¡Œè®¤è¯ï¼Œæˆ–è€…æŸ¥è¯¢ bearer token æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœä¸¤è€…éƒ½æ²¡é€šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚ï¼Œæç¤º Unauthorizedï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line">Unauthorized</span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem -H "Authorization: Bearer 123456"  https://172.21.16.87:10250/metrics</span></span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡è®¤è¯åï¼Œkubelet ä½¿ç”¨ SubjectAccessReview API å‘ kube-apiserver å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢è¯ä¹¦æˆ– token å¯¹åº”çš„ userã€group æ˜¯å¦æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</p><h4 id="2-11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ"><a href="#2-11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ"></a>2.11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æƒé™ä¸è¶³çš„è¯ä¹¦ï¼›</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/kube-controller-manager.pem --key /etc/kubernetes/ssl/kube-controller-manager-key.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line">Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼›</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><ul><li>â€“cacertã€â€“certã€â€“key çš„å‚æ•°å€¼å¿…é¡»æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ä¸Šé¢çš„ ./admin.pem ä¸èƒ½çœç•¥ ./ï¼Œå¦åˆ™è¿”å› 401 Unauthorizedï¼›</li></ul><h4 id="2-12ã€bear-token-è®¤è¯å’Œæˆæƒ"><a href="#2-12ã€bear-token-è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.12ã€bear token è®¤è¯å’Œæˆæƒ"></a>2.12ã€bear token è®¤è¯å’Œæˆæƒ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ª ServiceAccountï¼Œå°†å®ƒå’Œ ClusterRole system:kubelet-api-admin ç»‘å®šï¼Œä»è€Œå…·æœ‰è°ƒç”¨ kubelet API çš„æƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create sa kubelet-api-test</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding kubelet-api-test --clusterrole=system:kubelet-api-admin --serviceaccount=default:kubelet-api-test</span></span><br><span class="line"><span class="comment"># SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># TOKEN=$(kubectl describe secret $&#123;SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;TOKEN&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem -H "Authorization: Bearer $&#123;TOKEN&#125;" https://172.21.16.87:10250/metrics|head</span></span><br></pre></td></tr></table></figure><h3 id="3ã€cadvisor-å’Œ-metrics"><a href="#3ã€cadvisor-å’Œ-metrics" class="headerlink" title="3ã€cadvisor å’Œ metrics"></a>3ã€cadvisor å’Œ metrics</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cadvisor æ˜¯å†…åµŒåœ¨ kubelet äºŒè¿›åˆ¶ä¸­çš„ï¼Œç»Ÿè®¡æ‰€åœ¨èŠ‚ç‚¹å„å®¹å™¨çš„èµ„æº(CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘å¡)ä½¿ç”¨æƒ…å†µçš„æœåŠ¡ã€‚<br>æµè§ˆå™¨è®¿é—® <a href="https://172.21.16.87:10250/metrics" target="_blank" rel="noopener">https://172.21.16.87:10250/metrics</a> å’Œ <a href="https://172.21.16.87:10250/metrics/cadvisor" target="_blank" rel="noopener">https://172.21.16.87:10250/metrics/cadvisor</a> åˆ†åˆ«è¿”å› kubelet å’Œ cadvisor çš„ metricsã€‚<br><img src="https://img.xxlaila.cn/1568624798589.jpg" alt="img"></p><p><strong>æ³¨æ„:</strong></p><ul><li>kubelet.config.json è®¾ç½® authentication.anonymous.enabled ä¸º falseï¼Œä¸å…è®¸åŒ¿åè¯ä¹¦è®¿é—® 10250 çš„ https æœåŠ¡ï¼›</li><li>å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/kubeletæä¾›apiè¯·æ±‚æ¥å£/" target="_blank" rel="noopener">kubeletæä¾›apiè¯·æ±‚æ¥å£</a>ï¼Œåˆ›å»ºå’Œå¯¼å…¥ç›¸å…³è¯ä¹¦ï¼Œç„¶åè®¿é—®ä¸Šé¢çš„ 10250 ç«¯å£ï¼›</li></ul><h4 id="3-1ã€è·å–-kubelet-çš„é…ç½®"><a href="#3-1ã€è·å–-kubelet-çš„é…ç½®" class="headerlink" title="3.1ã€è·å– kubelet çš„é…ç½®"></a>3.1ã€è·å– kubelet çš„é…ç½®</h4><p>ä» kube-apiserver è·å–å„èŠ‚ç‚¹ kubelet çš„é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼›</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -sSL --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem $&#123;KUBE_APISERVER&#125;/api/v1/nodes/172.21.16.87/proxy/configz | jq  '.kubeletconfig|.kind="KubeletConfiguration"|.apiVersion="kubelet.config.k8s.io/v1beta1"'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"syncFrequency"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"fileCheckFrequency"</span>: <span class="string">"20s"</span>,</span><br><span class="line">  <span class="string">"httpCheckFrequency"</span>: <span class="string">"20s"</span>,</span><br><span class="line">  <span class="string">"address"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">  <span class="string">"port"</span>: 10250,</span><br><span class="line">  <span class="string">"rotateCertificates"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"serverTLSBootstrap"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"authentication"</span>: &#123;</span><br><span class="line">    <span class="string">"x509"</span>: &#123;</span><br><span class="line">      <span class="string">"clientCAFile"</span>: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"cacheTTL"</span>: <span class="string">"2m0s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"anonymous"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"authorization"</span>: &#123;</span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"Webhook"</span>,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"cacheAuthorizedTTL"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">      <span class="string">"cacheUnauthorizedTTL"</span>: <span class="string">"30s"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"registryPullQPS"</span>: 0,</span><br><span class="line">  <span class="string">"registryBurst"</span>: 20,</span><br><span class="line">  <span class="string">"eventRecordQPS"</span>: 0,</span><br><span class="line">  <span class="string">"eventBurst"</span>: 20,</span><br><span class="line">  <span class="string">"enableDebuggingHandlers"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"enableContentionProfiling"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"healthzPort"</span>: 10248,</span><br><span class="line">  <span class="string">"healthzBindAddress"</span>: <span class="string">"172.21.16.87"</span>,</span><br><span class="line">  <span class="string">"oomScoreAdj"</span>: -999,</span><br><span class="line">  <span class="string">"clusterDomain"</span>: <span class="string">"cluster.local"</span>,</span><br><span class="line">  <span class="string">"clusterDNS"</span>: [</span><br><span class="line">    <span class="string">"10.254.0.2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"streamingConnectionIdleTimeout"</span>: <span class="string">"4h0m0s"</span>,</span><br><span class="line">  <span class="string">"nodeStatusUpdateFrequency"</span>: <span class="string">"10s"</span>,</span><br><span class="line">  <span class="string">"nodeStatusReportFrequency"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"nodeLeaseDurationSeconds"</span>: 40,</span><br><span class="line">  <span class="string">"imageMinimumGCAge"</span>: <span class="string">"2m0s"</span>,</span><br><span class="line">  <span class="string">"imageGCHighThresholdPercent"</span>: 85,</span><br><span class="line">  <span class="string">"imageGCLowThresholdPercent"</span>: 80,</span><br><span class="line">  <span class="string">"volumeStatsAggPeriod"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"cgroupsPerQOS"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"cgroupDriver"</span>: <span class="string">"cgroupfs"</span>,</span><br><span class="line">  <span class="string">"cpuManagerPolicy"</span>: <span class="string">"none"</span>,</span><br><span class="line">  <span class="string">"cpuManagerReconcilePeriod"</span>: <span class="string">"10s"</span>,</span><br><span class="line">  <span class="string">"runtimeRequestTimeout"</span>: <span class="string">"10m0s"</span>,</span><br><span class="line">  <span class="string">"hairpinMode"</span>: <span class="string">"promiscuous-bridge"</span>,</span><br><span class="line">  <span class="string">"maxPods"</span>: 100,</span><br><span class="line">  <span class="string">"podCIDR"</span>: <span class="string">"172.30.0.0/16"</span>,</span><br><span class="line">  <span class="string">"podPidsLimit"</span>: -1,</span><br><span class="line">  <span class="string">"resolvConf"</span>: <span class="string">"/etc/resolv.conf"</span>,</span><br><span class="line">  <span class="string">"cpuCFSQuota"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"cpuCFSQuotaPeriod"</span>: <span class="string">"100ms"</span>,</span><br><span class="line">  <span class="string">"maxOpenFiles"</span>: 1000000,</span><br><span class="line">  <span class="string">"contentType"</span>: <span class="string">"application/vnd.kubernetes.protobuf"</span>,</span><br><span class="line">  <span class="string">"kubeAPIQPS"</span>: 1000,</span><br><span class="line">  <span class="string">"kubeAPIBurst"</span>: 2000,</span><br><span class="line">  <span class="string">"serializeImagePulls"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"evictionHard"</span>: &#123;</span><br><span class="line">    <span class="string">"memory.available"</span>: <span class="string">"100Mi"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"evictionPressureTransitionPeriod"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">  <span class="string">"enableControllerAttachDetach"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"makeIPTablesUtilChains"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"iptablesMasqueradeBit"</span>: 14,</span><br><span class="line">  <span class="string">"iptablesDropBit"</span>: 15,</span><br><span class="line">  <span class="string">"failSwapOn"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"containerLogMaxSize"</span>: <span class="string">"20Mi"</span>,</span><br><span class="line">  <span class="string">"containerLogMaxFiles"</span>: 10,</span><br><span class="line">  <span class="string">"configMapAndSecretChangeDetectionStrategy"</span>: <span class="string">"Watch"</span>,</span><br><span class="line">  <span class="string">"enforceNodeAllocatable"</span>: [</span><br><span class="line">    <span class="string">"pods"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"KubeletConfiguration"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"kubelet.config.k8s.io/v1beta1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4ã€éƒ¨ç½²-kube-proxy-ç»„ä»¶"><a href="#4ã€éƒ¨ç½²-kube-proxy-ç»„ä»¶" class="headerlink" title="4ã€éƒ¨ç½² kube-proxy ç»„ä»¶"></a>4ã€éƒ¨ç½² kube-proxy ç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-proxy è¿è¡Œåœ¨æ‰€æœ‰ worker èŠ‚ç‚¹ä¸Šï¼Œå®ƒç›‘å¬ apiserver ä¸­ service å’Œ endpoint çš„å˜åŒ–æƒ…å†µï¼Œåˆ›å»ºè·¯ç”±è§„åˆ™ä»¥æä¾›æœåŠ¡ IP å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p><h4 id="4-1ã€åˆ›å»º-kube-proxy-è¯ä¹¦"><a href="#4-1ã€åˆ›å»º-kube-proxy-è¯ä¹¦" class="headerlink" title="4.1ã€åˆ›å»º kube-proxy è¯ä¹¦"></a>4.1ã€åˆ›å»º kube-proxy è¯ä¹¦</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><p>CNï¼šæŒ‡å®šè¯¥è¯ä¹¦çš„ User ä¸º system:kube-proxyï¼›</p></li><li><p>é¢„å®šä¹‰çš„ RoleBinding system:node-proxier å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼›</p></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kube-proxy å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ls kube-proxy*.pem</span></span><br><span class="line">kube-proxy-key.pem  kube-proxy.pem</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#4-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="4.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>4.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials kube-proxy \</span></span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br></pre></td></tr></table></figure><ul><li>â€“embed-certs=trueï¼šå°† ca.pem å’Œ admin.pem è¯ä¹¦å†…å®¹åµŒå…¥åˆ°ç”Ÿæˆçš„ kubectl-proxy.kubeconfig æ–‡ä»¶ä¸­(ä¸åŠ æ—¶ï¼Œå†™å…¥çš„æ˜¯è¯ä¹¦æ–‡ä»¶è·¯å¾„)</li></ul><h4 id="4-3ã€åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶"><a href="#4-3ã€åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶" class="headerlink" title="4.3ã€åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶"></a>4.3ã€åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kube-proxy-config.yaml</span></span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-proxy.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">healthzBindAddress: 172.21.16.87:10256 <span class="comment">#node</span></span><br><span class="line">metricsBindAddress: 172.21.16.87:10249 <span class="comment">#node</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">clusterCIDR: 172.30.0.0/16</span><br><span class="line">hostnameOverride: 172.21.16.87 <span class="comment">#node </span></span><br><span class="line">mode: <span class="string">"ipvs"</span></span><br><span class="line">portRange: <span class="string">""</span></span><br><span class="line">kubeProxyIPTablesConfiguration:</span><br><span class="line">  masqueradeAll: <span class="literal">false</span></span><br><span class="line">kubeProxyIPVSConfiguration:</span><br><span class="line">  scheduler: rr</span><br><span class="line">  excludeCIDRs: []</span><br></pre></td></tr></table></figure><ul><li>bindAddress: ç›‘å¬åœ°å€ï¼›</li><li>clientConnection.kubeconfig: è¿æ¥ apiserver çš„ kubeconfig æ–‡ä»¶ï¼›</li><li>clusterCIDR: kube-proxy æ ¹æ® â€“cluster-cidr åˆ¤æ–­é›†ç¾¤å†…éƒ¨å’Œå¤–éƒ¨æµé‡ï¼ŒæŒ‡å®š â€“cluster-cidr æˆ– â€“masquerade-all é€‰é¡¹å kube-proxy æ‰ä¼šå¯¹è®¿é—® Service IP çš„è¯·æ±‚åš SNATï¼›</li><li>hostnameOverride: å‚æ•°å€¼å¿…é¡»ä¸ kubelet çš„å€¼ä¸€è‡´ï¼Œå¦åˆ™ kube-proxy å¯åŠ¨åä¼šæ‰¾ä¸åˆ°è¯¥ Nodeï¼Œä»è€Œä¸ä¼šåˆ›å»ºä»»ä½• ipvs è§„åˆ™ï¼›</li><li>mode: ä½¿ç”¨ ipvs æ¨¡å¼ï¼›</li></ul><h4 id="4-4ã€åˆ›å»ºkube-proxy-systemd-unit-æ–‡ä»¶"><a href="#4-4ã€åˆ›å»ºkube-proxy-systemd-unit-æ–‡ä»¶" class="headerlink" title="4.4ã€åˆ›å»ºkube-proxy systemd unit æ–‡ä»¶"></a>4.4ã€åˆ›å»ºkube-proxy systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-proxy.service </span></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-proxy</span><br><span class="line">ExecStart=/usr/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy-config.yaml \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="4-5ã€å¯åŠ¨-kube-proxy-æœåŠ¡"><a href="#4-5ã€å¯åŠ¨-kube-proxy-æœåŠ¡" class="headerlink" title="4.5ã€å¯åŠ¨ kube-proxy æœåŠ¡"></a>4.5ã€å¯åŠ¨ kube-proxy æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy &amp;&amp; systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure><h4 id="4-5ã€æ£€æŸ¥"><a href="#4-5ã€æ£€æŸ¥" class="headerlink" title="4.5ã€æ£€æŸ¥"></a>4.5ã€æ£€æŸ¥</h4><ul><li><p>æŸ¥çœ‹ç›‘å¬ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kube-prox</span></span><br><span class="line">tcp        0      0 172.21.16.87:10256      0.0.0.0:*               LISTEN      27423/kube-proxy    </span><br><span class="line">tcp        0      0 172.21.16.87:10249      0.0.0.0:*               LISTEN      27423/kube-proxy</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ ipvs è·¯ç”±è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ipvsadm -ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.254.0.1:443 rr</span><br><span class="line">  -&gt; 172.21.17.30:6443            Masq    1      0          0         </span><br><span class="line">  -&gt; 172.21.17.31:6443            Masq    1      0          0 </span><br><span class="line">  -&gt; 172.21.16.110:6443           Masq    1      0          0</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14 nodeå®‰è£…</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-v1.14å®‰è£…</title>
    <url>/2019/09/11/kubernetes-v1-14%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><h3 id="1ã€ç¯å¢ƒå‡†å¤‡"><a href="#1ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ç¯å¢ƒå‡†å¤‡"></a>1ã€ç¯å¢ƒå‡†å¤‡</h3><table><thead><tr><th>ip</th><th>type</th><th>docker</th><th>os</th><th>k8s version</th></tr></thead><tbody><tr><td>172.21.17.30</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td>v1.14.6</td></tr><tr><td>172.21.17.31</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.110</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.87</td><td>node,flanneld</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.240</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.204</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.45</td><td>vip</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr></tbody></table><h3 id="2ã€åˆå§‹åŒ–ç³»ç»Ÿ"><a href="#2ã€åˆå§‹åŒ–ç³»ç»Ÿ" class="headerlink" title="2ã€åˆå§‹åŒ–ç³»ç»Ÿ"></a>2ã€åˆå§‹åŒ–ç³»ç»Ÿ</h3><h4 id="2-1ã€å®‰è£…ä¾èµ–åŒ…"><a href="#2-1ã€å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="2.1ã€å®‰è£…ä¾èµ–åŒ…"></a>2.1ã€å®‰è£…ä¾èµ–åŒ…</h4><a id="more"></a><p>æ¯å°æœåŠ¡å™¨å‡æ“ä½œ,å…³é—­é˜²ç«å¢™,å…³é—­selinux</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y epel-release</span></span><br><span class="line"><span class="comment"># yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget</span></span><br></pre></td></tr></table></figure><h4 id="2-2ã€å…³é—­-swap-åˆ†åŒº"><a href="#2-2ã€å…³é—­-swap-åˆ†åŒº" class="headerlink" title="2.2ã€å…³é—­ swap åˆ†åŒº"></a>2.2ã€å…³é—­ swap åˆ†åŒº</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœå¼€å¯äº† swap åˆ†åŒºï¼Œkubelet ä¼šå¯åŠ¨å¤±è´¥(å¯ä»¥é€šè¿‡å°†å‚æ•° â€“fail-swap-on è®¾ç½®ä¸º false æ¥å¿½ç•¥ swap on)ï¼Œæ•…éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šå…³é—­ swap åˆ†åŒºã€‚åŒæ—¶æ³¨é‡Š /etc/fstab ä¸­ç›¸åº”çš„æ¡ç›®ï¼Œé˜²æ­¢å¼€æœºè‡ªåŠ¨æŒ‚è½½ swap åˆ†åŒºã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># swapoff -a</span></span><br><span class="line"><span class="comment"># sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab</span></span><br></pre></td></tr></table></figure><h4 id="2-3ã€åŠ è½½å†…æ ¸æ¨¡å—"><a href="#2-3ã€åŠ è½½å†…æ ¸æ¨¡å—" class="headerlink" title="2.3ã€åŠ è½½å†…æ ¸æ¨¡å—"></a>2.3ã€åŠ è½½å†…æ ¸æ¨¡å—</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># modprobe ip_vs_rr</span></span><br><span class="line"><span class="comment"># modprobe br_netfilter</span></span><br></pre></td></tr></table></figure><h5 id="2-3-1-åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨"><a href="#2-3-1-åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨" class="headerlink" title="2.3.1 åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨"></a>2.3.1 åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; /etc/rc.local  &lt;&lt; EOF</span></span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h5 id="2-3-2-ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—"><a href="#2-3-2-ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—" class="headerlink" title="2.3.2 ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—"></a>2.3.2 ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; /etc/modules-load.d/ipvs.conf &lt;&lt; EOF</span></span><br><span class="line"> ip_vs_rr</span><br><span class="line"> br_netfilter</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># systemctl enable --now systemd-modules-load.service</span></span><br></pre></td></tr></table></figure><h5 id="2-3-3-éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ"><a href="#2-3-3-éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ" class="headerlink" title="2.3.3 éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ"></a>2.3.3 éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># lsmod |egrep " ip_vs_rr|br_netfilter"</span></span><br><span class="line">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨IPVS,ä»k8sçš„1.8ç‰ˆæœ¬å¼€å§‹ï¼Œkube-proxyå¼•å…¥äº†IPVSæ¨¡å¼ï¼ŒIPVSæ¨¡å¼ä¸iptablesåŒæ ·åŸºäºNetfilterï¼Œä½†æ˜¯é‡‡ç”¨çš„<span class="built_in">hash</span>è¡¨ï¼Œå› æ­¤å½“serviceæ•°é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼Œ<span class="built_in">hash</span>æŸ¥è¡¨çš„é€Ÿåº¦ä¼˜åŠ¿å°±ä¼šæ˜¾ç°å‡ºæ¥ï¼Œä»è€Œæé«˜serviceçš„æœåŠ¡æ€§èƒ½ã€‚</span><br></pre></td></tr></table></figure><h4 id="2-4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°"><a href="#2-4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°" class="headerlink" title="2.4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°"></a>2.4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/sysctl.d/kubernetes.conf </span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line"><span class="comment"># sysctl -p /etc/sysctl.d/kubernetes.conf</span></span><br></pre></td></tr></table></figure><ul><li>å¿…é¡»å…³é—­ tcp_tw_recycleï¼Œå¦åˆ™å’Œ NAT å†²çªï¼Œä¼šå¯¼è‡´æœåŠ¡ä¸é€šï¼›</li><li>å…³é—­ IPV6ï¼Œé˜²æ­¢è§¦å‘ docker BUGï¼›</li></ul><h4 id="2-5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº"><a href="#2-5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº" class="headerlink" title="2.5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº"></a>2.5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># timedatectl set-timezone Asia/Shanghai</span></span><br><span class="line"><span class="comment"># timedatectl set-local-rtc 0</span></span><br><span class="line"><span class="comment"># systemctl restart rsyslog </span></span><br><span class="line"><span class="comment"># systemctl restart crond</span></span><br></pre></td></tr></table></figure><h4 id="2-6ã€å…³é—­æ— å…³çš„æœåŠ¡"><a href="#2-6ã€å…³é—­æ— å…³çš„æœåŠ¡" class="headerlink" title="2.6ã€å…³é—­æ— å…³çš„æœåŠ¡"></a>2.6ã€å…³é—­æ— å…³çš„æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl stop postfix &amp;&amp; systemctl disable postfix</span></span><br></pre></td></tr></table></figure><h3 id="3ã€å‡çº§å†…æ ¸"><a href="#3ã€å‡çº§å†…æ ¸" class="headerlink" title="3ã€å‡çº§å†…æ ¸"></a>3ã€å‡çº§å†…æ ¸</h3><p>ä»¥ä¸‹åœ¨masterèŠ‚ç‚¹æ“ä½œ<br>CentOS 7.x ç³»ç»Ÿè‡ªå¸¦çš„ 3.10.x å†…æ ¸å­˜åœ¨ä¸€äº› Bugsï¼Œå¯¼è‡´è¿è¡Œçš„ Dockerã€Kubernetes ä¸ç¨³å®šï¼Œä¾‹å¦‚:</p><ul><li>1.é«˜ç‰ˆæœ¬çš„ docker(1.13 ä»¥å) å¯ç”¨äº† 3.10 kernel å®éªŒæ”¯æŒçš„ kernel memory account åŠŸèƒ½(æ— æ³•å…³é—­)ï¼Œå½“èŠ‚ç‚¹å‹åŠ›å¤§å¦‚é¢‘ç¹å¯åŠ¨å’Œåœæ­¢å®¹å™¨æ—¶ä¼šå¯¼è‡´ cgroup memory leakï¼›</li><li>2.ç½‘ç»œè®¾å¤‡å¼•ç”¨è®¡æ•°æ³„æ¼ï¼Œä¼šå¯¼è‡´ç±»ä¼¼äºæŠ¥é”™ï¼šâ€kernel:unregister_netdevice: waiting for eth0 to become free. Usage count = 1â€;<br>è§£å†³æ–¹æ¡ˆå¦‚ä¸‹:</li><li>1.å‡çº§å†…æ ¸åˆ° 4.4.X ä»¥ä¸Š</li><li>2.æˆ–è€…ï¼Œæ‰‹åŠ¨ç¼–è¯‘å†…æ ¸ï¼Œdisable CONFIG_MEMCG_KMEM ç‰¹æ€§</li><li>æˆ–è€…ï¼Œå®‰è£…ä¿®å¤äº†è¯¥é—®é¢˜çš„ Docker 18.09.1 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚ä½†ç”±äº kubelet ä¹Ÿä¼šè®¾ç½® kmemï¼ˆå®ƒ vendor äº† runcï¼‰ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç¼–è¯‘ kubelet å¹¶æŒ‡å®š GOFLAGS=â€-tags=nokmemâ€</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --branch v1.14.1 --single-branch --depth 1 https://github.com/kubernetes/kubernetes</span><br><span class="line"><span class="built_in">cd</span> kubernetes</span><br><span class="line">KUBE_GIT_VERSION=v1.14.1 ./build/run.sh make kubelet GOFLAGS=<span class="string">"-tags=nokmem"</span></span><br></pre></td></tr></table></figure><h4 id="3-1ã€å†…æ ¸å‡çº§æ–¹æ³•"><a href="#3-1ã€å†…æ ¸å‡çº§æ–¹æ³•" class="headerlink" title="3.1ã€å†…æ ¸å‡çº§æ–¹æ³•"></a>3.1ã€å†…æ ¸å‡çº§æ–¹æ³•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span></span><br><span class="line"><span class="comment"># å®‰è£…å®Œæˆåæ£€æŸ¥ /boot/grub2/grub.cfg ä¸­å¯¹åº”å†…æ ¸ menuentry ä¸­æ˜¯å¦åŒ…å« initrd16 é…ç½®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å®‰è£…ä¸€æ¬¡ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yum --enablerepo=elrepo-kernel install -y kernel-lt</span></span><br><span class="line"><span class="comment"># è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨</span></span><br><span class="line"><span class="comment"># grub2-set-default 0</span></span><br></pre></td></tr></table></figure><h4 id="3-2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶"><a href="#3-2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶" class="headerlink" title="3.2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶"></a>3.2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum --enablerepo=elrepo-kernel install kernel-lt-devel-$(uname -r) kernel-lt-headers-$(uname -r)</span></span><br></pre></td></tr></table></figure><h4 id="3-3ã€å…³é—­-NUMA"><a href="#3-3ã€å…³é—­-NUMA" class="headerlink" title="3.3ã€å…³é—­ NUMA"></a>3.3ã€å…³é—­ NUMA</h4><p>åœ¨å…¶ä¸­ä¸€å°masterèŠ‚ç‚¹æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /etc/default/grub&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># åœ¨ GRUB_CMDLINE_LINUX ä¸€è¡Œæ·»åŠ  `numa=off` å‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤º</span></span><br><span class="line"><span class="comment"># cat /etc/default/grub</span></span><br><span class="line">GRUB_TIMEOUT=1</span><br><span class="line">GRUB_DISTRIBUTOR=<span class="string">"<span class="variable">$(sed 's, release .*$,,g' /etc/system-release)</span>"</span></span><br><span class="line">GRUB_DEFAULT=saved</span><br><span class="line">GRUB_DISABLE_SUBMENU=<span class="literal">true</span></span><br><span class="line">GRUB_TERMINAL=<span class="string">"serial console"</span></span><br><span class="line">GRUB_SERIAL_COMMAND=<span class="string">"serial --speed=115200"</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">"console=tty0 crashkernel=auto console=ttyS0,115200"</span></span><br><span class="line">numa=off</span><br><span class="line">GRUB_DISABLE_RECOVERY=<span class="string">"true"</span></span><br></pre></td></tr></table></figure><ul><li>é‡æ–°ç”Ÿæˆ grub2 é…ç½®æ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /boot/grub2/grub.cfg&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥"><a href="#4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥" class="headerlink" title="4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥"></a>4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºç¡®ä¿å®‰å…¨ï¼Œkubernetes ç³»ç»Ÿå„ç»„ä»¶éœ€è¦ä½¿ç”¨ x509 è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚CA (Certificate Authority) æ˜¯è‡ªç­¾åçš„æ ¹è¯ä¹¦ï¼Œç”¨æ¥ç­¾ååç»­åˆ›å»ºçš„å…¶å®ƒè¯ä¹¦ã€‚ä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl åˆ›å»ºæ‰€æœ‰è¯ä¹¦ï¼Œè¯ä¹¦å‡åœ¨ä¸€å°masterèŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œç„¶åé€šè¿‡è¿œç¨‹åˆ†å‘åˆ°å…¶ä»–çš„æœåŠ¡å™¨ä¸Šå»ã€‚</p><ul><li><strong>æ³¨æ„</strong>: æ¯ç”Ÿæˆçš„è¯ä¹¦å‡è¦è¿›è¡Œåˆ†å‘åˆ°å…¶ä»–çš„masterèŠ‚ç‚¹</li></ul><h4 id="4-1ã€å®‰è£…-cfssl-å·¥å…·é›†"><a href="#4-1ã€å®‰è£…-cfssl-å·¥å…·é›†" class="headerlink" title="4.1ã€å®‰è£… cfssl å·¥å…·é›†"></a>4.1ã€å®‰è£… cfssl å·¥å…·é›†</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -o cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="comment"># chmod +x * &amp;&amp;mv cfssl* /usr/bin/</span></span><br><span class="line"><span class="comment"># scp /usr/bin/cfssl* &#123;master-ip&#125;:/usr/bin</span></span><br></pre></td></tr></table></figure><h4 id="4-2ã€åˆ›å»ºæ ¹è¯ä¹¦-CA"><a href="#4-2ã€åˆ›å»ºæ ¹è¯ä¹¦-CA" class="headerlink" title="4.2ã€åˆ›å»ºæ ¹è¯ä¹¦ (CA)"></a>4.2ã€åˆ›å»ºæ ¹è¯ä¹¦ (CA)</h4><p>CA è¯ä¹¦æ˜¯é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹å…±äº«çš„ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ª CA è¯ä¹¦ï¼Œåç»­åˆ›å»ºçš„æ‰€æœ‰è¯ä¹¦éƒ½ç”±å®ƒç­¾åã€‚</p><h4 id="4-3ã€åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#4-3ã€åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="4.3ã€åˆ›å»ºé…ç½®æ–‡ä»¶"></a>4.3ã€åˆ›å»ºé…ç½®æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CA é…ç½®æ–‡ä»¶ç”¨äºé…ç½®æ ¹è¯ä¹¦çš„ä½¿ç”¨åœºæ™¯ (profile) å’Œå…·ä½“å‚æ•° (usageï¼Œè¿‡æœŸæ—¶é—´ã€æœåŠ¡ç«¯è®¤è¯ã€å®¢æˆ·ç«¯è®¤è¯ã€åŠ å¯†ç­‰)ï¼Œåç»­åœ¨ç­¾åå…¶å®ƒè¯ä¹¦æ—¶éœ€è¦æŒ‡å®šç‰¹å®šåœºæ™¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir k8s &amp;&amp; cd k8s#åé¢k8sç”Ÿæˆæ‰€éœ€è¦çš„è¯ä¹¦å‡åœ¨è¯¥ç›®å½•æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><ul><li><p>ca-config.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼Œç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼›</p></li><li><p>server authï¼šè¡¨ç¤º client å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ server æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p></li><li><p>client authï¼šè¡¨ç¤º server å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ client æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p></li></ul><h4 id="4-4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"><a href="#4-4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶" class="headerlink" title="4.4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"></a>4.4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</h4><ul><li><p>ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"ca"</span>: &#123;</span><br><span class="line">    <span class="string">"expiry"</span>: <span class="string">"876000h"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>CNï¼šCommon Nameï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼›</p></li><li><p>Oï¼šOrganizationï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼›</p></li><li><p>kube-apiserver å°†æå–çš„ Userã€Group ä½œä¸º RBAC æˆæƒçš„ç”¨æˆ·æ ‡è¯†ï¼›</p></li><li><p>ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span></span><br><span class="line"><span class="comment"># ls ca*</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/kubernetes/ssl &amp;&amp; cp ca*.pem ca-config.json /etc/kubernetes/ssl</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="5-éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·"><a href="#5-éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="5.éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·"></a>5.éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubectl é»˜è®¤ä» ~/.kube/config æ–‡ä»¶è¯»å– kube-apiserver åœ°å€å’Œè®¤è¯ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ‰§è¡Œ kubectl å‘½ä»¤æ—¶å¯èƒ½ä¼šå‡ºé”™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>:</li></ul><ul><li>1.å¦‚æœæ²¡æœ‰ç‰¹æ®ŠæŒ‡æ˜ï¼Œæœ¬æ–‡æ¡£çš„æ‰€æœ‰æ“ä½œå‡åœ¨ zhangjun-k8s01 èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œç„¶åè¿œç¨‹åˆ†å‘æ–‡ä»¶å’Œæ‰§è¡Œå‘½ä»¤ï¼›</li><li>2.æœ¬æ–‡æ¡£åªéœ€è¦éƒ¨ç½²ä¸€æ¬¡ï¼Œç”Ÿæˆçš„ kubeconfig æ–‡ä»¶æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥æ‹·è´åˆ°éœ€è¦æ‰§è¡Œ kubectl å‘½ä»¤çš„æœºå™¨ï¼Œé‡å‘½åä¸º ~/.kube/configï¼›</li></ul><h4 id="5-1ã€ä¸‹è½½å’Œåˆ†å‘-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#5-1ã€ä¸‹è½½å’Œåˆ†å‘-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="5.1ã€ä¸‹è½½å’Œåˆ†å‘ kubectl äºŒè¿›åˆ¶æ–‡ä»¶"></a>5.1ã€ä¸‹è½½å’Œåˆ†å‘ kubectl äºŒè¿›åˆ¶æ–‡ä»¶</h4><p>è¿™é‡Œå§æŠŠnodeå’Œmasteræ‰€éœ€è¦çš„åŒ…å‡ç»™ä¸€æ¬¡æ€§åˆ†å‘</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.14.6/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-client-linux-amd64.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># master èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp kubernetes/server/bin/&#123;apiextensions-apiserver,cloud-controller-manager,kube-apiserver,kube-controller-manager,kube-proxy,kube-scheduler,kubeadm,kubectl,kubelet,mounter&#125; &#123;master-ip&#125;:/usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># node èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; &#123;node-ip&#125;:/usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="5-2ã€åˆ›å»º-admin-è¯ä¹¦å’Œç§é’¥"><a href="#5-2ã€åˆ›å»º-admin-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="5.2ã€åˆ›å»º admin è¯ä¹¦å’Œç§é’¥"></a>5.2ã€åˆ›å»º admin è¯ä¹¦å’Œç§é’¥</h4><p>kubectl ä¸ apiserver https å®‰å…¨ç«¯å£é€šä¿¡ï¼Œapiserver å¯¹æä¾›çš„è¯ä¹¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚<br>kubectl ä½œä¸ºé›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œéœ€è¦è¢«æˆäºˆæœ€é«˜æƒé™ï¼Œè¿™é‡Œåˆ›å»ºå…·æœ‰<strong>æœ€é«˜æƒé™</strong>çš„ admin è¯ä¹¦ã€‚</p><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; admin-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>O ä¸º system:mastersï¼Œkube-apiserver æ”¶åˆ°è¯¥è¯ä¹¦åå°†è¯·æ±‚çš„ Group è®¾ç½®ä¸º system:mastersï¼›</p></li><li><p>é¢„å®šä¹‰çš„ ClusterRoleBinding cluster-admin å°† Group system:masters ä¸ Role cluster-admin ç»‘å®šï¼Œè¯¥ Role æˆäºˆæ‰€æœ‰ APIçš„æƒé™ï¼›</p></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kubectl å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json  -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></span><br><span class="line"><span class="comment"># ls admin*</span></span><br><span class="line"><span class="comment"># cp admin*.pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="5-3ã€åˆ›å»º-kubeconfig-æ–‡ä»¶"><a href="#5-3ã€åˆ›å»º-kubeconfig-æ–‡ä»¶" class="headerlink" title="5.3ã€åˆ›å»º kubeconfig æ–‡ä»¶"></a>5.3ã€åˆ›å»º kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubeconfig ä¸º kubectl çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«è®¿é—® apiserver çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¦‚ apiserver åœ°å€ã€CA è¯ä¹¦å’Œè‡ªèº«ä½¿ç”¨çš„è¯ä¹¦ï¼›</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤APIåœ°å€</span></span><br><span class="line"><span class="comment"># KUBE_APISERVER="https://172.21.16.45:8443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials admin \</span><br><span class="line">  --client-certificate=admin.pem \</span><br><span class="line">  --client-key=admin-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context kubernetes \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=admin \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=kubectl.kubeconfig</span><br></pre></td></tr></table></figure><ul><li><strong>æç¤º</strong>: åˆ†å‘<code>kubectl.kubeconfig</code>æ–‡ä»¶ï¼Œå§æ–‡ä»¶å‘½å<code>~/.kube/config</code>;</li><li>â€“certificate-authorityï¼šéªŒè¯ kube-apiserver è¯ä¹¦çš„æ ¹è¯ä¹¦ï¼›</li><li>â€“client-certificateã€â€“client-keyï¼šåˆšç”Ÿæˆçš„ admin è¯ä¹¦å’Œç§é’¥ï¼Œè¿æ¥ kube-apiserver æ—¶ä½¿ç”¨ï¼›</li><li>â€“embed-certs=trueï¼šå°† ca.pem å’Œ admin.pem è¯ä¹¦å†…å®¹åµŒå…¥åˆ°ç”Ÿæˆçš„ kubectl.kubeconfig æ–‡ä»¶ä¸­(ä¸åŠ æ—¶ï¼Œå†™å…¥çš„æ˜¯è¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼Œåç»­æ‹·è´ kubeconfig åˆ°å…¶å®ƒæœºå™¨æ—¶ï¼Œè¿˜éœ€è¦å•ç‹¬æ‹·è´è¯ä¹¦æ–‡ä»¶ï¼Œä¸æ–¹ä¾¿ã€‚)ï¼›</li></ul><h3 id="6ã€éƒ¨ç½²etcdé›†ç¾¤"><a href="#6ã€éƒ¨ç½²etcdé›†ç¾¤" class="headerlink" title="6ã€éƒ¨ç½²etcdé›†ç¾¤"></a>6ã€éƒ¨ç½²etcdé›†ç¾¤</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etcd æ˜¯åŸºäº Raft çš„åˆ†å¸ƒå¼ key-value å­˜å‚¨ç³»ç»Ÿï¼Œç”± CoreOS å¼€å‘ï¼Œå¸¸ç”¨äºæœåŠ¡å‘ç°ã€å…±äº«é…ç½®ä»¥åŠå¹¶å‘æ§åˆ¶ï¼ˆå¦‚ leader é€‰ä¸¾ã€åˆ†å¸ƒå¼é”ç­‰ï¼‰ã€‚kubernetes ä½¿ç”¨ etcd å­˜å‚¨æ‰€æœ‰è¿è¡Œæ•°æ®ã€‚</p><p>ä¸‰èŠ‚ç‚¹é«˜å¯ç”¨ etcd é›†ç¾¤çš„æ­¥éª¤ï¼š</p><ul><li>ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶ï¼›</li><li>åˆ›å»º etcd é›†ç¾¤å„èŠ‚ç‚¹çš„ x509 è¯ä¹¦ï¼Œç”¨äºåŠ å¯†å®¢æˆ·ç«¯(å¦‚ etcdctl) ä¸ etcd é›†ç¾¤ã€etcd é›†ç¾¤ä¹‹é—´çš„æ•°æ®æµï¼›</li><li>åˆ›å»º etcd çš„ systemd unit æ–‡ä»¶ï¼Œé…ç½®æœåŠ¡å‚æ•°</li><li>æ£€æŸ¥é›†ç¾¤å·¥ä½œçŠ¶æ€;</li></ul><ul><li><strong>æ³¨æ„</strong>: å‡åœ¨ä¸€å°master<code>[etcd]</code>èŠ‚ç‚¹æ“ä½œï¼Œå…¶ä»–master<code>[etcd]</code>èŠ‚ç‚¹é€šè¿‡åˆ†å‘</li></ul><h4 id="6-1ã€ä¸‹è½½å’Œåˆ†å‘-etcd-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#6-1ã€ä¸‹è½½å’Œåˆ†å‘-etcd-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="6.1ã€ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶"></a>6.1ã€ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir etcd &amp;&amp;cd etcd</span></span><br><span class="line"><span class="comment"># https://github.com/coreos/etcd/releases/download/v3.3.13/etcd-v3.3.13-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xvf etcd-v3.3.13-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># scp etcd* &#123;master-ip&#125;:/usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="6-2ã€åˆ›å»º-etcd-è¯ä¹¦å’Œç§é’¥"><a href="#6-2ã€åˆ›å»º-etcd-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="6.2ã€åˆ›å»º etcd è¯ä¹¦å’Œç§é’¥"></a>6.2ã€åˆ›å»º etcd è¯ä¹¦å’Œç§é’¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; etcd-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"172.21.17.30"</span>,</span><br><span class="line">    <span class="string">"172.21.17.31"</span>,</span><br><span class="line">    <span class="string">"172.21.16.110"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ etcd èŠ‚ç‚¹ IP æˆ–åŸŸååˆ—è¡¨ï¼Œéœ€è¦å°† etcd é›†ç¾¤çš„ä¸‰ä¸ªèŠ‚ç‚¹ IP éƒ½åˆ—åœ¨å…¶ä¸­ï¼›</li><li>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem cfssl gencert -ca=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span></span><br><span class="line"><span class="comment"># ls etcd*pem</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/etcd/ssl &amp;&amp; cp etcd*pem /etc/etcd/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="6-3ã€åˆ›å»º-etcd-çš„-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#6-3ã€åˆ›å»º-etcd-çš„-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="6.3ã€åˆ›å»º etcd çš„ systemd unit æ¨¡æ¿æ–‡ä»¶"></a>6.3ã€åˆ›å»º etcd çš„ systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/systemd/system/etcd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/data</span><br><span class="line">ExecStart=/usr/bin/etcd \</span><br><span class="line">  --data-dir=/var/lib/etcd/data \</span><br><span class="line">  --wal-dir=/var/lib/etcd/wal \</span><br><span class="line">  --name=etcd1 \<span class="comment">#æ ¹æ®èŠ‚ç‚¹åç§°è¿›è¡Œå˜åŒ–</span></span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --listen-peer-urls=https://172.21.17.30:2380 \</span><br><span class="line">  --initial-advertise-peer-urls=https://172.21.17.30:2380 \</span><br><span class="line">  --listen-client-urls=https://172.21.17.30:2379,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls=https://172.21.17.30:2379 \</span><br><span class="line">  --initial-cluster-token=etcd-cluster-0 \</span><br><span class="line">  --initial-cluster=etcd1=https://172.21.17.30:2380,etcd2=https://172.21.17.31:2380,etcd3=https://172.21.16.110:2380 \</span><br><span class="line">  --initial-cluster-state=new \</span><br><span class="line">  --auto-compaction-mode=periodic \</span><br><span class="line">  --auto-compaction-retention=1 \</span><br><span class="line">  --max-request-bytes=33554432 \</span><br><span class="line">  --quota-backend-bytes=6442450944 \</span><br><span class="line">  --heartbeat-interval=250 \</span><br><span class="line">  --election-timeout=2000</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /var/lib/etcd/&#123;data,wal&#125;</span></span><br></pre></td></tr></table></figure><ul><li>WorkingDirectoryã€â€“data-dirï¼šæŒ‡å®šå·¥ä½œç›®å½•å’Œæ•°æ®ç›®å½•ä¸º ${ETCD_DATA_DIR}ï¼Œéœ€åœ¨å¯åŠ¨æœåŠ¡å‰åˆ›å»ºè¿™ä¸ªç›®å½•ï¼›</li><li>â€“wal-dirï¼šæŒ‡å®š wal ç›®å½•ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œä¸€èˆ¬ä½¿ç”¨ SSD æˆ–è€…å’Œ â€“data-dir ä¸åŒçš„ç£ç›˜ï¼›</li><li>â€“nameï¼šæŒ‡å®šèŠ‚ç‚¹åç§°ï¼Œå½“ â€“initial-cluster-state å€¼ä¸º new æ—¶ï¼Œâ€“name çš„å‚æ•°å€¼å¿…é¡»ä½äº â€“initial-cluster åˆ—è¡¨ä¸­ï¼›</li><li>â€“cert-fileã€â€“key-fileï¼šetcd server ä¸ client é€šä¿¡æ—¶ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥ï¼›</li><li>â€“trusted-ca-fileï¼šç­¾å client è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œç”¨äºéªŒè¯ client è¯ä¹¦ï¼›</li><li>â€“peer-cert-fileã€â€“peer-key-fileï¼šetcd ä¸ peer é€šä¿¡ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥ï¼›</li><li>â€“peer-trusted-ca-fileï¼šç­¾å peer è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œç”¨äºéªŒè¯ peer è¯ä¹¦ï¼›</li></ul><h4 id="6-4ã€å¯åŠ¨-etcd-æœåŠ¡"><a href="#6-4ã€å¯åŠ¨-etcd-æœåŠ¡" class="headerlink" title="6.4ã€å¯åŠ¨ etcd æœåŠ¡"></a>6.4ã€å¯åŠ¨ etcd æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd &amp;&amp; systemctl status etcd</span></span><br></pre></td></tr></table></figure><h4 id="6-5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ"><a href="#6-5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ" class="headerlink" title="6.5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ"></a>6.5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ</h4><ul><li>ç¡®ä¿çŠ¶æ€ä¸º active (running)ï¼Œå¦åˆ™æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤åŸå› ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># journalctl -u etcd</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="6-6ã€éªŒè¯æœåŠ¡çŠ¶æ€"><a href="#6-6ã€éªŒè¯æœåŠ¡çŠ¶æ€" class="headerlink" title="6.6ã€éªŒè¯æœåŠ¡çŠ¶æ€"></a>6.6ã€éªŒè¯æœåŠ¡çŠ¶æ€</h4><p>éƒ¨ç½²å®Œ etcd é›†ç¾¤åï¼Œåœ¨ä»»ä¸€ etcd èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">    --endpoints=https://172.21.17.31:2379 \</span><br><span class="line">    --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-key.pem endpoint health</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥è¾“å‡ºå‡ä¸º healthy æ—¶è¡¨ç¤ºé›†ç¾¤æœåŠ¡æ­£å¸¸</p><h4 id="6-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#6-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="6.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>6.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCD_ENDPOINTS="https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379"</span></span><br><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">  -w table --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> endpoint status </span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|  https://172.21.17.30:2379 | 5d23ebc4382fa16f |  3.3.13 |  1.2 MB |     <span class="literal">false</span> |        83 |      58127 |</span><br><span class="line">|  https://172.21.17.31:2379 |  ceaae5134701946 |  3.3.13 |  1.2 MB |     <span class="literal">false</span> |        83 |      58127 |</span><br><span class="line">| https://172.21.16.110:2379 | 575020c8e15d3a06 |  3.3.13 |  1.2 MB |      <span class="literal">true</span> |        83 |      58128 |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></figure><ul><li>å½“å‰çš„ leader ä¸º 172.21.16.110</li></ul><h3 id="7ã€éƒ¨ç½²-flannel-ç½‘ç»œ"><a href="#7ã€éƒ¨ç½²-flannel-ç½‘ç»œ" class="headerlink" title="7ã€éƒ¨ç½² flannel ç½‘ç»œ"></a>7ã€éƒ¨ç½² flannel ç½‘ç»œ</h3><p>flannel ç½‘ç»œéƒ¨ç½²åœ¨nodeèŠ‚ç‚¹ï¼Œè¯ä¹¦åœ¨masterèŠ‚ç‚¹ç”Ÿæˆåˆ†å‘</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubernetes è¦æ±‚é›†ç¾¤å†…å„èŠ‚ç‚¹(åŒ…æ‹¬ master èŠ‚ç‚¹)èƒ½é€šè¿‡ Pod ç½‘æ®µäº’è”äº’é€šã€‚flannel ä½¿ç”¨ vxlan æŠ€æœ¯ä¸ºå„èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªå¯ä»¥äº’é€šçš„ Pod ç½‘ç»œï¼Œä½¿ç”¨çš„ç«¯å£ä¸º UDP 8472ï¼ˆéœ€è¦å¼€æ”¾è¯¥ç«¯å£ï¼‰<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flanneld ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œä» etcd è·å–é…ç½®çš„ Pod ç½‘æ®µä¿¡æ¯ï¼Œä¸ºæœ¬èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªæœªä½¿ç”¨çš„åœ°å€æ®µï¼Œç„¶ååˆ›å»º flannedl.1 ç½‘ç»œæ¥å£ï¼ˆä¹Ÿå¯èƒ½æ˜¯å…¶å®ƒåç§°ï¼Œå¦‚ flannel1 ç­‰ï¼‰<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flannel å°†åˆ†é…ç»™è‡ªå·±çš„ Pod ç½‘æ®µä¿¡æ¯å†™å…¥ /run/flannel/docker æ–‡ä»¶ï¼Œdocker åç»­ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡è®¾ç½® docker0 ç½‘æ¡¥ï¼Œä»è€Œä»è¿™ä¸ªåœ°å€æ®µä¸ºæœ¬èŠ‚ç‚¹çš„æ‰€æœ‰ Pod å®¹å™¨åˆ†é… IPã€‚</p><h4 id="7-1ã€ä¸‹è½½å’Œåˆ†å‘-flanneld-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#7-1ã€ä¸‹è½½å’Œåˆ†å‘-flanneld-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="7.1ã€ä¸‹è½½å’Œåˆ†å‘ flanneld äºŒè¿›åˆ¶æ–‡ä»¶"></a>7.1ã€ä¸‹è½½å’Œåˆ†å‘ flanneld äºŒè¿›åˆ¶æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir flannel &amp;&amp;cd flannel</span></span><br><span class="line"><span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzvf flannel-v0.11.0-linux-amd64.tar.gz -C flannel</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†å‘flanneld å¯æ‰§è¡Œæ–‡ä»¶åˆ°nodeèŠ‚ç‚¹</li></ul><h4 id="7-2ã€åˆ›å»º-flannel-è¯ä¹¦å’Œç§é’¥"><a href="#7-2ã€åˆ›å»º-flannel-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="7.2ã€åˆ›å»º flannel è¯ä¹¦å’Œç§é’¥"></a>7.2ã€åˆ›å»º flannel è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>flanneld-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; flanneld-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"flanneld"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kubectl å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld </span></span><br><span class="line"><span class="comment"># ls flanneld*pem</span></span><br><span class="line"><span class="comment"># scp flanneld*pem &#123;node-ip&#125;:/etc/flanneld/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="7-3ã€å‘-etcd-å†™å…¥é›†ç¾¤-Pod-ç½‘æ®µä¿¡æ¯"><a href="#7-3ã€å‘-etcd-å†™å…¥é›†ç¾¤-Pod-ç½‘æ®µä¿¡æ¯" class="headerlink" title="7.3ã€å‘ etcd å†™å…¥é›†ç¾¤ Pod ç½‘æ®µä¿¡æ¯"></a>7.3ã€å‘ etcd å†™å…¥é›†ç¾¤ Pod ç½‘æ®µä¿¡æ¯</h4><p><strong>æ³¨æ„</strong>ï¼šæœ¬æ­¥éª¤åªéœ€æ‰§è¡Œä¸€æ¬¡ã€‚åœ¨etcdé›†ç¾¤ä¸Šæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=flanneld.pem \</span><br><span class="line">  --key-file=flanneld-key.pem \</span><br><span class="line">  mk /kubernetes/network/config <span class="string">'&#123;"Network":"172.30.0.0/16", "SubnetLen": 21, "Backend": &#123;"Type": "vxlan"&#125;&#125;'</span></span><br></pre></td></tr></table></figure><ul><li>flanneld å½“å‰ç‰ˆæœ¬ (v0.11.0) ä¸æ”¯æŒ etcd v3ï¼Œæ•…ä½¿ç”¨ etcd v2 API å†™å…¥é…ç½® key å’Œç½‘æ®µæ•°æ®ï¼›</li><li>å†™å…¥çš„ Pod ç½‘æ®µ ${CLUSTER_CIDR} åœ°å€æ®µï¼ˆå¦‚ /16ï¼‰å¿…é¡»å°äº SubnetLenï¼Œå¿…é¡»ä¸ kube-controller-manager çš„ â€“cluster-cidr å‚æ•°å€¼ä¸€è‡´ï¼›</li></ul><h4 id="7-4ã€åˆ›å»º-flanneld-çš„-systemd-unit-æ–‡ä»¶"><a href="#7-4ã€åˆ›å»º-flanneld-çš„-systemd-unit-æ–‡ä»¶" class="headerlink" title="7.4ã€åˆ›å»º flanneld çš„ systemd unit æ–‡ä»¶"></a>7.4ã€åˆ›å»º flanneld çš„ systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/flanneld.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=etcd.service</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/flanneld \</span><br><span class="line">  -etcd-cafile=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  -etcd-certfile=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  -etcd-keyfile=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  -etcd-endpoints=https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379 \</span><br><span class="line">  -etcd-prefix=/kubernetes/network \</span><br><span class="line">  -iface=eth0 \</span><br><span class="line">  -ip-masq</span><br><span class="line">ExecStartPost=/usr/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">RequiredBy=docker.service</span><br></pre></td></tr></table></figure><ul><li>mk-docker-opts.sh è„šæœ¬å°†åˆ†é…ç»™ flanneld çš„ Pod å­ç½‘æ®µä¿¡æ¯å†™å…¥ /run/flannel/docker æ–‡ä»¶ï¼Œåç»­ docker å¯åŠ¨æ—¶ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡é…ç½® docker0 ç½‘æ¡¥ï¼›</li><li>flanneld ä½¿ç”¨ç³»ç»Ÿç¼ºçœè·¯ç”±æ‰€åœ¨çš„æ¥å£ä¸å…¶å®ƒèŠ‚ç‚¹é€šä¿¡ï¼Œå¯¹äºæœ‰å¤šä¸ªç½‘ç»œæ¥å£ï¼ˆå¦‚å†…ç½‘å’Œå…¬ç½‘ï¼‰çš„èŠ‚ç‚¹ï¼Œå¯ä»¥ç”¨ -iface å‚æ•°æŒ‡å®šé€šä¿¡æ¥å£;</li><li>flanneld è¿è¡Œæ—¶éœ€è¦ root æƒé™ï¼›</li><li>-ip-masq: flanneld ä¸ºè®¿é—® Pod ç½‘ç»œå¤–çš„æµé‡è®¾ç½® SNAT è§„åˆ™ï¼ŒåŒæ—¶å°†ä¼ é€’ç»™ Docker çš„å˜é‡ â€“ip-masqï¼ˆ/run/flannel/docker æ–‡ä»¶ä¸­ï¼‰è®¾ç½®ä¸º falseï¼Œè¿™æ · Docker å°†ä¸å†åˆ›å»º SNAT è§„åˆ™ï¼› Docker çš„ â€“ip-masq ä¸º true æ—¶ï¼Œåˆ›å»ºçš„ SNAT è§„åˆ™æ¯”è¾ƒâ€œæš´åŠ›â€ï¼šå°†æ‰€æœ‰æœ¬èŠ‚ç‚¹ Pod å‘èµ·çš„ã€è®¿é—®é docker0 æ¥å£çš„è¯·æ±‚åš SNATï¼Œè¿™æ ·è®¿é—®å…¶ä»–èŠ‚ç‚¹ Pod çš„è¯·æ±‚æ¥æº IP ä¼šè¢«è®¾ç½®ä¸º flannel.1 æ¥å£çš„ IPï¼Œå¯¼è‡´ç›®çš„ Pod çœ‹ä¸åˆ°çœŸå®çš„æ¥æº Pod IPã€‚ flanneld åˆ›å»ºçš„ SNAT è§„åˆ™æ¯”è¾ƒæ¸©å’Œï¼Œåªå¯¹è®¿é—®é Pod ç½‘æ®µçš„è¯·æ±‚åš SNATã€‚</li></ul><h4 id="7-5ã€å¯åŠ¨-flanneld-æœåŠ¡"><a href="#7-5ã€å¯åŠ¨-flanneld-æœåŠ¡" class="headerlink" title="7.5ã€å¯åŠ¨ flanneld æœåŠ¡"></a>7.5ã€å¯åŠ¨ flanneld æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable flanneld &amp;&amp; systemctl restart flanneld &amp;&amp; systemctl status flanneld</span></span><br></pre></td></tr></table></figure><h4 id="7-6ã€æ£€æŸ¥åˆ†é…ç»™å„-flanneld-çš„-Pod-ç½‘æ®µä¿¡æ¯"><a href="#7-6ã€æ£€æŸ¥åˆ†é…ç»™å„-flanneld-çš„-Pod-ç½‘æ®µä¿¡æ¯" class="headerlink" title="7.6ã€æ£€æŸ¥åˆ†é…ç»™å„ flanneld çš„ Pod ç½‘æ®µä¿¡æ¯"></a>7.6ã€æ£€æŸ¥åˆ†é…ç»™å„ flanneld çš„ Pod ç½‘æ®µä¿¡æ¯</h4><ul><li><p>æŸ¥çœ‹é›†ç¾¤ Pod ç½‘æ®µ(/16)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  get /kubernetes/network/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 21, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å·²åˆ†é…çš„ Pod å­ç½‘æ®µåˆ—è¡¨(/24):</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  ls /kubernetes/network/subnets</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">/kubernetes/network/subnets/172.30.232.0-21</span><br><span class="line">/kubernetes/network/subnets/172.30.128.0-21</span><br><span class="line">/kubernetes/network/subnets/172.30.176.0-21</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æŸä¸€ Pod ç½‘æ®µå¯¹åº”çš„èŠ‚ç‚¹ IP å’Œ flannel æ¥å£åœ°å€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  get /kubernetes/network/subnets/172.30.232.0-21</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"172.21.16.204"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"f6:50:05:5c:9a:20"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>172.30.232.0/21 è¢«åˆ†é…ç»™èŠ‚ç‚¹172.21.16.204ï¼‰ï¼›</p></li><li><p>VtepMAC ä¸º172.21.16.204èŠ‚ç‚¹çš„ flannel.1 ç½‘å¡ MAC åœ°å€ï¼›</p></li></ul><h4 id="7-7ã€æ£€æŸ¥èŠ‚ç‚¹-flannel-ç½‘ç»œä¿¡æ¯"><a href="#7-7ã€æ£€æŸ¥èŠ‚ç‚¹-flannel-ç½‘ç»œä¿¡æ¯" class="headerlink" title="7.7ã€æ£€æŸ¥èŠ‚ç‚¹ flannel ç½‘ç»œä¿¡æ¯"></a>7.7ã€æ£€æŸ¥èŠ‚ç‚¹ flannel ç½‘ç»œä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip addr show</span></span><br></pre></td></tr></table></figure><ul><li><p>flannel.1 ç½‘å¡çš„åœ°å€ä¸ºåˆ†é…çš„ Pod å­ç½‘æ®µçš„ç¬¬ä¸€ä¸ª IPï¼ˆ.0ï¼‰ï¼Œä¸”æ˜¯ /32 çš„åœ°å€ï¼›</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip route show |grep flannel.1</span></span><br><span class="line">172.30.128.0/21 via 172.30.128.0 dev flannel.1 onlink </span><br><span class="line">172.30.176.0/21 via 172.30.176.0 dev flannel.1 onlink</span><br></pre></td></tr></table></figure></li><li><p>åˆ°å…¶å®ƒèŠ‚ç‚¹ Pod ç½‘æ®µè¯·æ±‚éƒ½è¢«è½¬å‘åˆ° flannel.1 ç½‘å¡ï¼›</p></li><li><p>flanneld æ ¹æ® etcd ä¸­å­ç½‘æ®µçš„ä¿¡æ¯ï¼Œå¦‚/kubernetes/network/subnets/172.30.232.0-21 ï¼Œæ¥å†³å®šè¿›è¯·æ±‚å‘é€ç»™å“ªä¸ªèŠ‚ç‚¹çš„äº’è” IPï¼›</p></li><li><p>éªŒè¯å„èŠ‚ç‚¹èƒ½é€šè¿‡ Pod ç½‘æ®µäº’é€š</p></li></ul><h3 id="8ã€masterèŠ‚ç‚¹éƒ¨ç½²"><a href="#8ã€masterèŠ‚ç‚¹éƒ¨ç½²" class="headerlink" title="8ã€masterèŠ‚ç‚¹éƒ¨ç½²"></a>8ã€masterèŠ‚ç‚¹éƒ¨ç½²</h3><p>kubernetes master èŠ‚ç‚¹è¿è¡Œå¦‚ä¸‹ç»„ä»¶ï¼š</p><ul><li>kube-apiserver</li><li>kube-scheduler</li><li>kube-controller-manager<br>kube-apiserverã€kube-scheduler å’Œ kube-controller-manager å‡ä»¥å¤šå®ä¾‹æ¨¡å¼è¿è¡Œï¼š<br>1ã€kube-scheduler å’Œ kube-controller-manager ä¼šè‡ªåŠ¨é€‰ä¸¾äº§ç”Ÿä¸€ä¸ª leader å®ä¾‹ï¼Œå…¶å®ƒå®ä¾‹å¤„äºé˜»å¡æ¨¡å¼ï¼Œå½“ leader æŒ‚äº†åï¼Œé‡æ–°é€‰ä¸¾äº§ç”Ÿæ–°çš„ leaderï¼Œä»è€Œä¿è¯æœåŠ¡å¯ç”¨æ€§ï¼›<br>2ã€kube-apiserver æ˜¯æ— çŠ¶æ€çš„ï¼Œéœ€è¦é€šè¿‡<a href="https://xxlaila.github.io/2019/08/10/haproxy-keepalived/" target="_blank" rel="noopener">haproxy+keepalived</a>è¿›è¡Œä»£ç†è®¿é—®ï¼Œä»è€Œä¿è¯æœåŠ¡å¯ç”¨æ€§ï¼›</li></ul><h4 id="8-1ã€åˆ›å»º-kubernetes-è¯ä¹¦å’Œç§é’¥"><a href="#8-1ã€åˆ›å»º-kubernetes-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="8.1ã€åˆ›å»º kubernetes è¯ä¹¦å’Œç§é’¥"></a>8.1ã€åˆ›å»º kubernetes è¯ä¹¦å’Œç§é’¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kubernetes-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"172.21.17.30"</span>,</span><br><span class="line">    <span class="string">"172.21.17.31"</span>,</span><br><span class="line">    <span class="string">"172.21.16.110"</span>,</span><br><span class="line">    <span class="string">"172.21.16.45"</span>,</span><br><span class="line">    <span class="string">"10.254.0.1"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local."</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><p>hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ IP å’ŒåŸŸååˆ—è¡¨ï¼Œè¿™é‡Œåˆ—å‡ºäº† master èŠ‚ç‚¹ IPã€kubernetes æœåŠ¡çš„ IP å’ŒåŸŸå,ä»¥åŠVIPåœ°å€ï¼›</p></li><li><p>kubernetes æœåŠ¡ IP æ˜¯ apiserver è‡ªåŠ¨åˆ›å»ºçš„ï¼Œä¸€èˆ¬æ˜¯ â€“service-cluster-ip-range å‚æ•°æŒ‡å®šçš„ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIP,åç»­å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤è·å–ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc kubernetes</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.254.0.1   &lt;none&gt;        443/TCP   4h13m</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span></span><br><span class="line"><span class="comment"># ls kubernetes*pem</span></span><br><span class="line">kubernetes-key.pem  kubernetes.pem</span><br><span class="line"><span class="comment"># cp kubernetes*pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="8-2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶"><a href="#8-2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶" class="headerlink" title="8.2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶"></a>8.2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)</span></span><br><span class="line"><span class="comment"># cat &gt; encryption-config.yaml &lt;&lt;EOF</span></span><br><span class="line">kind: EncryptionConfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">resources:</span><br><span class="line">  - resources:</span><br><span class="line">      - secrets</span><br><span class="line">    providers:</span><br><span class="line">      - aescbc:</span><br><span class="line">          keys:</span><br><span class="line">            - name: key1</span><br><span class="line">              secret: <span class="variable">$&#123;ENCRYPTION_KEY&#125;</span></span><br><span class="line">      - identity: &#123;&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># cp encryption-config.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="8-3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"><a href="#8-3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶" class="headerlink" title="8.3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"></a>8.3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; audit-policy.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: audit.k8s.io/v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># The following requests were manually identified as high-volume and low-risk, so drop them.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">          - services</span><br><span class="line">          - services/status</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-proxy'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes</span><br><span class="line">          - nodes/status</span><br><span class="line">    userGroups:</span><br><span class="line">      - <span class="string">'system:nodes'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    namespaces:</span><br><span class="line">      - kube-system</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">      - <span class="string">'system:kube-scheduler'</span></span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:endpoint-controller'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - namespaces</span><br><span class="line">          - namespaces/status</span><br><span class="line">          - namespaces/finalize</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:apiserver'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log HPA fetching metrics.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log these read-only URLs.</span></span><br><span class="line">  - level: None</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">      - <span class="string">'/healthz*'</span></span><br><span class="line">      - /version</span><br><span class="line">      - <span class="string">'/swagger*'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log events requests.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - events</span><br><span class="line"></span><br><span class="line">  <span class="comment"># node and pod status calls from nodes are high-volume and can be large, don't log responses for expected updates from nodes</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes/status</span><br><span class="line">          - pods/status</span><br><span class="line">    users:</span><br><span class="line">      - kubelet</span><br><span class="line">      - <span class="string">'system:node-problem-detector'</span></span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:node-problem-detector'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes/status</span><br><span class="line">          - pods/status</span><br><span class="line">    userGroups:</span><br><span class="line">      - <span class="string">'system:nodes'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  <span class="comment"># deletecollection calls can be large, don't log responses for expected namespace deletions</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:namespace-controller'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - deletecollection</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span><br><span class="line">  <span class="comment"># so only log at the Metadata level.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - secrets</span><br><span class="line">          - configmaps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">        resources:</span><br><span class="line">          - tokenreviews</span><br><span class="line">  <span class="comment"># Get repsonses can be large; skip them.</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default level for known APIs</span></span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">      </span><br><span class="line">  <span class="comment"># Default level for all other requests.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp audit-policy.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="8-4ã€åˆ›å»ºåç»­è®¿é—®-metrics-server-ä½¿ç”¨çš„è¯ä¹¦"><a href="#8-4ã€åˆ›å»ºåç»­è®¿é—®-metrics-server-ä½¿ç”¨çš„è¯ä¹¦" class="headerlink" title="8.4ã€åˆ›å»ºåç»­è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦"></a>8.4ã€åˆ›å»ºåç»­è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; proxy-client-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"aggregator"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>CN åç§°éœ€è¦ä½äº kube-apiserver çš„ â€“requestheader-allowed-names å‚æ•°ä¸­ï¼Œå¦åˆ™åç»­è®¿é—® metrics æ—¶ä¼šæç¤ºæƒé™ä¸è¶³ã€‚</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem  -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes proxy-client-csr.json | cfssljson -bare proxy-client</span></span><br><span class="line"><span class="comment"># ls proxy-client*.pem</span></span><br><span class="line">proxy-client-key.pem  proxy-client.pem</span><br><span class="line"><span class="comment"># cp proxy-client*.pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="8-5ã€åˆ›å»º-kube-apiserver-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#8-5ã€åˆ›å»º-kube-apiserver-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="8.5ã€åˆ›å»º kube-apiserver systemd unit æ¨¡æ¿æ–‡ä»¶"></a>8.5ã€åˆ›å»º kube-apiserver systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-apiserver</span><br><span class="line">ExecStart=/usr/bin/kube-apiserver \</span><br><span class="line">  --advertise-address=172.21.17.30 \<span class="comment">#master èŠ‚ç‚¹çš„ip</span></span><br><span class="line">  --default-not-ready-toleration-seconds=360 \</span><br><span class="line">  --default-unreachable-toleration-seconds=360 \</span><br><span class="line">  --feature-gates=DynamicAuditing=<span class="literal">true</span> \</span><br><span class="line">  --max-mutating-requests-inflight=2000 \</span><br><span class="line">  --max-requests-inflight=4000 \</span><br><span class="line">  --default-watch-cache-size=200 \</span><br><span class="line">  --delete-collection-workers=2 \</span><br><span class="line">  --encryption-provider-config=/etc/kubernetes/encryption-config.yaml \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --etcd-servers=https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379 \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --insecure-port=0 \</span><br><span class="line">  --audit-dynamic-configuration \</span><br><span class="line">  --audit-log-maxage=15 \</span><br><span class="line">  --audit-log-maxbackup=3 \</span><br><span class="line">  --audit-log-maxsize=100 \</span><br><span class="line">  --audit-log-truncate-enabled \</span><br><span class="line">  --audit-log-path=/var/<span class="built_in">log</span>/k8s/kube-apiserver/audit.log \</span><br><span class="line">  --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span><br><span class="line">  --profiling \</span><br><span class="line">  --anonymous-auth=<span class="literal">false</span> \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --<span class="built_in">enable</span>-bootstrap-token-auth \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">"aggregator"</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --runtime-config=api/all=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">enable</span>-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,TaintNodesByCondition,Priority,DefaultTolerationSeconds,DefaultStorageClass,PersistentVolumeClaimResize,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --apiserver-count=3 \</span><br><span class="line">  --event-ttl=168h \</span><br><span class="line">  --kubelet-certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --kubelet-https=<span class="literal">true</span> \</span><br><span class="line">  --kubelet-timeout=10s \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/ssl/proxy-client.pem \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/ssl/proxy-client-key.pem \</span><br><span class="line">  --service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">  --service-node-port-range=30000-32767 \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">enable</span>-aggregator-routing=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-apiserver</span></span><br></pre></td></tr></table></figure><ul><li>â€“advertise-addressï¼šapiserver å¯¹å¤–é€šå‘Šçš„ IPï¼ˆkubernetes æœåŠ¡åç«¯èŠ‚ç‚¹ IPï¼‰ï¼›</li><li>â€“default-*-toleration-secondsï¼šè®¾ç½®èŠ‚ç‚¹å¼‚å¸¸ç›¸å…³çš„é˜ˆå€¼ï¼›</li><li>â€“max-*-requests-inflightï¼šè¯·æ±‚ç›¸å…³çš„æœ€å¤§é˜ˆå€¼ï¼›</li><li>â€“etcd-*ï¼šè®¿é—® etcd çš„è¯ä¹¦å’Œ etcd æœåŠ¡å™¨åœ°å€ï¼›</li><li>â€“experimental-encryption-provider-configï¼šæŒ‡å®šç”¨äºåŠ å¯† etcd ä¸­ secret çš„é…ç½®ï¼›</li><li>â€“bind-addressï¼š https ç›‘å¬çš„ IPï¼Œä¸èƒ½ä¸º 127.0.0.1ï¼Œå¦åˆ™å¤–ç•Œä¸èƒ½è®¿é—®å®ƒçš„å®‰å…¨ç«¯å£ 6443ï¼›</li><li>â€“secret-portï¼šhttps ç›‘å¬ç«¯å£ï¼›</li><li>â€“insecure-port=0ï¼šå…³é—­ç›‘å¬ http éå®‰å…¨ç«¯å£(8080)ï¼›</li><li>â€“tls-*-fileï¼šæŒ‡å®š apiserver ä½¿ç”¨çš„è¯ä¹¦ã€ç§é’¥å’Œ CA æ–‡ä»¶ï¼›</li><li>â€“audit-*ï¼šé…ç½®å®¡è®¡ç­–ç•¥å’Œå®¡è®¡æ—¥å¿—æ–‡ä»¶ç›¸å…³çš„å‚æ•°ï¼›</li><li>â€“client-ca-fileï¼šéªŒè¯ client (kue-controller-managerã€kube-schedulerã€kubeletã€kube-proxy ç­‰)è¯·æ±‚æ‰€å¸¦çš„è¯ä¹¦ï¼›</li><li>â€“enable-bootstrap-token-authï¼šå¯ç”¨ kubelet bootstrap çš„ token è®¤è¯ï¼›</li><li>â€“requestheader-*ï¼škube-apiserver çš„ aggregator layer ç›¸å…³çš„é…ç½®å‚æ•°ï¼Œproxy-client &amp; HPA éœ€è¦ä½¿ç”¨ï¼›</li><li>â€“requestheader-client-ca-fileï¼šç”¨äºç­¾å â€“proxy-client-cert-file å’Œ â€“proxy-client-key-file æŒ‡å®šçš„è¯ä¹¦ï¼›åœ¨å¯ç”¨äº† metric aggregator æ—¶ä½¿ç”¨ï¼›</li><li>â€“requestheader-allowed-namesï¼šä¸èƒ½ä¸ºç©ºï¼Œå€¼ä¸ºé€—å·åˆ†å‰²çš„ â€“proxy-client-cert-file è¯ä¹¦çš„ CN åç§°ï¼Œè¿™é‡Œè®¾ç½®ä¸º â€œaggregatorâ€ï¼›</li><li>â€“service-account-key-fileï¼šç­¾å ServiceAccount Token çš„å…¬é’¥æ–‡ä»¶ï¼Œkube-controller-manager çš„ â€“service-account-private-key-file æŒ‡å®šç§é’¥æ–‡ä»¶ï¼Œä¸¤è€…é…å¯¹ä½¿ç”¨ï¼›</li><li>â€“runtime-config=api/all=trueï¼š å¯ç”¨æ‰€æœ‰ç‰ˆæœ¬çš„ APIsï¼Œå¦‚ autoscaling/v2alpha1ï¼›</li><li>â€“authorization-mode=Node,RBACã€â€“anonymous-auth=falseï¼š å¼€å¯ Node å’Œ RBAC æˆæƒæ¨¡å¼ï¼Œæ‹’ç»æœªæˆæƒçš„è¯·æ±‚ï¼›</li><li>â€“enable-admission-pluginsï¼šå¯ç”¨ä¸€äº›é»˜è®¤å…³é—­çš„ pluginsï¼›</li><li>â€“allow-privilegedï¼šè¿è¡Œæ‰§è¡Œ privileged æƒé™çš„å®¹å™¨ï¼›</li><li>â€“apiserver-count=3ï¼šæŒ‡å®š apiserver å®ä¾‹çš„æ•°é‡ï¼›</li><li>â€“event-ttlï¼šæŒ‡å®š events çš„ä¿å­˜æ—¶é—´ï¼›</li><li>â€“kubelet-<em>ï¼šå¦‚æœæŒ‡å®šï¼Œåˆ™ä½¿ç”¨ https è®¿é—® kubelet APIsï¼›éœ€è¦ä¸ºè¯ä¹¦å¯¹åº”çš„ç”¨æˆ·(ä¸Šé¢ kubernetes</em>.pem è¯ä¹¦çš„ç”¨æˆ·ä¸º kubernetes) ç”¨æˆ·å®šä¹‰ RBAC è§„åˆ™ï¼Œå¦åˆ™è®¿é—® kubelet API æ—¶æç¤ºæœªæˆæƒï¼›</li><li>â€“proxy-client-*ï¼šapiserver è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦ï¼›</li><li>â€“service-cluster-ip-rangeï¼š æŒ‡å®š Service Cluster IP åœ°å€æ®µï¼›</li><li>â€“service-node-port-rangeï¼š æŒ‡å®š NodePort çš„ç«¯å£èŒƒå›´ï¼›</li><li>å¦‚æœ kube-apiserver æœºå™¨æ²¡æœ‰è¿è¡Œ kube-proxyï¼Œåˆ™è¿˜éœ€è¦æ·»åŠ  â€“enable-aggregator-routing=true å‚æ•°</li></ul><p><strong>æ³¨æ„</strong>:<br>1.requestheader-client-ca-file æŒ‡å®šçš„ CA è¯ä¹¦ï¼Œå¿…é¡»å…·æœ‰ client auth and server authï¼›<br>2.å¦‚æœ â€“requestheader-allowed-names ä¸ºç©ºï¼Œæˆ–è€… â€“proxy-client-cert-file è¯ä¹¦çš„ CN åç§°ä¸åœ¨ allowed-names ä¸­ï¼Œåˆ™åç»­æŸ¥çœ‹ node æˆ– pods çš„ metrics å¤±è´¥ï¼Œæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl top nodes</span></span><br><span class="line">Error from server (Forbidden): nodes.metrics.k8s.io is forbidden: User <span class="string">"aggregator"</span> cannot list resource <span class="string">"nodes"</span> <span class="keyword">in</span> API group <span class="string">"metrics.k8s.io"</span> at the cluster scope</span><br></pre></td></tr></table></figure><h4 id="8-6ã€å¯åŠ¨-kube-apiserver-æœåŠ¡"><a href="#8-6ã€å¯åŠ¨-kube-apiserver-æœåŠ¡" class="headerlink" title="8.6ã€å¯åŠ¨ kube-apiserver æœåŠ¡"></a>8.6ã€å¯åŠ¨ kube-apiserver æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver &amp;&amp;systemctl status kube-apiserver</span></span><br><span class="line"><span class="comment"># systemctl status kube-apiserver |grep 'Active:'</span></span><br><span class="line">   Active: active (running) since Mon 2019-09-16 14:38:31 CST; 1min 41s ago</span><br></pre></td></tr></table></figure><h4 id="8-6ã€æ‰“å°-kube-apiserver-å†™å…¥-etcd-çš„æ•°æ®"><a href="#8-6ã€æ‰“å°-kube-apiserver-å†™å…¥-etcd-çš„æ•°æ®" class="headerlink" title="8.6ã€æ‰“å° kube-apiserver å†™å…¥ etcd çš„æ•°æ®"></a>8.6ã€æ‰“å° kube-apiserver å†™å…¥ etcd çš„æ•°æ®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">    --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">    --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">    get /registry/ --prefix --keys-only</span><br></pre></td></tr></table></figure><h4 id="8-9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯"><a href="#8-9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯" class="headerlink" title="8.9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯"></a>8.9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl cluster-info</span></span><br><span class="line">Kubernetes master is running at https://172.21.16.45:8443</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get all --all-namespaces</span></span><br><span class="line">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default     service/kubernetes   ClusterIP   10.254.0.1   &lt;none&gt;        443/TCP   12m</span><br><span class="line"></span><br><span class="line"><span class="comment">#  kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused</span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused</span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œ kubectl get componentstatuses å‘½ä»¤æ—¶ï¼Œapiserver é»˜è®¤å‘ 127.0.0.1 å‘é€è¯·æ±‚ã€‚å½“ controller-managerã€scheduler ä»¥é›†ç¾¤æ¨¡å¼è¿è¡Œæ—¶ï¼Œæœ‰å¯èƒ½å’Œ kube-apiserver ä¸åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œè¿™æ—¶ controller-manager æˆ– scheduler çš„çŠ¶æ€ä¸º Unhealthyï¼Œä½†å®é™…ä¸Šå®ƒä»¬å·¥ä½œæ­£å¸¸ã€‚</li></ul><h4 id="8-10ã€æ£€æŸ¥-kube-apiserver-ç›‘å¬çš„ç«¯å£"><a href="#8-10ã€æ£€æŸ¥-kube-apiserver-ç›‘å¬çš„ç«¯å£" class="headerlink" title="8.10ã€æ£€æŸ¥ kube-apiserver ç›‘å¬çš„ç«¯å£"></a>8.10ã€æ£€æŸ¥ kube-apiserver ç›‘å¬çš„ç«¯å£</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kube</span></span><br><span class="line">tcp6       0      0 :::6443                 :::*                    LISTEN      10845/kube-apiserve</span><br></pre></td></tr></table></figure><ul><li>6443: æ¥æ”¶ https è¯·æ±‚çš„å®‰å…¨ç«¯å£ï¼Œå¯¹æ‰€æœ‰è¯·æ±‚åšè®¤è¯å’Œæˆæƒï¼›</li><li>ç”±äºå…³é—­äº†éå®‰å…¨ç«¯å£ï¼Œæ•…æ²¡æœ‰ç›‘å¬ 8080ï¼›</li></ul><h4 id="8-11ã€æˆäºˆ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™"><a href="#8-11ã€æˆäºˆ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™" class="headerlink" title="8.11ã€æˆäºˆ kube-apiserver è®¿é—® kubelet API çš„æƒé™"></a>8.11ã€æˆäºˆ kube-apiserver è®¿é—® kubelet API çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰§è¡Œ kubectl execã€runã€logs ç­‰å‘½ä»¤æ—¶ï¼Œapiserver ä¼šå°†è¯·æ±‚è½¬å‘åˆ° kubelet çš„ https ç«¯å£ã€‚è¿™é‡Œå®šä¹‰ RBAC è§„åˆ™ï¼Œæˆæƒ apiserver ä½¿ç”¨çš„è¯ä¹¦ï¼ˆkubernetes.pemï¼‰ç”¨æˆ·åï¼ˆCNï¼škuberntesï¼‰è®¿é—® kubelet API çš„æƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span><br></pre></td></tr></table></figure><h3 id="9ã€éƒ¨ç½²é«˜å¯ç”¨-kube-controller-manager"><a href="#9ã€éƒ¨ç½²é«˜å¯ç”¨-kube-controller-manager" class="headerlink" title="9ã€éƒ¨ç½²é«˜å¯ç”¨ kube-controller-manager"></a>9ã€éƒ¨ç½²é«˜å¯ç”¨ kube-controller-manager</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥é›†ç¾¤åŒ…å« 3 ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨åå°†é€šè¿‡ç«äº‰é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“ leader èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œé˜»å¡çš„èŠ‚ç‚¹å°†å†æ¬¡è¿›è¡Œé€‰ä¸¾äº§ç”Ÿæ–°çš„ leader èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚<br>ä¸ºä¿è¯é€šä¿¡å®‰å…¨ï¼Œæœ¬æ–‡æ¡£å…ˆç”Ÿæˆ x509 è¯ä¹¦å’Œç§é’¥ï¼Œkube-controller-manager åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥è¯ä¹¦ï¼š<br>1ã€ä¸ kube-apiserver çš„å®‰å…¨ç«¯å£é€šä¿¡;<br>2ã€åœ¨å®‰å…¨ç«¯å£(httpsï¼Œ10252) è¾“å‡º prometheus æ ¼å¼çš„ metricsï¼›</p><h4 id="9-1ã€åˆ›å»º-kube-controller-manager-è¯ä¹¦å’Œç§é’¥"><a href="#9-1ã€åˆ›å»º-kube-controller-manager-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="9.1ã€åˆ›å»º kube-controller-manager è¯ä¹¦å’Œç§é’¥"></a>9.1ã€åˆ›å»º kube-controller-manager è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.21.17.30"</span>,</span><br><span class="line">      <span class="string">"172.21.17.31"</span>,</span><br><span class="line">      <span class="string">"172.21.16.110"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>hosts åˆ—è¡¨åŒ…å«æ‰€æœ‰ kube-controller-manager èŠ‚ç‚¹ IPï¼›</p></li><li><p>CN å’Œ O å‡ä¸º system:kube-controller-managerï¼Œkubernetes å†…ç½®çš„ ClusterRoleBindings system:kube-controller-manager èµ‹äºˆ kube-controller-manager å·¥ä½œæ‰€éœ€çš„æƒé™ã€‚</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json   -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span><br><span class="line"><span class="comment"># ls kube-controller-manager*pem</span></span><br><span class="line">kube-controller-manager-key.pem  kube-controller-manager.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-controller-manager*pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="9-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#9-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="9.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>9.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-controller-manager ä½¿ç”¨ kubeconfig æ–‡ä»¶è®¿é—® apiserverï¼Œè¯¥æ–‡ä»¶æä¾›äº† apiserver åœ°å€ã€åµŒå…¥çš„ CA è¯ä¹¦å’Œ kube-controller-manager è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials system:kube-controller-manager \</span></span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context system:kube-controller-manager \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-controller-manager.kubeconfig /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="9-3ã€åˆ›å»º-kube-controller-manager-systemd-unitæ–‡ä»¶"><a href="#9-3ã€åˆ›å»º-kube-controller-manager-systemd-unitæ–‡ä»¶" class="headerlink" title="9.3ã€åˆ›å»º kube-controller-manager systemd unitæ–‡ä»¶"></a>9.3ã€åˆ›å»º kube-controller-manager systemd unitæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-controller-manager.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-controller-manager</span><br><span class="line">ExecStart=/usr/bin/kube-controller-manager \</span><br><span class="line">  --profiling \</span><br><span class="line">  --cluster-name=kubernetes \</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">  --kube-api-qps=1000 \</span><br><span class="line">  --kube-api-burst=2000 \</span><br><span class="line">  --leader-elect \</span><br><span class="line">  --use-service-account-credentials\</span><br><span class="line">  --concurrent-service-syncs=2 \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=10252 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span><br><span class="line">  --port=0 \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">""</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --experimental-cluster-signing-duration=876000h \</span><br><span class="line">  --horizontal-pod-autoscaler-sync-period=10s \</span><br><span class="line">  --horizontal-pod-autoscaler-use-rest-clients=<span class="literal">true</span> \</span><br><span class="line">  --concurrent-deployment-syncs=10 \</span><br><span class="line">  --concurrent-gc-syncs=30 \</span><br><span class="line">  --node-cidr-mask-size=24 \</span><br><span class="line">  --service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">  --pod-eviction-timeout=6m \</span><br><span class="line">  --terminated-pod-gc-threshold=10000 \</span><br><span class="line">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>â€“port=0ï¼šå…³é—­ç›‘å¬éå®‰å…¨ç«¯å£ï¼ˆhttpï¼‰ï¼ŒåŒæ—¶ â€“address å‚æ•°æ— æ•ˆï¼Œâ€“bind-address å‚æ•°æœ‰æ•ˆï¼›</li><li>â€“secure-port=10252ã€â€“bind-address=0.0.0.0: åœ¨æ‰€æœ‰ç½‘ç»œæ¥å£ç›‘å¬ 10252 ç«¯å£çš„ https /metrics è¯·æ±‚ï¼›</li><li>â€“kubeconfigï¼šæŒ‡å®š kubeconfig æ–‡ä»¶è·¯å¾„ï¼Œkube-controller-manager ä½¿ç”¨å®ƒè¿æ¥å’ŒéªŒè¯ kube-apiserverï¼›</li><li>â€“authentication-kubeconfig å’Œ â€“authorization-kubeconfigï¼škube-controller-manager ä½¿ç”¨å®ƒè¿æ¥ apiserverï¼Œå¯¹ client çš„è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚kube-controller-manager ä¸å†ä½¿ç”¨ â€“tls-ca-file å¯¹è¯·æ±‚ https metrics çš„ Client è¯ä¹¦è¿›è¡Œæ ¡éªŒã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™ä¸¤ä¸ª kubeconfig å‚æ•°ï¼Œåˆ™ client è¿æ¥ kube-controller-manager https ç«¯å£çš„è¯·æ±‚ä¼šè¢«æ‹’ç»(æç¤ºæƒé™ä¸è¶³)ã€‚</li><li>â€“cluster-signing-*-fileï¼šç­¾å TLS Bootstrap åˆ›å»ºçš„è¯ä¹¦ï¼›</li><li>â€“experimental-cluster-signing-durationï¼šæŒ‡å®š TLS Bootstrap è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼›</li><li>â€“root-ca-fileï¼šæ”¾ç½®åˆ°å®¹å™¨ ServiceAccount ä¸­çš„ CA è¯ä¹¦ï¼Œç”¨æ¥å¯¹ kube-apiserver çš„è¯ä¹¦è¿›è¡Œæ ¡éªŒï¼›</li><li>â€“service-account-private-key-fileï¼šç­¾å ServiceAccount ä¸­ Token çš„ç§é’¥æ–‡ä»¶ï¼Œå¿…é¡»å’Œ kube-apiserver çš„ â€“service-account-key-file æŒ‡å®šçš„å…¬é’¥æ–‡ä»¶é…å¯¹ä½¿ç”¨ï¼›</li><li>â€“service-cluster-ip-range ï¼šæŒ‡å®š Service Cluster IP ç½‘æ®µï¼Œå¿…é¡»å’Œ kube-apiserver ä¸­çš„åŒåå‚æ•°ä¸€è‡´ï¼›</li><li>â€“leader-elect=trueï¼šé›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œå¯ç”¨é€‰ä¸¾åŠŸèƒ½ï¼›è¢«é€‰ä¸º leader çš„èŠ‚ç‚¹è´Ÿè´£å¤„ç†å·¥ä½œï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ï¼›</li><li>â€“controllers=*,bootstrapsigner,tokencleanerï¼šå¯ç”¨çš„æ§åˆ¶å™¨åˆ—è¡¨ï¼Œtokencleaner ç”¨äºè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ Bootstrap tokenï¼›</li><li>â€“horizontal-pod-autoscaler-*ï¼šcustom metrics ç›¸å…³å‚æ•°ï¼Œæ”¯æŒ autoscaling/v2alpha1ï¼›</li><li>â€“tls-cert-fileã€â€“tls-private-key-fileï¼šä½¿ç”¨ https è¾“å‡º metrics æ—¶ä½¿ç”¨çš„ Server è¯ä¹¦å’Œç§˜é’¥ï¼›</li><li>â€“use-service-account-credentials=true: kube-controller-manager ä¸­å„ controller ä½¿ç”¨ serviceaccount è®¿é—® kube-apiserverï¼›</li></ul><h4 id="9-4ã€å¯åŠ¨-kube-controller-manager-æœåŠ¡"><a href="#9-4ã€å¯åŠ¨-kube-controller-manager-æœåŠ¡" class="headerlink" title="9.4ã€å¯åŠ¨ kube-controller-manager æœåŠ¡"></a>9.4ã€å¯åŠ¨ kube-controller-manager æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-controller-manager</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager &amp;&amp; systemctl status kube-controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # netstat -lnpt | grep kube-cont</span></span><br><span class="line">tcp6       0      0 :::10252                :::*                    LISTEN      8335/kube-controlle</span><br></pre></td></tr></table></figure><h4 id="9-5ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics"><a href="#9-5ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics" class="headerlink" title="9.5ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics"></a>9.5ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics</h4><p><strong>æ³¨æ„:</strong> ä»¥ä¸‹å‘½ä»¤åœ¨ kube-controller-manager èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.17.30:10252/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="9-6-kube-controller-manager-çš„æƒé™"><a href="#9-6-kube-controller-manager-çš„æƒé™" class="headerlink" title="9.6 kube-controller-manager çš„æƒé™"></a>9.6 kube-controller-manager çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusteRole system:kube-controller-manager çš„æƒé™å¾ˆå°ï¼Œåªèƒ½åˆ›å»º secretã€serviceaccount ç­‰èµ„æºå¯¹è±¡ï¼Œå„ controller çš„æƒé™åˆ†æ•£åˆ° ClusterRole system:controller:XXX ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kube-controller-manager</span></span><br><span class="line">Name:         system:kube-controller-manager</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                                  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                                  -----------------  --------------  -----</span><br><span class="line">  secrets                                    []                 []              [create delete get update]</span><br><span class="line">  endpoints                                  []                 []              [create get update]</span><br><span class="line">  serviceaccounts                            []                 []              [create get update]</span><br><span class="line">  events                                     []                 []              [create patch update]</span><br><span class="line">  tokenreviews.authentication.k8s.io         []                 []              [create]</span><br><span class="line">  subjectaccessreviews.authorization.k8s.io  []                 []              [create]</span><br><span class="line">  configmaps                                 []                 []              [get]</span><br><span class="line">  namespaces                                 []                 []              [get]</span><br><span class="line">  *.*                                        []                 []              [list watch]</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éœ€è¦åœ¨ kube-controller-manager çš„å¯åŠ¨å‚æ•°ä¸­æ·»åŠ  â€“use-service-account-credentials=true å‚æ•°ï¼Œè¿™æ · main controller ä¼šä¸ºå„ controller åˆ›å»ºå¯¹åº”çš„ ServiceAccount XXX-controllerã€‚å†…ç½®çš„ ClusterRoleBinding system:controller:XXX å°†èµ‹äºˆå„ XXX-controller ServiceAccount å¯¹åº”çš„ ClusterRole system:controller:XXX æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get clusterrole|grep controller</span></span><br><span class="line">system:controller:attachdetach-controller                              4h52m</span><br><span class="line">system:controller:certificate-controller                               4h52m</span><br><span class="line">system:controller:clusterrole-aggregation-controller                   4h52m</span><br><span class="line">system:controller:cronjob-controller                                   4h52m</span><br><span class="line">system:controller:daemon-set-controller                                4h52m</span><br><span class="line">system:controller:deployment-controller                                4h52m</span><br><span class="line">system:controller:disruption-controller                                4h52m</span><br><span class="line">system:controller:endpoint-controller                                  4h52m</span><br><span class="line">system:controller:expand-controller                                    4h52m</span><br><span class="line">system:controller:generic-garbage-collector                            4h52m</span><br><span class="line">system:controller:horizontal-pod-autoscaler                            4h52m</span><br><span class="line">system:controller:job-controller                                       4h52m</span><br><span class="line">system:controller:namespace-controller                                 4h52m</span><br><span class="line">system:controller:node-controller                                      4h52m</span><br><span class="line">system:controller:persistent-volume-binder                             4h52m</span><br><span class="line">system:controller:pod-garbage-collector                                4h52m</span><br><span class="line">system:controller:pv-protection-controller                             4h52m</span><br><span class="line">system:controller:pvc-protection-controller                            4h52m</span><br><span class="line">system:controller:replicaset-controller                                4h52m</span><br><span class="line">system:controller:replication-controller                               4h52m</span><br><span class="line">system:controller:resourcequota-controller                             4h52m</span><br><span class="line">system:controller:route-controller                                     4h52m</span><br><span class="line">system:controller:service-account-controller                           4h52m</span><br><span class="line">system:controller:service-controller                                   4h52m</span><br><span class="line">system:controller:statefulset-controller                               4h52m</span><br><span class="line">system:controller:ttl-controller                                       4h52m</span><br><span class="line">system:kube-controller-manager                                         4h52m</span><br></pre></td></tr></table></figure><ul><li>ä»¥ deployment controller ä¸ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:controller:deployment-controller</span></span><br><span class="line">Name:         system:controller:deployment-controller</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                          Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                          -----------------  --------------  -----</span><br><span class="line">  replicasets.apps                   []                 []              [create delete get list patch update watch]</span><br><span class="line">  replicasets.extensions             []                 []              [create delete get list patch update watch]</span><br><span class="line">  events                             []                 []              [create patch update]</span><br><span class="line">  pods                               []                 []              [get list update watch]</span><br><span class="line">  deployments.apps                   []                 []              [get list update watch]</span><br><span class="line">  deployments.extensions             []                 []              [get list update watch]</span><br><span class="line">  deployments.apps/finalizers        []                 []              [update]</span><br><span class="line">  deployments.apps/status            []                 []              [update]</span><br><span class="line">  deployments.extensions/finalizers  []                 []              [update]</span><br><span class="line">  deployments.extensions/status      []                 []              [update]</span><br></pre></td></tr></table></figure></li></ul><h4 id="9-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#9-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="9.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>9.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get endpoints kube-controller-manager --namespace=kube-system  -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"k8s-master-01-2.kxl_8890f530-d829-11e9-873f-fa163e5af833","leaseDurationSeconds":15,"acquireTime":"2019-09-16T06:00:15Z","renewTime":"2019-09-16T07:05:38Z","leaderTransitions":1&#125;'</span></span><br><span class="line">  creationTimestamp: <span class="string">"2019-09-16T02:27:06Z"</span></span><br><span class="line">  name: kube-controller-manager</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"25734"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager</span><br><span class="line">  uid: 7a5b872e-d829-11e9-9b67-fa163effd55b</span><br></pre></td></tr></table></figure><p>å½“å‰çš„ leader ä¸ºk8s-master-01-2èŠ‚ç‚¹ã€‚</p><p>æµ‹è¯• kube-controller-manager é›†ç¾¤çš„é«˜å¯ç”¨,åœæ‰ä¸€ä¸ªæˆ–ä¸¤ä¸ªèŠ‚ç‚¹çš„ kube-controller-manager æœåŠ¡ï¼Œè§‚å¯Ÿå…¶å®ƒèŠ‚ç‚¹çš„æ—¥å¿—ï¼Œçœ‹æ˜¯å¦è·å–äº† leader æƒé™ã€‚</p><h3 id="10ã€scheduleré›†ç¾¤"><a href="#10ã€scheduleré›†ç¾¤" class="headerlink" title="10ã€scheduleré›†ç¾¤"></a>10ã€scheduleré›†ç¾¤</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3 ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨åå°†é€šè¿‡ç«äº‰é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“ leader èŠ‚ç‚¹ä¸å¯ç”¨åï¼Œå‰©ä½™èŠ‚ç‚¹å°†å†æ¬¡è¿›è¡Œé€‰ä¸¾äº§ç”Ÿæ–°çš„ leader èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚</p><p>ä¸ºä¿è¯é€šä¿¡å®‰å…¨ï¼Œæœ¬æ–‡æ¡£å…ˆç”Ÿæˆ x509 è¯ä¹¦å’Œç§é’¥ï¼Œkube-scheduler åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥è¯ä¹¦ï¼š<br>1.ä¸ kube-apiserver çš„å®‰å…¨ç«¯å£é€šä¿¡;<br>2.åœ¨å®‰å…¨ç«¯å£(httpsï¼Œ10251) è¾“å‡º prometheus æ ¼å¼çš„ metricsï¼›</p><h4 id="10-1ã€åˆ›å»º-kube-scheduler-è¯ä¹¦å’Œç§é’¥"><a href="#10-1ã€åˆ›å»º-kube-scheduler-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="10.1ã€åˆ›å»º kube-scheduler è¯ä¹¦å’Œç§é’¥"></a>10.1ã€åˆ›å»º kube-scheduler è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.21.17.30"</span>,</span><br><span class="line">      <span class="string">"172.21.17.31"</span>,</span><br><span class="line">      <span class="string">"172.21.16.110"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>hosts åˆ—è¡¨åŒ…å«æ‰€æœ‰ kube-scheduler èŠ‚ç‚¹ IPï¼›</p></li><li><p>CN å’Œ O å‡ä¸º system:kube-schedulerï¼Œkubernetes å†…ç½®çš„ ClusterRoleBindings system:kube-scheduler å°†èµ‹äºˆ kube-scheduler å·¥ä½œæ‰€éœ€çš„æƒé™ï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ls kube-scheduler*pem</span></span><br><span class="line">kube-scheduler-key.pem  kube-scheduler.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler*pem  /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="10-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#10-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="10.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>10.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-scheduler ä½¿ç”¨ kubeconfig æ–‡ä»¶è®¿é—® apiserverï¼Œè¯¥æ–‡ä»¶æä¾›äº† apiserver åœ°å€ã€åµŒå…¥çš„ CA è¯ä¹¦å’Œ kube-scheduler è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials system:kube-scheduler \</span></span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context system:kube-scheduler \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler.kubeconfig /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="10-3ã€åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶"><a href="#10-3ã€åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶" class="headerlink" title="10.3ã€åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶"></a>10.3ã€åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;kube-scheduler.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeSchedulerConfiguration</span><br><span class="line">bindTimeoutSeconds: 600</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-scheduler.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">enableContentionProfiling: <span class="literal">false</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">hardPodAffinitySymmetricWeight: 1</span><br><span class="line">healthzBindAddress: 127.0.0.1:10251</span><br><span class="line">leaderElection:</span><br><span class="line">  leaderElect: <span class="literal">true</span></span><br><span class="line">metricsBindAddress: <span class="comment">##NODE_IP##:10251</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><ul><li>â€“kubeconfigï¼šæŒ‡å®š kubeconfig æ–‡ä»¶è·¯å¾„ï¼Œkube-scheduler ä½¿ç”¨å®ƒè¿æ¥å’ŒéªŒè¯ kube-apiserverï¼›</li><li>â€“leader-elect=trueï¼šé›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œå¯ç”¨é€‰ä¸¾åŠŸèƒ½ï¼›è¢«é€‰ä¸º leader çš„èŠ‚ç‚¹è´Ÿè´£å¤„ç†å·¥ä½œï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ï¼›</li></ul><h4 id="10-4ã€åˆ›å»º-kube-scheduler-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#10-4ã€åˆ›å»º-kube-scheduler-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="10.4ã€åˆ›å»º kube-scheduler systemd unit æ¨¡æ¿æ–‡ä»¶"></a>10.4ã€åˆ›å»º kube-scheduler systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-scheduler.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-scheduler</span><br><span class="line">ExecStart=/usr/bin/kube-scheduler \</span><br><span class="line">  --config=/etc/kubernetes/kube-scheduler.yaml \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=10259 \</span><br><span class="line">  --port=0 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">""</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="10-5ã€å¯åŠ¨-kube-scheduler-æœåŠ¡"><a href="#10-5ã€å¯åŠ¨-kube-scheduler-æœåŠ¡" class="headerlink" title="10.5ã€å¯åŠ¨ kube-scheduler æœåŠ¡"></a>10.5ã€å¯åŠ¨ kube-scheduler æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-scheduler</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler &amp;&amp; systemctl status kube-scheduler</span></span><br></pre></td></tr></table></figure><h4 id="10-6ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics"><a href="#10-6ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics" class="headerlink" title="10.6ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics"></a>10.6ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics</h4><p>kube-scheduler ç›‘å¬ 10251 å’Œ 10251 ç«¯å£ï¼š</p><ul><li>10251ï¼šæ¥æ”¶ http è¯·æ±‚ï¼Œéå®‰å…¨ç«¯å£ï¼Œä¸éœ€è¦è®¤è¯æˆæƒ</li><li>10259ï¼šæ¥æ”¶ https è¯·æ±‚ï¼Œå®‰å…¨ç«¯å£ï¼Œéœ€è¦è®¤è¯æˆæƒ</li></ul><p>ä¸¤ä¸ªæ¥å£éƒ½å¯¹å¤–æä¾› /metrics å’Œ /healthz çš„è®¿é—®ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt |grep kube-sch</span></span><br><span class="line">tcp        0      0 172.21.17.31:10251      0.0.0.0:*               LISTEN      8441/kube-scheduler </span><br><span class="line">tcp6       0      0 :::10259                :::*                    LISTEN      8441/kube-scheduler</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s http://172.21.17.30:10251/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.17.30:10259/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="10-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#10-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="10.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>10.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kubectl get endpoints kube-scheduler --namespace=kube-system  -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"k8s-master-01.kxl_2a6e0bf9-d82b-11e9-b946-fa163effd55b","leaseDurationSeconds":15,"acquireTime":"2019-09-16T06:00:28Z","renewTime":"2019-09-16T07:41:57Z","leaderTransitions":1&#125;'</span></span><br><span class="line">  creationTimestamp: <span class="string">"2019-09-16T02:38:55Z"</span></span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"29215"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-scheduler</span><br><span class="line">  uid: 20a04151-d82b-11e9-baf3-fa163e53d4c8</span><br></pre></td></tr></table></figure><h4 id="10-8-æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€"><a href="#10-8-æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€" class="headerlink" title="10.8 æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€"></a>10.8 æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get endpoints</span></span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   18h</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kuberntes v1.14</tag>
      </tags>
  </entry>
  <entry>
    <title>è·¯ç”±å™¨ç«¯å£æ˜ å°„</title>
    <url>/2019/09/10/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œh3c MSR3620è·¯ç”±å™¨åšç«¯å£æ˜ å°„åˆ°åç«¯æœåŠ¡å™¨,åŒ…å«å•ä¸ªç«¯å£å’Œç«¯å£æ®µçš„æ˜ å°„</p><a id="more"></a><h3 id="å•ä¸ªç«¯å£çš„æ˜ å°„"><a href="#å•ä¸ªç«¯å£çš„æ˜ å°„" class="headerlink" title="å•ä¸ªç«¯å£çš„æ˜ å°„"></a>å•ä¸ªç«¯å£çš„æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[router] interface GigabitEthernet0/2 å…¬ç½‘ipæ¥å£</span><br><span class="line">[router] nat server protocol tcp global å…¬ç½‘ip 80 inside å†…ç½‘ip 80</span><br></pre></td></tr></table></figure><h3 id="å¤šç«¯å£"><a href="#å¤šç«¯å£" class="headerlink" title="å¤šç«¯å£"></a>å¤šç«¯å£</h3><p>vsftpå¯ä»¥ä½¿ç”¨è¿™ä¸ª</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[router] interface GigabitEthernet0/2 å…¬ç½‘ipæ¥å£</span><br><span class="line">[router] nat server protocol tcp global current-interface 9000 9045 inside å†…ç½‘ip 9000 9045</span><br></pre></td></tr></table></figure><p><strong>å¤‡æ³¨:</strong> å¯ä»¥ä½¿ç”¨vsftpåœºæ™¯ï¼Œ<a href="https://xxlaila.github.io/2019/08/09/vsftpd%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">vsftpå®‰è£…</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>MSR3620</tag>
      </tags>
  </entry>
  <entry>
    <title>traefik httpsåº”ç”¨</title>
    <url>/2019/09/06/traefik-https%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰å·²ç»ä½¿ç”¨traefikæœåŠ¡ä½œä¸ºå…¥å£ï¼Œæµ‹è¯•å¹¶è®¿é—®äº†tomcatåº”ç”¨ï¼Œä¹‹å‰æ˜¯é€šè¿‡httpæ¥è®¿é—®çš„ï¼Œè€Œæˆ‘ä»¬åœ¨yamlæ–‡ä»¶é‡Œé¢ä¹Ÿæ·»åŠ 8443ç«¯å£ç”¨äºhttpsè®¿é—®ï¼Œåœ¨å®é™…ç¯å¢ƒä¸­æˆ‘ä»¬ä¹Ÿæ˜¯éœ€è¦httpsæ¥è¿›è¡Œè®¿é—®åº”ç”¨ï¼Œé€šè¿‡traefikå®ç°httpsï¼Œ<a href="https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">traefik httpåº”ç”¨</a></p><h3 id="æ“ä½œå®è·µ"><a href="#æ“ä½œå®è·µ" class="headerlink" title="æ“ä½œå®è·µ"></a>æ“ä½œå®è·µ</h3><ul><li>è¿™é‡Œæˆ‘ç”¨äº†å…¬å¸çš„è¯ä¹¦ï¼Œå°±æ˜¯ä¸ºäº†è´´è¿‘çœŸå®ï¼Œä¹Ÿæ»¡è¶³æµ‹è¯•éœ€æ±‚ï¼Œ</li><li>åˆ›å»ºä¸€ä¸ªsecretï¼Œä¿å­˜httpsè¯ä¹¦</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">1_test.xxlaila.cn_bundle.crt  2_test.xxlaila.cn.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create secret generic traefik-cert --from-file=1_test.xxlaila.cn_bundle.crt --from-file=2_test.xxlaila.cn.key -n kube-system</span></span><br><span class="line">secret/traefik-cert created</span><br></pre></td></tr></table></figure><p>æŠŠè¯ä¹¦æ‹·è´åˆ°k8s nodeèŠ‚ç‚¹ï¼Œå­˜æ”¾è·¯å¾„ä¸º/etc/kubernetes/certsã€‚</p><h3 id="åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®"><a href="#åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®" class="headerlink" title="åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®"></a>åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®</h3><p>traefixä¸­é…ç½®äº†æŠŠæ‰€æœ‰httpè¯·æ±‚å…¨éƒ¨rewriteä¸ºhttpsçš„è§„åˆ™ï¼Œå¹¶é…ç½®ç›¸åº”çš„è¯ä¹¦ä½ç½®</p><ul><li>traefik.toml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_test.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_test.xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line">$ kubectl create configmap traefik-conf --from-file=traefik.toml -n kube-system</span><br><span class="line">configmap/traefik-conf created</span><br></pre></td></tr></table></figure></li></ul><p>æŠŠtraefik.tomlæ–‡ä»¶æ‹·è´åˆ°k8s nodeèŠ‚ç‚¹,å­˜æ”¾è·¯å¾„ä¸º/etc/kubernetes/confã€‚</p><h3 id="é‡æ–°éƒ¨ç½²Traefix"><a href="#é‡æ–°éƒ¨ç½²Traefix" class="headerlink" title="é‡æ–°éƒ¨ç½²Traefix"></a>é‡æ–°éƒ¨ç½²Traefix</h3><p>ä¸»è¦æ˜¯è¦å…³è”åˆ›å»ºçš„secretå’ŒconfigMapï¼Œå¹¶æŒ‚è½½ç›¸å¯¹åº”çš„ä¸»æœºç›®å½•ã€‚</p><ul><li>deployment.yaml</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat deployment.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/certs"</span></span><br><span class="line">          name: <span class="string">"ssl"</span></span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/conf"</span></span><br><span class="line">          name: <span class="string">"config"</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --configFile=/etc/kubernetes/conf/traefik.toml</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f deployment.yaml </span><br><span class="line">deployment.extensions/traefik-ingress-lb configured</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•æ•ˆæœ"><a href="#æµ‹è¯•æ•ˆæœ" class="headerlink" title="æµ‹è¯•æ•ˆæœ"></a>æµ‹è¯•æ•ˆæœ</h3><p>ç™»é™†traefik-uiç•Œé¢,ç”¨åŸæœ¬httpçš„è®¿é—®ï¼Œtraefikä¼šç›´æ¥ç»™æˆ‘ä»¬é‡å®šå‘è‡³httpsã€‚<br><img src="https://img.xxlaila.cn/1567748749337.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºtraefik-uiä½¿ç”¨çš„åŸŸåä¸æ˜¯æˆ‘ä»¬è¯ä¹¦æ‰€æ”¯æŒçš„åŸŸåï¼Œæ‰€ä»¥è¿™é‡Œæç¤ºä¸å®‰å…¨ï¼Œä¿®æ”¹ä¹‹å‰åˆ›å»ºçš„ingressï¼Œä¿®æ”¹å…¶ä¸­çš„åŸŸåä¸ºæ”¯æŒè¯ä¹¦çš„åŸŸå</p><ul><li>traefik-ui.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system </span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8580</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f traefik-ui.yaml </span><br><span class="line">service/traefik-web-ui unchanged</span><br><span class="line">ingress.extensions/traefik-web-ui configured</span><br></pre></td></tr></table></figure></li></ul><p>ä¿®æ”¹hostsç‰ˆå®šçš„åŸŸåè¿›è¡Œè®¿é—®<br><img src="https://img.xxlaila.cn/1567749086159.jpg" alt="img"></p><ul><li><p>ä¿®æ”¹ä¹‹å‰éƒ¨ç½²çš„tomcatç¨‹åº</p></li><li><p>ingress-tomcat.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /test1/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line">      - path: /test2/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ingress-tomcat.yaml </span><br><span class="line">ingress.extensions/tomcat-test-web configured</span><br></pre></td></tr></table></figure></li></ul><p>è®¿é—®é“¾æ¥æµ‹è¯•<br><img src="https://img.xxlaila.cn/1567749278980.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567749309772.jpg" alt="img"></p><h3 id="å…¶ä»–éœ€æ±‚"><a href="#å…¶ä»–éœ€æ±‚" class="headerlink" title="å…¶ä»–éœ€æ±‚"></a>å…¶ä»–éœ€æ±‚</h3><p>åœ¨æˆ‘ä»¬çœŸå®çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œéœ€æ±‚è‚¯å®šæœ‰ä¸åŒçš„ï¼Œæ¯”å¦‚æˆ‘æ‰€åœ¨çš„å…¬å¸å¼€å‘ç¯å¢ƒå°±è¦åªæ˜¯httpå’Œhttpsï¼Œæµ‹è¯•ç¯å¢ƒä»¥ä¸Šçš„å°±å…¨éƒ¨å¼ºåˆ¶httpsã€‚è¿™å°±å¾—åˆ†å¼€è¿›è¡Œé…ç½®</p><h4 id="åŒæ—¶æ”¯æŒhttpå’Œhttps"><a href="#åŒæ—¶æ”¯æŒhttpå’Œhttps" class="headerlink" title="åŒæ—¶æ”¯æŒhttpå’Œhttps"></a>åŒæ—¶æ”¯æŒhttpå’Œhttps</h4><p>æŠŠhttpä¸­çš„rewriteä»£ç æ”¹æ‰</p><ul><li>traefik.toml</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_test.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_test.xxlaila.cn.key"</span></span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_dev.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_dev.xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line">[file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># rules</span></span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">      regex = <span class="string">"^http://traefix.test.xxlaila.cn/(.*)"</span></span><br><span class="line">      replacement = <span class="string">"https://traefix.test.xxlaila.cn/<span class="variable">$1</span>"</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>traefik ingressä½¿ç”¨</title>
    <url>/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><h3 id="Traefikä»‹ç»"><a href="#Traefikä»‹ç»" class="headerlink" title="Traefikä»‹ç»"></a>Traefikä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç®€å•çš„è¯´ï¼Œingresså°±æ˜¯ä»kubernetesé›†ç¾¤å¤–è®¿é—®é›†ç¾¤çš„å…¥å£ï¼Œå°†ç”¨æˆ·çš„URLè¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„serviceä¸Šã€‚Ingressç›¸å½“äºnginxã€apacheç­‰è´Ÿè½½å‡è¡¡åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬è§„åˆ™å®šä¹‰ï¼Œå³URLçš„è·¯ç”±ä¿¡æ¯ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traefikæ˜¯ä¸€æ¬¾å¼€æºçš„åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å·¥å…·ã€‚å®ƒæœ€å¤§çš„ä¼˜ç‚¹æ˜¯èƒ½å¤Ÿä¸å¸¸è§çš„å¾®æœåŠ¡ç³»ç»Ÿç›´æ¥æ•´åˆï¼Œå®ç°è‡ªåŠ¨åŒ–åŠ¨æ€é…ç½®ã€‚Traefiké€šè¿‡ä¸æ–­åœ°è·Ÿ kubernetes API æ‰“äº¤é“ï¼Œå®æ—¶çš„æ„ŸçŸ¥åç«¯ serviceã€pod ç­‰å˜åŒ–ï¼Œæ¯”å¦‚podï¼Œservice å¢åŠ ä¸å‡å°‘ç­‰ï¼›å½“å¾—åˆ°è¿™äº›å˜åŒ–ä¿¡æ¯åï¼ŒIngressè‡ªåŠ¨æ›´æ–°é…ç½®å¹¶çƒ­é‡è½½ ï¼Œè¾¾åˆ°æœåŠ¡å‘ç°çš„ä½œç”¨ã€‚</p><a id="more"></a><p>traefix æ•´ä½“æ¶æ„å›¾å¦‚ä¸‹:<br><img src="https://img.xxlaila.cn/34238937snkhfskdy8923.png" alt="img"></p><h3 id="Traefikä¸»è¦ç‰¹æ€§è¯¦è§£"><a href="#Traefikä¸»è¦ç‰¹æ€§è¯¦è§£" class="headerlink" title="Traefikä¸»è¦ç‰¹æ€§è¯¦è§£"></a>Traefikä¸»è¦ç‰¹æ€§è¯¦è§£</h3><ul><li><p>è‡ªåŠ¨ç†”æ–­</p><ul><li>åœ¨é›†ç¾¤ä¸­ï¼Œå½“æŸä¸€ä¸ªæœåŠ¡å¤§é‡å‡ºç°è¯·æ±‚é”™è¯¯ï¼Œæˆ–è€…è¯·æ±‚å“åº”æ—¶é—´è¿‡ä¹…ï¼Œæˆ–è€…è¿”å›500+é”™è¯¯çŠ¶æ€ç æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥ä¸»åŠ¨å‰”é™¤è¯¥æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸åœ¨å°†è¯·æ±‚è½¬å‘åˆ°è¯¥æœåŠ¡ä¸Šï¼Œè€Œè¿™ä¸€ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦äººå·¥æ‰§è¡Œã€‚Traefik é€šè¿‡é…ç½®å¾ˆå®¹æ˜“å°±èƒ½å¸®æˆ‘ä»¬å®ç°ï¼ŒTraefik å¯ä»¥é€šè¿‡å®šä¹‰ç­–ç•¥æ¥ä¸»åŠ¨ç†”æ–­æœåŠ¡ã€‚</li><li>NetworkErrorRatio() &gt; 0.5ï¼šç›‘æµ‹æœåŠ¡é”™è¯¯ç‡è¾¾åˆ°50%æ—¶ï¼Œç†”æ–­</li><li>LatencyAtQuantileMS(50.0) &gt; 50ï¼šç›‘æµ‹å»¶æ—¶å¤§äº50msæ—¶ï¼Œç†”æ–­</li><li>ResponseCodeRatio(500, 600, 0, 600) &gt; 0.5ï¼šç›‘æµ‹è¿”å›çŠ¶æ€ç ä¸º[500-600]åœ¨[0-600]åŒºé—´å æ¯”è¶…è¿‡50%æ—¶ï¼Œç†”æ–­</li></ul></li><li><p>è´Ÿè½½å‡è¡¡ç­–ç•¥</p><ul><li>Traefik æä¾›ä¸¤ç§è´Ÿè½½å‡è¡¡ç­–ç•¥æ”¯æŒã€‚ä¸€ç§æ˜¯ wrrï¼ˆåŠ æƒè½®è®­è°ƒåº¦ç®—æ³•ï¼‰ï¼Œä¸€ç§æ˜¯ drrï¼ˆåŠ¨æ€åŠ æƒå¾ªç¯è°ƒåº¦ç®—æ³•ï¼‰</li><li>wrræ˜¯é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œæ–°åˆ›å»ºçš„ service æƒé‡éƒ½æ˜¯ä¸€æ ·ä¸º1ï¼Œè¿™æ ·çš„è¯ï¼Œè¯·æ±‚ä¼šå¹³å‡åˆ†ç»™æ¯ä¸ªæœåŠ¡ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå¤šæ—¶å€™ä¼šå‡ºç°èµ„æºåˆ†é…ä¸å‡è¡¡çš„é—®é¢˜ï¼Œæ¯”å¦‚ç”±äºé›†ç¾¤ä¸­æ¯ä¸ªæœºå™¨é…ç½®ä¸ä¸€æ ·ï¼Œè€Œä¸”æœåŠ¡æ¶ˆè€—ä¸ä¸€æ ·ï¼Œå‡è®¾ A èµ„æºä½¿ç”¨ç‡å·²ç»å¾ˆé«˜ï¼Œè€Œ B å±äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœè¿˜æ˜¯å‡æ‘Šåˆ°æ¯ä¸ªæœåŠ¡çš„è¯ï¼Œä¼šåŠ é‡ A çš„è´Ÿè·ï¼Œè¿™æ—¶å€™å› è¯¥æœ‰ä¸€ç§ç­–ç•¥èƒ½å¤Ÿä¸»åŠ¨è¯†åˆ«å¹¶åˆ†æ‹…æ›´å¤šæµé‡åˆ° B æ‰å¯¹</li><li>drr å°±æ›´åŠ æ™ºèƒ½ï¼Œå®ƒæ˜¯ä¸€ç§åŠ¨æ€åŠ æƒè½®è®­è°ƒåº¦æ–¹å¼ï¼Œå®ƒä¼šè®°å½•ä¸€æ®µæ—¶é—´å†…è½¬å‘åˆ° A çš„è¯·æ±‚æ•°ï¼Œè·Ÿè½¬å‘åˆ° B çš„è¯·æ±‚æ•°å¯¹æ¯”ï¼Œè½¬å‘æ•°é‡å¤šï¼Œè¯´æ˜å¤„ç†é€Ÿåº¦å¿«ï¼Œå“åº”æ—¶é—´å¿«ã€‚å¦‚æœ A å¤„ç†è¯·æ±‚é€Ÿåº¦æ¯” B å¿«ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒæ•´ A çš„æƒé‡ï¼Œæ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ï¼Œå°±ä¼šè½¬å‘æ›´å¤šè¯·æ±‚ç»™ Aï¼Œç›¸åº”çš„ B çš„è½¬å‘å°±å°‘ä¸€äº›ã€‚æ•´ä¸ªè¿‡ç¨‹éƒ½åœ¨ä¸æ–­çš„è°ƒæ•´æƒé‡ï¼Œå®ç°è¯·æ±‚çš„åˆç†åˆ†é…ï¼Œä»è€Œè¾¾åˆ°èµ„æºä½¿ç”¨æœ€å¤§åŒ–</li></ul></li></ul><h3 id="éƒ¨ç½²Traefik-ingress"><a href="#éƒ¨ç½²Traefik-ingress" class="headerlink" title="éƒ¨ç½²Traefik ingress"></a>éƒ¨ç½²Traefik ingress</h3><ul><li><p>åˆ›å»ºingress-rbac.yamlï¼Œå°†ç”¨äºservice accountéªŒè¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat ingress-rbac.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: ingress</span><br><span class="line">    namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºDepeloymentéƒ¨ç½²traefikï¼Œå¦‚æ–‡ä»¶åä¸ºdeployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>æ³¨æ„</strong>: æˆ‘ä»¬è¿™é‡Œç”¨çš„æ˜¯Deployç±»å‹ï¼Œæ²¡æœ‰é™å®šè¯¥podè¿è¡Œåœ¨å“ªä¸ªä¸»æœºä¸Šã€‚Traefikçš„ç«¯å£æ˜¯8580ã€‚</li></ul><ul><li>ç¼–å†™Traefik UIçš„ingresséƒ¨ç½²æ–‡ä»¶ï¼Œå¦‚æ–‡ä»¶åä¸ºtraefik-ui.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system <span class="comment">#å¢åŠ è¡Œ</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8580</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><ul><li><code>backend</code>ä¸­è¦é…ç½®default namespaceä¸­å¯åŠ¨çš„serviceåå­—ã€‚</li><li><code>path</code>å°±æ˜¯URLåœ°å€åçš„è·¯å¾„ï¼Œå¦‚<code>traefik.frontend.io/path</code>ï¼Œserviceå°†ä¼šæ¥å—pathè¿™ä¸ªè·¯å¾„</li><li><code>host</code>æœ€å¥½ä½¿ç”¨service-name.filed1.filed2.domain-nameè¿™ç§ç±»ä¼¼ä¸»æœºåç§°çš„å‘½åæ–¹å¼ï¼Œæ–¹ä¾¿åŒºåˆ†æœåŠ¡ã€‚</li></ul><ul><li><strong>é€¼é€¼ä¸€ä¸‹</strong>: ç›®å‰æˆ‘æ‰€åœ¨çš„å…¬å¸åç«¯å¾®æœåŠ¡100+ï¼Œå‰ç«¯60+ï¼Œå¦‚æœç”¨ä¼ ç»Ÿnginxçš„localæ¥åŒ¹é…ï¼Œä¼°è®¡è¦å†™æ­»äººï¼Œè€Œä¸”å¯¹äºè¿ç»´è‡ªåŠ¨åŒ–æ¥ä¹Ÿä¸æ˜¯å¾ˆå¥½åšï¼Œå†åˆ™æ˜¯å‡ºäº†é—®é¢˜ä¹Ÿè¿˜è¦å»çœ‹ä¸€ä¸‹æ˜¯å“ªä¸ªåº”ç”¨ï¼›æˆ‘ä»¬ç›®å‰æ˜¯é€šè¿‡æ¯ä¸ªæœåŠ¡æ¯ä¸€ä¸ªåŸŸåï¼ŒåŸŸåæ˜¯æ ¹æ®æœåŠ¡åæ¥è‡ªåŠ¨ç”Ÿæˆï¼Œé™¤äº†å‡ ä¸ªç‰¹å®šå¯¹å¤–å…¬å¼€çš„æ˜¯ç‰¹åˆ¶çš„åŸŸåï¼Œå…¶ä»–çš„å‡é‡‡ç”¨è¿™ç§æœºåˆ¶ï¼Œå½“æœ‰é—®é¢˜çš„æ—¶å€™ï¼Œä¸€ä¸‹å°±èƒ½åˆ¤æ–­å‡ºé‚£é‡Œå‡ºé—®é¢˜ï¼Œå¾ˆå¥½å®šä½ï¼Œæœ‰åŸŸåæœ‰ç‰¹æ®Šé…ç½®çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å•ç‹¬çš„è¿›è¡Œè®¾ç½®ï¼Œä½†æ˜¯æˆªæ­¢ç›®å‰ä¸¤å¹´å¤šæ¥ï¼Œè¿ç»´æ‹’ç»è¿™ç§ç‰¹æ®Šéœ€æ±‚(æœ‰è¿˜æœ‰ï¼Œå¾ˆå°‘ï¼Œåªæœ‰é‚£ä¹ˆä¸¤ä¸‰ä¸ª)</li></ul><ul><li><p>é…ç½®å®Œæˆåå°±å¯ä»¥å¯åŠ¨treafik ingressäº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line">deployment.extensions/traefik-ingress-lb created</span><br><span class="line">serviceaccount/ingress created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/ingress created</span><br><span class="line">service/traefik-web-ui created</span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system | grep traefik</span></span><br><span class="line"></span><br><span class="line">traefik-ingress-lb-5d7f658cfd-4vkjc     1/1     Running   0          29m</span><br><span class="line">traefik-ingress-lb-5d7f658cfd-7sszp     1/1     Running   0          19m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get ingress -o wide --all-namespaces </span></span><br><span class="line">NAMESPACE     NAME                HOSTS                ADDRESS   PORTS   AGE</span><br><span class="line">kube-system   traefik-web-ui      traefik.xxlaila.io             80      29m</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨æµè§ˆå™¨ç»‘å®šhostsåŸŸåè§£æï¼Œnodeçš„ipåœ°å€ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥traefik.xxlaila.ioå³å¯è®¿é—®äº†<br><img src="https://img.xxlaila.cn/1567676343800.jpg" alt="img"></p><p>å·¦ä¾§è“è‰²éƒ¨åˆ†åˆ—å‡ºçš„æ˜¯æ‰€æœ‰çš„å‰ç«¯(frontends)ï¼Œå³ä¾§ç»¿è‰²éƒ¨åˆ†æ˜¯æ‰€æœ‰çš„åç«¯(backend)ã€‚</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ä¸‹é¢æ¨¡æ‹Ÿéƒ¨ç½²ä¸€ä¸ªç¨‹åºï¼Œä»¥Nginx ä¸ºä¾‹ï¼Œå¹¶ä½¿ç”¨drråŠ¨æ€è½®è®­åŠ æƒç­–ç•¥ã€‚</p><ul><li><p>nginx-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.15.5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-service</span><br><span class="line">  annotations:</span><br><span class="line">    traefik.ingress.kubernetes.io/load-balancer-method: drr</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx-service</span><br><span class="line">        namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-pod</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: k8s.nginx.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx-service</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºnginx</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f nginx-deployment.yaml </span></span><br><span class="line">deployment.apps/nginx-pod created</span><br><span class="line">service/nginx-service created</span><br><span class="line">ingress.extensions/nginx-ingress created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰€æœ‰è®¿é—®è¿™äº›åœ°å€çš„æµé‡éƒ½ä¼šå‘é€ç»™172.16.0.180è¿™å°ä¸»æœºï¼Œå°±æ˜¯æˆ‘ä»¬å¯åŠ¨traefikçš„ä¸»æœºã€‚Traefikä¼šè§£æhttpè¯·æ±‚headeré‡Œçš„Hostå‚æ•°å°†æµé‡è½¬å‘ç»™Ingressé…ç½®é‡Œçš„ç›¸åº”serviceã€‚<br><img src="https://img.xxlaila.cn/1567676984150.jpg" alt="img"></p><p>å®¢æˆ·ç«¯ç»‘å®šhostï¼Œæµè§ˆå™¨è¿›è¡Œè®¿é—®: <a href="http://k8s.nginx.com" target="_blank" rel="noopener">http://k8s.nginx.com</a><br><img src="https://img.xxlaila.cn/1567677018297.jpg" alt="img"></p><p>åœ¨K8sé›†ç¾¤èŠ‚ç‚¹ä¸Šè®¿é—®æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -x 172.21.16.204 http://k8s.nginx.com</span></span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;503 Service Unavailable&lt;/h1&gt;</span><br><span class="line">No server is available to handle this request.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line">[root@k8s ~]<span class="comment"># curl -x 172.21.16.204:80 http://k8s.nginx.com</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h4 id="ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨"><a href="#ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨" class="headerlink" title="ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨"></a>ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¸æƒ³é…ç½®å¤ªå¤šçš„åŸŸåæ¥åŒºåˆ«åº”ç”¨ï¼Œä½¿ç”¨åŒåŸŸååˆ†è·¯å¾„çš„æ–¹å¼æ¥åŒºåˆ«åº”ç”¨å°±ç®€æ´æ–¹ä¾¿å¾ˆå¤šã€‚ingressä¹Ÿæä¾›äº†ç›¸å…³çš„é…ç½®ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‡è®¾ä¸¤ä¸ªåº”ç”¨tomcat-test1å’Œtomcat-test2ã€‚è¿™é‡Œå¯é…ç½®åŸŸåtomcat.xxlaila.ioï¼Œé€šè¿‡è·¯å¾„test1ã€test2æ¥åˆ†åˆ«ä»£ç†ä¸¤ä¸ªtomcatåº”ç”¨ã€‚å…¶ä¸­ï¼Œåˆ†è·¯å¾„é…ç½®éœ€æ·»åŠ é…ç½®ï¼štraefik.frontend.rule.type: PathPrefixStrip,é¦–å…ˆï¼Œæˆ‘å…ˆåˆ›å»ºtomcat-test1å’Œtomcat-test2çš„podå’Œserviceï¼Œå…¶ä¸­8080ä¸ºtomcatçš„httpç«¯å£ï¼Œ8443ä¸ºtomcatçš„httpsç«¯å£ï¼Œæœ¬ä¾‹ä¸­ä»…ä½¿ç”¨httpç«¯å£æµ‹è¯•ã€‚</p><ul><li><p>tomcat-test1.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1</span><br><span class="line">  labels: </span><br><span class="line">    app: tomcat-test1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1 </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-test1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-test1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-test1</span><br><span class="line">        image: tomcat</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1</span><br><span class="line">  labels:</span><br><span class="line">    name: tomcat-test1</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8443</span><br><span class="line">    targetPort: 8443</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test1</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080 </span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test1</span><br></pre></td></tr></table></figure></li><li><p>tomcat-test2.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test2</span><br><span class="line">  labels: </span><br><span class="line">    app: tomcat-test2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1 </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-test2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-test2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-test2</span><br><span class="line">        image: manjeetchauhan211/tomcat_test2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test2</span><br><span class="line">  labels:</span><br><span class="line">    name: tomcat-test2</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8443</span><br><span class="line">    targetPort: 8443</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080 </span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test2</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"></span><br><span class="line">$ kubectl get deployment</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-pod      2/2     2            2           17h</span><br><span class="line">tomcat-test1   1/1     1            1           42m</span><br><span class="line">tomcat-test2   1/1     1            1           42m</span><br><span class="line"></span><br><span class="line">$ kubectl get svc</span><br><span class="line">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kubernetes       ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP    5d23h</span><br><span class="line">nginx-service    ClusterIP   10.254.149.69    &lt;none&gt;        80/TCP     17h</span><br><span class="line">tomcat-test1     ClusterIP   10.254.195.108   &lt;none&gt;        8080/TCP   42m</span><br><span class="line">tomcat-test2     ClusterIP   10.254.6.88      &lt;none&gt;        8080/TCP   42m</span><br><span class="line">traefik-web-ui   ClusterIP   10.254.22.102    &lt;none&gt;        80/TCP     17h</span><br></pre></td></tr></table></figure></li></ul><p>åˆ›å»ºtest1çš„ingressï¼Œæ¥å‘å¸ƒtomcat-test1æœåŠ¡</p><ul><li>ingress-tomcat1.yam<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat ingress-tomcat1.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f ingress-tomcat.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>åœ¨traefix-uiç•Œé¢ä¸Šï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æœ‰äº†ä¸€ä¸ª<code>tomcat.xxlaila.io</code>çš„åŸŸåè§„åˆ™.<br><img src="https://img.xxlaila.cn/1567739051461.jpg" alt="img"></p><p>åœ¨hostsæ–‡ä»¶æ·»åŠ tomcat.xxlaila.ioç»‘å®šæ¥è¿›è¡Œè®¿é—®<br><img src="https://img.xxlaila.cn/1567739162707.jpg" alt="img"></p><h5 id="ingressé…ç½®åŒåŸŸåå¯¹åº”location"><a href="#ingressé…ç½®åŒåŸŸåå¯¹åº”location" class="headerlink" title="ingressé…ç½®åŒåŸŸåå¯¹åº”location"></a>ingressé…ç½®åŒåŸŸåå¯¹åº”location</h5><ul><li><p>ingress-tomcat.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /test1/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line">      - path: /test2/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test2</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºå¹¶æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f ingress-tomcat.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl describe ingress tomcat-test-web</span><br><span class="line">Name:             tomcat-test-web</span><br><span class="line">Namespace:        default</span><br><span class="line">Address:          </span><br><span class="line">Default backend:  default-http-backend:80 (&lt;none&gt;)</span><br><span class="line">Rules:</span><br><span class="line">  Host               Path  Backends</span><br><span class="line">  ----               ----  --------</span><br><span class="line">  tomcat.xxlaila.io  </span><br><span class="line">                     /test1/   tomcat-test1:8080 (&lt;none&gt;)</span><br><span class="line">                     /test2/   tomcat-test2:8080 (&lt;none&gt;)</span><br><span class="line">Annotations:</span><br><span class="line">  traefik.frontend.rule.type:                        PathPrefixStrip</span><br><span class="line">  kubectl.kubernetes.io/last-applied-configuration:  &#123;<span class="string">"apiVersion"</span>:<span class="string">"extensions/v1beta1"</span>,<span class="string">"kind"</span>:<span class="string">"Ingress"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;<span class="string">"kubernetes.io/ingress.class"</span>:<span class="string">"traefik"</span>,<span class="string">"traefik.frontend.rule.type"</span>:<span class="string">"PathPrefixStrip"</span>&#125;,<span class="string">"name"</span>:<span class="string">"tomcat-test-web"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"rules"</span>:[&#123;<span class="string">"host"</span>:<span class="string">"tomcat.xxlaila.io"</span>,<span class="string">"http"</span>:&#123;<span class="string">"paths"</span>:[&#123;<span class="string">"backend"</span>:&#123;<span class="string">"serviceName"</span>:<span class="string">"tomcat-test1"</span>,<span class="string">"servicePort"</span>:8080&#125;,<span class="string">"path"</span>:<span class="string">"/test1/"</span>&#125;,&#123;<span class="string">"backend"</span>:&#123;<span class="string">"serviceName"</span>:<span class="string">"tomcat-test2"</span>,<span class="string">"servicePort"</span>:8080&#125;,<span class="string">"path"</span>:<span class="string">"/test2/"</span>&#125;]&#125;&#125;]&#125;&#125;</span><br><span class="line"></span><br><span class="line">  kubernetes.io/ingress.class:  traefik</span><br><span class="line">Events:                         &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç»™èŠ‚ç‚¹è®¾ç½®label"><a href="#ç»™èŠ‚ç‚¹è®¾ç½®label" class="headerlink" title="ç»™èŠ‚ç‚¹è®¾ç½®label"></a>ç»™èŠ‚ç‚¹è®¾ç½®label</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºæ˜¯ Kubernetes DeamonSet è¿™ç§æ–¹å¼éƒ¨ç½² Traefikï¼Œæ‰€ä»¥éœ€è¦æå‰ç»™èŠ‚ç‚¹è®¾ç½® Labelï¼Œè¿™æ ·å½“ç¨‹åºéƒ¨ç½²æ—¶ Pod ä¼šè‡ªåŠ¨è°ƒåº¦åˆ°è®¾ç½® Label çš„ç‚¹ä¸Šã€‚</p><h4 id="èŠ‚ç‚¹è®¾ç½®-Label-æ ‡ç­¾"><a href="#èŠ‚ç‚¹è®¾ç½®-Label-æ ‡ç­¾" class="headerlink" title="èŠ‚ç‚¹è®¾ç½® Label æ ‡ç­¾"></a>èŠ‚ç‚¹è®¾ç½® Label æ ‡ç­¾</h4><ul><li>æ ¼å¼ï¼škubectl label nodes [èŠ‚ç‚¹å] [key=value]<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> kubectl get nodes</span><br><span class="line">NAME            STATUS   ROLES    AGE    VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   7d5h   v1.13.3</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   7d2h   v1.13.3</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   7d2h   v1.13.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl label nodes 172.21.16.204 IngressProxy=true</span></span><br><span class="line">node/172.21.16.204 labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹labelè®¾ç½®æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment"># kubectl get nodes --show-labels</span></span><br><span class="line">NAME            STATUS   ROLES    AGE    VERSION   LABELS</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   7d5h   v1.13.3   IngressProxy=<span class="literal">true</span>,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.204,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   7d2h   v1.13.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.240,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   7d2h   v1.13.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.87,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶"><a href="#ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶"></a>ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat deployment.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ssl</span><br><span class="line">        secret:</span><br><span class="line">          secretName: traefik-cert</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: traefik-conf</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/certs"</span></span><br><span class="line">          name: <span class="string">"ssl"</span></span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/conf"</span></span><br><span class="line">          name: <span class="string">"config"</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --configFile=/etc/kubernetes/conf/traefik.toml</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br><span class="line">      nodeSelector:</span><br><span class="line">        IngressProxy: <span class="string">"true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œéƒ¨ç½²å³å¯</span></span><br></pre></td></tr></table></figure><ul><li>traefix-uiç•Œé¢ä¸Šå¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1567739737385.jpg" alt="img"></li></ul><p>ä»describeä¿¡æ¯å’Œuiç•Œé¢ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œtomcat.test.k8såˆ†åˆ«æœ‰äº†/test1/å’Œ/test2/çš„åŸŸåä»£ç†ä»¥åŠç›¸å¯¹åº”çš„åç«¯<br><img src="https://img.xxlaila.cn/1567739822127.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567739856570.jpg" alt="img"></p><p><a href="https://xuchao918.github.io/2019/03/01/Kubernetes-traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®2</a><br><a href="https://blog.51cto.com/icenycmh/2124502" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®1</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s-helm</title>
    <url>/2019/09/04/k8s-helm/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helmç±»ä¼¼ä¸linuxä¸‹é¢çš„yumï¼ŒHelmæ˜¯ä¸€ä¸ªç”¨äºkubernetesçš„åŒ…ç®¡ç†å™¨ï¼Œæ¯ä¸€ä¸ªåŒ…ä¸ºä¸€ä¸ªchartï¼Œä¸€ä¸ªchartæ˜¯ä¸€ä¸ªç›®å½•ï¼Œå¸¸å¸¸ä¼šå¯¹ç›®å½•è¿›è¡Œæ‰“åŒ…å‹ç¼©ï¼Œå½¢æˆä¸€ä¸ª${name}-version.tgzçš„æ ¼å¼è¿›è¡Œä¼ è¾“å’Œå­˜å‚¨ã€‚</p><ul><li>å¯¹äºåº”ç”¨å‘å¸ƒè€…è€Œè¨€ï¼Œå¯ä»¥é€šè¿‡Helmæ‰“åŒ…åº”ç”¨ï¼Œç®¡ç†åº”ç”¨ä¾èµ–å…³ç³»ï¼Œç®¡ç†åº”ç”¨ç‰ˆæœ¬å¹¶å‘å¸ƒåº”ç”¨åˆ°è½¯ä»¶ä»“åº“ã€‚</li><li>å¯¹äºä½¿ç”¨è€…è€Œè¨€ï¼Œä½¿ç”¨Helmåä¸ç”¨éœ€è¦äº†è§£Kubernetesçš„Yamlè¯­æ³•å¹¶ç¼–å†™åº”ç”¨éƒ¨ç½²æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡Helmä¸‹è½½å¹¶åœ¨kubernetesä¸Šå®‰è£…éœ€è¦çš„åº”ç”¨ã€‚</li></ul><p>Helmè¿˜æä¾›äº†kubernetesä¸Šçš„è½¯ä»¶éƒ¨ç½²ï¼Œåˆ é™¤ï¼Œå‡çº§ï¼Œå›æ»šåº”ç”¨çš„å¼ºå¤§åŠŸèƒ½</p><a id="more"></a><h3 id="1ã€helmç»„ä»¶"><a href="#1ã€helmç»„ä»¶" class="headerlink" title="1ã€helmç»„ä»¶"></a>1ã€helmç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œä¸‹çš„å®¢æˆ·ç«¯å·¥å…·ã€‚ä¸»è¦ç”¨äº Kubernetes åº”ç”¨ç¨‹åº Chart çš„åˆ›å»ºã€æ‰“åŒ…ã€å‘å¸ƒä»¥åŠåˆ›å»ºå’Œç®¡ç†æœ¬åœ°å’Œè¿œç¨‹çš„ Chart ä»“åº“ã€‚</p><h4 id="1-1ã€Tiller"><a href="#1-1ã€Tiller" class="headerlink" title="1.1ã€Tiller"></a>1.1ã€Tiller</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tiller æ˜¯ Helm çš„æœåŠ¡ç«¯ï¼Œéƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­ã€‚Tiller ç”¨äºæ¥æ”¶ Helm çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ® Chart ç”Ÿæˆ Kubernetes çš„éƒ¨ç½²æ–‡ä»¶ï¼ˆ Helm ç§°ä¸º Release ï¼‰ï¼Œç„¶åæäº¤ç»™ Kubernetes åˆ›å»ºåº”ç”¨ã€‚Tiller è¿˜æä¾›äº† Release çš„å‡çº§ã€åˆ é™¤ã€å›æ»šç­‰ä¸€ç³»åˆ—åŠŸèƒ½ã€‚</p><h4 id="1-2ã€Chart"><a href="#1-2ã€Chart" class="headerlink" title="1.2ã€Chart"></a>1.2ã€Chart</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm çš„è½¯ä»¶åŒ…ï¼Œé‡‡ç”¨ TAR æ ¼å¼ã€‚ç±»ä¼¼äº APT çš„ DEB åŒ…æˆ–è€… YUM çš„ RPM åŒ…ï¼Œå…¶åŒ…å«äº†ä¸€ç»„å®šä¹‰ Kubernetes èµ„æºç›¸å…³çš„ YAML æ–‡ä»¶</p><h4 id="1-3ã€Repoistory"><a href="#1-3ã€Repoistory" class="headerlink" title="1.3ã€Repoistory"></a>1.3ã€Repoistory</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm çš„è½¯ä»¶ä»“åº“ï¼ŒRepository æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨ä¿å­˜äº†ä¸€ç³»åˆ—çš„ Chart è½¯ä»¶åŒ…ä»¥ä¾›ç”¨æˆ·ä¸‹è½½ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªè¯¥ Repository çš„ Chart åŒ…çš„æ¸…å•æ–‡ä»¶ä»¥ä¾›æŸ¥è¯¢ã€‚Helm å¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ªä¸åŒçš„ Repository</p><h4 id="1-4ã€Release"><a href="#1-4ã€Release" class="headerlink" title="1.4ã€Release"></a>1.4ã€Release</h4><p>ä½¿ç”¨ helm install å‘½ä»¤åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²çš„ Chart ç§°ä¸º Release</p><h3 id="2ã€helmå®‰è£…"><a href="#2ã€helmå®‰è£…" class="headerlink" title="2ã€helmå®‰è£…"></a>2ã€helmå®‰è£…</h3><ul><li>ä¸‹è½½helm<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://storage.googleapis.com/kubernetes-helm/helm-v2.14.3-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf helm-v2.14.3-linux-amd64.tar.gz &amp;&amp; mv linux-amd64/&#123;helm,tiller&#125; /usr/bin</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·"><a href="#2-1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·" class="headerlink" title="2.1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·"></a>2.1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount tiller --namespace kube-system</span></span><br><span class="line">serviceaccount/tiller created</span><br></pre></td></tr></table></figure><h4 id="2-2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"><a href="#2-2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²" class="headerlink" title="2.2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"></a>2.2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create clusterrolebinding tiller-admin-binding --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/tiller-admin-binding created</span><br></pre></td></tr></table></figure><h4 id="2-2ã€å®‰è£…tiller"><a href="#2-2ã€å®‰è£…tiller" class="headerlink" title="2.2ã€å®‰è£…tiller"></a>2.2ã€å®‰è£…tiller</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm init --service-account tiller --upgrade -i docker.io/sapcc/tiller:v2.14.3 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span><br></pre></td></tr></table></figure><h5 id="2-2-1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ"><a href="#2-2-1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ" class="headerlink" title="2.2.1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ"></a>2.2.1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods|grep tiller</span></span><br><span class="line">tiller-deploy-75b8f8575d-fplck          1/1     Running   0          17h</span><br><span class="line"></span><br><span class="line"><span class="comment"># helm version</span></span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.3"</span>, GitCommit:<span class="string">"0e7f3b6637f7af8fcfddb3d2941fcc7cbebb0085"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.3"</span>, GitCommit:<span class="string">"0e7f3b6637f7af8fcfddb3d2941fcc7cbebb0085"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é”™è¯¯</strong>: è¿™é‡Œå®‰è£…å®Œæˆåæ‰§è¡Œ<code>helm version</code>æç¤ºé”™è¯¯ï¼Œå†…å®¹å¦‚ä¸‹:<br><code>E0904 18:51:07.730671 22845 portforward.go:391] an error occurred forwarding 38767 -&gt; 44134: error forwarding port 44134 to pod b52064300cfa79e6d83795535584f89c97c33dc91ea39c024492b7b40e3fb68e, uid : unable to do port forwarding: socat not found.</code>è¿™ä¸ªé”™è¯¯éœ€è¦åœ¨å®¢æˆ·ç«¯å®‰è£…ä¸€ä¸ª<a href="https://github.com/helm/helm/issues/1371" target="_blank" rel="noopener">socatæ’ä»¶</a></li></ul><ul><li><p>åœ¨nodeå®‰è£…socat</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y socat</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹helmç¬¬ä¸‰æ–¹å­˜å‚¨åº“(å¯é€‰)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add stable https://burdenbear.github.io/kube-charts-mirror/</span></span><br><span class="line"><span class="comment"># helm repo list</span></span><br><span class="line">NAME     URL                                             </span><br><span class="line"><span class="built_in">local</span>    http://127.0.0.1:8879/charts                    </span><br><span class="line">monocular https://helm.github.io/monocular                </span><br><span class="line">stable   https://burdenbear.github.io/kube-charts-mirror/</span><br></pre></td></tr></table></figure></li></ul><h3 id="3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm-web"><a href="#3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm-web" class="headerlink" title="3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm web"></a>3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm web</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm list</span></span><br><span class="line"><span class="comment"># helm search</span></span><br><span class="line"><span class="comment"># helm search mysql --versions</span></span><br><span class="line"><span class="comment"># helm repo list</span></span><br><span class="line"><span class="comment"># helm serve --address 0.0.0.0:8879 &amp;</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567651293339.jpg" alt="img"></p><h3 id="4ã€helm-web-ui"><a href="#4ã€helm-web-ui" class="headerlink" title="4ã€helm web ui"></a>4ã€helm web ui</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;helmå®‰è£…ä»¥åï¼Œç»å¸¸ä½¿ç”¨helm cliå‘½æ¥è¿›è¡Œéƒ¨ç½²è¿˜æ˜¯æ¯”è¾ƒåƒåŠ›çš„ï¼Œè€Œä¸”å¯¹äºæœ‰äº›äººä¸å–œæ¬¢cliçš„æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç—›è‹¦çš„äº‹æƒ…ï¼Œè¿™é‡Œä»‹ç»ä¸€æ¬¾kubeappsï¼ŒKubeappsæ˜¯ä¸€ä¸ªåŸºäºWebçš„UIï¼Œç”¨äºåœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºã€‚ Kubeappså…è®¸æ‚¨ï¼š</p><ul><li>ä»å›¾è¡¨å­˜å‚¨åº“ä¸­æµè§ˆå’Œéƒ¨ç½²Helmå›¾è¡¨</li><li>æ£€æŸ¥ï¼Œå‡çº§å’Œåˆ é™¤ç¾¤é›†ä¸­å®‰è£…çš„åŸºäºHelmçš„åº”ç”¨ç¨‹åº</li><li>æ·»åŠ è‡ªå®šä¹‰å’Œç§æœ‰å›¾è¡¨å­˜å‚¨åº“ï¼ˆæ”¯æŒChartMuseumå’ŒJFrog Artifactory)</li><li>ä»æœåŠ¡ç›®å½•å’Œå¯ç”¨çš„Service Brokersæµè§ˆå’Œé…ç½®å¤–éƒ¨æœåŠ¡</li><li>ä½¿ç”¨æœåŠ¡ç›®å½•ç»‘å®šå°†åŸºäºHelmçš„åº”ç”¨ç¨‹åºè¿æ¥åˆ°å¤–éƒ¨æœåŠ¡</li><li>åŸºäºKubernetesåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶çš„å®‰å…¨èº«ä»½éªŒè¯å’Œæˆæƒ</li></ul><h4 id="4-1ã€å®‰è£…kubeapps"><a href="#4-1ã€å®‰è£…kubeapps" class="headerlink" title="4.1ã€å®‰è£…kubeapps"></a>4.1ã€å®‰è£…kubeapps</h4><p>ä½¿ç”¨Helmå›¾è¡¨å®‰è£…<a href="https://github.com/kubeapps/kubeapps" target="_blank" rel="noopener">æœ€æ–°ç‰ˆæœ¬çš„Kubeapps</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add bitnami https://charts.bitnami.com/bitnami</span></span><br><span class="line"><span class="comment"># helm install --name kubeapps --namespace kubeapps bitnami/kubeapps</span></span><br></pre></td></tr></table></figure><h4 id="4-2ã€å¯åŠ¨kubeappsDashboard"><a href="#4-2ã€å¯åŠ¨kubeappsDashboard" class="headerlink" title="4.2ã€å¯åŠ¨kubeappsDashboard"></a>4.2ã€å¯åŠ¨kubeappsDashboard</h4><p>å®‰è£…Kubeappsåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»ç³»ç»Ÿå®‰å…¨è®¿é—®Kubeapps Dashboard</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export POD_NAME=$(kubectl get pods --namespace kubeapps -l "app=kubeapps" -o jsonpath="&#123;.items[0].metadata.name&#125;")</span></span><br><span class="line"><span class="comment"># kubectl port-forward -n kubeapps $POD_NAME --address 0.0.0.0 8081:8080 &amp;</span></span><br><span class="line"><span class="comment"># æŠŠå®¹å™¨çš„8080 æ˜ å°„åˆ°æœ¬åœ°çš„8081ç«¯å£ï¼Œç”¨äºæµè§ˆå™¨è®¿é—®</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567650844980.jpg" alt="img"></p><h4 id="4-3ã€åˆ›å»ºtoken"><a href="#4-3ã€åˆ›å»ºtoken" class="headerlink" title="4.3ã€åˆ›å»ºtoken"></a>4.3ã€åˆ›å»ºtoken</h4><p>è®¿é—®ä»ªè¡¨æ¿éœ€è¦Kubernetes APIä»¤ç‰Œæ‰èƒ½é€šè¿‡Kubernetes APIæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount kubeapps-operator</span></span><br><span class="line">serviceaccount/kubeapps-operator created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding kubeapps-operator --clusterrole=cluster-admin --serviceaccount=default:kubeapps-operator</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubeapps-operator created</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–token</span></span><br><span class="line"><span class="comment"># kubectl get secret $(kubectl get serviceaccount kubeapps-operator -o jsonpath='&#123;.secrets[].name&#125;') -o jsonpath='&#123;.data.token&#125;' | base64 --decode</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567650971425.jpg" alt="img"></p><h5 id="4-3-1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬"><a href="#4-3-1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬" class="headerlink" title="4.3.1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬"></a>4.3.1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬</h5><p>æ¯æ¬¡è®¿é—®kubeappsçš„token éƒ½è¦è¾“å…¥ä¸€é•¿ä¸²ï¼Œè¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªshellè„šæœ¬ï¼Œæ”¾åœ¨<code>/usr/bin</code>ç›®å½•ï¼Œéœ€è¦çš„æ—¶å€™æ‰§è¡Œå‘½ä»¤å³å¯ï¼Œè¿™æ ·æ–¹ä¾¿ç”¨äºè®°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/bin/kubeapps</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">kubectl get secret $(kubectl get serviceaccount kubeapps-operator -o jsonpath=<span class="string">'&#123;.secrets[].name&#125;'</span>) -o jsonpath=<span class="string">'&#123;.data.token&#125;'</span> | base64 --decode</span><br><span class="line"><span class="comment"># chmod +x /usr/bin/kubeapps</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>helm</tag>
      </tags>
  </entry>
  <entry>
    <title>metrics-serverå®‰è£…å­£</title>
    <url>/2019/09/04/metrics-server%E5%AE%89%E8%A3%85%E5%AD%A3/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metrics-server é€šè¿‡ kube-apiserver å‘ç°æ‰€æœ‰èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨ kubelet APIsï¼ˆé€šè¿‡ https æ¥å£ï¼‰è·å¾—å„èŠ‚ç‚¹ï¼ˆNodeï¼‰å’Œ Pod çš„ CPUã€Memory ç­‰èµ„æºä½¿ç”¨æƒ…å†µã€‚Kubernetes 1.12 å¼€å§‹ï¼Œkubernetes çš„å®‰è£…è„šæœ¬ç§»é™¤äº† Heapsterï¼Œä» 1.13 å¼€å§‹å®Œå…¨ç§»é™¤äº†å¯¹ Heapster çš„æ”¯æŒï¼ŒHeapster ä¸å†è¢«ç»´æŠ¤ã€‚</p><ul><li>æ›¿ä»£æ–¹æ¡ˆå¦‚ä¸‹:<ul><li>ç”¨äºæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹çš„ CPU/memory HPA metricsï¼šmetrics-server</li><li>é€šç”¨çš„ç›‘æ§æ–¹æ¡ˆï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹å¯ä»¥è·å– Prometheus æ ¼å¼ç›‘æ§æŒ‡æ ‡çš„ç›‘æ§ç³»ç»Ÿï¼Œå¦‚ Prometheus Operator</li><li>äº‹ä»¶ä¼ è¾“ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æ¥ä¼ è¾“ã€å½’æ¡£ kubernetes events</li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨ metrics-server æ›¿ä»£ Heapsterï¼Œå°†æ— æ³•åœ¨ dashboard ä¸­ä»¥å›¾å½¢å±•ç¤º Pod çš„å†…å­˜å’Œ CPU æƒ…å†µï¼Œéœ€è¦é€šè¿‡ Prometheusã€Grafana ç­‰ç›‘æ§æ–¹æ¡ˆæ¥å¼¥è¡¥ã€‚</p><a id="more"></a><h4 id="1ã€ç›‘æ§æ¶æ„"><a href="#1ã€ç›‘æ§æ¶æ„" class="headerlink" title="1ã€ç›‘æ§æ¶æ„"></a>1ã€ç›‘æ§æ¶æ„</h4><p><img src="https://img.xxlaila.cn/2748678bdjsg848sd.png" alt="img"></p><h4 id="2ã€å®‰è£…-metrics-server"><a href="#2ã€å®‰è£…-metrics-server" class="headerlink" title="2ã€å®‰è£… metrics-server"></a>2ã€å®‰è£… metrics-server</h4><ul><li>ä» github clone æºç <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/metrics-server</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">aggregated-metrics-reader.yaml  auth-delegator.yaml  auth-reader.yaml  metrics-apiservice.yaml  metrics-server-deployment.yaml  metrics-server-service.yaml  resource-reader.yaml</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>æ³¨æ„</strong>: ä¹‹å‰åœ¨å®‰è£…çš„æ—¶å€™é‡åˆ°å¾ˆå¤šå‘ï¼Œè€Œä¸”ç½‘ä¸Šçœ‹äº†æ•™ç¨‹åŸºæœ¬ä¸Šä¸èƒ½ç”¨ï¼Œå¾ˆå‘ï¼Œè‡ªå·±çœ‹ç½‘ä¸Šæ•™ç¨‹ï¼Œç„¶åæ ¹æ®æ¯ä¸€ä¸ªé”™è¯¯æ¥è¿›è¡Œè§£å†³ï¼Œç»ˆäºï¼ŒåŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼ŒèŠ±äº†ä¸€å¤©åŠç»ˆäºæå®šå•¦ã€‚</li></ul><h4 id="3ã€metrics-server-æ–‡ä»¶ä¿®æ”¹"><a href="#3ã€metrics-server-æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="3ã€metrics-server æ–‡ä»¶ä¿®æ”¹"></a>3ã€metrics-server æ–‡ä»¶ä¿®æ”¹</h4><p>metrics-server yamlæ–‡ä»¶è¿™é‡Œæ–‡ä»¶å·²ç»ä¿®æ”¹å¥½äº†ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ï¼Œ<a href="https://github.com/kubernetes-incubator/metrics-server/issues/247" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a>ï¼Œ</p><h5 id="3-1ã€metrics-server-deployment-yaml"><a href="#3-1ã€metrics-server-deployment-yaml" class="headerlink" title="3.1ã€metrics-server-deployment.yaml"></a>3.1ã€metrics-server-deployment.yaml</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat metrics-server-deployment.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      hostNetwork: <span class="literal">true</span>   <span class="comment">#å¢åŠ è¡Œ</span></span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span><br><span class="line">      - name: tmp-dir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: mirrorgooglecontainers/metrics-server-amd64:v0.3.3</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/kubernetes/</span><br><span class="line">          name: ca-ssl</span><br><span class="line">        <span class="built_in">command</span>:   <span class="comment"># commandå†…å®¹å‡ä¸ºå¢åŠ </span></span><br><span class="line">        - /metrics-server</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br><span class="line">        - --requestheader-client-ca-file=/etc/ssl/kubernetes/front-proxy-ca.pem</span><br><span class="line">        - --kubelet-insecure-tls=<span class="literal">true</span></span><br><span class="line">      volumes:</span><br><span class="line">       - name: ca-ssl</span><br><span class="line">         hostPath:</span><br><span class="line">          path: /etc/kubernetes/ssl</span><br></pre></td></tr></table></figure><h5 id="3-2ã€"><a href="#3-2ã€" class="headerlink" title="3.2ã€"></a>3.2ã€</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat resource-reader.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/stats</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups: <span class="comment"># å¢åŠ </span></span><br><span class="line">  - <span class="string">"extensions"</span></span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure><h4 id="4ã€å‡†å¤‡è¯ä¹¦"><a href="#4ã€å‡†å¤‡è¯ä¹¦" class="headerlink" title="4ã€å‡†å¤‡è¯ä¹¦"></a>4ã€å‡†å¤‡è¯ä¹¦</h4><p>è¿™äº›è¯ä¹¦æ–‡ä»¶ä¸»è¦ç”¨åœ¨Metrics API aggregator ä¸Š,<a href="https://blog.51cto.com/ylw6006/2114338" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><ul><li><p>front-proxy-ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat front-proxy-ca-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>front-proxy-client-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"front-proxy-client"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="4-1ã€ç”Ÿæˆè¯ä¹¦"><a href="#4-1ã€ç”Ÿæˆè¯ä¹¦" class="headerlink" title="4.1ã€ç”Ÿæˆè¯ä¹¦"></a>4.1ã€ç”Ÿæˆè¯ä¹¦</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca</span></span><br><span class="line"><span class="comment"># cfssl gencert \</span></span><br><span class="line"> -ca=front-proxy-ca.pem \</span><br><span class="line"> -ca-key=front-proxy-ca-key.pem \</span><br><span class="line"> -config=/root/ssl/kubernetes-gencert.json \</span><br><span class="line"> -profile=kubernetes \</span><br><span class="line"> front-proxy-client-csr.json | cfssljson -bare front-proxy-client</span><br><span class="line"><span class="comment"># ls *.pem</span></span><br><span class="line">front-proxy-ca-key.pem  front-proxy-ca.pem  front-proxy-client-key.pem  front-proxy-client.pem</span><br></pre></td></tr></table></figure><ul><li>è¯ä¹¦ç”Ÿæˆå®Œæˆåï¼Œå§è¯ä¹¦å¤åˆ¶åˆ°æ‰€æœ‰çš„masterèŠ‚ç‚¹å’ŒnodeèŠ‚ç‚¹</li></ul><h4 id="5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶"></a>5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶</h4><h4 id="5-1ã€apiserver"><a href="#5-1ã€apiserver" class="headerlink" title="5.1ã€apiserver"></a>5.1ã€apiserver</h4><p>åœ¨apiserveré…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--runtime-config=api/all=<span class="literal">true</span> \</span><br><span class="line">--<span class="built_in">enable</span>-aggregator-routing=<span class="literal">true</span> \</span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/ssl/front-proxy-ca.pem \</span><br><span class="line">--requestheader-allowed-names=aggregator \</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \</span><br><span class="line">--requestheader-username-headers=X-Remote-User \</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/ssl/front-proxy-client.pem \</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/ssl/front-proxy-client-key.pem \</span><br></pre></td></tr></table></figure><ul><li>apiserveré…ç½®æ–‡ä»¶KUBE_API_ARGSå†…å®¹å¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBE_API_ARGS=<span class="string">" --allow-privileged=true \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --alsologtostderr \</span></span><br><span class="line"><span class="string">                --apiserver-count=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">                --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">                --enable-aggregator-routing=true \</span></span><br><span class="line"><span class="string">                --audit-log-path=/var/log/kube-audit/audit.log \</span></span><br><span class="line"><span class="string">                --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span></span><br><span class="line"><span class="string">                --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">                --enable-garbage-collector \</span></span><br><span class="line"><span class="string">                --enable-logs-handler \</span></span><br><span class="line"><span class="string">                --endpoint-reconciler-type=lease \</span></span><br><span class="line"><span class="string">                --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span></span><br><span class="line"><span class="string">                --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">                --etcd-compaction-interval=0s \</span></span><br><span class="line"><span class="string">                --event-ttl=168h0m0s \</span></span><br><span class="line"><span class="string">                --kubelet-https=true \</span></span><br><span class="line"><span class="string">                --kubelet-certificate-authority=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem \</span></span><br><span class="line"><span class="string">                --kubelet-timeout=3s \</span></span><br><span class="line"><span class="string">                --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">                --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">                --service-account-key-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">                --requestheader-client-ca-file=/etc/kubernetes/ssl/front-proxy-ca.pem \</span></span><br><span class="line"><span class="string">                --requestheader-allowed-names=aggregator \</span></span><br><span class="line"><span class="string">                --requestheader-extra-headers-prefix=X-Remote-Extra- \</span></span><br><span class="line"><span class="string">                --requestheader-group-headers=X-Remote-Group \</span></span><br><span class="line"><span class="string">                --requestheader-username-headers=X-Remote-User \</span></span><br><span class="line"><span class="string">                --proxy-client-cert-file=/etc/kubernetes/ssl/front-proxy-client.pem \</span></span><br><span class="line"><span class="string">                --proxy-client-key-file=/etc/kubernetes/ssl/front-proxy-client-key.pem \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="5-2ã€kube-control-manager"><a href="#5-2ã€kube-control-manager" class="headerlink" title="5.2ã€kube-control-manager"></a>5.2ã€kube-control-manager</h5><p>åœ¨controller-manageræ–‡ä»¶å¢åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--horizontal-pod-autoscaler-use-rest-clients=<span class="literal">true</span> \</span><br></pre></td></tr></table></figure><ul><li>kube-control-manageré…ç½®æ–‡ä»¶KUBE_CONTROLLER_MANAGER_ARGSå¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">                                --cluster-signing-cert-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --cluster-signing-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">                                --deployment-controller-sync-period=10s \</span></span><br><span class="line"><span class="string">                                --experimental-cluster-signing-duration=87600h0m0s \</span></span><br><span class="line"><span class="string">                                --enable-garbage-collector=true \</span></span><br><span class="line"><span class="string">                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --leader-elect=true \</span></span><br><span class="line"><span class="string">                                --node-monitor-grace-period=20s \</span></span><br><span class="line"><span class="string">                                --node-monitor-period=5s \</span></span><br><span class="line"><span class="string">                                --port=10252 \</span></span><br><span class="line"><span class="string">                                --pod-eviction-timeout=2m0s \</span></span><br><span class="line"><span class="string">                                --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --terminated-pod-gc-threshold=50 \</span></span><br><span class="line"><span class="string">                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">                                --root-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --secure-port=10257 \</span></span><br><span class="line"><span class="string">                                --service-cluster-ip-range=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                                --service-account-private-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">                                --horizontal-pod-autoscaler-use-rest-clients=true \</span></span><br><span class="line"><span class="string">                                --v=2"</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="5-3ã€é‡å¯æœåŠ¡"><a href="#5-3ã€é‡å¯æœåŠ¡" class="headerlink" title="5.3ã€é‡å¯æœåŠ¡"></a>5.3ã€é‡å¯æœåŠ¡</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl  restart kube-apiserver.service &amp;&amp;systemctl  restart kube-controller-manager</span></span><br></pre></td></tr></table></figure><h4 id="6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹"><a href="#6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹"></a>6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹</h4><p>node èŠ‚ç‚¹ä¿®æ”¹ä¿®æ”¹kubeletæ–‡ä»¶</p><ul><li><p>kubeleté…ç½®æ–‡ä»¶å®Œæˆçš„KUBELET_ARGSå‚æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBELET_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                --allow-privileged \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --authorization-mode=Webhook \</span></span><br><span class="line"><span class="string">                --authentication-token-webhook=true \</span></span><br><span class="line"><span class="string">                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --cgroup-driver=cgroupfs \</span></span><br><span class="line"><span class="string">                --cert-dir=/etc/kubernetes/ssl \</span></span><br><span class="line"><span class="string">                --cluster-dns=10.254.0.2 \</span></span><br><span class="line"><span class="string">                --cluster-domain=cluster.local \</span></span><br><span class="line"><span class="string">                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% \</span></span><br><span class="line"><span class="string">                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m \</span></span><br><span class="line"><span class="string">                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% \</span></span><br><span class="line"><span class="string">                --eviction-max-pod-grace-period=30 \</span></span><br><span class="line"><span class="string">                --image-gc-high-threshold=80 \</span></span><br><span class="line"><span class="string">                --image-gc-low-threshold=70 \</span></span><br><span class="line"><span class="string">                --image-pull-progress-deadline=30s \</span></span><br><span class="line"><span class="string">                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">                --max-pods=100 \</span></span><br><span class="line"><span class="string">                --minimum-image-ttl-duration=720h0m0s \</span></span><br><span class="line"><span class="string">                --node-labels=node.kubernetes.io/k8s-node=true \</span></span><br><span class="line"><span class="string">                --pod-infra-container-image=docker.io/kubernetes/pause:latest \</span></span><br><span class="line"><span class="string">                --port=10250 \</span></span><br><span class="line"><span class="string">                --read-only-port=0 \</span></span><br><span class="line"><span class="string">                --rotate-certificates \</span></span><br><span class="line"><span class="string">                --rotate-server-certificates \</span></span><br><span class="line"><span class="string">                --fail-swap-on=false \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯kubelet</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl restart kubelet</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="7ã€åˆ›å»ºmetrics"><a href="#7ã€åˆ›å»ºmetrics" class="headerlink" title="7ã€åˆ›å»ºmetrics"></a>7ã€åˆ›å»ºmetrics</h4><p>é€šè¿‡yamlæ–‡ä»¶åˆ›å»ºå¯¹åº”çš„èµ„æº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ./</span></span><br></pre></td></tr></table></figure><h5 id="7-1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ"><a href="#7-1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ" class="headerlink" title="7.1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ"></a>7.1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods -l k8s-app=metrics-server</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-84b786c9bb-7trdr   1/1     Running   0          62m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get svc -n kube-system  metrics-server</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">metrics-server   ClusterIP   10.254.45.238   &lt;none&gt;        443/TCP   3h6m</span><br></pre></td></tr></table></figure><h5 id="7-2ã€è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯"><a href="#7-2ã€è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯" class="headerlink" title="7.2ã€è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯"></a>7.2ã€è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰<code>v1beta1.metrics.k8s.io kube-system/metrics-server True 3h</code>å‚æ•°ä¸€ç›´æ˜¯<code>v1beta1.metrics.k8s.io kube-system/metrics-server False (FailedDiscoveryCheck) 16m</code>,</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kubectl get apiservice</span></span><br><span class="line">NAME                                    SERVICE                      AVAILABLE   AGE</span><br><span class="line">v1.                                     Local                        True        4d</span><br><span class="line">v1.apps                                 Local                        True        4d</span><br><span class="line">v1.authentication.k8s.io                Local                        True        4d</span><br><span class="line">v1.authorization.k8s.io                 Local                        True        4d</span><br><span class="line">v1.autoscaling                          Local                        True        4d</span><br><span class="line">v1.batch                                Local                        True        4d</span><br><span class="line">v1.networking.k8s.io                    Local                        True        4d</span><br><span class="line">v1.rbac.authorization.k8s.io            Local                        True        4d</span><br><span class="line">v1.storage.k8s.io                       Local                        True        4d</span><br><span class="line">v1alpha1.admissionregistration.k8s.io   Local                        True        4d</span><br><span class="line">v1alpha1.auditregistration.k8s.io       Local                        True        4d</span><br><span class="line">v1alpha1.rbac.authorization.k8s.io      Local                        True        4d</span><br><span class="line">v1alpha1.scheduling.k8s.io              Local                        True        4d</span><br><span class="line">v1alpha1.settings.k8s.io                Local                        True        4d</span><br><span class="line">v1alpha1.storage.k8s.io                 Local                        True        4d</span><br><span class="line">v1beta1.admissionregistration.k8s.io    Local                        True        4d</span><br><span class="line">v1beta1.apiextensions.k8s.io            Local                        True        4d</span><br><span class="line">v1beta1.apps                            Local                        True        4d</span><br><span class="line">v1beta1.authentication.k8s.io           Local                        True        4d</span><br><span class="line">v1beta1.authorization.k8s.io            Local                        True        4d</span><br><span class="line">v1beta1.batch                           Local                        True        4d</span><br><span class="line">v1beta1.certificates.k8s.io             Local                        True        4d</span><br><span class="line">v1beta1.coordination.k8s.io             Local                        True        4d</span><br><span class="line">v1beta1.events.k8s.io                   Local                        True        4d</span><br><span class="line">v1beta1.extensions                      Local                        True        4d</span><br><span class="line">v1beta1.metrics.k8s.io                  kube-system/metrics-server   True        3h</span><br><span class="line">v1beta1.policy                          Local                        True        4d</span><br><span class="line">v1beta1.rbac.authorization.k8s.io       Local                        True        4d</span><br><span class="line">v1beta1.scheduling.k8s.io               Local                        True        4d</span><br><span class="line">v1beta1.storage.k8s.io                  Local                        True        4d</span><br><span class="line">v1beta2.apps                            Local                        True        4d</span><br><span class="line">v2alpha1.batch                          Local                        True        4d</span><br><span class="line">v2beta1.autoscaling                     Local                        True        4d</span><br><span class="line">v2beta2.autoscaling                     Local                        True        4d</span><br></pre></td></tr></table></figure><h4 id="8ã€æŸ¥çœ‹-metrics-server-è¾“å‡ºçš„-metrics"><a href="#8ã€æŸ¥çœ‹-metrics-server-è¾“å‡ºçš„-metrics" class="headerlink" title="8ã€æŸ¥çœ‹ metrics-server è¾“å‡ºçš„ metrics"></a>8ã€æŸ¥çœ‹ metrics-server è¾“å‡ºçš„ metrics</h4><h5 id="8-1ã€é€šè¿‡-kube-apiserver-æˆ–-kubectl-proxy-è®¿é—®"><a href="#8-1ã€é€šè¿‡-kube-apiserver-æˆ–-kubectl-proxy-è®¿é—®" class="headerlink" title="8.1ã€é€šè¿‡ kube-apiserver æˆ– kubectl proxy è®¿é—®"></a>8.1ã€é€šè¿‡ kube-apiserver æˆ– kubectl proxy è®¿é—®</h5><ul><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes/" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes/</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/pods" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/pods</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/namespace//pods/" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/namespace//pods/</a></li></ul><h5 id="8-2ã€ç›´æ¥ä½¿ç”¨-kubectl-å‘½ä»¤è®¿é—®"><a href="#8-2ã€ç›´æ¥ä½¿ç”¨-kubectl-å‘½ä»¤è®¿é—®" class="headerlink" title="8.2ã€ç›´æ¥ä½¿ç”¨ kubectl å‘½ä»¤è®¿é—®"></a>8.2ã€ç›´æ¥ä½¿ç”¨ kubectl å‘½ä»¤è®¿é—®</h5><ul><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/nodes</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/pods</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/nodes/</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/namespace//pods/</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get --raw "/apis/metrics.k8s.io/v1beta1" | jq .</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"APIResourceList"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">  <span class="string">"groupVersion"</span>: <span class="string">"metrics.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"resources"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"nodes"</span>,</span><br><span class="line">      <span class="string">"singularName"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"namespaced"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"kind"</span>: <span class="string">"NodeMetrics"</span>,</span><br><span class="line">      <span class="string">"verbs"</span>: [</span><br><span class="line">        <span class="string">"get"</span>,</span><br><span class="line">        <span class="string">"list"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"pods"</span>,</span><br><span class="line">      <span class="string">"singularName"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"namespaced"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"kind"</span>: <span class="string">"PodMetrics"</span>,</span><br><span class="line">      <span class="string">"verbs"</span>: [</span><br><span class="line">        <span class="string">"get"</span>,</span><br><span class="line">        <span class="string">"list"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get --raw "/apis/metrics.k8s.io/v1beta1/nodes" | jq .</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"NodeMetricsList"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"metrics.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"metadata"</span>: &#123;</span><br><span class="line">    <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"items"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.204"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.204"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:40Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"63788460n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"1033152Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.240"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.240"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:40Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"41797865n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"837420Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.87"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.87"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:34Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"37347688n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"851232Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>/apis/metrics.k8s.io/v1beta1/nodes å’Œ /apis/metrics.k8s.io/v1beta1/pods è¿”å›çš„ usage åŒ…å« CPU å’Œ Memoryï¼›</li></ul><h4 id="ä½¿ç”¨-kubectl-top"><a href="#ä½¿ç”¨-kubectl-top" class="headerlink" title="ä½¿ç”¨ kubectl top"></a>ä½¿ç”¨ kubectl top</h4><p>ä½¿ç”¨ kubectl top å‘½ä»¤æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ,kubectl top å‘½ä»¤ä» metrics-server è·å–é›†ç¾¤èŠ‚ç‚¹åŸºæœ¬çš„æŒ‡æ ‡ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl top node</span></span><br><span class="line">NAME            CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">172.21.16.204   69m          1%     1008Mi          13%       </span><br><span class="line">172.21.16.240   41m          2%     817Mi           23%       </span><br><span class="line">172.21.16.87    39m          1%     831Mi           23%</span><br></pre></td></tr></table></figure><p>metricsåˆ°è¿™é‡Œå°±å·²ç»æˆåŠŸçš„éƒ¨ç½²ï¼Œå‚æ•°æ²¡æœ‰ä¸€ä¸€ä»‹ç»ï¼ŒåæœŸæœ‰æ—¶é—´åœ¨åˆ—å‡ºæ¥</p><p>è¿™é‡Œè¿˜æœ‰å¾ˆå¤šå‚è€ƒçš„æ–‡æ¡£æ²¡æœ‰ä¸€ä¸€åˆ—å‡ºæ¥ï¼Œä¸»è¦æ˜¯æµè§ˆå™¨è¢«å…³é—­å•¦ï¼Œæ„Ÿè°¢é‚£äº›å‚è€ƒçš„æ–‡æ¡£ï¼ŒğŸ˜ŠğŸ˜ŠğŸ˜Š</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>metrics-server</tag>
      </tags>
  </entry>
  <entry>
    <title>kubeletæä¾›apiè¯·æ±‚æ¥å£</title>
    <url>/2019/09/04/kubelet%E6%8F%90%E4%BE%9Bapi%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="kubelet-æä¾›çš„-API-æ¥å£è®¤è¯"><a href="#kubelet-æä¾›çš„-API-æ¥å£è®¤è¯" class="headerlink" title="kubelet æä¾›çš„ API æ¥å£è®¤è¯"></a>kubelet æä¾›çš„ API æ¥å£è®¤è¯</h3><p><a href="https://xxlaila.github.io/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">nodeå®‰è£…å‚è€ƒ</a></p><p>kubelet å¯åŠ¨åç›‘å¬å¤šä¸ªç«¯å£ï¼Œç”¨äºæ¥æ”¶ kube-apiserver æˆ–å…¶å®ƒå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-3 ~]<span class="comment">#  netstat -lnpt|grep kubelet</span></span><br><span class="line">tcp        0      0 127.0.0.1:46395         0.0.0.0:*               LISTEN      8941/kubelet        </span><br><span class="line">tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      8941/kubelet        </span><br><span class="line">tcp6       0      0 :::10250                :::*                    LISTEN      8941/kubelet</span><br></pre></td></tr></table></figure><ul><li><strong>10248</strong>: healthz http æœåŠ¡</li><li><strong>10250</strong>: https æœåŠ¡ï¼Œè®¿é—®è¯¥ç«¯å£æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼ˆå³ä½¿è®¿é—® /healthz ä¹Ÿéœ€è¦ï¼‰</li><li>æœªå¼€å¯åªè¯»ç«¯å£ 10255</li><li>ä» K8S v1.10 å¼€å§‹ï¼Œå»é™¤äº† â€“cadvisor-port å‚æ•°ï¼ˆé»˜è®¤ 4194 ç«¯å£ï¼‰ï¼Œä¸æ”¯æŒè®¿é—® cAdvisor UI &amp; API</li></ul><a id="more"></a><p>kubelet æ¥æ”¶ 10250 ç«¯å£çš„ https è¯·æ±‚ï¼Œå¯ä»¥è®¿é—®å¦‚ä¸‹èµ„æºï¼š</p><ul><li>/podsã€/runningpods</li><li>/metricsã€/metrics/cadvisorã€/metrics/probes</li><li>/spec</li><li>/statsã€/stats/container</li><li>/logs</li><li>/run/ã€/exec/, /attach/, /portForward/, /containerLogs/<br><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/server/server.go#L434:3" target="_blank" rel="noopener">è¯¦æƒ…å‚è€ƒ</a></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºå…³é—­äº†åŒ¿åè®¤è¯ï¼ŒåŒæ—¶å¼€å¯äº† webhook æˆæƒï¼Œæ‰€æœ‰è®¿é—® 10250 ç«¯å£ https API çš„è¯·æ±‚éƒ½éœ€è¦è¢«è®¤è¯å’Œæˆæƒã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;é¢„å®šä¹‰çš„ ClusterRole system:kubelet-api-admin æˆäºˆè®¿é—® kubelet æ‰€æœ‰ API çš„æƒé™(kube-apiserver ä½¿ç”¨çš„ kubernetes è¯ä¹¦ User æˆäºˆäº†è¯¥æƒé™)ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kubelet-api-admin</span></span><br><span class="line">Name:         system:kubelet-api-admin</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources      Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------      -----------------  --------------  -----</span><br><span class="line">  nodes/<span class="built_in">log</span>      []                 []              [*]</span><br><span class="line">  nodes/metrics  []                 []              [*]</span><br><span class="line">  nodes/proxy    []                 []              [*]</span><br><span class="line">  nodes/spec     []                 []              [*]</span><br><span class="line">  nodes/stats    []                 []              [*]</span><br><span class="line">  nodes          []                 []              [get list watch proxy]</span><br></pre></td></tr></table></figure><h3 id="kubelet-api-è®¤è¯å’Œæˆæƒ"><a href="#kubelet-api-è®¤è¯å’Œæˆæƒ" class="headerlink" title="kubelet api è®¤è¯å’Œæˆæƒ"></a>kubelet api è®¤è¯å’Œæˆæƒ</h3><p>kubelet é…ç½®äº†å¦‚ä¸‹è®¤è¯å‚æ•°:</p><ul><li><strong>â€“anonymous-auth=false</strong>: è®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åï¿½è®¿é—® 10250 ç«¯å£</li><li><strong>â€“authentication-token-webhook=true</strong>: æŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTPs è¯ä¹¦è®¤è¯</li><li><strong>â€“client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem</strong>: å¼€å¯ HTTPs bearer token è®¤è¯</li><li><strong>â€“authorization-mode=Webhook</strong>: å¼€å¯ RBAC æˆæƒ</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;kubelet æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ clientCAFile å¯¹è¯ä¹¦ç­¾åè¿›è¡Œè®¤è¯ï¼Œæˆ–è€…æŸ¥è¯¢ bearer token æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœä¸¤è€…éƒ½æ²¡é€šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚ï¼Œæç¤º Unauthorized</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 ~]<span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem https://172.21.16.204:10250/metrics</span></span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡è®¤è¯åï¼Œkubelet ä½¿ç”¨ SubjectAccessReview API å‘ kube-apiserver å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢è¯ä¹¦æˆ– token å¯¹åº”çš„ userã€group æ˜¯å¦æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</p><h3 id="è¯ä¹¦è®¤è¯å’Œæˆæƒ"><a href="#è¯ä¹¦è®¤è¯å’Œæˆæƒ" class="headerlink" title="è¯ä¹¦è®¤è¯å’Œæˆæƒ"></a>è¯ä¹¦è®¤è¯å’Œæˆæƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æƒé™ä¸è¶³</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem  --cert /etc/kubernetes/ssl/kube-controller-manager.pem --key /etc/kubernetes/ssl/kube-controller-manager-key.pem https://172.21.16.204:10250/metrics</span></span><br><span class="line">Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.16.204:10250/metrics|head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"21600"</span>&#125; 0</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>: â€“cacertã€â€“certã€â€“key çš„å‚æ•°å€¼å¿…é¡»æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦åˆ™è¿”å› 401 Unauthorizedï¼›</li></ul><h4 id="bear-token-è®¤è¯å’Œæˆæƒ"><a href="#bear-token-è®¤è¯å’Œæˆæƒ" class="headerlink" title="bear token è®¤è¯å’Œæˆæƒ"></a>bear token è®¤è¯å’Œæˆæƒ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ª ServiceAccountï¼Œå°†å®ƒå’Œ ClusterRole system:kubelet-api-admin ç»‘å®šï¼Œä»è€Œå…·æœ‰è°ƒç”¨ kubelet API çš„æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">horization.k8s.io/kubelet-api-test created</span><br><span class="line"><span class="comment"># SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># TOKEN=$(kubectl describe secret $&#123;SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;TOKEN&#125;</span></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6Imt1YmVsZXQtYXBpLXRlc3QtdG9rZW4tNGJra3MiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoia3ViZWxldC1hcGktdGVzdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6Ijk3MDRhZDEwLWNlYjQtMTFlOS04ZDIwLWZhMTYzZTVhZjgzMyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0Omt1YmVsZXQtYXBpLXRlc3QifQ.ishvOaC5tppYKDNpEOXIiVhVtgjyqzjySZjzndot5Z5U9MkY9LN8ZSMWRe6lNsB1UuTgEWTsHlG3OIRfExnHehYhWIt59V9e39KKbeY17hHoT-RZSaD6GoB449t_vUdIJedd1FGZ8DckQvDr6X5fMuD7MSU3vRL077j-uls-y4IW5kaJHeAGJfc6eWoCnv96DCbI8mQ8yuYbwLFpfIPLb4u6FPkwMQL2KXy6FhWPY1va6zAh4LdjGWhH6IAkKleq0aqfMwvmlnk1_OUmnmBoGJGuB96IwqBATP0jFzrd-Sv6af3RsSYz2r8YzJUj3kat9bd__HNCCXampYYr8ffu8YEdn-J9p6HK13FWU4O9QSIDrRONNIOpUXclJ-ov3z6N1hiIcVq5UJU6xR2z4ccvPXmH9Sj7p8CquqKEuobZxK97TFtECGlb2Ex43u4t0UHRo23UCQA-qP2Zs4-U2Zmf_qu3I-Lm7jzuYzXFCAb27yZx_XOUY-ycnKhtM6PpUfVKhkcHfWBOYY-QtBEbYf6yHRqCWcjrsZ63C_B56qAYaU5ca3hAcr6RBuHmmHISGESlLbmrpGgJ_ajd5mrJSh3Z_qdqu-Xt0Ya0NLfXgAcGi5n8xWJLztRTeyHrFTj7g82MqERUfFk9bdLHcz77xmrNLnhRZ87GW9sTZLw8QRUjF1g</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem -H "Authorization: Bearer $&#123;TOKEN&#125;" https://172.21.16.204:10250/metrics|head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"21600"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="cadvisor-å’Œ-metrics"><a href="#cadvisor-å’Œ-metrics" class="headerlink" title="cadvisor å’Œ metrics"></a>cadvisor å’Œ metrics</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;cadvisor æ˜¯å†…åµŒåœ¨ kubelet äºŒè¿›åˆ¶ä¸­çš„ï¼Œç»Ÿè®¡æ‰€åœ¨èŠ‚ç‚¹å„å®¹å™¨çš„èµ„æº(CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘å¡)ä½¿ç”¨æƒ…å†µçš„æœåŠ¡.</p><blockquote><p>åœ¨è®¿é—®api-serverå®‰å…¨ç«¯å£ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›æ“ä½œæ‰èƒ½è®¿é—®ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œè®¿é—®</p></blockquote><h5 id="åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£"><a href="#åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£" class="headerlink" title="åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£"></a>åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;æç¤ºè¯ä¹¦ä¸è¢«ä¿¡ä»»,è¿™æ˜¯å› ä¸º kube-apiserver çš„ server è¯ä¹¦æ˜¯æˆ‘ä»¬åˆ›å»ºçš„æ ¹è¯ä¹¦ ca.pem ç­¾åçš„ï¼Œéœ€è¦å°†æ ¹è¯ä¹¦ ca.pem å¯¼å…¥æ“ä½œç³»ç»Ÿï¼Œå¹¶è®¾ç½®æ°¸ä¹…ä¿¡ä»»ã€‚<br><img src="https://img.xxlaila.cn/1567564092242.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ç»™æµè§ˆå™¨ç”Ÿæˆä¸€ä¸ª client è¯ä¹¦ï¼Œè®¿é—® apiserver çš„ 6443 https ç«¯å£æ—¶ä½¿ç”¨ã€‚è¿™é‡Œä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ admin è¯ä¹¦ã€ç§é’¥å’Œä¸Šé¢çš„ ca è¯ä¹¦ï¼Œåˆ›å»ºä¸€ä¸ªæµè§ˆå™¨å¯ä»¥ä½¿ç”¨ PKCS#12/PFX æ ¼å¼çš„è¯ä¹¦ï¼š</p><ul><li><p>ä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œè¿™é‡Œå¯†ç éœ€è¦è®°ä½ï¼Œä¸€ä¼šå€’å…¥è¯ä¹¦åˆ°æµè§ˆå™¨çš„æ—¶å€™éœ€è¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl pkcs12 -export -out admin.pfx -inkey admin-key.pem -in admin.pem -certfile kubernetes-ca.pem</span></span><br><span class="line">Enter Export Password:</span><br><span class="line">Verifying - Enter Export Password:</span><br></pre></td></tr></table></figure></li><li><p>å°†åˆ›å»ºçš„ admin.pfx å¯¼å…¥åˆ°ç³»ç»Ÿçš„è¯ä¹¦ä¸­,<br><img src="https://img.xxlaila.cn/1567564289155.jpg" alt="img"></p></li></ul><p>å†æ¬¡è®¿é—® apiserver åœ°å€ï¼Œæç¤ºé€‰æ‹©ä¸€ä¸ªæµè§ˆå™¨è¯ä¹¦ï¼Œè¿™é‡Œé€‰ä¸­ä¸Šé¢å¯¼å…¥çš„ admin.pfx<br><img src="https://img.xxlaila.cn/1567564393274.jpg" alt="img"></p><ul><li><p>æç¤ºéœ€è¦è¾“å…¥ç³»ç»Ÿçš„å¯†ç ,è¿™é‡Œæ˜¯macçš„ç”µè„‘<br><img src="https://img.xxlaila.cn/1567564441293.jpg" alt="img"></p></li><li><p>è¢«æˆæƒè®¿é—® kube-apiserver çš„å®‰å…¨ç«¯å£<br><img src="https://img.xxlaila.cn/1567564526664.jpg" alt="img"></p></li></ul><h5 id="å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†"><a href="#å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†" class="headerlink" title="å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†"></a>å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†</h5><ul><li>è¯ä¹¦é€‰æ‹©æ˜¯åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ SSL/TLS æ¡æ‰‹åå•†é˜¶æ®µå•†å®šçš„ï¼›</li><li>æœåŠ¡ç«¯å¦‚æœè¦æ±‚å®¢æˆ·ç«¯æä¾›è¯ä¹¦ï¼Œåˆ™åœ¨æ¡æ‰‹æ—¶ä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå®ƒæ¥å—çš„ CA åˆ—è¡¨ï¼›</li><li>å®¢æˆ·ç«¯æŸ¥æ‰¾å®ƒçš„è¯ä¹¦åˆ—è¡¨(ä¸€èˆ¬æ˜¯æ“ä½œç³»ç»Ÿçš„è¯ä¹¦ï¼Œå¯¹äº Mac ä¸º keychain)ï¼Œçœ‹æœ‰æ²¡æœ‰è¢« CA ç­¾åçš„è¯ä¹¦ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†å®ƒä»¬æä¾›ç»™ç”¨æˆ·é€‰æ‹©ï¼ˆè¯ä¹¦çš„ç§é’¥ï¼‰ï¼›</li><li>ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªè¯ä¹¦ç§é’¥ï¼Œç„¶åå®¢æˆ·ç«¯å°†ä½¿ç”¨å®ƒå’ŒæœåŠ¡ç«¯é€šä¿¡ï¼›</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨è®¿é—® <a href="https://172.21.16.204:10250/metrics" target="_blank" rel="noopener">https://172.21.16.204:10250/metrics</a> å’Œ <a href="https://172.21.16.204:10250/metrics/cadvisor" target="_blank" rel="noopener">https://172.21.16.204:10250/metrics/cadvisor</a> åˆ†åˆ«è¿”å› kubelet å’Œ cadvisor çš„ metricsã€‚<br><img src="https://img.xxlaila.cn/1567563858215.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567564733531.jpg" alt="img"></p><ul><li><strong>åŸå› </strong>: kubeleté…ç½®æ–‡ä»¶è®¾ç½®<code>--anonymous-auth=false</code>ä¸å…è®¸åŒ¿åè¯ä¹¦è®¿é—® 10250 çš„ https æœåŠ¡,æ‰€ä»¥æˆ‘ä»¬æ‰éœ€è¦é…ç½®è¯ä¹¦æ¥è¿›è¡Œè®¿é—®</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubelet</tag>
      </tags>
  </entry>
  <entry>
    <title>centos-nfs-512é”™è¯¯</title>
    <url>/2019/09/03/centos-nfs-512%E9%94%99%E8%AF%AF/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>nfs é”™è¯¯kernel: NFS: nfs4_discover_server_trunking unhandled error -512. Exiting with error EIO</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¾ˆä¹…æ²¡æŒ‚è½½è¿‡nfsï¼Œå¿˜è®°å®¢æˆ·ç«¯æ€ä¹ˆæŒ‚åœ¨nfsçš„äº†ï¼ŒæœåŠ¡ç«¯å¾ˆæ—©å°±å®‰è£…å¥½äº†ï¼Œä»Šå¤©ä¸€å°å®¢æˆ·æœºéœ€è¦æŒ‚è½½nfsï¼Œç„¶åå±…ç„¶æŠ¥é”™äº†ï¼Œç„¶åæ‰¾äº†ä¸€åœˆå±…ç„¶æ²¡æ‰¾åˆ°æ€ä¹ˆè§£å†³ï¼Œç„¶ååˆé‡æ–°çœ‹äº†ä¸€æ¬¡centos nfsçš„é…ç½®ï¼Œäºæ˜¯ä¹å°±æå®šäº†</p><p>åœ¨æŒ‚è½½nfsçš„æç¤ºå¾ˆæ…¢ï¼Œé•¿æ—¶é—´æ— å“åº”ï¼Œå¼ºè¡Œç»“æŸçœ‹çœ‹æ˜¯ä»€ä¹ˆé—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo tail -f /var/<span class="built_in">log</span>/messages</span><br><span class="line">Sep  3 11:23:51 dev-application kernel: NFS: nfs4_discover_server_trunking unhandled error -512. Exiting with error EIO</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind-service"><a href="#1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind-service" class="headerlink" title="1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind.service"></a>1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind.service</h3><p>åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹<code>rpcbind.service</code>æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼Œæ²¡æœ‰æ­£å¸¸å¯åŠ¨ï¼Œå°±éœ€è¦å¯åŠ¨ï¼Œæ²¡æœ‰å®‰è£…æœåŠ¡ï¼Œå°±éœ€è¦å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum -y install rpcbind</span><br><span class="line">$ sudo systemctl start rpcbind.service &amp;&amp; sudo systemctl <span class="built_in">enable</span> rpcbind.service</span><br></pre></td></tr></table></figure><ul><li>å†æ¬¡æŒ‚è½½çš„æ—¶å€™è¿˜æ˜¯æŒ‚è½½è¡¥ä¸Šï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æŒ‚è½½çš„æ—¶å€™å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€äº†æ•°æ®è¯·æ±‚ï¼Œè€Œä¸”è¿˜æ²¡æœ‰æ­£å¸¸çš„æ–­å¼€é“¾æ¥ï¼Œå¯ä»¥åœ¨æœåŠ¡ç«¯ç”¨<code>netstat -anp|grep tcp</code>æŸ¥çœ‹æœ‰æ²¡æœ‰å®¢æˆ·ç«¯çš„é“¾æ¥ä¿¡æ¯,çŠ¶æ€æ˜¯<code>ESTABLISHED</code>ï¼Œæœ‰çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒç»“æŸæ‰</li></ul><h3 id="2ã€linux-ç»“æŸtcpä¼šè¯"><a href="#2ã€linux-ç»“æŸtcpä¼šè¯" class="headerlink" title="2ã€linux ç»“æŸtcpä¼šè¯"></a>2ã€linux ç»“æŸtcpä¼šè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›®å‰ä¸çŸ¥é“ä»€ä¹ˆå‘½ä»¤,åæœŸæ›´æ–°</span></span><br><span class="line"><span class="comment"># é‡å¯nfsæœåŠ¡</span></span><br><span class="line">$ sudo systemctl restart nfs.service</span><br></pre></td></tr></table></figure><h3 id="3ã€å®¢æˆ·ç«¯æŒ‚è½½"><a href="#3ã€å®¢æˆ·ç«¯æŒ‚è½½" class="headerlink" title="3ã€å®¢æˆ·ç«¯æŒ‚è½½"></a>3ã€å®¢æˆ·ç«¯æŒ‚è½½</h3><p>å†æ¬¡æ¥åˆ°å®¢æˆ·æœºæŒ‚è½½ï¼Œå¯ä»¥æˆåŠŸçš„æŒ‚è½½</p><h3 id="4ã€rpcbindæœåŠ¡ä»‹ç»"><a href="#4ã€rpcbindæœåŠ¡ä»‹ç»" class="headerlink" title="4ã€rpcbindæœåŠ¡ä»‹ç»"></a>4ã€rpcbindæœåŠ¡ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿéœ€è¦æœåŠ¡ï¼Œçº¢å¸½ä¼ä¸šLinuxä½¿ç”¨æ ¸å¿ƒçº§çš„æ”¯æŒå’Œå®ˆæŠ¤è¿›ç¨‹çš„ç»„åˆæ¥æä¾›NFSæ–‡ä»¶å…±äº«.NFSä¾é è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è·¯ç”±è¯·æ±‚ã€‚åœ¨Linuxä¸‹RPCæœåŠ¡ç”±portmapæœåŠ¡æ§åˆ¶ã€‚</p><h4 id="4-1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ"><a href="#4-1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ" class="headerlink" title="4.1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ:"></a>4.1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ:</h4><ul><li>nfs - å¯åŠ¨ç›¸åº”RPCæœåŠ¡è¿›ç¨‹æ¥æœåŠ¡å¯¹äºNFSæ–‡ä»¶ç³»ç»Ÿçš„è¯·æ±‚.</li><li>nfslock - ä¸€ä¸ªå¯é€‰çš„æœåŠ¡ï¼Œç”¨äºå¯åŠ¨ç›¸åº”çš„RPCè¿›ç¨‹ï¼Œå…è®¸NFSå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ä¸Šå¯¹æ–‡ä»¶åŠ é”.</li><li>portmap - Linuxçš„RPCæœåŠ¡,å®ƒå“åº”RPCæœåŠ¡çš„è¯·æ±‚å’Œä¸è¯·æ±‚çš„RPCæœåŠ¡å»ºç«‹è¿æ¥.</li></ul><h4 id="4-2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡"><a href="#4-2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡" class="headerlink" title="4.2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡"></a>4.2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡</h4><ul><li>rpc.mountd - è¿™ä¸ªè¿›ç¨‹æ¥å—æ¥è‡ªNFSå®¢æˆ·ç«¯çš„åŠ è½½è¯·æ±‚å’ŒéªŒè¯è¯·æ±‚çš„æ–‡ä»¶ç³»ç»Ÿæ­£åœ¨è¢«è¾“å‡º.è¿™ä¸ªè¿›ç¨‹ç”±NFSæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li><li>rpc.nfsd - è¿™ä¸ªè¿›ç¨‹æ˜¯NFSæœåŠ¡å™¨.å®ƒå’ŒLinuxæ ¸å¿ƒä¸€èµ·å·¥ä½œæ¥æ»¡è¶³NFSå®¢æˆ·ç«¯çš„åŠ¨æ€éœ€æ±‚ï¼Œä¾‹å¦‚æä¾›ä¸ºæ¯ä¸ªNFSå®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚æœåŠ¡å™¨çº¿ç¨‹.è¿™ä¸ªè¿›ç¨‹å¯¹åº”äºnfsæœåŠ¡.</li><li>rpc.lockd - ä¸€ä¸ªå¯é€‰çš„è¿›ç¨‹ï¼Œå®ƒå…è®¸NFSå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ä¸Šå¯¹æ–‡ä»¶åŠ é”.è¿™ä¸ªè¿›ç¨‹å¯¹åº”äºnfslockæœåŠ¡.</li><li>rpc.statd - è¿™ä¸ªè¿›ç¨‹å®ç°äº†ç½‘ç»œçŠ¶æ€ç›‘æ§(NSM)RPCåè®®,é€šçŸ¥NFSå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ä¸€ä¸ªNFSæœåŠ¡å™¨éæ­£å¸¸é‡å¯åŠ¨.è¿™ä¸ªè¿›ç¨‹è¢«nfslockæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li><li>rpc.rquotad - è¿™ä¸ªè¿›ç¨‹å¯¹äºè¿œç¨‹ç”¨æˆ·æä¾›ç”¨æˆ·é…é¢ä¿¡æ¯. è¿™ä¸ªè¿›ç¨‹è¢«nfsæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sé›†ç¾¤éƒ¨ç½²heapster</title>
    <url>/2019/09/02/k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2heapster/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>kubernetesé›†ç¾¤å¯ç”¨tlsè®¤è¯éƒ¨ç½²heapsterï¼Œåœ¨éƒ¨ç½²æœŸé—´é‡åˆ°äº†å¾ˆå¤šçš„å‘ï¼Œèµ°è¿‡å¾ˆå¤šé›·ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹,ä¸è¿‡åœ¨æ–°ç‰ˆæœ¬ä¸­heapsterè¢«metrics-serverä»£æ›¿äº†ï¼Œmetrics-serveråç¯‡ä»‹ç»å’Œä½¿ç”¨</p><h2 id="1ã€å‡†å¤‡å·¥ä½œ"><a href="#1ã€å‡†å¤‡å·¥ä½œ" class="headerlink" title="1ã€å‡†å¤‡å·¥ä½œ"></a>1ã€å‡†å¤‡å·¥ä½œ</h2><p>ä¸‹è½½éœ€è¦çš„æ–‡ä»¶ï¼Œè¿™é‡Œç”¨ä¹‹å‰k8s-heapsteréƒ¨ç½²çš„æ–‡ä»¶æ‹¿æ¥è¿›è¡Œä¿®æ”¹ï¼Œ<a href="https://github.com/xxlaila/kubernetes-yaml/" target="_blank" rel="noopener">æ–‡ä»¶åœ°å€</a></p><h3 id="2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º"><a href="#2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º" class="headerlink" title="2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º"></a>2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes-yaml/heapster-influxdb-grafana</span></span><br><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li><strong>é”™è¯¯æç¤º</strong>: è¿™é‡Œåœ¨æ‰§è¡Œåˆ›å»ºåï¼Œæ²¡æœ‰å›¾åƒæ˜¾ç¤ºï¼ŒæŸ¥çœ‹podsæ—¥å¿—å‘ç°é”™è¯¯<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system|grep he</span></span><br><span class="line">heapster-7b7b4754d-5p7tb                1/1     Running   0          17m</span><br><span class="line"><span class="comment"># kubectl logs heapster-7b7b4754d-5p7tb -n kube-system</span></span><br><span class="line">E0902 10:57:11.804543       1 reflector.go:190] k8s.io/heapster/metrics/processors/namespace_based_enricher.go:89: Failed to list *v1.Namespace: namespaces is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list resource <span class="string">"namespaces"</span> <span class="keyword">in</span> API group <span class="string">""</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br><span class="line">E0902 10:57:12.071117       1 reflector.go:190] k8s.io/heapster/metrics/util/util.go:30: Failed to list *v1.Node: nodes is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list resource <span class="string">"nodes"</span> <span class="keyword">in</span> API group <span class="string">""</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br></pre></td></tr></table></figure></li></ul><ul><li>æ’é”™<br>æŸ¥çœ‹ClusterRole: system:heapsterçš„æƒé™,å‘ç°å¹¶æ²¡æœ‰</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:heapster</span></span><br><span class="line">Error from server (NotFound): clusterroles.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br></pre></td></tr></table></figure><p>æç¤ºè¿™ä¸ªé”™è¯¯ï¼Œåº”è¯¥æ˜¯æˆ‘ä¹‹å‰éƒ¨ç½²è¿‡ï¼Œç„¶åä¿®æ”¹è¿‡æƒé™ï¼Œä¸å°å¿ƒç»™åˆ æ‰å•¦ï¼Œè¿™é‡Œéœ€è¦å§æƒé™é‡å»ºä¸€æ¬¡å°±å¥½äº†ï¼Œ<a href="https://www.cnblogs.com/vincenshen/p/9638162.html" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><ul><li>æ–°å»ºheapster-clusterrole.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster-clusterrole.yaml </span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:heapster</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  - namespaces</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br></pre></td></tr></table></figure></li></ul><p>å¹¶æ‰§è¡Œ kubectl apply -f heapster-clusterrole.yaml,åœ¨æ¬¡æŸ¥çœ‹æ—¥å¿—ï¼Œå‘ç°ä¹‹å‰çš„é”™è¯¯æ²¡æœ‰äº†ï¼Œä½†æ˜¯åˆå‡ºç°äº†ä¸€ä¸ªæ–°çš„é”™è¯¯<br><code>E0902 11:27:05.025300 1 manager.go:101] Error in scraping containers from kubelet:172.21.16.204:10250: failed to get all container stats from Kubelet URL &quot;https://172.21.16.204:10250/stats/container/&quot;: request failed - &quot;401 Unauthorized&quot;, response: &quot;Unauthorized&quot;</code></p><ul><li><p>ä¿®æ”¹heapster-clusterrole.yamlæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶é‡Œé¢æˆ‘ä»¬æ·»åŠ å‡ ä¸ªæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster-clusterrole.yaml </span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:heapster</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  - namespaces</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f heapster-clusterrole.yaml</span></span><br><span class="line"><span class="comment"># é‡æ–°åˆ›å»ºheapster</span></span><br><span class="line"><span class="comment"># kubectl delete -f heapster.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f heapster.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>å®Œæˆä»¥åæˆ‘ä»¬ç»§ç»­çœ‹heapster podçš„æ—¥å¿—ï¼Œå‘ç°æ—¥å¿—é‡Œé¢è¿˜æ˜¯å‡ºç°<code>401 Unauthorized&quot;, response: &quot;Unauthorized&quot;</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹nodeèŠ‚ç‚¹ kubelet å¯åŠ¨çš„é…ç½®å‚æ•°ï¼Œæ·»åŠ <code>--authentication-token-webhook</code>å‚æ•°: ä½¿ç”¨tokenreview APIæ¥è¿›è¡Œä»¤ç‰Œè®¤è¯ã€‚Kubelet åœ¨é…ç½®çš„ API server ä¸Šè°ƒç”¨ TokenReview API ä»¥ç¡®å®šæ¥è‡ª bearer token çš„ç”¨æˆ·ä¿¡æ¯ã€‚<a href="https://k8smeetup.github.io/docs/admin/kubelet-authentication-authorization/" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a>ï¼Œ<a href="https://github.com/kubernetes-retired/heapster/issues/1936" target="_blank" rel="noopener">githubä¸Šé”™è¯¯è§£å†³</a>ï¼Œ <a href="https://jimmysong.io/posts/user-authentication-in-kubernetes/" target="_blank" rel="noopener">å‚æ•°æ–‡ç« å­¦ä¹ </a></p><p>åˆ°æ­¤ä¸ºæ­¢: é”™è¯¯æ²¡æœ‰å•¦ï¼Œä½†æ˜¯ç•Œé¢æ•°æ®æ²¡å‡ºæ¥ï¼Œç¨ç­‰ç‰‡åˆ»</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>heapster</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sé…ç½®Dashboard</title>
    <url>/2019/08/29/k8s%E9%85%8D%E7%BD%AEDashboard/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;K8S Dashboardæ˜¯å®˜æ–¹çš„ä¸€ä¸ªåŸºäºWEBçš„ç”¨æˆ·ç•Œé¢ï¼Œä¸“é—¨ç”¨æ¥ç®¡ç†K8Sé›†ç¾¤ï¼Œå¹¶å¯å±•ç¤ºé›†ç¾¤çš„çŠ¶æ€ã€‚K8Sé›†ç¾¤å®‰è£…å¥½åé»˜è®¤æ²¡æœ‰åŒ…å«Dashboardï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–åˆ›å»ºå®ƒã€‚</p><h3 id="1ã€å®‰è£…dashboard"><a href="#1ã€å®‰è£…dashboard" class="headerlink" title="1ã€å®‰è£…dashboard"></a>1ã€å®‰è£…dashboard</h3><h4 id="1-1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶"><a href="#1-1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶" class="headerlink" title="1.1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶"></a>1.1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶</h4><p>ç»è¿‡ä¿®æ”¹è¿‡åçš„æ–‡ä»¶ï¼Œå·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„<a href="https://github.com/xxlaila/kubernetes-yaml/" target="_blank" rel="noopener">æ–‡ä»¶</a></p><a id="more"></a><ul><li>åˆ›å»ºdashboard<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl create -f kubernetes-dashboard.yaml </span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br></pre></td></tr></table></figure></li></ul><h4 id="1-2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod"><a href="#1-2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod" class="headerlink" title="1.2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod"></a>1.2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl get service --all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">default       kubernetes             ClusterIP   10.254.0.1      &lt;none&gt;        443/TCP         18h</span><br><span class="line">kube-system   coredns                ClusterIP   10.254.0.10     &lt;none&gt;        53/UDP,53/TCP   16h</span><br><span class="line">kube-system   kubernetes-dashboard   NodePort    10.254.51.226   &lt;none&gt;        443:30001/TCP   15h</span><br></pre></td></tr></table></figure><ul><li><p>æŸ¥çœ‹serviceæè¿°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl describe  service kubernetes-dashboard -n kube-system</span></span><br><span class="line">Name:                     kubernetes-dashboard</span><br><span class="line">Namespace:                kube-system</span><br><span class="line">Labels:                   k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 k8s-app=kubernetes-dashboard</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP:                       10.254.51.226</span><br><span class="line">Port:                     &lt;<span class="built_in">unset</span>&gt;  443/TCP</span><br><span class="line">TargetPort:               8443/TCP</span><br><span class="line">NodePort:                 &lt;<span class="built_in">unset</span>&gt;  30001/TCP</span><br><span class="line">Endpoints:                10.254.39.3:8443</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹podæè¿°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl describe pod kubernetes-dashboard-6c655d9445-6zntr --namespace=kube-system</span></span><br><span class="line">Name:           kubernetes-dashboard-6c655d9445-6zntr</span><br><span class="line">Namespace:      kube-system</span><br><span class="line">Node:           172.21.17.31/172.21.17.31</span><br><span class="line">Start Time:     Thu, 29 Aug 2019 17:47:20 +0800</span><br><span class="line">Labels:         k8s-app=kubernetes-dashboard</span><br><span class="line">                pod-template-hash=6c655d9445</span><br><span class="line">Annotations:    &lt;none&gt;</span><br><span class="line">Status:         Running</span><br><span class="line">IP:             10.254.39.3</span><br></pre></td></tr></table></figure></li></ul><h3 id="2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™"><a href="#2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™" class="headerlink" title="2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™"></a>2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™</h3><p>è‹¥æœä¸è¿›è¡Œæˆæƒæ“ä½œï¼Œæ‰“å¼€dashboardä¼šæŠ¥é”™ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/WechatIMG28864.png" alt="img"></p><ul><li><p>æ–°å»ºkubrnetes-dashboard-admin-rbac.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubernetes-dashboard-admin-rbac.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Create ClusterRoleBinding</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f kubernetes-dashboard-admin-rbac.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>æ‰¾åˆ°kubernete-dashboard-adminçš„tokenï¼Œå¤åˆ¶tokenåœ¨dashboardé¡µé¢è¿›è¡Œç™»å½•ï¼Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl -n kube-system get secret | grep admin-user</span></span><br><span class="line">admin-user-token-qv49g             kubernetes.io/service-account-token   3      15h</span><br><span class="line"></span><br><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '&#123;print $1&#125;')</span></span><br><span class="line">Name:         admin-user-token-qv49g</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: ea3f0e3f-ca42-11e9-8716-fa163effd55b</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1359 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXF2NDlnIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlYTNmMGUzZi1jYTQyLTExZTktODcxNi1mYTE2M2VmZmQ1NWIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.AbdsJdgi9d0rCYrmvoJkWf32HKSMT03OyOX55aRhPptjzIjDcGxxQYecT0w58N7Z_2L2RwTBfOrm4B3wTEDfFZKgYsnGJQOzJMtZDN9w5YJg2xGQ27E3KisTbbQzd_I5DgxSZWW75GwWf756_bIQpWuXNRO_KjheyWuNNv0tSEYRiXpcboSQpb-8R-Km-vP85mxke6s5cJFSk0WLMjFWow1vOF1ns23NZ5nslEmYOMZF3_Fxybh3LbiCyrpD4c0FtfRcXaBIBqACeyCPRriYMIIJq3OJjI-DzuqUedu1x2xH2prB4mNjxlKt2-7q0M1zCuvm5JhW_LzWgveu9ni2ig</span><br></pre></td></tr></table></figure><h3 id="3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜"><a href="#3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜" class="headerlink" title="3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜"></a>3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;dashboard æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œé»˜è®¤çš„tokenå¤±æ•ˆçš„æ—¶é—´æ˜¯900ç§’ï¼Œ15åˆ†é’Ÿï¼Œæ¯15åˆ†é’Ÿå°±è¦è¿›è¡Œä¸€æ¬¡è®¤è¯ï¼Œè¿™æ ·å¯¹äºè¿ç»´äººå‘˜æ¥è¯´å°±ä¸æ˜¯ç‰¹åˆ«çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹token-ttlå‚æ•°æ¥è®¾ç½®ï¼Œä¸»è¦æ˜¯ä¿®æ”¹dashboradçš„yamlæ–‡ä»¶ï¼Œå¹¶é‡æ–°å»ºç«‹å³å¯</p><h4 id="3-1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹-æ·»åŠ "><a href="#3-1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹-æ·»åŠ " class="headerlink" title="3.1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹/æ·»åŠ "></a>3.1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹/æ·»åŠ </h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- containerPort: 8443</span><br><span class="line">  protocol: TCP</span><br><span class="line">args:</span><br><span class="line">  - --auto-generate-certificates</span><br><span class="line">  - --token-ttl=43200</span><br></pre></td></tr></table></figure><ul><li>é‡å»ºpod<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl apply -f kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>æˆ‘ä»¬å¯ä»¥è¾“å…¥ä»»æ„èŠ‚ç‚¹çš„ipåŠ 30001ç«¯å£å°±å¯ä»¥è®¿é—®dashboard, https://{ip}:30001ã€‚</p><h3 id="å…¶ä»–æ“ä½œ"><a href="#å…¶ä»–æ“ä½œ" class="headerlink" title="å…¶ä»–æ“ä½œ"></a>å…¶ä»–æ“ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ¯å¤©æˆ‘ä»¬æ¥å…¬å¸è¦ç™»å½•dashboardçš„æ—¶å€™éƒ½è¦å»è¾“å…¥ä¸€æ¬¡tokenï¼Œæ¯æ¬¡å»è·å–tokençš„æ—¶å€™éƒ½è¦è¾“å…¥å¾ˆé•¿çš„ä¸€ä¸²ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥å†™ä¸€ä¸ªè„šæœ¬ï¼Œè¦tokençš„æ—¶å€™æ‰§è¡Œä¸€ä¸‹è„šæœ¬ï¼Œå°±å¯ä»¥ã€‚</p><ul><li><p>åˆ›å»ºè„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim kube-token</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®è„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chmod +x kube-token</span></span><br><span class="line"><span class="comment"># mv kube-token /usr/bin</span></span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>k8såˆ é™¤nodeé‡æ–°åŠ å…¥</title>
    <url>/2019/08/29/k8s%E5%88%A0%E9%99%A4node%E9%87%8D%E6%96%B0%E5%8A%A0%E5%85%A5/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;æœ‰æ—¶å€™k8s node åœ¨åŠ å…¥é›†ç¾¤çš„æ—¶å€™ä¸ç»æ„çš„æ—¶å€™å¼„é”™å•¦æŸäº›ä¸œè¥¿ï¼Œè¿™æ—¶å€™å¯ä»¥æŠŠè¿™ä¸ªnodeåˆ é™¤ï¼Œç„¶åé‡æ–°åŠ å…¥ï¼Œåˆ é™¤èŠ‚ç‚¹ä¹‹å‰æˆ‘ä»¬éœ€è¦åšä¸€ä¸‹å¸¸è§„åŒ–çš„æ“ä½œï¼Œæ¥ä¿éšœè¿è¡Œåœ¨è¯¥èŠ‚ç‚¹çš„podè¿ç§»åˆ°å…¶ä»–çš„nodeä¸Šã€‚</p><a id="more"></a><ul><li><p>1ã€å…ˆé©±èµ¶ä¸Šé¢çš„pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl drain 172.21.110 --delete-local-data</span></span><br><span class="line">node/172.21.110 cordoned</span><br><span class="line">node/172.21.110 drained</span><br></pre></td></tr></table></figure></li><li><p>2ã€åˆ é™¤èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl delete node 172.21.110</span></span><br><span class="line">node <span class="string">"172.21.110"</span> deleted</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>kubectl delete</code> å‘½ä»¤æœ¬èº«æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥è¿›è¡Œä»»ä½•èµ„æºçš„åˆ é™¤<code>kubectl delete type typename</code>ï¼Œtypeæ˜¯èµ„æºç±»å‹ï¼Œå¯ä»¥æ˜¯<code>node, pod, rs, rc, deployment, service</code>ç­‰ç­‰ï¼Œtypenameæ˜¯è¿™ä¸ªèµ„æºçš„åç§°</p><ul><li><p>3ã€æŸ¥çœ‹nodeæ˜¯å¦è¢«åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.17.30   Ready    &lt;none&gt;   20m   v1.13.3</span><br><span class="line">172.21.17.31   Ready    &lt;none&gt;   10m   v1.13.3</span><br></pre></td></tr></table></figure></li><li><p>4ã€å½»åº•åˆ é™¤node<br>è¿›å…¥è¯¥èŠ‚ç‚¹ã€‚åˆ é™¤<code>kubelet.kubeconfig</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-3 kubernetes]<span class="comment"># rm -rf  kubelet.kubeconfig</span></span><br></pre></td></tr></table></figure></li><li><p>4ã€nodeé‡æ–°åŠ å…¥é›†ç¾¤<br>&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬çš„nodeæ‰§è¡Œåˆ é™¤ä»¥åï¼Œé‡æ–°å¯åŠ¨kubeletæœåŠ¡ä»¥åã€‚nodeåˆä¼šè‡ªåŠ¨çš„åŠ å…¥åˆ°é›†ç¾¤é‡Œé¢æ¥ï¼Œæ€ä¹ˆå½»åº•çš„åˆ é™¤ï¼Œè®©åé‡å¯kubeletçš„æ—¶å€™é‡æ–°åƒé›†ç¾¤é‡Œé¢å‘å‡ºcsrè¯·æ±‚ï¼Œé›†ç¾¤é‡æ–°é€šè¿‡è¯¥èŠ‚ç‚¹çš„csrè¯·æ±‚å§è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤æ¥ï¼Œ<code>kubelet.kubeconfig</code>ä¹Ÿé‡æ–°ç”Ÿæˆ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE     REQUESTOR           CONDITION</span><br><span class="line">node-csr-H1CAqJw4VZYY67-tk4Akuso_uuPPwpj3d5jK3xcL88M   8m      kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-YPvpbITaxGBrOxuCpGiY7jrGpPNSZ4sdbKhSkUEcdnc   7m54s   kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek   5s      kubelet-bootstrap   Pending</span><br><span class="line">node-csr-u4oi5e0Upt-ZmejSDEFm9Q0RU3wZf9bThU_o51nclgg   17m     kubelet-bootstrap   Approved,Issued</span><br></pre></td></tr></table></figure></li><li><p>5ã€é‡æ–°é€šè¿‡csr</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl certificate approve node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek </span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek approved</span><br></pre></td></tr></table></figure></li><li><p>6ã€åœ¨é›†ç¾¤æŸ¥çœ‹èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.16.110   Ready    &lt;none&gt;   36s   v1.13.3</span><br><span class="line">172.21.17.30    Ready    &lt;none&gt;   28m   v1.13.3</span><br><span class="line">172.21.17.31    Ready    &lt;none&gt;   17m   v1.13.3</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>node</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos routeç­–ç•¥</title>
    <url>/2019/08/28/Centos-route%E7%AD%96%E7%95%A5/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸ä¸šåŠ¡åœ¨ä¸€ä¸ªæ–°çš„äº‘å¹³å°ä¸Šçº¿ï¼Œè¯¥äº‘å¹³å°ä½¿ç”¨çš„æ˜¯æ¯”è¾ƒä¼ ç»Ÿçš„VMware vSphereæ¥åšçš„è™šæ‹ŸåŒ–ï¼Œè€Œä¸”è¯¥äº‘å¹³å°ç½‘ç»œä¹Ÿæ˜¯æˆ‘ä»¬ä¸æ¸…æ¥šçš„ï¼Œåæ­£å°±æ˜¯ä¸èƒ½è®¾ç½®(ä¸èƒ½åƒç°åœ¨ä¸»æµäº‘å¹³å°è‡ªå®šä¹‰ç½‘ç»œæˆ–è€…æ˜¯åœ°å€æ®µ)ï¼Œæ˜¯ä¸€ä¸ªæ”¿åºœçš„äº‘å¹³å°ï¼Œå…·ä½“å„ç§å¥‡è‘©çš„é™åˆ¶å°±ä¸è¯´å•¦ï¼Œä½ æ‡‚çš„â€¦â€¦</p></blockquote><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;æ ¹æ®æˆ‘ä»¬è‡ªèº«ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå†…ç½‘åœ°å€æ®µï¼Œå’Œå¯¹æ–¹åå•†åç»™æˆ‘ä»¬å¼€äº†ä¸€ä¸ª10ç½‘æ®µï¼Œ20çš„å­ç½‘ï¼Œç„¶åè¦äº†ä¸¤å°å¸¦æœ‰å¤–ç½‘ipçš„æœåŠ¡å™¨ï¼Œä¸€ä¸ªç”¨æ¥åšè·³æ¿æœºï¼Œä¸€ä¸ªç”¨æ¥åšåå‘ä»£ç†ã€‚ç„¶åç­‰äº†ä¸¤å¤©å¯¹æ–¹å§æœåŠ¡å™¨ç»™æˆ‘ä»¬å¼€å¥½äº†ï¼Œæˆ‘ä»¬ç™»å½•è·³æ¿æœºï¼Œå‘ç°åªæœ‰å¤–ç½‘ipçš„æœåŠ¡å™¨æ‰èƒ½ä¸Šç½‘ï¼Œå…¶ä»–çš„å‡ä¸èƒ½ä¸Šç½‘ï¼Œåšnatä¹Ÿä¸èƒ½ä¸Šï¼Œä½†æ˜¯è·³æ¿æœºæ˜¯å…¬ç½‘ï¼Œæ²¡æœ‰å†…ç½‘ï¼Œå¯ä»¥é€šå†…ç½‘çš„ipæœåŠ¡å™¨ï¼Œæ‰€ä»¥çŒœæµ‹ç½‘ç»œç­–ç•¥è‚¯å®šæ˜¯ä»–ä»¬åœ¨äº¤æ¢æœºä¸Šåšçš„ã€‚ç„¶åæˆ‘ä»¬è‡ªå·±yumæºæ¥å®‰è£…ä¸€äº›ä¸­é—´ä»¶ã€‚ï¼ˆä¸è¯´äº†ï¼Œåé¢è¿˜æœ‰ä¸€å †çš„å¥‡è‘©é—®é¢˜ï¼Œè¿›å…¥æ­£é¢˜å§ï¼‰</p><h3 id="åæœŸé—®é¢˜"><a href="#åæœŸé—®é¢˜" class="headerlink" title="åæœŸé—®é¢˜"></a>åæœŸé—®é¢˜</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬æŠŠä¸šåŠ¡éƒ¨ç½²ä¸Šçº¿ä»¥åï¼Œè¿è¡Œä¸€æ®µæ—¶é—´åå‡ºç°å¾®æœåŠ¡ä¹‹é—´è°ƒç”¨è¶…æ—¶ï¼Œç„¶åæˆ‘ä»¬ç™»å½•æœåŠ¡å™¨æ’æŸ¥ç½‘ç»œé—®é¢˜ï¼Œåœ¨æœåŠ¡å™¨ä¹‹é—´pingå†…ç½‘æ²¡é—®é¢˜ï¼Œpingæ³¨å†Œä¸­å¿ƒã€æ•°æ®åº“éƒ½æ²¡é—®é¢˜ã€‚æœåŠ¡å™¨æœ‰å…¬ç½‘ï¼Œç„¶åå…¬ç½‘ä¹‹é—´pingéƒ½æ²¡é—®é¢˜ï¼Œç½‘ç»œå±‚é¢æ²¡æœ‰ä»»ä½•çš„é—®é¢˜ï¼ŒæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ä¹Ÿæœ‰å‘ç°é”™è¯¯ï¼Œç„¶åå•ç‹¬çš„å§å€Ÿå£åœ°å€æ‹¿å‡ºæ¥è¿›è¡Œ<code>curl</code>èƒ½è¿‡ä½†æ˜¯æœ‰ç‚¹æ…¢ï¼Œç„¶åå°±å§è¿™ä¸ªå‘½ä»¤å†™åœ¨è„šæœ¬é‡Œé¢ï¼Œè®©ä»–æ¯30ç§’è·‘ä¸€æ¬¡ï¼Œç„¶åè¿½åŠ æ—¥å¿—ï¼Œè·‘äº†ä¸¤ä¸‰ä¸ªå°æ—¶ï¼Œæˆ‘ä»¬æŸ¥çœ‹æ—¥å¿—ï¼Œæ—¥å¿—é‡Œé¢ä¹Ÿæœ‰è¶…æ—¶ç°è±¡ï¼Œå¥‡æ€ªäº†ï¼Œç„¶åå§è¿™ä¸ªé—®é¢˜è”ç³»å¯¹æ–¹äº‘å¹³å°çš„å·¥ç¨‹å¸ˆï¼Œç³»ç»Ÿå·¥ç¨‹å¸ˆã€ç½‘ç»œå·¥ç¨‹å¸ˆæ‹‰ç¾¤è®¨è®ºï¼Œæœ€åå¯¹æ–¹ç³»ç»Ÿå·¥ç¨‹å¸ˆæç¤ºæˆ‘ä»¬è®©æˆ‘ä»¬å§è·¯ç”±çš„<code>Metric</code>å€¼ä¸¤ä¸ªç½‘å¡ä¸è¦ä¸€æ ·ï¼Œå¯¹<code>Metric</code>åˆšå¼€å§‹ä¸€å¹´æ‡µé€¼ï¼Œå…ˆä¸ç®¡ï¼Œè§£å†³é—®é¢˜å†è¯´ï¼š</p><ul><li><p>ä¿®æ”¹Metric(å†…ç½‘å¡)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br><span class="line">$ sudo route add -net 10.10.20.0/22 dev ens160 metric 98</span><br><span class="line">$ sudo route  del -net 10.10.20.0/22 dev ens160 metric 100</span><br></pre></td></tr></table></figure></li><li><p>è®°ä½æ˜¯å…ˆæ·»åŠ åˆ é™¤ï¼Œé¡ºåºä¸è¦é¢ å€’</p></li><li><p>æŸ¥çœ‹è·¯ç”±</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         119.126.116.254 0.0.0.0         UG    100    0        0 ens192</span><br><span class="line">10.10.20.0      0.0.0.0         255.255.252.0   U     98     0        0 ens160</span><br><span class="line">119.126.116.128 0.0.0.0         255.255.255.128 U     100    0        0 ens192</span><br></pre></td></tr></table></figure></li><li><p>ens192(å¤–ç½‘å¡)</p></li><li><p>ens160(å†…ç½‘å¡)</p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;æ¶‰åŠåˆ°çš„ä¸šåŠ¡æœåŠ¡å™¨éƒ½ä¿®æ”¹ï¼Œä¿®æ”¹Metricå€¼ä»¥åï¼Œæˆ‘ä»¬<code>curl</code>ä¸€æ¬¡ï¼Œé€Ÿåº¦æ¯”ä»¥å‰å¿«å¤šäº†ï¼Œåˆè·‘äº†ä¸€æ¬¡è„šæœ¬ï¼Œè§‚å¯Ÿäº†å‡ ä¸ªå°æ—¶æ²¡é—®é¢˜ï¼Œè§‚å¯Ÿäº†ä¸¤å¤©ï¼Œä¸šåŠ¡æ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œæ—¥å¿—é‡Œé¢ä¹Ÿæ²¡æœ‰å‡ºç°è¶…æ—¶ï¼Œé—®é¢˜å¾—åˆ°è§£å†³</p><h3 id="Metric-ä»‹ç»"><a href="#Metric-ä»‹ç»" class="headerlink" title="Metric ä»‹ç»"></a>Metric ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºè·¯ç”±æŒ‡å®šæ‰€éœ€è·ƒç‚¹æ•°çš„æ•´æ•°å€¼ï¼ˆèŒƒå›´æ˜¯ 1 ~ 9999ï¼‰ï¼Œå®ƒç”¨æ¥åœ¨è·¯ç”±è¡¨é‡Œçš„å¤šä¸ªè·¯ç”±ä¸­é€‰æ‹©ä¸è½¬å‘åŒ…ä¸­çš„ç›®æ ‡åœ°å€æœ€ä¸ºåŒ¹é…çš„è·¯ç”±ã€‚æ‰€é€‰çš„è·¯ç”±å…·æœ‰æœ€å°‘çš„è·ƒç‚¹æ•°ã€‚è·ƒç‚¹æ•°èƒ½å¤Ÿåæ˜ è·ƒç‚¹çš„æ•°é‡ã€è·¯å¾„çš„é€Ÿåº¦ã€è·¯å¾„å¯é æ€§ã€è·¯å¾„ååé‡ä»¥åŠç®¡ç†å±æ€§ã€‚Metricçš„å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼›å¦‚æœä¸¤å—ç½‘å¡çš„Metricçš„å€¼ç›¸åŒï¼Œå°±ä¼šå‡ºç°æŠ¢å ä¼˜å…ˆçº§ç»§è€Œç½‘å¡å†²çªï¼Œå°†ä¼šæœ‰ä¸€å—ç½‘å¡æ— æ³•è¿æ¥</p><p>æ›´å¤šä»‹ç»<a href="https://www.cyberciti.biz/faq/what-is-a-routing-table/" target="_blank" rel="noopener">å‚è€ƒ</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>route</tag>
        <tag>Metric</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²ingress</title>
    <url>/2019/08/26/k8s%E9%83%A8%E7%BD%B2ingress/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><p>åœ¨kubernetes é›†ç¾¤ä¸­ï¼Œä¸€ä¸ªæœåŠ¡å®‰è£…ä»¥åæ€ä¹ˆå¯¹å¤–æä¾›è®¿é—®ï¼Œå¤–éƒ¨ç”¨æˆ·æ€ä¹ˆæ¥è®¿é—®æˆ‘ä»¬å®¹å™¨ä¸­ä¸šåŠ¡ã€‚</p><p><img src="https://img.xxlaila.cn/2373874sds43.png" alt="img"></p><h3 id="1ã€Ingress-ä»‹ç»"><a href="#1ã€Ingress-ä»‹ç»" class="headerlink" title="1ã€Ingress ä»‹ç»"></a>1ã€Ingress ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes æš´éœ²æœåŠ¡çš„æ–¹å¼ç›®å‰åªæœ‰ä¸‰ç§ï¼šLoadBlancer Serviceã€NodePort Serviceã€Ingressï¼›æœ¬æ–‡ä¸»è¦é€šè¿‡Ingressæ¥è®¿é—®</p><h3 id="2ã€Ingress-æ˜¯ä»€ä¹ˆ"><a href="#2ã€Ingress-æ˜¯ä»€ä¹ˆ" class="headerlink" title="2ã€Ingress æ˜¯ä»€ä¹ˆ"></a>2ã€Ingress æ˜¯ä»€ä¹ˆ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Ingress å°±æ˜¯èƒ½åˆ©ç”¨ Nginxã€Haproxy å•¥çš„è´Ÿè½½å‡è¡¡å™¨æš´éœ²é›†ç¾¤å†…æœåŠ¡çš„å·¥å…·é—®é¢˜æ¥äº†ï¼Œé›†ç¾¤å†…æœåŠ¡æƒ³è¦æš´éœ²å‡ºå»é¢ä¸´ç€å‡ ä¸ªé—®é¢˜ï¼š</p><a id="more"></a><ul><li><p>Pod æ¼‚ç§»é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¼—æ‰€å‘¨çŸ¥ Kubernetes å…·æœ‰å¼ºå¤§çš„å‰¯æœ¬æ§åˆ¶èƒ½åŠ›ï¼Œèƒ½ä¿è¯åœ¨ä»»æ„å‰¯æœ¬(Pod)æŒ‚æ‰æ—¶è‡ªåŠ¨ä»å…¶ä»–æœºå™¨å¯åŠ¨ä¸€ä¸ªæ–°çš„ï¼Œè¿˜å¯ä»¥åŠ¨æ€æ‰©å®¹ç­‰ï¼Œæ€»ä¹‹ä¸€å¥è¯ï¼Œè¿™ä¸ª Pod å¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»å‡ºç°åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»æ­»åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šï¼›é‚£ä¹ˆè‡ªç„¶éšç€ Pod çš„åˆ›å»ºå’Œé”€æ¯ï¼ŒPod IP è‚¯å®šä¼šåŠ¨æ€å˜åŒ–ï¼›é‚£ä¹ˆå¦‚ä½•æŠŠè¿™ä¸ªåŠ¨æ€çš„ Pod IP æš´éœ²å‡ºå»ï¼Ÿè¿™é‡Œå€ŸåŠ©äº Kubernetes çš„ Service æœºåˆ¶ï¼ŒService å¯ä»¥ä»¥æ ‡ç­¾çš„å½¢å¼é€‰å®šä¸€ç»„å¸¦æœ‰æŒ‡å®šæ ‡ç­¾çš„ Podï¼Œå¹¶ç›‘æ§å’Œè‡ªåŠ¨è´Ÿè½½ä»–ä»¬çš„ Pod IPï¼Œé‚£ä¹ˆæˆ‘ä»¬å‘å¤–æš´éœ²åªæš´éœ² Service IP å°±è¡Œäº†ï¼›è¿™å°±æ˜¯ NodePort æ¨¡å¼ï¼šå³åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¼€èµ·ä¸€ä¸ªç«¯å£ï¼Œç„¶åè½¬å‘åˆ°å†…éƒ¨ Service IP ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://img.xxlaila.cn/4dfs98347sdhsfs.png" alt="img"></p></li><li><p>ç«¯å£ç®¡ç†é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;é‡‡ç”¨ NodePort æ–¹å¼æš´éœ²æœåŠ¡é¢ä¸´ä¸€ä¸ªå‘çˆ¹çš„é—®é¢˜æ˜¯ï¼ŒæœåŠ¡ä¸€æ—¦å¤šèµ·æ¥ï¼ŒNodePort åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¼€å¯çš„ç«¯å£ä¼šåŠå…¶åºå¤§ï¼Œè€Œä¸”éš¾ä»¥ç»´æŠ¤ï¼›è¿™æ—¶å€™å¼•å‡ºçš„æ€è€ƒé—®é¢˜æ˜¯ â€œèƒ½ä¸èƒ½ä½¿ç”¨ Nginx å•¥çš„åªç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œæ¯”å¦‚ 80ï¼Œç„¶åæŒ‰ç…§åŸŸåå‘åè½¬å‘ï¼Ÿâ€ ç®€å•çš„å®ç°å°±æ˜¯ä½¿ç”¨ DaemonSet åœ¨æ¯ä¸ª node ä¸Šç›‘å¬ 80ï¼Œç„¶åå†™å¥½è§„åˆ™ï¼Œå› ä¸º Nginx å¤–é¢ç»‘å®šäº†å®¿ä¸»æœº 80 ç«¯å£(å°±åƒ NodePort)ï¼Œæœ¬èº«åˆåœ¨é›†ç¾¤å†…ï¼Œé‚£ä¹ˆå‘åç›´æ¥è½¬å‘åˆ°ç›¸åº” Service IP å°±è¡Œäº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://img.xxlaila.cn/85793kdfksdo43.png" alt="img"></p></li><li><p>åŸŸååˆ†é…åŠåŠ¨æ€æ›´æ–°é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢çš„æ€è·¯ï¼Œé‡‡ç”¨ Nginx ä¼¼ä¹å·²ç»è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯å…¶å®è¿™é‡Œé¢æœ‰ä¸€ä¸ªå¾ˆå¤§ç¼ºé™·ï¼šæ¯æ¬¡æœ‰æ–°æœåŠ¡åŠ å…¥æ€ä¹ˆæ”¹ Nginx é…ç½®ï¼Ÿæ€»ä¸èƒ½æ‰‹åŠ¨æ”¹æˆ–è€…æ¥ä¸ª Rolling Update å‰ç«¯ Nginx Pod å§ï¼Ÿè¿™æ—¶å€™ â€œä¼Ÿå¤§è€Œåˆæ­£ç›´å‹‡æ•¢çš„â€ Ingress ç™»åœºï¼Œå¦‚æœä¸ç®—ä¸Šé¢çš„ Nginxï¼ŒIngress åªæœ‰ä¸¤å¤§ç»„ä»¶ï¼šIngress Controller å’Œ Ingress<br>&nbsp;&nbsp;&nbsp;&nbsp;Ingress ç®€å•çš„ç†è§£å°±æ˜¯ ä½ åŸæ¥è¦æ”¹ Nginx é…ç½®ï¼Œç„¶åé…ç½®å„ç§åŸŸåå¯¹åº”å“ªä¸ª Serviceï¼Œç°åœ¨æŠŠè¿™ä¸ªåŠ¨ä½œæŠ½è±¡å‡ºæ¥ï¼Œå˜æˆä¸€ä¸ª Ingress å¯¹è±¡ï¼Œä½ å¯ä»¥ç”¨ yml åˆ›å»ºï¼Œæ¯æ¬¡ä¸è¦å»æ”¹ Nginx äº†ï¼Œç›´æ¥æ”¹ yml ç„¶ååˆ›å»º/æ›´æ–°å°±è¡Œäº†ï¼›é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šâ€Nginx å’‹æ•´ï¼Ÿâ€<br>&nbsp;&nbsp;&nbsp;&nbsp;Ingress Controller è¿™ä¸œè¥¿å°±æ˜¯è§£å†³ â€œNginx å’‹æ•´â€ çš„ï¼›Ingress Controoler é€šè¿‡ä¸ Kubernetes API äº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ Ingress è§„åˆ™å˜åŒ–ï¼Œç„¶åè¯»å–ä»–ï¼ŒæŒ‰ç…§ä»–è‡ªå·±æ¨¡æ¿ç”Ÿæˆä¸€æ®µ Nginx é…ç½®ï¼Œå†å†™åˆ° Nginx Pod é‡Œï¼Œæœ€å reload ä¸€ä¸‹ï¼Œå·¥ä½œæµç¨‹å¦‚ä¸‹å›¾:</p></li></ul><p><img src="https://img.xxlaila.cn/3248kjfiy4789wodjkshf3.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;å½“ç„¶åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæœ€æ–°ç‰ˆæœ¬ Kubernetes å·²ç»å°† Nginx ä¸ Ingress Controller åˆå¹¶ä¸ºä¸€ä¸ªç»„ä»¶ï¼Œæ‰€ä»¥ Nginx æ— éœ€å•ç‹¬éƒ¨ç½²ï¼Œåªéœ€è¦éƒ¨ç½² Ingress Controller å³å¯ã€‚</p><h3 id="3ã€Nginx-Ingress"><a href="#3ã€Nginx-Ingress" class="headerlink" title="3ã€Nginx Ingress"></a>3ã€Nginx Ingress</h3><h4 id="3-1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶"><a href="#3-1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶" class="headerlink" title="3.1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶"></a>3.1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶</h4><p>å®˜æ–¹çš„mandatory.yamlæ–‡ä»¶é‡Œé¢åŒ…å«äº†ingress RBACï¼Œé‡è¦çš„ç»„ä»¶ <a href="https://github.com/kubernetes/ingress-nginx/tree/nginx-0.20.0/deploy" target="_blank" rel="noopener">Nginx+Ingres Controller</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mandatory.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-configuration</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: udp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-serviceaccount</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - endpoints</span><br><span class="line">      - nodes</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - nodes</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">"extensions"</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - events</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">      - patch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">"extensions"</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses/status</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">      - namespaces</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    resourceNames:</span><br><span class="line">      <span class="comment"># Defaults to "&lt;election-id&gt;-&lt;ingress-class&gt;"</span></span><br><span class="line">      <span class="comment"># Here: "&lt;ingress-controller-leader&gt;-&lt;nginx&gt;"</span></span><br><span class="line">      <span class="comment"># This has to be adapted if you change either parameter</span></span><br><span class="line">      <span class="comment"># when launching the nginx-ingress-controller.</span></span><br><span class="line">      - <span class="string">"ingress-controller-leader-nginx"</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - endpoints</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role-nisa-binding</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">      app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: <span class="string">"10254"</span></span><br><span class="line">        prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx-ingress-controller</span><br><span class="line">          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.22.0</span><br><span class="line">          args:</span><br><span class="line">            - /nginx-ingress-controller</span><br><span class="line">            - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class="line">            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class="line">            - --publish-service=$(POD_NAMESPACE)/ingress-nginx</span><br><span class="line">            - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line">     --default-ssl-certificate=$(POD_NAMESPACE)/ingress-secret</span><br><span class="line">      --default-backend-service=$(POD_NAMESPACE)/default-http-backend</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: <span class="literal">true</span></span><br><span class="line">            capabilities:</span><br><span class="line">              drop:</span><br><span class="line">                - ALL</span><br><span class="line">              add:</span><br><span class="line">                - NET_BIND_SERVICE</span><br><span class="line">            <span class="comment"># www-data -&gt; 33</span></span><br><span class="line">            runAsUser: 33</span><br><span class="line">          env:</span><br><span class="line">            - name: POD_NAME</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.name</span><br><span class="line">            - name: POD_NAMESPACE</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.namespace</span><br><span class="line">          ports:</span><br><span class="line">            - name: http</span><br><span class="line">              containerPort: 80</span><br><span class="line">              hostPort: 80</span><br><span class="line">            - name: https</span><br><span class="line">              containerPort: 443</span><br><span class="line">              hostPort: 443</span><br><span class="line">          livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">          readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>hostNetwork: true</code>æ˜¯å¢åŠ çš„ï¼Œ å®˜æ–¹çš„ Ingress Controller æœ‰ä¸ªå‘ï¼Œé»˜è®¤æ³¨é‡Šäº†hostNetwork å·¥ä½œæ–¹å¼ã€‚ä»¥é˜²æ­¢ç«¯å£çš„åœ¨å®¿ä¸»æœºçš„å†²çªã€‚æ²¡æœ‰ç»‘å®šåˆ°å®¿ä¸»æœº 80 ç«¯å£ï¼Œä¹Ÿå°±æ˜¯è¯´å‰ç«¯ Nginx æ²¡æœ‰ç›‘å¬å®¿ä¸»æœº 80 ç«¯å£ï¼›æ‰€ä»¥éœ€è¦æŠŠé…ç½®æä¸‹æ¥è‡ªå·±åŠ ä¸€ä¸‹ hostNetworkã€‚</p><h4 id="3-2ã€éƒ¨ç½²é»˜è®¤åç«¯"><a href="#3-2ã€éƒ¨ç½²é»˜è®¤åç«¯" class="headerlink" title="3.2ã€éƒ¨ç½²é»˜è®¤åç«¯"></a>3.2ã€éƒ¨ç½²é»˜è®¤åç«¯</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬çŸ¥é“ å‰ç«¯çš„ Nginx æœ€ç»ˆè¦è´Ÿè½½åˆ°åç«¯ service ä¸Šï¼Œé‚£ä¹ˆå¦‚æœè®¿é—®ä¸å­˜åœ¨çš„åŸŸåå’‹æ•´ï¼Ÿå®˜æ–¹ç»™å‡ºçš„å»ºè®®æ˜¯éƒ¨ç½²ä¸€ä¸ª é»˜è®¤åç«¯ï¼Œå¯¹äºæœªçŸ¥è¯·æ±‚å…¨éƒ¨è´Ÿè½½åˆ°è¿™ä¸ªé»˜è®¤åç«¯ä¸Šï¼›è¿™ä¸ªåç«¯å•¥ä¹Ÿä¸å¹²ï¼Œå°±æ˜¯è¿”å› 404ï¼Œéƒ¨ç½²å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat default-backend.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: default-http-backend</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - name: default-http-backend</span><br><span class="line">        <span class="comment"># Any image is permissable as long as:</span></span><br><span class="line">        <span class="comment"># 1. It serves a 404 page at /</span></span><br><span class="line">        <span class="comment"># 2. It serves 200 on a /healthz endpoint</span></span><br><span class="line">        image: docker.io/xxlaila/defaultbackend:1.4</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line"><span class="comment">#      nodeSelector:</span></span><br><span class="line"><span class="comment">#        kubernetes.io/hostname: 172.21.16.231</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: default-http-backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: default-http-backend</span><br></pre></td></tr></table></figure><h4 id="3-3ã€æ‰§è¡Œåˆ›å»º-å®Œæˆåå¯ä»¥çœ‹åˆ°"><a href="#3-3ã€æ‰§è¡Œåˆ›å»º-å®Œæˆåå¯ä»¥çœ‹åˆ°" class="headerlink" title="3.3ã€æ‰§è¡Œåˆ›å»º,å®Œæˆåå¯ä»¥çœ‹åˆ°"></a>3.3ã€æ‰§è¡Œåˆ›å»º,å®Œæˆåå¯ä»¥çœ‹åˆ°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f mandatory.yaml </span></span><br><span class="line"><span class="comment"># kubectl create -f default-backend.yaml</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/34dnksjfh384yksfkjdsfsd.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n ingress-nginx</span></span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">default-http-backend-66cdcb6c7d-pb9sp      1/1     Running   0          8h</span><br><span class="line">nginx-ingress-controller-69585dbb4-m6fcm   1/1     Running   0          8h</span><br><span class="line"><span class="comment"># kubectl get svc -n ingress-nginx</span></span><br><span class="line">NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default-http-backend   ClusterIP   10.102.60.154   &lt;none&gt;        80/TCP    8h</span><br></pre></td></tr></table></figure><h3 id="4ã€éƒ¨ç½²-Ingress"><a href="#4ã€éƒ¨ç½²-Ingress" class="headerlink" title="4ã€éƒ¨ç½² Ingress"></a>4ã€éƒ¨ç½² Ingress</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢å¯ä»¥çŸ¥é“ Ingress å°±æ˜¯ä¸ªè§„åˆ™ï¼ŒæŒ‡å®šå“ªä¸ªåŸŸåè½¬å‘åˆ°å“ªä¸ª Serviceï¼Œæ‰€ä»¥è¯´é¦–å…ˆæˆ‘ä»¬å¾—æœ‰ä¸ª Serviceï¼Œå½“ç„¶ Service å»å“ªæ‰¾è¿™é‡Œå°±ä¸ç®¡äº†ï¼›è¿™é‡Œé»˜è®¤ä¸ºå·²ç»æœ‰äº†ä¸¤ä¸ªå¯ç”¨çš„ Serviceï¼Œä»¥ä¸‹ä»¥ jenkinsã€Dashboard ä¸ºä¾‹<br>&nbsp;&nbsp;&nbsp;&nbsp;å…ˆå†™ä¸€ä¸ª Ingress æ–‡ä»¶ï¼Œè¯­æ³•æ ¼å¼å•¥çš„è¯·å‚è€ƒ å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºæˆ‘çš„ jenkinsåœ¨kube-opsï¼ŒDashboard åœ¨kube-system è¿™ä¸ªå‘½åç©ºé—´ï¼Œæ‰€ä»¥è¦æŒ‡å®š namespace.å‚è€ƒä¸‹é¢å®ä¾‹</p><h4 id="4-1ã€éƒ¨ç½²jenkinså®ä¾‹"><a href="#4-1ã€éƒ¨ç½²jenkinså®ä¾‹" class="headerlink" title="4.1ã€éƒ¨ç½²jenkinså®ä¾‹"></a>4.1ã€éƒ¨ç½²jenkinså®ä¾‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-ingress</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: ci.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: jenkins2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"><span class="comment"># kubectl create -f jenkins-ingress.yaml</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒåŸŸåè§£æåˆ°ipåœ°å€ï¼Œè®¿é—®jenkins</p><p><img src="https://img.xxlaila.cn/1566808344775.jpg" alt="img"></p><h4 id="4-2ã€éƒ¨ç½²kubernetes-dashboard"><a href="#4-2ã€éƒ¨ç½²kubernetes-dashboard" class="headerlink" title="4.2ã€éƒ¨ç½²kubernetes-dashboard"></a>4.2ã€éƒ¨ç½²kubernetes-dashboard</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat nginx-kubernetes-dashboard.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/ingress.class: nginx</span><br><span class="line">    nginx.ingress.kubernetes.io/secure-backends: <span class="string">"true"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-passthrough: <span class="string">"true"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - k8s.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">    - host: dashboard.xxlaila.io</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: kubernetes-dashboard</span><br><span class="line">            servicePort: 443</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/786jg656iojhf0.png" alt="img"></p><h3 id="5ã€éƒ¨ç½²-Ingress-TLS"><a href="#5ã€éƒ¨ç½²-Ingress-TLS" class="headerlink" title="5ã€éƒ¨ç½² Ingress TLS"></a>5ã€éƒ¨ç½² Ingress TLS</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢å·²ç»åšå¥½äº† Ingressï¼Œæ¥ä¸‹æ¥é…ç½®TLS ï¼›å®˜æ–¹ç»™å‡ºçš„æ ·ä¾‹å¾ˆç®€å•ï¼Œå¤§è‡´æ­¥éª¤å°±ä¸¤æ­¥ï¼šåˆ›å»ºä¸€ä¸ªå«æœ‰è¯ä¹¦çš„ secretã€åœ¨ Ingress å¼€å¯è¯ä¹¦ï¼›ä½†æ˜¯å®˜æ–¹çš„æœ‰å‘ï¼Œä¸‹é¢æ˜¯æ“ä½œæ­¥éª¤</p><h4 id="5-1ã€åˆ›å»ºè¯ä¹¦"><a href="#5-1ã€åˆ›å»ºè¯ä¹¦" class="headerlink" title="5.1ã€åˆ›å»ºè¯ä¹¦"></a>5.1ã€åˆ›å»ºè¯ä¹¦</h4><p>é¦–å…ˆç¬¬ä¸€æ­¥å½“ç„¶è¦æœ‰ä¸ªè¯ä¹¦ï¼Œç”±äºæˆ‘è¿™ä¸ª Ingress æœ‰ä¸¤ä¸ªæœåŠ¡åŸŸåï¼Œæ‰€ä»¥è¯ä¹¦è¦æ”¯æŒä¸¤ä¸ªåŸŸåï¼›ç”Ÿæˆè¯ä¹¦å‘½ä»¤å¦‚ä¸‹ï¼š</p><ul><li><p>ç”ŸæˆCAè¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir cert &amp;&amp; cd cert</span></span><br></pre></td></tr></table></figure></li><li><p>ç¼–è¾‘ openssl é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /etc/pki/tls/openssl.cnf .</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ä¸»è¦é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi openssl.cnf</span></span><br><span class="line">	[req]</span><br><span class="line">	req_extensions = v3_req <span class="comment"># è¿™è¡Œé»˜è®¤æ³¨é‡Šå…³ç€çš„ æŠŠæ³¨é‡Šåˆ æ‰</span></span><br></pre></td></tr></table></figure></li><li><p>å¢åŠ é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi openssl.cnf</span></span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = dashboard.mritd.me		<span class="comment">#éœ€è¦å¢åŠ çš„åŸŸå</span></span><br><span class="line">DNS.2 = kibana.mritd.me</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆè¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl genrsa -out ingress-key.pem 2048</span></span><br><span class="line"><span class="comment"># openssl req -new -key ingress-key.pem -out ingress.csr -subj "/CN=kube-ingress" -config openssl.cnf</span></span><br><span class="line"><span class="comment"># openssl x509 -req -in ingress.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out ingress.pem -days 365 -extensions v3_req -extfile openssl.cnf</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç”Ÿæˆåçš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">ca-key.pem  ca.pem  ca.srl  ingress-key.pem  ingress.csr  ingress.pem  openssl.cnf</span><br></pre></td></tr></table></figure></li></ul><h4 id="5-2ã€åˆ›å»º-secret"><a href="#5-2ã€åˆ›å»º-secret" class="headerlink" title="5.2ã€åˆ›å»º secret"></a>5.2ã€åˆ›å»º secret</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå¥½è¯ä¹¦ä»¥åï¼Œéœ€è¦å°†è¯ä¹¦å†…å®¹æ”¾åˆ° secret ä¸­ï¼Œsecret ä¸­å…¨éƒ¨å†…å®¹éœ€è¦ base64 ç¼–ç ï¼Œç„¶åæ³¨æ„å»æ‰æ¢è¡Œç¬¦(å˜æˆä¸€è¡Œ)ï¼›ä»¥ä¸‹æ˜¯æˆ‘çš„ secret æ ·ä¾‹(ä¸Šä¸€æ­¥ä¸­ ingress.pem æ˜¯è¯ä¹¦crtï¼Œingress-key.pem æ˜¯è¯ä¹¦çš„ key)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ingress-secret.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  tls.crt: MIIDAjCCAeqgAwIBAgIJAIUNBpFKFrg4MA0GCSqGSIb3DQEBCwUAMBIxEDAOBgNVBAMMB2t1YmUtY2EwHhcNMTkwMTI5MTAzMzQ3WhcNMjAwMTI5MTAzMzQ3WjAXMRUwEwYDVQQDDAxrdWJlLWluZ3Jlc3MwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC0rLcpYHdqVjN84vCJYF2l61F+LYuPRczPNWyo8Rba4XpT6MMMqoGqgmI164r4of2klBEMPZ0dm1mJaYnjb1Zq/qzVUlqaednxfXsr6u8Xm0a6l7ep+Yr+XcRISZC9AjgyqlFtgjzbNJauHkHTy0i+jqV2A4SkVUT2whBqF00WEKC6kQLhw4Ab1XBG5aOK2Jz4TZdP+Mw4n3AsihycHgjhFvhGNixKl4mpfHfLvFeKxmBa8ZoWT+3AGgkX186EXhdhsfdYqHeLT2TvwsqbUJI8E8F7nleo5VMifr9KGHxaCJ+ynr/WFX1c+0wYAGmSKsw4CnXh4EE+IvaeQjBz8O2HAgMBAAGjVjBUMAkGA1UdEwQCMAAwCwYDVR0PBAQDAgXgMDoGA1UdEQQzMDGCFmNpLnp4Yy5raW5neHVubGlhbi5jb22CF2s4cy56eGMua2luZ3h1bmxpYW4uY29tMA0GCSqGSIb3DQEBCwUAA4IBAQCShThVXg3Fnkrm82sHowxCEc9UG9uzOY2LbxhVN7mcm8U0cXy3acAXdKWLHUwdZnOxNJytpaBBWb/6KFFKrIekaSK+tSD+oRISJf43c1tbt0QEpplUaDagQ35NANyQY2VHQntDdVK4/NNJULbHNEqsu19vDDvmDFi0aLHvqPFAvlGnEBPgO1Ac297pDR2thHyMCGBzRKTQOJy2q3HKexa1pItHjAVmv/k71HBeTJ1en2tFHLUlR0kEhYYPBeRclVZ1oYWn7THRaBW8NtugdM6mxVNFAWQTq5goP0VcW44lWYiUF6mX/UZa2c+5FwsGWdSwbTqmZj7ptA2QcveUcN2/</span><br><span class="line">  tls.key: MIIEowIBAAKCAQEAtKy3KWB3alYzfOLwiWBdpetRfi2Lj0XMzzVsqPEW2uF6U+jDDKqBqoJiNeuK+KH9pJQRDD2dHZtZiWmJ429Wav6s1VJamnnZ8X17K+rvF5tGupe3qfmK/l3ESEmQvQI4MqpRbYI82zSWrh5B08tIvo6ldgOEpFVE9sIQahdNFhCgupEC4cOAG9VwRuWjitic+E2XT/jMOJ9wLIocnB4I4Rb4RjYsSpeJqXx3y7xXisZgWvGaFk/twBoJF9fOhF4XYbH3WKh3i09k78LKm1CSPBPBe55XqOVTIn6/Shh8Wgifsp6/1hV9XPtMGABpkirMOAp14eBBPiL2nkIwc/DthwIDAQABAoIBACLj97sV1fnDC85iRPFCmtMfzmz/fqP8ZsDdIE6/wBok0OrDWGdpxgCXjT+8bOn23nSZ43DptR2ykmfm6anyJk4jQF0xui16uovYH6ErjWCRq+b8xYsdlanpka4kBr95XkDqgy8Sp43taevWDABKkZG7Gljf9Q2HKfo9H85dEZXg7RKKz77wahcHpZofthNo0s5kkH2ckVpjwh5svM+M/gm8KhZkKayndr1ezEAmndT+K/P4EVuYbpPQyk5A6E1G7Dh9M2TczZZa6oiR5etloDk2sOIYxysIZqAblyMN2IrIO0hf4nGqSmfe0TZMCKzSXoVOV2Qe+ckJ+mSyOPcdbIECgYEA3EMWrrr4oc9R8o35mQ2FDCG0FUyXrCo9SN/CyhScdeUx1IRV00CBwL340H1CwzEpj5g4bj6LGGSeEw2g8qfPoPdzr1yxNnCv43dhaGrWRrSxGL6kGfKmIlbgHTPIuzRkAXGWiCgo5JnzPjQtjmpUTmwmxXwqDih8kpRsBSTsmx0CgYEA0f1ORGtmrj/bRBQU0NF+ztTVFJQbPV3lTHl21Qgd8QcEIcOHqzpI2fmkeGZdyYQXIfODA/X+PFng+Z6J5ubtvplN5jPzpQuQRtIZ47NRmtgn4DoH+GAqxIb2hFbwXpXuSR/LelFtzxb91nGiVKpdizvuwnitgOuAIbgGHYbgpfMCgYAvvA5fYb/eeWq+EUzFgauS3H8FmqrIMgNEFtJFL0BVQI2TC/b5qGI2XjVdIbhlSvNB3nBkXAOTDsM/R9XYoMubi+UzXPg+3x8PQeEHWxgDDMfQoAg6Y17j1EYPrhhTkeAWfAJukZ2DJWYU1gQFeD+7Gy8v31/R365XqfjbCIyKdQKBgD+/3tr2oB2WVUK9tfQPJag1BNtSe1KOBubImULjS/O4ZZC6g51//E3wc/X5Xc+nwj4UZ1n0fFJmFt6xOrxWryaF9BhG/VjFwe8+KY3vCn8v0CtKctD8oP842e4jVqXgbo7UkDl6LxQHrthDdzys2+lBMKLpcAMLe8LA01pzcA/xAoGBAK3KXGXz0AsM+5FBbUFVZFOROUQLcd+N8esHnSqD8i7/J0PJsxm9irutuLht0cYK7Fcq65fYmZ4lrJO7bpiBRzONR78lMgm/rcKfCCNr4o4n6almvuFxA+jGgEM2W7iYb9pW+FFOqIOjl0cSHy2hsN7seGv3JBcz5StRjtwuSWf6</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-secret</span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºå®Œæˆå create<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ingress-secret.yml</span></span><br><span class="line">secret/ingress-secret created</span><br></pre></td></tr></table></figure></li></ul><h4 id="5-3ã€å¿«é€Ÿåˆ›å»º"><a href="#5-3ã€å¿«é€Ÿåˆ›å»º" class="headerlink" title="5.3ã€å¿«é€Ÿåˆ›å»º"></a>5.3ã€å¿«é€Ÿåˆ›å»º</h4><p>5.2æ­¥éª¤å¯ä»¥ç®€åŒ–åˆ›å»ºï¼Œå¯ä»¥æ‰§è¡Œä¸€æ¡å‘½ä»¤è¿›è¡Œåˆ›å»ºï¼Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create secret tls ingress-secret --key cert/ingress-key.pem --cert cert/ingress.pem</span></span><br></pre></td></tr></table></figure><h4 id="5-4ã€é‡æ–°éƒ¨ç½²-Ingress"><a href="#5-4ã€é‡æ–°éƒ¨ç½²-Ingress" class="headerlink" title="5.4ã€é‡æ–°éƒ¨ç½² Ingress"></a>5.4ã€é‡æ–°éƒ¨ç½² Ingress</h4><p>åœ¨tlsç”Ÿæˆå®Œæˆåï¼Œéœ€è¦é‡æ–°éƒ¨ç½²Ingressï¼Œè®©Ingressèƒ½å¤Ÿå®¶åœ¨tlsã€‚ä¿®æ”¹é…ç½®æ–‡ä»¶</p><h5 id="5-4-1ã€jenkins-tls"><a href="#5-4-1ã€jenkins-tls" class="headerlink" title="5.4.1ã€jenkins tls"></a>5.4.1ã€jenkins tls</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi jenkins-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-ingress</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ci.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ci.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: jenkins2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"><span class="comment"># kubect create -f jenkins-ingress.yaml</span></span><br></pre></td></tr></table></figure><p>è®¿é—®jenkinsåŸŸåï¼Œè¿™é‡Œè¾“å…¥httpè®¿é—®ä¼šå¼ºåˆ¶è·³è½¬åˆ°https<br><img src="https://img.xxlaila.cn/1566808668453.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566808711171.jpg" alt="img"></p><h5 id="5-4-2ã€kubernetes-dashboard-tls"><a href="#5-4-2ã€kubernetes-dashboard-tls" class="headerlink" title="5.4.2ã€kubernetes dashboard tls"></a>5.4.2ã€kubernetes dashboard tls</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim nginx-kubernetes-dashboard.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - k8s.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: k8s.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 80</span><br><span class="line"><span class="comment"># kubectl create -f nginx-kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure><h3 id="6ã€ingress-é«˜çº§ç”¨æ³•"><a href="#6ã€ingress-é«˜çº§ç”¨æ³•" class="headerlink" title="6ã€ingress é«˜çº§ç”¨æ³•"></a>6ã€ingress é«˜çº§ç”¨æ³•</h3><p><img src="https://img.xxlaila.cn/34324kjsdfh8234ks.png" alt="img"></p><ul><li>lvs åå‘ä»£ç†åˆ° ç‰©ç†nginxã€‚å®Œæˆhttpsæ‹†åŒ…ï¼Œç»§æ‰¿nginxæ‰€æœ‰åŠŸèƒ½</li><li>nginx åå‘ä»£ç†åˆ°ingress-controlã€‚ ingress-control æœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ ã€‚<ul><li>ingress-control ä½¿ç”¨nodePort æ–¹å¼æš´æ¼æœåŠ¡</li><li>ingress-control ä½¿ç”¨hostNetwork æ–¹å¼æš´æ¼æœåŠ¡</li></ul></li></ul><h3 id="7ã€æ€»ç»“åˆ†æ"><a href="#7ã€æ€»ç»“åˆ†æ" class="headerlink" title="7ã€æ€»ç»“åˆ†æ"></a>7ã€æ€»ç»“åˆ†æ</h3><ul><li>ingress-control åœ¨è‡ªå·±çš„æ‰€å±çš„namespace=ingress, æ˜¯å¯ä»¥å¤¸ä¸åŒnamespaceæä¾›åå‘ä»£ç†æœ.</li><li>å¦‚æœéœ€è¦æä¾›å¤¸NS è®¿é—®ingressï¼Œå…ˆç»™ ingress-controlåˆ›å»ºRBAC</li><li>ingress-control ä½¿ç”¨hostnetwork æ¨¡å¼ æ€§èƒ½æ¯”ä½¿ç”¨service nodePort æ€§èƒ½å¥½å¾ˆå¤šã€‚å› ä¸ºhostnetwork æ˜¯ç›´æ¥è·å–pod çš„IPï¼Ÿ</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Ingress</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²Weave Scope</title>
    <url>/2019/08/26/k8s%E9%83%A8%E7%BD%B2Weave-Scope/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="1ã€Weave-Scopeä»‹ç»"><a href="#1ã€Weave-Scopeä»‹ç»" class="headerlink" title="1ã€Weave Scopeä»‹ç»"></a>1ã€Weave Scopeä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;weave scope æ˜¯Dockerå’ŒKubernetesçš„æ•…éšœæ’é™¤å’Œç›‘æ§ï¼Œè‡ªåŠ¨ç”Ÿæˆåº”ç”¨ç¨‹åºçš„åœ°å›¾ï¼Œèƒ½å¤Ÿç›´è§‚åœ°äº†è§£ï¼Œç›‘æ§å’Œæ§åˆ¶åŸºäºå®¹å™¨çš„ï¼ŒåŸºäºå¾®æœåŠ¡çš„åº”ç”¨ç¨‹åºã€‚å¯ä»¥å®æ—¶çš„äº†è§£dockerå®¹å™¨ï¼Œé€‰æ‹©å®¹å™¨åŸºç¡€æ¶æ„çš„æ¦‚è¿°ï¼Œæˆ–å…³æ³¨ç‰¹å®šçš„å¾®æœåŠ¡ã€‚è½»æ¾è¯†åˆ«å’Œçº æ­£é—®é¢˜ï¼Œç¡®ä¿é›†è£…ç®±åŒ–åº”ç”¨çš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼ŒæŸ¥çœ‹å®¹å™¨çš„ä¸Šä¸‹æ–‡æŒ‡æ ‡ï¼Œæ ‡è®°å’Œå…ƒæ•°æ®ã€‚è½»æ¾åœ°åœ¨å®¹å™¨å†…çš„è¿›ç¨‹ä¹‹é—´å¯¼èˆªï¼Œä»¥è¿è¡Œå®¹å™¨ï¼Œåœ¨å¯æ‰©å±•çš„å¯æ’åºè¡¨ä¸­è¿›è¡Œæ’åˆ—ã€‚ä½¿ç”¨ç»™å®šä¸»æœºæˆ–æœåŠ¡çš„æœ€å¤§CPUæˆ–å†…å­˜è½»æ¾æ‰¾åˆ°å®¹å™¨ã€‚ç›´æ¥ä¸æ‚¨çš„å®¹å™¨äº¤äº’ï¼šæš‚åœï¼Œé‡æ–°å¯åŠ¨å’Œåœæ­¢å®¹å™¨ã€‚å¯åŠ¨å‘½ä»¤è¡Œã€‚å…¨éƒ¨ä¸ç¦»å¼€èŒƒå›´æµè§ˆå™¨çª—å£ã€‚</p><p><img src="https://img.xxlaila.cn/378246bsjfhsajkdq.png" alt="img"></p><h3 id="2ã€éƒ¨ç½²weave-scope"><a href="#2ã€éƒ¨ç½²weave-scope" class="headerlink" title="2ã€éƒ¨ç½²weave scope"></a>2ã€éƒ¨ç½²weave scope</h3><p>åˆæ¬¡å­¦ä¹ ï¼Œç›´æ¥ä¸‹è½½å®˜æ–¹é…ç½®æ–‡ä»¶ï¼Œæ²¡æœ‰ç»è¿‡ä»»ä½•ä¿®æ”¹ï¼Œä¸è¿‡ç›¸ä¿¡è‡ªå·±éšç€å­¦ä¹ çš„è¿›æ­¥ï¼Œä¼šé€æ¸æ·±å…¥ã€‚<a href="https://github.com/weaveworks/scope" target="_blank" rel="noopener">githubåœ°å€</a>ï¼Œ<a href="https://www.weave.works/docs/cloud/latest/overview/" target="_blank" rel="noopener">å®˜æ–¹åœ°å€</a></p><a id="more"></a><h4 id="2-1ã€ä¸‹è½½é…ç½®æ–‡ä»¶"><a href="#2-1ã€ä¸‹è½½é…ç½®æ–‡ä»¶" class="headerlink" title="2.1ã€ä¸‹è½½é…ç½®æ–‡ä»¶"></a>2.1ã€ä¸‹è½½é…ç½®æ–‡ä»¶</h4><p><a href="https://github.com/weaveworks/scope/tree/master/examples/k8s" target="_blank" rel="noopener">ä¸‹è½½é…ç½®æ–‡ä»¶</a>,é…ç½®æ–‡ä»¶å¦‚ä¸‹åˆ—è¡¨:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -l</span></span><br><span class="line">cluster-role-binding.yaml</span><br><span class="line">cluster-role.yaml</span><br><span class="line">deploy.yaml</span><br><span class="line">ds.yaml</span><br><span class="line">ns.yaml</span><br><span class="line">psp.yaml</span><br><span class="line">sa.yaml</span><br><span class="line">scope.yaml</span><br><span class="line">svc.yaml</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ›å»º<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ./</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2ã€æŸ¥çœ‹éƒ¨ç½²"><a href="#2-2ã€æŸ¥çœ‹éƒ¨ç½²" class="headerlink" title="2.2ã€æŸ¥çœ‹éƒ¨ç½²"></a>2.2ã€æŸ¥çœ‹éƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc,pods -n weave</span></span><br><span class="line">NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/weave-scope-app   ClusterIP   10.99.252.207   &lt;none&gt;        80/TCP    25m</span><br><span class="line"></span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/weave-scope-agent-gpwmw            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-lmf22            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-r8vft            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-rph5p            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-zfrnc            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-app-5c46dd7467-s8cp8   1/1     Running   0          24m</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/3489hdnsjkhd8324sd.png" alt="img"></p><h4 id="2-3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€"><a href="#2-3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€" class="headerlink" title="2.3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€"></a>2.3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services -n weave</span></span><br><span class="line">NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">weave-scope-app   ClusterIP   10.99.252.207   &lt;none&gt;        80/TCP    27m</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ°è¿™é‡Œweave-scopeéƒ¨ç½²å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œè®¿é—®ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¹‹å‰å­¦ä¹ çš„nginx Ingressæ¥å¯¹scopeé…ç½®ä¸€ä¸ªåŸŸåï¼Œç„¶åå§åŸŸåè§£æåˆ°åˆ¶å®šçš„ipåœ°å€ä¸Šè¿›è¡Œè®¿é—®</p><h3 id="3ã€é…ç½®scopeåŸŸå"><a href="#3ã€é…ç½®scopeåŸŸå" class="headerlink" title="3ã€é…ç½®scopeåŸŸå"></a>3ã€é…ç½®scopeåŸŸå</h3><p>æ–°å»ºç«‹ä¸€ä¸ªyamlæ–‡ä»¶ï¼Œå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat scope-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: scope-ingress</span><br><span class="line">  namespace: weave</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: scope.xxlaila.io</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: weave-scope-app</span><br><span class="line">            servicePort: 80</span><br><span class="line"><span class="comment"># kubectl create -f scope-ingress.yaml</span></span><br></pre></td></tr></table></figure><blockquote><p>é€šè¿‡åŸŸåè®¿é—®ï¼š<a href="http://scope.xxlaila.io" target="_blank" rel="noopener">http://scope.xxlaila.io</a></p></blockquote><p><img src="https://img.xxlaila.cn/287346jskbdjy784kjs.png" alt="img"><br><img src="https://img.xxlaila.cn/3o4wndk9234sd.png" alt="img"><br><img src="https://img.xxlaila.cn/34873i24dfsd.png" alt="img"><br><img src="https://img.xxlaila.cn/458dskjfhu2y4skdsds.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Weave Scope</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²zookeeperé›†ç¾¤</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2zookeeper%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>zkå±äºæœ‰çŠ¶æ€æœåŠ¡ï¼Œéœ€è¦è¿æ¥å¤–éƒ¨å­˜å‚¨ï¼Œå§æ•°æ®å­˜æ”¾åœ¨æ•°æ®ç›˜é‡Œé¢ï¼Œå¦åˆ™å®¹å™¨æŒ‚äº†ï¼Œæ•°æ®æ²¡æœ‰äº†</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å‡†å¤‡zkçš„yamlæ–‡ä»¶</p><a id="more"></a><h3 id="1ã€é…ç½®zk-dataæ–‡ä»¶"><a href="#1ã€é…ç½®zk-dataæ–‡ä»¶" class="headerlink" title="1ã€é…ç½®zk-dataæ–‡ä»¶"></a>1ã€é…ç½®zk-dataæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat zk-data.yaml</span></span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk1</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">---</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk2</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">---</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk3</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line"><span class="comment"># cat zookeeper.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-hs</span><br><span class="line">  labels:</span><br><span class="line">    app: zk</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2888</span><br><span class="line">    name: server</span><br><span class="line">  - port: 3888</span><br><span class="line">    name: leader-election</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-cs</span><br><span class="line">  labels:</span><br><span class="line">    app: zk</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2181</span><br><span class="line">    name: client</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodDisruptionBudget</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-pdb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  maxUnavailable: 1</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: zk</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  serviceName: zk-hs</span><br><span class="line">  replicas: 3</span><br><span class="line">  updateStrategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">  podManagementPolicy: Parallel</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: zk</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: <span class="string">"app"</span></span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                    - zk</span><br><span class="line">              topologyKey: <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-zookeeper</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        image: <span class="string">"xxlaila/kubernetes-zookeeper:1.0-3.4.10"</span></span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"1Gi"</span></span><br><span class="line">            cpu: <span class="string">"0.5"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 2181</span><br><span class="line">          name: client</span><br><span class="line">        - containerPort: 2888</span><br><span class="line">          name: server</span><br><span class="line">        - containerPort: 3888</span><br><span class="line">          name: leader-election</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - <span class="string">"start-zookeeper \</span></span><br><span class="line"><span class="string">          --servers=3 \</span></span><br><span class="line"><span class="string">          --data_dir=/var/lib/zookeeper/data \</span></span><br><span class="line"><span class="string">          --data_log_dir=/var/lib/zookeeper/data/log \</span></span><br><span class="line"><span class="string">          --conf_dir=/opt/zookeeper/conf \</span></span><br><span class="line"><span class="string">          --client_port=2181 \</span></span><br><span class="line"><span class="string">          --election_port=3888 \</span></span><br><span class="line"><span class="string">          --server_port=2888 \</span></span><br><span class="line"><span class="string">          --tick_time=2000 \</span></span><br><span class="line"><span class="string">          --init_limit=10 \</span></span><br><span class="line"><span class="string">          --sync_limit=5 \</span></span><br><span class="line"><span class="string">          --heap=512M \</span></span><br><span class="line"><span class="string">          --max_client_cnxns=60 \</span></span><br><span class="line"><span class="string">          --snap_retain_count=3 \</span></span><br><span class="line"><span class="string">          --purge_interval=12 \</span></span><br><span class="line"><span class="string">          --max_session_timeout=40000 \</span></span><br><span class="line"><span class="string">          --min_session_timeout=4000 \</span></span><br><span class="line"><span class="string">          --log_level=INFO"</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">            - -c</span><br><span class="line">            - <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        livenessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">            - -c</span><br><span class="line">            - <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: datadir</span><br><span class="line">          mountPath: /var/lib/zookeeper</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 1000</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: datadir</span><br><span class="line">      annotations:</span><br><span class="line">        volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 3Gi</span><br></pre></td></tr></table></figure><h3 id="2ã€æ‰§è¡Œéƒ¨ç½²"><a href="#2ã€æ‰§è¡Œéƒ¨ç½²" class="headerlink" title="2ã€æ‰§è¡Œéƒ¨ç½²"></a>2ã€æ‰§è¡Œéƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f zookeeper.yaml -n kube-dev</span></span><br></pre></td></tr></table></figure><h3 id="3ã€æŸ¥çœ‹éƒ¨ç½²"><a href="#3ã€æŸ¥çœ‹éƒ¨ç½²" class="headerlink" title="3ã€æŸ¥çœ‹éƒ¨ç½²"></a>3ã€æŸ¥çœ‹éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide -n kube-dev</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">zk-0                            1/1     Running   0          6m13s   10.254.62.4   172.21.17.15    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">zk-1                            1/1     Running   0          6m12s   10.254.21.4   172.21.16.96    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">zk-2                            1/1     Running   0          6m12s   10.254.96.4   172.21.16.193   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜"><a href="#4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜" class="headerlink" title="4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜"></a>4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv -o wide -n kube-dev</span></span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                             STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-d1cb6a1c-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-0             managed-nfs-storage            6m18s</span><br><span class="line">pvc-d20a95ec-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-1             managed-nfs-storage            6m18s</span><br><span class="line">pvc-d23577af-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-2             managed-nfs-storage            6m23s</span><br></pre></td></tr></table></figure><h3 id="5ã€æŸ¥çœ‹pvc"><a href="#5ã€æŸ¥çœ‹pvc" class="headerlink" title="5ã€æŸ¥çœ‹pvc"></a>5ã€æŸ¥çœ‹pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pvc -o wide -n kube-dev</span></span><br><span class="line">NAME                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">datadir-zk-0             Bound    pvc-d1cb6a1c-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m38s</span><br><span class="line">datadir-zk-1             Bound    pvc-d20a95ec-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m37s</span><br><span class="line">datadir-zk-2             Bound    pvc-d23577af-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m37s</span><br></pre></td></tr></table></figure><h3 id="6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸"><a href="#6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸" class="headerlink" title="6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸"></a>6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in 0 1 2; do kubectl exec zk-$i zkServer.sh status -n kube-dev; done</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><h3 id="7ã€é›†ç¾¤çš„è®¿é—®åœ°å€"><a href="#7ã€é›†ç¾¤çš„è®¿é—®åœ°å€" class="headerlink" title="7ã€é›†ç¾¤çš„è®¿é—®åœ°å€"></a>7ã€é›†ç¾¤çš„è®¿é—®åœ°å€</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server.1=zk-0.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br><span class="line">server.2=zk-1.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br><span class="line">server.3=zk-2.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²coredns</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2coredns/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;k8sé›†ç¾¤ä¸­çš„åº”ç”¨é€šå¸¸æ˜¯é€šè¿‡ingresså®ç°å¾®æœåŠ¡å‘å¸ƒçš„ï¼Œå‰æ–‡ä»‹ç»è¿‡åœ¨K8Sé›†ç¾¤ä¸­ä½¿ç”¨traefikå®ç°æœåŠ¡çš„è‡ªåŠ¨å‘å¸ƒï¼Œå…¶å®ç°æ–¹å¼æ˜¯traefiké€šè¿‡é›†ç¾¤çš„DNSæœåŠ¡æ¥è§£æserviceå¯¹åº”çš„é›†ç¾¤åœ°å€ï¼ˆclusteripï¼‰ï¼Œä»è€Œå°†ç”¨æˆ·çš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤åœ°å€ä¸Šã€‚å› æ­¤ï¼Œåœ¨éƒ¨ç½²å®Œé›†ç¾¤åçš„ç¬¬ä¸€ä»¶äº‹æƒ…åº”è¯¥æ˜¯é…ç½®DNSæœåŠ¡ï¼Œç›®å‰å¯é€‰çš„æ–¹æ¡ˆæœ‰skydns, kube-dns, corednsã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;kubednsæ˜¯Kubernetesä¸­çš„ä¸€ä¸ªå†…ç½®æ’ä»¶ï¼Œç›®å‰ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¼€æºé¡¹ç›®ç»´æŠ¤ï¼Œè§<a href="https://github.com/kubernetes/dnsã€‚è¯¥DNSæœåŠ¡å™¨åˆ©ç”¨SkyDNSçš„åº“æ¥ä¸ºKubernetes" target="_blank" rel="noopener">https://github.com/kubernetes/dnsã€‚è¯¥DNSæœåŠ¡å™¨åˆ©ç”¨SkyDNSçš„åº“æ¥ä¸ºKubernetes</a> podå’ŒæœåŠ¡æä¾›DNSè¯·æ±‚ã€‚CoreDNSé¡¹ç›®æ˜¯SkyDNS2çš„ä½œè€…ï¼ŒMiek Giebené‡‡ç”¨æ›´æ¨¡å—åŒ–ï¼Œå¯æ‰©å±•çš„æ¡†æ¶æ„å»º,å°†æ­¤DNSæœåŠ¡å™¨ä½œä¸ºKubeDNSçš„æ›¿ä»£å“ã€‚CoreDNSä½œä¸ºCNCFä¸­çš„æ‰˜ç®¡çš„ä¸€ä¸ªé¡¹ç›®ï¼Œåœ¨Kuberentes1.9ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨kubeadmæ–¹å¼å®‰è£…çš„é›†ç¾¤å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç›´æ¥å®‰è£…CoreDNSã€‚kubeadm init â€“feature-gates=CoreDNS=true</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å‡†å¤‡corednsçš„<a href="https://github.com/coredns/deployment.git" target="_blank" rel="noopener">yamlæ–‡ä»¶</a></p><a id="more"></a><p>é¦–å…ˆæˆ‘ä»¬çš„æŸ¥çœ‹<code>cat /etc/kubernetes/kubelet</code> dnsçš„ipåœ°å€æ˜¯å¤šå°‘ï¼Œè¿™é‡Œæˆ‘çš„æ˜¯<code>10.254.0.2</code>ï¼Œæ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œä¿®æ”¹</p><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./deploy.sh -i 10.254.0.2 | kubectl apply -f -</span></span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure></li><li><p>æ“¦çœ‹corednsä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deployment,rc -n kube-system|grep dns</span></span><br><span class="line">pod/coredns-799775f9b6-mgdc9                1/1     Running   0          12m</span><br><span class="line">pod/coredns-799775f9b6-v95lp                1/1     Running   0          12m</span><br><span class="line">service/kube-dns               ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   12m</span><br><span class="line"></span><br><span class="line">deployment.extensions/coredns                2/2     2            2           12m</span><br></pre></td></tr></table></figure></li></ul><h3 id="éƒ¨ç½²-DNS-è‡ªåŠ¨æ‰©å®¹"><a href="#éƒ¨ç½²-DNS-è‡ªåŠ¨æ‰©å®¹" class="headerlink" title="éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹"></a>éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å¤§è§„æ¨¡é›†ç¾¤çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦é›†ç¾¤ DNS è‡ªåŠ¨æ‰©å®¹ï¼Œå…·ä½“æ–‡æ¡£è¯·å‚è€ƒ DNS Horizontal Autoscalerï¼ŒDNS æ‰©å®¹ç®—æ³•å¯å‚è€ƒ Githubï¼Œå¦‚æœ‰éœ€è¦è¯·è‡ªè¡Œä¿®æ”¹ï¼›ä»¥ä¸‹ä¸ºå…·ä½“é…ç½®</p><ul><li><p>dns-horizontal-autoscaler.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kind: ServiceAccount</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns-autoscaler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"nodes"</span>]</span><br><span class="line">    verbs: [<span class="string">"list"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"replicationcontrollers/scale"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"deployments/scale"</span>, <span class="string">"replicasets/scale"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>]</span><br><span class="line"><span class="comment"># Remove the configmaps rule once below issue is fixed:</span></span><br><span class="line"><span class="comment"># kubernetes-incubator/cluster-proportional-autoscaler#16</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"configmaps"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>]</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kube-dns-autoscaler</span><br><span class="line">    namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns-autoscaler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns-autoscaler</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns-autoscaler</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns-autoscaler</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: autoscaler</span><br><span class="line">        image: gcr.azk8s.cn/google_containers/cluster-proportional-autoscaler-amd64:1.1.2-r2</span><br><span class="line">        resources:</span><br><span class="line">            requests:</span><br><span class="line">                cpu: <span class="string">"20m"</span></span><br><span class="line">                memory: <span class="string">"10Mi"</span></span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">          - /cluster-proportional-autoscaler</span><br><span class="line">          - --namespace=kube-system</span><br><span class="line">          - --configmap=kube-dns-autoscaler</span><br><span class="line">          <span class="comment"># Should keep target in sync with cluster/addons/dns/kube-dns.yaml.base</span></span><br><span class="line">          - --target=Deployment/coredns</span><br><span class="line">          <span class="comment"># When cluster is using large nodes(with more cores), "coresPerReplica" should dominate.</span></span><br><span class="line">          <span class="comment"># If using small nodes, "nodesPerReplica" should dominate.</span></span><br><span class="line">          - --default-params=&#123;<span class="string">"linear"</span>:&#123;<span class="string">"coresPerReplica"</span>:256,<span class="string">"nodesPerReplica"</span>:16,<span class="string">"preventSinglePointFailure"</span>:<span class="literal">true</span>&#125;&#125;</span><br><span class="line">          - --logtostderr=<span class="literal">true</span></span><br><span class="line">          - --v=2</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line">        operator: <span class="string">"Exists"</span></span><br><span class="line">      serviceAccountName: kube-dns-autoscaler</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f dns-horizontal-autoscaler.yaml </span></span><br><span class="line">serviceaccount/kube-dns-autoscaler created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:kube-dns-autoscaler created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:kube-dns-autoscaler created</span><br><span class="line">deployment.apps/kube-dns-autoscaler created</span><br></pre></td></tr></table></figure></li></ul><p>æ‰§è¡Œåˆ›å»ºä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°pod åˆ›å»ºäº†ä¸¤ä¸ªdns</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system|grep coredns</span></span><br><span class="line">coredns-68676b6b88-pw9c2                1/1     Running   0          7m18s</span><br><span class="line">coredns-68676b6b88-tgbbv                1/1     Running   0          100m</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²mysql</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2mysql/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;åç«¯å­˜å‚¨åˆ©ç”¨nfsæ¥è¿›è¡Œå­˜å‚¨æ•°æ®ï¼Œnfså®‰è£…ä¸é˜è¿°ï¼Œéœ€è¦æ³¨æ„æ³¨æ„çš„æ˜¯åœ¨åˆ›å»ºmysql çš„å…±äº«ç›®å½•çš„æ—¶å€™å‚æ•°è®¾å®š<code>/data/mysql *(rw,sync,no_root_squash,no_subtree_check)</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl  restart nfs.service</span><br><span class="line">$ sudo exportfs -arv</span><br></pre></td></tr></table></figure><h3 id="1ã€åˆ›å»ºmysqlå­˜å‚¨"><a href="#1ã€åˆ›å»ºmysqlå­˜å‚¨" class="headerlink" title="1ã€åˆ›å»ºmysqlå­˜å‚¨"></a>1ã€åˆ›å»ºmysqlå­˜å‚¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-pvc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc001</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  nfs:</span><br><span class="line">    server: 172.21.16.240</span><br><span class="line">    path: /data/mysql</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pvc</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 10Gi</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2ã€éƒ¨ç½²mysql"><a href="#2ã€éƒ¨ç½²mysql" class="headerlink" title="2ã€éƒ¨ç½²mysql"></a>2ã€éƒ¨ç½²mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-deploy.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-deploy</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: mysql-ops</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        name: mysql-ops</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: mysql</span><br><span class="line">          image: mysql:8.0.12</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          env:</span><br><span class="line">          - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">            value: <span class="string">"noc-mysql"</span></span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 3306</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: mysql-persistent-storage</span><br><span class="line">              mountPath: <span class="string">"/var/lib/mysql"</span></span><br><span class="line">      volumes:</span><br><span class="line">        - name: mysql-persistent-storage</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">            claimName: mysql-pvc</span><br></pre></td></tr></table></figure><h3 id="3ã€è®¾ç½®ç«¯å£æ˜ å°„"><a href="#3ã€è®¾ç½®ç«¯å£æ˜ å°„" class="headerlink" title="3ã€è®¾ç½®ç«¯å£æ˜ å°„"></a>3ã€è®¾ç½®ç«¯å£æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-svc</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  labels: </span><br><span class="line">    name: mysql-svc</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3306</span><br><span class="line">    name: http</span><br><span class="line">    nodePort: 30003</span><br><span class="line">  selector:</span><br><span class="line">    name: mysql-ops</span><br></pre></td></tr></table></figure><h3 id="4ã€æŸ¥çœ‹podéƒ¨ç½²"><a href="#4ã€æŸ¥çœ‹podéƒ¨ç½²" class="headerlink" title="4ã€æŸ¥çœ‹podéƒ¨ç½²"></a>4ã€æŸ¥çœ‹podéƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/8364iqhkdaskda.png" alt="img"></p><h3 id="5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹"><a href="#5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹" class="headerlink" title="5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹"></a>5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/42joud02jef24.png" alt="img"></p><h3 id="6ã€è¿›å…¥mysqlå®¹å™¨"><a href="#6ã€è¿›å…¥mysqlå®¹å™¨" class="headerlink" title="6ã€è¿›å…¥mysqlå®¹å™¨"></a>6ã€è¿›å…¥mysqlå®¹å™¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker ps -a</span><br><span class="line">$ sudo docker <span class="built_in">exec</span> -it ded7f2990db5 /bin/bash</span><br><span class="line">root@mysql-deploy-6dc5d9786b-lgkxk:/<span class="comment"># mysql -h127.0.0.1 -uroot -pnoc-mysql</span></span><br></pre></td></tr></table></figure><h4 id="6-1ã€è®¾ç½®mysql"><a href="#6-1ã€è®¾ç½®mysql" class="headerlink" title="6.1ã€è®¾ç½®mysql"></a>6.1ã€è®¾ç½®mysql</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter user <span class="string">'root'</span>@<span class="string">'%'</span> identified with mysql_native_password by<span class="string">'root'</span>;</span><br><span class="line">mysql&gt; alter  user <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'mysql'</span>;</span><br><span class="line">mysql&gt; alter  user <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'noc-mysql'</span>;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é€€å‡ºmysqlå’Œå®¹å™¨ï¼Œæ‰§è¡Œquit;é€€å‡ºmysqlï¼ŒæŒ‰ctrl+p+qä»å®¹å™¨ä¸­è¿”å›nodeä¸»æœºã€‚åˆ©ç”¨navicat é€šè¿‡nodeä¸»æœºçš„ipåœ°å€å’Œç«¯å£30003è¿æ¥mysqlæ•°æ®åº“<br><img src="https://img.xxlaila.cn/2348wndssmadklj3.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sè§’è‰²è®¿é—®RBAC</title>
    <url>/2019/08/24/k8s%E8%A7%92%E8%89%B2%E8%AE%BF%E9%97%AERBAC/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="1ã€rbacä»‹ç»"><a href="#1ã€rbacä»‹ç»" class="headerlink" title="1ã€rbacä»‹ç»"></a>1ã€rbacä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesä¸­çš„ä¸¤ä¸ªç”¨äºé…ç½®ä¿¡æ¯çš„é‡è¦èµ„æºå¯¹è±¡ï¼šConfigMapå’ŒSecretï¼Œå…¶å®åˆ°è¿™é‡Œæˆ‘ä»¬åŸºæœ¬ä¸Šå­¦ä¹ çš„å†…å®¹å·²ç»è¦†ç›–åˆ°Kubernetesä¸­ä¸€äº›é‡è¦çš„èµ„æºå¯¹è±¡äº†ï¼Œæ¥éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åºæ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„äº†ã€‚åœ¨æˆ‘ä»¬æ¼”ç¤ºä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»™å¤§å®¶è®²è§£ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼šRBAC - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;RBACä½¿ç”¨rbac.authorization.k8s.io API Group æ¥å®ç°æˆæƒå†³ç­–ï¼Œå…è®¸ç®¡ç†å‘˜é€šè¿‡ Kubernetes API åŠ¨æ€é…ç½®ç­–ç•¥ï¼Œè¦å¯ç”¨RBACï¼Œéœ€è¦åœ¨ apiserver ä¸­æ·»åŠ å‚æ•°â€“authorization-mode=RBACï¼Œå¦‚æœä½¿ç”¨çš„kubeadmå®‰è£…çš„é›†ç¾¤ï¼Œ1.6 ç‰ˆæœ¬ä»¥ä¸Šçš„éƒ½é»˜è®¤å¼€å¯äº†RBACï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ Master èŠ‚ç‚¹ä¸Š apiserver çš„é™æ€Podå®šä¹‰æ–‡ä»¶ï¼š</p><h3 id="2ã€-kubernetes-å…³äºç©ºé—´æƒé™èµ‹äºˆ"><a href="#2ã€-kubernetes-å…³äºç©ºé—´æƒé™èµ‹äºˆ" class="headerlink" title="2ã€ kubernetes å…³äºç©ºé—´æƒé™èµ‹äºˆ"></a>2ã€ kubernetes å…³äºç©ºé—´æƒé™èµ‹äºˆ</h3><h4 id="1ã€è·å–å¹¶æŸ¥çœ‹"><a href="#1ã€è·å–å¹¶æŸ¥çœ‹" class="headerlink" title="1ã€è·å–å¹¶æŸ¥çœ‹"></a>1ã€è·å–å¹¶æŸ¥çœ‹</h4><ul><li>Role</li><li>ClusterRole</li><li>RoleBinding</li><li>ClusterRoleBinding</li></ul><a id="more"></a><ul><li><p>1.1ã€æŸ¥çœ‹kube-system namespaceä¸‹çš„æ‰€æœ‰role</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get role -n kube-system</span><br></pre></td></tr></table></figure></li><li><p>1.2ã€æŸ¥çœ‹æŸä¸ªroleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get role &lt;role-name&gt; -n kube-system -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.3ã€æŸ¥çœ‹kube-system namespaceä¸‹æ‰€æœ‰çš„rolebinding</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get rolebinding -n kube-system</span><br></pre></td></tr></table></figure></li><li><p>1.4ã€æŸ¥çœ‹kube-system namespaceä¸‹çš„æŸä¸ªrolebindingè¯¦ç»†ä¿¡æ¯ï¼ˆç»‘å®šçš„Roleå’Œsubjectï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get rolebinding &lt;rolebind-name&gt; -n kube-system -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.5ã€æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰çš„clusterrole</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole</span><br></pre></td></tr></table></figure></li><li><p>1.6ã€æŸ¥çœ‹æŸä¸ªclusterroleå®šä¹‰çš„èµ„æºæƒé™è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole &lt;clusterrole-name&gt; -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.7ã€æŸ¥çœ‹æ‰€æœ‰çš„clusterrolebinding</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrolebinding</span><br></pre></td></tr></table></figure></li><li><p>1.8ã€æŸ¥çœ‹æŸä¸€clusterrolebindingçš„è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrolebinding &lt;clusterrolebinding-name&gt; -o yaml</span><br></pre></td></tr></table></figure></li></ul><h4 id="2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚"><a href="#2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚" class="headerlink" title="2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚"></a>2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚</h4><ul><li><p>åœ¨æŸä¸€ç‰¹å®šåå­—ç©ºé—´å†…æˆäºˆRoleæˆ–è€…ClusterRoleã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding</span><br></pre></td></tr></table></figure></li><li><p>åœ¨åä¸ºâ€acmeâ€çš„åå­—ç©ºé—´ä¸­å°†admin ClusterRoleæˆäºˆç”¨æˆ·â€bobâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding bob-admin-binding --clusterrole=admin --user=bob --namespace=acme</span><br></pre></td></tr></table></figure></li><li><p>åœ¨åä¸ºâ€acmeâ€çš„åå­—ç©ºé—´ä¸­å°†view ClusterRoleæˆäºˆæœåŠ¡è´¦æˆ·â€myappâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding myapp-view-binding --clusterrole=view --serviceaccount=acme:myapp --namespace=acme</span><br><span class="line">kubectl create clusterrolebinding</span><br></pre></td></tr></table></figure></li></ul><h4 id="3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š"><a href="#3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š" class="headerlink" title="3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š"></a>3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</h4><ul><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†cluster-admin ClusterRoleæˆäºˆç”¨æˆ·â€rootâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding root-cluster-admin-binding --clusterrole=cluster-admin --user=root</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†system:node ClusterRoleæˆäºˆç”¨æˆ·â€kubeletâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-node-binding --clusterrole=system:node --user=kubelet</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†view ClusterRoleæˆäºˆåå­—ç©ºé—´â€acmeâ€å†…çš„æœåŠ¡è´¦æˆ·â€myappâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding myapp-view-binding --clusterrole=view --serviceaccount=acme:myapp</span><br></pre></td></tr></table></figure></li></ul><h4 id="4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™"><a href="#4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™" class="headerlink" title="4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™"></a>4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™</h4><ul><li><p>æŸ¥çœ‹kube-ops ä¸‹é¢çš„è§’è‰²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role -n kube-ops</span></span><br><span class="line">NAME       AGE</span><br><span class="line">jenkins2   2d6h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹roleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role jenkins2 -n kube-ops -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2019-01-14T03:07:25Z"</span></span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  resourceVersion: <span class="string">"2389179"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/kube-ops/roles/jenkins2</span><br><span class="line">  uid: 84762132-17a9-11e9-8991-fa163e14c5bd</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">exec</span></span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">log</span></span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºjenkins2çš„æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test-3 ~]<span class="comment"># kubectl -n kube-system create sa jenkins2</span></span><br><span class="line">serviceaccount/jenkins2 created</span><br></pre></td></tr></table></figure></li><li><p>æˆæƒè®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test-3 ~]<span class="comment"># kubectl create clusterrolebinding jenkins2 --clusterrole cluster-admin --serviceaccount=kube-ops:jenkins2</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/jenkins2 created</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>RBAC</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s heapster</title>
    <url>/2019/08/24/k8s-heapster/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="1ã€heapster-ä»‹ç»"><a href="#1ã€heapster-ä»‹ç»" class="headerlink" title="1ã€heapster ä»‹ç»"></a>1ã€heapster ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Heapsteræ˜¯å®¹å™¨é›†ç¾¤ç›‘æ§å’Œæ€§èƒ½åˆ†æå·¥å…·,æ”¯æŒKuberneteså’ŒCoreOSã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesæœ‰ä¸ªç›‘æ§agentâ€”cAdvisorã€‚åœ¨æ¯ä¸ªkubernetes Nodeä¸Šéƒ½ä¼šè¿è¡ŒcAdvisor,å®ƒä¼šæ”¶é›†æœ¬æœºä»¥åŠå®¹å™¨çš„ç›‘æ§æ•°æ®(cpu,memory,filesystem,network,uptime)ã€‚åœ¨è¾ƒæ–°çš„ç‰ˆæœ¬ä¸­ï¼ŒK8Så·²ç»å°†cAdvisoråŠŸèƒ½é›†æˆåˆ°kubeletç»„ä»¶ä¸­ã€‚æ¯ä¸ªNodeèŠ‚ç‚¹å¯ä»¥ç›´æ¥è¿›è¡Œwebè®¿é—®ã€‚</p><h3 id="2ã€heapster-å®‰è£…"><a href="#2ã€heapster-å®‰è£…" class="headerlink" title="2ã€heapster å®‰è£…"></a>2ã€heapster å®‰è£…</h3><p>ä¸‹è½½heapsterçš„<a href="https://github.com/kubernetes-retired/heapster/tree/master/deploy/kube-config" target="_blank" rel="noopener">yamlæ–‡ä»¶</a>ï¼Œä¸‹è½½å®Œæˆåæˆ‘ä»¬éœ€è¦å¯¹æ–‡ä»¶ä¿®æ”¹ï¼Œä»¥æ»¡è¶³æˆ‘ä»¬çš„çš„éœ€æ±‚.</p><h4 id="2-1ã€grafanaä¿®æ”¹"><a href="#2-1ã€grafanaä¿®æ”¹" class="headerlink" title="2.1ã€grafanaä¿®æ”¹"></a>2.1ã€grafanaä¿®æ”¹</h4><p>grafanaæ·»åŠ nodePort: 30003è®©grafanaæ”¯æŒå¤–éƒ¨è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç«¯å£è¿›è¡Œä½†å•ç‹¬çš„é¡µé¢é…ç½®ã€‚</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: k8s.gcr.io/heapster-grafana-amd64:v5.0.4</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/certs</span><br><span class="line">          name: ca-certificates</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">        - mountPath: /var</span><br><span class="line">          name: grafana-storage</span><br><span class="line">        env:</span><br><span class="line">        - name: INFLUXDB_HOST</span><br><span class="line">          value: monitoring-influxdb</span><br><span class="line">        - name: GF_SERVER_HTTP_PORT</span><br><span class="line">          value: <span class="string">"3000"</span></span><br><span class="line">          <span class="comment"># The following env variables are required to make Grafana accessible via</span></span><br><span class="line">          <span class="comment"># the kubernetes api-server proxy. On production clusters, we recommend</span></span><br><span class="line">          <span class="comment"># removing these env variables, setup auth for grafana, and expose the grafana</span></span><br><span class="line">          <span class="comment"># service using a LoadBalancer or a public IP.</span></span><br><span class="line">        - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">          value: <span class="string">"false"</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class="line">          value: Admin</span><br><span class="line">        - name: GF_SERVER_ROOT_URL</span><br><span class="line">          <span class="comment"># If you're only using the API Server proxy, set this value instead:</span></span><br><span class="line">          <span class="comment"># value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span></span><br><span class="line">          value: /</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ca-certificates</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/ssl/certs</span><br><span class="line">      - name: grafana-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></span><br><span class="line">    kubernetes.io/name: monitoring-grafana</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># In a production setup, we recommend accessing Grafana through an external Loadbalancer</span></span><br><span class="line">  <span class="comment"># or through a public IP.</span></span><br><span class="line">  <span class="comment"># type: LoadBalancer</span></span><br><span class="line">  <span class="comment"># You could also use NodePort to expose the service at a randomly-generated port</span></span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 3000</span><br><span class="line">    nodePort: 30003</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: grafana</span><br></pre></td></tr></table></figure><h4 id="2-2ã€heapsteræ–‡ä»¶ä¿®æ”¹"><a href="#2-2ã€heapsteræ–‡ä»¶ä¿®æ”¹" class="headerlink" title="2.2ã€heapsteræ–‡ä»¶ä¿®æ”¹"></a>2.2ã€heapsteræ–‡ä»¶ä¿®æ”¹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- --<span class="built_in">source</span>=kubernetes:https://kubernetes.default?useServiceAccount=<span class="literal">true</span>&amp;kubeletHttps=<span class="literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="literal">true</span></span><br><span class="line">è¿æ¥k8s apiçš„åœ°å€ï¼Œé»˜è®¤æ˜¯kubernetes.defaultï¼Œåé¢ä¸€æ®µåŠ å…¥ç”¨æˆ·è®¤è¯ï¼Œç«¯å£ï¼Œä»¥åŠhttps;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</span><br><span class="line">æŒ‡å®š influxdbæ•°æ®åº“çš„åœ°å€ï¼Œè¿™ä¸ªåœ¨infuxdbæ–‡ä»¶é‡Œé¢æœ‰è¿™ä¸ªåŸŸå</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: heapster</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: k8s.gcr.io/heapster-amd64:v1.5.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - /heapster</span><br><span class="line">        - --<span class="built_in">source</span>=kubernetes:https://kubernetes.default?useServiceAccount=<span class="literal">true</span>&amp;kubeletHttps=<span class="literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="literal">true</span></span><br><span class="line">        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></span><br><span class="line">    kubernetes.io/name: Heapster</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: heapster</span><br></pre></td></tr></table></figure><h3 id="3ã€æ‰§è¡Œåˆ›å»ºheapster"><a href="#3ã€æ‰§è¡Œåˆ›å»ºheapster" class="headerlink" title="3ã€æ‰§è¡Œåˆ›å»ºheapster"></a>3ã€æ‰§è¡Œåˆ›å»ºheapster</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubect create -f ./</span></span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œåˆ›å»ºå®Œæˆåï¼Œç­‰å¾…ä¸€ä¼šæ˜¾ç¤ºå›¾åƒ<br><img src="https://img.xxlaila.cn/459348skndiy923s.png" alt="img"><br><img src="https://img.xxlaila.cn/34293knsdalsk0329.png" alt="img"></p><h4 id="3-1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸"><a href="#3-1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸" class="headerlink" title="3.1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸"></a>3.1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸</h4><p>å‰é¢åœ¨grafanaæ–‡ä»¶é‡Œé¢å¢åŠ äº†nodePoer: 30003çš„ç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»æ„èŠ‚ç‚¹ip:30003è¿›è¡Œè®¿é—®grafanaç•Œé¢ã€‚</p><p><img src="https://img.xxlaila.cn/453847sndkniuy234wds.png" alt="img"><br><strong>å¯ä»¥è¿›è¡Œé…ç½®grafanaã€‚</strong></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>heapster</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²eurekaé›†ç¾¤</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2eureka%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>eureka ä¸é˜è¿°ä»‹ç»ï¼Œè¿™é‡Œç›´æ¥å¼€å§‹åœ¨kubernetesä¸‹éƒ¨ç½²eurekaé›†ç¾¤</p><h3 id="1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ "><a href="#1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ " class="headerlink" title="1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ "></a>1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ </h3><p>eureka åªä¸€ä¸ªæœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œéƒ¨ç½²æœ‰çŠ¶æ€æœåŠ¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨StatefulSet</p><h4 id="1-1ã€å¢åŠ dockerfile"><a href="#1-1ã€å¢åŠ dockerfile" class="headerlink" title="1.1ã€å¢åŠ dockerfile"></a>1.1ã€å¢åŠ dockerfile</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat Dockerfile</span><br><span class="line">FROM docker.io/xxlaila/centos7.6-jdk1.8:latest</span><br><span class="line">MAINTAINER xxlaila <span class="string">"cq_xxlaila@163.com"</span></span><br><span class="line"><span class="comment"># Install dependent plugin</span></span><br><span class="line"></span><br><span class="line">ADD target/kxl-eureka.jar /opt/webapps/kxl-eureka.jar</span><br><span class="line">ADD application.yaml /opt/webapps/application.yaml</span><br><span class="line"></span><br><span class="line">WORKDIR /opt/webapps</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"-Dspring.profiles.active=dev"</span>, <span class="string">"kxl-eureka.jar"</span>]</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#1-2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="1.2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>1.2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><p>åœ¨åšeurekaé›†ç¾¤çš„æ—¶å€™ï¼Œapplication.yamlçš„é…ç½®æ–‡ä»¶å¾ˆé‡è¦ï¼Œé…ç½®æ–‡ä»¶åšä¸å¥½ï¼Œå°†ä¼šç›´æ¥å½±å“åˆ°eurekaçš„å¯åŠ¨ï¼Œè¿˜æœ‰é›†ç¾¤çš„æ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat application.yaml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: kxl-eureka</span><br><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line"><span class="comment">#    prefer-ip-address: true</span></span><br><span class="line">    hostname: <span class="variable">$&#123;EUREKA_HOST_NAME:peer1&#125;</span> <span class="comment">#æœåŠ¡ä¸»æœºå</span></span><br><span class="line">    appname: <span class="variable">$&#123;spring.application.name&#125;</span>  <span class="comment">#æœåŠ¡åç§°ï¼Œé»˜è®¤ä¸º unknow è¿™é‡Œç›´æ¥å– spring.application.name äº†</span></span><br><span class="line">    <span class="comment"># server ä»æœ€åä¸€æ¬¡æ”¶åˆ°å¿ƒè·³åˆ°ç§»é™¤åºŸå¼ƒæœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    lease-expiration-duration-in-seconds: 90</span><br><span class="line">    <span class="comment"># client ç»™ server å‘é€å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæ¯” lease-expiration-duration-in-seconds å°</span></span><br><span class="line">    lease-renewal-interval-in-seconds: 30</span><br><span class="line"></span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: <span class="variable">$&#123;EUREKA_URL_LIST:http://peer1:8761/eureka/&#125;</span> <span class="comment"># æŒ‡å®šæœåŠ¡ä¸­å¿ƒ eureka serverçš„åœ°å€</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦ä»eurekaä¸Šæ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    fetch-registry: <span class="variable">$&#123;BOOL_FETCH:true&#125;</span>   <span class="comment"># æ˜¯å¦æ‹‰å– eureka server çš„æ³¨å†Œä¿¡æ¯ã€‚ é»˜è®¤ä¸ºtrue</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦æ³¨å†Œåˆ°eurekaä¸Šï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    register-with-eureka: <span class="variable">$&#123;BOOL_REGISTER:true&#125;</span>  <span class="comment"># æ˜¯å¦æŠŠæœåŠ¡ä¸­å¿ƒæœ¬èº«å½“åšeureka client æ³¨å†Œã€‚é»˜è®¤ä¸ºtrue</span></span><br><span class="line">    <span class="comment"># client é—´éš”å¤šä¹…å»æ‹‰å»æœåŠ¡ä¿¡æ¯(ç§’)</span></span><br><span class="line">    registry-fetch-interval-seconds: 30</span><br><span class="line">  server:</span><br><span class="line">    <span class="comment"># è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåº”å¯¹ç½‘ç»œé—ªæ–­æƒ…å†µï¼Œå¤§é¢ç§¯ä¸¢å¤±è¿‡å¤šçš„clientï¼Œä¸åˆ é™¤æœåŠ¡</span></span><br><span class="line">    <span class="built_in">enable</span>-self-preservation: <span class="variable">$&#123;SELF_PRESERVATION:true&#125;</span>     <span class="comment"># æ˜¯å¦å¼€å¯è‡ªæˆ‘ä¿æŠ¤ã€‚ é»˜è®¤ä¸º true.</span></span><br><span class="line">    <span class="comment"># æ¯åˆ†é’Ÿå¿ƒè·³æ•° å®é™…/æœŸæœ›ï¼Œå¦‚æœå°äºé˜ˆå€¼(threshold)ï¼Œåˆ™è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</span></span><br><span class="line">    renewal-percent-threshold: 0.85</span><br><span class="line">    <span class="comment"># æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">    eviction-interval-timer-in-ms: 60000</span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: <span class="variable">$&#123;EUREKA_APPLICATION_NAME:eureka-server&#125;</span></span><br></pre></td></tr></table></figure><h4 id="1-3ã€åˆ›å»º-eureka-dockeré•œåƒ"><a href="#1-3ã€åˆ›å»º-eureka-dockeré•œåƒ" class="headerlink" title="1.3ã€åˆ›å»º eureka dockeré•œåƒ"></a>1.3ã€åˆ›å»º eureka dockeré•œåƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t xxlaila/kxl-eureka:v1 .</span><br><span class="line">$ docker push xxlaila/kxl-eureka:v1</span><br></pre></td></tr></table></figure><h3 id="2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤"><a href="#2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤" class="headerlink" title="2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤"></a>2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤</h3><h4 id="2-1ã€åˆ›å»ºeurekaé›†ç¾¤"><a href="#2-1ã€åˆ›å»ºeurekaé›†ç¾¤" class="headerlink" title="2.1ã€åˆ›å»ºeurekaé›†ç¾¤"></a>2.1ã€åˆ›å»ºeurekaé›†ç¾¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat kxl-eureka.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  labels:</span><br><span class="line">    app: eureka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8761</span><br><span class="line">    name: eureka</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"eureka"</span></span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: eureka</span><br><span class="line">        image:  docker.io/xxlaila/kxl-eureka:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8761</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">          <span class="comment"># Due to camelcase issues with "defaultZone" and "preferIpAddress", _JAVA_OPTIONS is used here</span></span><br><span class="line">        - name: eureka_client_serviceUrl_defaultZone</span><br><span class="line">          <span class="comment">#value: http://eureka-0.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/,http://eureka-1.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/</span></span><br><span class="line">          value: http://eureka-0.eureka:8761/eureka/,http://eureka-1.eureka:8761/eureka/,http://eureka-2.eureka:8761/eureka/</span><br><span class="line">        - name: EUREKA_CLIENT_REGISTERWITHEUREKA</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: EUREKA_CLIENT_FETCHREGISTRY</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">          <span class="comment"># In the docker image, this is set to localhost. Otherwise, we could leave this empty.</span></span><br><span class="line">          <span class="comment"># The hostnames must match with the the eureka serviceUrls, otherwise the replicas are reported as unavailable in the eureka dashboard</span></span><br><span class="line">        - name: EUREKA_INSTANCE_HOSTNAME</span><br><span class="line">          <span class="comment">#value: "$(MY_POD_NAME).eureka.&lt;namespace.svc.cluster.local"</span></span><br><span class="line">          value: <span class="string">"<span class="variable">$(MY_POD_NAME)</span>.eureka"</span></span><br><span class="line">          <span class="comment">#value: eureka</span></span><br><span class="line">          <span class="comment"># For the other (stateless) services, this should probably be set to true, since their pods have no DNS-resolvable  hostnames</span></span><br><span class="line">       <span class="comment">#- name: EUREKA_INSTANCE_PREFERIPADDRESS</span></span><br><span class="line">       <span class="comment">#  value: "false"</span></span><br><span class="line">  <span class="comment"># No need to start the pods in order. We just need the stable network identity</span></span><br><span class="line">  podManagementPolicy: <span class="string">"Parallel"</span></span><br></pre></td></tr></table></figure><p>åœ¨åšè¿™ä¸ªçš„æ—¶å€™å…¶å®é‡åˆ°äº†å¾ˆå¤šå‘ï¼Œä¹Ÿæ˜¯å‚è€ƒä¸€äº›æ–‡ç« æ‰å®Œæˆçš„,<a href="https://github.com/kingschan1204/blog/issues/5" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><h4 id="2-2ã€åˆ›å»ºeureka-Ingress"><a href="#2-2ã€åˆ›å»ºeureka-Ingress" class="headerlink" title="2.2ã€åˆ›å»ºeureka Ingress"></a>2.2ã€åˆ›å»ºeureka Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat eureka-ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka-ingress</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/secure-backends: <span class="string">"true"</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: eureka.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: eureka</span><br><span class="line">          servicePort: 8761</span><br></pre></td></tr></table></figure><h4 id="2-3ã€æ‰§è¡Œåˆ›å»º"><a href="#2-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="2.3ã€æ‰§è¡Œåˆ›å»º"></a>2.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f .</span><br><span class="line">$ kubectl get pods -n kube-dev</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">eureka-0   1/1     Running   0          21m</span><br><span class="line">eureka-1   1/1     Running   0          21m</span><br><span class="line">eureka-2   1/1     Running   0          21m</span><br><span class="line">$ kubectl get pods,svc,rs -n kube-dev</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/eureka-0   1/1     Running   0          21m</span><br><span class="line">pod/eureka-1   1/1     Running   0          21m</span><br><span class="line">pod/eureka-2   1/1     Running   0          21m</span><br><span class="line"></span><br><span class="line">NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/eureka   ClusterIP   None         &lt;none&gt;        8761/TCP   21m</span><br></pre></td></tr></table></figure><h4 id="2-4ã€è®¿é—®éªŒè¯"><a href="#2-4ã€è®¿é—®éªŒè¯" class="headerlink" title="2.4ã€è®¿é—®éªŒè¯"></a>2.4ã€è®¿é—®éªŒè¯</h4><p><img src="https://img.xxlaila.cn/34239uskdnksjda.png" alt="img"><br>é€šè¿‡åŸŸåè®¿é—®ï¼š<br><img src="https://img.xxlaila.cn/89745jkndklsajkdhsajkbfa.png" alt="img"></p><h3 id="3ã€eureka-ç¯å¢ƒ"><a href="#3ã€eureka-ç¯å¢ƒ" class="headerlink" title="3ã€eureka ç¯å¢ƒ"></a>3ã€eureka ç¯å¢ƒ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ ¹æ®2.4å°èŠ‚å¯ä»¥çœ‹åˆ°ï¼Œenviroonmentä¸ºtestï¼Œæˆ‘ä»¬åœ¨dockerfileæŒ‡å®šçš„ä¸ºdevï¼Œæ‰€ä»¥è¿™é‡Œå°±æœ‰ç‚¹å·®æ± ï¼Œä½†æ˜¯æŸ¥çœ‹äº†ä¸€ä¸‹èµ„æ–™ï¼Œè¿™ä¸ªè¦ä¹ˆå°±å†™å¤šä¸ªapplication.yamlçš„é…ç½®æ–‡ä»¶ï¼Œè¦ä¹ˆå°±æ‰“å¤šä¸ªåŒ…ï¼Œè¿™æ ·å°±æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”è€ƒè™‘åˆ°å…¬å¸å¾®æœåŠ¡çš„ç‰¹æ®Šæ€§ï¼Œæ—¢è¦æ»¡è¶³äºå…¬å¸çš„å¾®æœåŠ¡æ¶æ„ï¼Œæœ‰è¦è€ƒè™‘çš„æ¨¡ç‰ˆçš„é€šç”¨æ€§ï¼Œè¿˜éœ€è¦è€ƒè™‘è¿ç»´ç»´æŠ¤çš„ä¾¿æ·æ€§ã€‚ä¸‹é¢ä¸€èµ·æ¥çœ‹çœ‹åŸºäºå…¬å¸çš„å®šåˆ¶åŒ–æ¥æ”¹å˜è¿™ä¸ªå±€é™æ€§ã€‚</p><h4 id="3-1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡"><a href="#3-1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡" class="headerlink" title="3.1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡"></a>3.1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CONFIG_API_SERVER=http://api.conf.xxlaila.io</span><br><span class="line">RUN_CLUSTER=default</span><br><span class="line">RUN_MODE=AUTO</span><br><span class="line">RUN_ENV=demo</span><br><span class="line">CONFIG_API_SERVERï¼šå…¬å¸é…ç½®ä¸­å¿ƒapiçš„åœ°å€ï¼Œappæ‹‰å–é…ç½®ä¸­å¿ƒçš„é…ç½®</span><br><span class="line">RUN_CLUSTERï¼šé»˜è®¤é›†ç¾¤ï¼Œåšç°åº¦å‘å¸ƒä½¿ç”¨</span><br><span class="line">RUN_MODEï¼š</span><br><span class="line">RUN_ENVï¼šå½“å‰ç³»ç»Ÿæ‰€è¿è¡Œçš„ç¯å¢ƒ</span><br></pre></td></tr></table></figure><h4 id="3-2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶"><a href="#3-2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶" class="headerlink" title="3.2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶"></a>3.2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶</h4><p>å¢åŠ é…ç½®eureka:<code>environment: ${RUN_ENV}</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat application.yaml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: kxl-eureka</span><br><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  environment: <span class="variable">$&#123;RUN_ENV&#125;</span></span><br><span class="line">  instance:</span><br><span class="line"><span class="comment">#    prefer-ip-address: true</span></span><br><span class="line">    hostname: <span class="variable">$&#123;EUREKA_HOST_NAME:peer1&#125;</span></span><br><span class="line">    appname: <span class="variable">$&#123;spring.application.name&#125;</span></span><br><span class="line">    <span class="comment"># server ä»æœ€åä¸€æ¬¡æ”¶åˆ°å¿ƒè·³åˆ°ç§»é™¤åºŸå¼ƒæœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    lease-expiration-duration-in-seconds: 90</span><br><span class="line">    <span class="comment"># client ç»™ server å‘é€å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæ¯” lease-expiration-duration-in-seconds å°</span></span><br><span class="line">    lease-renewal-interval-in-seconds: 30</span><br><span class="line"></span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: <span class="variable">$&#123;EUREKA_URL_LIST:http://peer1:8761/eureka/&#125;</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦ä»eurekaä¸Šæ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    fetch-registry: <span class="variable">$&#123;BOOL_FETCH:true&#125;</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦æ³¨å†Œåˆ°eurekaä¸Šï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    register-with-eureka: <span class="variable">$&#123;BOOL_REGISTER:true&#125;</span></span><br><span class="line">    <span class="comment"># client é—´éš”å¤šä¹…å»æ‹‰å»æœåŠ¡ä¿¡æ¯(ç§’)</span></span><br><span class="line">    registry-fetch-interval-seconds: 30</span><br><span class="line">  server:</span><br><span class="line">    <span class="comment"># è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåº”å¯¹ç½‘ç»œé—ªæ–­æƒ…å†µï¼Œå¤§é¢ç§¯ä¸¢å¤±è¿‡å¤šçš„clientï¼Œä¸åˆ é™¤æœåŠ¡</span></span><br><span class="line">    <span class="built_in">enable</span>-self-preservation: <span class="variable">$&#123;SELF_PRESERVATION:true&#125;</span></span><br><span class="line">    <span class="comment"># æ¯åˆ†é’Ÿå¿ƒè·³æ•° å®é™…/æœŸæœ›ï¼Œå¦‚æœå°äºé˜ˆå€¼(threshold)ï¼Œåˆ™è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</span></span><br><span class="line">    renewal-percent-threshold: 0.85</span><br><span class="line">    <span class="comment"># æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">    eviction-interval-timer-in-ms: 60000</span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: <span class="variable">$&#123;EUREKA_APPLICATION_NAME:eureka-server&#125;</span></span><br></pre></td></tr></table></figure><h4 id="3-3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶"><a href="#3-3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶" class="headerlink" title="3.3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶"></a>3.3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat kxl-eureka.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  labels:</span><br><span class="line">    app: eureka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8761</span><br><span class="line">    name: eureka</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"eureka"</span></span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: eureka</span><br><span class="line">        image:  docker.io/xxlaila/kxl-eureka:v2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8761</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">          <span class="comment"># Due to camelcase issues with "defaultZone" and "preferIpAddress", _JAVA_OPTIONS is used here</span></span><br><span class="line">        - name: eureka_client_serviceUrl_defaultZone</span><br><span class="line">          <span class="comment">#value: http://eureka-0.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/,http://eureka-1.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/</span></span><br><span class="line">          value: http://eureka-0.eureka:8761/eureka/,http://eureka-1.eureka:8761/eureka/,http://eureka-2.eureka:8761/eureka/</span><br><span class="line">        - name: EUREKA_CLIENT_REGISTERWITHEUREKA</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: EUREKA_CLIENT_FETCHREGISTRY</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">          <span class="comment"># In the docker image, this is set to localhost. Otherwise, we could leave this empty.</span></span><br><span class="line">          <span class="comment"># The hostnames must match with the the eureka serviceUrls, otherwise the replicas are reported as unavailable in the eureka dashboard</span></span><br><span class="line">        - name: EUREKA_INSTANCE_HOSTNAME</span><br><span class="line">          <span class="comment">#value: "$(MY_POD_NAME).eureka.&lt;namespace.svc.cluster.local"</span></span><br><span class="line">          value: <span class="string">"<span class="variable">$(MY_POD_NAME)</span>.eureka"</span></span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: <span class="built_in">test</span></span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.io</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">          <span class="comment">#value: eureka</span></span><br><span class="line">          <span class="comment"># For the other (stateless) services, this should probably be set to true, since their pods have no DNS-resolvable  hostnames</span></span><br><span class="line">       <span class="comment">#- name: EUREKA_INSTANCE_PREFERIPADDRESS</span></span><br><span class="line">       <span class="comment">#  value: "false"</span></span><br><span class="line">  <span class="comment"># No need to start the pods in order. We just need the stable network identity</span></span><br><span class="line">  podManagementPolicy: <span class="string">"Parallel"</span></span><br></pre></td></tr></table></figure><h4 id="3-4ã€é‡å»ºpod"><a href="#3-4ã€é‡å»ºpod" class="headerlink" title="3.4ã€é‡å»ºpod"></a>3.4ã€é‡å»ºpod</h4><p>podé‡å»ºä»¥åæˆ‘ä»¬ç»è¿‡è®¿é—®å¯ä»¥çœ‹åˆ°</p><p><img src="https://img.xxlaila.cn/453khskdha324.png" alt="img"><br><img src="https://img.xxlaila.cn/3746dfnks324.png" alt="img"></p><p><em>åç»­æŒç»­ä¼˜åŒ–</em></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>eureka</tag>
      </tags>
  </entry>
  <entry>
    <title>jiraæ¥å…¥LDAP</title>
    <url>/2019/08/24/jira%E6%8E%A5%E5%85%A5LDAP/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰ä»‹ç»äº†jira å’Œconfluenceçš„è´¦æˆ·ç»“åˆï¼Œjiraå’Œconfluenceå¯ä»¥ä½¿ç”¨ä¸€ä¸ªè´¦æˆ·ï¼Œæœ‰äººå‘˜ç¦»èŒä¹‹åç›´æ¥åœ¨jiraå§ç”¨æˆ·ç¦ç”¨å³å¯ï¼Œä¸€ç«¯æ“ä½œï¼Œæ–¹ä¾¿ä¸¤ç«¯ï¼Œä½†æ˜¯éšç€å…¬å¸äººå‘˜è¶Šæ¥è¶Šå¤šï¼Œè¿™æ ·çš„æ–¹å¼å·²ç»ä¸åœ¨é€‚åˆè¿™ç§äº†ï¼Œæ¥ä¸€ä¸ªç”¨æˆ·å°±éœ€è¦å»åˆ›å»ºï¼Œå¯¹è¿ç»´æ¥è¯´ï¼Œè¿™æ˜¯é‡å¤çš„å·¥ä½œï¼Œæå‡ä¸äº†ä»»ä½•æ•ˆç‡ï¼Œè€Œä¸”æ¯è‰æ— å‘³ã€‚è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ldapï¼Œjiraå’Œconfluenceéƒ½æ˜¯æ”¯æŒldapï¼Œldapçš„å¥½å¤„ï¼Œè¿™é‡Œä¸é˜è¿°ï¼Œä¸‹é¢æ¥çœ‹çœ‹å¦‚ä½•é…ç½®jiraä»‹å…¥ldapã€‚confluenceè¿˜æ˜¯æ¥å…¥jiraï¼Œè¿™æ ·æˆ‘ä»¬å°±åªæ“ä½œladpå’Œjiraï¼Œç®€å•çœäº‹ã€‚</p></blockquote><blockquote><p>é—®é¢˜ç‚¹:<br>&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºåœ¨å»ºç«‹jiraå’Œconfluenceçš„æ—¶å€™è¿˜æ²¡æœ‰ldapï¼Œldapæ˜¯åæœŸæ‰æ¥å…¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±å­˜åœ¨äºæ€ä¹ˆå§ä»¥å‰æœ‰jiraç™»å½•çš„è´¦æˆ·è®¤è¯åˆ‡æ¢åˆ°ldapã€‚è€Œä¸”ä¸å½±å“ä¹‹å‰çš„æ–‡æ¡£ï¼Œä½†æ˜¯ç”¨æˆ·æƒé™ä¼šå½±å“ï¼Œé—®é¢˜ä¸å¤§ï¼Œå¯ä»¥æ·»åŠ ã€‚ä¸‹é¢å¼€å§‹æ“ä½œ</p></blockquote><a id="more"></a><h3 id="1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢"><a href="#1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢" class="headerlink" title="1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢"></a>1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢</h3><p><img src="https://img.xxlaila.cn/image2018-7-12_11-12-55.png" alt="img"></p><h3 id="2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢"><a href="#2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢" class="headerlink" title="2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢"></a>2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-32-32.png" alt="img"><br><img src="https://img.xxlaila.cn/image2019-6-12_15-32-48.png" alt="img"></p><h3 id="3ã€é«˜çº§è®¾ç½®"><a href="#3ã€é«˜çº§è®¾ç½®" class="headerlink" title="3ã€é«˜çº§è®¾ç½®"></a>3ã€é«˜çº§è®¾ç½®</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-17.png" alt="img"></p><h3 id="4ã€é…ç½®ç”¨æˆ·æ¨¡å¼"><a href="#4ã€é…ç½®ç”¨æˆ·æ¨¡å¼" class="headerlink" title="4ã€é…ç½®ç”¨æˆ·æ¨¡å¼"></a>4ã€é…ç½®ç”¨æˆ·æ¨¡å¼</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-35.png" alt="img"></p><h3 id="5ã€è®¾ç½®ç»„æ¨¡å¼"><a href="#5ã€è®¾ç½®ç»„æ¨¡å¼" class="headerlink" title="5ã€è®¾ç½®ç»„æ¨¡å¼"></a>5ã€è®¾ç½®ç»„æ¨¡å¼</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-55.png" alt="img"></p><h3 id="6ã€è®¾ç½®æˆå‘˜æ¨¡å¼"><a href="#6ã€è®¾ç½®æˆå‘˜æ¨¡å¼" class="headerlink" title="6ã€è®¾ç½®æˆå‘˜æ¨¡å¼"></a>6ã€è®¾ç½®æˆå‘˜æ¨¡å¼</h3><p>è¿™é‡Œldapä¸€å®šè¦å­˜åœ¨ä¸ladpçš„groupé‡Œé¢<br><img src="https://img.xxlaila.cn/image2019-6-12_15-34-23.png" alt="img"></p><h3 id="7ã€æµ‹è¯•å¹¶ä¿å­˜"><a href="#7ã€æµ‹è¯•å¹¶ä¿å­˜" class="headerlink" title="7ã€æµ‹è¯•å¹¶ä¿å­˜"></a>7ã€æµ‹è¯•å¹¶ä¿å­˜</h3><p>è¿™é‡Œæµ‹è¯•è´¦æˆ·ä¸€å®šæ˜¯ladpçš„è´¦æˆ·<br><img src="https://img.xxlaila.cn/image2019-6-12_15-34-58.png" alt="img"></p><h3 id="8ã€åŒæ­¥è´¦æˆ·"><a href="#8ã€åŒæ­¥è´¦æˆ·" class="headerlink" title="8ã€åŒæ­¥è´¦æˆ·"></a>8ã€åŒæ­¥è´¦æˆ·</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-35-50.png" alt="img"></p><h3 id="9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•"><a href="#9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•" class="headerlink" title="9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•"></a>9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-36-53.png" alt="img"></p><h2 id="jiraè´¦æˆ·åˆ‡æ¢è‡³ldap"><a href="#jiraè´¦æˆ·åˆ‡æ¢è‡³ldap" class="headerlink" title="jiraè´¦æˆ·åˆ‡æ¢è‡³ldap"></a>jiraè´¦æˆ·åˆ‡æ¢è‡³ldap</h2><blockquote><p>jiraé…ç½®ldapä»¥åé»˜è®¤æ˜¯æœ¬åœ°è´¦æˆ·å’Œldapæ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œç”¨æˆ·å¯ä»¥ç”¨ä»¥å‰çš„æœ¬åœ°è´¦æˆ·å’Œldapéƒ½ç™»å½•ï¼Œè¿™é‡Œå®ç°ldapç™»å½•ï¼Œç¦æ­¢æœ¬åœ°ç™»å½•ã€‚</p></blockquote><h3 id="å‰ç½®æ¡ä»¶"><a href="#å‰ç½®æ¡ä»¶" class="headerlink" title="å‰ç½®æ¡ä»¶"></a>å‰ç½®æ¡ä»¶</h3><ul><li>jiraçš„æœ¬åœ°è´¦æˆ·å’Œldapçš„è´¦æˆ·åç§°å¿…é¡»ä¸€æ ·</li><li>æ“ä½œå‰è¯·å¤‡ä»½æ•°æ®åº“</li><li>ç”¨æˆ·é‚®ç®±ä¿æŒä¸€è‡´</li><li>å¯†ç æ— æ‰€è°“ï¼Œä¸éœ€è¦ç»Ÿä¸€</li></ul><h3 id="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”"><a href="#æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”" class="headerlink" title="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”"></a>æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”</h3><p>ç™»å½•jiraçš„æ•°æ®åº“ã€‚ç„¶åæ‰¾åˆ°cwd_userè¡¨</p><h4 id="cwd-userè¡¨"><a href="#cwd-userè¡¨" class="headerlink" title="cwd_userè¡¨"></a>cwd_userè¡¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;jiraçš„å‰å°ä¸èƒ½ç›´æ¥å»æ›´æ”¹ï¼Œåªæœ‰æ›´æ”¹æ•°æ®åº“ï¼Œè¿›å…¥æ•°æ®åº“ï¼Œæ‰¾åˆ°ä¸€å¼ cwd_userçš„è¡¨ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰ç”¨æˆ·çš„ç™»å½•è´¦å·ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå­—æ®µdirectory_idçš„ï¼Œè¿™ä¸ªå­—æ®µæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ¬åœ°è´¦æˆ·çš„idæ˜¯1ï¼ŒldapåŒæ­¥è¿‡æ¥çš„è´¦æˆ·æ˜¯10001ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://img.xxlaila.cn/1566617986314.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ç»§ç»­çœ‹è¯¥è¡¨çš„credentialå­—æ®µï¼Œå¯†ç ä¹Ÿæœ‰åŒºåˆ«,æœ¬åœ°è´¦æˆ·æ˜¯æœ‰ä¸€ä¸²åŠ å¯†åçš„å­—ç¬¦ä¸²ï¼Œldapè®¤è¯çš„æ˜¯nopassï¼ŒåŒ…æ‹¬åé¢çš„external_id ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/1566618124910.jpg" alt="img"></p><h4 id="cwd-directoryè¡¨"><a href="#cwd-directoryè¡¨" class="headerlink" title="cwd_directoryè¡¨"></a>cwd_directoryè¡¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰“å¼€cwd_directoryè¡¨ï¼Œé‡Œé¢æœ‰ä¸¤æ¡æ•°æ®ï¼Œä¸€ä¸ªå¯¹åº”çš„æ˜¯ldapï¼Œä¸€ä¸ªå¯¹åº”çš„æœ¬åœ°ï¼Œå’Œcwd_useræ˜¯å¯¹åº”çš„ï¼Œå¦‚å›¾ï¼š<br><img src="https://img.xxlaila.cn/image2019-6-13_10-0-47.png" alt="img"></p><h4 id="ä¿®æ”¹æ•°æ®åº“"><a href="#ä¿®æ”¹æ•°æ®åº“" class="headerlink" title="ä¿®æ”¹æ•°æ®åº“"></a>ä¿®æ”¹æ•°æ®åº“</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;è®°ä½ldapç›®å½•çš„idï¼Œç„¶ååœ¨cwd_userè¡¨é‡Œé¢åˆ é™¤ldapçš„ç›¸åŒè´¦æˆ·çš„æ•´æ¡è®°å½•ï¼Œå› ä¸ºè¦ä¼ªè£…åŸæœ¬ç³»ç»Ÿè‡ªå¸¦çš„ç›®å½•æœåŠ¡å™¨ï¼ŒåŸæ¥ç¼–è¾‘çš„æ–‡ä»¶å’Œå†…å®¹ä¸ºåŸå…ˆè¿™ä¸ªç”¨æˆ·çš„idã€‚ä¿®æ”¹directory_id ä¸ºldapçš„idï¼Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦ä¿®æ”¹çš„åœ°æ–¹ä¸ºCREDENTIALçš„å­—æ®µï¼ŒæŠŠå®ƒä¿®æ”¹ä¸ºnopassã€‚ä¿®æ”¹å®Œæˆåéœ€è¦é‡å¯jiraï¼Œä¸é‡å¯ä¸ä¼šç”Ÿæ•ˆï¼Œè€Œä¸”ç™»å½•æœåŠ¡å™¨è¿˜ä¼šæŠ¥é”™ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œjiraå’Œconfluenceæ˜¯åšäº†å…³è”çš„ï¼Œjiraä¿®æ”¹ä»¥åï¼Œconfluenceä¹Ÿå¯ä»¥è¿›è¡Œç™»å½•ï¼Œæ— éœ€åœ¨confluenceåœ¨è®¾ç½®ä¸€æ¬¡ldap;ä¿®æ”¹å®Œæˆåï¼Œä»¥å‰ç”¨æˆ·çš„ç®¡ç†å‘˜æƒé™æœ‰é—®é¢˜ï¼Œé‡æ–°æ·»åŠ ä¸€æ¬¡å³å¯ã€‚ä¸ä¼šå½±å“å…¶ä»–çš„ã€‚è®¾ç½®æ–‡æ¡£ï¼Œldapæƒé™è¦é€‰æ‹©ä¸ºåªè¯»ï¼Œä¸”ä¸ºæœ¬åœ°ç»„ã€‚ç„¶åå§jiaå’Œconfluenceçš„æ™®é€šç»„æ·»åŠ è¿›å»ï¼Œå¦åˆ™ç”¨æˆ·è¿›æ¥æ²¡æœ‰æƒé™</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jira</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>confluenceä¸jiraè´¦æˆ·æ‰“é€š</title>
    <url>/2019/08/24/confluence%E4%B8%8Ejira%E8%B4%A6%E6%88%B7%E6%89%93%E9%80%9A/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p><a href="http://xxlaila.github.io/2019/08/24/confluence-install/" target="_blank" rel="noopener">confluence</a>å®‰è£…</p><h3 id="ç™»å½•confluence"><a href="#ç™»å½•confluence" class="headerlink" title="ç™»å½•confluence"></a>ç™»å½•confluence</h3><p>ç‚¹å‡»ç”¨æˆ·ç®¡ç†</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1566615435701.jpg" alt="img"></p><ul><li>ç‚¹å‡»ç”¨æˆ·ç›®å½•<br><img src="https://img.xxlaila.cn/1566615500778.jpg" alt="img"></li></ul><h3 id="å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥"><a href="#å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥" class="headerlink" title="å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥"></a>å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥</h3><ul><li>ç‚¹å‡»æ·»åŠ ç›®å½•</li></ul><p><img src="https://img.xxlaila.cn/1566615580951.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566616502650.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566616536151.jpg" alt="img"></p><p>ç‚¹å‡»æµ‹è¯•è¿æ¥ï¼Œè¿æ¥æˆåŠŸä»¥åï¼Œç‚¹å‡»æµ‹è¯•ä¿å­˜ã€‚å›åˆ°ç•Œé¢å¯ä»¥ç‚¹å‡»åŒæ­¥<br><img src="https://img.xxlaila.cn/1566616609967.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>confluence</category>
      </categories>
      <tags>
        <tag>confluence,jira</tag>
      </tags>
  </entry>
  <entry>
    <title>jiraå®‰è£…å’Œé…ç½®</title>
    <url>/2019/08/24/jira%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;JIRAæ˜¯Atlassianå…¬å¸å‡ºå“çš„é¡¹ç›®ä¸äº‹åŠ¡è·Ÿè¸ªå·¥å…·ï¼Œè¢«å¹¿æ³›åº”ç”¨äºç¼ºé™·è·Ÿè¸ªã€å®¢æˆ·æœåŠ¡ã€éœ€æ±‚æ”¶é›†ã€æµç¨‹å®¡æ‰¹ã€ä»»åŠ¡è·Ÿè¸ªã€é¡¹ç›®è·Ÿè¸ªå’Œæ•æ·ç®¡ç†ç­‰å·¥ä½œé¢†åŸŸã€‚</p><ul><li>ç¯å¢ƒå‡†å¤‡</li></ul><table><thead><tr><th>åº”ç”¨</th><th>æœåŠ¡å™¨é…ç½®</th><th>æ“ä½œç³»ç»Ÿ</th><th>æ’ä»¶</th></tr></thead><tbody><tr><td>mysql 5.6 +</td><td>2/4G/50G</td><td>centos 7.4</td><td></td></tr><tr><td>jira</td><td>4/8G/200G</td><td>centos 7.4</td><td>jdk1.8</td></tr></tbody></table><a id="more"></a><h3 id="å®‰è£…JIRA"><a href="#å®‰è£…JIRA" class="headerlink" title="å®‰è£…JIRA"></a>å®‰è£…JIRA</h3><ul><li>æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./atlassian-jira-software-7.2.2-x64.bin</span></span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1524710136913-900.png" alt="img"></p><ul><li><p>å®‰è£…å®Œæˆååœæ­¢JIRA</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒ/etc/init.d/jira stop</span><br></pre></td></tr></table></figure></li><li><p>å¤åˆ¶ç ´è§£åŒ…å’Œæ•°æ®åº“é©±åŠ¨è¿æ¥å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒcp mysql-connector-java-5.1.39-bin.jar atlassian-extras-3.1.2.jar /opt/atlassian/jira/atlassian-jira/WEB-INF/lib/</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨JIRA</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒ/etc/init.d/jira start</span><br></pre></td></tr></table></figure></li></ul><p>ç™»é™†ç½‘é¡µæ§åˆ¶å°è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œç•¥è¿‡ï¼Œè¿™é‡Œè¿™æ˜¯å®Œæˆï¼Œæ— æ³•æˆªå›¾(åæœŸæœ‰æœºä¼šå®‰è£…æˆªå›¾è¡¥ä¸Š)ï¼Œè®¾ç½®ä»¥åçš„æˆªå›¾<br><img src="https://img.xxlaila.cn/1524710090658-810.png" alt="img"></p><h3 id="é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨"><a href="#é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨" class="headerlink" title="é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨"></a>é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨</h3><p><img src="https://img.xxlaila.cn/1524710057086-739.png" alt="img"><br><img src="https://img.xxlaila.cn/1524710038583-516.png" alt="img"></p><p>é…ç½®å®Œæˆåç‚¹å‡»æœ€ä¸‹é¢çš„æµ‹è¯•è¿æ¥</p><p><img src="https://img.xxlaila.cn/1524710027432-202.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jira</category>
      </categories>
      <tags>
        <tag>jira</tag>
      </tags>
  </entry>
  <entry>
    <title>gitæ¸…ç©ºcommitè®°å½•æ–¹æ³•</title>
    <url>/2019/08/24/git%E6%B8%85%E7%A9%BAcommit%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><blockquote><p>è¯´æ˜:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¾‹å¦‚å°†ä»£ç æäº¤åˆ°gitä»“åº“ï¼Œå°†ä¸€äº›æ•æ„Ÿä¿¡æ¯æäº¤ï¼Œæ‰€ä»¥éœ€è¦åˆ é™¤æäº¤è®°å½•ä»¥å½»åº•æ¸…é™¤æäº¤ä¿¡æ¯ï¼Œä»¥å¾—åˆ°ä¸€ä¸ªå¹²å‡€çš„ä»“åº“ä¸”ä»£ç ä¸å˜</p></blockquote><h3 id="1-Checkout"><a href="#1-Checkout" class="headerlink" title="1.Checkout"></a>1.Checkout</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git checkout --orphan latest_branch</span><br></pre></td></tr></table></figure><h3 id="2-Add-all-the-files"><a href="#2-Add-all-the-files" class="headerlink" title="2. Add all the files"></a>2. Add all the files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add -A</span><br></pre></td></tr></table></figure><h3 id="3-Commit-the-changes"><a href="#3-Commit-the-changes" class="headerlink" title="3. Commit the changes"></a>3. Commit the changes</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git commit -am <span class="string">"commit message"</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="4-Delete-the-branch"><a href="#4-Delete-the-branch" class="headerlink" title="4. Delete the branch"></a>4. Delete the branch</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch -D master</span><br></pre></td></tr></table></figure><h3 id="5-Rename-the-current-branch-to-master"><a href="#5-Rename-the-current-branch-to-master" class="headerlink" title="5.Rename the current branch to master"></a>5.Rename the current branch to master</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch -m master</span><br></pre></td></tr></table></figure><h3 id="6-Finally-force-update-your-repository"><a href="#6-Finally-force-update-your-repository" class="headerlink" title="6.Finally, force update your repository"></a>6.Finally, force update your repository</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git push -f origin master</span><br></pre></td></tr></table></figure><h2 id="git-ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥"><a href="#git-ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥" class="headerlink" title="git ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥"></a>git ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥</h2><h3 id="1ã€è¿œç¨‹åˆ†æ”¯"><a href="#1ã€è¿œç¨‹åˆ†æ”¯" class="headerlink" title="1ã€è¿œç¨‹åˆ†æ”¯"></a>1ã€è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹å½“å‰çš„è¿œç¨‹åˆ†æ”¯</span><br><span class="line">$ git remote -v</span><br></pre></td></tr></table></figure><h3 id="2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯"><a href="#2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯" class="headerlink" title="2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯"></a>2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git remote add latest https://github.com/xxlaila/work.git</span><br></pre></td></tr></table></figure><h3 id="3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯"><a href="#3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯" class="headerlink" title="3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯"></a>3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ›´æ–°è¿œç¨‹åˆ†æ”¯</span><br><span class="line">$ git fetch latest</span><br></pre></td></tr></table></figure><h3 id="4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç "><a href="#4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç " class="headerlink" title="4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç "></a>4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç </h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç </span><br><span class="line">$ git rebase latest/dev</span><br></pre></td></tr></table></figure><h3 id="5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“"><a href="#5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“" class="headerlink" title="5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“"></a>5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ¨é€è¿œç¨‹ä»“åº“</span><br><span class="line">$ git push</span><br></pre></td></tr></table></figure><h2 id="git-ä»£ç ä¿¡æ¯ç»Ÿè®¡"><a href="#git-ä»£ç ä¿¡æ¯ç»Ÿè®¡" class="headerlink" title="git ä»£ç ä¿¡æ¯ç»Ÿè®¡"></a>git ä»£ç ä¿¡æ¯ç»Ÿè®¡</h2><blockquote><p>è¯´æ˜: å…¬å¸æ¯ä¸ªå­£åº¦éƒ½è¦å¯¹å…¬å¸å¼€å‘äººå‘˜çš„å·¥ä½œé‡è¿›è¡Œæ•´ä½“è¯„ä¼°ï¼Œè¯„ä¼°gitä¸Šæ‰€æœ‰ä»£ç åº“çš„commitæ•°é‡å’Œä¿®æ”¹æ–‡ä»¶çš„æ€»è¡Œæ•°</p></blockquote><h3 id="ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡"><a href="#ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡" class="headerlink" title="ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡"></a>ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline --since==2019-04-1 --until=2019-06-30 | wc -l</span><br></pre></td></tr></table></figure><h3 id="ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°"><a href="#ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°" class="headerlink" title="ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°"></a>ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span> --<span class="built_in">stat</span> --since=<span class="string">"2019-4-01"</span> --before=<span class="string">"2019-06-30"</span> |perl -ne <span class="string">'END &#123; print $c &#125; $c += $1 if /(\d+) insertions/'</span></span><br></pre></td></tr></table></figure><h2 id="git-stashä½¿ç”¨"><a href="#git-stashä½¿ç”¨" class="headerlink" title="git stashä½¿ç”¨"></a>git stashä½¿ç”¨</h2><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»Šå¤©é‡åˆ°ä¸€ä¸ªç‰¹æ®Šçš„åœºæ™¯ï¼Œå†™çš„ä¸€ä¸ªpythonç¨‹åºåˆ°æœåŠ¡å™¨ä¸Šæœ‰ä¸€ä¸ªå°bugè¿è¡ŒæŠ¥é”™ï¼Œç„¶åå°±ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šè°ƒè¯•ï¼Œä¿®æ”¹äº†ç¨‹åºï¼Œç¨‹åºæ­£å¸¸è·‘èµ·ï¼Œç„¶è€Œæœ¬åœ°ä¹Ÿè¦ä¿®æ”¹ï¼Œä¿®æ”¹çš„æ—¶å€™åŒæ—¶ä¿®æ”¹äº†å…¶ä»–çš„åœ°æ–¹ï¼Œç„¶åæäº¤äº†gitä¸Šï¼Œè¿™æ—¶ï¼Œéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šæ›´æ–°æœ€æ–°çš„ä»£ç ï¼Œä½†æ˜¯æœåŠ¡å™¨ä¸Šçš„ä»£ç å’Œgitä¸Šçš„ä¸ä¸€è‡´ï¼Œè¿™å°±ä¼šå¯¼è‡´é”™è¯¯ï¼Œè¿™æ—¶gitçš„å¼ºå¤§ä¹‹å¤„å°±ä½“ç°å‡ºæ¥äº†ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git status</span><br><span class="line">èƒ½å¤Ÿå°†æ‰€æœ‰æœªæäº¤çš„ä¿®æ”¹ï¼ˆå·¥ä½œåŒºå’Œæš‚å­˜åŒºï¼‰ä¿å­˜è‡³å †æ ˆä¸­ï¼Œç”¨äºåç»­æ¢å¤å½“å‰å·¥ä½œç›®å½•ã€‚</span><br></pre></td></tr></table></figure><ul><li>æ›´æ–°ä»£ç <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git pull</span><br></pre></td></tr></table></figure></li></ul><p>å°†å½“å‰stashä¸­çš„å†…å®¹å¼¹å‡ºï¼Œå¹¶åº”ç”¨åˆ°å½“å‰åˆ†æ”¯å¯¹åº”çš„å·¥ä½œç›®å½•ä¸Šã€‚</p><blockquote><p>æ³¨:<br>&nbsp;&nbsp;&nbsp;&nbsp;è¯¥å‘½ä»¤å°†å †æ ˆä¸­æœ€è¿‘ä¿å­˜çš„å†…å®¹åˆ é™¤ï¼ˆæ ˆæ˜¯å…ˆè¿›åå‡ºï¼‰</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git stash pop</span><br></pre></td></tr></table></figure><p>æ›´å¤šçš„git stash å‘½ä»¤è¯¦è§£è¯·<a href="https://git-scm.com/book/zh/v1/Git-%E5%B7%A5%E5%85%B7-%E5%82%A8%E8%97%8F%EF%BC%88Stashing%EF%BC%89" target="_blank" rel="noopener">ç‚¹å‡»</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>confluence_install</title>
    <url>/2019/08/24/confluence-install/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Confluenceæ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼ä¸šçŸ¥è¯†ç®¡ç†ä¸ååŒè½¯ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨äºæ„å»ºä¼ä¸šwikiã€‚ä½¿ç”¨ç®€å•ï¼Œä½†å®ƒå¼ºå¤§çš„ç¼–è¾‘å’Œç«™ç‚¹ç®¡ç†ç‰¹å¾èƒ½å¤Ÿå¸®åŠ©å›¢é˜Ÿæˆå‘˜ä¹‹é—´å…±äº«ä¿¡æ¯ã€æ–‡æ¡£åä½œã€é›†ä½“è®¨è®ºï¼Œä¿¡æ¯æ¨é€ã€‚ä¸ºå›¢é˜Ÿæä¾›ä¸€ä¸ªåä½œç¯å¢ƒã€‚åœ¨è¿™é‡Œï¼Œå›¢é˜Ÿæˆå‘˜é½å¿ƒååŠ›ï¼Œå„æ“…å…¶èƒ½ï¼ŒååŒåœ°ç¼–å†™æ–‡æ¡£å’Œç®¡ç†é¡¹ç›®ã€‚ä»æ­¤æ‰“ç ´ä¸åŒå›¢é˜Ÿã€ä¸åŒéƒ¨é—¨ä»¥åŠä¸ªäººä¹‹é—´ä¿¡æ¯å­¤å²›çš„åƒµå±€ï¼ŒConfluenceçœŸæ­£å®ç°äº†ç»„ç»‡èµ„æºå…±äº«ã€‚</p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ç³»ç»Ÿç‰ˆæœ¬</th><th>æ’ä»¶</th><th>è½¯ä»¶</th><th>ç‰ˆæœ¬</th><th>æœåŠ¡é…ç½®</th></tr></thead><tbody><tr><td>centos 7.4</td><td></td><td>mysql</td><td>5.6+</td><td>2/4G/50G</td></tr><tr><td>centos 7.4</td><td>jdk 1.8</td><td>confluence</td><td>6.12.2</td><td>4/8G/200G</td></tr></tbody></table><p>confluence 6.12.2å®‰è£…å¹¶ç ´è§£ï¼Œmysql ç‰ˆæœ¬è¿™é‡Œä½¿ç”¨çš„æ˜¯5.7.24</p><a id="more"></a><h2 id="å®‰è£…mysql-5-7-24-ç‰ˆæœ¬"><a href="#å®‰è£…mysql-5-7-24-ç‰ˆæœ¬" class="headerlink" title="å®‰è£…mysql 5.7.24 ç‰ˆæœ¬"></a>å®‰è£…mysql 5.7.24 ç‰ˆæœ¬</h2><h3 id="å®‰è£…mysql"><a href="#å®‰è£…mysql" class="headerlink" title="å®‰è£…mysql"></a>å®‰è£…mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -ivh http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum list |grep "mysql"</span></span><br><span class="line"><span class="comment"># yum install -y mysql-community-server</span></span><br></pre></td></tr></table></figure><ul><li><p>åŠ¨mysql</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysqld.service</span></span><br><span class="line"><span class="comment"># systemctl enable mysqld.service</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹myslqå¯†ç </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grep 'temporary password' /var/log/mysqld.log</span></span><br><span class="line">mysql&gt; SET PASSWORD = PASSWORD(<span class="string">'news password'</span>);</span><br><span class="line">mysql&gt; ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> PASSWORD EXPIRE NEVER;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚"><a href="#ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚" class="headerlink" title="ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚"></a>ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚</h3><blockquote><p>åœ¨my.cnfé…ç½®æ–‡ä»¶[mysqld]é‡Œé¢æ·»åŠ ä¸‹é¢é…ç½®å‚æ•°</p></blockquote><ul><li><p>å°†é»˜è®¤å­—ç¬¦é›†æŒ‡å®šä¸ºUTF-8</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_bin</span><br></pre></td></tr></table></figure></li><li><p>å°†é»˜è®¤å­˜å‚¨å¼•æ“è®¾ç½®ä¸ºInnoDB</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">default-storage-engine=INNODB</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šå€¼max_allowed_packetè‡³å°‘ä¸º256M</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">max_allowed_packet=512M</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šå€¼ innodb_log_file_size è‡³å°‘ä¸º2GB</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">innodb_log_file_size=2GB</span><br></pre></td></tr></table></figure></li><li><p>ç¡®ä¿æ•°æ®åº“çš„å…¨å±€äº‹åŠ¡éš”ç¦»çº§åˆ«å·²è®¾ç½®ä¸ºREAD-COMMITTED</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">transaction-isolation=READ-COMMITTED</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥äºŒè¿›åˆ¶æ—¥å¿—è®°å½•æ ¼å¼æ˜¯å¦é…ç½®ä¸ºä½¿ç”¨â€œåŸºäºè¡Œâ€çš„äºŒè¿›åˆ¶æ—¥å¿—è®°å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">binlog_format=row</span><br></pre></td></tr></table></figure></li><li><p>ç¡®ä¿sql_modeå‚æ•°æœªæŒ‡å®šNO_AUTO_VALUE_ON_ZERO</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sql_mode = <span class="string">"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯mysqlæ•°æ®åº“</p></li></ul><h3 id="ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“"><a href="#ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“" class="headerlink" title="ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“"></a>ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE confluence CHARACTER SET utf8 COLLATE utf8_bin;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON confluence.* TO confluence@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'password'</span></span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…Confluence"><a href="#å®‰è£…Confluence" class="headerlink" title="å®‰è£…Confluence"></a>å®‰è£…Confluence</h2><p>ä¸‹è½½Confluenceï¼Œè¿™é‡Œä¸‹è½½binæ–‡ä»¶è¿›è¡Œå®‰è£…ï¼Œ<a href="https://www.atlassian.com/software/confluence/download-archives" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a>,ä¸‹è½½çš„ç‰ˆæœ¬ä¸ºatlassian-confluence-6.12.2-x64.bin,åŒ…æœ‰ç‚¹å¤§ï¼Œéœ€è¦ç­‰å¾…â€¦â€¦</p><ul><li><p>èµ‹äºˆæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chmod a+x atlassian-confluence-6.12.2-x64.bin</span></span><br></pre></td></tr></table></figure></li><li><p>å¼€å§‹å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./atlassian-confluence-6.12.2-x64.bin</span></span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…è¿‡ç¨‹ä¸­éœ€è¦åšä¸€äº›åŸºæœ¬çš„é…ç½®ï¼Œè¯¦æƒ…æŸ¥çœ‹æˆ‘çš„é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Unpacking JRE ...</span><br><span class="line">Starting Installer ...</span><br><span class="line"></span><br><span class="line">This will install Confluence 6.12.2 on your computer.</span><br><span class="line">OK [o, Enter], Cancel [c]</span><br><span class="line">o ï¼ˆè¾“å…¥oåŒæ„ï¼‰</span><br><span class="line">Click Next to <span class="built_in">continue</span>, or Cancel to <span class="built_in">exit</span> Setup.</span><br><span class="line"></span><br><span class="line">Choose the appropriate installation or upgrade option.</span><br><span class="line">Please choose one of the following:</span><br><span class="line">Express Install (uses default settings) [1], </span><br><span class="line">Custom Install (recommended <span class="keyword">for</span> advanced users) [2, Enter], </span><br><span class="line">Upgrade an existing Confluence installation [3]</span><br><span class="line">2   (é€‰æ‹©2è‡ªå®šä¹‰å®‰è£…ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€äº›å®šåˆ¶çš„é…ç½®)</span><br></pre></td></tr></table></figure></li><li><p>å¼€å§‹è¿›è¡Œå®‰è£…å‚æ•°çš„é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Select the folder <span class="built_in">where</span> you would like Confluence 6.12.2 to be installed,</span><br><span class="line"><span class="keyword">then</span> click Next.</span><br><span class="line">Where should Confluence 6.12.2 be installed?</span><br><span class="line">[/opt/atlassian/confluence](å®‰è£…ç›®å½•,ç›®å½•å˜åŒ–å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥ï¼Œè¿™é‡Œç›´æ¥å›è½¦)</span><br><span class="line"></span><br><span class="line">Default location <span class="keyword">for</span> Confluence data</span><br><span class="line">[/var/atlassian/application-data/confluence]ï¼ˆæ•°æ®çš„å­˜æ”¾ç›®å½•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¿®æ”¹åˆ°æˆ‘ä»¬çš„æ•°æ®ç›˜ï¼‰</span><br><span class="line">/opt/atlassian/confluence-data/</span><br><span class="line"></span><br><span class="line">Configure <span class="built_in">which</span> ports Confluence will use.</span><br><span class="line">Confluence requires two TCP ports that are not being used by any other</span><br><span class="line">applications on this machine. The HTTP port is <span class="built_in">where</span> you will access</span><br><span class="line">Confluence through your browser. The Control port is used to Startup and</span><br><span class="line">Shutdown Confluence.</span><br><span class="line">Use default ports (HTTP: 8090, Control: 8000) - Recommended [1, Enter], Set custom value <span class="keyword">for</span> HTTP and Control ports [2]</span><br><span class="line">ï¼ˆè¿™é‡Œæ˜¯è®¾ç½®ä½¿ç”¨çš„ç«¯å£ï¼Œé»˜è®¤å³å¯ï¼‰</span><br><span class="line"></span><br><span class="line">Confluence can be run <span class="keyword">in</span> the background.</span><br><span class="line">You may choose to run Confluence as a service, <span class="built_in">which</span> means it will start</span><br><span class="line">automatically whenever the computer restarts.</span><br><span class="line">Install Confluence as Service?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y</span><br><span class="line"></span><br><span class="line">Extracting files ...</span><br><span class="line">                                                                           </span><br><span class="line"></span><br><span class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> we configure Confluence.</span><br><span class="line"></span><br><span class="line">Installation of Confluence 6.12.2 is complete</span><br><span class="line">Start Confluence now?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y</span><br><span class="line"></span><br><span class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> Confluence starts up.</span><br><span class="line">Launching Confluence ...</span><br><span class="line">è¾“å…¥yå›è½¦åConfluenceä¼šè¿›è¡Œåå°å®‰è£…ï¼Œè¿™é‡Œç­‰å¾…å®‰è£…å®Œæˆå³å¯</span><br><span class="line"></span><br><span class="line">Installation of Confluence 6.12.2 is complete</span><br><span class="line">Your installation of Confluence 6.12.2 is now ready and can be accessed via</span><br><span class="line">your browser.</span><br><span class="line">Confluence 6.12.2 can be accessed at http://localhost:8090</span><br><span class="line">å®‰è£…å®Œæˆ</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>é€šè¿‡æµè§ˆå™¨è®¿é—®è¯•ä¸€ä¸‹: <a href="http://ip:8090" target="_blank" rel="noopener">http://ip:8090</a></p></blockquote><h2 id="è¿›è¡Œè®¿é—®é…ç½®"><a href="#è¿›è¡Œè®¿é—®é…ç½®" class="headerlink" title="è¿›è¡Œè®¿é—®é…ç½®"></a>è¿›è¡Œè®¿é—®é…ç½®</h2><h3 id="å®‰è£…nginx-è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®"><a href="#å®‰è£…nginx-è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®" class="headerlink" title="å®‰è£…nginx è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®"></a>å®‰è£…nginx è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum install nginx -y</span></span><br><span class="line"><span class="comment"># systemctl start nginx.service</span></span><br><span class="line"><span class="comment"># systemctl enable nginx.service</span></span><br><span class="line">é…ç½®nginxçš„upstreamè¿™é‡Œå°†ä¸å†é˜è¿°</span><br></pre></td></tr></table></figure><h3 id="æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®"><a href="#æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®" class="headerlink" title="æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®"></a>æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®</h3><ul><li>æ‰“å¼€é¡µé¢</li></ul><p><img src="https://img.xxlaila.cn/1566609337530.jpg" alt="img"></p><ul><li>è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡å’Œäº§å“å®‰è£…</li></ul><p><img src="https://img.xxlaila.cn/1566609486131.jpg" alt="img"></p><p>åœ¨ä¸‹é¢çš„ä¸€ä¸ªç•Œé¢éœ€è¦è®°ä½æœåŠ¡å™¨çš„IDï¼Œè¿™ä¸ªipåœ¨åé¢ç ´è§£çš„æ—¶å€™éœ€è¦çš„</p><ul><li>åœæ­¢confluence<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/init.d/confluence stop</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ç ´è§£Confluence"><a href="#ç ´è§£Confluence" class="headerlink" title="ç ´è§£Confluence"></a>ç ´è§£Confluence</h3><ul><li>åœ¨æœ¬åœ°ä¸‹è½½ç ´è§£å™¨</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/xxlaila/work/blob/master/zip/confluence.zip</span></span><br><span class="line"><span class="comment"># unzip confluence.zip</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨æœåŠ¡å™¨ä¸ŠæŠŠatlassian-extras-decoder-v2-3.4.1.jarè¿›è¡Œå¦‚ä¸‹æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /opt/atlassian/confluence/confluence/WEB-INF/lib</span></span><br><span class="line"><span class="comment"># cp atlassian-extras-decoder-v2-3.4.1.jar /opt/atlassian-extras-2.4.jar</span></span><br><span class="line"><span class="comment"># mv atlassian-extras-decoder-v2-3.4.1.jar atlassian-extras-decoder-v2-3.4.1.jar.bak</span></span><br></pre></td></tr></table></figure></li><li><p>æŠŠ/opt/atlassian-extras-2.4.jarä¸‹è½½åˆ°æœ¬åœ°,åœ¨æœ¬åœ°å¯åŠ¨Confluenceç ´è§£å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ java -jar confluence_keygen.jar</span><br></pre></td></tr></table></figure><ul><li>ç‚¹å‡».patch! é€‰æ‹©ä¸‹è½½åˆ°æœ¬åœ°çš„atlassian-extras-2.4.jaråŒ…ï¼Œæ–‡ä»¶ç±»å‹ä¸å˜ï¼Œç‚¹å‡»æ‰“å¼€ï¼Œè‡ªåŠ¨ç”Ÿäº§ä¸€ä¸ªæ–°çš„atlassian-extras-2.4.jaråŒ…</li></ul><p><img src="https://img.xxlaila.cn/FA8682F205BB1655E20AAD392DF13417.jpg" alt="img"></p><ul><li>æŠŠæœåŠ¡å™¨idè¾“å…¥åˆ°server idï¼Œnameé¡¹éšä¾¿è¾“å…¥ï¼Œåç§°ä¸è¦è¿‡çŸ­ï¼Œåº—å®¶.gen!ç”Ÿæˆæˆæƒå—ï¼Œç„¶åæŠŠæˆæƒå¤åˆ¶åˆ°confluenceæ¡†é‡Œé¢</li></ul><p><img src="https://img.xxlaila.cn/CB99372F30342EBABC1125510FBC50B9.jpg" alt="img"></p><ul><li>æŠŠæ–°ç”Ÿæˆçš„åŒ…ä¸Šä¼ åˆ°/opt/atlassian/confluence/confluence/WEB-INF/lib/ç›®å½•ä¸‹é¢</li></ul><h3 id="ä¸‹è½½mysqlé©±åŠ¨"><a href="#ä¸‹è½½mysqlé©±åŠ¨" class="headerlink" title="ä¸‹è½½mysqlé©±åŠ¨"></a>ä¸‹è½½mysqlé©±åŠ¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.47.zip</span></span><br></pre></td></tr></table></figure><ul><li><p>å®Œæˆåè¿›è¡Œè§£å‹ï¼Œå¹¶æŠŠmysql-connector-java-5.1.47-bin.jar å¤åˆ¶åˆ°libç›®å½•ä¸‹é¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp mysql-connector-java-5.1.47-bin.jar /opt/atlassian/confluence/confluence/WEB-INF/lib</span></span><br><span class="line"><span class="comment"># /etc/init.d/confluence start</span></span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®æ•°æ®åº“</p></li></ul><p><img src="https://img.xxlaila.cn/EFF70DEA9DFBCA88E24BE83BEE9DFFC8.jpg" alt="img"><br><img src="https://img.xxlaila.cn/BF70624FCFA9E5ECFD4E121E02D08FD3.jpg" alt="img"></p><blockquote><p>è¿™æ˜¯å®Œæˆä»¥åè¿›è¡Œæµ‹è¯•ï¼Œæ˜¯å¦è”é€šï¼Œåœ¨ä¸‹ä¸€æ­¥ï¼ˆéœ€è¦è¿›è¡Œç­‰å¾…ï¼Œåå°åœ¨ç”Ÿæˆæ•°æ®åº“ï¼‰,ç”Ÿæˆå®Œæˆåï¼Œç³»ç»Ÿä¼šè·³è½¬åˆ°å¦å¤–ä¸€ä¸ªé¡µé¢ï¼Œè¿™é‡Œå¿˜è®°æˆªå›¾,æ˜¯è¿›è¡Œæ•°æ®å¯¼å…¥ã€ç«™ç‚¹æ¢å¤ç­‰</p></blockquote><ul><li><p>é‡æ–°æ‰“å¼€ç½‘å€è¿æ¥<br><img src="https://img.xxlaila.cn/BEE317A48B4CEE0407638F47CDBDF31F.jpg" alt="img"></p></li><li><p>ç”±äºè¿™é‡Œæ²¡æœ‰ladpå’Œjira,æ‰€ä»¥é€‰æ‹©åœ¨confluenceä¸­ç®¡ç†ç”¨æˆ·å’Œç»„</p></li><li><p>è®¾ç½®ç³»ç»Ÿç®¡ç†è´¦æˆ·</p></li></ul><p><img src="https://img.xxlaila.cn/93FDD95874C661340531C27CC77298FD.jpg" alt="img"><br><img src="https://img.xxlaila.cn/6B1F3A2EBF1B3DAF1A962317AA59DC15.jpg" alt="img"></p><blockquote><p>è¿™é‡Œè·³è¿‡ä¸ªäººå¤´åƒè®¾å®š,å¤´åƒè®¾å®šå®Œæˆåä¼šæç¤ºä½ æ–°å»ºä¸€ä¸ªç©ºé—´</p></blockquote><p><img src="https://img.xxlaila.cn/FCE130BD8B121A290010FEA2C2342898.jpg" alt="img"></p><ul><li>æŸ¥çœ‹æˆæƒæœŸé™</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è®¾ç½®â€”â€”&gt;ä¸€èˆ¬è®¾ç½®â€”â€”&gt;ç®¡ç†â€”â€”&gt;æˆæƒç»†èŠ‚</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/EEB25C9704F4C76C30E1DF32A2E1EDE0.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>confluence</category>
      </categories>
      <tags>
        <tag>confluence</tag>
      </tags>
  </entry>
  <entry>
    <title>nexus3æ­å»ºnpmç§æœ</title>
    <url>/2019/08/23/nexus3%E6%90%AD%E5%BB%BAnpm%E7%A7%81%E6%9C%8D/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸å‰ç«¯å…¨æ˜¯nodejsçš„ï¼Œnodejsåœ¨installçš„æ—¶å€™å¾€å¾€æ˜¯è¿æ¥å¤–ç½‘ï¼Œæˆ–è€…æ˜¯è®¾ç½®taobaoæºï¼Œå³ä½¿æ˜¯è®¾ç½®äº†taobaoæºï¼Œä½†æ˜¯è¿˜æ˜¯è§£å†³ä¸äº†æ…¢çš„é—®é¢˜ï¼Œä¸ºæ­¤æ­å»ºäº†ä¸€ä¸ªå†…éƒ¨çš„npmç§æœï¼Œè¿™é‡Œç”¨googleä¸€ä¸‹æœ‰å¾ˆå¤šéƒ½å¯ä»¥æ¥è¿›è¡Œæ­å»ºnpmç§æœï¼Œç„¶åä¹Ÿçœ‹åˆ°äº†nexusä¹Ÿå¯ä»¥æ¥åšï¼Œæ­£å¥½mavenç§æœä¹Ÿæ˜¯ç”¨çš„è¿™ä¸ªï¼Œéƒ½æ˜¯3ç‰ˆæœ¬ï¼Œä¸ºæ­¤é€‰æ‹©äº†nexusæ¥åšnpmçš„ç§æœï¼Œå’Œmavenä¸€å¥—ä¾¿äºç»´æŠ¤ã€‚</p><h3 id="nexuså®‰è£…"><a href="#nexuså®‰è£…" class="headerlink" title="nexuså®‰è£…"></a>nexuså®‰è£…</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸ä»‹ç»ï¼Œå®‰è£…å®Œæˆnexusåï¼Œåœ¨æµè§ˆå™¨æ‰“å¼€å¹¶è¿›è¡Œç™»å½•ï¼Œç¬¬ä¸€æ¬¡å®‰è£…ç™»å½•nexusçš„é»˜è®¤ç”¨æˆ·<code>admin</code>,é»˜è®¤å¯†ç æ˜¯<code>admin123</code></p><a id="more"></a><h3 id="1ã€åˆ›å»ºrepository"><a href="#1ã€åˆ›å»ºrepository" class="headerlink" title="1ã€åˆ›å»ºrepository"></a>1ã€åˆ›å»ºrepository</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Nexus Repository Manager 3 å¯ä»¥ç”¨äºå¤šç§ç±»å‹çš„åŒ…ç®¡ç†ã€‚æ­¤å¤„æˆ‘ä»¬è¦æ­å»ºçš„æ˜¯npmåŒ…ç®¡ç†ç§æœã€‚ç™»å½•åœ¨ç•Œé¢ç‚¹å‡»ä¸‹å›¾æ‰€ç¤ºæŒ‰é’®ã€‚<br><img src="https://img.xxlaila.cn/1566524933898.jpg" alt="img"></p><ul><li>è¿›å…¥è®¾ç½®ç•Œé¢<br><img src="https://img.xxlaila.cn/1566525058628.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šå›¾ä¸­å·¦é¢èœå•æœ‰å¾ˆå¤šåŠŸèƒ½ã€‚å¯ä»¥åœ¨ Security ä¸‹çš„ Users å¯ä»¥åˆ›å»ºç”¨æˆ·å¹¶è®¾ç½®ç”¨æˆ·æƒé™ï¼Œä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ã€‚Logging ä¸‹çš„ Log Viewer å¯ä»¥æŸ¥çœ‹è¿è¡Œæ—¥å¿—ã€‚è€Œæœ¬æ¬¡é…ç½®ä¸»è¦ç”¨åˆ°äº† Repository -&gt; Repositories å’Œ Security -&gt; Realms ä¸¤é¡¹</p><ul><li>é¦–å…ˆåœ¨ Repositories åˆ›å»ºä»“åº“</li></ul><p><img src="https://img.xxlaila.cn/1566526054409.jpg" alt="img"></p><ul><li><p>æ¥ä¸‹æ¥ä¼šè¿›å…¥åˆ° Repositorty çš„é€‰æ‹©ï¼šï¼ˆnpm æœ‰ä¸‰ç§ï¼‰<br><img src="https://img.xxlaila.cn/1566526144738.jpg" alt="img"></p></li><li><p>ç¬¬ä¸€ç§ï¼šä»£ç† npm ä»“åº“</p></li></ul><p><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Proxying npm Registries</a>å¯äº§çœ‹å®˜æ–¹æ–‡æ¡£</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å°†å…¬å…± npm æœåŠ¡å™¨çš„èµ„æºä»£ç†ç¼“å­˜ï¼Œå‡å°‘é‡å¤ä¸‹è½½ï¼ŒåŠ å¿«å¼€å‘äººå‘˜å’ŒCIæœåŠ¡å™¨çš„ä¸‹è½½é€Ÿåº¦ã€‚åˆ›å»ºæ—¶é€‰æ‹© npm(proxy) ï¼Œåªéœ€å¡«å†™ Name å’Œ Remote storage ï¼ˆå…¬æœ‰åº“åŸŸåï¼‰å³å¯ã€‚<br><img src="https://img.xxlaila.cn/1566526375641.jpg" alt="img"></p><ul><li>ç¬¬äºŒç§ï¼šç§æœ‰ npm ä»“åº“<br><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Private npm Registries</a>å®˜æ–¹æ–‡æ¡£</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äº ä¸Šä¼ è‡ªå·±çš„npmåŒ… ä»¥åŠç¬¬ä¸‰æ–¹npmåŒ…ã€‚åŒæ ·çš„åˆ›å»ºæ­¥éª¤ï¼Œåªä¸è¿‡é€‰æ‹©çš„ ä»“åº“ç±»å‹ä¸º npm(hosted)ã€‚ åªå¡«å†™ Name å³å¯</p><p><img src="https://img.xxlaila.cn/1566526835511.jpg" alt="img"></p><ul><li>ç¬¬ä¸‰ç§ï¼šnpm ä»“åº“ç»„<br><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Grouping npm Registries</a>å®˜æ–¹æ–‡æ¡£</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºå°†å¤šä¸ªå†…éƒ¨æˆ–å¤–éƒ¨ npm ä»“åº“ç»Ÿä¸€ä¸ºä¸€ä¸ª npmä»“åº“ã€‚è¢«æ·»åŠ åˆ° npmä»“åº“ç»„ ä¸­çš„ å…¶ä»–ä»“åº“å†…çš„åŒ…éƒ½èƒ½å¤Ÿé€šè¿‡è¯¥ npmä»“åº“ç»„ è®¿é—®åˆ°ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¾‹å¦‚ï¼šå¯ä»¥æ–°å»ºä¸€ä¸ªnpmä»“åº“ç»„å°† ä¸Šé¢ä¸¤ä¸ªåˆšåˆšåˆ›å»ºçš„ npm ä»“åº“éƒ½æ·»åŠ è¿›å»ã€‚è¿™æ ·å¯ä»¥é€šè¿‡è¿™ä¸ª npmä»“åº“ç»„ï¼Œæ—¢å¯ä»¥è®¿é—® å…¬æœ‰npmä»“åº“ åˆå¯ä»¥è®¿é—®è‡ªå·±çš„ ç§æœ‰npmä»“åº“ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»“åº“ç±»å‹ä¸º npm(group)ï¼Œèµ·ä¸€ä¸ªåå­— Nameï¼Œç„¶åé€‰æ‹©éœ€è¦æ·»åŠ åˆ°ç»„é‡Œçš„ å…¶ä»– npm ä»“åº“ã€‚æ­¤å¤„æˆ‘é€‰æ‹©çš„æ˜¯ npm-kxl-external å’Œ npm-kxl-internal</p><p><img src="https://img.xxlaila.cn/1566527053731.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»“åº“éƒ½åˆ›å»ºå®Œæ¯•äº†ã€‚æ¥ä¸‹æ¥éœ€è¦éªŒè¯ä¸€ä¸‹æ˜¯å¦å¯ç”¨,åœ¨ Repositories ä¸­ç‚¹å‡»åˆ›å»ºçš„ ä»“åº“ã€‚å¯ä»¥æŸ¥çœ‹è¯¥ä»“åº“çš„ URLã€‚<br>åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º .npmrc æ–‡ä»¶ã€‚æ–‡ä»¶å†…å®¹ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">registry=http://172.21.16.90:8081/repository/npm-kxl-all/</span><br></pre></td></tr></table></figure><p>ç„¶åéšä¾¿å®‰è£…ä¸€ä¸ª åŒ… è¯•è¯•ï¼ˆæ—¥å¿—çº§åˆ«è®¾ç½®ä¸º infoï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm --loglevel info install react</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1566528241640.jpg" alt="img"></p><p>å¦‚å›¾ã€‚ç¡®å®æ˜¯ä»è®¾ç½®çš„ npm ç§æœä¸‹è½½çš„reactã€‚æˆåŠŸ</p><h3 id="å‘å¸ƒåˆ°-npm-ç§æœ"><a href="#å‘å¸ƒåˆ°-npm-ç§æœ" class="headerlink" title="å‘å¸ƒåˆ° npm ç§æœ"></a>å‘å¸ƒåˆ° npm ç§æœ</h3><p>é™¤äº†ä» npm ä»“åº“å®‰è£…ä¾èµ–ã€‚æˆ‘ä»¬è¿˜éœ€è¦å°†å…¬å¸å†…éƒ¨çš„ ä»£ç æ‰“åŒ… å‘å¸ƒåˆ° npm çš„ç§æœã€‚è¿™é‡Œæ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå°±æ˜¯éœ€è¦è®¾ç½®ä¸€ä¸‹ Nexus Repository Manager çš„æƒé™ã€‚è¿™æ ·æ‰èƒ½ä½¿ç”¨ npm login è®¤è¯ç™»å½•åˆ°æˆ‘ä»¬çš„ç§æœã€‚</p><p><img src="https://img.xxlaila.cn/1566528346695.jpg" alt="img"></p><p>æ­¤å¤„åœ¨ Realms ä¸‹ã€‚å°† npm Bearer Token Realm æ·»åŠ åˆ° Active åˆ—è¡¨å†…ä¿å­˜å³å¯ã€‚<br>ç„¶åå¯ä»¥æ‰§è¡Œï¼ˆç™»å½• ç§æœ‰npmä»“åº“ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm login --registry=http://172.21.16.90:8081/repository/npm-kxl-internal/</span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Email: (this IS public) 1@qq.com</span><br><span class="line">Logged <span class="keyword">in</span> as admin on http://172.21.16.90:8081/repository/npm-kxl-internal/.</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤ï¼Œæç¤ºå¡«å†™è´¦å·å¯†ç å’Œé‚®ç®±ï¼ŒéªŒè¯é€šè¿‡åå°†ä¼šåœ¨ ç”¨æˆ·ä¸»ç›®å½•ä¸‹çš„ .npmrc æ–‡ä»¶ä¸­æ’å…¥ä¸€æ¡ æ­¤ä»“åº“ url å’Œå¯¹åº”çš„ tokenã€‚</p><p><img src="https://img.xxlaila.cn/1566528452423.jpg" alt="img"></p><p>åœ¨ç¡®ä¿é¡¹ç›®æœ‰ package.json å‰æä¸‹ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm publish --registry=http://172.21.16.90:8081/repository/npm-kxl-internal/</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œä½¿ç”¨ Nexus Repository Manager 3 æ­å»º npm ç§æœç»“æŸã€‚æ•´ä½“æµç¨‹å¹¶ä¸å¤æ‚ï¼Œæ–‡æ¡£å¾ˆè¯¦å°½,ç›´æ¥è¯»æ–‡æ¡£å¯èƒ½ä¼šé—æ¼ä¸€äº›ä¸œè¥¿ã€‚å¯ä»¥å‚è€ƒ<a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://xxlaila.github.io/2019/10/15/nexusé…ç½®ldap/" target="_blank" rel="noopener">nexus ldapé…ç½®</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nexus</category>
      </categories>
      <tags>
        <tag>npm</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx URL æ–œæ é—®é¢˜</title>
    <url>/2019/08/22/nginx-URL-%E6%96%9C%E6%9D%A0%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä»Šå¤©å…¬å¸æ–°ä¸Šçš„ä¸€ä¸ªå‰ç«¯åº”ç”¨é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯åœ¨å¾®ä¿¡ç™»å½•ç•Œé¢æ‰«ç ç™»å½•ä¹‹åï¼Œå¾®ä¿¡å›è°ƒç»™æˆ‘ä»¬çš„åœ°å€å¤šåŠ äº†ä¸€ä¸ªæ–œæ ;</p><blockquote><p>é”™è¯¯çš„åœ°å€:<a href="http://a.xxlaila.com/wx.html/?code=011amZet0h1IUf19Fvht0jg4ft0amZeN" target="_blank" rel="noopener">http://a.xxlaila.com/wx.html/?code=011amZet0h1IUf19Fvht0jg4ft0amZeN</a><br>æ­£ç¡®çš„åœ°å€:<a href="http://a.xxlaila.com/wx.html?code=011amZet0h1IUf19Fvht0jg4ft0amZeN" target="_blank" rel="noopener">http://a.xxlaila.com/wx.html?code=011amZet0h1IUf19Fvht0jg4ft0amZeN</a></p></blockquote><p>åœ¨nginxä¸Šé…ç½®éœ€è¦å§è¿™ä¸ªæ–œæ åˆ é™¤æ‰ã€‚ç”¨æˆ·æ‰èƒ½æ­£å¸¸çš„è®¿é—®ï¼›</p><h3 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><p>åœ¨é…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®é¡¹</p><a id="more"></a><ul><li>åˆ é™¤URLç»“å°¾çš„æ–œæ </li></ul><p><em>rewrite ^/(.</em>)/$ /$1 permanent;*</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  a.xxlaila.com;</span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)/$</span> /<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">  <span class="attribute">index</span> index.html index.htm index.jsp index.php;</span><br><span class="line">  <span class="attribute">root</span> /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> <span class="regexp">~* /</span> &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span>   /var/log/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨URLç»“å°¾æ·»åŠ æ–œæ <br>åœ¨é…ç½®æ–‡ä»¶å¢åŠ å¦‚ä¸‹é…ç½®é¡¹ç›®</li></ul><p><em>rewrite ^(.</em>[^/])$ $1/ permanent;*</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  a.xxlaila.com;</span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^(.*[^/])$</span> <span class="variable">$1</span>/ <span class="literal">permanent</span>;</span><br><span class="line">  <span class="attribute">index</span> index.html index.htm index.jsp index.php;</span><br><span class="line">  <span class="attribute">root</span> /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> <span class="regexp">~* /</span> &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span>   /var/log/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h2><p>åœ¨æµè§ˆå™¨è®¿é—®æŸä¸€ä¸ªurl/é¡µé¢çš„æ—¶å€™ï¼Œé€šå¸¸æœ‰æ—¶å€™å¸¦æœ‰.htmlçš„ä¸€ä¸ªæ‰©å±•åï¼Œç°éœ€æ±‚æ˜¯å¸¦<code>.html</code>å’Œä¸å¸¦<code>.html</code>éƒ½å¯ä»¥è®¿é—®</p><h3 id="ä¾‹"><a href="#ä¾‹" class="headerlink" title="ä¾‹"></a>ä¾‹</h3><p>å¢åŠ å¦‚ä¸‹é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;    </span><br><span class="line">       rewrite ^(.*)$ /<span class="variable">$1</span>.html last;</span><br><span class="line">       <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  charset utf-8;</span><br><span class="line">  server_name  a.xxlaila.com;</span><br><span class="line">  rewrite ^/(.*)/$ /<span class="variable">$1</span> permanent;</span><br><span class="line">  index index.html index.htm index.jsp index.php;</span><br><span class="line">  root /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  location ~* / &#123;</span><br><span class="line">    <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">       rewrite ^(.*)$ /<span class="variable">$1</span>.html last;</span><br><span class="line">       <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  access_log   /var/<span class="built_in">log</span>/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(å››)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E5%9B%9B/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h2 id="1ã€Blue-Ocean"><a href="#1ã€Blue-Ocean" class="headerlink" title="1ã€Blue Ocean"></a>1ã€Blue Ocean</h2><p>å®‰è£…Blue Oceanæ’ä»¶</p><h3 id="1-1ã€åˆ›å»ºpipeline"><a href="#1-1ã€åˆ›å»ºpipeline" class="headerlink" title="1.1ã€åˆ›å»ºpipeline"></a>1.1ã€åˆ›å»ºpipeline</h3><p><img src="https://img.xxlaila.cn/348knfnsdlds.png" alt="img"></p><ul><li>é…ç½®ä»£ç åº“çš„åœ°å€</li><li>ç„¶åé…ç½®æˆæƒè´¦æˆ·</li></ul><p><img src="https://img.xxlaila.cn/9857jksdhfjkhdsfds.png" alt="img"></p><p>åœ¨è¿™å„¿ä¹‹å‰gitåº“é‡Œé¢å¿…é¡»å­˜åœ¨äºjenkinsfileæ–‡ä»¶ï¼Œpipelineä¼šè‡ªåŠ¨å»æ‰«æä»£ç åº“é‡Œé¢çš„åˆ†æ”¯ï¼Œç„¶åæ ¹æ®æ¯ä¸€ä¸ªåˆ†æ”¯å»ºç«‹ä¸€ä¸ªç±»ä¼¼äºjobçš„å½¢å¼ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æ ¹æ®æ¯ä¸€ä¸ªåˆ†æ”¯è¿›è¡Œéƒ¨ç½²ï¼Œå¯ä»¥æ‰§è¡Œå®šæ—¶è§¦å‘ï¼Œéƒ¨ç½²</p><p><img src="https://img.xxlaila.cn/382dklfjdskjfs.png" alt="img"></p><p>è¿™å„¿ï¼Œåªæœ‰ä¸€ä¸ªåˆ†æ”¯å­˜åœ¨äºjenkinsfileï¼Œæ‰€ä»¥åªæ˜¾ç¤ºä¸€ä¸ªåˆ†æ”¯ï¼Œå¦‚ä¸‹å›¾ï¼š</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>jenkins, ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(ä¸‰)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E4%B8%89/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;jenkins é…ç½®å®Œæˆåï¼Œæœ€ç»ˆå®ç°çš„æ˜¯ci/cdï¼Œåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°åç«¯javaçš„ï¼Œå‰ç«¯nodejsçš„ï¼Œè¿™é‡Œå°±éœ€è¦è¿›è¡Œä¸€ä¸ªk8såœ¨è°ƒåº¦çš„æ—¶å€™ç”Ÿäº§podæ¥è¿›è¡ŒæŒ‡å®špodè¿›è¡Œç¼–è¯‘</p><h3 id="1ã€åˆ¶ä½œå®¹å™¨"><a href="#1ã€åˆ¶ä½œå®¹å™¨" class="headerlink" title="1ã€åˆ¶ä½œå®¹å™¨"></a>1ã€åˆ¶ä½œå®¹å™¨</h3><p>è‡ªå®šä¹‰ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢åŒ…å«äº† javaï¼Œnodejsçš„æ‰€éœ€è¦çš„ç¯å¢ƒï¼ŒåŒæ—¶éœ€è¦åŒæ­¥å®¹å™¨çš„æ—¶é—´ï¼ŒåŒ…å«æ¥jenkinsçš„node</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat Dockerfile</span></span><br><span class="line"><span class="attr">FROM</span> <span class="string">docker.io/centos:latest</span></span><br><span class="line"><span class="attr">MAINTAINER</span> <span class="string">xxlaila "cq_xxlaila@163.com"</span></span><br><span class="line"><span class="comment"># Install dependent plugin</span></span><br><span class="line"><span class="attr">ENV</span> <span class="string">VERSION v10.15.1</span></span><br><span class="line"><span class="attr">RUN</span> <span class="string">yum install -y wget \</span></span><br><span class="line">    <span class="attr">git</span> <span class="string">\</span></span><br><span class="line">    <span class="meta">java-1.8.0-openjdk.x86_64</span> <span class="string">\</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">curl -sL https://rpm.nodesource.com/setup_11.x | bash - \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum install -y gcc gcc-c++ make \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum install -y nodejs \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum clean all</span></span><br><span class="line"><span class="comment"># System variable setting</span></span><br><span class="line"><span class="attr">RUN</span> <span class="string">echo "LANG=zh_CN.UTF-8" &gt;&gt; /etc/locale.conf \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">source /etc/locale.conf \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">echo "Asia/shanghai" &gt;&gt; /etc/timezone \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">groupadd -g 10000 jenkins \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">useradd -g jenkins -u 10000 jenkins</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">EXPOSE</span> <span class="string">50000</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li><p>æ‰§è¡Œå®¹å™¨æ‰“åŒ…</p><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="attr"># docker build -t centos7</span><span class="number">.6</span>/<span class="symbol">node11</span>:latest .\</span><br></pre></td></tr></table></figure></li><li><p>æ¨é€å®¹å™¨åˆ°ç§æœ‰é•œåƒä»“åº“</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># docker tag centos7<span class="number">.6</span>/node11:latest docker.io/xxlaila/centos<span class="number">-7</span>-jdk1<span class="number">.8</span>-nodejs11<span class="number">.10</span>-jenkins:latest</span><br><span class="line"># docker push docker.io/xxlaila/centos<span class="number">-7</span>-jdk1<span class="number">.8</span>-nodejs11<span class="number">.10</span>-jenkins:latest</span><br></pre></td></tr></table></figure></li></ul><h3 id="2ã€jenkinsçš„é…ç½®"><a href="#2ã€jenkinsçš„é…ç½®" class="headerlink" title="2ã€jenkinsçš„é…ç½®"></a>2ã€jenkinsçš„é…ç½®</h3><h4 id="2-1ã€ç³»ç»Ÿé…ç½®"><a href="#2-1ã€ç³»ç»Ÿé…ç½®" class="headerlink" title="2.1ã€ç³»ç»Ÿé…ç½®"></a>2.1ã€ç³»ç»Ÿé…ç½®</h4><p>jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;ç³»ç»Ÿè®¾ç½®<br><strong>åç§°</strong>ï¼škubernetes<br><strong>åœ°å€</strong>ï¼š<a href="https://kubernetes.default.svc.cluster.local" target="_blank" rel="noopener">https://kubernetes.default.svc.cluster.local</a><br><strong>jenkinsåœ°å€</strong>ï¼š<a href="http://jenkins2.kube-ops.svc.cluster.local:8080" target="_blank" rel="noopener">http://jenkins2.kube-ops.svc.cluster.local:8080</a><br><img src="https://img.xxlaila.cn/489kdngkdhfkodsmf.png" alt="img"></p><h4 id="2-2ã€å¢åŠ ä¸€ä¸ªkubenetes-pod-templates"><a href="#2-2ã€å¢åŠ ä¸€ä¸ªkubenetes-pod-templates" class="headerlink" title="2.2ã€å¢åŠ ä¸€ä¸ªkubenetes pod templates"></a>2.2ã€å¢åŠ ä¸€ä¸ªkubenetes pod templates</h4><p><img src="https://img.xxlaila.cn/83jknfkdslfds.png" alt="img"></p><h4 id="2-3ã€é…ç½®å®¹å™¨ç¯å¢ƒ"><a href="#2-3ã€é…ç½®å®¹å™¨ç¯å¢ƒ" class="headerlink" title="2.3ã€é…ç½®å®¹å™¨ç¯å¢ƒ"></a>2.3ã€é…ç½®å®¹å™¨ç¯å¢ƒ</h4><p><img src="https://img.xxlaila.cn/42clkdsjfkldsfs.png" alt="img"></p><h4 id="2-4ã€é…ç½®æƒé™"><a href="#2-4ã€é…ç½®æƒé™" class="headerlink" title="2.4ã€é…ç½®æƒé™"></a>2.4ã€é…ç½®æƒé™</h4><p><img src="https://img.xxlaila.cn/3486238kmxnfksd.png" alt="img"></p><h3 id="3ã€æµ‹è¯•job"><a href="#3ã€æµ‹è¯•job" class="headerlink" title="3ã€æµ‹è¯•job"></a>3ã€æµ‹è¯•job</h3><p>å»ºç«‹ä¸€ä¸ªtest job çš„pipelineæ¥è¿›è¡Œå®¹å™¨æ˜¯å¦æ­£å¸¸</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node (<span class="string">'agent-node'</span>)&#123;</span><br><span class="line">    container(<span class="string">'nodejs'</span>) &#123;</span><br><span class="line">        sh <span class="string">'whoami'</span></span><br><span class="line">        sh <span class="string">'hostname'</span></span><br><span class="line">        sh <span class="string">'echo $PATH'</span></span><br><span class="line">        sh <span class="string">'npm version'</span></span><br><span class="line">        sh <span class="string">'node -v'</span></span><br><span class="line">        sh <span class="string">'npx -v'</span></span><br><span class="line">        sh <span class="string">'java -version'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1ã€å»ºç«‹pipeline"><a href="#3-1ã€å»ºç«‹pipeline" class="headerlink" title="3.1ã€å»ºç«‹pipeline"></a>3.1ã€å»ºç«‹pipeline</h4><h5 id="3-1-1ã€å»ºç«‹ä¸€ä¸ªåç«¯"><a href="#3-1-1ã€å»ºç«‹ä¸€ä¸ªåç«¯" class="headerlink" title="3.1.1ã€å»ºç«‹ä¸€ä¸ªåç«¯"></a>3.1.1ã€å»ºç«‹ä¸€ä¸ªåç«¯</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'agent-build'</span>) &#123;</span><br><span class="line">   stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git credentialsId:<span class="string">'gitlabUser'</span>, url: <span class="string">'http://gitlab.xxlaila.com/plat/middleware/kxl-eureka.git'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'build'</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2. Start build <span class="variable">$&#123;JOB_NAME&#125;</span>"</span></span><br><span class="line">        sh <span class="string">'/opt/bin/mvn clean package'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'show package'</span>) &#123;</span><br><span class="line">        sh <span class="string">'pwd'</span></span><br><span class="line">        sh <span class="string">'ls -ltrh target/'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1-2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯"><a href="#3-1-2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯" class="headerlink" title="3.1.2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯"></a>3.1.2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯</h4><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'agent-build'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git credentialsId:<span class="string">'gitlabUser'</span>, ur<span class="variable">l:</span> <span class="string">'http://gitlab.xxlaila.com/front-end/portal/kts-platform.git'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'install'</span>) &#123;</span><br><span class="line">        container(<span class="string">'nodejs'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"2. Start install $&#123;JOB_NAME&#125;"</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'node -v'</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'npm install'</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'npm run build production'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'show package'</span>) &#123;</span><br><span class="line">        <span class="keyword">sh</span> <span class="string">'pwd'</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">'ls -ltrh'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(äºŒ)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E4%BA%8C/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><h1 id="åŸºäºjenkins-pipelineè¿›è¡Œéƒ¨ç½²"><a href="#åŸºäºjenkins-pipelineè¿›è¡Œéƒ¨ç½²" class="headerlink" title="åŸºäºjenkins  pipelineè¿›è¡Œéƒ¨ç½²"></a>åŸºäºjenkins pipelineè¿›è¡Œéƒ¨ç½²</h1><h2 id="1ã€jenkins-pipelineä»‹ç»"><a href="#1ã€jenkins-pipelineä»‹ç»" class="headerlink" title="1ã€jenkins pipelineä»‹ç»"></a>1ã€jenkins pipelineä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;è¦å®ç°åœ¨ Jenkins ä¸­çš„æ„å»ºå·¥ä½œï¼Œå¯ä»¥æœ‰å¤šç§æ–¹å¼ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨æ¯”è¾ƒå¸¸ç”¨çš„ Pipeline è¿™ç§æ–¹å¼ã€‚Pipelineï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸€å¥—è¿è¡Œåœ¨ Jenkins ä¸Šçš„å·¥ä½œæµæ¡†æ¶ï¼Œå°†åŸæ¥ç‹¬ç«‹è¿è¡Œäºå•ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ç‚¹çš„ä»»åŠ¡è¿æ¥èµ·æ¥ï¼Œå®ç°å•ä¸ªä»»åŠ¡éš¾ä»¥å®Œæˆçš„å¤æ‚æµç¨‹ç¼–æ’å’Œå¯è§†åŒ–çš„å·¥ä½œã€‚</p><p>Jenkins Pipeline æœ‰å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µ:</p><ul><li>Nodeï¼šèŠ‚ç‚¹ï¼Œä¸€ä¸ª Node å°±æ˜¯ä¸€ä¸ª Jenkins èŠ‚ç‚¹ï¼ŒMaster æˆ–è€… Agentï¼Œæ˜¯æ‰§è¡Œ Step çš„å…·ä½“è¿è¡Œç¯å¢ƒï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹‹å‰åŠ¨æ€è¿è¡Œçš„ Jenkins Slave å°±æ˜¯ä¸€ä¸ª Node èŠ‚ç‚¹</li><li>Stageï¼šé˜¶æ®µï¼Œä¸€ä¸ª Pipeline å¯ä»¥åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ª Stageï¼Œæ¯ä¸ª Stage ä»£è¡¨ä¸€ç»„æ“ä½œï¼Œæ¯”å¦‚ï¼šBuildã€Testã€Deployï¼ŒStage æ˜¯ä¸€ä¸ªé€»è¾‘åˆ†ç»„çš„æ¦‚å¿µï¼Œå¯ä»¥è·¨å¤šä¸ª Node</li><li>Stepï¼šæ­¥éª¤ï¼ŒStep æ˜¯æœ€åŸºæœ¬çš„æ“ä½œå•å…ƒï¼Œå¯ä»¥æ˜¯æ‰“å°ä¸€å¥è¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æ„å»ºä¸€ä¸ª Docker é•œåƒï¼Œç”±å„ç±» Jenkins æ’ä»¶æä¾›ï¼Œæ¯”å¦‚å‘½ä»¤ï¼šsh â€˜makeâ€™ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å¹³æ—¶ shell ç»ˆç«¯ä¸­æ‰§è¡Œ make å‘½ä»¤ä¸€æ ·ã€‚</li></ul><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åˆ›å»º Jenkins Pipline å‘¢ï¼Ÿ</p><ul><li>Pipeline è„šæœ¬æ˜¯ç”± Groovy è¯­è¨€å®ç°çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡å¿…è¦å•ç‹¬å»å­¦ä¹  Groovyï¼Œå½“ç„¶ä½ ä¼šçš„è¯æœ€å¥½</li><li>Pipeline æ”¯æŒä¸¤ç§è¯­æ³•ï¼šDeclarative(å£°æ˜å¼)å’Œ Scripted Pipeline(è„šæœ¬å¼)è¯­æ³•</li><li>Pipeline ä¹Ÿæœ‰ä¸¤ç§åˆ›å»ºæ–¹æ³•ï¼šå¯ä»¥ç›´æ¥åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­è¾“å…¥è„šæœ¬ï¼›ä¹Ÿå¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª Jenkinsfile è„šæœ¬æ–‡ä»¶æ”¾å…¥é¡¹ç›®æºç åº“ä¸­</li><li>ä¸€èˆ¬æˆ‘ä»¬éƒ½æ¨èåœ¨ Jenkins ä¸­ç›´æ¥ä»æºä»£ç æ§åˆ¶(SCMD)ä¸­ç›´æ¥è½½å…¥ Jenkinsfile Pipeline è¿™ç§æ–¹æ³•åˆ›å»ºä¸€ä¸ªç®€å•çš„ Pipeline<blockquote><p>æˆ‘ä»¬è¿™é‡Œæ¥ç»™å¤§å®¶å¿«é€Ÿåˆ›å»ºä¸€ä¸ªç®€å•çš„ Pipelineï¼Œç›´æ¥åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­è¾“å…¥è„šæœ¬è¿è¡Œã€‚</p></blockquote></li><li>æ–°å»º Jobï¼šåœ¨ Web UI ä¸­ç‚¹å‡» New Item -&gt; è¾“å…¥åç§°ï¼špipeline-demo -&gt; é€‰æ‹©ä¸‹é¢çš„ Pipeline -&gt; ç‚¹å‡» OK</li><li>é…ç½®ï¼šåœ¨æœ€ä¸‹æ–¹çš„ Pipeline åŒºåŸŸè¾“å…¥å¦‚ä¸‹ Script è„šæœ¬ï¼Œç„¶åç‚¹å‡»ä¿å­˜ã€‚</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell node &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span> </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span> </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"3.Build Stage"</span> </span><br><span class="line">        </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"4. Deploy Stage"</span> </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ„å»ºï¼šç‚¹å‡»å·¦ä¾§åŒºåŸŸçš„ Build Nowï¼Œå¯ä»¥çœ‹åˆ° Job å¼€å§‹æ„å»ºäº†<blockquote><p>éš”ä¸€ä¼šå„¿ï¼Œæ„å»ºå®Œæˆï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¾§åŒºåŸŸçš„ Console Outputï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºä¿¡æ¯ï¼š</p></blockquote></li></ul><p><img src="https://img.xxlaila.cn/sdsdsjid23874823ehsj.png" alt="img"></p><ul><li>åœ¨ Slave ä¸­æ„å»ºä»»åŠ¡<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ Pipeline ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªä»»åŠ¡å¹¶æ²¡æœ‰åœ¨ Jenkins çš„ Slave ä¸­è¿è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•è®©æˆ‘ä»¬çš„ä»»åŠ¡è·‘åœ¨ Slave ä¸­å‘¢ï¼Ÿè¿˜è®°å¾—ä¸ŠèŠ‚è¯¾æˆ‘ä»¬åœ¨æ·»åŠ  Slave Pod çš„æ—¶å€™ï¼Œä¸€å®šè¦è®°ä½æ·»åŠ çš„ label å—ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°è¿™ä¸ª labelï¼Œæˆ‘ä»¬é‡æ–°ç¼–è¾‘ä¸Šé¢åˆ›å»ºçš„ Pipeline è„šæœ¬ï¼Œç»™ node æ·»åŠ ä¸€ä¸ª label å±æ€§ï¼Œå¦‚ä¸‹:</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'jnlp-agent'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4. Deploy Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯ç»™ node æ·»åŠ äº†ä¸€ä¸ªjnlp-agentè¿™æ ·çš„ä¸€ä¸ªlabelï¼Œç„¶åæˆ‘ä»¬ä¿å­˜ï¼Œæ„å»ºä¹‹å‰æŸ¥çœ‹ä¸‹ kubernetes é›†ç¾¤ä¸­çš„ Podï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[<span class="built_in">test</span>] [root@k8s-zxc-test-3 ~]<span class="comment"># kubectl get pods -n kube-ops</span></span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">jenkins2-696b8fbdbb-q24nm   1/1     Running             0          45h</span><br><span class="line">jnlp-agent-342fv            0/1     ContainerCreating   0          0s</span><br><span class="line">[<span class="built_in">test</span>] [root@k8s-zxc-test-3 ~]<span class="comment"># kubectl get pods -n kube-ops</span></span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">jenkins2-696b8fbdbb-q24nm   1/1     Running             0          45h</span><br><span class="line">jnlp-agent-342fv            0/1     ContainerCreating   0          1s</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/dhf482390dsfjkdsg.png" alt="img"></p><ul><li><p>kubernetes ç•Œé¢æ˜¾ç¤º<br><img src="https://img.xxlaila.cn/9374hkdhskfjsdd.png" alt="img"></p></li><li><p>jenkinsæ‰§è¡Œç»“æœæ˜¾ç¤º<br><img src="https://img.xxlaila.cn/23cvkndiuyriens.png" alt="img"></p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp; è¯æ˜æˆ‘ä»¬å½“å‰çš„ä»»åŠ¡åœ¨è·‘åœ¨ä¸Šé¢åŠ¨æ€ç”Ÿæˆçš„è¿™ä¸ª Pod ä¸­ï¼Œä¹Ÿç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚æˆ‘ä»¬å›åˆ° Job çš„ä¸»ç•Œé¢ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°å¤§å®¶å¯èƒ½æ¯”è¾ƒç†Ÿæ‚‰çš„ Stage View ç•Œé¢ï¼š<br><img src="https://img.xxlaila.cn/45ksfh9whnkxa.png" alt="img"></p><h5 id="éƒ¨ç½²-Kubernetes-åº”ç”¨"><a href="#éƒ¨ç½²-Kubernetes-åº”ç”¨" class="headerlink" title="éƒ¨ç½² Kubernetes åº”ç”¨"></a>éƒ¨ç½² Kubernetes åº”ç”¨</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å·²ç»çŸ¥é“äº†å¦‚ä½•åœ¨ Jenkins Slave ä¸­æ„å»ºä»»åŠ¡äº†ï¼Œé‚£ä¹ˆå¦‚ä½•æ¥éƒ¨ç½²ä¸€ä¸ªåŸç”Ÿçš„ Kubernetes åº”ç”¨å‘¢ï¼Ÿ è¦éƒ¨ç½² Kubernetes åº”ç”¨ï¼Œæˆ‘ä»¬å°±å¾—å¯¹æˆ‘ä»¬ä¹‹å‰éƒ¨ç½²åº”ç”¨çš„æµç¨‹è¦éå¸¸ç†Ÿæ‚‰æ‰è¡Œï¼Œæˆ‘ä»¬ä¹‹å‰çš„æµç¨‹æ˜¯æ€æ ·çš„ï¼š</p><ul><li>1ã€ç¼–å†™ä»£ç </li><li>2ã€æµ‹è¯•</li><li>3ã€ç¼–å†™ Dockerfile</li><li>4ã€æ„å»ºæ‰“åŒ… Docker é•œåƒ</li><li>5ã€æ¨é€ Docker é•œåƒåˆ°ä»“åº“</li><li>6ã€ç¼–å†™ Kubernetes YAML æ–‡ä»¶</li><li>7ã€æ›´æ”¹ YAML æ–‡ä»¶ä¸­ Docker é•œåƒ TAG</li><li>8ã€åˆ©ç”¨ kubectl å·¥å…·éƒ¨ç½²åº”ç”¨</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬ä¹‹å‰åœ¨ Kubernetes ç¯å¢ƒä¸­éƒ¨ç½²ä¸€ä¸ªåŸç”Ÿåº”ç”¨çš„æµç¨‹åº”è¯¥åŸºæœ¬ä¸Šæ˜¯ä¸Šé¢è¿™äº›æµç¨‹å§ï¼Ÿç°åœ¨æˆ‘ä»¬å°±éœ€è¦æŠŠä¸Šé¢è¿™äº›æµç¨‹æ”¾å…¥ Jenkins ä¸­æ¥è‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆ(å½“ç„¶ç¼–ç é™¤å¤–)ï¼Œä»æµ‹è¯•åˆ°æ›´æ–° YAML æ–‡ä»¶å±äº CI æµç¨‹ï¼Œåé¢éƒ¨ç½²å±äº CD çš„æµç¨‹ã€‚å¦‚æœæŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬ç°åœ¨è¦æ¥ç¼–å†™ä¸€ä¸ª Pipeline çš„è„šæœ¬ã€‚</p><ul><li><p>ä¿®æ”¹test-spring-social-wechat-sample pipelineè„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'jnlp-agent'</span>) &#123;</span><br><span class="line">   stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'YAML'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"6. Deploy Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>1ï¼‰ã€å¢åŠ gitåœ°å€ï¼Œè¿›è¡Œä»£ç çš„clone</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Clone'</span>)</span></span> &#123;</span><br><span class="line">   echo <span class="string">"1.Clone Stage"</span></span><br><span class="line">   git url: <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>2ï¼‰ã€è¿›è¡Œæµ‹è¯•</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Test'</span>)</span></span> &#123;</span><br><span class="line">  echo <span class="string">"2.Test Stage"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>3ï¼‰ã€æ„å»ºä¸€ä¸ªdockeré•œåƒ</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Build'</span>)</span></span> &#123;</span><br><span class="line">  echo <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">  sh <span class="string">"docker build -t xxlaila/jenkins-demo:$&#123;build_tag&#125; ."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;å¹³æ—¶æ„å»ºçš„æ—¶å€™æ˜¯ä¸æ˜¯éƒ½æ˜¯ç›´æ¥ä½¿ç”¨docker buildå‘½ä»¤è¿›è¡Œæ„å»ºå°±è¡Œäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹å‘¢ï¼Ÿæˆ‘ä»¬ä¸ŠèŠ‚è¯¾ç»™å¤§å®¶æä¾›çš„ Slave Pod çš„é•œåƒé‡Œé¢æ˜¯ä¸æ˜¯é‡‡ç”¨çš„ Docker In Docker çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ Slave ä¸­ä½¿ç”¨ docker build å‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç›´æ¥ä½¿ç”¨ sh ç›´æ¥æ‰§è¡Œ docker build å‘½ä»¤å³å¯ï¼Œä½†æ˜¯é•œåƒçš„ tag å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬ä½¿ç”¨é•œåƒ tagï¼Œåˆ™æ¯æ¬¡éƒ½æ˜¯ latest çš„ tagï¼Œè¿™å¯¹äºä»¥åçš„æ’æŸ¥æˆ–è€…å›æ»šä¹‹ç±»çš„å·¥ä½œä¼šå¸¦æ¥å¾ˆå¤§éº»çƒ¦ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨å’Œgit commitçš„è®°å½•ä¸ºé•œåƒçš„ tagï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯é•œåƒçš„ tag å¯ä»¥å’Œ git æäº¤è®°å½•å¯¹åº”èµ·æ¥ï¼Œä¹Ÿæ–¹ä¾¿æ—¥åå¯¹åº”æŸ¥çœ‹ã€‚ä½†æ˜¯ç”±äºè¿™ä¸ª tag ä¸åªæ˜¯æˆ‘ä»¬è¿™ä¸€ä¸ª stage éœ€è¦ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªæ¨é€é•œåƒæ˜¯ä¸æ˜¯ä¹Ÿéœ€è¦ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æŠŠè¿™ä¸ª tag ç¼–å†™æˆä¸€ä¸ªå…¬å…±çš„å‚æ•°ï¼ŒæŠŠå®ƒæ”¾åœ¨ Clone è¿™ä¸ª stage ä¸­ï¼Œä¿®æ”¹å‰é¢ä¸¤ä¸ª stage:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git url: <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line">      script &#123;</span><br><span class="line">        build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">      sh <span class="string">"docker build -t xxlaila/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span> ."</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>4ï¼‰ã€æ¨é€é•œåƒ<br>&nbsp;&nbsp;&nbsp;&nbsp;é•œåƒæ„å»ºå®Œæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬å°±éœ€è¦å°†æ­¤å¤„æ„å»ºçš„é•œåƒæ¨é€åˆ°é•œåƒä»“åº“ä¸­å»ï¼Œå½“ç„¶å¦‚æœä½ æœ‰ç§æœ‰é•œåƒä»“åº“ä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰è‡ªå·±æ­å»ºç§æœ‰çš„ä»“åº“ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ docker hub å³å¯ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬çŸ¥é“ docker hub æ˜¯å…¬å…±çš„é•œåƒä»“åº“ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å–ä¸Šé¢çš„é•œåƒï¼Œä½†æ˜¯è¦å¾€ä¸Šæ¨é€é•œåƒæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°ä¸€ä¸ªå¸å·äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æå‰æ³¨å†Œä¸€ä¸ª docker hub çš„å¸å·ï¼Œè®°ä½ç”¨æˆ·åå’Œå¯†ç ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦ä½¿ç”¨ã€‚æ­£å¸¸æ¥è¯´æˆ‘ä»¬åœ¨æœ¬åœ°æ¨é€ docker é•œåƒçš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯éœ€è¦ä½¿ç”¨docker loginå‘½ä»¤ï¼Œç„¶åè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œè®¤è¯é€šè¿‡åï¼Œå°±å¯ä»¥ä½¿ç”¨docker pushå‘½ä»¤æ¥æ¨é€æœ¬åœ°çš„é•œåƒåˆ° docker hub ä¸Šé¢å»äº†ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬è¿™é‡Œçš„ Pipeline æ˜¯ä¸æ˜¯å°±è¯¥è¿™æ ·å†™äº†ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">      sh <span class="string">"docker login -u cq_xxlaila@163.com -p 111111"</span></span><br><span class="line">      sh <span class="string">"docker push xxlaila/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span>"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœåªæ˜¯åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡çš„è¯ï¼Œæˆ‘ä»¬è¿™é‡Œçš„ Pipeline æ˜¯å¯ä»¥è¿™æ ·å†™çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯ä¸æ˜¯æ¨èä½¿ç”¨ Jenkinsfile çš„å½¢å¼æ”¾å…¥æºç ä¸­è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬ç›´æ¥æŠŠ docker ä»“åº“çš„ç”¨æˆ·åå’Œå¯†ç æš´éœ²ç»™åˆ«äººè¿™æ ·å¾ˆæ˜¾ç„¶æ˜¯éå¸¸éå¸¸ä¸å®‰å…¨çš„ï¼Œæ›´ä½•å†µæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ github çš„å…¬å…±ä»£ç ä»“åº“ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥ç›´æ¥çœ‹åˆ°æˆ‘ä»¬çš„æºç ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ç”¨ä¸€ç§æ–¹å¼æ¥éšè—ç”¨æˆ·åå’Œå¯†ç è¿™ç§ç§å¯†ä¿¡æ¯ï¼Œå¹¸è¿çš„æ˜¯ Jenkins ä¸ºæˆ‘ä»¬æä¾›äº†è§£å†³æ–¹æ³•ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨é¦–é¡µç‚¹å‡» Credentials -&gt; Stores scoped to Jenkins ä¸‹é¢çš„ Jenkins -&gt; Global credentials (å‡­æ®) -&gt;system(ç³»ç»Ÿ)-&gt;å…¨å±€å‡­æ® (unrestricted)-&gt; å·¦ä¾§çš„ Add Credentials( æ·»åŠ å‡­æ®)ï¼šæ·»åŠ ä¸€ä¸ª Username with password ç±»å‹çš„è®¤è¯ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š<br><img src="https://img.xxlaila.cn/374kdjfkskfdsd.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;Add Credentials è¾“å…¥ docker hub çš„ç”¨æˆ·åå’Œå¯†ç ï¼ŒID éƒ¨åˆ†æˆ‘ä»¬è¾“å…¥dockerHubï¼Œæ³¨æ„ï¼Œè¿™ä¸ªå€¼éå¸¸é‡è¦ï¼Œåœ¨åé¢ Pipeline çš„è„šæœ¬ä¸­æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ª ID å€¼ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†ä¸Šé¢çš„ docker hub çš„ç”¨æˆ·åå’Œå¯†ç çš„è®¤è¯ä¿¡æ¯ï¼Œç°åœ¨ä¿®æ”¹ Pipeline ä¸­çš„ç¬¬å››éƒ¨ï¼Œä½¿ç”¨è¿™é‡Œçš„ç”¨æˆ·åå’Œå¯†ç ï¼š</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">stage('Push') &#123;</span><br><span class="line">     echo <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">     <span class="keyword">with</span><span class="constructor">Credentials([<span class="params">usernamePassword</span>(<span class="params">credentialsId</span>: '<span class="params">dockerHub</span>', <span class="params">passwordVariable</span>: '<span class="params">dockerHubPassword</span>', <span class="params">usernameVariable</span>: '<span class="params">dockerHubUser</span>')</span>]) &#123;</span><br><span class="line">         sh <span class="string">"docker login -u $&#123;dockerHubUser&#125; -p $&#123;dockerHubPassword&#125;"</span></span><br><span class="line">         sh <span class="string">"docker push xxlaila/jenkins-demo:$&#123;build_tag&#125;"</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><blockquote><p><em>æ³¨æ„</em>:<br>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è¿™é‡Œåœ¨ stage ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæ–°çš„å‡½æ•°withCredentialsï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªcredentialsIdå€¼å°±æ˜¯æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ ID å€¼ï¼Œç„¶åå°±å¯ä»¥åœ¨è„šæœ¬ä¸­ç›´æ¥ä½¿ç”¨è¿™é‡Œä¸¤ä¸ªå˜é‡å€¼æ¥ç›´æ¥æ›¿æ¢æ‰ä¹‹å‰çš„ç™»å½• docker hub çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿™æ ·æ“ä½œå°±ç›¸å¯¹æ¥è¯´å°±å¾ˆå®‰å…¨äº†ï¼Œåªæ˜¯ä¼ é€’è¿›å»äº†ä¸¤ä¸ªå˜é‡è€Œå·²ï¼Œåˆ«äººå¹¶ä¸çŸ¥é“çœŸæ­£ç”¨æˆ·åå’Œå¯†ç ï¼Œåªæœ‰æˆ‘ä»¬è‡ªå·±çš„ Jenkins å¹³å°ä¸Šæ·»åŠ çš„æ‰çŸ¥é“ã€‚<br><em>æµ‹è¯•ç»“æœ</em>:</p></blockquote><p><img src="https://img.xxlaila.cn/4ykjdbfjdshfkojdsl.png" alt="img"></p><ul><li>5ï¼‰ã€æ›´æ”¹ YAML<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢å·²ç»å®Œæˆäº†é•œåƒçš„æ‰“åŒ…ã€æ¨é€çš„å·¥ä½œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥æ›´æ–° Kubernetes ç³»ç»Ÿä¸­åº”ç”¨çš„é•œåƒç‰ˆæœ¬äº†ï¼Œå½“ç„¶ä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç”¨ YAML æ–‡ä»¶çš„å½¢å¼æ¥ç¼–å†™åº”ç”¨éƒ¨ç½²è§„åˆ™ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„ YAML æ–‡ä»¶ï¼š(k8s.yaml)<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cat k8s.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins-demo</span><br><span class="line"><span class="symbol">  namespace:</span> default</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      labels:</span></span><br><span class="line"><span class="symbol">        app:</span> jenkins-demo</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">      - image: xxlaila/jenkins-demo:<span class="params">&lt;BUILD_TAG&gt;</span></span><br><span class="line"><span class="symbol">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="symbol">        name:</span> jenkins-demo</span><br><span class="line"><span class="symbol">        env:</span></span><br><span class="line">        - name: branch</span><br><span class="line"><span class="symbol">          value:</span> <span class="params">&lt;BRANCH_NAME&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨ä¸€ä¸ª Deployment èµ„æºå¯¹è±¡æ¥ç®¡ç† Podï¼Œè¯¥ Pod ä½¿ç”¨çš„å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ¨é€çš„é•œåƒï¼Œå”¯ä¸€ä¸åŒçš„åœ°æ–¹æ˜¯ Docker é•œåƒçš„ tag ä¸æ˜¯æˆ‘ä»¬å¹³å¸¸è§çš„å…·ä½“çš„ tagï¼Œè€Œæ˜¯ä¸€ä¸ª çš„æ ‡è¯†ï¼Œå®é™…ä¸Šå¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªæ ‡è¯†æ›¿æ¢æˆä¸Šé¢çš„ Docker é•œåƒçš„ tagï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯æœ€ç»ˆæˆ‘ä»¬æœ¬æ¬¡æ„å»ºéœ€è¦ä½¿ç”¨åˆ°çš„é•œåƒï¼Ÿæ€ä¹ˆæ›¿æ¢å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªsedå‘½ä»¤å°±å¯ä»¥å®ç°äº†ï¼š</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'YAML'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">      sh <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>sed å‘½ä»¤å°±æ˜¯å°† k8s.yaml æ–‡ä»¶ä¸­çš„ æ ‡è¯†ç»™æ›¿æ¢æˆå˜é‡ build_tag çš„å€¼ã€‚</p></blockquote><ul><li>6ï¼‰ã€éƒ¨ç½²<br>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes åº”ç”¨çš„ YAML æ–‡ä»¶å·²ç»æ›´æ”¹å®Œæˆäº†ï¼Œä¹‹å‰æˆ‘ä»¬æ‰‹åŠ¨çš„ç¯å¢ƒä¸‹ï¼Œæ˜¯ä¸æ˜¯ç›´æ¥ä½¿ç”¨ kubectl apply å‘½ä»¤å°±å¯ä»¥ç›´æ¥æ›´æ–°åº”ç”¨ã€‚å½“ç„¶è¿™é‡Œåªæ˜¯å†™å…¥åˆ°äº† Pipeline é‡Œé¢ï¼Œæ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ï¼š</li></ul><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Deploy'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"6. Deploy Stage"</span></span><br><span class="line">      sh <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>ç‚¹å‡»jenkinsè¿›è¡Œæ„å»º<br><img src="https://img.xxlaila.cn/56hjkshdfdksnfkldsj.png" alt="img"></li></ul><blockquote><p>å½“ç„¶ï¼Œè¿™é‡Œéƒ¨ç½²å¤±è´¥ï¼Œå…ˆåˆ«ç®¡ï¼Œè¯æ˜æµç¨‹æ˜¯å¯¹çš„ï¼Œå¯ä»¥è¿™ä¹ˆèµ°</p></blockquote><p><img src="https://img.xxlaila.cn/3947dnfdsflskfjdsf.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»¥ä¸Šçš„é…ç½®åŸºæœ¬å·²ç»å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬çš„å®é™…é¡¹ç›®å®è·µè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€äº›äººå·¥å¹²é¢„çš„æ­¥éª¤ï¼Œæ¯”å¦‚æˆ‘ä»¬æäº¤äº†ä¸€æ¬¡ä»£ç ï¼Œæµ‹è¯•ä¹Ÿé€šè¿‡äº†ï¼Œé•œåƒä¹Ÿæ‰“åŒ…ä¸Šä¼ äº†ï¼Œä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬å¹¶ä¸ä¸€å®šå°±æ˜¯è¦ç«‹åˆ»ä¸Šçº¿åˆ°ç”Ÿäº§ç¯å¢ƒçš„ã€‚æˆ‘ä»¬å¯èƒ½éœ€è¦å°†è¯¥ç‰ˆæœ¬å…ˆå‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒã€QA ç¯å¢ƒã€æˆ–è€…é¢„è§ˆç¯å¢ƒä¹‹ç±»çš„ï¼Œæ€»ä¹‹ç›´æ¥å°±å‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒå»è¿˜æ˜¯æŒºå°‘è§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¢åŠ äººå·¥ç¡®è®¤çš„ç¯èŠ‚ï¼Œä¸€èˆ¬éƒ½æ˜¯åœ¨ CD çš„ç¯èŠ‚æ‰éœ€è¦äººå·¥å¹²é¢„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„æœ€åä¸¤æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å‰é¢åŠ ä¸Šç¡®è®¤ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'YAML'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">      def userInput = <span class="built_in">input</span>(</span><br><span class="line">          id: <span class="string">'userInput'</span>,</span><br><span class="line">          message: <span class="string">'Choose a deploy environment'</span>,</span><br><span class="line">          parameter<span class="variable">s:</span> [</span><br><span class="line">              [</span><br><span class="line">                  #clas<span class="variable">s:</span> <span class="string">'ChoiceParameterDefinition'</span>,</span><br><span class="line">                  choice<span class="variable">s:</span> <span class="string">"Dev\nTest\nUat\nDemo\nPord"</span>,</span><br><span class="line">                  name: <span class="string">'Env'</span></span><br><span class="line">                  ]</span><br><span class="line">              ]</span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"This is a deploy step to $&#123;userInput.Env&#125;"</span></span><br><span class="line">          <span class="keyword">sh</span> <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä½¿ç”¨äº† input å…³é”®å­—ï¼Œé‡Œé¢ä½¿ç”¨ä¸€ä¸ª Choice çš„åˆ—è¡¨æ¥è®©ç”¨æˆ·è¿›è¡Œé€‰æ‹©ï¼Œç„¶ååœ¨æˆ‘ä»¬é€‰æ‹©äº†éƒ¨ç½²ç¯å¢ƒåï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿå¯ä»¥é’ˆå¯¹ä¸åŒçš„ç¯å¢ƒå†åšä¸€äº›æ“ä½œï¼Œæ¯”å¦‚å¯ä»¥ç»™ä¸åŒç¯å¢ƒçš„ YAML æ–‡ä»¶éƒ¨ç½²åˆ°ä¸åŒçš„ namespace ä¸‹é¢å»ï¼Œå¢åŠ ä¸åŒçš„æ ‡ç­¾ç­‰ç­‰æ“ä½œï¼š</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Deploy'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"6. Deploy Stage"</span></span><br><span class="line">      <span class="keyword">if</span> (userInput<span class="selector-class">.Env</span> == <span class="string">"Dev"</span>)&#123;</span><br><span class="line">          <span class="comment">// deploy dev stuff</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userInput<span class="selector-class">.Env</span> == <span class="string">"Test"</span>)&#123;</span><br><span class="line">          <span class="comment">// deploy test stuff</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// deploy prod stuff</span></span><br><span class="line">      &#125;</span><br><span class="line">      sh <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸€æ­¥ä¹Ÿå±äºéƒ¨ç½²çš„èŒƒç•´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æœ€åä¸¤æ­¥éƒ½åˆå¹¶æˆä¸€æ­¥ï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ Pipeline è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'node-jnlp'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">        git ur<span class="variable">l:</span> <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line">        script &#123;</span><br><span class="line">            build_tag = <span class="keyword">sh</span>(returnStdou<span class="variable">t:</span> true, <span class="keyword">scrip</span><span class="variable">t:</span> <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"docker build -t xxlaila/jenkins-demo:$&#123;build_tag&#125; ."</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">        withCredentials([usernamePassword(credentialsId: <span class="string">'dockerHub'</span>, passwordVariable: <span class="string">'dockerHubPassword'</span>, usernameVariable: <span class="string">'dockerHubUser'</span>)]) &#123;</span><br><span class="line">            <span class="keyword">sh</span> <span class="string">"docker login -u $&#123;dockerHubUser&#125; -p $&#123;dockerHubPassword&#125;"</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">"docker push cnych/jenkins-demo:$&#123;build_tag&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"5. Deploy Stage"</span></span><br><span class="line">        def userInput = <span class="built_in">input</span>(</span><br><span class="line">            id: <span class="string">'userInput'</span>,</span><br><span class="line">            message: <span class="string">'Choose a deploy environment'</span>,</span><br><span class="line">            parameter<span class="variable">s:</span> [</span><br><span class="line">                [</span><br><span class="line">                    $clas<span class="variable">s:</span> <span class="string">'ChoiceParameterDefinition'</span>,</span><br><span class="line">                    choice<span class="variable">s:</span> <span class="string">"Dev\nQA\nProd"</span>,</span><br><span class="line">                    name: <span class="string">'Env'</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"This is a deploy step to $&#123;userInput&#125;"</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">"Dev"</span>) &#123;</span><br><span class="line">            // deploy dev stuff</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userInput == <span class="string">"QA"</span>)&#123;</span><br><span class="line">            // deploy <span class="keyword">qa</span> stuff</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            // deploy prod stuff</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>é”™è¯¯</em>: åœ¨jenkinsæ‰§è¡Œæ„å»ºçš„æ—¶å€™æç¤º:</p><p><img src="https://img.xxlaila.cn/2846djkfhklsdjdklsd.png" alt="img"></p><blockquote><p>æ²¡æœ‰æƒé™è¿›è¡Œéƒ¨ç½²ï¼Œä¸‹é¢è¿›è¡Œæƒé™çš„åˆ†é…ã€‚</p></blockquote><ul><li><p>æŸ¥çœ‹kube-ops ä¸‹é¢çš„è§’è‰²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role -n kube-ops</span></span><br><span class="line">NAME       AGE</span><br><span class="line">jenkins2   2d6h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹roleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role jenkins2 -n kube-ops -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2019-01-14T03:07:25Z"</span></span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  resourceVersion: <span class="string">"2389179"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/kube-ops/roles/jenkins2</span><br><span class="line">  uid: 84762132-17a9-11e9-8991-fa163e14c5bd</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">exec</span></span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">log</span></span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºjenkins2çš„æƒé™</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">[<span class="symbol">root@</span>k8s-zxc-test<span class="number">-3</span> ~]# kubectl -n kube-system create sa jenkins2</span><br><span class="line">serviceaccount/jenkins2 created</span><br></pre></td></tr></table></figure></li><li><p>æˆæƒè®¿é—®</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test<span class="number">-3</span> ~]# kubectl <span class="built_in">create</span> clusterrolebinding jenkins2 <span class="comment">--clusterrole cluster-admin --serviceaccount=kube-ops:jenkins2</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/jenkins2 created</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>zabbixä¼ä¸šå¾®ä¿¡å‘Šè­¦</title>
    <url>/2019/08/20/zabbix%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Zabbixå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼æŠŠå‘Šè­¦ä¿¡æ¯å‘é€åˆ°æŒ‡å®šäººï¼Œå¸¸ç”¨çš„æœ‰é‚®ä»¶ï¼ŒçŸ­ä¿¡æŠ¥è­¦æ–¹å¼ï¼Œä½†æ˜¯è¶Šæ¥è¶Šå¤šçš„ä¼ä¸šå¼€å§‹ä½¿ç”¨zabbixç»“åˆå¾®ä¿¡ä½œä¸ºä¸»è¦çš„å‘Šè­¦æ–¹å¼ï¼Œè¿™æ ·å¯ä»¥åŠæ—¶æœ‰æ•ˆçš„æŠŠå‘Šè­¦ä¿¡æ¯æ¨é€åˆ°æ¥æ”¶äººï¼Œæ–¹ä¾¿å‘Šè­¦çš„åŠæ—¶å¤„ç†ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;å¾®ä¿¡ä¼ä¸šå·éœ€è¦å…ˆåœ¨ä¼ä¸šé€šä¿¡å½•æ–°å»ºè¯¥å‘˜å·¥ï¼Œè¯¥å‘˜å·¥æ‰èƒ½å…³æ³¨è¯¥ä¼ä¸šå·ï¼Œè¿™æ ·å°±èƒ½å®ç°å‘Šè­¦ä¿¡æ¯çš„ç§å¯†æ€§ã€‚å¦‚æœä½¿ç”¨å…¬ä¼—å·ï¼Œåˆ™åªè¦æ‰€æœ‰å…³æ³¨äº†è¯¥å…¬ä¼—å·çš„äººéƒ½èƒ½æ”¶åˆ°å‘Šè­¦æ¶ˆæ¯ï¼Œå®¹æ˜“é€ æˆä¿¡æ¯æ³„éœ²ã€‚è€Œä¸”å‘˜å·¥æ•°å°‘äº200äººçš„ä¼ä¸šå·æ˜¯ä¸ç”¨é’±çš„ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ç”³è¯·é™åˆ¶.</p><h3 id="1ã€è„šæœ¬å­˜æ”¾ç›®å½•"><a href="#1ã€è„šæœ¬å­˜æ”¾ç›®å½•" class="headerlink" title="1ã€è„šæœ¬å­˜æ”¾ç›®å½•"></a>1ã€è„šæœ¬å­˜æ”¾ç›®å½•</h3><p>/usr/lib/zabbix/alertscriptsï¼Œè„šæœ¬çš„æƒé™æ˜¯zabbix è´¦æˆ·ï¼Œå…·æœ‰å¯æ‰§è¡Œæƒé™</p><a id="more"></a><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat wechat.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/python2.7</span></span><br><span class="line"><span class="comment">#_*_coding:utf-8 _*_</span></span><br><span class="line"><span class="built_in">import</span> requests,sys,json</span><br><span class="line"><span class="built_in">import</span> urllib3</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding('utf-<span class="number">8</span>')</span><br><span class="line">def GetToken(Corpid,Secret):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/gettoken"</span></span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"corpid"</span>:Corpid,</span><br><span class="line">        <span class="string">"corpsecret"</span>:Secret</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.get(<span class="attr">url=Url,params=Data,verify=False)</span></span><br><span class="line">    <span class="attr">Token</span> = r.json()['access_token']</span><br><span class="line">    return Token</span><br><span class="line">def SendMessage(Token,User,Agentid,Subject,Content):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s"</span> % Token</span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"touser"</span>: User,                                 <span class="comment"># ä¼ä¸šå·ä¸­çš„ç”¨æˆ·å¸å·ï¼Œåœ¨zabbixç”¨æˆ·Mediaä¸­é…ç½®ï¼Œå¦‚æœé…ç½®ä¸æ­£å¸¸ï¼Œå°†æŒ‰éƒ¨é—¨å‘é€ã€‚</span></span><br><span class="line">        <span class="comment">#"totag": Tagid,                                # ä¼ä¸šå·ä¸­çš„æ ‡ç­¾idï¼Œç¾¤å‘ä½¿ç”¨ï¼ˆæ¨èï¼‰</span></span><br><span class="line">        <span class="string">"toparty"</span>: <span class="string">"2"</span>,                            <span class="comment"># ä¼ä¸šå·ä¸­çš„éƒ¨é—¨idï¼Œç¾¤å‘æ—¶ä½¿ç”¨ã€‚</span></span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,                              <span class="comment"># æ¶ˆæ¯ç±»å‹ã€‚</span></span><br><span class="line">        <span class="string">"agentid"</span>: Agentid,                             <span class="comment"># ä¼ä¸šå·ä¸­çš„åº”ç”¨idã€‚</span></span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: Subject + '\n' + Content</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"safe"</span>: <span class="string">"0"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.post(<span class="attr">url=Url,data=json.dumps(Data),verify=False)</span></span><br><span class="line">    return r.text</span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == '__main__':</span><br><span class="line">    <span class="attr">User</span> = sys.argv[<span class="number">1</span>]                                                              <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Subject</span> = sys.argv[<span class="number">2</span>]                                                           <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Content</span> = sys.argv[<span class="number">3</span>]                                                           <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Corpid</span> = <span class="string">"wwa9c9999"</span>                                                   <span class="comment"># CorpIDæ˜¯ä¼ä¸šå·çš„æ ‡è¯†</span></span><br><span class="line">    <span class="attr">Secret</span> = <span class="string">"VGbZvXJ5RiLskdksh2dkhaskdu92uihsjdhjksadh"</span>     <span class="comment"># Secretæ˜¯ç®¡ç†ç»„å‡­è¯å¯†é’¥</span></span><br><span class="line">    <span class="comment">#Tagid = "1"                                                                     # é€šè®¯å½•æ ‡ç­¾ID</span></span><br><span class="line">    <span class="attr">Agentid</span> = <span class="string">"1000001"</span>                                                                   <span class="comment"># åº”ç”¨ID</span></span><br><span class="line">    <span class="comment">#Partyid = "1"                                                                  # éƒ¨é—¨ID</span></span><br><span class="line">    <span class="attr">Token</span> = GetToken(Corpid, Secret)</span><br><span class="line">    <span class="attr">Status</span> = SendMessage(Token,User,Agentid,Subject,Content)</span><br><span class="line">    print Status</span><br></pre></td></tr></table></figure><h3 id="2ã€é‡è¦å‚æ•°ä»‹ç»"><a href="#2ã€é‡è¦å‚æ•°ä»‹ç»" class="headerlink" title="2ã€é‡è¦å‚æ•°ä»‹ç»"></a>2ã€é‡è¦å‚æ•°ä»‹ç»</h3><ul><li>topartyï¼šâ€2â€ è¿™ä¸ªå‚æ•°æ˜¯åœ¨ä¼ä¸šå¾®ä¿¡é‡Œé¢éƒ¨é—¨çš„id</li><li>Corpidï¼šä¼ä¸šçš„CorpIDæ ‡ç¤º</li><li>Secretï¼šç®¡ç†ç»„çš„å¯†é’¥å‡­è¯</li><li>Agentidï¼šæ–°å»ºåº”ç”¨çš„id</li><li>åªéœ€è¦æ±‚ä¿®æ”¹ä»¥ä¸Šå‚æ•°å³å¯</li></ul><p><img src="https://img.xxlaila.cn/image2018-8-23_16-8-30.png" alt="img"></p><ul><li>ä»¥ä¸Šéƒ¨é—¨æ²¡æœ‰æ–°å»ºï¼Œåªæ˜¯åœ¨è¿™ä¸ªåº”ç”¨ä¸­æ–°å¢åŠ äº†å‡ ä¸ªç”¨æˆ·ã€‚æœ€å¥½çš„æ–¹å¼æ˜¯å¢åŠ ä¸€ä¸ªéƒ¨é—¨ç»„ï¼Œç”¨æˆ·æ·»åŠ åˆ°éƒ¨é—¨ç»„é‡Œé¢ï¼Œè¿™ç§æ–¹å¼æœ€ç§‘å­¦</li></ul><h3 id="3ã€ç™»é™†zabbix-è¿›è¡Œé…ç½®"><a href="#3ã€ç™»é™†zabbix-è¿›è¡Œé…ç½®" class="headerlink" title="3ã€ç™»é™†zabbix è¿›è¡Œé…ç½®"></a>3ã€ç™»é™†zabbix è¿›è¡Œé…ç½®</h3><h4 id="3-1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹"><a href="#3-1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹" class="headerlink" title="3.1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹"></a>3.1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-11-59.png" alt="img"></p><h4 id="3-2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«"><a href="#3-2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«" class="headerlink" title="3.2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«"></a>3.2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-12-53.png" alt="img"><br><img src="https://img.xxlaila.cn/image2018-8-23_16-13-9.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME}æ•…éšœ!</p><p>å‘Šè­¦ä¸»æœº:{HOST.NAME}<br>å‘Šè­¦åœ°å€:{HOST.IP}<br>ç›‘æ§é¡¹ç›®:{ITEM.NAME}<br>ç›‘æ§å–å€¼:{ITEM.LASTVALUE}<br>å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY}<br>å½“å‰çŠ¶æ€:{TRIGGER.STATUS}<br>å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME}<br>å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME}<br>äº‹ä»¶ID:{EVENT.ID}</p></blockquote><p><img src="https://img.xxlaila.cn/image2018-8-23_16-13-20.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME}å·²æ¢å¤!</p><p>å‘Šè­¦ä¸»æœº:{HOST.NAME}<br>å‘Šè­¦åœ°å€:{HOST.IP}<br>ç›‘æ§é¡¹ç›®:{ITEM.NAME}<br>ç›‘æ§å–å€¼:{ITEM.LASTVALUE}<br>å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY}<br>å½“å‰çŠ¶æ€:{TRIGGER.STATUS}<br>å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME}<br>å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME}<br>æ¢å¤æ—¶é—´:{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}<br>æŒç»­æ—¶é—´:{EVENT.AGE}<br>äº‹ä»¶ID:{EVENT.ID}</p></blockquote><p><img src="https://img.xxlaila.cn/image2018-8-23_16-13-28.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}: æŠ¥è­¦ç¡®è®¤</p><p>ç¡®è®¤äºº:{USER.FULLNAME}<br>æ—¶é—´:{ACK.DATE} {ACK.TIME}<br>ç¡®è®¤ä¿¡æ¯å¦‚ä¸‹:<br>â€œ{ACK.MESSAGE}â€<br>é—®é¢˜æœåŠ¡å™¨IP:{HOSTNAME1}<br>é—®é¢˜ID:{EVENT.ID}<br>å½“å‰çš„é—®é¢˜æ˜¯: {TRIGGER.NAME}</p></blockquote><h4 id="3-3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹"><a href="#3-3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹" class="headerlink" title="3.3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹"></a>3.3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-21-58.png" alt="img"><br>è¿™é‡Œä¸ºadminç”¨æˆ·æ·»åŠ çš„ å‘Šè­¦æ–¹å¼ã€‚æ³¨æ„ä¸€ä¸‹send to è¿™ä¸ªå‚æ•°ï¼Œè¿™é‡Œä¸€å®šè¦æ˜¯@allã€‚å¦åˆ™ä¸æˆåŠŸ</p><h3 id="4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•"><a href="#4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•" class="headerlink" title="4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•"></a>4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•</h3><p><img src="https://img.xxlaila.cn/image2018-8-23_16-23-14.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
      </tags>
  </entry>
  <entry>
    <title>å¸§ä¸­ç»§é…ç½®</title>
    <url>/2019/08/19/%E5%B8%A7%E4%B8%AD%E7%BB%A7%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="ç‚¹å¯¹ç‚¹é…ç½®"><a href="#ç‚¹å¯¹ç‚¹é…ç½®" class="headerlink" title="ç‚¹å¯¹ç‚¹é…ç½®"></a>ç‚¹å¯¹ç‚¹é…ç½®</h3><p><img src="https://img.xxlaila.cn/1566222269423.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">102</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li></ul><a id="more"></a><ul><li>FRAME-RELAYé…ç½®:<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching                 å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>pvc 201<span class="built_in"> interface </span>s0/0 102    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰"><a href="#ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰" class="headerlink" title="ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰"></a>ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222529208.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">102</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">103</span>                 </span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">103</span>  </span><br><span class="line">[RA-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>     é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCI</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">301</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">301</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching      å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰"><a href="#ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰" class="headerlink" title="ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰"></a>ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222807499.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA]int s0/<span class="number">0.1</span> multipoint</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">102</span>     è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">103</span>                 </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">103</span>  </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">301</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">301</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>    é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                    æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching    å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰"><a href="#ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰" class="headerlink" title="ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰"></a>ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222918549.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span> </span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh               æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RA]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">102</span>        è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·              </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br><span class="line">[RA]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RA-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">103</span>        è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·              </span><br><span class="line">[RA-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">103</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.2</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>    é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RB-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                   æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RB]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RB-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">201</span>     è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·             </span><br><span class="line">[RB-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>     é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RB-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">203</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·             </span><br><span class="line">[RB-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">203</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.3</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RC-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RC]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RC-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">301</span>         è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·                </span><br><span class="line">[RC-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.3</span><span class="number">.1</span> <span class="number">301</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.3</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RC-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">302</span>         è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·                </span><br><span class="line">[RC-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.2</span><span class="number">.1</span> <span class="number">302</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.2</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching                 å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201     é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301     é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay           å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>pvc 203<span class="built_in"> interface </span>s0/0 302    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay           å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>302<span class="built_in"> interface </span>s0/0 203    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>å¸§ä¸­ç»§</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes ci/cd(ä¸€)</title>
    <url>/2019/08/12/kubernetes-ci-cd-%E4%B8%80/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><blockquote><p>åŸºäºjenkinsçš„CI/CDå®‰è£…</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jenkinsä¸€ä¸ªæµè¡Œçš„æŒç»­é›†æˆ/å‘å¸ƒå·¥å…·ï¼Œåœ¨Kubernetesä½¿ç”¨,æŒç»­æ„å»ºä¸å‘å¸ƒæ˜¯æˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ­¥éª¤ï¼Œç›®å‰å¤§å¤šå…¬å¸éƒ½é‡‡ç”¨ Jenkins é›†ç¾¤æ¥æ­å»ºç¬¦åˆéœ€æ±‚çš„ CI/CD æµç¨‹ï¼Œç„¶è€Œä¼ ç»Ÿçš„ Jenkins Slave ä¸€ä¸»å¤šä»æ–¹å¼ä¼šå­˜åœ¨ä¸€äº›ç—›ç‚¹ï¼Œæ¯”å¦‚ï¼šä¸» Master å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ï¼Œæ•´ä¸ªæµç¨‹éƒ½ä¸å¯ç”¨äº†ï¼›æ¯ä¸ª Slave çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²ï¼›èµ„æºåˆ†é…ä¸å‡è¡¡ï¼Œæœ‰çš„ Slave è¦è¿è¡Œçš„ job å‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„ Slave å¤„äºç©ºé—²çŠ¶æ€ï¼›æœ€åèµ„æºæœ‰æµªè´¹ï¼Œæ¯å° Slave å¯èƒ½æ˜¯å®ä½“æœºæˆ–è€… VMï¼Œå½“ Slave å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æºã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æåˆ°åŸºäºKuberneteçš„CI/CDï¼Œå¯ä»¥ä½¿ç”¨çš„å·¥å…·æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚Jenkinsã€Gitlab CIå·²ç»æ–°å…´çš„droneä¹‹ç±»çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä¼šä½¿ç”¨å¤§å®¶æœ€ä¸ºç†Ÿæ‚‰çš„Jeninsæ¥åšCI/CDçš„å·¥å…·ã€‚</p><ul><li>ä¼˜ç‚¹:<ul><li>Jenkins å®‰è£…å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸ç”¨æ€¥ç€å°±å»ä½¿ç”¨ï¼Œæˆ‘ä»¬è¦äº†è§£ä¸‹åœ¨ Kubernetes ç¯å¢ƒä¸‹é¢ä½¿ç”¨ Jenkins æœ‰ä»€ä¹ˆå¥½å¤„ã€‚éƒ½çŸ¥é“æŒç»­æ„å»ºä¸å‘å¸ƒæ˜¯æˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ­¥éª¤ï¼Œç›®å‰å¤§å¤šå…¬å¸éƒ½é‡‡ç”¨ Jenkins é›†ç¾¤æ¥æ­å»ºç¬¦åˆéœ€æ±‚çš„ CI/CD æµç¨‹ï¼Œç„¶è€Œä¼ ç»Ÿçš„ Jenkins Slave ä¸€ä¸»å¤šä»æ–¹å¼ä¼šå­˜åœ¨ä¸€äº›ç—›ç‚¹ï¼Œæ¯”å¦‚:<ul><li>E ä¸» Master å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ï¼Œæ•´ä¸ªæµç¨‹éƒ½ä¸å¯ç”¨äº†ã€‚</li><li>E æ¯ä¸ª Slave çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²ã€‚</li><li>E èµ„æºåˆ†é…ä¸å‡è¡¡ï¼Œæœ‰çš„ Slave è¦è¿è¡Œçš„ job å‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„ Slave å¤„äºç©ºé—²çŠ¶æ€ã€‚</li><li>E èµ„æºæœ‰æµªè´¹ï¼Œæ¯å° Slave å¯èƒ½æ˜¯ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºï¼Œå½“ Slave å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æºã€‚</li></ul></li><li>æ­£å› ä¸ºè¿™äº›ç§ç§ç—›ç‚¹ï¼Œæˆ‘ä»¬æ¸´æœ›ä¸€ç§æ›´é«˜æ•ˆæ›´å¯é çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ª CI/CD æµç¨‹ï¼Œè€Œ Docker è™šæ‹ŸåŒ–å®¹å™¨æŠ€æœ¯èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªç—›ç‚¹ï¼Œåˆç‰¹åˆ«æ˜¯åœ¨ Kubernetes é›†ç¾¤ç¯å¢ƒä¸‹é¢èƒ½å¤Ÿæ›´å¥½æ¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä¸‹å›¾æ˜¯åŸºäº Kubernetes æ­å»º Jenkins é›†ç¾¤çš„ç®€å•ç¤ºæ„å›¾<br><img src="https://img.xxlaila.cn/xjfhs84we.png" alt="img"></li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ° Jenkins Master å’Œ Jenkins Slave ä»¥ Pod å½¢å¼è¿è¡Œåœ¨ Kubernetes é›†ç¾¤çš„ Node ä¸Šï¼ŒMaster è¿è¡Œåœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†å…¶é…ç½®æ•°æ®å­˜å‚¨åˆ°ä¸€ä¸ª Volume ä¸Šå»ï¼ŒSlave è¿è¡Œåœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”å®ƒä¸æ˜¯ä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå®ƒä¼šæŒ‰ç…§éœ€æ±‚åŠ¨æ€çš„åˆ›å»ºå¹¶è‡ªåŠ¨åˆ é™¤ã€‚</p><a id="more"></a><ul><li>è¿™ç§æ–¹å¼çš„å·¥ä½œæµç¨‹å¤§è‡´ä¸º<ul><li>å½“ Jenkins Master æ¥å—åˆ° Build è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®é…ç½®çš„ Label åŠ¨æ€åˆ›å»ºä¸€ä¸ªè¿è¡Œåœ¨ Pod ä¸­çš„ Jenkins Slave å¹¶æ³¨å†Œåˆ° Master ä¸Šï¼Œå½“è¿è¡Œå®Œ Job åï¼Œè¿™ä¸ª Slave ä¼šè¢«æ³¨é”€å¹¶ä¸”è¿™ä¸ª Pod ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤ï¼Œæ¢å¤åˆ°æœ€åˆçŠ¶æ€ã€‚é‚£ä¹ˆä½¿ç”¨è¿™ç§æ–¹å¼å¸¦æ¥äº†å“ªäº›å¥½å¤„å‘¢ï¼Ÿ</li><li>E æœåŠ¡é«˜å¯ç”¨ï¼Œå½“ Jenkins Master å‡ºç°æ•…éšœæ—¶ï¼ŒKubernetes ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Jenkins Master å®¹å™¨ï¼Œå¹¶ä¸”å°† Volume åˆ†é…ç»™æ–°åˆ›å»ºçš„å®¹å™¨ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä»è€Œè¾¾åˆ°é›†ç¾¤æœåŠ¡é«˜å¯ç”¨ã€‚</li><li>E åŠ¨æ€ä¼¸ç¼©ï¼Œåˆç†ä½¿ç”¨èµ„æºï¼Œæ¯æ¬¡è¿è¡Œ Job æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Jenkins Slaveï¼ŒJob å®Œæˆåï¼ŒSlave è‡ªåŠ¨æ³¨é”€å¹¶åˆ é™¤å®¹å™¨ï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸” Kubernetes ä¼šæ ¹æ®æ¯ä¸ªèµ„æºçš„ä½¿ç”¨æƒ…å†µï¼ŒåŠ¨æ€åˆ†é… Slave åˆ°ç©ºé—²çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œé™ä½å‡ºç°å› æŸèŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œè¿˜æ’é˜Ÿç­‰å¾…åœ¨è¯¥èŠ‚ç‚¹çš„æƒ…å†µã€‚</li><li>E æ‰©å±•æ€§å¥½ï¼Œå½“ Kubernetes é›†ç¾¤çš„èµ„æºä¸¥é‡ä¸è¶³è€Œå¯¼è‡´ Job æ’é˜Ÿç­‰å¾…æ—¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„æ·»åŠ ä¸€ä¸ª Kubernetes Node åˆ°é›†ç¾¤ä¸­ï¼Œä»è€Œå®ç°æ‰©å±•ã€‚</li></ul></li></ul><h2 id="1ã€å®‰è£…jenkins"><a href="#1ã€å®‰è£…jenkins" class="headerlink" title="1ã€å®‰è£…jenkins"></a>1ã€å®‰è£…jenkins</h2><h3 id="1-1ã€æ–°å»ºä¸€ä¸ª-Deployment"><a href="#1-1ã€æ–°å»ºä¸€ä¸ª-Deployment" class="headerlink" title="1.1ã€æ–°å»ºä¸€ä¸ª Deployment"></a>1.1ã€æ–°å»ºä¸€ä¸ª Deployment</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#cat  jenkins-deployment.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">jenkins/jenkins:lts</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">512</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">          subPath:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LIMITS_MEMORY</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">limits.memory</span></span><br><span class="line"><span class="attr">              divisor:</span> <span class="number">1</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="bullet">-Xmx$(LIMITS_MEMORY)m</span> <span class="attr">-XshowSettings:vm</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.initialDelay=0</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN=50</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN0=0.85</span> <span class="bullet">-Duser.timezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">        persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">          claimName:</span> <span class="string">opspvc</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30002</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">agent</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å¯¹è±¡èµ„æºéƒ½æ”¾ç½®åœ¨ä¸€ä¸ªåä¸º kube-ops çš„ namespace ä¸‹é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ åˆ›å»ºä¸€ä¸ª namespace,namespace è¯·å‚è€ƒnamspaceç« èŠ‚çš„å…·ä½“ä»‹ç»</p><figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line"># kubectl <span class="keyword">create</span> <span class="keyword">namespace</span> kube-ops</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä½¿ç”¨ä¸€ä¸ªåä¸º jenkins/jenkins:lts çš„å®˜æ–¹é•œåƒï¼Œè¿™æ˜¯ jenkins å®˜æ–¹çš„ Docker é•œåƒï¼Œç„¶åä¹Ÿæœ‰ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å®šåˆ¶ä¸€ä¸ªé•œåƒï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å°†ä¸€äº›æ’ä»¶æ‰“åŒ…åœ¨è‡ªå®šä¹‰çš„é•œåƒå½“ä¸­ï¼Œ<a href="https://github.com/jenkinsci/docker" target="_blank" rel="noopener">å¯ä»¥å‚è€ƒæ–‡æ¡£</a>ã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨é»˜è®¤çš„å®˜æ–¹é•œåƒå°±è¡Œï¼Œå¦å¤–ä¸€ä¸ªè¿˜éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å°†å®¹å™¨çš„ /var/jenkins_home ç›®å½•æŒ‚è½½åˆ°äº†ä¸€ä¸ªåä¸º opspvc çš„ PVC å¯¹è±¡ä¸Šé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ ·è¿˜å¾—æå‰åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ PVC å¯¹è±¡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ä»¬å‰é¢çš„ StorageClass å¯¹è±¡æ¥è‡ªåŠ¨åˆ›å»ºï¼š(jenkins-pvc.yaml)</p><h3 id="1-2-Jenkins-StorageClass-åˆ›å»º"><a href="#1-2-Jenkins-StorageClass-åˆ›å»º" class="headerlink" title="1.2 Jenkins StorageClass åˆ›å»º"></a>1.2 Jenkins StorageClass åˆ›å»º</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">opspv</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">172.21</span><span class="number">.16</span><span class="number">.231</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/jenkins</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">opspvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºpvcå¯¹è±¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-pvc.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–è¿™é‡Œè¿˜éœ€è¦ä½¿ç”¨åˆ°ä¸€ä¸ªæ‹¥æœ‰ç›¸å…³æƒé™çš„ serviceAccountï¼šjenkins2ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ç»™jenkins èµ‹äºˆäº†ä¸€äº›å¿…è¦çš„æƒé™ï¼Œå½“ç„¶å¦‚æœä½ å¯¹ serviceAccount çš„æƒé™ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯ï¼Œæˆ‘ä»¬ç»™è¿™ä¸ª sa ç»‘å®šä¸€ä¸ª cluster-admin çš„é›†ç¾¤è§’è‰²æƒé™ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå½“ç„¶è¿™æ ·å…·æœ‰ä¸€å®šçš„å®‰å…¨é£é™©ï¼šï¼ˆjenkins-rbac.yamlï¼‰</p><h3 id="1-3-Jenkins-serviceAccount"><a href="#1-3-Jenkins-serviceAccount" class="headerlink" title="1.3 Jenkins serviceAccount"></a>1.3 Jenkins serviceAccount</h3><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cat jenkins-rbac.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> ServiceAccount</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line"><span class="symbol">kind:</span> Role</span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"><span class="symbol">rules:</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"create"</span>,<span class="string">"delete"</span>,<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"patch"</span>,<span class="string">"update"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods/exec"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"create"</span>,<span class="string">"delete"</span>,<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"patch"</span>,<span class="string">"update"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods/log"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"secrets"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"get"</span>]</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="symbol">kind:</span> RoleBinding</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"><span class="symbol">roleRef:</span></span><br><span class="line"><span class="symbol">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="symbol">  kind:</span> Role</span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">subjects:</span></span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line"><span class="symbol">    name:</span> jenkins2</span><br><span class="line"><span class="symbol">namespace:</span> kube-ops</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»º rbac ç›¸å…³çš„èµ„æºå¯¹è±¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-rbac.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé€šè¿‡ ingressçš„å½¢å¼æ¥è®¿é—®Jenkins çš„ web æœåŠ¡ï¼ŒJenkins æœåŠ¡ç«¯å£ä¸º8080ï¼Œ50000 ç«¯å£ä¸ºagentï¼Œè¿™ä¸ªç«¯å£ä¸»è¦æ˜¯ç”¨äº Jenkins çš„ master å’Œ slave ä¹‹é—´é€šä¿¡ä½¿ç”¨çš„ã€‚(jenkins-ingress.yaml)</p><h3 id="1-4-Jenkins-å¯¹å¤–æä¾›è®¿é—®"><a href="#1-4-Jenkins-å¯¹å¤–æä¾›è®¿é—®" class="headerlink" title="1.4 Jenkins å¯¹å¤–æä¾›è®¿é—®"></a>1.4 Jenkins å¯¹å¤–æä¾›è®¿é—®</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">ci.xxlaila.cn</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»º Jenkins æœåŠ¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-deployment.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>åˆ›å»ºå®Œæˆådockeå›å»æ‹‰å»é•œåƒï¼Œéœ€è¦ç­‰å¾…ä¸€ä¼šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹jenkinsæ˜¯å¦éƒ¨ç½²æˆåŠŸ</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># kubectl <span class="keyword">get</span> pods -n kube-ops</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">jenkins2<span class="number">-84f</span>476cbb-vz4b2   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d19h</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å®Œæˆä»¥åæˆ‘ä¹ˆå¯ä»¥é€šè¿‡åœ¨jenkins-ingress.yamlé‡Œé¢ç»‘å®šè¿‡çš„åŸŸåè¿›è¡Œè®¿é—®ï¼Œç„¶åè¿›è¡Œå®‰è£…é…ç½®ï¼š<br><img src="https://img.xxlaila.cn/sfdsfdsf38432.png" alt="img"></p><blockquote><p>åˆå§‹åŒ–çš„å¯†ç æˆ‘ä»¬å¯ä»¥åœ¨ jenkins çš„å®¹å™¨çš„æ—¥å¿—ä¸­è¿›è¡ŒæŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ nfs çš„å…±äº«æ•°æ®ç›®å½•ä¸­æŸ¥çœ‹</p><p>$ cat /data/jenkins/jenkins2/secrets/initialAdminPassword</p></blockquote><p>å®Œæˆé…ç½®ï¼Œå°±å¯ä»¥åˆ°jenkinsçš„ç•Œé¢ï¼Œå°±å’Œæˆ‘ä»¬åœ¨vmä¸‹å®‰è£…çš„jenkinsæ²¡æœ‰ä»»ä½•çš„åŒºåˆ«ã€‚<br><img src="https://img.xxlaila.cn/isdy823723894324.png" alt="img"></p><h2 id="2-é…ç½®jenkins"><a href="#2-é…ç½®jenkins" class="headerlink" title="2 é…ç½®jenkins"></a>2 é…ç½®jenkins</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ¥é…ç½® Jenkinsï¼Œè®©ä»–èƒ½å¤ŸåŠ¨æ€çš„ç”Ÿæˆ Slave çš„ Podï¼Œå®‰è£…jenkinsçš„æ’ä»¶æ¸…å•</p><p><code>Kubernetes This plugin integrates Jenkins with Kubernetes</code><br>2.1 Kuberneteså’ŒJenkinsçš„ç»“åˆ<br>&nbsp;&nbsp;&nbsp;&nbsp;ç‚¹å‡» ç³»ç»Ÿç®¡ç†(Manage Jenkins) â€”&gt; ç³»ç»Ÿé…ç½®(Configure System) â€”&gt; (æ‹–åˆ°æœ€ä¸‹æ–¹)Add a new cloud â€”&gt; é€‰æ‹© Kubernetesï¼Œç„¶åå¡«å†™ Kubernetes å’Œ Jenkins é…ç½®ä¿¡æ¯ã€‚</p><p><img src="https://img.xxlaila.cn/di32sdsf.png" alt="img"></p><blockquote><p>æ³¨æ„ namespaceï¼Œæˆ‘ä»¬è¿™é‡Œå¡« kube-opsï¼Œç„¶åç‚¹å‡»Test Connectionï¼Œå¦‚æœå‡ºç° Connection test successful çš„æç¤ºä¿¡æ¯è¯æ˜Jenkins å·²ç»å¯ä»¥å’Œ Kubernetes ç³»ç»Ÿæ­£å¸¸é€šä¿¡äº†ï¼Œç„¶åä¸‹æ–¹çš„ Jenkins URL åœ°å€ï¼š<a href="http://jenkins2.kube-ops.svc.cluster.local:8080ï¼Œè¿™é‡Œçš„æ ¼å¼ä¸ºæœåŠ¡å.namespace.svc.cluster.local:8080ï¼Œæ ¹æ®ä¸Šé¢åˆ›å»ºçš„jenkinsçš„æœåŠ¡åå¡«å†™ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¹‹å‰åˆ›å»ºçš„åä¸ºjenkinsï¼Œå¦‚æœæ˜¯ç”¨ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å°±åº”è¯¥æ˜¯jenkins2" target="_blank" rel="noopener">http://jenkins2.kube-ops.svc.cluster.local:8080ï¼Œè¿™é‡Œçš„æ ¼å¼ä¸ºæœåŠ¡å.namespace.svc.cluster.local:8080ï¼Œæ ¹æ®ä¸Šé¢åˆ›å»ºçš„jenkinsçš„æœåŠ¡åå¡«å†™ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¹‹å‰åˆ›å»ºçš„åä¸ºjenkinsï¼Œå¦‚æœæ˜¯ç”¨ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å°±åº”è¯¥æ˜¯jenkins2</a></p></blockquote><h3 id="2-2ã€é…ç½®-Pod-Template"><a href="#2-2ã€é…ç½®-Pod-Template" class="headerlink" title="2.2ã€é…ç½® Pod Template"></a>2.2ã€é…ç½® Pod Template</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;é…ç½® Jenkins Slave è¿è¡Œçš„ Pod æ¨¡æ¿ï¼Œå‘½åç©ºé—´æˆ‘ä»¬åŒæ ·æ˜¯ç”¨kube-opsï¼ŒLabels è¿™é‡Œä¹Ÿéå¸¸é‡è¦ï¼Œå¯¹äºåé¢æ‰§è¡Œ Job çš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥å€¼ï¼Œç„¶åæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ cnych/jenkins:jnlp è¿™ä¸ªé•œåƒï¼Œè¿™ä¸ªé•œåƒæ˜¯åœ¨å®˜æ–¹çš„ jnlp é•œåƒåŸºç¡€ä¸Šå®šåˆ¶çš„ï¼ŒåŠ å…¥äº† kubectl ç­‰ä¸€äº›å®ç”¨çš„å·¥å…·ã€‚<br><img src="https://img.xxlaila.cn/897kdfhgdkjb4.png" alt="img"><br><img src="https://img.xxlaila.cn/kjgsadsad8234632.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–éœ€è¦æ³¨æ„æˆ‘ä»¬è¿™é‡Œéœ€è¦åœ¨ä¸‹é¢æŒ‚è½½ä¸€ä¸ªä¸»æœºç›®å½•ï¼Œä¸€ä¸ªæ˜¯ /var/run/docker.sockï¼Œè¯¥æ–‡ä»¶æ˜¯ç”¨äº Pod ä¸­çš„å®¹å™¨èƒ½å¤Ÿå…±äº«å®¿ä¸»æœºçš„ Dockerï¼Œè¿™å°±æ˜¯è¯´çš„ docker in docker çš„æ–¹å¼ï¼ŒDocker äºŒè¿›åˆ¶æ–‡ä»¶æˆ‘ä»¬å·²ç»æ‰“åŒ…åˆ°ä¸Šé¢çš„é•œåƒä¸­äº†ã€‚å¦‚æœåœ¨slave agentä¸­æƒ³è¦è®¿é—®kubernetes é›†ç¾¤ä¸­å…¶ä»–èµ„æºï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»‘å®šä¹‹å‰åˆ›å»ºçš„Service Account è´¦å·:jenkins2</p><p><img src="https://img.xxlaila.cn/khsdif28734knsdfkds.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–è¿˜æœ‰å‡ ä¸ªå‚æ•°éœ€è¦æ³¨æ„ï¼Œä¸Šå›¾æœ‰ä¸€ä¸ªpodå¯¿å‘½ä»£ç†çš„ç©ºé—²å­˜æ´»æ—¶é—´ï¼ˆåˆ†ï¼‰ï¼Œæ„æ€æ˜¯å½“å¤„äºç©ºé—²çŠ¶æ€çš„æ—¶å€™ä¿ç•™ Slave Podå¤šé•¿æ—¶é—´ï¼Œè¿™ä¸ªå‚æ•°æœ€å¥½æˆ‘ä»¬ä¿å­˜é»˜è®¤å°±è¡Œäº†ï¼Œå¦‚æœä½ è®¾ç½®è¿‡å¤§çš„è¯ï¼ŒJob ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå¯¹åº”çš„ Slave Pod å°±ä¸ä¼šç«‹å³è¢«é”€æ¯åˆ é™¤ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬çš„ Kubernetes Pluginæ’ä»¶å°±ç®—é…ç½®å®Œæˆäº†</p><h3 id="2-3-Jenkins-æµ‹è¯•"><a href="#2-3-Jenkins-æµ‹è¯•" class="headerlink" title="2.3 Jenkins æµ‹è¯•"></a>2.3 Jenkins æµ‹è¯•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes æ’ä»¶çš„é…ç½®å·¥ä½œå®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ·»åŠ ä¸€ä¸ª Job ä»»åŠ¡ï¼Œçœ‹æ˜¯å¦èƒ½å¤Ÿåœ¨ Slave Pod ä¸­æ‰§è¡Œï¼Œä»»åŠ¡æ‰§è¡Œå®Œæˆåçœ‹ Pod æ˜¯å¦ä¼šè¢«é”€æ¯åœ¨ Jenkins é¦–é¡µç‚¹å‡»create new jobsï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•çš„ä»»åŠ¡ï¼Œè¾“å…¥ä»»åŠ¡åç§°ï¼Œç„¶åæˆ‘ä»¬é€‰æ‹© Freestyle project ç±»å‹çš„ä»»åŠ¡<br>&nbsp;&nbsp;&nbsp;&nbsp;æ–°å»ºä¸€ä¸ªjobä¸ºsimple-testï¼Œå¢åŠ ä¸€ä¸ªshellæ¨¡å—ï¼Œshellæ¨¡å—é‡Œé¢å¢åŠ ç®€å•çš„echoæ¥æµ‹è¯•slaveçš„åŠ¨æ€éƒ¨ç½²ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"æµ‹è¯• Kubernetes åŠ¨æ€ç”Ÿæˆ jenkins slave"</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"==============docker in docker==========="</span></span><br><span class="line">docker info</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=============kubectl============="</span></span><br><span class="line">kubectl <span class="built_in">get</span> pods -n kube-<span class="built_in">system</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/s94uskljdslfd.png" alt="img"></p><p>ç°åœ¨æˆ‘ä»¬ç›´æ¥åœ¨é¡µé¢ç‚¹å‡»åšæˆçš„ Build now è§¦å‘æ„å»ºå³å¯ï¼Œç„¶åè§‚å¯Ÿ Kubernetes é›†ç¾¤ä¸­ Pod çš„å˜åŒ–</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl get pods -n kube-ops</span></span><br></pre></td></tr></table></figure><p>Kubernetes ç•Œé¢ä¹Ÿä¼šå‡ºç°jenkins agentçš„è¿›è¡Œpodçš„è¿›è¡Œéƒ¨ç½²ã€‚éƒ¨ç½²å®ŒæˆåéšåŠåˆ é™¤podã€‚</p><p><img src="https://img.xxlaila.cn/sakhd89234klmds.png" alt="img"><br><img src="https://img.xxlaila.cn/nslkfhio3rsd.png" alt="img"></p><h2 id="3ã€Jenkinsé”™è¯¯è§£å†³"><a href="#3ã€Jenkinsé”™è¯¯è§£å†³" class="headerlink" title="3ã€Jenkinsé”™è¯¯è§£å†³"></a>3ã€Jenkinsé”™è¯¯è§£å†³</h2><p>ç¬¬ä¸€æ¬¡å­¦ä¹ å®‰è£…jenkinsè¸©äº†å¾ˆå¤šå‘ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå­¦ä¹ äº†å¾ˆå¤šçš„ï¼Œä¸‹é¢æ˜¯åœ¨k8sä¸Šå®‰è£…jenkinsé‡åˆ°çš„ä¸€äº›é”™è¯¯ï¼š</p><ul><li>æ‰“å¼€jenkinsé¡µé¢çš„æ—¶å€™æç¤ºdnsä¸èƒ½è§£æï¼Œæ´é¢å¦‚ä¸‹å›¾ï¼š</li></ul><p><img src="https://img.xxlaila.cn/skajdh823648uesd.png" alt="img"></p><ul><li>æŸ¥çœ‹jenkinsçš„æ—¥å¿—æç¤º</li></ul><p><img src="https://img.xxlaila.cn/8243ihkdfnklsads.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¯¼è‡´çš„é—®é¢˜æœ‰httpsã€ç½‘ç»œè¿æ¥ä¸é€šç•…ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å§httpsä¿®æ”¹ä¸ºhttpï¼Œéœ€è¦ä¿®æ”¹jenkinsçš„é…ç½®æ–‡ä»¶ã€‚ç„¶åå†é‡æ–°å»ºç«‹jenkinsçš„podã€‚è¿›å…¥jenkinsçš„ç›®å½•ä¿®æ”¹hudson.model.UpdateCenter.xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">$ cat hudson.model.UpdateCenter.xml</span><br><span class="line"><span class="meta">&lt;?xml version='1.1' encoding='UTF-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sites</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">site</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://updates.jenkins.io/update-center.json<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨åšk8sçš„æ—¶å€™ä¸€å®šè¦ç”¨è¯ä¹¦ï¼Œä¸ç„¶åæœŸåœ¨åšå„ç§æœåŠ¡çš„æ—¶å€™éƒ½ä¼šé‡åˆ°é”™è¯¯ï¼Œå› ä¸ºdockeré»˜è®¤å»ç§æœ‰registoryè¦httpsï¼Œkuber-apiè¦httpsã€‚å½“ç„¶æ²¡æœ‰ä½¿ç”¨httpséƒ½å¯ä»¥æ¢æˆhttpï¼Œåœ¨æ¬¡é‡æ–°éƒ¨ç½²jenkinsä»¥åæç¤ºç³»åˆ—ä¿¡æ¯ã€‚è®¿é—®ç›®å½•æ²¡æœ‰æƒé™ã€‚</p><p><img src="https://img.xxlaila.cn/2864jksfhjdsh.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿›å…¥nfsç›®å½•ï¼Œéœ€è¦ä¿®æ”¹ä¸‹ç›®å½•æƒé™, å› ä¸ºå½“æ˜ å°„æœ¬åœ°æ•°æ®å·æ—¶ï¼Œ/home/docker/jenkinsç›®å½•çš„æ‹¥æœ‰è€…ä¸ºrootç”¨æˆ·ï¼Œè€Œå®¹å™¨ä¸­jenkins userçš„uidä¸º1000</p><p><code>$ sudo chown -R 1000:1000 /data/jenkins</code></p><blockquote><p>è¿™é‡Œå§httpsè§£å†³äº†è¿˜æ˜¯é‡åˆ°æç¤ºç½‘ç»œä¸é€šã€‚ä¸‹å›¾</p></blockquote><p><img src="https://img.xxlaila.cn/xnks94uoildsfs.png" alt="img"></p><blockquote><p>è¿™é‡Œæ˜¯dnsçš„ä¸èƒ½è§£æçš„é—®é¢˜ï¼Œä»¥ä¸‹æ’é”™æ€è·¯ï¼šç™»é™†jenkinsçš„å®¹å™¨é‡Œé¢æŸ¥çœ‹è·¯ç”±æ˜¯å¦æ­£ç¡®</p></blockquote><p><img src="https://img.xxlaila.cn/382468365324.png" alt="img"></p><blockquote><p>ç„¶ååœ¨ç¡®è®¤å®¹å™¨æ˜¯å¦å¯ä»¥è”é€šå¤–ç½‘ï¼Œè¿˜æ˜¯dnsä¸èƒ½è§£æ<br><img src="https://img.xxlaila.cn/fnijwy4nkdsfkhdsf.png" alt="img"></p></blockquote><blockquote><p>è¿™é‡Œping 114æ²¡æœ‰é—®é¢˜ï¼ŒpingåŸŸåä¸èƒ½è§£æï¼Œè¯´æ˜æ˜¯dnsè§£ææœ‰é—®é¢˜ã€‚æ¥ç€æˆ‘ä»¬åœ¨æŸ¥çœ‹å®¹å™¨çš„dnsé…ç½®</p></blockquote><p><img src="https://img.xxlaila.cn/dkjfsg328943242.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæ˜¯dnsé—®é¢˜ã€‚è¿™é‡Œä¸é˜è¿°dnsï¼Œå‚è€ƒç¬¬äºŒç« k8s dns,jenkins åœ¨æ‰§è¡Œç¼–è¯‘çš„æ—¶å€™æç¤º: <code>â€˜Jenkinsâ€™ doesnâ€™t have label â€˜jnlp-agentâ€™</code>,åœ¨ç³»ç»Ÿé…ç½®é…ç½®é‡Œé¢è¿›è¡Œæµ‹è¯•è¿æ¥k8s çš„apiæç¤ºå¦‚ä¸‹é”™è¯¯</p><p><img src="https://img.xxlaila.cn/324768ksdjsfhds.png" alt="img"></p><ul><li>æ·»åŠ jenkinsçš„secretè®¤è¯</li></ul><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"># kubectl get secret  -<span class="keyword">n</span> kube-ops</span><br><span class="line">NAME                     <span class="keyword">TYPE</span>                                  DATA   AGE</span><br><span class="line">default-<span class="keyword">token</span>-4gzkv      kubernetes.io/service-account-<span class="keyword">token</span>   3      13d</span><br><span class="line">jenkins2-<span class="keyword">token</span>-mjnw4     kubernetes.io/service-account-<span class="keyword">token</span>   3      14m</span><br><span class="line">prometheus-<span class="keyword">token</span>-84p87   kubernetes.io/service-account-<span class="keyword">token</span>   3      13d</span><br><span class="line"># kubectl <span class="keyword">describe</span> secret jenkins2-<span class="keyword">token</span>-mjnw4 -<span class="keyword">n</span> kube-ops</span><br><span class="line">Name:         jenkins2-<span class="keyword">token</span>-mjnw4</span><br><span class="line">Namespace:    kube-ops</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: jenkins2</span><br><span class="line">              kubernetes.io/service-account.uid: ffced652-2f6c-11e9-98a4-fa163e14c5bd</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span>:  kubernetes.io/service-account-<span class="keyword">token</span></span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line"><span class="keyword">ca</span>.crt:     1025 bytes</span><br><span class="line">namespace:  8 bytes</span><br><span class="line"><span class="keyword">token</span>:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLW9wcyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJqZW5raW5zMi10b2tlbi1tam53NCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJqZW5raW5zMiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImZmY2VkNjUyLTJmNmMtMTFlOS05OGE0LWZhMTYzZTE0YzViZCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLW9wczpqZW5raW5zMiJ9.PlPvO_AST4Q6tJJ2i2zGFfufFN1xjWLlHZ5ipTK0aU5CdR49OAropPQhQ0TjLRWf4Z66h847g28OCABmxO1cSG_-8UpwVsohFROTCOjx9Ka3KACmaIkw9Bvihm_lPQlaLykdyXxVDrfI6TobtG0Y5KnKPFj8CjkIFPk5ewTKpOm5pDKVDKu4W_4uOhSnISfLVUvHp8A_ojK_JCVnBBr0Py3UeuEF8vjJES0_yKNxPUtXQq-vkWEZecnAC_x5sfFJTA5aB18sEnxCaeMzgUxzi4IflNxxyVjdZrbq0UdS8llmfnGg5Ur7Zf-lu2ajdOlRdQp6VRPMcQmQaWoHUuoevg</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/2372837934232.png" alt="img"><br><img src="https://img.xxlaila.cn/djfjsr3897493432.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kube nfs åŠ¨æ€å­˜å‚¨</title>
    <url>/2019/08/12/kube-nfs-%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;nfs-client-provisioneræ˜¯ä¸€ä¸ªautomatic provisionerï¼Œä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œè‡ªåŠ¨åˆ›å»ºPVå’Œå¯¹åº”çš„PVCï¼Œæœ¬èº«ä¸æä¾›NFSå­˜å‚¨ï¼Œéœ€è¦å¤–éƒ¨å…ˆæœ‰ä¸€å¥—NFSå­˜å‚¨æœåŠ¡ã€‚</p><ul><li>PVä»¥ ${namespace}-${pvcName}-${pvName}çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">å®˜æ–¹è®¿é—®åœ°å€</a></p><h2 id="1ã€æƒé™ä½“ç³»æ„å»º"><a href="#1ã€æƒé™ä½“ç³»æ„å»º" class="headerlink" title="1ã€æƒé™ä½“ç³»æ„å»º"></a>1ã€æƒé™ä½“ç³»æ„å»º</h2><h3 id="1-1ã€åˆ›å»ºserviceaccount"><a href="#1-1ã€åˆ›å»ºserviceaccount" class="headerlink" title="1.1ã€åˆ›å»ºserviceaccount"></a>1.1ã€åˆ›å»ºserviceaccount</h3><p>ServiceAccountä¹Ÿæ˜¯ä¸€ç§è´¦å·, ä¾›è¿è¡Œåœ¨podä¸­çš„è¿›ç¨‹ä½¿ç”¨, ä¸ºpodä¸­çš„è¿›ç¨‹æä¾›å¿…è¦çš„èº«ä»½è¯æ˜.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat serviceaccount.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: kube-test</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1-2ã€åˆ›å»ºrole"><a href="#1-2ã€åˆ›å»ºrole" class="headerlink" title="1.2ã€åˆ›å»ºrole"></a>1.2ã€åˆ›å»ºrole</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat  clusterrole.yaml</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  namespace: kube-test</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    resources: [<span class="string">"storageclasses"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"events"</span>]</span><br><span class="line">    verbs: [<span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services"</span>, <span class="string">"endpoints"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>,<span class="string">"list"</span>, <span class="string">"watch"</span>,<span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"podsecuritypolicies"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"nfs-client-provisioner"</span>]</span><br><span class="line">    verbs: [<span class="string">"use"</span>]</span><br></pre></td></tr></table></figure><h3 id="1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"><a href="#1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š" class="headerlink" title="1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"></a>1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat clusterrolebinding.yaml </span></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: kube-test</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">æ‰§è¡Œåˆ›å»º</span><br><span class="line">kubectl create -f serviceaccount.yaml -f clusterrole.yaml -f clusterrolebinding.yaml</span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…éƒ¨ç½²"><a href="#2ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="2ã€å®‰è£…éƒ¨ç½²"></a>2ã€å®‰è£…éƒ¨ç½²</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹è½½deployment.yamlæ–‡ä»¶,éœ€è¦ä¿®æ”¹NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ10.10.10.60ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/ifs/kubernetesï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><h3 id="2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"><a href="#2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·" class="headerlink" title="2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"></a>2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·</h3><blockquote><p>æ ¹æ®PVCçš„è¯·æ±‚, åŠ¨æ€åˆ›å»ºPVå­˜å‚¨.</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat deployment.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: quay.io/external_storage/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.21.16.244</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /data</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 10.10.10.60</span><br><span class="line">            path: /ifs/kubernetes</span><br></pre></td></tr></table></figure><pre><code>* ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²class.yaml</code></pre><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´</p><h3 id="2-2ã€åˆ›å»ºstorageclass"><a href="#2-2ã€åˆ›å»ºstorageclass" class="headerlink" title="2.2ã€åˆ›å»ºstorageclass"></a>2.2ã€åˆ›å»ºstorageclass</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat class.yaml</span></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br></pre></td></tr></table></figure><h4 id="2-2-1ã€æŸ¥çœ‹StorageClass"><a href="#2-2-1ã€æŸ¥çœ‹StorageClass" class="headerlink" title="2.2.1ã€æŸ¥çœ‹StorageClass"></a>2.2.1ã€æŸ¥çœ‹StorageClass</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get sc</span></span><br><span class="line"><span class="comment"># kubectl get storageclass</span></span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   19h</span><br></pre></td></tr></table></figure><h4 id="2-2-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"><a href="#2-2-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨" class="headerlink" title="2.2.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"></a>2.2.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨</h4><p>è®¾ç½®è¿™ä¸ªdefaultåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch storageclass managed-nfs-storage -p '&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3ã€æµ‹è¯•åˆ›å»ºPVC"><a href="#2-2-3ã€æµ‹è¯•åˆ›å»ºPVC" class="headerlink" title="2.2.3ã€æµ‹è¯•åˆ›å»ºPVC"></a>2.2.3ã€æµ‹è¯•åˆ›å»ºPVC</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat test-claim.yaml </span></span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-claim</span><br><span class="line">  namespace: kube-test</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br></pre></td></tr></table></figure><h4 id="2-2-4ã€å¯åŠ¨æµ‹è¯•POD"><a href="#2-2-4ã€å¯åŠ¨æµ‹è¯•POD" class="headerlink" title="2.2.4ã€å¯åŠ¨æµ‹è¯•POD"></a>2.2.4ã€å¯åŠ¨æµ‹è¯•POD</h4><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat test-pod.yaml </span></span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-pod</span><br><span class="line">  namespace: kube-test</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: <span class="built_in">test</span>-pod</span><br><span class="line">    image: docker.io/busybox:1.24</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"/bin/sh"</span></span><br><span class="line">    args:</span><br><span class="line">      - <span class="string">"-c"</span></span><br><span class="line">      - <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        mountPath: <span class="string">"/mnt"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: <span class="built_in">test</span>-claim</span><br></pre></td></tr></table></figure><h4 id="2-2-5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ"><a href="#2-2-5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ" class="headerlink" title="2.2.5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ"></a>2.2.5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ</h4><p>å»NFSå…±äº«ç›®å½•æŸ¥çœ‹æœ‰æ²¡æœ‰SUCCESSæ–‡ä»¶<br><img src="https://img.xxlaila.cn/%E6%88%AA%E5%9B%BE.png" alt="img"><br><img src="https://img.xxlaila.cn/8934nsdlsa.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pvc -n kube-test</span></span><br><span class="line">NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line"><span class="built_in">test</span>-claim   Bound    pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd   1Mi        RWX            managed-nfs-storage   20h</span><br></pre></td></tr></table></figure><h3 id="2-3ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"><a href="#2-3ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥" class="headerlink" title="2.3ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"></a>2.3ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥</h3><ul><li><p>æŸ¥çœ‹é›†ç¾¤ä¸­PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch pv pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd -p '&#123;"spec":&#123;"persistentVolumeReclaimPolicy":"Retain"&#125;&#125;'</span></span><br><span class="line">persistentvolume/pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd patched</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ›´æ”¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>pvc pv</title>
    <url>/2019/08/12/pvc-pv/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h2 id="1ã€ä»‹ç»"><a href="#1ã€ä»‹ç»" class="headerlink" title="1ã€ä»‹ç»"></a>1ã€ä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;PersistentVolumeï¼ˆpvï¼‰å’ŒPersistentVolumeClaimï¼ˆpvcï¼‰æ˜¯k8sæä¾›çš„ä¸¤ç§APIèµ„æºï¼Œç”¨äºæŠ½è±¡å­˜å‚¨ç»†èŠ‚ã€‚ç®¡ç†å‘˜å…³æ³¨äºå¦‚ä½•é€šè¿‡pvæä¾›å­˜å‚¨åŠŸèƒ½è€Œæ— éœ€å…³æ³¨ç”¨æˆ·å¦‚ä½•ä½¿ç”¨ï¼ŒåŒæ ·çš„ç”¨æˆ·åªéœ€è¦æŒ‚è½½pvcåˆ°å®¹å™¨ä¸­è€Œä¸éœ€è¦å…³æ³¨å­˜å‚¨å·é‡‡ç”¨ä½•ç§æŠ€æœ¯å®ç°ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;pvcå’Œpvçš„å…³ç³»ä¸podå’Œnodeå…³ç³»ç±»ä¼¼ï¼Œå‰è€…æ¶ˆè€—åè€…çš„èµ„æºã€‚pvcå¯ä»¥å‘pvç”³è¯·æŒ‡å®šå¤§å°çš„å­˜å‚¨èµ„æºå¹¶è®¾ç½®è®¿é—®æ¨¡å¼,è¿™å°±å¯ä»¥é€šè¿‡Provision -&gt; Claim çš„æ–¹å¼ï¼Œæ¥å¯¹å­˜å‚¨èµ„æºè¿›è¡Œæ§åˆ¶ã€‚</p><h2 id="2ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#2ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2ã€ç”Ÿå‘½å‘¨æœŸ"></a>2ã€ç”Ÿå‘½å‘¨æœŸ</h2><p>pvå’Œpvcéµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š</p><ul><li>ä¾›åº”å‡†å¤‡ã€‚é€šè¿‡é›†ç¾¤å¤–çš„å­˜å‚¨ç³»ç»Ÿæˆ–è€…äº‘å¹³å°æ¥æä¾›å­˜å‚¨æŒä¹…åŒ–æ”¯æŒã€‚</li></ul><ul><li><p>é™æ€æä¾›ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¤šä¸ªPVï¼Œä¾›PVCä½¿ç”¨ã€‚</p></li><li><p>åŠ¨æ€æä¾›ï¼šåŠ¨æ€åˆ›å»ºPVCç‰¹å®šçš„PVï¼Œå¹¶ç»‘å®šã€‚</p><ul><li>ç»‘å®šã€‚ç”¨æˆ·åˆ›å»ºpvcå¹¶æŒ‡å®šéœ€è¦çš„èµ„æºå’Œè®¿é—®æ¨¡å¼ã€‚åœ¨æ‰¾åˆ°å¯ç”¨pvä¹‹å‰ï¼Œpvcä¼šä¿æŒæœªç»‘å®šçŠ¶æ€ã€‚</li><li>ä½¿ç”¨ã€‚ç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvcã€‚</li><li>é‡Šæ”¾ã€‚ç”¨æˆ·åˆ é™¤pvcæ¥å›æ”¶å­˜å‚¨èµ„æºï¼Œpvå°†å˜æˆâ€œreleasedâ€çŠ¶æ€ã€‚ç”±äºè¿˜ä¿ç•™ç€ä¹‹å‰çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†ï¼Œå¦åˆ™è¿™äº›å­˜å‚¨èµ„æºæ— æ³•è¢«å…¶ä»–pvcä½¿ç”¨ã€‚</li><li>å›æ”¶(Reclaiming)ã€‚pvå¯ä»¥è®¾ç½®ä¸‰ç§å›æ”¶ç­–ç•¥ï¼šä¿ç•™ï¼ˆRetainï¼‰ï¼Œå›æ”¶ï¼ˆRecycleï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</li></ul></li><li><p>ä¿ç•™ç­–ç•¥ï¼šå…è®¸äººå·¥å¤„ç†ä¿ç•™çš„æ•°æ®ã€‚</p></li><li><p>åˆ é™¤ç­–ç•¥ï¼šå°†åˆ é™¤pvå’Œå¤–éƒ¨å…³è”çš„å­˜å‚¨èµ„æºï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</p></li><li><p>å›æ”¶ç­–ç•¥ï¼šå°†æ‰§è¡Œæ¸…é™¤æ“ä½œï¼Œä¹‹åå¯ä»¥è¢«æ–°çš„pvcä½¿ç”¨ï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</p></li></ul><blockquote><p><em>ç›®å‰åªæœ‰NFSå’ŒHostPathç±»å‹å·æ”¯æŒå›æ”¶ç­–ç•¥ï¼ŒAWS EBS,GCE PD,Azure Diskå’ŒCinderæ”¯æŒåˆ é™¤(Delete)ç­–ç•¥ã€‚</em></p></blockquote><h3 id="2-1ã€Provisioning"><a href="#2-1ã€Provisioning" class="headerlink" title="2.1ã€Provisioning"></a>2.1ã€Provisioning</h3><p>ä¸¤ç§æ–¹å¼æä¾›çš„PVèµ„æºä¾›ç»™</p><a id="more"></a><p>static</p><ul><li>é€šè¿‡é›†ç¾¤ç®¡ç†è€…åˆ›å»ºå¤šä¸ªPVï¼Œä¸ºé›†ç¾¤â€œä½¿ç”¨è€…â€æä¾›å­˜å‚¨èƒ½åŠ›è€Œéšè—çœŸå®å­˜å‚¨çš„ç»†èŠ‚ã€‚å¹¶ä¸”å­˜åœ¨äºkubenretes apiä¸­ï¼Œå¯è¢«ç›´æ¥ä½¿ç”¨ã€‚</li></ul><p>dynamic</p><ul><li>åŠ¨æ€å·ä¾›ç»™æ˜¯kubernetesç‹¬æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¸€åŠŸèƒ½å…è®¸æŒ‰éœ€åˆ›å»ºå­˜å‚¨å»ºã€‚åœ¨æ­¤ä¹‹å‰ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦äº‹å…ˆåœ¨é›†ç¾¤å¤–ç”±å­˜å‚¨æä¾›è€…æˆ–è€…äº‘æä¾›å•†åˆ›å»º</li><li>å­˜å‚¨å·ï¼ŒæˆåŠŸä¹‹åå†åˆ›å»ºPersistentVolumeå¯¹è±¡ï¼Œæ‰èƒ½å¤Ÿåœ¨kubernetesä¸­ä½¿ç”¨ã€‚åŠ¨æ€å·ä¾›ç»™èƒ½è®©é›†ç¾¤ç®¡ç†å‘˜ä¸å¿…è¿›è¡Œé¢„å…ˆåˆ›å»ºå­˜å‚¨å·ï¼Œè€Œæ˜¯éšç€ç”¨æˆ·éœ€æ±‚è¿›è¡Œåˆ›å»ºã€‚åœ¨1.5ç‰ˆæœ¬æé«˜äº†åŠ¨æ€å·çš„å¼¹æ€§å’Œå¯ç”¨æ€§ã€‚</li></ul><h2 id="3ã€PVç±»å‹"><a href="#3ã€PVç±»å‹" class="headerlink" title="3ã€PVç±»å‹"></a>3ã€PVç±»å‹</h2><p>pvæ”¯æŒä»¥ä¸‹ç±»å‹:</p><pre><code>* GCEPersistentDisk
* AWSElasticBlockStore
* NFS
* iSCSI
* RBD (Ceph Block Device)
* Glusterfs
* AzureFile
* AzureDisk
* CephFS
* cinder
* FC
* FlexVolume
* Flocker
* PhotonPersistentDisk
* Quobyte
* VsphereVolume
* HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</code></pre><h3 id="3-1ã€PVå±æ€§"><a href="#3-1ã€PVå±æ€§" class="headerlink" title="3.1ã€PVå±æ€§"></a>3.1ã€PVå±æ€§</h3><ul><li>è®¿é—®æ¨¡å¼,ä¸pvçš„è¯­ä¹‰ç›¸åŒã€‚åœ¨è¯·æ±‚èµ„æºæ—¶ä½¿ç”¨ç‰¹å®šæ¨¡å¼ã€‚</li><li>èµ„æº,ç”³è¯·çš„å­˜å‚¨èµ„æºæ•°é¢ã€‚</li></ul><h3 id="3-2ã€PVå·é˜¶æ®µçŠ¶æ€"><a href="#3-2ã€PVå·é˜¶æ®µçŠ¶æ€" class="headerlink" title="3.2ã€PVå·é˜¶æ®µçŠ¶æ€"></a>3.2ã€PVå·é˜¶æ®µçŠ¶æ€</h3><ul><li>Available â€“ èµ„æºå°šæœªè¢«claimä½¿ç”¨</li><li>Bound â€“ å·å·²ç»è¢«ç»‘å®šåˆ°claimäº†</li><li>Released â€“ claimè¢«åˆ é™¤ï¼Œå·å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æœªè¢«é›†ç¾¤å›æ”¶ã€‚</li><li>Failed â€“ å·è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><h2 id="4ã€åˆ©ç”¨nfsåˆ›å»ºpv-pvc"><a href="#4ã€åˆ©ç”¨nfsåˆ›å»ºpv-pvc" class="headerlink" title="4ã€åˆ©ç”¨nfsåˆ›å»ºpv_pvc"></a>4ã€åˆ©ç”¨nfsåˆ›å»ºpv_pvc</h2><p>å‡†å¤‡ä¸€å°æœºå™¨ï¼Œæ­å»ºNFSæœåŠ¡ï¼Œnfsæ­å»ºè¿™é‡Œä¸é˜è¿°ï¼Œ</p><h3 id="4-1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv"><a href="#4-1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv" class="headerlink" title="4.1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv"></a>4.1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat pv.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: opspv</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/jenkins</span><br><span class="line">    server: 172.21.16.236</span><br><span class="line"><span class="comment"># kubectl create -f pv.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure><h3 id="4-2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc"><a href="#4-2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc" class="headerlink" title="4.2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc"></a>4.2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat pvc.yaml</span></span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: opspv</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line"><span class="comment"># kubectl create -f pvc.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pvc</span></span><br></pre></td></tr></table></figure><h3 id="4-3ã€åˆ›å»ºpodæŒ‚è½½pv-pvc"><a href="#4-3ã€åˆ›å»ºpodæŒ‚è½½pv-pvc" class="headerlink" title="4.3ã€åˆ›å»ºpodæŒ‚è½½pv_pvc"></a>4.3ã€åˆ›å»ºpodæŒ‚è½½pv_pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-deployment.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: jenkins2</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins</span><br><span class="line">        image: jenkins/jenkins:lts</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: web</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 50000</span><br><span class="line">          name: agent</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 512Mi</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: jenkinshome</span><br><span class="line">          subPath: jenkins2</span><br><span class="line">          mountPath: /var/jenkins_home</span><br><span class="line">        env:</span><br><span class="line">        - name: LIMITS_MEMORY</span><br><span class="line">          valueFrom:</span><br><span class="line">            resourceFieldRef:</span><br><span class="line">              resource: limits.memory</span><br><span class="line">              divisor: 1Mi</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx$(LIMITS_MEMORY)m -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85 -Duser.timezone=Asia/Shanghai</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">      volumes:</span><br><span class="line">      - name: jenkinshome</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: opspvc</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  labels:</span><br><span class="line">    app: jenkins2</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: jenkins2</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30002</span><br><span class="line">  - name: agent</span><br><span class="line">    port: 50000</span><br><span class="line">    targetPort: agent</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <tags>
        <tag>pvc,pv,kubernetes,å­˜å‚¨</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes å•æœºå®‰è£…</title>
    <url>/2019/08/12/kubernetes-%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h2 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1.ç¯å¢ƒå‡†å¤‡"></a>1.ç¯å¢ƒå‡†å¤‡</h2><blockquote><p>ä¸€ä¸ªmasterèŠ‚ç‚¹ï¼Œå››ä¸ªnodeèŠ‚ç‚¹<br>masterèŠ‚ç‚¹ip</p><ul><li>172.21.16.244<br>nodeèŠ‚ç‚¹ip</li><li>172.21.16.24</li><li>172.21.16.231</li><li>172.21.16.202</li><li>172.21.16.55</li></ul></blockquote><ul><li>ä»¥ä¸‹æ˜¯æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå‡è¿›è¡Œæ“ä½œ</li></ul><h2 id="2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº"><a href="#2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº" class="headerlink" title="2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº"></a>2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">  http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="3ã€é‡æ–°å»ºç«‹yumç¼“å­˜"><a href="#3ã€é‡æ–°å»ºç«‹yumç¼“å­˜" class="headerlink" title="3ã€é‡æ–°å»ºç«‹yumç¼“å­˜"></a>3ã€é‡æ–°å»ºç«‹yumç¼“å­˜</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install epel-release &amp;&amp;yum clean all &amp;&amp;yum makecach</span></span><br></pre></td></tr></table></figure><ul><li>è®°å¾—åŒæ­¥ç³»ç»Ÿçš„æ—¶é—´</li></ul><h2 id="3ã€é…ç½®è½¬å‘è¯·æ±‚"><a href="#3ã€é…ç½®è½¬å‘è¯·æ±‚" class="headerlink" title="3ã€é…ç½®è½¬å‘è¯·æ±‚"></a>3ã€é…ç½®è½¬å‘è¯·æ±‚</h2><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">å…³é—­swap</span><br><span class="line"><span class="comment"># sudo swapoff -a</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># sysctl --system</span></span><br></pre></td></tr></table></figure><h2 id="4ã€å®‰è£…docker"><a href="#4ã€å®‰è£…docker" class="headerlink" title="4ã€å®‰è£…docker"></a>4ã€å®‰è£…docker</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install docker</span></span><br><span class="line"><span class="comment"># systemctl enable docker &amp;&amp; systemctl start docker</span></span><br></pre></td></tr></table></figure><h2 id="5ã€å®‰è£…k8s-éœ€è¦çš„æ’ä»¶"><a href="#5ã€å®‰è£…k8s-éœ€è¦çš„æ’ä»¶" class="headerlink" title="5ã€å®‰è£…k8s éœ€è¦çš„æ’ä»¶"></a>5ã€å®‰è£…k8s éœ€è¦çš„æ’ä»¶</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install kubelet kubeadm kubectl kubernetes-cni</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet &amp;&amp; systemctl start kubelet</span></span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ä¸º kubelet ä¸ºCgroupæ¨¡å¼</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CGROUP_ARGS=--cgroup-driver=systemd"</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure><h2 id="6ã€æ‹‰å–é•œåƒ"><a href="#6ã€æ‹‰å–é•œåƒ" class="headerlink" title="6ã€æ‹‰å–é•œåƒ"></a>6ã€æ‹‰å–é•œåƒ</h2><p>æ–°å»ºä¸€ä¸ªshell æ‹‰å–é•œåƒåˆ°æœ¬åœ°(æ‰€æœ‰èŠ‚ç‚¹å‡æ“ä½œ)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">images=(kube-proxy:v1.13.0 kube-scheduler:v1.13.0 kube-controller-manager:v1.13.0 kube-apiserver:v1.13.0 etcd:3.2.24 coredns:1.2.6 pause:3.1 kubernetes-dashboard-amd64:v1.10.0 kubernetes-dashboard-init-amd64:v1.0.1  k8s-dns-sidecar-amd64:1.14.9 k8s-dns-kube-dns-amd64:1.14.9 k8s-dns-dnsmasq-nanny:1.15.0 heapster:v1.5.2 kubernetes-dashboard-arm:v1.10.0)</span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">docker pull xxlaila/<span class="variable">$imageName</span></span><br><span class="line">docker tag xxlaila/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">docker rmi xxlaila/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>ä»¥ä¸‹æ“ä½œæ˜¯åœ¨k8sçš„masterè¿›è¡Œæ“ä½œ</li></ul><h2 id="7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ"><a href="#7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ" class="headerlink" title="7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ"></a>7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm init --kubernetes-version=v1.13.0 --pod-network-cidr=10.244.0.0/16</span></span><br><span class="line"><span class="comment"># è®°ä¸‹è¿™å¥è¯ï¼Œåé¢nodeèŠ‚ç‚¹åŠ å…¥éœ€è¦</span></span><br><span class="line"><span class="comment"># kubeadm join 172.21.17.4:6443 --token 0mdk7x.du3cn19qm1jl2b0e --discovery-token-ca-cert-hash sha256:19bf79b41a931735b1f2f5138e1daa436ab26a4f19781ccf2015cff749ddb4b9</span></span><br></pre></td></tr></table></figure><h3 id="7-1ã€æ‰§è¡Œåˆ›å»ºç›®å½•"><a href="#7-1ã€æ‰§è¡Œåˆ›å»ºç›®å½•" class="headerlink" title="7.1ã€æ‰§è¡Œåˆ›å»ºç›®å½•"></a>7.1ã€æ‰§è¡Œåˆ›å»ºç›®å½•</h3><p>åé¢åœ¨ç”Ÿæˆè¯ä¹¦çš„æ—¶å€™éœ€è¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><h3 id="7-2ã€æŸ¥çœ‹éªŒè¯"><a href="#7-2ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="7.2ã€æŸ¥çœ‹éªŒè¯"></a>7.2ã€æŸ¥çœ‹éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatus</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br><span class="line"><span class="comment"># kubectl get cs</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="8ã€å®‰è£…flannel-ç½‘ç»œ"><a href="#8ã€å®‰è£…flannel-ç½‘ç»œ" class="headerlink" title="8ã€å®‰è£…flannel ç½‘ç»œ"></a>8ã€å®‰è£…flannel ç½‘ç»œ</h2><blockquote><p>(é…ç½®æ–‡ä»¶å’Œç›®å½•æ¯ä¸ªnodeéƒ½è¦å»ºç«‹)</p></blockquote><h3 id="8-1-åˆ›å»ºflannelé…ç½®æ–‡ä»¶"><a href="#8-1-åˆ›å»ºflannelé…ç½®æ–‡ä»¶" class="headerlink" title="8.1 åˆ›å»ºflannelé…ç½®æ–‡ä»¶"></a>8.1 åˆ›å»ºflannelé…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/cni/net.d/</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF&gt; /etc/cni/net.d/10-flannel.conf</span></span><br><span class="line">&#123;</span><br><span class="line">â€œnameâ€: â€œcbr0â€,</span><br><span class="line">â€œ<span class="built_in">type</span>â€: â€œflannelâ€,</span><br><span class="line">â€œdelegateâ€: &#123;</span><br><span class="line">â€œisDefaultGatewayâ€: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="8-2-åˆ›å»ºç½‘ç»œé…ç½®"><a href="#8-2-åˆ›å»ºç½‘ç»œé…ç½®" class="headerlink" title="8.2 åˆ›å»ºç½‘ç»œé…ç½®"></a>8.2 åˆ›å»ºç½‘ç»œé…ç½®</h3><blockquote><p>(åªéœ€è¦åœ¨ä¸»èŠ‚ç‚¹æ“ä½œå³å¯)</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-amd64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-ppc64le created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-s390x created</span><br></pre></td></tr></table></figure><h2 id="9ã€æŸ¥çœ‹å‘½åç©ºé—´"><a href="#9ã€æŸ¥çœ‹å‘½åç©ºé—´" class="headerlink" title="9ã€æŸ¥çœ‹å‘½åç©ºé—´"></a>9ã€æŸ¥çœ‹å‘½åç©ºé—´</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get ns</span></span><br><span class="line">NAME          STATUS   AGE</span><br><span class="line">default       Active   27m</span><br><span class="line">kube-public   Active   27m</span><br><span class="line">kube-system   Active   27m</span><br></pre></td></tr></table></figure><h2 id="10ã€æŸ¥çœ‹systemçš„pod"><a href="#10ã€æŸ¥çœ‹systemçš„pod" class="headerlink" title="10ã€æŸ¥çœ‹systemçš„pod"></a>10ã€æŸ¥çœ‹systemçš„pod</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-86c58d9df4-4gfvd                     1/1     Running   0          27m</span><br><span class="line">coredns-86c58d9df4-cxtz5                     1/1     Running   0          27m</span><br><span class="line">etcd-k8s-zxc-test-3.kxl                      1/1     Running   0          26m</span><br><span class="line">kube-apiserver-k8s-zxc-test-3.kxl            1/1     Running   0          26m</span><br><span class="line">kube-controller-manager-k8s-zxc-test-3.kxl   1/1     Running   0          26m</span><br><span class="line">kube-flannel-ds-nh95x                        1/1     Running   0          15m</span><br><span class="line">kube-proxy-kvlng                             1/1     Running   0          27m</span><br><span class="line">kube-scheduler-k8s-zxc-test-3.kxl            1/1     Running   0          27m</span><br></pre></td></tr></table></figure><h2 id="11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter"><a href="#11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter" class="headerlink" title="11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter"></a>11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter</h2><ul><li>ä»¥ä¸‹æ˜¯æ¯ä¸ªnodeèŠ‚ç‚¹æ‰§è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm join 172.21.17.4:6443 --token 0mdk7x.du3cn19qm1jl2b0e --discovery-token-ca-cert-hash sha256:19bf79b41a931735b1f2f5138e1daa436ab26a4f19781ccf2015cff749ddb4b9</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦åŠ å…¥</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨kubectl get podså‘½ä»¤æ¥æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€</span></span><br><span class="line"><span class="comment"># kubectl get pods --all-namespaces</span></span><br></pre></td></tr></table></figure><h2 id="12ã€å®‰è£…kubernetes-dashboard"><a href="#12ã€å®‰è£…kubernetes-dashboard" class="headerlink" title="12ã€å®‰è£…kubernetes dashboard"></a>12ã€å®‰è£…kubernetes dashboard</h2><p>ä¸‹è½½å®˜ç½‘çš„dashboardæ–‡ä»¶ä¿®æ”¹kubernetes-dashboard.yamlæ–‡ä»¶,ç”¨ä¿®æ”¹ä¹‹åçš„kubernetes-dashboard.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»ºdashboard</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/kubernetes-dashboard</span></span><br><span class="line"><span class="comment"># kubectl apply -f kubernetes-dashboard.yaml</span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br></pre></td></tr></table></figure><h2 id="13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ"><a href="#13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ" class="headerlink" title="13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ"></a>13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system</span></span><br></pre></td></tr></table></figure><h3 id="13-1ã€æŸ¥çœ‹dashboard-info"><a href="#13-1ã€æŸ¥çœ‹dashboard-info" class="headerlink" title="13.1ã€æŸ¥çœ‹dashboard info"></a>13.1ã€æŸ¥çœ‹dashboard info</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe svc kubernetes-dashboard -n kube-system</span></span><br></pre></td></tr></table></figure><h3 id="13-2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹"><a href="#13-2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹" class="headerlink" title="13.2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹"></a>13.2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get pods -n kube-system -o wide</span></span><br></pre></td></tr></table></figure><h3 id="13-3ã€æŸ¥çœ‹service-èŠ‚ç‚¹ç«¯å£"><a href="#13-3ã€æŸ¥çœ‹service-èŠ‚ç‚¹ç«¯å£" class="headerlink" title="13.3ã€æŸ¥çœ‹service èŠ‚ç‚¹ç«¯å£"></a>13.3ã€æŸ¥çœ‹service èŠ‚ç‚¹ç«¯å£</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get service -n kube-system -o wide</span></span><br></pre></td></tr></table></figure><h3 id="13-4ã€åˆ›å»ºdashboard-admin-è´¦æˆ·"><a href="#13-4ã€åˆ›å»ºdashboard-admin-è´¦æˆ·" class="headerlink" title="13.4ã€åˆ›å»ºdashboard admin è´¦æˆ·"></a>13.4ã€åˆ›å»ºdashboard admin è´¦æˆ·</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f admin-user.yaml</span></span><br><span class="line">è·å–tokens</span><br><span class="line"><span class="comment"># kubectl describe serviceaccount admin -n kube-system</span></span><br><span class="line">Name:                admin</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:         kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                       &#123;<span class="string">"apiVersion"</span>:<span class="string">"v1"</span>,<span class="string">"kind"</span>:<span class="string">"ServiceAccount"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"labels"</span>:&#123;<span class="string">"k8s-app"</span>:<span class="string">"kubernetes-dashboard"</span>&#125;,<span class="string">"name"</span>:<span class="string">"admin"</span>,<span class="string">"namesp...</span></span><br><span class="line"><span class="string">Image pull secrets:  &lt;none&gt;</span></span><br><span class="line"><span class="string">Mountable secrets:   admin-token-kxs6k</span></span><br><span class="line"><span class="string">Tokens:              admin-token-kxs6k</span></span><br><span class="line"><span class="string">Events:              &lt;none&gt;</span></span><br><span class="line"><span class="string">æŸ¥çœ‹token ä¿¡æ¯</span></span><br><span class="line"><span class="string"># kubectl describe secret admin-token-kxs6k -n kube-system</span></span><br></pre></td></tr></table></figure><h2 id="14ã€dashboard-è®¿é—®"><a href="#14ã€dashboard-è®¿é—®" class="headerlink" title="14ã€dashboard è®¿é—®"></a>14ã€dashboard è®¿é—®</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ©ç”¨èŠ‚ç‚¹ip+30001 ç«¯å£è¿›è¡Œè®¿é—®ã€‚è®¿é—®ä¹‹å‰éœ€è¦åœ¨masterèŠ‚ç‚¹ç”Ÿæˆè¯ä¹¦ï¼ŒæŠŠè¯ä¹¦(kubecfg.p12)ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè¿›è¡Œå¯¼å…¥åˆ°æµè§ˆå™¨ï¼Œè¿™é‡Œä½¿ç”¨ç«ç‹æµè§ˆå™¨ï¼Œgoogleæµè§ˆå™¨å¯¼å…¥,ä¸æˆåŠŸï¼Œç”Ÿäº§è¯ä¹¦ä¹‹å‰è®°å¾—ç¬¬9æ­¥å·²æ“ä½œ</p><h3 id="14-1ã€ç”Ÿæˆè¯ä¹¦"><a href="#14-1ã€ç”Ÿæˆè¯ä¹¦" class="headerlink" title="14.1ã€ç”Ÿæˆè¯ä¹¦"></a>14.1ã€ç”Ÿæˆè¯ä¹¦</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grep 'client-certificate-data' ~/.kube/config | head -n 1 | awk '&#123;print $2&#125;' | base64 -d &gt;&gt; kubecfg.crt</span></span><br><span class="line"><span class="comment"># grep 'client-key-data' ~/.kube/config | head -n 1 | awk '&#123;print $2&#125;' | base64 -d &gt;&gt; kubecfg.key</span></span><br><span class="line"><span class="comment"># openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name "kubernetes-client"</span></span><br></pre></td></tr></table></figure><h3 id="14-2ã€dashboard-é…ç½®ä¿®æ”¹"><a href="#14-2ã€dashboard-é…ç½®ä¿®æ”¹" class="headerlink" title="14.2ã€dashboard é…ç½®ä¿®æ”¹"></a>14.2ã€dashboard é…ç½®ä¿®æ”¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;kubernetes dashboard v1.10.0ä½¿ç”¨çš„æ˜¯åŒå› å­ç™»é™†ï¼Œé»˜è®¤tokenå¤±æ•ˆçš„æ—¶é—´æ˜¯900ç§’ï¼Œ15åˆ†é’Ÿï¼Œæ¯15åˆ†é’Ÿå°±è¦è¿›è¡Œä¸€æ¬¡è®¤è¯ã€‚æˆ‘ä»¬å¯ä»¥åŠŸè¿‡ä¿®æ”¹token-ttlå‚æ•°æ¥è®¾ç½®ï¼Œä¸»è¦æ˜¯ä¿®æ”¹dashboard.yamlæ–‡ä»¶ï¼Œå¹¶é‡æ–°å»ºç«‹å³å¯</p><ul><li>åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ·»åŠ <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- containerPort: 8443</span><br><span class="line">  protocol: TCP</span><br><span class="line">args:</span><br><span class="line">  - --auto-generate-certificates</span><br><span class="line">  - --token-ttl=43200</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>é‡å»ºdashboard,é€šè¿‡åˆ©ç”¨httpæ·»åŠ ç«¯å£30001ï¼Œç„¶ååˆ©ç”¨tonkenè¿›è¡ŒéªŒè¯ç™»é™†,å®‰è£…å¤±è´¥æ¸…ç†ç¯å¢ƒ</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm reset</span></span><br><span class="line">æŸ¥çœ‹åŠ å…¥é›†ç¾¤token</span><br><span class="line"><span class="comment"># kubeadm token list</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos 5.5 å®‰è£…DRBD</title>
    <url>/2019/08/11/Centos-5-5-%E5%AE%89%E8%A3%85DRBD/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>Centos5.5 32bitå®‰è£…DRBD</p><ul><li>å®‰è£…å‰å‡†å¤‡</li></ul><table><thead><tr><th>èŠ‚ç‚¹ç±»å‹</th><th>IPåœ°å€è§„åˆ’</th><th>ä¸»æœºå</th></tr></thead><tbody><tr><td>ä¸»ç”¨èŠ‚ç‚¹</td><td>192.168.1.101</td><td>node2</td></tr><tr><td>å¤‡ç”¨èŠ‚ç‚¹</td><td>192.168.1.102</td><td>node1</td></tr><tr><td>ç£ç›˜</td><td>ä¸¤å°10Gç£ç›˜</td><td></td></tr></tbody></table><h2 id="åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD"><a href="#åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD" class="headerlink" title="åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD"></a>åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># yum -y install kmod-drbd83 drbd83</span></span><br></pre></td></tr></table></figure><p>å®‰è£…æˆåŠŸä¹‹å/sbinç›®å½•ä¸‹é¢æœ‰drbdadmï¼Œdrbdmetaï¼Œdrbdsetupå‘½ä»¤ï¼Œä»¥åŠ/etc /init.d/drbdå¯åŠ¨è„šæœ¬ã€‚</p><ul><li>å¤‡ç”¨èŠ‚ç‚¹å®‰è£…DRBD</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># yum -y install kmod-drbd83 drbd83</span></span><br></pre></td></tr></table></figure><blockquote><p>å®‰è£…å®Œæˆåã€‚é»˜è®¤é…ç½®æ–‡ä»¶/etc/drbd.confï¼Œä»¥ä¸‹æ˜¯ä¸¤å°çš„ä¸»æœºé…ç½®å®ä¾‹:</p></blockquote><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># cat /etc/drbd.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># please have a a look at the example configuration file in</span></span><br><span class="line"><span class="comment"># /usr/share/doc/drbd83/drbd.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># drbd.conf</span></span><br><span class="line"><span class="comment"># create by dba.gao@gmail.com at 2010-10-11</span></span><br><span class="line">global &#123;</span><br><span class="line">    <span class="comment"># minor-count 64;</span></span><br><span class="line">    <span class="comment"># dialog-refresh 5; # 5 seconds</span></span><br><span class="line">    <span class="comment"># disable-ip-verification;</span></span><br><span class="line">usage-count no; <span class="comment">#æ˜¯å¦å‚åŠ DRBDä½¿ç”¨è€…ç»Ÿè®¡ï¼Œé»˜è®¤yes</span></span><br><span class="line">&#125;</span><br><span class="line">common &#123;</span><br><span class="line">    syncer &#123; rate <span class="comment">#è®¾ç½®ä¸»å¤‡èŠ‚ç‚¹åŒæ­¥æ—¶çš„ç½‘ç»œé€Ÿç‡æœ€å¤§å€¼ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚</span></span><br><span class="line">        200M; &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource r0 &#123;</span><br><span class="line">protocol C;</span><br><span class="line"><span class="comment"># ä½¿ç”¨drbdçš„ç¬¬ä¸‰ç§åŒæ­¥åè®®,è¡¨ç¤ºæ”¶åˆ°è¿œç¨‹ä¸»æœºçš„å†™å…¥ç¡®è®¤å,åˆ™è®¤ä¸ºå†™å…¥å®Œæˆ</span></span><br><span class="line">handlers &#123;</span><br><span class="line">    pri-on-incon-degr <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">    pri-lost-after-sb <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">    <span class="built_in">local</span>-io-error <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">fence-peer <span class="string">"/usr/lib64/heartbeat/drbd-peer-outdater -t 5"</span>;</span><br><span class="line">pri-lost <span class="string">"echo pri-lost. Have a look at the log files. | mail -s 'DRBD Alert' root"</span>;</span><br><span class="line">    split-brain <span class="string">"/usr/lib/drbd/notify-split-brain.sh root"</span>;</span><br><span class="line">    out-of-sync <span class="string">"/usr/lib/drbd/notify-out-of-sync.sh root"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">net &#123;</span><br><span class="line"><span class="comment"># timeout 60;</span></span><br><span class="line"><span class="comment"># connect-int 10;</span></span><br><span class="line"><span class="comment"># ping-int 10;</span></span><br><span class="line"><span class="comment"># max-buffers 2048;</span></span><br><span class="line"><span class="comment"># max-epoch-size 2048;</span></span><br><span class="line">cram-hmac-alg <span class="string">"sha1"</span>;</span><br><span class="line">shared-secret <span class="string">"MySQL-HA"</span>;</span><br><span class="line"><span class="comment"># DRBDåŒæ­¥æ—¶ä½¿ç”¨çš„éªŒè¯æ–¹å¼å’Œå¯†ç ä¿¡æ¯ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line">disk &#123;</span><br><span class="line">    on-io-error detach;</span><br><span class="line">fencing resource-only;</span><br><span class="line">&#125;</span><br><span class="line">startup &#123;</span><br><span class="line">    wfc-timeout 120;</span><br><span class="line">    degr-wfc-timeout 120;</span><br><span class="line">  &#125;</span><br><span class="line">  device        /dev/drbd0;</span><br><span class="line"><span class="comment">#è¿™é‡Œé…ç½®æ¡£æˆ‘ä»¬æŒ‚åœ¨çš„ç³»ç»Ÿçš„ç£ç›˜æ ‡ç¤ºé©±åŠ¨ç›˜ç¬¦; on node2 &#123;</span></span><br><span class="line"><span class="comment">#æ¯ä¸ªä¸»æœºçš„è¯´æ˜ä»¥onå¼€å¤´,åé¢æ˜¯hostname(uname - n)ï¼Œåœ¨åé¢çš„&#123;&#125;ä¸­ä¸ºè¿™ä¸ªä¸»æœºçš„é…ç½®ã€‚</span></span><br><span class="line">disk /dev/sdb5;</span><br><span class="line"><span class="comment">#/dev/drbd0ä½¿ç”¨çš„ç£ç›˜åˆ†åŒºæ˜¯/dev/sdb5</span></span><br><span class="line">address     192.168.1.101:7788;</span><br><span class="line">IPåœ°å€ä»¥åŠDRBDä½¿ç”¨çš„ç«¯å£ meta-disk internal;</span><br><span class="line">&#125;</span><br><span class="line">on node1 &#123;</span><br><span class="line">disk /dev/sdb5;</span><br><span class="line">address 192.168.1.102:7788; å’Œä¸Šè¿°ä¸€æ ·</span><br><span class="line">meta-disk internal; <span class="comment">#drbdçš„å…ƒæ•°æ®å­˜æ”¾æ–¹å¼ &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆåå¯åŠ¨èŠ‚ç‚¹ï¼Œåœ¨å¯åŠ¨DRBDä¹‹å‰,ä½ éœ€è¦åˆ†åˆ«åœ¨ä¸¤å°ä¸»æœºçš„hdåˆ†åŒºä¸Š,åˆ›å»ºä¾›DRBDè®°å½•ä¿¡æ¯çš„æ•°æ®å—.åˆ†åˆ«åœ¨ä¸¤å°ä¸»æœºä¸Šæ‰§è¡Œ(è¿™é‡Œæ³¨æ„:åœ¨åˆ›å»ºåˆ†åŒºä¹‹å‰æˆ‘ä»¬éœ€è¦å§ç£ç›˜çš„åˆ†åŒºåˆ†å¥½)</p><p><img src alt="img"></p><p>åˆ†åŒºåˆ†å¥½ä»¥åå…ˆä¸è¦æŒ‚åœ¨å’Œæ ¼å¼åŒ–(æŒ‚åœ¨ä»¥ååˆ›å»ºä¼šæŠ¥é”™)ï¼Œç„¶ååˆ›å»ºä¾›DRBDè®° å½•ä¿¡æ¯çš„æ•°æ®å—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># drbdadm create-md r0</span></span><br><span class="line">[root@node1 ~]<span class="comment"># drbdadm create-md r0</span></span><br><span class="line">æˆ–è€…æ‰§è¡Œdrbdadm create-md all</span><br></pre></td></tr></table></figure><ul><li><p>åœ¨ä¸¤ä¸ªèŠ‚ç‚¹å¯åŠ¨æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># /etc/init.d/drbd start</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /etc/init.d/drbd start</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨ä»»æ„èŠ‚ç‚¹æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</p></li></ul><blockquote><p>1: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C râ€”-<br>ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:2007644</p></blockquote><blockquote><p>å¯¹è¾“å‡ºçš„å«ä¹‰è§£é‡Šå¦‚ä¸‹:<br>roè¡¨ç¤ºè§’è‰²ä¿¡æ¯ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨drbdæ—¶ï¼Œä¸¤ä¸ªdrbdèŠ‚ç‚¹é»˜è®¤éƒ½å¤„äºSecondaryçŠ¶æ€,<br>dsæ˜¯ç£ç›˜çŠ¶æ€ä¿¡æ¯ï¼Œâ€œInconsistent/Inconsistenâ€ï¼Œå³ä¸ºâ€œä¸ä¸€è‡´/ä¸ä¸€è‡´â€ çŠ¶æ€ï¼Œè¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹çš„ç£ç›˜æ•°æ®å¤„äºä¸ä¸€è‡´çŠ¶æ€ã€‚<br>Nsè¡¨ç¤ºç½‘ç»œå‘é€çš„æ•°æ®åŒ…ä¿¡æ¯ã€‚</p></blockquote><h3 id="è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2"><a href="#è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2" class="headerlink" title="è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2"></a>è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># drbdsetup /dev/drbd1 primary â€“o æˆ–è€…æ‰§è¡Œä¸‹é¢å‘½ä»¤ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line">[root@node2 ~]<span class="comment">#drbdadm -- --overwrite-data-of-peer primary all</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæ­¤å‘½ä»¤åï¼Œåœ¨åé¢å¦‚æœéœ€è¦è®¾ç½®å“ªä¸ªæ˜¯ä¸»èŠ‚ç‚¹æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨å¦ å¤–ä¸€ä¸ªå‘½ä»¤:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment">#/sbin/drbdadm primary r0æˆ–è€…/sbin/drbdadm primary all</span></span><br></pre></td></tr></table></figure><blockquote><p>æ‰§è¡Œæ­¤å‘½ä»¤åï¼Œå¼€å§‹åŒæ­¥ä¸¤å°æœºå™¨å¯¹åº”ç£ç›˜çš„æ•°æ®</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ node2 ~]<span class="comment">#cat /proc/drbd</span></span><br><span class="line">1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r--- -</span><br><span class="line">ns:576224 nr:0 dw:0 dr:581760 al:0 bm:34 lo:84 pe:369 ua:256 ap:0 ep:1 wo:b oos:1443196</span><br><span class="line">[====&gt;...............] sync<span class="string">'ed: 28.4% (1443196/2007644)K delay_probe: 69</span></span><br><span class="line"><span class="string">finish: 0:03:56 speed: 6,024 (5,876) K/sec</span></span><br></pre></td></tr></table></figure><blockquote><p>æœ€åæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ,ç”±äºmountæ“ä½œåªèƒ½åœ¨ä¸»èŠ‚ç‚¹è¿›è¡Œï¼Œæ‰€ä»¥åªæœ‰è®¾ç½®äº†ä¸»èŠ‚ç‚¹åæ‰èƒ½æ ¼å¼åŒ–ç£ç›˜åˆ† åŒºï¼Œç„¶åæŒ‚è½½:</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># mkfs -t ext3 /dev/drbd0</span></span><br><span class="line">[root@node2 ~]<span class="comment"># mount /dev/drbd0 /data/</span></span><br><span class="line">[root@node2 ~]<span class="comment"># df -h</span></span><br><span class="line">Filesystem</span><br><span class="line">/dev/sda3</span><br><span class="line">/dev/sda1</span><br><span class="line">tmpfs</span><br><span class="line">/dev/drbd0</span><br><span class="line">Size  Used Avail Use% Mounted on</span><br><span class="line"> 28G  3.7G   23G  15% /</span><br><span class="line">487M   22M  440M   5% /boot</span><br><span class="line">125M     0  125M   0% /dev/shm</span><br><span class="line">9.9G  151M  9.2G   2% /data</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;Dwæ˜¯ç£ç›˜å†™ä¿¡æ¯;Dræ˜¯ç£ç›˜è¯»ä¿¡æ¯;å¯åŠ¨DRBDåè®¾ç½®ä¸»æ¬¡èŠ‚ç‚¹ï¼Œé€‰æ‹©éœ€è¦è®¾ç½®ä¸»æœºçš„ä¸»èŠ‚ç‚¹ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤: è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>å­˜å‚¨,Centos</category>
      </categories>
      <tags>
        <tag>drdb</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle ORA-12519</title>
    <url>/2019/08/10/oracle-ORA-12519/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><blockquote><p>oracle ORA-12519é”™è¯¯è§£å†³<br>ä»Šå¤©é‡åˆ°åšç³»ç»Ÿå‹åŠ›æµ‹è¯•çš„æ—¶å€™ï¼Œç³»ç»ŸæŠ¥äº†ä¸€ä¸ªé”™è¯¯<br>OERR: ORA-12519 TNS:no appropriate service handler found</p></blockquote><p><img src="https://img.xxlaila.cn/ORA-12519-error.png" alt="img"></p><p>åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€ä¸‹oralcçš„é”™è¯¯ä¿¡æ¯ORA-12519ï¼Œè§£å†³åŠæ³•æŒºå¤šçš„ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p><h3 id="ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“"><a href="#ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“" class="headerlink" title="ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“"></a>ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlplus <span class="string">"/as sysdba"</span></span><br></pre></td></tr></table></figure><blockquote><p>é¦–å…ˆæ£€æŸ¥processå’Œsessionçš„ä½¿ç”¨æƒ…å†µ</p></blockquote><p><img src="https://img.xxlaila.cn/parameter_%20processes_1.png" alt="img"><br><img src="https://img.xxlaila.cn/parameter_%20session_3.png" alt="img"></p><a id="more"></a><ul><li>è¿™é‡Œå¯ä»¥çœ‹åˆ°processå‡ ä¹å·²ç»æ»¡äº†</li></ul><h3 id="ä¿®æ”¹oracleçš„processå’Œsessionå€¼"><a href="#ä¿®æ”¹oracleçš„processå’Œsessionå€¼" class="headerlink" title="ä¿®æ”¹oracleçš„processå’Œsessionå€¼"></a>ä¿®æ”¹oracleçš„processå’Œsessionå€¼</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œæˆ‘ä»¬æŠŠè¿™äº›å€¼ä¿®æ”¹ä¸º1000å’Œ1135</span><br><span class="line">SQL&gt; alter system <span class="built_in">set</span> processes=1000 scope=spfile;</span><br><span class="line">ç³»ç»Ÿå·²æ›´æ”¹ã€‚</span><br><span class="line">SQL&gt; alter system <span class="built_in">set</span> sessions=1135 scope=spfile;</span><br><span class="line">ç³»ç»Ÿå·²æ›´æ”¹ã€‚</span><br></pre></td></tr></table></figure><h3 id="é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ"><a href="#é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ" class="headerlink" title="é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ"></a>é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; shutdown abort;</span><br><span class="line">ORACLE ä¾‹ç¨‹å·²ç»å…³é—­ã€‚</span><br><span class="line">SQL&gt; startup;</span><br><span class="line">ORACLE ä¾‹ç¨‹å·²ç»å¯åŠ¨ã€‚</span><br><span class="line">Total System Global Area  534462464 bytes</span><br><span class="line">Fixed Size                  2215064 bytes</span><br><span class="line">Variable Size             234881896 bytes</span><br><span class="line">Database Buffers          289406976 bytes</span><br><span class="line">Redo Buffers                7958528 bytes</span><br><span class="line">æ•°æ®åº“è£…è½½å®Œæ¯•ã€‚</span><br><span class="line">æ•°æ®åº“å·²ç»æ‰“å¼€ã€‚</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹å¹¶éªŒè¯"><a href="#æŸ¥çœ‹å¹¶éªŒè¯" class="headerlink" title="æŸ¥çœ‹å¹¶éªŒè¯"></a>æŸ¥çœ‹å¹¶éªŒè¯</h2><p><img src="https://img.xxlaila.cn/W.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>oracle</category>
      </categories>
      <tags>
        <tag>ORA-12519</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx https</title>
    <url>/2019/08/10/nginx-https/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>nginx http å¼ºåˆ¶è·³è½¬åˆ°https</p><h2 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$server_port</span> = 80 ) &#123;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$server_port</span> = 80 ) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123; <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>; &#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$host</span> != xxx.test.com) &#123; <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://xxx.test.com<span class="variable">$request_uri</span>; &#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123; <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$host</span> != xxx.test.com) &#123; <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://xxx.test.com<span class="variable">$request_uri</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•å››"><a href="#æ–¹æ³•å››" class="headerlink" title="æ–¹æ³•å››"></a>æ–¹æ³•å››</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    rewrite ^(.*) https://www.test.com<span class="variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¾‹å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    rewrite ^(.*) https://www.test.com<span class="variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    root ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•äº”"><a href="#æ–¹æ³•äº”" class="headerlink" title="æ–¹æ³•äº”"></a>æ–¹æ³•äº”</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>https</tag>
      </tags>
  </entry>
  <entry>
    <title>haproxy keepalived </title>
    <url>/2019/08/10/haproxy-keepalived/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>æœ¬æ–‡ä¸»è¦æ˜¯ä»£ç†kubernetes masterçš„é«˜å¯ç”¨ã€‚</p><h2 id="å®‰è£…haproxyå’Œkeepalived"><a href="#å®‰è£…haproxyå’Œkeepalived" class="headerlink" title="å®‰è£…haproxyå’Œkeepalived"></a>å®‰è£…haproxyå’Œkeepalived</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install keepalived.x86_64</span></span><br><span class="line"><span class="comment"># yum -y install haproxy18u.x86_64</span></span><br></pre></td></tr></table></figure><h2 id="2ã€é…ç½®haproxy"><a href="#2ã€é…ç½®haproxy" class="headerlink" title="2ã€é…ç½®haproxy"></a>2ã€é…ç½®haproxy</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/haproxy/haproxy.cfg</span></span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  uid 99</span><br><span class="line">  gid 99</span><br><span class="line">  <span class="comment">#daemon</span></span><br><span class="line">  nbproc 1</span><br><span class="line">  pidfile haproxy.pid</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  retries 3</span><br><span class="line">  timeout connect 5s</span><br><span class="line">  timeout client 30s</span><br><span class="line">  timeout server 30s</span><br><span class="line">  timeout check 2s</span><br><span class="line"></span><br><span class="line">listen admin_stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:1080</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  stats refresh 30s</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    admin:admin1</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats admin <span class="keyword">if</span> TRUE</span><br><span class="line"></span><br><span class="line">frontend k8s-https</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  default_backend k8s-http</span><br><span class="line"></span><br><span class="line">backend k8s-http</span><br><span class="line">  mode tcp</span><br><span class="line">  balance roundrobin</span><br><span class="line">  server k8s-master-01 172.21.17.4:6443</span><br><span class="line">  server k8s-master-02 172.21.16.230:6443</span><br><span class="line">  server k8s-master-03 172.21.240:6443</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="3ã€keepalivedé…ç½®"><a href="#3ã€keepalivedé…ç½®" class="headerlink" title="3ã€keepalivedé…ç½®"></a>3ã€keepalivedé…ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  notification_email &#123;</span><br><span class="line">    cq_xxlaila@163.com</span><br><span class="line">    &#125;</span><br><span class="line">  notification_email_from cq_xxlaila@163.com</span><br><span class="line">  smtp_server 127.0.0.1</span><br><span class="line">  smtp_connect_timeout 30</span><br><span class="line">  router_id haproxy-01</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/haproxy_check.sh"</span></span><br><span class="line">  interval 2</span><br><span class="line">  timeout 2</span><br><span class="line">  fall 3</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    dont_track_primary</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass 57D0BC82E074C9D6</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      172.21.16.45</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç›‘æµ‹è„šæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat haproxy_check.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">A=`ps -C haproxy --no-header | wc -l`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$A</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    systemctl start haproxy</span><br><span class="line">    sleep 3</span><br><span class="line">    <span class="keyword">if</span> [ `ps -C haproxy --no-header | wc -l ` -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        systemctl stop haproxy</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æœåŠ¡</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl enable haproxy &amp;&amp;systemctl enable keepalived</span></span><br><span class="line"><span class="comment"># systemctl start keepalived &amp;&amp;systemctl start haproxy</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>haproxy,keepalived,kubernetes</category>
      </categories>
      <tags>
        <tag>haproxy,keepalived</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s-prometheus</title>
    <url>/2019/08/10/k8s-prometheus/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p><a href="https://prometheus.io/" target="_blank" rel="noopener">Prometheus</a>æ˜¯ä¸€ä¸ªé›†æ•°æ®æ”¶é›†å­˜å‚¨ã€æ•°æ®æŸ¥è¯¢å’Œæ•°æ®å›¾è¡¨æ˜¾ç¤ºäºä¸€èº«çš„å¼€æºç›‘æ§ç»„ä»¶ã€‚æœ¬æ–‡ä¸»è¦è®²è§£å¦‚ä½•æ­å»ºPrometheusï¼Œå¹¶ä½¿ç”¨å®ƒç›‘æ§Kubernetesé›†ç¾¤ã€‚</p><h2 id="1ã€ä¸‹è½½ç›¸å…³yaml"><a href="#1ã€ä¸‹è½½ç›¸å…³yaml" class="headerlink" title="1ã€ä¸‹è½½ç›¸å…³yaml"></a>1ã€ä¸‹è½½ç›¸å…³yaml</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/xxlaila/kubernetes-yaml/tree/master/prometheus-grafana</span></span><br><span class="line"><span class="comment"># ls -l</span></span><br><span class="line">configmap.yaml</span><br><span class="line">grafana-deploy.yaml</span><br><span class="line">grafana-ingress.yaml</span><br><span class="line">grafana-svc.yaml</span><br><span class="line">node-exporter.yaml</span><br><span class="line">prometheus-deploy.yaml</span><br><span class="line">prometheus-svc.yaml</span><br><span class="line">rbac-setup.yaml</span><br><span class="line">prometheus-ingress.yaml</span><br></pre></td></tr></table></figure><h2 id="2ã€å¼€å§‹éƒ¨ç½²"><a href="#2ã€å¼€å§‹éƒ¨ç½²" class="headerlink" title="2ã€å¼€å§‹éƒ¨ç½²"></a>2ã€å¼€å§‹éƒ¨ç½²</h2><h3 id="2-1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶"><a href="#2-1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶" class="headerlink" title="2.1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶"></a>2.1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f  node-exporter.yaml</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2-2ã€éƒ¨ç½²prometheusç»„ä»¶"><a href="#2-2ã€éƒ¨ç½²prometheusç»„ä»¶" class="headerlink" title="2.2ã€éƒ¨ç½²prometheusç»„ä»¶"></a>2.2ã€éƒ¨ç½²prometheusç»„ä»¶</h3><h4 id="2-2-1ã€rbacæ–‡ä»¶"><a href="#2-2-1ã€rbacæ–‡ä»¶" class="headerlink" title="2.2.1ã€rbacæ–‡ä»¶"></a>2.2.1ã€rbacæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f rbac-setup.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶"><a href="#2-2-2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶" class="headerlink" title="2.2.2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶"></a>2.2.2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f configmap.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3ã€Prometheus-deployment-æ–‡ä»¶"><a href="#2-2-3ã€Prometheus-deployment-æ–‡ä»¶" class="headerlink" title="2.2.3ã€Prometheus deployment æ–‡ä»¶"></a>2.2.3ã€Prometheus deployment æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f  prometheus-deploy.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-4ã€Prometheus-serviceæ–‡ä»¶"><a href="#2-2-4ã€Prometheus-serviceæ–‡ä»¶" class="headerlink" title="2.2.4ã€Prometheus serviceæ–‡ä»¶"></a>2.2.4ã€Prometheus serviceæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f prometheus-svc.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-5ã€é…ç½®Ingress"><a href="#2-2-5ã€é…ç½®Ingress" class="headerlink" title="2.2.5ã€é…ç½®Ingress"></a>2.2.5ã€é…ç½®Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f prometheus-ingress.yaml</span></span><br></pre></td></tr></table></figure><h3 id="2-3ã€éƒ¨ç½²grafanaç»„ä»¶"><a href="#2-3ã€éƒ¨ç½²grafanaç»„ä»¶" class="headerlink" title="2.3ã€éƒ¨ç½²grafanaç»„ä»¶"></a>2.3ã€éƒ¨ç½²grafanaç»„ä»¶</h3><h4 id="2-3-1ã€grafana-deploymenté…ç½®æ–‡ä»¶"><a href="#2-3-1ã€grafana-deploymenté…ç½®æ–‡ä»¶" class="headerlink" title="2.3.1ã€grafana deploymenté…ç½®æ–‡ä»¶"></a>2.3.1ã€grafana deploymenté…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-deploy.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-3-2ã€grafana-serviceé…ç½®æ–‡ä»¶"><a href="#2-3-2ã€grafana-serviceé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.2ã€grafana serviceé…ç½®æ–‡ä»¶"></a>2.3.2ã€grafana serviceé…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-svc.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-3-3ã€grafana-ingressé…ç½®æ–‡ä»¶"><a href="#2-3-3ã€grafana-ingressé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.3ã€grafana ingressé…ç½®æ–‡ä»¶"></a>2.3.3ã€grafana ingressé…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-ingress.yaml</span></span><br></pre></td></tr></table></figure><h3 id="2-4ã€WEBç•Œé¢é…ç½®"><a href="#2-4ã€WEBç•Œé¢é…ç½®" class="headerlink" title="2.4ã€WEBç•Œé¢é…ç½®"></a>2.4ã€WEBç•Œé¢é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc,pods -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/46ds9824.png" alt="img"></p><h4 id="2-4-1-æŸ¥çœ‹node-exporter"><a href="#2-4-1-æŸ¥çœ‹node-exporter" class="headerlink" title="2.4.1 æŸ¥çœ‹node-exporter"></a>2.4.1 æŸ¥çœ‹node-exporter</h4><p><img src="https://img.xxlaila.cn/8764kjfnks.png" alt="img"></p><h4 id="2-4-2ã€æŸ¥çœ‹promethues"><a href="#2-4-2ã€æŸ¥çœ‹promethues" class="headerlink" title="2.4.2ã€æŸ¥çœ‹promethues"></a>2.4.2ã€æŸ¥çœ‹promethues</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;prometheuså¯¹åº”çš„nodeportç«¯å£ä¸º30005ï¼Œé€šè¿‡è®¿é—®<a href="http://172.21.17.4:30005/targets" target="_blank" rel="noopener">http://172.21.17.4:30005/targets</a> å¯ä»¥çœ‹åˆ°prometheuså·²ç»æˆåŠŸè¿æ¥ä¸Šäº†k8sçš„apiserver,è¿™é‡Œæˆ‘ä»¬å‰é¢å¢åŠ äº†prometheusçš„ingressï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥é€šè¿‡åŸŸåè¿›è¡Œè®¿é—®</p><p><img src="https://img.xxlaila.cn/skd9234342.png" alt="img"></p><h4 id="2-4-3ã€è®¿é—®grafana"><a href="#2-4-3ã€è®¿é—®grafana" class="headerlink" title="2.4.3ã€è®¿é—®grafana"></a>2.4.3ã€è®¿é—®grafana</h4><p>é€šè¿‡åŸŸåè®¿é—®grafanaï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç å‡ä¸ºadminï¼Œé…ç½®æ•°æ®æº<br><img src="https://img.xxlaila.cn/sld023423.png" alt="img"></p><ul><li>åˆ°grafanaå®˜æ–¹<a href="https://grafana.com/dashboards/315" target="_blank" rel="noopener">ä¸‹è½½æ¨¡ç‰ˆ</a>ï¼Œå¯¼å…¥jsonæ¨¡ç‰ˆ</li></ul><p><img src="https://img.xxlaila.cn/kf24skdsfds.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>kubednsæ’ä»¶é…ç½®</title>
    <url>/2019/08/10/kubedns%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h1 id="å®‰è£…å’Œé…ç½®kubednsæ’ä»¶"><a href="#å®‰è£…å’Œé…ç½®kubednsæ’ä»¶" class="headerlink" title="å®‰è£…å’Œé…ç½®kubednsæ’ä»¶"></a>å®‰è£…å’Œé…ç½®kubednsæ’ä»¶</h1><h2 id="1ã€é…ç½®æ–‡ä»¶å‡†å¤‡"><a href="#1ã€é…ç½®æ–‡ä»¶å‡†å¤‡" class="headerlink" title="1ã€é…ç½®æ–‡ä»¶å‡†å¤‡"></a>1ã€é…ç½®æ–‡ä»¶å‡†å¤‡</h2><p>ä¸‹è½½å®˜æ–¹çš„yamlæ–‡ä»¶ç›®å½•ï¼škubernetes/cluster/addons/dnsã€‚è¯¥æ’ä»¶ç›´æ¥ä½¿ç”¨kuberneteséƒ¨ç½²,yamlæ–‡ä»¶ç»è¿‡ä¿®æ”¹å®Œæˆéƒ¨ç½²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/coredns</span></span><br><span class="line"><span class="comment"># sed -i 's/10.96.0.10/10.254.0.2/g' coredns-service.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods,svc,rs -n kube-system</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-68676b6b88-l7b5g   1/1     Running   0          16m</span><br><span class="line"></span><br><span class="line">NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/coredns   ClusterIP   10.254.0.2   &lt;none&gt;        53/UDP,53/TCP   16m</span><br><span class="line"></span><br><span class="line">NAME                                       DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.extensions/coredns-68676b6b88   1         1         1       16m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-68676b6b88-l7b5g                1/1     Running   0          40m     10.254.28.2   172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…å’Œé…ç½®dashboard"><a href="#2ã€å®‰è£…å’Œé…ç½®dashboard" class="headerlink" title="2ã€å®‰è£…å’Œé…ç½®dashboard"></a>2ã€å®‰è£…å’Œé…ç½®dashboard</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;å®˜æ–¹é…ç½®æ–‡ä»¶kubernetes/cluster/addons/dashboardï¼Œè¿™é‡Œå·²ç»ä¿®æ”¹è¿‡äº†ï¼Œç»è¿‡æµ‹è¯•éƒ¨ç½²ï¼Œç›´æ¥è¿›å…¥dashboardç›®å½•ï¼Œä¿®æ”¹inageså‚æ•°è¿›è¡Œéƒ¨ç½²</p><a id="more"></a><h3 id="2-1ã€å®‰è£…dashboard"><a href="#2-1ã€å®‰è£…dashboard" class="headerlink" title="2.1ã€å®‰è£…dashboard"></a>2.1ã€å®‰è£…dashboard</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ../kubernetes-dashboard</span></span><br><span class="line"><span class="comment"># kubectl create -f kubernetes-dashboard.yaml </span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">kubernetes-dashboard-6c655d9445-4557x   1/1     Running   0          6m54s   10.254.90.2   172.21.16.110   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="2-2ã€é…ç½®è´¦æˆ·æˆæƒ"><a href="#2-2ã€é…ç½®è´¦æˆ·æˆæƒ" class="headerlink" title="2.2ã€é…ç½®è´¦æˆ·æˆæƒ"></a>2.2ã€é…ç½®è´¦æˆ·æˆæƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f admin-user.yaml </span></span><br><span class="line">serviceaccount/admin created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin created</span><br><span class="line"><span class="comment"># kubectl describe serviceaccount admin -n kube-system</span></span><br><span class="line">Name:                admin</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   admin-token-wwjw8</span><br><span class="line">Tokens:              admin-token-wwjw8</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"><span class="comment"># kubectl describe secret admin-token-wwjw8 -n kube-system</span></span><br><span class="line">åœ¨æµè§ˆå™¨è®¿é—®ä»»æ„èŠ‚ç‚¹IPåœ°å€http://&lt;node_ip&gt;:30001</span><br></pre></td></tr></table></figure><h2 id="3ã€ç›‘æ§å®‰è£…"><a href="#3ã€ç›‘æ§å®‰è£…" class="headerlink" title="3ã€ç›‘æ§å®‰è£…"></a>3ã€ç›‘æ§å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ../heapster-influxdb-grafana</span></span><br><span class="line"><span class="comment"># kubectl create -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE   IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">heapster-658646db69-lh5tx               1/1     Running   0          11m   10.254.28.3   172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">monitoring-grafana-7bfc56ffcd-kgh56     1/1     Running   0          11m   10.254.90.3   172.21.16.110   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">monitoring-influxdb-7478d7675c-9255v    1/1     Running   0          11m   10.254.85.2   172.21.16.244   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé‡åˆ°ä¸€ä¸ªæ€ªäº‹æƒ…ï¼›heapsterå®‰è£…ä»¥åå›¾å§‹ç»ˆæ— æ³•å‡ºæ¥ï¼Œè¿™é‡ŒæŠ˜è…¾å·®ä¸å¤šå¤§åŠå¤©ã€‚æœ€ååœ¨dashboardçš„yamlæ–‡ä»¶é‡Œé¢æ·»åŠ äº†ä»¥ä¸‹å‚æ•°ï¼Œå›¾å°±å¯ä»¥äº†ï¼Œ</p><p><img src="https://img.xxlaila.cn/4udfs93.png" alt="img"></p><p>args:<br>- â€“auto-generate-certificates<br>- â€“token-ttl=43200<br><em>- â€“heapster-host=<a href="http://heapster" target="_blank" rel="noopener">http://heapster</a></em></p><p><img src="https://img.xxlaila.cn/ds832948dk.png" alt="img"></p><p>Prometheusçš„å®‰è£…è¯·å‚è€ƒ<a href="http://xxlaila.github.io/2019/08/10/k8s-prometheus/" target="_blank" rel="noopener">ã€ŠPrometheus å…¥é—¨ã€‹</a>æ–‡ç« ï¼Œgrafanaä¸éœ€è¦é‡å¤éƒ¨ç½²ã€‚åªéœ€è¦åœ¨grafanaé‡Œé¢å¢åŠ ç›®å½•æŒ‚åœ¨ï¼Œå§kube-ops ä¿®æ”¹kube-systemå³å¯</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kube-dns,dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes nodeèŠ‚ç‚¹å®‰è£…</title>
    <url>/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>More: <a href="https://xxlaila.github.io/2019/08/09/kubernetes-v1-13-3%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">masterèŠ‚ç‚¹å®‰è£…è¯·å‚è€ƒ</a></p><h2 id="1ã€éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹"><a href="#1ã€éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹" class="headerlink" title="1ã€éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹"></a>1ã€éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹</h2><p>Kubernetes nodeèŠ‚ç‚¹åŒ…å«å¦‚ä¸‹ç»„ä»¶ï¼š</p><ul><li><strong>Flanneld</strong>: ä¹‹å‰å•æœºèŠ‚ç‚¹å®‰è£…æ²¡æœ‰é…ç½®TLSï¼Œç°åœ¨éœ€è¦åœ¨serviceé…ç½®æ–‡ä»¶ä¸­å¢åŠ TLSé…ç½®</li><li><strong>Docker</strong>: version 18.06.2-ce</li><li><strong>kubelet</strong></li><li><strong>kube-proxy</strong></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls /etc/kubernetes/</span></span><br><span class="line">bootstrap.kubeconfig  kubelet   kube-proxy.kubeconfig  proxy  ssl</span><br><span class="line"><span class="comment"># ls /etc/kubernetes/ssl</span></span><br><span class="line">admin-key.pem  kube-apiserver-key.pem  kube-controller-manager-key.pem  kubelet-api-admin-key.pem   kube-proxy-key.pem  kubernetes-ca-key.pem  kube-scheduler-key.pem</span><br><span class="line">admin.pem      kube-apiserver.pem      kube-controller-manager.pem      kubelet-api-admin.pem       kube-proxy.pem      kubernetes-ca.pem      kube-scheduler.pem</span><br></pre></td></tr></table></figure><h3 id="å¢åŠ docker-æº"><a href="#å¢åŠ docker-æº" class="headerlink" title="å¢åŠ docker æº"></a>å¢åŠ docker æº</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum-config-manager \</span></span><br><span class="line">  --add-repo \</span><br><span class="line">  https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><ul><li><p>æ ¹æ®å®é™…æŸ¥æ‰¾å½“å‰ç‰ˆæœ¬ (å¯é€‰)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum list docker-ce --showduplicates | sort -r</span></span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœç¡®å®šäº†ç‰ˆæœ¬,ç›´æ¥å®‰è£…,å¦‚æœè¦è£…17ã€‚03ç›´æ¥ä¿®æ”¹ä¸‹é¢æ•°å­—å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install docker-ce-18.06.2.ce-3.el7  # ä¸»æ„ç‰ˆæœ¬å¡«å†™åŒ…åçš„æ ¼å¼.</span></span><br></pre></td></tr></table></figure></li><li><p>å¯dockeræœåŠ¡,å’Œå¼€æœºå¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="1-1ã€å®‰è£…flanneld"><a href="#1-1ã€å®‰è£…flanneld" class="headerlink" title="1.1ã€å®‰è£…flanneld"></a>1.1ã€å®‰è£…flanneld</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mv kubernetes  /etc/ &amp;&amp; chown -R root: /etc/kubernetes</span></span><br><span class="line"><span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf flannel-v0.11.0-linux-amd64.tar.gz &amp;&amp; mv flanneld mk-docker-opts.sh /usr/bin/ &amp;&amp; rm -rf flannel-v0.11.0-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><h4 id="1-1-1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶"><a href="#1-1-1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶" class="headerlink" title="1.1.1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶"></a>1.1.1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/flanneld.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=etcd.service</span><br><span class="line">Before=docker.service</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/etc/sysconfig/flanneld</span><br><span class="line">ExecStart=/usr/bin/flanneld -etcd-endpoints=<span class="variable">$&#123;FLANNEL_ETCD&#125;</span> <span class="variable">$FLANNEL_OPTIONS</span></span><br><span class="line">ExecStartPost=/usr/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">RequiredBy=docker.service</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-1-2ã€flanneldé…ç½®æ–‡ä»¶"><a href="#1-1-2ã€flanneldé…ç½®æ–‡ä»¶" class="headerlink" title="1.1.2ã€flanneldé…ç½®æ–‡ä»¶"></a>1.1.2ã€flanneldé…ç½®æ–‡ä»¶</h4><p>flanneld é…ç½®æ–‡ä»¶è¿æ¥äº†etcdï¼Œè€Œåœ¨é…ç½®etcdçš„æ—¶å€™éœ€è¦è¯ä¹¦ï¼Œæ‰€ä»¥è®°çš„å§è¯ä¹¦copyåˆ°nodeèŠ‚ç‚¹ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/sysconfig/flanneld</span></span><br><span class="line"><span class="comment"># Flanneld configuration options</span></span><br><span class="line"><span class="comment"># etcd url location.  Point this to the server where etcd runs</span></span><br><span class="line">FLANNEL_ETCD=<span class="string">"https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379"</span></span><br><span class="line"><span class="comment"># etcd config key.  This is the configuration key that flannel queries</span></span><br><span class="line"><span class="comment"># For address range assignment</span></span><br><span class="line">FLANNEL_ETCD_PREFIX=<span class="string">"/coreos.com/network"</span></span><br><span class="line"><span class="comment"># Any additional options that you want to pass</span></span><br><span class="line">FLANNEL_OPTIONS=<span class="string">"-etcd-cafile=/etc/etcd/ssl/etcd-ca.pem -etcd-certfile=/etc/etcd/ssl/etcd.pem -etcd-keyfile=/etc/etcd/ssl/etcd-key.pem"</span></span><br></pre></td></tr></table></figure><ul><li>åœ¨å¯åŠ¨flanneldä¹‹å‰ï¼Œéœ€è¦åœ¨etcdä¸­æ·»åŠ ä¸€æ¡ç½‘ç»œé…ç½®è®°å½•ï¼Œè¿™ä¸ªé…ç½®å°†ç”¨äºflanneldåˆ†é…ç»™æ¯ä¸ªdockerçš„è™šæ‹Ÿipåœ°å€æ®µ,</li><li>åœ¨ä»»æ„ä¸€å°masteræ‰§è¡Œ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl set /coreos.com/network/config '&#123; "Network": "10.254.0.0/16" &#125;'</span></span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"10.254.0.0/16"</span> &#125;</span><br><span class="line"><span class="comment"># etcdctl get  /coreos.com/network/config </span></span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"10.254.0.0/16"</span> &#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰§è¡Œçš„æ—¶å€™æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºå‰é¢etcdæ˜¯å¯ç”¨äº†httpsçš„ï¼Œå¦åˆ™çš„è¯ï¼Œä¼šæŠ¥<code>Error: client: etcd cluster is unavailable or misconfigured; error #0: x509: certificate signed by unknown authority</code>çš„é”™è¯¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcd.rc</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_ENDPOINT=https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CERT_FILE=/etc/etcd/ssl/etcd.pem</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_KEY_FILE=/etc/etcd/ssl/etcd-key.pem</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CA_FILE=/etc/etcd/ssl/etcd-ca.pem</span><br></pre></td></tr></table></figure><h3 id="1-1-3ã€å¯åŠ¨flanneld"><a href="#1-1-3ã€å¯åŠ¨flanneld" class="headerlink" title="1.1.3ã€å¯åŠ¨flanneld"></a>1.1.3ã€å¯åŠ¨flanneld</h3><p>åœ¨å¯åŠ¨flanneldä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹dockerçš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/docker.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable flanneld &amp;&amp;systemctl start flanneld &amp;&amp;systemctl status flanneld</span></span><br></pre></td></tr></table></figure><p>é‡å¯äº†dockerå’Œflanneldä»¥åï¼Œæˆ‘ä»¬åœ¨ä»»æ„ä¸€å°nodeèŠ‚ç‚¹ä¸Šé€šè¿‡ip add så¯ä»¥æŸ¥çœ‹ã€‚flanneld å’Œdocker ç½‘ç»œç»‘å®šçš„æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip add s</span></span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…å’Œé…ç½®kubelet"><a href="#2ã€å®‰è£…å’Œé…ç½®kubelet" class="headerlink" title="2ã€å®‰è£…å’Œé…ç½®kubelet"></a>2ã€å®‰è£…å’Œé…ç½®kubelet</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;kubeletå¯åŠ¨æ—¶å‘kube-apiserverå‘é€tls bootstrappingè¯·æ±‚ï¼Œéœ€è¦å°†bootstrap tokenæ–‡ä»¶ä¸­kube-bootsrapç”¨æˆ·æˆäºˆsystem:node-bootstrapper clusterè§’è‰²ï¼ˆroleï¼‰ï¼Œç„¶åkubeletæ‰èƒ½æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚ï¼ˆcertificate signing requestsï¼‰</p><h3 id="2-1ã€å®‰è£…kubelet"><a href="#2-1ã€å®‰è£…kubelet" class="headerlink" title="2.1ã€å®‰è£…kubelet"></a>2.1ã€å®‰è£…kubelet</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.13.3/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzf kubernetes-server-linux-amd64.tar.gz &amp;&amp;cp -r ./kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; /usr/bin/ &amp;&amp; rm -rf ./kubernetes*</span></span><br></pre></td></tr></table></figure><h3 id="2-2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶"><a href="#2-2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶" class="headerlink" title="2.2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶"></a>2.2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kubelet.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kubelet</span><br><span class="line">ExecStart=/usr/bin/kubelet \</span><br><span class="line">           <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">           <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">           <span class="variable">$KUBELET_API_SERVER</span> \</span><br><span class="line">           <span class="variable">$KUBELET_ADDRESS</span> \</span><br><span class="line">           <span class="variable">$KUBELET_PORT</span> \</span><br><span class="line">           <span class="variable">$KUBELET_HOSTNAME</span> \</span><br><span class="line">           <span class="variable">$KUBE_ALLOW_PRIV</span> \</span><br><span class="line">           <span class="variable">$KUBELET_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="2-3ã€kubeleté…ç½®æ–‡ä»¶"><a href="#2-3ã€kubeleté…ç½®æ–‡ä»¶" class="headerlink" title="2.3ã€kubeleté…ç½®æ–‡ä»¶"></a>2.3ã€kubeleté…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kubelet</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes kubelet (minion) config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span></span><br><span class="line">KUBELET_ADDRESS=<span class="string">"--node-ip=&#123;node_ip&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The port for the info server to serve on</span></span><br><span class="line"><span class="comment"># KUBELET_PORT="--port=10250"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may leave this blank to use the actual hostname</span></span><br><span class="line">KUBELET_HOSTNAME=<span class="string">"--hostname-override=&#123;node_ip&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># location of the api-server</span></span><br><span class="line"><span class="comment"># KUBELET_API_SERVER=""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBELET_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                --allow-privileged \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --authorization-mode=Webhook \</span></span><br><span class="line"><span class="string">                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --cgroup-driver=cgroupfs \</span></span><br><span class="line"><span class="string">                --cert-dir=/etc/kubernetes/ssl \</span></span><br><span class="line"><span class="string">                --cluster-dns=10.254.0.2 \</span></span><br><span class="line"><span class="string">                --cluster-domain=cluster.local \</span></span><br><span class="line"><span class="string">                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% \</span></span><br><span class="line"><span class="string">                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m \</span></span><br><span class="line"><span class="string">                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% \</span></span><br><span class="line"><span class="string">                --eviction-max-pod-grace-period=30 \</span></span><br><span class="line"><span class="string">                --image-gc-high-threshold=80 \</span></span><br><span class="line"><span class="string">                --image-gc-low-threshold=70 \</span></span><br><span class="line"><span class="string">                --image-pull-progress-deadline=30s \</span></span><br><span class="line"><span class="string">                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">                --max-pods=100 \</span></span><br><span class="line"><span class="string">                --minimum-image-ttl-duration=720h0m0s \</span></span><br><span class="line"><span class="string">                --node-labels=node.kubernetes.io/k8s-node=true \</span></span><br><span class="line"><span class="string">                --pod-infra-container-image=docker.io/kubernetes/pause:latest \</span></span><br><span class="line"><span class="string">                --port=10250 \</span></span><br><span class="line"><span class="string">                --read-only-port=0 \</span></span><br><span class="line"><span class="string">                --rotate-certificates \</span></span><br><span class="line"><span class="string">                --rotate-server-certificates \</span></span><br><span class="line"><span class="string">                --fail-swap-on=false \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure><h3 id="2-4ã€å¯åŠ¨kubelet"><a href="#2-4ã€å¯åŠ¨kubelet" class="headerlink" title="2.4ã€å¯åŠ¨kubelet"></a>2.4ã€å¯åŠ¨kubelet</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /var/lib/kubelet -p</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet &amp;&amp;systemctl start kubelet &amp;&amp; systemctl status kubelet</span></span><br><span class="line"><span class="comment"># journalctl -fxeu kubelet</span></span><br></pre></td></tr></table></figure><h2 id="3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚"><a href="#3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚" class="headerlink" title="3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚"></a>3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚</h2><p>kubeleté¦–æ¬¡å¯åŠ¨æ—¶åƒkube-apiserverå‘é€è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œå¿…é¡»é€šè¿‡åkubernetesç³»ç»Ÿæ‰ä¼šå°†è¯¥nodeåŠ å…¥é›†ç¾¤ï¼š</p><h3 id="3-1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚"><a href="#3-1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚" class="headerlink" title="3.1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚"></a>3.1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚</h3><ul><li>ä»»æ„masterèŠ‚ç‚¹å‡å¯</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE   REQUESTOR                   CONDITION</span><br><span class="line">csr-kxfql                                              78m   system:node:172.21.16.204   Pending</span><br><span class="line">node-csr-QptfMgAu2y4GmUZX1Ph9B0XomA0Rg-fxcgs0Yzd-XRU   79m   system:bootstrap:ff90fd     Approved,Issued</span><br><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure><h3 id="3-2ã€é€šè¿‡csrè¯·æ±‚"><a href="#3-2ã€é€šè¿‡csrè¯·æ±‚" class="headerlink" title="3.2ã€é€šè¿‡csrè¯·æ±‚"></a>3.2ã€é€šè¿‡csrè¯·æ±‚</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl certificate approve csr-kxfql</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-kxfql approved</span><br></pre></td></tr></table></figure><ul><li>è‡ªåŠ¨ç”Ÿæˆkubelet kubeconfigæ–‡ä»¶å’Œå…¬ç§é’¥,æ–°ç‰ˆæœ¬ kubelet server çš„è¯ä¹¦è‡ªåŠ¨ç­¾å‘å·²ç»è¢«å…³é—­,æ‰€ä»¥å¯¹äº kubelet server çš„è¯ä¹¦ä»éœ€è¦æ‰‹åŠ¨ç­¾ç½²</li></ul><h2 id="4ã€é…ç½®kube-proxy"><a href="#4ã€é…ç½®kube-proxy" class="headerlink" title="4ã€é…ç½®kube-proxy"></a>4ã€é…ç½®kube-proxy</h2><h3 id="4-1ã€kupe-proxy-å¯åŠ¨æ–‡ä»¶"><a href="#4-1ã€kupe-proxy-å¯åŠ¨æ–‡ä»¶" class="headerlink" title="4.1ã€kupe-proxy å¯åŠ¨æ–‡ä»¶"></a>4.1ã€kupe-proxy å¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-proxy.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/proxy</span><br><span class="line">ExecStart=/usr/bin/kube-proxy \</span><br><span class="line">       <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">       <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">       <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">       <span class="variable">$KUBE_PROXY_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="4-2ã€kube-proxyé…ç½®æ–‡ä»¶"><a href="#4-2ã€kube-proxyé…ç½®æ–‡ä»¶" class="headerlink" title="4.2ã€kube-proxyé…ç½®æ–‡ä»¶"></a>4.2ã€kube-proxyé…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/proxy</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes proxy config</span></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_PROXY_ARGS=<span class="string">"   --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                    --cleanup-ipvs=true \</span></span><br><span class="line"><span class="string">                    --cluster-cidr=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                    --hostname-override=docker4.node \</span></span><br><span class="line"><span class="string">                    --healthz-bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                    --healthz-port=10256 \</span></span><br><span class="line"><span class="string">                    --masquerade-all=true \</span></span><br><span class="line"><span class="string">                    --proxy-mode=ipvs \</span></span><br><span class="line"><span class="string">                    --ipvs-min-sync-period=5s \</span></span><br><span class="line"><span class="string">                    --ipvs-sync-period=5s \</span></span><br><span class="line"><span class="string">                    --ipvs-scheduler=wrr \</span></span><br><span class="line"><span class="string">                    --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \</span></span><br><span class="line"><span class="string">                    --logtostderr=true \</span></span><br><span class="line"><span class="string">                    --v=2"</span></span><br></pre></td></tr></table></figure><h3 id="4-3ã€å¯åŠ¨kube-proxy"><a href="#4-3ã€å¯åŠ¨kube-proxy" class="headerlink" title="4.3ã€å¯åŠ¨kube-proxy"></a>4.3ã€å¯åŠ¨kube-proxy</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-proxy &amp;&amp; systemctl start kube-proxy &amp;&amp; systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure><h3 id="4-4-åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰"><a href="#4-4-åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰" class="headerlink" title="4.4 åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰"></a>4.4 åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰</h3><p>ç”±äº kubelet ç»„ä»¶æ˜¯é‡‡ç”¨ TLS Bootstrap å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆåˆ›å»ºç›¸å…³é…ç½®</p><ul><li>åˆ›å»ºç”¨äº tls bootstrap çš„ token secret<blockquote><p>masterèŠ‚ç‚¹æ“ä½œ</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f bootstrap.secret.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>ä¸ºäº†èƒ½è®© kubelet å®ç°è‡ªåŠ¨æ›´æ–°è¯ä¹¦ï¼Œéœ€è¦é…ç½®ç›¸å…³ clusterrolebinding</p><ul><li><p>å…è®¸ kubelet tls bootstrap åˆ›å»º csr è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding create-csrs-for-bootstrapping \</span><br><span class="line">    --clusterrole=system:node-bootstrapper \</span><br><span class="line">    --group=system:bootstrappers</span><br></pre></td></tr></table></figure></li><li><p>è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding auto-approve-csrs-for-group \</span><br><span class="line">    --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient \</span><br><span class="line">    --group=system:bootstrappers</span><br></pre></td></tr></table></figure></li><li><p>è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding auto-approve-renewals-for-nodes \</span><br><span class="line">    --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient \</span><br><span class="line">    --group=system:nodes</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ kubelet server å¼€å¯ api è®¤è¯çš„æƒ…å†µä¸‹ï¼Œapiserver åå‘è®¿é—® kubelet 10250 éœ€è¦æ­¤æˆæƒ(eg: kubectl logs)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding system:kubelet-api-admin \</span><br><span class="line">    --clusterrole=system:kubelet-api-admin \</span><br><span class="line">    --user=system:kubelet-api-admin</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>é—®é¢˜</strong>:<br>åœ¨å¯åŠ¨kubeletçš„æ—¶å€™ï¼ŒnodeèŠ‚ç‚¹åœ¨masterèŠ‚ç‚¹æ— æ³•æŸ¥çœ‹ï¼ŒæŸ¥çœ‹kubeletçš„æ—¥å¿—æç¤ºå¦‚ä¸‹ï¼š</li><li>æŸ¥çœ‹kubeletçš„æ—¥å¿—æ–¹å¼æœ‰ä¸¤ç§</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># journalctl -f -u kubelet</span></span><br><span class="line"><span class="comment"># systemctl  status kubelet -l</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹nodes<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.16.244   Ready    &lt;none&gt;   12m   v1.13.3</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>éªŒè¯æµ‹è¯•é›†ç¾¤</strong><br>åˆ›å»ºä¸€ä¸ªnginxæµ‹è¯•é›†ç¾¤æ˜¯å¦å¯ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl run nginx --image=docker.io/nginx:latest --replicas=2 --labels run=nginx</span></span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line"><span class="comment"># kubectl expose deployment nginx --port=80 --type=NodePort</span></span><br><span class="line">service/nginx exposed</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹podæƒ…å†µ</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                     READY   STATUS              RESTARTS   AGE   IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-766994fc9f-gcv4n   0/1     ContainerCreating   0          55s   &lt;none&gt;        172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-766994fc9f-w2j8p   1/1     Running             0          55s   10.254.45.2   172.21.16.83    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹å¯¹å¤–çš„æœåŠ¡</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc nginx</span></span><br><span class="line">NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">nginx   NodePort   10.254.11.147   &lt;none&gt;        80:48713/TCP   31s</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å®Œæˆåï¼Œé€šè¿‡ä»»æ„nodeèŠ‚ç‚¹IPçš„åœ°å€åŠ ç«¯å£48713å³å¯è®¿é—®<br><a href="http://node-ip:48713/" target="_blank" rel="noopener">http://node-ip:48713/</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes v13.3 node</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes v1.13.3å®‰è£…</title>
    <url>/2019/08/09/kubernetes-v1-13-3%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:27 GMT+0800 (China Standard Time) --><h2 id="1ã€-ç¯å¢ƒå‡†å¤‡"><a href="#1ã€-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ ç¯å¢ƒå‡†å¤‡"></a>1ã€ ç¯å¢ƒå‡†å¤‡</h2><table><thead><tr><th>ip</th><th>type</th><th>docker</th><th>os</th><th>k8s version</th></tr></thead><tbody><tr><td>172.21.17.4</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td>v1.13.3</td></tr><tr><td>172.21.16.230</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.240</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.244</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.248</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.45</td><td>vip</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr></tbody></table><h2 id="2ã€éƒ¨ç½²ETCé›†ç¾¤"><a href="#2ã€éƒ¨ç½²ETCé›†ç¾¤" class="headerlink" title="2ã€éƒ¨ç½²ETCé›†ç¾¤"></a>2ã€éƒ¨ç½²ETCé›†ç¾¤</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;etcdçš„æ­£å¸¸è¿è¡Œæ˜¯k8sé›†ç¾¤è¿è¡Œçš„æå‰æ¡ä»¶ï¼Œå› æ­¤éƒ¨ç½²k8sé›†ç¾¤é¦–å…ˆéƒ¨ç½²etcdé›†ç¾¤ã€‚å®‰è£…CAè¯ä¹¦ï¼Œå®‰è£…CFSSLè¯ä¹¦ç®¡ç†å·¥å…·ã€‚ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…</p><a id="more"></a><h3 id="2-1ã€ä¸‹è½½cfssl"><a href="#2-1ã€ä¸‹è½½cfssl" class="headerlink" title="2.1ã€ä¸‹è½½cfssl"></a>2.1ã€ä¸‹è½½cfssl</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -o cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="comment"># chmod +x * &amp;&amp;mv cfssl* /usr/bin/</span></span><br></pre></td></tr></table></figure><h3 id="2-2-ã€åˆ›å»ºetcdè¯ä¹¦"><a href="#2-2-ã€åˆ›å»ºetcdè¯ä¹¦" class="headerlink" title="2.2 ã€åˆ›å»ºetcdè¯ä¹¦"></a>2.2 ã€åˆ›å»ºetcdè¯ä¹¦</h3><ul><li><p>etcd-ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir etcd_ssl &amp;&amp; cd etcd_ssl</span></span><br><span class="line"><span class="comment"># cat etcd-ca-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd-ca"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 4096</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"etcd Security"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"ca"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>etcd-gencert.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat etcd-gencert.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">          <span class="string">"signing"</span>,</span><br><span class="line">          <span class="string">"key encipherment"</span>,</span><br><span class="line">          <span class="string">"server auth"</span>,</span><br><span class="line">          <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>etcd-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat etcd-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"etcd Security"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"172.21.17.4"</span>,</span><br><span class="line">        <span class="string">"172.21.16.231"</span>,</span><br><span class="line">        <span class="string">"172.21.16.240"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥æ‰§è¡Œç”Ÿæˆå³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert --initca=true etcd-ca-csr.json | cfssljson --bare etcd-ca</span></span><br><span class="line"><span class="comment"># cfssl gencert --ca etcd-ca.pem --ca-key etcd-ca-key.pem --config etcd-gencert.json etcd-csr.json | cfssljson --bare etcd</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/etcd/ssl &amp;&amp;mkdir -p /var/lib/etcd</span></span><br><span class="line"><span class="comment"># cp *.pem /etc/etcd/ssl</span></span><br><span class="line"><span class="comment"># ls /etc/etcd/ssl/</span></span><br><span class="line">etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem</span><br><span class="line"><span class="comment"># scp -r /etc/etcd k8s-master-02:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/etcd k8s-master-03:/etc</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="2-3ã€å¼€å§‹é…ç½®etcd"><a href="#2-3ã€å¼€å§‹é…ç½®etcd" class="headerlink" title="2.3ã€å¼€å§‹é…ç½®etcd"></a>2.3ã€å¼€å§‹é…ç½®etcd</h3><h4 id="2-3-1ã€ä¸‹è½½etcd"><a href="#2-3-1ã€ä¸‹è½½etcd" class="headerlink" title="2.3.1ã€ä¸‹è½½etcd"></a>2.3.1ã€ä¸‹è½½etcd</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.3.15/etcd-v3.3.15-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf etcd-v3.3.15-linux-amd64.tar.gz &amp;&amp;cd etcd-v3.3.15-linux-amd64 &amp;&amp;cp -arp etcd* /usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="2-3-2ã€åˆ›å»ºetcdçš„Systemd-unit-æ–‡ä»¶"><a href="#2-3-2ã€åˆ›å»ºetcdçš„Systemd-unit-æ–‡ä»¶" class="headerlink" title="2.3.2ã€åˆ›å»ºetcdçš„Systemd unit æ–‡ä»¶"></a>2.3.2ã€åˆ›å»ºetcdçš„Systemd unit æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;Etcd è¿™é‡Œé‡‡ç”¨æœ€æ–°çš„ 3.3.15 ç‰ˆæœ¬ï¼Œå®‰è£…æ–¹å¼ç›´æ¥å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ã€systemd service é…ç½®å³å¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„ç›¸å…³ç”¨æˆ·æƒé™é—®é¢˜ï¼Œä»¥ä¸‹è„šæœ¬é…ç½®ç­‰å‚è€ƒäº† etcd rpm å®‰è£…åŒ…</p><h4 id="2-3-3ã€é…ç½®etcd-conf"><a href="#2-3-3ã€é…ç½®etcd-conf" class="headerlink" title="2.3.3ã€é…ç½®etcd.conf"></a>2.3.3ã€é…ç½®etcd.conf</h4><ul><li>k8s-master-01<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd1</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.17.4:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.17.4:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.17.4:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.17.4:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p>k8s-master-02</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd2</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.16.231:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.16.231:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.16.231:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.16.231:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li><li><p>k8s-master-03</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd3</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.16.240:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.16.240:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-3-4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶"><a href="#2-3-4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶" class="headerlink" title="2.3.4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶"></a>2.3.4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/etcd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">User=etcd</span><br><span class="line"><span class="comment"># set GOMAXPROCS to number of processors</span></span><br><span class="line">ExecStart=/bin/bash -c <span class="string">"GOMAXPROCS=<span class="variable">$(nproc)</span> /usr/bin/etcd --name=\"<span class="variable">$&#123;ETCD_NAME&#125;</span>\" --data-dir=\"<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span>\" --listen-client-urls=\"<span class="variable">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>\""</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="2-3-5ã€etcdæˆæƒ"><a href="#2-3-5ã€etcdæˆæƒ" class="headerlink" title="2.3.5ã€etcdæˆæƒ"></a>2.3.5ã€etcdæˆæƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># groupadd -r etcd</span></span><br><span class="line"><span class="comment"># useradd -r -g etcd -d /var/lib/etcd -s /sbin/nologin -c "etcd user" etcd</span></span><br><span class="line"><span class="comment"># chown -R etcd:etcd /etc/etcd &amp;&amp; chmod -R 755 /etc/etcd/ssl &amp;&amp;chown -R etcd:etcd /var/lib/etcd</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp;systemctl start etcd &amp;&amp; systemctl status etcd</span></span><br></pre></td></tr></table></figure><h4 id="2-3-6ã€éªŒè¯etcd"><a href="#2-3-6ã€éªŒè¯etcd" class="headerlink" title="2.3.6ã€éªŒè¯etcd"></a>2.3.6ã€éªŒè¯etcd</h4><p>ç”±äºetcdä½¿ç”¨äº†è¯ä¹¦ï¼Œæ‰€ä»¥etcdå‘½ä»¤éœ€è¦å¸¦ä¸Šè¯ä¹¦</p><ul><li><p>æŸ¥çœ‹æˆå‘˜åˆ—è¡¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl --key-file /etc/etcd/ssl/etcd-key.pem --cert-file /etc/etcd/ssl/etcd.pem --ca-file /etc/etcd/ssl/etcd-ca.pem member list</span></span><br><span class="line">93c04a995ff8aa8: name=etcd3 peerURLs=https://172.21.16.240:2380 clientURLs=https://172.21.16.240:2379 isLeader=<span class="literal">false</span></span><br><span class="line">7cc4daf6e4db3a8a: name=etcd2 peerURLs=https://172.21.16.231:2380 clientURLs=https://172.21.16.231:2379 isLeader=<span class="literal">false</span></span><br><span class="line">ec7ea930930d012e: name=etcd1 peerURLs=https://172.21.17.4:2380 clientURLs=https://172.21.17.4:2379 isLeader=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl --key-file /etc/etcd/ssl/etcd-key.pem --cert-file /etc/etcd/ssl/etcd.pem --ca-file /etc/etcd/ssl/etcd-ca.pem cluster-health</span></span><br><span class="line">member 93c04a995ff8aa8 is healthy: got healthy result from https://172.21.16.240:2379</span><br><span class="line">member 7cc4daf6e4db3a8a is healthy: got healthy result from https://172.21.16.231:2379</span><br><span class="line">member ec7ea930930d012e is healthy: got healthy result from https://172.21.17.4:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure></li></ul><h2 id="3ã€éƒ¨ç½²kubernetes"><a href="#3ã€éƒ¨ç½²kubernetes" class="headerlink" title="3ã€éƒ¨ç½²kubernetes"></a>3ã€éƒ¨ç½²kubernetes</h2><h3 id="3-1-ä»‹ç»"><a href="#3-1-ä»‹ç»" class="headerlink" title="3.1 ä»‹ç»"></a>3.1 ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ–°ç‰ˆæœ¬å·²ç»è¶Šæ¥è¶Šè¶‹è¿‘å…¨é¢ TLS + RBAC é…ç½®ï¼Œæ‰€ä»¥æœ¬æ¬¡å®‰è£…å°†ä¼šå¯åŠ¨å¤§éƒ¨åˆ† TLS + RBAC é…ç½®ï¼ŒåŒ…æ‹¬ kube-controler-managerã€kube-scheduler ç»„ä»¶ä¸å†è¿æ¥æœ¬åœ° kube-apiserver çš„ 8080 éè®¤è¯ç«¯å£ï¼Œkubelet ç­‰ç»„ä»¶ API ç«¯ç‚¹å…³é—­åŒ¿åè®¿é—®ï¼Œå¯åŠ¨ RBAC è®¤è¯ç­‰ï¼›ä¸ºäº†æ»¡è¶³è¿™äº›è®¤è¯ï¼Œéœ€è¦ç­¾ç½²ä»¥ä¸‹è¯ä¹¦</p><h3 id="3-2ã€åˆ›å»ºCA"><a href="#3-2ã€åˆ›å»ºCA" class="headerlink" title="3.2ã€åˆ›å»ºCA"></a>3.2ã€åˆ›å»ºCA</h3><h4 id="3-2-1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶"><a href="#3-2-1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶" class="headerlink" title="3.2.1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶"></a>3.2.1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶</h4><ul><li><p>kubernetes-ca-csr.jsoné›†ç¾¤CAæ ¹è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir ssl &amp;&amp; cd ssl/</span></span><br><span class="line"><span class="comment"># cat kubernetes-ca-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 4096</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"ca"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>â€œCNâ€</strong>: Common Nameï¼Œkube-apiserver ä»è¯¥è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·åï¼ˆUser Nameï¼‰;æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™åˆæ³•æ€§ï¼›</li><li><strong>â€œOâ€</strong>: Organizationï¼Œkube-apiserverä»è¯¥è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±ç»„ï¼ˆGroupï¼‰ï¼›</li></ul></li><li><p>kubernetes-gencert.json<br>ç”¨äºç”Ÿæˆå…¶ä»–è¯ä¹¦çš„æ ‡å‡†</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubernetes-gencert.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"signing"</span>: &#123;</span><br><span class="line">        <span class="string">"default"</span>: &#123;</span><br><span class="line">            <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"profiles"</span>: &#123;</span><br><span class="line">            <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">                <span class="string">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"server auth"</span>,</span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-apiserver-csr.json<br>apiserver TLS è®¤è¯ç«¯å£éœ€è¦çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-apiserver-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"10.254.0.1"</span>,</span><br><span class="line">        <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"172.21.16.45"</span>,</span><br><span class="line">        <span class="string">"*.master.kubernetes.node"</span>,</span><br><span class="line">        <span class="string">"kubernetes"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>172.21.16.45</strong>: vipåœ°å€</li><li>å¦‚æœhostså­—æ®µä¸ä¸ºç©ºåˆ™éœ€è¦æŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ipæˆ–åŸŸååˆ—è¡¨,kube-apiserveræŒ‡å®šçš„service-cluster-ip-rangeç½‘æ®µçš„ç¬¬ä¸€ä¸ªipï¼Œå¦‚10.254.0.1</li></ul><ul><li><p>kube-controller-manager-csr.json<br>controller manager è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« 10257 ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-controller-manager-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"localhost"</span>,</span><br><span class="line">    <span class="string">"*.master.kubernetes.node"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-scheduler-csr.json<br>schedulerè¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« 10259 ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-scheduler-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"localhost"</span>,</span><br><span class="line">    <span class="string">"*.master.kubernetes.node"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-proxy-csr.json<br>proxy ç»„ä»¶è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-proxy-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kubelet-api-admin-csr.json<br>apiserver åå‘è¿æ¥ kubelet ç»„ä»¶ 10250 ç«¯å£éœ€è¦ä½¿ç”¨çš„è¯ä¹¦(ä¾‹å¦‚æ‰§è¡Œ kubectl logs)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubelet-api-admin-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kubelet-api-admin"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:kubelet-api-admin"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>admin-csr.json<br>é›†ç¾¤ç®¡ç†å‘˜(kubectl)è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat admin-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>æ³¨æ„</strong>: è¯ä¹¦æ–‡ä»¶é‡Œé¢çš„CNã€Oå­—æ®µï¼Œä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„å­—æ®µï¼ŒåŸºæœ¬éƒ½æ˜¯system:å¼€å¤´ï¼Œæ˜¯ä¸ºäº†åŒ¹é…RBACè§„åˆ™,<a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings" target="_blank" rel="noopener">è¯¦æƒ…å‚è€ƒ</a></p><h4 id="3-3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯"><a href="#3-3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯" class="headerlink" title="3.3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯"></a>3.3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert --initca=true kubernetes-ca-csr.json | cfssljson --bare kubernetes-ca</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for targetName in kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet-api-admin admin; do</span></span><br><span class="line">  cfssl gencert --ca kubernetes-ca.pem --ca-key kubernetes-ca-key.pem --config kubernetes-gencert.json --profile kubernetes <span class="variable">$targetName</span>-csr.json | cfssljson --bare <span class="variable">$targetName</span>; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="3-4ã€åˆ†å‘è¯ä¹¦"><a href="#3-4ã€åˆ†å‘è¯ä¹¦" class="headerlink" title="3.4ã€åˆ†å‘è¯ä¹¦"></a>3.4ã€åˆ†å‘è¯ä¹¦</h4><p>å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ï¼ˆåç¼€åä¸º.pemï¼‰æ‹·è´åˆ°æ‰€æœ‰æœºå™¨ï¼›kubernetesç³»ç»Ÿçš„å„ä¸ªç»„å»ºéœ€è¦ä½¿ç”¨tlsè¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†ã€‚</p><h5 id="1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š"><a href="#1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š" class="headerlink" title="1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š"></a>1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š</h5><ul><li>admin-key.pem</li><li>admin.pem</li><li>kube-apiserver-key.pem</li><li>kube-apiserver.pem</li><li>kube-controller-manager-key.pem</li><li>kube-controller-manager.pem</li><li>kubelet-api-admin-key.pem</li><li>kubelet-api-admin.pem</li><li>kube-proxy-key.pem</li><li>kube-proxy.pem</li><li>kubernetes-ca-key.pem</li><li>kubernetes-ca.pem</li><li>kube-scheduler-key.pem</li><li>kube-scheduler.pem</li></ul><h5 id="3ï¼‰ã€è¯ä¹¦æ‹·è´"><a href="#3ï¼‰ã€è¯ä¹¦æ‹·è´" class="headerlink" title="3ï¼‰ã€è¯ä¹¦æ‹·è´"></a>3ï¼‰ã€è¯ä¹¦æ‹·è´</h5><ul><li><p><strong>master èŠ‚ç‚¹æ‹·è´</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/kubernetes/ssl</span></span><br><span class="line"><span class="comment"># cp *.pem /etc/kubernetes/ssl/</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes k8s-master-02:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes k8s-master-03:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes node-01:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes node-02:/etc</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºç›®å½•</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/kube-audit &amp;&amp; mkdir /var/lib/kubelet -p &amp;&amp; mkdir /usr/libexec -p</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="4ã€åˆ›å»ºkube-configæ–‡ä»¶"><a href="#4ã€åˆ›å»ºkube-configæ–‡ä»¶" class="headerlink" title="4ã€åˆ›å»ºkube configæ–‡ä»¶"></a>4ã€åˆ›å»ºkube configæ–‡ä»¶</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;kubeletã€kube-proxyç­‰Nodeæœºå™¨ä¸Šçš„ç»å¸¸ä¸masteræœºå™¨çš„kube-apiserverè¿›ç¨‹é€šä¿¡æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼›kubernetes 1.4 å¼€å§‹æ”¯æŒæœ‰kube-apiserverä¸ºå®¢æˆ·ç«¯ç”Ÿæˆtlsè¯ä¹¦çš„ TLS BootstrappingåŠŸèƒ½ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦äº†ï¼Œè¯¥åŠŸèƒ½å½“å‰ä»…æ”¯æŒä¸ºkueletç”Ÿæˆè¯ä¹¦ï¼›</p><h3 id="4-1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶"><a href="#4-1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶" class="headerlink" title="4.1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶"></a>4.1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶</h3><ul><li>bootstrap.kubeconfig kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µéœ€è¦ä½¿ç”¨çš„é…ç½®æ–‡ä»¶</li><li>kube-controller-manager.kubeconfig controller manager ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li><li>kube-scheduler.kubeconfig scheduler ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li><li>kube-proxy.kubeconfig proxy ç»„ä»¶è¿æ¥ apiserver æ‰€éœ€é…ç½®æ–‡ä»¶</li><li>audit-policy.yaml apiserver RBAC å®¡è®¡æ—¥å¿—é…ç½®æ–‡ä»¶</li><li>bootstrap.secret.yaml kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µä½¿ç”¨ Bootstrap Token æ–¹å¼å¼•å¯¼ï¼Œéœ€è¦é¢„å…ˆåˆ›å»ºæ­¤ Token</li></ul><h3 id="4-2ã€åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶"><a href="#4-2ã€åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶" class="headerlink" title="4.2ã€åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶"></a>4.2ã€åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶</h3><p>åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦ä¸‹è½½kubernetes ç›¸å…³çš„äºŒè¿›åˆ¶åŒ…ï¼ŒæŠŠå¯¹åº”çš„å·¥å…·å’Œå‘½ä»¤æ‹·è´åˆ°/usr/binç›®å½•ä¸‹é¢;ä¸‹è½½äºŒè¿›åˆ¶åŒ…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.13.3/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf kubernetes-server-linux-amd64.tar.gz &amp;&amp; cd kubernetes/server/bin</span></span><br></pre></td></tr></table></figure><ul><li>masterèŠ‚ç‚¹æ‹·è´</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mv apiextensions-apiserver cloud-controller-manager hyperkube kube-apiserver kube-controller-manager kube-proxy kube-scheduler kubectl kubelet mounter kubeadm /usr/bin/ &amp;&amp; cd &amp;&amp;rm -rf kubernetes kubernetes-server-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><h4 id="4-2-1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping"><a href="#4-2-1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping" class="headerlink" title="4.2.1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping"></a>4.2.1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping</h4><ul><li>master-01<br>&nbsp;&nbsp;&nbsp;&nbsp;config æ˜¯ä¸€ä¸ªé€šç”¨é…ç½®æ–‡ä»¶è¦è¿æ¥æœ¬åœ°çš„ 6443 åŠ å¯†ç«¯å£ï¼›è€Œè¿™ä¸ªå˜é‡å°†ä¼šè¦†ç›– kubeconfig ä¸­æŒ‡å®šçš„master_vipåœ°å€172.21.16.45:6443 åœ°å€</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export KUBE_APISERVER="https://172.21.16.45:6443"</span></span><br></pre></td></tr></table></figure><ul><li>ç”Ÿæˆ Bootstrap Token<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># BOOTSTRAP_TOKEN_ID=$(head -c 6 /dev/urandom | md5sum | head -c 6)</span></span><br><span class="line"><span class="comment"># BOOTSTRAP_TOKEN_SECRET=$(head -c 16 /dev/urandom | md5sum | head -c 16)</span></span><br><span class="line"><span class="comment"># BOOTSTRAP_TOKEN="$&#123;BOOTSTRAP_TOKEN_ID&#125;.$&#123;BOOTSTRAP_TOKEN_SECRET&#125;"</span></span><br><span class="line"><span class="comment"># echo "Bootstrap Tokne: $&#123;BOOTSTRAP_TOKEN&#125;"</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="4-2-2ã€ç”Ÿæˆ-kubelet-tls-bootstrap-é…ç½®"><a href="#4-2-2ã€ç”Ÿæˆ-kubelet-tls-bootstrap-é…ç½®" class="headerlink" title="4.2.2ã€ç”Ÿæˆ kubelet tls bootstrap é…ç½®"></a>4.2.2ã€ç”Ÿæˆ kubelet tls bootstrap é…ç½®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:bootstrap:$&#123;BOOTSTRAP_TOKEN_ID&#125;" \</span></span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=<span class="string">"system:bootstrap:<span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span>"</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-3ã€ç”Ÿæˆ-kube-controller-manager-é…ç½®æ–‡ä»¶"><a href="#4-2-3ã€ç”Ÿæˆ-kube-controller-manager-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.3ã€ç”Ÿæˆ kube-controller-manager é…ç½®æ–‡ä»¶"></a>4.2.3ã€ç”Ÿæˆ kube-controller-manager é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-controller-manager" \</span></span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-4ã€ç”Ÿæˆ-kube-scheduler-é…ç½®æ–‡ä»¶"><a href="#4-2-4ã€ç”Ÿæˆ-kube-scheduler-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.4ã€ç”Ÿæˆ kube-scheduler é…ç½®æ–‡ä»¶"></a>4.2.4ã€ç”Ÿæˆ kube-scheduler é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-scheduler" \</span></span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-5ã€ç”Ÿæˆ-kube-proxy-é…ç½®æ–‡ä»¶"><a href="#4-2-5ã€ç”Ÿæˆ-kube-proxy-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.5ã€ç”Ÿæˆ kube-proxy é…ç½®æ–‡ä»¶"></a>4.2.5ã€ç”Ÿæˆ kube-proxy é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-proxy" \</span></span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-6ã€ç”Ÿæˆ-apiserver-RBAC-å®¡è®¡é…ç½®æ–‡ä»¶"><a href="#4-2-6ã€ç”Ÿæˆ-apiserver-RBAC-å®¡è®¡é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.6ã€ç”Ÿæˆ apiserver RBAC å®¡è®¡é…ç½®æ–‡ä»¶"></a>4.2.6ã€ç”Ÿæˆ apiserver RBAC å®¡è®¡é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; audit-policy.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="comment"># Log all requests at the Metadata level.</span></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">- level: Metadata</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-2-7ã€ç”Ÿæˆ-tls-bootstrap-token-secret-é…ç½®æ–‡ä»¶"><a href="#4-2-7ã€ç”Ÿæˆ-tls-bootstrap-token-secret-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.7ã€ç”Ÿæˆ tls bootstrap token secret é…ç½®æ–‡ä»¶"></a>4.2.7ã€ç”Ÿæˆ tls bootstrap token secret é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; bootstrap.secret.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># Name MUST be of form "bootstrap-token-&lt;token id&gt;"</span></span><br><span class="line">  name: bootstrap-token-<span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span></span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="comment"># Type MUST be 'bootstrap.kubernetes.io/token'</span></span><br><span class="line"><span class="built_in">type</span>: bootstrap.kubernetes.io/token</span><br><span class="line">stringData:</span><br><span class="line">  <span class="comment"># Human readable description. Optional.</span></span><br><span class="line">  description: <span class="string">"The default bootstrap token."</span></span><br><span class="line">  <span class="comment"># Token ID and secret. Required.</span></span><br><span class="line">  token-id: <span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span></span><br><span class="line">  token-secret: <span class="variable">$&#123;BOOTSTRAP_TOKEN_SECRET&#125;</span></span><br><span class="line">  <span class="comment"># Expiration. Optional.</span></span><br><span class="line">  expiration: $(date -d<span class="string">'+2 day'</span> -u +<span class="string">"%Y-%m-%dT%H:%M:%SZ"</span>)</span><br><span class="line">  <span class="comment"># Allowed usages.</span></span><br><span class="line">  usage-bootstrap-authentication: <span class="string">"true"</span></span><br><span class="line">  usage-bootstrap-signing: <span class="string">"true"</span></span><br><span class="line">  <span class="comment"># Extra groups to authenticate the token as. Must start with "system:bootstrappers:"</span></span><br><span class="line"><span class="comment">#  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-3ã€å¤åˆ¶æ–‡ä»¶"><a href="#4-3ã€å¤åˆ¶æ–‡ä»¶" class="headerlink" title="4.3ã€å¤åˆ¶æ–‡ä»¶"></a>4.3ã€å¤åˆ¶æ–‡ä»¶</h4><p>æŠŠåˆšç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°<code>/etc/kubernetes</code>ç›®å½•ä¸‹é¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># cp audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig /etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig k8s-master-02:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig k8s-master-03:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># node èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp -r  bootstrap.kubeconfig kube-proxy.kubeconfig node-01:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r  bootstrap.kubeconfig kube-proxy.kubeconfig node-02:/etc/kubernetes</span></span><br></pre></td></tr></table></figure><h4 id="4-4ã€å¤„ç†-ipvs-åŠä¾èµ–"><a href="#4-4ã€å¤„ç†-ipvs-åŠä¾èµ–" class="headerlink" title="4.4ã€å¤„ç† ipvs åŠä¾èµ–"></a>4.4ã€å¤„ç† ipvs åŠä¾èµ–</h4><p>&nbsp;&nbsp;&nbsp;&nbsp; æ–°ç‰ˆæœ¬ç›®å‰ kube-proxy ç»„ä»¶å…¨éƒ¨é‡‡ç”¨ ipvs æ–¹å¼è´Ÿè½½ï¼Œæ‰€ä»¥ä¸ºäº† kube-proxy èƒ½æ­£å¸¸å·¥ä½œéœ€è¦é¢„å…ˆå¤„ç†ä¸€ä¸‹ ipvs é…ç½®ä»¥åŠç›¸å…³ä¾èµ–(æ¯å° node éƒ½è¦å¤„ç†)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># sysctl -p</span></span><br></pre></td></tr></table></figure><p>kubernetes ä¸­å¯ç”¨ ipvs,è¯¦ç»†ä»‹ç»ï¼Œ<a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/proxy/ipvs" target="_blank" rel="noopener">å®˜æ–¹</a>,<a href="https://juejin.im/entry/5b7e409ce51d4538b35c03df" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install ipvsadm</span></span><br><span class="line"><span class="comment"># cat &gt;&gt; /etc/modules &lt;&lt;EOF</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver"><a href="#5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver" class="headerlink" title="5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver"></a>5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver</h2><h3 id="5-1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶"><a href="#5-1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶"></a>5.1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶</h3><ul><li><strong>kube-apiserver.service</strong><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service</span></span><br><span class="line">[Unit]</span><br><span class="line">  Description=Kubernetes API Service</span><br><span class="line">  Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">  After=network.target</span><br><span class="line">  After=etcd.service</span><br><span class="line">[Service]</span><br><span class="line">  EnvironmentFile=-/etc/kubernetes/apiserver</span><br><span class="line">  ExecStart=/usr/bin/kube-apiserver \</span><br><span class="line">          <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">          <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">          <span class="variable">$KUBE_ETCD_SERVERS</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_ADDRESS</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_PORT</span> \</span><br><span class="line">          <span class="variable">$KUBELET_PORT</span> \</span><br><span class="line">          <span class="variable">$KUBE_ALLOW_PRIV</span> \</span><br><span class="line">          <span class="variable">$KUBE_SERVICE_ADDRESSES</span> \</span><br><span class="line">          <span class="variable">$KUBE_ADMISSION_CONTROL</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_ARGS</span></span><br><span class="line">  Restart=on-failure</span><br><span class="line">  Type=notify</span><br><span class="line">  LimitNOFILE=65536</span><br><span class="line">[Install]</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-2ã€apiserveré…ç½®æ–‡ä»¶"><a href="#5-2ã€apiserveré…ç½®æ–‡ä»¶" class="headerlink" title="5.2ã€apiserveré…ç½®æ–‡ä»¶"></a>5.2ã€apiserveré…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/apiserver</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes system config</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The following values are used to configure the kube-apiserver</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address on the local server to listen to.</span></span><br><span class="line">KUBE_API_ADDRESS=<span class="string">"--advertise-address=172.21.17.4 --bind-address=0.0.0.0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The port on the local server to listen on.</span></span><br><span class="line">KUBE_API_PORT=<span class="string">"--secure-port=6443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port minions listen on</span></span><br><span class="line"><span class="comment"># KUBELET_PORT="--kubelet-port=10250"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Comma separated list of nodes in the etcd cluster</span></span><br><span class="line">KUBE_ETCD_SERVERS=<span class="string">"--etcd-servers=https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Address range to use for services</span></span><br><span class="line">KUBE_SERVICE_ADDRESSES=<span class="string">"--service-cluster-ip-range=10.254.0.0/16"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default admission control policies</span></span><br><span class="line">KUBE_ADMISSION_CONTROL=<span class="string">"--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,Priority,ResourceQuota"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_API_ARGS=<span class="string">" --allow-privileged=true \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --alsologtostderr \</span></span><br><span class="line"><span class="string">                --apiserver-count=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">                --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">                --audit-log-path=/var/log/kube-audit/audit.log \</span></span><br><span class="line"><span class="string">                --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span></span><br><span class="line"><span class="string">                --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">                --enable-garbage-collector \</span></span><br><span class="line"><span class="string">                --enable-logs-handler \</span></span><br><span class="line"><span class="string">                --endpoint-reconciler-type=lease \</span></span><br><span class="line"><span class="string">                --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span></span><br><span class="line"><span class="string">                --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">                --etcd-compaction-interval=0s \</span></span><br><span class="line"><span class="string">                --event-ttl=168h0m0s \</span></span><br><span class="line"><span class="string">                --kubelet-https=true \</span></span><br><span class="line"><span class="string">                --kubelet-certificate-authority=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem \</span></span><br><span class="line"><span class="string">                --kubelet-timeout=3s \</span></span><br><span class="line"><span class="string">                --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">                --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">                --service-account-key-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure><ul><li><strong>â€“client-ca-file</strong>: å®šä¹‰å®¢æˆ·ç«¯ CA</li><li><strong>â€“endpoint-reconciler-type</strong>: master endpoint ç­–ç•¥</li><li><strong>â€“kubelet-client-certificateã€â€“kubelet-client-key</strong>: master åå‘è¿æ¥ kubelet ä½¿ç”¨çš„è¯ä¹¦</li><li><strong>â€“service-account-key-file</strong>: service account ç­¾å key(ç”¨äºæœ‰æ•ˆæ€§éªŒè¯)</li><li><strong>â€“tls-cert-fileã€â€“tls-private-key-file</strong>: master apiserver 6443 ç«¯å£è¯ä¹¦<br>è¯¦ç»†å‚æ•°<a href="https://www.jianshu.com/p/36ad3028a710" target="_blank" rel="noopener">ä»‹ç»</a></li></ul><h3 id="5-2-1ã€å¯åŠ¨kube-apiserver"><a href="#5-2-1ã€å¯åŠ¨kube-apiserver" class="headerlink" title="5.2.1ã€å¯åŠ¨kube-apiserver"></a>5.2.1ã€å¯åŠ¨kube-apiserver</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-apiserver &amp;&amp;systemctl start kube-apiserver &amp;&amp;systemctl status kube-apiserver</span></span><br></pre></td></tr></table></figure><h3 id="5-3ã€é…ç½®kube-controller-manager"><a href="#5-3ã€é…ç½®kube-controller-manager" class="headerlink" title="5.3ã€é…ç½®kube-controller-manager"></a>5.3ã€é…ç½®kube-controller-manager</h3><p>åˆ›å»ºkube-controller-managerçš„serviceé…ç½®æ–‡ä»¶</p><h3 id="5-3-1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶"><a href="#5-3-1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.3.1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶"></a>5.3.1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-controller-manager.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/controller-manager</span><br><span class="line">ExecStart=/usr/bin/kube-controller-manager \</span><br><span class="line">	    <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">	    <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">	    <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">	    <span class="variable">$KUBE_CONTROLLER_MANAGER_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="5-3-2ã€é…ç½®controller-manageræ–‡ä»¶"><a href="#5-3-2ã€é…ç½®controller-manageræ–‡ä»¶" class="headerlink" title="5.3.2ã€é…ç½®controller-manageræ–‡ä»¶"></a>5.3.2ã€é…ç½®controller-manageræ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/controller-manager</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># The following values are used to configure the kubernetes controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defaults from config and apiserver should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">                                --cluster-signing-cert-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --cluster-signing-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">                                --deployment-controller-sync-period=10s \</span></span><br><span class="line"><span class="string">                                --experimental-cluster-signing-duration=87600h0m0s \</span></span><br><span class="line"><span class="string">                                --enable-garbage-collector=true \</span></span><br><span class="line"><span class="string">                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --leader-elect=true \</span></span><br><span class="line"><span class="string">                                --node-monitor-grace-period=20s \</span></span><br><span class="line"><span class="string">                                --node-monitor-period=5s \</span></span><br><span class="line"><span class="string">                                --port=10252 \</span></span><br><span class="line"><span class="string">                                --pod-eviction-timeout=2m0s \</span></span><br><span class="line"><span class="string">                                --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --terminated-pod-gc-threshold=50 \</span></span><br><span class="line"><span class="string">                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">                                --root-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --secure-port=10257 \</span></span><br><span class="line"><span class="string">                                --service-cluster-ip-range=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                                --service-account-private-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">                                --v=2"</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;controller manager å°†ä¸å®‰å…¨ç«¯å£ 10252 ç»‘å®šåˆ° 127.0.0.1 ç¡®ä¿ kuebctl get cs æœ‰æ­£ç¡®è¿”å›ï¼›å°†å®‰å…¨ç«¯å£ 10257 ç»‘å®šåˆ° 0.0.0.0 å…¬å¼€ï¼Œæä¾›æœåŠ¡è°ƒç”¨ï¼›ç”±äº controller manager å¼€å§‹è¿æ¥ apiserver çš„ 6443 è®¤è¯ç«¯å£ï¼Œæ‰€ä»¥éœ€è¦ â€“use-service-account-credentials é€‰é¡¹æ¥è®© controller manager åˆ›å»ºå•ç‹¬çš„ service account(é»˜è®¤ system:kube-controller-manager ç”¨æˆ·æ²¡æœ‰é‚£ä¹ˆé«˜æƒé™)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused   </span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused   </span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="5-3-3ã€å¯åŠ¨kube-controller-manager"><a href="#5-3-3ã€å¯åŠ¨kube-controller-manager" class="headerlink" title="5.3.3ã€å¯åŠ¨kube-controller-manager"></a>5.3.3ã€å¯åŠ¨kube-controller-manager</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl enable kube-controller-manager &amp;&amp;systemctl start kube-controller-manager &amp;&amp;systemctl status kube-controller-manager</span></span><br></pre></td></tr></table></figure><h3 id="5-4ã€é…ç½®kube-scheduler"><a href="#5-4ã€é…ç½®kube-scheduler" class="headerlink" title="5.4ã€é…ç½®kube-scheduler"></a>5.4ã€é…ç½®kube-scheduler</h3><p>åˆ›å»ºkube-schedulerçš„serviceé…ç½®æ–‡ä»¶</p><h4 id="5-4-1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶"><a href="#5-4-1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.4.1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶"></a>5.4.1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/kube-scheduler.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler Plugin</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/scheduler</span><br><span class="line">ExecStart=/usr/bin/kube-scheduler \</span><br><span class="line">	    <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">	    <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">	    <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">	    <span class="variable">$KUBE_SCHEDULER_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="5-4-2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶"><a href="#5-4-2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶" class="headerlink" title="5.4.2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶"></a>5.4.2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/scheduler </span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes scheduler config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_SCHEDULER_ARGS=<span class="string">"   --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                        --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                        --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                        --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                        --secure-port=10259 \</span></span><br><span class="line"><span class="string">                        --leader-elect=true \</span></span><br><span class="line"><span class="string">                        --port=10251 \</span></span><br><span class="line"><span class="string">                        --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \</span></span><br><span class="line"><span class="string">                        --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem \</span></span><br><span class="line"><span class="string">                        --v=2"</span></span><br></pre></td></tr></table></figure><p>shceduler åŒ controller manager ä¸€æ ·å°†ä¸å®‰å…¨ç«¯å£ç»‘å®šåœ¨æœ¬åœ°ï¼Œå®‰å…¨ç«¯å£å¯¹å¤–å…¬å¼€</p><h4 id="5-4-3ã€å¯åŠ¨kube-scheduler"><a href="#5-4-3ã€å¯åŠ¨kube-scheduler" class="headerlink" title="5.4.3ã€å¯åŠ¨kube-scheduler"></a>5.4.3ã€å¯åŠ¨kube-scheduler</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-scheduler &amp;&amp;systemctl start kube-scheduler &amp;&amp;systemctl status kube-scheduler</span></span><br></pre></td></tr></table></figure><h3 id="5-4ã€éªŒè¯masterèŠ‚ç‚¹"><a href="#5-4ã€éªŒè¯masterèŠ‚ç‚¹" class="headerlink" title="5.4ã€éªŒè¯masterèŠ‚ç‚¹"></a>5.4ã€éªŒè¯masterèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤masterèŠ‚ç‚¹éƒ¨ç½²å®Œæ¯•</p><p>kubernetesé«˜å¯ç”¨ä½¿ç”¨haproxyè¿›è¡Œä»£ç†,<a href="https://xxlaila.github.io/2019/08/10/haproxy-keepalived/" target="_blank" rel="noopener">haproxy</a>ä»£ç†å®‰è£…</p><p><a href="https://xxlaila.github.io/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">nodeèŠ‚ç‚¹å®‰è£…</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes v1.13.3</tag>
      </tags>
  </entry>
  <entry>
    <title>vsftpdå®‰è£…</title>
    <url>/2019/08/09/vsftpd%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Centosä¸‹ftpçš„å®‰è£…ä¸€èˆ¬é‡‡ç”¨çš„æ˜¯vsftpdï¼Œä½†æ˜¯åœ¨ftpçš„æ¨¡å¼ä¸­åˆæœ‰å‡ ä¸ªç”¨æˆ·é…ç½®é¡¹éœ€è¦æ³¨æ„ï¼Œæœ‰äº›äººå–œæ¬¢ç”¨æœ¬åœ°ç”¨æˆ·å»ç™»é™†FTPï¼Œè™½ç„¶åœ¨å»ºç«‹æœ¬åœ°ç”¨æˆ·çš„æ—¶å€™åŠ äº†/sbin/nologinå‚æ•°ï¼Œä½†æ˜¯è¿™ä¸ªè¿˜æ˜¯ä¸å¤Ÿå®‰å…¨ï¼Œè€Œä¸”è¿™æ ·æƒé™æ§åˆ¶ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼Œä»–ä»¬éƒ½æ˜¯ç»Ÿä¸€çš„æ§åˆ¶æƒé™ï¼Œè¿™é‡Œé‡‡ç”¨è™šæ‹Ÿç”¨æˆ·å‰æ¥é…ç½®ã€‚è™šæ‹Ÿç”¨æˆ·é…åˆé˜²ç«å¢™selinuxè¿˜æœ‰å•ä¸ªç”¨æˆ·çš„æƒé™ï¼Œè¿™ä½¿å¾—FTPæœ‰ç€è¶³å¤Ÿçš„å®‰å…¨ã€‚è€Œä¸”æƒé™æ§åˆ¶ç‰¹åˆ«çµæ´»ï¼Œä¿®æ”¹ä¸€ä¸ªç”¨æˆ·çš„æƒé™ä¸ä¼šå½±å“åˆ°å…¶ä»–ç”¨æˆ·ã€‚<br>centos ç³»ç»Ÿç‰ˆæœ¬(5.5ã€5.3ã€6.0ã€6.5)<br>centos 7.4 å·²ç»éªŒè¯</p><h3 id="é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd"><a href="#é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd" class="headerlink" title="é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd"></a>é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum â€“y install vsftpd</span></span><br></pre></td></tr></table></figure><h3 id="2ã€å¯åŠ¨å’ŒåŠ è½½vsftp"><a href="#2ã€å¯åŠ¨å’ŒåŠ è½½vsftp" class="headerlink" title="2ã€å¯åŠ¨å’ŒåŠ è½½vsftp"></a>2ã€å¯åŠ¨å’ŒåŠ è½½vsftp</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># service vsftpd restart</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chkconfig â€“level 35 vsftpd on</span></span><br></pre></td></tr></table></figure><h3 id="3ã€å¼€å§‹é…ç½®vsftpd"><a href="#3ã€å¼€å§‹é…ç½®vsftpd" class="headerlink" title="3ã€å¼€å§‹é…ç½®vsftpd"></a>3ã€å¼€å§‹é…ç½®vsftpd</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Vsftpdçš„é…ç½®æ–‡ä»¶åœ¨/etc/vsftpdä¸‹é¢ï¼Œåœ¨é…ç½®ä¹‹å‰æˆ‘ä»¬å…ˆcpä¸€ä»½åšå¤‡ä»½ç”¨ä»¥å…å‘ç”Ÿæ„å¤–(åšä»€ä¹ˆéƒ½è¦éšæ‰‹å¤‡ä»½ï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸‡ï¼Œåªæœ‰ä¸‡ä¸€ã€‚)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment">#  cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.bak</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vim /etc/vsftpd/vsftpd.conf</span></span><br></pre></td></tr></table></figure><ul><li><strong>vsftpdçš„å‚æ•°ä»‹ç»</strong></li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reverse_lookup_enable=NO <span class="comment">#æ·»åŠ æ­¤è¡Œï¼Œè§£å†³å®¢æˆ·ç«¯ç™»é™†ç¼“æ…¢é—®é¢˜ï¼é‡è¦ï¼é»˜è®¤vsftpdå¼€å¯äº†DNSåå“è§£æï¼è¿™é‡Œéœ€è¦å…³é—­ï¼Œå¦‚æœå¯åŠ¨æœ‰é”™è¯¯ï¼Œè¯·æ³¨é”€ï¼</span></span><br><span class="line">listen_port=21 <span class="comment">#é»˜è®¤æ— æ­¤è¡Œï¼Œftpç«¯å£ä¸º21ï¼Œæ·»åŠ listen_port=2222æŠŠé»˜è®¤ç«¯å£ä¿®æ”¹ä¸º2222ï¼Œæ³¨æ„ï¼šé˜²ç«å¢™åŒæ—¶è¦å¼€å¯2222ç«¯å£</span></span><br><span class="line">anonymous_enable=NOã€€ã€€ <span class="comment">#ç¦æ­¢åŒ¿åç”¨æˆ·</span></span><br><span class="line">local_enable=YES</span><br><span class="line">è®¾å®šæœ¬åœ°ç”¨æˆ·å¯ä»¥è®¿é—®ã€‚æ³¨æ„ï¼šä¸»è¦æ˜¯ä¸ºè™šæ‹Ÿå®¿ä¸»ç”¨æˆ·ï¼Œå¦‚æœè¯¥é¡¹ç›®è®¾å®šä¸ºNOé‚£ä¹ˆæ‰€æœ‰è™šæ‹Ÿç”¨æˆ·å°†æ— æ³•è®¿é—®</span><br><span class="line">write_enable=YES <span class="comment">#å…¨å±€è®¾ç½®ï¼Œæ˜¯å¦å®¹è®¸å†™å…¥ï¼ˆæ— è®ºæ˜¯åŒ¿åç”¨æˆ·è¿˜æ˜¯æœ¬åœ°ç”¨æˆ·ï¼Œè‹¥è¦å¯ç”¨ä¸Šä¼ æƒé™çš„è¯ï¼Œå°±è¦å¼€å¯ä»–ï¼‰</span></span><br><span class="line">local_umask=022 è®¾å®šä¸Šä¼ åæ–‡ä»¶çš„æƒé™æ©ç ã€‚</span><br><span class="line">anon_upload_enable=NO ç¦æ­¢åŒ¿åç”¨æˆ·ä¸Šä¼ ã€‚</span><br><span class="line">anon_mkdir_write_enable=NO ç¦æ­¢åŒ¿åç”¨æˆ·å»ºç«‹ç›®å½•ã€‚</span><br><span class="line">dirmessage_enable=YES è®¾å®šå¼€å¯ç›®å½•æ ‡è¯­åŠŸèƒ½ã€‚</span><br><span class="line">xferlog_enable=YES è®¾å®šå¼€å¯æ—¥å¿—è®°å½•åŠŸèƒ½ã€‚</span><br><span class="line">connect_from_port_20=YES è®¾å®šç«¯å£20è¿›è¡Œæ•°æ®è¿æ¥ã€‚</span><br><span class="line">chown_uploads=NO è®¾å®šç¦æ­¢ä¸Šä¼ æ–‡ä»¶æ›´æ”¹å®¿ä¸»ã€‚</span><br><span class="line">xferlog_file=/var/<span class="built_in">log</span>/vsftpd.log æ—¥å¿—ä¿å­˜è·¯å¾„ï¼ˆå…ˆåˆ›å»ºå¥½æ–‡ä»¶ï¼‰</span><br><span class="line">xferlog_std_format=YESã€€ã€€ <span class="comment">#ä½¿ç”¨æ ‡å‡†æ ¼å¼</span></span><br><span class="line">async_abor_enable=YES è®¾å®šæ”¯æŒå¼‚æ­¥ä¼ è¾“åŠŸèƒ½ã€‚</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES è®¾å®šæ”¯æŒASCIIæ¨¡å¼çš„ä¸Šä¼ å’Œä¸‹è½½åŠŸèƒ½ã€‚</span><br><span class="line">ftpd_banner=Welcome to Awei FTP servers è®¾å®šVsftpdçš„ç™»é™†æ ‡è¯­ã€‚</span><br><span class="line">chroot_local_user=YES ç¦æ­¢æœ¬åœ°ç”¨æˆ·ç™»å‡ºè‡ªå·±çš„FTPä¸»ç›®å½•ã€‚</span><br><span class="line">pam_service_name=vsftpd è®¾å®šPAMæœåŠ¡ä¸‹Vsftpdçš„éªŒè¯é…ç½®æ–‡ä»¶åã€‚å› æ­¤ï¼ŒPAMéªŒè¯å°†å‚è€ƒ/etc/pam.d/ä¸‹çš„vsftpdæ–‡ä»¶é…ç½®ã€‚</span><br><span class="line">userlist_enable=YES è®¾ä¸ºYESçš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·åæ˜¯åœ¨userlist_fileå‚æ•°æŒ‡å®šçš„æ–‡ä»¶ä¸­ï¼Œ</span><br><span class="line"> é‚£ä¹ˆåœ¨è¦æ±‚ä»–ä»¬è¾“å…¥å¯†ç ä¹‹å‰ï¼Œä¼šç›´æ¥æ‹’ç»ä»–ä»¬ç™»é™†ã€‚</span><br><span class="line">tcp_wrappers=YES æ˜¯å¦æ”¯æŒtcp_wrappers</span><br></pre></td></tr></table></figure><ul><li><strong>ä»¥ä¸‹æ˜¯æˆ‘ä½¿ç”¨çš„å‚æ•°,ä½¿ç”¨çš„æ˜¯è¢«åŠ¨æ¨¡å¼</strong><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">anonymous_enable=No</span><br><span class="line">listen_port=21</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"><span class="comment">#chown_uploads=YES</span></span><br><span class="line">xferlog_file=/var/<span class="built_in">log</span>/vsftpd.log</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">async_abor_enable=YES</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES</span><br><span class="line">ftpd_banner=Welcome to blah FTP service.</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">listen=YES</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line">reverse_lookup_enable=No</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=vsftpd</span><br><span class="line">user_config_dir=/etc/vsftpd/vconf</span><br><span class="line">virtual_use_local_privs=YES</span><br><span class="line">pasv_min_port=9000</span><br><span class="line">pasv_max_port=9045</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">allow_writeable_chroot=YES</span><br><span class="line"><span class="comment">#port_enable=YES</span></span><br><span class="line"><span class="comment">#connect_from_port_20=YES</span></span><br><span class="line">pasv_enable=yes</span><br></pre></td></tr></table></figure></li></ul><ul><li>å¤‡æ³¨: è¿™é‡Œvsftpé‡‡ç”¨çš„è¢«åŠ¨æ¨¡å¼ï¼Œè¢«åŠ¨æ¨¡å¼å¼€æ”¾äº†ä¸€ä¸ªç«¯å£æ®µï¼Œå…¬å¸è·¯ç”±å™¨ä¸Šéœ€è¦å¼€æ”¾è¿™ä¸€ä¸ªç«¯å£ç«¯ï¼Œ<a href="https://xxlaila.github.io/2019/09/10/è·¯ç”±å™¨ç«¯å£æ˜ å°„/" target="_blank" rel="noopener">è·¯ç”±å™¨ç«¯å£æ˜ å°„</a></li></ul><h3 id="4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶"><a href="#4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶" class="headerlink" title="4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶"></a>4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶</h3><p>ç¼–è¾‘è™šæ‹Ÿç”¨æˆ·çš„åå•ï¼šï¼ˆç¬¬ä¸€è¡Œç”¨æˆ·åã€‚ç¬¬äºŒè¡Œå¯†ç ã€‚ä¸èƒ½ä½¿ç”¨rootï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># vim /etc/vsftpd/xuniusers</span></span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">23123213</span><br><span class="line">test1</span><br><span class="line">34dsfds</span><br><span class="line">test2</span><br><span class="line">df43sd</span><br></pre></td></tr></table></figure><h3 id="5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶"><a href="#5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶" class="headerlink" title="5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶"></a>5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶</h3><p>è¿™é‡Œéœ€è¦å®‰è£…db4,è®¾ç½®PAMæ–‡ä»¶æƒé™ï¼Œå¹¶åˆ¶å®šè™šæ‹Ÿç”¨æˆ·æ•°æ®åº“æ–‡ä»¶è¯»å–</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum â€“y install db4-utils</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># db_load -T -t hash -f /etc/vsftpd/xuniusers /etc/vsftpd/xuniusers.db</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chmod 600 /etc/vsftpd/xuniusers.db</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨/etc/pam.d/vsftpdçš„æ–‡ä»¶å¤´éƒ¨åŠ å…¥ä»¥ä¸‹ä¿¡æ¯ï¼ˆæ³¨*è¿™é‡Œä¸€å®šè¦åœ¨å‰é¢ï¼Œä¸èƒ½å†åé¢ï¼Œåˆšå¼€å§‹æˆ‘ä¹ŸåŠ è½½åˆ°åé¢ç™»é™†çš„æ—¶å€™æç¤ºé”™è¯¯ï¼‰,ä¿®æ”¹å‰å…ˆå¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># cp /etc/pam.d/vsftpd /etc/pam.d/vsftpd.bak</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vi /etc/pam.d/vsftpd</span></span><br><span class="line">auth sufficient /lib/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br><span class="line">account sufficient /lib/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/%E5%9B%BE%E7%89%87%201.png" alt="img"></p><ul><li>æ³¨*64ä½çš„æ“ä½œç³»ç»Ÿï¼Œåˆ™ä¸Šé¢libæ”¹ä¸º64ã€‚ä¸ç„¶é…ç½®ä¹Ÿä¼šæ— æ•ˆ</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">auth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br><span class="line">account sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å»ºç«‹ä¸€ä¸ªç³»ç»Ÿç”¨æˆ·vsftpdï¼Œç”¨æˆ·çš„ä¸»ç›®å½•å¯ä»¥è‡ªå·±è®¾ç½®ï¼Œ/home/wwwrootï¼Œè®¾ç½®ç”¨æˆ·ç™»é™†çš„ç»ˆç«¯ä¸º/bin/false</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># useradd vsftpd -d /home/wwwroot -s /bin/false</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chown vsftpd:vsftpd /home/wwwroot -R</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chown www:www /home/wwwroot â€“R #å¦‚æœè™šæ‹Ÿç”¨æˆ·çš„å®¿ä¸»ç”¨æˆ·ä¸ºnginxï¼Œéœ€è¦è¿™æ ·è®¾ç½®ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶"><a href="#6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶" class="headerlink" title="6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶"></a>6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># mkdir /etc/vsftpd/vconf</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># cd /etc/vsftpd/vconf</span></span><br><span class="line">touch test1 test2 test3 <span class="comment">#è¿™é‡Œåˆ›å»ºä¸‰ä¸ªè™šæ‹Ÿç”¨æˆ·é…ç½®æ–‡ä»¶</span></span><br><span class="line">vi web1 <span class="comment">#ç¼–è¾‘ç”¨æˆ·test1é…ç½®æ–‡ä»¶ï¼Œå…¶ä»–çš„è·Ÿè¿™ä¸ªé…ç½®æ–‡ä»¶ç±»ä¼¼</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vim test1</span></span><br><span class="line">local_root=/home/wwwroot/test1/</span><br><span class="line">write_enable=YES</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod u-w /home/wwwroot</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;æœ€åé‡å¯vsftpdæœåŠ¡,ä¸å…³é—­Selinuxå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é€šè¿‡FTPã€‚é˜²ç«å¢™å¼€æ”¾ç«¯å£<code>setsebool -P ftpd_disable_trans 1</code><br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¿°é…ç½®å®Œæˆåè¿˜å¯ä»¥é€šè¿‡#adduser -d /ç›®å½•è·¯å¾„ -g vsftpd -s /sbin/nologin ç”¨æˆ·å è¿™ä¸ªå‘½ä»¤æ¥æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œä¸éœ€è¦é…ç½®ä»»ä½•æƒé™éƒ½å¯ä»¥è¿›è¡ŒFTPçš„è®¿é—®,æœ€åè¡¥å……è¯´æ˜ï¼Œéœ€è¦å®‰è£…çš„å…¶ä»–æ’ä»¶</p><ul><li><p>éœ€è¦å®‰è£…çš„çš„æ˜¯pan</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum install -y pam</span></span><br></pre></td></tr></table></figure></li><li><p>è¿™é‡Œæˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹æ—¥å¿—ï¼Œå¯ä»¥æ ¹æ®æç¤ºçš„æç¤ºæ¥åˆ¤æ–­ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># cat /var/log/secure</span></span><br></pre></td></tr></table></figure></li></ul><p>æµ‹è¯•ç”¨æˆ·ç™»å½•è™šæ‹Ÿç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±æœ¬èº«çš„ç›®å½• ï¼Œä¸èƒ½å»å…¶ä»–ç›®å½•æŸ¥çœ‹(åˆ°è¿™é‡Œvsftpdé…ç½®ç»“æŸ)</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>vsftpd</tag>
      </tags>
  </entry>
  <entry>
    <title>TeamViewer macç ´è§£</title>
    <url>/2019/08/09/TeamViewer-mac%E7%A0%B4%E8%A7%A3/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h2 id="TeamViewer14-4-MACç ´è§£"><a href="#TeamViewer14-4-MACç ´è§£" class="headerlink" title="TeamViewer14.4 MACç ´è§£"></a>TeamViewer14.4 MACç ´è§£</h2><h3 id="åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤"><a href="#åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤" class="headerlink" title="åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤"></a>åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo python TeamViewer-id-changer.py</span><br><span class="line">ä½¿ç”¨macè‡ªå¸¦python2.7 æ‰§è¡Œå³å¯</span><br></pre></td></tr></table></figure><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim TeamViewer-id-changer.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2019/8/1 14:57</span></span><br><span class="line"><span class="comment"># @Author  : xxlaila</span></span><br><span class="line"><span class="comment"># @Site    : </span></span><br><span class="line"><span class="comment"># @File    : TeamViewer-id-changer.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">import platform</span><br><span class="line">import random</span><br><span class="line">import re</span><br><span class="line">import string</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">--------------------------------</span></span><br><span class="line"><span class="string">TeamViewer 14 ID Changer for MAC OS</span></span><br><span class="line"><span class="string">Version: 0.2 2019</span></span><br><span class="line"><span class="string">--------------------------------</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> platform.system() != <span class="string">"Darwin"</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"This script can be run only on MAC OS."</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.geteuid() != 0:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"This script must be run form root."</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">"SUDO_USER"</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">    USERNAME = os.environ[<span class="string">"SUDO_USER"</span>]</span><br><span class="line">    <span class="keyword">if</span> USERNAME == <span class="string">"root"</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Can not find user name. Run this script via sudo from regular user"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Can not find user name. Run this script via sudo from regular user"</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line">HOMEDIRLIB = <span class="string">"/Users/"</span> + USERNAME + <span class="string">"/library/preferences/"</span></span><br><span class="line">GLOBALLIB = <span class="string">"/library/preferences/"</span></span><br><span class="line"></span><br><span class="line">CONFIGS = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Find config files</span></span><br><span class="line"></span><br><span class="line">def listdir_fullpath(d):</span><br><span class="line">    <span class="built_in">return</span> [os.path.join(d, f) <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(d)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> listdir_fullpath(HOMEDIRLIB):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'teamviewer'</span> <span class="keyword">in</span> file.lower():</span><br><span class="line">        CONFIGS.append(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> listdir_fullpath(GLOBALLIB):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'teamviewer'</span> <span class="keyword">in</span> file.lower():</span><br><span class="line">        CONFIGS.append(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not CONFIGS:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">            There is no TemViewer configs found.</span></span><br><span class="line"><span class="string">            Maybe you have deleted it manualy or never run TeamViewer after installation.</span></span><br><span class="line"><span class="string">            Nothing to delete.</span></span><br><span class="line"><span class="string">            '</span><span class="string">''</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Delete config files</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Configs found:\n"</span>)</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> CONFIGS:</span><br><span class="line">        <span class="built_in">print</span>(file)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">        This files will be DELETED permanently.</span></span><br><span class="line"><span class="string">        All TeamViewer settings will be lost</span></span><br><span class="line"><span class="string">        '</span><span class="string">''</span>)</span><br><span class="line">        raw_input(<span class="string">"Press Enter to continue or CTR+C to abort..."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> CONFIGS:</span><br><span class="line">        try:</span><br><span class="line">            os.remove(file)</span><br><span class="line">        except:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Cannot delete config files. Permission denied?"</span>)</span><br><span class="line">            sys.exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Done."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find binaryes</span></span><br><span class="line"></span><br><span class="line">TMBINARYES = [</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/MacOS/TeamViewer'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/MacOS/TeamViewer_Service'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/Helpers/TeamViewer_Desktop'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/Helpers/TeamViewer_Assignment'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> TMBINARYES:</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(file):</span><br><span class="line">        pass</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"File not found: "</span> + file)</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">"Install TeamViewer correctly"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Patch files</span></span><br><span class="line"></span><br><span class="line">def idpatch(fpath, platf, serial):</span><br><span class="line">    file = open(fpath, <span class="string">'r+b'</span>)</span><br><span class="line">    binary = file.read()</span><br><span class="line">    PlatformPattern = <span class="string">"IOPlatformExpert.&#123;6&#125;"</span></span><br><span class="line">    SerialPattern = <span class="string">"IOPlatformSerialNumber%s%s%s"</span></span><br><span class="line"></span><br><span class="line">    binary = re.sub(PlatformPattern, platf, binary)</span><br><span class="line">    binary = re.sub(SerialPattern % (chr(0), <span class="string">"[0-9a-zA-Z]&#123;8,8&#125;"</span>, chr(0)), SerialPattern % (chr(0), serial, chr(0)), binary)</span><br><span class="line"></span><br><span class="line">    file = open(fpath, <span class="string">'wb'</span>).write(binary)</span><br><span class="line">    <span class="built_in">return</span> True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def random_generator(size=8, chars=string.ascii_uppercase + string.ascii_lowercase + string.digits):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join(random.choice(chars) <span class="keyword">for</span> _ <span class="keyword">in</span> range(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RANDOMSERIAL = random_generator(8)</span><br><span class="line">RANDOMPLATFORM = <span class="string">"IOPlatformExpert"</span> + random_generator(6)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> TMBINARYES:</span><br><span class="line">    try:</span><br><span class="line">        idpatch(file, RANDOMPLATFORM, RANDOMSERIAL)</span><br><span class="line">    except:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Error: can not patch file "</span> + file)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"PlatformDevice: "</span> + RANDOMPLATFORM)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"PlatformSerial: "</span> + RANDOMSERIAL)</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">"sudo codesign -f -s - /Applications/TeamViewer.app/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">ID changed sucessfully.</span></span><br><span class="line"><span class="string">!!! Restart computer before using TeamViewer !!!!</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span>)</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>TeamViewer</category>
      </categories>
      <tags>
        <tag>TeamViewer</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkins jobç®¡ç†</title>
    <url>/2019/08/09/jenkins-job%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><ul><li><strong>ä»‹ç»</strong>: ç”±äºå…¬å¸çš„ciç”¨äºç¼–è¯‘çš„ç¯å¢ƒæ¯”è¾ƒå¤šï¼Œä¸ºäº†æ›´å¥½çš„åŒºåˆ†ï¼Œä¸ºæ¯ä¸€ä¸ªç¯å¢ƒå»ºç«‹äº†ä¸€ä¸ªview</li><li><strong>ç—›ç‚¹</strong>: è¿ç»´äººå‘˜åœ¨å»ºç«‹jobçš„æ—¶å€™éœ€è¦åˆ°å¯¹åº”çš„viewä¸‹é¢å»ºç«‹ï¼Œè™½ç„¶è¿™ä¸æ˜¯ç‹ ç—›è‹¦ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚</li><li><strong>è§£å†³</strong>: äººå‘˜ç™»é™†é»˜è®¤æ˜¯åœ¨all viewä¸‹é¢ï¼Œæ¯ä¸ªè¿ç»´äººå‘˜åœ¨è¿™ä¸‹é¢å»ºç«‹jobï¼Œç„¶åæ¯ä¸ªviewæ ¹æ®è‡ªå·±çš„è§„åˆ™å§å¯¹åº”çš„jobæ·»åŠ è¿›æ¥ã€‚jobè§„åˆ™è‡ªå·±æå‰å®šä¹‰å¥½</li></ul><h2 id="1ã€å®‰è£…jenkinsæ’ä»¶"><a href="#1ã€å®‰è£…jenkinsæ’ä»¶" class="headerlink" title="1ã€å®‰è£…jenkinsæ’ä»¶"></a>1ã€å®‰è£…jenkinsæ’ä»¶</h2><p>view job è¿‡æ»¤æ’ä»¶view-job-filtersï¼Œå®‰è£…è¿‡ç¨‹ä¸ç´¯èµ˜</p><h2 id="2ã€é…ç½®viewè§„åˆ™"><a href="#2ã€é…ç½®viewè§„åˆ™" class="headerlink" title="2ã€é…ç½®viewè§„åˆ™"></a>2ã€é…ç½®viewè§„åˆ™</h2><p>è¿™é‡Œè®¾ç½®ä¸¤ä¸ªå‰ç«¯å’Œä¸€ä¸ªåç«¯å®ä¾‹</p><a id="more"></a><h3 id="2-1ã€å‰ç«¯1"><a href="#2-1ã€å‰ç«¯1" class="headerlink" title="2.1ã€å‰ç«¯1"></a>2.1ã€å‰ç«¯1</h3><p><img src="https://img.xxlaila.cn/image2018-5-29_10-47-20.png" alt="img"></p><h3 id="2-2ã€å‰ç«¯test"><a href="#2-2ã€å‰ç«¯test" class="headerlink" title="2.2ã€å‰ç«¯test"></a>2.2ã€å‰ç«¯test</h3><p>test æˆ‘ä»¬ç”¨å®‰è£…çš„è¿™ä¸ªæ’ä»¶æ¥è¿›è¡Œé…ç½®,ç‚¹å‡»Add Job Filterâ€”â€”&gt;ä¼šæœ‰å¾ˆå¤šçš„è§„åˆ™ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„çŠ¶æ€ã€æ ç›®æ¥è¿›è¡Œå´åˆ†ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©</p><p><img src="https://img.xxlaila.cn/image2018-5-29_10-49-46.png" alt="img"><br><img src="https://img.xxlaila.cn/image2018-5-29_10-52-49.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæ·»åŠ äº†ä¸¤æ¡è§„åˆ™ï¼Œè¿™ä¸ªæ˜¯å»ºç«‹jobçš„æ—¶å€™æœ‰ç‚¹ç‰¹æ®Šæ€§ï¼Œç”¨ç¬¬ä¸€ç§æ–¹å¼å®ç°å°±ä¼šæœ‰é—®é¢˜ï¼Œç¬¬ä¸€æ¡è§„åˆ™æ˜¯ç°å®æ‰€æœ‰testç±»çš„jobï¼Œä½†æ˜¯å§ä¸‹é¢çš„ä¸€æ¡ç»™åŠ è¿›æ¥äº†ï¼Œä¸ç°å®è¿™ç±»jobã€‚ä¿æŒå³å¯</p><h2 id="åç«¯javaç¨‹åº"><a href="#åç«¯javaç¨‹åº" class="headerlink" title="åç«¯javaç¨‹åº"></a>åç«¯javaç¨‹åº</h2><p>devç¯å¢ƒä¸ºä¾‹å­</p><p><img src="https://img.xxlaila.cn/image2018-5-29_10-54-54.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins job</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsç”¨æˆ·æƒé™é…ç½®</title>
    <url>/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><h3 id="1ã€jenkinsç”¨æˆ·æƒé™"><a href="#1ã€jenkinsç”¨æˆ·æƒé™" class="headerlink" title="1ã€jenkinsç”¨æˆ·æƒé™"></a>1ã€jenkinsç”¨æˆ·æƒé™</h3><ul><li>å¯ä»¥é›†æˆgitlabã€jenkinsä¸“æœ‰è´¦æˆ·ã€LDAPã€Servletå®¹å™¨ä»£ç†ã€Unixç”¨æˆ·/ç»„æ•°æ®åº“</li></ul><h3 id="2ã€æˆæƒç­–ç•¥"><a href="#2ã€æˆæƒç­–ç•¥" class="headerlink" title="2ã€æˆæƒç­–ç•¥"></a>2ã€æˆæƒç­–ç•¥</h3><ul><li>Gitlab Commiter Authorization Strategy</li><li>Role-Based Strategy</li><li>ä»»ä½•ç”¨æˆ·å¯ä»¥åšä»»ä½•äº‹(æ²¡æœ‰ä»»ä½•é™åˆ¶)</li><li>å®‰å…¨çŸ©é˜µ</li><li>ç™»å½•ç”¨æˆ·å¯ä»¥åšä»»ä½•äº‹</li><li>é—ç•™æ¨¡å¼</li><li>é¡¹ç›®çŸ©é˜µæˆæƒç­–ç•¥</li></ul><h3 id="3ã€æ’ä»¶å®‰è£…"><a href="#3ã€æ’ä»¶å®‰è£…" class="headerlink" title="3ã€æ’ä»¶å®‰è£…"></a>3ã€æ’ä»¶å®‰è£…</h3><p>å®‰è£…æ’ä»¶ï¼šRole-based Authorization Strategy</p><a id="more"></a><h3 id="4ã€jenkinsè®¾ç½®"><a href="#4ã€jenkinsè®¾ç½®" class="headerlink" title="4ã€jenkinsè®¾ç½®"></a>4ã€jenkinsè®¾ç½®</h3><p>ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®â€”â€”&gt;<br><img src="https://img.xxlaila.cn/image2018-5-11_14-26-37.png" alt="img"></p><p>å›åˆ°ç³»ç»Ÿç®¡ç†ç•Œé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°å¤šå‡ºæ¥ä¸€ä¸ªæ’ä»¶: Mangge and Assing Roles</p><h3 id="5ã€æƒé™è®¾ç½®"><a href="#5ã€æƒé™è®¾ç½®" class="headerlink" title="5ã€æƒé™è®¾ç½®"></a>5ã€æƒé™è®¾ç½®</h3><p>è¿›å…¥Manager and Assign Rolesâ€”â€”&gt;Manage Roles,è¿™é‡Œå»ºç«‹äº†å››ä¸ªæƒé™ï¼Œåˆ†åˆ«æ¥å¯¹åº”ä¸åŒçš„äººå‘˜<br><img src="https://img.xxlaila.cn/image2018-5-24_11-35-15.png" alt="img"></p><ul><li>åˆ›å»ºé¡¹ç›®è§’è‰²:</li></ul><p><img src="https://img.xxlaila.cn/image2018-5-24_11-35-27.png" alt="img"></p><p>å›åˆ°Manage and Assign Rolesç•Œé¢</p><h3 id="6ã€é…ç½®è§’è‰²"><a href="#6ã€é…ç½®è§’è‰²" class="headerlink" title="6ã€é…ç½®è§’è‰²"></a>6ã€é…ç½®è§’è‰²</h3><p>é€‰æ‹©Assign Roles,ç”¨æˆ·æ–°å»ºä»¥åï¼Œæ ¹æ®ç”¨æˆ·ä¸åŒç±»å‹çš„å‹¾é€‰ä¸åŒçš„æƒé™,</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodbå‰¯æœ¬é›†</title>
    <url>/2019/08/09/mongodb%E5%89%AF%E6%9C%AC%E9%9B%86/</url>
    <content><![CDATA[<!-- build time:Thu Nov 07 2019 10:52:26 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Mongodb replica setå®‰è£…åŠ è®¤è¯ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯keyFileè¿›è¡Œè®¤è¯ï¼Œä¹‹å‰çœ‹è¿‡å¾ˆå¤šæ–‡ç« ï¼Œå‘ä¸€å¤§å †ï¼Œè¿™é‡Œæ˜¯çœ‹äº†ä¸¤å¤©çš„å®˜æ–¹æ–‡æ¡£è¿›è¡Œçš„å®‰è£…ï¼Œå¹¶ç”¨æˆ·ç”Ÿäº§ï¼Œé…ç½®æ–‡ä»¶å‚æ•°è´´ä¸€éƒ¨åˆ†,ä¸‰ä¸ªå¸¦æœ‰æ•°æ®é›†çš„èŠ‚ç‚¹ç»„æˆçš„å¤åˆ¶é›†æ‹¥æœ‰ï¼Œæ¶æ„å›¾å¦‚ä¸‹ï¼Œå‚è€ƒå®˜æ–¹</p><p><img src="https://img.xxlaila.cn/image2018-8-13_15-27-53.png" alt="img"><br>ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ï¼Œè¿™ä¸¤ä¸ªä»èŠ‚ç‚¹éƒ½å¯ä»¥åœ¨é€‰ä¸¾ä¸­å‡çº§ä¸ºä¸»èŠ‚ç‚¹</p><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>ä¸‰å°æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">primary: 192.168.32.7</span><br><span class="line">secaodray: 192.168.32.11</span><br><span class="line">secondary: 192.168.32.14</span><br></pre></td></tr></table></figure><h2 id="1ã€å®‰è£…mongodb"><a href="#1ã€å®‰è£…mongodb" class="headerlink" title="1ã€å®‰è£…mongodb"></a>1ã€å®‰è£…mongodb</h2><h3 id="1-1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ"><a href="#1-1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ" class="headerlink" title="1.1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ"></a>1.1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo vim /etc/yum.repos.d/mongodb-enterprise.repo</span></span><br><span class="line">[mongodb-enterprise]</span><br><span class="line">name=MongoDB Enterprise Repository</span><br><span class="line">baseurl=https://repo.mongodb.com/yum/redhat/<span class="variable">$releasever</span>/mongodb-enterprise/3.4/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc   </span><br><span class="line"></span><br><span class="line"><span class="comment"># sudo yum install -y mongodb-enterprise</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå¦‚æœé‡‡ç”¨æºç åŒ…æ–¹å¼å®‰è£…éœ€è¦å®‰è£…ä¸€ä¸‹æ’ä»¶</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo yum install cyrus-sasl cyrus-sasl-plain cyrus-sasl-gssapi krb5-libs lm_sensors-libs net-snmp-agent-libs net-snmp openssl rpm-libs tcp_wrappers-libs libcurl</span></span><br></pre></td></tr></table></figure><h2 id="2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶-æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ"><a href="#2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶-æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ" class="headerlink" title="2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶(æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ)"></a>2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶(æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ)</h2><h3 id="è‡ªå®šä¹‰mongodbçš„ç›®å½•"><a href="#è‡ªå®šä¹‰mongodbçš„ç›®å½•" class="headerlink" title="è‡ªå®šä¹‰mongodbçš„ç›®å½•"></a>è‡ªå®šä¹‰mongodbçš„ç›®å½•</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /opt/mongodb/&#123;data,conf,logs&#125; -p</span></span><br><span class="line"><span class="comment"># sudo vim /etc/mongod.conf</span></span><br><span class="line"> systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /opt/mongodb/logs/mongod.log</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /opt/mongodb/data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  pidFilePath: /opt/mongodb/logs/mongod.pid</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0</span><br></pre></td></tr></table></figure><h3 id="3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶-åœ¨mong01ä¸Šæ“ä½œ"><a href="#3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶-åœ¨mong01ä¸Šæ“ä½œ" class="headerlink" title="3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶(åœ¨mong01ä¸Šæ“ä½œ)"></a>3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶(åœ¨mong01ä¸Šæ“ä½œ)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl rand -base64 756 &gt; ï¼opt/mongodb/conf/mongo-keyfile</span></span><br><span class="line"><span class="comment"># sudo chmod 400 /opt/mongo/mongo-keyfile</span></span><br><span class="line"><span class="comment"># scp â€“r mongo-keyfile user@192.168.32.11:/opt/mongodb/conf</span></span><br><span class="line"><span class="comment"># scp â€“r mongo-keyfile user@192.168.32.14:/opt/mongodb/conf</span></span><br></pre></td></tr></table></figure><h3 id="4ã€ä¿®æ”¹mongodbçš„é…ç½®"><a href="#4ã€ä¿®æ”¹mongodbçš„é…ç½®" class="headerlink" title="4ã€ä¿®æ”¹mongodbçš„é…ç½®"></a>4ã€ä¿®æ”¹mongodbçš„é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">security:</span><br><span class="line">  keyFile: /opt/mongodb/conf/mongo-keyfile</span><br><span class="line">replication:</span><br><span class="line">  replSetName: xxlaila01ï¼ˆå¯å˜åŒ–ï¼Œè‡ªå®šä¹‰ï¼‰</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«åœ¨ä¸‰å°æœåŠ¡å™¨ä¸Šå¯åŠ¨mongodb</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mongod --config /etc/mongod.conf</span></span><br></pre></td></tr></table></figure><h3 id="5ã€å»ºç«‹é›†ç¾¤"><a href="#5ã€å»ºç«‹é›†ç¾¤" class="headerlink" title="5ã€å»ºç«‹é›†ç¾¤"></a>5ã€å»ºç«‹é›†ç¾¤</h3><p>åœ¨ä½ éœ€è¦è®¤ä¸ºæ˜¯ä¸»èŠ‚ç‚¹çš„æœåŠ¡å™¨è¿›è¡Œmongodbçš„ç™»é™†ï¼Œå’Œè´¦æˆ·æƒé™çš„å»ºç«‹ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©çš„192.168.32.7</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongo --shell --host 127.0.0.1</span><br></pre></td></tr></table></figure><p>ç™»é™†è¿›å»ä»¥åå¯ä»¥è¿›è¡Œä¸€ä¸ªç®€å•çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹</p><p><img src="https://img.xxlaila.cn/image2018-8-13_15-37-2.png" alt="img"></p><h3 id="6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†"><a href="#6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†" class="headerlink" title="6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†"></a>6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise &gt; config = &#123; _id:<span class="string">"kxlprod01"</span>,members:[ &#123;_id:0,host:<span class="string">"192.168.32.7:27017"</span>&#125;,</span><br><span class="line">...   &#123;_id:1,host:<span class="string">"192.168.32.11:27017"</span>&#125; ,&#123;_id:2,host:<span class="string">"192.168.32.14:27017"</span>&#125;] &#125;</span><br></pre></td></tr></table></figure><p>config = { _id:â€kxlprod01â€,members:[ {_id:0,host:â€192.168.32.7:27017â€},{_id:1,host:â€192.168.32.11:27017â€} ,{_id:2,host:â€192.168.32.14:27017â€}] }ï¼Œå¢åŠ å†…å®¹</p><h4 id="6-1-çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€"><a href="#6-1-çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€" class="headerlink" title="6.1 çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€"></a>6.1 çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€</h4><p>åˆ©ç”¨rs.status()å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; rs.status()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæç¤ºé…ç½®è¿˜æ²¡æœ‰åŠ è½½åˆ°mongodbå‰¯æœ¬é‡Œé¢</p><h4 id="6-2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†"><a href="#6-2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†" class="headerlink" title="6.2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†"></a>6.2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; rs.initiate(config)</span><br></pre></td></tr></table></figure><p>å†æ¬¡æŸ¥çœ‹å‰¯æœ¬çš„çŠ¶æ€å°±å¯ä»¥çœ‹åˆ°mongodbçš„å‰¯æœ¬é›†å·²å»ºç«‹ï¼Œå¦‚æœæ­¤æ—¶ä¸»èŠ‚ç‚¹æœªè¢«é€‰ä¸¾å‡ºæ¥ï¼Œç¨å¾®ç­‰ä¸€ä¼šå°±æˆåŠŸ</p><h3 id="7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯"><a href="#7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯" class="headerlink" title="7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯"></a>7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯</h3><p>ä¸‹é¢ä¸¤è¡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡ä¸»èŠ‚ç‚¹æ²¡æœ‰é€‰ä¸¾æˆåŠŸï¼Œéšå³æˆ‘ä»¬åœ¨å›è½¦PRIMARYèŠ‚ç‚¹é€‰ä¸¾æˆåŠŸäº†ï¼Œä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise xxlaila01:SECONDARY&gt; admin = db.getSiblingDB(<span class="string">"admin"</span>)</span><br><span class="line">MongoDB Enterprise xxlaila01:PRIMARY&gt;</span><br><span class="line">admin.createUser(</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    user: <span class="string">"root"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"123456"</span>,</span><br><span class="line"></span><br><span class="line">    roles: [ &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"root"</span>, <span class="string">"123456"</span> )</span><br></pre></td></tr></table></figure><h4 id="7-1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·"><a href="#7-1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·" class="headerlink" title="7.1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·"></a>7.1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·</h4><p>åˆ›å»ºä¸€ä¸ªé›†ç¾¤ç®¡ç†è´¦æˆ·ï¼Œé›†ç¾¤è´¦æˆ·å…·æœ‰ç®¡ç†æ•´ä¸ªå‰¯æœ¬é›†çš„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo -u <span class="string">"root"</span> -p <span class="string">"123456"</span> --authenticationDatabase <span class="string">"admin"</span></span><br><span class="line"></span><br><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"user"</span> : <span class="string">"manger"</span>,</span><br><span class="line">    <span class="string">"pwd"</span> : <span class="string">"123456"</span>,</span><br><span class="line">    roles: [ &#123; <span class="string">"role"</span> : <span class="string">"clusterAdmin"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span> &#125; ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="7-2-åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·"><a href="#7-2-åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·" class="headerlink" title="7.2 åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·"></a>7.2 åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"user"</span> : <span class="string">"systemprod"</span>,</span><br><span class="line">    <span class="string">"pwd"</span> : <span class="string">"123456"</span>,</span><br><span class="line">    roles: [ &#123; <span class="string">"role"</span> : <span class="string">"root"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è‡³æ­¤mongodbçš„å‰¯æœ¬é›†åˆ›å»ºå®Œæˆã€‚æµ‹è¯•æ²¡æœ‰é—®é¢˜,ç™»é™†å…¶ä¸­ä¸€å°SECONDARYæœåŠ¡å™¨è¿›è¡Œæµ‹è¯•,è¿™é‡Œæµ‹è¯•192.168.32.11æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo</span><br><span class="line"></span><br><span class="line">&gt; rs.status()    <span class="comment"># è¿™é‡Œæç¤ºæ²¡æœ‰æƒé™ï¼ˆç™»å½•è¿›æ¥ä»¥åå¦‚æœä¸æ˜¯ä¸»å‡ ç‚¹ï¼Œmognodbå°±ä¼šé»˜è®¤æ˜¾ç¤ºæœªsecondaryï¼‰</span></span><br><span class="line"></span><br><span class="line">&gt; use admin 	<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">&gt; db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"manger"</span>, <span class="string">"123456"</span>)</span><br></pre></td></tr></table></figure><p>å®Œæˆåæˆ‘ä»¬åœ¨æ‰§è¡Œrs.status()å°±å¯ä»¥çœ‹åˆ°å‰¯æœ¬é›†çš„ä¿¡æ¯</p><h4 id="7-3-æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·"><a href="#7-3-æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·" class="headerlink" title="7.3 æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·"></a>7.3 æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise xxlaila01:SECONDARY&gt; db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"systemprod"</span>, <span class="string">"123456"</span> )</span><br><span class="line">&gt; show dbs;	<span class="comment">#ä¼šæç¤º â€œnot master and slaveok=falseâ€</span></span><br><span class="line"></span><br><span class="line">&gt; db.getMongo().setSlaveOk()</span><br><span class="line">&gt; show dbs;	<span class="comment">#åœ¨æ¬¡æ‰§è¡Œä¼šæ˜¾ç¤ºå‡ºç»“æœ</span></span><br></pre></td></tr></table></figure><p>å‰¯æœ¬é›†æ²¡æœ‰è¯»çš„æƒé™ï¼Œéœ€è¦æ‰§è¡Œdb.getMongo().setSlaveOk()</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>mongodb,mongodbå‰¯æœ¬é›†,mongodbé«˜å¯ç”¨</tag>
      </tags>
  </entry>
</search>
