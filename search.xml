<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>istioéƒ¨ç½²</title>
    <url>/2019/10/29/istio%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="Istioä»‹ç»"><a href="#Istioä»‹ç»" class="headerlink" title="Istioä»‹ç»"></a>Istioä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;istioä»£è¡¨çš„æ˜¯Service Meshçš„æ–¹æ¡ˆå®ç°ï¼ŒIstio æœ‰åŠ©äºé™ä½è¿™äº›éƒ¨ç½²çš„å¤æ‚æ€§ï¼Œå¹¶å‡è½»å¼€å‘å›¢é˜Ÿçš„å‹åŠ›ã€‚æä¾›ä¸€ç§ç®€å•çš„æ–¹å¼æ¥ä¸ºå·²éƒ¨ç½²çš„æœåŠ¡å»ºç«‹ç½‘ç»œï¼Œä¸”æä¾›å…·æœ‰è´Ÿè½½å‡è¡¡ã€æœåŠ¡é—´è®¤è¯ã€ç›‘æ§ã€æµé‡ç®¡ç†ç­‰åŠŸèƒ½ã€‚</p><a id="more"></a><h3 id="æœåŠ¡ç½‘æ ¼ï¼ˆService-Meshï¼‰"><a href="#æœåŠ¡ç½‘æ ¼ï¼ˆService-Meshï¼‰" class="headerlink" title="æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰"></a>æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰ç”¨äºæè¿°æ„æˆè¿™äº›åº”ç”¨ç¨‹åºçš„å¾®æœåŠ¡ç½‘ç»œä»¥åŠåº”ç”¨ä¹‹é—´çš„äº¤äº’ã€‚éšç€è§„æ¨¡å’Œå¤æ‚æ€§çš„å¢é•¿ï¼ŒæœåŠ¡ç½‘æ ¼è¶Šæ¥è¶Šéš¾ä»¥ç†è§£å’Œç®¡ç†ã€‚å®ƒçš„éœ€æ±‚åŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœæ¢å¤ã€æŒ‡æ ‡æ”¶é›†å’Œç›‘æ§ä»¥åŠé€šå¸¸æ›´åŠ å¤æ‚çš„è¿ç»´éœ€æ±‚ï¼Œä¾‹å¦‚ A/B æµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒã€é™æµã€è®¿é—®æ§åˆ¶å’Œç«¯åˆ°ç«¯è®¤è¯ç­‰ã€‚è€Œistioåˆšå¥½æä¾›äº†ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡æ§åˆ¶æ•´ä¸ªæœåŠ¡å™¨ç½‘æ ¼æä¾›è¡Œä¸ºæ´å¯Ÿå’Œæ“ä½œæ§åˆ¶æ¥æ»¡è¶³å¾®æœåŠ¡åº”ç”¨çš„å¤šæ ·åŒ–</p><h3 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio æœåŠ¡ç½‘æ ¼é€»è¾‘ä¸Šåˆ†ä¸ºæ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ã€‚</p><ul><li>æ•°æ®å¹³é¢ç”±ä¸€ç»„ä»¥ sidecar æ–¹å¼éƒ¨ç½²çš„æ™ºèƒ½ä»£ç†ï¼ˆEnvoyï¼‰ç»„æˆã€‚è¿™äº›ä»£ç†å¯ä»¥è°ƒèŠ‚å’Œæ§åˆ¶å¾®æœåŠ¡åŠ Mixer ä¹‹é—´æ‰€æœ‰çš„ç½‘ç»œé€šä¿¡ã€‚</li><li>æ§åˆ¶å¹³é¢è´Ÿè´£ç®¡ç†å’Œé…ç½®ä»£ç†æ¥è·¯ç”±æµé‡ã€‚æ­¤å¤–æ§åˆ¶å¹³é¢é…ç½® Mixer ä»¥å®æ–½ç­–ç•¥å’Œæ”¶é›†é¥æµ‹æ•°æ®ã€‚</li></ul><p>æ„æˆæ¯ä¸ªé¢æ¿çš„ä¸åŒç»„ä»¶:<br><img src="https://img.xxlaila.cn/1567136153850.jpg" alt="img"></p><h4 id="istio-ç»„ä»¶"><a href="#istio-ç»„ä»¶" class="headerlink" title="istio ç»„ä»¶"></a>istio ç»„ä»¶</h4><ul><li>Envoy: Istio ä½¿ç”¨ Envoy ä»£ç†çš„æ‰©å±•ç‰ˆæœ¬ï¼Œç”¨äºè°ƒè§£æœåŠ¡ç½‘æ ¼ä¸­æ‰€æœ‰æœåŠ¡çš„æ‰€æœ‰å…¥ç«™å’Œå‡ºç«™æµé‡ï¼Œå±äºæ•°æ®å±‚é¢ã€‚Istioåˆ©ç”¨Envoyçš„å†…ç½®åŠŸèƒ½å®ç°å¦‚ä¸‹æŒ‡æ ‡:<ul><li>åŠ¨æ€æœåŠ¡å‘ç°</li><li>è´Ÿè½½å‡è¡¡</li><li>TLSç»ˆæ­¢</li><li>HTTP/2å’ŒgRPCä»£ç†</li><li>æ–­è·¯å™¨</li><li>å¥åº·æ£€æŸ¥</li><li>åˆ†é˜¶æ®µæ¨å‡ºï¼ŒæŒ‰ç™¾åˆ†æ¯”åˆ†é…æµé‡</li><li>æ•…éšœæ³¨å…¥</li><li>ä¸°å¯Œçš„æŒ‡æ ‡</li></ul></li><li>Mixer: æ˜¯ä¸€ä¸ªç‹¬ç«‹äºå¹³å°çš„ç»„ä»¶ï¼Œè´Ÿè´£åœ¨æœåŠ¡ç½‘æ ¼ä¸Šæ‰§è¡Œè®¿é—®æ§åˆ¶å’Œä½¿ç”¨ç­–ç•¥ï¼Œå¹¶ä» Envoy ä»£ç†å’Œå…¶ä»–æœåŠ¡æ”¶é›†é¥æµ‹æ•°æ®</li><li>Pilot: ä¸º Envoy sidecar æä¾›æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œä¸ºæ™ºèƒ½è·¯ç”±ï¼ˆä¾‹å¦‚ A/B æµ‹è¯•ã€é‡‘ä¸é›€éƒ¨ç½²ç­‰ï¼‰å’Œå¼¹æ€§ï¼ˆè¶…æ—¶ã€é‡è¯•ã€ç†”æ–­å™¨ç­‰ï¼‰æä¾›æµé‡ç®¡ç†åŠŸèƒ½</li><li>Citadel: é€šè¿‡å†…ç½®èº«ä»½å’Œå‡­è¯ç®¡ç†èµ‹èƒ½å¼ºå¤§çš„æœåŠ¡é—´å’Œæœ€ç»ˆç”¨æˆ·èº«ä»½éªŒè¯ã€‚å¯ç”¨äºå‡çº§æœåŠ¡ç½‘æ ¼ä¸­æœªåŠ å¯†çš„æµé‡ï¼Œå¹¶ä¸ºè¿ç»´äººå‘˜æä¾›åŸºäºæœåŠ¡æ ‡è¯†è€Œä¸æ˜¯ç½‘ç»œæ§åˆ¶çš„å¼ºåˆ¶æ‰§è¡Œç­–ç•¥çš„èƒ½åŠ›</li><li>Galley: ä»£è¡¨å…¶ä»–çš„ Istio æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œç”¨æ¥éªŒè¯ç”¨æˆ·ç¼–å†™çš„ Istio API é…ç½®ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒGalley å°†æ¥ç®¡ Istio è·å–é…ç½®ã€ å¤„ç†å’Œåˆ†é…ç»„ä»¶çš„é¡¶çº§è´£ä»»</li></ul><h3 id="Istion-å®‰è£…"><a href="#Istion-å®‰è£…" class="headerlink" title="Istion å®‰è£…"></a>Istion å®‰è£…</h3><h4 id="ä¸‹è½½istioåŒ…"><a href="#ä¸‹è½½istioåŒ…" class="headerlink" title="ä¸‹è½½istioåŒ…"></a>ä¸‹è½½istioåŒ…</h4><p>æ‰§è¡Œä¸‹è½½å’Œè‡ªåŠ¨è§£å‹ç¼©</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://git.io/getLatestIstio | ISTIO_VERSION=1.2.8 sh -</span></span><br><span class="line"><span class="comment"># cd istio-1.2.8/bin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp istioctl /usr/bin/</span></span><br></pre></td></tr></table></figure><p>å®‰è£…ç›®å½•ä¸­åŒ…å«ï¼š</p><ul><li><code>åœ¨ install/</code>: ç›®å½•ä¸­åŒ…å«äº† Kubernetes å®‰è£…æ‰€éœ€çš„ .yaml æ–‡ä»¶</li><li><code>samples/</code>: ç›®å½•ä¸­æ˜¯ç¤ºä¾‹åº”ç”¨</li><li><code>istioctl</code>: istioctlå®¢æˆ·ç«¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ‰‹åŠ¨å°†Envoyä½œä¸ºSidecarä»£ç†æ³¨å…¥å¹¶åˆ›å»ºè·¯ç”±è§„åˆ™å’Œç­–ç•¥æ—¶ï¼Œå°†ä½¿ç”¨æ­¤å·¥å…·ã€‚</li><li><code>istio.VERSION</code>: é…ç½®æ–‡ä»¶</li></ul><h3 id="åœ¨kubernetes-é›†ç¾¤ä¸­å®‰è£…"><a href="#åœ¨kubernetes-é›†ç¾¤ä¸­å®‰è£…" class="headerlink" title="åœ¨kubernetes é›†ç¾¤ä¸­å®‰è£…"></a>åœ¨kubernetes é›†ç¾¤ä¸­å®‰è£…</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio ä¼šè¢«å®‰è£…åˆ°è‡ªå·±çš„ istio-system å‘½åç©ºé—´ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¯¹æ‰€æœ‰å…¶ä»–å‘½åç©ºé—´çš„æœåŠ¡è¿›è¡Œç®¡ç†ã€‚è¿™é‡Œé‡‡ç”¨helmè¿›è¡Œå®‰è£…ï¼Œ<a href="https://xxlaila.github.io/2019/09/04/k8s-helm/" target="_blank" rel="noopener">helmå®‰è£…å‚è€ƒ</a>ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºKialiè®¾ç½®èº«ä»½éªŒè¯å‡­æ®ï¼ˆç›‘è§†ï¼‰ã€‚ç”¨äºåé¢çš„ç™»å½•è®¤è¯</p><h4 id="è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡"><a href="#è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡" class="headerlink" title="è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡"></a>è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># KIALI_USERNAME=$(read -p 'Kiali Username: ' uval &amp;&amp; echo -n $uval | base64)</span></span><br><span class="line"><span class="comment"># KIALI_PASSPHRASE=$(read -sp 'Kiali Passphrase: ' pval &amp;&amp; echo -n $pval | base64)</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºå‘½åç©ºé—´"><a href="#åˆ›å»ºå‘½åç©ºé—´" class="headerlink" title="åˆ›å»ºå‘½åç©ºé—´"></a>åˆ›å»ºå‘½åç©ºé—´</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># NAMESPACE=istio-system</span></span><br><span class="line"><span class="comment"># kubectl create namespace $NAMESPACE</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºç”¨äºå­˜å‚¨ä¸Šé¢è®¾ç½®çš„ç”¨æˆ·å/å¯†ç çš„æœºå¯†<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: kiali</span><br><span class="line">  namespace: <span class="variable">$NAMESPACE</span></span><br><span class="line">  labels:</span><br><span class="line">    app: kiali</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  username: <span class="variable">$KIALI_USERNAME</span></span><br><span class="line">  passphrase: <span class="variable">$KIALI_PASSPHRASE</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="ä½¿ç”¨helmå®‰è£…istio-CRD"><a href="#ä½¿ç”¨helmå®‰è£…istio-CRD" class="headerlink" title="ä½¿ç”¨helmå®‰è£…istio CRD"></a>ä½¿ç”¨helmå®‰è£…istio CRD</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm install install/kubernetes/helm/istio-init --name istio-init --namespace istio-system</span></span><br><span class="line">NAME:   istio-init</span><br><span class="line">LAST DEPLOYED: Fri Nov  1 10:13:22 2019</span><br><span class="line">NAMESPACE: istio-system</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/ClusterRole</span><br><span class="line">NAME                     AGE</span><br><span class="line">istio-init-istio-system  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ClusterRoleBinding</span><br><span class="line">NAME                                        AGE</span><br><span class="line">istio-init-admin-role-binding-istio-system  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME          DATA  AGE</span><br><span class="line">istio-crd-10  1     0s</span><br><span class="line">istio-crd-11  1     0s</span><br><span class="line">istio-crd-12  1     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Job</span><br><span class="line">NAME                     COMPLETIONS  DURATION  AGE</span><br><span class="line">istio-init-crd-10-1.2.8  0/1          0s</span><br><span class="line">istio-init-crd-11-1.2.8  0/1          0s</span><br><span class="line">istio-init-crd-12-1.2.8  0/1          0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ServiceAccount</span><br><span class="line">NAME                        SECRETS  AGE</span><br><span class="line">istio-init-service-account  0        0s</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod"><a href="#æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod" class="headerlink" title="æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod"></a>æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¿°å®‰è£…ä¼šæŠŠistioçš„23ä¸ªcrdéƒ½æäº¤ç»™kubernetes api æœåŠ¡å™¨ã€‚å¦‚æœå¯ç”¨äº†è¯ä¹¦ç®¡ç†ï¼Œcrdè®¡æ•°å™¨ä¸º28ä¸ªã€‚æˆ‘è¿™é‡Œæœªå¯ç”¨è¯ä¹¦ç®¡ç†ï¼Œåªæœ‰23ä¸ªã€‚è¿˜ç”Ÿæˆä¸‰ä¸ªpod</p><ul><li><p>CRD</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get CustomResourceDefinition</span></span><br><span class="line">NAME                                   CREATED AT</span><br><span class="line">adapters.config.istio.io               2019-10-29T08:41:31Z</span><br><span class="line">attributemanifests.config.istio.io     2019-10-29T08:41:30Z</span><br><span class="line">authorizationpolicies.rbac.istio.io    2019-10-29T08:41:36Z</span><br><span class="line">certificates.certmanager.k8s.io        2019-10-29T08:41:38Z</span><br><span class="line">challenges.certmanager.k8s.io          2019-10-29T08:41:40Z</span><br><span class="line">clusterissuers.certmanager.k8s.io      2019-10-29T08:41:37Z</span><br><span class="line">clusterrbacconfigs.rbac.istio.io       2019-10-29T08:41:26Z</span><br><span class="line">destinationrules.networking.istio.io   2019-10-29T08:41:25Z</span><br><span class="line">envoyfilters.networking.istio.io       2019-10-29T08:41:26Z</span><br><span class="line">gateways.networking.istio.io           2019-10-29T08:41:26Z</span><br><span class="line">handlers.config.istio.io               2019-10-29T08:41:33Z</span><br><span class="line">httpapispecbindings.config.istio.io    2019-10-29T08:41:27Z</span><br><span class="line">httpapispecs.config.istio.io           2019-10-29T08:41:28Z</span><br><span class="line">instances.config.istio.io              2019-10-29T08:41:32Z</span><br><span class="line">issuers.certmanager.k8s.io             2019-10-29T08:41:37Z</span><br><span class="line">meshpolicies.authentication.istio.io   2019-10-29T08:41:27Z</span><br><span class="line">orders.certmanager.k8s.io              2019-10-29T08:41:40Z</span><br><span class="line">policies.authentication.istio.io       2019-10-29T08:41:27Z</span><br><span class="line">quotaspecbindings.config.istio.io      2019-10-29T08:41:28Z</span><br><span class="line">quotaspecs.config.istio.io             2019-10-29T08:41:29Z</span><br><span class="line">rbacconfigs.rbac.istio.io              2019-10-29T08:41:31Z</span><br><span class="line">rules.config.istio.io                  2019-10-29T08:41:30Z</span><br><span class="line">serviceentries.networking.istio.io     2019-10-29T08:41:25Z</span><br><span class="line">servicerolebindings.rbac.istio.io      2019-10-29T08:41:31Z</span><br><span class="line">serviceroles.rbac.istio.io             2019-10-29T08:41:31Z</span><br><span class="line">sidecars.networking.istio.io           2019-10-29T08:41:34Z</span><br><span class="line">templates.config.istio.io              2019-10-29T08:41:32Z</span><br><span class="line">virtualservices.networking.istio.io    2019-10-29T08:41:25Z</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get crds | grep 'istio.io\|certmanager.k8s.io' | wc -l</span></span><br><span class="line">23</span><br></pre></td></tr></table></figure></li><li><p>pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">NAME                            READY   STATUS      RESTARTS   AGE</span><br><span class="line">istio-init-crd-10-1.2.8-pbtb8   0/1     Completed   0          47s</span><br><span class="line">istio-init-crd-11-1.2.8-shx6q   0/1     Completed   0          47s</span><br><span class="line">istio-init-crd-12-1.2.8-zmh2w   0/1     Completed   0          47s</span><br></pre></td></tr></table></figure></li></ul><h4 id="ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶"><a href="#ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶" class="headerlink" title="ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶"></a>ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install install/kubernetes/helm/istio --<span class="built_in">wait</span> \</span><br><span class="line">    --name istio \</span><br><span class="line">    --namespace istio-system \</span><br><span class="line">    --<span class="built_in">set</span> global.mtls.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> tracing.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> grafana.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> servicegraph.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> global.k8sIngress.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> global.k8sIngress.gatewayName=ingressgateway \</span><br><span class="line">    --<span class="built_in">set</span> grafana.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.createDemoSecret=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.contextPath=/ \</span><br><span class="line">    --<span class="built_in">set</span> <span class="string">"kiali.dashboard.jaegerURL=http://jaeger-query:16686"</span> \</span><br><span class="line">    --<span class="built_in">set</span> <span class="string">"kiali.dashboard.grafanaURL=http://grafana:3000"</span> \</span><br><span class="line">    --<span class="built_in">set</span> gateways.istio-ingressgateway.type=NodePort \</span><br><span class="line">    --<span class="built_in">set</span> gateways.istio-egressgateway.type=NodePort \</span><br><span class="line">    --<span class="built_in">set</span> sidecarInjectorWebhook.enabled=<span class="literal">false</span></span><br></pre></td></tr></table></figure><h4 id="éªŒè¯å®‰è£…"><a href="#éªŒè¯å®‰è£…" class="headerlink" title="éªŒè¯å®‰è£…"></a>éªŒè¯å®‰è£…</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éªŒè¯æ–‡ä»¶é‡Œé¢çš„æœåŠ¡æ˜¯å¦éƒ½éƒ¨ç½²åœ¨kubernetes æœåŠ¡ä¸­ã€‚ç¡®ä¿éƒ¨ç½²çš„pod åœ¨å¯¹åº”çš„kubernetes namespace é‡Œé¢ï¼Œå¹¶æ­£å¸¸å¯åŠ¨ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æœŸé—´å°†åˆ›å»ºæ‰€éœ€çš„RBACæƒé™ï¼Œå¹¶éƒ¨ç½²Istio-Pilotï¼ŒIstio-Mixerï¼ŒIstio-Ingressï¼ŒIstio-Egresså’ŒIstio-CAï¼ˆè¯ä¹¦é¢å‘æœºæ„ï¼‰ã€‚</p><h5 id="æœåŠ¡å™¨éªŒè¯"><a href="#æœåŠ¡å™¨éªŒè¯" class="headerlink" title="æœåŠ¡å™¨éªŒè¯"></a>æœåŠ¡å™¨éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®ä¿éƒ¨ç½²äº†ä»¥ä¸‹KubernetesæœåŠ¡ï¼šistio-pilotï¼Œistio-mixerï¼Œistio-ingressã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc -n istio-system</span></span><br><span class="line">NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                                                      AGE</span><br><span class="line">grafana                  ClusterIP   10.254.113.150   &lt;none&gt;        3000/TCP                                                                                                                                     3h22m</span><br><span class="line">istio-citadel            ClusterIP   10.254.27.143    &lt;none&gt;        8060/TCP,15014/TCP                                                                                                                           3h22m</span><br><span class="line">istio-galley             ClusterIP   10.254.155.177   &lt;none&gt;        443/TCP,15014/TCP,9901/TCP                                                                                                                   3h22m</span><br><span class="line">istio-ingressgateway     NodePort    10.254.170.109   &lt;none&gt;        15020:31952/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32532/TCP,15030:31518/TCP,15031:31525/TCP,15032:30404/TCP,15443:30309/TCP   3h22m</span><br><span class="line">istio-pilot              ClusterIP   10.254.228.182   &lt;none&gt;        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       3h22m</span><br><span class="line">istio-policy             ClusterIP   10.254.13.184    &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP                                                                                                                 3h22m</span><br><span class="line">istio-sidecar-injector   ClusterIP   10.254.154.169   &lt;none&gt;        443/TCP                                                                                                                                      3h22m</span><br><span class="line">istio-telemetry          ClusterIP   10.254.71.72     &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       3h22m</span><br><span class="line">jaeger-agent             ClusterIP   None             &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP                                                                                                                   3h22m</span><br><span class="line">jaeger-collector         ClusterIP   10.254.100.29    &lt;none&gt;        14267/TCP,14268/TCP                                                                                                                          3h22m</span><br><span class="line">jaeger-query             ClusterIP   10.254.18.117    &lt;none&gt;        16686/TCP                                                                                                                                    3h22m</span><br><span class="line">kiali                    ClusterIP   10.254.156.117   &lt;none&gt;        20001/TCP                                                                                                                                    3h22m</span><br><span class="line">prometheus               ClusterIP   10.254.145.181   &lt;none&gt;        9090/TCP                                                                                                                                     3h22m</span><br><span class="line">tracing                  ClusterIP   10.254.87.72     &lt;none&gt;        80/TCP                                                                                                                                       3h22m</span><br><span class="line">zipkin                   ClusterIP   10.254.39.22     &lt;none&gt;        9411/TCP                                                                                                                                     3h22m</span><br></pre></td></tr></table></figure><h5 id="pod-éªŒè¯"><a href="#pod-éªŒè¯" class="headerlink" title="pod éªŒè¯"></a>pod éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®ä¿å·²éƒ¨ç½²ç›¸åº”çš„Kubernetes Podï¼Œå¹¶ä¸”æ‰€æœ‰å®¹å™¨éƒ½å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">grafana-6fb9f8c5c7-n2plk                  1/1     Running     0          3h19m</span><br><span class="line">istio-citadel-7c9b84ddb6-n5h2n            1/1     Running     0          3h19m</span><br><span class="line">istio-galley-64f7d8cc97-zdbb6             1/1     Running     0          3h19m</span><br><span class="line">istio-grafana-post-install-1.2.8-98grv    0/1     Completed   0          3h19m</span><br><span class="line">istio-ingressgateway-65c7498b78-dfmfp     1/1     Running     0          3h19m</span><br><span class="line">istio-init-crd-10-1.2.8-wxxjn             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-11-1.2.8-brjhh             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-12-1.2.8-w8wnc             0/1     Completed   0          3h20m</span><br><span class="line">istio-pilot-569499d666-vhgn5              2/2     Running     0          3h19m</span><br><span class="line">istio-policy-5dbbc56db5-dmr4p             2/2     Running     3          3h19m</span><br><span class="line">istio-sidecar-injector-747cf74498-99drh   1/1     Running     0          3h19m</span><br><span class="line">istio-telemetry-7db5dd4c57-zngq7          2/2     Running     4          3h19m</span><br><span class="line">istio-tracing-5d8f57c8ff-vt2kn            1/1     Running     0          3h19m</span><br><span class="line">kiali-7d749f9dcb-68tlt                    1/1     Running     0          3h19m</span><br><span class="line">prometheus-776fdf7479-zbrxl               1/1     Running     0          3h19m</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio ä»¥ä¸€ä¸ªé¡¹ç›®çš„å½¢å¼éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œéƒ¨ç½²å¥½çš„ pods ä¸­ï¼Œé™¤äº†æœ‰ istio-citadelã€ã€istio-ingressgatewayã€istio-pilot ç­‰ Istio æœ¬èº«çš„åŠŸèƒ½ç»„ä»¶ï¼Œè¿˜é›†æˆäº†å¾®æœåŠ¡ç›¸å…³çš„ç›‘æ§å·¥å…·ï¼Œï¼Œå¦‚ï¼šgrafanaã€jaeger-queryã€kialiã€prometheusã€‚è¿™äº›åŠŸèƒ½ä¸°å¯Œä¸”å¼ºå¤§çš„ç›‘æ§å·¥å…·ï¼Œå¸®åŠ© Istioå®ç°äº†å¾®æœåŠ¡çš„å¯è§†åŒ–ç®¡ç†ã€‚</p><h3 id="éƒ¨ç½²BookInfoç”¨ç¨‹åº"><a href="#éƒ¨ç½²BookInfoç”¨ç¨‹åº" class="headerlink" title="éƒ¨ç½²BookInfoç”¨ç¨‹åº"></a>éƒ¨ç½²BookInfoç”¨ç¨‹åº</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨å¼€å§‹éƒ¨ç½² Bookinfo ç¤ºä¾‹ç¨‹åºã€‚éƒ¨ç½²Bookinfoæ¡ä»¶æ˜¯é›†ç¾¤ä¸­è‡³å°‘æœ‰4ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸”æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸å¾—ä½äº4Gã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥éƒ¨ç½²å®‰è£…éšé™„çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºä¹‹ä¸€-BookInfoã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿä¹¦åº—åº”ç”¨ç¨‹åºï¼Œç”±å››ä¸ªæœåŠ¡ç»„æˆï¼Œè¿™äº›æœåŠ¡æä¾›ä¸€ä¸ªWebäº§å“é¡µé¢ï¼Œä¹¦ç±è¯¦ç»†ä¿¡æ¯ï¼Œè¯„è®ºï¼ˆå¸¦æœ‰å¤šä¸ªç‰ˆæœ¬çš„è¯„è®ºæœåŠ¡ï¼‰å’Œè¯„åˆ†-æ‰€æœ‰è¿™äº›éƒ½ä½¿ç”¨Istioè¿›è¡Œç®¡ç†ã€‚</p><ul><li><p>BookInfoåº”ç”¨ç¨‹åºåˆ†ä¸ºå››ä¸ªå•ç‹¬çš„å¾®æœåŠ¡:</p><ul><li>productpage ï¼šproductpage å¾®æœåŠ¡ä¼šè°ƒç”¨ details å’Œ reviews ä¸¤ä¸ªå¾®æœåŠ¡ï¼Œç”¨æ¥ç”Ÿæˆé¡µé¢ã€‚</li><li>details ï¼šè¿™ä¸ªå¾®æœåŠ¡åŒ…å«äº†ä¹¦ç±çš„ä¿¡æ¯ã€‚</li><li>reviews ï¼šè¿™ä¸ªå¾®æœåŠ¡åŒ…å«äº†ä¹¦ç±ç›¸å…³çš„è¯„è®ºã€‚å®ƒè¿˜ä¼šè°ƒç”¨ ratings å¾®æœåŠ¡ã€‚</li><li>ratings ï¼šratings å¾®æœåŠ¡ä¸­åŒ…å«äº†ç”±ä¹¦ç±è¯„ä»·ç»„æˆçš„è¯„çº§ä¿¡æ¯ã€‚</li></ul></li><li><p>reviews å¾®æœåŠ¡æœ‰ 3 ä¸ªç‰ˆæœ¬ï¼š</p><ul><li>v1 ç‰ˆæœ¬ä¸ä¼šè°ƒç”¨ ratings æœåŠ¡.</li><li>v2 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªé»‘è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li><li>v3 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªçº¢è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li></ul></li><li><p>ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸ªåº”ç”¨çš„ç«¯åˆ°ç«¯æ¶æ„<br><img src="https://img.xxlaila.cn/1572576628250.jpg" alt="img"></p></li></ul><h4 id="æ‰“æ ‡ç­¾"><a href="#æ‰“æ ‡ç­¾" class="headerlink" title="æ‰“æ ‡ç­¾"></a>æ‰“æ ‡ç­¾</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸º default å‘½åç©ºé—´æ‰“ä¸Šæ ‡ç­¾ istio-injection=enabledï¼Œå®ç° Sidecar è‡ªåŠ¨æ³¨å…¥ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label namespace default istio-injection=enabled</span></span><br><span class="line">namespace/default labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get namespace --show-labels</span></span><br><span class="line">NAME              STATUS   AGE   LABELS</span><br><span class="line">default           Active   43d   istio-injection=enabled</span><br><span class="line">istio-system      Active   29m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   43d   &lt;none&gt;</span><br><span class="line">kube-public       Active   43d   &lt;none&gt;</span><br><span class="line">kube-system       Active   43d   &lt;none&gt;</span><br><span class="line">monitoring        Active   35d   &lt;none&gt;</span><br><span class="line">weave             Active   35d   &lt;none&gt;</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„:</strong> æ­¤æ­¥éª¤å…ˆä¸æ‰§è¡Œï¼Œå¦‚æœè¿™è¿™ä¸ªæ‰§è¡Œäº†ï¼Œåœ¨åé¢éƒ¨ç½²Bookinfoçš„æ—¶å€™ä¼šæç¤ºå¦‚ä¸‹é”™è¯¯<code>Error creating: Internal error occurred: failed calling webhook &quot;sidecar-injector.istio.io&quot;: Post https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</code>è¿™ä¸€æ­¥æœ‰æ‰§è¡Œçš„å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œåˆ é™¤</li></ul><ul><li>åˆ é™¤nsçš„label<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get ns --show-labels</span></span><br><span class="line">NAME              STATUS   AGE    LABELS</span><br><span class="line">default           Active   2d4h   istio-injection=enabled</span><br><span class="line">istio-system      Active   174m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-public       Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-system       Active   2d4h   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl label namespace default istio-injection-</span></span><br><span class="line">namespace/default labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get ns --show-labels</span></span><br><span class="line">NAME              STATUS   AGE    LABELS</span><br><span class="line">default           Active   2d4h   &lt;none&gt;</span><br><span class="line">istio-system      Active   175m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-public       Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-system       Active   2d4h   &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><h4 id="éƒ¨ç½²Bookinfo"><a href="#éƒ¨ç½²Bookinfo" class="headerlink" title="éƒ¨ç½²Bookinfo"></a>éƒ¨ç½²Bookinfo</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›´æ¥ä½¿ç”¨kubectl createå…¶å¸¸è§„çš„YAMLéƒ¨ç½²æ–‡ä»¶æ¥éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚å°†ä½¿ç”¨istioctlå°†Envoyå®¹å™¨æ³¨å…¥åˆ°åº”ç”¨ç¨‹åºå®¹å™¨ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)</span></span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥å‘½ä»¤å°†å¯åŠ¨bookinfoåº”ç”¨ç¨‹åºä½“ç³»ç»“æ„å›¾ä¸­æ˜¾ç¤ºçš„æ‰€æœ‰å››ä¸ªæœåŠ¡ã€‚å·²å¯åŠ¨è¯„è®ºæœåŠ¡çš„æ‰€æœ‰3ä¸ªç‰ˆæœ¬ï¼Œå³v1ï¼Œv2å’Œv3ã€‚è€Œåœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ä¼šéƒ¨ç½²æ–°ç‰ˆæœ¬çš„å¾®æœåŠ¡ï¼Œè€Œä¸æ˜¯åŒæ—¶éƒ¨ç½²æ‰€æœ‰ç‰ˆæœ¬ã€‚</p><h4 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®è®¤æ‰€æœ‰æœåŠ¡å’ŒPodå‡å·²æ­£ç¡®å®šä¹‰å¹¶æ­£åœ¨è¿è¡Œã€‚</p><ul><li><p>æ£€æŸ¥ services</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   10.254.61.113    &lt;none&gt;        9080/TCP   2m27s</span><br><span class="line">kubernetes    ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP    43d</span><br><span class="line">productpage   ClusterIP   10.254.130.5     &lt;none&gt;        9080/TCP   2m23s</span><br><span class="line">ratings       ClusterIP   10.254.186.181   &lt;none&gt;        9080/TCP   2m26s</span><br><span class="line">reviews       ClusterIP   10.254.200.107   &lt;none&gt;        9080/TCP   2m25s</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥ pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-c5b5f496d-lphgd        1/1     Running   0          15h</span><br><span class="line">load-generator-7fbcc7489f-vbpnx   1/1     Running   2          20d</span><br><span class="line">nginx-deploy-d494b9564-vx97s      1/1     Running   1          20d</span><br><span class="line">productpage-v1-c7765c886-97spj    1/1     Running   0          15h</span><br><span class="line">ratings-v1-f745cf57b-mdgxr        1/1     Running   0          15h</span><br><span class="line">reviews-v1-75b979578c-ghqqm       1/1     Running   0          15h</span><br><span class="line">reviews-v2-597bf96c8f-r659w       1/1     Running   0          15h</span><br><span class="line">reviews-v3-54c6c64795-tvsmq       1/1     Running   0          15h</span><br></pre></td></tr></table></figure></li><li><p>ç¡®è®¤Bookinfoåº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œè¯·é€šè¿‡curlæŸä¸ªpodä¸­çš„å‘½ä»¤å‘å…¶å‘é€è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec -it $(kubectl get pod -l app=ratings -o jsonpath='&#123;.items[0].metadata.name&#125;') -c ratings -- curl productpage:9080/productpage | grep -o "&lt;title&gt;.*&lt;/title&gt;"</span></span><br><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ¯ä¸ªæœåŠ¡æ—è¾¹éƒ½æ³¨å…¥äº†Envoyï¼Œæ¶æ„å°†å¦‚ä¸‹<br><img src="https://img.xxlaila.cn/1572577460804.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BookinfoæœåŠ¡å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œï¼Œæ‚¨éœ€è¦ä½¿è¯¥åº”ç”¨ç¨‹åºå¯ä»¥ä»Kubernetesé›†ç¾¤å¤–éƒ¨è®¿é—®ï¼Œä¾‹å¦‚ï¼Œä»æµè§ˆå™¨è®¿é—®ã€‚Istioç½‘å…³ç”¨äºæ­¤ç›®çš„ã€‚ä½†æ˜¯æˆ‘åœ¨éƒ¨ç½² bookinfo-gateway çš„æ—¶å€™å‡ºç°é”™è¯¯ï¼Œé”™è¯¯å¦‚ä¸‹ï¼›ç„¶åçœ‹äº†ä¸€ä¸‹ bookinfo-gatewayå°±æ˜¯æä¾›ä¸€ä¸ªwebè®¿é—®çš„ç¨‹åºï¼Œæ—¢ç„¶æ˜¯æä¾›çš„ä¸€ä¸ªwebè®¿é—®ï¼Œæˆ‘å°±ä½¿ç”¨äº†Traefixæ¥æä¾›è¿™ä¸ªæœåŠ¡ã€‚</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Timeout): <span class="builtin-name">error</span> when creating <span class="string">"samples/bookinfo/networking/bookinfo-gateway.yaml"</span>: Timeout: request did <span class="keyword">not</span> complete within requested timeout 30s</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Timeout): <span class="builtin-name">error</span> when creating <span class="string">"samples/bookinfo/networking/bookinfo-gateway.yaml"</span>: Timeout: request did <span class="keyword">not</span> complete within requested timeout 30s</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»º-bookinfo-gateway"><a href="#åˆ›å»º-bookinfo-gateway" class="headerlink" title="åˆ›å»º bookinfo-gateway"></a>åˆ›å»º bookinfo-gateway</h4><ul><li>istio-Ingress.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: istio-web-ui</span><br><span class="line">  namespace: </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: productpage</span><br><span class="line">          servicePort: 9080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨è¾“å…¥<code>http://istio.xxlaila.cn</code> æ¥è®¿é—®ã€‚ç”¨ productpageä»¥æŸ¥çœ‹BookInfoç½‘é¡µã€‚å¦‚æœæ‚¨å¤šæ¬¡åˆ·æ–°é¡µé¢ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°äº§å“é¡µé¢ä¸Šæ˜¾ç¤ºçš„è¯„è®ºç‰ˆæœ¬ä¸åŒï¼Œå¹¶ä»¥å¾ªç¯æ–¹å¼æ˜¾ç¤ºï¼ˆçº¢è‰²æ˜Ÿæ˜Ÿï¼Œé»‘è‰²æ˜Ÿæ˜Ÿï¼Œæ— æ˜Ÿæ˜Ÿï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬å°šæœªä½¿ç”¨Istioæ¥æ§åˆ¶ç‰ˆæœ¬è·¯ç”±<br><img src="https://img.xxlaila.cn/1572578398765.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1572578189667.jpg" alt="img"></p><p>åŸºæœ¬é“è¿™é‡Œï¼ŒåŠ¨æ€æ›´æ”¹è¯·æ±‚è·¯ç”±å­¦ä¹ ä¸­ï¼ŒğŸ˜‚ğŸ˜‚ğŸ˜‚</p><h3 id="ç›‘æ§æ–¹å¼"><a href="#ç›‘æ§æ–¹å¼" class="headerlink" title="ç›‘æ§æ–¹å¼"></a>ç›‘æ§æ–¹å¼</h3><h4 id="ç”ŸæˆæœåŠ¡å›¾"><a href="#ç”ŸæˆæœåŠ¡å›¾" class="headerlink" title="ç”ŸæˆæœåŠ¡å›¾"></a>ç”ŸæˆæœåŠ¡å›¾</h4><p>è¦éªŒè¯Kialiæ˜¯å¦åœ¨æ‚¨çš„é›†ç¾¤ä¸­è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n istio-system get svc kiali</span></span><br><span class="line">NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">kiali   ClusterIP   10.254.156.117   &lt;none&gt;        20001/TCP   4h38m</span><br></pre></td></tr></table></figure><p>æµé‡å‘é€åˆ°ç½‘æ ¼ï¼Œæœ‰ä¸‰ç§é€‰æ‹©:<br>1.åœ¨ç½‘ç»œæµè§ˆå™¨ä¸­è®¿é—®<a href="http://istio.xxlaila.cn/productpage" target="_blank" rel="noopener">http://istio.xxlaila.cn/productpage</a><br>2.å¤šæ¬¡ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl http://istio.xxlaila.cn/productpage</span></span><br></pre></td></tr></table></figure><p>3.ä½¿ç”¨ä»¥ä¸‹watchå‘½ä»¤è¿ç»­å‘é€è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># watch -n 1 curl -o /dev/null -s -w %&#123;http_code&#125; http://istio.xxlaila.cn/productpage</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œéœ€è¦é…ç½®Kiali UIï¼Œæˆ‘ä»¬åŒæ ·é€‚ç”¨Traefixæ¥è¿›è¡Œé…ç½®</p><ul><li>kialiâ€“Ingress.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kiali--Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kiali-web-ui</span><br><span class="line">  namespace: istio-system </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: istio-kiali.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kiali</span><br><span class="line">          servicePort: 20001</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://istio-kiali.xxlaila.cn" target="_blank" rel="noopener">http://istio-kiali.xxlaila.cn</a> ï¼Œ è¦ç™»å½•Kiali UIï¼Œè¯·è½¬åˆ°Kialiç™»å½•å±å¹•ï¼Œç„¶åè¾“å…¥å­˜å‚¨åœ¨Kialiæœºå¯†ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ã€‚è´¦æˆ·å¯†ç æ˜¯å‰é¢æˆ‘ä»¬è®¾ç½®çš„</p><h4 id="1-ç½‘æ ¼æ¦‚è¿°"><a href="#1-ç½‘æ ¼æ¦‚è¿°" class="headerlink" title="1.ç½‘æ ¼æ¦‚è¿°"></a>1.ç½‘æ ¼æ¦‚è¿°</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•åç«‹å³æ˜¾ç¤ºçš„â€œæ¦‚è¿°â€é¡µé¢ä¸­æŸ¥çœ‹ç½‘æ ¼çš„æ¦‚è¿°ã€‚â€œæ¦‚è¿°â€é¡µé¢æ˜¾ç¤ºäº†ç½‘æ ¼ä¸­å…·æœ‰æœåŠ¡çš„æ‰€æœ‰åç§°ç©ºé—´ã€‚ä»¥ä¸‹å±å¹•æˆªå›¾æ˜¾ç¤ºäº†ç±»ä¼¼çš„é¡µé¢<br><img src="https://img.xxlaila.cn/1572578943386.jpg" alt="img"></p><h4 id="2-ç©ºé—´å›¾"><a href="#2-ç©ºé—´å›¾" class="headerlink" title="2.ç©ºé—´å›¾"></a>2.ç©ºé—´å›¾</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¦æŸ¥çœ‹åç§°ç©ºé—´å›¾ï¼Œè¯·åœ¨bookinfoBookinfoåç§°ç©ºé—´å¡ä¸­å•å‡»å›¾å›¾æ ‡ã€‚å›¾å½¢å›¾æ ‡ä½äºåç§°ç©ºé—´å¡çš„å·¦ä¸‹æ–¹ï¼Œçœ‹èµ·æ¥åƒæ˜¯ä¸€ç»„ç›¸è¿çš„åœˆå­ã€‚è¯¥é¡µé¢ç±»ä¼¼äº<br><img src="https://img.xxlaila.cn/1572579048298.jpg" alt="img"></p><h3 id="åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ"><a href="#åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ" class="headerlink" title="åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ"></a>åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ç”¨Istioçš„åº”ç”¨ç¨‹åºå¯ä»¥é…ç½®ä¸ºä½¿ç”¨æµè¡Œçš„Jaegeråˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿæ¥æ”¶é›†è·Ÿè¸ªèŒƒå›´ã€‚åˆ†å¸ƒå¼è·Ÿè¸ªä½¿æ‚¨å¯ä»¥æŸ¥çœ‹ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­å‘å‡ºçš„è¯·æ±‚æµï¼Œè€ŒIstioçš„æ¨¡å‹åˆ™å…è®¸è¿™æ ·åšï¼Œè€Œä¸æ„å»ºåº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„è¯­è¨€/æ¡†æ¶/å¹³å°æ— å…³ã€‚ä½¿ç”¨Traefixæ¥æä¾›è¿™ä¸ªæœåŠ¡ã€‚</p><ul><li><p>Jaeger-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; Jaeger-Ingress.yaml  &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jaeger-web-ui</span><br><span class="line">  namespace: istio-system </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: jaeger.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: jaeger-query</span><br><span class="line">          servicePort: 16686</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f Jaeger-Ingress.yaml </span></span><br><span class="line">ingress.extensions/jaeger-web-ui unchanged</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://jaeger.xxlaila.cn" target="_blank" rel="noopener">http://jaeger.xxlaila.cn</a> ï¼Œ ä½¿ç”¨Bookinfoç¤ºä¾‹ç”Ÿæˆè·Ÿè¸ªï¼Œè¦æŸ¥çœ‹è·Ÿè¸ªæ•°æ®ï¼Œå¿…é¡»å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡ã€‚è¯·æ±‚æ•°é‡å–å†³äºIstioçš„é‡‡æ ·ç‡ã€‚æ‚¨åœ¨å®‰è£…Istioæ—¶è®¾ç½®æ­¤é€Ÿç‡ã€‚é»˜è®¤é‡‡æ ·ç‡ä¸º1ï¼…ã€‚æ‚¨éœ€è¦è‡³å°‘å‘é€100ä¸ªè¯·æ±‚ï¼Œæ‰èƒ½æ˜¾ç¤ºç¬¬ä¸€æ¡è·Ÿè¸ªã€‚è¦å°†100ä¸ªè¯·æ±‚å‘é€åˆ°productpageæœåŠ¡ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in `seq 1 100`; do curl -s -o /dev/null http://istio.xxlaila.cn/productpage; done</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨ä»ªè¡¨æ¿çš„å·¦ä¾§çª—æ ¼ä¸­ï¼Œä»â€œæœåŠ¡â€ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©productpage.defaultï¼Œç„¶åå•å‡»â€œæŸ¥æ‰¾è·Ÿè¸ªâ€<br><img src="https://img.xxlaila.cn/1572592255728.jpg" alt="img"></p></li><li><p>å•å‡»é¡¶éƒ¨çš„æœ€æ–°è·Ÿè¸ªä»¥æŸ¥çœ‹ä¸å¯¹/ productpageçš„æœ€æ–°è¯·æ±‚ç›¸å¯¹åº”çš„è¯¦ç»†ä¿¡æ¯<br><img src="https://img.xxlaila.cn/1572592385675.jpg" alt="img"></p></li></ul><h3 id="ç›‘è§†Istio"><a href="#ç›‘è§†Istio" class="headerlink" title="ç›‘è§†Istio"></a>ç›‘è§†Istio</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚ä½•è®¾ç½®å’Œä½¿ç”¨Istioä»ªè¡¨æ¿ç›‘è§†ç½‘æ ¼æµé‡ã€‚ä½œä¸ºç›‘æ§çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦å°†å®‰è£…Grafana Istioæ’ä»¶ï¼Œå¹¶ä½¿ç”¨åŸºäºWebçš„ç•Œé¢æŸ¥çœ‹æœåŠ¡ç½‘æ ¼æµé‡æ•°æ®ã€‚Grafanaå°†ç”¨äºå¯è§†åŒ–æ™®ç½—ç±³ä¿®æ–¯æ•°æ®ã€‚åœ¨æ‰§è¡Œéƒ¨ç½²çš„æ—¶å€™ä¹Ÿéƒ¨ç½²äº†è¿™ä¸¤ä¸ªæœåŠ¡ã€‚</p><h4 id="åˆ›å»ºgrafana-Ingress"><a href="#åˆ›å»ºgrafana-Ingress" class="headerlink" title="åˆ›å»ºgrafana Ingress"></a>åˆ›å»ºgrafana Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;grafana-istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-istio-web-ui</span><br><span class="line">  namespace: istio-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana-istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ›å»ºï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨ä»¥å‰çš„grafanaé‡Œé¢æ·»åŠ æ•°æ®åº“æºï¼Œå°±ä¸ç”¨åœ¨æ–°èµ·ä¸€ä¸ªåŸŸåæ¥è¿›è¡Œè®¿é—®<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†æ¬¡åŠ è½½Bookinfoåº”ç”¨ç¨‹åºï¼ˆ<a href="http://istio.xxlaila.cn/productpageï¼‰" target="_blank" rel="noopener">http://istio.xxlaila.cn/productpageï¼‰</a> ï¼Œ åˆ·æ–°é¡µé¢å‡ æ¬¡ï¼ˆæˆ–å‘é€å‘½ä»¤å‡ æ¬¡ï¼‰ä»¥äº§ç”Ÿå°‘é‡æµé‡ã€‚å†æ¬¡æŸ¥çœ‹Istioä»ªè¡¨æ¿ã€‚å®ƒåº”è¯¥åæ˜ æ‰€äº§ç”Ÿçš„æµé‡ã€‚<br><img src="https://img.xxlaila.cn/1572593852626.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;istio è¿˜æä¾›äº†ç½‘æ ¼çš„å…¨å±€è§†å›¾ä»¥åŠç½‘æ ¼ä¸­çš„æœåŠ¡å’Œå·¥ä½œè´Ÿè½½ã€‚æ‚¨å¯ä»¥é€šè¿‡å¯¼èˆªåˆ°ç‰¹å®šçš„ä»ªè¡¨æ¿æ¥è·å–æœ‰å…³æœåŠ¡å’Œå·¥ä½œè´Ÿè½½çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚<br><img src="https://img.xxlaila.cn/1572594150893.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æä¾›äº†æœ‰å…³æœåŠ¡æŒ‡æ ‡çš„è¯¦ç»†ä¿¡æ¯ï¼Œç„¶åæ˜¯è¯¥æœåŠ¡çš„å®¢æˆ·ç«¯å·¥ä½œè´Ÿè½½ï¼ˆæ­£åœ¨è°ƒç”¨æ­¤æœåŠ¡çš„å·¥ä½œè´Ÿè½½ï¼‰å’ŒæœåŠ¡å·¥ä½œè´Ÿè½½ï¼ˆæ­£åœ¨æä¾›è¯¥æœåŠ¡çš„å·¥ä½œè´Ÿè½½ï¼‰ã€‚<br><img src="https://img.xxlaila.cn/1572594261333.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio åœ¨grafana æä¾›äº†å¾ˆå¤šçš„ç›‘æ§æŒ‡æ ‡ï¼Œå¯ä»¥åˆ†åˆ«ç‚¹å‡»çœ‹çœ‹<br><img src="https://img.xxlaila.cn/1572594330246.jpg" alt="img"></p><h3 id="æŸ¥è¯¢IstioæŒ‡æ ‡"><a href="#æŸ¥è¯¢IstioæŒ‡æ ‡" class="headerlink" title="æŸ¥è¯¢IstioæŒ‡æ ‡"></a>æŸ¥è¯¢IstioæŒ‡æ ‡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istioçš„æ•°æ®æ˜¯å­˜å‚¨åœ¨prometheusé‡Œé¢çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡prometheusè¿›è¡Œç›´æ¥æ•°æ®çš„æŸ¥è¯¢</p><h4 id="æŸ¥çœ‹prometheusæœåŠ¡"><a href="#æŸ¥çœ‹prometheusæœåŠ¡" class="headerlink" title="æŸ¥çœ‹prometheusæœåŠ¡"></a>æŸ¥çœ‹prometheusæœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n istio-system get svc prometheus</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">prometheus   ClusterIP   10.254.145.181   &lt;none&gt;        9090/TCP   5h35m</span><br></pre></td></tr></table></figure><h4 id="prometheus-traefix"><a href="#prometheus-traefix" class="headerlink" title="prometheus traefix"></a>prometheus traefix</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡traefix æ¥ä»£ç†prometheusï¼Œç„¶åæˆ‘ä»¬å°†æµé‡å‘é€åˆ°ç½‘æ ¼ã€‚</p><ul><li><p>prometheus-istio.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; prometheus-istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-istio-web-ui</span><br><span class="line">  namespace: istio-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus-istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f prometheus-istio-Ingress.yaml </span></span><br><span class="line">ingress.extensions/prometheus-istio-web-ui created</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://prometheus-istio.xxlaila.cn" target="_blank" rel="noopener">http://prometheus-istio.xxlaila.cn</a> ï¼Œå¯ä»¥åœ¨è¾“å…¥æ¡†é‡Œé¢è¾“å…¥è¡¨è¾¾å¼æ¥è·å–æŒ‡ï¼Œè¾“å…¥æ–‡æœ¬ï¼šistio_requests_total<br><img src="https://img.xxlaila.cn/1572594888435.jpg" alt="img"></p><ul><li><p>å…¶ä»–æŸ¥è¯¢å°è¯•ï¼š</p><ul><li><p>å¯¹productpageæœåŠ¡çš„æ‰€æœ‰è¯·æ±‚æ€»æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">istio_requests_total&#123;destination_service=<span class="string">"productpage.default.svc.cluster.local"</span>&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯¹v3ç‰ˆæœ¬çš„è¯„è®ºæœåŠ¡çš„æ‰€æœ‰è¯·æ±‚æ€»æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">istio_requests_total&#123;destination_service=<span class="string">"reviews.default.svc.cluster.local"</span>, destination_version=<span class="string">"v3"</span>&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>è¯¥æŸ¥è¯¢å°†æ‰€æœ‰è¯·æ±‚çš„å½“å‰æ€»æ•°è¿”å›åˆ°è¯„è®ºæœåŠ¡çš„v3ã€‚</p><ul><li>è¿‡å»5åˆ†é’Ÿå†…å¯¹productpageæœåŠ¡æ‰€æœ‰å®ä¾‹çš„è¯·æ±‚ç‡ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rate(istio_requests_total&#123;destination_service=~<span class="string">"productpage.*"</span>, response_code=<span class="string">"200"</span>&#125;[5m])</span><br></pre></td></tr></table></figure></li></ul></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>istio</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineæ ¸å¿ƒé«˜çº§ç¯‡</title>
    <url>/2019/10/26/pipeline%E9%AB%98%E7%BA%A7%E7%AF%87/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢çš„ä¸¤ç¯‡æ–‡ç« ä»‹ç»äº†pipelineçš„åŸºæœ¬ä½¿ç”¨å’Œä¸€äº›å®é™…ä½¿ç”¨çš„ä¾‹å­ï¼Œçœ‹ä¼¼å¾ˆä¸é”™ï¼Œä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¹Ÿä¼šå‡ºç°å¾ˆå¤šçš„ä¸è¶³å’Œé—®é¢˜ï¼Œéšä¹‹ç³»ç»Ÿçš„åºå¤§ã€æœåŠ¡çš„å¢åŠ ã€äººå‘˜çš„å‚å·®ä¸é½ä¼šå¯¼è‡´å¾ˆå¤šçš„é—®é¢˜ã€‚<a id="more"></a>å±Šæ—¶ä¼šå¸¦æ¥å¾ˆå¤§çš„ç»´æŠ¤æˆæœ¬å’Œä¸€äº›æ”¹åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åšäº‹æƒ…ä¹‹å‰å°±è¦è€ƒè™‘è¿›å»ï¼Œä¸€äº›æ„å¤–äº‹ä»¶çš„å‘ç”Ÿã€æˆ–è€…æ˜¯åœ¨å°†æ¥å³å°†ä¼šå‘ç”Ÿå’Œéœ€è¦æ”¹å˜çš„äº‹æƒ…æˆ‘ä»¬éƒ½è¦æƒ³åˆ°æˆ–è€…æ˜¯é¢„ç•™å£å­ï¼Œè¿™æ ·æ‰åœ¨ä»Šåæ‰©å±•ã€ä¿®æ”¹ã€å¼•å…¥éƒ½èƒ½æœ‰å¾ˆå¥½å¯å¡‘æ€§ã€‚</p><h3 id="jenkins-jobä»‹ç»"><a href="#jenkins-jobä»‹ç»" class="headerlink" title="jenkins jobä»‹ç»"></a>jenkins jobä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨jenkinsçš„æ™®é€šjobï¼Œæ™®é€šçš„jobå¥½å¤„æ˜¯é…ç½®ç®€å•ï¼Œç»“æ„åŒ–å¯ä»¥å¤æ‚ï¼Œä¹Ÿå¯ä»¥å•ä¸€ã€‚åœ¨ä½¿ç”¨jenkins jobçš„æ—¶å€™æˆ‘ä»¬åˆ†ä¸ºä¸¤ç§ï¼šä¸€ç§æ˜¯å•ä¸€jobï¼Œä¸€ç§æ˜¯å…·æœ‰è€¦åˆæ€§çš„ã€‚ä¸‹é¢å¯¹ä¸¤ç§æƒ…å†µè¿›è¡Œå¯¹æ¯”å’Œæ¯”è¾ƒã€‚</p><h4 id="jenkins-å•ä¸€job"><a href="#jenkins-å•ä¸€job" class="headerlink" title="jenkins å•ä¸€job"></a>jenkins å•ä¸€job</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨jenkinsçš„ä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œå•ä¸€çš„çš„jobå¯ä»¥è®©ç»´æŠ¤äººå‘˜å¯ä»¥å¾ˆå¥½çš„æŸ¥çœ‹é‡Œé¢çš„é€»è¾‘æ­¥éª¤ï¼Œjobé‡Œé¢æ‰€æœ‰çš„ä»»åŠ¡éƒ½åœ¨è¿™ä¸ªæ‰€å±çš„ç©ºé—´é‡Œé¢æ‰§è¡Œï¼Œå®ƒé‡Œé¢åŒ…å«äº†ï¼šä»£ç pullã€ç¼–è¯‘ã€æ‰“åŒ…ã€å¤åˆ¶åŒ…ã€å‘å¸ƒåŒ…ï¼ˆä½¿ç”¨å†…ç½®çš„shellæ¨¡å—æ¥å†™shellï¼Œè¿™ç§åº”è¯¥ä¸å­˜åœ¨ï¼‰ã€‚ç§å•ä¸€jobæœåŠ¡ç®—å¾—ä¸Šæ˜¯æœåŠ¡å‘¨åˆ°ï¼Œä¸å½±å“å…¶ä»–äººï¼Œè‡ªå·±ç®¡ç†å¥½è‡ªå·±çš„ä¸€äº©ä¸‰åˆ†åœ°ã€‚å¥½å¤„æ˜¯å½“å‡ºé”™ä»¥åå½±å“èŒƒå›´å°ï¼Œå®¹æ˜“æ§åˆ¶ã€‚å¦‚ä¸‹å›¾ï¼š<br><img src="https://img.xxlaila.cn/1572064519037.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¿™ä¸­æ¨¡å¼ä¸‹ï¼Œç»´æŠ¤äººå‘˜å‰æœŸç”¨çœ‹ä¼¼æ¯”è¾ƒè½»æ¾çš„å·¥ä½œå»ºç«‹èµ·äº†æ•´ä¸ªå‘å¸ƒæµç¨‹ã€‚ä½†æ˜¯åˆ°äº†åæœŸå°±ä¸è¡Œäº†ã€‚ä¹‹å‰æˆ‘åœ¨çš„è¿™å®¶å…¬å¸å‰æœŸä¹Ÿæ˜¯è¿™ä¹ˆè¿™ä¹ˆåšçš„ã€‚å¼€å‘å®Œæˆåæäº¤gitï¼Œç„¶åè‡ªåŠ¨è§¦å‘ã€æ„å»ºã€åˆ¶å“åº“ã€å‘å¸ƒï¼Œåœ¨ä¸€ä¸ªjobé‡Œé¢å°±å®Œæˆäº†ã€‚åæ¥æˆ‘ä»¬å‡†å¤‡æ¨è¡Œæ›´å¥½çš„devopsæ–¹æ¡ˆçš„æ—¶å€™ï¼›å‘ç°ä»¥å‰çš„è¿™ä¸ªjobå»ºç«‹æœ‰é—®é¢˜ï¼Œä¸€æƒ³åˆ°å‡ ç™¾ä¸ªå¾®æœåŠ¡ï¼Œå‡ ç™¾ä¸ªjobéœ€è¦å»è¿›è¡Œæ”¹é€ ã€‚é¡¿æ—¶æˆ‘ä»¬è¿ç»´è„¸çº¿ä¸€é»‘ï¼Œè™½ç„¶æˆ‘ä»¬è‡ªå·±å†™äº†ä¸€ä¸ªå¿«é€Ÿåœ¨jenkinsä¸Šå»ºç«‹jobï¼Œä½†æ˜¯ä¸€æƒ³åˆ°å‡ ç™¾ä¸ªè¿˜æ˜¯ä¸å¥½ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†jobä¹‹é—´çš„ä»»åŠ¡å…³è”ï¼Œç„¶åé€šè¿‡å‚æ•°ä¼ é€’å®Œæˆæ•´ä¸ªæµç¨‹æœåŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™ç§æ¨¡å¼ä¸‹çš„å¼Šç«¯å°±å¦‚ä¸Šé¢æ‰€è¯´çš„ä¸€æ ·ï¼Œä½†ä»€ä¹ˆæ—¶å€™å¥½çš„æœåŠ¡å‘¢ï¼Ÿå¥½çš„æœåŠ¡åˆæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™é‡Œä¹Ÿå¯ä»¥åµŒå¥—ä¸€äº›å¾®æœåŠ¡çš„æ¦‚å¿µç†è®ºã€‚å¦‚æœæˆ‘ä»¬è¦åšåˆ°ä»€ä¹ˆæ—¶å€™å¥½çš„æœåŠ¡ï¼Œæˆ‘ä»¬å¾—äº†è§£äº†è§£ä¸€ä¸‹: ä½è€¦åˆå’Œé«˜å†…èšã€‚äº†è§£è¿™ä¸ªä¸œè¥¿æœ‰åŠ©äºæˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„pipeline æµæ°´çº¿çš„è®¾è®¡ï¼ŒåŒ…æ‹¬åœ¨åæœŸdevopsçš„è®¾è®¡ä»¥åŠæ’¸ç éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚</p><h3 id="è€¦åˆæ€§"><a href="#è€¦åˆæ€§" class="headerlink" title="è€¦åˆæ€§"></a>è€¦åˆæ€§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆæˆ‘ä»¬æ¥äº†è§£è¿™ä¸€æ¦‚å¿µ: â€œé«˜å†…èšä½è€¦åˆâ€ã€‚åœ¨è½¯ä»¶è®¾è®¡ä¸­é€šå¸¸ç”¨è€¦åˆåº¦å’Œå†…èšåº¦ä½œä¸ºè¡¡é‡æ¨¡å—ç‹¬ç«‹ç¨‹åº¦çš„æ ‡å‡†ã€‚åˆ’åˆ†æ¨¡å—çš„ä¸€ä¸ªå‡†åˆ™æ˜¯é«˜å†…èšä½è€¦åˆã€‚ä»æ¨¡å—ç²’åº¦æ¥çœ‹ï¼Œé«˜å†…èšï¼šå°½å¯èƒ½ç±»çš„æ¯ä¸ªæˆå‘˜æ–¹æ³•åªå®Œæˆä¸€ä»¶äº‹ï¼ˆæœ€å¤§é™åº¦çš„èšåˆï¼‰ï¼›ä½è€¦åˆï¼šå‡å°‘ç±»å†…éƒ¨ï¼Œä¸€ä¸ªæˆå‘˜æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæˆå‘˜æ–¹æ³•ã€‚ä»ç±»è§’åº¦æ¥çœ‹ï¼Œé«˜å†…èšä½è€¦åˆï¼šå‡å°‘ç±»å†…éƒ¨ï¼Œå¯¹å…¶ä»–ç±»çš„è°ƒç”¨ï¼›ä»åŠŸèƒ½å—æ¥çœ‹ï¼Œé«˜å†…èšä½è€¦åˆï¼šå‡å°‘æ¨¡å—ä¹‹é—´çš„äº¤äº’å¤æ‚åº¦ï¼ˆæ¥å£æ•°é‡ï¼Œå‚æ•°æ•°æ®ï¼‰å³æ¨ªå‘ï¼šç±»ä¸ç±»ä¹‹é—´ã€æ¨¡å—ä¸æ¨¡å—ä¹‹é—´ï¼›çºµå‘ï¼šå±‚æ¬¡ä¹‹é—´ï¼›å°½å¯èƒ½ï¼Œå†…å®¹å†…èšï¼Œæ•°æ®è€¦åˆã€‚</p><h4 id="ä½è€¦åˆ"><a href="#ä½è€¦åˆ" class="headerlink" title="ä½è€¦åˆ"></a>ä½è€¦åˆ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸åŒæ¨¡å—ç›¸äº’ä¾èµ–å¤šå°‘ï¼Ÿæ¨¡å—åº”å°½å¯èƒ½ç‹¬ç«‹äºå…¶ä»–æ¨¡å—ï¼Œä»¥ä½¿å¯¹æ¨¡å—çš„æ›´æ”¹ä¸ä¼šä¸¥é‡å½±å“å…¶ä»–æ¨¡å—ã€‚</p><h4 id="é«˜è€¦åˆ"><a href="#é«˜è€¦åˆ" class="headerlink" title="é«˜è€¦åˆ"></a>é«˜è€¦åˆ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é«˜è€¦åˆå°†æ„å‘³ç€æ‚¨çš„æ¨¡å—å¯¹å…¶ä»–æ¨¡å—çš„å†…éƒ¨è¿ä½œäº†è§£å¤ªå¤šã€‚å¯¹å…¶ä»–æ¨¡å—äº†è§£å¤ªå¤šçš„æ¨¡å—ä¼šä½¿æ›´æ”¹éš¾ä»¥åè°ƒï¼Œå¹¶ä½¿æ¨¡å—èƒ½åŠ›å˜å¼±ã€‚å¦‚æœæ¨¡å—Aå¯¹æ¨¡å—Bçš„äº†è§£è¿‡å¤šï¼Œåˆ™å¯¹æ¨¡å—Bå†…éƒ¨çš„æ›´æ”¹å¯èƒ½ä¼šç ´åæ¨¡å—Açš„åŠŸèƒ½ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡å®ç°ä½è€¦åˆï¼Œå¯ä»¥è½»æ¾æ›´æ”¹æ¨¡å—å†…éƒ¨ï¼Œä¸å¿…æ‹…å¿ƒå®ƒä»¬å¯¹ç³»ç»Ÿä¸­å…¶ä»–æ¨¡å—çš„å½±å“ã€‚ä½è€¦åˆè¿˜ä½¿æˆ‘ä»¬çš„æ¨¡å—å½¼æ­¤ä¹‹é—´ä¸ç›¸äº’ä¾èµ–ï¼Œå› æ­¤æ›´æ˜“äºè®¾è®¡ï¼Œç¼–å†™å’Œæµ‹è¯•ä»£ç ã€‚æˆ‘ä»¬è¿˜è·å¾—äº†æ˜“äºé‡ç”¨å’Œå¯ç»„åˆçš„æ¨¡å—çš„ä¼˜åŠ¿ã€‚é—®é¢˜ä¹Ÿè¢«éš”ç¦»åˆ°å°çš„ï¼Œç‹¬ç«‹çš„ä»£ç å•å…ƒä¸­ã€‚</p><p><strong>å¥½å¤„:</strong></p><ul><li>å¯ç»´æŠ¤æ€§: æ›´æ”¹é™åˆ¶åœ¨ä¸€ä¸ªæ¨¡å—ä¸­</li><li>å¯æµ‹è¯•æ€§: å•å…ƒæµ‹è¯•ä¸­æ¶‰åŠçš„æ¨¡å—å¯ä»¥é™åˆ¶åœ¨æœ€ä½é™åº¦</li><li>å¯è¯»æ€§: éœ€è¦åˆ†æçš„ç±»å‡å°‘</li></ul><h4 id="é«˜å†…èš"><a href="#é«˜å†…èš" class="headerlink" title="é«˜å†…èš"></a>é«˜å†…èš</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…èšæ€§é€šå¸¸æ˜¯æŒ‡æ¨¡å—çš„å…ƒç´ å¦‚ä½•ç›¸äº’ç»„åˆã€‚ç›¸å…³ä»£ç åº”å½¼æ­¤æ¥è¿‘ï¼Œä»¥ä½¿å…¶å…·æœ‰é«˜åº¦çš„å‡èšåŠ›ã€‚æ˜“äºç»´æŠ¤çš„ä»£ç é€šå¸¸å…·æœ‰å¾ˆé«˜çš„å†…èšæ€§ã€‚æ¨¡å—ä¸­çš„å…ƒç´ ä¸è¯¥æ¨¡å—è¦æä¾›çš„åŠŸèƒ½ç›´æ¥ç›¸å…³ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ï¼Œæœ€å¥½æ˜¯åœ¨ä¸€ä¸ªåœ°æ–¹è¿›è¡Œä¿®æ”¹ï¼Œç„¶åå¯ä»¥å°½å¿«çš„å‘å¸ƒã€‚å¦‚æœå¾ˆå¤šä¸åŒçš„åœ°æ–¹è¦è¿›è¡Œä¿®æ”¹ï¼Œå°±æœ‰å¯èƒ½éœ€è¦å‘å¸ƒå¤šä¸ªå¾®æœåŠ¡æ‰èƒ½äº¤äº’è¿™ä¸ªåŠŸèƒ½ã€‚åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œä¿®æ”¹ï¼Œä¸ä»…ä¿®æ”¹é€Ÿåº¦å¾ˆæ…¢ï¼ŒåŒæ—¶éƒ¨ç½²å¤šä¸ªå¾®æœåŠ¡ä¹Ÿæé«˜äº†é£é™©ã€‚æ‰€ä»¥åœ¨æ‰¾åˆ°é—®é¢˜åŸŸçš„è¾¹ç•ŒåŸŸåå¯ä»¥ç¡®ä¿ç›¸å…³çš„è¡Œä¸ºèƒ½æ”¾åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼Œå¹¶ä¸”å®ƒä»¬ä¼šå’Œå…¶å®ƒè¾¹ç•Œä»¥å°½é‡ä½è€¦åˆçš„å½¢å¼è¿›è¡Œé€šä¿¡ã€‚</p><p><strong>å¥½å¤„:</strong></p><ul><li>å¯è¯»æ€§: åŠŸèƒ½åŒ…å«åœ¨å•ä¸ªæ¨¡å—ä¸­</li><li>å¯ç»´æŠ¤æ€§: è°ƒè¯•å¾€å¾€åŒ…å«åœ¨å•ä¸ªæ¨¡å—ä¸­</li><li>å¯é‡ç”¨æ€§: å…·æœ‰é›†ä¸­åŠŸèƒ½ä¸ä¼šè¢«æ— ç”¨çš„å¹²æ‰°</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…èšæ€§ä½æ„å‘³ç€ç»„æˆæŸäº›åŠŸèƒ½çš„ä»£ç ä¼šæ•£å¸ƒåœ¨æ‚¨çš„æ•´ä¸ªä»£ç åº“ä¸­ã€‚ä¸ä»…å¾ˆéš¾å‘ç°ä¸æ‚¨çš„æ¨¡å—ç›¸å…³çš„ä»£ç ï¼Œè€Œä¸”å¾ˆéš¾åœ¨ä¸åŒçš„æ¨¡å—ä¹‹é—´è·³è½¬å¹¶è·Ÿè¸ªçš„æ‰€æœ‰ä»£ç ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šä¿—çš„æ¥è®²ï¼Œå†…èšæ˜¯ä»åŠŸèƒ½è§’åº¦æ¥åº¦é‡æ¨¡å—å†…çš„è”ç³»ï¼Œå¥½çš„å†…èšæ¨¡å—åº”æ°å¥½åšä¸€ä»¶äº‹ã€‚æè¿°çš„æ˜¯æ¨¡å—å†…çš„åŠŸèƒ½è”ç³»ã€‚è€¦åˆæ˜¯è½¯ä»¶ç»“æ„ä¸­å„æ¨¡å—ä¹‹é—´ç›¸äº’è¿æ¥çš„ä¸€ç§åº¦é‡ï¼Œè€¦åˆå¼ºå¼±å–å†³äºæ¨¡å—é—´æ¥å£çš„å¤æ‚ç¨‹åº¦ã€è¿›å…¥æˆ–è®¿é—®ä¸€ä¸ªæ¨¡å—ç‚¹ä»¥åŠé€šè¿‡æ¥å£çš„æ•°æ®ã€‚</p><h4 id="å¯ç»´æŠ¤çš„ä»£ç "><a href="#å¯ç»´æŠ¤çš„ä»£ç " class="headerlink" title="å¯ç»´æŠ¤çš„ä»£ç "></a>å¯ç»´æŠ¤çš„ä»£ç </h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸€èˆ¬åœ¨ç¼–å†™å¯ç»´æŠ¤çš„ä»£ç æœ‰åŠ©äºæé«˜å¼€å‘äººå‘˜çš„ç”Ÿäº§åŠ›ã€‚å…·æœ‰é«˜åº¦å¯ç»´æŠ¤çš„ä»£ç ä½¿è®¾è®¡æ–°åŠŸèƒ½å’Œç¼–å†™ä»£ç å˜å¾—æ›´åŠ å®¹æ˜“ã€‚æ¨¡å—åŒ–ï¼ŒåŸºäºç»„ä»¶çš„åˆ†å±‚ä»£ç å¯æé«˜ç”Ÿäº§ç‡å¹¶é™ä½è¿›è¡Œæ›´æ”¹æ—¶çš„é£é™©ã€‚é€šè¿‡ä½¿ä»£ç ä¿æŒæ¾æ•£è€¦åˆï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ¨¡å—å†…ç¼–å†™ä»£ç ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–æ¨¡å—ã€‚é€šè¿‡ä¿æŒä»£ç çš„å†…èšæ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ›´è½»æ¾åœ°ç¼–å†™æ˜“äºä½¿ç”¨çš„DRYä»£ç ã€‚</p><p><strong>é—®é¢˜</strong>: å½“æˆ‘ä»¬é‡åˆ°é—®é¢˜æ—¶ï¼Œè¯·è¯„ä¼°ä¿®å¤ã€ä¿®æ”¹ç¨‹åºçš„ç¨‹åº¦ã€‚æ˜¯æ›´æ”¹ä¸€ä¸ªæ¨¡å—ï¼Œè¿˜æ˜¯æ›´æ”¹åˆ†æ•£åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ï¼Ÿåœ¨è¿›è¡Œæ›´æ”¹æ—¶ï¼Œå®ƒæ˜¯å¦å¯ä»¥è§£å†³æ‰€æœ‰çš„é—®é¢˜ï¼Œè¿˜æ˜¯ä¼šäº§ç”Ÿå…¶ä»–ä¸€äº›ä¸å¯é¢„çŸ¥çš„é—®é¢˜ï¼Ÿ</p><p>åœ¨ç¼–å†™å’Œä½¿ç”¨ä»£ç åº“æ—¶:</p><ul><li>æˆ‘è¦ä¿®å¤å’Œåˆ›å»ºçš„æ­¤åŠŸèƒ½æ¨¡å—æ˜¯å¤šå°‘ï¼Ÿ</li><li>æ­¤æ›´æ”¹æ˜¯è¦åœ¨å‡ ä¸ªä¸åŒçš„åœ°æ–¹è¿›è¡Œï¼Ÿ</li><li>æˆ‘èƒ½å¦ç‹¬ç«‹æµ‹è¯•ä»£ç ï¼Œæµ‹è¯•æ•´ä¸ªä»£ç æœ‰å¤šéš¾ï¼Ÿ</li><li>æˆ‘ä»¬æ˜¯å¦å¯ä»¥ä½¿ä»£ç æ›´æ¾æ•£åœ°è€¦åˆæ¥æ”¹å–„ï¼Ÿå¯ä»¥ä½¿ç”¨é«˜å†…èšæ¥æ”¹å–„æˆ‘ä»¬çš„ä»£ç å—ï¼Ÿ</li></ul><h3 id="Jenkins-è®¾è®¡"><a href="#Jenkins-è®¾è®¡" class="headerlink" title="Jenkins è®¾è®¡"></a>Jenkins è®¾è®¡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†ä¸Šé¢çš„çš„ç†è®ºä¸æ¦‚å¿µã€‚æ ¹æ®è¿™é‡Œç†è®ºå’Œæ¦‚å¿µæˆ‘ä»¬å°±å¯ä»¥è®¾è®¡å‡ºä¸€å¥—æ›´å¥½çš„devopsæµç¨‹ã€‚æœ¬æ–‡å°†kuberneteså¹³å°ä¸Šæ¥åšè¿™ä¸€å¥—è®¾è®¡ï¼Œå¹¶åœ¨å®é™…çš„ç¯å¢ƒä¸­åº”ç”¨ã€‚æ¶‰åŠçš„åŠŸèƒ½å¦‚ä¸‹: æœåŠ¡ Jobã€Code Jobã€Releaseã€Noticeå››ä¸ªåŠŸèƒ½ä»»åŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¯ä¸€ä¸ªç¯å¢ƒæœ‰é”™è¯¯ï¼Œå°±ä¼šæ‰§è¡Œå‘Šè­¦ä»»åŠ¡æ¨¡å—ï¼Œå‘Šè­¦ç›®å‰ä½¿ç”¨çš„æ˜¯<a href="https://github.com/xxlaila/jenkins-wechat-notice" target="_blank" rel="noopener">ä¼ä¸šå¾®ä¿¡</a>ã€‚jobä¹‹é—´éœ€è¦ä¼ é€’JOB_NAMEï¼Œenvï¼Œversionä¸‰ä¸ªå‚æ•°ã€‚åœ¨ä¹‹å‰çš„devopsè®¾è®¡é‡Œé¢æ•´ä¸ªjobçš„è°ƒç”¨è®¾è®¡è¿˜è¦å¤šã€‚å½¢æˆäº†ä¸€ä¸ªé€šç”¨ä½“ç³»ã€‚åœ¨è¿™ä¸ªè®¾è®¡é‡Œé¢ï¼Œå½“è¿˜éœ€è¦å¢åŠ ä¸€ä¸ªä»»åŠ¡æµç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹pipelineï¼Œç„¶åå¢åŠ ä¸€ä¸ªjobï¼Œåœ¨ä¸‹æ¬¡æ„å»ºçš„æ—¶å€™å°±ä¼šæŠŠæˆ‘ä»¬æ–°å¢åŠ çš„æµç¨‹ç»™åŠ è¿›å»ï¼Œéå¸¸çš„æ–¹ä¾¿ã€‚è®¾è®¡å›¾å¦‚ä¸‹ï¼š<br><img src="https://img.xxlaila.cn/1572081425995.jpg" alt="img"></p><h4 id="Project-Name"><a href="#Project-Name" class="headerlink" title="Project Name"></a>Project Name</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤jobä¸€èˆ¬å°±æ˜¯æœåŠ¡ï¼Œjobåç§°ä»¥æœåŠ¡çš„åç§°è¿›è¡Œå‘½åã€‚é‡Œé¢åŒ…å«äº†å››ä¸ªåŠŸèƒ½.</p><ul><li>Clone Code: clone ä»£ç ã€‚</li><li>Build Code: å°±æ˜¯å¯¹å¼€å‘æäº¤çš„ä»£ç è¿›è¡Œç¼–è¯‘ã€‚</li><li>Env Version: è·å–æœ¬æ¬¡æäº¤çš„hashï¼Œä»¥hashä¸ºç‰ˆæœ¬ï¼Œç»“åˆç¯å¢ƒæ¥åšä¸€ä¸ªç‰ˆæœ¬è®°å½•ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œåˆ¤æ–­ã€‚uat/prodç¯å¢ƒä¸éœ€è¦envå‰ç¼€ã€‚</li><li>Build Docker: æŠŠç¼–è¯‘å®Œæˆåçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰“åŒ…æˆä¸€ä¸ªdockeré•œåƒã€‚</li></ul><h4 id="Code-Test"><a href="#Code-Test" class="headerlink" title="Code Test"></a>Code Test</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºæµ‹è¯•è¿›è¡Œå¯¹ä»£ç çš„è‡ªåŠ¨åŒ–æµ‹è¯•ï¼›è‡ªåŠ¨åŒ–æµç¨‹ã€æ€§èƒ½ç­‰æµ‹è¯•</p><h4 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸»è¦æ˜¯è¿›è¡Œå‘å¸ƒæœåŠ¡ã€‚å½“æ¥å—åˆ°ä¸Šæ¸¸jobä¼ é€’æ¥çš„å‚æ•°ä¿¡æ¯åï¼Œç»“åˆå‚æ•°ä¿¡æ¯æ¥è¿›è¡Œå¯¹åº”çš„å‘å¸ƒåˆ°kubernetesä¸­namespaceä¸­ï¼Œä¸»è¦åŒ…å«äº†ä»¥ä¸‹åŠŸèƒ½</p><ul><li>Push Docker: æŠŠå‰é¢æ‰“åŒ…çš„dockeré•œåƒæ¨é€åˆ°harbor</li><li>Edit Files: ä¿®æ”¹å‘å¸ƒçš„è„šæœ¬</li><li>Release: æ‰§è¡Œ<code>kubectl</code>è¿›è¡Œå‘å¸ƒ<ul><li>å½“å‘å¸ƒåˆ°kubernetesä¸­ï¼Œkubernetes ä¼šæ‰§è¡Œ<a href="https://xxlaila.github.io/2019/09/27/k8s-pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/" target="_blank" rel="noopener">healthæ£€æµ‹</a>ï¼Œå¦‚æœå¯åŠ¨å¤±è´¥ï¼Œä¼šè¿›è¡Œé€šçŸ¥</li></ul></li></ul><h4 id="Notice"><a href="#Notice" class="headerlink" title="Notice"></a>Notice</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤jobä¸»è¦ç”¨äºé€šçŸ¥ã€‚å½“æ¥å—åˆ°è§„åˆ™çš„å‘Šè­¦é€šçŸ¥ä»¥åï¼Œå°±ä¼šè¿›è¡Œè§¦å‘é€šçŸ¥ç›¸å…³çš„äººå‘˜ã€‚</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineå¤šåˆ†æ”¯gitlabè§¦å‘</title>
    <url>/2019/10/25/pipeline%E5%A4%9A%E5%88%86%E6%94%AFgitlab%E8%A7%A6%E5%8F%91/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="enter password to read." />
    <label for="hbePass">enter password to read.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="ae7439c0d2e6128b14ad2bfba6c0197f5dfef3528fa3ae632a1918614f51a66f">d69a90776b8106231e3f5503e1ddcc13ce0bde5f443a0f2168d3f72bab2055dff68e1e331692aaf8cab8b235d2eee4dca4140d26b2ca6082fdda4372b8276eb6037dd821f137b31a3f9484efbd0033e17c15f788a9633d423f5affd102c94c6ab127506161e3e0f8a3f1d93c575bc93d7d322011957a9615b1de4a2a20f81fc701af0a91acf561d3267f1fdf2a540d1d10613a324bbc3198d95d29e400ccc04c434fcc25ebbc1adb76ca14960696424a60300858237b05796f508ec3236d9178f6cb11958a820253757a5acaf602d98d91fe01a36ee679f9f6c5afcbfa6b1412934f8bf2472e8fb4675bb2372ae0817463002eb64445fb86f40c88c99139476e705ba2bb90efc0531bc01187693787b97083ef360c41d5e745c0adb0d8ea43649ccd4393018abe36d1057a894d705343185221af10940fe8a0eae6cb6d15db09f1a4b92289d739c3b99707299610c189a4e2275ddd2dc9367758982bb515d343108e85589ad5953c024f0955c300bbbcbf1f99aeb7138f76ec685c92c7d88cf469c0ceb3b8bd73a10e6ff9f0018920fd252286582395b5b8ad523c34077e59d8eefde2f441bd38cae75b181eb35e348dcf8da5e78991cad451442acf7a5d15ea821e45c502699c7939358884b8a358e76404f50e92ea62cc84d8d093dc29630ff18d2309cb5ac6b68128be6b7ff71090354e1c3de696e525e4558b7e41a724739e5a7539837b04bfedb3273d7c99e87e506cdf3be3a9f981e09c2dcd14f2a4a3684d5f94f619b5eb20d93f840a422f15045db4220abccce12bc861b344c7650c69ccf14af9df30b7201c0aede322a35003551bc0f0092dcab8184601d7f155aea03bf01b8b6c3f8f7e8638a25bc419ab61dc28c74733c808a9a53be7ac26726d9f6256babe50b148bcab3fad280885260e7a0357ad5dc11a6fecc61beb401dfb69ac9d50d170a6a2a5f17c5d75fbd0dada108dd9156cf6409cc82d0db80dba66f78c45a117bec45293fdd3be9c8eb77f590bbcda2bc976120cc6a9dde44c0520d3d72702cefb1c6e47010abc4bfdd769d09c434d82349da4514a06b360242a7c871db94b0af22e74897fbbf320e0b0a0f7ce5160ed774fec3b5e0ec13df0082bf461781d7347b1601dad1e063db2e5d6e33f6f292a6d565447adceea9ba8e5e46d8c0d4132aec738ec587536fa737cbc36599a924cf16fd4c63948f587722f9f1c34ebea69cadba85bfa38eb320faeb21c69cc479d9f27384218ed4ec99549001166067a1bc8d1668ce074d5f5cbd41375fbfd6f815d989345f7a7d1789dbbfab0c4c63b4565eed10f7a579ce4642c95698c25f2fd19b3d9e5e21f5b7c93a150487bfea8540319ac37ec05f55d157d87a9b74067b8577a69ff046202b4c111ea4c83e07b184523ccd887213f103ae9658bf9867dc011abbfdde595f8ec1c35744f66de52777765fe120ec403eb5674d9420d8a67df9973a6f0ea79a8e044eacf39f9d7e977f183fd6857397ae068fc282673f811f19fac6927736e824fb9a8b5b82b3324a35b26f9380ece478c2fae8a03fb704ac6a62d80f24c106807271145f2c1fcdd86e9ae11fc4a58c1a15ff961686809622c76115ef0f5712da93e202a5cd321dfc1d36e94c60de0dbf84fc2fd98af6e3fa4498b6c4a1fa963e67e458949d42bb260c94c8afafac79e34aace81964e03a1277b304ec43afffec9683a9b9de670cc90389758a70429b856242af2614ec1280d1cc4f514ee6f90d22f086e97f240375ab2ef3d73385d629d6210543a724e2f7a8b1453a89618fb6f401594684deac0a98cca4b46980ca8224f0d7b664abcafb833e8b6314c812ac54928d184285c537cee2074950b87475c508fceb23b7a7e94f075388e0c8e05856642c4b9d746de2e4c8d1c4ef31625108ca6c6cabf60ac30f55df96f168f3f26d3b0cf39d856ed26405f3f7ccee086478bf07f7506249de3759920e69e19dde4a2fe183e7b4288103447c7d47e1a937605b6f2db4b7c0346d510129a81d3adf85db399f9e6f1a924072c70b48daae4269cf6f14f0c0b3952bcf5a6a185ddc8080e7e6928144d312896d19603a7a4955be1f69bc1540c0128482a707693f65bfc03c4c44c4f5dd49920a66c7813a6188f8f75d480249ff7b50eac4d22d687b25b2f754c075e08b1b81c6a4e15540a5813974d634158a3ad835b0ef8408ae243afeafb7de36e27f169b3957de2fd8f324f6a08b13bd50fe5f928e1f6d4d1e1538988f25bd647cce1f77442eee8b94d67eb0289fe801cb6eb893c5ce084f8e099fe35fb0305c079eb2e9cf73c6ff8536242d2016d745987ac8bab1fc5c9041517e396a83883fde622c536e2ed7476bcbd0ae4de8c5a3e5720e8f6b417ae03b35df121646ee1472b2ea6cb1e4c3230fd974496409786e6d7566bfc99ccc9dbe36ec75bbc9dc3dfc0505640c71de5cafdc04ca117285485897ca641a297eafa172fd0cb2e74cfd8a1b391b1fa63c8430f0347e5e5a57a89bd574e93fe48eb1f574731645154e28bd3b5c3e83f41cb68b2ea8b0476f8ee3add3862f75dde5c81652c21e2b84d157b98f9289261709aae2dafd810680c18117caa54890cae09066dcc67699dc5045c9c491842f17f3f7b1e6b386241ec83559f2f766e2828456b5e753bdc481303e225952016bf2980dbeae58a68265348513578b6089c455ac15bccde98d0b359bdbe4a9c83ab5692bb93424f8d030e4339e0104499e9f86506045b97b378fdf18496a1bc5f4bb0e5c30662e44e091be58da0a8755c86192d0b253a12441dc103a84dfc275f3d4118b639ce7fe9ed3a14681e27d195bd0e54b10282c914bfa7edae1fe4ef89bf18353a2561cdba26697341683c17bafc22dc33717cdaf9c18428b09f9c04833db081e6e04e0755b634679e6192ba703ff4139f4c19a9358844eb2cf654295f355370d58bf2ed4658ebb4c39a3ce1ffaf6ffe6a79cb02120a7654c3db174bc18813a4bc1f3245b573e2e26f553cc399358c7568c756f15510f0589ffcc17b368a51666529de14726c763ac39681be14e516522957d9ec0fb659457ab04446447a1100785dcee3fc648e428d4075087579e2d7eb283668d34b197369b969f2bd4f63eb9a7c0169c66ced0cff1475e6e0fcf53c9bd272864bec4f2ff45f9da4ba3fa8aee46e02dbd5a7b7661473dccb3938e990ded951959a4e60c00545bd40bada09a7129a04ff66cdf274a2d58bed3c590c3b4c089a6333a92e0d51d632989c135294acb0a23c95ca6b4d595c9fc7c508fb915bf1405e6d22f856f7963cec30ba862619e8dc951367ceef3eb6d0569df50ee35ad54ad9faa7433cffbc6a78910ecf4601341907d6b0b4fdbfb0860b4f96d3032f904a7a2ef8689d9c49285f10ea32386d37739f3489521d0ed8b7471e4816b1978d07b0cce02896dd201f98045aad747f36662fbf45e4646609e19423b8353f035a3ea58c7a62253937c4c89eb3637f7d46c73f8e514a17d7099cfd782a5ec13f2cbd46bcce13f1ec607a2b4ae3e50ae52d299c5aa9e995b6859f9b49f28f4a9291d96a27734d4b6dcd01c4d50adceea7dd47a10a0eeec19b87b23a9518f3bbd065e3cf2c8f5a2bfcf2882809781c772407d2aca55054e9c09606b772ec9c114bf088b73f2ce2203073728877953433a11cbeb970ee9b53359672cb425afe9d4940f68479e1c1934125f47e25c8fcdb001e5c87858e4dab07dd4691df251f4dde0f11c1bc098bd3a3396d19969d9e3786cd73cc53d48ec1ff44a4d3cb4206e473609814a9326b4cdb9fd09bc0876f5e91bb2b798be3f5d4167781394920e998dc1cf2b08b9aaa4262c206f43142375d50036ea1aa611e624cd0401b04cf58d8e3ac816c8e2db3cd53cb13f8fc9689455ed9374ec51e6766a79f3c85e2b22555b6e78b834a0d1c26927dc5d001fb0eafd2bb6123240e2cb09e4b36dd06577d3114db1c106387976f165bac5f629337d13d0e96a93aed08545250a65bd1c44f0a6925d8cf618bf14ddff4698c95467610108627a6ad427a54e49c7f3a18df29863737629e9b072dc83899c82568504c8ac4daa8d31acb2ee412ad73ea31ee1476c2bb79a2e21a4e7c30051dc7570340e4b2ebc527628c05f9916494049ec219539c363ed2f32ca0c0dbdf28b666e486e526b4b66f644581373a974cdd84dcd3f47c647a8d6d435d14abdf10fd7a93c6fa74d732fa140c7593a5390dc1646b4c2347bc68657169d37f3f847f8de6d030ed7d9a63e72a87941aada5512387f504b837dac9afe5c8a7e4844477981f53eef94908925a34d6ce4e3514a72666dc90558a234b784f541919ae81a5e8f0c3b6e2b3ce7361e507236da2c840d56477fc13bf98a9bcac41be2bde96bbc3432736ac2960954674edc4d5072a3e01b8dbf24deea4498867af1d4cd66d25c466cf3313502903d5e67451c1548ab0746c92e9bc0d755f76a7eb9c8d868941b8d5457cf3b1dbfe975e992f931bb61d7a48f3c6416c15bbe14f625de88ff38834360387c97faca635ace939f9931591baafd5bee7405ce4fe861d19e2d9bae774a1d8c6469d7179c3c5c49034a3437f719de82c11f920356667ce2dd10c7917d9a28ad5837cf279b4453b18497f1b7e5ca70b8c29fe5dc1d66bc049b476620800915a625c7aa3f4af8e7a0fec73097fe8da3ce1eb44b0253cfafa5ae7aca10e538e5bea0ece2e69148ff8884c1670964abff7202bde4a62e861024b00f6c37aac04017227b4f5b514e48add6bd89eb2b0a9a556210a7d8d5045638a0747681442a79b3748abc470781a1e832099bf5d6ee6f90f4373debe0892028e06a66380ec7b61879587eedbd1f8d5a19844c64cce1ca67fffd1a8f7919e4f33defce2e3c57cb940482f13db23798f2322b41d152d362d418322c12064e98ea4951362ab5eeeb124220a9fb9e7273d9072d8cccbc0bb742d864ad881b01a31a531777f3c9096ccf6a8111ed1668c8e03061496134c6eb3f6b8af2cda79bd8282747a74e943920ced2f896004be3d9927e0b830f52b893590ce79a9e068e3c32abba6f26c4334ed790f653bbeb7cd83862ebbcaf1d52a95bb8859d0cbfaa06e417dc0033b85d155bf18a53e18a485dd0f37c26c2f51947e8e122dcac6b3e218829006e359a6663c777a9d7545fc1b3ef7928bda14b4fb85efc0545b1cd54291038d9eb8c6de939698948fe99e5ede657ec00e8ad534af6d43caa2e06d102e022def755cfe4ae09dca1729024a36557fb71e04c6252176f218c78ba6504693ee509006e6a6c8a36e6d396e776a96b7a6cb1f6425e24bf2be1c9e67c7fada458103e0360d7a2c88ea94af1a9528a9529c4b4358275628dec1bd5ffff935145d73bb13504231060473718ce66a872c7d1cfa5265ed40aafd7d2e65deef4fd611a534fa2dd88fed1b80569a2b2700402f10a025b48df2ef7d6ca9e027c7e728a8d90b2365b727b2d50c81ce5426dabf426c1a7d50aa85265e8d1c0f95b1a0f330055b793fd8dccbd056f16ff96eea74f9da1fd4e6192bf66e362eda0bcba338a570ad7ab4252d02e6751b522d84fca2396a887811a7b7561c4a886dea63ce657771fe2e5a1eecf21e1709ec6490f6ef184e1b67e381ed3df16621eb2c33ba6cf041a52a19e01676ac36897949f9a5c1e671f9ba9837f3111c0391d910119c36fe2f85aececf760dbe377f8250ce45484bc9e53e9434dd0e0627a2ba3a23d9d829a70f65ca781c0fa28ba1defd76194df198ed119377df9cebf0c0674963b2cad67cc9054a87875cf77f9114acdd6e45b6862cf421da1c8b50ba2397ac549e2706db6999ba060d20642d1bb6b165552167c86a82e6b514b22e4dfc9e5c84ac4aa3f4538fc9f9ff74f2ead139b73a31651af9b26028a6b1c34b089123f9006ccd1f0b7c8854bcf6bb25db43ea2193a3af6ec680373c39da93f35c449e23fa1abdd992a211c162516c9f59ff60156c3ddc80d4a5abf88b5dcfbce9b5cc0beb51c0a32a7097affea5ce93748b513b9ba2c5920d56691dcffc524a00ed6fbb31cb902f5faa53c2f89f69f9338af0b1749f7a654679d7f77aebf252b1ae1331e244b8a4981d4a8bfcc51f0de154b3887acaf5668fff914fe6ff17f905898dd7295e18b357fd2f4e225a93053d950de492832b910b73ff8ac3aff4ae01fb670992c0c8ac80119a5af32f39052b255c9d1377260b1a073a68f9e56fabfab4510df0570187352360c483fe911cda24be444d815424bb70bdb3bd3c8a8456b45927bb857f982a6a9106ac766dbcc458ca91b6b8f9f3d08074ad1bfa7823c813a94551206c260a107e83e9fffb29fc71274082ca01d0d361926411fd1c01ad53f45a7eae2b3925b8f6f8f73b7b35d62f706c1ee7c4d37d30e5a1b74852cc3324b66ca6a32bdec3bd83f16dcd812115e2d343dd78d41031f71856c23c91a8a7abc918f0bf387f5f00c03197dd3cfda631d225fe8a6683ff70caf39700d880f7ac1cb615643c1f160431830cc66e086087d49db2666c5607241273272febfe1512e2835e7d2fa8d022a41abf88025096ef39fe7c2cfdd7bff6b99e3412685279fa14599a302633688a85a73291c0cc654ab0f3eab58d07726d92276bebbb08aedb0c3f68e73cf9766a9c9c2e157a8ffaf56b49a5205d0a530c7241710b32fdda65da35536065f85a27927741efb1f3a29d185d073e70c37372920e2f394d064049dc542a535c2c57119f89412e6db6b6bf2f9ac4b783abe12760ea2bdd87babaad5ba7e2829ba2d30168bf689bf76513477887385a039c36b749b970c6d5dbb3c91b2365545e7bf28c4a4980d5a02ba28fa618fa3040e6d86290b6600b383332285c09bcc535f5ad5b5ea71587b7ae97436b16d194792570eaf3725a3941fe482ddcd202698efe7278938829f0203623e5f6d8ffd0224335129d63d20eeb2cfdf0416492be9f6c1c7a829831a2b65f05e2b53c8cc45a51947f9aa55fa3a9926fb200e796494266882c17d90d48ff6f41ac06d4dffb41b2bc2ad29164d9523caedfb4069be895704b547ad0462a1e6ec32d4b531165119dbbb20a6bf4d93c9d3237620fa0ca986d55d4410915caa2d7a1695aa20fc5f0636190cadd9e4a359dbd5a545067add5ac6e751b57cd93147044f5a90ed1ed1415aae18f0db0544cf385bddb3066f7fa43e2f1ede20f00337590ff1b01fb1a0064fe03c2f8d26ab8786a72fe25eae9a699df937954783c6bd14a9ff515968af808f37499853fd1197f9ed7a28afafadc59961539504a159b949c0e15d518fd3622a85e17ea9f27a110848164caff2d12e0032b06f9aefefd2537373efc33710c8e581022713c19f4bd639edcb46226a80180e561dec920dd012956027a1c0a47b49edcb86047fccf1cb56743bc52e53b820e335cabe0ee1dee89592ff53d030feff1f8170e601253fc417df57bc3405db8e7f17d172056869a5617f106bc9c11688a6e26d7b37e79732e579a423a74cb42fae6debfdcebc258950d51d05900c5538e495ac601a7a14993b1bcb5a4909a9209fdbe61417893f2b7ef309a7549dab6e5ec390aa4e4ad6dcedc3d98c5ce90d80b427a1bef366410872c24c6287690d9f772dba3853f3f0c04655455c76bdb55938d3f18095fbb21ca721ee25eae8874214594d24b9f37aa4dc27b938e5b66325d578ad65143b6fd5e7bde44dd783b3b2655bfcdd97cde9927a23d1d18d2c8ec37538ba8bb23f50fe050d779dfa21136567b604cafcf013d650b0424a705dd8b907170e612bfc8c44c4dcfb15d5bdc4c290c0fbb230f0f3c71349e61e1445ae96bf6c54e9181c83cc1d0bc6143e238078b972b61295aa32f45c4164bf5ef4e8bfa4cf178ef6fee51e6204ef526c97d7dba50783b6de111320ae8a7b72cef3d8675d092b2d65682139358f5ac086b9810acd63b08a9d8c5caddfbfd82943a1e47aa24ad73d090e1b048d655ae4fd97fb28ef809c11d9ade861e1c3d9fffcb97613cacd263c2bbda0d2e02e560ffd516a777d86670cb298c4f55aeb3dfbba98a9df82ecc73458816c1634fe3b8647810ace3d0cc4eeb8d159e65ee88e8f2f81f52c3629f42d7dadca2c9b9f115b94467dbc01672318a32413e272d2563a764f4816087667a999fb734cfd36fa727810ef0fddc53866487da974f160cddb26c4a9e72ff829792b9abd426c16b9004d8ce6b422fccab7f8f584ebeb395cecb79e649ccdb4a3106fa7660c7dd18512cbb5c8e58082b5da585d344ffcdc0e0907b46d2b599ab78bc2a6325e4a5c7338c79e4e8501481900548ba60bf4c5fec652955e1ec1f0401ad127c4cddca102c318d6953b8384b9d09808178c4dcb88058fffe973df9b920b3cf9c1bb117ccfa28170be57d9627d49f4e50df434b005d0293c23773f5a1b7ccd7958fe6bea7bd555d39700da11b3744d1a3fdf0606502ba689f92c4572d708847309154bc48e17cab0ab3f2d7773758933a37c0005e0f6bf92b42cc64e89511f6b1352097445b98b924ff1e5d4cf4116b0a3b558dc620e809bfed9ce1d0ecdc3d797c28febe2ecd50649cd9959d53754a5c91b5b14035f95da9f3025bb2bd9d4656efec6f1b205edfde919bbe578277118d8786048bed7002d913f8501ee9dca9c4c42fee559ee0baf8f8b063e710c7654c20e20a24218b1f3f25aa8c69c605ed80ce74cbbbc49d9d2feae478b5a49f3814bd8f5e38022b7bb91fb9f8d2d8ed28871e40e904ad80229704f8fd6c0acaaf008a4afa3f58c4abd901c8f7a30d38a732e2b6275490d7c657c1835ddc9a9a45db62e2b4edd50bd123bcf869591a2dbcca429b10b647c076e60c16b4e99ee5347604d46a22a9b5a2b915f6ab459f57fb847f25d7558e14ec6d63ac1d003a522f69d28af6c9216e972b6e5279d147736b3113a0cbd3061582ae86ea2e0875e2ce55eeb9997248aa02f2c99b977efa87b806e41f834c11894431cecf4906dd74f150a9796a40287768ea31a746d2234314443e77c123d52193df1d44004b7fd6fc5d200039db3c04611d8469ea6bb017e293887915e2d53407601b67b136be16862a279385271fb6a1ee705ef9756873a19a4c3aa5ed307af61b3b96d5ee35724c64d9bcd7f5f528d926404a9a2fd2d4fecce5061bb47c9b2135d45db6c20c4e12ed09fc4b46213035cd9fa23948b53da7a17904894f688a4128ee38b781ed2c9de0daacdaade4b75c852e8a57e1c03c583e408820a519873d834cee8e526c8e5b017e26fc75f14107f6669b9802ce0fd705aaa7ec1bff5ca5600dd2c8ef8a153f976e0ea004d48dc848bb6cbd18d415076693869298278bad15962b651e6d3fb904d7a3b0763fedef7aaba122d34f80a826f216bc486022475040ab34ced080176eeb20849f6a42fcda9d71ec694b21e8e051982ff9c50e0248a0b0fce84cf498644cf37dac83ed4953d97b28c1b42aaa29c72597776a0f9ec779271c7bcb74ccb8eb4728943888f8831f431b75a8e0d7ad20f711554fd069fd110fb365036183dcaabbd8a9b44e182d7205776757b507a9d54208026b46138f2acd39c72c624bd6371c9a3b96b5956dff5944b6059f2fabb19b2debd3499e6e39a46b0646e042207908863855b9edad9dbd2792fa13b9353ee614233599b71eecf58130b95742ac65cedf171160fd5179e8ac22f3db7e9f90de4c9a7d4c5df3e889599a2ff14f60c852880fdc73251cfec12ad987be05d2ac95ce71b5019357643022e09a4848364d9bb3d331dc614efd0ad2a9d74ed038f0e8dadb449fdcad48b3e650d59c0a6ce3632549b108c56474a22190c1be754cfa99b289c3181de434f62e5d91befe436b8560161d020104c7668d5d6340080d4db9c3e4f3408b973c0fba09a2fb884316e5a35730ce6171987a5d64aabf913d25b400b9d34ec697955ae7aa62907130595080ad6ae3ceb72b530ec02ab6d5e2df9fae58a4978b96f8a80add0128e165ecaff95041e1263c197be2ba406c8e20970bef21da5c3f17af65477ded5e2b8b130bf73c6d490b6d1cfc3b327b710227525a765458460f7e112bd7986e591fe9ca431b67006bc1a7313ffe2f84ac4c020879516a59f571dd5ec61932683f9e7b9fa9adf36cb4e5ddf521c933de34d4630c753a4282e3c106847809078c95367c9b24c736aac58bd797f18222cf7cce0a026daf7203fdb291857f79568f56aaebfc6d67872ac66a39ccd6f64c1a8d70f918d1128c942b04676336c73d2796fa6b653212dd283d99700dc49b13601deac73c38287f992bb1298a12287fd7ad75b9b9b0ae5432e60f55d9cf47d47602cc14b1149412dd42142e7c26c6002442033b8be1e0428869191f8e935b93c861e200185fa6c0ad864689c5315cc5ee9a0b6c79a6de9de0c7b5a4f41901993edbfb3b1a777d3935a238d47d439cfbfd08abe60a4edd722afc91586cf31347b9f64e58c11ad4173a6b7ebfed97a3392961045c2df916b41324fa86215e9f9bb3205851fa4ad1897dff7de10cb4c76d7ea51037d0b945f88462b8ccf9b19b900a48f51733bfeab7f7762ad1ffdc3af81b45fc42ee98a1b5ecbf4c04b1d27a620c6dafc2d5c0e428c24f51e9c8591fdf5605113ef884f8549cafd97506fd2f1ecf1493523a83b091af628a222a161a6927dc214d68a6d10fa7ad9a07c21a658266fb10d5caa29b13e3a959ac757872b61a0c878ec3679eabf023270073d51cf17ae57963f24554b11c987d4dc871f80bc27b4442f18f87d2a12d27dc4bd7853e567eb8ec6c149ea528cc448ac8053836487fb725ae21661b78ef03b783163fdde8967e7fed2293ea463c7a2413df05018f2eac6acf3c645a87f8ad4f0bbd85595b19371a6798d3ced13987fa78ad13112cc1cb363774441547e6dbd60fb34e635ce4c80a076e3ad236a0c2149c1857ef814104a52924f9e6413343db74fd5d417e0d15580378ab1c18ddf183c8084f93559edba4201b54bc84d1357d3d7d0f78e8ddf8fe6c62faf063cd5cbfcdf41cf561c044c0c661523b103ad33a4c0b58619949dd0e2f4cfde3f717be4f73d777a12fa60b386789dfd242eb1b6f5c126eda6c711a812005edaace7bca2dff2460cdd4b1eb5313043441bba62b9176aa96eb11c29b1e308f28a83cbbb102293a322407340e8bf9514e37063d74a500e97bf0b114bb00905fb0a23127b566415633239ebf182e88354011c81bdd3adf7042f0942c4f0f9889c5ff544a68c166238d8fed8e4f4d8b66c6bb1b42ecaae170149bdb93fee6fde2a81c966a57ceffb57dbbce241d27eb497daad4eb5b59a0532eb7a5a93a2e1fdb1266ee15c44a6f352043666a787a03ab212cc445ff8bf0b2492f98400584a1da3c43d084605e747d1079ba17a0396c0d7e533bd14c95805a2fbb534772397f0378e7381c11469be38ea274fd157c711d235483b52969360200a51cc533787c86efe21d129baa1142eba93c2db5a45e25de24241d9b605b17f646957e45bcd31d332deac26cf111a464e03659ee3566c3395c318f1210add4a2c28747c0234cc569b128df1742e42f14e424096ce8bc4795b20850c7db06f27a3de2e807aad6aa4cf419db43d545060b91c8c331336772b9f97fcf208a7ac98229c45c190d4f77604d51b2db6a04a2a7a073a6b1c502436ba441bd6e47874f501ff4cca98dedd57d4aaccf6396f6da3383ec57f10d486d89fc08c2a39c85c1c9157ef70a1c7689aa5cda202537f1a89df1446bc929df71b4d1a8a9d08869297293732ab8535f7b89fe07716be5274b69658a75e93c24c92554a657507e00b6512fe1c4f3e482cf79280e81cb47ebd9a5ef6597178d4ff89bca2cf553ebf709bea5b62a028038e5494a5623e0dd52129247f2a635eed2210a9b06a07d04de1d0acccf08c454a2de4b04b296358ea2a4d3b3a5bad06019e19268389d3c0a71191e875e0439dd5b038f06e1bd4c705639c4b109bbe1acafc582d07f60a3ddf5e4b7154d98d6c796d927e6726f6c3dbba53e38d75419a62e7200cbfcab4e2f6d6d244f0a054d7bae3f25b7d0df1e6ded02201e2407971d49f52f7193acd51dfdd15b374c0c7a730e96ba08b476e15ff09b1ef96cf6dc1c31ee256ab2102f05b722fe9e7866b25036ea2e42bfdf98675d79c9231ba4ca184c5003d1f8ce6535da5750ef0016a3a406f4665b248e723d6e9ff9bd44fe59fba367ffea854256b324c7d11aaca05151d151a3ec559c9e69aaa72d06fdb0230a61f527857692be3aa1ce6484f43c76789e38c5d5f04ec33feaa644c2405d79cb192adc3ec9185a6fab6a565a7d91bb50cbd52a62ed11f339d02954f3886618999ceecc086fe78d93c4dbd660327f6509a5d007d30bc374227e981164a47d4d18ab0027557262eea4261f610dd86fcf2fd98aab87c94efb3676a76acdf2727878187ed7dfbd595cdd4360fb081b8a9253b0d5213b3b33fd93e49edfc4c11831b43e26816bf37b28518d9c9f1496e9a3cdcb25f87203ec274ccba7414128802574c2a430c9bfe87e005fb440f09394c251db8688e8dc0aba4485c26e8dcaeeee23a97e4a179b3b70af3e7f966b2bcc7e41327c828846f86011f2113d6591a3eb947ab712ac00ded744f2312d2fef8e6f8192d699f66102b0269b6a1e00959a671b182d16813a9ccd5ef4b368a8afb039af73cce2ada94a703956c833c511f6ce2f1b4186855d4f11e51c2a995ac66e215b528dcdcd364f304f3d051e9847a30f57fa7c3d0f47e34cece539ea9bbc5ce2904250dc01ae41ffbedeb3db8c5a2c053e1beca6eedc4b79ef360b7775e1201000cc13a4908fa2b85401939c98ec59261d52b2f1a312e3b7684a590e68a11322585455e88b3f03d55bb3c4b73de2a867757bc30b51c92fc5463bb9c51df597dabc8ea4983a2cd8acc41d41d8b8abe2386d563209041631fbac4abd42ee7aebc57aad432e1762c84999bb1fc4ad6f1dc5bd3e8c11fcc0b48b1c0e6dd8723c60d47119726902036329f5694969ec7347ccb07a9bff3dce98e2c170fe7e740e3a0ae5cea146f1bc3482a78872331829b482a54e768263d7d2d253cabb90ba568f068b118262c8849776679681cdb2dedba74866e1a911a327e755664e4579fec6f745304510eecaf38f532c0759561b922000ed0ab8434c1adfc9eb112fc7eb19fb9b9cb09527829d285fb1501ac0d69e7ea0f3f51fbd6488ab54f0d83c5c5f250af865351c35ddd1eb23c85deee05d768fa23c73a98b95459a6a0d24e48d477a8832cd57b1d50e230665d62badae436e8497607c20a0222785320ba831bcb2e477da420312b5c7bf5b360dfd64e66b676bc732c3f41d8b71973650d9dfcdd165eb627ad3389260e6544e87cde074e367dc19d4e27f78c88e4135915de848e4261fd0b41da585c5e7d5fa21b6327d3767e0c78c92743c784ad4e2973535b294cb3a715af0a892acd7ee5c99ac799c08a872bc0df2381ceab9a43f0a9a3548a195127f8de3b6a281c4e3cdd1f2124028867802792bfdc875bc1a71eeadb3b38fb6f1300a23c5ee79e80a5816548b96ee26ecb63ababfa0584b6ddd46cfb55bfb38f0e0407565e25b0daed061f6cd243b4482319a46797277edf7c6e7a5f1b11eeba633f9e90c0c18280892c5ca17a98f97c2064ebc7ced8a180c5ae5606199c9bf92174561302687af11f36e0309eee659436cec4e2d6cc1128209274fef9a0a42a771372b25263ae0a944f0977383d30bc8cb2c7122559df0094ca130e918e2fc03c1c48132ff1c9a6f5199b475e2ea9c5fb6884b123ab1b4ec05fa3fe19380b160c8116dd623c2178f32461cc5033367bfb1c92bbb8ff0c3fc56c55802f0159ebd329d4f30ba402fef6d9a0c0075e0991250eb84aa8eb927922fe7443e307b032b4b5964e3ae342c786bcc8b6b7c8746f3e612d701919ed69ce1814cc646fb6cc3546d9daa68bb796fc16a477a9fb994c2d81bacfcaed20d23d6e64d31d91e20e7248e39ef4f7b24f65b053f340362ea25aed7371ef4943bf58d9f0c49833fee5a47b6b975c49aeb3e12b17fe99a367656067b4f26781d6cf96cae9afea8cc101584483925b9b7f0237385e909fe89be6412831c9560d3ce6f00d149f89011a0f0dd4b5573e6b9cef37071dbcae73d473567b103cb9f21ca63a6181501208e931f0ee95b5abbf68d15323a9fbb91944cb2d47dfaaaac000dd949a0432f1d5fea2e3e49a654f851228d69cc38ed735ddb22be1de3247e43590d79762ae3f220f4b708045e17fdd249d05b4065ff14fd947bec88d70ffd8ce78241adb6ceb409a57066f00c7c6d82054ca1fd6274e296ca834e140857e982e208e17c895b32152ffa384d4df858fb73a8659f9e30807fc948a2126dc9e5cefe596fc156474dc4f314c3c61373957896d6a0862023175050799456e0578896e43da4df1bb791f1e0ff1f1cc122a238c5d025f06e984659e322ddf6ff91fb57358ed6939857543d89432da27bb742e356cf91def60a48ab214f594fef5ca61d11cb1359c4083d105d38ef3ee39d81799415ad7d23762dfd0ae1f162fd66003fc8f8cee71fb1b3000015d9f3fecb34602125ba3009efcfb8df5481eca894ad183550cd09037f498b32c45e10f9b55d34277aca36e94eb076b021a4af055205464f98f3dbfcc086f02b5716c78db8f7b007b3d6281c9e5498ac0d8e415d429af47bc977f141c7fd040b9d601cb506306a65340af3e8ffedaa43b743928f0e05a4a58d5d438c5a97419628b1e626078b5a93381abcd96c61111f52d738bcd493e9b459bf686c4ad4c5cde4e1d3887bdd3977df5e918edc59acaba4b058ceacd82f98e6e00b3e34d5ca6cac303427f534044f620b5135e0fd851e635f9e768483ef782708b5f1ac8090373b8332923e0eb872ad368405d8b8e2a1252cbbc1473435fd7a0ef24bd69e1895a74fa86159de57c36a7aa96ba213dc451e09934846e93c8a85a4d883f0a3856ac2ef21d22a622739d7dc4c289b458407b8d35e48a1c15833a855a275626a40c34de19f1d9c630b6d6644c7ef3cf20edd1615c3dd22017a9dc41a7fb70bde4c578bb606091a4c3caca203a4f534d7582b766f36a24ef0af83bd7f6af644d37425ec5a91e6fa45705e7702c8c96219abcb969b6a45af0d5810b8a64a64cf44abc60d73d6bd69ff53c6aea549727cd50931dd187f72d1b1711ad70b52d9022091e8e838109e077abbdeef2a73e28a759b9bb1bae0eea44f81585353efb36682db87a7f5b3d6d868e8aaad1fbb3796290449f70d07d12ddff69f1441df2ce13c3693ef3cefcb0d3918f3ed395dd1a83d96e143bcba80de8b7714b94132c4ef1f11199f724e358db54899f04c690918ae4f14dc8d74f2d5f48a30105fddda1e64ca35651ad291bf084124e392734bdbaec7047bc81b5bc34936c6302b45c23288889a19b3f7e107ea6feecf00b5ab71216541c1f6b3a046fdc7af8f062253c207a311e6cc296b8f220683d6f6bcd89876565e5330a2165b91b9656fc0b44fcc47702c90db2879775d1fe34222f910f51fc5ded7f90d338c18d71089b1e288f2cf908a60cc68ec36edbe45ec2c2655fd95b4136ea336309c8809b54a05c8268d3437bfc920573839f1b51ab227ecad70222cc1dc53c0c944ad640aed997da06feab25a120f23639a4edcd5a7e0eb67f98098bba8adc1b632164a77ea17237c03ffb3c996c32ce8af6086b5c49635e9f90539a712e435eb6e2db72833b349aaf857132d989ef5ad0fb0bbeac515da4c78862712ba2e0db4815e6cbd81b04a73cb9c27bbe1cf161ecc1f26b1e7b2bc69eca4ac1431be5661f58cd8bfbc95d7724e674691b579cccbd2025829cbe0321dfb5c104b8359a1a3d8ccd1cc21e72b5125cd220af7b48ec718e43cdba446cb3f73c04044b76c8c97c914f93796ac3563a2f35fcaecdeeb3da11e53924ae14c0a1e08716306d6af0852eea1448414615152209d00366f8b977b77079523852a075a7e351489d6dd35d68172ae442b5c3d8787ee0125d287e710c20d4e976da72af7141429c05a0fd20b9cb3b8abef5e4972bf9e59c9e91596ccaebce8118c8dacc1baa6f1cf2fe612dca041248817b3e71d88d7fd4c291baa31b47b13af622d4cafcccddea83482a475748b34caa47c51f164c75cba81a70bbb08ef58758282291ea0632a598bd625ecd9c6d708c60566171e92275b4aba56642e0200fbe34225ee355a986e31be73a4f32f1fc0c48a2f8558c0e24e55e5f8428b04540e00d7204de9097719bc0c45dcc8368880ba7e10b900b7d9ebde73dfc5cdcabf9d20dde2aa6ecef6881939d8e89c94fbca2172763596a0248c8d907bacc4be7cd04c02d8d2be332258e09f6e1ee14327f8682d7fedf84009dfbb78ada6bb50af1ebeec64eaaa9b0a52daafc2433ad05ea712b89a8f3875f902dd6cef57f9508459360e8eed3239d58dda37ae60081253cc41e1acc883cde959a5539e94832a28ae345ef60764f572b678491a070ed0d68ab1db7d7b4bad0b9d54b578aaebea5c436874ec86145cb59ac40f4e06c0da2dade00d8b162c1ab116757c5b8daad53877273a3b789ffe60699184789fd80a49e96e4c0af17007f041ba71d83886f9d605ee01cefa4be256ad4545955376748917a2fdd6d6015a56a58dd349b68d7ccf4110ea83fc4a916b33dcd670171e6a84b05b9c67f0dd6c07705d8ba985c0a3542d7edccc3f7c7481ba99e1919717ff43ee68a816954f6b10c61ad1159c098ed1b2e114a226933d413d4a588642fdd0dbc048ba8093ca627db71d125ac75c3ec82b4f2a90e68179a9f39255a018b0c66e79f0d7fa969cb4d35c029f2ef1950a6f8b33107296614b66fa51cb2b22208554aedc6b82c93023c06a4eb46b799b7b67ea4c8c2b539f802fef38efa04458b8a5e343d9d482b19df95a062fd1973b86cb008713eaffe211e4dc79a7b76f0f72e5154e74cea03217db7d865ccb29185cda3e29ca2e784c05eb6c9f454145d30fd350125a7f324ced2aad5622c7ed59bb48a92e6c8a9b80e87b361f00bc443d63afe454b4cad29ed1f7b314160c3189c07a77dc5386e665327a5e596472f6eba559199abbf168f71618756117acb6a109bb52752fb17d223469bebd0a23c7b49984788b5b69fd659acd918f745882f95d9d81c810cf1f5e823f3848c4c0cf0fa698560a8b200923afe69a6af3741013c17c3fb26c249945ac28c2207fdd4d29ab8836e4f65f2f0b5277835995a8a4e29133f082f08c9751c2c73e3b81f55e288ba2d088e381a488c617ea63976c79db4e811a709ee45a912c236d6c79142007e95809b882e512f0603180307583b17f33bd19d2dccf06d209dc9706f457af0a8d7a74b8604ae5e4a3f1e522ab2d5818f9eca5882a8867f3d8b5ad711273aa2a2cc811d8585a2e472eb2c3656bd62dc1fd002e562c57682ff364ec3010ac5e901e0581ff0cd65d7d999d96d0bed93c22096617b4aae2ccb0950720d18f6e357d9141706e142f5fcee6290669b155be48f4ba2c65ff400bb766e40bf7610f6243263ab2b1d13b0e526b09ee1a37f03d7789c0220f0fa92c0e3e9bf3a3134630cd6d89942f49356c54be44f2268f2a16b09c6f78b07316bc227d6a88f5736c6f28631c744f3b114683b813cfe9b30e557975a760760f461937dab51b4e31713dfb20e34f3fe7fab6dce2443b196d5259a880c929a654c32161a2dba1713cfe9906cb02a886599312a5bc0378adfec1a573dc4b7b58557208fad700e4c1236b5bc92abf9a66ea56f9a0707e9754cd91fe743f4fd6779d866d45b8c686982053dc50dc567b3de03bf372608ae215edab784971d8c3144e68ecc43e4bf029b1f6bf9ce737c29bf4046867115a9dd64eb50a6527f97b2470cb87543ef10c22c9e87b8804c4324b9c03e70e46494dc32874a232a376deae58fb058d14289a0e5fc61210f678238fd2f5e06f553fe9d656a300d67903f763a17f833889720343926f4b96f23ea6ce30d13a4e43734c2db13c5fe3dc069d41093430a6530caf4473540cd20b55b94ef8caf83d787f80fd7054f7ef5de28953c39e2d832b280376d9540681e5ff720836a266421ad0ff6fa20435af493074eba7e51e5bf771d3d62a8c671d91504191f4a29cb701f5fbd091feb366533720f6f420bc7f7d403194d70a4ace9df2dba303b31bc1f7f804721c08333282ab2f4b6b9c38465645c3123af632103894f592e7a45ba2d8d5119aee0f6b4c008a8897e0897e2dd7aa4e5fa043f2bf9c5714714511320c2ecede8a3af981b8231243c7cbeb79d13852771c46a5612ff396f38a134f45172b5f38d96d389a0607d2503d2f7d11bd6cd96d7599de5c705a7189ba8ad25a4ffdfcbf5e297485a0b238ee5c1c7278bb65deb5fbb9d48ac5df57e303df443fa637eca1b437101f51f143e1882273d6bf208ff2a62b08777e1691a605946c522081e9953a956498e500645c4e48b2014de227a641fd8d11a495b78aa0f71dc8b04f618db1c258ac4a1c37dd5b61dd8f791c7d5de02bec578d3bf3252f0826ea4992f6d3cf87af87af6dacf1b76caf94f0004edf90ffde3d21fae6966d3fcfd144e386d83ff59aeb8eca5fbaa9cd41f80ba143e73380ce8a1ddbefaf13658583777e2d405d74e8ad10f030d90e5e327f60d4c1c1d3c7933cd6bf3a403356b04cf29d03f576b0f75e47912939cd7ef0f385f686b7f97011ff98fa6d08843b5d9d82af6593b136f677fe975430f53bf7cb733c5a8d1afde12eb97c655796a56c11ce866de3e87d0beb7cf699d5e8e51fb5d011eaf029c174735a173b37c568be04574638fa0cbe9e656892459d1780be60e906fa4a7a21c7b1008bc6c31d981b9e0bf1a713b1084241b093151e42900535b78a869b234b9435f554103ac61a9c4fa93570bba251bff07c9a8bc4d88c3c1c85c12608459f6c2ff492e4e0adb7851797578ef6b9d309c2e89e74d8cf28702cc3eb9b2354402630336d5ac55c40c36632a421a9a7eeeffa740d0daf327a75fae81404b189ecbdfb2d5529a14be7dc4352cfeedf9257aa3617bab14173c9158fdfcfdc3cd7da1f7748b83da368dfdd30e03e96da4bcc49bf45f3771d8d6667e0d19a205ac173e40beeb954bcc3459f2363edcf975b31a9120ea41a9b5447565714e59dc5a93e608149041a11e41c378e6a32b874c0161095a1a0b87a12d1a2a28b0330146854f11547a7b867244277bed0c97dd5413e4491da7a7db2bf1318aa2c61f76b4812e09656ba7c7a21a92dc8be929db693f8b15f112a3f1d3929dd9836e8efe0e6bd04efa4f716271e5c73680ddb4c54fea743ba9427b2fd47b0f520b5e3b34b4f17e931104c429f627b079bee6209fa09ff9a0b2afd7ae515c68433844ce9a499d4e2115bd2c77912319c1b522fb87589b86d41d62c0b69e9bae600d259bd740b41d6178801b14732599189a7e18675322483ae824843c778338d4d17589acabc0f9bf81da866207d58747403ddf6c8b5a87e1def77492db59948601eb78b72319e0a54771270df9bc9302fcf1476ff3b0f304be037dc0a4d8a4a381d85436b73c2dc527c4ead1ed75945367f803657e21b8cae529df289363638b2301f42046fc5a3292b12780ef2d8e1f82b30cfb94a704301f8769a44f1b03381a170831fd054ad1d047d24e6beca2c819dbe24c4d54935019a76b7fcf63bc5a76968769a2bd46d306a793b893fe03b294f938aa154ca6d95b214063c12ab70edffbf48cd81b2f93fdb2b2bc5bc988717e0f4572df8de0be8de8450ade2d566e461ba6c8f11c8713fe15924b3f160c05c8cd5faa826ead2aad64d9422ccd1ae56a16da973f43a08cf482ea8bbb453d4d988b84871671830f81193db4e983791cfd433b2aefac330289aeed43258b763791270bd369f029828270293f1528298acf9106746d3c276cad46caf5870a9547bc84cb4431fad9c51f574a150feb922887f2565575d76d2be4b313660edbb39a9f880947f96e067f6c1035333f8aa508de1a4586033b022edca6988fd9878990a4b378a29f52936feb973c509ca6ff3cb33394fa77f4353dc31ebf4b8bbe04403562780fcdeaebc9dbe97c2f384df14eead54829b42bcbca67a44120a7133f011f6c78f90dc9f1bb771c020078e39a7c3b148be97441bbd650ce9f0be7372e217965ab7c326855fa0b280d06835d90d7d89282262cbd072fa300cab3aa87ad66da4d8d4ec077d540fc6f01af845833092d78c3360d0b89c7e19295d3d32b468b9e84a8c4dc5fe899e1d8744a02fc19b6f81dbdefc928c6ccc8d91a5e71558ceea97b34beb075939068b5de14b6dab1acb654c9bae4a59b4679dd68be517bf91582ae3a8558abe4267ee08a1d134d1bc6300bf8d54b199d3c969d5f6343f935c2e21626aca21616695c6c6cb4f2e7f0876dd27d73ecff32cac38559a4e03468966d8580f2d8b7ef64e5bbbe4c27efa37cf4f77aca30e411607374e3ab61ff75191dbd1f084e57441225ba53b5b0d8230b8e09d060f3d43cf40c6a526ebb2e108a6970198c83233f7b8a206327ab64ef408c1a2b904777b2b70272d5574170a64f7ada10b1fbf29193d20dfa52ce6fe92198e48fea533c69baec875cc8969ad07107c786f74edd9742635c731eaacadc4ba7fc22d159b547101e7a0b4d058be811abff9f1ed1803f760de461327219ddf54ea637528a28a8bbfbbaeeecd0a56e44863128db251ceaee254fe9582e33f13f0b5d7fbd65ef8c60730f5ce0939cdb1b23b46817b7284604f3f14d1c75a7781b647d71db61dde181804e34a1e87a84ebe7aa2fbcc300fbca28836f43ee5ed1c6ef7986d38843eccd9b2ecfbacf18591a45592b01b9935426b5f272beaedd684c3d81ceb150f86906392649b47f951f885adf436856d446cbd35889cdaf55d24b2bc590bec1aea6bc63f1cb0f74eb62f31a56dd30824f1ca8cb6e44598a33f455280bb9d47381a6057e0a09bc2e4c24835c071cae50b4bd4764ad1c64f7847ce6981a7b15d46211aa32a8cf140ce80667a5652110823b263c806b90018d464f9a77e2ca594aab4dba3b55a807850916269613ef3ba0400a08e5328475a930dfafe1760b43ecb7136407b78b50c6183c68f6abc58027cc720ee0bdb25efa641e76e4873816f18a88a3cb6655e51c1b85e41175fcfc6be9be62dd2093cee5b7d83a3858a2c8b4dd7cddc6a4f1b83ce9d2cafd63f3ae0b079829bcc7daa62d257c4e44c4c68dbb6016ef0915807a78da7f80a783b04d9d0059e0c40110131e28a15c6131321f8166ea004ee8e3c0d7c2fba87205ad03dd68849b4b808be7cd73c38472bec2561107d450f61ad482e65df807949ada74cd06c4f4202694b36c4ebf95ce4862fe2d610bb68fc061a8960ed411b6d4bea9a11348655904cf774f35ad64821099ee189683cdf66b4fe9b19a4b69acf6edb8668f7567baad28b20c924815e06edcdd1433271be6d805bcb8547331fb4bc1e251e37d668472c2c435d48cabbffb07cda6da59e26f6a41a7b214bd60f268f3b1bf5f0c6f9856b3100b62e01f26673cc672d01a2f84d95da43e83d5bcc2ceaa24bf327f237bb9c9eb8da96697601024e1f6066e42878985306eb62d5bc40c9a12415fdf1cc48d0a2469eb7cbaaa51dba747a6c8b87bd39b8fe8769be9fad6688ef02078f9a1879ea268b39a3584927b4f895df063dc24a5205fc7f7cc59e9f14d5e2dc74ccd293769ec8b6e6f606052099c4a7422dda506468d48dbd1624c63487bf79d9cb0a219b5638eb88cb626a041fc1fadb3a959e468ef023ea8217e0e9fd62def9494fddbbd6144cc97ed169e68ef62773516a1974837ec8b62f206e216c0dd5ebbdc73dde4fc6f87c6c182f604979b69045b0e16c2d8a78969bbddedd9d0e5ca66a23cb83fdc0aed679ad94853a1944885027c3cefc6f69f3af2b2bf1d509b513953c4ca3b2d8df4112322d00857d3bb57b7f961412de9ba627588928e9174c54bc234f15c2d1418ff48fdf93a3b63d9b79fc47ea6c2f00aa798773c612b3a82c92f00b04eab0109a3c75ed20a0eedb67e438d3764c2c63a9e6247643a82eb1794175a3c96751545e9575a0cfe6b94d69b015fba7105fdfb5a5fe6872b96fba61eb3830e708113380883fe572aa47dd038b084da273359df74155604c4760f605e6d012b25cfc52e30981c8bed5b43731bb338196436fc768e594a8bb2f39302eee99594434d39a60347f2f3da9c3753ee4de8080442acb069b87fc178b625256236a46e529388da6c0a01065d9fc6be944361433eedeab42081bf01b49c66e302926ad4f98df7f2d73ba9bca90e0f3a2403c3675949bf3be0ad437f6046dcfbeb8ff7b0643f4a94f25595bb060a5fb4bc3a3078106ecdd68561276afcfa1fa1b3423395da4c3eca4b0b7ce88785497f760d9f20ae5ed77eeb240361ec0aea123458a8774fac3843d406eda48ab96c82a08b4bbbe381c467b2aa5034f16251a070bd38094101ac59bd3155cfb4aaf6ce470532a4896cb7c1f060631bc9bc845ac94664f91d8e6fdcc543c315c17bb4dd44d56dcdf0fa0ec5b5e782975aba4b782a9726b2d4d123279f1b392a90f8b930172342db650403940e29e9c4ba73a1a6767cee072b58ecdf5b05d9ad571095cbe8e72d803c9e85631dc97816cc5ca884900b4dcd8523b50950fabc61cdeca92f285622e002ac1add3bb76787f74e9ac35a80e2257d47b0f10d6ea208c37a2f0f43a405904af52eb2482b85388ba519402bafaa1306e32fd3b0a1dcedc7c53662b2daa41a6df58f6b68540a1df3c513f1e126a3e3dc93d50f11c2ec56fb9335c984d52ae8ccfae31c0e14fc3b53624b47dd00b9e28a05c1647d88edccf0b981cc278d86b940e4661be20ff78330098cb9a8e796a7dab05efadd505951bdbbd57ae98ceb3eea3332759808e0f2de1cfa7c84d1ac629e72d44cd66c9af17b293f779c41883f1de86638efeb94c8a957bff0284d78cb9dbe038b6ff6a8261a6cb0825c3877e8400166ada2a901412e0a68f6f594321e39d2162027bf31fce6dfe1fa4e6fe50a1788cccca345bcc05198edf5f129bad66c6c6374caff3e8e36211edb321d1a3e194e8f3ca463033e2c031258a4a02a86a28ff4281994cbada0d522979eda3ecddde14ccaaca39dfccc606ba06241fb26586ada8793eb3fd4ed555e74485079bc96a9a814456c6b8b1212f7c8982848cc65d34a6a93a6282f5106475e6093fbb219a0f7f43554bff4d689de3b869b1f66bd2f372eb53b5a40e2fa7c123ea0b4c051f8c689d9e121ca11acb26e0099d60468613079492872be99b6fc3046625601eef55f411f48e3cd690507f14735478db1c0e59943767a9b7f3a4e44e05c58a9709cf0de225bc89e7d12e18e0365123927ae952fdcb255b48f596c765cf6a12634a9c1a779d8efaab8888fb6a3b3279d6cfb477c5241e09cb5a30bfa0faba0357dfd7e9a4f3be8e69bc7c435d9918eb865221a30429c57eeabc87d9748453f77dc2c2c7c4f26800c9617dbad249d3b9edc624c374cd9a07be7c75710f0776bb0e6d126d2c2adcc6195aa644d26939c99a5e24d5aaf07efb557c7714c2f721e8c1d779b9ecb331045eefe7dce1c5a3e57478510ef9b70693ec9a5484cd8fa1893250087bbc8d6f0a0789ddf5f86b009aaa88cd3771c8182ea08c9b19f3a1e41adef4254c2ca273a27ce0089c77eb4bc4dd88d5064290eb9000b204785c97a8158942a532d78912d003255e8e150df9ef003ef5153973bab453cce2e5ddea2d7151110718b9d49a87fa6a0211217681a3b97bd7fc76778cb8ab5feaf97ef6e18df3669602fbdafad3ef4a408044613664613f0680db71b766365b7a6f9ed86ca9a44a1db65d97de27235dec7cc83c16572f70c8545bec1712385696f3fc87341d51e3a3cb7edbbbcd24d47c47b4ada24f35dbc96af3beb2131a340b16794bdb7f864ff73680e64f070cc5d4a9b2c18d693dd42ae08b42dc4a16bde1a2dc0d78b48ab63e391eaf5fc9f0c5dc20c69bf81202e4a27903bec40c93e0d1070215768809276d648e9de1aaafc2a0cf99d3b2ebb34f05c850bb9c2db6bcc55bc68fe0c6ba0346b80f40d871b5da33ed06c065ddac07f17a13a4e374f08397e30812ff047cffc044ca884264d2bff81e678f9614037d8690609ed925e3759129507fed2bf402e37619b8df58b5f10aa7fb702ff4bdc9cb82ecc9386ba1923091e341592d1276c5b7b5c72cd9128ca7ec4fe33f2354175d813e01c2e3b3b7942e5299be22a6a13f86c94875298c13075dd3462ae6023a163b6f4c68c8dd41f4651503aa866ca4174ad41e832f3ca2267916390c84e1f14d55036b4cd0774b7ff98a289e9b1f481e53397d3ca7d9ad364a2eb15eb5d860218143be4367274883affd2dc1c62a6d0614402735dda2a9405a7a31f0212092b06a53a6e0c387b9e5e0c922b90546b591515c58a16d8f5dc7036b094739b0eee21cac2a3985d15962326b1ae747276ceb95d8a5c54fb84bc845f8ea16d706aa1d5fd4e8d208097a5515e0bc1fbc71344ef53cf28ba67ad53f277157e3a9d66e733ab73362f5e03a4a41819879d9bc05778e3aa037df06d3af6b13af09e5f5005f8b7cbfc63bda1137449383493c973ef6245cd5cc37e440ad3a09d0f3dd5520c502458b4c3f0fca6196fb9a0dfe1910741a9081d99288bbae666e1e2c0cd88151bb8cac511f7dee99de287ce320850591b03c8c062b96f85dc6e1052745447ff01d3b32174cb17d24c88de4684a42f13462cc261a116de5535b187e9eb3cbd97b1a9d29ecf23209daf596a6d23956e36a32f2e6f75c20c780b83fe56c47926235e141614cdd5dc742b93de57a51150a0db7bc8406786c96d6e3f2808ab485634e4ee3048d118c143fa7a247868a982c77aef1c7095591fc8f62c95c9929dc11cf4d7c244894c3e5a26c9c161fad644861a4cb807757e30499905c3e4bc2ca76e94167484cdebbce4f0d609f9599ac33d9c4ad0d9955cdbbaa47a96980e96c6b27977ffcc2ae2a41a2ce039d851b8b13a930c4d9ccd623a89eb2dbfb14dccbf005b2033ff889a9f5513205fca93589288690fc152c8915399ebc7db64be6f936cea6b9ff8aba15b07cade061fdcd463a1b2b0e10621d173900424ed910c0eee4c07ffddc1c229cc5732d7b2c09e5a295c3755388a47c621d6e3b3fd5bba822010a34ed20a655669601e2db29bd9fa3b2e449e48571f546ac70db1875b56cc73e027bfdaea3a052d20b4dda65d6861afedf900f6e0a731078bd2c39810e3ce3a7ce8355d839e7240baed2309fad281d2abe3b366eb79c4ad0e754ac270f763c8e97c08030be8d32e30b5816cd76452ba135530c8ada6b2dbf8731fe09a966b37bdc62551ec2017f7d69463129f8d5b93c9506f7acb8fc625b5584f7aa677f525f92a8dac7f33794589be8440994b38616b707898f3e83b7cbc9803356de210d602096332387e52be0f36874a65ad2dd7df035b0e49b346abf6729bdfda9e299e726d1f63b0af187e28fdd9c7666166b1cde46ef8e187cbef2cd7f43f7f69ea8eec795341f7395c531f57980faef8933822372bc0b607dbd0818d1d8e3dd43f325cfc5027a606ce764bd9fbc80836f8abb0637d0797ceb9018de3bbec0ca3c99a607c8b1bfca3bc3835df50b7397820bb06b180e5110d98fa133ccb5aa4dc2847a7a56e7492039eb15d90cbd7b68898cceede03ea7a14fcd98f88be402323d379a967f38545fbdb836e78719b3f55a40b47b7f2076695c6f17fc559a46eccfa0b0fc9a36dbc6319c45153dc2969a710d10879b4645954e2c67e399fa4f805d4d99dbb8e53e27af55cf7c8ca9ee9b9a7c6ec134a9bfdb51f0452aae1224c7f5b33409060589d749334fb6a12370b71387e40c69f112488360e4c2ae432d0e3b20a2d1fd5fd5d6a0340a3946ac9d9f8adffb95ce44d218dc1f141bc1cadeefbcd378e233ba2cfa35eac6fff0ffbc8d2ccf9c4ef252a208c0b49d108e93d562eafd121444422fd0725a6c2daf04db57d6428e7b8648177e20384497d58453d9857880e59f4975050b7d8e78b96d9b48472ea49da25028c1513f041d5b14ea0717b6c1e4c8eb36b4675207f4d30ef9c509e45dca5edeaa7c54bea7ed3dbb0c00cd7d249bed4f21444c64d291e3c5b8100e2b293feca9afd81046ef92411dceda2e2b5b98f1e843bee182fefb72c6a6afc43a65235dc436804cfaf6d68d1441f3f1267e40ff057651c1e1acb2c738c249d4e53026a66266a7f61de6e28298cd5f25e098efe21d10d99ef050d91891fd1a5444c2cdc74b655baced470bd490232f32821b21c98f39063433650cb39b5e2136f2dc511d0fa9344385b5c739af8b0e724c007d82f5f112bfa56c415c4474948de0277e570cab7c2f8b1d1bba26ce73932735d15f275f022a9a43999d533c32b51c851745eb81b966d086577f026e54dd510f53607d6ca3862969ca97392dd766ca34df6b40201a5b2ed3a944e33cb3235efb358afe858d27679acb4f1752c107119e64b9e32407b3f5f0a89b1c353ea19c27f9a24a8490aedec34d39a286a1cb5dc5a4ba433d0125f21c19fa700f49c1cda962706e22ec4d85cb088ee77fc4a13ebbada5c36757ea6538809c1a41ebbc4291d2ebbd750a1281ff8738e1a0e0b78fc304f1fd1336215a568aab0c31276292f3ad6d7810699f3fdec1b6808ad0eac4c4e5a83f81a7df7bd32820012a19f85d2e5f942be739c08dda6807d1e6dd3b125b73fb836ef0b5b80e2690cbd310bbc4c5c266d76ff22a48cdd9242b74b9633287cd44e89e8facc0fa1d1093f0883ad5a3bcf10ab0a0e6a27561507dd8ec58a1c59cd0d14209f3b23cd48dd72d33cba5c821b6d7f90b639d1b218cc3e71227db0e4aa1eb6b71ffd14c40501b19d251d1de7272bc7ace13d779c9def6313f9f7a7c7b0676b8c5b6f408728a1d0d5957d9296df38a31766dc0d0d734e373ad4d3a3e454403085450f9fe9d6e2ea6ac3ddf7e0de62c9d9a701d31257616f70964672dd967ff4978ef84e18ad0e7fab228d91da2e7753dee15bb2db8cf23d0d06920da58e44485cc10f0613287a04722412f03ca0dbbe860f1d0f9213afcc91f409285b962c73033d887ffed5cf455ce54f693c57b9218a31c70b200e3f87272de7d55ed97a64d0b4349ec8f4a5073e140c0c8acbef4b1d8a6fdf87184fc87dd66aee2ae6580bc41c13f83f26ce0c1ecd1d4de1159124a5a1e33e032ecd4227cb987aa658f5e09608e42fcc1b8228dad037dd89e0f7047c497d6de1045e772a9b50b157fcf09e1410a637de4b6fc64531aabbb069b78b9383b9c77e8a1657cbd95142cedcaa359f54c2197624d89cef30fb9cdad988ae1e6eaa9e52630127705b95286805b8999b805a873475fccb640dbb08a984e48925f64125f33d33ebb77c0fd4456723c2cf4c4d8d980c83ccf84c707bd8ed2fcf9fe36f1265b2f6f4c9faad96fb561163ddb056afb377d7c561f88ac307d4fd3c12527d6d6eeb1445a8984b7621501ebfdc416e006315abcf442d9213074496470865612c01d1a6eec176be6f9c330a541b48d7058a3ff97674017b2e2b2d9df5e361a7d95da7ec46e418afa71dcb0f507890b25495bac795551919c8a157729669b6f572460103d6afe70a2ca5137a688db5f6f207f6288052047d76ccea4a5c8d03606f05b3e0a273cf503fa56a5d6c73f61308375fa6eb125cf87b34b45889e5e57a4f64836482cdeeb38118b11d38b7c9e3561ede9e37aac204853bff213956198793e5b83b53c47918da252f15c276ed82de113ebc773f99aca3a94a7994a00c1a2bf4cba508964bd2a41625be44fd44c0e619c8199c1adcb694ad8fae9e1b892895996823a12f07f7a5e54036f86cae209fc3a0c16b34b247025ff107bb0b0fdc323a34e0a62fcedc71329f8923455691e87161c80e1d529c274a066a00d45adb5a565727e1445e4c07025b83a47b6c6acdde71683d7225979674122eda8d7827ad35ff749247251543acd1d0a83d1209c881a517be24bb409b44d5ab6b7ca3c610fa09fac19143c2e0ddfa39b23d00fb46828064d3df83459c6e6fa7c0531a0febe17e2ddc3bc95a930d8ab48df798bcc445667056d76f0d033984d34892557ba8d9cc7d6385e22f5c1b79fcf7199c7118ff71ce0468ac04cf5e0d8cbf1351e80030cb9f8b9908c4214ba5e708947b48f5913465120d9b11d2980f19cee015acf327d3e1f3de3c4bcf8b76e72f7b3518edd01b5429ebd600ff70b8bebcd74c133768ab5a75ec8c611d984b93d778423a3ef07ee36f2912d679ccd45716f231c3801a16fdd064b62bd577ed7f6f84752e55ea95b7aa0438b1a970d8d859e46e1d667e7ec14f70e7df12db0d37114f432f4df4e728690d56a53b3d6c3b8c8d547a8ceee6209c592be26bf4a479a736b1f0b597fe66d6e5d27deb48f2e1efbeb439ad392bac5541523e1bca6b4d8e5f94195d0b90a57d9c5265e8c3084e68488c6e747f770e6a5c0f88d3df51fd65dd6f630809ca3b3516599a7362c8e2cf5e07b5034a582ae4ce59c242a80f817050b9d8c50166f4d2f9d3803cab838033b1a73c585cb573bc291fcf9f073dd10a0ca8d8d01b78ebbbcf1f511d00e4c15fb502c984d7405868a7f509b1683503daf07c1986bf5d072459f8e8ba2124cb2c0ae61ad0188feedb6d5d48bd25f584e5c77032641cb4eca2dc68d914e175bda6502e540628a6a1be75ed0739eef8a07474a46944cc835d62cd9ff137cf90545cba3cb3ffef227db39a82ad723c2ad741a6a3baa4ff6c5dffa7a71fdba7ef4989aa59efb3def9a68724c73df742186f63e00b428aa7bbcd3b6dc77d850efd2287732e3149114c4c27c14fac0b971c3ab9a8723060dbe1e7ed6b2c47385d5d25ded1da4c9bd0e72e36903c94165ec1a3d01dc573c52a48fcafb36236a3224f9e5c059613330ff1eb5c5662c03b9a94730409fa2f49d1661c8f283555e821787143dfcb1ed8608f27f21de4074403d34a796cf6f8454353fa2723d6ead9132142dacf9e3d3d1f05019b48099e85cd4b3a7a19ed2cbb422c940cccc499d2afda206a12d7d6935e236b55230b2176ebcbeb6f99db57e0db390c24de74392ea6bac982f3dee2495c9f9d7361959f330e79e82b24aaa5171ba44cb2045ec2c2d6e134d1092cf2a8928c2e7ea4967db2f77c178ba3d09fad5e1f6ca06c3e40411e920631b3b852ef9004f51aa2467d029b7a1287b5f1d4cf4b63b5a076d3b97c4229193752b2e68c0bb2a1b68e517facaa8515ffccb85aad2b66f61470fb151eed598a9c2369432d70fba2173a64cbac79d7e6be2038984887de2619ca3b187cce4a0c71ffc4a1d9e5edec67681d751ec89609d90a54ca321dfe2be1ce432ef8425616cbf0df281aba10bc06af1a55be46243b0d9bb6917a81053eda1a0c5959fd9cff188bbcea7147985deec8eae228db41b8009b675f857627a8d8e4e6198bf5979612652d7d606da8799b5a9aaad9c9457321059b29b9236fb3bb4ae36ac9f6151492d7922dbad8058403e2de86107a468e672b5ed949983eb01963c57153efc604cf2f7c6838a75d8f2b8fd5cdb76aae120a07bde58601bdae84b02538e40f85e999f4453aeec74c70f238fe930fe3d83a46a02607ac47739cc2366bbc9e545e4cdad5a0ff13adb9ca06452df86c5b6143b96aff29d94a22117fd654910afc490ba3324241e09ffe1f10e1f8c9ed746ffad3c158652472a39259d7c3b83964d43daf18fd8f7215ebe2c8e5883dc1de61d75ce1dc851966a0626242229a169b0e814ea122e049d264e67f708728324057c1877eca46314a80900720733875b4d46cc3827e1e16f09c6604c613083d2c0c4b7b4213b66f8d266f1a255219937df6489fc5a3068341c205e491e11e867c26807eff9eb165d33f44c494ce79ec7152d1d95c8f6cf4425423e549db2ce9abd98f98a01a11de700ff7d3f752ab6105a7d8318ff24372ed56d83611eb7935ab576c8713d872a1441e23e0bca40ca0b56c653b751686002c6dcc4c7aa99ade3e4b61edf31861c8a0efd4f3189cd917c036748a283ba79d360154a22c840282674573e3245b2fdf4bc21e55aa0237f66329372185759b7307a87236652023ca69e678fc0f759b087fd6f9e3345d4a634d1afa90dea6a49e4bb1bfdfe7528000ec8ebda0e14b0fd53f6909ee482edb84002ad25a3a73e1fbca866cca4b07f1e0cc898ce48f2277e4fb0eedb25c01e63054b347ce6ae126d4ae9ad87de4a55273eee054cca6a3bb6c6323ef9f2fc5dcb177346dba7d260e19a62707dd7eda95783e03000961c81895cf6c6e6d106e2dc1eacba002d35dcac81bed211dfa10bc5f6e3b87c00a968cf3765489374573bf792bdfc1e8f50dfa8b94104d1ef33acd639a4a5318dfe0b1f4db3d904efb6e3a262772046e9d2783ddf1a1c5b19205a004c6807ca92e076d0e378166238013314cafd0e71d236f46f4965f8e681300cff2624faa421739d80901d86c029d3116048d8becb2dbc26f7a7318c0c4fd4c70f3044743239749c5a8573901f9c7b751d99ac53467400a125955e4a806e462a12cd8f4982f9606ef0bea394d8d17d1a16e4a0032425ad159232ff1f05299e55affd9306c535bdf11cbc0a6dfeda048e330f809794c472a007c6dc3a5398c7427fb9a5aea1c305f399ed0501577633be4b95c4e8190e4b7765ef8675c7e544ca17c6d524a4d4ed251545e8ff606a0664b37ece5698411a82fe75cb6b416ec239f20edc8345ec984e139e54e03876879d2d0bad5e7834cfcb51c63b102a280af969f3075be773268edf7f31bded0a7f503f8c94b526bb775e2d52533c0bd47418ac077e0c4ac9f0e2c7aba33b85e1e5d98586f5d04d38d75dc0b6be04f2478bae627c39f1782475412bb473b6a73f2e38b387d3d7a70aeee8b0931a20cbd62909776d99723acc19b1e4ee46c7e939a0a652f1d0c36854054076ee9d5254bef6f83b7cad3326e7e989d09ea26a743d05342b73ccc91fa9efd771f63f2cd6a71d1d13fdedafbcf32a9d9dbe89b20c1f806a03532ef0e328ee291c2e9e8d049aedae7fe3fda8c94cbf433039b284ed60ccb17e0ecaa871b20bf8bc28b211b03916e3c544d276f7a315d06469a04b0a5e385dacc93bf255875c513306aa92500f0e12ecabef17e9e2af92d806b2e1464332785b6ea881a01ab835717d04321585064c2d1192725c3d6aebdbf655d108ba2a11843bf611c9987c5096846ffd10228657654e406dc364b29ef02527fb4515ce9297ad50b21e66ba9b2a7e4e0a4c08cf6b8049cbf62e015928578907c2a073f55fa4bae511e357859a853c40df30790937c9ca8bef50b965905b2ad960bb523a1663ef3a2d5ee43b02371c6c04ce5b5b517dc154d896ce650f9d772205a633ae3fe9dfd9aef7bb865ae78e283a9610c8912288ca874a2224de0338159684973b9f7e47a92d9015bb41d19ef345ce88768596bd3202284cb249efa0acbef72668e6c88869165bebca2cff01127fea4b650ff93644204913e92eae3d89ee46cc1b441f6483e8ec71c57405e2f71fbbfa6882c2a62877ca4a88e2545d3e97898764d74ece8681242f585de0edef539e11a5a2bf929b17a1ddb8256d8fc06d41b4fdcbb5f6983049acd16109312b09eecc4f1af60eb9513c5f765a967c7a95a710ddd456eee8cffdecef476355913e147c62b2bcefdf4dad117505c2acd3ea07c0790131a32e6f1d8ab4534417356bee70417142c3e935cb21f8dbe33c8cf29ebb68f4762668ab9e6c97b9a544cc5b3b4ab84293d68c4ec07fb8a774fd09dac35ac9486dea903189d2ec5833661741202bac0e03a1742dafc13d1a658b42754cc2ada8a7493fdd3b35c828755667f896e8365aac4e87452aa70527cdbf516c5888b09aa07a0939afe15b82cfaf7070e1de99ae0ecd29e1dc8ce1b81c0c38cab9504201b65291977fa452a70a5b985ba6c08f5fff718aa438bb4e5f0965b97a468fafa36e5b57ef49297aa3a42ce773477d6edd9e2b8c339ac83d477449c73d33b18a5b37d9c3e438582aa6c340b45da31655ca8a3a2cfa5d8880c0383f69be9796a9f75523d6e2b70a3982077c13178b948f4fc24f5fdf12f037f4a4547d2f7b5405268ecd7905b8a21c68cbaac8a97bdb97ed247e44bbf0d8a1e843513e09fbde7ce905277e8f8f1eef3c72a975c17e0ba1e9650d140fe48d215830e26b0713c82f6eab11082a176ac1415a238e00eb49999f92162f7bbcdb5df839d4c2389bc93fc651ef1d346251ec627e9b4c6edf989f5ec8ae2994c3e6487b75d30376a0586e35ad49ad0cf093e2b4ed9c40e7959cc2747d174fc904a1239c786c094002fd8e4b517471520315689433dbfd98cf3dcb926a7143344e357798a7aa1d1f4fec6915cb8bb61a9f15e804d809c432f0231ec6f32714e3f4ca0aabf7ee1879c05b7029a8b1119e5bcaed4c0481b98e44f5cce4d76e49fd677a21fa800a453803477b0e5497408fcb4c6f305b90b53e9fc0e2e882ce4a2492e0a7b532cbdeb99be7e5840475eb9b03100c8f45fd9e1b85f78f5e06ff537beb6f1803034c2fd4d26c0ed7a8e3126072b4b2233997c191710d318ed3466826ce0f0cf6131ecd803494266eaee0dc10729ba9715d4e30806a6cb005bad655169da6118ea94ed7d2383fa60f2b21002a3081fc66825eaf9f119003ba6a552fabbe06c73e62975c05f34dfd494b7ee5aae2765427eaa1e5385ff13d5861ecd264a0bccf68219280f6e5f341acd24fe2f7dca235d2832b0ae1012a00c8fca2c67873fb85dfea2820d8191536ab13ad69d6877fa44bd88f9f458be3fb9a9a3aa94b99f256afd0ba235531a3340bb892346e71ae68162463a1b85795d2669e420f97e148e9c72a7c502312d0f337634dc365e0c36cc1e4416cb1d4c044aaeec142482f80778ca20f4a6ac412db26f4bc6a74d2b5720f5738004af555add7a68a98ec8e8dc15ac02325e3f9cd385419d7525b2d7e21e043b590aca2a6263508e11ac27fac282cf584f77df441a9ca1ea698a5b1d7b55438d143a6dbd359c73ac1ad97b1a44813e3a3207dd6e83edf13f9ccae374066c1a5ee12153785837e0685d295b23984489af0ce824cf58dcb7b1ad0aa3cb7fee5461d3dd2d8b3e8c073b8b29fb06f7de09b45a27ef2e176344643ab3629ada223665743f01736aa9090f06bf28cd1566b0c566676a112bd7480995f55f9232f6f6b3781e32f4630a44feff235991b2d1c744ab8cac5d46ee97b57367e34a40ce2d9d23f7e2a86b9b402e672751e5b25d219bfcb84384ddbb4d6a586a25ec155d4e2955b1c83cbd5a7809c38d040b7feb03c49831e083870fe5f50dd6f00d2d41929737cf8abae7a2f77e7f94a5624f5f128c04552cf9229ced26265bef3caae413c4e5d23a80f54942556a407ec962b5afd0814629b1548b637df89cce21afb1188432a14f6d227232b06731e3f30cd168414ab5c0fe9a5c705a00688a7437edd2b36559eb18bd8ffc45a01fdcaea3cc248e0c8158460e475dfb0691ee7c606d4cdb4cb80c818b0cee7a13260924b25c9f1b2b11e97746656c848a7aa2f12333ac84ee58e9d373e68daa3ef9294767fd0496004d7a87aab5acdf07b474ebb35e5aa099a7e868dcb17d148468dc56f2f0ee3c26591f4e963ab19729b0a6095c3702e3d3294d21b435c9ad403952fb433c17ecc9ce790d945bf0bf1f4d592fc4d0521f2b0f4108434832403f0e4c9b83c73a48817bcb17e60f91c35322dabe12ddcbeb2a1e44ae94b3a5eb8077417065f6cebb2a5b71122dbaf334f08d6b7ae886a63cc18f31f6bc6575f211b5e3604a0aa745e2222d3849de2640feb5def2fbb00acc63b8fc39880162eb2759af58cf2347e28b140cc429307fea85ac00232cfd94b3fa2312011ca6fa9838ddd9c11321375774f97c00f95a6e81f9bde9e7f02fbb021e93be470c9a5e96871d040f985c1017410e2fa5e4049eb74a127fa998ff4c447f42f0a77f79306ad1a30b433d60b645175c4029d39ba25963f7da6b9a9da4092b80a664653eb0cf0efbf1bb00a2ea7f8d02497e36f581943b341725f7b2a50cd140c80d320b8fc5390e541798f6f776212bfb6e908817a2d29790725863c8aa28ae17989f04ff2121d57ede409638a213feec2cb1cab83fcf367022f127b2c43cb139aea9adf3b931425c477283a8d76297135520b6dc0df6dd5768044b52e78eafb8f1776c5f505a249296ed1d21385abeadc5503f48aba89d3e24d9bbca72388b2447cb5187299600dec23dbb4fe49c3a8fdd3fbb1387106ae0e24951825310df99d8b6d16164c1141062add5b1069a6a637b6b41d43d2fe69801d47c4be6d045e2c98508deed741cf90baeb67497be916f38b5565aa557a5a983658bd0a3e8c69ec278f521db3e650f9a7536149145dd409c57a8587739d5ac77a6e94e391dd05dbacb511c9ccf787907849a891822d001f78e5a8d599489bd89b717419afe178b679521ca046127795606307d42497a4f621a994648d800bbb17011ef498fae07bda424b5b88fcdd0ba83ab7d9e5fa982b1c1b41489eda37b162b431ada7e3cd3d512d3ab65ff16f604cffc6a36e9a3cc226f3de9efc8f64f709054df147041994103957f26b57f99a2e46a11c3ca34ee12999d5c8f2ea59a7a08f9c1906d86fd81642b56ab9c6c1508e9d4544651472c0de045d2978185792b7b3e3112c31de3b870779d8dd69dc8baa2951d10657430ed5f4454043358a0c2b15c6297184ae00fd4a8b66944dc0a45b3917c5b87b38a84b89ad112cbd0689464e590c4c65ac1247bd68837fb3e0e61073c4b9b42afc1fd560bded962596f90b11ab7d9004078824407e85ba78727e5a10290fe7ddf2723cc91274d76873189eea9ca9ac5f8a21a6ddd41c0aa18065a6e46938142d09853323d84b237b2c9a7f6fe2a0095a616967418a793887c3cbba95261f346372b8dcea77ffb84ac497925a63acc00a58e491146396601f59b1c89070a84107b103176b4a7d9b36aea6bb36268d9396c3ffaeec42ac10a38b3954470c7728de395068c08bdf23b65da73e456a50091cd208a01afef0c63cb6902f9bb7343e37e13b606bbd2ca879864378ca754f8cf6a2d955e17d1a982bcbeb86d52f5debba1cef5c02816bafa52184da4973a44c8ee2df2974a94ec355cdc8c11c7b81affce8244b37b5be596e2918d3fffbcaf882d080af8ac10164abb577ead95b4475b59b78315958bd20b78d8977483caf7b8047c768f7ffa0ecff4fd23b601669b0eb516ed97dfee245c4325fcce3729b28e794120e2ee5fd99c5ee6f65462210931016c3a93c08cd1dd2d0d70b2fcc66dba7e195121576770bbbf7d10513c65a9f1078fa7dcf83bf7506f0e059691ad428d034f831f9cc8919d82746b9e9b8467d72a157314222520f1758d4f9fc25e7e5bf5f295f79df9dbcbb65a20e7e80116108e801c80b955d5767357985de69296c921c25b256e39e3f888e67320bb15da75843cf846b59d446d766c44217741dcfabb94820fd49d331f9510a01bcc1438af580ef9fc3dfbf1f1f91e4e4990d5ac13d9e1e594860de41e63638c3e64fe0f5d91e6c16ab5d9c29a4c9df90b00d9a3dda640d444b97048739b96f55b29d40229c64eaa44cb01bfd5ae0a653813535cda691a4486f5e942c303f2a9f884085df22a168049a93dcf70b1589434d64d92e094dbf96f36198707794b8de3b4eed3188d303043f8fc3baa5a700832049df16b217378d23b47fd0d6da4af6a78ef2b1f3ec6ba7d7dbd7d331ffc2016d3faebf5b1276e2d32e684e8e431bc7c068df2d9ea385a9abba4b18c640ffb4cf96c300ad58347c9e7c4f560fe808c4dcb1fc5bba70a0b03b355d94e8ca88011862d438f09e487e4f8809791fbf5d811ab098aed650c9c566d7d309c16f4d16edda5fe057d721e1b6a211a349a401d01e8a460204e5e7e6f6e76860e2733c60cda6c167bd72502b0aa3c0a5fd36d29814c5f98f2f21b61dd6e2391bc7e28b345a2b72009f12d6c1919b3f2437cc52e51593b18eedd1ee22752c5695466e612e4ceff92afe9e920e16ce3a6180ddd2e96f7da4f765998e14f8179fb285921bcb01bfc090e1b19fe02bf8b774305b6a508419ddaae77c107ada13d14628bb566d4fab066ae243fd7080ff144e3917c36b2495d832f3c4f2289b69da9f1ac6394435d2d8678c420722b64d1b3e87aa631cd86c936ee6f6a88964c2c49417224f6a17ebab4b46244fe91228a1ff4b209845fd826f437fcc6834369c4f3a4ace8455861fb48e99cb3bdfe20373a7338d4b05176ad7bbc8f043a7dbb5b4cc2b3e9505517522330eaf7a4d15dda6885f2107b856a350c590702168ff44b68bf84fbaf296fe68723afe311e9c246f70a2f253f55d9390f716adc4d0e2f3922638caf61611b179d3f7402804fdd776d62dd8eba85a2ed7558000af0a6ff9bc8396a630ace8d047c6dc7f7c86be271df34e058a4d9c839473bc9e8d01e5a483659b9531dd2ac5c33279a13b914059f4aa48c2891e60efe0b2e1acc5825f53f81096834405abfaaac924e7a8cbda0fc1da53f1a3028c4f6b0fb351dd32d9c82e958200a47444f7c24009327b520091bd466f6bcf02e3c2627fb36a95ab67a6139f6fe528856df4e3d72ae5f7c11d56dd9743b65c69ac0b78611968c993e8581011d57dd643e8ecf98a0836505729ea332b43314f81ae09fcab6a261cb9fe741c2ac7b3b81f2701c05fc76df8c587f8115ce6097981ac5b832e7d1aea8d2d57ce837f70c2d0305ac2459a12faefbac854919c1a1cb18ce9e5ab4a458145560603f4309cf0a27157b90936be10f9416ca7142c7d1bd842e710731f386131f829846bcacd4bdcb77dfe34e2ce2f8e0ffa34708214740b6cc0eef00dc2ea89bdc4ec4018373c3fdc28d555a91d0d4b7947fe888c92529b8d1e62e4428b36d4ce097d5d87889b82e8620c6998912067bd6901221fcf6a0396b7ce001b7977192c109d5f42230ab3ed9855ca5b7af2d79e395b3bf2408f9f495328256809568c6de7d0283c426d445b5070260bfe4a70c9a1366aa1eeacb68495277f87258839a56e6655dbbd7f4728674d2d156b4230af4d85506000a5b9e55e3ddf7451605fede54c093fceed32408ec089af4534ab6991003e7eb022e0cb1cabb86b0734194b91da3eadeabcb7e7f095f30ccac3755a221ae47381c9b70a5f26b11827e2daf7d3c66e09deace8fc2d1fc8eb48b56ec005ae6ba6bba7e05451b42824cb8de6cbde13070eca49f6e434970e07bbd662121a14371b65a01ba4f124ecf9537a5d9c6b47591a497a5c23ef2d5e73504f41ddfd106afeabed899399fe34f396262f58a7387a729403f8b7c6f066ebc147345267f02366d3e8dae908e0264b610b41a0277c57e7706c0f52accc7355ef99c2582ce94006b756091c6ddc6c14a5b26cefb499d5fabc168390c8ca895a5d67f0216d74e1df140187cdfaf959fa6fce7c803664d884323a26d70f8f25f198d2c2d273b18b2b1929e22f93b6fa8fccb22bc3e5753a81d95b60351d685abf84b68c60224593f5732f7c972d54fa5fd072dca29d3fef5f5a90c6d01970ce6b884383690d2169ac8ec3f97a1b8fae48ba496c9bf15b61f267fc9bf0ab0f3953d662318cb5ed046989ea4955d4764759ea68979637011cac492d8a26a7388a48a6c68cb99daed3eac0bf446fa11db718eb69f2dd21527f00c7cc5994686e66b6ea29a5e3c81f62cb5de781a61f27f05f47f44fd9ca6d7270999d655af9ceca328449ecab19939bfc487b3026a7faea2ee51e4089e6c053b588cf9e91992eaef1d53abfeea300f90e8c1dd5397dcf48c0e12ac439914dc3a1a91f71eb6414a8d7dcf9b282e5196cd0c82d9b504f010c0061477a5f00feb36da7a247cfb53321fd43d2f4c9b0db6a7de978fcbbebfcdeb893c6c321f95e940c92070fa748a1546563995e3bb436125017c4c87db96d177c5510e89f79b1eb404debc4dc8f1398d8fa39d61b346d5eddd97e4120284a229f52bdf88cf18937067b51667e77fab720de8aca1c518e61b58639875c048bca705875396eb9779236f7179cb842641bd0267555f64f8bb52859ba1bd87a5b616d1c211fa9a1ec68da2f1cb5a00006b591c96ec44bdf0a2c91e74928a257a2d9b0d46643df12af4efbd1bded91cfbf2d4553f8dd87b05693d83f9cc2c38576ace9c390e704969de015e583f488ca270a732f6042cf5467f94b97c099fc89e8df0e575c518ac4dcd8b3761e71ace92e95b8d79b02a9a80f49539dad71512f9992a96e1c44d1df5e6368d962e1b3445efdef0e9baa13b1b15880f789d24d7dc92d2d3302363117efabf0abf621184b1f3cccf50f4c617970fa78cc58ec71424639e7d12c8d6a31a4f11bedb7d309309f936a628e07689b54f75a550f920ebc70cbb1ca8d6f4275d45e8e991fe01b842829e1e91133593aecdb421ba0772567e523f4b5d44591067387229f7593627613601afc0de7e422ae460c6f3a625aaa84c14c3845b33903b9b017d4d6de937d745c70fe867dc98f8ca042e263ab355b8e79022863b155e0fcf11635c90fb62b28a4c1e86dc90355440f2b976ad29fd71be649a24d0ab2ef497b345e93e953982fbef32141b3d01a7497a9a3f954221636c3b902d794a8517b2f7cee34d8ef49a466d2c2b4a97f7836f8e7a715b00c0fc061c9d50008ec73eed376f921b19c86e43a13ec9434ee344cf605c3f1c0489a4654d6f0d1d2970ca89e03d4e8ba939f4f25221131a711dfdbe8112b178c8b3e5d54742a9145cef5b5d7759685d0fa8df10922275d63c51a1be1713611a43ef03ece19eccb0c95925b75d963c4e1efa81cea19a6762c19d9c2060060667c3f065bfeb8f427d25c47f14d0d54eca76bccfd7610c3f08e1d3ee85a9a7ef2dda7880440225a7470857651450dd526a791b828e3dd24852e7acd8519c72c20fa9bdf8b0678910ec3f3b57e802c22605d3208b2cf06b73438a2954c9bd52f0440817707e2f4b70cb2382f46d20d68a6dc0f259ddc5065737fdcc0e31d26dddfd58b48e2b3a9dfa8381b42fdc10b4bbd07b7f91001c0ff2809667a41ee28c73a6cae8eba5785abd54e725bbcde26a3b385146b47f4532fd82d80be36f5e731fe6c850c46d679703e531a474eb35c9ff3b5cdd88678ab757135512ec0ec3f5a1671ab8a1d3067d0af4814e3a0ffe8f2cda450d549c53ee85dd1058bcde4fff008acc237fcb4dc749432da99f27b5c9bb25fba1377c3b1f2180477b3b8d12115fe88031d9ef8268f02b17b63a33da9ba0f64496ef740f0d2835ea88d6f15d95db1ee33deee37b459c2c8beabc736c3507de50de63f16468d5fee3c204b4c5a3a845f5eeb4db9b8ff1b258854ccefca2c724398daacb3eb10bebdd7be0a81d2c2f577274e1de575548821b8e1d19f949cf93d65076e37d476299c75a0a273763b8ccd8fa0e4c4fba1f593eb1aa406ec3cd843476067b1e7b6c292991fef0c8002e07b84e6a0befe13ea89bad392e7769935557dddd4dcd878b306609f6547cfad903a49656d84f3a32e4aba6203c34d0775363af8d7f9a00dacf6394000341017eba0fef39d9b78ca86e153e31d7952205752f2e4aca879b21d1e85235481c10d432222b00d885a92255b95790de06c28d538642867b00d256f95c9c7d5ef7ca1238517a5f9ccd2981ef6c43f99c2c7e7de6a53c69e5228b03d1b184d32619b33a061f686ced0b1af4ba6b81d5fa3c7dd26e14e8065e2757390b595bfa77fb3c29d40cfec53acad5b579598ee7c3c536e85e990f92a7bb31a3d7cb5d41e7d04cccbfc13d8c858f102b8c6fb7a4b511325aeb25ff0bd723d6ba055c979356e63770e2df42cae1778ca08fa36d7bc9317bc8eaa4001c573dc3bf3148912425335214e564ecfd7938a1f6ea9981b05b83bd8002ab25dfba22f35d92a3e862a87f8452f554883c1f6ace92786fe0e87b4b41aecd9730b2ac256cde604708810bdfd3a9a7e60915b528402d99d09db909504314a7c15d861d628a867942d10422e40bb70f74f542e1ca5d80728d438964bc89abee4a4166d1311bab81f7a4068a10df0e4664e3b39a616beedfed2f396d344b7c76e9c9a0cff56bf4666be22653d15d388a137a4a2dce8126fad4d126b71bf044933de67ec7b1e53c10bc8f939ed77c2775c7b4f8408eb685ffd9e3b5e4522b188f858a36ae4698778cd27ce097b564bd3d5eafa19ffadafece771913de6496a9454d2cd9be7becbb13337672f2dacf4acad74896562fddf64a81842dabf876b766be6d9c94fa12f6a5d506dfb1a5dbbf3c77213a2e7a1e7252719f008c8f048ac00f1ddeacd5176408a5b7043ad0661e420a07d90f53be2dfb34b18503768c54d26c1a9b6c3d4a9b429a294c9e5a2ce83c1987307f94a51e22253f346d97117c2610d2f985fe342c3eb8979fdc8dd2cfded1afd8d2b77a1246372b66e08b1e1206fc09564eea9fa5e0a4ac06f1883d993c0d8aaa21c175db39b0da28ae61f6c94eb58f138e849f6965a2f1dde3942700d6c9f5d8f82135a76f038bb2041821db95198b4d87edbb4318f87fcd1c19268ab46141e5ea2749069f6b59fab4835b3e9186db4516ae55e84e3641ff88a8a0c45f4142e6d5f659ff7e9297bad1d4633443033efb863c3310e68f0da06cd75a93fcb7df7f62cf5089aabf2f9e46053568cefadb60833eee4427efdcb4d459025c0e777f20eabdd0f5bb64371111c142de07c87927fc0e2ac59c53db98400ee7483f82e3930b9597f6b34498d5a90bd057c11a2999759f89438934fbe8fee43c2a8bb4fc73c587bbbdf1936d1de340af0c9a0bb046ef84647c683b6dbb45e5d08da10f7153613c8ee0f7dcc4a28f39a21b815fff2911cf2b24cb1bbb7fd90741ac6bbf481bc33f7fb3922002e1cb6ea0ecb8bf373ed91365920694b5997ccf8cb6c32acb11a39403dac447c229f967207be64a31a716feb867918bd348c6d3717dd3ea584340aeae757f8b7db52e79d3fbbbec14f80587fd9b12e0f9384ab1068cff1d7b877935932bfbe3f2524bedc898da5a0a79ad6c1b1bcab5e845c0dece50f5e4d08f37614316cb21898ded408e7fc1a6ccd24d263da378f039e7de870c90e20385ab34349c3ce9438895e4ff2b8a919f1b1600d6e663e371b3496fba9100a1d752a8990b8d72c84e98a84d2c24b35ba9bc192c94a5c718078b5a777c0a2c8b28b53ba1d193d3229dda3730eeabd7cf9540d7eaa8a184db78b382ae2d61b0ece26bca932838bd96e0ffc8fa5ee93a9b25ef8b1707c5e2b902a75f98c89d27008671eaeb9ed4fd4b53599e8d768256832182c7dbf6ae8c8d4fd3d369f02b025caeb8f7db1fce3c8061bb4e36a0a620a8022820d3ed28a84c38cb225771ec8d082132fd85916d05534c15948b3d529b77ea7e36cacc7f8f62bd1b3a4140b7a137957fbe22144fa3e885f782be9d099514760dba96bdefeb5f1c8a29e6589b67b1de84761d9676b84035d416664264dc02d236b0df3d5f5eaaa8c6339782595ba58cb52920fda79cc948afa764e14662793f1854eb728fb649f6d717674c8f80851198ddce3d2dd884613f4cac2b2c010479d89f6fde6dbd09cdb37fd38ddb585d0db2ccb31015975df607b72dbec6cead9edae0f7ec42f56c66813931a582e66cf8cbcf52c1ce89c613a8b75348efa0d730c0351bc40f8a303bf7ba1b046090861680177808d54c5544da82bdc29ce4c50d783d92843fc4f0e92df6b5fbf741bf57d2cda92ab48134528c79f533f9642580b5ca5dd6e8c2e7ddd29ee23e5e64ec056e81e86ce1990b5ba86010e60151c7517f08fbfdc589b97b63ac5095d41370985ac9ea3a585463829079c31a78b80045505c7655c62a2dc84dd43c455bc554f11ad675dd18b8ed74467b6d94ce3387ec8970841d9c16f96fdbe73b290a2be53635bacfae548ad8a73d9db98b1bc6c8e56737c74829ebaaaa0e48e02a9e2824e9ad3cc92d5e631cdba66417715e1d13e769a11ccff8c0ac290b7ab69da5bba9e486fdb2e2536070a59d37fcd72dc1368b3e8ab4b9dd49ea24884d23baefab0aa791869790aba99221ade538c3a3ce3250de1b1f58b7c7df894387e9c7de766a7e8a3e57f3e6862956a8c11c21f6560da82417b730851ba53d13804bb1427d3393c568f9748395b3ee43bcbe5749c72de47d53ba601ec4ab342c80b4497870de76594458d0a8c1529459955b434e56639d6c6efcdd68e16ff9aefd827b8b9e463f695b7fa860dcc0d91b68523f6233e776ff5194a7d92e00bec59b7633e4066d47cc3c00abf8448c6aff475c203f96a83aeb32613a753b25d0f13a42bf39d8938c5403040f21824adeb9a2d7ad8e0054152b138e11083551e175fb0ccc2df6b80c59fd831ff1848b2c8cb357dd9a46ecfd9285ac42d918de4e2877bbc5d59778a43ba95117f15b9fe22a0a52b98630478d32b9e7b055f9fe0afe12a93eee391f4f2df1af4e8b69c9e4195bc62929b532a7f7cabd5099e9499ccf3fc3985f1622e53698639fd5947abc0d2b6785a18c2a5a8eb0531475ffa043f78b68c26eb87e7457a56fe48f7fa1a8225f8129503ddb75847bae460aa827d3fafacf23710aa7d19d3c1431fe134c7f1f878bbb3468b2be5000394e72ed20262a02756f974ff5a19239e472e9f03cb115267bc33569576f0c286fe7303417d07f9b5b9b9dda46c12313c8d57aeff63336495632a7c309c13f61489d6fa6cfa33965a238a2af8a319027d7caf18a5510186a4ba714fd8adb3ac6df9301817aa7d215635c5cb562a6f5c4077bc1456ac4a43f3123df3a2afa347d898d001a1fd04e1da7ab019923b90ec7aa701a0ebb47774beb22a357758dea2760b5af773b609673c99bdc23b62aa9733270900103ff5c17856ade0e875ce62153a02af7457d7ba74f2470ed00b2cdb612ea5e7bec207488f2a731e078ad86ba2767f0f70042fb3a9e9fa4467ee9372bdd3a3a8c72f57a75bf2b2ba9e9d28cbd5ad2cbcb24803d7e6fafce27d8e367ef5925160f606cd23a352113d0926e00760057f6bfe32ab4453ff9fff06a119fbd5f6bf84a5e99ea27bdace977ec8140f11458b7876c8cd3f5f62eb21651aa69b56ae56eca80523774a94ed953236380953f57557ca50898359a48d84c7296efaf3d7d7dc49d282e1312068e7b541cc934721537d50847a29b4043cc4874ac8e4b375670d99bca0301139ff4c75df5fc0ee5097f67a3a8e02e2d4dd72337b44f45bfc1d9977345c93631a155d71686891f94081fc229c8372f07cd32ed4f4e049aba135cf90c9fe6cd09b122b20da2175616e005a4fff241c969ae82af7543b583094d796d69550b77b3a8fae9177b43dc69bdad5aa3d0994d1bb3539b31079d549a3784ebfa5464fdd6ef83eb2a9cd66cf81acef3aa64cdd660479cf983dddb70f00b0b1503236aea0a45dae863c3c0ffebac3314cbcd9162599fd40a1218ebcdde03284175841dd040fb6a49fe3483be8423904bb1cc4a57f02d39694dcf50136b085c23b4c94da4c10bfc2a88581b676b6b17cb998a0ce3401c523efbc1f8c0018b714320f4dd77f99b6a9f3c6135f0d4151be268df0b1652e369bd1f6dbaa7d0695e7e77a899a87bbf0e7837e7ee8d7cde8a4027ce9e35cbd91968493faa064adfabcce27fac9d366ad42f76d23772efaa4137c7ba11df5c71e56cdcf327f21cffe37b5df699d2578f663a855fe45fb2d15826c65d4db574c66d237bbf78f3ef01d4766d43bcd00f289feb15782a223035359ccded04c8cea70f547a8d85729752f03d9b7a9513ae2a8c1aa0950d2aa635be67eadd5e00716242788f87229763a1ac494fc659ffa8501302bb0ef238c5279e32254a1bb485f2b9f3c6cc746b708e6f0a2f641d4aceff8bacd5f5a5518de963a011efbe9366320b2a552819187718cc47ad81192de90f0a296e07bcf25bd4ac542f1fe9afba413c128f7412554de4a06e220adbf402794d896129b258e089df4d9e0ebc070d8873ddc05d2310f45b289018d9fbe6c115636bf2877072a04051f416cc03fced9a58063c61ecd32c2e66b296cc8122cb1efcd1baad7ccc4e5d4b5b67c56bac832086c547ac9e53965366dc92345c311ac7d8ab077d8b99c6f7840b96f50dd20541762eeccdf4d592b112d24c7f6adcd42833b6ad4b663ed2271a09233dd732a8574cee8b43209d786e554c529eee8f668d86665b6bb47db2035e2bc7cb49a5ce0b68a58859f4a1daa229aa2542fe3528a6feafcbd451f3b0f3e75cf7388578cfc1fe33d023a822e1a69dbcc6b64cd0b392678a22a3d7e14e169cfb6b220cc48fdfa1ac23297e556434900b72e4421a48c66feb5534938f43a5c421b157f857f978b7ee87704b5f6db0a74a4119f01b78c47cd7ac6a221d2695c8e75c96e6b1bed5740f114fec95762d3b7a88988d2c3aa4c50be0a2bd606df306b401f84e43217566bfb2392cf7f42fbdefe7004a55713e78a86791905ea2143e84992f3c7669ce13c3d572a1117e264b5555d26108f13291d3809700515a26ef6fd4223e8d16cfc7d5fcec7379066a35bb69b0c6d703215cd30d386c4b702bc3c21aa5689b34677d24c22908502df7c3cd028e5a7aabfdc4f65e803432b7c7ada7bc95d2223ea9eef51668b5b5525271a03d674fe9178eea6a9d01c6a932627b5f1c49fd9b3c9d0005c02f7f5dd8c968bb431ef60e8098ee3525a727b892011e2ee2eab39c2484b0b08c1c9dbbff43344e1700dede1631c0aaf287fe2a70c409783e549dc7449d5c2caf07d96e3a33cb6fcf86bf51e4ca27bd617f2a6446616526f508ebea8cbe64625682a2d6bc3bbcfe157940d881cb2206be803c3a004451598b9fe686afcf909616ba915a11ed4fb940b29ea6a3f632fceef574ab9d9b5adab733d349b05c719579d098ccdf3ffeebef07ff1e316e88666cf7b0631506b8802572c87f94134b607f46076e07e9bec633110b24f98360550ca6cec0028f1c362a02142f8a32b8ca34303988ced5d2e32fabd6c1f9f91277477b81b5bfa9a6d6fa30b65c9118db476e7471beac559e211fe036f9d60f5ff502b517d5a474b9152db864bceed22d98820ffc90cd18eeb16647df51d1a43d0be8d095247a1789bc0d567eb153055746b0ed54c0a9848de67fa439ae4e18303cfa60ce8beedf438b785136fc14ae4a6c89ecef7a6cbf914ebc90bfd4515d4c5ac666eed177534aa615ec9a4a3f402d960c4d0d2c572f5287703553c671e35332a23b34b2248f56348827c7f84ef694f5f7f0f88cbcbb70aecb4a5fc4cbc77161a44b6358dc2a8c50f80b7daf3741b3ed9b904691d0d41a4cb135b1db32e99d31b0a99be57aa98ce64cc8b552629a7bd065f92873c5e1e146ab6626306c569c5a59b2006fb88aee990a288e1440866c3a2306696c553e5b4a6c020258cbf834caef410194f5df83d39608f49de548973e5edac0094503967eb9a8a7ea7b5fb8dd6c3912738636ad73f6da67e0533888bf1049d09d7f3f69903bc39775b1453dbaffff50aa497e33da62d4197b1fe00204a0a02d28d7e880b1bc2cf69d08d6f8d78823da8e05820cc739376ec9de6dd296285e9af9eab33233e6102b4dcf07757ff3740cc3fcf28123f4ffa6ebda3c3fe56d24876bc97299c22ec957ac18629f050c95c99dda007b312648a72df68832e153c442a6e80357011018ee7ffc2023f1cb018b88ab99918aa780e20769812b7ef04e36328f8d71364ab3356a1c146cbbe00104c5cb92656351550abe13118e353aaf16af421b36df412411dc39b05680c431623cb22b9344877f1e3d0dafb906b5f0d8f9cdedc929fcf1be9a38d78b2c9a0f63f952de89c28f75c4273320b132afe9d6bcb544375e2bedb9354c90b10fc5cf4a572f7cea86c30cd69f2fd4de6000f74a49df70044727d0b9c5897ea49e2cf9d1b5e497f1df614e57b93b9fd9ccffdd9a646eabb004090d392a8b26ec76cd32757feff48be710befc75d465c0db5290c33abc32720ea88a61a53ba9b85b5c81b2e2f33195246c969e1a749883e79d0b0db88d2b1cff6ef0b9b59e487e56ae98be00d28ed03a76af586ddfa5ab5f0611b7ac6b1a8694ee7a2688ccdd3ecd22ba2f6c5cf89e375d5ecdf89403a0007afa8480e85ac56859ca137356f0de00bf3a2c6564db436237fd8a4c7bfbfd836c58d344a6f33232b01af68ba1f77f46b85fc7226a8c921a52551674611282921c1e289f33b783a72053bcddf7c10041d0e20c34bb307006b8fc42da43c256bda03bcba36c5afffad9a9e03383d6c314a4b24f79251f85f283a4787e6a92be56d4853117e4a0dfb1d1b74b2e509693f256f27cd55711686a59179862e651de569720a0b6d4b5f945dfc7f00ab280ca1370d9a2c8b6859cf1f0cf93c7afb6f3e08ccc2755cd86efad41865ba441d9bca51e22612763f81c1694ca04fc55a0a0547b0325881550b340a8d1582de65ccd0020f7f2a067ff71b65e80fe93d8d3d61d9ad522ce326e548cb7a6cfa2bb222ea4336f7c8b22e3b7a7a3d01a5c5afb3588f264dc025c6e4b060220bc858a603dabbadad1a9e0eb4e157fbac62dab0142c835219b0413b1846597d6297c8d8480060e86568cf8b593d8e1f11e641bdcea24d685f22c89fde5cb0397152c9d75b9c277175c384e86e21d2c61a382bb53ff89d213d846aa8b534ceb931d6395df744579dadfb3638c38e8811bfec60d46e039f1efd037d4fc19a060845e77b0540311f2ae7a9d9880cbc3ce3ffa144b60ca8a11cad21fbba5fb4a78be43773069f7086c9292ba8905a0fa60e9c1504f263657e22f56fc6aa40d40169b504d24db3dd743dc908a70967116d22a11ee197c06c77c132379b0f21c3abbf1e2b79a89d5afbc5fc3801ead507fe6415ee4704081aadc6851f89aef242dca6fee4023a1ee181d5b639e7d82bf63f8c328fc007917fb8de6be7c407c592bc2a30e860e3c360cae82c74ad6205c182ee8847e31fb4f816a1bab11084ac81cfa8a8d1cd9973c3e7ff635bcb1bd9d07cfdd13bf2b0b90e0032971a0ec617f42e970b4cab42c3477b7edc217fd4546675fc253f0fec275a89e042b3055f5c224a144c8d5bbaefb5c72dd94a9ff845ecb3d3c6d105fcee97099547c1d835484dfd0b97ebe7b2c3748b6535e9ab86997aeb7fd306df60d56bb827f7030be4417285f37d988377429c7b5f74d34049e01f2348f609e28d74a79e92bc7a4fd0cbe94ebdb021ee8ba64c160156c7b9a6b8eb91ad5e440038473f538c35b1a06478cda852666dfc40502a37a70275d211f13f87e59acccd337e60f28fc561d30eeb5927a91c71a9c77f09d3addcdc675293d8a89453a70e82d73cce9f33964044fa1b41bd499ec34d764f90dbef7e63593aeac09f0a31c00fa87334630a12ed9f26cebe57cc38d2276448339d63e135f2637b4b35fbeb91fd23466bde6e7286d8ab9facf2e5e358651dddc6fa92ab138c8c5f06117fa8df968924b0cba85cc04a0bf24abf3c3e9bffcb2a339a989abd244bd5c57bb63751d7fb26d030f6bf2eb54be792253ad678aa84056a7da8d53596f4a9c9f72cfe690e2f060cba862d4951de0bb1ab55f702e5173a29c0934e204d91d0bfcd9e965a44f90008d8d05ad91cedcf140e73878e55ce0e192d5f5e5f22faf280f5d6966aa7af3fa6af367f2f16e3ebbd6e47b61a849d5303ea3e668da92d8b766c664162235a0f23ed522a66eef920d53bdb23ab659d61ccbdcf194501a382c13f5a3676ccc6c67d9435ac86dfdc673a18a94b33b9233f4f91d7f84fefa7fb852fe3c31ae927bfe8ed411090c6d20939fda26829d67a46247af8d3b3f31c6f0b67627ca70cdafa22589e89bba83f8b9849ab9bbe769484d4cc605f1741113047309b4f0f994ee443b8aceb3d80823edb114d826a33b74c36a2cbfa4aca159e38e5b3fdc554750fd6b7aaccb797bab939935c14b042696995db4ac3b2a79195399e2f792cbde9de6ef5aeb6b2ac6d4a221069b1d03ebf2e0de668b154f44b62a1acd1d451a7c1987f6625afb20a5acefe47e495701dd127c4b41a9d6547e72e051b3da26fca2b8cf5acac629ddf9104f43cf11265aa354062c52f28df361a06efe8f7da03032a15e034d73b56adb0bb174ea9aae34ae62ab208bf7bf1bdc0fe003bc1512d2b7b03c17b8828590d2339e87c58038d40c369071bef2704342000ab67ef3bbdcaeb37ae12bfa10c8dbb89fbaccc4d02c5d26dae6e00f2d35cfaff401dce48361f9b01bf3b229d76c8066aa09334c29e6f62a0f24e5a6ed9b48af52367873b9f5f28fc3e911db564303f3738560e63454be2c0ff2c418eca618769e465caebe2e453048bb2f7856dff39c7966ac020b7829e005786508036e7ff49621f9aa67b0d1ed239948703205ffdda937336628cf4e3ed4cf748850c4657fecc34272473e933370a65ba83d85bbb62e5cba13db2e0006cdbadca5bca0c68afc3994a3881bf5ee263a2f9720f5de341278fa145c41c1b1adfe2c4bb757543dfb2174b5c1620fd4924283d896eff25e11677c03ca209fa36211e104814251dccb359f86c5fa722985c79d72a422ce5fa460eed13c580531a3927f63aef4392797416723cb56a9ccb5087ccfd2e1dbd9b9b680f1a3d1777089031b351d971ed2c99fbacd6652248d34e309fa460f03447bb84ca6005c796e8856b93593ef5293d8b11cc5d1ad6ae833b4c61cdaf3408e8fe2c5b17310b14f13c64e81a7ece2f3d174491931d67f38f960af86131320c0e938eebc27fa7030c1b929c61476ade51fe12fbf8fd81ec846cd85807ab21ad558cb55678c14c4af52fcd6ab73fc279a40ad2f0ff2e529b1f0452f7cdfbf16eb0121a01e44d7e46f96c234967c26c4083272701e526e018ba75e5e03e1062eac826a280ef71230d2890bb4695db6340280fb8b6defaf3ce56853af2f85047868e94244949a264084f30b2f77306ccc3addd291c13e32897daace0aaa90d5e6d45958f27a60ac4a954895a22312f92899e7a4f1fd9c4472490ac700f96c73f5b96e6632562ac4008bdc431639af4bbf2677738a515a6414d35a3f359aacbcc8eae112021b1f0dcc2b5c2d2985c7e1d8c854954e1e08e291d42ae2e16b7345b91606dd46daefc38dcb1258435f89b4827a6c0185dc12419d79413510ab19db3ab6fc6031bcdd329c874b03fff784dc0df6e8e547c8951e8eb53d1a1288198933b7212aeadcae1e7221e142ad6a968a44475afa1b401088a6e0bbf71d8af97f1ac74291d10d4b6cb62ef4e3b4f38d75df0af434a4ae7d46371257b98c380bdb2fe5c07724fb4f2852d7dc5a39d0f23a840773f64646c5a1eaeb93ec560908cd01ebc3973eb2ed7d8c5f7cf7ed0b185b91f4b0a79f72be7906bd29ceba0e29bf0dc2e0a99366a2545d4e78e6b8d5c6730b4f63c9a0ae5913b36caafd6d39732f84967489a497fd097840c70503d999aa07aae19ccca482c356179010cfe97e2ee4439fd0e445f57bdba04b03745c7df97a499903d93e2374de26014fa213fd8480f879dfec837b06c3282b4fcb0665a0116e1b0941f55a62dec478f10db38b5b98d34cc341889585f80e3109824604305ffc3eddf5f6d8cb2312ede7e88ab75ff1aade536203830b308ad330e271c83c316d286ccdd02074ae91b804a55b1e62573405f99a43794bb9bf84f19c5eee13915c6596b40d61e88a145bd8ada04e60f463a4a667bc52839f9a1cc58f1e88678ec58978847d3beea245f44a936323bf041074205f40ebdbf47e6439346465069dcdc90792002dbff5331546e636279c105d46b4900e02140054e39388f92a50ca46e0e48ae59cb06d35eb41788c13f7308fa17ba1ff53784cf9c312bc4ea6689083e06f72cbe3527227d48ae17f726476f14d5547015bd1318dcd3a88f44c2748726ef21fa1e37041e03ab601612ab15861d0d67bc66d7b5167fd630d6974c728507142723a28a4aeac28313636db157248c9229a46bfaec9aaf527aff7d317bcef7b264f00604bcdaa9affcaeaedd8730997ccefa0d839821305a2a7345681da37c7f9206259e7beedbed525378a6d9f6bef08c0bfdd76152c3b6e6594d4f0767b20e2d018ac7dc87fd054ce345aa0a8ca9f07d1153ae6c29a978bed3f4ed0c236b03e92813e1c16835ab9953fceeb4ba2c2e6681e70eb723ccdc55fea70d9b44f900e528b6276cf67b65655a63cbc508fecd80134f4baf83f9f34582b3b14ff46b2089517010389cfd408623f975f8637f06d48bf97b2c91d07641e29c88f8bdb0cbcb89dd93f5852458b6d2deb289ad4cc6942e18e4d72ff4287d45b4cd947e5fc181abad4aac3f30403c88c833fb636ce3eaa948f737c384a6e6b2efcbf01c0fbfcda58bdf81a45c1eec916a9c71aac60be525ff71a885584a0fe4a512f635f4aee12fc1cd391e8bede02be7d56556df90b889b4684faf15d3b98444e199b6cfb3e3487878f2fac1aa05a74fe9f3dc7034474bebc5b8d338d034e4ef62499e7fe16b8368c70dfa63bd9f390f53e0b114b9c0b3dc3165a45728e16401839b1d6fb8bf767d5c8f37546e35a41d5cbbda4125433a2ad9aa8d7cbf480d5b2e58ca4fb9399f36c595933e1ab3be0d9c1ca2fa3318df1d62b7ca8d9378b01b224d9c1c8b72c6529da9d002827875882626a1919adb32b82f1ecf66c9ac5617ec50ae4426a86aedc46124833da60fdeaa56bbe920f22cf4a453ac8f84349cd30a1e41b2104678e95215e54207417d892afe616f27ccff0e897eed5c429bbe6c22d49f8813371f5c83632ea96683d9750be922fb2b5033e4e0450650a47bd510b1ce4161fb5cc74eaa3661bb33371221af298220791959840534bf8c5b482b2b2cc269431b35e2b8ef0faaa49d2f65331e77f842e81d0fee6f068ad315b04f2d97df74a1b6ffd1d34f97753b3a7430dd679572526d63e461566979fd8cc23f8adaba7e6d501bb3a96435610512e641bbc5958c3e13ff2cc9addff14f9633ecbaa45a49e4ce849745207b3c510bb43f0dc0bf058de39398c20ff7bb5e7ad2c7a5da70f665ce973f50a5ce9b88bfef5b2f09ba30b0855412b207cc3ca3ae7cf6cb65c8fa24a35e480725c1dea6b040d7d7365049973bb76c58e354c04922828193c1b21200b8246b987903e1dfe9a5ccb5d8088a0824ce890405004635a31a83f92bd23b40ed78381a4c71ac95fd2d28a52d8df240de6f66038e25593ace377248aa2177fe8d6e498bcd6ad4a674192644284a562e4d10e36a7316de938943e4679493bfee3e718b43094d929bfed21c76687d1a6b21e2c67728d68b2de04d2247cf16483afcc6d672f425d1f32b8aba0c23da01ad1b89aff9355df9b196e3dfcb49accb01cb2f6a19e4d1349b20a5d88c10201b40fa6d476643f1fa0536714c8e8ed343e20cae72615c3073f101ff6688a34d4069643fb56e2f1ef2e802d9200b8884404f4816e5d83a3bf7823ace1b788e8178f040959c83701483c68da7dd1a9b0141e41bc13b4fe22b0fd02517a748aaf00fc603265ce2e73881f0b0f0b67f7eb7c521f5978bb53cd67321bea03f6600433dc8e9dcb16fe2b5cec1ea1f2847c8ab6471e8e0327ec7aecd6f6b3ccac378d665fdadcb5a0cb061b4712105a8ee40f3b2714f8ff9e3ab6b6899d1cb4728bdb29c9a4f4fd3c4186747a6ae253494d13e1e93a667655fab7b72a2ed2907c8620c91ca71137886bb5d869ff1d796b42ca3c7869bbdc8a0a538e5f1c782b1df0f95033de9fe5076c6899d4075836b37f2c8c6eda66347ecb0e80e4d8788b5a23700a89592786083222b88076de7f89dcac1083964855fb9a53419ddf3f39e20a11c1a1911faffa4ad25bbd6bc2974872ce7da7f0a8d8443d82709d6c5724c149fc3f9e6760046731b3bf631abf240aa354526a4284ed96a92fb0702eb08723e5b3c198c8895a75d1c2682c0781f61b621be628a19316e6ef882bcf940cd96f8af7c55fe76f5ba03350be4964fbf4856ca198c61b9a5c8a96953703c77c76075816976184a3d0c5bfc79cbd4ccb0ebb1dd40f899f2f0334cf3c87e8f385b0fd3f3011a0923cbede8979f00068a931f94549dcc860ffc93ca289d2af135d2c05235974a1692c21b813eeefcc9f5db6352fc0a5dbe7a72be17c7d50c9e8e9fee8cdd3c25dfaa0722f969a1d2f306b61078554f6390550084a60f044b32ed285480497bc31f35ceeed7e3b4c214a24d49574c5154c93fd2e64fb6960e678660c851097093825669d0a87561ec825fc555e5e83084196f6e168c84b5067b76a15067c6dbbea3461cfd61b81e7425b291ef8a273ade5d8adfb53025ab2fc3cb0912f23d05e24726198b5e500806da286e27d19a528d1aaff7c1f911451ebaeef4284c4cf919d7035251799ae10ff553628baff80b27656b0a21e975199ea72208c3a2a2b6e7e6d2f4c8caf78fa2410c641b322888baa3503d22491d8690b96591e4688ea90161b542644d1055994582e51212209138ff491f25927ac9bd1b1ada53bfb93de4ca770c8a2931f8a3e9fb60063b69b7945483fe785748106922d57b37a211892a2ed4415f7ce4cc9018ea74162c2807c307b77d2e4b0668c61cb459b5d53430eb6d5f45ce88225c42f24835c886a0e3fe1d7f9518b4826b0c6141afccbccbf2c055b7562370488641359518254390ebd5ed5df521359f9fa3d133f12f257d27b1d5d250685e0f865e15e24beb64178cf30d3654d7a449e41afe6618f60693ad30237c8899622c646270806894d9685904394da98feb6350b9527f44a90fbc9b64755ad2abff190501b776f5902a90ea08fb6dc8a68ce33041501415cc56c96c5feea5cd6fc7f148b25d2e4f8adcfe75ca50bd3d0ed0cff56049e02af9e6ba595ae977a1d7863624a57839affd473f79873e47ad9e8f6152d5381cd9d48a237c7588fc0a3f873fb32d3c5909c350231ee7bc58eda14a608517ef0e6f032e7d3afda7ee84dfe217eea904f1aa8a3f83eaf008003aaf4a28f69ee263b1f3cf9671f727897397d4b701873e5c9e992056b58adb66154bf4429ee71438153855575f7ebe18f602cc1776437f7f9f6dde91dd7b01435b418e01d7fba9d7ecbf7f629e136585cb7760ee929d23657289f9de451b2d40ac481bcc333ff67a5882598458cc5522d4c4ba1f9839e74c77aa7b4b74daf304aa87a662a9bff1c6a894ac5c820ec466394424e1cf949cf1149cb12aedd07e3bdc127e784d778403e688810fe9edcaa2e678b6a9ed559f107e148d1363acf853a55568dee63ef3689166c8e215c46c1c9d40253909944b621dcad7f11865482fecf9fe243903c64550b0ac9ca5c0845fcc532a8c261f07be96f1129796e585cb92c776240100abd889e04bc356783107931946e43cc486c322a6a84674e3a8af59268ba1d1f86c232be7c76ce447b814dbd99bb2cb98115eb4fbafab95bb5736d3a5bb08319f7ac0be88dda696d59063136b3dae0ddb66031ff8305f3412e777d7e776319c0b39f1d6fae79a53f87e8939a3f2aed0cc2244a25a9f5bcd24350d036eda97a88d395fffd90fadbe3a31752f3700be451eed3edb26a28d2d812c03211603fb5e29694baaf9c8da872d4e44526795c0f764e9dd152515ac3b0ef9da43ac5663b8b8684835e410590e58b813b7ee5be2c08a1afa13b356b2d15510df91e9a3e9aa87bf345a9adbacd106bdcdb96a99061ffa9292a41f20df7f989f00e26d48e13fe9dd9f647dd01b22c29764839426e6252ffa46f52eb878590fb8692db36a310494bf2b06855da10990e954d89ba4341de17e5beacc97e983ed436cbe56c6b6898ea2200d3951912a9891f66f42a32b618bf0f0b362197f21493803b3a43c1c7851b5172c5a268cb1ff4d9da7d9e74006dc743c2856b44cf84ca6dcfb8ef9766592f6feccc5973fb9b19c52a8268f14419671cdda751576ab84ecf4593290ccfe9e07ce9ca896826de0e94ee9f663b33ad7afad949a47f1e64044ec0455d86bf86bb443d6d85749f269e1261f5ebb0889fc5009867ebfb29a986a86a2cb4d800b8aee4e4cb6f222820bac97f50dda389121eb6061c1f8d964910c4a83e7c4267ffd1e39e169030291fb45381184b10148539a02752f15f30a336755efd4ebe518e9dcc8cbfa313e544fe7ab2c7835bac7bc5bf7ea18fedd2ce2da21d6f242b049762aeccdb19ed17ca1a7a6db28924d5a4e246c6c0b1cb2047c4693939744d4df65e8e8458ecf26fba9594a9237a722ee36403a192297dc50152799ff64723a69fcddee9f977b13670bbec9e977f9630dd5d061f5a904e85a80299a5b3c7b0adcdb3b659ab567ffeb3b33fda9d552424cb075e13c5817e1c8bff18718076532a1b9982d4fe8006e07bff1f1e0a668d4ee8d87146635de3d0a166a4af0bcbfa652d0b4366e9a013081904aafbcb127ba113d8fb26d93127b7dd2d7f68951412fe9d7d896b40fe0132d13a2ce1a9db9357c851d01af83cf502f4dd27cdb27443588bf2a3c22771ad7b6dbef487ed4fc0879641cccc76e243f8e10081dc150f6a8025b0c2f8609f09568f27c0fcae11babcb91222226c647dc6c22bb672bf8888cfcd63e4ffb2d21611a8901b638683632023ef6dcb26304ca553bc40535e4aec91b70363ecf99d63174ffb698a08c99aa10968153d00db15b72029a46362b1bac9c04f6e52b8a7bdcaad8079f4f72c449c43c84088e2920dea3df13c474591bd287b68afccb35d68f026d19af7203b1de8011a2a0d89f12bd3b894fcda44cd829d694b246d45faf205734d234a5d8f3714f7053b053f3fa8f1c6997bdde1d61cfd45aabd2a4951c565870782aade8b836a6b7ca0799137a74b4810b127417b6efbd6d63a59c0bb729c0fc3fa09909e008534296c5c894247a4aa77c7b319ae1efbe16b223fd2f2ec3856c83786dd3388c17af197197d54b2ff9913e9a0b2ffc135ab120ebf65e02162dc979a222a49663afd6eff957a37ab5696a0b483da8acb96c9f1bac4627941aa22dedd0a1ddd6c124e16582cd9fcb89f2821cf0850dd7c90a8919d6b7cd16f22cfbf0a5798c384b2702f27046adac05f917bda3e5f9c3d769e2d4d13a47fcf7e3cb2caf2a4060dc421068080a686da5a131d70b65755ec3154e2779751b3903de492e962a31c227213de5bff4f780958fd33a313b6657d44b2a02196ae5a6854cefac1e56be97dde03f40a2f32774a98156774eeca2ac0946c32be7ef5f3a1403ed66427f4bf927d9c3217eae460bfa2a4cde31a21e8d1032c9aa2dce78a452d06d8f71714a56ed81a2e30ecfe82493651cb542b5bb7e10028f62cc2e8bcbcd338788e7e22cae6a9a85c423d0f58b9da820ad073b958f709163ec93ee2e96d4f7c87733f8d587b312c089a8013652e8a3b6203a97c4f6000f5d7de85aca3da6897d0bb8ce1be37fb7a5b8c30949ab7bcea4ab848db3617b4ba8fcfe6bf3fff41572575a24264f30f58750fb84ab8472e7bb493ae2f652e67bd7755819005330df4a3077dd6263338ab3076cd82ef73838b16bb47c8b7faf9d8a9bef2b925649a9c88cadbd2044e084fc99040ffc6c86afe4504356d66c8aa1c1a280d9501cb8846e6989d4acdb185644b3307ecf33874dcd130d1de1cbd88dc14e7e37e5ed295ae427cc69cd6e6667ba28288e7f56e4bf54c794bbd9aa1f180e548af9284f0af42c0d0164ee5c8ebe787444d0b17e49dddeb7e43df7803eaa2fad3566b4ea95fd9f8acfde6a14afe00f53a963603ae741177d65bd626bc2b447ed9cc6838805dfd9e065816030cb505d11217e2176ff160fb5cff882c50b5bc2a4507afffea5370c315915edfc518f7ac8082e80c68574db65a698c5c703e02c908395b8d9dd292fa64b2828c8619084c83a9543cd8f3d5874d077aace55df6fdb5d2e5b6ac27f3a2db961d3278b622a043c92cadb5cbe791d9886207fcfe36fbaac1f2d66df3974a93e7939ef5e4b359486daf11333f532cc283edeb74c536d4de21b0cb72f11d10ce90980a31be2aae6640ed15073aa332963bf2f31bf49f495ffd726d8bd94f03a44fec8a065ac3f1faa2cd6c512d8b55ba9ca24eb5d77db5265d3b7a47f30836347becbf0ae040e84fff3d2ce745948bd166ef12714da79eac7e2b219a97d1a7d998c1826d631c5481ff94ef2d01910d713f79433d77109649f762cd95744b7ec493207d0a833094b65088a38cde0c7c38cd7c0f68d30853adfb27392c4a9c10077d3e352cb3401d7841b73b3fc66e209482125fd55f495533b552c752ad28f0ade3ee8e549260b48eff58dd85147d794c31c0d2645130319901c4fe0b386bf6493b9e133682323f90254ca916f12cdadd157c88502151dbcefee12422a73d2aee39756dfadb2f247cb72f387a19ef1f493b0a2fbc885f2240281670101824f5056a4a7f8a59cc5dc1aacb608eb2f33bcf77d8484384965e33d2c9d9e879e7415d8dd2499a20b1ebfcc214feefd1d06eeecbf6f0e96a5bd679e39b534991a97a51bf19df309a46eea34b7ac823190adc690918ba233043f212d15fb493032ccdb52279af326546c624cb9c84bbf1d2fa06522f66120924f099b3937f8a9e38b13c028fe9473636040b356922d1d72325b46daaa8018a64cb6ba2194983aed06a78757fd706d5bfb512adb1484a359616d009e4224b7f27c655f34a333f24677bd2aaad5d24d13c81aa8d2fc148eb5c73c3ecf891e5f6ee43a79608cb706e4b0171a3aa6030585f33d02928a572eb4c6a4e1a731ae43f3403d298eac5b494ac5ab1b38a3e411186b02ef4eeef2a7b3e0a15b5849d49b27d766c76cc9073417b608584145a94dbad1da162146b43e710b0d08caf430994218d7e49e7f50f60ee20d534030ae585a7ddd8c67f62396772fbf70471c15b451e02f7ff5b7077d175696ff2a5ce90f9254804a58bffb2f5e4a02bbbd30c297c47da4c07e66fd398f97863449bbd019716a4fddfcceca80c10f1a9bceaa411d01149dc379438dac1231203baf3beece618247a3d71e88f22b36c145b02cd5754ae5c6abf1dbfe5ceb0297c76f3a6362cd3dc13128411fe4ac02da3dc767947f3a506f59b735ae2b2faa470bd9368405d983d7857e3420dba8634ad195559547ab658f6328bb3f2ef432238c6a7153ae1befbcd73d55652fbae5a80c0558af6119f3d69a32b54e9920b17e4319da32efe774613c7081c7042620f34db5e2275886d0895e25026f434909405de3d1d3de56a0408cd4b7220a8598ea8260b9b3a5d1a1dd2569ccabe3af6f50c9ba03323f7a5b20808c92d3947b3ca894bce807ce6b1752a5e955d48f12db429f24a8726a7a53d8d05d9665e9c309a585cf1c2c962cb726e9f80c913b058a05d04775f3f804143892e28c5fe9a2ddacacc6dcfd3ce49c42a396bd4079ff987af28461459d86782c2a931fea0cbc6de22d6c7730703330f8fbd1b537e210ff3ed82f00b79699c6069b838eb2ad2629cea2ebca2a5794c2b78333ce5e09a4c0424d6d5be1392c003252840333fcae6a98af5552015aecaf58804754c318cfb6196f5eb1d924afc4f07da701fd9a795984e1e51d39495831a7d4c5044d0cdc77891716802b96489b80333b3dccbf198701471f8e6a89a4038379d038d766b6869c1dc123df9220a5e6056d0f2a08e963e095b9556a6370fd7393933b859d3980f3f40b26d76aa5bc578a2517aaf08483fe82606be54c909df771acd593786345302de44db63b8f410a72b626779cdb98fea5481a068c3ad52d544d2d997b476b518290bf84b805072ed2701f433dd447a834ad3338fccc40090eeec331ecd8396f062c635961925696ffdf0cf5fda6bdb728ea774414d5560d074174534ad856efa2f84d85674340f4539357100dab12b464aef98c9854cf31b06bd9fa479a2352b3a8582ce644c4014ddd82c1c95fb2a1391ad1b00a37e1e1e25f9cd618c07dd65548a7918b84ddfdf442208bec16a3690fb928d46557e0d8ca901642087a81977a408b91a3a6be5eb0f3bf28a73b6233378ca624a64407f36eb1e77228d55b39bbef41adbdd4433553bfcb1d083d095ce0dabf78f6b52586e91b061cec3138471efbd9e6ef7d4c3b485521f53764a25dceaa4ac54df18e146bc8eb9e6e49c32721932d4bdc77dfc2942ffd2d05c964e070a525d92d4d1a100b8852fbaddcfe53b2e6233ab3cf305c3897ed087b7c57c4501c532b39fdda3cfd397df9646ab3c49d17163470ea1918c62db9797a0b6a6c165afa20f2a1363f3b7daccc8bc570d3457113f35e11d2174bb4ff21ff1e0f9ef9eaaf3da1cfd3acb8a043e3577fa75c8d74f9c6f81399c66381b03f5d83766f6e266b73a251b07837e676732367e6755242d983de3e44c5ac16ab645c30b36e4e659f15014a9430e9c066d91e2a87059e76573e229cd3f4b63a4f12902c4f531ec3a6cdca29d1c8a7f047fb1586d6f81f5424e86f406474a18bd9b4f6f616351fe2c65e0237dbb89780c6d2134473cdad75cd7cebd656fb9d72257765f6d97cf387af49480a1b6e8b5346d56479f536f8e20fc2e35d1d57bbd1ee3314313229ecda9864d8885de214f3d31cd856b7bd290750d535be964d4a10b3493dfc403d648a55894778c55c14d56e915e25aa19add547d49b99174f5a4de71aa1be0b838e38181caec1e3297686a3fafce5a758d96ba3fec8e8342ebd37c057dc416b17f7d545da08e4790fde78acffb99f8a9de4f1eef9bf437c45b194690d2db161066d90474ce612dc7a62765f8217d47e7524362e9bf34859ad94579837de9fc8bc749c949a1d6217a2370c1b720276c02669b46dd8810ef6d598048a0a330f6470320f85bf9e828791650b118e5a4083bd63d113fc54c463bd97ca26d536bce39420e0d8c0f085a3714b31031a78d8120fe0361f77082a7700a04d13adbd942f85aeeb8cf3abebae02dbcdf2b3b28389528d047428e32397dadb9aaaf2ea9ee89c3a3f10e43be3471ed05c7dd0aac394e7037df95864a3c108d9675ecf3a4213b897fc1f1eac35b8bdab9aab0af270fa321069b44b098d51b6a1560fb4cc4ffb9db9316b0e1478d01269302e9b7b42abfe7ecbf94169a3bfc5460bffb4e3fb4071dae7748fb92a0779c7e2735a3f2ee4503760bf266f2c027f9713dd20c8871bccf4ab2f40f14867f6aa64ae7b585b0673586548adfeb057d2b7c038f997204402b234f2eb8ecb2448278c1a0f4416780b77648bc017f7dd5aafb8903153d372f963fd128e75817237843bd805fef00c3fe9f10004cd1cc07fe46ddcf4b1aa5e4edf97e7f0e8d6c6d4baec3663d87d88633bfb166ab09544bd105a48e3e7bfd0be834661dbbbb7feed07f15739558242256e809b7bdea76cddc5334b1ac0c92362e345865ce1024614ee9ec4e7253354e9869298684b47912c0f694646fa73e3d93f80e149a9d76e72394c1f8f112ed56a31cf93fff34f63eb9ce5e81b8024e200b790481eba3e460538249736376997c337110ab48c460492256d90dbf64ab38070fdc373d6c677e367bcbbdba39bbc81d00539a5ad7520b41710c4e31060085c5453860ed6298f9cee6b11e294a660f654617c685ae042b6939d102c7c0a83eef7119401933ada4cead6ddc0dd74c0fd5a758a92fd36318132947dfd54800ff5f367494ddf9f5798fb8403564fe41faa57e34b652a1ce6b6a829965f56eb76f567e8607470dc02d38a0d3edeb1c2711d6990f1c4c72a7c373188ab68690f538f9615e6109a64fb50c0f2eed3452846a1b436d7c81519f8862b4b6d6f6c3e2db6d91dd6ca77285574629e28a54fa25103bee14c95cb39d556d928f6363fee232a98e1789d2573f930cfb8622c6ed349eb6abfa373cfe2f44dee86e73d200d0899ea671bcff1ea5766d9e62434b9b57532c58ad4f031fb221b6eedeb3a8a9c4a37a524a40c7e5e4eb28002bd7f5a6b37c1b2bda2474b219a2fe242907b9bad9f74e626fd27905aa24e1d1a65eb76142546963455158ea386cc7893d8cdeb6a4fd41519c1c8f3836f52bbbb2df77e7289dff297841dd5333166e4065440db657f4c3dcdc51786fd00053504f87898976a0af62d5af1681cd50d51e7fb602181f04f081245260c16b9b7d8223fdb53699378c9c0c9a2a04a60cff88e08ad98fc54056af9f9d9b2192f2f3757ebb33473d654d6f51bfcf7ed6e903ae15a873f269cf3268c6c531fc8905bd1b3876356f09bbd1ea7e6f171552a188950b904614c23dcfa9af5a79e287909c7b0e3a72025bb71781085257860b5746f8558fb137acc018ccf7211dc9e25a72f2df4babf65a7e33dbc6c4972fa32a11f22d4657c9d58078365c79b65ad1c62b51a4fdb7248562e60482da9b69fc71b4e406679cbdac3539d763438c97834f17cabada26bf9a30056eac4a1aacc9e5816b54c7d94d12b14777d44c832173baa39abaf5de2eb9b0be0aea5bacf1ff2c7e00e14e4738b3fc4283b5854e24c824f4a4ab873fb9d4d86e0ffeded27cbe8d738071bd77ce130314a56f0570a124876862d260112f85dff186d6d2bc109cb238eb43dae7ebe21bc489286744bf4057958f643e96219f4079ef0bff8b32e746f23feea1e5cab87cf74a628e9bc3c0de113d65a73662a4773caa587b30f99fda0932565d1915d02e8cac4e3c539769a14b78caa6b0c568e015ac32d657bc269de59c978a1a1d6abf3bc6ca6d75d3987bd216539fc08397b39a5ac04a0c9112ed2f560430ca8b40b4dbe21c197ba4eda80b54678afda60a12f9dfe9fc3183af43ab186e9f6b8ec2b3b2676ea86c39a39cc1681f88c9490b983410f6d86555512878bb20eac7bae45ae7fac60bc4be49271d5a7869a1dc7c224135055e4cc61ddc90ec7ebcd5ec490e7c87ad6f5fe87848f5db0667973df929098e764413a0c4fb1c612bdb9259a3a05cc5a97d0a59ac9ce0f8aae9bf371409a1e0e1d36776051137901f03e06f95cfd302a1645ff6495ab60c3f8c40260909115294d61ac4189b4863d15b8470f30e9a5a8c549951d2fd74de83a42de19f289ef2c7701b0dbbe8880fe2c521e8e74fce6bcdc56aa74288bc70149cde27e552e0f5796fa7d7ea762e75078a660ebc4795ae5beaba6216912a2215b0bf3bbff3c109809858b6f5bfeb3e216a684574e89e8a064ab04299a8b2776aa5a3f3255ae51353d1a73c604a8365dddcea149d704fa29e03119a3df7d8d5bfffe24144be692aba2990bfa8839423ebeb85baa311d92f1a40c8de63129aecba9d0dcd8ae4ca29bc2980809d3cf788816c3d97d7e5d30557a4153d53fe440f9d461fef86d31598ee5b6f620a8e1ea0c639803440e9ea5b79f65f0f0967843280bcb09fa4936fabaa13bf48266b098d53599c717c0a945d328fed183fd9aae1b5dd43cc34233da72c1d420a945e92ad3af2207053b0264122930d8d6d4b631082cdc6deeca4a48282009caea6ecc52105c50b6e9c10e1db7c86f5dae2a2f04013b352bc779ff2850b2a5befdab40fe47ca3680740fad1ed52f30631cb1596de42e418876ee524ad8b82cfcb6056c7b86886a2d7ea3862d42030f954e0fd470311978033c801b25dd1fd83f5dd67b4aa9ab35a8ef89e26b28973e24ab727d65c0ab5e19e53061f8dac7a9a779bad24f36a337ade790e83111b7ad1cb77ba3558d679504e82ee661fde189546d6317442e62dd8993646d9eebaaf91132b087fbaa329107b0668157e7350c8b92346a460746b4ed6f924f8af00f8942c296630fe4071752ccf92d14cbcbff374471cbeb71264c0df4fd4dec904020fcbc794d5d5988b9fa813d34ee76d552c2d1931ccab0ecf1b988563a8857809ee85e6713caa38989159c733e75a2d524a85d309e797c29d997c4f8a7f406c0fe9f9c768542cd67ae78a645bee0fe06a120662e0be8c07f7f659b4039ceefb9383024bfd20a1702d72fb330a4dc6572b22541a4490d5cd9954acf40ffd787234ed6e26ef026695017b8b832d518b5b0cdcb407a8c2ca40b334b2ed2f6583a5d904fd9e3b86f53a8f2f2b874a33c12027e6655b7faf670e47c833ccd424061efe5c727a1c50f0522bbfd864d09970f6e7f54be6cad161728afef43d3dac695b03ed2456afc454780425ce76c050d19f208a2d63e6a092c84eb0748f1d9047433d7826555e17672210244d88644132683c9bacf3f5b6308f40a53bbcf8b872a7b7a02abc305f35f2e41d79a155b30f54c1b0c482c8095e712ec2ab7a27cc4c3f6c9bd7d2f89093b87078b8747a2d47dcf24423fa17ecb416353ef6fc2ee9a943c78c8c7fb1873e3492dcfeb47b7b7a26a869d868e037ceffedfbdda223910672b23d619d5ba25654551a8b53036cd70223c87fc6ad48d779a955ef3530667d3cbe1ce5f38b221907deb377c6649fc22639965b1e1210b232d74c69d2220765b844005b3850a1112ed97e80497d3bdcea9bc8d83faa8e69998a8a2127c72350e716bd060bd95c1f19017a311282eaa683649c6ee772e7bac9cdee71e437d53d12ceb651f51b943acaab144cde3139a56b69eee312abeeeb218b8dde6ae196f56d480c15c8274e6c0874b9df65cd752dde76a0c4c5342752075382ea3790d8a306291999f620ebf9f637374d87f4a19780350db4e8a72c26a1dc4cf317441932819d25d75d8d98fc5ee7abde63ed5c382e95624f591493a90694871fea231f09c974909702c306e466b3f44643f00ccc65e2641eace84023eb58fe2571122bd227878bef1bbdc7b1a432876c2556dfd4d6519f4cfa4fc22e0e37abb3b0a18d75667bf39b4d6260961bab5d1347156f0a785c5734d320e5a6c5f8f155c5d4be4d498e0801fa3fe6997a298408de3efcacca153bb729b4c6b8868b54b214d2b1b38aa85ce52d84029ca572e7b19745d45e3cbf0f6bfcc6d8eb3531313983a96c3af658f37be30f2a196acd88cbbf469e3817938caed5e5a8fcd360901bfa2a969ee3d37414f402385cd0ac25d10b5ec55a2a632bbd9b703875696069acbb8ec586f4a26442fc4eeb3fe9c1e1d29e511dd58a63c0850dd3aa937bf6710bdbab6e5772c7c9e0d85b8ae4a14be1ca5259d6bc9c8bcb52646d28d6ecbae00b2e82da8fb88a84a32221eff4da4b3863e00ae22a6b52fdf6f94def5fa5fadd2aa292119a20ac4a6341c44a8f6dc1921dac1a1affb84e8ee82e4afa4655e25fb2218f4061ccd7cccc21a3eb6b1179673332b978fcc51f6b4c0b91cb9843e2c28c0a6ede71bf059c10b88ad1992749fe7248b4527f6bd09089e1eabcaf977b668334e25edc2c6a19481365f85734c0086d6f7581bdd2ea0060dc084c29d9d38b798dfcf87300053eee3e3d729c90f041e0b61198c7997c2d746f886ff73f8bd5e77c054ac24bd9830c94544d17b134b7fea9b09c2af79873eddd5004980f78d762b178e7b3a4956f7d0d3d137fb24f44dacd941ebb09c42c84829f26992a790da488bd585a7ac9301739694edd71776ea03f36be0601919d3dc0b7afab042a3555472c4286072fc7b6661be3ae07dc9eee5564e517a3d52e757b67afd4435dc17f573d7f80680296a6d0e460faf4b2fb23070a879438d65443a17ef4ee6573ccc1637c57070f5faaaf452d9aa0bde7dd00eefca075f2906b4011ba29f3d2a1fb82a07f3ea3195b4eb1015000c3ab74d34ffd59c05452bd1ff7311671ac6d2507a9323f1457d9abb9112aa17f4897edd6bfd4052bbe158cf408fff207b1b6b2be5e642ec06ff5c90e621427bc7b1b4b08a0cc33f6286f4b671ff4892a338f5e3eab0bcab1246b4e629bf8376b65982b2f44c05700d5ac1d601d852dea0d542b0ee0c3f6bc6d9d5be486ddb82e5b90ebbb04813df2dda8e023d65f20404ba09b40b907347b51e7eb1e0aae7f6015019c821549bf072f9a4956b91b5cdf4e317fff742f44fdda2a5e2705995c3c14d4e6d10871f4bb1c17797b027388d5e906bb3651273ac8835d564a782771c5fc4feb719a1c45eee4680ade34e91ac27fd255a5b6bb92d91e850153736756829c58af5e5f2e67ecc32d564e1f3230b0467e912d958e8da5c8bbc167f903b4c1108a71d2f2910d86c24106c218b0b609fd74f7ce8b3f9ceb553fbf959fa031dae28513636f29e00c73eb613f360a0e413b7a1d7c8148426e364550d45c99103b2a77083ed4275713fecb49ce370bb0d6551b7a84adc5baeffcb5dd062335d2c7cd061d6a1dd7a499b2a6a3971bab863e7e170b03267c6357198a3bb8063067211e4ba80d6aea322a4e31cb8220042002d6abd8a275da34cf4cb16cce6f9c54708dba212756973116e57123e95e035ec0914497e979718b9761196bd47b4078a0cb3ea9abd4ce484e659f992e013aa1b938edcad03488ea45e3d9aa77074383551a9c88e9d82aaf3b5c7eb04e96fd7b9587bf49e36b505e49eb2eaf35c5952b32428f3ad6a4d97f64647808c59e8fc1ffbe00fb667efb8baec9f611f5a6e2c74cf09840a1697ac2be11e95ef059ba1f6e25584b1daa4fce94727f1af835a6d4abc811b89685bab5d769b0f6dc7a5ef65bcb354bd9967b07975ef47b7304718343fae8d847e5102018aa964765d36b033354a1853447df2bce4b1bf2621dd91bac783ceda90c0bdab2f51650f35a026dec3b4618b654d0220d625dd761678261a28805b8b62d4a7bd1362a825c757fd98905a9904b893c05cd17efe6e49ed1ac519749c8b6cd3be92600b5664c56fa62602c60a114e37a88d590f77d842028324d20154c178399734fbc2fd6ffa973fef8e444a6809d7b8e8a5165a92ea12fbc675b517adc27679e4461e095307bc3887636e9db916f1ff5b8b930be150b94c17fd0c5e0896188be3df81ddf13494d12b997e8200ad8ec44d7013eab710655f21f612e06f8ef41ae517135f4290eef1bf3bd629aa4ce886ea916252a2dfc5b27a8c38e9ee7440a3ac51506f6599949aaacc32454225018324b1a20b3dbd52a0550cf26b0df3a803e4f9e56d8d8094d419318798410e6af78e6ed4d5aa13906fe149e4b16bf0cd299eecc690d102482f24f45f85e294cb754aa19c8576fe95dc5d630c298364c6358b2c9109c48257c5410965d08b6c1ede16a3a1c4b101a70a4674aa16c3b82e7ff606974294ec2b8cea8c4ed4a12669689f31bfcfa6138d8651127d983e08b608e20a75dda7927715bd6c749058182a27ea250d2dcc7e987d0800bd4f41012da2d669b3f4a0605ea68facad54ce1f5f10e3e194eebf0eb305a34003dd5beb38813c90957e2c20d430f84fc46d77e6edd90ece442da3eaf6a322cc036da2e02239f1364bdf1aff3b9e6ee477c6705e42e84a42115bd5192d24dfc4dc6987d72a388c576bf0faee3e4045c5e78d04694e3e79e57e8e1ec92f21c4436780d5bea9dfb71e9ddea94f36302801e5eebc22990eb254ad63772127d727b11bcb7e2141752a9a99886920fe6a70e05627c8f99a543f53df4467021a30bcbda4818a5fde68f2c39b06e2e427b6f9df7c27de825adb530e3cc10b702c77d8f2464978003d491e4e39e0710500dca4e43afab898fcdda47322b5d9b398d0a98a5017587a350824ce170b9bbd62dfa11b7400e1295bede9faf902eb3a46ac736459807c53ac3564e639eb7536fd49f6ed4a65eaea8fce866b9f8d653003d6d174ec0b745a62e1737a4ed2c09bb419c8fa8ce72b718cefb896416f8f2091d53bf80b12598040b2f75c116d4659bb4b445df4b36834c7410ea27272d81f8e4cd807d2dc97c95267aea4e9c59bc6ea70ce843e3d4f5872ee2029e34279592861f2d75749da218fed3380ccfe896188f5961faa86de34f7a4be91f62d5f2eb460acd1203cdd2b15e6cb92d8554f6957e6b6100f9d91bd8b06dd426e0d9f9adf0da778d576c7c0ced677c69204c0ca860d3b59f00bb87c071b5e3ab05ec760e5aaf6dbb7de1e6855f8deb009bbaf46676a4a0ed2d81913cc20906c6f63e89c4f71616846aa8d872dc212b5951bb42f0bc02ab8800c1b0847d0ede4989ca14f32ce07569e4d43513eab7f2864557f44ef43357307ecf0c5ac530d3621971ea84e54a12230246264359bce1beb517c7fc440e70f401ce6a5d7c14a9e39a34164245d396c44e930c4ff5d368e34a3a6905a049e13fc724145f523facb4f518fd8ef25eee3918415d71378c0d4ca6d6ea30d5cee1c9f46be0cf82c932b5420b338f90c66652287c1a0a78bd68dbc42ab6f81c0a292351b2e497e701359522c845df108ef7f68a2ae09f38874406b1613ab2615586d7d79e784d59cec3b019b20e4f3557fdcd215001a383bc145752dabd173ba9fdc71b3fa6d83ab06d2832e1c8955c0523cf772bfdfe6158298c4846dfd200fcb1d3c87d138b3a41d905171f4e098ed815adca4b6a490db986f95079e2d9a2a90e83f8ac78c5df5c70e795f7a1fd9909148332530b31e23b4cbc9422d33fbe4a4040033a7c3520dc36c21197add0cec06f413fa765f2358d3f623eb9518408c401e109bcfbbde61ee93edcf05b2edb1f01a61584e169a5fd2229849b6ba70e2f57c136765c2c5687778d255c1e62cf0392339e65c8e99c82affd0ac4fc46cc6eb49ad6dec06723cc205a08dbc22ae71b61d9e72bd70bd01c4dd4ccde9a8dfc11c7f4bf22f75d8205bb1aa87f81184bbad92c75bd860baea1c474313cb6ea3938b862e0351df8b148969e5845d26b233f7ed21bdd4a6a168c4eabe7c634988ed5d3553d19056f88fba1941e52f0f68f7636230463b3116ee04609b682e66562538302dd8b0577b077b5bfc55def356d7a3389ef71562f0f5370b98b4b65a8c04addc5eb5dee2d611c2de16b15d8a4c85870f11d194ee2ba2c238bfb580030110173fd0b440aa047f04614f1e960a3f0e0bc9ace0f6415c280e5ed5ea20d1192243fe8a5ca5e7a5bc5aa6e4432f8a1e083d20f0b16d94a4470d5c6ccbad1e8559568632f7165cdff2f17d50a9c457d38804e343c05a0b78ac584ff1aea941b1c8e1846590e5294bb85a6769428327789805f8bbfe14ca0560d67fff5cbc9b276a5756b8aa599a435fc6962078b0a578d357413799749060b8691c7e856c118e4c1cc15f3c2c7987ad54e5e4b3f62e392263b8a885aa806187d5cff96355cdacc520f00f7c1d95dc864b4785ef3573d6932d20ced9da4b378980fb8f8b1191fe37f1f7e6ee6f298d2757e6a81594d993055ca948a0d65bcd4109796faeb3a3582f8d90f201465a68e9fce8be06379fe245a5657e90107f6502a796d38477703a03127c5b4ce8bc68268ee3b2ae79b2252e8186ccdf7474db77d6b8befbfdd46411856708185e0391dd4d6d42f5e59fb84dd3c8e820ca14fe256b5cb538025714810f1e3b5fbe379ccc194952f6a9cbda9ff861cb6ae144b5d43728a93cfd0e922ed75e98c503143407d431afc03082cafd0f03633765799fc20982c72850b3568141026b58b81783ac643034c2a3bdb1b4b4cc90d87dce3cf7f95b9e514f603083e5cb1e6b9ed10346dda5bc5fb3362aedff7b238eeffc72bfb17d4292bb91b906a642f1cbe94cf94840cb874fe91aff0a6a822ad15f163d2e7eb25136312811996660cf440c343cb7ac4fb31d3d7be1c05ea9833db0fed52d18dbe7b1572859e68224e529d02986fc09a3d528ba6fc83eb2676cdec2f2ed81fc7ddb87678a534feb47468b8cc705507c78c00bac6dad58b2a94692aca2c7eb84fc1d92098bf12551a5e86c1dd3b5d73e3ea0fbd8f9ec658d91bdcd0a859a89b4eca59fc3bbd6dc37c15d1c7d90971aa0c48760b464b3aa4ca81d767e8bc7656d28fd6f8161b59ea3972f3eed902bb9d4003d8aded42edfc31394708115c1cdbdbee7bcc6702630b1d0b39000e7171ad8d99e55fb6418e72956666cf153cfd3e009f2f496c4d09e52ffd76014a53e8368521c6b0235746144b97f17c75ea8002f56f7ada8301aa0556c7eaa8ca82ee4bc5277cb07ba3a8b6355cbbab8fc5c917aac8aa54119f247288365a8a3766458210ae2588cfe3c640d09bfa9c8b0cbbcbe14e3b7b192b49d45c87549ec862932681c97f92df44ce94cb0eb4099400deb1f0ce389e09236de6b57293247907c30bb5be575fabcb5b48816bff65d2b61b86a5f646c447d2ae421c89ce6fea19f881464bfb75193482e4e89ce4d15afd95c2e28879976a632eb99b655d61c89dd181f5348bc0d671c00bbacfa521eb165c82a1c9711534484bc26e25b68a9d181f3327b1fdd59edabb2e619bdc22b01d9fd3c13ef57eb8ca4a524589ae42d183da3059e83e44b4c86aeb9c26d8eb9dc29063658e1b6d541cb28f26c1352a6d22f2e6c72476c209f8ba1774fc95d66d3cbb2b312b4f1a9158a37b4324ea04d0df8787365be9bb2afb9f502791567eb6aa22fff19f69f5d792da4b648e6814cdbead20ccd298cb0c68451f80785c91516d4779b66be53a9a2f6f27045565e539cee98251e59d3de78d1c05a4d897b1c63f8091d3a338d7983a35b4ca75df19da4073302cd31fa03976a38452da3cdf9cb980935c8a425d4fa39cdfc9d6b3a077aa34c911f751db3ce9b088fdea082b7681dc91b538cd1e5fd561e4958cc7a4bb54a9035aa3753cf0bcf5c00190b4b294e54467cee4af04bfb42ef8632b32df67036119474bc27c24fa5596c84013a27475c1a98c15183a78b2498b2efe8f774b8fe465c64e381905062af83b29b8c4ed37c47d210a4fdf0e6d053ae9b91c520506bd3fbe46e56de6a791126680d862fd3cea8ee16d9897a9c45a59bc854116d304e5f06420be6fcba0221b11e6917725e7f494a6f0ba9a24e3905ccf43159177e0217abfbc0a21a24ac5dce1512fac7fdbb6763ce5e009b651177e8909b0d9ff1cbd476656280f5c18e0d10e634c069c905e034d2a936e330ad803c0bc054af33902b9569fe81c1a7f074a1f7e8237212e4d8bd465ac5b3c295ab22983515ba413c8b3487f6ba161cdc1346c77d2f8ce0e20cb36fa89153a72c5d28700891c89c28e2d1faf118f7ad072aef8604617bdec6324391ca1e7246bdb20c5038928a879b7cdb80105003ef67080a26b44bf809fb12c06fb741d5ffa7adc1ab65fd3377cfea232d10c15a7be7b1798d4f3fc476227e07bd09a5971a3538b51b94fd6709a3932ee9bc4e9ca4d96aa361c3931c58d06b273e1c87a78b9f7bece4257df1a61bc9090f530a926ef368b97bb5715ce88c5e8b3811ca3e3fd55669a1ca0f609302127fd4c06073d0f7147010fc7e17853c4ba6abe6f6e5e473c7b44dc467202f0448ee25e32fe7a89d6db38e64b9db288054401518e986fd1b28bc1d1f5763641aed9aa5e1deb10246201278ecd38f52d72571f9d148fe27fbc05fa3dd95188cb26a13966e6a82be25216b230ffd62ec56f5188d2d9004b4ba359679492a77aeb821340275c0c563e4b890b7603b194120a70be98427ac53e781d5227ff5c3f1286f16d74888249ebf444f34ccfc2a1494f46c454962956c98a65a81adb7646119bdf555201abc9ebc8a832ea3fa71a2fb44a4f8dae64b92753bf1c68787741b88db63560b8e3c8d4f9e214833f331ae9cf6dbfd1296c1c424ac30ced604fd22aef192d7e8802bcb612ef6739351750eaa31faee46827edfd9f819836b45c6586ae0c657ed972e74133bf0097cbd5568a5422b1c435853b527db9f254eac670505dcabf4c51a3e405dfca5393044adc7ae8d6fa3ce12cc1b0de8277a79230ecd9624a40a84cb3108aab4d0efb7621b45307f545e1b771391da4c4bf7d0f513fdf1aec1878c8f8f9d3c1c9be713389b9926b75c2bd2b2a039abcc3d8acbc104a3dadafae499c819786b4c4fb613492f1046475276a8393b6fb703d7b2f608602ac945eac5b9887cabc320dad959c626f1dfd71338252119fe89402efe2399d8f5669dcc58943cc5f8646bce354c54da08a676b694ac0cff540991f4002f4afb296e66766b64f43b8bcbd6c840e9c6638ebce4403249c8212e2db8f3e6d08683b588ffe2426a4fd99ebb8dbab411bf2157d3396c0e821575daa796a3ff1c6692d4aca0552c91da15a6cb139d0f777d9d11364d09a02b8917639c2729e3e3bee101b066e7c7c9c9f5e13747af08d4aa3da7ff706affb41a7e1458483c643308ff4606ca774ad9a27d15a4c536dfce803d48f471a24632c43c372dbc4635549ce60c2210cc98011c0ddf72dfaed61ea8056c6c58ebe69c719b014fa39e539ac53912c51c0b22c2d7d85c62bf77979e3403179da415c48b0c1079392f6a8cd72766709d39e30ca4e06819e75c8d9a67e024dd1684818d6a5b59ca63474139caaf03c558d662fc68313a7f051701b83bb9a5a9c7869c254d40b364623f33254372af38b92b7767f067af2320cb45faea9afbfe367fb7ca92f84f95a7343d9179e3aac4021492b844f2e59d749455c4af25cb55ce7175d3ec0a1b585e2b9a473d5e17064e29c654f3613600393da8be7a1a4540b9a2a6366a80a92fb01d91ce48a53fe338c9decba6ef184e12f78ccb7cc55134e0269c1be5eba4c0570bbf50db443a93c0933b7059551225526ec653672bbc504da71e35d846b4451db526c4868f3e3b52c4ab4322c056873043456f9b2670db0e16ce32ed6cb993ed7d71d43558fc94741c112dae897cd3864bd0db8907da2fb541747401f320606a34149c2df89067715572a586a73ca4170ce779f791bc601244a2a4c5ebad73c683c2d33ab7ed76b58c7a705c0ebd0616d81e59a9344d659c0b8ded0b0a3b4a449c3578c03ec153233cee268979b47cdcc4ef789f07f6cb0d8b334b0cba599bbaad8bed649b8af0f04dfdb7b58074d2ff19c6f3f286858eb58607f5293a52f54f4059777c85389a0617b17661838b1a6a199072e65f01462e96679a4b7ab1f0a0199b4c4df8907cf20ddbb6c6c63303cbd831c8861128fd819404144860168853d3a0597597740751ea0b003ea56c65aabd51ba2d9d36fe075640269e631d08da37b9bda9361ff96ca0369a68802c5b9bbfb9e4c6c5316b3faf7e57ad297ca8549c22141b7a76505ac8a85229f2a376b4f132cfced45635bf5f07a59d64847cb60b17bd41d3b6092270cafdf9dd5b325463f1e5904920ac26b511adf6d13310a65b9b4e0fb5c4996f84ee532cab5fcba94aa38f77415808857f7b56513cc01f3271a7ac17ac612ff1276c671d5a361279e3759e3463cae34b5de0795f13680749d5ae16227fe4f9c371655f0acab5a0555da0773ea350562575f5e594660f4cf62bd6b08b5cafc6b21a253421406467bd290e58b2e8992adc697237b2e693107e85b074538c0cea6ed2990c60f6d7b365cfe053bb148af5d662c0e2a610285945d00d9ec9891cf00195689e2ef05221e10ee4f5b896732de21c586c5d923265c8d3c37543f024110664eb9798335f6d4437537d01a97c949d943903f3f36597bfa08369f097dc02c94fd1a5f7040460d9be372f0a0a55618c0f601edf7fefa3b64dc1bdc97c82c941db804d2391605f941e51ade0fe9f118ac80e8a535037135a2832da03aa91ce321c8bd2c0f66eac3367e62dda7887799141b37f309ff44d104b9c28c12d0a6f3d4b61e78b23e044061f7dc2ba4f1e3e6e6ac844c7905467d6b0eff1ef1832b428c5a857563e6df569b4d43464c280dccbb4e2f7bba0e033914007672fb7c96747e60c157f9676e0d6233953133696e7c51f86042e442224967d87fd8691d802c59e6ccfb6dfeb1a9cb940a5f2250a6e5b9181347c374d67690f39187c9aeefeb78ecd3fca0394eaf3da41c87636fc64395652976658c1adeec50db6d3e97d9f4d8b8974483b3772bed4252590ba8c40eb6eb526667bda38f80d746cba152e8142acfb44ef9554299376bfa6b7c7945086d91bc27948d7b5df8532c08dd451c1f4c7eb696315c734b97eb43e9fcb24c36f26f8ec149c18bcc2df43ba296f6ab28be14ba7310baf421f10e04278dff42c62f0367678ba7715f57cbad0f295fa4448f0fbea182846c84ba19e9e865557c9cc105e5e27fa00508d87d8eed016aa8abe4f45ca3f71517db072e68ddade6ba485c1915bb0785a38b4ec80e4c574d6713b16953dae82a27cface8a952e6375666561a64ef1b28751badf2865fb9f0c8c53349a2722610ba6f3dbb313bcca5c32469df2b3dd80ba96cd0e98a89531a2ab9095af7088ae095983f928bfe7d48ae393bbfe4c7b275318678705e1137410439d75051663c49f729e894ba86e5cc5d36dca5b9df386ac4d68a0c621c6b81b159026d4ba4afc99e3f13abefe57fa86b0009c6ac226fe15349a77618e9468e39de8d3c8cfac5c27997a017ce10cedac4a66b6e3f3b8e05865ebd4ee2559e1a0d588a3f6b027ed655a0013d6b92b83da793dabef4e6c9951ca9251f873b1ac4ff75e8e971424a70b01d68136aa0cbe8a1c0a35d72382076af31113ab038384d6d1fcba43cdc71a9df49d37502605cae1f2d40cabd5f4baf807f22dd6d49d974a57e25db56ca642f726dbbcbdd894f4ad635ab270017a12225b46743f39b92ba04533d31db16abd4bd813bfead99617f6471a468ad3df1f9d4feb4d456a72a4fc1fd5f028fe9ba4edaf8b5f14e4c3e3f64cbaf2cdca315ff3e3381f7da74a1938b59c60be4882959af0f9eaa2408dc2a200ede19ac6ddde1ac44a2b93802bd85ae35d080b9e0aa6edb0c9aeda2927737a49a2791b28ead1d6c2c8e02d2e547c1ececcf956d1100781ed0a5d1b14a8f5bdf89d0e6e4a6d9c29ea56222b3ca78ae3fb91d17ec0051a9c3d21f1ff61adc90ef4aaf75b3ce3168a239f46724dfb1396a2514c5f5d9bb59cafc36908136ebbde13412139a01beb06fd23647317106273202ffcffbfd1952b106bd4da1b626f0039c1214bd1447f55e4a8707b8bc8c1ad3995e6d0fade0251778046c248d6b4f182c39f781e3d8f70d90a3130da30c939d24479d098d94a3df9a514125080dc38666d9cd12480da0d5638e7a1997ed72fd1b31e0b7d5a3bfc019a395e661223ed0b22f376346d5a01794b350a176611497b97537c00bc39de12e65d2a83cd00e2f8a0e9acd4fbdaa883fb8b8e53449b090e1a56737a0abe1028a4f931e64881bd78482285bf2728a6cc71c417119e83c5c3bc22ac1c6dd0f53c1418f9b27dc24084a6152b8ba69a05b773e6ca603bfe1f9b40cad5fccd523d166db81ffddb0a98734fa507169832df03102fa72fba69588ecf6922388573a5a4a62e988c7b9c65599254dd0609807bfeceb6b6b2d4787dbc5c67486cf5871e1d09d8022c5b701481524eaafd5a734d771da7d014897d2f7c0fc4c2dd96c4d97895973b846601337c5f4d368d611f3a03536a06e69631bbbbe7999840c77e39a02d1c07506aee743a5311c739aad7bbe9cdd55802b21d9e5239c255a85bcdbcd83d1a5fb622edabe2f747e12cf3a162ae9aaf718095137b6b65eebddc1c8140732a90c67168720a12380bb78f2b59ef7d0d9dfe855b7d903b18b121af27375cc5b07253fbd91637924e67d56df80276445d54dc93a7067015526d00101f22e9fe1da0221cb907e741259149b962ed6967a4a387c903db0d23aa57b52f75fe72150c798025c73bf1f04ded7d1950ff2d7eef98d4410e9186db86dcf40f0b08a95f5a2a38c4d8d47340add4240a59a712104e087d02a12f0002f6c61efeb4646388ddd3f91582fb987c0f6a0ab6d115b5e3b37c16afcce6a23b6f24e294feeee66120b6711e73707057ab59b708bb82f32d8b9cd18755d3a254de4cfd247927cec284a5ad335b18996ec2d233c5afc278d5b0a2e24e1c8347f234435147149c2bb2f9c5e608b31536935ef5c225b39d8d785699c1bf58ea3d786a0b74d7bdba5e6c7384bd526fdc4742dcb390ebc7654d79b5c114ce03e243509dacf4d63ec24ea21b09aec31e7bf109846ecca0001f5b49dded8dde7edcbf535986253d2ad1ffa32f70bd44e8e8a82febbdd1fd09525108ffa0347038f83ba8adee1bf56e691421ab1f04eab6bdf51d55d244c898eec8981cb2aa3f4061398c9b803650b14d34a18f9c3d3b14d0d9ad487e633c9ade2c3d6a2ea450c847b01eeee6376130c1917a5ec80b0731b9089a54b8f95f6079361311da7186e64cf6e64fefafa588c8af8e36990fb48d7312df647c338b1d7306f6d6d5febf820cc7753f7ac5a40bfb5c8129da728704a5a431c68ab67f8eda1417b194ae9ab40e42aed9a0b92a87c155ec6eb156f5d28cad2ba0a6417fc8d386c3c2d00768f5e7e040e9468b28e148e01ea48e8cdf5d4ef3503ca0f312635c203a9e6c8877ea2904d2352f7093f4198800dd09c3ff37f2525b3e5ac16da4de7a90eee8d765f3f8672312e4501a016052a6470a1d4619af17a8e16055dd21342a56841108545d7c12725e564316b27b962ad37ee5c317ffb2bbbf37ae3ef7601515ab46afeb4d6035e8eae940b496c2e52d25fbb837613832d81420b5a29935779d2e10a38e0159da469a7577ad27ee853086c5da85d0b9e2df287c8847f4c14ef629e8d102c2871f4c6039878767aafde322788de6a142935e90b001b606694c87b134bd5265967533327e13c8dbe93872ca13f8b0117f80a2ddc25eaf12cd9c647ac511947fb7cd19fa1781a72f84cdd45c1a96977b61f7c5b6a9d1b7a0c45fec38e3ba909b9a4fe47155131761fefd55e05519680b333f5876e80a3a52f14a82adcb953754d0de2969f46872fbf8377384843a90f39e178dd1aa6a27b11e0887f2ee6833671563e546608afb3bc2e98d3f39445db1df1fa52e23cfa8033261550f183f77b1a94e9d599542ddfbf49f383764094dca081c1e2a383f088c2fb34948e4c221a92d08da3699cacfaa609b0de87445ac367664bcc42a570380f002f8d837732743c2cc729c4a832f2743f3e72b29dc0df5133f37bd6542edc5d0166ecd31daa7e2a129b004e2af4bb9e80d51b82fd48e6a55451582951b50ece218bd9beb95dae04b9d517cc78f65499d8043b586d6308673cdb9843586133dc838f549904130340736e39e3c584609aba766c6cfe5deafefc5c738eea25739067d82435c6c0c0452e0bbca57407995d7ce47f988aa6490b396fcb9df8bd4088d7990aabb86b477918d7c13784cc0627efe2435504b2a3f1ed0a8300ec9a9199f9a54942bcb56fd34f3ef2ac6febf95a862c25af4365d44b4f628273a7045e60e80222e21266fe126e52f962ab13313a573ff071568d9d5bed6e6012aa15c25c4a167d46dca8cc61d48186909aadc66221d26579018d0643eaeaab51a11edae7368991c6086c1f07a1d916072398b384f419364c3b4b2d05255f1d73ff4fbeb7bc247cc804770fb7693526e29e58312238c6e900975bb028302ac341b0be329cb844a5e2604fd403f3088d35124f222030f05b64f1f06c9a9dd010e0f6161f050d1ba05ab44d55ceab7e8edc39af47c8dd7a815443873a82577da8e8f072b4df27783c550bfdaa0354ec94bd1985499120ec72185b3ca723e116a3efb7bc28a39846bd12564e273e536351dc8b8856ca4a3ffd044d8493a90cb2e0af48e5604cd01a3b67dafd198f6de310465eb903123fbcfc441448b3a80e9e7ca96cdf89e96418db30eb8f5fd6050d2f17c84fcb9b47b3ac8c8f8651709ebacd77329eef102c4433207ef699a62cd7fca996d3fcab6ae42ba80ff0e42928e167761f26f9e4a8b67549ddd3f6c1877df01fd6af601c54034b3f6745843285b65499ad96213be7284b88500797aeccbb7cc6f905ba878f16508284930465753eea08490dbceed5f175aa200679e824fcb255460701eb1c3521c40f642ffc27e5af29140cfa9165b1749ff3b69162018e27e69dab3c8fd6551126f2aaee4562b773c6bf686c9aecea0b1e86ab88847effc274f863eff1cfc46b87779d6fef12a25c098cd4ffc331eba3261091b40cd03915e5d4476fc231182ee09b9526ec1bbb4ec9e6c01ec78fe04d9dce77768f4468502e6afa5d544d69603fcd55d3f821357edd031fb6579c9e1e8456b8ce704dcc630fd3085a44dc001856748a8f733331d5702192dc82ec0d7506d9ea1ef9df85c63bf4981d83117610eb42a411597e45f5d5728d52da557b8edb47dfb6741cb37126e4144b67df82e0b8dc4e6b57b9dd7d78943b09ef0c62f3cee7fbeff5d9bd4059a85ed3b99366f266afc7f272ccf848fe201243937e89041a1f42d6eb176bc2d02d1e63101f6c93efc2b3eb819e06850d717ebffa5307f7b0087d04cfd1c517ae33dc861419522b59baf9faee5d77ea876eab1bbdf336b482fc197b32441b64ab9c799e8ef7db6d6ef5dbb0f35be142e263bd415a8a62540c41b943471a4faa3abac4b604dd28874c4a4e87e52c1ffe4eab43e947bce2e2647de8f1c73590a3af6a9b03561b9814ceb1e5c790dbd182312d13680914dcf4ccf271ea0854963dcaf114813166e91ea80633c7b0dbc38dce4e9b0c0739d19d2a8917054ab0d9139dab0ed608057df70827c2d175bfd5ab3a9b222755964566cbeca0b2119d9ed2b51090e9da22153f77cb06f54bf6c35df90e01a010029d24c9cb968b0d3e088a90eb8238f31c02eba1ed8074ff663e54d020a2e515dc628b6d20b217d5ecaa66fcb969c31b10d50f2fc84bb779fe4e5d86f79924da55e209a041a6d9607826940a1567b117bc09af1fa386829105282902288041f8b5226113c3a45529081b582555b6c03e91f3d9e959fbad8437659a3d22e462f02f2662deab10bb9e1261fc3f672d246aa50fc62a66205ace2365091089eb815bb7de7c2e2cea8671fde6d4ebf1a1e46771e042e940ed40d1649979a8401705fa699bbc1c043df446b0763398fca2d6db8b5e29f9db2dfd3a183c7a077570bb09e986862d38b3878498186bf54d00a15d3551367b9208158832c55d6228b77f08c3983fc839847097f46d063b7c1a09799433314ec145cd201bc7fe3949c1730afe92b79f1bd784b849a2624c361667aa3aee94db809c62603ac73f0688a6e4f283e5bfeead52a4dcba9cf6c2ffa1a93d14f17ce6542842a4cd92e27af0f0e2e80dc0d2f296eceeefe5175ea8696e504e2ecf602e4a05c0bacd1564352945387c7a74ba683e0c4d0508a089e696fc8a8f02410db445e871ace60f1b098a8993fe6e66112ebb9fba62338429782350068f0ab6a1d2e05b2ed9c6975daf7055181fff8c88ff84be9f833dc23251692a7c961d682b531678dedc7848c37683070e81b1af9f85b96a6eb99930809d6f0c82a394fa604409a22dc119148bf68b3509b08f2cc17f1f66c20dd3cea271ea4a3870a2fd567085be923e54843770d947ad7895b7a882dbf4faa3304ec4982341586ca01214fa2546a1e45965344a64431f0ffd51743eb0f95c147179139a26aae23d035f2ee5a1adf70983c6f4d02e047d98994f846a537e28bc1f68b9fdbe4dd1d5c06d87909225324bc89d2ba3801159f42efcf968e17ba014ade4103dd20c28c981b6154fcbda415f42b0206d94caae4fbc23927b5f26e873edf428af781415f218425cdf50625aa234312f05c767e2691326a784b5802cc6dd0d73134f0e1ae3c3eacbfd93bbe8919f97192c68bc4f0a973a2993e9a0257ba4b758b06bc484dd1755edf3f9a5a19de2074d527c45263da2a60668176c0ac2407234ad58a56f0a54ef4dda1cc93597d0af25d678e07b578561fa9839c6b28c6bf791351d57f227d4d8a73dedcb11c39a56983f3cbdaeb0fd1355f3ebd03c8f88a7a779973123bc65d61514b9abf4ac53a786613677755ca2c6c43b402423bb315cee7ea3b8a723c756f7a29cfb95e8e9464511e3a8d7e654e72b4cba748d6adbae0645b5280dca7967ff9aa08f962bd7b3a2aa5ee82deac51d45c963c1ad5860c5bcdd706296a9709f0024642cd8b73ceecc9d24549debfb669e235bf5da0f20c873de804af56f7c103a578b22118e88bb9eb1ca79eafc719b581b762df813e9222582371dcf14ea3b5f9823538f7043a8740c1014f85d87f926f3b8828d5348ac8a27321a046cc5361d50241c2e655e7b4a58eec4cd5f3f11720f1521d87862a5cc98183a8ef2a361dfc41666314d4aba07c560190285ef52dd2dcb5fc4281905b206dd9a565863f8bf5625e0b11b3635b94b5a2dcde27ff04e4722f24115c40e6797ed12ad774a2f28719de509a787c96d7ae89bc477104d114a9e9a8a3fe0e0f7753af2b2ad4ed9a39452d50133fc5b25ce1890e6ffdf79480440723a259045cadefcb7853edc46a61fa9c4d1323cd0250687cd9cc4a51f282884d48452f096f84e8bfc21fb4c5cd7403399a552b3eeee3e619812caf267253e1c6147308ae8e12bdf45d554453b72ad6ad6a43ecafcfa70caf6b8641b2ebd3672b2c5485d24fa2b4ed2dc7ae8a7dacb43d5aee01ecc67574424e2b5498af6b74e8b6536dbd3f7d76428e2f27251661ae8e81e4f46c2b2455b61b7b98ad896d2363910dbe90da313d59b777e7c471294191d41157aad4d218d15472ddf903111524a6e80483bd4eef7dfd81cf0c7443aff9bc016d10044c4d9729547cc3064c5e432c890951edcdc7db5449cdbe18d46c5fa327f1ecca89383077533a5644da3cdd4c64261a2e26e420e17c9541450a033ec323b4545210b7db6cd37a30af5556ab7c30ece0ea5844c369f49981d80537042b4717269dd552f9bf6972b1362e6684217759ae6c91829886131e28bd6b53348b8df6d94a4216cd6e0d9af5e63399db18480d4a7b7d4f4ad11615ccdc18d9166938d43ee82ee8d2c2b65982d91797fc1df434e1e21b1c39a8e5cf435ad4f4cc21064768173b6bbe138da2de991c9915a59be4bae14c14f613f4f5c46ea6ad193e6f3490b082e147395b2cd243b017e642a4f90d7aba606fdb84b1f7d68567d2b818e80ef65818150892a7b37e361c318592cc199a44f8757fe1cb1dc3ead97a7f3bd61ee088c600aea607e0024adcbe0c014f51f80474c3de3e31462a079c9226d23146856af1a8d5eba40b4de43ab3fed6a023a75658d1e63ebb00ca41a8351c22069bf5dd86d7f6ab7e1f0c1865c1bbdcb421aee561d3d9a85e2fa59fc8b92a7cba1a745af30ca5a276b2cec46bffaabb5ee5d83807358ef065209b2f2d8254d3166d57c8926b0949f7112097ebafe8e30e645e957e767063c34a9456fa2d32feef3331b1b869c6adcc40ad990fe8b368ebf0f76315290e5a5562ca62ed516f263a2014fb94081f17f095ad07629ae15ebce8ad3597b265e5301ac51b6cf773cecbae965de285dd25bb02e2c0c06bf114806dd714cec97575593796b4fdcc7e2330b212d3c3f12b4c31add6cbba4e25c51f404c728fce692e23264af0f4538528b6caea8828ea821959efdcb4f30bfba0e0259b20f153d6b59072948e83987a6190769836ab055a601be4df45447cf25b4bd8b8741c82bb8df02a8603e6a510efa7d12050d7f243a3876f8182defe23eb59eeeab2d5495ea3246b74c14cb8eda4e41cb09f73886825eb9582b1edb52a07780bc2e060312e9fe4eb9d1ff54c17f2e332559657eac89ced71e6fe507b55282c63d5bd2aa55d14d66ca6b5edca2ca861c5186135b5be9bae81b32c07e6fd36ed6a449b3506504287b5d6720f7a199abed48d35737dcacb8aa01394351f32bcb241b2fd10ab105df4f5a3e0683932ae01c258753b542fadf9888da0dc3b77635393bcf1ad851f946e6d36d284d1dd2cf8e7f81e821bbcaf4230811222bfa527c12319fa1cb6d60e6d365c023decc2df78f3bf82246e29d3c406c843a62daf390a1b0574d3dd70dd1c4ee58979b76d4c33252f54cf4dbdbf3abeb9aa6e8e29a184f83ce33c9cfc24b287bc68090efd4263f6afe53e88234a085acee67b95f5416cb31cf9c832e0678d0cd90ccbb3c5cb00d523c95d80210c47b4835a2cc7dd86e825a2ed6866c76bfc672db96f3d593142cd407b546dc3fd17e1c6b8747c2d4acc60820bbeb2de1536dd9681b8f2f3735d6ed68570c795e9b39c47d23ff4605159b9427ae374a2a6cdb9b65d3286b074d84e7f8ff17da4f2b0511ac9e301fdea007bdb8e9928b6a1e3d9e4bb5629d2221385b37947b8c959adc6b71f1dbc06a275589cdaee5aa5d604e2796a2c1a48ea9034e7d13cbd5f2936613ab4a43370c3f6905cca38d310336d301505df02c5bef16c50583816459c719b4aff0e29444d190a24d8198182639b9cb4930e49e268f1bf5d2ccbf412ce63de8e4ca67c1de65e425afa71acc741cd06f863f16384f32c0bf380fdfe9f50f5f278b6b15fcbe94cd457ef4f641e52a344411b66f45dbd4dc7c5b2e7e0e6e0ed73b08f03c744b2761244c3f001dbc1eedfa54ed8f97585f67a98a802e0565e4de66c92b831e63e6e6c82f10f3b1cd00a1ae538985fd59569d901af22292d57ff16473e60648f86943f5df5c9de1438d3562de449894e2d4fd7a408506844014163f786a9655e42e74cfe155e64c7b8e36b46e85b89a57d5ae28f7a0909fc8479055aa593c0c3769c860c5f8232f74560da6035347fac16cbd4ec572dc6e7b7f118dd5898b17f1ffb1d44d0e3fd1f947f1e021e0d78568887eeb30938430b84c8cfb2929a2fc02d1949587a0c59b9bdf217bd035220040260cc0adc49cf64c072c65b10a29ea23812dd85ae946522362190242abc3625a90fc78f41880a67656465c30d623b5f6322c2023de6c71b835f098abe4a5e98bec4bc45714ee2bd5cc51320a05493772d0131192a90a64995a158badf156f896957b27665b466798e594dda44b39b41df333c27a2880d1d89a42abf960bb0e650912c49fe8fefaf565745adae2f4dee5b3ee9bde7bce5dfc5fad853946308556b24f2086fe9a10ebf18c290c0fe4a3baf900e0692b22fe8395cf555f5807ad5a51629725cc16809842fd21089d02006120567b222ea748d1072d35b1785e5616ab598380ecdcc8ec696d503b492728d2b0a78d0e5c8c8bb3f1c37c1e1ffc0e5edaabe587590cfafb963187dd156ec53c77b600030ca8b3d934ad815e56d7fb800696a8e9a678fe6473a7d3645bcbc778041d73953dcf19fd8a72254f9f0be450581fba937d55a6fdff32ba05a09b86f343d38abf0c2880cdad5b329d8306453ac2616dfb635a5c740ad2567372e41f105707ca53ec75096d03d27f0d0668dbb3420defdb2be1bc22dee24a2310f9dffec86e0ec75cd1b1c3f7009c77daa351c9be7e30ba91ba1bcfff680153d7af86d764015bcce62a73c22a3f7d09813015a4b9108d269209b78f473081729e57d10a06a86fcf79e16e4286540001d18955b4efbe6cc66d70052ed2c9b71f60ac0513ac60c7f0ddf2deb9aad7fd0d4d674bd0d16db9ab46e49d9aa46d7b98df8538047540b0a5a45812b823ee6fc8ca69f15b0f7bfba1851a62cf40bf235fd1ad2a58bd33b47ad12787ececba72b36493fa26af8ed0d24480385e872ec85c9d0436877e4fd951f65cc0233650474495ef57db0650f45bfde500fdc2786ea4b1778054e4fd691b9c006790a7b1ea2e6389d20a72f8fa57d71b9c18519e07783688dbcb1618bb078ae29e0a38e5644549162914ee967627b42c84ad6f3daeae5b12ef9b9315ce2548d6f42356e7117f723e9141343141c3714604f7c141a02f9d2a090e038e9a6cba01b47eb57872802ccd130f5c01afb4d9f49519173a5b1043e07013d6ddd4c16659873d1f2da11e432e141a11e6927dbfe83cb2a94514b2719035484c1cd31db7a3da0d984b7af27a2025ae5bca6a6e88ae82c746af94955ae22a56aef2ce3922568fdec632744d0e020750cff8f052a862cae56c3dbabb75e2e1077700de45e696c05511a5019456f59bfca9ae3fa5c6f259ff56558fc276bd7a126b97e5919cdeff167607e810d227a8bd36377df4d14934606b65eb64af6a454294ca2789a16e5ff5a0b11272094ce07d7d0d5667609c361a189fc4b45a4407b11884e898eff0d0aeb383716c5cbcff97d3fd74fe222d1783ecedfc669cb1489fe5a527484d9666ebf7cad79d5db6a96d128dafb9e84d836eb4273fbe2171a681c10d90a314998c83909bf182b0b79171e099b4dc7fa76a51f27ebad22ecd7e313cdf437280aff9c3e0fe294efec9a9004d2f49d366b906009b5a1063f5d2c40c80d4a42c54b687a06990d384cd2ffca3fbf26332556f2e340ed800739f266c05979b3136d00e50fce0f917d69eb54779011205cd3295d34633e6f44efdee1c2f6dfcb363ab2e57091fe5e26d39f1c183b328105c6b20d513761a62cf22ac3a417cc106ea6d95532a24475dcb470b4da6cd081495cf6268d19f530b1b132bdfc460952fadcf7dc24da0efe9791fe04381d7961b0797481b5ceaea1d0860d80e879cf2ab8aa385be132704f434d2cd17cf822825bd0316f33a5848a408098ae37eee57d373df080ec061597415fd768bca6355a1f6753f3816f431fad5c489157a90dd6f13451ab525e4afa4afce8111c39f4e4c5f6cabb86a904a59bbf12ff11edfc5c44bae1c2474bb904dfcb9ffe7757a9f233849f2d967490dc33119b16fae8e3dd1f7b3d0ea368ca6cb1c5177ff79f548955a241175190caa5a536cdd12258e5992ffcbe4dccd7c6f22b5646321549d9ee261f2fc00c850a66ba4d3e38afa8ae4f59760751d2b9d3a392eafbea1f54413886b19193c2f2ab06b11ccca421cbbf8755bd1808b5aecffd8a90b4d6c1c509310a2bf64d414b2feeea418d673c816b0ee34db6b8c0f3e30905718aee8c144335e8b4db9e2a031db1f8abebee2c83bbab69f664a0ec22ed37a04a0cab0dad7371f91bdc4d4c7946c5f682efa4843c6bded7e8568615c69583994237397c958c96deb7686327f0dee454f27b7c61b3d2840b0418568643970e86e315d9210d7f2f28929cb9b9df98efac6315c0f5503064098ae7a4c4390cbe9596a859eace12cfc2f8867be490b4bdfff14bdd0b0141183eda2e7bcb7b96fad14b5712d705b866e694d67b48c04a6ea3d8f9a92e04c3c45578c1684c9f431351ba06e508ea601be04ccd6ef11986276ceea8c9b6a17691e51b8b56a1935b068146b62a6112b21e72dea1a4946c52e893d7b5e6e6f41b345b44c1bce1f3befbb76036d288b85b0b63705e2886461f55f84cec708262602d2723429430dc08e30cfc059f2294f5074bfc9d88cc5fe381cb49683b80d62048550a2e76e68c4afe9145c3e40f34c9c283b01f42845a1506bad5c609961234d6428de8598f9bce0b59f976b13d93c3c3da6dc8c433a8a65540fba81408957f9de3e4a2aa87914955f22707cc502dca01fc3520e4f21d28a402b8672ffe56030afcc9bc044bdfda566bc7b73f2d4ce07300dc3827de1e150112e21aa06bd667c0d55e4edca52299efddb44d71183ba46789f38662a52b74d4f25d5c85a9faeaa3bdf60983d9d709a9a6dff59b975d9888ca1228426310ba0e439bb5590e8fa0858e6d85e8749f4f17910cec5ccd092fbac6b5746bd199a701c7d020dcabed918b1f9892d40f716b9f76e4402b9d065aad614eda9acac93fb1b9b73bf67858c281afb22efb699ab93ce2c204a3987851ac6f7fe7da5fd742241af3a087d784720698b9cae97c7b3c93ae9f8c0dd9052c3cf3a4316a5149508c8ebb04726d89be27c2e8ee5424ce21443a822fd91edb85694afa83f2ffba8b5c0a8ef3e4b94d7685439da6190ad32bb0ab78797fbedc7285984804dfdfd8128cc79b6d9d8d975234fc4220c60508d7678d53ccbe6af1ae58b15325c14eb5f523c39280d4f77f6e775760c8fd3982cc4a03b55df531dc6ed0d614642748a55aeea450ee0631f9777b82dc8e7ea309ab4007ce7464b2b5a5e7c907b984598f1c353c93c915a7b676775741ea2f26712b26382748170781192f9283c6c2c4d9f387425a93bc8d5c696b56cc0d8ac28be2f6d9513e65e7f4c0d86cc2dc09116ee9801c8f47bcf8c40ab496649152c62f2fc2f6ddd477e04749a6c98ed8b0c11a8c0d078f48018626a0888c67b677900b17dc51faa68abc0f23e6dd74ebeda0b72354a30ad22e105c414d9f3f1709342a1315240e3c8f9228b9dd0b1b861708ccba46144a4abfc7258fe55c32ce9e2ba09a3232059451c2ef0fcd3af421279a004eaf1365c1580a11635ddcf0bf5b7bf5aeb6f18954882a3ac1f1ab31f36bde289b74258a31aad211ba9b3f61083594ea01613567c924e1ffac86e172521f5921c68a5ef91494f3f63cfc3b0e7781f2ae99af32be31cf8e00f38c8bcdf1d29a4e70489399bcf2e8e3e129fcceefa67a7b1e514accae29b98c397406522215cb592a748ea308e96b40266e25a6a500f3a8b953a29c7500d575cd03f386eca82bb56dcd83edfb0629f0b59862e540c1896dc2dccbc8ed3d8106e3072c8c48a723fe3c03c94238567b2c1c3ee830dade1358b969ee20deb46087f5ab837cfb8720cb7dd7140bc9c5251abbc224fdf0385630fc00d5c7a48d25567d3897a99df60e37e01bf841a5e88ecd45da5a5f0e6ab2a5a6cd537e25da025106e09b56faf83063ae75a67d6aa8a1915b5aed344f89f732c447c1e8097efe7bfef8e282986d9398be62a06d49a636dc36a4a7b4a50dc47599da5dd5b2c114880d838a2c1469982895d64140c3d98446fd326e2699373597f115275453e81a37ad4cf3d9d3c56dab04a1922a7d97213548f44439071fdbeae248ec956b6416851f20cf46317f0b5485585cdfe23e31db1128b7b164350c9cd25fa6dd0c138427035fcd8c15bf61e4cfd82f542fdfedda22c84143b52d9e983137cd73bb4fa167989e6a38d4b9737eda7a3efb58a6f710092c516dba2354ed88863a74ecfe7ca4707fad29b3c2fba85a5e5ee1edd89773e1c6ac1323dd6a9a6f3f52dfcb6c53828ea7bd33f72357a9a554605ee3cb592819ab5a12851244afa719130bb45d56c146436ff8545c80cdb6a18f4984837a0cd5d0d09d193c02b1637f8137b91624e2197746121cae979fe5e100a63330f9a9b0e0af43b6c7650fb1764bcc426563d22113a6308ebc425536ae1368f1a398e8893a4078194248d3e0a41c1f982d4bb23bb862a3289f9d888e272f20dd74ca902542a32f4bdd9b136af7a268a1d09c13c2b3809467758a16968e30357254ed691006584ac22179691e9eccf859a1dd36416ab76bd1a479a9977985d83709eb0a36af1a0912490d79e5e6ff4c71c6017e0be3a041407225ca3e6a86fa9bdc8a792ed915ec1d090737124a63efdd2f7437420cf1bb4bf611c8fc5c4233e79c3b91b453a9fb520cd7a74865893ba9703199f29692b6c2cdefaeabe7c20eb79c42f7d4cb6c4b15dbb60d8c843511ea909255ec602d14d5ef656c31b81b2295a44543863d776bead7aa3a2fe4ff66195e027956be394f3ead6df0703e1a446aa5c6835bcea2f1f4324a6a112554c4cd3cebe0d7195c10687d5b9c4390a5528bad70f5115db352143f3cd92a2a541b812eb34061859c8e0c24dbd2405601698f14d1b5ed7102ad84fa65c84fa244abf4132be4be210d8a7180238c1cef3708ed9cb58f08c99af967408eab07ba66ebd3c6fc51b2269bb4d3f4a97375bec9f3d053a808264d47f0c07d1960ffadc26350f8708fe60d2bdee73d35fcf3b28299f4143c069b9173581b0f3c094e8df87b80c123e3db55af7a0ca2725c18e24ac2cdd2eafb04c450fa99a617572481b998aa3fe9ebbfbc442831e28e07978718645b9dd724350fec836de665f76a6979ab8a98b64d79b922ad2322a4b5d5b5c265a2c44f629793f1129966ff4e81ac69661e18606151b5d87552ecbd284f1bf3b5c17babefafbd295a1d6a50b0fe471154905fe494793b3c5da92ec52b35a333351a35a40b9230fcc3293fa59750af203e1d4c041191939e328a82b55241038b1c9e7b1e8ff7cd5e461349e7fe348c1f57c564dda91c1b75a829a0f0781e5b977f55b5aa34949525590a11f75d81de7bb609439b31f6ef7433a9615bcef15d4f92ae4dc6f5ed3ad0c59d273e9358069bb04795bca945140a335d6f60e4aaaa2347635fd3db877c1a9e4cf4c17bc9ba59e1f6a34d718bf5c8e72c6051bd8583a1958cb6d2fb8688a430c6ba6918ea7131bfc323c8251ec2f8c0514b09316c402a832aa9879dbb406b7b2af6c050c4db3ce8d46d349ffa1a08a243d9f6104f773d53620f27417086f5d965107fef45cdc3f4af7ad592dd94d0af736e55e8438cdd947cbdc964a48e1e68d4b0e27f6b61a0fdfd8a5cd3740e8e3a6972a6abf9ef29f6ac9b4369688aedddc3c983ed5598b7279930cb8466977045f5498f60bf819171856b16aea06b4dc6f75314bd48f3e74c9d589743a8b4d7319cec2c7c9ee17fed91eedcf00ded26bb02f5ea4d6fe54a300c400a3ae32f47a86e354cee3ef24fac343245bda02b3c7bb506798d72f2fd0c3569ddf0386c999055deb23dd5f7a723fa32643f09b04ce48b5b41c1626cd0eba4bb5ebf02f04566f79b26e2d784a7713e9efa2abf029248ae8bf5155374e2cc6f54d9da72def3c2ec0d2171681d78ed30bcbd88317d5d2968dfd742b437bde6db0403029631e5302f3221f8d76afc2e6302cbdea47b69923dcec6e8289edd9d1cce97148070b2c8964caf7048206bfb14e1b2e350d13a48be1f0a23e4cfda91c0d6e2ce718ed8ca1f449ef3c9701b11f8be58cbf4b712aa5f9bebfc4aad1543549f4cb6a22e3449027e10a779da4c20204d482efed60304b146c40cf8494837f7ca6752d5e4f236e0aff20d8344f6da8fed2c0d2fc0289587985819abf94df48f683930f3f8553bc08482dd222b5b0a8ecce7a0b7ba493bc9051eb728f6a531b0b4dec9dd58b5a48be0799645b0dfbb80977ed16c6b1ca5b11c5670a7078e9ee14650a14ae721e460b40cda4f546debe6d1ea7602d626b9d0236686497b6e641dddab8f8d3641e6411b164f769d3eed6e48ae11dc3fc344f0c812e8e1a8ea43a28956086ac06a5807662a8547fd8466199170001c9fb68db19d35e1d5c384346310af2ab622d82bf9b3f99bcab2b1951647bb4a7c5ef0354dbcb9e73d0703ccac2ed8baeffcd012128745dc145db00dfe96d91c77482a12677d538945d01da968adfb58728f93623d413483825043dd8b916da810106bc418d94a0c81477fbcfea202d5fc68c8573fd6bd746f8beea1b248ca17c3cb2103abf90543a6803c09ec9a22eba220a44e9482f3186a7ed0f588322da56ff826ea940c67cb97fdcf69bc325a6c3fd7914c6a09ede055402a5bdc9e39621e5f8b83cc2b625d0a8d9de44d4001872a445febded35e1be8ce2defb5642e5a9677c013fcaad060a887b8dd542f5109d7cace7087b2de7d1c5be81ef0a3021f8c69ca01ef4145cec8393d9c858049766b9d448f82aa9e8fd28b75f2c420f3554d53099099913fb1bc20c8cbae5a489a28cd74c20cf95130866e63540d3f4ccad967badca5bd59943d9d68ba2e8a529ef72ec53e49433d0d9e1f997bedda4f4542937c5b33e25c8294509bdeb6e5e1c6ebe96a4653167e09c7c28d0e23b3a9116ecabec18d9b91acec33f32f2516b742bc9c6d5e90599ea92f94906fc9a6b78d3ab91bbd5e4dddd6f88f1246bbcca84a70be232b6f2fbbb418c780bddcccf4a12b92cba44de4c24158ca6901435f80e23d71ef6a5fb1fdc68c5ee72cf80227db0d26d47cb6dbd2a1b9dcf48f6f5939e78c2ac7eec01407cd0421054a91c7b9ecc2c0f90cc55ba23acc9ab7e9e9b0c8dcee76f37524eda6fead12acc5fa9b0114dc73763748014f7a95bd0a6f633fc438ea352ac68b82651764a4f08c6be7a4718f6710a14b958733d595976708ac0171f83ecd90dec08423764d42593bfe3872bb149eee80661293c14d517d89cc821e9ea7717b16f0abec5d2d3e68acc2c9f6ca9de264bbd31432a55a4bfa32e9cbd631f231bd181f89a6bde9515beb7331b56f341cc4c0fcec896fa23a22e3cffcad024911139f9b4287601768f5e0fa294f217c5ad53ea69ea283fd130c6894d468ce6adea200f15d1433d039cab1c313c5f87ca2ea5bbb22ca220a3b98784d07af881f6a663d45aa8ed39307b285bd00d76e73e0fe54f0deedc35fbb9c92d8150c73fde66f198ce18f97985608ee04d26b95f1d5639c5526b1521d9a2a6fc7243f67af3e7945521529eaf9e000c5411c5ba35a21cb268167810d508ed60515c0d62f98e7722b5d524b659c9f363243c9ebb5b8f7ec1c7d97af4e66e79152794675759a21babbc8d23f0946c6238053da5d419d0873c3565c71daf07c76c517eeee9403e5c61f2b63211e8188300616d46868c5ad7d1eab0fd44f6fc601b78e058d9cb1ae9fb6d547450f25ff9f7ddfdeb24e2be5397bcb310564c2b0ad7bb4aa0c0de306430001690ff08e28437d4ebd571be3e43c0bc98d6789ec59b3193133ff7a4cc7927c86de8ebbb1e9fd08e7b2f9de1a454b7729099c0c41108dd2b254eb8d6e43e56f29cbf49c081baceca6e5fa8d97bf0b4d351d1271ba23cbf831727360586b00ae79143e905399f294fcdf6deb394a618ad6a32e50606c5c43f4e2c24768531a6d219826458e5f7b0956468f54455730f281ec8f897b109dedabd962b3447a9dc048561d8be320944c473a1c39127cc4565224c3d56e19d1ed1f97e309f840f9a7610e754a8e44d96e9c2b9340f85ffcf043f46ceeaaa502361c42e1ec7590c351c8e3d161ad52fc5b994878f58d71dbfae07452f06ef84d78041097f120392dd7c02148d5767d3d20c31b340fc97939dc9087873de5090ba741a9e87d20a92bcd671a64231054120a1890af9d59931e90c3b33fb4e7a71c71e37262b24a547b938397c81651cd110765f25b0b98dc409c9015a0cfdc1a2057de09474e514802013e463a313878e1907d071088c9201adabd5c6a4f5d428b8330c9d01f24e9766dd2a9259a9b43de9df7e72121a5e5a215dce15de71178c5090de6fe5758bb76ce13e051aa1d90c501ccb94f1274986cb46d8bf59cefa9fc7f1c85f9070e52b70faf8785cecb7964e5b22f6790437d5a5841265ded917757bcbe55ddef528527250900ceeb4ba91b6c3214c037a19f6f465e21b90949089220d6600d621127131052a0af762d57b30e0227dde6cbaa385bf0e1b414f641f9a42f2fae3898718c3fd053b5423c92e051412dd56ca862fa66ca519c434d49be5763f1fe191f2bd32765bd76902e179bff04f792bbedb9bdc7df7e73b5623ca202421b671f7c9edad5fd6e066ebb0492751ef5fc</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsè¿ç»´ç¯‡</title>
    <url>/2019/10/22/jenkins%E8%BF%90%E7%BB%B4%E7%AF%87/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="jenkins-å¯è§†åŒ–æ„å»º"><a href="#jenkins-å¯è§†åŒ–æ„å»º" class="headerlink" title="jenkins å¯è§†åŒ–æ„å»º"></a>jenkins å¯è§†åŒ–æ„å»º</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ä¹‹å‰é‡åˆ°è¿‡å¼€å‘æäº¤ä»£ç åï¼Œå®Œå…¨ä¸ç®¡æäº¤çš„ä»£ç æ˜¯å¦å‘å¸ƒæˆåŠŸï¼ŒåŠæ—¶åæ¥åŠ å…¥äº†ä¼ä¸šå¾®ä¿¡çš„å‘Šè­¦æœºåˆ¶ï¼Œä½†æ˜¯ä¾ç„¶æœ‰äººä¸ä¼šå»å…³æ³¨è¿™ä¸ªã€‚<a id="more"></a> åªæœ‰åœ¨æµ‹è¯•äººå‘˜åœ¨åé¦ˆxxxä½ çš„ä»£ç æäº¤äº†æ²¡æœ‰ï¼Œè¿™æ—¶å€™ç ”å‘äººå‘˜æ‰å›å»çœ‹ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªè§¦å‘æ„å»ºå¤±è´¥äº†ï¼Œæ‘†åœ¨é‚£é‡Œå¾ˆä¹…ï¼Œå¦‚æœ‰ä¸‹ä¸€ä¸ªå¼€å‘äººå‘˜è¦å¯¹è¿™ä¸ªå·¥ç¨‹ä¿®æ”¹æäº¤çš„æ—¶å€™å‘ç°è¿‡ä¸äº†ï¼Œè¿™æ—¶å€™å†æ¥è§£å†³ï¼Œæˆæœ¬å°±æœ‰ç‚¹å¤§ã€‚è¿™é‡Œå¯ä»¥å€ŸåŠ©çœ‹æ¿çš„å½¢å¼è®©ç ”å‘äººå‘˜å¯ä»¥éšæ—¶å…³æ³¨åˆ°è‡ªå·±çš„æäº¤çš„å·¥ç¨‹ï¼Œç»“åˆå‘Šè­¦æ¥åšï¼Œæ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚</p><h4 id="æ’ä»¶å®‰è£…"><a href="#æ’ä»¶å®‰è£…" class="headerlink" title="æ’ä»¶å®‰è£…"></a>æ’ä»¶å®‰è£…</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®‰è£…Build Monitor View æ’ä»¶ï¼Œç„¶ååœ¨ä¸»é¡µé¢æ·»åŠ <code>+</code>ä¸€ä¸ªè§†å›¾<br><img src="https://img.xxlaila.cn/1571707794737.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥æ ¹æ®jobçš„ç±»å‹æˆ–è€…æ ¹æ®è‡ªå·±çš„æ¡ä»¶è¿›è¡Œ<a href="https://xxlaila.github.io/2019/08/09/jenkins-job%E7%AE%A1%E7%90%86/" target="_blank" rel="noopener">è¿‡æ»¤job</a>æ¥ç”Ÿæˆçœ‹æ¿ã€‚</p><ul><li>Build Monitor - View Settings: æ ¹æ®jobçš„ä¸€äº›çŠ¶æ€æ¥è¿›è¡Œæ’åº<br><img src="https://img.xxlaila.cn/1571708048469.jpg" alt="img"></li></ul><h3 id="jenkins-ç›‘æ§"><a href="#jenkins-ç›‘æ§" class="headerlink" title="jenkins ç›‘æ§"></a>jenkins ç›‘æ§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰æ—¶å€™æˆ‘ä»¬æ²¡æœ‰ç›‘æ§ï¼Œä½†æ˜¯æœ‰æ—¶å€™éœ€è¦çœ‹çœ‹jenkinsçš„ä¸€äº›ç›‘æ§ä¿¡æ¯ï¼Œå¦‚ï¼šå†…å­˜ã€cpuã€ç³»ç»Ÿè´Ÿå€ºã€httpå“åº”æ—¶é—´ã€ç³»ç»Ÿè¿›ç¨‹æ•°ã€çº¿ç¨‹æ•°ç­‰ï¼Œæœ‰æ‡’å¾—å®‰è£…ç›‘æ§ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å€ŸåŠ©jenkinsè‡ªå¸¦çš„ä¸€ä¸ªæ’ä»¶<code>Monitoring</code>ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ’ä»¶å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç³»ç»Ÿç®¡ç†èœå•ä¸‹é¢çœ‹åˆ°<code>Monitoring of Jenkins master</code><br><img src="https://img.xxlaila.cn/1571708499625.jpg" alt="img"></p><p>ç‚¹å‡»è¿›å…¥ä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571708561404.jpg" alt="img"><br>é¡µé¢æ˜¾ç¤ºä¹±ç ï¼Œè¿™ä¸ªå¯ä»¥è‡ªå·±googleè§£å†³</p><h3 id="Build-Trigger-Badge"><a href="#Build-Trigger-Badge" class="headerlink" title="Build Trigger Badge"></a>Build Trigger Badge</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤æ’ä»¶ç›´æ¥åœ¨æ„å»ºå†å²è®°å½•ä¸­æ˜¾ç¤ºä»£è¡¨æ„å»ºåŸå› çš„å›¾æ ‡ã€‚å®ƒå¯ä»¥è®©æ‚¨å¿«é€ŸçŸ¥é“æ˜¯å“ªä¸ªåŸå› è§¦å‘äº†æ„å»ºã€‚å¦‚æœæ²¡æœ‰æ­¤æ’ä»¶ï¼Œæ‚¨æœ‰æ—¶å¯èƒ½ä¼šæƒ³çŸ¥é“æ˜¯ä»€ä¹ˆè§¦å‘äº†æ„å»ºå†å²ä¸­æ˜¾ç¤ºçš„&gt;&gt;ç‰¹å®šæ„å»ºã€‚è¦çŸ¥é“è¿™ä¸€ç‚¹ï¼Œæ‚¨å¿…é¡»å•ç‹¬æ‰“å¼€æ¯ä¸ªé“¾æ¥ï¼Œè¿™å¯èƒ½å¾ˆéº»çƒ¦ã€‚<br><img src="https://img.xxlaila.cn/1572059619062.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineè¯­æ³•</title>
    <url>/2019/10/21/pipeline%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ€è¿‘åœ¨æµ‹è¯•k8sä¸Šçš„ci/cdï¼Œä¹‹å‰çš„ci/cdå…¶å®ä¹Ÿèƒ½æ»¡è¶³ç›®å‰å…ˆä¸šåŠ¡çš„éœ€æ±‚ï¼Œä½†æ˜¯æƒ³å°è¯•æ”¹è¿›ä¸€ä¸‹ï¼Œä¼˜åŒ–ä»¥å‰çš„jobï¼Œå¸Œæœ›åœ¨ç™»å½•ciçš„æ—¶å€™æ›´åŠ çš„ç®€æ´ï¼Œ<a id="more"></a> è€Œä¸”æŸ¥æ‰¾jobçš„æ—¶å€™ï¼Œç‚¹å‡»ä¸€ä¸ªjobå°±èƒ½æŸ¥çœ‹å®Œæ•´çš„ä¿¡æ¯ï¼Œä¸éœ€è¦jobä¹‹é—´çš„æ¥å›åˆ‡æ¢ï¼Œç­‰ç­‰å„ç§ç†ç”±ï¼ŒğŸ˜ğŸ˜ã€‚è¿™é‡Œä½¿ç”¨jenkins pipelineï¼Œèµ·åˆæµ‹è¯•çš„æ—¶å€™ä½¿ç”¨pipelineï¼Œæ²¡é—®é¢˜ä»¥åï¼Œä½¿ç”¨jenkinsfileã€‚</p><h3 id="pipeline-å¸¸ç”¨ä»‹ç»"><a href="#pipeline-å¸¸ç”¨ä»‹ç»" class="headerlink" title="pipeline å¸¸ç”¨ä»‹ç»"></a>pipeline å¸¸ç”¨ä»‹ç»</h3><h4 id="æ¸…ç†å†å²build"><a href="#æ¸…ç†å†å²build" class="headerlink" title="æ¸…ç†å†å²build"></a>æ¸…ç†å†å²build</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ™®é€šjobçš„æ—¶å€™æ¸…ç†å’Œä¿ç•™å†å²jobçš„build å¾ˆç®€å•ï¼Œå‹¾å‹¾å°±å¯ä»¥å•¦ï¼Œä½†æ˜¯pipelineå°±çš„ä½¿ç”¨ä¸€ä¸‹æ–¹å¼ï¼Œè€Œä¸”è¿˜çš„å†™åœ¨æœ€å‰é¢ï¼Œä¸ç„¶è¯†åˆ«ä¸äº†ï¼Œä¼šæŠ¥é”™çš„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        buildDiscarder(logRotar(numToKeepStr: <span class="string">'8'</span>))</span><br><span class="line">        disableConcurrentBuilds()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>buildDiscarder: ä¿æŒæ„å»ºçš„æœ€å¤§ä¸ªæ•°</li><li>disableConcurrentBuilds: ç¦æ­¢å¹¶å‘æ„å»º</li></ul><p>è¯¦ç»†å‚æ•°:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">buildDiscarder(logRotator(numToKeepStr: <span class="string">'8'</span>, artifactNumToKeepStr: <span class="string">'8'</span>, daysToKeepStr: <span class="string">'8'</span>, artifactDaysToKeepStr: <span class="string">'7'</span>))</span><br></pre></td></tr></table></figure><ul><li>artifactDaysToKeepStr: å‘å¸ƒåŒ…ä¿ç•™å¤©æ•°</li><li>artifactNumToKeepStr: å‘å¸ƒåŒ…æœ€å¤§ä¿ç•™#ä¸ªæ„å»º</li><li>daysToKeepStr: ä¿æŒæ„å»ºçš„å¤©æ•°</li><li>numToKeepStr: ä¿æŒæ„å»ºçš„æœ€å¤§ä¸ªæ•°</li></ul><h4 id="gitlabäº‹ä»¶è§¦å‘"><a href="#gitlabäº‹ä»¶è§¦å‘" class="headerlink" title="gitlabäº‹ä»¶è§¦å‘"></a>gitlabäº‹ä»¶è§¦å‘</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰çš„æˆ‘ä»¬çš„ci/cdéƒ½æ˜¯å¼€å‘æäº¤åˆ°æŸä¸€ä¸ªåˆ†æ”¯ï¼Œç„¶åjenkinsä¼šè‡ªåŠ¨è§¦å‘ç¼–è¯‘ã€å‘å¸ƒï¼Œè€Œä¸”é…ç½®è¿™ä¸ªæ­¥éª¤ä¹Ÿéœ€è¦å¥½å‡ æ­¥æ‰èƒ½å®ç°ï¼Œä½†åœ¨pipelineä¸­ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç å½¢å¼æœ€è¿™ç§è§¦å‘å™¨(å‹¾å­)è¿›è¡Œé…ç½®ã€‚è¿™æ ·è®©æ¯ä¸ªé¡¹ç›®éƒ½å’Œjenkinsè¿›è¡Œè€¦åˆï¼›è¿ç»´äººå‘˜åªéœ€è¦ä¸“æ³¨çš„ç»´æŠ¤Jenkinsfileï¼Œåˆ›å»ºå¯¹åº”çš„é¡¹ç›®å³å¯ã€‚gitlabè§¦å‘jenkinsçš„æ„å»ºéœ€è¦ä¾èµ–Gitlabæ’ä»¶ã€‚è¿™é‡Œéœ€è¦è‡ªè¡Œå®‰è£…</p><ul><li><p>æ¥å—å›ºå®šçš„åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">        gitlab(triggersOnPush: <span class="literal">true</span>,</span><br><span class="line">              triggersOnMergeRequest: <span class="literal">true</span>,</span><br><span class="line">              branchFilterType: <span class="string">"NameBasedFilter"</span>,</span><br><span class="line">              includeBranchesSpec: <span class="string">"dev,test,master"</span>,</span><br><span class="line">              secretToken: <span class="string">"<span class="variable">$&#123;env.git_token&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>triggerOnPush: å½“Gitlabè§¦å‘pushäº‹ä»¶æ—¶ï¼Œæ˜¯å¦æ‰§è¡Œæ„å»º</p></li><li><p>triggerOnMergeRequest: å½“Gitlabè§¦å‘mergeRequestäº‹ä»¶æ—¶ï¼Œæ˜¯å¦æ‰§è¡Œæ„å»º</p></li><li><p>branchFilterType: åªæœ‰ç¬¦åˆæ¡ä»¶çš„åˆ†æ”¯æ‰ä¼šè§¦å‘æ„å»ºï¼Œå¿…é€‰ï¼Œå¦åˆ™æ— æ³•å®ç°è§¦å‘ã€‚</p><ul><li>All: æ‰€æœ‰åˆ†æ”¯</li><li>NameBasedFilter: åŸºäºåˆ†æ”¯åè¿›è¡Œè¿‡æ»¤ï¼Œå¤šä¸ªåˆ†æ”¯åä½¿ç”¨é€—å·åˆ†éš”<ul><li>includeBranchesSpec: åŸºäºbranchFilterTypeå€¼ï¼Œè¾“å…¥æœŸæœ›åŒ…æ‹¬çš„åˆ†æ”¯çš„è§„åˆ™</li><li>excludeBranchesSpec: åŸºäºbranchFilterTypeå€¼ï¼Œè¾“å…¥æœŸæœ›æ’é™¤çš„åˆ†æ”¯çš„è§„åˆ™</li></ul></li><li>RegexBasedFilter: åŸºäºæ­£åˆ™è¡¨è¾¾å¼å¯¹åˆ†æ”¯åè¿›è¡Œè¿‡æ»¤<ul><li>sourceBranchRegex: å®šä¹‰æœŸæœ›çš„é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼é™åˆ¶çš„åˆ†æ”¯è§„åˆ™</li></ul></li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰€ä»¥åˆ†æ”¯ä¸é˜è¿°ï¼Œå…¶ä»–çš„ä¸¤ä¸ªé€‰é¡¹æ˜¯æœ€å®ç”¨çš„ï¼Œæˆ‘ä»¬åœ¨æ­£å¼ä½¿ç”¨çš„æ—¶å€™ä¸€å®šä¼šç”¨åˆ°è¿™ä¸ªï¼Œä¸Šé¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªæ¥å—å›ºå®šçš„å‡ ä¸ªåˆ†æ”¯</p><ul><li>åŒ¹é…çš„æ–¹å¼<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">        gitlab(triggersOnPush: <span class="literal">true</span>,</span><br><span class="line">              triggersOnMergeRequest: <span class="literal">true</span>,</span><br><span class="line">              branchFilterType: <span class="string">"RegexBasedFilter"</span>,</span><br><span class="line">              sourceBranchRegex: <span class="string">"dev.*"</span>,</span><br><span class="line">              secretToken: <span class="string">"<span class="variable">$&#123;env.git_token&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œçš„git_tokenéœ€è¦åœ¨jenkinsçš„å…¨å±€å˜é‡é‡Œé¢æ·»åŠ ä¸€ä¸ª<code>Environment variables</code>å¯¹åº”çš„ä¸€ä¸ªé”®å€¼å³å¯ã€‚</p><p><strong>æ³¨</strong>: æ‰€æœ‰çš„è§¦å‘å™¨éƒ½éœ€è¦å…ˆæ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ï¼Œè®©jenkinså®¶åœ¨å…¶ä¸­çš„é…ç½®ï¼Œå¯¹åº”çš„æŒ‡ä»¤æ‰ä¼šç”Ÿæ•ˆã€‚</p><ul><li><p>jenkins éªŒè¯<br><img src="https://img.xxlaila.cn/1571644117201.jpg" alt="img"></p></li><li><p>gitlabéªŒè¯<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éœ€è¦å°†é¡¹ç›®å›è°ƒåœ°å€å†™å…¥åˆ°Gitlabé’©å­å½“ä¸­æ‰å¯ä»¥ã€‚ç»è¿‡æµ‹è¯•ä¸€ä¸ªpipelineçš„jobå¯ä»¥ç®¡ç†å¤šä¸ªåˆ†æ”¯çš„è§¦å‘ï¼Œé¿å…ä¹‹å‰çš„æ¯ä¸€ä¸ªåˆ†æ”¯çš„jobè¿›è¡Œè§¦å‘ã€‚</p></li></ul><h4 id="parameters-æ¨¡å—"><a href="#parameters-æ¨¡å—" class="headerlink" title="parameters æ¨¡å—"></a>parameters æ¨¡å—</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥æ¨¡å—éœ€è¦å®‰è£…ï¼ŒparametersæŒ‡ä»¤æä¾›ç”¨æˆ·åœ¨è§¦å‘Pipelineæ—¶åº”æä¾›çš„å‚æ•°åˆ—è¡¨ã€‚è¿™äº›ç”¨æˆ·æŒ‡å®šçš„å‚æ•°çš„å€¼é€šè¿‡è¯¥paramså¯¹è±¡å¯ç”¨äºPipelineæ­¥éª¤ã€‚ç ”å‘ç»å¸¸ä¼šæœ‰æ‰“å‡ºä¸€ä¸ªç‰¹æ€§åˆ†æ”¯ï¼Œè¿™ä¸ªåˆ†æ”¯ç”¨äºhotfixï¼Œè¿™ä¸ªæ—¶å€™å°±è¦ç»™ç ”å‘æäº¤ä¸€ä¸ªå¯ä»¥é€‰æ‹©çš„åˆ†æ”¯ï¼Œç„¶ä»–ä»¬å»éƒ¨ç½²åˆ°å¯¹åº”çš„ç¯å¢ƒã€‚</p><ul><li><p>å­—ç¬¦ä¸²å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥åœ¨Jenkins UIä¸Šè¾“å…¥å­—ç¬¦ä¸²ï¼Œå¸¸è§ä½¿ç”¨è¿™ä¸ªå‚æ•°çš„åœºæ™¯æœ‰ï¼Œç”¨æˆ·åï¼Œæ”¶ä»¶äººé‚®ç®±ï¼Œæ–‡ä»¶ç½‘ç»œè·¯å¾„ï¼Œä¸»æœºåç§°çš„æˆ–è€…urlç­‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    string(name: <span class="string">'DEPLOY_ENV'</span>, defaultValue: <span class="string">'staging'</span>, description: <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¸ƒå°”å€¼å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå¸ƒå°”ç±»å‹å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥åœ¨Jenkins UIä¸Šé€‰æ‹©æ˜¯è¿˜æ˜¯å¦ï¼Œé€‰æ‹©æ˜¯è¡¨ç¤ºä»£ç ä¼šæ‰§è¡Œè¿™éƒ¨åˆ†ï¼Œå¦‚æœé€‰æ‹©å¦ï¼Œä¼šè·³è¿‡è¿™éƒ¨åˆ†ã€‚ä¸€èˆ¬éœ€è¦ä½¿ç”¨å¸ƒå°”å€¼çš„åœºæ™¯æœ‰ï¼Œæ‰§è¡Œä¸€äº›ç‰¹å®šé›†æˆçš„è„šæœ¬æˆ–åˆ™å·¥ä½œï¼Œæˆ–è€…äº‹åæ¸…é™¤ç¯å¢ƒï¼Œä¾‹å¦‚æ¸…æ¥šJenkinsçš„workspaceè¿™æ ·çš„åŠ¨ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    booleanParam(name: <span class="string">'DEBUG_BUILD'</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€‰æ‹©å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€‰æ‹©ï¼ˆchoiceï¼‰çš„å‚æ•°å°±æ˜¯æ”¯æŒç”¨æˆ·ä»å¤šä¸ªé€‰æ‹©é¡¹ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªå€¼ç”¨æ¥è¡¨ç¤ºè¿™ä¸ªå˜é‡çš„å€¼ã€‚å·¥ä½œä¸­å¸¸ç”¨çš„åœºæ™¯ï¼Œæœ‰é€‰æ‹©æœåŠ¡å™¨ç±»å‹ï¼Œé€‰æ‹©ç‰ˆæœ¬å·ç­‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    choice(name: <span class="string">'ENV_TYPE'</span>, choices: [<span class="string">'dev'</span>, <span class="string">'test'</span>, <span class="string">'product'</span>], description: <span class="string">'dev env test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“ç„¶parametersæ¨¡å—æˆ‘ä»¬ç”¨çš„æœ€å¤šçš„æ˜¯åœ¨æ‰‹åŠ¨çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»è¿›è¡Œæ„å»ºéƒ¨ç½²ï¼Œè‡³äºå…¶ä»–çš„ç›®å‰æˆ‘æš‚æ—¶æœªç”¨åˆ°</p><ul><li>é€‰æ‹©åˆ†æ”¯éƒ¨ç½²<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;label <span class="string">'agent-node'</span>&#125;</span><br><span class="line">    parameters &#123;</span><br><span class="line">        gitParameter branchFilter: <span class="string">'origin/(.*)'</span>, defaultValue: <span class="string">'dev'</span>, name: <span class="string">'BRANCH'</span>, <span class="built_in">type</span>: <span class="string">'PT_BRANCH'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'gitlib code'</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                git branch:<span class="string">"<span class="variable">$&#123;params.BRANCH&#125;</span>"</span>, credentialsId:<span class="string">'gitlabUser'</span>, url: <span class="string">"http://gitlab.xxlaila.cn/xxx/kxl-eureka.git"</span></span><br><span class="line">                script &#123;</span><br><span class="line">                    build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>parameters<a href="https://wiki.jenkins.io/display/JENKINS/Git+Parameter+Plugin" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a>ï¼Œä»‹ç»å¾—æŒºè¯¦ç»†çš„ï¼Œ<a href="https://mohamicorp.atlassian.net/wiki/spaces/DOC/pages/136740885/Triggering+Jenkins+Based+on+New+Tags" target="_blank" rel="noopener">è¾…åŠ©å‚è€ƒ</a><br><img src="https://img.xxlaila.cn/1571651950634.jpg" alt="img"></p><ul><li>è¿˜å¯ä»¥å†™æˆ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    gitParameter(</span><br><span class="line">        branch: <span class="string">''</span>,</span><br><span class="line">        branchFilter: <span class="string">'origin/(.*)'</span>,</span><br><span class="line">        defaultValue: <span class="string">'dev'</span>,</span><br><span class="line">        description: <span class="string">'test code'</span>,</span><br><span class="line">        name: <span class="string">'BRANCH'</span>,</span><br><span class="line">        quickFilterEnabled: <span class="literal">false</span>,</span><br><span class="line">        selectedValue: <span class="string">'NONE'</span>,</span><br><span class="line">        sortMode: <span class="string">'NONE'</span>,</span><br><span class="line">        tagFilter: <span class="string">'*'</span>,</span><br><span class="line">        <span class="built_in">type</span>: <span class="string">'PT_BRANCH'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå½“è¿™é‡Œè®¾ç½®äº†å¯ä»¥é€‰æ‹©åˆ†æ”¯çš„æ—¶å€™ï¼Œç„¶ååœ¨ä¹‹å‰çš„è‡ªåŠ¨è§¦å‘å°±ä¼šæœ‰é—®é¢˜ï¼Œå°±æ˜¯åœ¨å»åˆ†æ”¯æ‹‰å»ä»£ç çš„æ—¶å€™å°±ä¸€åªæ˜¯devåˆ†æ”¯ï¼Œè€Œä¸æ˜¯å…¶ä»–çš„åˆ†æ”¯ï¼Œè¿™é‡Œä»ç„¶åœ¨æ¢ç´¢çš„æµ‹è¯•ä¸­ã€‚<br>ç¼–è¾‘jobå¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571903055002.jpg" alt="img"></p><h3 id="å¤šåˆ†æ”¯pipeline"><a href="#å¤šåˆ†æ”¯pipeline" class="headerlink" title="å¤šåˆ†æ”¯pipeline"></a>å¤šåˆ†æ”¯pipeline</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æŒ‰ç…§ä¸Šé¢çš„åˆè¦æ”¯æŒç”¨æˆ·å¯ä»¥é€‰æ‹©åˆ†æ”¯ï¼Œåˆè¦é€‚åˆè‡ªåŠ¨è§¦å‘åŠŸèƒ½ã€‚ç”¨å•åˆ†æ”¯pipelineæ¥ç®¡ç†é¡¹ç›®ï¼Œåˆè¦å›åˆ°æˆ‘ä»¬æœ€åˆçš„æ¨¡å¼ï¼Œè€Œåœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åˆ°å¤šåˆ†æ”¯åŒæ—¶è¿›è¡Œå¼€å‘ã€‚è¿™æ ·å°±æ»¡è¶³äº†æˆ‘ä»¬çš„å®é™…éœ€æ±‚ã€‚å¤šåˆ†æ”¯ä»»åŠ¡è¿™é‡Œä¸åšè¿‡å¤šçš„è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œé˜è¿°ä¸¤ä¸ªåŠŸèƒ½ç‚¹ï¼›åˆ†åˆ«æ˜¯åˆ†æ”¯çš„æ‰«æç­–ç•¥å’Œå­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)ã€‚</p><h4 id="åˆ†æ”¯çš„æ‰«æç­–ç•¥"><a href="#åˆ†æ”¯çš„æ‰«æç­–ç•¥" class="headerlink" title="åˆ†æ”¯çš„æ‰«æç­–ç•¥"></a>åˆ†æ”¯çš„æ‰«æç­–ç•¥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ†æ”¯æ‰«ææ˜¯jenkinsæ ¹æ®ä¸€å®šçš„ç­–ç•¥å»ä»£ç ä»“åº“æ‰«æåˆ†æ”¯ï¼Œå¦‚æœæœ‰æ–°åˆ†æ”¯å°±åˆ›å»ºä¸€ä¸ªä»¥æ–°åˆ†æ”¯å‘½åçš„ä»»åŠ¡ï¼Œå¦‚æœå‘ç°åˆ†æ”¯è¢«åˆ é™¤ï¼Œå°±åˆ é™¤å¯¹åº”çš„jenkinsä»»åŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨â€æ‰«æå¤šåˆ†æ”¯æµæ°´çº¿è§¦å‘å™¨(Scan Multibranch Pipeline Triggers)â€ä¸‹æœ‰ä¸€ä¸ª: Periodically if not otherwise runï¼ˆæ²¡æœ‰æ‰‹åŠ¨è§¦å‘ï¼Œå°±å®šæœŸæ‰«æåˆ†æ”¯ï¼‰ã€‚é€‰æ‹©æ­¤é¡¹ï¼Œè®¾ç½®ä¸€ä¸ªæ‰«æé—´éš”æ—¶é•¿ã€‚å¯ä»¥æ ¹æ®é¡¹ç›®åˆ†æ”¯çš„é¢‘ç¹ç¨‹åº¦è®¾ç½®å‘¨æœŸçš„é•¿çŸ­ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡é¡µé¢æ‰‹åŠ¨è§¦å‘jenkinsè¿›è¡Œæ‰«æã€‚<br><img src="https://img.xxlaila.cn/1571973819297.jpg" alt="img"></p><h4 id="å­¤å„¿é¡¹ç­–ç•¥-Orphaned-Item"><a href="#å­¤å„¿é¡¹ç­–ç•¥-Orphaned-Item" class="headerlink" title="å­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)"></a>å­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥åŠŸèƒ½æ˜¯åœ¨ä»£ç ä»“åº“ä¸­åˆ é™¤äº†releaseåˆ†æ”¯ï¼Œé‚£ä¹ˆåœ¨å¤šä»»åŠ¡é¡µé¢ä¸Šï¼Œè¯¥åˆ†æ”¯åœ¨jenkinsä¸Šçš„ä»»åŠ¡ä¹Ÿåº”è¯¥å¯¹åº”åˆ é™¤ã€‚ä»€ä¹ˆæ—¶å€™åˆ é™¤ï¼Œå–å†³äºä¸‹æ¬¡åˆ†æ”¯æ‰«ææ—¶é—´ã€‚å¦‚æœä»£ç ä»“åº“ä¸­çš„åˆ†æ”¯è¢«åˆ é™¤ï¼Œè€Œjenkinsä¸Šå“åº”çš„ä»»åŠ¡æ²¡æœ‰è¢«åˆ é™¤ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°±æ˜¯æ‰€è¯´çš„å­¤å„¿ä»»åŠ¡ã€‚å¯¹äºåˆ†æ”¯ä»»åŠ¡çš„å†å²è®°å½•ï¼Œä¿å­˜å¤šé•¿æ—¶é—´è®¾ç½®</p><ul><li><p>ç•Œé¢é…ç½®<br><img src="https://img.xxlaila.cn/1571974190710.jpg" alt="img"></p></li><li><p>pipeline å†™æ³•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">orphanedItemStrategy &#123;</span><br><span class="line">    discardolditems &#123;</span><br><span class="line">        daysTokeep(10)</span><br><span class="line">        numToKeep(5)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>æ³¨</strong>: è¿™é‡Œå­¤å„¿ç­–ç•¥pipeline éœ€è¦å¦å¤–ä¸€ç§æ–¹å¼æ¥æ”¯æŒï¼Œ<a href="https://gitee.com/jenkins-zh/gitlab-branch-source-plugin" target="_blank" rel="noopener">Setting up GitLab Server Configuration on Jenkins</a>ï¼Œè¿™é‡Œæ²¡æœ‰ç”¨åˆ°è¿™ä¸ªï¼Œä¸åšè¿‡å¤šçš„é˜è¿°ã€‚<a href="https://github.com/jenkinsci/job-dsl-plugin/wiki/Migration" target="_blank" rel="noopener">githubå‚è€ƒ</a></p><h3 id="å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘"><a href="#å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘" class="headerlink" title="å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘"></a>å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ†æ”¯çš„è§¦å¥½å¤„æ˜¯å¤šå¤šçš„ï¼Œè‡ªç„¶åœ¨å¤šåˆ†æ”¯é¢å‰è‡ªåŠ¨è§¦å‘è‚¯å®šä¹Ÿå°‘ä¸äº†ã€‚å¤šåˆ†æ”¯çš„è§¦å‘æœ‰ä¸¤ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯å‰é¢æåˆ°çš„Gitlab triggerå’ŒGeneric Webhook Triggerã€‚ä¸‹é¢åˆ†åˆ«å¯¹ä¸¤ç§æ¨¡å¼è¿›è¡Œé˜è¿°å’Œå®é™…çš„æµ‹è¯•</p><h4 id="Generic-Webhook-Trigger"><a href="#Generic-Webhook-Trigger" class="headerlink" title="Generic Webhook Trigger"></a>Generic Webhook Trigger</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Generic Webhook Trigger æ’ä»¶éœ€è¦æå‰å®‰è£…ï¼ŒGenericTriggerè§¦å‘æ¡ä»¶æ˜¯ç”±GWTæ’ä»¶æä¾›ï¼ŒGenericTriggerè§¦å‘çš„æ¡ä»¶åˆ†ä¸º5ä¸ªéƒ¨åˆ†ã€‚<a href="https://wiki.jenkins.io/display/JENKINS/Generic+Webhook+Trigger+Plugin" target="_blank" rel="noopener">GenericTriggerå®˜æ–¹å‚è€ƒ</a></p><ul><li>ä»HTTP POSTè¯·æ±‚ä¸­æå–å‚æ•°</li><li>tokenï¼ŒGWTæ’ä»¶ç”¨äºæ ‡è¯†jenkinsé¡¹ç›®çš„å”¯ä¸€æ€§</li><li>æ ¹æ®è¯·æ±‚å‚æ•°å€¼åˆ¤æ–­æ˜¯å¦è§¦å‘Jenkinsé¡¹ç›®æ‰§è¡Œ</li><li>æ—¥å¿—æ§åˆ¶æ‰“å°</li><li>webhookå“åº”æ§åˆ¶</li></ul><h4 id="GerenericTrigger-çš„å†™æ³•"><a href="#GerenericTrigger-çš„å†™æ³•" class="headerlink" title="GerenericTrigger çš„å†™æ³•"></a>GerenericTrigger çš„å†™æ³•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">    GenericTrigger(</span><br><span class="line">        genericVariables:[</span><br><span class="line">            [key: <span class="string">'ref'</span>, value: <span class="string">'$.ref'</span>]</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        token: env.JOB_NAME,</span><br><span class="line">        regexpFilterText: <span class="string">'$ref'</span>,</span><br><span class="line">        regexpFilterExpression: <span class="string">'refs/heads/'</span> + env.BRANCH_NAME</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env.BRANCH_NAME è¿™é‡ŒæŒ‡çš„æ˜¯åˆ†æ”¯åã€‚å½“ç„¶è¿™æ ·ä¿®æ”¹ä»¥åæ˜¯ä¸è¡Œçš„ï¼Œæ˜¯è¾¾ä¸åˆ°è‡ªåŠ¨è§¦å‘çš„ï¼Œéœ€è¦è‡ªè¡Œå»gitlabä¸Šæ·»åŠ é’©å­ï¼Œè¿™é‡Œç»è¿‡æµ‹è¯•æµç¨‹ï¼šç”¨æˆ·ä¿®æ”¹devåˆ†æ”¯ï¼Œpushåˆ°gitlab devåˆ†æ”¯å¯ä»¥è§¦å‘ä»»åŠ¡çš„devåˆ†æ”¯è‡ªåŠ¨æ„å»ºï¼›åˆå¹¶åˆ°teståˆ†æ”¯ï¼Œä¹Ÿå¯ä»¥è§¦å‘teståˆ†æ”¯è‡ªåŠ¨æ„å»ºï¼›åœ¨åˆå¹¶åˆ°masteråˆ†æ”¯ä¹Ÿèƒ½è‡ªåŠ¨è§¦å‘ä»»åŠ¡çš„masteråˆ†æ”¯è‡ªåŠ¨æ„å»ºã€‚<br><img src="https://img.xxlaila.cn/1571984557618.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è¦å®ç°è¿™å—ï¼Œè¦ç†è§£çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œé¦–å…ˆè¦çŸ¥é“gitlab push æ•°æ®çš„æ ¼å¼ï¼ŒçŸ¥é“äº†gitlab pushæ ¼å¼ï¼Œæˆ‘ä»¬æ‰çŸ¥é“åº”è¯¥æ€ä¹ˆæ“ä½œï¼Œ<a href="https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#webhooks" target="_blank" rel="noopener">gitlab pushæ•°æ®çš„æ ¼å¼å‚è€ƒ</a>ï¼Œ</p><ul><li>å‚è€ƒ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"object_kind"</span>: <span class="string">"push"</span>,</span><br><span class="line">  <span class="string">"before"</span>: <span class="string">"95790bf891e76fee5e1747ab589903a6a1f80f22"</span>,</span><br><span class="line">  <span class="string">"after"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">  <span class="string">"ref"</span>: <span class="string">"refs/heads/master"</span>,</span><br><span class="line">  <span class="string">"checkout_sha"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">  <span class="string">"user_id"</span>: 4,</span><br><span class="line">  <span class="string">"user_name"</span>: <span class="string">"John Smith"</span>,</span><br><span class="line">  <span class="string">"user_username"</span>: <span class="string">"jsmith"</span>,</span><br><span class="line">  <span class="string">"user_email"</span>: <span class="string">"john@example.com"</span>,</span><br><span class="line">  <span class="string">"user_avatar"</span>: <span class="string">"https://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=8://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=80"</span>,</span><br><span class="line">  <span class="string">"project_id"</span>: 15,</span><br><span class="line">  <span class="string">"project"</span>:&#123;</span><br><span class="line">    <span class="string">"id"</span>: 15,</span><br><span class="line">    <span class="string">"name"</span>:<span class="string">"Diaspora"</span>,</span><br><span class="line">    <span class="string">"description"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="string">"web_url"</span>:<span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"avatar_url"</span>:null,</span><br><span class="line">    <span class="string">"git_ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"git_http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"namespace"</span>:<span class="string">"Mike"</span>,</span><br><span class="line">    <span class="string">"visibility_level"</span>:0,</span><br><span class="line">    <span class="string">"path_with_namespace"</span>:<span class="string">"mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"default_branch"</span>:<span class="string">"master"</span>,</span><br><span class="line">    <span class="string">"homepage"</span>:<span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"repository"</span>:&#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"Diaspora"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"description"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"homepage"</span>: <span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"git_http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"git_ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"visibility_level"</span>:0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"commits"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327"</span>,</span><br><span class="line">      <span class="string">"message"</span>: <span class="string">"Update Catalan translation to e38cb41."</span>,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2011-12-12T14:27:31+02:00"</span>,</span><br><span class="line">      <span class="string">"url"</span>: <span class="string">"http://example.com/mike/diaspora/commit/b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327"</span>,</span><br><span class="line">      <span class="string">"author"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"Jordi Mallach"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"jordi@softcatala.org"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"added"</span>: [<span class="string">"CHANGELOG"</span>],</span><br><span class="line">      <span class="string">"modified"</span>: [<span class="string">"app/controller/application.rb"</span>],</span><br><span class="line">      <span class="string">"removed"</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">      <span class="string">"message"</span>: <span class="string">"fixed readme"</span>,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2012-01-03T23:36:29+02:00"</span>,</span><br><span class="line">      <span class="string">"url"</span>: <span class="string">"http://example.com/mike/diaspora/commit/da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">      <span class="string">"author"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"GitLab dev user"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"gitlabdev@dv6700.(none)"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"added"</span>: [<span class="string">"CHANGELOG"</span>],</span><br><span class="line">      <span class="string">"modified"</span>: [<span class="string">"app/controller/application.rb"</span>],</span><br><span class="line">      <span class="string">"removed"</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"total_commits_count"</span>: 4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸åŒçš„åˆ†æ”¯æäº¤æ¥è§¦å‘jenkinsçš„æ„å»ºï¼Œé‚£å°±åº”è¯¥çŸ¥é“postæ•°æ®å“ªä¸€ä¸ªå±æ€§ä»£è¡¨äº†ä¸åŒçš„åˆ†æ”¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¬¬å››è¡Œçœ‹åˆ°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">"ref"</span>: <span class="string">"refs/heads/master"</span>,</span><br></pre></td></tr></table></figure><p><strong>æ³¨é‡Š</strong>: ä¹Ÿå¯ä»¥é€šè¿‡IDEAå·¥å…·æäº¤çš„æ—¶å€™çœ‹åˆ°æäº¤çš„é€‰é¡¹ã€‚å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”¨refå¯ä»¥å¾ˆå¥½çš„åŒºåˆ†ä¸åŒåˆ†æ”¯ï¼Œè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆè¦å¡«å†™refçš„åŸå› ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡pipelineä»£ç çš„ç”Ÿæˆå™¨æ¥ç”Ÿæˆ</p><ul><li>pipeline ä»£ç ç”Ÿæˆå™¨<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">  GenericTrigger causeString: <span class="string">'Generic Cause'</span>, genericVariables: [[defaultValue: <span class="string">''</span>, key: <span class="string">'ref'</span>, regexpFilter: <span class="string">''</span>, value: <span class="string">'$.ref'</span>]], printContributedVariables: <span class="literal">true</span>, printPostContent: <span class="literal">true</span>, regexpFilterExpression: <span class="string">'\'</span>refs/heads/\<span class="string">' + evn.BRANCH_NAME'</span>, regexpFilterText: <span class="string">'$ref'</span>, token: <span class="string">'env.JOB_NAME'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1571982583457.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571982622070.jpg" alt="img"></p><p><strong>æ³¨</strong>: tokenå‚æ•°çš„ä½œç”¨æ˜¯æ ‡è¯†ä¸€ä¸ªpipelineåœ¨jenkinsä¸­çš„å”¯ä¸€æ€§ï¼Œè¿™ä¸ªå‚æ•°çš„é‡è¦æ€§å°±å¾—æèµ·GWTæ’ä»¶çš„åŸç†ã€‚å½“jenkinsæ”¶åˆ°generic-webhook-trgger/invokeæ¥å£çš„è¯·æ±‚æ—¶ï¼Œä¼šå°†è¯·æ±‚ä»£ç†ç»™GWTæ’ä»¶å¤„ç†ï¼ŒGWTæ’ä»¶å†…å®¹ä¼šä»jenkinså®ä¾‹å¯¹è±¡ä¸­å–å‡ºæ‰€æœ‰çš„å‚æ•°åŒ–jenkinsé¡¹ç›®ï¼ŒåŒ…æ‹¬pipelineï¼Œç„¶åè¿›è¡Œéå†ã€‚å¦‚æœæˆ‘ä»¬åœ¨å‚æ•°åŒ–é¡¹ç›®ä¸­Generic Triggeré…ç½®tokençš„å€¼ä¸webhookè¯·æ±‚æ—¶çš„tokenä¸€è‡´ï¼Œå°±ä¼šè§¦å‘æ”¹é¡¹ç›®ã€‚å¦‚æœå¤šä¸ªå‚æ•°åŒ–é¡¹ç›®çš„tokenä¸€æ ·ï¼Œåˆ™éƒ½ä¼šè¿›è¡Œè§¦å‘ï¼Œæ‰€ä»¥è¿™é‡Œçš„tokenæœ€å¥½æ—¶JOB_NAMEé¡¹ç›®åï¼Œå› ä¸ºè¿™ä¸ªæ˜¯åœ¨é¡¹ç›®æˆ–è€…æ˜¯åœ¨ä¸ºæœåŠ¡é¢†åŸŸä»–éƒ½æ˜¯å”¯ä¸€çš„ã€‚</p><ul><li>å‚æ•°ä»‹ç»:<ul><li>regexpFilterText: éœ€è¦è¿›è¡ŒåŒ¹é…çš„keyï¼Œä¾‹å­ä¸­ï¼Œä½¿ç”¨ä»post bodyä¸­æå–çš„refå˜é‡å€¼ã€‚</li><li>regexpFilterExpression: <a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html" target="_blank" rel="noopener">æ­£åˆ™è¡¨è¾¾å¼</a>ï¼›å¦‚æœregexpFilterTextå‚æ•°ç¬¦åˆregexpFilterExpressionå‚æ•°çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ™è§¦å‘æ‰§è¡Œã€‚</li><li>printPostContent: å¸ƒå°”å€¼ï¼Œå°†webhookè¯·æ±‚ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—ä¸Š</li><li>printContributedVariables: å¸ƒå°”å€¼ï¼Œå°†æå–åçš„å˜é‡ååŠå˜é‡å€¼æ‰“å°å‡ºæ¥</li><li>causeString: å­—ç¬¦ä¸²å‹ï¼Œè§¦å‘åŸå› ï¼Œå¯ä»¥ç›´æ¥åº”ç”¨æå–åçš„å˜é‡ï¼Œå¦‚ causeString: â€˜Triggered on $msgâ€™</li><li>Silent response: å¸ƒå°”å‹ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“webhookè¯·æ±‚æˆåŠŸåï¼ŒGWTæ’ä»¶ä¼šè¿”å›HTTP 200çŠ¶æ€ç å’Œè§¦å‘ç»“æœç»™å¯¹æ–¹è°ƒç”¨ï¼Œä½†æ˜¯å½“Silentresponseè®¾ç½®ä¸ºtrueæ—¶ï¼Œå°±åªè¿”å›HTTP 200çŠ¶æ€ç ï¼Œä¸åæ‚”è§¦å‘ç»“æœ</li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢çš„çœ‹çš„å‡ºæ¥ï¼Œæˆ‘ä»¬åªè¦æ˜¯æäº¤äº†åˆ†æ”¯éƒ½å¯ä»¥è¿›è¡Œè§¦å‘æ„å»ºï¼Œä½†æ˜¯å‘¢ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†devâ€”â€”&gt;testâ€”â€”master åˆ†æ”¯ï¼Œå°±æ˜¯åªæƒ³è¦è¿™å‡ ä¸ªè¿›è¡Œè§¦å‘æ„å»ºï¼Œå…¶ä»–çš„ä¸è¿›è¡Œè§¦å‘ï¼Œè®©å¼€å‘è‡ªå·±å»ç‚¹å‡»ã€‚</p><ul><li><p>æŒ‡å®šåˆ†æ”¯æ„å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">  GenericTrigger causeString: <span class="string">'Triggered on $msg'</span>, genericVariables: [[defaultValue: <span class="string">''</span>, key: <span class="string">'ref'</span>, regexpFilter: <span class="string">''</span>, value: <span class="string">'$.ref'</span>]], printContributedVariables: <span class="literal">true</span>, printPostContent: <span class="literal">true</span>, regexpFilterExpression: <span class="string">'\'</span>refs/heads/(dev|<span class="built_in">test</span>|master)\<span class="string">''</span>, regexpFilterText: <span class="string">'$ref'</span>, token: <span class="string">'env.JOB_NAME'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¤šåˆ†æ”¯Gitlab trigger<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤šåˆ†æ”¯çš„Gitlab triggerå’Œæˆ‘ä»¬å‰é¢ä»‹ç»çš„gitlabäº‹ä»¶è§¦å‘ä¸€æ ·çš„ï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œè¿™é‡Œæˆ‘æµ‹è¯•äº†ä¸€ä¸ªjobï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚åŒæ—¶æ–°å»ºäº†ä¸€ä¸ªåˆ†æ”¯ï¼Œjenkinsä¼šè‡ªåŠ¨çš„æ‰«ææ–°å»ºä¸€ä¸ªä»¥åˆ†æ”¯ä¸ºåçš„ä»»åŠ¡ï¼Œè¿›è¡Œè‡ªåŠ¨è§¦å‘ã€‚å½“æˆ‘åˆ é™¤äº†æŸä¸€ä¸ªåˆ†æ”¯ï¼Œå°±ä¼šè§¦å‘è‡ªåŠ¨æ‰«æï¼Œç„¶åæŸ¥çœ‹åˆ†æ”¯ä¸ºåˆ é™¤ã€‚</p></li><li><p>åˆ é™¤åˆ†æ”¯<br><img src="https://img.xxlaila.cn/1571996378764.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571996257688.jpg" alt="img"></p></li><li><p>æ•´ä½“æ•ˆæœå›¾<br><img src="https://img.xxlaila.cn/1571990331005.jpg" alt="img"></p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä»‹ç»ä¸€ä¸‹éƒ¨ç½²è¿™å—ï¼Œæ ¹æ®branchæ¥è¿›è¡Œåˆ¤æ–­ï¼Œä¸åŒçš„branchéƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒï¼Œå½“è®¾å®šçš„å€¼ä¸åœ¨branchèŒƒå›´å†…ï¼Œå°±éœ€è¦äººä¸ºçš„åˆ¶å®šéƒ¨ç½²ç¯å¢ƒã€‚å½“äººå‘˜ä¸‰åˆ†é’Ÿå†…æ²¡æœ‰æ¥è¿›è¡Œç¯å¢ƒéƒ¨ç½²çš„é€‰æ‹©ï¼Œç³»ç»Ÿå°±ä¼šæ–­å¼€ï¼Œå¯¹è¯¥åˆ†æ”¯æ ‡è®°ä¸ºç»“æŸã€‚</p><p><a href="http://xxlaila.github.io/2019/10/25/pipeline%E5%A4%9A%E5%88%86%E6%94%AFgitlab%E8%A7%A6%E5%8F%91/" target="_blank" rel="noopener">å®Œæ•´æ–‡ä»¶</a><br><a href="https://jenkinsci.github.io/job-dsl-plugin/#path/buildPipelineView" target="_blank" rel="noopener">æ¨èå­¦ä¹ å‚è€ƒåœ°å€</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>elasticserch</title>
    <url>/2019/10/17/elasticserch%E6%97%A5%E5%B8%B8%E7%BB%B4%E6%8A%A4/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="days-1"><a href="#days-1" class="headerlink" title="days 1"></a>days 1</h3><a id="more"></a><h4 id="elasticserch-ç´¢å¼•å’Œæ•°æ®æ“ä½œ"><a href="#elasticserch-ç´¢å¼•å’Œæ•°æ®æ“ä½œ" class="headerlink" title="elasticserch ç´¢å¼•å’Œæ•°æ®æ“ä½œ"></a>elasticserch ç´¢å¼•å’Œæ•°æ®æ“ä½œ</h4><ul><li><p>æŸ¥çœ‹ç´¢å¼•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/indices?v'</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ç´¢å¼•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/indices?v' |grep "red"|awk '&#123;print $3&#125;'|uniq &gt;l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in `cat a`;do  curl -XDELETE http://127.0.0.1:9200/$&#123;i&#125;;done</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹shards</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET http://127.0.0.1:9200/_cat/shards</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shards æœ‰å‡ ç§ç±»å‹ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹<code>UNASSIGNED</code>ï¼Œes é›†ç¾¤é‡Œé¢çš„åˆ†ç‰‡æ˜¯åˆ†é…åœ¨å¤šå°nodeä¸Šçš„ï¼Œä¸ºçš„å°±æ˜¯é«˜å¯ç”¨ï¼Œæ¯”å¦‚ä½ çš„æŸå°æœºå™¨crashäº†ï¼Œé‚£ä¹ˆé›†ç¾¤å°±ä¼šè®©å…¶ä»–å‰¯æœ¬é¡¶ä¸Šæ¥ï¼Œé¿å…å‡ºç°æŸä¸ªåˆ†ç‰‡ä¸èƒ½æä¾›æœåŠ¡çš„æƒ…å†µï¼Œä½†æ˜¯éš¾å…è¿˜æ˜¯ä¼šå‡ºç° UNASSIGNED shards çš„é”™è¯¯ã€‚</p><ul><li>åˆ é™¤shards UNASSIGNED<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/shards'|grep "UNASSIGNED"|awk '&#123;print $1&#125;'|uniq &gt;l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in `cat l`;do curl -XDELETE http://127.0.0.1:9200/$i;done</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="elasticserchéªŒè¯é›†ç¾¤"><a href="#elasticserchéªŒè¯é›†ç¾¤" class="headerlink" title="elasticserchéªŒè¯é›†ç¾¤"></a>elasticserchéªŒè¯é›†ç¾¤</h4><ul><li><p>é›†ç¾¤ç›¸å…³API</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat</span><br><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/tasks</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br><span class="line">/_cat/count</span><br><span class="line">/_cat/count/&#123;index&#125;</span><br><span class="line">/_cat/recovery</span><br><span class="line">/_cat/recovery/&#123;index&#125;</span><br><span class="line">/_cat/health</span><br><span class="line">/_cat/pending_tasks</span><br><span class="line">/_cat/aliases</span><br><span class="line">/_cat/aliases/&#123;<span class="built_in">alias</span>&#125;</span><br><span class="line">/_cat/thread_pool</span><br><span class="line">/_cat/thread_pool/&#123;thread_pools&#125;</span><br><span class="line">/_cat/plugins</span><br><span class="line">/_cat/fielddata</span><br><span class="line">/_cat/fielddata/&#123;fields&#125;</span><br><span class="line">/_cat/nodeattrs</span><br><span class="line">/_cat/repositories</span><br><span class="line">/_cat/snapshots/&#123;repository&#125;</span><br><span class="line">/_cat/templates</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤åç§°ç­‰ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"elk_elasticsearch_data_2"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elk_elasticsearch"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"T47wQwa6TT-6MHJVFM40Tw"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"6.4.0"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"rpm"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"595516e"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2018-08-17T23:18:47.308994Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"7.4.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"5.6.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"5.0.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/nodes?v</span><br><span class="line">ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">172.21.16.198           29          85   0    0.10    0.04     0.05 mdi       -      elk_elasticsearch_data_2</span><br><span class="line">172.21.16.187           48          85   0    0.00    0.01     0.05 mdi       *      elk_elasticsearch_master</span><br><span class="line">172.21.16.206           25          86   0    0.08    0.03     0.05 mdi       -      elk_elasticsearch_data_3</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯é›†ç¾¤ç£ç›˜åˆ†é…æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/allocation?v</span><br><span class="line">shards disk.indices disk.used disk.avail disk.total disk.percent host          ip            node</span><br><span class="line">    98          1gb     3.6gb     96.3gb     99.9gb            3 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2</span><br><span class="line">    99      887.1mb     4.5gb     95.4gb     99.9gb            4 172.21.16.187 172.21.16.187 elk_elasticsearch_master</span><br><span class="line">    99        957mb     3.5gb     96.4gb     99.9gb            3 172.21.16.206 172.21.16.206 elk_elasticsearch_data_3</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯é›†ç¾¤å¥åº·çŠ¶å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/health?v </span><br><span class="line">epoch      timestamp cluster           status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1571648406 17:00:06  elk_elasticsearch green           3         3    296 148    0    0        0             0                  -                100.0%</span><br><span class="line"></span><br><span class="line">$</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ä¸Šè¢«fielddataæ‰€ä½¿ç”¨çš„å †å†…å­˜å¤§å°ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/fielddata?v</span><br><span class="line">id                     host          ip            node                     field                    size</span><br><span class="line">VNcRqM30T3axzVjiPkDTmA 172.21.16.187 172.21.16.187 elk_elasticsearch_master event.resultCode.keyword 352b</span><br><span class="line">VNcRqM30T3axzVjiPkDTmA 172.21.16.187 172.21.16.187 elk_elasticsearch_master <span class="built_in">type</span>                     720b</span><br><span class="line">HNc5BrMWQcummBeAskQc4A 172.21.16.206 172.21.16.206 elk_elasticsearch_data_3 event.resultCode.keyword 704b</span><br><span class="line">z3zUA8KxTH6B7C8CmVRUIQ 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2 <span class="built_in">type</span>                     720b</span><br><span class="line">z3zUA8KxTH6B7C8CmVRUIQ 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2 event.resultCode.keyword 704b</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>elasticserch</category>
      </categories>
      <tags>
        <tag>elasticserch</tag>
      </tags>
  </entry>
  <entry>
    <title>nexusé…ç½®ldap</title>
    <url>/2019/10/15/nexus%E9%85%8D%E7%BD%AEldap/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="é…ç½®nexus"><a href="#é…ç½®nexus" class="headerlink" title="é…ç½®nexus"></a>é…ç½®nexus</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•nexusåœ¨è®¾ç½®é¡µï¼Œç‚¹å‡»ldapï¼Œ</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1571131890608.jpg" alt="img"><br>å‚æ•°ä»‹ç»:</p><ul><li>Name: éšä¾¿å†™</li><li>LDAP server address: æ”¯æŒldapså’Œldap,è€Œç«¯å£åˆ™å–å†³äºé…ç½®ã€‚ å¦‚æœæ²¡æœ‰ç‰¹æ®Šé…ç½®ï¼Œldapé»˜è®¤ç«¯å£æ˜¯389</li><li>Search base: åªéœ€è¦å¡«DCå³å¯ï¼Œæ¯”å¦‚DC=example,DC=comã€‚ å…¶å®ƒå†…å®¹ï¼Œæ¯”å¦‚CNã€OUç­‰ï¼Œä¸éœ€è¦å¡«å†™</li><li>Authentication methodæœ‰ä»¥ä¸‹é€‰é¡¹:<ul><li>Simple Authentication</li><li>Anonymous Authentication</li><li>DIGEST-MD5</li><li>CRAM-MD5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šå¸¸é€‰æ‹©Simple Authenticationå³å¯ã€‚Username or DNã€Passwordé‡Œå¡«å†™è´¦æˆ·ã€å¯†ç ï¼Œè€Œ Connection rulesæ— éœ€ä¿®æ”¹ã€‚å¡«å†™å®Œæ¯•åï¼Œç‚¹å‡»ã€Verify connectionã€‘æŒ‰é’®ï¼Œå¯ä»¥éªŒè¯ä¿¡æ¯ã€‚ å¦‚æœæˆåŠŸï¼Œå³å¯ä¿å­˜ã€‚</li></ul></li></ul><h4 id="Choose-Users-and-Groups"><a href="#Choose-Users-and-Groups" class="headerlink" title="Choose Users and Groups"></a>Choose Users and Groups</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é¡¹æ•…åæ€ä¹‰å°±æ˜¯é…ç½®ç”¨æˆ·å’Œç»„çš„ï¼Œåœ¨æœ€å¼€å¤´çš„Configuration templateä¸­ï¼Œæœ‰å››ç§æ¨¡æ¿å¯é€‰ï¼š</p><ul><li>Active Directory</li><li>Generic Ldap Server</li><li>Posix with Dynamic Groups</li><li>Posix with Static Groups</li></ul><p>è¿™é‡Œé€‰æ‹©<code>Generic Ldap Server</code></p><ul><li>Base DN åœ¨LDAPä¸­æ‰¾åˆ°ç”¨æˆ·çš„åŸºæœ¬ä½ç½®ã€‚è¿™æ˜¯ç›¸å¯¹äºæœç´¢åŸºç¡€çš„ï¼ˆä¾‹å¦‚ou = peopleï¼‰ã€‚</li><li>User subtreeé€šå¸¸éœ€è¦å‹¾é€‰ã€‚ å¦‚æœæŠŠLDAPçš„Treeæ¯”ä½œç›®å½•çš„è¯ï¼Œå‹¾é€‰ä»¥åç›¸å½“äºé€’å½’æŸ¥æ‰¾å­ç›®å½•ã€‚</li><li>User filteré€šè¿‡è¿‡æ»¤è§„åˆ™ï¼Œå‡å°‘æœç´¢ä¿¡æ¯ï¼Œç”¨äºæå‡æ€§èƒ½ã€‚ ä»…ä»…åªæ˜¯æå‡æ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä¸æ‡‚å®ƒç‰¹æ®Šçš„åŒ¹é…è§„åˆ™ï¼Œä¹Ÿå¯ä»¥ä¸å¡«ã€‚</li><li>ä¹‹å‰é€‰æ‹©äº†<code>Generic Ldap Server</code>æ¨¡ç‰ˆåï¼ŒUser ID attributeé»˜è®¤ä¸ºuidï¼ŒReal name attributeé»˜è®¤ä¸ºcnã€Email attributeé»˜è®¤ä¸ºmailã€Password attributeä¸ºç©ºã€‚</li><li>Map LDAP groups as roleså¦‚æœä¸å‹¾é€‰ï¼Œå°±ä¸ä¼šåŒæ­¥ç”¨æˆ·ç»„ä¿¡æ¯ã€‚ å¦‚æœå‹¾é€‰ï¼Œåˆ™å¯ä»¥é€‰æ‹©Group typeå’ŒGroup member of attributeã€‚ è‹¥æ— å¿…è¦ï¼Œä¿æŒé»˜è®¤å³å¯ï¼Œé»˜è®¤æ˜¯å‹¾é€‰çš„ã€‚<br><img src="https://img.xxlaila.cn/1571133103461.jpg" alt="img"></li><li>å¡«å†™å®Œæˆåï¼Œé€šè¿‡ã€Verify user mappingã€‘å¯ä»¥éªŒè¯æŸ¥è¯¢ç»“æœ<br><img src="https://img.xxlaila.cn/1571133221971.jpg" alt="img"><br>ç‚¹å‡»åˆ›å»º<br><img src="https://img.xxlaila.cn/1571133286829.jpg" alt="img"></li></ul><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°èµ·ä¸€ä¸ªçª—å£åˆ©ç”¨ldapé‡Œé¢çš„è´¦å·è¿›è¡Œç™»å½•ï¼Œå¯ä»¥ç™»å½•ï¼Œæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ç™»å½•ä¹‹åç”¨æˆ·æ²¡æœ‰ä»»ä½•æƒé™ï¼Œè¿™å¯¹äºç ”å‘æ¥è¯´åˆæ˜¯ä¸€ä¸ªä¸å¯æ¥å—çš„äº‹æƒ…ã€‚æ¥ä¸‹æ¥é…ç½®æƒé™</p><h5 id="ç¦æ­¢åŒ¿åè®¿é—®"><a href="#ç¦æ­¢åŒ¿åè®¿é—®" class="headerlink" title="ç¦æ­¢åŒ¿åè®¿é—®"></a>ç¦æ­¢åŒ¿åè®¿é—®</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ˜¯ä¸å…è®¸åŒ¿åç”¨æˆ·ä¸å¯ä»¥ç™»å½•å°±èƒ½è®¿é—®çš„ï¼Œè¿™æ ·æˆ‘ä»¬ldapå°±æ²¡æœ‰ä»»ä½•æ„ä¹‰äº†<br><img src="https://img.xxlaila.cn/1571133691247.jpg" alt="img"></p><ul><li>ç¦æ­¢åŒ¿åç”¨æˆ·<br><img src="https://img.xxlaila.cn/1571133811908.jpg" alt="img"></li></ul><h5 id="åˆ›å»ºè§’è‰²"><a href="#åˆ›å»ºè§’è‰²" class="headerlink" title="åˆ›å»ºè§’è‰²"></a>åˆ›å»ºè§’è‰²</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨Securityâ€”â€”&gt;Rolesâ€”â€”&gt;Create roleï¼Œè¿™é‡Œåˆ›å»ºè§’è‰²æœ‰ä¸¤ç§ã€‚ä¸€ç§æ˜¯nexus relosæœ¬åœ°è§’è‰²ï¼Œä¸€ç§æ˜¯External roles mappingå¤–éƒ¨æ˜ å°„çš„å½¢å¼ã€‚ä¸ºäº†æ»¡è¶³æˆ‘ä»¬ldapè´¦æˆ·ç™»å½•è¿›æ¥æœ‰æµè§ˆåº“çš„æƒé™ï¼Œç ”å‘åˆå¯ä»¥ä¸Šä¼ ç¬¬ä¸‰æ–¹ä¾èµ–åº“çš„æƒé™ï¼Œä½†æ˜¯ä¸èƒ½åˆ é™¤å’Œç§ä¸‹å¢åŠ åº“Repositoriesã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å•ç‹¬å»ºç«‹ä¸€ä¸ªæœ¬åœ°çš„relosï¼Œç„¶ååœ¨æ˜ å°„å¤–éƒ¨çš„ldapåˆ°è¿™ä¸ªæœ¬åœ°çš„rolesï¼Œè¿™æ ·ldapè´¦æˆ·ç™»å½•è¿›æ¥å°±èƒ½å®ç°æ—¥å¸¸çš„åŸºæœ¬æ“ä½œã€‚</p><ul><li><p>åˆ›å»ºnexus relosæœ¬åœ°è§’è‰²<br><img src="https://img.xxlaila.cn/1571296771150.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä»–èµ‹äºˆæƒé™ï¼Œå¯¹ç”¨æˆ·è¿›è¡Œæƒé™æ§åˆ¶ï¼Œæ²¡æœ‰æƒé™æ§åˆ¶ï¼Œå°±æ²¡åŠæ³•è¾¾æˆæˆ‘ä»¬ä¸Šé¢çš„ç›®æ ‡ã€‚ä¸‹é¢æ˜¯æˆ‘èµ‹äºˆçš„æƒé™ï¼Œå¯ä»¥ç»“åˆå®é™…éœ€æ±‚æ¥è¿›è¡Œèµ‹äºˆã€‚</p></li><li><p>æƒé™ä»‹ç»:</p><ul><li>ng-component-upload: æœ‰ä¸Šä¼ çš„æƒé™ï¼Œæ¯”å¦‚javaä¾èµ–çš„ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œç ”å‘å¯ä»¥è‡ªå·±è¿›è¡Œä¸Šä¼ </li><li>ng-repository-admin-<em>-</em>-browse: æµè§ˆæ‰€æœ‰çš„repository</li><li>ng-repository-admin-<em>-</em>-read: å¯ä»¥æ‰€æœ‰è¯»å–repositoryçš„é…ç½®ä¿¡æ¯</li><li>ng-repository-view-maven2-maven-central-browse: å…·æœ‰æµè§ˆmaven-centralå†…å®¹</li><li>ng-repository-view-maven2-maven-central-read: è¯»å–maven-centralå†…å®¹ï¼Œåœ¨mavenç¼–è¯‘çš„æ—¶å€™å…·æœ‰ä¸‹è½½çš„æƒé™ï¼Œ(åé¢ä¸ä¸€ä¸€ä»‹ç»)</li><li>ng-repository-view-maven2-maven-public-browse</li><li>ng-repository-view-maven2-maven-public-read</li><li>ng-repository-view-maven2-maven-releases-browse</li><li>ng-repository-view-maven2-maven-releases-read</li><li>ng-repository-view-maven2-maven-snapshots-browse</li><li>ng-repository-view-maven2-maven-snapshots-read</li><li>ng-repository-view-npm-npm-kxl-all-browse: ä»¥ä¸‹æ˜¯è‡ªå·±åšçš„npmä»£ç†ç¼“å­˜ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://xxlaila.github.io/2019/08/23/nexus3æ­å»ºnpmç§æœ/" target="_blank" rel="noopener">nexus3æ­å»ºnpmç§æœ</a></li><li>ng-repository-view-npm-npm-kxl-all-read</li><li>ng-repository-view-npm-npm-external-browse</li><li>ng-repository-view-npm-npm-external-read</li><li>ng-repository-view-npm-npm-internal-browse</li><li>ng-repository-view-npm-npm-internal-read</li><li>ng-search-read: è®©ç”¨æˆ·å…·æœ‰æ‰€æœ‰æƒé™ï¼Œæ²¡æœ‰æ­¤æƒé™ï¼Œç ”å‘æŸ¥æ‰¾ä¸€ä¸ªåŒ…ï¼Œä¼°è®¡ä¼šæ­»</li></ul></li><li><p>åˆ›å»ºæ˜¯External roles mappingå¤–éƒ¨æ˜ å°„<br><img src="https://img.xxlaila.cn/1571134166780.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571297568491.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¿›è¡ŒRoles ID è¿™æ ç›®ï¼Œéœ€è¦å¡«å†™çš„æ˜¯Usersï¼Œè¿™ä¸ªUsersä¼šåœ¨ldapä¸ŠåŒæ­¥Usersçš„ä¸€ä¸ªç”¨æˆ·ç»„ã€‚æ ¹æ®è‡ªå·±çš„ldapè´¦æˆ·ç»„è®¾ç½®æ¥è¿›è¡Œå¡«å†™ã€‚ä¸‹å›¾æ˜¯ldapçš„ç»„è®¾ç½®<br><img src="https://img.xxlaila.cn/1571298567078.jpg" alt="img"></p></li></ul><p><strong>æ³¨</strong>: å…¶å®åœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›è¡ŒPrivilegesçš„æƒé™èµ‹äºˆï¼Œä½†æ˜¯æˆ‘é€‰æ‹©çš„æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªæœ¬åœ°çš„nexus relosã€‚ç„¶åæˆ‘ä»¬åœ¨Rolesæ å…³è”ä¹‹å‰åˆ›å»ºçš„<code>Developer</code>ï¼Œå®Œæˆä»¥åé€šè¿‡ldapè´¦æˆ·ç™»å½•è¿›è¡Œæµ‹è¯•</p><h5 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä¸»è¦æ˜¯ä»å››ä¸ªæ–¹é¢æ¥æµ‹è¯•ldapè´¦æˆ·ã€‚åˆ†åˆ«æ˜¯: ç™»å½•é»˜è®¤çš„æƒé™ã€æµè§ˆæ‰€æœ‰åº“çš„æƒé™ã€Browseçš„æµè§ˆã€Browseåº“çš„ä¸Šä¼ </p><ul><li><p>ç™»å½•é»˜è®¤çš„æƒé™<br><img src="https://img.xxlaila.cn/1571297962563.jpg" alt="img"></p></li><li><p>æµè§ˆæ‰€æœ‰åº“çš„æƒé™<br><img src="https://img.xxlaila.cn/1571298121188.jpg" alt="img"></p></li><li><p>Browseçš„æµ<br><img src="https://img.xxlaila.cn/1571298018356.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571298167348.jpg" alt="img"></p></li><li><p>Browseåº“çš„ä¸Šä¼ <br><img src="https://img.xxlaila.cn/1571298224331.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571298260091.jpg" alt="img"></p></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nexus</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsé…ç½®å¤‡ä»½</title>
    <url>/2019/10/15/jenkins%E9%85%8D%E7%BD%AE%E5%A4%87%E4%BB%BD/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="jenkins-å¤‡ä»½"><a href="#jenkins-å¤‡ä»½" class="headerlink" title="jenkins å¤‡ä»½"></a>jenkins å¤‡ä»½</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“jenkinsåœ¨ç”¨èµ·æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éš¾ä¿ä»–ä¸ä¼šå‡ºæ•…éšœï¼Œä½†æ˜¯å‡ºäº†æ•…éšœæˆ‘ä»¬æ€ä¹ˆåšåˆ°å¿«é€Ÿçš„æ¢å¤å‘¢ï¼Œè¿™æ—¶å¤‡ä»½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚ä½†jenkinsæœ¬èº«ä¸æä¾›å¤‡ä»½çš„åŠŸèƒ½ï¼Œ<a id="more"></a> æ‰€ä»¥è¿™é‡Œå°±éœ€è¦å€ŸåŠ©å¤–åŠ›ã€‚å¤‡ä»½å¯ä»¥å¤šæ ·åŒ–ï¼Œä¸€ç§æ˜¯æˆ‘ä»¬ç›´æ¥åˆ°jenkinsçš„ç›®å½•ä¸‹é¢æ‰‹åŠ¨å¤‡ä»½jenkinsç›®å½•ã€‚ä¸€ç§æ˜¯æˆ‘ä»¬å°±jenkinsè‡ªå¸¦çš„æ’ä»¶<code>thinBackup</code>å’Œ<code>Periodic Backup</code>è¿›è¡Œå¤‡ä»½æ¢å¤ï¼Œä¸‹é¢è¿›è¡Œåˆ†åˆ«ä»‹ç»</p><h3 id="thinBackupå¤‡ä»½"><a href="#thinBackupå¤‡ä»½" class="headerlink" title="thinBackupå¤‡ä»½"></a>thinBackupå¤‡ä»½</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;æ’ä»¶ç®¡ç†<br><img src="https://img.xxlaila.cn/1571101180571.jpg" alt="img"><br>å®‰è£…å®Œæˆä¹‹åé‡å¯jenkinsæœåŠ¡ï¼Œç™»å½•jenkinsåœ¨ç³»ç»Ÿç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571101557754.jpg" alt="img"></p><h4 id="é…ç½®ThinBackup"><a href="#é…ç½®ThinBackup" class="headerlink" title="é…ç½®ThinBackup"></a>é…ç½®ThinBackup</h4><ul><li>ç‚¹å‡»ThinBackup<br><img src="https://img.xxlaila.cn/1571101640273.jpg" alt="img"><br>å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªé€‰é¡¹:</li><li>Backup Now: æ‰‹åŠ¨ç«‹å³å¤‡ä»½</li><li>Restore: æ¢å¤å¤‡ä»½</li><li>Settings: å¤‡ä»½å‚æ•°çš„è®¾ç½®</li></ul><h5 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹é¢æ˜¯æˆ‘çš„å¤‡ä»½å‚æ•°ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è‡ªå·±è®¾å®šå¤‡ä»½å‚æ•°ï¼Œè®¾ç½®å¥½å‹saveå³å¯ï¼Œ<code>Backup schedule for full backups</code>æ„æ€æ˜¯å‘¨ä¸€åˆ°å‘¨äº”æ¯å¤©å‡Œæ™¨ä¸¤ç‚¹è¿›è¡Œå¤‡ä»½<br><img src="https://img.xxlaila.cn/1571102057919.jpg" alt="img"></p><h5 id="Restore"><a href="#Restore" class="headerlink" title="Restore"></a>Restore</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤‡ä»½æ–‡ä»¶æ˜¯ä»¥æ—¥æœŸ+æ—¶é—´èŠ‚ç‚¹ç»„æˆçš„æ–‡ä»¶åï¼Œæˆ‘ä»¬æ¢å¤ä»€ä¹ˆæ—¶é—´æ®µçš„ï¼Œç‚¹å‡»è¿›è¡Œæ¢å¤ï¼Œ<br><img src="https://img.xxlaila.cn/1571102188007.jpg" alt="img"></p><h3 id="Periodic-Backup"><a href="#Periodic-Backup" class="headerlink" title="Periodic Backup"></a>Periodic Backup</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤‡ä»½é™¤äº†ä¸Šé¢æåˆ°çš„æ’ä»¶è¿˜æœ‰ä¸€ä¸ªæ’ä»¶æ˜¯<code>Periodic Backup</code>ï¼Œå®‰è£…<code>Periodic Backup</code>ä¸é˜è¿°ï¼Œå®‰è£…å®Œæˆåå¯ä»¥åœ¨ç³»ç»Ÿç®¡ç†èœå•ä¸‹é¢æœ‰ä¸€ä¸ª<code>Periodic Backup Manager</code>èœå•<br><img src="https://img.xxlaila.cn/1571709136813.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰“å¼€<code>Periodic Backup Manager</code>ï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€æ˜¯æ²¡æœ‰ä»»ä½•ä¸œè¥¿çš„ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å»å»ºç«‹ä¸€ä¸ªè§„åˆ™ï¼Œç‚¹å‡»<code>Configure</code><br><img src="https://img.xxlaila.cn/1571709270639.jpg" alt="img"></p><p>é…ç½®é¡¹å¾ˆç®€å•:</p><ul><li>Temporary Directory: ä¸´æ—¶ç›®å½•</li><li>Backup schedule (cron): è¿›è¡Œå¤‡ä»½cronçš„è¡¨è¾¾å¼ï¼Œå¡«å†™å®Œæˆåç‚¹å‡»<code>Validate cron syntax</code>è¿›è¡ŒéªŒè¯</li><li>Maximum backups in location: æœ€å¤§ä½ç½®å¤‡ä»½ï¼Œä¿ç•™å¤šå°‘ä¸ªå¤‡ä»½æ–‡ä»¶</li><li>Store no older than (days): ä¿ç•™çš„æ—¶é—´</li><li>File Management Strategy: å¤‡ä»½ç­–ç•¥<ul><li>ConfigOnly: åªå¤‡ä»½é…ç½®æ–‡ä»¶</li><li>FullBackup: è¿›è¡Œå…¨é‡å¤‡ä»½ï¼Œå¯ä»¥é€šè¿‡Excludes listä¸­å¡«å…¥Anté£æ ¼è¡¨è¾¾å¼ï¼Œæ’é™¤ä¸å¸Œæœ›å¤‡ä»½çš„æ–‡ä»¶ï¼Œå¤šä¸ªè¡¨è¾¾å¼ä½¿ç”¨åˆ†å·åˆ†éš”</li></ul></li><li>Storage Strategy: å­˜å‚¨ç­–ç•¥ï¼Œå°±æ˜¯æ˜¯å¦éœ€è¦è¿›è¡Œå‹ç¼©å­˜å‚¨</li><li>Backup Location: å¤‡ä»½çš„ä½ç½®ï¼Œéƒ½æ˜¯æœ¬åœ°ç›®å½•<br><img src="https://img.xxlaila.cn/1571709879768.jpg" alt="img"></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsé…ç½®ldap</title>
    <url>/2019/10/14/jenkins%E9%85%8D%E7%BD%AEldap/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸ç ”å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜ï¼Œè¿˜æœ‰è¿ç»´äººå‘˜æœ‰æ—¶å€™ç™»å½•jenkinså»æŸ¥çœ‹ä¸€äº›jobçš„çŠ¶æ€æˆ–è€…æ˜¯å…¶ä»–çš„ä¸œè¥¿ï¼Œè™½ç„¶æœ‰ä¼ä¸šå¾®ä¿¡çš„é€šçŸ¥ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯ä¸èƒ½æ»¡è¶³ï¼Œ<a id="more"></a> æ¯”å¦‚jobé”™è¯¯äº†ï¼Œä¼ä¸šå¾®ä¿¡è™½ç„¶å§é”™è¯¯å‘ç»™äº†ç ”å‘äººå‘˜ï¼Œä½†æ˜¯ç ”å‘è¿˜æ˜¯è¦ç™»å½•jenkinsä¸Šå»çœ‹ï¼Œå°±æ„Ÿè§‰è¦èˆ’æœä¸€ç‚¹ï¼Œæµ‹è¯•ä¸Šåšçš„ä¸€äº›è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæœ‰æ—¶å€™å¤±è´¥äº†ä»–ä»¬ä¹Ÿä¼šå»çœ‹æˆ–è€…æ˜¯å»å»ºç«‹ä¸€äº›è‡ªåŠ¨åŒ–çš„jobã€‚ä¹‹å‰å»ºç«‹äº†å…¬å…±çš„è´¦å·ï¼Œå¼€å‘å’Œæµ‹è¯•äººå‘˜éƒ½å»ç™»å½•ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä»–ä»¬è¯¯æ“ä½œäº†ï¼Œå¯¼è‡´ä¸€äº›å…¶ä»–çš„ä¸œè¥¿å¤±è´¥æˆ–è€…é”™è¯¯ï¼Œè™½ç„¶åšäº†æƒé™æ§åˆ¶ï¼Œä½†æ˜¯ä»–ä»¬è¿˜æ˜¯æ­»ä¸æ‰¿è®¤ï¼Œæ‰€ä»¥è¿™é‡Œä»‹å…¥ldapã€‚è°åŠ¨çš„å°±çŸ¥é“äº†ï¼Œè¿™æ ·å°±ä¸æ€•äº†ã€‚</p><h3 id="å¼€å§‹é…ç½®"><a href="#å¼€å§‹é…ç½®" class="headerlink" title="å¼€å§‹é…ç½®"></a>å¼€å§‹é…ç½®</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®<br><img src="https://img.xxlaila.cn/1571025388007.jpg" alt="img"><br>è®¿é—®æ§åˆ¶â€”â€”&gt;LDAP<br><img src="https://img.xxlaila.cn/1571027524602.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆä»¥åæˆ‘ä»¬éœ€è¦æµ‹è¯•ä¸€ä¸‹è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œç‚¹å‡»<code>Test LDAP setttings</code>ï¼Œè¾“å…¥åœ¨ldapçš„å…¶ä¸­ä¸€ä¸ªè´¦æˆ·æ¥è¿›è¡ŒéªŒè¯ï¼Œæ²¡é—®é¢˜çš„ç»“æœå¦‚ä¸‹:<br><img src="https://img.xxlaila.cn/1571027696951.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆå¹¶æµ‹è¯•é€šè¿‡åå°±å¯ä»¥ç”¨LDAPç›´æ¥ç™»å½•äº†<br><strong>æ³¨</strong>: å¯ç”¨äº†LDAPç™»å½•åå°†æ— æ³•å†ç”¨ä¹‹å‰çš„ç™»å½•æ–¹å¼ï¼ˆæœ¬åœ°è®¤è¯å°†æ— æ³•åœ¨ä½¿ç”¨ï¼‰ç™»å½•ï¼Œç™»å½•è¿›æ¥çš„ä»»ä½•ä¸€ä¸ªè´¦å·éƒ½æ˜¯ç®¡ç†å‘˜ï¼Œéƒ½æ˜¯ç®¡ç†ç€è‚¯å®šæ¥è¯´ä¸å®‰å…¨ï¼Œæƒé™é…ç½®è¯·ä¸‹çœ‹</p><p><a href="https://wiki.jenkins.io/display/JENKINS/LDAP+Plugin" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a></p><h3 id="é…ç½®ldapçš„è´¦æˆ·æƒé™"><a href="#é…ç½®ldapçš„è´¦æˆ·æƒé™" class="headerlink" title="é…ç½®ldapçš„è´¦æˆ·æƒé™"></a>é…ç½®ldapçš„è´¦æˆ·æƒé™</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢æˆ‘ä»¬è™½ç„¶å§ldapé…ç½®å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å¯¹ç”¨æˆ·è¿›è¡Œæƒé™çš„é…ç½®ï¼Œä¸å¯èƒ½æ¯ä¸ªäººç™»å½•éƒ½èƒ½å¯¹æˆ‘ä»¬jenkinsè¿›è¡Œæ— é™åˆ¶çš„æ“ä½œï¼Œè¿™ä¸ç¬¦åˆæˆ‘ä»¬ä¹‹å‰çš„æ„å›¾ã€‚å®‰è£…<code>Role-based Authorization Strategy</code>æ’ä»¶</p><ul><li>åœ¨ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®,å¯ä»¥çœ‹åˆ°ä¸‹é¢é€‰é¡¹ï¼Œæ¯é¡¹ä»‹<a href="https://xxlaila.github.io/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" target="_blank" rel="noopener">å‚è€ƒ</a><br><img src="https://img.xxlaila.cn/1571034253089.jpg" alt="img"></li></ul><p>ä¿å­˜ä»¥åï¼Œè¿”å›ç³»ç»Ÿç®¡ç†ç•Œé¢å°±å¯ä»¥çœ‹åˆ°å¤šå¤„ä¸€ä¸ª<code>Manage and Assign Roles</code><br><img src="https://img.xxlaila.cn/1571034433352.jpg" alt="img"><br>ç‚¹å‡»è¿›å»</p><p><img src="https://img.xxlaila.cn/1571034507945.jpg" alt="img"></p><ul><li><strong>Manage Roles</strong>: è§’è‰²åˆ†ä¸ºGlobalå’ŒProjectï¼Œå¯åˆ›å»ºè§’è‰²åˆ†ç»„å’Œæ·»åŠ é¡¹ç›®ã€‚</li><li><strong>Assign Roles</strong>: å¢åŠ å…·ä½“çš„ç”¨æˆ·ï¼Œåˆ†é…åˆ°è§’è‰²ç»„ï¼ŒæŒ‡å®šé¡¹ç›®æƒé™ã€‚</li></ul><p><a href="https://xxlaila.github.io/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" target="_blank" rel="noopener">æƒé™è®¾ç½®</a></p><ul><li>ä¸‹é¢æˆ‘çš„é…ç½®ï¼Œå’Œä¹‹å‰çš„å¤§åŒå°å¼‚<br><img src="https://img.xxlaila.cn/1571038684383.jpg" alt="img"></li></ul><p><strong>æ³¨</strong>: è¿™é‡Œæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œè¿™æ ·é…ç½®ä»¥åï¼Œæ–°ç”¨æˆ·ç™»å½•è¿›æ¥ä»¥åå°±ä¼šæç¤ºæ²¡æœ‰æƒé™ï¼Œ<code>Access Denied,xxxxæ²¡æœ‰å…¨éƒ¨/Readæƒé™</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ‰“å¼€jenkinsåï¼Œæ²¡æœ‰åˆ›å»ºç”¨æˆ·å‰ï¼Œå…ˆä¸è¦å‹¾é€‰ç³»ç»Ÿè®¾ç½®ä¸­å¯ç”¨å®‰å…¨é€‰é¡¹ï¼Œå¦‚æœå‹¾é€‰äº†ï¼Œå°±ä¼šå‡ºç°æ— æ³•è¿›å…¥jenkinsçš„ç°è±¡<br><img src="https://img.xxlaila.cn/1571037187865.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ç½‘ä¸Šçœ‹åˆ°æœ‰è¿™ç§çš„è§£å†³åŠæ³•ï¼Œæœ‰å‡ ç§æ–¹æ¡ˆï¼Œä¸€ä¸ªæ˜¯ä¿®æ”¹confing.xmlçš„æ–‡ä»¶ï¼Œä¿®æ”¹config.xmlæ–‡ä»¶çš„ä¸‰ç§æ–¹å¼æ„Ÿè§‰éƒ½ä¸å¤ªåˆ‡åˆå®é™…çš„ä¸šåŠ¡ï¼›ä¸‹é¢æ˜¯æˆ‘åšçš„ä¸¤ç§åŠæ³•ï¼Œæ¨èä½¿ç”¨ç¬¬äºŒç§</p><ul><li><p>Role-Based Strategy<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨<code>Assign Roles</code>å§ç”¨æˆ·æ·»åŠ è¿›æ¥ï¼Œç„¶åå‹¾é€‰æƒé™ï¼Œ<br>ç³»ç»Ÿç®¡ç†â€”â€”&gt;Manage and Assign Rolesâ€”â€”&gt;Assign Roles<br><img src="https://img.xxlaila.cn/1571037604678.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½†æ˜¯è¿™æœ‰ä¸€ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯æ¯æ¬¡æ–°æ¥ä¸€ä¸ªç”¨æˆ·å°±å¾—å»æ·»åŠ ä¸€æ¬¡ç”¨æˆ·æƒé™ï¼Œè™½ç„¶æ»¡è¶³äº†ä¸šåŠ¡éœ€æ±‚ï¼Œä½†æ˜¯ä¸ç§‘å­¦</p></li><li><p>é¡¹ç›®çŸ©é˜µæˆæƒç­–ç•¥<br><img src="https://img.xxlaila.cn/1571041499340.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æ˜¯ä¸€ä¸ªå…¨å±€çš„é…ç½®ï¼Œç‰¹å®šç»„åªèƒ½æŒ‰ç…§æœ€å°çš„æƒé™æˆæƒï¼Œé¢å¤–çš„æƒé™å¯ä»¥åœ¨å…·ä½“çš„é¡¹ç›®æƒé™çŸ©é˜µé‡Œé¢åœ¨æ·»åŠ ã€‚ é»˜è®¤åªæœ‰<code>Anonymous Users</code>å’Œ<code>Authenticated Users</code>ï¼Œç®¡ç†å‘˜ç»„æ˜¯éœ€è¦æ·»åŠ çš„<code>admin</code></p></li><li><p>Anonymous Users: åŒ¿åç”¨æˆ·ï¼Œæ˜¾ç„¶ä¸èƒ½</p></li><li><p>Authenticated Users: è®¤è¯ç”¨æˆ·ï¼Œå°±æ˜¯åªè¦æ˜¯è®¤è¯çš„è´¦å·éƒ½å¯ä»¥æ‹¥æœ‰çš„æƒé™</p></li><li><p>admin: å°±æ˜¯æ‹¥æœ‰æ‰€æœ‰çš„æƒé™äº†ï¼Œè¿™ä¸ªç»„ä¸€èˆ¬åªèƒ½è¿ç»´äººå‘˜å’Œéƒ¨é—¨è€å¤§åŠ å…¥ã€‚</p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ å…¥adminç»„ä»¥åï¼Œä»–ä¼šè‡ªåŠ¨å»åŒæ­¥ldapçš„ç»„ç”¨æˆ·ï¼Œå¦‚æœç”¨æˆ·åœ¨ldapæ˜¯adminç»„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°±ä¼šæ˜¯ç®¡ç†å‘˜æƒé™ï¼Œå¦‚æœç”¨æˆ·æ˜¯æ™®é€šç»„ï¼Œé‚£ä¹ˆå°±æ˜¯<code>Authenticated Users</code>ç»„èµ‹äºˆçš„æƒé™ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼åªè¦ç”¨æˆ·æ˜¯ldapé‡Œé¢çš„ï¼Œå°±å¯ä»¥ç™»å½•æŸ¥çœ‹ã€‚è¿™æ ·å°±æ»¡è¶³äº†ä¸šåŠ¡åœºæ™¯éœ€æ±‚</p><h3 id="æ—¥å¿—è®°å½•"><a href="#æ—¥å¿—è®°å½•" class="headerlink" title="æ—¥å¿—è®°å½•"></a>æ—¥å¿—è®°å½•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è®°å½•ç”¨æˆ·æ—¥å¿—éœ€è¦å•ç‹¬çš„å®‰è£…<code>Audit Trail</code>æ’ä»¶ï¼Œè¯¥æ’ä»¶åœ¨Jenkinsä¸»é…ç½®é¡µé¢ä¸­æ·»åŠ äº†ä¸€ä¸ªé…ç½®éƒ¨åˆ†ï¼Œå¯ä»¥åœ¨æ­¤å¤„é…ç½®æ—¥å¿—ä½ç½®å’Œè®¾ç½®ï¼ˆæ–‡ä»¶å¤§å°å’Œå¾ªç¯æ—¥å¿—æ–‡ä»¶çš„æ•°é‡ï¼‰ï¼Œä»¥åŠç”¨äºè®°å½•è¯·æ±‚çš„URIæ¨¡å¼ã€‚é»˜è®¤é€‰é¡¹é€‰æ‹©æ•ˆæœæ˜¾ç€çš„å¤§å¤šæ•°æ“ä½œï¼Œä¾‹å¦‚åˆ›å»º/é…ç½®/åˆ é™¤ä½œä¸šå’Œè§†å›¾æˆ–æ°¸ä¹…åˆ é™¤/ä¿å­˜/å¼€å§‹æ„å»ºã€‚æ—¥å¿—å°†æŒ‰ç…§é…ç½®å†™å…¥ç£ç›˜ï¼Œæœ€è¿‘çš„æ¡ç›®ä¹Ÿå¯ä»¥åœ¨â€œç®¡ç†/ç³»ç»Ÿæ—¥å¿—â€éƒ¨åˆ†ä¸­æŸ¥çœ‹ã€‚<br><img src="https://img.xxlaila.cn/1572057054289.jpg" alt="img"><br><a href="https://plugins.jenkins.io/audit-trail" target="_blank" rel="noopener">Audit Trailå®˜æ–¹å‚è€ƒ</a></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé…ç½®ä»¥åè¿˜ä¸èƒ½è®°å½•jobçš„æ—¥å¿—ï¼Œéœ€è¦å¯¹jobè¿›è¡Œè®°å½•éœ€è¦å¦å¤–çš„å®‰è£…<a href="https://wiki.jenkins.io/display/JENKINS/JobConfigHistory+Plugin" target="_blank" rel="noopener">Job Configuration Historyæ’ä»¶</a>ï¼Œæ ¹æ®å®˜æ–¹çš„ä»‹ç»ï¼Œå¯ç”¨äºæŸ¥çœ‹æ‰€æœ‰ä½œä¸šé…ç½®å†å²è®°å½•æˆ–ä»…æŸ¥çœ‹å·²åˆ é™¤çš„ä½œä¸šæˆ–æ‰€æœ‰ç±»å‹çš„é…ç½®å†å²è®°å½•æ¡ç›®ã€‚åŒæ—¶ï¼Œå¦‚æœé…ç½®äº†å®‰å…¨ç­–ç•¥ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹å“ªä¸ªç”¨æˆ·è¿›è¡Œäº†å“ªäº›æ›´æ”¹ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬åœ¨jobé‡Œé¢å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>Job Config History</code>çš„èœå•ã€‚æœ€å¼€å§‹æ²¡æœ‰æ²¡æœ‰ä»»ä½•è®°å½•ï¼Œåªæœ‰å½“æ„å»ºjobæˆ–è€…ä¿®æ”¹è¿‡jobä»¥åæ‰ä¼šæœ‰è®°å½•<br><img src="https://img.xxlaila.cn/1572057782047.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1572057958019.jpg" alt="img"></p><ul><li>ç‚¹å‡»Show Diffs å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å…·ä½“ä¿®æ”¹äº†ä»€ä¹ˆä¸œè¥¿<br><img src="https://img.xxlaila.cn/1572058118436.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬å®‰è£…å¥½è¿™ä¸ªæ’ä»¶ä»¥åï¼Œä¹Ÿæµ‹è¯•å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½è®©æ‰€æœ‰çš„jobæ—¥å¿—è®°å½•ä¿å­˜å†å²è¿‡ä¹…ï¼Œå¦‚æœjobè¿‡å¤šï¼Œè®°å½•è¿‡å¤šï¼Œè¿™ä¼šå¯¹æˆ‘ä»¬çš„ç£ç›˜ç©ºé—´æ¥è¯´ï¼Œè‚¯å®šæ˜¯ä¸€ä¸ªå‹åŠ›ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦è¿›è¡Œé…ç½®ï¼Œä¿å­˜å¤šå°‘æ¬¡çš„è®°å½•ï¼Œè€Œä¸”è¿˜å¯ä»¥è®¾ç½®æ’é™¤çš„æ–‡ä»¶ã€‚<br><img src="https://img.xxlaila.cn/1572058857084.jpg" alt="img"></p><p><a href="https://wiki.jenkins.io/display/JENKINS/JobConfigHistory+Plugin" target="_blank" rel="noopener">Job Configuration Historyå®˜æ–¹</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>javaåº”ç”¨éƒ¨ç½²</title>
    <url>/2019/10/12/java%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="Welcome to my blog, enter password to read." />
    <label for="hbePass">Welcome to my blog, enter password to read.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="f659594153f73d07a97f350a71b64432b77b5c8cf98ab8568b67411b99ffd234">d69a90776b8106231e3f5503e1ddcc13ce0bde5f443a0f2168d3f72bab2055dff68e1e331692aaf8cab8b235d2eee4dca4140d26b2ca6082fdda4372b8276eb6037dd821f137b31a3f9484efbd0033e15496b56dec43a9853a36edd87ee41fe110e28d69395d2a7e8a3e76306373f69e5f2686226737e1aa9dfbcf0358aa31f16ead817682bee3593904dc3eb9e13ab52b4ebb0b74e0660faa4620eae61ebe46db0bc8a114d037e5adc994745620fbb3ba3464233fc9606f5c458af6eac1f3c588bf369f847077c952aee472e6eb812042dcb3392ea143c3891bca0ce80369deeb4a7defbf62bcbaaffdb142e2f556e3c57829cd2cf02bec584df45e184492fd29ee123fefe9eb210fbce226cd109c70dfb31000da954173968c10e9e6c9298594a9fbfd143640a0229d4649b50ba8c0d494ec415c7bec3283eb127e340d4db0e66d78abd8af51a62c30322e6469b2f02e251e4f623a112cae826203d7a179d7d2c2e47c22f5d0cc2d97289947e6dceb1910c240162e9fbee6ba5efed1eb1ff55463d6b9de38086601b725d151d855f043181138babed047eb85dc87bd4eb2396f3157a103748c0aee8a019879099e20aae8aaee16276e333e00f39fd4a144a6d5177e20cc0710b1b53162a0dee3794c31ca93c49e6d40994518299d5cbb8363a1364e4ca575e02c4664e7e5abd1e5f2a872f054fe6a46b6cd812f07355926e5ca2c83940fa023c30bac21a50103bfceb018035046cbf75ca31ea815936ec52816b7ebb3d2bdbf949c3ea940ffa63efca0de0a9e93d4073bd660f27b9e3aa97f06e0842cde79cfc81fb35cf652ee211fca03a4999b03227575f65e9558095182f61fb33f123c669d022ca1a945d692ad6abffbdf19c499dfc32719d047466aba6316f2754d9f82f238ea06ae05c69e36849e1e2ada80905b3db39116348848d098485ab53d4ca8f69577c523c40baf5655eda1a2999f38107434ae36e2878b5239d84bf30d2826ac95d0b37dbba78f8b6ecd5104ccb9e0e6b639dfb8848ff1f9ff7bf6cd67ca8271fefe013279c47a718fffc12be9c133e0d69c81883ae8f4087dd6957cd6d7543cccbd3801ff2f68e4267e8971a840698a021017bcc9c5d334da0a346454c833bd7643978b1fc21f758837986cb455926397f13f501559de6415476169b165b0cc62c09ac104d0e295f1b5123a46b21dfdbf793960ef6c4d0269b575933fc63d30e92dcaf5f3126ecda794d92a23efc938a09c1a90eda03f3dd30e5037fa8da743d4f7d69841da82bebf0f45818cf05937a7f93e7376928470133ba8b8faf662cf44af59c8fd2e46a301c4349df56987abfa727eca73871b68ac533c4c1d17aee941a3cf08e0254c3a1e56590c6725bf42768084ba08115333df545b220df937f6af2e4204c23cb40e34ad960e8ba02a90793fe4fb5ea8920fea05566e8f1ca847f61bbdbaa47bbd9cf8c41426173473a91d91f367369ca7c5711db3479ec71004b944a95b3c056a0e341a3707361c4ff0e40326a303187c5844aa66ff1b16dde59110a5355c35d938eae59998d96a755921aa6bfe2b1b0502b3122cad01761a0df5efdf6fc7a7bd6e07439b4fd46536b1c70359cc24a43c93429026c93a8fd45dc08a1a497fe3acdb67c1d56afbdaae9e60615514887df65df5be176d8665496cc32b4a6269bf79f868cbaab66681e4817aebf6b0a62abce5171a3e6ab4edd7a6006bfdd395837bf6718e0746b6c6f3d9eff37c20d3ed6ffc042c227a703efb69ce9929d3d3b01e88814fb3f580a2fed9e4f3055b2fe5f9ad37ed6940700545f25e5b1b3a10650f3784a9d24285c904242dde41cc3f0b46c7f1878b636bc809707cf663e68c16e75a59b8e6b64837c37b21d04ffac7b3cdfde886a87325bd71d8e49e0a7ed17665c0bb3db68da609f665c4cd05a6461428941d7bb1e3cfd0b91b4d307c17309276dd15f60adef09fcebf9f78aa5757dfec442070325d9d3babca3e28cd53c64074b36430324ace43bcceabc4880764f1e641bbaa047c988d461a6751d0a619aadb6882612790e3e97e13ee8c300a7ad5fe755b6ff31582abb67fea31408fed27cfe59a31bb74182b740a95b24abe054747a74bc20cb877f66351248389b641137cbce9c7fb01a48c51f14bdc0c1dda80aa955cfac6c899b1f25e20fac7e7b94b5aeed9da44db33c59be0066c65ee1cdb8a412823f1dea073ce513521fc4508403770d141214e556289a0c23691f65942efe095cc16faef391d211873b12cc239d091afeb65053e659e0430c12791fec7c4cc1e536be5bd83bbf6ce68c8245b7a96b067b19c50ab77abbfcf4fb6767c1f47f60d63b5a362ddeca3f6f239ec90059d4feab53a380e12ff2ce7943f23cf93c76438fa57638d8e7aaa35ceca8116b4723b21bcb3e9201f34401177b04c0d59708814cd32a4447f6a32e27d544e08ae97dcb82254cc1731664c9de2ddd33f4319393e009f76168d5816292a5612566eb1de62ebb64640a78064b87bd2a43adf555200d2d453208311eb341cfbad98e4566b44926e7378a11f13c65f778b978fc76314b67b2b8682b77ba57d7e1b3997de6f60b040cb53b5c74f0d1f06df129cbf04b8177b21386e9923d978212959444f95e131fc1e2e484e77374698a17285cab0a580f6ccc30d64ea699da7e2ebf2bc94f3b4442a10d7709f19dcffdd049a7c77752fbed65a094db29bcec0d58f26504698b60069199585e4015f0ab87e70021acbc5aa37f6b7fd386603a832cfb592537bf3355b426c1ef32d54cba1488c89d761126864ecfe91929833603eef604352cd9c622286c2f5bd37019811a5ff375def2b26c0eb90d201e63d43507ff7df34786a46b876b8a2110303b9406c61fe31b878ac57469aaf11dad4e5f42df178fe5ff521bcd514435f8be9b4e5d4a1c4360ab61601fffba5247bb26ed3ad47c6aad569bed3ac9999ef016acb6952735f3c18bf1d51cbe81a0d34837d784625020eba37684e78e7cb4e3cf96944fdff665b1f739ca52e34a39df6451c8b81345a4b053071e5a844e5032c41916a63f892ead4eb12d6202081e9cec1f343946adef3343155c3e28fdb9693b6c545f6bc56eeed8a88bd2b51aba9bcdfa577de1bdaa2eabe2ff8143678949a3b617d860963c95c270f54cf8d3ce2944a2eb4280c0b17ca36ff45b69bf7aef842922ce995276985a7b17707c9bb2d9a6a7c8815b6cb40a9563e9ec550a76726f3971240ea50262f8bd0e3f8d2f626a341e6a8915fc4023cf8a2b98840a22c1a8353a273c836b651804bd1feb6268d6229eca198d149440d399aa6f1dfde63770bbad56ec76673b4b3ecf0c8bba83af7c647b879d3411392c47c20a71cafd819eccc4c4bd7d859b87967fd3de00a6067bcf26c82cac5a42711a08d295aae303752ee7972787d965beec6f6e8a1f213797252cf1af86b5052a3c86661bab3bae869ad6043d9aa4cfcea0c36cbd54c3f97cd4c3d3e3b978a6a43e41377572a0107adeb172badf554fdcd07f25b03425e20d52075ec7b269741b4c163586be200a667db1487547db23cdc186f137d4a6fd162677e51da4cb5c2c1b843901d17fad57c7a1f4718c489dba7c5e7d9f98cbd0abc065191e9bdf9d5ef26c8825991c48a57e7812757bffcc2d7c1bdb922a0e3bb8b28639e05d7940d8ee7b94f99afdd6addccf749aa771793a0edfd3b4570aedc69a592371d906e46403b57b897175a76fd0f4c33304feaf3caddb0da9bbd01147604710430a2180fa73ad4e968de5c98ba13530639e5e547010b2cb5b5ba2e046b5a8009ae31bc1c852ea23be8710758bb4b84d175a40b0bfa9a9e63648c7b3934a79eb9a68936521fbdbafdfe077650433222db14334be56213391a750e0e8835cf7a6c1e6611e00f303e6af581784bcae02e28d8dd76f14788fd8308fd72bc0a393dc0e32140e9e1c165e0eedc7be81263633bd52009e7ea215dba2425bb3db7bdd1f11e5db8bf89b0a587398521caad131c18d3a2824f5ab94163b750e8d4e8e9db3b84177d5c0f903cd2baccc3aa43702940edefa882a1994520198ab6402da553024a243a15f8faa2ae2ead77bdb66092545ca365a2f9995d3be55883340ad0b935886ebb0968a3bdbb889b657be85ae89ce8eb6a535833bc6e3e956fbf11d1f8c9895f0d9bf38066f1b756b4f5b62c860089f1716aefa605900c48f463590439aab348e1e949ca45bf94fda3c29183646d4c2f7217dd132c1c747aace9d9d42237b812942fb9703a4088eaac33390e64e1da10493bb2773bb282cace0ceebd263d13499459c9324b92c1a65a1b21efc423ed83632ba3aa0a6ccf4b13880b2f3177822aaaa432b3ed64e63fe11788ff86b3f5c1f07dfa1a55c1a0e229a9f5fc6c1a835b189163dc1e4b7a3f0f1b26dec33fa7b630c4422ac103c07ed44e2147ffd062c2b01c8b92cefeae0766f85d630db743c7f4d89e51795d4984d4c47a712dc134d2a20234aae4d234f8d1c9532ceb4c3e139686d3d09f437878a06ab80093f9af0b4fea83e8a54a3f2bdcb39928dc3a86e8bb904b8ce976832ae88ed44e68df5e0fb8ad4805192d8b0f24c91faece1f5ac20fc3b0e7769eda5267fbaff8e2bd60b98bbc8a4beed65c29a628d60438b6efbde6fe53c9e1d14e026c864e624c18d0424f9f450cc851af3b1759bf64a7d538a6de4c9fd5633e62948e18287f6734eb47b897a04a341707b51259d1270e1c88dddd37468a689902f663c13233f4f1ffe935f145d6e838de7fb3053b154b23f055f8b2000d2dd1e8f16366f61557b006f63ebc78bbcafadca18a5490491382dc7185047c63504a2296d730a897356999c6086ccde955334cc8fbcc4eb750cab5671add7a89ec27d473c1fddb06b5e9f9e8b2c48662ba5030ce0536085efc087ea91ec1015aae07453cab28266ec158264ae26fbfee2615d3d5060bb863ae600fe41d5ac1f919a09fa1631bdad78a16dd0b3154cc44cd8cb64cc28b5c641219192177f7e5822c408320f9702af187a3b4610065bb2c2507e1c6a55ec602ef76db3eaa87278c4e2a553f5f6460bc6008b6e7fd16808c58022b29200be2bdf2b4ae9c6a5011c434f792d0c6736d34a154198589dc7247a4638d96b8b59a574da5f5654279dd71361d7e41acb009d958a12f4fef64da2dd0b91b4c0fe899fd7342e599d117a5febcd65c4da23c0900f89612ad960338493795c0a62464aca81ff512755e6a66122562d966f24cc3d5ba4ff93151de7d4769b5f4bf83e1eb23f3e54b80288dcb00b5a17413e08d8902eec2099900f0b27e7d556fcdab7ffd3762841c89c5925ba619b80c9240143634eb07fc182dbf9abaaf6dcc45c6c46aa722f3da42bb581bc3e8259219ea4bb48d730728a2c18519c24aa897f8c7b6cecc4c2a25069af50c60dfde410f87d149cb6c4028e6c0452cf4bb60f5c9c0b921d758ae85960f955bb638ea1d3a56e01dfa65dc01d4dd3daf14a3a02477c330dca8b54dcf018bdea7a1b2898400f73f4c5c627ac85674291bafd096040dc99aa1a383cd361aefae2b2f61e23d824cc5714bdc96aabc01eea056c33b65b81bb7e97f0a9f977e695b70c82199f8312d7e7ebeb61d50e7bfac9e4882e54664706cdd909cbf923507908bfbfac4fdcd515db3c0da27ec75f022a64d13593895bc30c8ced7e8703c66d222d8e586817e56b82576cacaf146bf3ebe1bf186ea8b72e61aceb7fcd55dc21322283ecabbb9ce38212d0137de477e80c4ede9c7ad7feeee5642dcc6d09fbc76abca9641601f415f2b85591095b07bc293479f8d4de8dc7cf046d70e5cb0f26e1dc1f01db5d78ce517da9452e06d5caacda9e051452ae32315d8b4ba00cb90298afcd975a67c683ce9423a6e09bff6561b16f159d00ddbf126c4f6985412314b91780d00ef6032a3fcd6f12e2dfbd82c4f2b547be9e2af01ccdf67f5c982cd0b81b57f11d6b0b7e383bf848a2a15a93f8bf2ac986b5b3f87bf54e37bcedeba38043fe1345d8bb6acced9be89837f51acef40c1d83f3d14dbb1f7156ae7911c0cff150e49b20b6b92cd6fa0c48b7b3e7bf68f497ab035257b4241f5a4cb4a12678814d29af7deb21129cee901e42377f8d4a89ad8d106afc80dd37445c1979a070964a259a6421587ec9c5551da7b08e64b60451ef19362d343302ebfe32cf9b77c1ffb2ff22c683fc4d91f16bba8a491ba98f0b669709028cb63e8ff5be348f3478668a4c0d280812419de3aad76474baf44e3dc7bbe04d6528e2477ae4299cbb64466be713580eeaceafc20a794e55483f2ee150773b4c54b385583c7ab2288128cd4f5903b01dfb1c332896bab8c9e784efb77c1d6191eeb6729e62de3a2244a79a023cfac13902148a3bb8ba634f1acc6bb4c8055c0899ad163e898f7f52425f1d2e50cb2e501c7324f43f87dd297530ec875a61c30abb72b5475e7742c848dd409334bda6fbad719af8e472275d86e8b3cecc0181a218811174554857e6b3df5c72027c39b6653b6dc4a6e8a4aaedc61e6e8aadcf9ede1aa516a785a469ad2433157d0ba050ed937aedeeb4e276c88b37ad220ba8faaa066660f234c35804ff4e4b3fb71185f040135b3b4fe5f0d51d2e3acba745e231c69aa7457b941ac64b94ecf27210567e46e82c629aeda7a3d54c4fe40db5a58d3564c4533d6446c2f9b161c5254d252f74ace61e0c27f420525e20e54895a7bbfe19ff1e6bafe29405e66cd9a9bf8146ba0a33fd1a8922c32536d7f93facf6b61ae8b2e7a9c77ca953310605d0c42ac60709ff8a2886c04368daaec1a1d5c93225db8ee3dea3472134a7ed26bc7121257a4f00a354b5e730cf2b0368efdfe6b8b7ec066fea7c7edb746f9fe60d4ddd29030e009a77a1c8d43eb8edc426996e1901475833b59f7d0fcc820e14ce0ca99991184a1945ab2a0ca87ccbf2634e92dacb39288388e9328a86e153b8b8d75cee941fc6ad60268316bb4289696462a70fc0b8489270d2cac023f565223aa3cfff0ab4ab60e284b5a3003e886aec826fc1421b4c1b989cfaef4711858d75652554e1dd3c271d5c21724ced2c30b5eba209580549b60875f4c72418a0bcb0ebb360f518269cb75c90c091fea8014b0b5dd47ab7460be1992e137f3513c301d088f8c54a630723e31bf130bfc69365190c5b6313972a6fd160a354854665d31f0cd7f5d69d67ace4dbf15ec6c8ec3b3d7ba51342158105d7dc05ae2f96b2aeb0e1c7c1bf4c6474e41306a74a30616e93d27253c251a20317e53da3bd38e2d2638c38fd6ecbc286ae45da973801174bd385fa5d514fda9b215da4be2bb37bfc92f2679a909569b7c16bf7007159088042b1ce5636ab3e0162026b57ff6a212b429649a51f1910e01ca7ee9ae0db99274bff4e5f5146f7973bb70706b9ee9598c05bcc00650046ae9b4262214facb9e0b4fc85b8402150a65e7bcbfd645c73d329bc21748f3a60d7c039e6205470333dbd1b7100357b41cae1131aa14e38d0f6b38675edc801e30777e17060b2ede8513b6ed193ba0ed8bc41d4ba6c8cdc87ead69aa8628479cc7a89f18c8d1cb9586790ffe23049e8752662980d7646e4db9ec7c11408560868c1d70ac46d4d38f88fd63c06dd88095db72ff2db575aef0dfc720514967b1c0ba96814b878105046817061b3086c2c93d3100ca4664ddbf2ed56aee8f9ecca801809db717438e9b4fe9a8d9e609d8ed01b64f1258c2f905549cda446567423aa03a3697b2b3049245ea4a46f86d74960189893b152529613c31743721d5bc354e70e68efd081bf0323ca472756f14bf34c030ac5a7c5b261e8d52bbb96c3e43d0ad7141b6471db98e205bb8647bef8a75b57cddfee2ad60205752fb7a3e7262df3f89bef008960a24ae2ad1bddb2736ef24879ec980eaa54d27fa8c98cb3ca37496a7f8dd4e4f2150d61984809937b933ceb8f836f8508d7e0f209f5d44b6833b0dbb7fd17afc8c00a9a047f0e1ecde0d345c28ffcc4722ea11e9808e192a6dab96a1a7e50d861135aa6d3ed8aad9df91f64deca5685b137ae3b4a263bd7b28fde455a2449efbc2e1f45a2a976bae6043660734b0e53acb08adb1848fa47b1c8e1e03093284d505e5e8edf2108d98cfd5d5eb10916ebad86c64513be26884980c776e346dea304f19f55c21260337e5a99d1d592819a53133b95b5a433106d08b70a56e48b1e09a264d0ce9c29b058d1f845a3698788a022ad456366e8cfcb7b87bdec7eaa0eea3c2680feecb215ad24dc4c4ae2b42dc6a4365815b588cfede509fd1c9eb4c6df0c68ef5554c87a2b95f8209f6e4d933bcae5bb59ba8ad80b31052374e8021d2e84aff668417ade28cba0138331409da1a25d06846c426f067b81e1a2b68de982e6defba9fba9674436cd2f2183fd747fac8a89f4c2070b83a2af504969546ea4109772f5715a4a9126a47d521eb4edc46b44a0260c352b68e6798fcd604d92525a2866b627f956f877778783e08439d3a30929b74394b6095f65aa24f97214525c30d86d3ad7383071c01c13f4e454171d14d1825281f650e2dd81725c8b4ea5746cf71bf2ae5356e85e15bc57dafbb5d225d4589376b2f093b7d896412e950c744d59204adb3a6a39c652baf045cf60962012e3f280f2e0ad1f62c436710e0d8beeb1963710fa4de259f433ecf36bb9de927e804ce74f7d6e8cb04d533ba9f06a11a1bce45a89cbadb92dc76798b9731a0dc2c0204518dc5f6b0ce35c662481f48e3e2a39d83827890ca6fc8d42384a46122d5c734d2bafe1d23426176b7a9d27fb4b03d44602660c1badfb3aaadc133947a1a675d5401cfc08e82aa169c331dadf80178372ff9b472faf5541dea5418f2d75478e0d416e3f87c97b251e2dac9913490e351a9f074238512bf03671d6815c62111fcc1eee4fcbe3e5063d172f7f7c3c34cd4b8130268b2e3560de9be3372bb8397a7b447f334dd54178307fe5236eb49769af227d605d076647f237b8c64662c56c1809f9d44145cdb7ef2fbf359785b33f1cdaf7aeacb9bb3223b72ad83b5eab34c5f4cf618316711110b3c306b1268f7cd2246349c3c2aae871f5a9cd6180b18f26d733028017a07a6bcf8a652e26c3c5c6afdff7e9d91f8cb1845bfc09e38e111fab40ffa1cea67df4fb7ff991441565ef5d04d5e8fd096dcb50f7986c8377700a2ac0a831ededca4843d542927c27e8759276375baf1fa0ecd79a95f2e94a01aa5908beb9ca4cb02edccc530127089033e3d4776504648d5cb306a026a22c4db71679ccf2e6417df26cfbe2476063117d3b4ad90050310d140be414fb3afa10d541db51c2384d2e341621891b26b441b29022086d545f67cde3180be1522f440c42fcf2b61ed42b6450c77bd95d469b1e1374fd1073325940c0ebde0490ec44d77989f1842450e4c00fc18587cc5314257c408195edccea03920dd86bc264ab340ca6559848b26c5bb67db750beb24359501eae6264bcfb547248a9f9712d384b356b79f996fbbb9708684188e548b6d68c27e85789b0e9ee75f3699647ce97892ea42728397ea63b7324f6a9471db52db714072e23ee6963a95834cd11553a96f5671bff99618a1d903f0b530ce343cb2d3709b3e66348f777cc6d136b45a208b1ddeaf488c48c497a0aa64ec6facf346106c635af16a79e118abef85ad098952505edec55c9e43f93097242fb3ee1cbef7f3684e70ab49bd2a7b51d4875d33d16821746548a80948c920b9b4fdaf06aac389ccb17e623ced07ec4a9c3ee34738afc8393da97457c54c3824cfd7efaff382e157d8afae9d1ebf32a42a27858d3c40ccfe7d3b3c3835e3e970f034047de23f19d97ac2903a59c33ff90b9fe8c706b4689959395ddb3ece9527abd9e1cd4c30abe157cca16c1569a314b0300986cc4d687ecf1e2749aa0a86a8847357a674eaeb272c848caca970e1d5fdf276c20316d4eef2620d9370ab0866cf43093cbe260849d9b0aa5a58fd3c74c95bcdc8c01f8dc136485893aa6a9276639993347e2c4ea8ea591a4fbd09654a4abd8f293dd5d00ecf0a096b9e33427bab42cbfc447ec1fab054ee6d98bada8099bbd8102c982e512153c6efa15b2ebb500e1c72bc323e5006eee7c32c7409122b113d26fced216a4fac566d74f949e77f68d8b723ae9618726ec06682a0e6ae1016feedf17648502f93fc13f8cd582382bc4b3fcf1644785fa65af850e7223ed79b899a7e7e29d14808975c32790ea314a254b403e3a7db1460e35da1750ca226a4de71d2ae39461f8675c866499ce4536a9ebb78c14eec2436510b7380af4a0c0ef944b6d4726888f5ae0523196980ad6bf359e369fb8c9281f5e4da4b2eb34db9f119300a0dfbc3bf2a10ce53c07bc2376f33d4ee09a3c6bf758f260a48b94466eb0fe430ca607ff96a1ff5aa55a20e4b57bbd16f5be78ef93a7e9cbec1ce3b348401b8f231a5f189c5e028c796353f35c17885283ef67c8170ceccb2f3e6c7405f649a8b28266eb589f16c22b3a5cd92ca8e7a344e466566c5d4e2048b99cc378180ea0c5dda2e3c9b207b561807cb55b7c59903061d39c35b37744e933cddf263ea75471494193c5d9ac2294d3d3858c426a75de4aceab27b72ff2de783a079d570b8a5074e0867085922b5278921b3be8c65a67c5aab498ddaf7c1bcbc9dcd0d0a4bd90b1f5f8261b2fbc8e6610a7c0f3202a8ed241ebf043246df4acf76ff46ca0e2a64ae1c38c5cad14f946b5292f06dcfd3647d3ab29fe2fd1e82d086a89d4ce0cbdd11213a33df4d1ed49ee0fe6e456afcb2f60a2b7db9f9a78b2d0af4918b6567c1c18d7e84518270ba6e6e6884d376ffab4a8122b0a845519f8ed2b810f79b6000f487c63469561addb1a3791b38b28b3f251a595e2be859415c7e0dd1cf4adf86215eba480097de37c2dac541201d31fe6128c78fdc8aa77b6aac70ffcea7ad1a3e17cc1bce05f53667b3cd26657733a0a8a35c3a2df559b87cbe49d94f9c7f62fdc531e8163fc62783aecc288b6a53cf5e75377d9fd6815c96213065df8d4a652c7086885ac9b47858a9d6bad1b6a65c498e07bcd2220885663ab80f01df1947df5da76323b4727964274b27d24bd8acc2fb28ff0ce4b9d836221a233f3146e8640e71b0ca7f40f91a97b5ba19e321df4c098029ba3e959b8d6863fc93dc8defd4bc9a64aca420458e8d7b786cff4f55cf1a08072a9cb4f6037d955aadb79490f7ffc73f44c44c6a659ff88552afe4fe7f3846922153b72a30c238daaf0a14ba0e0baf26040cb0eb43ed04ab38e87587791c817c1ef558da6ea3430448284a33b7c05a8a2decae9e0ec770c84bac9d9ab27b1b5daafbbcfea42bee29f5b026771aaf4f2ddce625d8af3c566e9c8731ffd18acc81500b663a7b8ec8de937735c83df26777da19fd19596058dd5345679ed80a3228ba3cbdd25ff5b345a0b788a7fc150faf7246fb38ee1476f5dfcbe4b1ed44e018581eacac126289e4ac6e7569e2101b562520406bcd7dbf60a21cb56376fff5e13a62715b286cfdf74383578a979f5f13e0e25b19d1d200f7aff7aa08bc4f8b1388ae14aa6cc200b3656cb6a4b6be0162dde7b674b4623860c9646df03253bc98505c21492ed8037ac3e1d26e88a40a62088ce24cabfdbb2b0c69e17d7292e5a3159e3fed7e2041fcbdb7f4ffeb29e9b17fe9310a494c83feed6fcb47a2e3cbcb32c3e2b20b7dc014b869b85901106c77fb647f819cb33cfe70788c2a93ee2a9cfb4c16036dc79bd859286f26a1d922149b8848d84a22c387280681a184be86b5cf073ecef9fd64b704a369a0258eac896e7678098ec774fc406c7a5d4f374665e02e0b319ae5a22bffdd8915f1d78d75df30884b112b1de2f6d08e1a2ee30daf621f6c4dc942544c30e02f696dad28b09403d1607bce798d299634edb041fe8163e9643ddb73501b6e5a77e7e07b1860aab164375a281691ea75db5e5935dafd58f96d2a0eb5d25ab43fd6e79216a9436ca8e6a849446465667c4417fcdc4ed9731277446f9f48dfd31eda63cd3bd66503c5381486531976ba740b93a60d579898f72b536fa7b923f28f1ded8cd2616f973536a35162367e9d5a2ddb073826b85ceec58437fcc6256b189a7b6a44a9b831200d82c3ca2b880fdcf174ccbafd8f6933ab153a8e5d3044ce88f5f2ddd0e27c846f08cc311bc0d2e2efbe0040d51c3795cbaabe9723585d4e37e9f457e2e787ef2625865f8e1f5b35ac384cf2c65b7cf7bad8a3afc04348c2ed3c75826b3c4cd731f81b49e7959f8eb550addf795b54045cf34a9f8a85ac19097f6ae5048b2da2b1caf44a1ba940cd3ad7ac105d042e26e7a80b6364c5cbe3135a04c7aecfba4adbf495e2f82ff4333524f6e99ff8098612849105705c262f80d4a1d92ddef578e1bd98c7f1e85ece175bf9c1c79e69cb01e449e9f2ac32ffa3bd62833c9e2e265dfac2bdf73ae06d675fe932a801d885808f4b5ad91738d27802581816f4c8a807bdd4bbc89b74dcf27bf439448c500ec8a904781246d105bf31e0428c492af40ed07be96a76767ba3f772e2d5d14d4fa1dd58d2397e2da5c708a37af93967006fbcfa1f0bdcb0661cd9394c29b83c8d7ac897a7a47cc627d18cf96c448feb66d8bc2ed464fcb186f0e1b28baa8ccd85f333cdd8b1d34b9d196655bb8532b774e8532cc7cc5234d8fc785523bc4ca135a98312163919ff44738bbb2d891c373e3d647d4cc51050ebf5584305c1dcc9ff678edce2832b7fd4da286cfcfb5d838c143d72da314ed82d1794c407f34aad6caced39997718cea2e26c7013dea31c91c95ba6c42e4ed622d8772392e6ba36f3f38011b974642f168e9780f673dc3e766222756ffb39616964afbd354d291871c5d049195ccdd29f0024ef6bd6a01e543d4f5d61e4e615cb9609a1a5d9ea10bb9315420163acbf08a1c1302b0f84f4ebaa97eb886c5a4f0a58ba32bd30f1862e4d0bd6d3d1a52732eb3c1e0557b996a993df6b6fe10e3e4c380288fb5ce81e0b875d269e32235084e68947cbcd7d513d556314165fe9101e22657c60ae8f6f6ee5cb8567a348a447ae77220ac80c06ad2e080ed914cbc12c345e7f3b25a9d1eb217075ad5c32241936ca1c950f39df5bda1cbf7c9ec4d029484050fb471b44f0c8c9cd345c0bfc2d20b80fb4e64b233d1a93f03d87974e000288eb2b223ee4eb5ddd386dfabb636c154633045795d1d5410233b1e72fb9eaf3e90127a61803a53981bf7c5188781537b79ca958f0ebe504d843e67b5ce7b1dae245980c687dfc66147c355bc03253c8fc0e352cbb281060bd9a8e2199806ea5e41115e9683bde82899a8e4622aeb4c36fdea6ee2020cb7ab233610e742817b3c1162a185968f08772b55b35a23e23b72e0bcb8fe92471a7688b3be6b5290b507fcf08b4dfe64e1e27c874e55b5a39e0773d746f31ea9d580e1fc24041f6102c938e80d34c985eee85059432a087a48d2ebf5624ce0ba5167fcf2bb773bc29c04cbe62a71004c57e4f67b80e59a00faf684b241869839aeb5d69a57309b308c0f4b55c0bcc304837ed7836ea20527d841cbb0614ae2b4dd3f9eab003e84e9452002e11ae1676e753ca1139874be6f877d83d7ea1ab0ccbcb42698e77021fb46d42358fa066c188a8dacc9b3368a823a7db08af24f958bdc080da39fbfd59626f7340ab8cbad86b0c006c757d39be3be876ff9ceb22a5f6d21bc75c1e77a50dcac01be2e2427b096f8e9a62adb1eae12de4783852c1dbd9c3ac2e06a4e4c3a4b30f75af80730204b456b5547e0f034ecf18605f1fa9388fa0a977887dfd6967633f21053a4286010fd8dedb0f27ef069639227e4c03ffad3e1cbad5f50c13a41e41a600341f373961c4092af9b8ea4cb36b8faa2ab93ec468fcc1c9c75dbd6717ae017459136e2e51f44eebdb328052d8bf8b4725233cae2d72690dc12b2ac9c56ed1761f98e474ed4bfb147588f35ba1c292427290577466a15ae1ff670864f6c17be46389dcfc9d52ccec47e0359af9c0703a1bb44a1e4521a54ed3afcdb59da66aeaca75e632d5151cd6bed0a6080b9308b1ea9628cfe66cd9b5c640342821298ccb6c4553413576087ff141fff4750c7107d07ac69080bfa8bd7ce62a2fe3f5c92dae7543e6ef86414dc18951cfbcd139ff1cb188e6e1f60b8cd1d4b2fefd4c4add19fb10f211d7d1d7b39c13e3fefd7e71d76809c38cc1a0237917ef51c69f491d788a2d3d600edbd1ba7e95871d7cd8abff46a22409026639acb611a311558f70a6e5503904f9fd20c0e9e0cbe9f93a3d13e525d1706758d8431cd7006415c594e11ed4e84df5b579e7d7d34f506d8bfd907a7377e844997dccb982f2d23b12ee8f8f4f9299cbb618fab5d52b797d92ab92ed790e48ed7c33564be041f793a34131d71cd23a78f9937746c782d63ba6ecc023f6fe1210a28053a85daf49104bb784f69588443d9d2c1816565b2c49c368a0ece75fb9b78fac529505a6265946f290d3ec6df411a707eb4bcd0130cad3c69a9aefbde51ed4ccf01e8e8c48d7666c0a22c19f5d42548c2713c5fe6ec71d70f35e9257dc43e333c313315981ba216fffb11741fc23d5ea4ef451daec0418e83d6e424c519597e6911e8422c9cd68023c09c2307b24510e143e9abb205e9a12febb6ca0147bbf1858dcf1c85ead3b6feb46f8073ac7999b95411994692d19fd8474e27558476a966b345b05193f7379a036a71348d389c2de8f9986506b460a9166c0cefe423fd983f48f852d0ea725d8fb98ede288cd74b173a18eb7c13b73ae521f872376f381f62c9c6ae27bfb44a52e73649fb49f68047b77d34572b98e6bd2e64fc4094438dd2faa9983c121f7fb1a626d348f3efffa96c4f7eafb80026b30be45bb0f43971b45532711a1ea979c9f8c5d8f07adb25a630b4b569b47f1bed7505a85be546deede48967a9d9c2d950a95d15d5d08a718abb16958a71d94b1d79f5cfadb9d2d04844a388b68a5f335b4bc306d66a62740956ac3bfc053c15ddfef6839410fbf4167423f1cbf63a811d336be968cca08f473e040dc8bc1b6a142b746d537780461460889ad33f19307d9c528786237d08cd0226af6544fc2d7411a6739c140f6e2b0eeee146bfc449dc670aa34857f2622d907f0ea8268cfc4a6f156543531865b5183c9b6f9be44266ad4c4bf9cfa4cdce9a40657ce107b7d9e92766b5c58e2cc9b88017f8cf31c766211590a138fa1bf709dfa53588c17197d7456cd409139698b5a8bd03cb64f8c747ba6c4481b4631c92c7326011540e4c29618b13f2e879c00a67cbe7d85991f3b86c107b67c9a81f0efd8309785e7ff3726bf44f9b82aa3b43e79680893e71b529b2c6d60af8cfc4dc06476218eb49f9aa898859ee1fb89a330e6ba262e48a166a2b99c44aa30dc9e762bd3f35d8971b38f7475d6c46b5852edcefef10421696054418ab4789dfe8a6bcb8b9cf128f2efa4198c9ecf44751be7b64faa383df6ffd5b4a0cac4938fbb5dfa15b902d49b980a4d6490268e2986b7d7325f56e0595a8a84f381412ca6e1351dd21c66da97eaec00a8bf6fd921612f45287b902a06ef22b1ed4a2f1d03a33957dfb26db0ffac7c37c96e4c117f7329054caeabe9405d04c138b1d0519c9700739aea08b9b2ed297faad7797b247c01aa977701f8bc0d8533ee1c5942507bff62f69c6b7e31f1284c943170b191a82491293fecc5ba77b1a1d2f81b6a9b2a8ed9570bab5f9b46913022af73f1a75db120f83d78d5e446c8199e81df8c249d6dca72a41cf6e678e734cd3b20cae5171478c373af204f9be17ade0294963b7dfc6df2461f2c53baab1153559ac53e9df107b58597c7e84da5cb8a99620ce4daa301c9cd24780a2b42fe3041a1e2d861314ac3706c6b08216b4f08844a0102622fa3fb4597f9216fc93aadc136668ea6f23b5cb702b2f0ed250c75798e1a1f16a8249bf31e2ced0aff665e7258a78c2174289f2a5c7156fa77e84e86999af53bc70f0450da7bb0f0a62413b5a8c294cc7f068622fe7d73f5cd33379795be341ba5f35bf0526fd04ae390fada047b5313f02e9565d9f0d250c3b67b2d3209c6115f9e4de4c540ac853385bf2bdb64080be82daa76644eb6691841b3fd08b3a41fd832732072fcc0ec31adbce3c393208f622f3405cd49f12ce56d25df7b21495fc0e1d07f8ac4097e0675b6372fa11ff7a6cd232912a71e8d711d0092098d3d32d4110794cf44a18e62634034ee534a3e715efa3ed591ac8f99e691eb90f0a3e9d2347a57bcc2b4f00913263d4588326e89502e8fffb024016ac154e784b4626d91bab3eefbaf99a2c701fdefae9ae13ebdd217d3610e25abae8d0d2703c140d926028ae57d0e5666481a81c9859234615f811e732eec8d8b82cde740fb01e4969c4f5700682656078f86bcaabd70391e780a8951139ef09bd6b3df1eb45374a86cbda5228b7f8de40f14fd084fb62e564764947a88b6959913598c42b8e48ea340dbfc174445b146bbbbb1d29f1d195041a9380e053c27e6f2863302156ddc509104786edc9e54279edfc45e9d145677e93e4b1c437ee9bba83c7752c1cee0a453d71ff09bd7cf882e318cac4b9cd500b660a1d7852aee939f4eca1f6eda0375ea0c0f3c9b11d7a27228f4f2f24036f6bdfba258fa02ece51d58f55f2c4fe99de8c0ef620aff96ff441d58ea0c550512be6dea27edf038f08a830489c4f6638e2bf380f03005741580534f733a428837fdfc2adaa4060c2a82eedd4c4a80dd35335ba67bec5b727c5044027564038de4f479eb5182cd1460f56ccef9e33b8689c1c159ee0cb0618d55c9cb85cd8e61eb5e2fa535dc5186825d56707415be656f5c46cdb53510d160de6e705a29f4fb481be903f28dc4b90ca65d172a8adbf335d1556210cbf3a4ba752493c1800f81a90476cf59b2bdc3e70f48c380d4b602bb1ba6bd2b3ba77072d5e5f1651990404974e675dc533633ccde591f218b4a4a752027d4c82be3e054d998247796c95127cee444196b235d7ed3377031dbedd803d4255862577717a80009461379c1c5a2f49730544d0a6d4d838dd5accd79616cc916d086c77456c439cdadb8ba21144c2df7216a904238ad0f31849195bc4471c7208dfa4e1ddd9d7ca76ba98ff5093d7a02aaa8cdf70454bc66c05987f9f9b2eb99637da7b1f9f5869b063de968b54d6814471a9edbc015b1768a7b95bb72a00c03f4f6c39f426e6832f2e4f414dac63b5177b6d81b95b1d7dd73adcafcb074abddb263d407f46a9693dc6255f4bb66a7cedec8a9d59a978b1af89e0ef68f11e56f6c88dd52ee7b354b869ae688ffcdfc1d27448d02614ebaf548a50a20ac76150097d2f749a9d5c104ab98e04540b851dcd7c16b87f832460635afb57714a3aeaf80c4bb20755af4b3aa7ac1248cec96839f462e1eb3852792cfdea1d99f43cfe048f0df0e7fdeb49a2ed5f6a16ff14ad629151acc5dbd9ee1847dd82333ab476d0c2a954ed1defec5b9c11b6b53d0807a272a3bc1c89e15e2514625330e14f2948eead8646735020e07407bd922bd267f6291fc17b5fe546abda102e8a4b98db6892da3a3667319cf8faecd6ae2894986135bf70c57ecc804a16b2227841a45435107bc332d285f6a371fbcf02d8561a438cbe3b35edc7d61f2beb652ea73f572b58f0d13321d035228d2b5af3d7ca37eb34249bfbf3a9b61cb23a7720cdce8784e2427c0f80eef99bdf30be5b28e05c6b2b86598583600b9f67118f17e45a15bfe848b30bf981ea959341004e3c5878201a4c65bca7cbcec6418bdadb5da39a5327934257445974dbf78a4d78eb24437e5d48682f57577e58bb3bfc25fb5b9b81c33937b826bc0d944aa03a0dbb4d52f089f687ba4806325df3b202405cf869729579281d072bbdaaf5249e5fda23a8effcfafa36962590d899109289f99df23ab0650d5b9ad82ea2702bcbde4938188242a85628c3bd512141d07f47325c79d4d8769a89687e23bec5e2610609d7daa61df9b6262d5d201bdfa9e1b9aa2a097dc4ef672b7316a938f279217d1f3d1fad3e6a78ed45e37dce5b392502d428a033b48ed6ad6f30d768a25bc87ecf87fd1aff6b49fb210945b25c0f22008b073701ef57dc4eefaf0d19446b6194c36c71a44981aa204934410a3dfabeafd111bc3f8b6de6cc4f18fe6c231e01cf2be512b02e3d97f743213e025273cb059f6e6c9676f95cfa0d611548008868c371405c762bbed35835e99c3b09364e3d707ed5a85b582dc22e915e11336ab0c6a3d02f4bc6dc3bde2e4682c7a734d8524cf2fc7ddabe9047a5982f9c4a77d6824ba686b9f35da27d9eb97d70cfcb45dbec8d1ffce098939c9c5e1a57bf78454be786e8350f7414e7935a24428984f4d020619e8b5b4a5fdfac16bca6700ed0e703638faca53e237f86edd9b77a17e226b0ece2ee6058d2e7ba8012cf48cdb6b6a09be396f2090223e89ffe0aef8e364be947aa8fd0e61529eee51e1f9b792010708dd7e395cac7806107f62fde71b217e1647bb38a645c3cc417bced469ceb42938222f90f76b124c6ef4847f7c020e19b947cf138c685347cee20651aa921b435027d0bee9fbffb74dbbdcf6a2785a2b732721fdec590cc56f92ad8a313d83d4e10d2125a21094cddea7d2e74a85a1d5ecb5151f6925e90d3e249b52566d98f4f867d707b88ab1321665ecf3f48102f2b66dae2dc78454f8ae194a7a05080d19272c7a4fb4dcfff385bd6a92dbde9a8a137c9bbbad98c6449d936e2b7020716745a030a690e173fe252b7a0faad4d451aed50e0af0f05082f626b3057a2f29ceafcf2956f53857f5a8e89d07bcd6b5b7dc66c26dcbb2f387798b632ba3c539527005815c71e6f8bcc7717f9e8dcb895a345acd7122a33a3d22af66446eb798b5bbaba5985c4da115374eb442f753dc9eb76579eb18df17b1e5ef189eb1e39927f9eae998a90e1349578e3ae56c2f2337c7eeb945dc05e22abbf9064af9dc16e04a0ff2096a8ce1f45e0ddbd8b5001892a030bb72df48e878487e2111c2caa926d0527ef4594c96f5bf3d0fc4025f98446a4e1fe9c0e3c4ae27ba191d941fa73ef49299c9029abde309269d8647f2716dff19ad0351857eb31022978c5768cf57e8c78ddc65a3b8d70cef6f80de381705d493f9df15a87180ff5b5817697eb266d2c8f87cf39ab4e1c72ca8423dd554ed7842d4f57b519d66ecc2100f8f5dc98b8f7cf33e9d4d723cd7853d92b890ff3cb12f2b8d37da66ddf10e0a508d60e7c025df16684fa5f8e9e81f9961ba1be70b07b5f0572966158dbb465fe6a5d498cb669e01be9a70c713f57466b051a401dd838e196e9bdf343001badb419f4b65416bcd6464f925ef4b4fffb6869886fd18d908b46aa76049c59443db8764f5b1a4161a4d18db77056cf563f5eba2baf446df9a75e92d1f3b12110db426e1e9c74a3a32cbee0762b27c477d4fb21f34914e7cc9dfb51f8c9a7bfbf9429f94b9a8abaae20c956548144ad9619df3c42e6a49dd52abbe8463b019b747ad19c476c4703afbd6e9bd0e6e46508cf40be67c367aa57900f7e245e6e7a282e60e4533cae7696979a5695521bec3559d76d586a599ff9d2cf53c7c83ffa2d8e8fadd452a793c712a0ae5d7780c8c4fa26c7f0a5e7d98b1a1862b032e02d23376c1163b6ca6bc36cbdb465b54a52088a3e66bbf6b2825dff5816a255f848d2dbe1fba70ee4357e9acf8182d09168da1d429a392b49299d1dea4bda93937b778efe60bf322a3ab85d5b74e9c2e3fbc433ebf572a2676266ae7f0f403ccb8489961c79a6da166ac483fad85564055d4d99532824f6fa1b43bc18c650b304d69f782629acebc5a63222370ae2e2cd93f17615cacfca1133a1228c80a2e05a9aba3e4d006bf21ff4ab3cfc9ababc05f7ca86f47d63baffd598d48a79ffd9cf6493c4be1720ac3b9f3152d2b4948972da3c212196650f34d194783460c80e8825c66a60d8e794acd8b42edda8d14d0d7d05572ffd7e5e23605c039fdcbd7efefb4c1cc7c71e976892985d7ff9deb0ed38a13c01beeddf2c74f78491558360e07827d7ee8fcd4573cb5aaa856f0dc1a5aa7e3ba85ccfd0d846172021dbc57e56c9e0c700295be7ec545fd8cf650c74c4810ad608274e911d1052ea2896814b32d76e9505208942c80f4a95757a345d95d71d221472b3f5c90e1a2e8217e34cc877e786f26f5d456b50ff02deec371343b2d9aafa844e07f9657053157c1dffbd71324419db70cedfd11274c1dde57272536e941d71046637441f076fb4e3ca55f9bec7d748ed5cd4119de96707bc92189a7e3392acc677774cc5cda257c506e82b6507ddead4ee3c0173194bb6fc5161823d4da59b1232f383480146938bf958d6362f01c8042e0c73a898e3fb54113b2631afcc085b0a918ff2ad9949b3abebfee74dbfdacdb62b7ac60eb249022b22dd51a5fd7269b07c9fde30bc1eadb1f2f9d882613d34320f2c97cfc225e9778862ac2412abcd625fd53d448d09661fe9566639c0b231ea9bb6d230dfed65320129db06e57c36c6c6af011a78052f5cb582f2c25e3dcf421b6cba46b580de57ac02cc3dd1c66124ecf85183da95e21e6b385870282f131556d160066c60c1129f67bfc59631fff82a5b856adc5fda24005677e2b809edab3815ff684539d37daac01c88ae1a862fefca4543a327d5207bb00c76dd7ca5ceb8e5d77735335efa2c7d5cd3471d54a241a444ea745501cbddf4ee0decee359b3aa16da43a85499d8b1825ca6123a499782276a926b4db837a10b8cb3a7063e489ca68c23be862fc6d61f9272aebbdedf2840234f51a38316010fcf1f8d8cc8a17ed3000e267a948fc4a8458b51275aa7e0b45e4517885c5f87faac8332848ffe20309f356742bdc1e8641054595e7f1b640f17ac91897c705f1e491a7c8e90988771da3f0fa21cdc2fd804b68a5507c8cb784b668a618d81708f528247eb4bcce4d63a3733dd59a79428c4d02878348f000ad4c8abfb0e3727973b2500cfb3da0c78bb904af5a9dc5b2c78dea6c22911d21436bce8de19ebad51fd45fa7f1cec774396819ebc4c43966288908a80a2cd2d35a14c7b5c6af30625ff094b0c439a6e63d0895322e41a8081555dcbda8a5213d66a107476915109a866835c94817eadd3521eaef802aa60b808b810d0bd7b34a53f89dade1cc826a50a19d6f8b11f6fa5cada9b608be712c9efcc982fc54679d66ac2b631958e8da7c556d38175747a2c375582363b05f1bec1885e6035b3a20d9e891108e6529e2087022596bc035db71babb7e1545e7719b1ec8000b7095ad05b3b4d481715b59ef9beffa0834429ee8d8c41de34ae798a30b858d0ef27dec803a7c74b9e82214cc7048ceca09a2b785acc69e4e08fbf4b5908cd85b1c0e4224090e594ac7a1f36d21bce565e3e543723893354d3a37ce92bcbe8a3a47d4c30012be5fccd8b87ea4c7c2e1102ac82b9a74871dd33ab831f4d7dae19afb317bf4d814b935329ab5193af2bea619ec8c4ee132f40ad6a479381f7cfb6ac03bbc86f6ec7fd7fe1978243915e26e94fd094e3545a639ee8739ed0a64ac8e84273bee4c8a1095e863b3719214ae51cb94c19270441addf7a1a8cc50ebe2716dd828fb0bb07b35cf779305c6acc4042d942b764606e5d100fda65e08263700952cf3c942d05b74c028ca9cf9234fa6250761358472dddcc89368452c6d357d0eed5e0c6487f6d075fd1cc3f7d8c08533ee2afc8e7d05985acf4e434d298538b04c191459f65d8929ee86a40f6a67feb7ef3216174086437b32cf7fb80d356f16f94502a2a05bd430dcdcbfa780fcc741634356a016eb54c60cdbc3552797203d79ad897fbac4bb60af94b27af58bb65bef34ef4648cfd554563eeae22e281b5b26654d9407df705b373463107b2448233dac214fb663e946abeb6500c884f7ea90c78e221e0ebc8a3c636ae34b125697f04a9f3d6573af8d7316dd347963e378865c95fd991275394c6abea58c86f184d42d62d522997c6cb6d6a678ffbeab3e602354835eb9640e6fc965e6ea219946902fbd760ab752999dc4fc0b5baa770785e44fb1a2aee55f41cddbadac1cc9ee919507ae249143dbaf9c94059316b40e60e92123559cbaa6b0995624334b48cc64d0b8d0d91c7627ce880f79c5f247e945fda2a7f6bcd3a628ee75daab0c93ec79df48481756fe38b98051369c7e3f67401a24c39256cb72748c7c35c9f1aaad3e9154ec781e3338a8ac2258d81bc461985cfdb41303d7fb39e6e940c1759c20f914c147a643c6d1213534330cc23d1928ab608cf9d8bd0c8c620058bafa964bfeab4dc9693e11d9d22343e4f5a66b2c209c66f566a9cfa680eb16a76cc1d2296759df5b1c905a77692f9273de88fe2e3fa274c0524e083b9cee87d816673175b2d70d00e94d2fe6697</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>harbor ä½¿ç”¨</title>
    <url>/2019/10/10/harbor-%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h4 id="days-2019-10-10"><a href="#days-2019-10-10" class="headerlink" title="days(2019-10-10)"></a>days(2019-10-10)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢æ–‡ç« ä»‹ç»äº†harborçš„éƒ¨ç½²ï¼Œä»Šå¤©ç¬¬ä¸€æ¬¡å­¦ä¹ å…¥é—¨ä½¿ç”¨ã€‚</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœåŠ¡å™¨å®‰è£…dockerä»¥åï¼Œæˆ‘ä»¬æ€ä¹ˆå§é•œåƒpushåˆ°æˆ‘ä»¬çš„ç§æœ‰ä»“åº“ï¼Œå’Œæ€ä¹ˆå§é•œåƒpullåˆ°æœ¬åœ°ï¼Œé¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šè£…å¤‡dockerç¯å¢ƒ</p><h5 id="è¿æ¥harbor"><a href="#è¿æ¥harbor" class="headerlink" title="è¿æ¥harbor"></a>è¿æ¥harbor</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker login reg.xxlaila.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Error response from daemon: Get https://172.21.16.90/v1/users/: dial tcp reg.xxlaila.cn:443: connect: connection refused</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œç¬¬ä¸€æ¬¡è¿æ¥æŠ¥é”™ï¼ŒDockerè‡ªä»1.3.Xä¹‹ådocker registryäº¤äº’é»˜è®¤ä½¿ç”¨çš„æ˜¯HTTPSï¼Œä½†æ˜¯æˆ‘ä»¬æ­å»ºç§æœ‰é•œåƒé»˜è®¤ä½¿ç”¨çš„æ˜¯HTTPæœåŠ¡ï¼Œæ‰€ä»¥ä¸ç§æœ‰é•œåƒäº¤æ—¶å‡ºç°ä»¥ä¸Šé”™è¯¯ã€‚</p><h5 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h5><ul><li><p>æ–¹æ³•ä¸€: ä¿®æ”¹æˆ–æ·»åŠ é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"insecure-registries"</span> : [<span class="string">"reg.xxlaila.cn"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é‡æ–°å¯åŠ¨dockerï¼Œå¹¶é‡æ–°ç™»å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl restart docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  docker login reg.xxlaila.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure></li><li><p>æ–¹æ³•äºŒï¼šä¿®æ”¹å¯åŠ¨æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/lib/systemd/system/docker.service  </span></span><br><span class="line">ExecStart=/usr/bin/dockerd --insecure-registry reg.xxlaila.cn <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨"><a href="#Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨" class="headerlink" title="Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨"></a>Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨</h5><p><img src="https://img.xxlaila.cn/1570697850857.jpg" alt="img"></p><h5 id="DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾"><a href="#DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾" class="headerlink" title="DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾"></a>DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                     TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/xxlaila/kxl-eureka   v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker tag docker.io/xxlaila/kxl-eureka:v2 reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/xxlaila/kxl-eureka    v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br><span class="line">reg.xxlaila.cn/kxl/kxl-eureka   v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br></pre></td></tr></table></figure><h5 id="ä¸Šä¼ é•œåƒ"><a href="#ä¸Šä¼ é•œåƒ" class="headerlink" title="ä¸Šä¼ é•œåƒ"></a>ä¸Šä¼ é•œåƒ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker push reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line">The push refers to a repository [reg.xxlaila.cn/kxl/kxl-eureka]</span><br><span class="line">f6026bf67b63: Pushed </span><br><span class="line">1489a4b0f1dd: Pushed </span><br><span class="line">2af6e035aa36: Pushed </span><br><span class="line">472cfce4528e: Pushed </span><br><span class="line">071d8bd76517: Pushed </span><br><span class="line">v2: digest: sha256:20d3bc74fdcb2fc4cdfc9066f742c828898c728f7e3f2114498ebe2848b71653 size: 1368</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1570698233987.jpg" alt="img"></p><h5 id="ä¸‹è½½é•œåƒ"><a href="#ä¸‹è½½é•œåƒ" class="headerlink" title="ä¸‹è½½é•œåƒ"></a>ä¸‹è½½é•œåƒ</h5><ul><li><p>åˆ é™¤æœ¬åœ°é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker rmi reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker rmi docker.io/xxlaila/kxl-eureka:v2</span></span><br></pre></td></tr></table></figure></li><li><p>ä¸‹è½½harborä¸Šçš„é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker pull reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line">Trying to pull repository reg.xxlaila.cn/kxl/kxl-eureka ... </span><br><span class="line">v2: Pulling from reg.xxlaila.cn/kxl/kxl-eureka</span><br><span class="line">a02a4930cb5d: Pull complete </span><br><span class="line">6ea3dcbee0db: Extracting [==================================================&gt;]  81.4 MB/81.4 MB</span><br><span class="line">6ea3dcbee0db: Pull complete </span><br><span class="line">c423a7a79cc1: Pull complete </span><br><span class="line">7418081934c1: Pull complete </span><br><span class="line">f89b73853622: Pull complete </span><br><span class="line">Digest: sha256:20d3bc74fdcb2fc4cdfc9066f742c828898c728f7e3f2114498ebe2848b71653</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> reg.xxlaila.cn/kxl/kxl-eureka:v2</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1570698681073.jpg" alt="img"></p><h4 id="days-2019-10-12"><a href="#days-2019-10-12" class="headerlink" title="days(2019-10-12)"></a>days(2019-10-12)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºå…¬å¸éœ€æ±‚ï¼Œå¼€å‘äººå‘˜æ¯”è¾ƒå¤šï¼Œåˆä¸æƒ³ç ”å‘ç”¨ä¸€ä¸ªè´¦å·ï¼Œä¹Ÿä¸æƒ³ç»™ç ”å‘ä¸€ä¸ªä¸ªçš„å¼€è´¦å·ï¼Œä½ç½®harboræ”¯æŒäº†ldapã€‚æœ‰äº†è¿™ä¹ˆä¸€ä¸ªä¸œè¥¿ï¼Œæˆ‘ä»¬å°±èƒ½å¾ˆå¥½çš„ä¸ºç ”å‘åˆ›å»ºè´¦å·æ”¯æŒç ”å‘éšæ—¶æŸ¥çœ‹dockerçš„é•œåƒã€‚</p><h4 id="é…ç½®harbor-ldap"><a href="#é…ç½®harbor-ldap" class="headerlink" title="é…ç½®harbor ldap"></a>é…ç½®harbor ldap</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°ç‰ˆæœ¬çš„harborå¾ˆå¤šä¸œè¥¿éƒ½å¯ä»¥ç›´æ¥åœ¨ç•Œé¢é…ç½®ï¼Œä¸éœ€è¦å»ä¿®æ”¹æ–‡ä»¶ï¼Œçœå»äº†å¤§é‡çš„å·¥ä½œï¼Œwebç•Œé¢é…ç½®æ›´åŠ æ–¹ä¾¿å¿«æ·ï¼Œç™»å½•harborå¹³å°ï¼Œç‚¹å‡»é…ç½®ç®¡ç†â€”â€”&gt;ä¿®æ”¹è®¤è¯æ¨¡å¼ï¼Œè®¤è¯æ¨¡å¼æ”¯æŒå¾ˆå¤šç±»å‹ï¼Œè¿™é‡Œé€‰æ‹©ldapã€‚<br><img src="https://img.xxlaila.cn/1571019665079.jpg" alt="img"><br><strong>æ³¨</strong>: åœ¨å¯†ç è¿™æ å¡«å†™éœ€è¦å¡«å†™ç®¡ç†å‘˜çš„å¯†ç ï¼Œæ™®é€šç”¨æˆ·çš„å¯†ç æ˜¯ä¸è¡Œçš„ï¼Œå³ä½¿æ˜¯åœ¨ç®¡ç†å‘˜çš„ç”¨æˆ·ä¹Ÿæ˜¯ä¸è¡Œçš„ã€‚<br>ç‚¹å‡»æµ‹è¯•ldapï¼Œæç¤ºè¿æ¥æˆåŠŸåä¿å­˜<br><img src="https://img.xxlaila.cn/1571019741060.jpg" alt="img"></p><h4 id="é…ç½®é‚®ç®±"><a href="#é…ç½®é‚®ç®±" class="headerlink" title="é…ç½®é‚®ç®±"></a>é…ç½®é‚®ç®±</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨é…ç½®ldapé¡µé¢æ—è¾¹æœ‰ä¸€ä¸ªé‚®ç®±é…ç½®ï¼Œé‚®ä»¶æœåŠ¡å™¨ç”¨äºå‘è¯·æ±‚é‡è®¾å¯†ç çš„ç”¨æˆ·å‘é€å“åº”ã€‚<br><img src="https://img.xxlaila.cn/1570873497729.jpg" alt="img"><br>ç‚¹å‡»æµ‹è¯•ï¼Œæµ‹è¯•æ²¡é—®é¢˜ä¹‹åç‚¹å‡»ä¿å­˜ã€‚</p><h4 id="æµ‹è¯•ladpè¿æ¥"><a href="#æµ‹è¯•ladpè¿æ¥" class="headerlink" title="æµ‹è¯•ladpè¿æ¥"></a>æµ‹è¯•ladpè¿æ¥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°æ‰“å¼€ä¸€ä¸ªä¸€ä¸ªæµè§ˆå™¨çª—å£ï¼Œåˆ©ç”¨ladpè´¦æˆ·è¿›è¡Œç™»å½•ã€‚<br><img src="https://img.xxlaila.cn/1571019859287.jpg" alt="img"><br><strong>æ³¨é‡Š</strong>: æ–°ç‰ˆæœ¬çš„åœ¨ç™»å½•ç•Œé¢æ²¡æœ‰ä»€ä¹ˆé€‰æ‹©ldapç™»å½•ï¼Œç›´æ¥ä½¿ç”¨ldapè´¦å·ç™»å½•å°±ok</p><h4 id="å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP-ADç»„"><a href="#å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP-ADç»„" class="headerlink" title="å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP / ADç»„"></a>å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP / ADç»„</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¿®æ”¹ä¹‹å‰çš„ldapé…ç½®ï¼Œå¢åŠ ç»„çš„é…ç½®<br><img src="https://img.xxlaila.cn/1571023069387.jpg" alt="img"><br>åœ¨é¡¹ç›®-&gt;æˆå‘˜-&gt; +ç»„ä¸­ã€‚<br><img src="https://img.xxlaila.cn/1571023177214.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571023223796.jpg" alt="img"></p><h4 id="è®¾ç½®ldapè´¦æˆ·çš„æƒé™"><a href="#è®¾ç½®ldapè´¦æˆ·çš„æƒé™" class="headerlink" title="è®¾ç½®ldapè´¦æˆ·çš„æƒé™"></a>è®¾ç½®ldapè´¦æˆ·çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“ldapé…ç½®ä»¥åï¼Œldapè´¦æˆ·ç™»å½•æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œæˆ‘ä»¬ç®¡ç†harborè¿˜çš„ä½¿ç”¨<code>harbor</code>çš„adminè´¦æˆ·ç™»å½•ï¼Œè¿™æ ·æ— ç–‘å¯¹è¿ç»´äººå‘˜ç»´æŠ¤å¸¦æ¥äº†ä¸ä¾¿åˆ©ã€‚å½“ldapç”¨æˆ·ç™»å½•ï¼Œharborå°±ä¼šè®°å½•è¯¥ç”¨æˆ·ï¼Œæˆ‘ä»¬è®¾ç½®è¿ç»´ç”¨æˆ·ä¸ºè¶…çº§ç®¡ç†å‘˜ï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªè´¦å·ç™»å½•ï¼Œç»´æŠ¤çš„æ—¶å€™ä¹Ÿä¸ç”¨è´¦å·åˆ‡æ¢<br><img src="https://img.xxlaila.cn/1571023451423.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>harbor</tag>
      </tags>
  </entry>
  <entry>
    <title>HPAè®¤è¯†</title>
    <url>/2019/10/09/hpa/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="Pod-è‡ªåŠ¨æ‰©ç¼©å®¹"><a href="#Pod-è‡ªåŠ¨æ‰©ç¼©å®¹" class="headerlink" title="Pod è‡ªåŠ¨æ‰©ç¼©å®¹"></a>Pod è‡ªåŠ¨æ‰©ç¼©å®¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesæä¾›äº†è¿™æ ·ä¸€ä¸ªèµ„æºå¯¹è±¡: <code>Horizontal Pod Autoscaling</code> Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼‰ï¼Œç®€ç§°HPAã€‚HAPé€šè¿‡ç›‘æ§åˆ†æRCæˆ–è€…Deploymentæ§åˆ¶çš„æ‰€æœ‰Podçš„è´Ÿè½½å˜åŒ–æƒ…å†µæ¥ç¡®å®šæ˜¯å¦éœ€è¦è°ƒæ•´Podçš„å‰¯æœ¬æ•°é‡ï¼Œè¿™æ˜¯HPAæœ€åŸºæœ¬çš„åŸç†ã€‚</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1570605234009.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HPAåœ¨kubernetesé›†ç¾¤ä¸­è¢«è®¾è®¡æˆä¸€ä¸ªKubernetes APIèµ„æºå’Œæ§åˆ¶å™¨ï¼Œå¯ä»¥é€šè¿‡kubectl autoscaleå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªHPAèµ„æºå¯¹è±¡ï¼ŒHPA Controlleré»˜è®¤15sè½®è¯¢ä¸€æ¬¡ï¼ˆå¯é€šè¿‡kube-controller-managerçš„æ ‡å¿—â€“horizontal-pod-autoscaler-sync-periodè¿›è¡Œè®¾ç½®ï¼‰ï¼ŒæŸ¥è¯¢æŒ‡å®šçš„èµ„æºï¼ˆRCæˆ–è€…Deploymentï¼‰ä¸­Podçš„èµ„æºä½¿ç”¨ç‡ï¼Œå¹¶ä¸”ä¸åˆ›å»ºæ—¶è®¾å®šçš„å€¼å’ŒæŒ‡æ ‡åšå¯¹æ¯”ï¼Œä»è€Œå®ç°è‡ªåŠ¨ä¼¸ç¼©çš„åŠŸèƒ½ã€‚<br><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener">è¯¦ç»†ä»‹ç»</a></p><h3 id="Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ "><a href="#Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ " class="headerlink" title="Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ "></a>Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ </h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºHorizontal Pod Autoscalerä½¿ç”¨æ­¤APIæ”¶é›†æŒ‡æ ‡ï¼Œå› æ­¤éœ€è¦åœ¨ç¾¤é›†ä¸­éƒ¨ç½²metrics-serverç›‘è§†ä»¥é€šè¿‡èµ„æºæŒ‡æ ‡APIæä¾›æŒ‡æ ‡,</p><h4 id="è¿è¡Œphp-apacheæœåŠ¡å™¨"><a href="#è¿è¡Œphp-apacheæœåŠ¡å™¨" class="headerlink" title="è¿è¡Œphp-apacheæœåŠ¡å™¨"></a>è¿è¡Œphp-apacheæœåŠ¡å™¨</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†å¼€å§‹è¿è¡Œè¯¥æ˜ åƒçš„éƒ¨ç½²ï¼Œå¹¶å°†å…¶æœåŠ¡å…¬å¼€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run php-apache --image=0layfolk0/hpa-example --requests=cpu=200m --limits=cpu=500m --expose --port=80</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">service/php-apache created</span><br><span class="line">deployment.apps/php-apache created</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨"><a href="#åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨" class="headerlink" title="åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨"></a>åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æœåŠ¡è¿è¡Œä»¥åã€‚æˆ‘ä»¬å°†ä½¿ç”¨kubectl autoscaleåˆ›å»ºè‡ªåŠ¨ ç¼©æ”¾å™¨ã€‚ä»¥ä¸‹å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œè¯¥ç¼©æ”¾å™¨å°†ç»´æŠ¤ç”±æˆ‘ä»¬åœ¨è¿™äº›è¯´æ˜çš„ç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„php-apacheéƒ¨ç½²æ§åˆ¶çš„Podçš„1è‡³10ä¸ªå‰¯æœ¬ã€‚ç²—ç•¥åœ°è¯´ï¼ŒHPAå°†ï¼ˆé€šè¿‡éƒ¨ç½²ï¼‰å¢åŠ æˆ–å‡å°‘å‰¯æœ¬æ•°ï¼Œä»¥å°†æ‰€æœ‰Podçš„å¹³å‡CPUåˆ©ç”¨ç‡ç»´æŒåœ¨50ï¼…ï¼ˆå› ä¸ºæ¯ä¸ªpodé€šè¿‡kubectlè¿è¡Œè¯·æ±‚200æ¯«æ ¸ï¼Œè¿™æ„å‘³ç€å¹³å‡CPUåˆ©ç”¨ç‡ä¸º100æ¯«-æ ¸å¿ƒï¼‰ã€‚<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#algorithm-details" target="_blank" rel="noopener">ç®—æ³•æ›´å¤šä¿¡æ¯</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span><br><span class="line">horizontalpodautoscaler.autoscaling/php-apache autoscaled</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥è‡ªåŠ¨å®šæ ‡å™¨çš„å½“å‰çŠ¶æ€:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         10        1          14s</span><br></pre></td></tr></table></figure><p><strong>æ³¨é‡Š</strong>: ç”±äºæˆ‘ä»¬æ²¡æœ‰å‘æœåŠ¡å™¨å‘é€ä»»ä½•è¯·æ±‚ï¼Œå› æ­¤å½“å‰CPUæ¶ˆè€—ä¸º0ï¼…ï¼ˆâ€œ CURRENTâ€åˆ—æ˜¾ç¤ºäº†ç”±ç›¸åº”éƒ¨ç½²æ§åˆ¶çš„æ‰€æœ‰Podçš„å¹³å‡å€¼ï¼‰ã€‚</p><h4 id="å¢åŠ å‹åŠ›æµ‹è¯•"><a href="#å¢åŠ å‹åŠ›æµ‹è¯•" class="headerlink" title="å¢åŠ å‹åŠ›æµ‹è¯•"></a>å¢åŠ å‹åŠ›æµ‹è¯•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨æˆ‘ä»¬è¦å¯¹<code>php-apache</code>åšå‹åŠ›æµ‹è¯•æ¥è§‚çœ‹è‡ªåŠ¨ç¼©æ”¾å¦‚ä½•å¯¹å¢åŠ çš„è´Ÿè½½åšå‡ºååº”ï¼Œæˆ‘ä»¬å°†å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶å°†æ— é™å¾ªç¯çš„æŸ¥è¯¢å‘é€åˆ°php-apacheæœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty load-generator --image=busybox /bin/sh</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # while true; do wget -q -O- http://php-apache.default.svc.cluster.local; done</span></span><br><span class="line"><span class="string">OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!O</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸€åˆ†é’Ÿå·¦å³çš„æ—¶é—´å†…ï¼Œæˆ‘ä»¬åº”è¯¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥çœ‹åˆ°æ›´é«˜çš„CPUè´Ÿè½½ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   250%/50%   1         10        1          9m12s</span><br><span class="line"></span><br><span class="line">$ kubectl get deployment php-apache</span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   3/5     5            3           88m</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”±äºç½‘ç»œé—®é¢˜å’Œpull é•œåƒå¤ªæ…¢äº†ï¼Œæˆ‘å°±ç›´æ¥ç»“æŸäº†æµ‹è¯•</p><h4 id="åœæ­¢å‹åŠ›æµ‹è¯•"><a href="#åœæ­¢å‹åŠ›æµ‹è¯•" class="headerlink" title="åœæ­¢å‹åŠ›æµ‹è¯•"></a>åœæ­¢å‹åŠ›æµ‹è¯•</h4><p>æˆ‘ä»¬åœ¨<code>busybox</code>å®¹å™¨çš„ç»ˆç«¯é‡Œé¢æ‰§è¡Œ<code>&lt;Ctrl&gt; + C</code>æ¥ç»“æŸå‹åŠ›æµ‹è¯•ï¼Œç„¶åæˆ‘ä»¬åœ¨è§‚å¯Ÿç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   91%/50%   1         10        5          10m</span><br><span class="line"></span><br><span class="line">$ kubectl get deployment php-apache</span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   2/2     2            2           99m</span><br></pre></td></tr></table></figure><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener">è‡ªåŠ¨ç¼©æ”¾å¤šä¸ªæŒ‡æ ‡å’Œè‡ªå®šä¹‰æŒ‡æ ‡</a></p><h3 id="nginx-æµ‹è¯•"><a href="#nginx-æµ‹è¯•" class="headerlink" title="nginx æµ‹è¯•"></a>nginx æµ‹è¯•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ©ç”¨ä¹‹å‰<a href="https://xxlaila.github.io/2019/10/09/Deployment%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">Deployment</a>é‡Œé¢çš„nginxåšæµ‹è¯•ï¼Œæˆ‘ä»¬åªéœ€è¦å§ä¹‹å‰çš„yamlæ–‡ä»¶ç¨ä½œä¿®æ”¹å³å¯</p><h4 id="ä¿®æ”¹nginx-deployment-yaml"><a href="#ä¿®æ”¹nginx-deployment-yaml" class="headerlink" title="ä¿®æ”¹nginx-deployment.yaml"></a>ä¿®æ”¹nginx-deployment.yaml</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-deploy</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-deploy</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"200Mi"</span></span><br><span class="line">            cpu: <span class="string">"200m"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="æ–°å»ºç«‹nginx-deploy-hpa-yaml"><a href="#æ–°å»ºç«‹nginx-deploy-hpa-yaml" class="headerlink" title="æ–°å»ºç«‹nginx-deploy-hpa.yaml"></a>æ–°å»ºç«‹nginx-deploy-hpa.yaml</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deploy-hpa.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 5</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: extensions/v1beta1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx-deploy</span><br><span class="line">  targetCPUUtilizationPercentage: 10</span><br><span class="line">status:</span><br><span class="line">  currentCPUUtilizationPercentage: 8</span><br><span class="line">  currentReplicas: 1</span><br><span class="line">  desiredReplicas: 0</span><br></pre></td></tr></table></figure><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">$ kubectl apply -f kubectl apply -f nginx-deploy-hpa.yaml</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   0%/10%    1         5         2          45s</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       8m28s</span><br><span class="line">nginx-deploy-d494b9564      2         2         2       13m</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œå‹åŠ›æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty load-generator --image=busybox /bin/sh</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # while true; do wget -q -O- http://172.30.224.5:80; done</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ•ˆæœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   28%/10%   1         5         4          4m48s</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       12m</span><br><span class="line">nginx-deploy-d494b9564      5         5         5       18m</span><br><span class="line"></span><br><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   16%/10%   1         5         5          5m39s</span><br></pre></td></tr></table></figure></li><li><p>ç»“æŸå‹æµ‹<br>ç­‰å¾…ä¸€ä¼šæŸ¥çœ‹ç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   0%/10%    1         5         1          12m</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       19m</span><br><span class="line">nginx-deploy-d494b9564      1         1         1       25m</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>hpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Deploymentä½¿ç”¨</title>
    <url>/2019/10/09/Deployment%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="Deploymentå’Œrcçš„å¯¹æ¯”"><a href="#Deploymentå’Œrcçš„å¯¹æ¯”" class="headerlink" title="Deploymentå’Œrcçš„å¯¹æ¯”"></a>Deploymentå’Œrcçš„å¯¹æ¯”</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆRCæ˜¯Kubernetesçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå½“æˆ‘ä»¬æŠŠåº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤ä¹‹åï¼Œéœ€è¦ä¿è¯åº”ç”¨èƒ½å¤ŸæŒç»­ç¨³å®šçš„è¿è¡Œï¼ŒRCå°±æ˜¯è¿™ä¸ªä¿è¯çš„å…³é”®ï¼Œä¸»è¦åŠŸèƒ½å¦‚:</p><ul><li>ç¡®ä¿Podæ•°é‡: å®ƒä¼šç¡®ä¿Kubernetesä¸­æœ‰æŒ‡å®šæ•°é‡çš„Podåœ¨è¿è¡Œï¼Œå¦‚æœå°‘äºæŒ‡å®šæ•°é‡çš„Podï¼ŒRCå°±ä¼šåˆ›å»ºæ–°çš„ï¼Œåä¹‹è¿™ä¼šåˆ é™¤å¤šä½™çš„ï¼Œä¿è¯Podçš„å‰¯æœ¬æ•°é‡ä¸å˜ã€‚</li><li>ç¡®ä¿Podå¥åº·: å½“Podä¸å¥åº·ï¼Œæ¯”å¦‚è¿è¡Œå‡ºé”™äº†ï¼Œæ€»ä¹‹æ— æ³•æä¾›æ­£å¸¸æœåŠ¡æ—¶ï¼ŒRCä¹Ÿä¼šæ€æ­»ä¸å¥åº·çš„Podï¼Œé‡æ–°åˆ›å»ºæ–°çš„ã€‚</li><li>å¼¹æ€§ä¼¸ç¼©: åœ¨ä¸šåŠ¡é«˜å³°æˆ–è€…ä½å³°çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨è¿‡RCæ¥åŠ¨æ€çš„è°ƒæ•´Podæ•°é‡æ¥æä¾›èµ„æºçš„åˆ©ç”¨ç‡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡å¦‚æœä½¿ç”¨HPAè¿™ç§èµ„æºå¯¹è±¡çš„è¯å¯ä»¥åšåˆ°è‡ªåŠ¨ä¼¸ç¼©ã€‚</li><li>æ»šåŠ¨å‡çº§: æ»šåŠ¨å‡çº§æ˜¯ä¸€ç§å¹³æ»‘çš„å‡çº§æ–¹å¼ï¼Œé€šè¿‡é€æ­¥æ›¿æ¢çš„ç­–ç•¥ï¼Œä¿è¯æ•´ä½“ç³»ç»Ÿçš„ç¨³å®šæ€§</li></ul><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeploymentåŒæ ·ä¹Ÿæ˜¯Kubernetesç³»ç»Ÿçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œä¸»è¦èŒè´£å’ŒRCä¸€æ ·çš„éƒ½æ˜¯ä¿è¯Podçš„æ•°é‡å’Œå¥åº·ï¼ŒäºŒè€…å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªå‡çº§ç‰ˆçš„RCæ§åˆ¶å™¨ï¼ŒDeploymentå…·å¤‡çš„æ–°ç‰¹æ€§</p><ul><li>RCçš„å…¨éƒ¨åŠŸèƒ½: Deploymentå…·å¤‡ä¸Šé¢æè¿°çš„RCçš„å…¨éƒ¨åŠŸèƒ½</li><li>äº‹ä»¶å’ŒçŠ¶æ€æŸ¥çœ‹: å¯ä»¥æŸ¥çœ‹Deploymentçš„å‡çº§è¯¦ç»†è¿›åº¦å’ŒçŠ¶æ€</li><li>å›æ»š: å½“å‡çº§Podçš„æ—¶å€™å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å›æ»šæ“ä½œå›æ»šåˆ°ä¹‹å‰çš„ä»»ä¸€ç‰ˆæœ¬</li><li>ç‰ˆæœ¬è®°å½•: æ¯ä¸€æ¬¡å¯¹Deploymentçš„æ“ä½œï¼Œéƒ½èƒ½å¤Ÿä¿å­˜ä¸‹æ¥ï¼Œè¿™ä¹Ÿæ˜¯ä¿è¯å¯ä»¥å›æ»šåˆ°ä»»ä¸€ç‰ˆæœ¬çš„åŸºç¡€</li><li>æš‚åœå’Œå¯åŠ¨: å¯¹äºæ¯ä¸€æ¬¡å‡çº§éƒ½èƒ½å¤Ÿéšæ—¶æš‚åœå’Œå¯åŠ¨</li></ul><p><strong>å¯¹æ¯”</strong>: Deploymentä½œä¸ºæ–°ä¸€ä»£çš„RCï¼Œåœ¨åŠŸèƒ½ä¸Šæ›´ä¸ºä¸°å¯Œï¼ŒåŒæ—¶å®˜æ–¹ä¹Ÿæ˜¯æ¨èä½¿ç”¨Deploymentæ¥ç®¡ç†Podï¼Œæ¯”å¦‚ä¸€äº›å®˜æ–¹ç»„ä»¶kube-dnsã€kube-proxyä¹Ÿéƒ½æ˜¯ä½¿ç”¨çš„Deploymentæ¥ç®¡ç†çš„ï¼Œæ‰€ä»¥æœ€å¥½ä½¿ç”¨Deploymentæ¥ç®¡ç†Podã€‚</p><h3 id="Deployment-ä»‹ç»"><a href="#Deployment-ä»‹ç»" class="headerlink" title="Deployment ä»‹ç»"></a>Deployment ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Deploymentæ‹¥æœ‰å¤šä¸ªReplica Setï¼Œè€Œä¸€ä¸ªReplica Setæ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªPodã€‚ä¸€ä¸ªDeploymentæ§åˆ¶å¤šä¸ªrsä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒå›æ»šæœºåˆ¶ï¼Œæ¯å½“Deploymentæ“ä½œæ—¶ï¼ŒKubernetesä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªReplica Setå¹¶ä¿ç•™ï¼Œä»¥åæœ‰éœ€è¦çš„è¯å°±å¯ä»¥å›æ»šè‡³ä¹‹å‰çš„çŠ¶æ€ã€‚</p><p><strong>å®ä¾‹</strong>: åˆ›å»ºä¸€ä¸ªDeploymentï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªReplica Setæ¥å¯åŠ¨3ä¸ªnginx podï¼Œyamlæ–‡ä»¶å¦‚ä¸‹:</p><ul><li><p>nginx-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f nginx-deployment.yaml</span><br><span class="line">deployment.apps/nginx-deploy created</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œä¸€ä¸‹å‘½ä»¤æŸ¥çœ‹åˆšåˆšåˆ›å»ºçš„Deployment</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   0/3     3            0           12s</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡æ‰§è¡Œä¸Šé¢å‘½ä»¤</span></span><br><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   1/3     3            1           35s</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥çœ‹åˆ°Deploymentå·²ç»åˆ›å»ºäº†1ä¸ªReplica Setäº†ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹rså’Œpod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get rs</span><br><span class="line">NAME                     DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d   3         3         2       70s</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ kubectl get pod --show-labels</span><br><span class="line">NAME                           READY   STATUS              RESTARTS   AGE   LABELS</span><br><span class="line">nginx-deploy-6dd86d77d-9n9vf   1/1     Running             0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br><span class="line">nginx-deploy-6dd86d77d-bhrsk   0/1     ContainerCreating   0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br><span class="line">nginx-deploy-6dd86d77d-jdnrh   1/1     Running             0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br></pre></td></tr></table></figure></li></ul><p>ä¸Šé¢çš„Deploymentçš„yamlæ–‡ä»¶ä¸­çš„replicas:3å°†ä¼šä¿è¯æˆ‘ä»¬å§‹ç»ˆæœ‰3ä¸ªPODåœ¨è¿è¡Œã€‚</p><h3 id="æ»šåŠ¨å‡çº§"><a href="#æ»šåŠ¨å‡çº§" class="headerlink" title="æ»šåŠ¨å‡çº§"></a>æ»šåŠ¨å‡çº§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¿®æ”¹ä¹‹å‰ä½¿ç”¨çš„nginx-deployment.yamlæ–‡ä»¶ä¸­çš„nginxé•œåƒä¿®æ”¹ä¸ºnginx:1.13.3ï¼Œç„¶ååœ¨specä¸‹é¢æ·»åŠ æ»šåŠ¨å‡çº§ç­–ç•¥ï¼š</p><ul><li><p>nginx-deploments.yml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure></li><li><p>minReadySeconds:</p><ul><li>æ»šåŠ¨å‡çº§æ—¶5såè®¤ä¸ºè¯¥podå°±ç»ª</li><li>å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼ŒKubernetesä¼šå‡è®¾è¯¥å®¹å™¨å¯åŠ¨èµ·æ¥åå°±æä¾›æœåŠ¡äº†</li><li>å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼Œåœ¨æŸäº›æç«¯æƒ…å†µä¸‹å¯èƒ½ä¼šé€ æˆæœåŠ¡ä¸æ­£å¸¸è¿è¡Œ</li></ul></li><li><p>rollingUpdate:</p><ul><li>äºreplicasä¸º3,åˆ™æ•´ä¸ªå‡çº§,podä¸ªæ•°åœ¨2-4ä¸ªä¹‹é—´</li></ul></li><li><p>maxSurge:</p><ul><li>å‡çº§è¿‡ç¨‹ä¸­æœ€å¤šå¯ä»¥æ¯”åŸå…ˆè®¾ç½®å¤šå‡ºçš„PODæ•°é‡</li><li>ä¾‹å¦‚ï¼šmaxSurage=1ï¼Œreplicas=3,åˆ™è¡¨ç¤ºKubernetesä¼šå…ˆå¯åŠ¨1ä¸€ä¸ªæ–°çš„Podåæ‰åˆ æ‰ä¸€ä¸ªæ—§çš„PODï¼Œæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰3+1ä¸ªPODã€‚</li></ul></li><li><p>maxUnavaible:</p><ul><li>å‡çº§è¿‡ç¨‹ä¸­æœ€å¤šæœ‰å¤šå°‘ä¸ªPODå¤„äºæ— æ³•æä¾›æœåŠ¡çš„çŠ¶æ€</li><li>å½“maxSurgeä¸ä¸º0æ—¶ï¼Œè¯¥å€¼ä¹Ÿä¸èƒ½ä¸º0</li><li>ä¾‹å¦‚ï¼šmaxUnavaible=1ï¼Œåˆ™è¡¨ç¤ºKubernetesæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰1ä¸ªPODå¤„äºæ— æ³•æœåŠ¡çš„çŠ¶æ€ã€‚</li></ul></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">deployment.apps/nginx-deploy configured</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨rolloutå‘½ä»¤</span></span><br><span class="line">$ kubectl rollout status deployment/nginx-deploy</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line"></span><br><span class="line"><span class="comment"># æš‚åœå‡çº§</span></span><br><span class="line">$ kubectl rollout pause deployment deployment/nginx-deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­å‡çº§</span></span><br><span class="line">$ kubectl rollout resume deployment deployment/nginx-deploy</span><br></pre></td></tr></table></figure></li></ul><p>å‡çº§ç»“æŸåï¼Œç»§ç»­æŸ¥çœ‹rsçš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    0         0         0       21m</span><br><span class="line">nginx-deploy-799d666985   3         3         3       10m</span><br></pre></td></tr></table></figure><p>æ ¹æ®AGEæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¦»æˆ‘ä»¬æœ€è¿‘çš„å½“å‰çŠ¶æ€æ˜¯ï¼š3ï¼Œå’Œæˆ‘ä»¬çš„yamlæ–‡ä»¶æ˜¯ä¸€è‡´çš„ï¼Œè¯æ˜å‡çº§æˆåŠŸäº†ã€‚ç”¨describeå‘½ä»¤å¯ä»¥æŸ¥çœ‹å‡çº§çš„å…¨éƒ¨ä¿¡æ¯:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe deploy nginx-deploy</span><br><span class="line">Name:                   nginx-deploy</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Wed, 09 Oct 2019 10:12:56 +0800</span><br><span class="line">Labels:                 k8s-app=nginx-demo</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 2</span><br><span class="line">                        kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                          &#123;<span class="string">"apiVersion"</span>:<span class="string">"apps/v1beta1"</span>,<span class="string">"kind"</span>:<span class="string">"Deployment"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"labels"</span>:&#123;<span class="string">"k8s-app"</span>:<span class="string">"nginx-demo"</span>&#125;,<span class="string">"name"</span>:<span class="string">"nginx-deploy"</span>,<span class="string">"nam...</span></span><br><span class="line"><span class="string">Selector:               app=nginx</span></span><br><span class="line"><span class="string">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span></span><br><span class="line"><span class="string">StrategyType:           RollingUpdate</span></span><br><span class="line"><span class="string">MinReadySeconds:        5</span></span><br><span class="line"><span class="string">RollingUpdateStrategy:  1 max unavailable, 1 max surge</span></span><br><span class="line"><span class="string">Pod Template:</span></span><br><span class="line"><span class="string">  Labels:  app=nginx</span></span><br><span class="line"><span class="string">  Containers:</span></span><br><span class="line"><span class="string">   nginx:</span></span><br><span class="line"><span class="string">    Image:        nginx:1.13.3</span></span><br><span class="line"><span class="string">    Port:         80/TCP</span></span><br><span class="line"><span class="string">    Host Port:    0/TCP</span></span><br><span class="line"><span class="string">    Environment:  &lt;none&gt;</span></span><br><span class="line"><span class="string">    Mounts:       &lt;none&gt;</span></span><br><span class="line"><span class="string">  Volumes:        &lt;none&gt;</span></span><br><span class="line"><span class="string">Conditions:</span></span><br><span class="line"><span class="string">  Type           Status  Reason</span></span><br><span class="line"><span class="string">  ----           ------  ------</span></span><br><span class="line"><span class="string">  Available      True    MinimumReplicasAvailable</span></span><br><span class="line"><span class="string">  Progressing    True    NewReplicaSetAvailable</span></span><br><span class="line"><span class="string">OldReplicaSets:  &lt;none&gt;</span></span><br><span class="line"><span class="string">NewReplicaSet:   nginx-deploy-799d666985 (3/3 replicas created)</span></span><br><span class="line"><span class="string">Events:</span></span><br><span class="line"><span class="string">  Type    Reason             Age   From                   Message</span></span><br><span class="line"><span class="string">  ----    ------             ----  ----                   -------</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  23m   deployment-controller  Scaled up replica set nginx-deploy-6dd86d77d to 3</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 1</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 2</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 2</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 1</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 3</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  10m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 0</span></span><br></pre></td></tr></table></figure><h3 id="å›æ»šDeployment"><a href="#å›æ»šDeployment" class="headerlink" title="å›æ»šDeployment"></a>å›æ»šDeployment</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢å·²ç»æ»šåŠ¨å¹³æ»‘çš„å‡çº§Deploymentï¼Œä½†æ˜¯å¦‚æœå‡çº§åçš„PODå‡ºäº†é—®é¢˜è¯¥æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬èƒ½å¤Ÿæƒ³åˆ°çš„æœ€å¥½æœ€å¿«çš„æ–¹å¼å½“ç„¶æ˜¯å›é€€åˆ°ä¸Šä¸€æ¬¡èƒ½å¤Ÿæä¾›æ­£å¸¸å·¥ä½œçš„ç‰ˆæœ¬ï¼ŒDeploymentå°±ä¸ºæˆ‘ä»¬æä¾›äº†å›æ»šæœºåˆ¶ã€‚</p><ul><li>é¦–å…ˆï¼ŒæŸ¥çœ‹Deploymentçš„å‡çº§å†å²:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment nginx-deploy</span><br><span class="line">deployment.extensions/nginx-deploy </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºåœ¨æ‰§è¡ŒDeploymentå‡çº§çš„æ—¶å€™æœ€å¥½å¸¦ä¸Šrecordå‚æ•°ï¼Œä¾¿äºæˆ‘ä»¬æŸ¥çœ‹å†å²ç‰ˆæœ¬ä¿¡æ¯ã€‚<code>kubectl apply --filename=nginx-deployment.yaml --record=true</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰é€šè¿‡kubectl xxxx â€“recordéƒ½ä¼šè¢«kubernetesè®°å½•åˆ°etcdè¿›è¡ŒæŒä¹…åŒ–ï¼Œè¿™æ— ç–‘ä¼šå ç”¨èµ„æºï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæ—¶é—´ä¹…äº†ï¼Œå½“ä½ kubectl get rsæ—¶ï¼Œä¼šæœ‰æˆç™¾ä¸Šåƒçš„åƒåœ¾RSè¿”å›ï¼Œè¿™å¯¹äºè¿ç»´æ¥è¯´ç»´æŠ¤å¾ˆä¸ä¾¿åˆ©ï¼Œ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬åœ¨ä¸Šç”Ÿäº§æ—¶ï¼Œæˆ‘ä»¬æœ€å¥½é€šè¿‡è®¾ç½®Deploymentçš„.spec.revisionHistoryLimitæ¥é™åˆ¶æœ€å¤§ä¿ç•™çš„revision numberï¼Œæ¯”å¦‚15ä¸ªç‰ˆæœ¬ï¼Œå›æ»šçš„æ—¶å€™ä¸€èˆ¬åªä¼šå›æ»šåˆ°æœ€è¿‘çš„å‡ ä¸ªç‰ˆæœ¬å°±è¶³å¤Ÿäº†ã€‚å…¶å®rollout historyä¸­è®°å½•çš„revisionéƒ½å’ŒReplicaSetsä¸€ä¸€å¯¹åº”ã€‚å¦‚æœæ‰‹åŠ¨deleteæŸä¸ªReplicaSetï¼Œå¯¹åº”çš„rollout historyå°±ä¼šè¢«åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯è¿˜è¯´ä½ æ— æ³•å›æ»šåˆ°è¿™ä¸ªrevisonã€‚rollout historyå’ŒReplicaSetçš„å¯¹åº”å…³ç³»ï¼Œå¯ä»¥åœ¨kubectl describe rs $RSNAMEè¿”å›çš„revisionå­—æ®µä¸­å¾—åˆ°ï¼Œè¿™é‡Œçš„revisionå°±å¯¹åº”ç€rollout historyè¿”å›çš„revisonã€‚</p><ul><li><p>yamlä¾‹å­</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat nginx-deployment.yaml </span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å•ä¸ªrevisonçš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment nginx-deploy --revision=2</span><br><span class="line">deployment.extensions/nginx-deploy with revision <span class="comment">#2</span></span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:	app=nginx</span><br><span class="line">	pod-template-hash=799d666985</span><br><span class="line">  Annotations:	kubernetes.io/change-cause: kubectl apply --filename=nginx-deployment.yaml --record=<span class="literal">true</span></span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:	nginx:1.13.3</span><br><span class="line">    Port:	80/TCP</span><br><span class="line">    Host Port:	0/TCP</span><br><span class="line">    Environment:	&lt;none&gt;</span><br><span class="line">    Mounts:	&lt;none&gt;</span><br><span class="line">  Volumes:	&lt;none&gt;</span><br></pre></td></tr></table></figure></li><li><p>ç›´æ¥å›é€€åˆ°å½“å‰ç‰ˆæœ¬çš„å‰ä¸€ä¸ªç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout undo deployment nginx-deploy</span><br><span class="line">deployment.extensions/nginx-deploy rolled back</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥ç”¨revisionå›é€€åˆ°æŒ‡å®šçš„ç‰ˆæœ¬</span></span><br><span class="line">$ kubectl rollout undo deployment nginx-deploy --to-revision=1</span><br><span class="line">deployment.extensions/nginx-deploy rolled back</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹Deploymentç°åœ¨çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   2/3     3            2           56m</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    1         1         1       56m</span><br><span class="line">nginx-deploy-799d666985   3         3         1       46m</span><br><span class="line"></span><br><span class="line">$ kubectl rollout status deployment/nginx-deploy</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 of 3 updated replicas are available...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 of 3 updated replicas are available...</span><br><span class="line">deployment <span class="string">"nginx-deploy"</span> successfully rolled out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ŒæˆåæŸ¥çœ‹</span></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    0         0         0       57m</span><br><span class="line">nginx-deploy-799d666985   3         3         3       47m</span><br></pre></td></tr></table></figure></li></ul><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Deployment</tag>
      </tags>
  </entry>
  <entry>
    <title>harborç§æœ‰ä»“åº“éƒ¨ç½²</title>
    <url>/2019/09/30/harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Harboræ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨å’Œåˆ†å‘Dockeré•œåƒçš„ä¼ä¸šçº§RegistryæœåŠ¡å™¨ï¼Œé€šè¿‡æ·»åŠ ä¸€äº›ä¼ä¸šå¿…éœ€çš„åŠŸèƒ½ç‰¹æ€§ï¼Œä¾‹å¦‚å®‰å…¨ã€æ ‡è¯†å’Œç®¡ç†ç­‰ï¼Œæ‰©å±•äº†å¼€æºDocker Distributionã€‚ä½œä¸ºä¸€ä¸ªä¼ä¸šçº§ç§æœ‰RegistryæœåŠ¡å™¨ï¼ŒHarboræä¾›äº†æ›´å¥½çš„æ€§èƒ½å’Œå®‰å…¨ã€‚æå‡ç”¨æˆ·ä½¿ç”¨Registryæ„å»ºå’Œè¿è¡Œç¯å¢ƒä¼ è¾“é•œåƒçš„æ•ˆç‡ã€‚Harboræ”¯æŒå®‰è£…åœ¨å¤šä¸ªRegistryèŠ‚ç‚¹çš„é•œåƒèµ„æºå¤åˆ¶ï¼Œé•œåƒå…¨éƒ¨ä¿å­˜åœ¨ç§æœ‰Registryä¸­ï¼Œ ç¡®ä¿æ•°æ®å’ŒçŸ¥è¯†äº§æƒåœ¨å…¬å¸å†…éƒ¨ç½‘ç»œä¸­ç®¡æ§ã€‚å¦å¤–ï¼ŒHarborä¹Ÿæä¾›äº†é«˜çº§çš„å®‰å…¨ç‰¹æ€§ï¼Œè¯¸å¦‚ç”¨æˆ·ç®¡ç†ï¼Œè®¿é—®æ§åˆ¶å’Œæ´»åŠ¨å®¡è®¡ç­‰ã€‚</p><a id="more"></a><h3 id="éƒ¨ç½²ç¯å¢ƒå‡†å¤‡"><a href="#éƒ¨ç½²ç¯å¢ƒå‡†å¤‡" class="headerlink" title="éƒ¨ç½²ç¯å¢ƒå‡†å¤‡"></a>éƒ¨ç½²ç¯å¢ƒå‡†å¤‡</h3><h4 id="æœåŠ¡å™¨é…ç½®"><a href="#æœåŠ¡å™¨é…ç½®" class="headerlink" title="æœåŠ¡å™¨é…ç½®"></a>æœåŠ¡å™¨é…ç½®</h4><table><thead><tr><th>ç³»ç»Ÿ</th><th>é…ç½®</th><th>ip</th></tr></thead><tbody><tr><td>centos 7.4</td><td>4/8G/200G</td><td>172.21.16.90</td></tr></tbody></table><h4 id="ä¸‹è½½æ‰€éœ€æ–‡ä»¶"><a href="#ä¸‹è½½æ‰€éœ€æ–‡ä»¶" class="headerlink" title="ä¸‹è½½æ‰€éœ€æ–‡ä»¶"></a>ä¸‹è½½æ‰€éœ€æ–‡ä»¶</h4><h5 id="docker-compose-ä¸‹è½½"><a href="#docker-compose-ä¸‹è½½" class="headerlink" title="docker-compose ä¸‹è½½"></a>docker-compose ä¸‹è½½</h5><p>docker compose <a href="https://github.com/docker/compose/releases" target="_blank" rel="noopener">å‘å¸ƒé¡µé¢</a>ä¸‹è½½æœ€æ–°çš„ docker-compose äºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/docker/compose/releases/download/1.24.1/docker-compose-Linux-x86_64</span></span><br><span class="line"><span class="comment"># mv ~/docker-compose-Linux-x86_64 /usr/bin/docker-compose </span></span><br><span class="line"><span class="comment"># chmod a+x  /ur/bin/docker-compose</span></span><br></pre></td></tr></table></figure><ul><li>å®˜æ–¹çš„å®‰è£…<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class="line"><span class="comment"># chmod +x /usr/local/bin/docker-compose</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="harbor-ä¸‹è½½"><a href="#harbor-ä¸‹è½½" class="headerlink" title="harbor ä¸‹è½½"></a>harbor ä¸‹è½½</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harbor å®‰è£…æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨çº¿å®‰è£…ï¼Œä¸€ç§æ˜¯ç¦»çº¿å®‰è£…ï¼Œè¿™é‡Œç”±äºç½‘ç»œä¸å¥½ï¼Œä½¿ç”¨çš„æ˜¯ç¦»çº¿å®‰è£…ï¼Œharbor<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">å‘å¸ƒé¡µé¢</a>ä¸‹è½½æœ€æ–°çš„ harbor ç¦»çº¿å®‰è£…åŒ…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://storage.googleapis.com/harbor-releases/release-1.9.0/harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line"><span class="comment"># tar -zxvf harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹å®‰è£…"><a href="#å¼€å§‹å®‰è£…" class="headerlink" title="å¼€å§‹å®‰è£…"></a>å¼€å§‹å®‰è£…</h3><h4 id="docker-å®‰è£…"><a href="#docker-å®‰è£…" class="headerlink" title="docker å®‰è£…"></a>docker å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum-config-manager   --add-repo   https://download.docker.com/linux/centos/docker-ce.repo</span></span><br><span class="line"><span class="comment"># sudo yum -y install docker-ce-18.09.6-3.el7.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables: 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables: 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># sysctl -p /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="comment"># systemctl  start docker</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>: ä¸æ·»åŠ <code>/etc/sysctl.d/k8s.conf</code> å¯åŠ¨dockerä¼šæç¤º<code>WARNING: bridge-nf-call-iptables is disabled WARNING: bridge-nf-call-ip6tables is disabled</code></p><h4 id="å¯¼å…¥-docker-images"><a href="#å¯¼å…¥-docker-images" class="headerlink" title="å¯¼å…¥ docker images"></a>å¯¼å…¥ docker images</h4><p>å¯¼å…¥ç¦»çº¿å®‰è£…åŒ…ä¸­harborç›¸å…³çš„ docker imagesï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd harbor</span></span><br><span class="line"><span class="comment"># docker load -i harbor.v1.9.0.tar.gz </span></span><br><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                      TAG                        IMAGE ID            CREATED             SIZE</span><br><span class="line">goharbor/chartmuseum-photon     v0.9.0-v1.9.0              00c12627cbd7        2 weeks ago         131MB</span><br><span class="line">goharbor/harbor-migrator        v1.9.0                     75d4de5e0f16        2 weeks ago         362MB</span><br><span class="line">goharbor/redis-photon           v1.9.0                     3249afaa9965        2 weeks ago         109MB</span><br><span class="line">goharbor/clair-photon           v2.0.9-v1.9.0              e54ad567c58f        2 weeks ago         165MB</span><br><span class="line">goharbor/notary-server-photon   v0.6.1-v1.9.0              2cdecba59f38        2 weeks ago         138MB</span><br><span class="line">goharbor/notary-signer-photon   v0.6.1-v1.9.0              973378593def        2 weeks ago         135MB</span><br><span class="line">goharbor/harbor-registryctl     v1.9.0                     30a01bf0f4df        2 weeks ago         99.6MB</span><br><span class="line">goharbor/registry-photon        v2.7.1-patch-2819-v1.9.0   32571099a9fe        2 weeks ago         82.3MB</span><br><span class="line">goharbor/nginx-photon           v1.9.0                     f933d62f9952        2 weeks ago         43.9MB</span><br><span class="line">goharbor/harbor-log             v1.9.0                     28e27d511335        2 weeks ago         82.6MB</span><br><span class="line">goharbor/harbor-jobservice      v1.9.0                     f3cd0b181a89        2 weeks ago         141MB</span><br><span class="line">goharbor/harbor-core            v1.9.0                     f2814ed8aadd        2 weeks ago         155MB</span><br><span class="line">goharbor/harbor-portal          v1.9.0                     0778d4c5d27e        2 weeks ago         51.3MB</span><br><span class="line">goharbor/harbor-db              v1.9.0                     a809e14d2d49        2 weeks ago         147MB</span><br><span class="line">goharbor/prepare                v1.9.0                     aa594772c1e8        2 weeks ago         147MB</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-harbor-yml-æ–‡ä»¶"><a href="#ä¿®æ”¹-harbor-yml-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ harbor.yml æ–‡ä»¶"></a>ä¿®æ”¹ harbor.yml æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim harbor.yml</span></span><br><span class="line">hostname: reg.xxlaila.cn</span><br><span class="line"></span><br><span class="line"><span class="comment"># email configure</span></span><br><span class="line">email_server: smtp.exmail.qq.com</span><br><span class="line">email_server_port: 465</span><br><span class="line">email_username: admin@xxlaila.cn</span><br><span class="line">email_password: 123</span><br><span class="line">email_from: admin&lt;admin@xxlaila.cn&gt;</span><br><span class="line">email_ssl: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User registration is prohibited</span></span><br><span class="line">self_registration: off</span><br><span class="line"></span><br><span class="line"><span class="comment"># LDAP authentication configuration item</span></span><br><span class="line"><span class="comment">#ldap_url: ldaps://ldap.xxlaila.cn</span></span><br><span class="line"><span class="comment">#ldap_searchdn: uid=username,ou=people,dc=xxlaila,dc=com</span></span><br><span class="line"><span class="comment">#ldap_search_pwd: password</span></span><br><span class="line"><span class="comment">#ldap_basedn: ou=people,dc=xxlaila,dc=com</span></span><br><span class="line"><span class="comment">#ldap_filter: (objectClass=person)</span></span><br><span class="line"><span class="comment">#ldap_uid: uid </span></span><br><span class="line"><span class="comment">#ldap_scope: 3 </span></span><br><span class="line"><span class="comment">#ldap_timeout: 5</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨</strong>: æ–°ç‰ˆæœ¬çš„é‚®ç®±ã€ldapç°åœ¨éƒ½ä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ¥æ·»åŠ é…ç½®äº†ï¼Œç›´æ¥é€šè¿‡webç•Œé¢æ¥è¿›è¡Œé…ç½®å³å¯ï¼Œè¿™é‡Œæˆ‘åªæ˜¯æ·»åŠ è¿›æ¥ï¼Œä¿ç•™ï¼ŒğŸ˜ğŸ˜ğŸ˜</p><h4 id="åŠ è½½å’Œå¯åŠ¨-harbor-é•œåƒ"><a href="#åŠ è½½å’Œå¯åŠ¨-harbor-é•œåƒ" class="headerlink" title="åŠ è½½å’Œå¯åŠ¨ harbor é•œåƒ"></a>åŠ è½½å’Œå¯åŠ¨ harbor é•œåƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /data</span></span><br><span class="line"><span class="comment"># chmod 777 /var/run/docker.sock /data</span></span><br><span class="line"><span class="comment"># ./install.sh </span></span><br><span class="line"></span><br><span class="line">[Step 0]: checking installation environment ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 19.03.2</span><br><span class="line"></span><br><span class="line">Note: docker-compose version: 1.24.1</span><br><span class="line"></span><br><span class="line">[Step 1]: loading Harbor images ...</span><br><span class="line">Loaded image: goharbor/harbor-portal:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-core:v1.9.0</span><br><span class="line">Loaded image: goharbor/nginx-photon:v1.9.0</span><br><span class="line">Loaded image: goharbor/notary-signer-photon:v0.6.1-v1.9.0</span><br><span class="line">Loaded image: goharbor/registry-photon:v2.7.1-patch-2819-v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-migrator:v1.9.0</span><br><span class="line">Loaded image: goharbor/chartmuseum-photon:v0.9.0-v1.9.0</span><br><span class="line">Loaded image: goharbor/prepare:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-log:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-db:v1.9.0</span><br><span class="line">Loaded image: goharbor/clair-photon:v2.0.9-v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-jobservice:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-registryctl:v1.9.0</span><br><span class="line">Loaded image: goharbor/redis-photon:v1.9.0</span><br><span class="line">Loaded image: goharbor/notary-server-photon:v0.6.1-v1.9.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 2]: preparing environment ...</span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /opt/harbor</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated and saved secret to file: /secret/keys/secretkey</span><br><span class="line">Generated certificate, key file: /secret/core/private_key.pem, cert file: /secret/registry/root.crt</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 3]: starting Harbor ...</span><br><span class="line">Creating network <span class="string">"harbor_harbor"</span> with the default driver</span><br><span class="line">Creating harbor-log ... <span class="keyword">done</span></span><br><span class="line">Creating registryctl   ... <span class="keyword">done</span></span><br><span class="line">Creating redis         ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-portal ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-db     ... <span class="keyword">done</span></span><br><span class="line">Creating registry      ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-core   ... <span class="keyword">done</span></span><br><span class="line">Creating nginx             ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-jobservice ... <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">âœ” ----Harbor has been installed and started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able to visit the admin portal at http://reg.xxlaila.cn. </span><br><span class="line">For more details, please visit https://github.com/goharbor/harbor .</span><br></pre></td></tr></table></figure><h4 id="è®¿é—®ç®¡ç†ç•Œé¢"><a href="#è®¿é—®ç®¡ç†ç•Œé¢" class="headerlink" title="è®¿é—®ç®¡ç†ç•Œé¢"></a>è®¿é—®ç®¡ç†ç•Œé¢</h4><p>ç¡®è®¤æ‰€æœ‰ç»„ä»¶éƒ½å·¥ä½œæ­£å¸¸ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker-compose  ps</span></span><br><span class="line">      Name                     Command                       State                     Ports          </span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-core         /harbor/harbor_core              Up (healthy)                                     </span><br><span class="line">harbor-db           /docker-entrypoint.sh            Up (healthy)            5432/tcp                 </span><br><span class="line">harbor-jobservice   /harbor/harbor_jobservice  ...   Up (health: starting)                            </span><br><span class="line">harbor-log          /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up (healthy)            127.0.0.1:1514-&gt;10514/tcp</span><br><span class="line">harbor-portal       nginx -g daemon off;             Up (healthy)            8080/tcp                 </span><br><span class="line">nginx               nginx -g daemon off;             Up (healthy)            0.0.0.0:80-&gt;8080/tcp     </span><br><span class="line">redis               redis-server /etc/redis.conf     Up (healthy)            6379/tcp                 </span><br><span class="line">registry            /entrypoint.sh /etc/regist ...   Up (healthy)            5000/tcp                 </span><br><span class="line">registryctl         /harbor/start.sh                 Up (healthy)</span><br></pre></td></tr></table></figure><h5 id="harbor-ç»„å»ºä»‹ç»"><a href="#harbor-ç»„å»ºä»‹ç»" class="headerlink" title="harbor ç»„å»ºä»‹ç»"></a>harbor ç»„å»ºä»‹ç»</h5><ul><li>harbor-core: Harborçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸»è¦æä¾›ä»¥ä¸‹æœåŠ¡ï¼š<ul><li>UIï¼šæä¾›å›¾å½¢åŒ–ç•Œé¢ï¼Œå¸®åŠ©ç”¨æˆ·ç®¡ç†registryä¸Šçš„é•œåƒï¼ˆimageï¼‰, å¹¶å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒã€‚</li><li>webhookï¼šä¸ºäº†åŠæ—¶è·å–registry ä¸ŠimageçŠ¶æ€å˜åŒ–çš„æƒ…å†µï¼Œ åœ¨Registryä¸Šé…ç½®webhookï¼ŒæŠŠçŠ¶æ€å˜åŒ–ä¼ é€’ç»™UIæ¨¡å—ã€‚</li><li>token æœåŠ¡ï¼šè´Ÿè´£æ ¹æ®ç”¨æˆ·æƒé™ç»™æ¯ä¸ªdocker push/pullå‘½ä»¤ç­¾å‘token. Docker å®¢æˆ·ç«¯å‘RegiÃ¸stryæœåŠ¡å‘èµ·çš„è¯·æ±‚,å¦‚æœä¸åŒ…å«tokenï¼Œä¼šè¢«é‡å®šå‘åˆ°è¿™é‡Œï¼Œè·å¾—tokenåå†é‡æ–°å‘Registryè¿›è¡Œè¯·æ±‚ã€‚</li></ul></li><li>harbor-db: ä¸ºcore servicesæä¾›æ•°æ®åº“æœåŠ¡ï¼Œè´Ÿè´£å‚¨å­˜ç”¨æˆ·æƒé™ã€å®¡è®¡æ—¥å¿—ã€Docker imageåˆ†ç»„ä¿¡æ¯ç­‰æ•°æ®ã€‚</li><li>harbor-jobservice: harbor-jobservice æ˜¯harborçš„jobç®¡ç†æ¨¡å—ï¼Œjobåœ¨harboré‡Œé¢ä¸»è¦æ˜¯ä¸ºäº†é•œåƒä»“åº“ä¹‹å‰åŒæ­¥ä½¿ç”¨çš„;</li><li>harbor-log: ä¸ºäº†å¸®åŠ©ç›‘æ§Harborè¿è¡Œï¼Œè´Ÿè´£æ”¶é›†å…¶ä»–ç»„ä»¶çš„logï¼Œä¾›æ—¥åè¿›è¡Œåˆ†æã€‚</li><li>nginx: nginxè´Ÿè´£æµé‡è½¬å‘å’Œå®‰å…¨éªŒè¯ï¼Œå¯¹å¤–æä¾›çš„æµé‡éƒ½æ˜¯ä»nginxä¸­è½¬ï¼Œæ‰€ä»¥å¼€æ”¾httpsçš„443ç«¯å£ï¼Œå®ƒå°†æµé‡åˆ†å‘åˆ°åç«¯çš„uiå’Œæ­£åœ¨dockeré•œåƒå­˜å‚¨çš„docker registryã€‚</li><li>redis: å­˜å‚¨ç¼“å­˜ä¿¡æ¯</li><li>registry: è´Ÿè´£å‚¨å­˜Dockeré•œåƒï¼Œå¹¶å¤„ç†docker push/pull å‘½ä»¤ã€‚ç”±äºæˆ‘ä»¬è¦å¯¹ç”¨æˆ·è¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œå³ä¸åŒç”¨æˆ·å¯¹Docker imageæœ‰ä¸åŒçš„è¯»å†™æƒé™ï¼ŒRegistryä¼šæŒ‡å‘ä¸€ä¸ªtokenæœåŠ¡ï¼Œå¼ºåˆ¶ç”¨æˆ·çš„æ¯æ¬¡docker pull/pushè¯·æ±‚éƒ½è¦æºå¸¦ä¸€ä¸ªåˆæ³•çš„token, Registryä¼šé€šè¿‡å…¬é’¥å¯¹token è¿›è¡Œè§£å¯†éªŒè¯ã€‚</li><li>registryctl: æ˜¯harborçš„ç®¡ç†å‘˜é…ç½®harborçš„ä¸€äº›å¸¸ç”¨é…ç½®å’Œé«˜çº§é…ç½®</li></ul><p>åœ¨æµè§ˆå™¨è®¿é—®<a href="http://reg.xxlaila.cnï¼Œ" target="_blank" rel="noopener">http://reg.xxlaila.cnï¼Œ</a> ç”¨è´¦å· admin å’Œ harbor.yml é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å¯†ç  Harbor12345 ç™»é™†ç³»ç»Ÿ<br><img src="https://img.xxlaila.cn/8095d05-b9b7-4bdc-b0fc-7810db649e23.png" alt="img"><br><img src="https://img.xxlaila.cn/4bfab8be-e5de-4165-9268-fa591c5f12f8.png" alt="img"></p><h4 id="harbor-è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•"><a href="#harbor-è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•" class="headerlink" title="harbor è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•"></a>harbor è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harbor å°†æ—¥å¿—æ‰“å°åˆ° /var/log/harbor çš„ç›¸å…³ç›®å½•ä¸‹ï¼Œä¼ ç»Ÿçš„docker logs XXX æˆ– docker-compose logs XXX çœ‹ä¸åˆ°å®¹å™¨çš„æ—¥å¿—ã€‚åªæœ‰ä½¿ç”¨å¸¸ç”¨ç³»ç»Ÿå‘½ä»¤æ¥è¿›è¡Œæ—¥å¿—çš„æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># # æ—¥å¿—ç›®å½•</span></span><br><span class="line"><span class="comment"># ls /var/log/harbor</span></span><br><span class="line">core.log  jobservice.log  portal.log  postgresql.log  proxy.log  redis.log  registryctl.log  registry.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># # æ•°æ®ç›®å½•ï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€é•œåƒä»“åº“</span></span><br><span class="line"><span class="comment"># ls /data/</span></span><br><span class="line">ca_download  database  job_logs  psc  redis  registry  secret</span><br></pre></td></tr></table></figure><h4 id="å…¶å®ƒæ“ä½œ"><a href="#å…¶å®ƒæ“ä½œ" class="headerlink" title="å…¶å®ƒæ“ä½œ"></a>å…¶å®ƒæ“ä½œ</h4><p>ä¸‹åˆ—æ“ä½œçš„å·¥ä½œç›®å½•å‡ä¸ºè§£å‹ç¦»çº¿å®‰è£…æ–‡ä»¶åç”Ÿæˆçš„ harbor ç›®å½•ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># # åœæ­¢ harbor</span></span><br><span class="line"><span class="comment"># docker-compose down -v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # å¯åŠ¨ harbor</span></span><br><span class="line"><span class="comment"># docker-compose up -d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # æ›´ä¿®æ”¹çš„é…ç½®æ›´æ–°åˆ° docker-compose.yml æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># ./prepare</span></span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /opt/harbor</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Clearing the configuration file: /config/nginx/nginx.conf</span><br><span class="line">Clearing the configuration file: /config/core/env</span><br><span class="line">Clearing the configuration file: /config/core/app.conf</span><br><span class="line">Clearing the configuration file: /config/registry/config.yml</span><br><span class="line">Clearing the configuration file: /config/registry/root.crt</span><br><span class="line">Clearing the configuration file: /config/registryctl/env</span><br><span class="line">Clearing the configuration file: /config/registryctl/config.yml</span><br><span class="line">Clearing the configuration file: /config/db/env</span><br><span class="line">Clearing the configuration file: /config/jobservice/env</span><br><span class="line">Clearing the configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">loaded secret from file: /secret/keys/secretkey</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>harbor</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s podå¥åº·æ£€æµ‹</title>
    <url>/2019/09/27/k8s-pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="Podå¥åº·æ£€æµ‹æœºåˆ¶"><a href="#Podå¥åº·æ£€æµ‹æœºåˆ¶" class="headerlink" title="Podå¥åº·æ£€æµ‹æœºåˆ¶"></a>Podå¥åº·æ£€æµ‹æœºåˆ¶</h3><p>å¯¹äºPodçš„å¥åº·çŠ¶æ€æ£€æµ‹ï¼Œkubernetesæä¾›äº†ä¸¤ç±»æ¢é’ˆ(Probe)æ¥æ‰§è¡Œå¯¹Podçš„å¥åº·çŠ¶æ€æ£€æµ‹:</p><ul><li><strong>LivenessProbeæ¢é’ˆ</strong>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå³Podæ˜¯å¦ä¸ºrunningçŠ¶æ€ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†killæ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥æ˜¯å¦é‡å¯ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œåˆ™Kubeletè®¤ä¸ºå®¹å™¨çš„LivenessProbeæ¢é’ˆçš„è¿”å›å€¼æ°¸è¿œæˆåŠŸ.</li></ul><a id="more"></a><ul><li><strong>ReadinessProbeæ¢é’ˆ</strong>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œå³å®¹å™¨çš„Readyæ˜¯å¦ä¸ºTrueï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœReadinessProbeæ¢æµ‹å¤±è´¥ï¼Œåˆ™å®¹å™¨çš„Readyå°†ä¸ºFalseï¼Œæ§åˆ¶å™¨å°†æ­¤Podçš„Endpointä»å¯¹åº”çš„serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»æ­¤ä¸å†å°†ä»»ä½•è¯·æ±‚è°ƒåº¦æ­¤Podä¸Šï¼Œç›´åˆ°ä¸‹æ¬¡æ¢æµ‹æˆåŠŸã€‚</li></ul><!--more--><p>æ¯ç±»æ¢é’ˆéƒ½æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹æ³•:</p><ul><li><strong>ExecAction</strong>: é€šè¿‡æ‰§è¡Œå‘½ä»¤æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œé’ˆå¯¹å¤æ‚æ£€æµ‹æˆ–æ— HTTPæ¥å£çš„æœåŠ¡ï¼Œå‘½ä»¤è¿”å›å€¼ä¸º0åˆ™è¡¨ç¤ºå®¹å™¨å¥åº·ã€‚</li><li><strong>HTTPGetAction</strong>: é€šè¿‡å‘é€httpè¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œè¿”å›200-399çŠ¶æ€ç åˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li><li><strong>TCPSocketAction</strong>: é€šè¿‡å®¹å™¨çš„IPå’ŒPortæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li></ul><p>æ¢é’ˆæ¢æµ‹çš„ç»“æœæœ‰ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€:</p><ul><li><strong>Success</strong>: Containeré€šè¿‡äº†æ£€æŸ¥</li><li><strong>Failure</strong>: Containeræœªé€šè¿‡æ£€æŸ¥</li><li><strong>Unknown</strong>: æœªèƒ½æ‰§è¡Œæ£€æŸ¥ï¼Œå› æ­¤ä¸é‡‡å–ä»»ä½•æªæ–½</li></ul><h3 id="LivenessProbeæ¢é’ˆé…ç½®"><a href="#LivenessProbeæ¢é’ˆé…ç½®" class="headerlink" title="LivenessProbeæ¢é’ˆé…ç½®"></a>LivenessProbeæ¢é’ˆé…ç½®</h3><h4 id="ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹</h4><ul><li>exec-liveness.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; <span class="built_in">exec</span>-liveness.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">test</span>: liveness</span><br><span class="line">  name: liveness-exec</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">    - /bin/sh</span><br><span class="line">    - -c</span><br><span class="line">    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><br><span class="line">    livenessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - cat</span><br><span class="line">        - /tmp/healthy</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 5</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹å®¹å™¨æ‰§è¡ŒlivenessProbeæ£€æŸ¥ï¼ŒperiodSecondså­—æ®µæŒ‡å®škubeletæ¯5sæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œæ£€æŸ¥çš„å‘½ä»¤ä¸ºcat /tmp/healthyï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletåº”è¯¥åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ä¹‹å‰ç­‰å¾…5ç§’ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›0ï¼Œé‚£ä¹ˆkubeletå°±è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸ºé0ï¼Œåˆ™Kubeletä¼šKillæ‰å®¹å™¨å¹¶æ ¹æ®é‡å¯ç­–ç•¥æ¥å†³å®šæ˜¯å¦éœ€è¦é‡å¯ã€‚</p><ul><li>å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/bin/sh -c <span class="string">"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯¹äºå®¹å™¨çš„å‰30ç§’ï¼Œæœ‰ä¸€ä¸ª/tmp/healthyæ–‡ä»¶ã€‚å› æ­¤ï¼Œåœ¨å‰30ç§’å†…ï¼Œè¯¥å‘½ä»¤cat /tmp/healthyè¿”å›æˆåŠŸä»£ç ã€‚30ç§’åï¼Œcat /tmp/healthyè¿”å›å¤±è´¥ä»£ç ã€‚</p><ul><li><p>åˆ›å»ºPod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl create -f  <span class="built_in">exec</span>-liveness.yaml </span><br><span class="line">pod/liveness-exec created</span><br></pre></td></tr></table></figure></li><li><p>åœ¨30ç§’å†…ï¼ŒæŸ¥çœ‹Podäº‹ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                   Message</span><br><span class="line">  ----    ------     ----  ----                   -------</span><br><span class="line">  Normal  Scheduled  23s   default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Normal  Pulling    20s   kubelet, 172.21.17.34  Pulling image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Pulled     2s    kubelet, 172.21.17.34  Successfully pulled image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Created    2s    kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal  Started    1s    kubelet, 172.21.17.34  Started container liveness</span><br></pre></td></tr></table></figure></li><li><p>35ç§’åï¼Œå†æ¬¡æŸ¥çœ‹Podäº‹ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age              From                   Message</span><br><span class="line">  ----     ------     ----             ----                   -------</span><br><span class="line">  Normal   Scheduled  58s              default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Normal   Pulling    55s              kubelet, 172.21.17.34  Pulling image <span class="string">"busybox"</span></span><br><span class="line">  Normal   Pulled     37s              kubelet, 172.21.17.34  Successfully pulled image <span class="string">"busybox"</span></span><br><span class="line">  Normal   Created    37s              kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal   Started    36s              kubelet, 172.21.17.34  Started container liveness</span><br><span class="line">  Warning  Unhealthy  0s (x2 over 5s)  kubelet, 172.21.17.34  Liveness probe failed: cat: can<span class="string">'t open '</span>/tmp/healthy<span class="string">': No such file or directory</span></span><br></pre></td></tr></table></figure></li><li><p>å†ç­‰30ç§’ï¼Œç¡®è®¤Containerå·²é‡æ–°å¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod liveness-exec</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-exec   1/1     Running   1          115s</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                 From                   Message</span><br><span class="line">  ----     ------     ----                ----                   -------</span><br><span class="line">  Normal   Scheduled  2m7s                default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Warning  Unhealthy  64s (x3 over 74s)   kubelet, 172.21.17.34  Liveness probe failed: cat: can<span class="string">'t open '</span>/tmp/healthy<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">  Normal   Killing    64s                 kubelet, 172.21.17.34  Container liveness failed liveness probe, will be restarted</span></span><br><span class="line"><span class="string">  Normal   Pulling    34s (x2 over 2m4s)  kubelet, 172.21.17.34  Pulling image "busybox"</span></span><br><span class="line"><span class="string">  Normal   Pulled     25s (x2 over 106s)  kubelet, 172.21.17.34  Successfully pulled image "busybox"</span></span><br><span class="line"><span class="string">  Normal   Created    25s (x2 over 106s)  kubelet, 172.21.17.34  Created container liveness</span></span><br><span class="line"><span class="string">  Normal   Started    25s (x2 over 105s)  kubelet, 172.21.17.34  Started container liveness</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; http-liveness.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">test</span>: liveness</span><br><span class="line">  name: liveness-http</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: carlziess/liveness</span><br><span class="line">    args:</span><br><span class="line">    - /server</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /healthz</span><br><span class="line">        port: 8080</span><br><span class="line">        httpHeaders:</span><br><span class="line">        - name: X-Custom-Header</span><br><span class="line">          value: Awesome</span><br><span class="line">      initialDelaySeconds: 3</span><br><span class="line">      periodSeconds: 3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ªPodï¼Œå…¶ä¸­periodSecondså­—æ®µæŒ‡å®škubeletæ¯3ç§’æ‰§è¡Œä¸€æ¬¡æ¢æµ‹ï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletå»¶è¿Ÿç­‰å¾…3ç§’ï¼Œæ¢æµ‹æ–¹å¼ä¸ºå‘å®¹å™¨ä¸­è¿è¡Œçš„æœåŠ¡å‘é€HTTP GETè¯·æ±‚ï¼Œè¯·æ±‚8080ç«¯å£ä¸‹çš„/healthz, ä»»ä½•å¤§äºæˆ–ç­‰äº200ä¸”å°äº400çš„ä»£ç è¡¨ç¤ºæˆåŠŸã€‚ä»»ä½•å…¶ä»–ä»£ç è¡¨ç¤ºå¤±è´¥ã€‚</p><ul><li><p>åˆ›å»ºpod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f http-liveness.yaml </span><br><span class="line">pod/liveness-http created</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-http</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                   From                   Message</span><br><span class="line">  ----     ------     ----                  ----                   -------</span><br><span class="line">  Normal   Scheduled  2m59s                 default-scheduler      Successfully assigned default/liveness-http to 172.21.17.34</span><br><span class="line">  Normal   Pulled     119s (x3 over 2m46s)  kubelet, 172.21.17.34  Successfully pulled image <span class="string">"carlziess/liveness"</span></span><br><span class="line">  Normal   Created    119s (x3 over 2m46s)  kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal   Started    118s (x3 over 2m45s)  kubelet, 172.21.17.34  Started container liveness</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-http   1/1     Running   0          26s</span><br></pre></td></tr></table></figure></li><li><p><strong>httpGet</strong>æ¢æµ‹æ–¹å¼æœ‰å¦‚ä¸‹å¯é€‰çš„æ§åˆ¶å­—æ®µ</p><ul><li>host: è¦è¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤ä¸ºPod IPï¼Œå¯ä»¥åœ¨http request headä¸­è®¾ç½®hostå¤´éƒ¨ã€‚</li><li>scheme: ç”¨äºè¿æ¥hostçš„åè®®ï¼Œé»˜è®¤ä¸ºHTTPã€‚</li><li>path: httpæœåŠ¡å™¨ä¸Šçš„è®¿é—®URL</li><li>httpHeaders: è‡ªå®šä¹‰HTTPè¯·æ±‚headersï¼ŒHTTPå…è®¸é‡å¤headers</li><li>port: å®¹å™¨ä¸Šè¦è®¿é—®ç«¯å£å·æˆ–åç§°</li></ul></li></ul><h4 id="ä¾‹ä¸‰-é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹ä¸‰-é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹ä¸‰: é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹ä¸‰: é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹</h4><p>Kubeletå°†å°è¯•åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šæ‰“å¼€å®¹å™¨ä¸Šçš„å¥—æ¥å­—ï¼Œå¦‚æœèƒ½å»ºç«‹è¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; tcp-liveness-readiness.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: goproxy</span><br><span class="line">  labels:</span><br><span class="line">    app: goproxy</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: goproxy</span><br><span class="line">    image: goproxy/goproxy</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    readinessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      periodSeconds: 20</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCPæ£€æŸ¥æ–¹å¼å’ŒHTTPæ£€æŸ¥æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œç¤ºä¾‹ä¸­ä¸¤ç§æ¢é’ˆéƒ½ä½¿ç”¨äº†ï¼Œåœ¨å®¹å™¨å¯åŠ¨5ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªreadinessProbeæ¢é’ˆï¼Œè¿™å°†è¿æ¥åˆ°å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœæ¢æµ‹æˆåŠŸï¼Œåˆ™è¯¥Podå°†è¢«æ ‡è¯†ä¸ºreadyï¼Œ10ç§’åï¼Œkubeletå°†è¿›è¡Œç¬¬äºŒæ¬¡è¿æ¥ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é™¤æ­¤ï¼Œé…ç½®è¿˜åŒ…å«äº†livenessProbeæ¢é’ˆï¼Œåœ¨å®¹å™¨å¯åŠ¨15ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªlivenessProbeæ¢é’ˆï¼Œä»ç„¶å°è¯•è¿æ¥å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœè¿æ¥å¤±è´¥åˆ™é‡å¯å®¹å™¨ã€‚</p><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f tcp-liveness-readiness.yaml</span><br><span class="line">pod/goproxy created</span><br></pre></td></tr></table></figure></li><li><p>15ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ä»¥éªŒè¯æ´»åŠ¨æ¢æµ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod goproxy</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                    Message</span><br><span class="line">  ----    ------     ----  ----                    -------</span><br><span class="line">  Normal  Scheduled  26s   default-scheduler       Successfully assigned default/goproxy to 172.21.16.231</span><br><span class="line">  Normal  Pulling    22s   kubelet, 172.21.16.231  Pulling image <span class="string">"goproxy/goproxy"</span></span><br></pre></td></tr></table></figure></li></ul><p>å½“å®¹å™¨æœ‰å¤šä¸ªç«¯å£æ—¶ï¼Œé€šå¸¸ä¼šç»™æ¯ä¸ªç«¯å£å‘½åï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ¢é’ˆæ¢æµ‹æ—¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™è‡ªå®šä¹‰çš„ç«¯å£åç§°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- name: liveness-port</span><br><span class="line">  containerPort: 8080</span><br><span class="line">  hostPort: 8080</span><br><span class="line">livenessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /healthz</span><br><span class="line">    port: liveness-port</span><br></pre></td></tr></table></figure><h3 id="ReadinessProbeæ¢é’ˆé…ç½®"><a href="#ReadinessProbeæ¢é’ˆé…ç½®" class="headerlink" title="ReadinessProbeæ¢é’ˆé…ç½®"></a>ReadinessProbeæ¢é’ˆé…ç½®</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeæ¢é’ˆçš„ä½¿ç”¨åœºæ™¯livenessProbeç¨æœ‰ä¸åŒï¼Œæœ‰çš„æ—¶å€™åº”ç”¨ç¨‹åºå¯èƒ½æš‚æ—¶æ— æ³•æ¥å—è¯·æ±‚ï¼Œæ¯”å¦‚Podå·²ç»Runningäº†ï¼Œä½†æ˜¯å®¹å™¨å†…åº”ç”¨ç¨‹åºå°šæœªå¯åŠ¨æˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰ReadinessProbeï¼Œåˆ™Kubernetesè®¤ä¸ºå®ƒå¯ä»¥å¤„ç†è¯·æ±‚äº†ï¼Œç„¶è€Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ç¨‹åºè¿˜æ²¡å¯åŠ¨æˆåŠŸæ˜¯ä¸èƒ½æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¸å¸Œæœ›kubernetesæŠŠè¯·æ±‚è°ƒåº¦ç»™å®ƒï¼Œåˆ™ä½¿ç”¨ReadinessProbeæ¢é’ˆã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeå’ŒlivenessProbeå¯ä»¥ä½¿ç”¨ç›¸åŒæ¢æµ‹æ–¹å¼ï¼Œåªæ˜¯å¯¹Podçš„å¤„ç½®æ–¹å¼ä¸åŒï¼ŒReadinessProbeæ˜¯å°†Pod IP:Portä»å¯¹åº”çš„EndPointåˆ—è¡¨ä¸­åˆ é™¤ï¼Œè€ŒlivenessProbeåˆ™Killå®¹å™¨å¹¶æ ¹æ®Podçš„é‡å¯ç­–ç•¥æ¥å†³å®šä½œå‡ºå¯¹åº”çš„æªæ–½ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢é’ˆæ¢æµ‹å®¹å™¨æ˜¯å¦å·²å‡†å¤‡å°±ç»ªï¼Œå¦‚æœæœªå‡†å¤‡å°±ç»ªåˆ™kubernetesä¸ä¼šå°†æµé‡è½¬å‘ç»™æ­¤Podã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeæ¢é’ˆä¸livenessProbeä¸€æ ·ä¹Ÿæ”¯æŒexecã€httpGetã€TCPçš„æ¢æµ‹æ–¹å¼ï¼Œé…ç½®æ–¹å¼ç›¸åŒï¼Œåªä¸è¿‡æ˜¯å°†livenessProbeå­—æ®µä¿®æ”¹ä¸ºReadinessProbeã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">readinessProbe:</span><br><span class="line">  <span class="built_in">exec</span>:</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - cat</span><br><span class="line">    - /tmp/healthy</span><br><span class="line">  initialDelaySeconds: 5</span><br><span class="line">  periodSeconds: 5</span><br></pre></td></tr></table></figure><p>ReadinessProbeæ¢é’ˆçš„HTTPã€TCPçš„æ¢æµ‹æ–¹å¼ä¹Ÿä¸livenessProbeçš„åŸºæœ¬ä¸€è‡´ã€‚</p><h4 id="ä¾‹å››-ReadinessProbeç¤ºä¾‹"><a href="#ä¾‹å››-ReadinessProbeç¤ºä¾‹" class="headerlink" title="ä¾‹å››: ReadinessProbeç¤ºä¾‹"></a>ä¾‹å››: ReadinessProbeç¤ºä¾‹</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ å…¥ReadinessProbeæ¢é’ˆå’Œä¸€ä¸ªæ²¡æœ‰ReadinessProbeæ¢é’ˆçš„ç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªdeployï¼Œåä¸ºJavaAppï¼Œå¯åŠ¨çš„å®¹å™¨è¿è¡Œä¸€ä¸ªjavaåº”ç”¨ç¨‹åºï¼Œç¨‹åºç›‘å¬ç«¯å£ä¸º9093ã€‚</p><ul><li><p>æ²¡æœ‰ReadinessProbe</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; k8s.yaml &lt;&lt; EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  labels:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9093</span><br><span class="line">    name: biz-gateway</span><br><span class="line">  selector:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: biz-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: biz-gateway</span><br><span class="line">        image: docker.io/xxlaila/biz-gateway:dev-08c8a4e</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9093</span><br><span class="line">        env:</span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: dev</span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.cn</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f k8s.yaml </span><br><span class="line">service/biz-gateway created</span><br><span class="line">deployment.extensions/biz-gateway created</span><br></pre></td></tr></table></figure></li><li><p>åˆšåˆ›å»ºåï¼Œç­‰ä¸€ä¼šåï¼ŒæŸ¥çœ‹PodçŠ¶æ€ï¼Œè®°ç€è¦ç»™imageç•™ä¸‹pullçš„æ—¶é—´</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods  |grep <span class="string">"biz-gateway"</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">biz-gateway-95f6b677f-rnz22   1/1     Running   0          2m8s</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªè¿‡ç¨‹Podç”¨äº†2m8sï¼Œè‡ªèº«çŠ¶æ€å·²Runningï¼Œå…¶READå­—æ®µï¼Œ1/1 è¡¨ç¤º1ä¸ªå®¹å™¨çŠ¶æ€å·²å‡†å¤‡å°±ç»ªäº†ï¼Œæ­¤æ—¶ï¼Œå¯¹äºkubernetesè€Œè¨€ï¼Œå·²ç»å¯ä»¥æ¥æ”¶è¯·æ±‚äº†,è€Œå®é™…ä¸ŠæœåŠ¡è¿˜æ— æ³•è®¿é—®ï¼Œå› ä¸ºJAVAç¨‹åºè¿˜å°šå¯åŠ¨èµ·æ¥ï¼Œ2m8ssåæ–¹å¯æ­£å¸¸è®¿é—®ï¼Œæ‰€ä»¥é’ˆå¯¹æ­¤ç±»ç¨‹åºï¼Œå¿…é¡»é…ç½®ReadinessProbeã€‚</p><ul><li>åŠ å…¥readinessProbe<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; k8s.yaml &lt;&lt; EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  labels:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 9093</span><br><span class="line">    name: biz-gateway</span><br><span class="line">  selector:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: biz-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: biz-gateway</span><br><span class="line">        image: docker.io/xxlaila/biz-gateway:dev-08c8a4e</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9093</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9093</span><br><span class="line">          initialDelaySeconds: 140</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        env:</span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: dev</span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.cn</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼ŒReadinessProbeæ¢é’ˆçš„æ¢æµ‹æ–¹å¼ä¸ºtcpSocketï¼Œå› ä¸ºç¨‹åºç›‘å¬åœ¨9093ç«¯å£ï¼Œæ‰€ä»¥è¿™é‡Œæ¢æµ‹ä¸ºå¯¹9093å»ºç«‹è¿æ¥,è¿™é‡Œç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æ˜¯åœ¨Pod Runingå140ç§’åï¼Œé—´éš”10ç§’åæ‰§è¡Œç¬¬äºŒæ¬¡æ¢æµ‹ã€‚</p><ul><li><p>åˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f ./</span><br><span class="line">service/biz-gateway created</span><br><span class="line">deployment.extensions/biz-gateway created</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåç­‰å¾…äº†60s</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP            NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">biz-gateway-f69cc8678-qs8s7   0/1     Running   0          60s   172.30.56.6   172.21.17.40   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­ç­‰å¾…ä¸€ä¼š</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">biz-gateway-f69cc8678-qs8s7   1/1     Running   0          2m36s   172.30.56.6   172.21.17.40   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°åœ¨2m36ç§’åï¼Œpodå¯åŠ¨okï¼Œåœ¨ç¬¬ä¸€æ¬¡æŸ¥çœ‹çš„æ—¶å€™ï¼ŒPodè™½ç„¶å·²å¤„äºRunnigçŠ¶æ€ï¼Œä½†æ˜¯ç”±äºç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æœªåˆ°ï¼Œæ‰€ä»¥READYå­—æ®µä¸º0/1ï¼Œå³å®¹å™¨çš„çŠ¶æ€ä¸ºæœªå‡†å¤‡å°±ç»ªï¼Œåœ¨æœªå‡†å¤‡å°±ç»ªçš„æƒ…å†µä¸‹ï¼Œå…¶Podå¯¹åº”çš„Serviceä¸‹çš„Endpointä¹Ÿä¸ºç©ºï¼Œæ‰€ä»¥æ‰ä¸ä¼šæœ‰ä»»ä½•è¯·æ±‚è¢«è°ƒåº¦è¿›æ¥ã€‚</p><ul><li>æŸ¥çœ‹Endpoint<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ¬¡æ‰§è¡Œ</span></span><br><span class="line">$ kubectl get endpoints</span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">biz-gateway                                                            57s</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   13d</span><br><span class="line"></span><br><span class="line">åœ¨2m36sååœ¨æ¬¡æ‰§è¡Œ</span><br><span class="line">$ kubectl get endpoints</span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">biz-gateway   172.30.56.6:9093                                         2m41s</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   13d</span><br></pre></td></tr></table></figure></li></ul><h3 id="é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§"><a href="#é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§" class="headerlink" title="é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§"></a>é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢é’ˆ(Probe)æœ‰è®¸å¤šå¯é€‰å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æ›´åŠ ç²¾ç¡®çš„æ§åˆ¶Livenesså’ŒReadinessä¸¤ç§æ¢é’ˆçš„è¡Œä¸º(Probe)ï¼š</p><ul><li>initialDelaySecondsï¼šPodå¯åŠ¨åå»¶è¿Ÿå¤šä¹…æ‰è¿›è¡Œæ£€æŸ¥ï¼Œå•ä½ï¼šç§’</li><li>periodSecondsï¼šæ£€æŸ¥çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º10ï¼Œå•ä½ï¼šç§’ã€‚</li><li>timeoutSecondsï¼šæ¢æµ‹çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º1ï¼Œå•ä½ï¼šç§’ã€‚</li><li>successThresholdï¼šæ¢æµ‹å¤±è´¥åè®¤ä¸ºæˆåŠŸçš„æœ€å°è¿æ¥æˆåŠŸæ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œåœ¨Livenessæ¢é’ˆä¸­å¿…é¡»ä¸º1ï¼Œæœ€å°å€¼ä¸º1ã€‚</li><li>failureThresholdï¼šæ¢æµ‹å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•ä¸€å®šæ¬¡æ•°åå°†è®¤ä¸ºå¤±è´¥ï¼Œåœ¨readinessæ¢é’ˆä¸­ï¼ŒPodä¼šè¢«æ ‡è®°ä¸ºæœªå°±ç»ªï¼Œé»˜è®¤ä¸º3ï¼Œæœ€å°å€¼ä¸º1ã€‚</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>ä¹‹å‰é”™è¯¯å‚è€ƒæ’æŸ¥ä»‹ç»</strong>: åœ¨ä¹‹å‰å®‰è£…jenkinsçš„æ—¶å€™ï¼Œåˆ›å»ºpodå°±ä¸€å€¼å¤„äº<code>running</code>,ä½†æ˜¯è¿‡ä¸€ä¼šï¼Œç•Œé¢å°±æŠ¥é”™ï¼Œé”™è¯¯å¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/15008WechatIMG.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç„¶åæŸ¥çœ‹podæ—¥å¿—å’Œç³»ç»Ÿç³»ç»Ÿï¼Œéƒ½æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œpodæ—¥å¿—å¦‚ä¸‹ï¼Œç„¶åå°±é—®äº†æœ‹å‹ï¼Œå°±è¯´æœ‰å¯èƒ½æ˜¯podçš„å¥åº·æ£€æµ‹æœºåˆ¶ï¼Œæœ€åå°±ä¿®æ”¹äº†podçš„å¥åº·æ£€æµ‹æœºåˆ¶ï¼ŒjenkinsæœåŠ¡å™¨éƒ¨ç½²okã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">log</span> $(kubectl get pods -n kube-ops | awk <span class="string">'&#123;print $1&#125;'</span> | grep jenkins) -n kube-ops</span><br><span class="line"><span class="built_in">log</span> is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use logs instead.</span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size: 3.00G</span><br><span class="line">    Ergonomics Machine Class: server</span><br><span class="line">    Using VM: OpenJDK 64-Bit Server VM</span><br><span class="line"></span><br><span class="line">Running from: /usr/share/jenkins/jenkins.war</span><br><span class="line">webroot: EnvVars.masterEnvVars.get(<span class="string">"JENKINS_HOME"</span>)</span><br><span class="line">2019-09-27 03:02:24.133+0000 [id=1] INFO org.eclipse.jetty.util.log.Log<span class="comment">#initialized: Logging initialized @429ms to org.eclipse.jetty.util.log.JavaUtilLog</span></span><br><span class="line">2019-09-27 03:02:24.247+0000 [id=1] INFO winstone.Logger<span class="comment">#logInternal: Beginning extraction from war file</span></span><br></pre></td></tr></table></figure><p><strong>åç»­</strong>: è™½ç„¶å¥åº·æ£€æµ‹å¯ä»¥å–æ¶ˆï¼Œä¸åŠ å…¥ï¼Œä½†æ˜¯å½“æˆ‘ä»¬åœ¨ä¸Šç”Ÿäº§ç¯å¢ƒçš„æ—¶å€™è¿˜æ˜¯è¦åŠ ä¸Šï¼Œæ­£å¦‚ä¾‹å››ä»‹ç»çš„é‚£æ ·ã€‚å¦‚æœæˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒé”™æ•…éšœè‡ªæ„ˆã€è½®è¯¢å‘å¸ƒç­‰ã€‚éƒ½éœ€è¦è¿™ä¸ªä¸œè¥¿ï¼ŒåŠ å…¥å†å‡çº§çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨éƒ½è¿˜æ²¡èµ·æ¥ï¼Œk8så°±å§æµé‡ç»™è°ƒåº¦è¿‡æ¥ï¼Œå‡çº§ä¸‹ä¸€ä¸ªpodï¼Œå¤–éƒ¨ç”¨æˆ·è®¿é—®å°±ä¼šæŠ¥é”™ï¼Œé‚£å°±æ˜¯å¾ˆå°´å°¬</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pod</tag>
      </tags>
  </entry>
  <entry>
    <title>EFK</title>
    <url>/2019/09/25/EFK/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡"><a href="#åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡" class="headerlink" title="åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡"></a>åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚<code>kubernetes/cluster/addons/fluentd-elasticsearch</code>è¿™æ˜¯æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;es æ•°æ®é»˜è®¤çš„å­˜å‚¨åœ¨dockeré‡Œé¢ï¼Œåœ¨ç”¨çš„æ˜¯nodeèŠ‚ç‚¹çš„ç©ºé—´ï¼Œè€ŒnodeèŠ‚ç‚¹æˆ‘ä»¬ä¸å¯èƒ½éƒ½å‡†å¤‡å¾ˆå¤§çš„ç©ºé—´ï¼Œé‚£æ ·å¾ˆæµªè´¹èµ„æºï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å‡†å¤‡å¤–éƒ¨çš„nfså­˜å‚¨ç©ºé—´ï¼Œç„¶åé€šè¿‡<a href="https://xxlaila.github.io/2019/09/24/%E5%88%A9%E7%94%A8NFS%E5%8A%A8%E6%80%81%E6%8F%90%E4%BE%9BKubernetes%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8%E5%8D%B7/" target="_blank" rel="noopener">pv</a>çš„æ¨¡å¼è¿›è¡ŒæŒ‚è½½ï¼Œæ•°æ®å­˜å‚¨åˆ°nfsæœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·ä¿éšœäº†esæ”¶é›†æ•°æ®çš„å¯ç”¨æ€§ã€‚</p><a id="more"></a><h3 id="åˆ›å»ºå­˜å‚¨ä»‹è´¨"><a href="#åˆ›å»ºå­˜å‚¨ä»‹è´¨" class="headerlink" title="åˆ›å»ºå­˜å‚¨ä»‹è´¨"></a>åˆ›å»ºå­˜å‚¨ä»‹è´¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; pvc.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: es-nfs-data</span><br><span class="line">provisioner: fuseim.pri/ifs</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc.yaml</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><ul><li><p>es-statefulset.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># RBAC authn and authz</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - <span class="string">"services"</span></span><br><span class="line">  - <span class="string">"namespaces"</span></span><br><span class="line">  - <span class="string">"endpoints"</span></span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">"get"</span></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># Elasticsearch deployment itself</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    version: v6.6.1</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  serviceName: elasticsearch-logging</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: elasticsearch-logging</span><br><span class="line">      version: v6.6.1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: elasticsearch-logging</span><br><span class="line">        version: v6.6.1</span><br><span class="line">        kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: elasticsearch-logging</span><br><span class="line">      containers:</span><br><span class="line">      - image: elasticsearch:6.6.1</span><br><span class="line">        name: elasticsearch-logging</span><br><span class="line">        resources:</span><br><span class="line">          <span class="comment"># need more cpu upon initialization, therefore burstable class</span></span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9200</span><br><span class="line">          name: db</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9300</span><br><span class="line">          name: transport</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: elasticsearch-logging</span><br><span class="line">          mountPath: /data</span><br><span class="line">        env:</span><br><span class="line">        - name: <span class="string">"NAMESPACE"</span></span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">      <span class="comment"># Elasticsearch requires vm.max_map_count to be at least 262144.</span></span><br><span class="line">      <span class="comment"># If your OS already sets up this number to a higher value, feel free</span></span><br><span class="line">      <span class="comment"># to remove this init container.</span></span><br><span class="line">      initContainers:</span><br><span class="line">      - image: alpine:3.6</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">"/sbin/sysctl"</span>, <span class="string">"-w"</span>, <span class="string">"vm.max_map_count=262144"</span>]</span><br><span class="line">        name: elasticsearch-logging-init</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: <span class="literal">true</span></span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: elasticsearch-logging</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteMany"</span> ]</span><br><span class="line">      storageClassName: <span class="string">"es-nfs-data"</span></span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 30Gi</span><br></pre></td></tr></table></figure></li><li><p>fluentd-es-ds.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - <span class="string">"namespaces"</span></span><br><span class="line">  - <span class="string">"pods"</span></span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">"get"</span></span><br><span class="line">  - <span class="string">"watch"</span></span><br><span class="line">  - <span class="string">"list"</span></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es-v2.4.0</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    version: v2.4.0</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: fluentd-es</span><br><span class="line">      version: v2.4.0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: fluentd-es</span><br><span class="line">        kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">        version: v2.4.0</span><br><span class="line">      <span class="comment"># This annotation ensures that fluentd does not get evicted if the node</span></span><br><span class="line">      <span class="comment"># supports critical pod annotation based priority scheme.</span></span><br><span class="line">      <span class="comment"># Note that this does not guarantee admission on the nodes (#40573).</span></span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'docker/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-node-critical</span><br><span class="line">      serviceAccountName: fluentd-es</span><br><span class="line">      containers:</span><br><span class="line">      - name: fluentd-es</span><br><span class="line">        image: docker.io/xxlaila/fluentd-elasticsearch:v2.4.0</span><br><span class="line">        env:</span><br><span class="line">        - name: FLUENTD_ARGS</span><br><span class="line">          value: --no-supervisor -q</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: varlog</span><br><span class="line">          mountPath: /var/<span class="built_in">log</span></span><br><span class="line">        - name: varlibdockercontainers</span><br><span class="line">          mountPath: /var/lib/docker/containers</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/fluent/config.d</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: varlog</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/<span class="built_in">log</span></span><br><span class="line">      - name: varlibdockercontainers</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/lib/docker/containers</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: fluentd-es-config-v0.2.0</span><br></pre></td></tr></table></figure></li><li><p>kibana-deployment.yaml<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ³¨é‡Šé‡Œé¢çš„ä¸¤è¡Œé…ç½®,ä¸æ³¨é‡Šçš„è¯ï¼Œæ‰“å¼€kibanaçš„æ—¶å€™ä¼šæç¤º<code>kibana {&quot;statusCode&quot;:404,&quot;error&quot;:&quot;Not Found&quot;,&quot;message&quot;:&quot;Not Found&quot;}</code>,å‚è€ƒ<a href="https://github.com/kubernetes-sigs/kubespray/issues/3322" target="_blank" rel="noopener">è§£å†³æ–¹æ¡ˆ</a>,æ³¨é‡Šé…ç½®å¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- name: SERVER_BASEPATH</span><br><span class="line">  value: /api/v1/namespaces/kube-system/services/kibana-logging/proxy</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f ./</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹åˆ›å»º"><a href="#æŸ¥çœ‹åˆ›å»º" class="headerlink" title="æŸ¥çœ‹åˆ›å»º"></a>æŸ¥çœ‹åˆ›å»º</h4><ul><li><p>æŸ¥çœ‹pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system |egrep <span class="string">"kibana|elasticsearch|fluentd"</span></span><br><span class="line">elasticsearch-logging-0                       1/1     Running   0          65m</span><br><span class="line">elasticsearch-logging-1                       1/1     Running   0          61m</span><br><span class="line">fluentd-es-v2.4.0-4fp28                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-b7k67                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-f8jzp                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-shwzm                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-ww8r8                       1/1     Running   0          30m</span><br><span class="line">kibana-logging-57b55f58bc-xh5lp               1/1     Running   0          6m35s</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹service</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc -n kube-system |egrep <span class="string">"kibana|elasticsearch"</span></span><br><span class="line">elasticsearch-logging     ClusterIP   10.254.30.110    &lt;none&gt;        9200/TCP                 9s</span><br><span class="line">kibana-logging            ClusterIP   10.254.188.5     &lt;none&gt;        5601/TCP                 16h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹pvï¼Œpvc</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl get pv,pvc -n kube-system</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                                       STORAGECLASS   REASON   AGE</span><br><span class="line">persistentvolume/pvc-65fdd14e-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            Delete           Bound    kube-system/elasticsearch-logging-elasticsearch-logging-0   es-nfs-data             21m</span><br><span class="line">persistentvolume/pvc-fe818f55-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            Delete           Bound    kube-system/elasticsearch-logging-elasticsearch-logging-1   es-nfs-data             16m</span><br><span class="line"></span><br><span class="line">NAME                                                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">persistentvolumeclaim/elasticsearch-logging-elasticsearch-logging-0   Bound    pvc-65fdd14e-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            es-nfs-data    21m</span><br><span class="line">persistentvolumeclaim/elasticsearch-logging-elasticsearch-logging-1   Bound    pvc-fe818f55-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            es-nfs-data    17m</span><br></pre></td></tr></table></figure></li></ul><h3 id="åˆ›å»ºwebè®¿é—®"><a href="#åˆ›å»ºwebè®¿é—®" class="headerlink" title="åˆ›å»ºwebè®¿é—®"></a>åˆ›å»ºwebè®¿é—®</h3><ul><li><p>kibana-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; kibana-Ingress.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: kibana.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kibana-logging</span><br><span class="line">          servicePort: 5601</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>es-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; es-Ingress &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: es-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: es.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: elasticsearch-logging</span><br><span class="line">          servicePort: 9200</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f es-Ingress.yaml kibana-Ingress.yaml</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æµè§ˆå™¨è®¿é—®es<br><img src="https://img.xxlaila.cn/1569462606884.jpg" alt="img"></p></li><li><p>æµè§ˆå™¨è®¿é—®kibana<br><img src="https://img.xxlaila.cn/1569464839630.jpg" alt="img"><br>å»ºç«‹ç´¢å¼•ï¼Œé»˜è®¤çš„ç´¢å¼•æ˜¯æ ¹æ®å¤©æ¥è‡ªåŠ¨åˆ›å»ºåœ¨esé‡Œé¢ï¼Œè¿™é‡Œæˆ‘æ˜¯åœ¨kibanaé‡Œé¢æ˜¯æ ¹æ®æœˆæ¥å´åˆ†çš„<br><img src="https://img.xxlaila.cn/1569464950776.jpg" alt="img"></p></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>efk</tag>
      </tags>
  </entry>
  <entry>
    <title>ç½‘ç»œçŠ¶æ€ç›‘æ§</title>
    <url>/2019/09/25/%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›‘æ§IDCæœºæˆ¿ç½‘ç»œè´¨é‡æƒ…å†µï¼Œæœ¬åœ°åŒºåˆ°å…¶ä»–åœ°åŒºï¼Œå…¶ä»–åœ°åŒºåˆ°æœ¬èŠ‚ç‚¹ï¼Œæˆ–è€…å„çœå¸‚æ—¶é—´ç½‘ç»œã€è¿è¥å•†ç½‘ç»œçŠ¶æ€ï¼Œç›‘è§†ç½‘ç»œæ€§èƒ½ï¼ŒåŒ…æ‹¬å¸¸è§„çš„ pingï¼Œç”¨ fpingã€echopingã€tracert ç›‘è§† www æœåŠ¡å™¨æ€§èƒ½ï¼Œç›‘è§† dns æŸ¥è¯¢æ€§èƒ½ï¼Œç›‘è§† ssh æ€§èƒ½ç­‰ã€‚åº•å±‚ä¹Ÿæ˜¯ rrdtool åšæ”¯æŒï¼Œç‰¹ç‚¹æ˜¯ç”»çš„å›¾éå¸¸æ¼‚äº®ï¼Œç½‘ç»œä¸¢åŒ…å’Œå»¶è¿Ÿç”¨é¢œè‰²å’Œé˜´å½±æ¥è¡¨ç¤ºã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Smokepingã€‚æœ€æ–°ç‰ˆæœ¬çš„ Smokeping æ”¯æŒå¤šä¸ªèŠ‚ç‚¹çš„æ£€æµ‹ç»“æœä»ä¸€ä¸ªå›¾ä¸Šç”»å‡ºæ¥</p><a id="more"></a><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><h4 id="å®‰è£…yumæº"><a href="#å®‰è£…yumæº" class="headerlink" title="å®‰è£…yumæº"></a>å®‰è£…yumæº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm               </span></span><br><span class="line"><span class="comment"># rpm â€“Uvh http://mirrors.neusoft.edu.cn/epel/6/i386/epel-release-6-8.noarch.rpm</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ä¾èµ–åŒ…"><a href="#å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="å®‰è£…ä¾èµ–åŒ…"></a>å®‰è£…ä¾èµ–åŒ…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum â€“y install perl perl-Net-Telnet perl-Net-DNS perl-LDAP perl-libwww-perl perl-RadiusPerl perl-IO-Socket-SSL perl-Socket6 perl-CGI-SpeedyCGI perl-FCGI perl-CGI-SpeedCGI perl-Time-HiRes perl-ExtUtils-MakeMaker perl-RRD-Simple rrdtool rrdtool-perl curl fping echo</span></span><br><span class="line">ping  httpd httpd-devel gcc make  wget libxml2-devel libpng-devel glib pango pango-devel freetype freetype-devel fontconfig cairo cairo-devel libart_lgpl libart_lgpl-devel mod_fastcgi</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…smokeping"><a href="#å®‰è£…smokeping" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h3><h4 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget http://oss.oetiker.ch/smokeping/pub/smokeping-2.6.11.tar.gz è¿™é‡Œä¸‹è½½çš„æœ€æ–°ç‰ˆ</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…FCGI"><a href="#å®‰è£…FCGI" class="headerlink" title="å®‰è£…FCGI"></a>å®‰è£…FCGI</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf CGI-4.33.tar.gz</span></span><br><span class="line"><span class="comment"># cd CGI-4.33</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Config-Grammar"><a href="#å®‰è£…Config-Grammar" class="headerlink" title="å®‰è£…Config-Grammar"></a>å®‰è£…Config-Grammar</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Config-Grammar-1.10.tar.gz</span></span><br><span class="line"><span class="comment"># cd Config-Grammar-1.10</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ExtUtils-MakeMaker"><a href="#å®‰è£…ExtUtils-MakeMaker" class="headerlink" title="å®‰è£…ExtUtils-MakeMaker"></a>å®‰è£…ExtUtils-MakeMaker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf ExtUtils-MakeMaker-7.24.tar.gz</span></span><br><span class="line"><span class="comment"># cd ExtUtils-MakeMaker</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Simple"><a href="#å®‰è£…Simple" class="headerlink" title="å®‰è£…Simple"></a>å®‰è£…Simple</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Test-Simple-1.302056.tar.gz</span></span><br><span class="line"><span class="comment"># cd Test-Simple-1.302056</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">`</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-OpenSSH"><a href="#å®‰è£…Net-OpenSSH" class="headerlink" title="å®‰è£…Net-OpenSSH"></a>å®‰è£…Net-OpenSSH</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Net-OpenSSH-0.73.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-OpenSSH-0.73</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-SNMP"><a href="#å®‰è£…Net-SNMP" class="headerlink" title="å®‰è£…Net-SNMP"></a>å®‰è£…Net-SNMP</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar Net-SNMP-v6.0.1.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-SNMP-v6.0.1</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…perl-ldap"><a href="#å®‰è£…perl-ldap" class="headerlink" title="å®‰è£…perl-ldap"></a>å®‰è£…perl-ldap</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf perl-ldap-0.65.tar.gz</span></span><br><span class="line"><span class="comment"># cd perl-ldap-0.65</span></span><br><span class="line"><span class="comment"># ./install-nomake</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-DNS"><a href="#å®‰è£…Net-DNS" class="headerlink" title="å®‰è£…Net-DNS"></a>å®‰è£…Net-DNS</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Net-DNS-1.06.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-DNS-1.06</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…IO-Tty"><a href="#å®‰è£…IO-Tty" class="headerlink" title="å®‰è£…IO-Tty"></a>å®‰è£…IO-Tty</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar IO-Tty-1.12.tar.gz</span></span><br><span class="line"><span class="comment"># cd IO-Tty-1.12</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…libwww-perl"><a href="#å®‰è£…libwww-perl" class="headerlink" title="å®‰è£…libwww-perl"></a>å®‰è£…libwww-perl</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf libwww-perl-6.15.tar.gz</span></span><br><span class="line"><span class="comment"># cd libwww-perl-6.15</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…smokeping-1"><a href="#å®‰è£…smokeping-1" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf smokeping-2.6.11.tar.gz</span></span><br><span class="line"><span class="comment"># cd smokeping-2.6.11</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/smokeping</span></span><br><span class="line"><span class="comment"># /usr/bin/gmake install</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œé’ˆå¯¹ç½‘ç»œä¸èƒ½ç¿»å¢™ã€‚ä¹Ÿå¯ä»¥é‡‡å–smokepingä¸€é”®å®‰è£…çš„æ–¹å¼è¿›è¡Œå®‰è£…</p><h3 id="smokepingä¸€é”®å®‰è£…"><a href="#smokepingä¸€é”®å®‰è£…" class="headerlink" title="smokepingä¸€é”®å®‰è£…"></a>smokepingä¸€é”®å®‰è£…</h3><h4 id="å®‰è£…smokeping-2"><a href="#å®‰è£…smokeping-2" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf smokeping-2.6.11.tar.gz</span></span><br><span class="line"><span class="comment"># cd smokeping-2.6.11</span></span><br><span class="line"><span class="comment"># ./setup/build-perl-modules.sh /usr/local/smokeping/thirdparty</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/smokeping</span></span><br><span class="line"><span class="comment"># /usr/bin/gmake install</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®smkeping"><a href="#é…ç½®smkeping" class="headerlink" title="é…ç½®smkeping"></a>é…ç½®smkeping</h3><h4 id="åˆ›å»ºcacheã€dataã€varç›®å½•"><a href="#åˆ›å»ºcacheã€dataã€varç›®å½•" class="headerlink" title="åˆ›å»ºcacheã€dataã€varç›®å½•"></a>åˆ›å»ºcacheã€dataã€varç›®å½•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/smokeping/</span></span><br><span class="line"><span class="comment"># mkdir &#123;cache,data,var&#125;</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ—¥å¿—æ–‡ä»¶"><a href="#åˆ›å»ºæ—¥å¿—æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæ—¥å¿—æ–‡ä»¶"></a>åˆ›å»ºæ—¥å¿—æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># touch /var/log/smokeping.log</span></span><br></pre></td></tr></table></figure><h4 id="èµ‹æƒé™"><a href="#èµ‹æƒé™" class="headerlink" title="èµ‹æƒé™"></a>èµ‹æƒé™</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chown apache:apache cache/ data/ var/</span></span><br><span class="line"><span class="comment"># chown  apache:apache /var/log/smokeping.log</span></span><br><span class="line"><span class="comment"># chmod 755 cache/ data/ var/    #è¿™é‡Œä¹Ÿè¦èµ‹æƒé™ï¼Œä¼šå½±å“å›¾ç‰‡æ— æ³•åŠ è½½</span></span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/local/smokeping/htdocs</span></span><br><span class="line"><span class="comment"># cp -arp smokeping.fcgi.dist smokeping.fcgi</span></span><br><span class="line"><span class="comment"># cd ../etc/</span></span><br><span class="line"><span class="comment"># cp -arp config.dist config</span></span><br><span class="line"><span class="comment"># chmod 600 /usr/local/smokeping/etc/smokeping_secrets.dist</span></span><br><span class="line"><span class="comment"># vim config</span></span><br><span class="line">*** General ***</span><br><span class="line">owner    = Peter Random</span><br><span class="line">contact  = some@address.nowhere</span><br><span class="line">mailhost = my.mail.host</span><br><span class="line">sendmail = /usr/sbin/sendmail</span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> do not put the Image Cache below cgi-bin</span></span><br><span class="line"><span class="comment"># since all files under cgi-bin will be executed ... this is not</span></span><br><span class="line"><span class="comment"># good for images.</span></span><br><span class="line">imgcache = /usr/<span class="built_in">local</span>/smokeping/cache</span><br><span class="line">imgurl   = http://172.16.1.100/cache                                                      <span class="comment">#è¿™é‡Œå¦‚æœä¸é…ç½®æ­£ç¡®ï¼Œä¼šå½±å“åé¢å‡ºå›¾ï¼Œè¿™é‡Œä¸€ä¸ªå‘</span></span><br><span class="line">datadir  = /usr/<span class="built_in">local</span>/smokeping/data</span><br><span class="line">piddir  = /usr/<span class="built_in">local</span>/smokeping/var</span><br><span class="line">cgiurl   = http://172.16.1.100/smokeping/smokeping.cgi</span><br><span class="line"><span class="comment">#cgiurl   = http://some.url/smokeping.cgi</span></span><br><span class="line">smokemail = /usr/<span class="built_in">local</span>/smokeping/etc/smokemail.dist</span><br><span class="line">tmail = /usr/<span class="built_in">local</span>/smokeping/etc/tmail.dist</span><br><span class="line"><span class="comment"># specify this to get syslog logging</span></span><br><span class="line">syslogfacility = local0</span><br><span class="line"><span class="comment"># each probe is now run in its own process</span></span><br><span class="line"><span class="comment"># disable this to revert to the old behaviour</span></span><br><span class="line"><span class="comment"># concurrentprobes = no</span></span><br><span class="line">*** Alerts ***</span><br><span class="line">to = alertee@address.somewhere</span><br><span class="line">from = smokealert@company.xy</span><br><span class="line">+someloss</span><br><span class="line"><span class="built_in">type</span> = loss</span><br><span class="line"><span class="comment"># in percent</span></span><br><span class="line">pattern = &gt;0%,*12*,&gt;0%,*12*,&gt;0%</span><br><span class="line">comment = loss 3 <span class="built_in">times</span>  <span class="keyword">in</span> a row</span><br><span class="line">*** Database ***</span><br><span class="line">step     = 60                                              <span class="comment">#æ£€æµ‹æ—¶é—´ï¼Œé»˜è®¤300</span></span><br><span class="line">pings    = 20</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸Šè¿°ä¿®æ”¹å¸¦æœ‰æ³¨è§†éƒ¨åˆ†ï¼Œå…¶ä»–å‚æ•°å‚è€ƒå®˜æ–¹ï¼Œè€Œä¸”éƒ½èƒ½çœ‹æ‡‚ã€‚åé¢æœ‰å¾ˆå¤šé…ç½®ä¸å…¨éƒ¨è´´å‡ºæ¥</p><h3 id="é…ç½®apache"><a href="#é…ç½®apache" class="headerlink" title="é…ç½®apache"></a>é…ç½®apache</h3><h4 id="é…ç½®httpd-conf"><a href="#é…ç½®httpd-conf" class="headerlink" title="é…ç½®httpd.conf"></a>é…ç½®httpd.conf</h4><p>åœ¨DocumentRoot â€œ/var/www/htmlâ€è¿™è¡Œå¢åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">Alias /cache <span class="string">"/usr/local/smokeping/cache"</span></span><br><span class="line">Alias /cropper <span class="string">"/usr/local/smokeping/htdocs/cropper"</span></span><br><span class="line">Alias /smokeping <span class="string">"/usr/local/smokeping/htdocs/smokeping.fcgi"</span></span><br><span class="line">&lt;Directory <span class="string">"/usr/local/smokeping"</span>&gt;</span><br><span class="line">        AllowOverride None</span><br><span class="line">        Options All</span><br><span class="line">        AddHandler cgi-script .fcgi .cgi</span><br><span class="line">        Order allow,deny</span><br><span class="line">        Allow from all</span><br><span class="line">        AuthName <span class="string">"Smokeping"</span></span><br><span class="line">        AuthType Basic</span><br><span class="line">        AuthUserFile /usr/<span class="built_in">local</span>/smokeping/htdocs/htpasswd</span><br><span class="line">        Require valid-user</span><br><span class="line">        DirectoryIndex smokeping.fcgi</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure><h4 id="apacheç™»å½•è®¤è¯"><a href="#apacheç™»å½•è®¤è¯" class="headerlink" title="apacheç™»å½•è®¤è¯"></a>apacheç™»å½•è®¤è¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/local/smokeping/htdocs</span></span><br><span class="line"><span class="comment"># htpasswd -c /usr/local/smokeping/htdocs/htpasswd admin                   #å›è½¦è®¾ç½®adminè´¦æˆ·çš„å¯†ç </span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“"><a href="#å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“" class="headerlink" title="å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“"></a>å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install wqy-zenhei-fonts.noarch</span></span><br></pre></td></tr></table></figure><h4 id="smokepingå¼€æœºè„šæœ¬"><a href="#smokepingå¼€æœºè„šæœ¬" class="headerlink" title="smokepingå¼€æœºè„šæœ¬"></a>smokepingå¼€æœºè„šæœ¬</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/init.d/smokeping</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">PIDFILE=/usr/<span class="built_in">local</span>/smokeping/var/smokeping.pid</span><br><span class="line">SMOKEPING=/usr/<span class="built_in">local</span>/smokeping/bin/smokeping</span><br><span class="line">ERROR=0</span><br><span class="line">RUNNING=0</span><br><span class="line">ARGV=<span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x<span class="variable">$ARGV</span>"</span> = <span class="string">"x"</span> ] ; <span class="keyword">then</span></span><br><span class="line">ARGS=<span class="built_in">help</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">for</span> ARG <span class="keyword">in</span> <span class="variable">$@</span> <span class="variable">$ARGS</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$PIDFILE</span> ] ; <span class="keyword">then</span></span><br><span class="line">PID=`cat <span class="variable">$PIDFILE</span>`</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> -0 <span class="variable">$PID</span> 2&gt;/dev/null ; <span class="keyword">then</span></span><br><span class="line"><span class="comment"># smokeping is running</span></span><br><span class="line">RUNNING=1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># smokeping not running but PID file exists =&gt; delete PID file</span></span><br><span class="line">rm -f <span class="variable">$PIDFILE</span></span><br><span class="line">RUNNING=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># smokeping (no pid file) not running</span></span><br><span class="line">RUNNING=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$ARG</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 0 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$SMOKEPING</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping started"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be started"</span></span><br><span class="line">ERROR=1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is running with PID <span class="variable">$PID</span>"</span></span><br><span class="line">ERROR=2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> <span class="variable">$PID</span> ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping (<span class="variable">$PID</span>) stopped"</span></span><br><span class="line">rm <span class="variable">$PIDFILE</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be stopped"</span></span><br><span class="line">ERROR=3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping not running"</span></span><br><span class="line">ERROR=4</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$SMOKEPING</span> --restart &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping restarted"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be started"</span></span><br><span class="line">ERROR=5</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="variable">$0</span> start</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">strace_debug)</span><br><span class="line">rm -f /tmp/strace_smokeping</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> strace -o/tmp/strace_smokeping <span class="variable">$SMOKEPING</span> --restart &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping restarted with strace debug in /tmp/strace_smokeping"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping strace debug could not be started"</span></span><br><span class="line">ERROR=6</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">if</span> strace -o/tmp/strace_smokeping <span class="variable">$SMOKEPING</span> &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping started with strace debug in /tmp/strace_smokeping"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping strace debug could not be started"</span></span><br><span class="line">ERROR=7</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is running with PID (<span class="variable">$PID</span>)"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is not running"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$0</span> (start|stop|restart|status|strace_debug|help)"</span></span><br><span class="line">cat</span><br><span class="line">start - start smokeping</span><br><span class="line">stop - stop smokeping</span><br><span class="line">restart - restart smokeping <span class="keyword">if</span> running or start <span class="keyword">if</span> not running</span><br><span class="line">status - show status <span class="keyword">if</span> smokeping is running or not</span><br><span class="line"><span class="built_in">help</span> - this screen</span><br><span class="line">EOF</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$ERROR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod +x /etc/init.d/smokeping</span></span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service httpd start</span></span><br><span class="line"><span class="comment"># /etc/init.d/smokeping start</span></span><br></pre></td></tr></table></figure><p>æ‰“å¼€æµè§ˆå™¨æµ‹è¯•http://{ip}/smokeping ä¼šæç¤ºè¾“å…¥ç”¨æˆ·å’Œå¯†ç <br><img src="https://img.xxlaila.cn/74D2C8DE-129F-4219-87C5-D6A771D19484.png" alt="img"><br><img src="https://img.xxlaila.cn/91D9FA70-65B1-4752-8F15-68A158E72A49.png" alt="img"></p><h4 id="é…ç½®æ–‡ä»¶æ·»åŠ "><a href="#é…ç½®æ–‡ä»¶æ·»åŠ " class="headerlink" title="é…ç½®æ–‡ä»¶æ·»åŠ "></a>é…ç½®æ–‡ä»¶æ·»åŠ </h4><p>é…ç½®æ–‡ä»¶æ·»ä»‹ç»ï¼Œåœ¨é…ç½®æ–‡ä»¶é‡Œé¢+è¡¨ç¤ºä¸€çº§++è¡¨ç¤ºäºŒçº§+++ä¸‰çº§<br>æœ¬æ¬¡æ·»åŠ çš„å†…å®¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">+ Other</span><br><span class="line">menu = å…¶ä»–ç½‘ç»œç›‘æ§</span><br><span class="line">title = å…¶ä»–æ‰€æœ‰ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">++ dianxin</span><br><span class="line">menu = ç”µä¿¡ç½‘ç»œç›‘æ§</span><br><span class="line">title = ç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/dianxin/dianxin-hlj /Other/dianxin/dianxin-gd /Other/dianxin/dianxin-gs /Other/dianxin/dianxin-sh /Other/dianxin/dianxin-sc /Other/dianxin/dianxin-cq /Other/dianxin/dianxin-gz /Other/dianxin/dianxin-ln /Other/dianxin/dianxin-zj /Other/dianxin/dianxin-sd /Other/dianxin/dianxin-hib /Other/dianxin/dianxin-ah /Other/dianxin/dianxin-hb /Other/dianxin/dianxin-jl /Other/dianxin/dianxin-jx</span><br><span class="line">+++ dianxin-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿç”µä¿¡</span><br><span class="line">title = é»‘é¾™æ±Ÿç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 219.150.32.132</span><br><span class="line">+++ dianxin-gd</span><br><span class="line">menu = å¹¿ä¸œç”µä¿¡</span><br><span class="line">title = å¹¿ä¸œç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.96.134.133</span><br><span class="line">+++ dianxin-gs</span><br><span class="line">menu = ç”˜è‚ƒç”µä¿¡</span><br><span class="line">title = ç”˜è‚ƒç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.100.64.68</span><br><span class="line">+++ dianxin-sh</span><br><span class="line">menu = ä¸Šæµ·ç”µä¿¡</span><br><span class="line">title = ä¸Šæµ·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.96.209.5</span><br><span class="line">+++ dianxin-sc</span><br><span class="line">menu = å››å·ç”µä¿¡</span><br><span class="line">title = å››å·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.6.145.111</span><br><span class="line">+++ dianxin-cq</span><br><span class="line">menu = é‡åº†ç”µä¿¡</span><br><span class="line">title = é‡åº†ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 61.128.128.68</span><br><span class="line">+++ dianxin-gz</span><br><span class="line">menu = è´µå·ç”µä¿¡</span><br><span class="line">title = è´µå·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.98.192.68</span><br><span class="line">+++ dianxin-ln</span><br><span class="line">menu = è¾½å®ç”µä¿¡</span><br><span class="line">title = è¾½å®ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 219.149.6.99</span><br><span class="line">+++ dianxin-zj</span><br><span class="line">menu = æµ™æ±Ÿç”µä¿¡</span><br><span class="line">title = æµ™æ±Ÿç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.96.96.68</span><br><span class="line">+++ dianxin-sd</span><br><span class="line">menu = å±±ä¸œç”µä¿¡</span><br><span class="line">title = å±±ä¸œç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 222.173.95.53</span><br><span class="line">+++ dianxin-hib</span><br><span class="line">menu = æ¹–åŒ—ç”µä¿¡</span><br><span class="line">title = æ¹–åŒ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.103.0.68</span><br><span class="line">+++ dianxin-ah</span><br><span class="line">menu = å®‰å¾½ç”µä¿¡</span><br><span class="line">title = å®‰å¾½ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 220.178.75.134</span><br><span class="line">+++ dianxin-hb</span><br><span class="line">menu = æ²³åŒ—ç”µä¿¡</span><br><span class="line">title = æ²³åŒ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.99.160.68</span><br><span class="line">+++ dianxin-jl</span><br><span class="line">menu = å‰æ—ç”µä¿¡</span><br><span class="line">title = å‰æ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host =  219.149.194.55</span><br><span class="line">+++ dianxin-jx</span><br><span class="line">menu = æ±Ÿè¥¿ç”µä¿¡</span><br><span class="line">title = æ±Ÿè¥¿ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.101.224.68</span><br><span class="line"><span class="comment">#+++ dianxin-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/dianxin/dianxin-hlj /Other/dianxin/dianxin-gd /Other/dianxin/dianxin-gs /Other/dianxin/dianxin-sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">++ liantong</span><br><span class="line">menu = è”é€šç½‘ç»œç›‘æ§</span><br><span class="line">title = è”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/liantong/liantong-hlj /Other/liantong/liantong-gd /Other/liantong/liantong-gs /Other/liantong/liantong-sh /Other/liantong/liantong-sc /Other/liantong/liantong-cq /Other/liantong/liantong-gz /Other/liantong/liantong-ln /Other/liantong/liantong-zj /Other/liantong/liantong-sd /Other/liantong/liantong-hib /Other/liantong/liantong-ah /Other/liantong/liantong-hb /Other/liantong/liantong-jl /Other/liantong/liantong-jx</span><br><span class="line">+++ liantong-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿè”é€š</span><br><span class="line">title = é»‘é¾™æ±Ÿè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.97.224.68</span><br><span class="line">+++ liantong-gd</span><br><span class="line">menu = å¹¿ä¸œè”é€š</span><br><span class="line">title = å¹¿ä¸œè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 221.4.66.66</span><br><span class="line">+++ liantong-gs</span><br><span class="line">menu = ç”˜è‚ƒè”é€š</span><br><span class="line">title = ç”˜è‚ƒè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 221.7.34.10</span><br><span class="line">+++ liantong-sh</span><br><span class="line">menu = ä¸Šæµ·è”é€š</span><br><span class="line">title = ä¸Šæµ·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 210.22.70.3</span><br><span class="line">+++ liantong-sc</span><br><span class="line">menu = å››å·è”é€š</span><br><span class="line">title = å››å·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 119.6.6.6</span><br><span class="line">+++ liantong-cq</span><br><span class="line">menu = é‡åº†è”é€š</span><br><span class="line">title = é‡åº†è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.7.92.98</span><br><span class="line">+++ liantong-gz</span><br><span class="line">menu = è´µå·è”é€š</span><br><span class="line">title = è´µå·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.13.30.242</span><br><span class="line">+++ liantong-ln</span><br><span class="line">menu = è¾½å®è”é€š</span><br><span class="line">title = è¾½å®è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 124.161.97.234</span><br><span class="line">+++ liantong-zj</span><br><span class="line">menu = æµ™æ±Ÿè”é€š</span><br><span class="line">title = æµ™æ±Ÿè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.12.33.227</span><br><span class="line">+++ liantong-sd</span><br><span class="line">menu = å±±ä¸œè”é€š</span><br><span class="line">title = å±±ä¸œè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.102.152.3</span><br><span class="line">+++ liantong-hib</span><br><span class="line">menu = æ¹–åŒ—è”é€š</span><br><span class="line">title = æ¹–åŒ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.104.111.114</span><br><span class="line">+++ liantong-ah</span><br><span class="line">menu = å®‰å¾½è”é€š</span><br><span class="line">title = å®‰å¾½è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.91.88.129</span><br><span class="line">+++ liantong-hb</span><br><span class="line">menu = æ²³åŒ—è”é€š</span><br><span class="line">title = æ²³åŒ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.99.160.68</span><br><span class="line">+++ liantong-jl</span><br><span class="line">menu = å‰æ—è”é€š</span><br><span class="line">title = å‰æ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.98.5.6</span><br><span class="line">+++ liantong-jx</span><br><span class="line">menu = æ±Ÿè¥¿è”é€š</span><br><span class="line">title = æ±Ÿè¥¿è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 220.248.192.12</span><br><span class="line"><span class="comment">#+++ liantong-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªè”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªè”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/liantong/liantong-hlj /Other/liantong/liantong-gd /Other/liantong/liantong-gs /Other/liantong/liantong-sh</span></span><br><span class="line">++ yidong</span><br><span class="line">menu = ç§»åŠ¨ç½‘ç»œç›‘æ§</span><br><span class="line">title = ç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/yidong/yidong-hlj /Other/yidong/yidong-gd /Other/yidong/yidong-gs /Other/yidong/yidong-sh /Other/yidong/yidong-sc /Other/yidong/yidong-cq /Other/yidong/yidong-gz /Other/yidong/yidong-ln /Other/yidong/yidong-zj /Other/yidong/yidong-sd /Other/yidong/yidong-hib /Other/yidong/yidong-ah /Other/yidong/yidong-hb</span><br><span class="line">+++ yidong-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿç§»åŠ¨</span><br><span class="line">title = é»‘é¾™æ±Ÿç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 211.137.241.34</span><br><span class="line">+++ yidong-gd</span><br><span class="line">menu = å¹¿ä¸œç§»åŠ¨</span><br><span class="line">title = å¹¿ä¸œç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 211.137.241.34</span><br><span class="line">+++ yidong-gs</span><br><span class="line">menu = ç”˜è‚ƒç§»åŠ¨</span><br><span class="line">title = ç”˜è‚ƒç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 218.203.160.194</span><br><span class="line">+++ yidong-sh</span><br><span class="line">menu = ä¸Šæµ·ç§»åŠ¨</span><br><span class="line">title = ä¸Šæµ·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 117.131.0.22</span><br><span class="line">+++ yidong-sc</span><br><span class="line">menu = å››å·ç§»åŠ¨</span><br><span class="line">title = å››å·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.96.205</span><br><span class="line">+++ yidong-cq</span><br><span class="line">menu = é‡åº†ç§»åŠ¨</span><br><span class="line">title = é‡åº†ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.201.4.3</span><br><span class="line">+++ yidong-gz</span><br><span class="line">menu = è´µå·ç§»åŠ¨</span><br><span class="line">title = è´µå·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.139.1.3</span><br><span class="line">+++ yidong-ln</span><br><span class="line">menu = è¾½å®ç§»åŠ¨</span><br><span class="line">title = è¾½å®ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.59.181.182</span><br><span class="line">+++ yidong-zj</span><br><span class="line">menu = æµ™æ±Ÿç§»åŠ¨</span><br><span class="line">title = æµ™æ±Ÿç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.140.10.2</span><br><span class="line">+++ yidong-sd</span><br><span class="line">menu = å±±ä¸œç§»åŠ¨</span><br><span class="line">title = å±±ä¸œç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.191.26</span><br><span class="line">+++ yidong-hib</span><br><span class="line">menu = æ¹–åŒ—ç§»åŠ¨</span><br><span class="line">title = æ¹–åŒ—ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.76.68</span><br><span class="line">+++ yidong-ah</span><br><span class="line">menu = å®‰å¾½ç§»åŠ¨</span><br><span class="line">title = å®‰å¾½ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.138.180.2</span><br><span class="line">+++ yidong-hb</span><br><span class="line">menu = æ²³åŒ—ç§»åŠ¨</span><br><span class="line">title = æ²³åŒ—ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.98.2.4</span><br><span class="line"><span class="comment">#+++ yidong-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/yidong/yidong-hlj /Other/yidong/yidong-gd /Other/yidong/yidong-gs /Other/yidong/yidong-sh</span></span><br><span class="line">++ jiaoyu</span><br><span class="line">menu = æ•™è‚²ç½‘ç»œç›‘æ§</span><br><span class="line">title = æ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/jiaoyu/jiaoyu-qh /Other/jiaoyu/jiaoyu-sh /Other/jiaoyu/jiaoyu-wh /Other/jiaoyu/jiaoyu-hn</span><br><span class="line">+++ jiaoyu-qh</span><br><span class="line">menu = æ¸…åå¤§å­¦</span><br><span class="line">title = æ¸…åå¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 166.111.8.28</span><br><span class="line">+++ jiaoyu-sh</span><br><span class="line">menu = ä¸Šæµ·äº¤å¤§</span><br><span class="line">title = ä¸Šæµ·äº¤å¤§</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.112.26.34</span><br><span class="line">+++ jiaoyu-wh</span><br><span class="line">menu = æ­¦æ±‰ç§‘æŠ€å¤§å­¦</span><br><span class="line">title = æ­¦æ±‰ç§‘æŠ€å¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.114.240.6</span><br><span class="line">+++ jiaoyu-hn</span><br><span class="line">menu = åå—å†œä¸šå¤§å­¦</span><br><span class="line">title = åå—å†œä¸šå¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.116.160.33</span><br><span class="line"><span class="comment">#+++ jiaoyu-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªæ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªæ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/jiaoyu/jiaoyu-qh /Other/jiaoyu/jiaoyu-sh /Other/jiaoyu/jiaoyu-wh /Other/jiaoyu/jiaoyu-hn</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Smokeping</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux å¸¸ç”¨å‘½ä»¤å­¦ä¹ </title>
    <url>/2019/09/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:15 GMT+0800 (China Standard Time) --><h4 id="æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤"><a href="#æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤" class="headerlink" title="æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤"></a>æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤</h4><ul><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹é¢å¤§å°è¶…è¿‡5Mçš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ -size +5M</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹100å¤©ä¹‹å‰ä¿®æ”¹è¿‡çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ -mtime +100</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹60å¤©æœªè¢«è®¿é—®è¿‡çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ \! atime -60</span><br></pre></td></tr></table></figure></li></ul><a id="more"></a><ul><li>æŸ¥æ‰¾ç›®å½•ä¸‹é¢æ–‡ä»¶â€œcoreâ€œï¼Œå¦‚æœå‘ç°æ— éœ€æç¤ºç›´æ¥åˆ é™¤ã€‚<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find / -name core -<span class="built_in">exec</span> rm &#123;&#125; \</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾æ’é™¤æŸä¸€ä¸ªæ–‡ä»¶ç„¶åè¿›è¡Œåˆ é™¤</span></span><br><span class="line">$ find / -<span class="built_in">type</span> f ! -name <span class="string">"test"</span> -<span class="built_in">exec</span> rm &#123;&#125; \;</span><br><span class="line">$ find ./ -mtime +3 -name <span class="string">"*.log"</span> -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br><span class="line">$ find /tmp -mtime +30 -<span class="built_in">type</span> f -name <span class="string">"*.sh[ab]"</span> -<span class="built_in">exec</span> rm -f &#123;&#125; \;</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨ä¸€ä¸ªç›®å½•ä¸­ä¿ç•™æœ€è¿‘30å¤©çš„æ–‡ä»¶ï¼Œ30å¤©å‰çš„æ–‡ä»¶è‡ªåŠ¨åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /tmp -mtime +30 -<span class="built_in">type</span> f -name <span class="string">"*.sh[ab]"</span> -<span class="built_in">exec</span> rm -f &#123;&#125; \;</span><br></pre></td></tr></table></figure><ul><li>/tmp â€“è®¾ç½®æŸ¥æ‰¾çš„ç›®å½•ï¼›</li><li>-mtime +30 â€“è®¾ç½®æ—¶é—´ä¸º30å¤©å‰ï¼›</li><li>-type f â€“è®¾ç½®æŸ¥æ‰¾çš„ç±»å‹ä¸ºæ–‡ä»¶ï¼›</li><li>-name *.sh[ab] â€“è®¾ç½®æ–‡ä»¶åç§°ä¸­åŒ…å«shaæˆ–è€…shbï¼›</li><li>-exec rm -f â€“æŸ¥æ‰¾å®Œæ¯•åæ‰§è¡Œåˆ é™¤æ“ä½œï¼›</li><li><strong>æç¤º</strong>ï¼šå°†æ­¤å‘½ä»¤å†™å…¥crontabåå³å¯è‡ªåŠ¨å®ŒæˆæŸ¥æ‰¾å¹¶åˆ é™¤çš„å·¥ä½œ</li></ul><ul><li>æ˜¾ç¤ºç›®å½•æ–‡ä»¶çš„æ–‡ä»¶åå’Œå®ƒä»¬çš„æ‹¥æœ‰è€…<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ll | awk <span class="string">'&#123;print $3,"owns",$9&#125;'</span></span><br></pre></td></tr></table></figure></li></ul><p>æ˜¾ç¤ºä½ çš„ç³»ç»Ÿä¸ŠPCIæ€»çº¿å’Œé™„åŠ è®¾å¤‡çš„ä¿¡æ¯ã€‚æŒ‡å®š-vï¼Œ-vvæˆ–-vvvæ¥è·å–è¶Šæ¥è¶Šè¯¦ç»†çš„è¾“å‡º</p><ul><li><p>lspci å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum whatprovides */lspci</span><br><span class="line">pciutils-3.5.1-2.el7.x86_64 : PCI bus related utilities</span><br><span class="line">Repo        : base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /usr/sbin/lspci</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pciutils-3.5.1-3.el7.x86_64 : PCI bus related utilities</span><br><span class="line">Repo        : base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /usr/sbin/lspci</span><br><span class="line"></span><br><span class="line">$ sudo yum install pciutils</span><br><span class="line"></span><br><span class="line">lspci æ›´å¤š[è¯¦ç»†ä½¿ç”¨](https://blog.csdn.net/styshoo/article/details/51281437)</span><br><span class="line"></span><br><span class="line">$ lspci -vvvvv</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å½“å‰çš„LinuxæœåŠ¡å™¨çš„è¿è¡Œçº§åˆ«</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ who -r</span><br><span class="line">$ who -b </span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿæœ€åä¸€æ¬¡å¯åŠ¨çš„æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">$ last reboot</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿå†å²å¯åŠ¨çš„æ—¶é—´</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿè¿è¡Œäº†å¤šé•¿æ—¶é—´</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /proc/uptime| awk -F. <span class="string">'&#123;run_days=$1 / 86400;run_hour=($1 % 86400)/3600;run_minute=($1 % 3600)/60;run_second=$1 % 60;printf("ç³»ç»Ÿå·²è¿è¡Œï¼š%då¤©%dæ—¶%dåˆ†%dç§’",run_days,run_hour,run_minute,run_second)&#125;'</span></span><br><span class="line">$ w</span><br><span class="line">$ uptime</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿå¯åŠ¨çš„æ—¥æœŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ date -d <span class="string">"<span class="variable">$(awk -F. '&#123;print $1&#125;' /proc/uptime)</span> second ago"</span> +<span class="string">"%Y-%m-%d %H:%M:%S"</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶å†…å®¹æ²¡æœ‰åŒ…æ‹¬â€œnginxâ€ã€â€œmsgTypeâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep -r -l -v <span class="string">"nginx"</span> /data/</span><br><span class="line">$ grep -r  -v <span class="string">"msgType"</span> /data/</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶å†…å®¹åŒ…æ‹¬â€nginxâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep -r <span class="string">"nginx"</span> /data/                                             ä¼šæŠŠ<span class="string">"nginx"</span>å­—ç¬¦ä¸²æ‰€åœ¨è¿™è¡Œçš„å†…å®¹æ˜¾ç¤ºå‡ºæ¥</span><br><span class="line">$ grep -o â€œnginxâ€ /data/</span><br><span class="line">$ grep -r -l <span class="string">"nginx"</span> /data/                                          ä¸æ˜¾ç¤º<span class="string">"nginx"</span>å­—ç¬¦ä¸²æ‰€åœ¨è¡Œï¼Œæ˜¯æ˜¾ç¤ºæ–‡ä»¶</span><br></pre></td></tr></table></figure></li><li><p>catä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat sentry.conf.py |grep -v <span class="string">"^#"</span>          æŸ¥çœ‹é…ç½®æ–‡ä»¶ä¸åŒ…æ‹¬æ³¨é‡Šå†…å®¹</span><br><span class="line">$ cat -b `find /var/<span class="built_in">log</span>/httpd/ -cmin -60 -<span class="built_in">print</span> |sed <span class="string">"1d"</span>`\ |awk <span class="string">'&#123;print $2&#125;'</span>|sort |uniq -c |sort -n -k 1 -r |head -n 1               ç»Ÿè®¡å½“å‰ç›®å½•ä¸‹æ—¥å¿—æ–‡ä»¶é‡Œé¢Iå¹³è®¿é—®é‡æœ€å¤šçš„ä¸€ä¸ªIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŸä¸€ä¸ªæ—¶é—´æ®µçš„IPåœ°å€è®¿é—®æ’åå‰10</span></span><br><span class="line">$ cat nginx_access.log|grep <span class="string">'+0800'</span>|awk <span class="string">'&#123;split($1,array,"[");if(array[2]&gt;="25/Jul/2017:14:17:30" &amp;&amp; array[2]&lt;="25/Jul/2017:20:17:30")&#123;print $0&#125;&#125;'</span>|awk -F<span class="string">"^`"</span> &amp;&amp; <span class="string">"-"</span> &amp;&amp; <span class="string">"^`"</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å½“å‰æ—¥å¿—ipè®¿é—®å‰10</span></span><br><span class="line">$ cat nginx_access.log |awk -F<span class="string">"^"</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br></pre></td></tr></table></figure></li><li><p>è·å–IPåœ°å€é€šç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig |sed -n 2p |awk <span class="string">'&#123;print $1$2&#125;'</span>|sed <span class="string">'s/^.*[^0-9]\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)$/\1\.\2\.\3\.\4/g'</span></span><br></pre></td></tr></table></figure></li><li><p>curlä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›‘æ§ç½‘é¡µçš„å“åº”æ—¶é—´</span></span><br><span class="line">$ curl -o /dev/null -s -w <span class="string">"time_connect: %&#123;time_connect&#125;\ntime_starttransfer: %&#123;time_starttransfer&#125;\ntime_total: %&#123;time_total&#125;\n"</span> <span class="string">"http://www.baidu.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›‘æ§ç«™ç‚¹å¯ç”¨æ€§</span></span><br><span class="line">$ curl -o /dev/null -s -w %&#123;http_code&#125; <span class="string">"http://www.baidu.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯gzipè¯·æ±‚</span></span><br><span class="line">$ curl -I http://www.sina.com.cn/ -H Accept-Encoding:gzip,defalte</span><br></pre></td></tr></table></figure></li><li><p>æ¯10ç§’æ˜¾ç¤ºä¸€æ¬¡å¤åˆ¶çš„å¤§å°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ watch -n 10 du -sh /root</span><br></pre></td></tr></table></figure></li><li><p>ç»Ÿè®¡ç›®å½•(åŒ…æ‹¬å­ç›®å½•)ä¸‹é¢æ–‡ä»¶ä¸ªæ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find ./ -<span class="built_in">type</span> f | wc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨findå‘½ä»¤æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ˜¯æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶ï¼Œç„¶åç”¨wcæ¥è®¡æ•°</span></span><br><span class="line">$ ls -lR|grep <span class="string">"^-"</span>|wc -l</span><br><span class="line"><span class="comment"># lså‘½ä»¤åŠ Rå‚æ•°ï¼Œåˆ—å‡ºä¸‹çº§å­ç›®å½•ï¼Œä½¿ç”¨grepå‘½ä»¤è¿‡æ»¤ä»¥â€œ-â€å¼€å¤´çš„ï¼Œå¦‚æœæ˜¯ç›®å½•å°±æ”¹æˆâ€œ^dâ€ï¼Œåé¢ç”¨wcè®¡æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line">$ find ./ -name <span class="string">"*.*"</span> |xargs cat|grep -v ^$|wc -l</span><br><span class="line">$ find . \( ! -name <span class="string">'*.png'</span> ! -name <span class="string">'*.gif'</span> ! -name <span class="string">'*.jpg'</span> ! -name <span class="string">'*.swf'</span> \) -<span class="built_in">type</span> f |wc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„çš„è¡Œæ•°ï¼Œå»æ‰ç©ºè¡Œ</span></span><br><span class="line">$ find ./ -name <span class="string">"*.*"</span> |xargs cat|wc -l   </span><br><span class="line">$ find . \( ! -name <span class="string">'*.png'</span> ! -name <span class="string">'*.gif'</span> ! -name <span class="string">'*.jpg'</span> ! -name <span class="string">'*.swf'</span> \) -<span class="built_in">type</span> f |xargs cat|wc -l</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿtcpè¿æ¥ä¸­å„ä¸ªçŠ¶æ€çš„è¿æ¥æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -an | awk '/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºæ¯ä¸ªIPçš„è¿æ¥æ•°ï¼Œä»¥åŠæ€»çš„å„ä¸ªçŠ¶æ€çš„è¿æ¥æ•°</span></span><br><span class="line">$ netstat -n | awk <span class="string">'/^tcp/ &#123;n=split($(NF-1),array,":");if(n&lt;=2)++S[array[(1)]];else++S[array[(4)]];++s[$NF];++N&#125; END &#123;for(a in S)&#123;printf("%-20s %s\n", a, S[a]);++I&#125;printf("%-20s %s\n","TOTAL_IP",I);for(a in s) printf("%-20s %s\n",a, s[a]);printf("%-20s %s\n","TOTAL_LINK",N);&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å½“å‰tcp/ipé“¾æ¥æ•°æ’åå‰10çš„IP</span></span><br><span class="line">$ netstat -n|awk <span class="string">'/^tcp/ &#123;print $5&#125;'</span>|awk -F<span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨grepç»Ÿè®¡å½“å‰æ–‡ä»¶é‡Œé¢æ‰€æœ‰çš„IPåœ°å€</span></span><br><span class="line">$ grep -E -o <span class="string">"(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"</span> nginx_access.log</span><br></pre></td></tr></table></figure></li></ul><p>æŸ¥çœ‹ç³»ç»Ÿå½“å‰è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„æ•°ï¼ŒæŒ‰ç…§æœ€å¤§çš„è¿›è¡Œæ’åº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lsof -n | awk <span class="string">'&#123;print $2&#125;'</span> | sort | uniq -c | sort -nr | more</span><br></pre></td></tr></table></figure><ul><li>pingå‘½ä»¤æ˜¾ç¤ºæ—¶é—´ä»¥åŠæ—¥æœŸ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping www.sina.com.cn -i 3 | awk <span class="string">'&#123; print $0"\t" strftime("%Y-%m-%d %H:%M:%S",systime()) &#125; '</span> &gt; /opt/sina.log &amp;</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>iptables</title>
    <url>/2019/09/25/iptables/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="Iptables"><a href="#Iptables" class="headerlink" title="Iptables"></a>Iptables</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iptalbes æ˜¯ç”¨æ¥è®¾ç½®ã€ç»´æŠ¤å’Œæ£€æŸ¥Linuxå†…æ ¸çš„IPåŒ…è¿‡æ»¤è§„åˆ™çš„ã€‚å¯ä»¥å®šä¹‰ä¸åŒçš„è¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½åŒ…å«å‡ ä¸ªå†…éƒ¨çš„é“¾ï¼Œä¹Ÿèƒ½åŒ…å«ç”¨æˆ·å®šä¹‰çš„é“¾ã€‚æ¯ä¸ªé“¾éƒ½æ˜¯ä¸€ä¸ªè§„åˆ™åˆ—è¡¨ï¼Œå¯¹å¯¹åº”çš„åŒ…è¿›è¡ŒåŒ¹é…ï¼šæ¯æ¡è§„åˆ™æŒ‡å®šåº”å½“å¦‚ä½•å¤„ç†ä¸ä¹‹ç›¸åŒ¹é…çš„åŒ…ã€‚è¿™è¢«ç§°ä½œâ€™targetâ€™ï¼ˆç›®æ ‡ï¼‰ï¼Œä¹Ÿå¯ä»¥è·³å‘åŒä¸€ä¸ªè¡¨å†…çš„ç”¨æˆ·å®šä¹‰çš„é“¾ã€‚</p><a id="more"></a><h4 id="iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£"><a href="#iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£" class="headerlink" title="iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£"></a>iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£</h4><ul><li><p>å…è®¸æŸä¸ªIP ï¼ˆ192.168.6.100ï¼‰çš„æœºå™¨è¿›è¡ŒSSHè¿æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 192.168.6.100 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.100 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li><li><p>å…è®¸æŸä¸€æ®µçš„IP è®¿é—®SSH</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 192.168.6.0/24 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.0/24 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li><li><p>é™åˆ¶æŸä¸€IP è®¿é—®SSH</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp -s ! 192.168.6.100 --dport 22 -j ACCEPT --æ³¨æ„ï¼å·æœ‰ä¸ªç©ºæ ¼</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.0/24 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li></ul><h3 id="é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™"><a href="#é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™" class="headerlink" title="é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™"></a>é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™</h3><ul><li><p>é˜²æ­¢å¤–ç½‘ç”¨å†…ç½‘IPæ¬ºéª—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 10.0.0.0/8 -j DROP</span><br><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 172.16.0.0/12 -j DROP</span><br><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 192.168.0.0/16 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>ç¦æ­¢ä¸211.101.46.253çš„æ‰€æœ‰è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -d 211.101.46.253 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>ç¦ç”¨FTP(21)ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 21 -j DROP</span><br><span class="line"><span class="comment"># è¿™æ ·å†™èŒƒå›´å¤ªå¤§äº†,æˆ‘ä»¬å¯ä»¥æ›´ç²¾ç¡®çš„å®šä¹‰.</span></span><br><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 21 -d 211.101.46.253 -j DROP</span><br><span class="line"><span class="comment"># è¿™æ ·åªç¦ç”¨211.101.46.253åœ°å€çš„FTPè¿æ¥,å…¶ä»–è¿æ¥è¿˜å¯ä»¥.å¦‚web(80ç«¯å£)è¿æ¥.</span></span><br></pre></td></tr></table></figure></li><li><p>iptablesç™½åå•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 80 -j DROP</span><br><span class="line"><span class="comment"># æ‹’ç»æ‰€æœ‰IPé“¾æ¥80ç«¯å£</span></span><br><span class="line"></span><br><span class="line">$ iptables -A INPUT -s 58.17.245.222 -p tcp --dport 80 -j ACCEPT</span><br><span class="line"><span class="comment"># å…è®¸æŒ‡å®šIPè®¿é—®80ç«¯å£</span></span><br></pre></td></tr></table></figure></li><li><p>å…è®¸æ‰€æœ‰å·²ç»å»ºç«‹çš„å’Œç›¸å…³çš„è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p>dropéæ³•è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state INVALID -j DROP</span><br><span class="line">$ iptables -A OUTPUT -m state --state INVALID -j DROP</span><br><span class="line">$ iptables -A FORWARD -m state --state INVALID -j DROP</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç«¯å£æ˜ å°„"><a href="#ç«¯å£æ˜ å°„" class="headerlink" title="ç«¯å£æ˜ å°„"></a>ç«¯å£æ˜ å°„</h3><ul><li>è¿™é‡Œä½¿ç”¨çš„æ˜¯FTPæœåŠ¡(36542)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 36542 -j DNAT --to 192.168.50.2:36542</span><br><span class="line">$ iptables -t nat -A POSTROUTING -p tcp --dport 36542 -j MASQUERADE</span><br><span class="line"><span class="comment"># å› ä¸ºFTPä½¿ç”¨äº†ä¸¤ä¸ªç«¯å£21å’Œ20ï¼Œ21åªæ˜¯ç”¨äºè¿æ¥ï¼Œ20æ˜¯æ‰§è¡Œå‘½ä»¤çš„ã€‚20æ²¡åŠæ³•ä¿®æ”¹ï¼Œè¿™é‡Œä½¿ç”¨äº†è¢«åŠ¨æ¨¡å¼è¿æ¥ã€‚</span></span><br><span class="line"></span><br><span class="line">$ iptables -t nat -I PREROUTING -p tcp --dport 60000:65000 -j DNAT --to 192.168.50.2</span><br><span class="line"><span class="comment"># è¢«åŠ¨è¿æ¥ç«¯å£60000-65000å…¨éƒ¨è½¬å‘ç»™50.2</span></span><br><span class="line"></span><br><span class="line">$ iptables -t nat -I POSTROUTING -p tcp --dport 60000:65000 -j MASQUERADE</span><br><span class="line"><span class="comment"># éœ€è¦å¼€æ”¾60000:65000ç«¯å£ï¼Œ</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ç«¯å£è½¬å‘"><a href="#ç«¯å£è½¬å‘" class="headerlink" title="ç«¯å£è½¬å‘"></a>ç«¯å£è½¬å‘</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸æœ‰ä¸€å°æœåŠ¡å™¨è¿æ¥å¤–ç½‘ï¼Œå…¶ä»–çš„æœåŠ¡å™¨éƒ½ä¸èƒ½ä¸Šå¤–ç½‘ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå¤–ç½‘æœåŠ¡å™¨ç”¨ä½œç½‘å…³æœåŠ¡å™¨ï¼Œåšç«¯å£è½¬å‘ï¼Œè¿æ¥åˆ°å†…ç½‘æœåŠ¡å™¨</p><ul><li><p>è¿™é‡Œä½¿ç”¨æ•°æ®åº“çš„3306æ˜ å°„åˆ°å¤–ç½‘çš„çš„36544</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING  -m tcp -p tcp --dport 36544 -j DNAT --to-destination 172.16.1.11:3306</span><br><span class="line">$ iptables -t nat -A POSTROUTING -m tcp -p tcp --dport 3306 -d 172.16.1.11 -j SNAT --to-source 172.16.1.1</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ è¿ç»­ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp --dport 60000:65000 -j ACCEPT</span><br><span class="line"><span class="comment"># å†’å·è¡¨ç¤ºæ·»åŠ ä¸€ä¸ªè¿ç»­çš„ç«¯å£</span></span><br><span class="line"></span><br><span class="line">$ iptables -A INPUT -p tcp -m multiport â€“dport 21:25,135:139 -j DROP</span><br><span class="line"><span class="comment">#ä½¿ç”¨multiportå‚æ•°é…ç½®ä¸è¿ç»­ç«¯å£å’Œå¤šä¸ªç«¯å£</span></span><br></pre></td></tr></table></figure></li><li><p>ä»£ç†ä¸Šç½‘<br>å†…ç½‘æœºå­æ— æ³•ä¸Šç½‘ï¼Œé€šè¿‡ä¸€å°å¯ä»¥ä¸Šç½‘çš„ç”µè„‘ï¼Œåœ¨å¯ä»¥è®¿é—®å¤–ç½‘çš„serverä¸Šiptablesè®©å…¶ä¸€ä¸ªç½‘æ®µå†…çš„æœºå­è®¿é—®å¤–ç½‘ï¼Œè¿™é‡Œæ˜¯é˜¿é‡Œäº‘ç¯å¢ƒæ¥åšçš„ï¼Œå¼€å¯IPè½¬å‘åŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sed -i <span class="string">'s/net.ipv4.ip_forward = 0/net.ipv4.ip_forward = 1/g'</span> /etc/sysctl.conf</span><br><span class="line">$ iptables -t nat -I POSTROUTING -s 172.16.3.0/24 -j SNAT --to-source 172.16.3.2</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ“ä½œiptablesçš„natè§„åˆ™"><a href="#æ“ä½œiptablesçš„natè§„åˆ™" class="headerlink" title="æ“ä½œiptablesçš„natè§„åˆ™"></a>æ“ä½œiptablesçš„natè§„åˆ™</h4><ul><li><p>æŸ¥çœ‹è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -nvL -t nat</span><br><span class="line">$ iptables -t nat -L -n --line-numbers</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -D POSTROUTING 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptablesçš„è§„åˆ™å·</span></span><br><span class="line">$ iptables -nL --line-number</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹/æ›¿æ¢è§„åˆ™</span></span><br><span class="line">$ iptbales -R INPUT &#123;1&#125; -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è§„åˆ™</span></span><br><span class="line">$ iptables -D INPUT &#123;1&#125;</span><br></pre></td></tr></table></figure></li><li><p>iptalesç«¯å£é€šè¿‡ä¸€å¼ ç½‘å¡å‡ºå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLESHED -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p>æœ¬æœºç«¯å£ï¼Œæ˜ å°„åˆ°æœ¬æœºç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 25 -j REDIRECT --to-port 2525</span><br><span class="line">$ iptables -t nat -I PREROUTING --src 0/0 --dst 192.168.1.5 -p tcp --dport 80 -j REDIRECT --to-ports 8123</span><br><span class="line">$ iptables -t nat -I OUTPUT --src 0/0 --dst 192.168.1.5 -p tcp --dport 80 -j REDIRECT --to-ports 8123</span><br></pre></td></tr></table></figure></li><li><p>ä¿å­˜é˜²ç«å¢™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo /usr/libexec/iptables/iptables.init save</span><br></pre></td></tr></table></figure></li><li><p>å¥‡è‘©éœ€æ±‚ï¼Œå¼€æ”¾sshç«¯å£æŒ‡å®šçš„IPåœ°å€è®¿é—®ï¼Œå…¶ä»–ç«¯å£å¤ªå¤šä¸æƒ³æ·»åŠ èƒ½å¯¹å¤–è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"><span class="comment"># sample configuration for iptables service</span></span><br><span class="line"><span class="comment"># you can edit this manually or use system-config-firewall</span></span><br><span class="line"><span class="comment"># please do not ask us to add additional ports/services to this default configuration</span></span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT -s 192.168.10.1/32 -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m tcp --dport 22 -j  REJECT --reject-with icmp-port-unreachable</span><br><span class="line"><span class="comment">#-A INPUT -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line"><span class="comment">#-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>iptables</tag>
      </tags>
  </entry>
  <entry>
    <title>äº¤æ¢æœºåšç«¯å£èšåˆ</title>
    <url>/2019/09/25/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%81%9A%E7%AB%AF%E5%8F%A3%E8%81%9A%E5%90%88/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šh3c s5500 (Switch A)ã€‚huawei s5720S-SI-ACï¼ˆSwitch Bï¼‰</p><p>Switch A ä½œä¸ºä¸Šè¡Œäº¤æ¢æœºï¼ŒSwitch Bä½œä¸ºä¸‹è¡Œäº¤æ¢æœº</p><p><strong>ç»„ç½‘</strong>ï¼šä¸¤ä¸ªäº¤æ¢æœºçš„idã€vlanå·è¿™é‡Œä½¿ç”¨çš„æ˜¯ç›¸åŒ</p><a id="more"></a><p><img src="https://img.xxlaila.cn/2846sjdhausiy84yhks.png" alt="img"></p><h3 id="Switch-Aé…ç½®"><a href="#Switch-Aé…ç½®" class="headerlink" title="Switch Aé…ç½®"></a>Switch Aé…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]vlan 50</span><br><span class="line">[Switch A-SW-vlan50]quit</span><br><span class="line">[Switch A-SW]interface Bridge-Aggregation 50</span><br><span class="line">[Switch A-SW-Bridge-Aggregation50]port access vlan 50</span><br><span class="line">[Switch A-SW]interface GigabitEthernet 1/0/19</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/19]port link-aggregation group 50</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/19] port access vlan 50</span><br><span class="line">[Switch A-SW]interface GigabitEthernet 1/0/20</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/20]port link-aggregation group 50</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/20]port access vlan 50</span><br><span class="line">[Switch A-SW]link-aggregation load-sharing mode <span class="built_in">source</span>-mac destination-mac</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ç«¯å£èšåˆ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]dis link-aggregation verbose</span><br></pre></td></tr></table></figure></li></ul><h3 id="Switch-Bé…ç½®"><a href="#Switch-Bé…ç½®" class="headerlink" title="Switch Bé…ç½®"></a>Switch Bé…ç½®</h3><h4 id="1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜"><a href="#1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜" class="headerlink" title="1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜"></a>1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] interface eth-trunk 50</span><br><span class="line">[Switch B-Eth-Trunk1] trunkport gigabitethernet 0/0/1 to 0/0/3</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h4 id="2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan"><a href="#2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan" class="headerlink" title="2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan"></a>2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] vlan batch 50</span><br><span class="line">[Switch B] interface eth-trunk 50</span><br><span class="line">[Switch B-Eth-Trunk1] port link-type trunk</span><br><span class="line">[Switch B-Eth-Trunk1] port trunk allow-pass vlan 50</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h4 id="3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼"><a href="#3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼" class="headerlink" title="3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼"></a>3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] interface eth-trunk 1</span><br><span class="line">[Switch B-Eth-Trunk1] load-balance src-dst-mac</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h3 id="Switch-Aé…ç½®åœ°å€æ®µ"><a href="#Switch-Aé…ç½®åœ°å€æ®µ" class="headerlink" title="Switch Aé…ç½®åœ°å€æ®µ"></a>Switch Aé…ç½®åœ°å€æ®µ</h3><p>åœ¨vlané‡Œé¢èµ·ä¸€ä¸ªç½‘ç»œï¼Œä½†ä¸å¯ç”¨dhcpæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]int vlan 50</span><br><span class="line">[Switch A-SW-Vlan-interface50]ip ad 172.21.16.1 20</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>äº¤æ¢æœº</tag>
      </tags>
  </entry>
  <entry>
    <title>pv pvc</title>
    <url>/2019/09/25/pv-pvc/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="1ã€ä»‹ç»"><a href="#1ã€ä»‹ç»" class="headerlink" title="1ã€ä»‹ç»"></a>1ã€ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PersistentVolumeï¼ˆpvï¼‰å’ŒPersistentVolumeClaimï¼ˆpvcï¼‰æ˜¯k8sæä¾›çš„ä¸¤ç§APIèµ„æºï¼Œç”¨äºæŠ½è±¡å­˜å‚¨ç»†èŠ‚ã€‚ç®¡ç†å‘˜å…³æ³¨äºå¦‚ä½•é€šè¿‡pvæä¾›å­˜å‚¨åŠŸèƒ½è€Œæ— éœ€å…³æ³¨ç”¨æˆ·å¦‚ä½•ä½¿ç”¨ï¼ŒåŒæ ·çš„ç”¨æˆ·åªéœ€è¦æŒ‚è½½pvcåˆ°å®¹å™¨ä¸­è€Œä¸éœ€è¦å…³æ³¨å­˜å‚¨å·é‡‡ç”¨ä½•ç§æŠ€æœ¯å®ç°ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pvcå’Œpvçš„å…³ç³»ä¸podå’Œnodeå…³ç³»ç±»ä¼¼ï¼Œå‰è€…æ¶ˆè€—åè€…çš„èµ„æºã€‚pvcå¯ä»¥å‘pvç”³è¯·æŒ‡å®šå¤§å°çš„å­˜å‚¨èµ„æºå¹¶è®¾ç½®è®¿é—®æ¨¡å¼,è¿™å°±å¯ä»¥é€šè¿‡Provision -&gt; Claim çš„æ–¹å¼ï¼Œæ¥å¯¹å­˜å‚¨èµ„æºè¿›è¡Œæ§åˆ¶ã€‚</p><a id="more"></a><h3 id="2ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#2ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2ã€ç”Ÿå‘½å‘¨æœŸ"></a>2ã€ç”Ÿå‘½å‘¨æœŸ</h3><p>pvå’Œpvcéµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸ:</p><ul><li>ä¾›åº”å‡†å¤‡ã€‚é€šè¿‡é›†ç¾¤å¤–çš„å­˜å‚¨ç³»ç»Ÿæˆ–è€…äº‘å¹³å°æ¥æä¾›å­˜å‚¨æŒä¹…åŒ–æ”¯æŒã€‚<ul><li><strong>é™æ€æä¾›</strong>: ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¤šä¸ªPVï¼Œä¾›PVCä½¿ç”¨ã€‚</li><li><strong>åŠ¨æ€æä¾›</strong>: åŠ¨æ€åˆ›å»ºPVCç‰¹å®šçš„PVï¼Œå¹¶ç»‘å®šã€‚</li></ul></li><li>ç»‘å®šã€‚ç”¨æˆ·åˆ›å»ºpvcå¹¶æŒ‡å®šéœ€è¦çš„èµ„æºå’Œè®¿é—®æ¨¡å¼ã€‚åœ¨æ‰¾åˆ°å¯ç”¨pvä¹‹å‰ï¼Œpvcä¼šä¿æŒæœªç»‘å®šçŠ¶æ€ã€‚</li><li>ä½¿ç”¨ã€‚ç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvcã€‚</li><li>é‡Šæ”¾ã€‚ç”¨æˆ·åˆ é™¤pvcæ¥å›æ”¶å­˜å‚¨èµ„æºï¼Œpvå°†å˜æˆâ€œreleasedâ€çŠ¶æ€ã€‚ç”±äºè¿˜ä¿ç•™ç€ä¹‹å‰çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†ï¼Œå¦åˆ™è¿™äº›å­˜å‚¨èµ„æºæ— æ³•è¢«å…¶ä»–pvcä½¿ç”¨ã€‚</li><li>å›æ”¶(Reclaiming)ã€‚pvå¯ä»¥è®¾ç½®ä¸‰ç§å›æ”¶ç­–ç•¥ï¼šä¿ç•™ï¼ˆRetainï¼‰ï¼Œå›æ”¶ï¼ˆRecycleï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</li></ul><ul><li><strong>ä¿ç•™ç­–ç•¥</strong>: å…è®¸äººå·¥å¤„ç†ä¿ç•™çš„æ•°æ®ã€‚</li><li><strong>åˆ é™¤ç­–ç•¥</strong>: å°†åˆ é™¤pvå’Œå¤–éƒ¨å…³è”çš„å­˜å‚¨èµ„æºï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</li><li><strong>å›æ”¶ç­–ç•¥</strong>: å°†æ‰§è¡Œæ¸…é™¤æ“ä½œï¼Œä¹‹åå¯ä»¥è¢«æ–°çš„pvcä½¿ç”¨ï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›®å‰åªæœ‰NFSå’ŒHostPathç±»å‹å·æ”¯æŒå›æ”¶ç­–ç•¥ï¼ŒAWS EBS,GCE PD,Azure Diskå’ŒCinderæ”¯æŒåˆ é™¤(Delete)ç­–ç•¥ã€‚</p><h4 id="2-1ã€Provisioning"><a href="#2-1ã€Provisioning" class="headerlink" title="2.1ã€Provisioning"></a>2.1ã€Provisioning</h4><p>ä¸¤ç§æ–¹å¼æä¾›çš„PVèµ„æºä¾›ç»™ï¼š</p><ul><li><p>static:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡é›†ç¾¤ç®¡ç†è€…åˆ›å»ºå¤šä¸ªPVï¼Œä¸ºé›†ç¾¤â€œä½¿ç”¨è€…â€æä¾›å­˜å‚¨èƒ½åŠ›è€Œéšè—çœŸå®å­˜å‚¨çš„ç»†èŠ‚ã€‚å¹¶ä¸”å­˜åœ¨äºkubenretes apiä¸­ï¼Œå¯è¢«ç›´æ¥ä½¿ç”¨ã€‚</p></li><li><p>dynamic:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ¨æ€å·ä¾›ç»™æ˜¯kubernetesç‹¬æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¸€åŠŸèƒ½å…è®¸æŒ‰éœ€åˆ›å»ºå­˜å‚¨å»ºã€‚åœ¨æ­¤ä¹‹å‰ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦äº‹å…ˆåœ¨é›†ç¾¤å¤–ç”±å­˜å‚¨æä¾›è€…æˆ–è€…äº‘æä¾›å•†åˆ›å»º<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å­˜å‚¨å·ï¼ŒæˆåŠŸä¹‹åå†åˆ›å»ºPersistentVolumeå¯¹è±¡ï¼Œæ‰èƒ½å¤Ÿåœ¨kubernetesä¸­ä½¿ç”¨ã€‚åŠ¨æ€å·ä¾›ç»™èƒ½è®©é›†ç¾¤ç®¡ç†å‘˜ä¸å¿…è¿›è¡Œé¢„å…ˆåˆ›å»ºå­˜å‚¨å·ï¼Œè€Œæ˜¯éšç€ç”¨æˆ·éœ€æ±‚è¿›è¡Œåˆ›å»ºã€‚åœ¨1.5ç‰ˆæœ¬æé«˜äº†åŠ¨æ€å·çš„å¼¹æ€§å’Œå¯ç”¨æ€§ã€‚</p></li></ul><h3 id="PVç±»å‹"><a href="#PVç±»å‹" class="headerlink" title="PVç±»å‹"></a>PVç±»å‹</h3><p>pvæ”¯æŒä»¥ä¸‹ç±»å‹:</p><ul><li>GCEPersistentDisk</li><li>AWSElasticBlockStore</li><li>NFS</li><li>iSCSI</li><li>RBD (Ceph Block Device)</li><li>Glusterfs</li><li>AzureFile</li><li>AzureDisk</li><li>CephFS</li><li>cinder</li><li>FC</li><li>FlexVolume</li><li>Flocker</li><li>PhotonPersistentDisk</li><li>Quobyte</li><li>VsphereVolume</li><li>HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</li></ul><h4 id="3-1ã€PVå±æ€§"><a href="#3-1ã€PVå±æ€§" class="headerlink" title="3.1ã€PVå±æ€§"></a>3.1ã€PVå±æ€§</h4><ul><li>è®¿é—®æ¨¡å¼,ä¸pvçš„è¯­ä¹‰ç›¸åŒã€‚åœ¨è¯·æ±‚èµ„æºæ—¶ä½¿ç”¨ç‰¹å®šæ¨¡å¼ã€‚</li><li>èµ„æº,ç”³è¯·çš„å­˜å‚¨èµ„æºæ•°é¢ã€‚</li></ul><h4 id="3-2ã€PVå·é˜¶æ®µçŠ¶æ€"><a href="#3-2ã€PVå·é˜¶æ®µçŠ¶æ€" class="headerlink" title="3.2ã€PVå·é˜¶æ®µçŠ¶æ€"></a>3.2ã€PVå·é˜¶æ®µçŠ¶æ€</h4><ul><li>Available â€“ èµ„æºå°šæœªè¢«claimä½¿ç”¨</li><li>Bound â€“ å·å·²ç»è¢«ç»‘å®šåˆ°claimäº†</li><li>Released â€“ claimè¢«åˆ é™¤ï¼Œå·å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æœªè¢«é›†ç¾¤å›æ”¶ã€‚</li><li>Failed â€“ å·è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pv, pvc</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ©ç”¨NFSåŠ¨æ€æä¾›Kubernetesåç«¯å­˜å‚¨å·</title>
    <url>/2019/09/24/%E5%88%A9%E7%94%A8NFS%E5%8A%A8%E6%80%81%E6%8F%90%E4%BE%9BKubernetes%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8%E5%8D%B7/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nfs-client-provisioneræ˜¯ä¸€ä¸ªautomatic provisionerï¼Œä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œè‡ªåŠ¨åˆ›å»ºPVå’Œå¯¹åº”çš„PVCï¼Œæœ¬èº«ä¸æä¾›NFSå­˜å‚¨ï¼Œéœ€è¦å¤–éƒ¨å…ˆæœ‰ä¸€å¥—NFSå­˜å‚¨æœåŠ¡ã€‚</p><ul><li>PVä»¥ ${namespace}-${pvcName}-${pvName}çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">å®˜æ–¹è®¿é—®åœ°å€</a></p><a id="more"></a><h3 id="1ã€æƒé™ä½“ç³»æ„å»º"><a href="#1ã€æƒé™ä½“ç³»æ„å»º" class="headerlink" title="1ã€æƒé™ä½“ç³»æ„å»º"></a>1ã€æƒé™ä½“ç³»æ„å»º</h3><h4 id="1-1ã€åˆ›å»ºserviceaccount"><a href="#1-1ã€åˆ›å»ºserviceaccount" class="headerlink" title="1.1ã€åˆ›å»ºserviceaccount"></a>1.1ã€åˆ›å»ºserviceaccount</h4><p>ServiceAccountä¹Ÿæ˜¯ä¸€ç§è´¦å·, ä¾›è¿è¡Œåœ¨podä¸­çš„è¿›ç¨‹ä½¿ç”¨, ä¸ºpodä¸­çš„è¿›ç¨‹æä¾›å¿…è¦çš„èº«ä»½è¯æ˜</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; serviceaccount.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-2ã€åˆ›å»ºrole"><a href="#1-2ã€åˆ›å»ºrole" class="headerlink" title="1.2ã€åˆ›å»ºrole"></a>1.2ã€åˆ›å»ºrole</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt;clusterrole.yaml&lt;&lt;EOF</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    resources: [<span class="string">"storageclasses"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"events"</span>]</span><br><span class="line">    verbs: [<span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services"</span>, <span class="string">"endpoints"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>,<span class="string">"list"</span>, <span class="string">"watch"</span>,<span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"podsecuritypolicies"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"nfs-client-provisioner"</span>]</span><br><span class="line">    verbs: [<span class="string">"use"</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"><a href="#1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š" class="headerlink" title="1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"></a>1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt;clusterrolebinding.yaml &lt;&lt;EOF</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: kube-ops</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-4ã€æ‰§è¡Œåˆ›å»º"><a href="#1-4ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="1.4ã€æ‰§è¡Œåˆ›å»º"></a>1.4ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f serviceaccount.yaml -f clusterrole.yaml -f clusterrolebinding.yaml</span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span><br></pre></td></tr></table></figure><h3 id="2ã€å®‰è£…éƒ¨ç½²"><a href="#2ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="2ã€å®‰è£…éƒ¨ç½²"></a>2ã€å®‰è£…éƒ¨ç½²</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹è½½deployment.yamlæ–‡ä»¶,éœ€è¦ä¿®æ”¹NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ10.10.10.60ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/ifs/kubernetesï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><h4 id="2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"><a href="#2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·" class="headerlink" title="2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"></a>2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·</h4><p>æ ¹æ®PVCçš„è¯·æ±‚, åŠ¨æ€åˆ›å»ºPVå­˜å‚¨.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: quay.io/external_storage/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.21.17.39</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /opt</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: /opt</span><br><span class="line">            path: 172.21.17.39</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²class.yaml</li></ul><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´</p><h4 id="2-2ã€åˆ›å»ºstorageclass"><a href="#2-2ã€åˆ›å»ºstorageclass" class="headerlink" title="2.2ã€åˆ›å»ºstorageclass"></a>2.2ã€åˆ›å»ºstorageclass</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; class.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-3ã€æ‰§è¡Œåˆ›å»º"><a href="#2-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="2.3ã€æ‰§è¡Œåˆ›å»º"></a>2.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f deployment.yaml </span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">deployment.extensions/nfs-client-provisioner created</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f class.yaml </span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage created</span><br></pre></td></tr></table></figure><h5 id="2-3-1ã€æŸ¥çœ‹StorageClass"><a href="#2-3-1ã€æŸ¥çœ‹StorageClass" class="headerlink" title="2.3.1ã€æŸ¥çœ‹StorageClass"></a>2.3.1ã€æŸ¥çœ‹StorageClass</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get storageclass</span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   18s</span><br></pre></td></tr></table></figure><h5 id="2-3-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"><a href="#2-3-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨" class="headerlink" title="2.3.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"></a>2.3.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨</h5><p>è®¾ç½®è¿™ä¸ªdefaultåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl patch storageclass managed-nfs-storage -p <span class="string">'&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage patched</span><br></pre></td></tr></table></figure><ul><li>storage.yaml (å’Œä¸Šé¢ä¸€æ ·)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; storage.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">  annotations:</span><br><span class="line">    storageclass.kubernetes.io/is-default-class: <span class="string">"true"</span></span><br><span class="line">provisioner: fuseim.pri/ifs</span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-3-3ã€æŸ¥çœ‹éªŒè¯"><a href="#2-3-3ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="2.3.3ã€æŸ¥çœ‹éªŒè¯"></a>2.3.3ã€æŸ¥çœ‹éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get all -n kube-ops</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-77f678858b-8d2d6   1/1     Running   0          26m</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nfs-client-provisioner   1/1     1            1           29m</span><br><span class="line"></span><br><span class="line">NAME                                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nfs-client-provisioner-77f678858b   1         1         1       26m</span><br></pre></td></tr></table></figure><h3 id="3ã€éªŒè¯æµ‹è¯•"><a href="#3ã€éªŒè¯æµ‹è¯•" class="headerlink" title="3ã€éªŒè¯æµ‹è¯•"></a>3ã€éªŒè¯æµ‹è¯•</h3><h4 id="3-1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨"><a href="#3-1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨" class="headerlink" title="3.1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨"></a>3.1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; <span class="built_in">test</span>-claim.yaml &lt;&lt;EOF</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-claim</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2ã€å¯åŠ¨æµ‹è¯•POD"><a href="#3-2ã€å¯åŠ¨æµ‹è¯•POD" class="headerlink" title="3.2ã€å¯åŠ¨æµ‹è¯•POD"></a>3.2ã€å¯åŠ¨æµ‹è¯•POD</h4><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat  &gt; <span class="built_in">test</span>-pod.yaml &lt;&lt;EOF</span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-pod</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: <span class="built_in">test</span>-pod</span><br><span class="line">    image: docker.io/busybox:1.24</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"/bin/sh"</span></span><br><span class="line">    args:</span><br><span class="line">      - <span class="string">"-c"</span></span><br><span class="line">      - <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        mountPath: <span class="string">"/mnt"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: <span class="built_in">test</span>-claim</span><br></pre></td></tr></table></figure><h4 id="3-3ã€æ‰§è¡Œåˆ›å»º"><a href="#3-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="3.3ã€æ‰§è¡Œåˆ›å»º"></a>3.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f ./</span><br><span class="line">persistentvolumeclaim/<span class="built_in">test</span>-claim created</span><br><span class="line">pod/<span class="built_in">test</span>-pod created</span><br></pre></td></tr></table></figure><h4 id="3-4ã€æŸ¥çœ‹éªŒè¯"><a href="#3-4ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="3.4ã€æŸ¥çœ‹éªŒè¯"></a>3.4ã€æŸ¥çœ‹éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod,pv -n kube-ops</span><br><span class="line">NAME                                          READY   STATUS      RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-77f678858b-8d2d6   1/1     Running     0          3h26m</span><br><span class="line">pod/<span class="built_in">test</span>-pod                                  0/1     Completed   0          172m</span><br><span class="line"></span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">persistentvolume/pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Retain           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            172m</span><br></pre></td></tr></table></figure><ul><li>ç™»å½•nfsæœåŠ¡å™¨æŸ¥çœ‹æ˜¯å¦æˆåŠŸçš„åˆ›å»ºç›®å½•<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /opt/</span><br><span class="line">kube-ops-test-claim-pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-5ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"><a href="#3-5ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥" class="headerlink" title="3.5ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"></a>3.5ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥</h4><ul><li><p>æŸ¥çœ‹é›†ç¾¤ä¸­PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pv -n kube-ops</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Delete           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            3m6s</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl patch pv pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8  -p <span class="string">'&#123;"spec":&#123;"persistentVolumeReclaimPolicy":"Retain"&#125;&#125;'</span></span><br><span class="line">persistentvolume/pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8 patched</span><br><span class="line"></span><br><span class="line">$ kubectl get pv -n kube-ops</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Retain           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            3m54s</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pvc,pv</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 prometheus</title>
    <url>/2019/09/20/k8s-v1-14-prometheus/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h1 id="Prometheusã€Grafana-éƒ¨ç½²"><a href="#Prometheusã€Grafana-éƒ¨ç½²" class="headerlink" title="Prometheusã€Grafana éƒ¨ç½²"></a>Prometheusã€Grafana éƒ¨ç½²</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Grafanaæ˜¯ä¸€ä¸ªå¼€æºçš„åº¦é‡åˆ†æä¸å¯è§†åŒ–å¥—ä»¶ã€‚ç»å¸¸è¢«ç”¨ä½œåŸºç¡€è®¾æ–½çš„æ—¶é—´åºåˆ—æ•°æ®å’Œåº”ç”¨ç¨‹åºåˆ†æçš„å¯è§†åŒ–ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨å®ƒæ¥åšKubernetesé›†ç¾¤ç›‘æ§æ•°æ®çš„å¯è§†åŒ–ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆªè‡³å½“å‰ï¼Œprometheusã€grafanaå‡é‡‡ç”¨æœ€æ–°çš„é•œåƒåŒ…ï¼Œåœ¨åœ¨ç¬¬ä¸€æ¬¡éƒ¨ç½²çš„æ—¶å€™grafanaæŠ¥äº†ä¸€ä¸ªé”™è¯¯<code>mkdir: cannot create directory &#39;/var/lib/grafana/plugins&#39;: No such file or directory</code>,è¿™æ˜¯å› ä¸ºGrafanaå¯åŠ¨ä½¿ç”¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„éƒ½æ˜¯472ï¼Œé€ æˆå¯¹å¤–æŒ‚å­˜å‚¨æ²¡æœ‰æƒé™ã€‚<a href="https://grafana.com/docs/installation/docker/#migration-from-a-previous-version-of-the-docker-container-to-5-1-or-later" target="_blank" rel="noopener">å‚è€ƒå®˜æ–¹</a></p><a id="more"></a><h3 id="å¼€å§‹éƒ¨ç½²"><a href="#å¼€å§‹éƒ¨ç½²" class="headerlink" title="å¼€å§‹éƒ¨ç½²"></a>å¼€å§‹éƒ¨ç½²</h3><p>æ–°å»ºyamlæ–‡ä»¶</p><ul><li>monitor-namespace.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat  monitor-namespace.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring</span><br></pre></td></tr></table></figure></li></ul><p>å…¶ä»–çš„æ–‡ä»¶å‡é‡‡ç”¨ä»¥å‰å†å²çš„ï¼Œç„¶åç¨åŠ ä¿®æ”¹ï¼Œå…¶ä»–<a href="https://github.com/xxlaila/kubernetes-yaml.git" target="_blank" rel="noopener">yaml</a>æ–‡ä»¶,ç§»é™¤<code>grafana-ingress.yaml</code>ã€<code>prometheus-ingress.yaml</code></p><h3 id="æ–‡ä»¶ä¿®æ”¹"><a href="#æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="æ–‡ä»¶ä¿®æ”¹"></a>æ–‡ä»¶ä¿®æ”¹</h3><ul><li><p>grafana-deploy.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-core</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: grafana</span><br><span class="line">        component: core</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: grafana/grafana:latest</span><br><span class="line">        name: grafana-core</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment"># env:</span></span><br><span class="line">        resources:</span><br><span class="line">          <span class="comment"># keep request = limit to keep this container in guaranteed class</span></span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        env:</span><br><span class="line">          <span class="comment"># The following env variables set up basic auth twith the default admin user and admin password.</span></span><br><span class="line">          - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">            value: <span class="string">"true"</span></span><br><span class="line">          - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">            value: <span class="string">"false"</span></span><br><span class="line">          <span class="comment"># - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span></span><br><span class="line">          <span class="comment">#   value: Admin</span></span><br><span class="line">          <span class="comment"># does not really work, because of template variables in exported dashboards:</span></span><br><span class="line">          <span class="comment"># - name: GF_DASHBOARDS_JSON_ENABLED</span></span><br><span class="line">          <span class="comment">#   value: "true"</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 3000</span><br><span class="line">          <span class="comment"># initialDelaySeconds: 30</span></span><br><span class="line">          <span class="comment"># timeoutSeconds: 1</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: grafana-persistent-storage</span><br><span class="line">          mountPath: /var/lib/grafana</span><br><span class="line">      volumes:</span><br><span class="line">      - name: grafana-persistent-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>prometheus-deploy.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/prometheus:latest</span><br><span class="line">        name: prometheus</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - <span class="string">"/bin/prometheus"</span></span><br></pre></td></tr></table></figure></li><li><p>prometheus-svc.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    targetPort: 9090</span><br><span class="line">    <span class="comment">#nodePort: 30005</span></span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br></pre></td></tr></table></figure></li><li><p>grafana-svc.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line">  ports:</span><br><span class="line">    - port: 3000</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šæ‰§è¡Œå‡ æ¬¡</span></span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deploy -n monitoring</span></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/grafana-core-7b5989cf9d-snbk5   1/1     Running   0          2m31s</span><br><span class="line">pod/node-exporter-dddv7             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-fhfp6             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-m46bf             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-xkrzp             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-zfcxh             1/1     Running   0          12m</span><br><span class="line">pod/prometheus-67bcf457db-999ns     1/1     Running   0          12m</span><br><span class="line"></span><br><span class="line">NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/grafana         ClusterIP   10.254.95.151    &lt;none&gt;        3000/TCP         12m</span><br><span class="line">service/node-exporter   ClusterIP   10.254.114.12    &lt;none&gt;        9100/TCP         12m</span><br><span class="line">service/prometheus      ClusterIP   10.254.104.216   &lt;none&gt;        9090/TCP         12m</span><br><span class="line"></span><br><span class="line">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.extensions/grafana-core   1/1     1            1           12m</span><br><span class="line">deployment.extensions/prometheus     1/1     1            1           12m</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºIngress"><a href="#åˆ›å»ºIngress" class="headerlink" title="åˆ›å»ºIngress"></a>åˆ›å»ºIngress</h3><h4 id="prometheus-Ingress"><a href="#prometheus-Ingress" class="headerlink" title="prometheus Ingress"></a>prometheus Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat prometheus-Ingress.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-web-ui</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br></pre></td></tr></table></figure><h4 id="grafana-Ingress"><a href="#grafana-Ingress" class="headerlink" title="grafana Ingress"></a>grafana Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana-Ingress.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-web-ui</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br></pre></td></tr></table></figure><h4 id="æ‰§è¡Œåˆ›å»º-1"><a href="#æ‰§è¡Œåˆ›å»º-1" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f prometheus-Ingress.yaml </span></span><br><span class="line">ingress.extensions/prometheus-web-ui created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f grafana-Ingress.yaml </span></span><br><span class="line">ingress.extensions/grafana-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨è¾“å…¥prometheus.xxlaila.cnè®¿é—®prometheusï¼Œè¾“å…¥grafana.xxlaila.cnè®¿é—®grafanaã€‚</p><h3 id="è®¿é—®prometheus"><a href="#è®¿é—®prometheus" class="headerlink" title="è®¿é—®prometheus"></a>è®¿é—®prometheus</h3><p><img src="https://img.xxlaila.cn/1569218750254.jpg" alt="img"></p><h3 id="é…ç½®grafana"><a href="#é…ç½®grafana" class="headerlink" title="é…ç½®grafana"></a>é…ç½®grafana</h3><p><img src="https://img.xxlaila.cn/1568968344227.jpg" alt="img"></p><p>åˆ°grafanaçš„å®˜æ–¹ä¸‹è½½å¯¹åº”çš„æ¨¡ç‰ˆæ–‡ä»¶å¯¼å…¥ï¼Œå°±å¯ä»¥å‡ºå›¾å•¦<br><img src="https://img.xxlaila.cn/1568968420655.jpg" alt="img"></p><p><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/prometheus" target="_blank" rel="noopener">åç»­åˆ©ç”¨pvc</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14,prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 weave-scope</title>
    <url>/2019/09/20/k8s-v1-14-weave-scope/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="å‰æ²¿"><a href="#å‰æ²¿" class="headerlink" title="å‰æ²¿"></a>å‰æ²¿</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes é›†ç¾¤å¹¶éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨åªæ˜¯ç¬¬ä¸€æ­¥ã€‚ä¸€æ—¦é›†ç¾¤è¿è¡Œèµ·æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ä¸€èµ·æ­£å¸¸ï¼Œæ‰€æœ‰å¿…è¦ç»„ä»¶å°±ä½å¹¶å„å¸å…¶èŒï¼Œæœ‰è¶³å¤Ÿçš„èµ„æºæ»¡è¶³åº”ç”¨çš„éœ€æ±‚ã€‚Kubernetes æ˜¯ä¸€ä¸ªå¤æ‚ç³»ç»Ÿï¼Œè¿ç»´å›¢é˜Ÿéœ€è¦æœ‰ä¸€å¥—å·¥å…·å¸®åŠ©ä»–ä»¬è·çŸ¥é›†ç¾¤çš„å®æ—¶çŠ¶æ€ï¼Œå¹¶ä¸ºæ•…éšœæ’æŸ¥æä¾›åŠæ—¶å’Œå‡†ç¡®çš„æ•°æ®æ”¯æŒã€‚</p><h3 id="weave-scope-ä»‹ç»"><a href="#weave-scope-ä»‹ç»" class="headerlink" title="weave scope ä»‹ç»"></a>weave scope ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Weave Scopeæ˜¯Dockerå’ŒKubernetesçš„å¯è§†åŒ–å’Œç›‘æ§å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€ä¸ªè‡ªä¸Šè€Œä¸‹çš„åº”ç”¨ç¨‹åºä»¥åŠæ•´ä¸ªåŸºç¡€æ¶æ„è§†å›¾ï¼Œå¹¶å…è®¸æ‚¨åœ¨éƒ¨ç½²åˆ°äº‘æä¾›å•†æ—¶å®æ—¶è¯Šæ–­åˆ†å¸ƒå¼å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ä»»ä½•é—®é¢˜ã€‚</p><a id="more"></a><h3 id="åŠŸèƒ½ä»‹ç»"><a href="#åŠŸèƒ½ä»‹ç»" class="headerlink" title="åŠŸèƒ½ä»‹ç»"></a>åŠŸèƒ½ä»‹ç»</h3><ul><li>podæ‹“æ‰‘æ˜ å°„</li><li>å›¾å½¢æˆ–è¡¨æ ¼æ¨¡å¼</li><li>çµæ´»è¿‡æ»¤</li><li>å¼ºå¤§çš„æœç´¢åŠŸèƒ½</li><li>å®æ—¶åº”ç”¨å’Œå®¹å™¨æŒ‡æ ‡</li><li>æ’é™¤æ•…éšœå¹¶ç®¡ç†å®¹å™¨</li><li>ä½¿ç”¨Plugin APIç”Ÿæˆè‡ªå®šä¹‰æŒ‡æ ‡</li></ul><p><a href="https://www.weave.works/docs/scope/latest/features/" target="_blank" rel="noopener">ä»‹ç»å‚è€ƒ</a></p><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>åœ¨ K8s é›†ç¾¤ä¸­å®‰è£… Scope çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f "https://cloud.weave.works/k8s/scope.yaml?k8s-version=$(kubectl version | base64 | tr -d '\n')"</span></span><br><span class="line">namespace/weave created</span><br><span class="line">serviceaccount/weave-scope created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">deployment.apps/weave-scope-app created</span><br><span class="line">service/weave-scope-app created</span><br><span class="line">deployment.apps/weave-scope-cluster-agent created</span><br><span class="line">daemonset.extensions/weave-scope-agent created</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥"><a href="#æ£€æŸ¥" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deploy -n weave</span></span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/weave-scope-agent-2t4m5                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-6tfp5                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-fxj5f                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-gkxc6                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-qnbbv                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-app-b99fb9585-wld6n              1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-cluster-agent-77bc946585-8fcjj   1/1     Running   0          15m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/weave-scope-app   ClusterIP   10.254.184.106   &lt;none&gt;        80/TCP    15m</span><br><span class="line"></span><br><span class="line">NAME                                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.extensions/weave-scope-app             1/1     1            1           15m</span><br><span class="line">deployment.extensions/weave-scope-cluster-agent   1/1     1            1           15m</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºweave-scope-ingress"><a href="#åˆ›å»ºweave-scope-ingress" class="headerlink" title="åˆ›å»ºweave-scope ingress"></a>åˆ›å»ºweave-scope ingress</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat weave-scope.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: weave-web-ui</span><br><span class="line">  namespace: weave</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: weave-scope.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: weave-scope-app</span><br><span class="line">          servicePort: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f weave-scope.yaml </span></span><br><span class="line">ingress.extensions/weave-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆè¾“å…¥<code>weave-scope.xxlaila.cn</code>å³å¯è®¿é—®<br><img src="https://img.xxlaila.cn/1568958836846.jpg" alt="img"></p><h4 id="æ‹“æ‰‘ç»“æ„"><a href="#æ‹“æ‰‘ç»“æ„" class="headerlink" title="æ‹“æ‰‘ç»“æ„"></a>æ‹“æ‰‘ç»“æ„</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scope ä¼šè‡ªåŠ¨æ„å»ºåº”ç”¨å’Œé›†ç¾¤çš„é€»è¾‘æ‹“æ‰‘ã€‚æ¯”å¦‚ç‚¹å‡»é¡¶éƒ¨ Podsï¼Œä¼šæ˜¾ç¤ºæ‰€æœ‰ Pod ä»¥åŠ Pod ä¹‹é—´çš„ä¾èµ–å…³ç³»<br><img src="https://img.xxlaila.cn/1568958666089.jpg" alt="img"><br>ç‚¹å‡» Hostsï¼Œä¼šæ˜¾ç¤ºå„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œå¯ä»¥åœ¨ Scope ä¸­æŸ¥çœ‹èµ„æºçš„ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚<br><img src="https://img.xxlaila.cn/1568958913275.jpg" alt="img"></p><h3 id="åœ¨çº¿æ“ä½œ"><a href="#åœ¨çº¿æ“ä½œ" class="headerlink" title="åœ¨çº¿æ“ä½œ"></a>åœ¨çº¿æ“ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scope è¿˜æä¾›äº†ä¾¿æ·çš„åœ¨çº¿æ“ä½œåŠŸèƒ½ï¼Œæ¯”å¦‚é€‰ä¸­æŸä¸ª Hostï¼Œç‚¹å‡» &gt;_æŒ‰é’®å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€èŠ‚ç‚¹çš„å‘½ä»¤è¡Œç»ˆç«¯ï¼š<br><img src="https://img.xxlaila.cn/1568959004395.jpg" alt="img"></p><ul><li><p>ç‚¹å‡» Deployment çš„ + å¯ä»¥æ‰§è¡Œæ–°å¢ä¸€ä¸ªpodå®åˆ—<br><img src="https://img.xxlaila.cn/1568959269040.jpg" alt="img"></p></li><li><p>æŸ¥çœ‹podçš„æ—¥å¿—<br><img src="https://img.xxlaila.cn/1568959359334.jpg" alt="img"></p></li><li><p>attachã€restartã€stop å®¹å™¨ï¼Œä»¥åŠç›´æ¥åœ¨ Scope ä¸­æ’æŸ¥é—®é¢˜<br><img src="https://img.xxlaila.cn/1568959467442.jpg" alt="img"></p></li></ul><p>æ›´å¤šåŠŸå‘¢ä¸ªè¯·<a href="https://www.weave.works/docs/scope/latest/plugins/" target="_blank" rel="noopener">å‚è€ƒå®˜æ–¹</a>,æˆ–è€…å®æ“</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14, weave-scope</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 traefikéƒ¨ç½²</title>
    <url>/2019/09/20/k8s-v1-14-traefik%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefix å‰ç¯‡æ˜¯å¯ä»¥ä½¿ç”¨ï¼Œè¿™é‡Œk8s v1.14 ä¹‹å‰çš„æ‹¿æ¥ç”¨ä¸ä¸Šï¼Œç„¶åæŠ˜è…¾äº†ä¸€ä¸‹ï¼Œå‚è€ƒå®˜æ–¹çš„æŠ˜è…¾èµ·æ¥äº†</p><h3 id="åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes-1-6-ï¼‰"><a href="#åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes-1-6-ï¼‰" class="headerlink" title="åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes 1.6+ï¼‰"></a>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes 1.6+ï¼‰</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesåœ¨1.6+ä¸­å¼•å…¥äº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼Œä»¥å…è®¸å¯¹Kubernetesèµ„æºå’ŒAPIè¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚ç¾¤é›†é…ç½®äº†RBACï¼Œåˆ™éœ€è¦æˆæƒTraefikä½¿ç”¨Kubernetes APIã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®¾ç½®é€‚å½“çš„æƒé™ï¼šé€šè¿‡ç‰¹å®šäºå‘½åç©ºé—´çš„RoleBindingsæˆ–å•ä¸ªå…¨å±€ClusterRoleBindingã€‚</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¯ä¸ªå‘½åç©ºé—´çš„RoleBindingå¯ä»¥é™åˆ¶æˆäºˆæƒé™ï¼Œåªæœ‰Traefikæ­£åœ¨ç›‘è§†çš„åç§°ç©ºé—´æ‰èƒ½ä½¿ç”¨ï¼Œä»è€Œéµå¾ªæœ€å°æƒé™åŸåˆ™ã€‚å¦‚æœTraefikä¸åº”è¯¥ç›‘è§†æ‰€æœ‰åç§°ç©ºé—´ï¼Œå¹¶ä¸”åç§°ç©ºé—´é›†ä¸ä¼šåŠ¨æ€æ›´æ”¹ï¼Œé‚£ä¹ˆè¿™æ˜¯é¦–é€‰æ–¹æ³•ã€‚å¦åˆ™ï¼Œå¿…é¡»ä½¿ç”¨å•ä¸ªClusterRoleBindingã€‚</p><p><a href="https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">traefikå­¦ä¹ </a><br><a href="https://docs.traefik.io/v1.7/user-guide/kubernetes/" target="_blank" rel="noopener">traefikå®˜æ–¹</a></p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>ä¸‹è½½trarfixä»£ç ï¼Œç„¶ååˆ‡æ¢åˆ°v1.7çš„åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/containous/traefik.git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git branch --all</span></span><br><span class="line">* master</span><br><span class="line">  remotes/origin/HEAD -&gt; origin/master</span><br><span class="line">  remotes/origin/add-plugin-support</span><br><span class="line">  remotes/origin/gh-pages</span><br><span class="line">  remotes/origin/master</span><br><span class="line">  remotes/origin/v1.0</span><br><span class="line">  remotes/origin/v1.1</span><br><span class="line">  remotes/origin/v1.2</span><br><span class="line">  remotes/origin/v1.3</span><br><span class="line">  remotes/origin/v1.4</span><br><span class="line">  remotes/origin/v1.5</span><br><span class="line">  remotes/origin/v1.6</span><br><span class="line">  remotes/origin/v1.7</span><br><span class="line">  remotes/origin/v2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># git checkout v1.7</span></span><br><span class="line">Branch <span class="string">'v1.7'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'v1.7'</span> from <span class="string">'origin'</span>.</span><br><span class="line">Switched to a new branch <span class="string">'v1.7'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /root/traefik/examples/k8s</span></span><br></pre></td></tr></table></figure><h3 id="å®‰è£…éƒ¨ç½²"><a href="#å®‰è£…éƒ¨ç½²" class="headerlink" title="å®‰è£…éƒ¨ç½²"></a>å®‰è£…éƒ¨ç½²</h3><h4 id="ä½¿ç”¨ClusterRoleBinding"><a href="#ä½¿ç”¨ClusterRoleBinding" class="headerlink" title="ä½¿ç”¨ClusterRoleBinding"></a>ä½¿ç”¨ClusterRoleBinding</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik-rbac.yaml </span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br></pre></td></tr></table></figure><p>å¯¹äºå‘½åç©ºé—´é™åˆ¶ï¼Œæ¯ä¸ªç›‘è§†å‘½åç©ºé—´éœ€è¦ä¸€ä¸ªRoleBindingä»¥åŠTraefik kubernetes.namespaceså‚æ•°çš„ç›¸åº”é…ç½®ã€‚</p><h4 id="ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet"><a href="#ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet" class="headerlink" title="ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet"></a>ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet</h4><p>å¯ä»¥å°†Traefikä¸Deploymentæˆ–DaemonSetå¯¹è±¡ä¸€èµ·ä½¿ç”¨ï¼Œè€Œè¿™ä¸¤ä¸ªé€‰é¡¹å„æœ‰åˆ©å¼Šï¼š</p><ul><li>ä½¿ç”¨éƒ¨ç½²æ—¶ï¼Œå¯ä¼¸ç¼©æ€§å¯ä»¥æ›´å¥½ï¼Œå› ä¸ºåœ¨ä½¿ç”¨DaemonSetæ—¶æ‚¨å°†æ‹¥æœ‰æ¯ä¸ªèŠ‚ç‚¹çš„Single-Podæ¨¡å‹ï¼Œè€Œåœ¨ä½¿ç”¨éƒ¨ç½²æ—¶ï¼Œå¯èƒ½éœ€è¦æ›´å°‘çš„åŸºäºç¯å¢ƒçš„å‰¯æœ¬ã€‚</li><li>å½“èŠ‚ç‚¹åŠ å…¥ç¾¤é›†æ—¶ï¼ŒDaemonSetä¼šè‡ªåŠ¨æ‰©å±•åˆ°æ–°èŠ‚ç‚¹ï¼Œè€Œéƒ¨ç½²çª—æ ¼ä»…åœ¨éœ€è¦æ—¶åœ¨æ–°èŠ‚ç‚¹ä¸Šè¿›è¡Œè°ƒåº¦ã€‚</li><li>DaemonSetsç¡®ä¿åªæœ‰ä¸€ä¸ªpodå‰¯æœ¬åœ¨ä»»ä½•å•ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚å¦‚æœè¦ç¡®ä¿ä¸¤ä¸ªpodä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œåˆ™éƒ¨ç½²éœ€è¦å…³è”è®¾ç½®</li><li>å¯ä»¥ä½¿ç”¨è¯¥NET_BIND_SERVICEåŠŸèƒ½è¿è¡ŒDaemonSet ï¼Œè¿™å°†å…è®¸å®ƒç»‘å®šåˆ°æ¯ä¸ªä¸»æœºä¸Šçš„ç«¯å£80/443 / etcã€‚è¿™å°†å…è®¸ç»•è¿‡kube-proxyï¼Œå¹¶å‡å°‘æµé‡è·³è·ƒã€‚è¯·æ³¨æ„ï¼Œè¿™è¿åäº†Kubernetesæœ€ä½³å®è·µæŒ‡å—ï¼Œå¹¶æå‡ºäº†è°ƒåº¦/æ‰©å±•é—®é¢˜çš„å¯èƒ½æ€§ã€‚å°½ç®¡å­˜åœ¨æ½œåœ¨é—®é¢˜ï¼Œä½†è¿™ä»ç„¶æ˜¯å¤§å¤šæ•°å…¥å£æ§åˆ¶å™¨çš„é€‰æ‹©ã€‚</li></ul><h4 id="Deploymentséƒ¨ç½²"><a href="#Deploymentséƒ¨ç½²" class="headerlink" title="Deploymentséƒ¨ç½²"></a>Deploymentséƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  apply -f  traefik-deployment.yaml</span></span><br><span class="line">serviceaccount/traefik-ingress-controller created</span><br><span class="line">deployment.extensions/traefik-ingress-controller created</span><br><span class="line">service/traefik-ingress-service created</span><br></pre></td></tr></table></figure><h4 id="DaemonSets-éƒ¨ç½²-å¯é€‰"><a href="#DaemonSets-éƒ¨ç½²-å¯é€‰" class="headerlink" title="DaemonSets éƒ¨ç½²(å¯é€‰)"></a>DaemonSets éƒ¨ç½²(å¯é€‰)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik-ds.yaml</span></span><br></pre></td></tr></table></figure><ul><li>Deploymentså’ŒDaemonSetsä¹‹é—´å­˜åœ¨ä¸€äº›æ˜¾ç€å·®å¼‚:<ul><li>éƒ¨ç½²å…·æœ‰æ›´å®¹æ˜“çš„å‘ä¸Šå’Œå‘ä¸‹æ‰©å±•å¯èƒ½æ€§ã€‚å®ƒå¯ä»¥å®ç°å®Œæ•´çš„podç”Ÿå‘½å‘¨æœŸï¼Œå¹¶æ”¯æŒKubernetes 1.2çš„æ»šåŠ¨æ›´æ–°ã€‚è¿è¡Œéƒ¨ç½²è‡³å°‘éœ€è¦ä¸€ä¸ªPodã€‚</li><li>DaemonSetä¼šè‡ªåŠ¨æ‰©å±•åˆ°æ»¡è¶³ç‰¹å®šé€‰æ‹©å™¨çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶ä¿è¯ä¸€æ¬¡å¡«å……ä¸€ä¸ªèŠ‚ç‚¹ã€‚Kubernetes 1.7ä¹Ÿå®Œå…¨æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œé€‚ç”¨äºDaemonSets</li></ul></li></ul><h3 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h3><ul><li><p>æŸ¥çœ‹pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl --namespace=kube-system get pods</span></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5579b8778b-xw8m9                     1/1     Running   2          3d21h</span><br><span class="line">kubernetes-dashboard-65dfbf6f4f-hcgbb        1/1     Running   0          2d16h</span><br><span class="line">metrics-server-94ff5d4cc-b97l5               1/1     Running   1          3d</span><br><span class="line">tiller-deploy-5cbcf75545-rbzld               1/1     Running   0          17h</span><br><span class="line">traefik-ingress-controller-c595665d6-cm7kh   1/1     Running   0          3m20s</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹services</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services --namespace=kube-system</span></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                       AGE</span><br><span class="line">kube-dns                  ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP        3d21h</span><br><span class="line">kubernetes-dashboard      NodePort    10.254.214.153   &lt;none&gt;        443:32533/TCP                 3d21h</span><br><span class="line">metrics-server            ClusterIP   10.254.61.132    &lt;none&gt;        443/TCP                       3d</span><br><span class="line">tiller-deploy             ClusterIP   10.254.207.227   &lt;none&gt;        44134/TCP                     17h</span><br><span class="line">traefik-ingress-service   NodePort    10.254.246.158   &lt;none&gt;        80:32146/TCP,8080:30455/TCP   3m53s</span><br></pre></td></tr></table></figure></li></ul><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯nodeportæ¨¡å¼è¿›è¡Œéƒ¨ç½²çš„ï¼Œå¯ä»¥çœ‹åˆ°ç«¯å£ä¸º32146ï¼Œè¿™é‡Œè®¿é—®ä¼šè¿”å›<code>404 page not found</code>,é‚£æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ç»™Traefikä»»ä½•é…ç½®ã€‚</p><h3 id="åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik-Web-UIçš„Ingres"><a href="#åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik-Web-UIçš„Ingres" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik Web UIçš„Ingres"></a>åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik Web UIçš„Ingres</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ui.yaml </span></span><br><span class="line">service/traefik-web-ui created</span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨/etc/hosts æ–‡ä»¶è®¾ç½®ä¸€ä¸ªè·¯ç”±æ¡ç›®<code>traefik-ui.minikube</code></p><p>åœ¨æµè§ˆå™¨è¿›è¡Œè®¿é—®å¯ä»¥çœ‹åˆ°Traefik Web UI</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14, traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 metrics-server</title>
    <url>/2019/09/17/k8s-v1-14-metrics-server/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>metrics-serverè¿™é‡Œä¸è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/metrics-serverå®‰è£…å­£/" target="_blank" rel="noopener">metrics-serverå®‰è£…å­£</a></p><h3 id="å®‰è£…metrics-server"><a href="#å®‰è£…metrics-server" class="headerlink" title="å®‰è£…metrics-server"></a>å®‰è£…metrics-server</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œå®‰è£…å’Œä¹‹å‰çš„<strong>metrics-serverå®‰è£…å­£</strong>ç¨å¾®æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œä¹‹å‰é›†ç¾¤å®‰è£…æ²¡æœ‰ä½¿ç”¨httpsè¯ä¹¦ï¼Œåé¢å»å„ç§ç”Ÿæˆçš„è¯ä¹¦å’Œè¸©å‘ï¼Œè¿™é‡Œæ˜¯åœ¨å®‰è£…çš„æ—¶å€™ä¸€å¼€å§‹å°±ä½¿ç”¨äº†httpså…¨è¯ä¹¦,æ‰€æœ‰ç¨å¾®æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œè¿™é‡Œåªåˆ—å‡ºæœ‰åŒºåˆ«çš„åœ°æ–¹ï¼Œå…¶ä»–çš„å®Œå…¨å¯ä»¥å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/metrics-serverå®‰è£…å­£/" target="_blank" rel="noopener">metrics-serverå®‰è£…å­£</a>ï¼Œè¿™é‡Œhttpsè¯ä¹¦<strong>ä¸éœ€è¦</strong>é‡æ–°ç”Ÿæˆï¼›</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®æ–‡ä»¶ä¹Ÿä¸éœ€è¦æ·»åŠ ï¼Œåœ¨v1.14å®‰è£…çš„æ—¶å€™å°±å·²ç»å§é…ç½®æ–‡ä»¶æ·»åŠ è¿›å»äº†ï¼Œæ‰€ä»¥è¿™é‡Œé…ç½®æ–‡ä»¶ä¹Ÿä¸éœ€è¦å¢åŠ </p><h3 id="æ–‡ä»¶çš„ä¿®æ”¹"><a href="#æ–‡ä»¶çš„ä¿®æ”¹" class="headerlink" title="æ–‡ä»¶çš„ä¿®æ”¹"></a>æ–‡ä»¶çš„ä¿®æ”¹</h3><ul><li><p>ä¿®æ”¹ metrics-server-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat metrics-server-deployment.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      hostNetwork: <span class="literal">true</span> è¿™ä¸ªè¿˜æ˜¯éœ€è¦å¢åŠ </span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span><br><span class="line">      - name: tmp-dir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: mirrorgooglecontainers/metrics-server-amd64:v0.3.4</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        args:  <span class="comment"># è¿™é‡Œä¸ä¸€æ ·</span></span><br><span class="line">        - --metric-resolution=30s</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp-dir</span><br><span class="line">          mountPath: /tmp</span><br></pre></td></tr></table></figure></li><li><p>â€“metric-resolution=30sï¼šä» kubelet é‡‡é›†æ•°æ®çš„å‘¨æœŸï¼›</p></li><li><p>â€“kubelet-preferred-address-typesï¼šä¼˜å…ˆä½¿ç”¨ InternalIP æ¥è®¿é—® kubeletï¼Œè¿™æ ·å¯ä»¥é¿å…èŠ‚ç‚¹åç§°æ²¡æœ‰ DNS è§£æè®°å½•æ—¶ï¼Œé€šè¿‡èŠ‚ç‚¹åç§°è°ƒç”¨èŠ‚ç‚¹ kubelet API å¤±è´¥çš„æƒ…å†µï¼ˆæœªé…ç½®æ—¶é»˜è®¤çš„æƒ…å†µï¼‰ï¼›</p></li><li><p><strong>hostNetwork: true:</strong> è¿™ä¸ªä¸å¢åŠ çš„ä¼šæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Error from server (ServiceUnavailable): the server is currently unable to handle the request</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ resource-reader.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat resource-reader.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/stats</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups: <span class="comment"># å¢åŠ </span></span><br><span class="line">  - <span class="string">"extensions"</span></span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹è¿è¡Œæƒ…å†µ"><a href="#æŸ¥çœ‹è¿è¡Œæƒ…å†µ" class="headerlink" title="æŸ¥çœ‹è¿è¡Œæƒ…å†µ"></a>æŸ¥çœ‹è¿è¡Œæƒ…å†µ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods -l k8s-app=metrics-server</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-94ff5d4cc-b97l5   1/1     Running   0          21m</span><br><span class="line"></span><br><span class="line"><span class="comment">#  kubectl get svc -n kube-system  metrics-server</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">metrics-server   ClusterIP   10.254.61.132   &lt;none&gt;        443/TCP   27m</span><br></pre></td></tr></table></figure><h3 id="è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯"><a href="#è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯" class="headerlink" title="è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯"></a>è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get apiservice</span></span><br><span class="line">NAME                                   SERVICE                      AVAILABLE   AGE</span><br><span class="line">v1.                                    Local                        True        23h</span><br><span class="line">v1.apps                                Local                        True        23h</span><br><span class="line">v1.authentication.k8s.io               Local                        True        23h</span><br><span class="line">v1.authorization.k8s.io                Local                        True        23h</span><br><span class="line">v1.autoscaling                         Local                        True        23h</span><br><span class="line">v1.batch                               Local                        True        23h</span><br><span class="line">v1.coordination.k8s.io                 Local                        True        23h</span><br><span class="line">v1.networking.k8s.io                   Local                        True        23h</span><br><span class="line">v1.rbac.authorization.k8s.io           Local                        True        23h</span><br><span class="line">v1.scheduling.k8s.io                   Local                        True        23h</span><br><span class="line">v1.storage.k8s.io                      Local                        True        23h</span><br><span class="line">v1alpha1.auditregistration.k8s.io      Local                        True        23h</span><br><span class="line">v1alpha1.node.k8s.io                   Local                        True        23h</span><br><span class="line">v1alpha1.rbac.authorization.k8s.io     Local                        True        23h</span><br><span class="line">v1alpha1.scheduling.k8s.io             Local                        True        23h</span><br><span class="line">v1alpha1.settings.k8s.io               Local                        True        23h</span><br><span class="line">v1alpha1.storage.k8s.io                Local                        True        23h</span><br><span class="line">v1beta1.admissionregistration.k8s.io   Local                        True        23h</span><br><span class="line">v1beta1.apiextensions.k8s.io           Local                        True        23h</span><br><span class="line">v1beta1.apps                           Local                        True        23h</span><br><span class="line">v1beta1.authentication.k8s.io          Local                        True        23h</span><br><span class="line">v1beta1.authorization.k8s.io           Local                        True        23h</span><br><span class="line">v1beta1.batch                          Local                        True        23h</span><br><span class="line">v1beta1.certificates.k8s.io            Local                        True        23h</span><br><span class="line">v1beta1.coordination.k8s.io            Local                        True        23h</span><br><span class="line">v1beta1.events.k8s.io                  Local                        True        23h</span><br><span class="line">v1beta1.extensions                     Local                        True        23h</span><br><span class="line">v1beta1.metrics.k8s.io                 kube-system/metrics-server   True        27m</span><br><span class="line">v1beta1.networking.k8s.io              Local                        True        23h</span><br><span class="line">v1beta1.node.k8s.io                    Local                        True        23h</span><br><span class="line">v1beta1.policy                         Local                        True        23h</span><br><span class="line">v1beta1.rbac.authorization.k8s.io      Local                        True        23h</span><br><span class="line">v1beta1.scheduling.k8s.io              Local                        True        23h</span><br><span class="line">v1beta1.storage.k8s.io                 Local                        True        23h</span><br><span class="line">v1beta2.apps                           Local                        True        23h</span><br><span class="line">v2alpha1.batch                         Local                        True        23h</span><br><span class="line">v2beta1.autoscaling                    Local                        True        23h</span><br><span class="line">v2beta2.autoscaling                    Local                        True        23h</span><br></pre></td></tr></table></figure><h3 id="metrics-server-çš„å‘½ä»¤è¡Œå‚æ•°"><a href="#metrics-server-çš„å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="metrics-server çš„å‘½ä»¤è¡Œå‚æ•°"></a>metrics-server çš„å‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec --namespace kube-system -it metrics-server-94ff5d4cc-b97l5 -- /metrics-server --help</span></span><br><span class="line">Launch metrics-server</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">   [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --alsologtostderr                                         <span class="built_in">log</span> to standard error as well as files</span><br><span class="line">      --authentication-kubeconfig string                        kubeconfig file pointing at the <span class="string">'core'</span> kubernetes server with enough rights to create tokenaccessreviews.authentication.k8s.io.</span><br><span class="line">      --authentication-skip-lookup                              If <span class="literal">false</span>, the authentication-kubeconfig will be used to lookup missing authentication configuration from the cluster.</span><br><span class="line">      --authentication-token-webhook-cache-ttl duration         The duration to cache responses from the webhook token authenticator. (default 10s)</span><br><span class="line">      --authentication-tolerate-lookup-failure                  If <span class="literal">true</span>, failures to look up missing authentication configuration from the cluster are not considered fatal. Note that this can result <span class="keyword">in</span> authentication that treats all requests as anonymous.</span><br><span class="line">      --authorization-always-allow-paths strings                A list of HTTP paths to skip during authorization, i.e. these are authorized without contacting the <span class="string">'core'</span> kubernetes server.</span><br><span class="line">      --authorization-kubeconfig string                         kubeconfig file pointing at the <span class="string">'core'</span> kubernetes server with enough rights to create subjectaccessreviews.authorization.k8s.io.</span><br><span class="line">      --authorization-webhook-cache-authorized-ttl duration     The duration to cache <span class="string">'authorized'</span> responses from the webhook authorizer. (default 10s)</span><br><span class="line">      --authorization-webhook-cache-unauthorized-ttl duration   The duration to cache <span class="string">'unauthorized'</span> responses from the webhook authorizer. (default 10s)</span><br><span class="line">      --<span class="built_in">bind</span>-address ip                                         The IP address on <span class="built_in">which</span> to listen <span class="keyword">for</span> the --secure-port port. The associated interface(s) must be reachable by the rest of the cluster, and by CLI/web clients. If blank, all interfaces will be used (0.0.0.0 <span class="keyword">for</span> all IPv4 interfaces and :: <span class="keyword">for</span> all IPv6 interfaces). (default 0.0.0.0)</span><br><span class="line">      --cert-dir string                                         The directory <span class="built_in">where</span> the TLS certs are located. If --tls-cert-file and --tls-private-key-file are provided, this flag will be ignored. (default <span class="string">"apiserver.local.config/certificates"</span>)</span><br><span class="line">      --client-ca-file string                                   If <span class="built_in">set</span>, any request presenting a client certificate signed by one of the authorities <span class="keyword">in</span> the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.</span><br><span class="line">      --contention-profiling                                    Enable lock contention profiling, <span class="keyword">if</span> profiling is enabled</span><br><span class="line">  -h, --<span class="built_in">help</span>                                                    <span class="built_in">help</span> <span class="keyword">for</span> this <span class="built_in">command</span></span><br><span class="line">      --http2-max-streams-per-connection int                    The <span class="built_in">limit</span> that the server gives to clients <span class="keyword">for</span> the maximum number of streams <span class="keyword">in</span> an HTTP/2 connection. Zero means to use golang<span class="string">'s default.</span></span><br><span class="line"><span class="string">      --kubeconfig string                                       The path to the kubeconfig used to connect to the Kubernetes API server and the Kubelets (defaults to in-cluster config)</span></span><br><span class="line"><span class="string">      --kubelet-certificate-authority string                    Path to the CA to use to validate the Kubelet'</span>s serving certificates.</span><br><span class="line">      --kubelet-insecure-tls                                    Do not verify CA of serving certificates presented by Kubelets.  For testing purposes only.</span><br><span class="line">      --kubelet-port int                                        The port to use to connect to Kubelets. (default 10250)</span><br><span class="line">      --kubelet-preferred-address-types strings                 The priority of node address types to use when determining <span class="built_in">which</span> address to use to connect to a particular node (default [Hostname,InternalDNS,InternalIP,ExternalDNS,ExternalIP])</span><br><span class="line">      --<span class="built_in">log</span>-flush-frequency duration                            Maximum number of seconds between <span class="built_in">log</span> flushes (default 5s)</span><br><span class="line">      --log_backtrace_at traceLocation                          when logging hits line file:N, emit a stack trace (default :0)</span><br><span class="line">      --log_dir string                                          If non-empty, write <span class="built_in">log</span> files <span class="keyword">in</span> this directory</span><br><span class="line">      --log_file string                                         If non-empty, use this <span class="built_in">log</span> file</span><br><span class="line">      --logtostderr                                             <span class="built_in">log</span> to standard error instead of files (default <span class="literal">true</span>)</span><br><span class="line">      --metric-resolution duration                              The resolution at <span class="built_in">which</span> metrics-server will retain metrics. (default 1m0s)</span><br><span class="line">      --profiling                                               Enable profiling via web interface host:port/debug/pprof/ (default <span class="literal">true</span>)</span><br><span class="line">      --requestheader-allowed-names strings                     List of client certificate common names to allow to provide usernames <span class="keyword">in</span> headers specified by --requestheader-username-headers. If empty, any client certificate validated by the authorities <span class="keyword">in</span> --requestheader-client-ca-file is allowed.</span><br><span class="line">      --requestheader-client-ca-file string                     Root certificate bundle to use to verify client certificates on incoming requests before trusting usernames <span class="keyword">in</span> headers specified by --requestheader-username-headers. WARNING: generally <span class="keyword">do</span> not depend on authorization being already <span class="keyword">done</span> <span class="keyword">for</span> incoming requests.</span><br><span class="line">      --requestheader-extra-headers-prefix strings              List of request header prefixes to inspect. X-Remote-Extra- is suggested. (default [x-remote-extra-])</span><br><span class="line">      --requestheader-group-headers strings                     List of request headers to inspect <span class="keyword">for</span> groups. X-Remote-Group is suggested. (default [x-remote-group])</span><br><span class="line">      --requestheader-username-headers strings                  List of request headers to inspect <span class="keyword">for</span> usernames. X-Remote-User is common. (default [x-remote-user])</span><br><span class="line">      --secure-port int                                         The port on <span class="built_in">which</span> to serve HTTPS with authentication and authorization.If 0, don<span class="string">'t serve HTTPS at all. (default 443)</span></span><br><span class="line"><span class="string">      --skip_headers                                            If true, avoid header prefixes in the log messages</span></span><br><span class="line"><span class="string">      --stderrthreshold severity                                logs at or above this threshold go to stderr</span></span><br><span class="line"><span class="string">      --tls-cert-file string                                    File containing the default x509 Certificate for HTTPS. (CA cert, if any, concatenated after server cert). If HTTPS serving is enabled, and --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to the directory specified by --cert-dir.</span></span><br><span class="line"><span class="string">      --tls-cipher-suites strings                               Comma-separated list of cipher suites for the server. If omitted, the default Go cipher suites will be use.  Possible values: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_RC4_128_SHA,TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_RC4_128_SHA,TLS_RSA_WITH_3DES_EDE_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA256,TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_RC4_128_SHA</span></span><br><span class="line"><span class="string">      --tls-min-version string                                  Minimum TLS version supported. Possible values: VersionTLS10, VersionTLS11, VersionTLS12</span></span><br><span class="line"><span class="string">      --tls-private-key-file string                             File containing the default x509 private key matching --tls-cert-file.</span></span><br><span class="line"><span class="string">      --tls-sni-cert-key namedCertKey                           A pair of x509 certificate and private key file paths, optionally suffixed with a list of domain patterns which are fully qualified domain names, possibly with prefixed wildcard segments. If no domain patterns are provided, the names of the certificate are extracted. Non-wildcard matches trump over wildcard matches, explicit domain patterns trump over extracted names. For multiple key/certificate pairs, use the --tls-sni-cert-key multiple times. Examples: "example.crt,example.key" or "foo.crt,foo.key:*.foo.com,foo.com". (default [])</span></span><br><span class="line"><span class="string">  -v, --v Level                                                 number for the log level verbosity</span></span><br><span class="line"><span class="string">      --vmodule moduleSpec                                      comma-separated list of pattern=N settings for file-filtered logging</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>metrics-server</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 dashboard</title>
    <url>/2019/09/16/k8s-v1-14-dashboard/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>kuberntes è‡ªå¸¦æ’ä»¶çš„ manifests yaml æ–‡ä»¶ä½¿ç”¨ gcr.io çš„ docker registryï¼Œå›½å†…è¢«å¢™ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä¸ºå…¶å®ƒ registry åœ°å€</p><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-src.tar.gz</span></span><br></pre></td></tr></table></figure><p>dashboard å¯¹åº”çš„ç›®å½•æ˜¯ï¼šcluster/addons/dashboardï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd cluster/addons/dashboard</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ service å®šä¹‰ï¼ŒæŒ‡å®šç«¯å£ç±»å‹ä¸º NodePortï¼Œè¿™æ ·å¤–ç•Œå¯ä»¥é€šè¿‡åœ°å€ NodeIP:NodePort è®¿é—® dashboardï¼›</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat dashboard-service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort <span class="comment"># å¢åŠ è¿™ä¸€è¡Œ</span></span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat dashboard-controller.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'docker/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: docker.io/xxlaila/kubernetes-dashboard-amd64:v1.10.0  <span class="comment">#ä¿®æ”¹è¿™ä¸€è¡Œ</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶"><a href="#æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶" class="headerlink" title="æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶"></a>æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls *.yaml</span></span><br><span class="line">dashboard-configmap.yaml  dashboard-controller.yaml  dashboard-rbac.yaml  dashboard-secret.yaml  dashboard-service.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f  .</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹åˆ†é…çš„-NodePort"><a href="#æŸ¥çœ‹åˆ†é…çš„-NodePort" class="headerlink" title="æŸ¥çœ‹åˆ†é…çš„ NodePort"></a>æŸ¥çœ‹åˆ†é…çš„ NodePort</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get deployment kubernetes-dashboard  -n kube-system</span></span><br><span class="line">NAME                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kubernetes-dashboard   1/1     1            1           5h10m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl --namespace kube-system get pods -o wide</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP             NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-5579b8778b-xw8m9                1/1     Running   1          5h15m   172.30.232.3   172.21.16.204   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-6cc78dfc99-hb4l5   1/1     Running   0          5h10m   172.30.176.3   172.21.16.240   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get services kubernetes-dashboard -n kube-system</span></span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.254.214.153   &lt;none&gt;        443:32533/TCP   5h10m</span><br></pre></td></tr></table></figure><ul><li>NodePort 32533 æ˜ å°„åˆ° dashboard pod 443 ç«¯å£ï¼›</li></ul><h3 id="æŸ¥çœ‹-dashboard-æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°"><a href="#æŸ¥çœ‹-dashboard-æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="æŸ¥çœ‹ dashboard æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°"></a>æŸ¥çœ‹ dashboard æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec --namespace kube-system -it kubernetes-dashboard-6cc78dfc99-hb4l5  -- /dashboard --help</span></span><br><span class="line">2019/09/16 09:51:33 Starting overwatch</span><br><span class="line">Usage of /dashboard:</span><br><span class="line">      --alsologtostderr                  <span class="built_in">log</span> to standard error as well as files</span><br><span class="line">      --api-log-level string             Level of API request logging. Should be one of <span class="string">'INFO|NONE|DEBUG'</span>. Default: <span class="string">'INFO'</span>. (default <span class="string">"INFO"</span>)</span><br><span class="line">      --apiserver-host string            The address of the Kubernetes Apiserver to connect to <span class="keyword">in</span> the format of protocol://address:port, e.g., http://localhost:8080. If not specified, the assumption is that the binary runs inside a Kubernetes cluster and <span class="built_in">local</span> discovery is attempted.</span><br><span class="line">      --authentication-mode strings      Enables authentication options that will be reflected on login screen. Supported values: token, basic. Default: token.Note that basic option should only be used <span class="keyword">if</span> apiserver has <span class="string">'--authorization-mode=ABAC'</span> and <span class="string">'--basic-auth-file'</span> flags <span class="built_in">set</span>. (default [token])</span><br><span class="line">      --auto-generate-certificates       When <span class="built_in">set</span> to <span class="literal">true</span>, Dashboard will automatically generate certificates used to serve HTTPS. Default: <span class="literal">false</span>.</span><br><span class="line">      --<span class="built_in">bind</span>-address ip                  The IP address on <span class="built_in">which</span> to serve the --secure-port (<span class="built_in">set</span> to 0.0.0.0 <span class="keyword">for</span> all interfaces). (default 0.0.0.0)</span><br><span class="line">      --default-cert-dir string          Directory path containing <span class="string">'--tls-cert-file'</span> and <span class="string">'--tls-key-file'</span> files. Used also when auto-generating certificates flag is <span class="built_in">set</span>. (default <span class="string">"/certs"</span>)</span><br><span class="line">      --<span class="built_in">disable</span>-settings-authorizer      When enabled, Dashboard settings page will not require user to be logged <span class="keyword">in</span> and authorized to access settings page.</span><br><span class="line">      --<span class="built_in">disable</span>-skip                     When enabled, the skip button on the login page will not be shown. Default: <span class="literal">false</span>.</span><br><span class="line">      --<span class="built_in">enable</span>-insecure-login            When enabled, Dashboard login view will also be shown when Dashboard is not served over HTTPS. Default: <span class="literal">false</span>.</span><br><span class="line">      --heapster-host string             The address of the Heapster Apiserver to connect to <span class="keyword">in</span> the format of protocol://address:port, e.g., http://localhost:8082. If not specified, the assumption is that the binary runs inside a Kubernetes cluster and service proxy will be used.</span><br><span class="line">      --insecure-bind-address ip         The IP address on <span class="built_in">which</span> to serve the --port (<span class="built_in">set</span> to 0.0.0.0 <span class="keyword">for</span> all interfaces). (default 127.0.0.1)</span><br><span class="line">      --insecure-port int                The port to listen to <span class="keyword">for</span> incoming HTTP requests. (default 9090)</span><br><span class="line">      --kubeconfig string                Path to kubeconfig file with authorization and master location information.</span><br><span class="line">      --log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace (default :0)</span><br><span class="line">      --log_dir string                   If non-empty, write <span class="built_in">log</span> files <span class="keyword">in</span> this directory</span><br><span class="line">      --logtostderr                      <span class="built_in">log</span> to standard error instead of files</span><br><span class="line">      --metric-client-check-period int   Time <span class="keyword">in</span> seconds that defines how often configured metric client health check should be run. Default: 30 seconds. (default 30)</span><br><span class="line">      --port int                         The secure port to listen to <span class="keyword">for</span> incoming HTTPS requests. (default 8443)</span><br><span class="line">      --stderrthreshold severity         logs at or above this threshold go to stderr (default 2)</span><br><span class="line">      --system-banner string             When non-empty displays message to Dashboard users. Accepts simple HTML tags. Default: <span class="string">''</span>.</span><br><span class="line">      --system-banner-severity string    Severity of system banner. Should be one of <span class="string">'INFO|WARNING|ERROR'</span>. Default: <span class="string">'INFO'</span>. (default <span class="string">"INFO"</span>)</span><br><span class="line">      --tls-cert-file string             File containing the default x509 Certificate <span class="keyword">for</span> HTTPS.</span><br><span class="line">      --tls-key-file string              File containing the default x509 private key matching --tls-cert-file.</span><br><span class="line">      --token-ttl int                    Expiration time (<span class="keyword">in</span> seconds) of JWE tokens generated by dashboard. Default: 15 min. 0 - never expires (default 900)</span><br><span class="line">  -v, --v Level                          <span class="built_in">log</span> level <span class="keyword">for</span> V logs</span><br><span class="line">      --vmodule moduleSpec               comma-separated list of pattern=N settings <span class="keyword">for</span> file-filtered logging</span><br><span class="line">pflag: <span class="built_in">help</span> requested</span><br><span class="line"><span class="built_in">command</span> terminated with <span class="built_in">exit</span> code 2</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashboard çš„ â€“authentication-mode æ”¯æŒ tokenã€basicï¼Œé»˜è®¤ä¸º tokenã€‚å¦‚æœä½¿ç”¨ basicï¼Œåˆ™ kube-apiserver å¿…é¡»é…ç½® â€“authorization-mode=ABAC å’Œ â€“basic-auth-file å‚æ•°</p><h3 id="è®¿é—®-dashboard"><a href="#è®¿é—®-dashboard" class="headerlink" title="è®¿é—® dashboard"></a>è®¿é—® dashboard</h3><p>ä½¿ç”¨httpsåè®®ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ä»»æ„nodeçš„ipåŠ ç«¯å£å³å¯è®¿é—®<br><img src="https://img.xxlaila.cn/1568961339763.jpg" alt="img"></p><h3 id="åˆ›å»ºç™»å½•-Dashboard-çš„-token-å’Œ-kubeconfig-é…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºç™»å½•-Dashboard-çš„-token-å’Œ-kubeconfig-é…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºç™»å½• Dashboard çš„ token å’Œ kubeconfig é…ç½®æ–‡ä»¶"></a>åˆ›å»ºç™»å½• Dashboard çš„ token å’Œ kubeconfig é…ç½®æ–‡ä»¶</h3><p>dashboard é»˜è®¤åªæ”¯æŒ token è®¤è¯ï¼ˆä¸æ”¯æŒ client è¯ä¹¦è®¤è¯ï¼‰ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨ Kubeconfig æ–‡ä»¶ï¼Œéœ€è¦å°† token å†™å…¥åˆ°è¯¥æ–‡ä»¶ã€‚</p><h4 id="åˆ›å»ºç™»å½•-token"><a href="#åˆ›å»ºç™»å½•-token" class="headerlink" title="åˆ›å»ºç™»å½• token"></a>åˆ›å»ºç™»å½• token</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create sa dashboard-admin -n kube-system</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span></span><br><span class="line"><span class="comment"># ADMIN_SECRET=$(kubectl get secrets -n kube-system | grep dashboard-admin | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># DASHBOARD_LOGIN_TOKEN=$(kubectl describe secret -n kube-system $&#123;ADMIN_SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;DASHBOARD_LOGIN_TOKEN&#125;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¾“å‡ºçš„ token ç™»å½• Dashboardã€‚</p><h3 id="åˆ›å»ºä½¿ç”¨-token-çš„-KubeConfig-æ–‡ä»¶"><a href="#åˆ›å»ºä½¿ç”¨-token-çš„-KubeConfig-æ–‡ä»¶" class="headerlink" title="åˆ›å»ºä½¿ç”¨ token çš„ KubeConfig æ–‡ä»¶"></a>åˆ›å»ºä½¿ç”¨ token çš„ KubeConfig æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°ï¼Œä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ Token</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials dashboard_user \</span><br><span class="line">  --token=<span class="variable">$&#123;DASHBOARD_LOGIN_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=dashboard_user \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context default --kubeconfig=dashboard.kubeconfig</span><br></pre></td></tr></table></figure><p>å¦‚å›¾:<br><img src="https://img.xxlaila.cn/1568961447890.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨ç”Ÿæˆçš„ dashboard.kubeconfig ç™»å½• Dashboardã€‚ç”±äºk8s é»˜è®¤çš„Dashboard 15åˆ†é’Ÿåå°±ä¼šå¼¹å‡ºï¼Œåˆè¦é‡æ–°ç™»å½•å’Œè·å–tokenéº»çƒ¦ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://xxlaila.github.io/2019/08/29/k8sé…ç½®Dashboard/" target="_blank" rel="noopener">k8sé…ç½®Dashboard</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 dnsæ’ä»¶</title>
    <url>/2019/09/16/k8s-v1-14-dns%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="éƒ¨ç½²-coredns-æ’ä»¶"><a href="#éƒ¨ç½²-coredns-æ’ä»¶" class="headerlink" title="éƒ¨ç½² coredns æ’ä»¶"></a>éƒ¨ç½² coredns æ’ä»¶</h3><p><strong>æ³¨æ„:</strong></p><ul><li>kuberntes è‡ªå¸¦æ’ä»¶çš„ manifests yaml æ–‡ä»¶ä½¿ç”¨ gcr.io çš„ docker registryï¼Œå›½å†…è¢«å¢™ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä¸ºå…¶å®ƒ registry åœ°å€;</li></ul><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-src.tar.gz</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li>coredns ç›®å½•æ˜¯ cluster/addons/dns<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd cluster/addons/dns/coredns</span></span><br><span class="line"><span class="comment"># cp coredns.yaml.base coredns.yaml</span></span><br><span class="line"><span class="comment"># sed -i -e "s/__PILLAR__DNS__DOMAIN__/cluster.local/" -e "s/__PILLAR__DNS__SERVER__/10.254.0.2/" coredns.yaml</span></span><br><span class="line"><span class="comment"># sed -i "s/k8s.gcr.io/coredns/" coredns.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f coredns.yaml</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="æ£€æŸ¥-coredns-åŠŸèƒ½"><a href="#æ£€æŸ¥-coredns-åŠŸèƒ½" class="headerlink" title="æ£€æŸ¥ coredns åŠŸèƒ½"></a>æ£€æŸ¥ coredns åŠŸèƒ½</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get all -n kube-system</span></span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-5579b8778b-xw8m9                1/1     Running   1          5h7m</span><br><span class="line"></span><br><span class="line">NAME                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/kube-dns               ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   5h7m</span><br><span class="line"></span><br><span class="line">NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/coredns                1/1     1            1           5h7m</span><br><span class="line"></span><br><span class="line">NAME                                              DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/coredns-5579b8778b                1         1         1       5h7m</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-9fb46   1/1     Running   0          5h14m</span><br><span class="line">nginx-ds-bgfzt   1/1     Running   0          5h14m</span><br><span class="line">nginx-ds-t22wj   1/1     Running   0          5h14m</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -it exec nginx-ds-9fb46 bash</span></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># cat /etc/resolv.conf</span></span><br><span class="line">nameserver 10.254.0.2</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local openstacklocal novalocal</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping www.baidu.com</span></span><br><span class="line">PING www.wshifen.com (104.193.88.77): 48 data bytes</span><br><span class="line">56 bytes from 104.193.88.77: icmp_seq=0 ttl=45 time=191.953 ms</span><br><span class="line">56 bytes from 104.193.88.77: icmp_seq=1 ttl=45 time=191.680 ms</span><br><span class="line">^C--- www.wshifen.com ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 191.680/191.817/191.953/0.137 ms</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.120 ms</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=1 ttl=64 time=0.116 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.116/0.118/0.120/0.000 ms</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.079 ms</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=1 ttl=64 time=0.152 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.079/0.115/0.152/0.037 ms</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc.cluster.local.</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.080 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.080/0.080/0.080/0.000 ms</span><br><span class="line">`</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14 coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14é›†ç¾¤éªŒè¯</title>
    <url>/2019/09/16/k8s-v1-14%E9%9B%86%E7%BE%A4%E9%AA%8C%E8%AF%81/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="éªŒè¯é›†ç¾¤åŠŸèƒ½"><a href="#éªŒè¯é›†ç¾¤åŠŸèƒ½" class="headerlink" title="éªŒè¯é›†ç¾¤åŠŸèƒ½"></a>éªŒè¯é›†ç¾¤åŠŸèƒ½</h3><h3 id="æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€"><a href="#æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€"></a>æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   5h50m   v1.14.6</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   5h48m   v1.14.6</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   5h45m   v1.14.6</span><br></pre></td></tr></table></figure><p>éƒ½ä¸º Ready æ—¶æ­£å¸¸ã€‚</p><a id="more"></a><h3 id="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"><a href="#åˆ›å»ºæµ‹è¯•æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"></a>åˆ›å»ºæµ‹è¯•æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat nginx-ds.yml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f nginx-ds.yml</span></span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥å„èŠ‚ç‚¹çš„-Pod-IP-è¿é€šæ€§"><a href="#æ£€æŸ¥å„èŠ‚ç‚¹çš„-Pod-IP-è¿é€šæ€§" class="headerlink" title="æ£€æŸ¥å„èŠ‚ç‚¹çš„ Pod IP è¿é€šæ€§"></a>æ£€æŸ¥å„èŠ‚ç‚¹çš„ Pod IP è¿é€šæ€§</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods  -o wide|grep nginx-ds</span></span><br><span class="line">nginx-ds-9fb46   1/1     Running   0          5h2m   172.30.232.2   172.21.16.204   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-bgfzt   1/1     Running   0          5h2m   172.30.128.2   172.21.16.87    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-t22wj   1/1     Running   0          5h2m   172.30.176.2   172.21.16.240   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥æœåŠ¡-IP-å’Œç«¯å£å¯è¾¾æ€§"><a href="#æ£€æŸ¥æœåŠ¡-IP-å’Œç«¯å£å¯è¾¾æ€§" class="headerlink" title="æ£€æŸ¥æœåŠ¡ IP å’Œç«¯å£å¯è¾¾æ€§"></a>æ£€æŸ¥æœåŠ¡ IP å’Œç«¯å£å¯è¾¾æ€§</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc |grep nginx-ds</span></span><br><span class="line">nginx-ds     NodePort    10.254.232.104   &lt;none&gt;        80:30349/TCP   5h2m</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨åœ¨30349è¿›è¡Œè®¿é—®å¯ä»¥çœ‹åˆ°neinxçš„æ¬¢è¿ç•Œé¢</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-v1.14 nodeå®‰è£…</title>
    <url>/2019/09/16/kubernetes-v1-14-node%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="1ã€å®‰è£…docker"><a href="#1ã€å®‰è£…docker" class="headerlink" title="1ã€å®‰è£…docker"></a>1ã€å®‰è£…docker</h3><h4 id="1-1ã€å¢åŠ docker-æº"><a href="#1-1ã€å¢åŠ docker-æº" class="headerlink" title="1.1ã€å¢åŠ docker æº"></a>1.1ã€å¢åŠ docker æº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">  --add-repo \</span><br><span class="line">  https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h4 id="1-2ã€å®‰è£…docker"><a href="#1-2ã€å®‰è£…docker" class="headerlink" title="1.2ã€å®‰è£…docker"></a>1.2ã€å®‰è£…docker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  yum -y install docker-ce</span></span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-3ã€ä¿®æ”¹docker-systemd-unit-æ–‡ä»¶"><a href="#1-3ã€ä¿®æ”¹docker-systemd-unit-æ–‡ä»¶" class="headerlink" title="1.3ã€ä¿®æ”¹docker systemd unit æ–‡ä»¶"></a>1.3ã€ä¿®æ”¹docker systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/docker.service |egrep -Ev "^$|^#"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">BindsTo=containerd.service</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/run/flannel/docker</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>dockerd è¿è¡Œæ—¶ä¼šè°ƒç”¨å…¶å®ƒ docker å‘½ä»¤ï¼Œå¦‚ docker-proxyï¼Œæ‰€ä»¥éœ€è¦å°† docker å‘½ä»¤æ‰€åœ¨çš„ç›®å½•åŠ åˆ° PATH ç¯å¢ƒå˜é‡ä¸­ï¼›</li><li>flanneld å¯åŠ¨æ—¶å°†ç½‘ç»œé…ç½®å†™å…¥ /run/flannel/docker æ–‡ä»¶ä¸­ï¼Œdockerd å¯åŠ¨å‰è¯»å–è¯¥æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡ DOCKER_NETWORK_OPTIONS ï¼Œç„¶åè®¾ç½® docker0 ç½‘æ¡¥ç½‘æ®µï¼›</li><li>å¦‚æœæŒ‡å®šäº†å¤šä¸ª EnvironmentFile é€‰é¡¹ï¼Œåˆ™å¿…é¡»å°† /run/flannel/docker æ”¾åœ¨æœ€å(ç¡®ä¿ docker0 ä½¿ç”¨ flanneld ç”Ÿæˆçš„ bip å‚æ•°)ï¼›</li><li>docker éœ€è¦ä»¥ root ç”¨äºè¿è¡Œï¼›</li></ul><h4 id="1-4ã€å¯åŠ¨-docker-æœåŠ¡"><a href="#1-4ã€å¯åŠ¨-docker-æœåŠ¡" class="headerlink" title="1.4ã€å¯åŠ¨ docker æœåŠ¡"></a>1.4ã€å¯åŠ¨ docker æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable docker &amp;&amp; systemctl restart docker &amp;&amp; systemctl status docker</span></span><br></pre></td></tr></table></figure><h4 id="1-5ã€æ£€æŸ¥-docker0-ç½‘æ¡¥"><a href="#1-5ã€æ£€æŸ¥-docker0-ç½‘æ¡¥" class="headerlink" title="1.5ã€æ£€æŸ¥ docker0 ç½‘æ¡¥"></a>1.5ã€æ£€æŸ¥ docker0 ç½‘æ¡¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/sbin/ip addr show flannel.1 &amp;&amp; /usr/sbin/ip addr show docker0</span></span><br><span class="line">3: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether 8a:be:12:b9:ab:b8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.128.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:eb:ec:ae:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.128.1/21 brd 172.30.135.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h4 id="1-5ã€æŸ¥çœ‹-docker-çš„çŠ¶æ€ä¿¡æ¯"><a href="#1-5ã€æŸ¥çœ‹-docker-çš„çŠ¶æ€ä¿¡æ¯" class="headerlink" title="1.5ã€æŸ¥çœ‹ docker çš„çŠ¶æ€ä¿¡æ¯"></a>1.5ã€æŸ¥çœ‹ docker çš„çŠ¶æ€ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ps -elfH|grep docker</span></span><br><span class="line">0 S root      1436   975  0  80   0 - 28167 -      10:54 pts/0    00:00:00                 grep --color=auto docker</span><br><span class="line">4 S root      1265     1  1  80   0 - 122095 futex_ 10:54 ?       00:00:00   /usr/bin/dockerd --bip=172.30.112.1/21 --ip-masq=<span class="literal">false</span> --mtu=1450</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker info</span></span><br><span class="line">vClient:</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 0</span><br><span class="line">  Running: 0</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 0</span><br><span class="line"> Images: 0</span><br><span class="line"> Server Version: 18.09.6</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: xfs</span><br><span class="line">  Supports d_type: <span class="literal">true</span></span><br><span class="line">  Native Overlay Diff: <span class="literal">true</span></span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: <span class="built_in">local</span></span><br><span class="line">  Network: bridge host macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk syslog</span><br><span class="line"> Swarm: inactive</span><br><span class="line"> Runtimes: runc</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version: 894b81a4b802e4eb2a91d1ce216b8817763c29fb</span><br><span class="line"> runc version: 425e105d5a03fabd737a126ad93d62a9eeede87f</span><br><span class="line"> init version: fec3683</span><br><span class="line"> Security Options:</span><br><span class="line">  seccomp</span><br><span class="line">   Profile: default</span><br><span class="line"> Kernel Version: 4.4.193-1.el7.elrepo.x86_64</span><br><span class="line"> Operating System: CentOS Linux 7 (Core)</span><br><span class="line"> OSType: linux</span><br><span class="line"> Architecture: x86_64</span><br><span class="line"> CPUs: 4</span><br><span class="line"> Total Memory: 7.796GiB</span><br><span class="line"> Name: k8s-node-2.kxl</span><br><span class="line"> ID: GJEA:U6PT:NMHM:KWD2:DOIJ:U6XW:6N3U:4QZN:F5PT:CQXH:MZKU:VATL</span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Registry: https://index.docker.io/v1/</span><br><span class="line"> Labels:</span><br><span class="line"> Experimental: <span class="literal">false</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Live Restore Enabled: <span class="literal">false</span></span><br><span class="line"> Product License: Community Engine</span><br></pre></td></tr></table></figure><h3 id="2ã€éƒ¨ç½²-kubelet-ç»„ä»¶"><a href="#2ã€éƒ¨ç½²-kubelet-ç»„ä»¶" class="headerlink" title="2ã€éƒ¨ç½² kubelet ç»„ä»¶"></a>2ã€éƒ¨ç½² kubelet ç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet è¿è¡Œåœ¨æ¯ä¸ª worker èŠ‚ç‚¹ä¸Šï¼Œæ¥æ”¶ kube-apiserver å‘é€çš„è¯·æ±‚ï¼Œç®¡ç† Pod å®¹å™¨ï¼Œæ‰§è¡Œäº¤äº’å¼å‘½ä»¤ï¼Œå¦‚ execã€runã€logs ç­‰ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨æ—¶è‡ªåŠ¨å‘ kube-apiserver æ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œå†…ç½®çš„ cadvisor ç»Ÿè®¡å’Œç›‘æ§èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºç¡®ä¿å®‰å…¨ï¼Œéƒ¨ç½²æ—¶å…³é—­äº† kubelet çš„éå®‰å…¨ http ç«¯å£ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒï¼Œæ‹’ç»æœªæˆæƒçš„è®¿é—®(å¦‚ apiserverã€heapster çš„è¯·æ±‚)ã€‚</p><h4 id="2-1ã€åˆ›å»º-kubelet-bootstrap-kubeconfig-æ–‡ä»¶"><a href="#2-1ã€åˆ›å»º-kubelet-bootstrap-kubeconfig-æ–‡ä»¶" class="headerlink" title="2.1ã€åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶"></a>2.1ã€åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶</h4><p>NODE_NAMES é‡Œé¢çš„å€¼æ˜¯nodeçš„ä¸»æœºå</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># NODE_NAMES=(node-01 node-02 node-03)</span></span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»º token</span></span><br><span class="line">    <span class="built_in">export</span> BOOTSTRAP_TOKEN=$(kubeadm token create \</span><br><span class="line">      --description kubelet-bootstrap-token \</span><br><span class="line">      --groups system:bootstrappers:<span class="variable">$&#123;node_name&#125;</span> \</span><br><span class="line">      --kubeconfig ~/.kube/config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">      --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">      --embed-certs=<span class="literal">true</span> \</span><br><span class="line">      --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</span><br><span class="line">      --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">      --cluster=kubernetes \</span><br><span class="line">      --user=kubelet-bootstrap \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">    kubectl config use-context default --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for node_name in $&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">    scp kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig root@<span class="variable">$&#123;node_name&#125;</span>:/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li><p>å‘ kubeconfig å†™å…¥çš„æ˜¯ tokenï¼Œbootstrap ç»“æŸå kube-controller-manager ä¸º kubelet åˆ›å»º client å’Œ server è¯ä¹¦ï¼›</p></li><li><p>æŸ¥çœ‹ kubeadm ä¸ºå„èŠ‚ç‚¹åˆ›å»ºçš„ token:<br>master èŠ‚ç‚¹æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm token list --kubeconfig ~/.kube/config</span></span><br><span class="line">TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION               EXTRA GROUPS</span><br><span class="line">016e9x.306t91l832suzg8i   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-03</span><br><span class="line">4l4tcx.juy6qs9rmrnfpbig   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-01</span><br><span class="line">64pk36.vbhvbmtojpskyclt   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-02</span><br></pre></td></tr></table></figure><ul><li>token æœ‰æ•ˆæœŸä¸º 1 å¤©ï¼Œè¶…æœŸåå°†ä¸èƒ½å†è¢«ç”¨æ¥ boostrap kubeletï¼Œä¸”ä¼šè¢« kube-controller-manager çš„ tokencleaner æ¸…ç†ï¼›</li><li>kube-apiserver æ¥æ”¶ kubelet çš„ bootstrap token åï¼Œå°†è¯·æ±‚çš„ user è®¾ç½®ä¸º system:bootstrap:<token>ï¼Œgroup è®¾ç½®ä¸º system:bootstrappersï¼Œåç»­å°†ä¸ºè¿™ä¸ª group è®¾ç½® ClusterRoleBindingï¼›</token></li></ul></li><li><p>æŸ¥çœ‹å„ token å…³è”çš„ Secretï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get secrets  -n kube-system|grep bootstrap-token</span></span><br><span class="line">bootstrap-token-016e9x                           bootstrap.kubernetes.io/token         7      4h25m</span><br><span class="line">bootstrap-token-4l4tcx                           bootstrap.kubernetes.io/token         7      4h25m</span><br><span class="line">bootstrap-token-64pk36                           bootstrap.kubernetes.io/token         7      4h25m</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2ã€åˆ›å»ºå’Œåˆ†å‘-kubelet-å‚æ•°é…ç½®æ–‡ä»¶"><a href="#2-2ã€åˆ›å»ºå’Œåˆ†å‘-kubelet-å‚æ•°é…ç½®æ–‡ä»¶" class="headerlink" title="2.2ã€åˆ›å»ºå’Œåˆ†å‘ kubelet å‚æ•°é…ç½®æ–‡ä»¶"></a>2.2ã€åˆ›å»ºå’Œåˆ†å‘ kubelet å‚æ•°é…ç½®æ–‡ä»¶</h4><p>ä» v1.10 å¼€å§‹ï¼Œéƒ¨åˆ† kubelet å‚æ•°éœ€åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œkubelet â€“help ä¼šæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DEPRECATED: This parameter should be <span class="built_in">set</span> via the config file specified by the Kubelet<span class="string">'s --config flag</span></span><br></pre></td></tr></table></figure><ul><li><p>åˆ›å»º kubelet å‚æ•°é…ç½®æ–‡ä»¶æ¨¡æ¿</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kubelet-config.yaml</span></span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: <span class="string">"0.0.0.0"</span></span><br><span class="line">staticPodPath: <span class="string">""</span></span><br><span class="line">syncFrequency: 1m</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">staticPodURL: <span class="string">""</span></span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 0</span><br><span class="line">rotateCertificates: <span class="literal">true</span></span><br><span class="line">serverTLSBootstrap: <span class="literal">true</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">registryPullQPS: 0</span><br><span class="line">registryBurst: 20</span><br><span class="line">eventRecordQPS: 0</span><br><span class="line">eventBurst: 20</span><br><span class="line">enableDebuggingHandlers: <span class="literal">true</span></span><br><span class="line">enableContentionProfiling: <span class="literal">true</span></span><br><span class="line">healthzPort: 10248</span><br><span class="line">healthzBindAddress: <span class="string">"172.21.16.87"</span> <span class="comment"># nodeèŠ‚ç‚¹ip</span></span><br><span class="line">clusterDomain: <span class="string">"cluster.local"</span></span><br><span class="line">clusterDNS:</span><br><span class="line">  - <span class="string">"10.254.0.2"</span></span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">nodeStatusReportFrequency: 1m</span><br><span class="line">imageMinimumGCAge: 2m</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">volumeStatsAggPeriod: 1m</span><br><span class="line">kubeletCgroups: <span class="string">""</span></span><br><span class="line">systemCgroups: <span class="string">""</span></span><br><span class="line">cgroupRoot: <span class="string">""</span></span><br><span class="line">cgroupsPerQOS: <span class="literal">true</span></span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">runtimeRequestTimeout: 10m</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">maxPods: 100</span><br><span class="line">podCIDR: <span class="string">"172.30.0.0/16"</span></span><br><span class="line">podPidsLimit: -1</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">kubeAPIQPS: 1000</span><br><span class="line">kubeAPIBurst: 2000</span><br><span class="line">serializeImagePulls: <span class="literal">false</span></span><br><span class="line">evictionHard:</span><br><span class="line">  memory.available:  <span class="string">"100Mi"</span></span><br><span class="line">nodefs.available:  <span class="string">"10%"</span></span><br><span class="line">nodefs.inodesFree: <span class="string">"5%"</span></span><br><span class="line">imagefs.available: <span class="string">"15%"</span></span><br><span class="line">evictionSoft: &#123;&#125;</span><br><span class="line">enableControllerAttachDetach: <span class="literal">true</span></span><br><span class="line">failSwapOn: <span class="literal">true</span></span><br><span class="line">containerLogMaxSize: 20Mi</span><br><span class="line">containerLogMaxFiles: 10</span><br><span class="line">systemReserved: &#123;&#125;</span><br><span class="line">kubeReserved: &#123;&#125;</span><br><span class="line">systemReservedCgroup: <span class="string">""</span></span><br><span class="line">kubeReservedCgroup: <span class="string">""</span></span><br><span class="line">enforceNodeAllocatable: [<span class="string">"pods"</span>]</span><br></pre></td></tr></table></figure><ul><li>addressï¼škubelet å®‰å…¨ç«¯å£ï¼ˆhttpsï¼Œ10250ï¼‰ç›‘å¬çš„åœ°å€ï¼Œä¸èƒ½ä¸º 127.0.0.1ï¼Œå¦åˆ™ kube-apiserverã€heapster ç­‰ä¸èƒ½è°ƒç”¨ kubelet çš„ APIï¼›</li><li>readOnlyPort=0ï¼šå…³é—­åªè¯»ç«¯å£(é»˜è®¤ 10255)ï¼Œç­‰æ•ˆä¸ºæœªæŒ‡å®šï¼›</li><li>authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åï¿½è®¿é—® 10250 ç«¯å£ï¼›</li><li>authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTP è¯ä¹¦è®¤è¯ï¼›</li><li>authentication.webhook.enabled=trueï¼šå¼€å¯ HTTPs bearer token è®¤è¯ï¼›</li><li>å¯¹äºæœªé€šè¿‡ x509 è¯ä¹¦å’Œ webhook è®¤è¯çš„è¯·æ±‚(kube-apiserver æˆ–å…¶ä»–å®¢æˆ·ç«¯)ï¼Œå°†è¢«æ‹’ç»ï¼Œæç¤º Unauthorizedï¼›</li><li>authroization.mode=Webhookï¼škubelet ä½¿ç”¨ SubjectAccessReview API æŸ¥è¯¢ kube-apiserver æŸ userã€group æ˜¯å¦å…·æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</li><li>featureGates.RotateKubeletClientCertificateã€featureGates.RotateKubeletServerCertificateï¼šè‡ªåŠ¨ rotate è¯ä¹¦ï¼Œè¯ä¹¦çš„æœ‰æ•ˆæœŸå–å†³äº kube-controller-manager çš„ â€“experimental-cluster-signing-duration å‚æ•°ï¼›</li><li>éœ€è¦ root è´¦æˆ·è¿è¡Œï¼›</li></ul></li></ul><h4 id="2-3ã€åˆ›å»ºkubelet-systemd-unit-æ–‡ä»¶"><a href="#2-3ã€åˆ›å»ºkubelet-systemd-unit-æ–‡ä»¶" class="headerlink" title="2.3ã€åˆ›å»ºkubelet systemd unit æ–‡ä»¶"></a>2.3ã€åˆ›å»ºkubelet systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kubelet.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kubelet</span><br><span class="line">ExecStart=/usr/bin/kubelet \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \</span><br><span class="line">  --cert-dir=/etc/kubernetes/ssl \</span><br><span class="line">  --cni-conf-dir=/etc/cni/net.d \</span><br><span class="line">  --container-runtime=docker \</span><br><span class="line">  --container-runtime-endpoint=unix:///var/run/dockershim.sock \</span><br><span class="line">  --root-dir=/var/lib/kubelet \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  --config=/etc/kubernetes/kubelet-config.yaml \</span><br><span class="line">  --hostname-override=172.21.16.87 \ <span class="comment"># node èŠ‚ç‚¹ip</span></span><br><span class="line">  --pod-infra-container-image=registry.cn-beijing.aliyuncs.com/images_k8s/pause-amd64:3.1 \</span><br><span class="line">  --image-pull-progress-deadline=15m \</span><br><span class="line">  --volume-plugin-dir=/var/lib/kubelet/kubelet-plugins/volume/<span class="built_in">exec</span>/ \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœè®¾ç½®äº† â€“hostname-override é€‰é¡¹ï¼Œåˆ™ kube-proxy ä¹Ÿéœ€è¦è®¾ç½®è¯¥é€‰é¡¹ï¼Œå¦åˆ™ä¼šå‡ºç°æ‰¾ä¸åˆ° Node çš„æƒ…å†µï¼›</li><li>â€“bootstrap-kubeconfigï¼šæŒ‡å‘ bootstrap kubeconfig æ–‡ä»¶ï¼Œkubelet ä½¿ç”¨è¯¥æ–‡ä»¶ä¸­çš„ç”¨æˆ·åå’Œ token å‘ kube-apiserver å‘é€ TLS Bootstrapping è¯·æ±‚ï¼›</li><li>K8S approve kubelet çš„ csr è¯·æ±‚åï¼Œåœ¨ â€“cert-dir ç›®å½•åˆ›å»ºè¯ä¹¦å’Œç§é’¥æ–‡ä»¶ï¼Œç„¶åå†™å…¥ â€“kubeconfig æ–‡ä»¶ï¼›</li><li>â€“pod-infra-container-image ä¸ä½¿ç”¨ redhat çš„ pod-infrastructure:latest é•œåƒï¼Œå®ƒä¸èƒ½å›æ”¶å®¹å™¨çš„åƒµå°¸ï¼›</li></ul><h4 id="2-4ã€Bootstrap-Token-Auth-å’Œæˆäºˆæƒé™"><a href="#2-4ã€Bootstrap-Token-Auth-å’Œæˆäºˆæƒé™" class="headerlink" title="2.4ã€Bootstrap Token Auth å’Œæˆäºˆæƒé™"></a>2.4ã€Bootstrap Token Auth å’Œæˆäºˆæƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨æ—¶æŸ¥æ‰¾ â€“kubeletconfig å‚æ•°å¯¹åº”çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ â€“bootstrap-kubeconfig æŒ‡å®šçš„ kubeconfig æ–‡ä»¶å‘ kube-apiserver å‘é€è¯ä¹¦ç­¾åè¯·æ±‚ (CSR)ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-apiserver æ”¶åˆ° CSR è¯·æ±‚åï¼Œå¯¹å…¶ä¸­çš„ Token è¿›è¡Œè®¤è¯ï¼Œè®¤è¯é€šè¿‡åå°†è¯·æ±‚çš„ user è®¾ç½®ä¸º system:bootstrap:<token>ï¼Œgroup è®¾ç½®ä¸º system:bootstrappersï¼Œè¿™ä¸€è¿‡ç¨‹ç§°ä¸º Bootstrap Token Authã€‚</token></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ª user å’Œ group æ²¡æœ‰åˆ›å»º CSR çš„æƒé™ï¼Œkubelet å¯åŠ¨å¤±è´¥ï¼Œé”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.858672   20385 reflector.go:126] k8s.io/client-go/informers/factory.go:133: Failed to list *v1beta1.RuntimeClass: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.860429   20385 reflector.go:126] k8s.io/client-go/informers/factory.go:133: Failed to list *v1beta1.CSIDriver: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.903098   20385 kubelet.go:2244] node <span class="string">"172.21.16.240"</span> not found</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.985568   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/kubelet.go:442: Failed to list *v1.Service: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.986781   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: Failed to list *v1.Pod: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.987454   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/kubelet.go:451: Failed to list *v1.Node: Unauthorized</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•æ˜¯ï¼šåˆ›å»ºä¸€ä¸ª clusterrolebindingï¼Œå°† group system:bootstrappers å’Œ clusterrole system:node-bootstrapper ç»‘å®šï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span></span><br></pre></td></tr></table></figure><h4 id="2-5ã€å¯åŠ¨-kubelet-æœåŠ¡"><a href="#2-5ã€å¯åŠ¨-kubelet-æœåŠ¡" class="headerlink" title="2.5ã€å¯åŠ¨ kubelet æœåŠ¡"></a>2.5ã€å¯åŠ¨ kubelet æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kubelet</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet &amp;&amp; systemctl status kubelet</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æœåŠ¡å‰å¿…é¡»å…ˆåˆ›å»ºå·¥ä½œç›®å½•ï¼›</li><li>å…³é—­ swap åˆ†åŒºï¼Œå¦åˆ™ kubelet ä¼šå¯åŠ¨å¤±è´¥ï¼›</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨åä½¿ç”¨ â€“bootstrap-kubeconfig å‘ kube-apiserver å‘é€ CSR è¯·æ±‚ï¼Œå½“è¿™ä¸ª CSR è¢« approve åï¼Œkube-controller-manager ä¸º kubelet åˆ›å»º TLS å®¢æˆ·ç«¯è¯ä¹¦ã€ç§é’¥å’Œ â€“kubeletconfig æ–‡ä»¶ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>æ³¨æ„</strong>ï¼škube-controller-manager éœ€è¦é…ç½® â€“cluster-signing-cert-file å’Œ â€“cluster-signing-key-file å‚æ•°ï¼Œæ‰ä¼šä¸º TLS Bootstrap åˆ›å»ºè¯ä¹¦å’Œç§é’¥ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                 CONDITION</span><br><span class="line">csr-bwcbm   82s     system:bootstrap:016e9x   Pending</span><br><span class="line">csr-gqdhf   105s    system:bootstrap:64pk36   Pending</span><br><span class="line">csr-q995g   6m57s   system:bootstrap:4l4tcx   Pending</span><br><span class="line">csr-xx45v   7m33s   system:bootstrap:4l4tcx   Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure><h4 id="2-6ã€è‡ªåŠ¨-approve-CSR-è¯·æ±‚"><a href="#2-6ã€è‡ªåŠ¨-approve-CSR-è¯·æ±‚" class="headerlink" title="2.6ã€è‡ªåŠ¨ approve CSR è¯·æ±‚"></a>2.6ã€è‡ªåŠ¨ approve CSR è¯·æ±‚</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/csr-crb.yaml</span></span><br><span class="line"><span class="comment"># Approve all CSRs for the group "system:bootstrappers"</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: auto-approve-csrs-for-group</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:bootstrappers</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own credentials</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: node-client-cert-renewal</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:nodes</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="comment"># serving cert matching its client cert.</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: approve-node-server-renewal-csr</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  resources: [<span class="string">"certificatesigningrequests/selfnodeserver"</span>]</span><br><span class="line">  verbs: [<span class="string">"create"</span>]</span><br><span class="line">---</span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own server credentials</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: node-server-cert-renewal</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:nodes</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: approve-node-server-renewal-csr</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure><ul><li>auto-approve-csrs-for-groupï¼šè‡ªåŠ¨ approve node çš„ç¬¬ä¸€æ¬¡ CSRï¼› æ³¨æ„ç¬¬ä¸€æ¬¡ CSR æ—¶ï¼Œè¯·æ±‚çš„ Group ä¸º system:bootstrappersï¼›</li><li>node-client-cert-renewalï¼šè‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ client è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodes;</li><li>node-server-cert-renewalï¼šè‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ server è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodes;</li></ul><h4 id="2-6ã€ç­‰æŸ¥çœ‹-kubelet-çš„æƒ…å†µ"><a href="#2-6ã€ç­‰æŸ¥çœ‹-kubelet-çš„æƒ…å†µ" class="headerlink" title="2.6ã€ç­‰æŸ¥çœ‹ kubelet çš„æƒ…å†µ"></a>2.6ã€ç­‰æŸ¥çœ‹ kubelet çš„æƒ…å†µ</h4><p>å¾…ä¸€æ®µæ—¶é—´(1-10 åˆ†é’Ÿ)ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„ CSR éƒ½è¢«è‡ªåŠ¨ approvedï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                   CONDITION</span><br><span class="line">csr-2t4bj   2m58s   system:node:172.21.16.240   Pending</span><br><span class="line">csr-2z2mq   4m14s   system:node:172.21.16.204   Pending</span><br><span class="line">csr-bwcbm   6m6s    system:bootstrap:016e9x     Approved,Issued</span><br><span class="line">csr-gqdhf   6m29s   system:bootstrap:64pk36     Approved,Issued</span><br><span class="line">csr-q995g   11m     system:bootstrap:4l4tcx     Approved,Issued</span><br><span class="line">csr-xx45v   12m     system:bootstrap:4l4tcx     Pending</span><br></pre></td></tr></table></figure><ul><li>æ‰€æœ‰èŠ‚ç‚¹å‡ readyï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   4m17s   v1.14.6</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   3m2s    v1.14.6</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   3s      v1.14.6</span><br></pre></td></tr></table></figure></li></ul><p>kube-controller-manager ä¸ºå„ node ç”Ÿæˆäº† kubeconfig æ–‡ä»¶å’Œå…¬ç§é’¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -l /etc/kubernetes/kubelet.kubeconfig</span></span><br><span class="line">-rw------- 1 root root 2311 Sep 16 11:31 /etc/kubernetes/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls -l /etc/kubernetes/ssl/|grep kubelet</span></span><br><span class="line">-rw------- 1 root root 1281 Sep 16 11:43 kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:43 kubelet-client-current.pem -&gt; /etc/kubernetes/ssl/kubelet-client-2019-09-16-11-43-20.pem</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆ kubelet server è¯ä¹¦ï¼›</p><h4 id="2-8ã€æ‰‹åŠ¨-approve-server-cert-csr"><a href="#2-8ã€æ‰‹åŠ¨-approve-server-cert-csr" class="headerlink" title="2.8ã€æ‰‹åŠ¨ approve server cert csr"></a>2.8ã€æ‰‹åŠ¨ approve server cert csr</h4><p>åŸºäº<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#kubelet-configuratio" target="_blank" rel="noopener">å®‰å…¨æ€§è€ƒè™‘</a>ï¼ŒCSR approving controllers ä¸ä¼šè‡ªåŠ¨ approve kubelet server è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œéœ€è¦æ‰‹åŠ¨ approveï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                   CONDITION</span><br><span class="line">csr-2t4bj   3m5s    system:node:172.21.16.240   Pending</span><br><span class="line">csr-2z2mq   4m21s   system:node:172.21.16.204   Pending</span><br><span class="line">csr-bwcbm   6m13s   system:bootstrap:016e9x     Approved,Issued</span><br><span class="line">csr-gqdhf   6m36s   system:bootstrap:64pk36     Approved,Issued</span><br><span class="line">csr-gtkrt   7s      system:node:172.21.16.87    Pending</span><br><span class="line">csr-q995g   11m     system:bootstrap:4l4tcx     Approved,Issued</span><br><span class="line">csr-xx45v   12m     system:bootstrap:4l4tcx     Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-2t4bj</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-2t4bj approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-2z2mq </span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-2z2mq approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-gtkrt</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-gtkrt approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls -l /etc/kubernetes/ssl/|grep kubelet</span></span><br><span class="line">-rw------- 1 root root 1281 Sep 16 11:43 kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:43 kubelet-client-current.pem -&gt; /etc/kubernetes/ssl/kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">-rw------- 1 root root 1305 Sep 16 11:44 kubelet-server-2019-09-16-11-44-12.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:44 kubelet-server-current.pem -&gt; /etc/kubernetes/ssl/kubelet-server-2019-09-16-11-44-12.pem</span><br></pre></td></tr></table></figure><h4 id="2-9ã€kubelet-æä¾›çš„-API-æ¥å£"><a href="#2-9ã€kubelet-æä¾›çš„-API-æ¥å£" class="headerlink" title="2.9ã€kubelet æä¾›çš„ API æ¥å£"></a>2.9ã€kubelet æä¾›çš„ API æ¥å£</h4><p>kubelet å¯åŠ¨åç›‘å¬å¤šä¸ªç«¯å£ï¼Œç”¨äºæ¥æ”¶ kube-apiserver æˆ–å…¶å®ƒå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kubelet</span></span><br><span class="line">tcp        0      0 127.0.0.1:43042         0.0.0.0:*               LISTEN      22726/kubelet       </span><br><span class="line">tcp        0      0 172.21.16.87:10248      0.0.0.0:*               LISTEN      22726/kubelet       </span><br><span class="line">tcp6       0      0 :::10250                :::*                    LISTEN      22726/kubelet</span><br></pre></td></tr></table></figure><ul><li>10248: healthz http æœåŠ¡ï¼›</li><li>10250: https æœåŠ¡ï¼Œè®¿é—®è¯¥ç«¯å£æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼ˆå³ä½¿è®¿é—® /healthz ä¹Ÿéœ€è¦ï¼‰ï¼›</li><li>æœªå¼€å¯åªè¯»ç«¯å£ 10255ï¼›</li><li>ä» K8S v1.10 å¼€å§‹ï¼Œå»é™¤äº† â€“cadvisor-port å‚æ•°ï¼ˆé»˜è®¤ 4194 ç«¯å£ï¼‰ï¼Œä¸æ”¯æŒè®¿é—® cAdvisor UI &amp; APIã€‚</li></ul><p>ç”±äºå…³é—­äº†åŒ¿åè®¤è¯ï¼ŒåŒæ—¶å¼€å¯äº† webhook æˆæƒï¼Œæ‰€æœ‰è®¿é—® 10250 ç«¯å£ https API çš„è¯·æ±‚éƒ½éœ€è¦è¢«è®¤è¯å’Œæˆæƒã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¢„å®šä¹‰çš„ ClusterRole system:kubelet-api-admin æˆäºˆè®¿é—® kubelet æ‰€æœ‰ API çš„æƒé™(kube-apiserver ä½¿ç”¨çš„ kubernetes è¯ä¹¦ User æˆäºˆäº†è¯¥æƒé™)ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kubelet-api-admin</span></span><br><span class="line">Name:         system:kubelet-api-admin</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources      Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------      -----------------  --------------  -----</span><br><span class="line">  nodes/<span class="built_in">log</span>      []                 []              [*]</span><br><span class="line">  nodes/metrics  []                 []              [*]</span><br><span class="line">  nodes/proxy    []                 []              [*]</span><br><span class="line">  nodes/spec     []                 []              [*]</span><br><span class="line">  nodes/stats    []                 []              [*]</span><br><span class="line">  nodes          []                 []              [get list watch proxy]</span><br></pre></td></tr></table></figure><h4 id="2-10ã€kubelet-api-è®¤è¯å’Œæˆæƒ"><a href="#2-10ã€kubelet-api-è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.10ã€kubelet api è®¤è¯å’Œæˆæƒ"></a>2.10ã€kubelet api è®¤è¯å’Œæˆæƒ</h4><p>kubelet é…ç½®äº†å¦‚ä¸‹è®¤è¯å‚æ•°:</p><ul><li>authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åè®¿é—® 10250 ç«¯å£ï¼›</li><li>authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTPs è¯ä¹¦è®¤è¯ï¼›</li><li>authentication.webhook.enabled=trueï¼šå¼€å¯ HTTPs bearer token è®¤è¯ï¼›</li></ul><p>åŒæ—¶é…ç½®äº†å¦‚ä¸‹æˆæƒå‚æ•°:</p><ul><li>authroization.mode=Webhookï¼šå¼€å¯ RBAC æˆæƒ</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ clientCAFile å¯¹è¯ä¹¦ç­¾åè¿›è¡Œè®¤è¯ï¼Œæˆ–è€…æŸ¥è¯¢ bearer token æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœä¸¤è€…éƒ½æ²¡é€šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚ï¼Œæç¤º Unauthorizedï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line">Unauthorized</span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem -H "Authorization: Bearer 123456"  https://172.21.16.87:10250/metrics</span></span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡è®¤è¯åï¼Œkubelet ä½¿ç”¨ SubjectAccessReview API å‘ kube-apiserver å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢è¯ä¹¦æˆ– token å¯¹åº”çš„ userã€group æ˜¯å¦æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</p><h4 id="2-11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ"><a href="#2-11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ"></a>2.11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æƒé™ä¸è¶³çš„è¯ä¹¦ï¼›</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/kube-controller-manager.pem --key /etc/kubernetes/ssl/kube-controller-manager-key.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line">Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼›</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><ul><li>â€“cacertã€â€“certã€â€“key çš„å‚æ•°å€¼å¿…é¡»æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ä¸Šé¢çš„ ./admin.pem ä¸èƒ½çœç•¥ ./ï¼Œå¦åˆ™è¿”å› 401 Unauthorizedï¼›</li></ul><h4 id="2-12ã€bear-token-è®¤è¯å’Œæˆæƒ"><a href="#2-12ã€bear-token-è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.12ã€bear token è®¤è¯å’Œæˆæƒ"></a>2.12ã€bear token è®¤è¯å’Œæˆæƒ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ª ServiceAccountï¼Œå°†å®ƒå’Œ ClusterRole system:kubelet-api-admin ç»‘å®šï¼Œä»è€Œå…·æœ‰è°ƒç”¨ kubelet API çš„æƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create sa kubelet-api-test</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding kubelet-api-test --clusterrole=system:kubelet-api-admin --serviceaccount=default:kubelet-api-test</span></span><br><span class="line"><span class="comment"># SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># TOKEN=$(kubectl describe secret $&#123;SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;TOKEN&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem -H "Authorization: Bearer $&#123;TOKEN&#125;" https://172.21.16.87:10250/metrics|head</span></span><br></pre></td></tr></table></figure><h3 id="3ã€cadvisor-å’Œ-metrics"><a href="#3ã€cadvisor-å’Œ-metrics" class="headerlink" title="3ã€cadvisor å’Œ metrics"></a>3ã€cadvisor å’Œ metrics</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cadvisor æ˜¯å†…åµŒåœ¨ kubelet äºŒè¿›åˆ¶ä¸­çš„ï¼Œç»Ÿè®¡æ‰€åœ¨èŠ‚ç‚¹å„å®¹å™¨çš„èµ„æº(CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘å¡)ä½¿ç”¨æƒ…å†µçš„æœåŠ¡ã€‚<br>æµè§ˆå™¨è®¿é—® <a href="https://172.21.16.87:10250/metrics" target="_blank" rel="noopener">https://172.21.16.87:10250/metrics</a> å’Œ <a href="https://172.21.16.87:10250/metrics/cadvisor" target="_blank" rel="noopener">https://172.21.16.87:10250/metrics/cadvisor</a> åˆ†åˆ«è¿”å› kubelet å’Œ cadvisor çš„ metricsã€‚<br><img src="https://img.xxlaila.cn/1568624798589.jpg" alt="img"></p><p><strong>æ³¨æ„:</strong></p><ul><li>kubelet.config.json è®¾ç½® authentication.anonymous.enabled ä¸º falseï¼Œä¸å…è®¸åŒ¿åè¯ä¹¦è®¿é—® 10250 çš„ https æœåŠ¡ï¼›</li><li>å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/kubeletæä¾›apiè¯·æ±‚æ¥å£/" target="_blank" rel="noopener">kubeletæä¾›apiè¯·æ±‚æ¥å£</a>ï¼Œåˆ›å»ºå’Œå¯¼å…¥ç›¸å…³è¯ä¹¦ï¼Œç„¶åè®¿é—®ä¸Šé¢çš„ 10250 ç«¯å£ï¼›</li></ul><h4 id="3-1ã€è·å–-kubelet-çš„é…ç½®"><a href="#3-1ã€è·å–-kubelet-çš„é…ç½®" class="headerlink" title="3.1ã€è·å– kubelet çš„é…ç½®"></a>3.1ã€è·å– kubelet çš„é…ç½®</h4><p>ä» kube-apiserver è·å–å„èŠ‚ç‚¹ kubelet çš„é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼›</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -sSL --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem $&#123;KUBE_APISERVER&#125;/api/v1/nodes/172.21.16.87/proxy/configz | jq  '.kubeletconfig|.kind="KubeletConfiguration"|.apiVersion="kubelet.config.k8s.io/v1beta1"'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"syncFrequency"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"fileCheckFrequency"</span>: <span class="string">"20s"</span>,</span><br><span class="line">  <span class="string">"httpCheckFrequency"</span>: <span class="string">"20s"</span>,</span><br><span class="line">  <span class="string">"address"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">  <span class="string">"port"</span>: 10250,</span><br><span class="line">  <span class="string">"rotateCertificates"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"serverTLSBootstrap"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"authentication"</span>: &#123;</span><br><span class="line">    <span class="string">"x509"</span>: &#123;</span><br><span class="line">      <span class="string">"clientCAFile"</span>: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"cacheTTL"</span>: <span class="string">"2m0s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"anonymous"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"authorization"</span>: &#123;</span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"Webhook"</span>,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"cacheAuthorizedTTL"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">      <span class="string">"cacheUnauthorizedTTL"</span>: <span class="string">"30s"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"registryPullQPS"</span>: 0,</span><br><span class="line">  <span class="string">"registryBurst"</span>: 20,</span><br><span class="line">  <span class="string">"eventRecordQPS"</span>: 0,</span><br><span class="line">  <span class="string">"eventBurst"</span>: 20,</span><br><span class="line">  <span class="string">"enableDebuggingHandlers"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"enableContentionProfiling"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"healthzPort"</span>: 10248,</span><br><span class="line">  <span class="string">"healthzBindAddress"</span>: <span class="string">"172.21.16.87"</span>,</span><br><span class="line">  <span class="string">"oomScoreAdj"</span>: -999,</span><br><span class="line">  <span class="string">"clusterDomain"</span>: <span class="string">"cluster.local"</span>,</span><br><span class="line">  <span class="string">"clusterDNS"</span>: [</span><br><span class="line">    <span class="string">"10.254.0.2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"streamingConnectionIdleTimeout"</span>: <span class="string">"4h0m0s"</span>,</span><br><span class="line">  <span class="string">"nodeStatusUpdateFrequency"</span>: <span class="string">"10s"</span>,</span><br><span class="line">  <span class="string">"nodeStatusReportFrequency"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"nodeLeaseDurationSeconds"</span>: 40,</span><br><span class="line">  <span class="string">"imageMinimumGCAge"</span>: <span class="string">"2m0s"</span>,</span><br><span class="line">  <span class="string">"imageGCHighThresholdPercent"</span>: 85,</span><br><span class="line">  <span class="string">"imageGCLowThresholdPercent"</span>: 80,</span><br><span class="line">  <span class="string">"volumeStatsAggPeriod"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"cgroupsPerQOS"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"cgroupDriver"</span>: <span class="string">"cgroupfs"</span>,</span><br><span class="line">  <span class="string">"cpuManagerPolicy"</span>: <span class="string">"none"</span>,</span><br><span class="line">  <span class="string">"cpuManagerReconcilePeriod"</span>: <span class="string">"10s"</span>,</span><br><span class="line">  <span class="string">"runtimeRequestTimeout"</span>: <span class="string">"10m0s"</span>,</span><br><span class="line">  <span class="string">"hairpinMode"</span>: <span class="string">"promiscuous-bridge"</span>,</span><br><span class="line">  <span class="string">"maxPods"</span>: 100,</span><br><span class="line">  <span class="string">"podCIDR"</span>: <span class="string">"172.30.0.0/16"</span>,</span><br><span class="line">  <span class="string">"podPidsLimit"</span>: -1,</span><br><span class="line">  <span class="string">"resolvConf"</span>: <span class="string">"/etc/resolv.conf"</span>,</span><br><span class="line">  <span class="string">"cpuCFSQuota"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"cpuCFSQuotaPeriod"</span>: <span class="string">"100ms"</span>,</span><br><span class="line">  <span class="string">"maxOpenFiles"</span>: 1000000,</span><br><span class="line">  <span class="string">"contentType"</span>: <span class="string">"application/vnd.kubernetes.protobuf"</span>,</span><br><span class="line">  <span class="string">"kubeAPIQPS"</span>: 1000,</span><br><span class="line">  <span class="string">"kubeAPIBurst"</span>: 2000,</span><br><span class="line">  <span class="string">"serializeImagePulls"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"evictionHard"</span>: &#123;</span><br><span class="line">    <span class="string">"memory.available"</span>: <span class="string">"100Mi"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"evictionPressureTransitionPeriod"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">  <span class="string">"enableControllerAttachDetach"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"makeIPTablesUtilChains"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"iptablesMasqueradeBit"</span>: 14,</span><br><span class="line">  <span class="string">"iptablesDropBit"</span>: 15,</span><br><span class="line">  <span class="string">"failSwapOn"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"containerLogMaxSize"</span>: <span class="string">"20Mi"</span>,</span><br><span class="line">  <span class="string">"containerLogMaxFiles"</span>: 10,</span><br><span class="line">  <span class="string">"configMapAndSecretChangeDetectionStrategy"</span>: <span class="string">"Watch"</span>,</span><br><span class="line">  <span class="string">"enforceNodeAllocatable"</span>: [</span><br><span class="line">    <span class="string">"pods"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"KubeletConfiguration"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"kubelet.config.k8s.io/v1beta1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4ã€éƒ¨ç½²-kube-proxy-ç»„ä»¶"><a href="#4ã€éƒ¨ç½²-kube-proxy-ç»„ä»¶" class="headerlink" title="4ã€éƒ¨ç½² kube-proxy ç»„ä»¶"></a>4ã€éƒ¨ç½² kube-proxy ç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-proxy è¿è¡Œåœ¨æ‰€æœ‰ worker èŠ‚ç‚¹ä¸Šï¼Œå®ƒç›‘å¬ apiserver ä¸­ service å’Œ endpoint çš„å˜åŒ–æƒ…å†µï¼Œåˆ›å»ºè·¯ç”±è§„åˆ™ä»¥æä¾›æœåŠ¡ IP å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p><h4 id="4-1ã€åˆ›å»º-kube-proxy-è¯ä¹¦"><a href="#4-1ã€åˆ›å»º-kube-proxy-è¯ä¹¦" class="headerlink" title="4.1ã€åˆ›å»º kube-proxy è¯ä¹¦"></a>4.1ã€åˆ›å»º kube-proxy è¯ä¹¦</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><p>CNï¼šæŒ‡å®šè¯¥è¯ä¹¦çš„ User ä¸º system:kube-proxyï¼›</p></li><li><p>é¢„å®šä¹‰çš„ RoleBinding system:node-proxier å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼›</p></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kube-proxy å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ls kube-proxy*.pem</span></span><br><span class="line">kube-proxy-key.pem  kube-proxy.pem</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#4-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="4.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>4.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials kube-proxy \</span></span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br></pre></td></tr></table></figure><ul><li>â€“embed-certs=trueï¼šå°† ca.pem å’Œ admin.pem è¯ä¹¦å†…å®¹åµŒå…¥åˆ°ç”Ÿæˆçš„ kubectl-proxy.kubeconfig æ–‡ä»¶ä¸­(ä¸åŠ æ—¶ï¼Œå†™å…¥çš„æ˜¯è¯ä¹¦æ–‡ä»¶è·¯å¾„)</li></ul><h4 id="4-3ã€åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶"><a href="#4-3ã€åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶" class="headerlink" title="4.3ã€åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶"></a>4.3ã€åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kube-proxy-config.yaml</span></span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-proxy.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">healthzBindAddress: 172.21.16.87:10256 <span class="comment">#node</span></span><br><span class="line">metricsBindAddress: 172.21.16.87:10249 <span class="comment">#node</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">clusterCIDR: 172.30.0.0/16</span><br><span class="line">hostnameOverride: 172.21.16.87 <span class="comment">#node </span></span><br><span class="line">mode: <span class="string">"ipvs"</span></span><br><span class="line">portRange: <span class="string">""</span></span><br><span class="line">kubeProxyIPTablesConfiguration:</span><br><span class="line">  masqueradeAll: <span class="literal">false</span></span><br><span class="line">kubeProxyIPVSConfiguration:</span><br><span class="line">  scheduler: rr</span><br><span class="line">  excludeCIDRs: []</span><br></pre></td></tr></table></figure><ul><li>bindAddress: ç›‘å¬åœ°å€ï¼›</li><li>clientConnection.kubeconfig: è¿æ¥ apiserver çš„ kubeconfig æ–‡ä»¶ï¼›</li><li>clusterCIDR: kube-proxy æ ¹æ® â€“cluster-cidr åˆ¤æ–­é›†ç¾¤å†…éƒ¨å’Œå¤–éƒ¨æµé‡ï¼ŒæŒ‡å®š â€“cluster-cidr æˆ– â€“masquerade-all é€‰é¡¹å kube-proxy æ‰ä¼šå¯¹è®¿é—® Service IP çš„è¯·æ±‚åš SNATï¼›</li><li>hostnameOverride: å‚æ•°å€¼å¿…é¡»ä¸ kubelet çš„å€¼ä¸€è‡´ï¼Œå¦åˆ™ kube-proxy å¯åŠ¨åä¼šæ‰¾ä¸åˆ°è¯¥ Nodeï¼Œä»è€Œä¸ä¼šåˆ›å»ºä»»ä½• ipvs è§„åˆ™ï¼›</li><li>mode: ä½¿ç”¨ ipvs æ¨¡å¼ï¼›</li></ul><h4 id="4-4ã€åˆ›å»ºkube-proxy-systemd-unit-æ–‡ä»¶"><a href="#4-4ã€åˆ›å»ºkube-proxy-systemd-unit-æ–‡ä»¶" class="headerlink" title="4.4ã€åˆ›å»ºkube-proxy systemd unit æ–‡ä»¶"></a>4.4ã€åˆ›å»ºkube-proxy systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-proxy.service </span></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-proxy</span><br><span class="line">ExecStart=/usr/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy-config.yaml \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="4-5ã€å¯åŠ¨-kube-proxy-æœåŠ¡"><a href="#4-5ã€å¯åŠ¨-kube-proxy-æœåŠ¡" class="headerlink" title="4.5ã€å¯åŠ¨ kube-proxy æœåŠ¡"></a>4.5ã€å¯åŠ¨ kube-proxy æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy &amp;&amp; systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure><h4 id="4-5ã€æ£€æŸ¥"><a href="#4-5ã€æ£€æŸ¥" class="headerlink" title="4.5ã€æ£€æŸ¥"></a>4.5ã€æ£€æŸ¥</h4><ul><li><p>æŸ¥çœ‹ç›‘å¬ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kube-prox</span></span><br><span class="line">tcp        0      0 172.21.16.87:10256      0.0.0.0:*               LISTEN      27423/kube-proxy    </span><br><span class="line">tcp        0      0 172.21.16.87:10249      0.0.0.0:*               LISTEN      27423/kube-proxy</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ ipvs è·¯ç”±è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ipvsadm -ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.254.0.1:443 rr</span><br><span class="line">  -&gt; 172.21.17.30:6443            Masq    1      0          0         </span><br><span class="line">  -&gt; 172.21.17.31:6443            Masq    1      0          0 </span><br><span class="line">  -&gt; 172.21.16.110:6443           Masq    1      0          0</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14 nodeå®‰è£…</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-v1.14å®‰è£…</title>
    <url>/2019/09/11/kubernetes-v1-14%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="1ã€ç¯å¢ƒå‡†å¤‡"><a href="#1ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ç¯å¢ƒå‡†å¤‡"></a>1ã€ç¯å¢ƒå‡†å¤‡</h3><table><thead><tr><th>ip</th><th>type</th><th>docker</th><th>os</th><th>k8s version</th></tr></thead><tbody><tr><td>172.21.17.30</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td>v1.14.6</td></tr><tr><td>172.21.17.31</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.110</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.87</td><td>node,flanneld</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.240</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.204</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.45</td><td>vip</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr></tbody></table><h3 id="2ã€åˆå§‹åŒ–ç³»ç»Ÿ"><a href="#2ã€åˆå§‹åŒ–ç³»ç»Ÿ" class="headerlink" title="2ã€åˆå§‹åŒ–ç³»ç»Ÿ"></a>2ã€åˆå§‹åŒ–ç³»ç»Ÿ</h3><h4 id="2-1ã€å®‰è£…ä¾èµ–åŒ…"><a href="#2-1ã€å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="2.1ã€å®‰è£…ä¾èµ–åŒ…"></a>2.1ã€å®‰è£…ä¾èµ–åŒ…</h4><a id="more"></a><p>æ¯å°æœåŠ¡å™¨å‡æ“ä½œ,å…³é—­é˜²ç«å¢™,å…³é—­selinux</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y epel-release</span></span><br><span class="line"><span class="comment"># yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget</span></span><br></pre></td></tr></table></figure><h4 id="2-2ã€å…³é—­-swap-åˆ†åŒº"><a href="#2-2ã€å…³é—­-swap-åˆ†åŒº" class="headerlink" title="2.2ã€å…³é—­ swap åˆ†åŒº"></a>2.2ã€å…³é—­ swap åˆ†åŒº</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœå¼€å¯äº† swap åˆ†åŒºï¼Œkubelet ä¼šå¯åŠ¨å¤±è´¥(å¯ä»¥é€šè¿‡å°†å‚æ•° â€“fail-swap-on è®¾ç½®ä¸º false æ¥å¿½ç•¥ swap on)ï¼Œæ•…éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šå…³é—­ swap åˆ†åŒºã€‚åŒæ—¶æ³¨é‡Š /etc/fstab ä¸­ç›¸åº”çš„æ¡ç›®ï¼Œé˜²æ­¢å¼€æœºè‡ªåŠ¨æŒ‚è½½ swap åˆ†åŒºã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># swapoff -a</span></span><br><span class="line"><span class="comment"># sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab</span></span><br></pre></td></tr></table></figure><h4 id="2-3ã€åŠ è½½å†…æ ¸æ¨¡å—"><a href="#2-3ã€åŠ è½½å†…æ ¸æ¨¡å—" class="headerlink" title="2.3ã€åŠ è½½å†…æ ¸æ¨¡å—"></a>2.3ã€åŠ è½½å†…æ ¸æ¨¡å—</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># modprobe ip_vs_rr</span></span><br><span class="line"><span class="comment"># modprobe br_netfilter</span></span><br></pre></td></tr></table></figure><h5 id="2-3-1-åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨"><a href="#2-3-1-åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨" class="headerlink" title="2.3.1 åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨"></a>2.3.1 åŠ è½½å†…æ ¸ï¼ŒåŠ å…¥å¼€æœºå¯åŠ¨</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; /etc/rc.local  &lt;&lt; EOF</span></span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h5 id="2-3-2-ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—"><a href="#2-3-2-ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—" class="headerlink" title="2.3.2 ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—"></a>2.3.2 ä½¿ç”¨systemd-modules-loadåŠ è½½å†…æ ¸æ¨¡å—</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; /etc/modules-load.d/ipvs.conf &lt;&lt; EOF</span></span><br><span class="line"> ip_vs_rr</span><br><span class="line"> br_netfilter</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># systemctl enable --now systemd-modules-load.service</span></span><br></pre></td></tr></table></figure><h5 id="2-3-3-éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ"><a href="#2-3-3-éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ" class="headerlink" title="2.3.3 éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ"></a>2.3.3 éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># lsmod |egrep " ip_vs_rr|br_netfilter"</span></span><br><span class="line">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨IPVS,ä»k8sçš„1.8ç‰ˆæœ¬å¼€å§‹ï¼Œkube-proxyå¼•å…¥äº†IPVSæ¨¡å¼ï¼ŒIPVSæ¨¡å¼ä¸iptablesåŒæ ·åŸºäºNetfilterï¼Œä½†æ˜¯é‡‡ç”¨çš„<span class="built_in">hash</span>è¡¨ï¼Œå› æ­¤å½“serviceæ•°é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼Œ<span class="built_in">hash</span>æŸ¥è¡¨çš„é€Ÿåº¦ä¼˜åŠ¿å°±ä¼šæ˜¾ç°å‡ºæ¥ï¼Œä»è€Œæé«˜serviceçš„æœåŠ¡æ€§èƒ½ã€‚</span><br></pre></td></tr></table></figure><h4 id="2-4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°"><a href="#2-4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°" class="headerlink" title="2.4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°"></a>2.4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/sysctl.d/kubernetes.conf </span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line"><span class="comment"># sysctl -p /etc/sysctl.d/kubernetes.conf</span></span><br></pre></td></tr></table></figure><ul><li>å¿…é¡»å…³é—­ tcp_tw_recycleï¼Œå¦åˆ™å’Œ NAT å†²çªï¼Œä¼šå¯¼è‡´æœåŠ¡ä¸é€šï¼›</li><li>å…³é—­ IPV6ï¼Œé˜²æ­¢è§¦å‘ docker BUGï¼›</li></ul><h4 id="2-5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº"><a href="#2-5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº" class="headerlink" title="2.5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº"></a>2.5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># timedatectl set-timezone Asia/Shanghai</span></span><br><span class="line"><span class="comment"># timedatectl set-local-rtc 0</span></span><br><span class="line"><span class="comment"># systemctl restart rsyslog </span></span><br><span class="line"><span class="comment"># systemctl restart crond</span></span><br></pre></td></tr></table></figure><h4 id="2-6ã€å…³é—­æ— å…³çš„æœåŠ¡"><a href="#2-6ã€å…³é—­æ— å…³çš„æœåŠ¡" class="headerlink" title="2.6ã€å…³é—­æ— å…³çš„æœåŠ¡"></a>2.6ã€å…³é—­æ— å…³çš„æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl stop postfix &amp;&amp; systemctl disable postfix</span></span><br></pre></td></tr></table></figure><h3 id="3ã€å‡çº§å†…æ ¸"><a href="#3ã€å‡çº§å†…æ ¸" class="headerlink" title="3ã€å‡çº§å†…æ ¸"></a>3ã€å‡çº§å†…æ ¸</h3><p>ä»¥ä¸‹åœ¨masterèŠ‚ç‚¹æ“ä½œ<br>CentOS 7.x ç³»ç»Ÿè‡ªå¸¦çš„ 3.10.x å†…æ ¸å­˜åœ¨ä¸€äº› Bugsï¼Œå¯¼è‡´è¿è¡Œçš„ Dockerã€Kubernetes ä¸ç¨³å®šï¼Œä¾‹å¦‚:</p><ul><li>1.é«˜ç‰ˆæœ¬çš„ docker(1.13 ä»¥å) å¯ç”¨äº† 3.10 kernel å®éªŒæ”¯æŒçš„ kernel memory account åŠŸèƒ½(æ— æ³•å…³é—­)ï¼Œå½“èŠ‚ç‚¹å‹åŠ›å¤§å¦‚é¢‘ç¹å¯åŠ¨å’Œåœæ­¢å®¹å™¨æ—¶ä¼šå¯¼è‡´ cgroup memory leakï¼›</li><li>2.ç½‘ç»œè®¾å¤‡å¼•ç”¨è®¡æ•°æ³„æ¼ï¼Œä¼šå¯¼è‡´ç±»ä¼¼äºæŠ¥é”™ï¼šâ€kernel:unregister_netdevice: waiting for eth0 to become free. Usage count = 1â€;<br>è§£å†³æ–¹æ¡ˆå¦‚ä¸‹:</li><li>1.å‡çº§å†…æ ¸åˆ° 4.4.X ä»¥ä¸Š</li><li>2.æˆ–è€…ï¼Œæ‰‹åŠ¨ç¼–è¯‘å†…æ ¸ï¼Œdisable CONFIG_MEMCG_KMEM ç‰¹æ€§</li><li>æˆ–è€…ï¼Œå®‰è£…ä¿®å¤äº†è¯¥é—®é¢˜çš„ Docker 18.09.1 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚ä½†ç”±äº kubelet ä¹Ÿä¼šè®¾ç½® kmemï¼ˆå®ƒ vendor äº† runcï¼‰ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç¼–è¯‘ kubelet å¹¶æŒ‡å®š GOFLAGS=â€-tags=nokmemâ€</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --branch v1.14.1 --single-branch --depth 1 https://github.com/kubernetes/kubernetes</span><br><span class="line"><span class="built_in">cd</span> kubernetes</span><br><span class="line">KUBE_GIT_VERSION=v1.14.1 ./build/run.sh make kubelet GOFLAGS=<span class="string">"-tags=nokmem"</span></span><br></pre></td></tr></table></figure><h4 id="3-1ã€å†…æ ¸å‡çº§æ–¹æ³•"><a href="#3-1ã€å†…æ ¸å‡çº§æ–¹æ³•" class="headerlink" title="3.1ã€å†…æ ¸å‡çº§æ–¹æ³•"></a>3.1ã€å†…æ ¸å‡çº§æ–¹æ³•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span></span><br><span class="line"><span class="comment"># å®‰è£…å®Œæˆåæ£€æŸ¥ /boot/grub2/grub.cfg ä¸­å¯¹åº”å†…æ ¸ menuentry ä¸­æ˜¯å¦åŒ…å« initrd16 é…ç½®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å®‰è£…ä¸€æ¬¡ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yum --enablerepo=elrepo-kernel install -y kernel-lt</span></span><br><span class="line"><span class="comment"># è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨</span></span><br><span class="line"><span class="comment"># grub2-set-default 0</span></span><br></pre></td></tr></table></figure><h4 id="3-2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶"><a href="#3-2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶" class="headerlink" title="3.2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶"></a>3.2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum --enablerepo=elrepo-kernel install kernel-lt-devel-$(uname -r) kernel-lt-headers-$(uname -r)</span></span><br></pre></td></tr></table></figure><h4 id="3-3ã€å…³é—­-NUMA"><a href="#3-3ã€å…³é—­-NUMA" class="headerlink" title="3.3ã€å…³é—­ NUMA"></a>3.3ã€å…³é—­ NUMA</h4><p>åœ¨å…¶ä¸­ä¸€å°masterèŠ‚ç‚¹æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /etc/default/grub&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># åœ¨ GRUB_CMDLINE_LINUX ä¸€è¡Œæ·»åŠ  `numa=off` å‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤º</span></span><br><span class="line"><span class="comment"># cat /etc/default/grub</span></span><br><span class="line">GRUB_TIMEOUT=1</span><br><span class="line">GRUB_DISTRIBUTOR=<span class="string">"<span class="variable">$(sed 's, release .*$,,g' /etc/system-release)</span>"</span></span><br><span class="line">GRUB_DEFAULT=saved</span><br><span class="line">GRUB_DISABLE_SUBMENU=<span class="literal">true</span></span><br><span class="line">GRUB_TERMINAL=<span class="string">"serial console"</span></span><br><span class="line">GRUB_SERIAL_COMMAND=<span class="string">"serial --speed=115200"</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">"console=tty0 crashkernel=auto console=ttyS0,115200"</span></span><br><span class="line">numa=off</span><br><span class="line">GRUB_DISABLE_RECOVERY=<span class="string">"true"</span></span><br></pre></td></tr></table></figure><ul><li>é‡æ–°ç”Ÿæˆ grub2 é…ç½®æ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /boot/grub2/grub.cfg&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥"><a href="#4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥" class="headerlink" title="4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥"></a>4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºç¡®ä¿å®‰å…¨ï¼Œkubernetes ç³»ç»Ÿå„ç»„ä»¶éœ€è¦ä½¿ç”¨ x509 è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚CA (Certificate Authority) æ˜¯è‡ªç­¾åçš„æ ¹è¯ä¹¦ï¼Œç”¨æ¥ç­¾ååç»­åˆ›å»ºçš„å…¶å®ƒè¯ä¹¦ã€‚ä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl åˆ›å»ºæ‰€æœ‰è¯ä¹¦ï¼Œè¯ä¹¦å‡åœ¨ä¸€å°masterèŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œç„¶åé€šè¿‡è¿œç¨‹åˆ†å‘åˆ°å…¶ä»–çš„æœåŠ¡å™¨ä¸Šå»ã€‚</p><ul><li><strong>æ³¨æ„</strong>: æ¯ç”Ÿæˆçš„è¯ä¹¦å‡è¦è¿›è¡Œåˆ†å‘åˆ°å…¶ä»–çš„masterèŠ‚ç‚¹</li></ul><h4 id="4-1ã€å®‰è£…-cfssl-å·¥å…·é›†"><a href="#4-1ã€å®‰è£…-cfssl-å·¥å…·é›†" class="headerlink" title="4.1ã€å®‰è£… cfssl å·¥å…·é›†"></a>4.1ã€å®‰è£… cfssl å·¥å…·é›†</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -o cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="comment"># chmod +x * &amp;&amp;mv cfssl* /usr/bin/</span></span><br><span class="line"><span class="comment"># scp /usr/bin/cfssl* &#123;master-ip&#125;:/usr/bin</span></span><br></pre></td></tr></table></figure><h4 id="4-2ã€åˆ›å»ºæ ¹è¯ä¹¦-CA"><a href="#4-2ã€åˆ›å»ºæ ¹è¯ä¹¦-CA" class="headerlink" title="4.2ã€åˆ›å»ºæ ¹è¯ä¹¦ (CA)"></a>4.2ã€åˆ›å»ºæ ¹è¯ä¹¦ (CA)</h4><p>CA è¯ä¹¦æ˜¯é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹å…±äº«çš„ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ª CA è¯ä¹¦ï¼Œåç»­åˆ›å»ºçš„æ‰€æœ‰è¯ä¹¦éƒ½ç”±å®ƒç­¾åã€‚</p><h4 id="4-3ã€åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#4-3ã€åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="4.3ã€åˆ›å»ºé…ç½®æ–‡ä»¶"></a>4.3ã€åˆ›å»ºé…ç½®æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CA é…ç½®æ–‡ä»¶ç”¨äºé…ç½®æ ¹è¯ä¹¦çš„ä½¿ç”¨åœºæ™¯ (profile) å’Œå…·ä½“å‚æ•° (usageï¼Œè¿‡æœŸæ—¶é—´ã€æœåŠ¡ç«¯è®¤è¯ã€å®¢æˆ·ç«¯è®¤è¯ã€åŠ å¯†ç­‰)ï¼Œåç»­åœ¨ç­¾åå…¶å®ƒè¯ä¹¦æ—¶éœ€è¦æŒ‡å®šç‰¹å®šåœºæ™¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir k8s &amp;&amp; cd k8s#åé¢k8sç”Ÿæˆæ‰€éœ€è¦çš„è¯ä¹¦å‡åœ¨è¯¥ç›®å½•æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><ul><li><p>ca-config.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼Œç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼›</p></li><li><p>server authï¼šè¡¨ç¤º client å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ server æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p></li><li><p>client authï¼šè¡¨ç¤º server å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ client æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p></li></ul><h4 id="4-4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"><a href="#4-4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶" class="headerlink" title="4.4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"></a>4.4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</h4><ul><li><p>ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"ca"</span>: &#123;</span><br><span class="line">    <span class="string">"expiry"</span>: <span class="string">"876000h"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>CNï¼šCommon Nameï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼›</p></li><li><p>Oï¼šOrganizationï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼›</p></li><li><p>kube-apiserver å°†æå–çš„ Userã€Group ä½œä¸º RBAC æˆæƒçš„ç”¨æˆ·æ ‡è¯†ï¼›</p></li><li><p>ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span></span><br><span class="line"><span class="comment"># ls ca*</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/kubernetes/ssl &amp;&amp; cp ca*.pem ca-config.json /etc/kubernetes/ssl</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="5-éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·"><a href="#5-éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="5.éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·"></a>5.éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubectl é»˜è®¤ä» ~/.kube/config æ–‡ä»¶è¯»å– kube-apiserver åœ°å€å’Œè®¤è¯ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ‰§è¡Œ kubectl å‘½ä»¤æ—¶å¯èƒ½ä¼šå‡ºé”™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>:</li></ul><ul><li>1.å¦‚æœæ²¡æœ‰ç‰¹æ®ŠæŒ‡æ˜ï¼Œæœ¬æ–‡æ¡£çš„æ‰€æœ‰æ“ä½œå‡åœ¨ zhangjun-k8s01 èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œç„¶åè¿œç¨‹åˆ†å‘æ–‡ä»¶å’Œæ‰§è¡Œå‘½ä»¤ï¼›</li><li>2.æœ¬æ–‡æ¡£åªéœ€è¦éƒ¨ç½²ä¸€æ¬¡ï¼Œç”Ÿæˆçš„ kubeconfig æ–‡ä»¶æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥æ‹·è´åˆ°éœ€è¦æ‰§è¡Œ kubectl å‘½ä»¤çš„æœºå™¨ï¼Œé‡å‘½åä¸º ~/.kube/configï¼›</li></ul><h4 id="5-1ã€ä¸‹è½½å’Œåˆ†å‘-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#5-1ã€ä¸‹è½½å’Œåˆ†å‘-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="5.1ã€ä¸‹è½½å’Œåˆ†å‘ kubectl äºŒè¿›åˆ¶æ–‡ä»¶"></a>5.1ã€ä¸‹è½½å’Œåˆ†å‘ kubectl äºŒè¿›åˆ¶æ–‡ä»¶</h4><p>è¿™é‡Œå§æŠŠnodeå’Œmasteræ‰€éœ€è¦çš„åŒ…å‡ç»™ä¸€æ¬¡æ€§åˆ†å‘</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.14.6/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-client-linux-amd64.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># master èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp kubernetes/server/bin/&#123;apiextensions-apiserver,cloud-controller-manager,kube-apiserver,kube-controller-manager,kube-proxy,kube-scheduler,kubeadm,kubectl,kubelet,mounter&#125; &#123;master-ip&#125;:/usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># node èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; &#123;node-ip&#125;:/usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="5-2ã€åˆ›å»º-admin-è¯ä¹¦å’Œç§é’¥"><a href="#5-2ã€åˆ›å»º-admin-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="5.2ã€åˆ›å»º admin è¯ä¹¦å’Œç§é’¥"></a>5.2ã€åˆ›å»º admin è¯ä¹¦å’Œç§é’¥</h4><p>kubectl ä¸ apiserver https å®‰å…¨ç«¯å£é€šä¿¡ï¼Œapiserver å¯¹æä¾›çš„è¯ä¹¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚<br>kubectl ä½œä¸ºé›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œéœ€è¦è¢«æˆäºˆæœ€é«˜æƒé™ï¼Œè¿™é‡Œåˆ›å»ºå…·æœ‰<strong>æœ€é«˜æƒé™</strong>çš„ admin è¯ä¹¦ã€‚</p><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; admin-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>O ä¸º system:mastersï¼Œkube-apiserver æ”¶åˆ°è¯¥è¯ä¹¦åå°†è¯·æ±‚çš„ Group è®¾ç½®ä¸º system:mastersï¼›</p></li><li><p>é¢„å®šä¹‰çš„ ClusterRoleBinding cluster-admin å°† Group system:masters ä¸ Role cluster-admin ç»‘å®šï¼Œè¯¥ Role æˆäºˆæ‰€æœ‰ APIçš„æƒé™ï¼›</p></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kubectl å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json  -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></span><br><span class="line"><span class="comment"># ls admin*</span></span><br><span class="line"><span class="comment"># cp admin*.pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="5-3ã€åˆ›å»º-kubeconfig-æ–‡ä»¶"><a href="#5-3ã€åˆ›å»º-kubeconfig-æ–‡ä»¶" class="headerlink" title="5.3ã€åˆ›å»º kubeconfig æ–‡ä»¶"></a>5.3ã€åˆ›å»º kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubeconfig ä¸º kubectl çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«è®¿é—® apiserver çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¦‚ apiserver åœ°å€ã€CA è¯ä¹¦å’Œè‡ªèº«ä½¿ç”¨çš„è¯ä¹¦ï¼›</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤APIåœ°å€</span></span><br><span class="line"><span class="comment"># KUBE_APISERVER="https://172.21.16.45:8443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials admin \</span><br><span class="line">  --client-certificate=admin.pem \</span><br><span class="line">  --client-key=admin-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context kubernetes \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=admin \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=kubectl.kubeconfig</span><br></pre></td></tr></table></figure><ul><li><strong>æç¤º</strong>: åˆ†å‘<code>kubectl.kubeconfig</code>æ–‡ä»¶ï¼Œå§æ–‡ä»¶å‘½å<code>~/.kube/config</code>;</li><li>â€“certificate-authorityï¼šéªŒè¯ kube-apiserver è¯ä¹¦çš„æ ¹è¯ä¹¦ï¼›</li><li>â€“client-certificateã€â€“client-keyï¼šåˆšç”Ÿæˆçš„ admin è¯ä¹¦å’Œç§é’¥ï¼Œè¿æ¥ kube-apiserver æ—¶ä½¿ç”¨ï¼›</li><li>â€“embed-certs=trueï¼šå°† ca.pem å’Œ admin.pem è¯ä¹¦å†…å®¹åµŒå…¥åˆ°ç”Ÿæˆçš„ kubectl.kubeconfig æ–‡ä»¶ä¸­(ä¸åŠ æ—¶ï¼Œå†™å…¥çš„æ˜¯è¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼Œåç»­æ‹·è´ kubeconfig åˆ°å…¶å®ƒæœºå™¨æ—¶ï¼Œè¿˜éœ€è¦å•ç‹¬æ‹·è´è¯ä¹¦æ–‡ä»¶ï¼Œä¸æ–¹ä¾¿ã€‚)ï¼›</li></ul><h3 id="6ã€éƒ¨ç½²etcdé›†ç¾¤"><a href="#6ã€éƒ¨ç½²etcdé›†ç¾¤" class="headerlink" title="6ã€éƒ¨ç½²etcdé›†ç¾¤"></a>6ã€éƒ¨ç½²etcdé›†ç¾¤</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etcd æ˜¯åŸºäº Raft çš„åˆ†å¸ƒå¼ key-value å­˜å‚¨ç³»ç»Ÿï¼Œç”± CoreOS å¼€å‘ï¼Œå¸¸ç”¨äºæœåŠ¡å‘ç°ã€å…±äº«é…ç½®ä»¥åŠå¹¶å‘æ§åˆ¶ï¼ˆå¦‚ leader é€‰ä¸¾ã€åˆ†å¸ƒå¼é”ç­‰ï¼‰ã€‚kubernetes ä½¿ç”¨ etcd å­˜å‚¨æ‰€æœ‰è¿è¡Œæ•°æ®ã€‚</p><p>ä¸‰èŠ‚ç‚¹é«˜å¯ç”¨ etcd é›†ç¾¤çš„æ­¥éª¤ï¼š</p><ul><li>ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶ï¼›</li><li>åˆ›å»º etcd é›†ç¾¤å„èŠ‚ç‚¹çš„ x509 è¯ä¹¦ï¼Œç”¨äºåŠ å¯†å®¢æˆ·ç«¯(å¦‚ etcdctl) ä¸ etcd é›†ç¾¤ã€etcd é›†ç¾¤ä¹‹é—´çš„æ•°æ®æµï¼›</li><li>åˆ›å»º etcd çš„ systemd unit æ–‡ä»¶ï¼Œé…ç½®æœåŠ¡å‚æ•°</li><li>æ£€æŸ¥é›†ç¾¤å·¥ä½œçŠ¶æ€;</li></ul><ul><li><strong>æ³¨æ„</strong>: å‡åœ¨ä¸€å°master<code>[etcd]</code>èŠ‚ç‚¹æ“ä½œï¼Œå…¶ä»–master<code>[etcd]</code>èŠ‚ç‚¹é€šè¿‡åˆ†å‘</li></ul><h4 id="6-1ã€ä¸‹è½½å’Œåˆ†å‘-etcd-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#6-1ã€ä¸‹è½½å’Œåˆ†å‘-etcd-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="6.1ã€ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶"></a>6.1ã€ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir etcd &amp;&amp;cd etcd</span></span><br><span class="line"><span class="comment"># https://github.com/coreos/etcd/releases/download/v3.3.13/etcd-v3.3.13-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xvf etcd-v3.3.13-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># scp etcd* &#123;master-ip&#125;:/usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="6-2ã€åˆ›å»º-etcd-è¯ä¹¦å’Œç§é’¥"><a href="#6-2ã€åˆ›å»º-etcd-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="6.2ã€åˆ›å»º etcd è¯ä¹¦å’Œç§é’¥"></a>6.2ã€åˆ›å»º etcd è¯ä¹¦å’Œç§é’¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; etcd-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"172.21.17.30"</span>,</span><br><span class="line">    <span class="string">"172.21.17.31"</span>,</span><br><span class="line">    <span class="string">"172.21.16.110"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ etcd èŠ‚ç‚¹ IP æˆ–åŸŸååˆ—è¡¨ï¼Œéœ€è¦å°† etcd é›†ç¾¤çš„ä¸‰ä¸ªèŠ‚ç‚¹ IP éƒ½åˆ—åœ¨å…¶ä¸­ï¼›</li><li>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem cfssl gencert -ca=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span></span><br><span class="line"><span class="comment"># ls etcd*pem</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/etcd/ssl &amp;&amp; cp etcd*pem /etc/etcd/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="6-3ã€åˆ›å»º-etcd-çš„-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#6-3ã€åˆ›å»º-etcd-çš„-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="6.3ã€åˆ›å»º etcd çš„ systemd unit æ¨¡æ¿æ–‡ä»¶"></a>6.3ã€åˆ›å»º etcd çš„ systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/systemd/system/etcd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/data</span><br><span class="line">ExecStart=/usr/bin/etcd \</span><br><span class="line">  --data-dir=/var/lib/etcd/data \</span><br><span class="line">  --wal-dir=/var/lib/etcd/wal \</span><br><span class="line">  --name=etcd1 \<span class="comment">#æ ¹æ®èŠ‚ç‚¹åç§°è¿›è¡Œå˜åŒ–</span></span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --listen-peer-urls=https://172.21.17.30:2380 \</span><br><span class="line">  --initial-advertise-peer-urls=https://172.21.17.30:2380 \</span><br><span class="line">  --listen-client-urls=https://172.21.17.30:2379,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls=https://172.21.17.30:2379 \</span><br><span class="line">  --initial-cluster-token=etcd-cluster-0 \</span><br><span class="line">  --initial-cluster=etcd1=https://172.21.17.30:2380,etcd2=https://172.21.17.31:2380,etcd3=https://172.21.16.110:2380 \</span><br><span class="line">  --initial-cluster-state=new \</span><br><span class="line">  --auto-compaction-mode=periodic \</span><br><span class="line">  --auto-compaction-retention=1 \</span><br><span class="line">  --max-request-bytes=33554432 \</span><br><span class="line">  --quota-backend-bytes=6442450944 \</span><br><span class="line">  --heartbeat-interval=250 \</span><br><span class="line">  --election-timeout=2000</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /var/lib/etcd/&#123;data,wal&#125;</span></span><br></pre></td></tr></table></figure><ul><li>WorkingDirectoryã€â€“data-dirï¼šæŒ‡å®šå·¥ä½œç›®å½•å’Œæ•°æ®ç›®å½•ä¸º ${ETCD_DATA_DIR}ï¼Œéœ€åœ¨å¯åŠ¨æœåŠ¡å‰åˆ›å»ºè¿™ä¸ªç›®å½•ï¼›</li><li>â€“wal-dirï¼šæŒ‡å®š wal ç›®å½•ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œä¸€èˆ¬ä½¿ç”¨ SSD æˆ–è€…å’Œ â€“data-dir ä¸åŒçš„ç£ç›˜ï¼›</li><li>â€“nameï¼šæŒ‡å®šèŠ‚ç‚¹åç§°ï¼Œå½“ â€“initial-cluster-state å€¼ä¸º new æ—¶ï¼Œâ€“name çš„å‚æ•°å€¼å¿…é¡»ä½äº â€“initial-cluster åˆ—è¡¨ä¸­ï¼›</li><li>â€“cert-fileã€â€“key-fileï¼šetcd server ä¸ client é€šä¿¡æ—¶ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥ï¼›</li><li>â€“trusted-ca-fileï¼šç­¾å client è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œç”¨äºéªŒè¯ client è¯ä¹¦ï¼›</li><li>â€“peer-cert-fileã€â€“peer-key-fileï¼šetcd ä¸ peer é€šä¿¡ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥ï¼›</li><li>â€“peer-trusted-ca-fileï¼šç­¾å peer è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œç”¨äºéªŒè¯ peer è¯ä¹¦ï¼›</li></ul><h4 id="6-4ã€å¯åŠ¨-etcd-æœåŠ¡"><a href="#6-4ã€å¯åŠ¨-etcd-æœåŠ¡" class="headerlink" title="6.4ã€å¯åŠ¨ etcd æœåŠ¡"></a>6.4ã€å¯åŠ¨ etcd æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd &amp;&amp; systemctl status etcd</span></span><br></pre></td></tr></table></figure><h4 id="6-5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ"><a href="#6-5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ" class="headerlink" title="6.5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ"></a>6.5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ</h4><ul><li>ç¡®ä¿çŠ¶æ€ä¸º active (running)ï¼Œå¦åˆ™æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤åŸå› ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># journalctl -u etcd</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="6-6ã€éªŒè¯æœåŠ¡çŠ¶æ€"><a href="#6-6ã€éªŒè¯æœåŠ¡çŠ¶æ€" class="headerlink" title="6.6ã€éªŒè¯æœåŠ¡çŠ¶æ€"></a>6.6ã€éªŒè¯æœåŠ¡çŠ¶æ€</h4><p>éƒ¨ç½²å®Œ etcd é›†ç¾¤åï¼Œåœ¨ä»»ä¸€ etcd èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">    --endpoints=https://172.21.17.31:2379 \</span><br><span class="line">    --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-key.pem endpoint health</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥è¾“å‡ºå‡ä¸º healthy æ—¶è¡¨ç¤ºé›†ç¾¤æœåŠ¡æ­£å¸¸</p><h4 id="6-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#6-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="6.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>6.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCD_ENDPOINTS="https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379"</span></span><br><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">  -w table --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> endpoint status </span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|  https://172.21.17.30:2379 | 5d23ebc4382fa16f |  3.3.13 |  1.2 MB |     <span class="literal">false</span> |        83 |      58127 |</span><br><span class="line">|  https://172.21.17.31:2379 |  ceaae5134701946 |  3.3.13 |  1.2 MB |     <span class="literal">false</span> |        83 |      58127 |</span><br><span class="line">| https://172.21.16.110:2379 | 575020c8e15d3a06 |  3.3.13 |  1.2 MB |      <span class="literal">true</span> |        83 |      58128 |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></figure><ul><li>å½“å‰çš„ leader ä¸º 172.21.16.110</li></ul><h3 id="7ã€éƒ¨ç½²-flannel-ç½‘ç»œ"><a href="#7ã€éƒ¨ç½²-flannel-ç½‘ç»œ" class="headerlink" title="7ã€éƒ¨ç½² flannel ç½‘ç»œ"></a>7ã€éƒ¨ç½² flannel ç½‘ç»œ</h3><p>flannel ç½‘ç»œéƒ¨ç½²åœ¨nodeèŠ‚ç‚¹ï¼Œè¯ä¹¦åœ¨masterèŠ‚ç‚¹ç”Ÿæˆåˆ†å‘</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubernetes è¦æ±‚é›†ç¾¤å†…å„èŠ‚ç‚¹(åŒ…æ‹¬ master èŠ‚ç‚¹)èƒ½é€šè¿‡ Pod ç½‘æ®µäº’è”äº’é€šã€‚flannel ä½¿ç”¨ vxlan æŠ€æœ¯ä¸ºå„èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªå¯ä»¥äº’é€šçš„ Pod ç½‘ç»œï¼Œä½¿ç”¨çš„ç«¯å£ä¸º UDP 8472ï¼ˆéœ€è¦å¼€æ”¾è¯¥ç«¯å£ï¼‰<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flanneld ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œä» etcd è·å–é…ç½®çš„ Pod ç½‘æ®µä¿¡æ¯ï¼Œä¸ºæœ¬èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªæœªä½¿ç”¨çš„åœ°å€æ®µï¼Œç„¶ååˆ›å»º flannedl.1 ç½‘ç»œæ¥å£ï¼ˆä¹Ÿå¯èƒ½æ˜¯å…¶å®ƒåç§°ï¼Œå¦‚ flannel1 ç­‰ï¼‰<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flannel å°†åˆ†é…ç»™è‡ªå·±çš„ Pod ç½‘æ®µä¿¡æ¯å†™å…¥ /run/flannel/docker æ–‡ä»¶ï¼Œdocker åç»­ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡è®¾ç½® docker0 ç½‘æ¡¥ï¼Œä»è€Œä»è¿™ä¸ªåœ°å€æ®µä¸ºæœ¬èŠ‚ç‚¹çš„æ‰€æœ‰ Pod å®¹å™¨åˆ†é… IPã€‚</p><h4 id="7-1ã€ä¸‹è½½å’Œåˆ†å‘-flanneld-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#7-1ã€ä¸‹è½½å’Œåˆ†å‘-flanneld-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="7.1ã€ä¸‹è½½å’Œåˆ†å‘ flanneld äºŒè¿›åˆ¶æ–‡ä»¶"></a>7.1ã€ä¸‹è½½å’Œåˆ†å‘ flanneld äºŒè¿›åˆ¶æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir flannel &amp;&amp;cd flannel</span></span><br><span class="line"><span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzvf flannel-v0.11.0-linux-amd64.tar.gz -C flannel</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†å‘flanneld å¯æ‰§è¡Œæ–‡ä»¶åˆ°nodeèŠ‚ç‚¹</li></ul><h4 id="7-2ã€åˆ›å»º-flannel-è¯ä¹¦å’Œç§é’¥"><a href="#7-2ã€åˆ›å»º-flannel-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="7.2ã€åˆ›å»º flannel è¯ä¹¦å’Œç§é’¥"></a>7.2ã€åˆ›å»º flannel è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>flanneld-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; flanneld-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"flanneld"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kubectl å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld </span></span><br><span class="line"><span class="comment"># ls flanneld*pem</span></span><br><span class="line"><span class="comment"># scp flanneld*pem &#123;node-ip&#125;:/etc/flanneld/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="7-3ã€å‘-etcd-å†™å…¥é›†ç¾¤-Pod-ç½‘æ®µä¿¡æ¯"><a href="#7-3ã€å‘-etcd-å†™å…¥é›†ç¾¤-Pod-ç½‘æ®µä¿¡æ¯" class="headerlink" title="7.3ã€å‘ etcd å†™å…¥é›†ç¾¤ Pod ç½‘æ®µä¿¡æ¯"></a>7.3ã€å‘ etcd å†™å…¥é›†ç¾¤ Pod ç½‘æ®µä¿¡æ¯</h4><p><strong>æ³¨æ„</strong>ï¼šæœ¬æ­¥éª¤åªéœ€æ‰§è¡Œä¸€æ¬¡ã€‚åœ¨etcdé›†ç¾¤ä¸Šæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=flanneld.pem \</span><br><span class="line">  --key-file=flanneld-key.pem \</span><br><span class="line">  mk /kubernetes/network/config <span class="string">'&#123;"Network":"172.30.0.0/16", "SubnetLen": 21, "Backend": &#123;"Type": "vxlan"&#125;&#125;'</span></span><br></pre></td></tr></table></figure><ul><li>flanneld å½“å‰ç‰ˆæœ¬ (v0.11.0) ä¸æ”¯æŒ etcd v3ï¼Œæ•…ä½¿ç”¨ etcd v2 API å†™å…¥é…ç½® key å’Œç½‘æ®µæ•°æ®ï¼›</li><li>å†™å…¥çš„ Pod ç½‘æ®µ ${CLUSTER_CIDR} åœ°å€æ®µï¼ˆå¦‚ /16ï¼‰å¿…é¡»å°äº SubnetLenï¼Œå¿…é¡»ä¸ kube-controller-manager çš„ â€“cluster-cidr å‚æ•°å€¼ä¸€è‡´ï¼›</li></ul><h4 id="7-4ã€åˆ›å»º-flanneld-çš„-systemd-unit-æ–‡ä»¶"><a href="#7-4ã€åˆ›å»º-flanneld-çš„-systemd-unit-æ–‡ä»¶" class="headerlink" title="7.4ã€åˆ›å»º flanneld çš„ systemd unit æ–‡ä»¶"></a>7.4ã€åˆ›å»º flanneld çš„ systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/flanneld.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=etcd.service</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/flanneld \</span><br><span class="line">  -etcd-cafile=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  -etcd-certfile=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  -etcd-keyfile=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  -etcd-endpoints=https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379 \</span><br><span class="line">  -etcd-prefix=/kubernetes/network \</span><br><span class="line">  -iface=eth0 \</span><br><span class="line">  -ip-masq</span><br><span class="line">ExecStartPost=/usr/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">RequiredBy=docker.service</span><br></pre></td></tr></table></figure><ul><li>mk-docker-opts.sh è„šæœ¬å°†åˆ†é…ç»™ flanneld çš„ Pod å­ç½‘æ®µä¿¡æ¯å†™å…¥ /run/flannel/docker æ–‡ä»¶ï¼Œåç»­ docker å¯åŠ¨æ—¶ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡é…ç½® docker0 ç½‘æ¡¥ï¼›</li><li>flanneld ä½¿ç”¨ç³»ç»Ÿç¼ºçœè·¯ç”±æ‰€åœ¨çš„æ¥å£ä¸å…¶å®ƒèŠ‚ç‚¹é€šä¿¡ï¼Œå¯¹äºæœ‰å¤šä¸ªç½‘ç»œæ¥å£ï¼ˆå¦‚å†…ç½‘å’Œå…¬ç½‘ï¼‰çš„èŠ‚ç‚¹ï¼Œå¯ä»¥ç”¨ -iface å‚æ•°æŒ‡å®šé€šä¿¡æ¥å£;</li><li>flanneld è¿è¡Œæ—¶éœ€è¦ root æƒé™ï¼›</li><li>-ip-masq: flanneld ä¸ºè®¿é—® Pod ç½‘ç»œå¤–çš„æµé‡è®¾ç½® SNAT è§„åˆ™ï¼ŒåŒæ—¶å°†ä¼ é€’ç»™ Docker çš„å˜é‡ â€“ip-masqï¼ˆ/run/flannel/docker æ–‡ä»¶ä¸­ï¼‰è®¾ç½®ä¸º falseï¼Œè¿™æ · Docker å°†ä¸å†åˆ›å»º SNAT è§„åˆ™ï¼› Docker çš„ â€“ip-masq ä¸º true æ—¶ï¼Œåˆ›å»ºçš„ SNAT è§„åˆ™æ¯”è¾ƒâ€œæš´åŠ›â€ï¼šå°†æ‰€æœ‰æœ¬èŠ‚ç‚¹ Pod å‘èµ·çš„ã€è®¿é—®é docker0 æ¥å£çš„è¯·æ±‚åš SNATï¼Œè¿™æ ·è®¿é—®å…¶ä»–èŠ‚ç‚¹ Pod çš„è¯·æ±‚æ¥æº IP ä¼šè¢«è®¾ç½®ä¸º flannel.1 æ¥å£çš„ IPï¼Œå¯¼è‡´ç›®çš„ Pod çœ‹ä¸åˆ°çœŸå®çš„æ¥æº Pod IPã€‚ flanneld åˆ›å»ºçš„ SNAT è§„åˆ™æ¯”è¾ƒæ¸©å’Œï¼Œåªå¯¹è®¿é—®é Pod ç½‘æ®µçš„è¯·æ±‚åš SNATã€‚</li></ul><h4 id="7-5ã€å¯åŠ¨-flanneld-æœåŠ¡"><a href="#7-5ã€å¯åŠ¨-flanneld-æœåŠ¡" class="headerlink" title="7.5ã€å¯åŠ¨ flanneld æœåŠ¡"></a>7.5ã€å¯åŠ¨ flanneld æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable flanneld &amp;&amp; systemctl restart flanneld &amp;&amp; systemctl status flanneld</span></span><br></pre></td></tr></table></figure><h4 id="7-6ã€æ£€æŸ¥åˆ†é…ç»™å„-flanneld-çš„-Pod-ç½‘æ®µä¿¡æ¯"><a href="#7-6ã€æ£€æŸ¥åˆ†é…ç»™å„-flanneld-çš„-Pod-ç½‘æ®µä¿¡æ¯" class="headerlink" title="7.6ã€æ£€æŸ¥åˆ†é…ç»™å„ flanneld çš„ Pod ç½‘æ®µä¿¡æ¯"></a>7.6ã€æ£€æŸ¥åˆ†é…ç»™å„ flanneld çš„ Pod ç½‘æ®µä¿¡æ¯</h4><ul><li><p>æŸ¥çœ‹é›†ç¾¤ Pod ç½‘æ®µ(/16)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  get /kubernetes/network/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 21, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å·²åˆ†é…çš„ Pod å­ç½‘æ®µåˆ—è¡¨(/24):</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  ls /kubernetes/network/subnets</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">/kubernetes/network/subnets/172.30.232.0-21</span><br><span class="line">/kubernetes/network/subnets/172.30.128.0-21</span><br><span class="line">/kubernetes/network/subnets/172.30.176.0-21</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æŸä¸€ Pod ç½‘æ®µå¯¹åº”çš„èŠ‚ç‚¹ IP å’Œ flannel æ¥å£åœ°å€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  get /kubernetes/network/subnets/172.30.232.0-21</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"172.21.16.204"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"f6:50:05:5c:9a:20"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>172.30.232.0/21 è¢«åˆ†é…ç»™èŠ‚ç‚¹172.21.16.204ï¼‰ï¼›</p></li><li><p>VtepMAC ä¸º172.21.16.204èŠ‚ç‚¹çš„ flannel.1 ç½‘å¡ MAC åœ°å€ï¼›</p></li></ul><h4 id="7-7ã€æ£€æŸ¥èŠ‚ç‚¹-flannel-ç½‘ç»œä¿¡æ¯"><a href="#7-7ã€æ£€æŸ¥èŠ‚ç‚¹-flannel-ç½‘ç»œä¿¡æ¯" class="headerlink" title="7.7ã€æ£€æŸ¥èŠ‚ç‚¹ flannel ç½‘ç»œä¿¡æ¯"></a>7.7ã€æ£€æŸ¥èŠ‚ç‚¹ flannel ç½‘ç»œä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip addr show</span></span><br></pre></td></tr></table></figure><ul><li><p>flannel.1 ç½‘å¡çš„åœ°å€ä¸ºåˆ†é…çš„ Pod å­ç½‘æ®µçš„ç¬¬ä¸€ä¸ª IPï¼ˆ.0ï¼‰ï¼Œä¸”æ˜¯ /32 çš„åœ°å€ï¼›</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip route show |grep flannel.1</span></span><br><span class="line">172.30.128.0/21 via 172.30.128.0 dev flannel.1 onlink </span><br><span class="line">172.30.176.0/21 via 172.30.176.0 dev flannel.1 onlink</span><br></pre></td></tr></table></figure></li><li><p>åˆ°å…¶å®ƒèŠ‚ç‚¹ Pod ç½‘æ®µè¯·æ±‚éƒ½è¢«è½¬å‘åˆ° flannel.1 ç½‘å¡ï¼›</p></li><li><p>flanneld æ ¹æ® etcd ä¸­å­ç½‘æ®µçš„ä¿¡æ¯ï¼Œå¦‚/kubernetes/network/subnets/172.30.232.0-21 ï¼Œæ¥å†³å®šè¿›è¯·æ±‚å‘é€ç»™å“ªä¸ªèŠ‚ç‚¹çš„äº’è” IPï¼›</p></li><li><p>éªŒè¯å„èŠ‚ç‚¹èƒ½é€šè¿‡ Pod ç½‘æ®µäº’é€š</p></li></ul><h3 id="8ã€masterèŠ‚ç‚¹éƒ¨ç½²"><a href="#8ã€masterèŠ‚ç‚¹éƒ¨ç½²" class="headerlink" title="8ã€masterèŠ‚ç‚¹éƒ¨ç½²"></a>8ã€masterèŠ‚ç‚¹éƒ¨ç½²</h3><p>kubernetes master èŠ‚ç‚¹è¿è¡Œå¦‚ä¸‹ç»„ä»¶ï¼š</p><ul><li>kube-apiserver</li><li>kube-scheduler</li><li>kube-controller-manager<br>kube-apiserverã€kube-scheduler å’Œ kube-controller-manager å‡ä»¥å¤šå®ä¾‹æ¨¡å¼è¿è¡Œï¼š<br>1ã€kube-scheduler å’Œ kube-controller-manager ä¼šè‡ªåŠ¨é€‰ä¸¾äº§ç”Ÿä¸€ä¸ª leader å®ä¾‹ï¼Œå…¶å®ƒå®ä¾‹å¤„äºé˜»å¡æ¨¡å¼ï¼Œå½“ leader æŒ‚äº†åï¼Œé‡æ–°é€‰ä¸¾äº§ç”Ÿæ–°çš„ leaderï¼Œä»è€Œä¿è¯æœåŠ¡å¯ç”¨æ€§ï¼›<br>2ã€kube-apiserver æ˜¯æ— çŠ¶æ€çš„ï¼Œéœ€è¦é€šè¿‡<a href="https://xxlaila.github.io/2019/08/10/haproxy-keepalived/" target="_blank" rel="noopener">haproxy+keepalived</a>è¿›è¡Œä»£ç†è®¿é—®ï¼Œä»è€Œä¿è¯æœåŠ¡å¯ç”¨æ€§ï¼›</li></ul><h4 id="8-1ã€åˆ›å»º-kubernetes-è¯ä¹¦å’Œç§é’¥"><a href="#8-1ã€åˆ›å»º-kubernetes-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="8.1ã€åˆ›å»º kubernetes è¯ä¹¦å’Œç§é’¥"></a>8.1ã€åˆ›å»º kubernetes è¯ä¹¦å’Œç§é’¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kubernetes-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"172.21.17.30"</span>,</span><br><span class="line">    <span class="string">"172.21.17.31"</span>,</span><br><span class="line">    <span class="string">"172.21.16.110"</span>,</span><br><span class="line">    <span class="string">"172.21.16.45"</span>,</span><br><span class="line">    <span class="string">"10.254.0.1"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local."</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><p>hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ IP å’ŒåŸŸååˆ—è¡¨ï¼Œè¿™é‡Œåˆ—å‡ºäº† master èŠ‚ç‚¹ IPã€kubernetes æœåŠ¡çš„ IP å’ŒåŸŸå,ä»¥åŠVIPåœ°å€ï¼›</p></li><li><p>kubernetes æœåŠ¡ IP æ˜¯ apiserver è‡ªåŠ¨åˆ›å»ºçš„ï¼Œä¸€èˆ¬æ˜¯ â€“service-cluster-ip-range å‚æ•°æŒ‡å®šçš„ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIP,åç»­å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤è·å–ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc kubernetes</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.254.0.1   &lt;none&gt;        443/TCP   4h13m</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span></span><br><span class="line"><span class="comment"># ls kubernetes*pem</span></span><br><span class="line">kubernetes-key.pem  kubernetes.pem</span><br><span class="line"><span class="comment"># cp kubernetes*pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="8-2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶"><a href="#8-2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶" class="headerlink" title="8.2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶"></a>8.2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)</span></span><br><span class="line"><span class="comment"># cat &gt; encryption-config.yaml &lt;&lt;EOF</span></span><br><span class="line">kind: EncryptionConfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">resources:</span><br><span class="line">  - resources:</span><br><span class="line">      - secrets</span><br><span class="line">    providers:</span><br><span class="line">      - aescbc:</span><br><span class="line">          keys:</span><br><span class="line">            - name: key1</span><br><span class="line">              secret: <span class="variable">$&#123;ENCRYPTION_KEY&#125;</span></span><br><span class="line">      - identity: &#123;&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># cp encryption-config.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="8-3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"><a href="#8-3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶" class="headerlink" title="8.3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"></a>8.3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; audit-policy.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: audit.k8s.io/v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># The following requests were manually identified as high-volume and low-risk, so drop them.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">          - services</span><br><span class="line">          - services/status</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-proxy'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes</span><br><span class="line">          - nodes/status</span><br><span class="line">    userGroups:</span><br><span class="line">      - <span class="string">'system:nodes'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    namespaces:</span><br><span class="line">      - kube-system</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">      - <span class="string">'system:kube-scheduler'</span></span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:endpoint-controller'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - namespaces</span><br><span class="line">          - namespaces/status</span><br><span class="line">          - namespaces/finalize</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:apiserver'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log HPA fetching metrics.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log these read-only URLs.</span></span><br><span class="line">  - level: None</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">      - <span class="string">'/healthz*'</span></span><br><span class="line">      - /version</span><br><span class="line">      - <span class="string">'/swagger*'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log events requests.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - events</span><br><span class="line"></span><br><span class="line">  <span class="comment"># node and pod status calls from nodes are high-volume and can be large, don't log responses for expected updates from nodes</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes/status</span><br><span class="line">          - pods/status</span><br><span class="line">    users:</span><br><span class="line">      - kubelet</span><br><span class="line">      - <span class="string">'system:node-problem-detector'</span></span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:node-problem-detector'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes/status</span><br><span class="line">          - pods/status</span><br><span class="line">    userGroups:</span><br><span class="line">      - <span class="string">'system:nodes'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  <span class="comment"># deletecollection calls can be large, don't log responses for expected namespace deletions</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:namespace-controller'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - deletecollection</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span><br><span class="line">  <span class="comment"># so only log at the Metadata level.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - secrets</span><br><span class="line">          - configmaps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">        resources:</span><br><span class="line">          - tokenreviews</span><br><span class="line">  <span class="comment"># Get repsonses can be large; skip them.</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default level for known APIs</span></span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">      </span><br><span class="line">  <span class="comment"># Default level for all other requests.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp audit-policy.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="8-4ã€åˆ›å»ºåç»­è®¿é—®-metrics-server-ä½¿ç”¨çš„è¯ä¹¦"><a href="#8-4ã€åˆ›å»ºåç»­è®¿é—®-metrics-server-ä½¿ç”¨çš„è¯ä¹¦" class="headerlink" title="8.4ã€åˆ›å»ºåç»­è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦"></a>8.4ã€åˆ›å»ºåç»­è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; proxy-client-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"aggregator"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>CN åç§°éœ€è¦ä½äº kube-apiserver çš„ â€“requestheader-allowed-names å‚æ•°ä¸­ï¼Œå¦åˆ™åç»­è®¿é—® metrics æ—¶ä¼šæç¤ºæƒé™ä¸è¶³ã€‚</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem  -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes proxy-client-csr.json | cfssljson -bare proxy-client</span></span><br><span class="line"><span class="comment"># ls proxy-client*.pem</span></span><br><span class="line">proxy-client-key.pem  proxy-client.pem</span><br><span class="line"><span class="comment"># cp proxy-client*.pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="8-5ã€åˆ›å»º-kube-apiserver-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#8-5ã€åˆ›å»º-kube-apiserver-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="8.5ã€åˆ›å»º kube-apiserver systemd unit æ¨¡æ¿æ–‡ä»¶"></a>8.5ã€åˆ›å»º kube-apiserver systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-apiserver</span><br><span class="line">ExecStart=/usr/bin/kube-apiserver \</span><br><span class="line">  --advertise-address=172.21.17.30 \<span class="comment">#master èŠ‚ç‚¹çš„ip</span></span><br><span class="line">  --default-not-ready-toleration-seconds=360 \</span><br><span class="line">  --default-unreachable-toleration-seconds=360 \</span><br><span class="line">  --feature-gates=DynamicAuditing=<span class="literal">true</span> \</span><br><span class="line">  --max-mutating-requests-inflight=2000 \</span><br><span class="line">  --max-requests-inflight=4000 \</span><br><span class="line">  --default-watch-cache-size=200 \</span><br><span class="line">  --delete-collection-workers=2 \</span><br><span class="line">  --encryption-provider-config=/etc/kubernetes/encryption-config.yaml \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --etcd-servers=https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379 \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --insecure-port=0 \</span><br><span class="line">  --audit-dynamic-configuration \</span><br><span class="line">  --audit-log-maxage=15 \</span><br><span class="line">  --audit-log-maxbackup=3 \</span><br><span class="line">  --audit-log-maxsize=100 \</span><br><span class="line">  --audit-log-truncate-enabled \</span><br><span class="line">  --audit-log-path=/var/<span class="built_in">log</span>/k8s/kube-apiserver/audit.log \</span><br><span class="line">  --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span><br><span class="line">  --profiling \</span><br><span class="line">  --anonymous-auth=<span class="literal">false</span> \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --<span class="built_in">enable</span>-bootstrap-token-auth \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">"aggregator"</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --runtime-config=api/all=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">enable</span>-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,TaintNodesByCondition,Priority,DefaultTolerationSeconds,DefaultStorageClass,PersistentVolumeClaimResize,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --apiserver-count=3 \</span><br><span class="line">  --event-ttl=168h \</span><br><span class="line">  --kubelet-certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --kubelet-https=<span class="literal">true</span> \</span><br><span class="line">  --kubelet-timeout=10s \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/ssl/proxy-client.pem \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/ssl/proxy-client-key.pem \</span><br><span class="line">  --service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">  --service-node-port-range=30000-32767 \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">enable</span>-aggregator-routing=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-apiserver</span></span><br></pre></td></tr></table></figure><ul><li>â€“advertise-addressï¼šapiserver å¯¹å¤–é€šå‘Šçš„ IPï¼ˆkubernetes æœåŠ¡åç«¯èŠ‚ç‚¹ IPï¼‰ï¼›</li><li>â€“default-*-toleration-secondsï¼šè®¾ç½®èŠ‚ç‚¹å¼‚å¸¸ç›¸å…³çš„é˜ˆå€¼ï¼›</li><li>â€“max-*-requests-inflightï¼šè¯·æ±‚ç›¸å…³çš„æœ€å¤§é˜ˆå€¼ï¼›</li><li>â€“etcd-*ï¼šè®¿é—® etcd çš„è¯ä¹¦å’Œ etcd æœåŠ¡å™¨åœ°å€ï¼›</li><li>â€“experimental-encryption-provider-configï¼šæŒ‡å®šç”¨äºåŠ å¯† etcd ä¸­ secret çš„é…ç½®ï¼›</li><li>â€“bind-addressï¼š https ç›‘å¬çš„ IPï¼Œä¸èƒ½ä¸º 127.0.0.1ï¼Œå¦åˆ™å¤–ç•Œä¸èƒ½è®¿é—®å®ƒçš„å®‰å…¨ç«¯å£ 6443ï¼›</li><li>â€“secret-portï¼šhttps ç›‘å¬ç«¯å£ï¼›</li><li>â€“insecure-port=0ï¼šå…³é—­ç›‘å¬ http éå®‰å…¨ç«¯å£(8080)ï¼›</li><li>â€“tls-*-fileï¼šæŒ‡å®š apiserver ä½¿ç”¨çš„è¯ä¹¦ã€ç§é’¥å’Œ CA æ–‡ä»¶ï¼›</li><li>â€“audit-*ï¼šé…ç½®å®¡è®¡ç­–ç•¥å’Œå®¡è®¡æ—¥å¿—æ–‡ä»¶ç›¸å…³çš„å‚æ•°ï¼›</li><li>â€“client-ca-fileï¼šéªŒè¯ client (kue-controller-managerã€kube-schedulerã€kubeletã€kube-proxy ç­‰)è¯·æ±‚æ‰€å¸¦çš„è¯ä¹¦ï¼›</li><li>â€“enable-bootstrap-token-authï¼šå¯ç”¨ kubelet bootstrap çš„ token è®¤è¯ï¼›</li><li>â€“requestheader-*ï¼škube-apiserver çš„ aggregator layer ç›¸å…³çš„é…ç½®å‚æ•°ï¼Œproxy-client &amp; HPA éœ€è¦ä½¿ç”¨ï¼›</li><li>â€“requestheader-client-ca-fileï¼šç”¨äºç­¾å â€“proxy-client-cert-file å’Œ â€“proxy-client-key-file æŒ‡å®šçš„è¯ä¹¦ï¼›åœ¨å¯ç”¨äº† metric aggregator æ—¶ä½¿ç”¨ï¼›</li><li>â€“requestheader-allowed-namesï¼šä¸èƒ½ä¸ºç©ºï¼Œå€¼ä¸ºé€—å·åˆ†å‰²çš„ â€“proxy-client-cert-file è¯ä¹¦çš„ CN åç§°ï¼Œè¿™é‡Œè®¾ç½®ä¸º â€œaggregatorâ€ï¼›</li><li>â€“service-account-key-fileï¼šç­¾å ServiceAccount Token çš„å…¬é’¥æ–‡ä»¶ï¼Œkube-controller-manager çš„ â€“service-account-private-key-file æŒ‡å®šç§é’¥æ–‡ä»¶ï¼Œä¸¤è€…é…å¯¹ä½¿ç”¨ï¼›</li><li>â€“runtime-config=api/all=trueï¼š å¯ç”¨æ‰€æœ‰ç‰ˆæœ¬çš„ APIsï¼Œå¦‚ autoscaling/v2alpha1ï¼›</li><li>â€“authorization-mode=Node,RBACã€â€“anonymous-auth=falseï¼š å¼€å¯ Node å’Œ RBAC æˆæƒæ¨¡å¼ï¼Œæ‹’ç»æœªæˆæƒçš„è¯·æ±‚ï¼›</li><li>â€“enable-admission-pluginsï¼šå¯ç”¨ä¸€äº›é»˜è®¤å…³é—­çš„ pluginsï¼›</li><li>â€“allow-privilegedï¼šè¿è¡Œæ‰§è¡Œ privileged æƒé™çš„å®¹å™¨ï¼›</li><li>â€“apiserver-count=3ï¼šæŒ‡å®š apiserver å®ä¾‹çš„æ•°é‡ï¼›</li><li>â€“event-ttlï¼šæŒ‡å®š events çš„ä¿å­˜æ—¶é—´ï¼›</li><li>â€“kubelet-<em>ï¼šå¦‚æœæŒ‡å®šï¼Œåˆ™ä½¿ç”¨ https è®¿é—® kubelet APIsï¼›éœ€è¦ä¸ºè¯ä¹¦å¯¹åº”çš„ç”¨æˆ·(ä¸Šé¢ kubernetes</em>.pem è¯ä¹¦çš„ç”¨æˆ·ä¸º kubernetes) ç”¨æˆ·å®šä¹‰ RBAC è§„åˆ™ï¼Œå¦åˆ™è®¿é—® kubelet API æ—¶æç¤ºæœªæˆæƒï¼›</li><li>â€“proxy-client-*ï¼šapiserver è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦ï¼›</li><li>â€“service-cluster-ip-rangeï¼š æŒ‡å®š Service Cluster IP åœ°å€æ®µï¼›</li><li>â€“service-node-port-rangeï¼š æŒ‡å®š NodePort çš„ç«¯å£èŒƒå›´ï¼›</li><li>å¦‚æœ kube-apiserver æœºå™¨æ²¡æœ‰è¿è¡Œ kube-proxyï¼Œåˆ™è¿˜éœ€è¦æ·»åŠ  â€“enable-aggregator-routing=true å‚æ•°</li></ul><p><strong>æ³¨æ„</strong>:<br>1.requestheader-client-ca-file æŒ‡å®šçš„ CA è¯ä¹¦ï¼Œå¿…é¡»å…·æœ‰ client auth and server authï¼›<br>2.å¦‚æœ â€“requestheader-allowed-names ä¸ºç©ºï¼Œæˆ–è€… â€“proxy-client-cert-file è¯ä¹¦çš„ CN åç§°ä¸åœ¨ allowed-names ä¸­ï¼Œåˆ™åç»­æŸ¥çœ‹ node æˆ– pods çš„ metrics å¤±è´¥ï¼Œæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl top nodes</span></span><br><span class="line">Error from server (Forbidden): nodes.metrics.k8s.io is forbidden: User <span class="string">"aggregator"</span> cannot list resource <span class="string">"nodes"</span> <span class="keyword">in</span> API group <span class="string">"metrics.k8s.io"</span> at the cluster scope</span><br></pre></td></tr></table></figure><h4 id="8-6ã€å¯åŠ¨-kube-apiserver-æœåŠ¡"><a href="#8-6ã€å¯åŠ¨-kube-apiserver-æœåŠ¡" class="headerlink" title="8.6ã€å¯åŠ¨ kube-apiserver æœåŠ¡"></a>8.6ã€å¯åŠ¨ kube-apiserver æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver &amp;&amp;systemctl status kube-apiserver</span></span><br><span class="line"><span class="comment"># systemctl status kube-apiserver |grep 'Active:'</span></span><br><span class="line">   Active: active (running) since Mon 2019-09-16 14:38:31 CST; 1min 41s ago</span><br></pre></td></tr></table></figure><h4 id="8-6ã€æ‰“å°-kube-apiserver-å†™å…¥-etcd-çš„æ•°æ®"><a href="#8-6ã€æ‰“å°-kube-apiserver-å†™å…¥-etcd-çš„æ•°æ®" class="headerlink" title="8.6ã€æ‰“å° kube-apiserver å†™å…¥ etcd çš„æ•°æ®"></a>8.6ã€æ‰“å° kube-apiserver å†™å…¥ etcd çš„æ•°æ®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">    --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">    --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">    get /registry/ --prefix --keys-only</span><br></pre></td></tr></table></figure><h4 id="8-9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯"><a href="#8-9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯" class="headerlink" title="8.9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯"></a>8.9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl cluster-info</span></span><br><span class="line">Kubernetes master is running at https://172.21.16.45:8443</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get all --all-namespaces</span></span><br><span class="line">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default     service/kubernetes   ClusterIP   10.254.0.1   &lt;none&gt;        443/TCP   12m</span><br><span class="line"></span><br><span class="line"><span class="comment">#  kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused</span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused</span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œ kubectl get componentstatuses å‘½ä»¤æ—¶ï¼Œapiserver é»˜è®¤å‘ 127.0.0.1 å‘é€è¯·æ±‚ã€‚å½“ controller-managerã€scheduler ä»¥é›†ç¾¤æ¨¡å¼è¿è¡Œæ—¶ï¼Œæœ‰å¯èƒ½å’Œ kube-apiserver ä¸åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œè¿™æ—¶ controller-manager æˆ– scheduler çš„çŠ¶æ€ä¸º Unhealthyï¼Œä½†å®é™…ä¸Šå®ƒä»¬å·¥ä½œæ­£å¸¸ã€‚</li></ul><h4 id="8-10ã€æ£€æŸ¥-kube-apiserver-ç›‘å¬çš„ç«¯å£"><a href="#8-10ã€æ£€æŸ¥-kube-apiserver-ç›‘å¬çš„ç«¯å£" class="headerlink" title="8.10ã€æ£€æŸ¥ kube-apiserver ç›‘å¬çš„ç«¯å£"></a>8.10ã€æ£€æŸ¥ kube-apiserver ç›‘å¬çš„ç«¯å£</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kube</span></span><br><span class="line">tcp6       0      0 :::6443                 :::*                    LISTEN      10845/kube-apiserve</span><br></pre></td></tr></table></figure><ul><li>6443: æ¥æ”¶ https è¯·æ±‚çš„å®‰å…¨ç«¯å£ï¼Œå¯¹æ‰€æœ‰è¯·æ±‚åšè®¤è¯å’Œæˆæƒï¼›</li><li>ç”±äºå…³é—­äº†éå®‰å…¨ç«¯å£ï¼Œæ•…æ²¡æœ‰ç›‘å¬ 8080ï¼›</li></ul><h4 id="8-11ã€æˆäºˆ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™"><a href="#8-11ã€æˆäºˆ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™" class="headerlink" title="8.11ã€æˆäºˆ kube-apiserver è®¿é—® kubelet API çš„æƒé™"></a>8.11ã€æˆäºˆ kube-apiserver è®¿é—® kubelet API çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰§è¡Œ kubectl execã€runã€logs ç­‰å‘½ä»¤æ—¶ï¼Œapiserver ä¼šå°†è¯·æ±‚è½¬å‘åˆ° kubelet çš„ https ç«¯å£ã€‚è¿™é‡Œå®šä¹‰ RBAC è§„åˆ™ï¼Œæˆæƒ apiserver ä½¿ç”¨çš„è¯ä¹¦ï¼ˆkubernetes.pemï¼‰ç”¨æˆ·åï¼ˆCNï¼škuberntesï¼‰è®¿é—® kubelet API çš„æƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span><br></pre></td></tr></table></figure><h3 id="9ã€éƒ¨ç½²é«˜å¯ç”¨-kube-controller-manager"><a href="#9ã€éƒ¨ç½²é«˜å¯ç”¨-kube-controller-manager" class="headerlink" title="9ã€éƒ¨ç½²é«˜å¯ç”¨ kube-controller-manager"></a>9ã€éƒ¨ç½²é«˜å¯ç”¨ kube-controller-manager</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥é›†ç¾¤åŒ…å« 3 ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨åå°†é€šè¿‡ç«äº‰é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“ leader èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œé˜»å¡çš„èŠ‚ç‚¹å°†å†æ¬¡è¿›è¡Œé€‰ä¸¾äº§ç”Ÿæ–°çš„ leader èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚<br>ä¸ºä¿è¯é€šä¿¡å®‰å…¨ï¼Œæœ¬æ–‡æ¡£å…ˆç”Ÿæˆ x509 è¯ä¹¦å’Œç§é’¥ï¼Œkube-controller-manager åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥è¯ä¹¦ï¼š<br>1ã€ä¸ kube-apiserver çš„å®‰å…¨ç«¯å£é€šä¿¡;<br>2ã€åœ¨å®‰å…¨ç«¯å£(httpsï¼Œ10252) è¾“å‡º prometheus æ ¼å¼çš„ metricsï¼›</p><h4 id="9-1ã€åˆ›å»º-kube-controller-manager-è¯ä¹¦å’Œç§é’¥"><a href="#9-1ã€åˆ›å»º-kube-controller-manager-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="9.1ã€åˆ›å»º kube-controller-manager è¯ä¹¦å’Œç§é’¥"></a>9.1ã€åˆ›å»º kube-controller-manager è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.21.17.30"</span>,</span><br><span class="line">      <span class="string">"172.21.17.31"</span>,</span><br><span class="line">      <span class="string">"172.21.16.110"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>hosts åˆ—è¡¨åŒ…å«æ‰€æœ‰ kube-controller-manager èŠ‚ç‚¹ IPï¼›</p></li><li><p>CN å’Œ O å‡ä¸º system:kube-controller-managerï¼Œkubernetes å†…ç½®çš„ ClusterRoleBindings system:kube-controller-manager èµ‹äºˆ kube-controller-manager å·¥ä½œæ‰€éœ€çš„æƒé™ã€‚</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json   -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span><br><span class="line"><span class="comment"># ls kube-controller-manager*pem</span></span><br><span class="line">kube-controller-manager-key.pem  kube-controller-manager.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-controller-manager*pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="9-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#9-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="9.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>9.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-controller-manager ä½¿ç”¨ kubeconfig æ–‡ä»¶è®¿é—® apiserverï¼Œè¯¥æ–‡ä»¶æä¾›äº† apiserver åœ°å€ã€åµŒå…¥çš„ CA è¯ä¹¦å’Œ kube-controller-manager è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials system:kube-controller-manager \</span></span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context system:kube-controller-manager \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-controller-manager.kubeconfig /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="9-3ã€åˆ›å»º-kube-controller-manager-systemd-unitæ–‡ä»¶"><a href="#9-3ã€åˆ›å»º-kube-controller-manager-systemd-unitæ–‡ä»¶" class="headerlink" title="9.3ã€åˆ›å»º kube-controller-manager systemd unitæ–‡ä»¶"></a>9.3ã€åˆ›å»º kube-controller-manager systemd unitæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-controller-manager.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-controller-manager</span><br><span class="line">ExecStart=/usr/bin/kube-controller-manager \</span><br><span class="line">  --profiling \</span><br><span class="line">  --cluster-name=kubernetes \</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">  --kube-api-qps=1000 \</span><br><span class="line">  --kube-api-burst=2000 \</span><br><span class="line">  --leader-elect \</span><br><span class="line">  --use-service-account-credentials\</span><br><span class="line">  --concurrent-service-syncs=2 \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=10252 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span><br><span class="line">  --port=0 \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">""</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --experimental-cluster-signing-duration=876000h \</span><br><span class="line">  --horizontal-pod-autoscaler-sync-period=10s \</span><br><span class="line">  --horizontal-pod-autoscaler-use-rest-clients=<span class="literal">true</span> \</span><br><span class="line">  --concurrent-deployment-syncs=10 \</span><br><span class="line">  --concurrent-gc-syncs=30 \</span><br><span class="line">  --node-cidr-mask-size=24 \</span><br><span class="line">  --service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">  --pod-eviction-timeout=6m \</span><br><span class="line">  --terminated-pod-gc-threshold=10000 \</span><br><span class="line">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>â€“port=0ï¼šå…³é—­ç›‘å¬éå®‰å…¨ç«¯å£ï¼ˆhttpï¼‰ï¼ŒåŒæ—¶ â€“address å‚æ•°æ— æ•ˆï¼Œâ€“bind-address å‚æ•°æœ‰æ•ˆï¼›</li><li>â€“secure-port=10252ã€â€“bind-address=0.0.0.0: åœ¨æ‰€æœ‰ç½‘ç»œæ¥å£ç›‘å¬ 10252 ç«¯å£çš„ https /metrics è¯·æ±‚ï¼›</li><li>â€“kubeconfigï¼šæŒ‡å®š kubeconfig æ–‡ä»¶è·¯å¾„ï¼Œkube-controller-manager ä½¿ç”¨å®ƒè¿æ¥å’ŒéªŒè¯ kube-apiserverï¼›</li><li>â€“authentication-kubeconfig å’Œ â€“authorization-kubeconfigï¼škube-controller-manager ä½¿ç”¨å®ƒè¿æ¥ apiserverï¼Œå¯¹ client çš„è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚kube-controller-manager ä¸å†ä½¿ç”¨ â€“tls-ca-file å¯¹è¯·æ±‚ https metrics çš„ Client è¯ä¹¦è¿›è¡Œæ ¡éªŒã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™ä¸¤ä¸ª kubeconfig å‚æ•°ï¼Œåˆ™ client è¿æ¥ kube-controller-manager https ç«¯å£çš„è¯·æ±‚ä¼šè¢«æ‹’ç»(æç¤ºæƒé™ä¸è¶³)ã€‚</li><li>â€“cluster-signing-*-fileï¼šç­¾å TLS Bootstrap åˆ›å»ºçš„è¯ä¹¦ï¼›</li><li>â€“experimental-cluster-signing-durationï¼šæŒ‡å®š TLS Bootstrap è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼›</li><li>â€“root-ca-fileï¼šæ”¾ç½®åˆ°å®¹å™¨ ServiceAccount ä¸­çš„ CA è¯ä¹¦ï¼Œç”¨æ¥å¯¹ kube-apiserver çš„è¯ä¹¦è¿›è¡Œæ ¡éªŒï¼›</li><li>â€“service-account-private-key-fileï¼šç­¾å ServiceAccount ä¸­ Token çš„ç§é’¥æ–‡ä»¶ï¼Œå¿…é¡»å’Œ kube-apiserver çš„ â€“service-account-key-file æŒ‡å®šçš„å…¬é’¥æ–‡ä»¶é…å¯¹ä½¿ç”¨ï¼›</li><li>â€“service-cluster-ip-range ï¼šæŒ‡å®š Service Cluster IP ç½‘æ®µï¼Œå¿…é¡»å’Œ kube-apiserver ä¸­çš„åŒåå‚æ•°ä¸€è‡´ï¼›</li><li>â€“leader-elect=trueï¼šé›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œå¯ç”¨é€‰ä¸¾åŠŸèƒ½ï¼›è¢«é€‰ä¸º leader çš„èŠ‚ç‚¹è´Ÿè´£å¤„ç†å·¥ä½œï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ï¼›</li><li>â€“controllers=*,bootstrapsigner,tokencleanerï¼šå¯ç”¨çš„æ§åˆ¶å™¨åˆ—è¡¨ï¼Œtokencleaner ç”¨äºè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ Bootstrap tokenï¼›</li><li>â€“horizontal-pod-autoscaler-*ï¼šcustom metrics ç›¸å…³å‚æ•°ï¼Œæ”¯æŒ autoscaling/v2alpha1ï¼›</li><li>â€“tls-cert-fileã€â€“tls-private-key-fileï¼šä½¿ç”¨ https è¾“å‡º metrics æ—¶ä½¿ç”¨çš„ Server è¯ä¹¦å’Œç§˜é’¥ï¼›</li><li>â€“use-service-account-credentials=true: kube-controller-manager ä¸­å„ controller ä½¿ç”¨ serviceaccount è®¿é—® kube-apiserverï¼›</li></ul><h4 id="9-4ã€å¯åŠ¨-kube-controller-manager-æœåŠ¡"><a href="#9-4ã€å¯åŠ¨-kube-controller-manager-æœåŠ¡" class="headerlink" title="9.4ã€å¯åŠ¨ kube-controller-manager æœåŠ¡"></a>9.4ã€å¯åŠ¨ kube-controller-manager æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-controller-manager</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager &amp;&amp; systemctl status kube-controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # netstat -lnpt | grep kube-cont</span></span><br><span class="line">tcp6       0      0 :::10252                :::*                    LISTEN      8335/kube-controlle</span><br></pre></td></tr></table></figure><h4 id="9-5ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics"><a href="#9-5ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics" class="headerlink" title="9.5ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics"></a>9.5ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics</h4><p><strong>æ³¨æ„:</strong> ä»¥ä¸‹å‘½ä»¤åœ¨ kube-controller-manager èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.17.30:10252/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="9-6-kube-controller-manager-çš„æƒé™"><a href="#9-6-kube-controller-manager-çš„æƒé™" class="headerlink" title="9.6 kube-controller-manager çš„æƒé™"></a>9.6 kube-controller-manager çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusteRole system:kube-controller-manager çš„æƒé™å¾ˆå°ï¼Œåªèƒ½åˆ›å»º secretã€serviceaccount ç­‰èµ„æºå¯¹è±¡ï¼Œå„ controller çš„æƒé™åˆ†æ•£åˆ° ClusterRole system:controller:XXX ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kube-controller-manager</span></span><br><span class="line">Name:         system:kube-controller-manager</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                                  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                                  -----------------  --------------  -----</span><br><span class="line">  secrets                                    []                 []              [create delete get update]</span><br><span class="line">  endpoints                                  []                 []              [create get update]</span><br><span class="line">  serviceaccounts                            []                 []              [create get update]</span><br><span class="line">  events                                     []                 []              [create patch update]</span><br><span class="line">  tokenreviews.authentication.k8s.io         []                 []              [create]</span><br><span class="line">  subjectaccessreviews.authorization.k8s.io  []                 []              [create]</span><br><span class="line">  configmaps                                 []                 []              [get]</span><br><span class="line">  namespaces                                 []                 []              [get]</span><br><span class="line">  *.*                                        []                 []              [list watch]</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éœ€è¦åœ¨ kube-controller-manager çš„å¯åŠ¨å‚æ•°ä¸­æ·»åŠ  â€“use-service-account-credentials=true å‚æ•°ï¼Œè¿™æ · main controller ä¼šä¸ºå„ controller åˆ›å»ºå¯¹åº”çš„ ServiceAccount XXX-controllerã€‚å†…ç½®çš„ ClusterRoleBinding system:controller:XXX å°†èµ‹äºˆå„ XXX-controller ServiceAccount å¯¹åº”çš„ ClusterRole system:controller:XXX æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get clusterrole|grep controller</span></span><br><span class="line">system:controller:attachdetach-controller                              4h52m</span><br><span class="line">system:controller:certificate-controller                               4h52m</span><br><span class="line">system:controller:clusterrole-aggregation-controller                   4h52m</span><br><span class="line">system:controller:cronjob-controller                                   4h52m</span><br><span class="line">system:controller:daemon-set-controller                                4h52m</span><br><span class="line">system:controller:deployment-controller                                4h52m</span><br><span class="line">system:controller:disruption-controller                                4h52m</span><br><span class="line">system:controller:endpoint-controller                                  4h52m</span><br><span class="line">system:controller:expand-controller                                    4h52m</span><br><span class="line">system:controller:generic-garbage-collector                            4h52m</span><br><span class="line">system:controller:horizontal-pod-autoscaler                            4h52m</span><br><span class="line">system:controller:job-controller                                       4h52m</span><br><span class="line">system:controller:namespace-controller                                 4h52m</span><br><span class="line">system:controller:node-controller                                      4h52m</span><br><span class="line">system:controller:persistent-volume-binder                             4h52m</span><br><span class="line">system:controller:pod-garbage-collector                                4h52m</span><br><span class="line">system:controller:pv-protection-controller                             4h52m</span><br><span class="line">system:controller:pvc-protection-controller                            4h52m</span><br><span class="line">system:controller:replicaset-controller                                4h52m</span><br><span class="line">system:controller:replication-controller                               4h52m</span><br><span class="line">system:controller:resourcequota-controller                             4h52m</span><br><span class="line">system:controller:route-controller                                     4h52m</span><br><span class="line">system:controller:service-account-controller                           4h52m</span><br><span class="line">system:controller:service-controller                                   4h52m</span><br><span class="line">system:controller:statefulset-controller                               4h52m</span><br><span class="line">system:controller:ttl-controller                                       4h52m</span><br><span class="line">system:kube-controller-manager                                         4h52m</span><br></pre></td></tr></table></figure><ul><li>ä»¥ deployment controller ä¸ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:controller:deployment-controller</span></span><br><span class="line">Name:         system:controller:deployment-controller</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                          Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                          -----------------  --------------  -----</span><br><span class="line">  replicasets.apps                   []                 []              [create delete get list patch update watch]</span><br><span class="line">  replicasets.extensions             []                 []              [create delete get list patch update watch]</span><br><span class="line">  events                             []                 []              [create patch update]</span><br><span class="line">  pods                               []                 []              [get list update watch]</span><br><span class="line">  deployments.apps                   []                 []              [get list update watch]</span><br><span class="line">  deployments.extensions             []                 []              [get list update watch]</span><br><span class="line">  deployments.apps/finalizers        []                 []              [update]</span><br><span class="line">  deployments.apps/status            []                 []              [update]</span><br><span class="line">  deployments.extensions/finalizers  []                 []              [update]</span><br><span class="line">  deployments.extensions/status      []                 []              [update]</span><br></pre></td></tr></table></figure></li></ul><h4 id="9-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#9-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="9.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>9.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get endpoints kube-controller-manager --namespace=kube-system  -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"k8s-master-01-2.kxl_8890f530-d829-11e9-873f-fa163e5af833","leaseDurationSeconds":15,"acquireTime":"2019-09-16T06:00:15Z","renewTime":"2019-09-16T07:05:38Z","leaderTransitions":1&#125;'</span></span><br><span class="line">  creationTimestamp: <span class="string">"2019-09-16T02:27:06Z"</span></span><br><span class="line">  name: kube-controller-manager</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"25734"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager</span><br><span class="line">  uid: 7a5b872e-d829-11e9-9b67-fa163effd55b</span><br></pre></td></tr></table></figure><p>å½“å‰çš„ leader ä¸ºk8s-master-01-2èŠ‚ç‚¹ã€‚</p><p>æµ‹è¯• kube-controller-manager é›†ç¾¤çš„é«˜å¯ç”¨,åœæ‰ä¸€ä¸ªæˆ–ä¸¤ä¸ªèŠ‚ç‚¹çš„ kube-controller-manager æœåŠ¡ï¼Œè§‚å¯Ÿå…¶å®ƒèŠ‚ç‚¹çš„æ—¥å¿—ï¼Œçœ‹æ˜¯å¦è·å–äº† leader æƒé™ã€‚</p><h3 id="10ã€scheduleré›†ç¾¤"><a href="#10ã€scheduleré›†ç¾¤" class="headerlink" title="10ã€scheduleré›†ç¾¤"></a>10ã€scheduleré›†ç¾¤</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3 ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨åå°†é€šè¿‡ç«äº‰é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“ leader èŠ‚ç‚¹ä¸å¯ç”¨åï¼Œå‰©ä½™èŠ‚ç‚¹å°†å†æ¬¡è¿›è¡Œé€‰ä¸¾äº§ç”Ÿæ–°çš„ leader èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚</p><p>ä¸ºä¿è¯é€šä¿¡å®‰å…¨ï¼Œæœ¬æ–‡æ¡£å…ˆç”Ÿæˆ x509 è¯ä¹¦å’Œç§é’¥ï¼Œkube-scheduler åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥è¯ä¹¦ï¼š<br>1.ä¸ kube-apiserver çš„å®‰å…¨ç«¯å£é€šä¿¡;<br>2.åœ¨å®‰å…¨ç«¯å£(httpsï¼Œ10251) è¾“å‡º prometheus æ ¼å¼çš„ metricsï¼›</p><h4 id="10-1ã€åˆ›å»º-kube-scheduler-è¯ä¹¦å’Œç§é’¥"><a href="#10-1ã€åˆ›å»º-kube-scheduler-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="10.1ã€åˆ›å»º kube-scheduler è¯ä¹¦å’Œç§é’¥"></a>10.1ã€åˆ›å»º kube-scheduler è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.21.17.30"</span>,</span><br><span class="line">      <span class="string">"172.21.17.31"</span>,</span><br><span class="line">      <span class="string">"172.21.16.110"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>hosts åˆ—è¡¨åŒ…å«æ‰€æœ‰ kube-scheduler èŠ‚ç‚¹ IPï¼›</p></li><li><p>CN å’Œ O å‡ä¸º system:kube-schedulerï¼Œkubernetes å†…ç½®çš„ ClusterRoleBindings system:kube-scheduler å°†èµ‹äºˆ kube-scheduler å·¥ä½œæ‰€éœ€çš„æƒé™ï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ls kube-scheduler*pem</span></span><br><span class="line">kube-scheduler-key.pem  kube-scheduler.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler*pem  /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="10-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#10-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="10.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>10.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-scheduler ä½¿ç”¨ kubeconfig æ–‡ä»¶è®¿é—® apiserverï¼Œè¯¥æ–‡ä»¶æä¾›äº† apiserver åœ°å€ã€åµŒå…¥çš„ CA è¯ä¹¦å’Œ kube-scheduler è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials system:kube-scheduler \</span></span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context system:kube-scheduler \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler.kubeconfig /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="10-3ã€åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶"><a href="#10-3ã€åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶" class="headerlink" title="10.3ã€åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶"></a>10.3ã€åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;kube-scheduler.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeSchedulerConfiguration</span><br><span class="line">bindTimeoutSeconds: 600</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-scheduler.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">enableContentionProfiling: <span class="literal">false</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">hardPodAffinitySymmetricWeight: 1</span><br><span class="line">healthzBindAddress: 127.0.0.1:10251</span><br><span class="line">leaderElection:</span><br><span class="line">  leaderElect: <span class="literal">true</span></span><br><span class="line">metricsBindAddress: <span class="comment">##NODE_IP##:10251</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><ul><li>â€“kubeconfigï¼šæŒ‡å®š kubeconfig æ–‡ä»¶è·¯å¾„ï¼Œkube-scheduler ä½¿ç”¨å®ƒè¿æ¥å’ŒéªŒè¯ kube-apiserverï¼›</li><li>â€“leader-elect=trueï¼šé›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œå¯ç”¨é€‰ä¸¾åŠŸèƒ½ï¼›è¢«é€‰ä¸º leader çš„èŠ‚ç‚¹è´Ÿè´£å¤„ç†å·¥ä½œï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ï¼›</li></ul><h4 id="10-4ã€åˆ›å»º-kube-scheduler-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#10-4ã€åˆ›å»º-kube-scheduler-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="10.4ã€åˆ›å»º kube-scheduler systemd unit æ¨¡æ¿æ–‡ä»¶"></a>10.4ã€åˆ›å»º kube-scheduler systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-scheduler.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-scheduler</span><br><span class="line">ExecStart=/usr/bin/kube-scheduler \</span><br><span class="line">  --config=/etc/kubernetes/kube-scheduler.yaml \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=10259 \</span><br><span class="line">  --port=0 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">""</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="10-5ã€å¯åŠ¨-kube-scheduler-æœåŠ¡"><a href="#10-5ã€å¯åŠ¨-kube-scheduler-æœåŠ¡" class="headerlink" title="10.5ã€å¯åŠ¨ kube-scheduler æœåŠ¡"></a>10.5ã€å¯åŠ¨ kube-scheduler æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-scheduler</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler &amp;&amp; systemctl status kube-scheduler</span></span><br></pre></td></tr></table></figure><h4 id="10-6ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics"><a href="#10-6ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics" class="headerlink" title="10.6ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics"></a>10.6ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics</h4><p>kube-scheduler ç›‘å¬ 10251 å’Œ 10251 ç«¯å£ï¼š</p><ul><li>10251ï¼šæ¥æ”¶ http è¯·æ±‚ï¼Œéå®‰å…¨ç«¯å£ï¼Œä¸éœ€è¦è®¤è¯æˆæƒ</li><li>10259ï¼šæ¥æ”¶ https è¯·æ±‚ï¼Œå®‰å…¨ç«¯å£ï¼Œéœ€è¦è®¤è¯æˆæƒ</li></ul><p>ä¸¤ä¸ªæ¥å£éƒ½å¯¹å¤–æä¾› /metrics å’Œ /healthz çš„è®¿é—®ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt |grep kube-sch</span></span><br><span class="line">tcp        0      0 172.21.17.31:10251      0.0.0.0:*               LISTEN      8441/kube-scheduler </span><br><span class="line">tcp6       0      0 :::10259                :::*                    LISTEN      8441/kube-scheduler</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s http://172.21.17.30:10251/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.17.30:10259/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="10-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#10-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="10.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>10.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kubectl get endpoints kube-scheduler --namespace=kube-system  -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"k8s-master-01.kxl_2a6e0bf9-d82b-11e9-b946-fa163effd55b","leaseDurationSeconds":15,"acquireTime":"2019-09-16T06:00:28Z","renewTime":"2019-09-16T07:41:57Z","leaderTransitions":1&#125;'</span></span><br><span class="line">  creationTimestamp: <span class="string">"2019-09-16T02:38:55Z"</span></span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"29215"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-scheduler</span><br><span class="line">  uid: 20a04151-d82b-11e9-baf3-fa163e53d4c8</span><br></pre></td></tr></table></figure><h4 id="10-8-æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€"><a href="#10-8-æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€" class="headerlink" title="10.8 æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€"></a>10.8 æ£€æŸ¥é›†ç¾¤endpointsçŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get endpoints</span></span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   18h</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kuberntes v1.14</tag>
      </tags>
  </entry>
  <entry>
    <title>è·¯ç”±å™¨ç«¯å£æ˜ å°„</title>
    <url>/2019/09/10/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œh3c MSR3620è·¯ç”±å™¨åšç«¯å£æ˜ å°„åˆ°åç«¯æœåŠ¡å™¨,åŒ…å«å•ä¸ªç«¯å£å’Œç«¯å£æ®µçš„æ˜ å°„</p><a id="more"></a><h3 id="å•ä¸ªç«¯å£çš„æ˜ å°„"><a href="#å•ä¸ªç«¯å£çš„æ˜ å°„" class="headerlink" title="å•ä¸ªç«¯å£çš„æ˜ å°„"></a>å•ä¸ªç«¯å£çš„æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[router] interface GigabitEthernet0/2 å…¬ç½‘ipæ¥å£</span><br><span class="line">[router] nat server protocol tcp global å…¬ç½‘ip 80 inside å†…ç½‘ip 80</span><br></pre></td></tr></table></figure><h3 id="å¤šç«¯å£"><a href="#å¤šç«¯å£" class="headerlink" title="å¤šç«¯å£"></a>å¤šç«¯å£</h3><p>vsftpå¯ä»¥ä½¿ç”¨è¿™ä¸ª</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[router] interface GigabitEthernet0/2 å…¬ç½‘ipæ¥å£</span><br><span class="line">[router] nat server protocol tcp global current-interface 9000 9045 inside å†…ç½‘ip 9000 9045</span><br></pre></td></tr></table></figure><p><strong>å¤‡æ³¨:</strong> å¯ä»¥ä½¿ç”¨vsftpåœºæ™¯ï¼Œ<a href="https://xxlaila.github.io/2019/08/09/vsftpd%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">vsftpå®‰è£…</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>MSR3620</tag>
      </tags>
  </entry>
  <entry>
    <title>traefik httpsåº”ç”¨</title>
    <url>/2019/09/06/traefik-https%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰å·²ç»ä½¿ç”¨traefikæœåŠ¡ä½œä¸ºå…¥å£ï¼Œæµ‹è¯•å¹¶è®¿é—®äº†tomcatåº”ç”¨ï¼Œä¹‹å‰æ˜¯é€šè¿‡httpæ¥è®¿é—®çš„ï¼Œè€Œæˆ‘ä»¬åœ¨yamlæ–‡ä»¶é‡Œé¢ä¹Ÿæ·»åŠ 8443ç«¯å£ç”¨äºhttpsè®¿é—®ï¼Œåœ¨å®é™…ç¯å¢ƒä¸­æˆ‘ä»¬ä¹Ÿæ˜¯éœ€è¦httpsæ¥è¿›è¡Œè®¿é—®åº”ç”¨ï¼Œé€šè¿‡traefikå®ç°httpsï¼Œ<a href="https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">traefik httpåº”ç”¨</a></p><h3 id="æ“ä½œå®è·µ"><a href="#æ“ä½œå®è·µ" class="headerlink" title="æ“ä½œå®è·µ"></a>æ“ä½œå®è·µ</h3><ul><li>è¿™é‡Œæˆ‘ç”¨äº†å…¬å¸çš„è¯ä¹¦ï¼Œå°±æ˜¯ä¸ºäº†è´´è¿‘çœŸå®ï¼Œä¹Ÿæ»¡è¶³æµ‹è¯•éœ€æ±‚ï¼Œ</li><li>åˆ›å»ºä¸€ä¸ªsecretï¼Œä¿å­˜httpsè¯ä¹¦</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">1_test.xxlaila.cn_bundle.crt  2_test.xxlaila.cn.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create secret generic traefik-cert --from-file=1_test.xxlaila.cn_bundle.crt --from-file=2_test.xxlaila.cn.key -n kube-system</span></span><br><span class="line">secret/traefik-cert created</span><br></pre></td></tr></table></figure><p>æŠŠè¯ä¹¦æ‹·è´åˆ°k8s nodeèŠ‚ç‚¹ï¼Œå­˜æ”¾è·¯å¾„ä¸º/etc/kubernetes/certsã€‚</p><h3 id="åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®"><a href="#åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®" class="headerlink" title="åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®"></a>åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®</h3><p>traefixä¸­é…ç½®äº†æŠŠæ‰€æœ‰httpè¯·æ±‚å…¨éƒ¨rewriteä¸ºhttpsçš„è§„åˆ™ï¼Œå¹¶é…ç½®ç›¸åº”çš„è¯ä¹¦ä½ç½®</p><ul><li>traefik.toml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_test.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_test.xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line">$ kubectl create configmap traefik-conf --from-file=traefik.toml -n kube-system</span><br><span class="line">configmap/traefik-conf created</span><br></pre></td></tr></table></figure></li></ul><p>æŠŠtraefik.tomlæ–‡ä»¶æ‹·è´åˆ°k8s nodeèŠ‚ç‚¹,å­˜æ”¾è·¯å¾„ä¸º/etc/kubernetes/confã€‚</p><h3 id="é‡æ–°éƒ¨ç½²Traefix"><a href="#é‡æ–°éƒ¨ç½²Traefix" class="headerlink" title="é‡æ–°éƒ¨ç½²Traefix"></a>é‡æ–°éƒ¨ç½²Traefix</h3><p>ä¸»è¦æ˜¯è¦å…³è”åˆ›å»ºçš„secretå’ŒconfigMapï¼Œå¹¶æŒ‚è½½ç›¸å¯¹åº”çš„ä¸»æœºç›®å½•ã€‚</p><ul><li>deployment.yaml</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat deployment.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/certs"</span></span><br><span class="line">          name: <span class="string">"ssl"</span></span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/conf"</span></span><br><span class="line">          name: <span class="string">"config"</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --configFile=/etc/kubernetes/conf/traefik.toml</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f deployment.yaml </span><br><span class="line">deployment.extensions/traefik-ingress-lb configured</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•æ•ˆæœ"><a href="#æµ‹è¯•æ•ˆæœ" class="headerlink" title="æµ‹è¯•æ•ˆæœ"></a>æµ‹è¯•æ•ˆæœ</h3><p>ç™»é™†traefik-uiç•Œé¢,ç”¨åŸæœ¬httpçš„è®¿é—®ï¼Œtraefikä¼šç›´æ¥ç»™æˆ‘ä»¬é‡å®šå‘è‡³httpsã€‚<br><img src="https://img.xxlaila.cn/1567748749337.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºtraefik-uiä½¿ç”¨çš„åŸŸåä¸æ˜¯æˆ‘ä»¬è¯ä¹¦æ‰€æ”¯æŒçš„åŸŸåï¼Œæ‰€ä»¥è¿™é‡Œæç¤ºä¸å®‰å…¨ï¼Œä¿®æ”¹ä¹‹å‰åˆ›å»ºçš„ingressï¼Œä¿®æ”¹å…¶ä¸­çš„åŸŸåä¸ºæ”¯æŒè¯ä¹¦çš„åŸŸå</p><ul><li>traefik-ui.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system </span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8580</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f traefik-ui.yaml </span><br><span class="line">service/traefik-web-ui unchanged</span><br><span class="line">ingress.extensions/traefik-web-ui configured</span><br></pre></td></tr></table></figure></li></ul><p>ä¿®æ”¹hostsç‰ˆå®šçš„åŸŸåè¿›è¡Œè®¿é—®<br><img src="https://img.xxlaila.cn/1567749086159.jpg" alt="img"></p><ul><li><p>ä¿®æ”¹ä¹‹å‰éƒ¨ç½²çš„tomcatç¨‹åº</p></li><li><p>ingress-tomcat.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /test1/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line">      - path: /test2/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ingress-tomcat.yaml </span><br><span class="line">ingress.extensions/tomcat-test-web configured</span><br></pre></td></tr></table></figure></li></ul><p>è®¿é—®é“¾æ¥æµ‹è¯•<br><img src="https://img.xxlaila.cn/1567749278980.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567749309772.jpg" alt="img"></p><h3 id="å…¶ä»–éœ€æ±‚"><a href="#å…¶ä»–éœ€æ±‚" class="headerlink" title="å…¶ä»–éœ€æ±‚"></a>å…¶ä»–éœ€æ±‚</h3><p>åœ¨æˆ‘ä»¬çœŸå®çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œéœ€æ±‚è‚¯å®šæœ‰ä¸åŒçš„ï¼Œæ¯”å¦‚æˆ‘æ‰€åœ¨çš„å…¬å¸å¼€å‘ç¯å¢ƒå°±è¦åªæ˜¯httpå’Œhttpsï¼Œæµ‹è¯•ç¯å¢ƒä»¥ä¸Šçš„å°±å…¨éƒ¨å¼ºåˆ¶httpsã€‚è¿™å°±å¾—åˆ†å¼€è¿›è¡Œé…ç½®</p><h4 id="åŒæ—¶æ”¯æŒhttpå’Œhttps"><a href="#åŒæ—¶æ”¯æŒhttpå’Œhttps" class="headerlink" title="åŒæ—¶æ”¯æŒhttpå’Œhttps"></a>åŒæ—¶æ”¯æŒhttpå’Œhttps</h4><p>æŠŠhttpä¸­çš„rewriteä»£ç æ”¹æ‰</p><ul><li>traefik.toml</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_test.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_test.xxlaila.cn.key"</span></span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_dev.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_dev.xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line">[file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># rules</span></span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">      regex = <span class="string">"^http://traefix.test.xxlaila.cn/(.*)"</span></span><br><span class="line">      replacement = <span class="string">"https://traefix.test.xxlaila.cn/<span class="variable">$1</span>"</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>traefik ingressä½¿ç”¨</title>
    <url>/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="Traefikä»‹ç»"><a href="#Traefikä»‹ç»" class="headerlink" title="Traefikä»‹ç»"></a>Traefikä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç®€å•çš„è¯´ï¼Œingresså°±æ˜¯ä»kubernetesé›†ç¾¤å¤–è®¿é—®é›†ç¾¤çš„å…¥å£ï¼Œå°†ç”¨æˆ·çš„URLè¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„serviceä¸Šã€‚Ingressç›¸å½“äºnginxã€apacheç­‰è´Ÿè½½å‡è¡¡åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬è§„åˆ™å®šä¹‰ï¼Œå³URLçš„è·¯ç”±ä¿¡æ¯ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traefikæ˜¯ä¸€æ¬¾å¼€æºçš„åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å·¥å…·ã€‚å®ƒæœ€å¤§çš„ä¼˜ç‚¹æ˜¯èƒ½å¤Ÿä¸å¸¸è§çš„å¾®æœåŠ¡ç³»ç»Ÿç›´æ¥æ•´åˆï¼Œå®ç°è‡ªåŠ¨åŒ–åŠ¨æ€é…ç½®ã€‚Traefiké€šè¿‡ä¸æ–­åœ°è·Ÿ kubernetes API æ‰“äº¤é“ï¼Œå®æ—¶çš„æ„ŸçŸ¥åç«¯ serviceã€pod ç­‰å˜åŒ–ï¼Œæ¯”å¦‚podï¼Œservice å¢åŠ ä¸å‡å°‘ç­‰ï¼›å½“å¾—åˆ°è¿™äº›å˜åŒ–ä¿¡æ¯åï¼ŒIngressè‡ªåŠ¨æ›´æ–°é…ç½®å¹¶çƒ­é‡è½½ ï¼Œè¾¾åˆ°æœåŠ¡å‘ç°çš„ä½œç”¨ã€‚</p><a id="more"></a><p>traefix æ•´ä½“æ¶æ„å›¾å¦‚ä¸‹:<br><img src="https://img.xxlaila.cn/34238937snkhfskdy8923.png" alt="img"></p><h3 id="Traefikä¸»è¦ç‰¹æ€§è¯¦è§£"><a href="#Traefikä¸»è¦ç‰¹æ€§è¯¦è§£" class="headerlink" title="Traefikä¸»è¦ç‰¹æ€§è¯¦è§£"></a>Traefikä¸»è¦ç‰¹æ€§è¯¦è§£</h3><ul><li><p>è‡ªåŠ¨ç†”æ–­</p><ul><li>åœ¨é›†ç¾¤ä¸­ï¼Œå½“æŸä¸€ä¸ªæœåŠ¡å¤§é‡å‡ºç°è¯·æ±‚é”™è¯¯ï¼Œæˆ–è€…è¯·æ±‚å“åº”æ—¶é—´è¿‡ä¹…ï¼Œæˆ–è€…è¿”å›500+é”™è¯¯çŠ¶æ€ç æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥ä¸»åŠ¨å‰”é™¤è¯¥æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸åœ¨å°†è¯·æ±‚è½¬å‘åˆ°è¯¥æœåŠ¡ä¸Šï¼Œè€Œè¿™ä¸€ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦äººå·¥æ‰§è¡Œã€‚Traefik é€šè¿‡é…ç½®å¾ˆå®¹æ˜“å°±èƒ½å¸®æˆ‘ä»¬å®ç°ï¼ŒTraefik å¯ä»¥é€šè¿‡å®šä¹‰ç­–ç•¥æ¥ä¸»åŠ¨ç†”æ–­æœåŠ¡ã€‚</li><li>NetworkErrorRatio() &gt; 0.5ï¼šç›‘æµ‹æœåŠ¡é”™è¯¯ç‡è¾¾åˆ°50%æ—¶ï¼Œç†”æ–­</li><li>LatencyAtQuantileMS(50.0) &gt; 50ï¼šç›‘æµ‹å»¶æ—¶å¤§äº50msæ—¶ï¼Œç†”æ–­</li><li>ResponseCodeRatio(500, 600, 0, 600) &gt; 0.5ï¼šç›‘æµ‹è¿”å›çŠ¶æ€ç ä¸º[500-600]åœ¨[0-600]åŒºé—´å æ¯”è¶…è¿‡50%æ—¶ï¼Œç†”æ–­</li></ul></li><li><p>è´Ÿè½½å‡è¡¡ç­–ç•¥</p><ul><li>Traefik æä¾›ä¸¤ç§è´Ÿè½½å‡è¡¡ç­–ç•¥æ”¯æŒã€‚ä¸€ç§æ˜¯ wrrï¼ˆåŠ æƒè½®è®­è°ƒåº¦ç®—æ³•ï¼‰ï¼Œä¸€ç§æ˜¯ drrï¼ˆåŠ¨æ€åŠ æƒå¾ªç¯è°ƒåº¦ç®—æ³•ï¼‰</li><li>wrræ˜¯é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œæ–°åˆ›å»ºçš„ service æƒé‡éƒ½æ˜¯ä¸€æ ·ä¸º1ï¼Œè¿™æ ·çš„è¯ï¼Œè¯·æ±‚ä¼šå¹³å‡åˆ†ç»™æ¯ä¸ªæœåŠ¡ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå¤šæ—¶å€™ä¼šå‡ºç°èµ„æºåˆ†é…ä¸å‡è¡¡çš„é—®é¢˜ï¼Œæ¯”å¦‚ç”±äºé›†ç¾¤ä¸­æ¯ä¸ªæœºå™¨é…ç½®ä¸ä¸€æ ·ï¼Œè€Œä¸”æœåŠ¡æ¶ˆè€—ä¸ä¸€æ ·ï¼Œå‡è®¾ A èµ„æºä½¿ç”¨ç‡å·²ç»å¾ˆé«˜ï¼Œè€Œ B å±äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœè¿˜æ˜¯å‡æ‘Šåˆ°æ¯ä¸ªæœåŠ¡çš„è¯ï¼Œä¼šåŠ é‡ A çš„è´Ÿè·ï¼Œè¿™æ—¶å€™å› è¯¥æœ‰ä¸€ç§ç­–ç•¥èƒ½å¤Ÿä¸»åŠ¨è¯†åˆ«å¹¶åˆ†æ‹…æ›´å¤šæµé‡åˆ° B æ‰å¯¹</li><li>drr å°±æ›´åŠ æ™ºèƒ½ï¼Œå®ƒæ˜¯ä¸€ç§åŠ¨æ€åŠ æƒè½®è®­è°ƒåº¦æ–¹å¼ï¼Œå®ƒä¼šè®°å½•ä¸€æ®µæ—¶é—´å†…è½¬å‘åˆ° A çš„è¯·æ±‚æ•°ï¼Œè·Ÿè½¬å‘åˆ° B çš„è¯·æ±‚æ•°å¯¹æ¯”ï¼Œè½¬å‘æ•°é‡å¤šï¼Œè¯´æ˜å¤„ç†é€Ÿåº¦å¿«ï¼Œå“åº”æ—¶é—´å¿«ã€‚å¦‚æœ A å¤„ç†è¯·æ±‚é€Ÿåº¦æ¯” B å¿«ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒæ•´ A çš„æƒé‡ï¼Œæ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ï¼Œå°±ä¼šè½¬å‘æ›´å¤šè¯·æ±‚ç»™ Aï¼Œç›¸åº”çš„ B çš„è½¬å‘å°±å°‘ä¸€äº›ã€‚æ•´ä¸ªè¿‡ç¨‹éƒ½åœ¨ä¸æ–­çš„è°ƒæ•´æƒé‡ï¼Œå®ç°è¯·æ±‚çš„åˆç†åˆ†é…ï¼Œä»è€Œè¾¾åˆ°èµ„æºä½¿ç”¨æœ€å¤§åŒ–</li></ul></li></ul><h3 id="éƒ¨ç½²Traefik-ingress"><a href="#éƒ¨ç½²Traefik-ingress" class="headerlink" title="éƒ¨ç½²Traefik ingress"></a>éƒ¨ç½²Traefik ingress</h3><ul><li><p>åˆ›å»ºingress-rbac.yamlï¼Œå°†ç”¨äºservice accountéªŒè¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat ingress-rbac.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: ingress</span><br><span class="line">    namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºDepeloymentéƒ¨ç½²traefikï¼Œå¦‚æ–‡ä»¶åä¸ºdeployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>æ³¨æ„</strong>: æˆ‘ä»¬è¿™é‡Œç”¨çš„æ˜¯Deployç±»å‹ï¼Œæ²¡æœ‰é™å®šè¯¥podè¿è¡Œåœ¨å“ªä¸ªä¸»æœºä¸Šã€‚Traefikçš„ç«¯å£æ˜¯8580ã€‚</li></ul><ul><li>ç¼–å†™Traefik UIçš„ingresséƒ¨ç½²æ–‡ä»¶ï¼Œå¦‚æ–‡ä»¶åä¸ºtraefik-ui.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system <span class="comment">#å¢åŠ è¡Œ</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8580</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><ul><li><code>backend</code>ä¸­è¦é…ç½®default namespaceä¸­å¯åŠ¨çš„serviceåå­—ã€‚</li><li><code>path</code>å°±æ˜¯URLåœ°å€åçš„è·¯å¾„ï¼Œå¦‚<code>traefik.frontend.io/path</code>ï¼Œserviceå°†ä¼šæ¥å—pathè¿™ä¸ªè·¯å¾„</li><li><code>host</code>æœ€å¥½ä½¿ç”¨service-name.filed1.filed2.domain-nameè¿™ç§ç±»ä¼¼ä¸»æœºåç§°çš„å‘½åæ–¹å¼ï¼Œæ–¹ä¾¿åŒºåˆ†æœåŠ¡ã€‚</li></ul><ul><li><strong>é€¼é€¼ä¸€ä¸‹</strong>: ç›®å‰æˆ‘æ‰€åœ¨çš„å…¬å¸åç«¯å¾®æœåŠ¡100+ï¼Œå‰ç«¯60+ï¼Œå¦‚æœç”¨ä¼ ç»Ÿnginxçš„localæ¥åŒ¹é…ï¼Œä¼°è®¡è¦å†™æ­»äººï¼Œè€Œä¸”å¯¹äºè¿ç»´è‡ªåŠ¨åŒ–æ¥ä¹Ÿä¸æ˜¯å¾ˆå¥½åšï¼Œå†åˆ™æ˜¯å‡ºäº†é—®é¢˜ä¹Ÿè¿˜è¦å»çœ‹ä¸€ä¸‹æ˜¯å“ªä¸ªåº”ç”¨ï¼›æˆ‘ä»¬ç›®å‰æ˜¯é€šè¿‡æ¯ä¸ªæœåŠ¡æ¯ä¸€ä¸ªåŸŸåï¼ŒåŸŸåæ˜¯æ ¹æ®æœåŠ¡åæ¥è‡ªåŠ¨ç”Ÿæˆï¼Œé™¤äº†å‡ ä¸ªç‰¹å®šå¯¹å¤–å…¬å¼€çš„æ˜¯ç‰¹åˆ¶çš„åŸŸåï¼Œå…¶ä»–çš„å‡é‡‡ç”¨è¿™ç§æœºåˆ¶ï¼Œå½“æœ‰é—®é¢˜çš„æ—¶å€™ï¼Œä¸€ä¸‹å°±èƒ½åˆ¤æ–­å‡ºé‚£é‡Œå‡ºé—®é¢˜ï¼Œå¾ˆå¥½å®šä½ï¼Œæœ‰åŸŸåæœ‰ç‰¹æ®Šé…ç½®çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å•ç‹¬çš„è¿›è¡Œè®¾ç½®ï¼Œä½†æ˜¯æˆªæ­¢ç›®å‰ä¸¤å¹´å¤šæ¥ï¼Œè¿ç»´æ‹’ç»è¿™ç§ç‰¹æ®Šéœ€æ±‚(æœ‰è¿˜æœ‰ï¼Œå¾ˆå°‘ï¼Œåªæœ‰é‚£ä¹ˆä¸¤ä¸‰ä¸ª)</li></ul><ul><li><p>é…ç½®å®Œæˆåå°±å¯ä»¥å¯åŠ¨treafik ingressäº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line">deployment.extensions/traefik-ingress-lb created</span><br><span class="line">serviceaccount/ingress created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/ingress created</span><br><span class="line">service/traefik-web-ui created</span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system | grep traefik</span></span><br><span class="line"></span><br><span class="line">traefik-ingress-lb-5d7f658cfd-4vkjc     1/1     Running   0          29m</span><br><span class="line">traefik-ingress-lb-5d7f658cfd-7sszp     1/1     Running   0          19m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get ingress -o wide --all-namespaces </span></span><br><span class="line">NAMESPACE     NAME                HOSTS                ADDRESS   PORTS   AGE</span><br><span class="line">kube-system   traefik-web-ui      traefik.xxlaila.io             80      29m</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨æµè§ˆå™¨ç»‘å®šhostsåŸŸåè§£æï¼Œnodeçš„ipåœ°å€ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥traefik.xxlaila.ioå³å¯è®¿é—®äº†<br><img src="https://img.xxlaila.cn/1567676343800.jpg" alt="img"></p><p>å·¦ä¾§è“è‰²éƒ¨åˆ†åˆ—å‡ºçš„æ˜¯æ‰€æœ‰çš„å‰ç«¯(frontends)ï¼Œå³ä¾§ç»¿è‰²éƒ¨åˆ†æ˜¯æ‰€æœ‰çš„åç«¯(backend)ã€‚</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ä¸‹é¢æ¨¡æ‹Ÿéƒ¨ç½²ä¸€ä¸ªç¨‹åºï¼Œä»¥Nginx ä¸ºä¾‹ï¼Œå¹¶ä½¿ç”¨drråŠ¨æ€è½®è®­åŠ æƒç­–ç•¥ã€‚</p><ul><li><p>nginx-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.15.5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-service</span><br><span class="line">  annotations:</span><br><span class="line">    traefik.ingress.kubernetes.io/load-balancer-method: drr</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx-service</span><br><span class="line">        namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-pod</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: k8s.nginx.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx-service</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºnginx</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f nginx-deployment.yaml </span></span><br><span class="line">deployment.apps/nginx-pod created</span><br><span class="line">service/nginx-service created</span><br><span class="line">ingress.extensions/nginx-ingress created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰€æœ‰è®¿é—®è¿™äº›åœ°å€çš„æµé‡éƒ½ä¼šå‘é€ç»™172.16.0.180è¿™å°ä¸»æœºï¼Œå°±æ˜¯æˆ‘ä»¬å¯åŠ¨traefikçš„ä¸»æœºã€‚Traefikä¼šè§£æhttpè¯·æ±‚headeré‡Œçš„Hostå‚æ•°å°†æµé‡è½¬å‘ç»™Ingressé…ç½®é‡Œçš„ç›¸åº”serviceã€‚<br><img src="https://img.xxlaila.cn/1567676984150.jpg" alt="img"></p><p>å®¢æˆ·ç«¯ç»‘å®šhostï¼Œæµè§ˆå™¨è¿›è¡Œè®¿é—®: <a href="http://k8s.nginx.com" target="_blank" rel="noopener">http://k8s.nginx.com</a><br><img src="https://img.xxlaila.cn/1567677018297.jpg" alt="img"></p><p>åœ¨K8sé›†ç¾¤èŠ‚ç‚¹ä¸Šè®¿é—®æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -x 172.21.16.204 http://k8s.nginx.com</span></span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;503 Service Unavailable&lt;/h1&gt;</span><br><span class="line">No server is available to handle this request.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line">[root@k8s ~]<span class="comment"># curl -x 172.21.16.204:80 http://k8s.nginx.com</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h4 id="ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨"><a href="#ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨" class="headerlink" title="ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨"></a>ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¸æƒ³é…ç½®å¤ªå¤šçš„åŸŸåæ¥åŒºåˆ«åº”ç”¨ï¼Œä½¿ç”¨åŒåŸŸååˆ†è·¯å¾„çš„æ–¹å¼æ¥åŒºåˆ«åº”ç”¨å°±ç®€æ´æ–¹ä¾¿å¾ˆå¤šã€‚ingressä¹Ÿæä¾›äº†ç›¸å…³çš„é…ç½®ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‡è®¾ä¸¤ä¸ªåº”ç”¨tomcat-test1å’Œtomcat-test2ã€‚è¿™é‡Œå¯é…ç½®åŸŸåtomcat.xxlaila.ioï¼Œé€šè¿‡è·¯å¾„test1ã€test2æ¥åˆ†åˆ«ä»£ç†ä¸¤ä¸ªtomcatåº”ç”¨ã€‚å…¶ä¸­ï¼Œåˆ†è·¯å¾„é…ç½®éœ€æ·»åŠ é…ç½®ï¼štraefik.frontend.rule.type: PathPrefixStrip,é¦–å…ˆï¼Œæˆ‘å…ˆåˆ›å»ºtomcat-test1å’Œtomcat-test2çš„podå’Œserviceï¼Œå…¶ä¸­8080ä¸ºtomcatçš„httpç«¯å£ï¼Œ8443ä¸ºtomcatçš„httpsç«¯å£ï¼Œæœ¬ä¾‹ä¸­ä»…ä½¿ç”¨httpç«¯å£æµ‹è¯•ã€‚</p><ul><li><p>tomcat-test1.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1</span><br><span class="line">  labels: </span><br><span class="line">    app: tomcat-test1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1 </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-test1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-test1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-test1</span><br><span class="line">        image: tomcat</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1</span><br><span class="line">  labels:</span><br><span class="line">    name: tomcat-test1</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8443</span><br><span class="line">    targetPort: 8443</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test1</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080 </span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test1</span><br></pre></td></tr></table></figure></li><li><p>tomcat-test2.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test2</span><br><span class="line">  labels: </span><br><span class="line">    app: tomcat-test2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1 </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-test2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-test2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-test2</span><br><span class="line">        image: manjeetchauhan211/tomcat_test2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test2</span><br><span class="line">  labels:</span><br><span class="line">    name: tomcat-test2</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8443</span><br><span class="line">    targetPort: 8443</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080 </span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test2</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"></span><br><span class="line">$ kubectl get deployment</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-pod      2/2     2            2           17h</span><br><span class="line">tomcat-test1   1/1     1            1           42m</span><br><span class="line">tomcat-test2   1/1     1            1           42m</span><br><span class="line"></span><br><span class="line">$ kubectl get svc</span><br><span class="line">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kubernetes       ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP    5d23h</span><br><span class="line">nginx-service    ClusterIP   10.254.149.69    &lt;none&gt;        80/TCP     17h</span><br><span class="line">tomcat-test1     ClusterIP   10.254.195.108   &lt;none&gt;        8080/TCP   42m</span><br><span class="line">tomcat-test2     ClusterIP   10.254.6.88      &lt;none&gt;        8080/TCP   42m</span><br><span class="line">traefik-web-ui   ClusterIP   10.254.22.102    &lt;none&gt;        80/TCP     17h</span><br></pre></td></tr></table></figure></li></ul><p>åˆ›å»ºtest1çš„ingressï¼Œæ¥å‘å¸ƒtomcat-test1æœåŠ¡</p><ul><li>ingress-tomcat1.yam<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat ingress-tomcat1.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f ingress-tomcat.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>åœ¨traefix-uiç•Œé¢ä¸Šï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æœ‰äº†ä¸€ä¸ª<code>tomcat.xxlaila.io</code>çš„åŸŸåè§„åˆ™.<br><img src="https://img.xxlaila.cn/1567739051461.jpg" alt="img"></p><p>åœ¨hostsæ–‡ä»¶æ·»åŠ tomcat.xxlaila.ioç»‘å®šæ¥è¿›è¡Œè®¿é—®<br><img src="https://img.xxlaila.cn/1567739162707.jpg" alt="img"></p><h5 id="ingressé…ç½®åŒåŸŸåå¯¹åº”location"><a href="#ingressé…ç½®åŒåŸŸåå¯¹åº”location" class="headerlink" title="ingressé…ç½®åŒåŸŸåå¯¹åº”location"></a>ingressé…ç½®åŒåŸŸåå¯¹åº”location</h5><ul><li><p>ingress-tomcat.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /test1/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line">      - path: /test2/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test2</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºå¹¶æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f ingress-tomcat.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl describe ingress tomcat-test-web</span><br><span class="line">Name:             tomcat-test-web</span><br><span class="line">Namespace:        default</span><br><span class="line">Address:          </span><br><span class="line">Default backend:  default-http-backend:80 (&lt;none&gt;)</span><br><span class="line">Rules:</span><br><span class="line">  Host               Path  Backends</span><br><span class="line">  ----               ----  --------</span><br><span class="line">  tomcat.xxlaila.io  </span><br><span class="line">                     /test1/   tomcat-test1:8080 (&lt;none&gt;)</span><br><span class="line">                     /test2/   tomcat-test2:8080 (&lt;none&gt;)</span><br><span class="line">Annotations:</span><br><span class="line">  traefik.frontend.rule.type:                        PathPrefixStrip</span><br><span class="line">  kubectl.kubernetes.io/last-applied-configuration:  &#123;<span class="string">"apiVersion"</span>:<span class="string">"extensions/v1beta1"</span>,<span class="string">"kind"</span>:<span class="string">"Ingress"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;<span class="string">"kubernetes.io/ingress.class"</span>:<span class="string">"traefik"</span>,<span class="string">"traefik.frontend.rule.type"</span>:<span class="string">"PathPrefixStrip"</span>&#125;,<span class="string">"name"</span>:<span class="string">"tomcat-test-web"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"rules"</span>:[&#123;<span class="string">"host"</span>:<span class="string">"tomcat.xxlaila.io"</span>,<span class="string">"http"</span>:&#123;<span class="string">"paths"</span>:[&#123;<span class="string">"backend"</span>:&#123;<span class="string">"serviceName"</span>:<span class="string">"tomcat-test1"</span>,<span class="string">"servicePort"</span>:8080&#125;,<span class="string">"path"</span>:<span class="string">"/test1/"</span>&#125;,&#123;<span class="string">"backend"</span>:&#123;<span class="string">"serviceName"</span>:<span class="string">"tomcat-test2"</span>,<span class="string">"servicePort"</span>:8080&#125;,<span class="string">"path"</span>:<span class="string">"/test2/"</span>&#125;]&#125;&#125;]&#125;&#125;</span><br><span class="line"></span><br><span class="line">  kubernetes.io/ingress.class:  traefik</span><br><span class="line">Events:                         &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç»™èŠ‚ç‚¹è®¾ç½®label"><a href="#ç»™èŠ‚ç‚¹è®¾ç½®label" class="headerlink" title="ç»™èŠ‚ç‚¹è®¾ç½®label"></a>ç»™èŠ‚ç‚¹è®¾ç½®label</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºæ˜¯ Kubernetes DeamonSet è¿™ç§æ–¹å¼éƒ¨ç½² Traefikï¼Œæ‰€ä»¥éœ€è¦æå‰ç»™èŠ‚ç‚¹è®¾ç½® Labelï¼Œè¿™æ ·å½“ç¨‹åºéƒ¨ç½²æ—¶ Pod ä¼šè‡ªåŠ¨è°ƒåº¦åˆ°è®¾ç½® Label çš„ç‚¹ä¸Šã€‚</p><h4 id="èŠ‚ç‚¹è®¾ç½®-Label-æ ‡ç­¾"><a href="#èŠ‚ç‚¹è®¾ç½®-Label-æ ‡ç­¾" class="headerlink" title="èŠ‚ç‚¹è®¾ç½® Label æ ‡ç­¾"></a>èŠ‚ç‚¹è®¾ç½® Label æ ‡ç­¾</h4><ul><li>æ ¼å¼ï¼škubectl label nodes [èŠ‚ç‚¹å] [key=value]<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> kubectl get nodes</span><br><span class="line">NAME            STATUS   ROLES    AGE    VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   7d5h   v1.13.3</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   7d2h   v1.13.3</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   7d2h   v1.13.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl label nodes 172.21.16.204 IngressProxy=true</span></span><br><span class="line">node/172.21.16.204 labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹labelè®¾ç½®æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment"># kubectl get nodes --show-labels</span></span><br><span class="line">NAME            STATUS   ROLES    AGE    VERSION   LABELS</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   7d5h   v1.13.3   IngressProxy=<span class="literal">true</span>,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.204,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   7d2h   v1.13.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.240,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   7d2h   v1.13.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.87,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶"><a href="#ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶"></a>ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat deployment.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ssl</span><br><span class="line">        secret:</span><br><span class="line">          secretName: traefik-cert</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: traefik-conf</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/certs"</span></span><br><span class="line">          name: <span class="string">"ssl"</span></span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/conf"</span></span><br><span class="line">          name: <span class="string">"config"</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --configFile=/etc/kubernetes/conf/traefik.toml</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br><span class="line">      nodeSelector:</span><br><span class="line">        IngressProxy: <span class="string">"true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œéƒ¨ç½²å³å¯</span></span><br></pre></td></tr></table></figure><ul><li>traefix-uiç•Œé¢ä¸Šå¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1567739737385.jpg" alt="img"></li></ul><p>ä»describeä¿¡æ¯å’Œuiç•Œé¢ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œtomcat.test.k8såˆ†åˆ«æœ‰äº†/test1/å’Œ/test2/çš„åŸŸåä»£ç†ä»¥åŠç›¸å¯¹åº”çš„åç«¯<br><img src="https://img.xxlaila.cn/1567739822127.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567739856570.jpg" alt="img"></p><p><a href="https://xuchao918.github.io/2019/03/01/Kubernetes-traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®2</a><br><a href="https://blog.51cto.com/icenycmh/2124502" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®1</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s-helm</title>
    <url>/2019/09/04/k8s-helm/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helmç±»ä¼¼ä¸linuxä¸‹é¢çš„yumï¼ŒHelmæ˜¯ä¸€ä¸ªç”¨äºkubernetesçš„åŒ…ç®¡ç†å™¨ï¼Œæ¯ä¸€ä¸ªåŒ…ä¸ºä¸€ä¸ªchartï¼Œä¸€ä¸ªchartæ˜¯ä¸€ä¸ªç›®å½•ï¼Œå¸¸å¸¸ä¼šå¯¹ç›®å½•è¿›è¡Œæ‰“åŒ…å‹ç¼©ï¼Œå½¢æˆä¸€ä¸ª${name}-version.tgzçš„æ ¼å¼è¿›è¡Œä¼ è¾“å’Œå­˜å‚¨ã€‚</p><ul><li>å¯¹äºåº”ç”¨å‘å¸ƒè€…è€Œè¨€ï¼Œå¯ä»¥é€šè¿‡Helmæ‰“åŒ…åº”ç”¨ï¼Œç®¡ç†åº”ç”¨ä¾èµ–å…³ç³»ï¼Œç®¡ç†åº”ç”¨ç‰ˆæœ¬å¹¶å‘å¸ƒåº”ç”¨åˆ°è½¯ä»¶ä»“åº“ã€‚</li><li>å¯¹äºä½¿ç”¨è€…è€Œè¨€ï¼Œä½¿ç”¨Helmåä¸ç”¨éœ€è¦äº†è§£Kubernetesçš„Yamlè¯­æ³•å¹¶ç¼–å†™åº”ç”¨éƒ¨ç½²æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡Helmä¸‹è½½å¹¶åœ¨kubernetesä¸Šå®‰è£…éœ€è¦çš„åº”ç”¨ã€‚</li></ul><p>Helmè¿˜æä¾›äº†kubernetesä¸Šçš„è½¯ä»¶éƒ¨ç½²ï¼Œåˆ é™¤ï¼Œå‡çº§ï¼Œå›æ»šåº”ç”¨çš„å¼ºå¤§åŠŸèƒ½</p><a id="more"></a><h3 id="1ã€helmç»„ä»¶"><a href="#1ã€helmç»„ä»¶" class="headerlink" title="1ã€helmç»„ä»¶"></a>1ã€helmç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œä¸‹çš„å®¢æˆ·ç«¯å·¥å…·ã€‚ä¸»è¦ç”¨äº Kubernetes åº”ç”¨ç¨‹åº Chart çš„åˆ›å»ºã€æ‰“åŒ…ã€å‘å¸ƒä»¥åŠåˆ›å»ºå’Œç®¡ç†æœ¬åœ°å’Œè¿œç¨‹çš„ Chart ä»“åº“ã€‚</p><h4 id="1-1ã€Tiller"><a href="#1-1ã€Tiller" class="headerlink" title="1.1ã€Tiller"></a>1.1ã€Tiller</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tiller æ˜¯ Helm çš„æœåŠ¡ç«¯ï¼Œéƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­ã€‚Tiller ç”¨äºæ¥æ”¶ Helm çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ® Chart ç”Ÿæˆ Kubernetes çš„éƒ¨ç½²æ–‡ä»¶ï¼ˆ Helm ç§°ä¸º Release ï¼‰ï¼Œç„¶åæäº¤ç»™ Kubernetes åˆ›å»ºåº”ç”¨ã€‚Tiller è¿˜æä¾›äº† Release çš„å‡çº§ã€åˆ é™¤ã€å›æ»šç­‰ä¸€ç³»åˆ—åŠŸèƒ½ã€‚</p><h4 id="1-2ã€Chart"><a href="#1-2ã€Chart" class="headerlink" title="1.2ã€Chart"></a>1.2ã€Chart</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm çš„è½¯ä»¶åŒ…ï¼Œé‡‡ç”¨ TAR æ ¼å¼ã€‚ç±»ä¼¼äº APT çš„ DEB åŒ…æˆ–è€… YUM çš„ RPM åŒ…ï¼Œå…¶åŒ…å«äº†ä¸€ç»„å®šä¹‰ Kubernetes èµ„æºç›¸å…³çš„ YAML æ–‡ä»¶</p><h4 id="1-3ã€Repoistory"><a href="#1-3ã€Repoistory" class="headerlink" title="1.3ã€Repoistory"></a>1.3ã€Repoistory</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm çš„è½¯ä»¶ä»“åº“ï¼ŒRepository æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨ä¿å­˜äº†ä¸€ç³»åˆ—çš„ Chart è½¯ä»¶åŒ…ä»¥ä¾›ç”¨æˆ·ä¸‹è½½ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªè¯¥ Repository çš„ Chart åŒ…çš„æ¸…å•æ–‡ä»¶ä»¥ä¾›æŸ¥è¯¢ã€‚Helm å¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ªä¸åŒçš„ Repository</p><h4 id="1-4ã€Release"><a href="#1-4ã€Release" class="headerlink" title="1.4ã€Release"></a>1.4ã€Release</h4><p>ä½¿ç”¨ helm install å‘½ä»¤åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²çš„ Chart ç§°ä¸º Release</p><h3 id="2ã€helmå®‰è£…"><a href="#2ã€helmå®‰è£…" class="headerlink" title="2ã€helmå®‰è£…"></a>2ã€helmå®‰è£…</h3><ul><li>ä¸‹è½½helm<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://storage.googleapis.com/kubernetes-helm/helm-v2.14.3-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf helm-v2.14.3-linux-amd64.tar.gz &amp;&amp; mv linux-amd64/&#123;helm,tiller&#125; /usr/bin</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·"><a href="#2-1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·" class="headerlink" title="2.1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·"></a>2.1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount tiller --namespace kube-system</span></span><br><span class="line">serviceaccount/tiller created</span><br></pre></td></tr></table></figure><h4 id="2-2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"><a href="#2-2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²" class="headerlink" title="2.2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"></a>2.2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create clusterrolebinding tiller-admin-binding --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/tiller-admin-binding created</span><br></pre></td></tr></table></figure><h4 id="2-2ã€å®‰è£…tiller"><a href="#2-2ã€å®‰è£…tiller" class="headerlink" title="2.2ã€å®‰è£…tiller"></a>2.2ã€å®‰è£…tiller</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm init --service-account tiller --upgrade -i docker.io/sapcc/tiller:v2.14.3 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span><br></pre></td></tr></table></figure><h5 id="2-2-1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ"><a href="#2-2-1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ" class="headerlink" title="2.2.1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ"></a>2.2.1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods|grep tiller</span></span><br><span class="line">tiller-deploy-75b8f8575d-fplck          1/1     Running   0          17h</span><br><span class="line"></span><br><span class="line"><span class="comment"># helm version</span></span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.3"</span>, GitCommit:<span class="string">"0e7f3b6637f7af8fcfddb3d2941fcc7cbebb0085"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.3"</span>, GitCommit:<span class="string">"0e7f3b6637f7af8fcfddb3d2941fcc7cbebb0085"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é”™è¯¯</strong>: è¿™é‡Œå®‰è£…å®Œæˆåæ‰§è¡Œ<code>helm version</code>æç¤ºé”™è¯¯ï¼Œå†…å®¹å¦‚ä¸‹:<br><code>E0904 18:51:07.730671 22845 portforward.go:391] an error occurred forwarding 38767 -&gt; 44134: error forwarding port 44134 to pod b52064300cfa79e6d83795535584f89c97c33dc91ea39c024492b7b40e3fb68e, uid : unable to do port forwarding: socat not found.</code>è¿™ä¸ªé”™è¯¯éœ€è¦åœ¨å®¢æˆ·ç«¯å®‰è£…ä¸€ä¸ª<a href="https://github.com/helm/helm/issues/1371" target="_blank" rel="noopener">socatæ’ä»¶</a></li></ul><ul><li><p>åœ¨nodeå®‰è£…socat</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y socat</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹helmç¬¬ä¸‰æ–¹å­˜å‚¨åº“(å¯é€‰)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add stable https://burdenbear.github.io/kube-charts-mirror/</span></span><br><span class="line"><span class="comment"># helm repo list</span></span><br><span class="line">NAME     URL                                             </span><br><span class="line"><span class="built_in">local</span>    http://127.0.0.1:8879/charts                    </span><br><span class="line">monocular https://helm.github.io/monocular                </span><br><span class="line">stable   https://burdenbear.github.io/kube-charts-mirror/</span><br></pre></td></tr></table></figure></li></ul><h3 id="3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm-web"><a href="#3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm-web" class="headerlink" title="3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm web"></a>3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm web</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm list</span></span><br><span class="line"><span class="comment"># helm search</span></span><br><span class="line"><span class="comment"># helm search mysql --versions</span></span><br><span class="line"><span class="comment"># helm repo list</span></span><br><span class="line"><span class="comment"># helm serve --address 0.0.0.0:8879 &amp;</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567651293339.jpg" alt="img"></p><h3 id="4ã€helm-web-ui"><a href="#4ã€helm-web-ui" class="headerlink" title="4ã€helm web ui"></a>4ã€helm web ui</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;helmå®‰è£…ä»¥åï¼Œç»å¸¸ä½¿ç”¨helm cliå‘½æ¥è¿›è¡Œéƒ¨ç½²è¿˜æ˜¯æ¯”è¾ƒåƒåŠ›çš„ï¼Œè€Œä¸”å¯¹äºæœ‰äº›äººä¸å–œæ¬¢cliçš„æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç—›è‹¦çš„äº‹æƒ…ï¼Œè¿™é‡Œä»‹ç»ä¸€æ¬¾kubeappsï¼ŒKubeappsæ˜¯ä¸€ä¸ªåŸºäºWebçš„UIï¼Œç”¨äºåœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºã€‚ Kubeappså…è®¸æ‚¨ï¼š</p><ul><li>ä»å›¾è¡¨å­˜å‚¨åº“ä¸­æµè§ˆå’Œéƒ¨ç½²Helmå›¾è¡¨</li><li>æ£€æŸ¥ï¼Œå‡çº§å’Œåˆ é™¤ç¾¤é›†ä¸­å®‰è£…çš„åŸºäºHelmçš„åº”ç”¨ç¨‹åº</li><li>æ·»åŠ è‡ªå®šä¹‰å’Œç§æœ‰å›¾è¡¨å­˜å‚¨åº“ï¼ˆæ”¯æŒChartMuseumå’ŒJFrog Artifactory)</li><li>ä»æœåŠ¡ç›®å½•å’Œå¯ç”¨çš„Service Brokersæµè§ˆå’Œé…ç½®å¤–éƒ¨æœåŠ¡</li><li>ä½¿ç”¨æœåŠ¡ç›®å½•ç»‘å®šå°†åŸºäºHelmçš„åº”ç”¨ç¨‹åºè¿æ¥åˆ°å¤–éƒ¨æœåŠ¡</li><li>åŸºäºKubernetesåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶çš„å®‰å…¨èº«ä»½éªŒè¯å’Œæˆæƒ</li></ul><h4 id="4-1ã€å®‰è£…kubeapps"><a href="#4-1ã€å®‰è£…kubeapps" class="headerlink" title="4.1ã€å®‰è£…kubeapps"></a>4.1ã€å®‰è£…kubeapps</h4><p>ä½¿ç”¨Helmå›¾è¡¨å®‰è£…<a href="https://github.com/kubeapps/kubeapps" target="_blank" rel="noopener">æœ€æ–°ç‰ˆæœ¬çš„Kubeapps</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add bitnami https://charts.bitnami.com/bitnami</span></span><br><span class="line"><span class="comment"># helm install --name kubeapps --namespace kubeapps bitnami/kubeapps</span></span><br></pre></td></tr></table></figure><h4 id="4-2ã€å¯åŠ¨kubeappsDashboard"><a href="#4-2ã€å¯åŠ¨kubeappsDashboard" class="headerlink" title="4.2ã€å¯åŠ¨kubeappsDashboard"></a>4.2ã€å¯åŠ¨kubeappsDashboard</h4><p>å®‰è£…Kubeappsåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»ç³»ç»Ÿå®‰å…¨è®¿é—®Kubeapps Dashboard</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export POD_NAME=$(kubectl get pods --namespace kubeapps -l "app=kubeapps" -o jsonpath="&#123;.items[0].metadata.name&#125;")</span></span><br><span class="line"><span class="comment"># kubectl port-forward -n kubeapps $POD_NAME --address 0.0.0.0 8081:8080 &amp;</span></span><br><span class="line"><span class="comment"># æŠŠå®¹å™¨çš„8080 æ˜ å°„åˆ°æœ¬åœ°çš„8081ç«¯å£ï¼Œç”¨äºæµè§ˆå™¨è®¿é—®</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567650844980.jpg" alt="img"></p><h4 id="4-3ã€åˆ›å»ºtoken"><a href="#4-3ã€åˆ›å»ºtoken" class="headerlink" title="4.3ã€åˆ›å»ºtoken"></a>4.3ã€åˆ›å»ºtoken</h4><p>è®¿é—®ä»ªè¡¨æ¿éœ€è¦Kubernetes APIä»¤ç‰Œæ‰èƒ½é€šè¿‡Kubernetes APIæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount kubeapps-operator</span></span><br><span class="line">serviceaccount/kubeapps-operator created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding kubeapps-operator --clusterrole=cluster-admin --serviceaccount=default:kubeapps-operator</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubeapps-operator created</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–token</span></span><br><span class="line"><span class="comment"># kubectl get secret $(kubectl get serviceaccount kubeapps-operator -o jsonpath='&#123;.secrets[].name&#125;') -o jsonpath='&#123;.data.token&#125;' | base64 --decode</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567650971425.jpg" alt="img"></p><h5 id="4-3-1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬"><a href="#4-3-1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬" class="headerlink" title="4.3.1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬"></a>4.3.1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬</h5><p>æ¯æ¬¡è®¿é—®kubeappsçš„token éƒ½è¦è¾“å…¥ä¸€é•¿ä¸²ï¼Œè¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªshellè„šæœ¬ï¼Œæ”¾åœ¨<code>/usr/bin</code>ç›®å½•ï¼Œéœ€è¦çš„æ—¶å€™æ‰§è¡Œå‘½ä»¤å³å¯ï¼Œè¿™æ ·æ–¹ä¾¿ç”¨äºè®°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/bin/kubeapps</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">kubectl get secret $(kubectl get serviceaccount kubeapps-operator -o jsonpath=<span class="string">'&#123;.secrets[].name&#125;'</span>) -o jsonpath=<span class="string">'&#123;.data.token&#125;'</span> | base64 --decode</span><br><span class="line"><span class="comment"># chmod +x /usr/bin/kubeapps</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>helm</tag>
      </tags>
  </entry>
  <entry>
    <title>metrics-serverå®‰è£…å­£</title>
    <url>/2019/09/04/metrics-server%E5%AE%89%E8%A3%85%E5%AD%A3/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metrics-server é€šè¿‡ kube-apiserver å‘ç°æ‰€æœ‰èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨ kubelet APIsï¼ˆé€šè¿‡ https æ¥å£ï¼‰è·å¾—å„èŠ‚ç‚¹ï¼ˆNodeï¼‰å’Œ Pod çš„ CPUã€Memory ç­‰èµ„æºä½¿ç”¨æƒ…å†µã€‚Kubernetes 1.12 å¼€å§‹ï¼Œkubernetes çš„å®‰è£…è„šæœ¬ç§»é™¤äº† Heapsterï¼Œä» 1.13 å¼€å§‹å®Œå…¨ç§»é™¤äº†å¯¹ Heapster çš„æ”¯æŒï¼ŒHeapster ä¸å†è¢«ç»´æŠ¤ã€‚</p><ul><li>æ›¿ä»£æ–¹æ¡ˆå¦‚ä¸‹:<ul><li>ç”¨äºæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹çš„ CPU/memory HPA metricsï¼šmetrics-server</li><li>é€šç”¨çš„ç›‘æ§æ–¹æ¡ˆï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹å¯ä»¥è·å– Prometheus æ ¼å¼ç›‘æ§æŒ‡æ ‡çš„ç›‘æ§ç³»ç»Ÿï¼Œå¦‚ Prometheus Operator</li><li>äº‹ä»¶ä¼ è¾“ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æ¥ä¼ è¾“ã€å½’æ¡£ kubernetes events</li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨ metrics-server æ›¿ä»£ Heapsterï¼Œå°†æ— æ³•åœ¨ dashboard ä¸­ä»¥å›¾å½¢å±•ç¤º Pod çš„å†…å­˜å’Œ CPU æƒ…å†µï¼Œéœ€è¦é€šè¿‡ Prometheusã€Grafana ç­‰ç›‘æ§æ–¹æ¡ˆæ¥å¼¥è¡¥ã€‚</p><a id="more"></a><h4 id="1ã€ç›‘æ§æ¶æ„"><a href="#1ã€ç›‘æ§æ¶æ„" class="headerlink" title="1ã€ç›‘æ§æ¶æ„"></a>1ã€ç›‘æ§æ¶æ„</h4><p><img src="https://img.xxlaila.cn/2748678bdjsg848sd.png" alt="img"></p><h4 id="2ã€å®‰è£…-metrics-server"><a href="#2ã€å®‰è£…-metrics-server" class="headerlink" title="2ã€å®‰è£… metrics-server"></a>2ã€å®‰è£… metrics-server</h4><ul><li>ä» github clone æºç <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/metrics-server</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">aggregated-metrics-reader.yaml  auth-delegator.yaml  auth-reader.yaml  metrics-apiservice.yaml  metrics-server-deployment.yaml  metrics-server-service.yaml  resource-reader.yaml</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>æ³¨æ„</strong>: ä¹‹å‰åœ¨å®‰è£…çš„æ—¶å€™é‡åˆ°å¾ˆå¤šå‘ï¼Œè€Œä¸”ç½‘ä¸Šçœ‹äº†æ•™ç¨‹åŸºæœ¬ä¸Šä¸èƒ½ç”¨ï¼Œå¾ˆå‘ï¼Œè‡ªå·±çœ‹ç½‘ä¸Šæ•™ç¨‹ï¼Œç„¶åæ ¹æ®æ¯ä¸€ä¸ªé”™è¯¯æ¥è¿›è¡Œè§£å†³ï¼Œç»ˆäºï¼ŒåŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼ŒèŠ±äº†ä¸€å¤©åŠç»ˆäºæå®šå•¦ã€‚</li></ul><h4 id="3ã€metrics-server-æ–‡ä»¶ä¿®æ”¹"><a href="#3ã€metrics-server-æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="3ã€metrics-server æ–‡ä»¶ä¿®æ”¹"></a>3ã€metrics-server æ–‡ä»¶ä¿®æ”¹</h4><p>metrics-server yamlæ–‡ä»¶è¿™é‡Œæ–‡ä»¶å·²ç»ä¿®æ”¹å¥½äº†ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ï¼Œ<a href="https://github.com/kubernetes-incubator/metrics-server/issues/247" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a>ï¼Œ</p><h5 id="3-1ã€metrics-server-deployment-yaml"><a href="#3-1ã€metrics-server-deployment-yaml" class="headerlink" title="3.1ã€metrics-server-deployment.yaml"></a>3.1ã€metrics-server-deployment.yaml</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat metrics-server-deployment.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      hostNetwork: <span class="literal">true</span>   <span class="comment">#å¢åŠ è¡Œ</span></span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span><br><span class="line">      - name: tmp-dir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: mirrorgooglecontainers/metrics-server-amd64:v0.3.3</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/kubernetes/</span><br><span class="line">          name: ca-ssl</span><br><span class="line">        <span class="built_in">command</span>:   <span class="comment"># commandå†…å®¹å‡ä¸ºå¢åŠ </span></span><br><span class="line">        - /metrics-server</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br><span class="line">        - --requestheader-client-ca-file=/etc/ssl/kubernetes/front-proxy-ca.pem</span><br><span class="line">        - --kubelet-insecure-tls=<span class="literal">true</span></span><br><span class="line">      volumes:</span><br><span class="line">       - name: ca-ssl</span><br><span class="line">         hostPath:</span><br><span class="line">          path: /etc/kubernetes/ssl</span><br></pre></td></tr></table></figure><h5 id="3-2ã€"><a href="#3-2ã€" class="headerlink" title="3.2ã€"></a>3.2ã€</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat resource-reader.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/stats</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups: <span class="comment"># å¢åŠ </span></span><br><span class="line">  - <span class="string">"extensions"</span></span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure><h4 id="4ã€å‡†å¤‡è¯ä¹¦"><a href="#4ã€å‡†å¤‡è¯ä¹¦" class="headerlink" title="4ã€å‡†å¤‡è¯ä¹¦"></a>4ã€å‡†å¤‡è¯ä¹¦</h4><p>è¿™äº›è¯ä¹¦æ–‡ä»¶ä¸»è¦ç”¨åœ¨Metrics API aggregator ä¸Š,<a href="https://blog.51cto.com/ylw6006/2114338" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><ul><li><p>front-proxy-ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat front-proxy-ca-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>front-proxy-client-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"front-proxy-client"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="4-1ã€ç”Ÿæˆè¯ä¹¦"><a href="#4-1ã€ç”Ÿæˆè¯ä¹¦" class="headerlink" title="4.1ã€ç”Ÿæˆè¯ä¹¦"></a>4.1ã€ç”Ÿæˆè¯ä¹¦</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca</span></span><br><span class="line"><span class="comment"># cfssl gencert \</span></span><br><span class="line"> -ca=front-proxy-ca.pem \</span><br><span class="line"> -ca-key=front-proxy-ca-key.pem \</span><br><span class="line"> -config=/root/ssl/kubernetes-gencert.json \</span><br><span class="line"> -profile=kubernetes \</span><br><span class="line"> front-proxy-client-csr.json | cfssljson -bare front-proxy-client</span><br><span class="line"><span class="comment"># ls *.pem</span></span><br><span class="line">front-proxy-ca-key.pem  front-proxy-ca.pem  front-proxy-client-key.pem  front-proxy-client.pem</span><br></pre></td></tr></table></figure><ul><li>è¯ä¹¦ç”Ÿæˆå®Œæˆåï¼Œå§è¯ä¹¦å¤åˆ¶åˆ°æ‰€æœ‰çš„masterèŠ‚ç‚¹å’ŒnodeèŠ‚ç‚¹</li></ul><h4 id="5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶"></a>5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶</h4><h4 id="5-1ã€apiserver"><a href="#5-1ã€apiserver" class="headerlink" title="5.1ã€apiserver"></a>5.1ã€apiserver</h4><p>åœ¨apiserveré…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--runtime-config=api/all=<span class="literal">true</span> \</span><br><span class="line">--<span class="built_in">enable</span>-aggregator-routing=<span class="literal">true</span> \</span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/ssl/front-proxy-ca.pem \</span><br><span class="line">--requestheader-allowed-names=aggregator \</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \</span><br><span class="line">--requestheader-username-headers=X-Remote-User \</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/ssl/front-proxy-client.pem \</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/ssl/front-proxy-client-key.pem \</span><br></pre></td></tr></table></figure><ul><li>apiserveré…ç½®æ–‡ä»¶KUBE_API_ARGSå†…å®¹å¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBE_API_ARGS=<span class="string">" --allow-privileged=true \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --alsologtostderr \</span></span><br><span class="line"><span class="string">                --apiserver-count=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">                --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">                --enable-aggregator-routing=true \</span></span><br><span class="line"><span class="string">                --audit-log-path=/var/log/kube-audit/audit.log \</span></span><br><span class="line"><span class="string">                --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span></span><br><span class="line"><span class="string">                --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">                --enable-garbage-collector \</span></span><br><span class="line"><span class="string">                --enable-logs-handler \</span></span><br><span class="line"><span class="string">                --endpoint-reconciler-type=lease \</span></span><br><span class="line"><span class="string">                --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span></span><br><span class="line"><span class="string">                --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">                --etcd-compaction-interval=0s \</span></span><br><span class="line"><span class="string">                --event-ttl=168h0m0s \</span></span><br><span class="line"><span class="string">                --kubelet-https=true \</span></span><br><span class="line"><span class="string">                --kubelet-certificate-authority=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem \</span></span><br><span class="line"><span class="string">                --kubelet-timeout=3s \</span></span><br><span class="line"><span class="string">                --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">                --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">                --service-account-key-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">                --requestheader-client-ca-file=/etc/kubernetes/ssl/front-proxy-ca.pem \</span></span><br><span class="line"><span class="string">                --requestheader-allowed-names=aggregator \</span></span><br><span class="line"><span class="string">                --requestheader-extra-headers-prefix=X-Remote-Extra- \</span></span><br><span class="line"><span class="string">                --requestheader-group-headers=X-Remote-Group \</span></span><br><span class="line"><span class="string">                --requestheader-username-headers=X-Remote-User \</span></span><br><span class="line"><span class="string">                --proxy-client-cert-file=/etc/kubernetes/ssl/front-proxy-client.pem \</span></span><br><span class="line"><span class="string">                --proxy-client-key-file=/etc/kubernetes/ssl/front-proxy-client-key.pem \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="5-2ã€kube-control-manager"><a href="#5-2ã€kube-control-manager" class="headerlink" title="5.2ã€kube-control-manager"></a>5.2ã€kube-control-manager</h5><p>åœ¨controller-manageræ–‡ä»¶å¢åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--horizontal-pod-autoscaler-use-rest-clients=<span class="literal">true</span> \</span><br></pre></td></tr></table></figure><ul><li>kube-control-manageré…ç½®æ–‡ä»¶KUBE_CONTROLLER_MANAGER_ARGSå¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">                                --cluster-signing-cert-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --cluster-signing-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">                                --deployment-controller-sync-period=10s \</span></span><br><span class="line"><span class="string">                                --experimental-cluster-signing-duration=87600h0m0s \</span></span><br><span class="line"><span class="string">                                --enable-garbage-collector=true \</span></span><br><span class="line"><span class="string">                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --leader-elect=true \</span></span><br><span class="line"><span class="string">                                --node-monitor-grace-period=20s \</span></span><br><span class="line"><span class="string">                                --node-monitor-period=5s \</span></span><br><span class="line"><span class="string">                                --port=10252 \</span></span><br><span class="line"><span class="string">                                --pod-eviction-timeout=2m0s \</span></span><br><span class="line"><span class="string">                                --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --terminated-pod-gc-threshold=50 \</span></span><br><span class="line"><span class="string">                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">                                --root-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --secure-port=10257 \</span></span><br><span class="line"><span class="string">                                --service-cluster-ip-range=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                                --service-account-private-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">                                --horizontal-pod-autoscaler-use-rest-clients=true \</span></span><br><span class="line"><span class="string">                                --v=2"</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="5-3ã€é‡å¯æœåŠ¡"><a href="#5-3ã€é‡å¯æœåŠ¡" class="headerlink" title="5.3ã€é‡å¯æœåŠ¡"></a>5.3ã€é‡å¯æœåŠ¡</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl  restart kube-apiserver.service &amp;&amp;systemctl  restart kube-controller-manager</span></span><br></pre></td></tr></table></figure><h4 id="6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹"><a href="#6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹"></a>6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹</h4><p>node èŠ‚ç‚¹ä¿®æ”¹ä¿®æ”¹kubeletæ–‡ä»¶</p><ul><li><p>kubeleté…ç½®æ–‡ä»¶å®Œæˆçš„KUBELET_ARGSå‚æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBELET_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                --allow-privileged \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --authorization-mode=Webhook \</span></span><br><span class="line"><span class="string">                --authentication-token-webhook=true \</span></span><br><span class="line"><span class="string">                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --cgroup-driver=cgroupfs \</span></span><br><span class="line"><span class="string">                --cert-dir=/etc/kubernetes/ssl \</span></span><br><span class="line"><span class="string">                --cluster-dns=10.254.0.2 \</span></span><br><span class="line"><span class="string">                --cluster-domain=cluster.local \</span></span><br><span class="line"><span class="string">                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% \</span></span><br><span class="line"><span class="string">                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m \</span></span><br><span class="line"><span class="string">                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% \</span></span><br><span class="line"><span class="string">                --eviction-max-pod-grace-period=30 \</span></span><br><span class="line"><span class="string">                --image-gc-high-threshold=80 \</span></span><br><span class="line"><span class="string">                --image-gc-low-threshold=70 \</span></span><br><span class="line"><span class="string">                --image-pull-progress-deadline=30s \</span></span><br><span class="line"><span class="string">                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">                --max-pods=100 \</span></span><br><span class="line"><span class="string">                --minimum-image-ttl-duration=720h0m0s \</span></span><br><span class="line"><span class="string">                --node-labels=node.kubernetes.io/k8s-node=true \</span></span><br><span class="line"><span class="string">                --pod-infra-container-image=docker.io/kubernetes/pause:latest \</span></span><br><span class="line"><span class="string">                --port=10250 \</span></span><br><span class="line"><span class="string">                --read-only-port=0 \</span></span><br><span class="line"><span class="string">                --rotate-certificates \</span></span><br><span class="line"><span class="string">                --rotate-server-certificates \</span></span><br><span class="line"><span class="string">                --fail-swap-on=false \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯kubelet</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl restart kubelet</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="7ã€åˆ›å»ºmetrics"><a href="#7ã€åˆ›å»ºmetrics" class="headerlink" title="7ã€åˆ›å»ºmetrics"></a>7ã€åˆ›å»ºmetrics</h4><p>é€šè¿‡yamlæ–‡ä»¶åˆ›å»ºå¯¹åº”çš„èµ„æº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ./</span></span><br></pre></td></tr></table></figure><h5 id="7-1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ"><a href="#7-1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ" class="headerlink" title="7.1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ"></a>7.1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods -l k8s-app=metrics-server</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-84b786c9bb-7trdr   1/1     Running   0          62m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get svc -n kube-system  metrics-server</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">metrics-server   ClusterIP   10.254.45.238   &lt;none&gt;        443/TCP   3h6m</span><br></pre></td></tr></table></figure><h5 id="7-2ã€è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯"><a href="#7-2ã€è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯" class="headerlink" title="7.2ã€è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯"></a>7.2ã€è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰<code>v1beta1.metrics.k8s.io kube-system/metrics-server True 3h</code>å‚æ•°ä¸€ç›´æ˜¯<code>v1beta1.metrics.k8s.io kube-system/metrics-server False (FailedDiscoveryCheck) 16m</code>,</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kubectl get apiservice</span></span><br><span class="line">NAME                                    SERVICE                      AVAILABLE   AGE</span><br><span class="line">v1.                                     Local                        True        4d</span><br><span class="line">v1.apps                                 Local                        True        4d</span><br><span class="line">v1.authentication.k8s.io                Local                        True        4d</span><br><span class="line">v1.authorization.k8s.io                 Local                        True        4d</span><br><span class="line">v1.autoscaling                          Local                        True        4d</span><br><span class="line">v1.batch                                Local                        True        4d</span><br><span class="line">v1.networking.k8s.io                    Local                        True        4d</span><br><span class="line">v1.rbac.authorization.k8s.io            Local                        True        4d</span><br><span class="line">v1.storage.k8s.io                       Local                        True        4d</span><br><span class="line">v1alpha1.admissionregistration.k8s.io   Local                        True        4d</span><br><span class="line">v1alpha1.auditregistration.k8s.io       Local                        True        4d</span><br><span class="line">v1alpha1.rbac.authorization.k8s.io      Local                        True        4d</span><br><span class="line">v1alpha1.scheduling.k8s.io              Local                        True        4d</span><br><span class="line">v1alpha1.settings.k8s.io                Local                        True        4d</span><br><span class="line">v1alpha1.storage.k8s.io                 Local                        True        4d</span><br><span class="line">v1beta1.admissionregistration.k8s.io    Local                        True        4d</span><br><span class="line">v1beta1.apiextensions.k8s.io            Local                        True        4d</span><br><span class="line">v1beta1.apps                            Local                        True        4d</span><br><span class="line">v1beta1.authentication.k8s.io           Local                        True        4d</span><br><span class="line">v1beta1.authorization.k8s.io            Local                        True        4d</span><br><span class="line">v1beta1.batch                           Local                        True        4d</span><br><span class="line">v1beta1.certificates.k8s.io             Local                        True        4d</span><br><span class="line">v1beta1.coordination.k8s.io             Local                        True        4d</span><br><span class="line">v1beta1.events.k8s.io                   Local                        True        4d</span><br><span class="line">v1beta1.extensions                      Local                        True        4d</span><br><span class="line">v1beta1.metrics.k8s.io                  kube-system/metrics-server   True        3h</span><br><span class="line">v1beta1.policy                          Local                        True        4d</span><br><span class="line">v1beta1.rbac.authorization.k8s.io       Local                        True        4d</span><br><span class="line">v1beta1.scheduling.k8s.io               Local                        True        4d</span><br><span class="line">v1beta1.storage.k8s.io                  Local                        True        4d</span><br><span class="line">v1beta2.apps                            Local                        True        4d</span><br><span class="line">v2alpha1.batch                          Local                        True        4d</span><br><span class="line">v2beta1.autoscaling                     Local                        True        4d</span><br><span class="line">v2beta2.autoscaling                     Local                        True        4d</span><br></pre></td></tr></table></figure><h4 id="8ã€æŸ¥çœ‹-metrics-server-è¾“å‡ºçš„-metrics"><a href="#8ã€æŸ¥çœ‹-metrics-server-è¾“å‡ºçš„-metrics" class="headerlink" title="8ã€æŸ¥çœ‹ metrics-server è¾“å‡ºçš„ metrics"></a>8ã€æŸ¥çœ‹ metrics-server è¾“å‡ºçš„ metrics</h4><h5 id="8-1ã€é€šè¿‡-kube-apiserver-æˆ–-kubectl-proxy-è®¿é—®"><a href="#8-1ã€é€šè¿‡-kube-apiserver-æˆ–-kubectl-proxy-è®¿é—®" class="headerlink" title="8.1ã€é€šè¿‡ kube-apiserver æˆ– kubectl proxy è®¿é—®"></a>8.1ã€é€šè¿‡ kube-apiserver æˆ– kubectl proxy è®¿é—®</h5><ul><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes/" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes/</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/pods" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/pods</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/namespace//pods/" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/namespace//pods/</a></li></ul><h5 id="8-2ã€ç›´æ¥ä½¿ç”¨-kubectl-å‘½ä»¤è®¿é—®"><a href="#8-2ã€ç›´æ¥ä½¿ç”¨-kubectl-å‘½ä»¤è®¿é—®" class="headerlink" title="8.2ã€ç›´æ¥ä½¿ç”¨ kubectl å‘½ä»¤è®¿é—®"></a>8.2ã€ç›´æ¥ä½¿ç”¨ kubectl å‘½ä»¤è®¿é—®</h5><ul><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/nodes</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/pods</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/nodes/</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/namespace//pods/</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get --raw "/apis/metrics.k8s.io/v1beta1" | jq .</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"APIResourceList"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">  <span class="string">"groupVersion"</span>: <span class="string">"metrics.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"resources"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"nodes"</span>,</span><br><span class="line">      <span class="string">"singularName"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"namespaced"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"kind"</span>: <span class="string">"NodeMetrics"</span>,</span><br><span class="line">      <span class="string">"verbs"</span>: [</span><br><span class="line">        <span class="string">"get"</span>,</span><br><span class="line">        <span class="string">"list"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"pods"</span>,</span><br><span class="line">      <span class="string">"singularName"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"namespaced"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"kind"</span>: <span class="string">"PodMetrics"</span>,</span><br><span class="line">      <span class="string">"verbs"</span>: [</span><br><span class="line">        <span class="string">"get"</span>,</span><br><span class="line">        <span class="string">"list"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get --raw "/apis/metrics.k8s.io/v1beta1/nodes" | jq .</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"NodeMetricsList"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"metrics.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"metadata"</span>: &#123;</span><br><span class="line">    <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"items"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.204"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.204"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:40Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"63788460n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"1033152Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.240"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.240"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:40Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"41797865n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"837420Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.87"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.87"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:34Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"37347688n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"851232Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>/apis/metrics.k8s.io/v1beta1/nodes å’Œ /apis/metrics.k8s.io/v1beta1/pods è¿”å›çš„ usage åŒ…å« CPU å’Œ Memoryï¼›</li></ul><h4 id="ä½¿ç”¨-kubectl-top"><a href="#ä½¿ç”¨-kubectl-top" class="headerlink" title="ä½¿ç”¨ kubectl top"></a>ä½¿ç”¨ kubectl top</h4><p>ä½¿ç”¨ kubectl top å‘½ä»¤æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ,kubectl top å‘½ä»¤ä» metrics-server è·å–é›†ç¾¤èŠ‚ç‚¹åŸºæœ¬çš„æŒ‡æ ‡ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl top node</span></span><br><span class="line">NAME            CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">172.21.16.204   69m          1%     1008Mi          13%       </span><br><span class="line">172.21.16.240   41m          2%     817Mi           23%       </span><br><span class="line">172.21.16.87    39m          1%     831Mi           23%</span><br></pre></td></tr></table></figure><p>metricsåˆ°è¿™é‡Œå°±å·²ç»æˆåŠŸçš„éƒ¨ç½²ï¼Œå‚æ•°æ²¡æœ‰ä¸€ä¸€ä»‹ç»ï¼ŒåæœŸæœ‰æ—¶é—´åœ¨åˆ—å‡ºæ¥</p><p>è¿™é‡Œè¿˜æœ‰å¾ˆå¤šå‚è€ƒçš„æ–‡æ¡£æ²¡æœ‰ä¸€ä¸€åˆ—å‡ºæ¥ï¼Œä¸»è¦æ˜¯æµè§ˆå™¨è¢«å…³é—­å•¦ï¼Œæ„Ÿè°¢é‚£äº›å‚è€ƒçš„æ–‡æ¡£ï¼ŒğŸ˜ŠğŸ˜ŠğŸ˜Š</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>metrics-server</tag>
      </tags>
  </entry>
  <entry>
    <title>kubeletæä¾›apiè¯·æ±‚æ¥å£</title>
    <url>/2019/09/04/kubelet%E6%8F%90%E4%BE%9Bapi%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="kubelet-æä¾›çš„-API-æ¥å£è®¤è¯"><a href="#kubelet-æä¾›çš„-API-æ¥å£è®¤è¯" class="headerlink" title="kubelet æä¾›çš„ API æ¥å£è®¤è¯"></a>kubelet æä¾›çš„ API æ¥å£è®¤è¯</h3><p><a href="https://xxlaila.github.io/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">nodeå®‰è£…å‚è€ƒ</a></p><p>kubelet å¯åŠ¨åç›‘å¬å¤šä¸ªç«¯å£ï¼Œç”¨äºæ¥æ”¶ kube-apiserver æˆ–å…¶å®ƒå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-3 ~]<span class="comment">#  netstat -lnpt|grep kubelet</span></span><br><span class="line">tcp        0      0 127.0.0.1:46395         0.0.0.0:*               LISTEN      8941/kubelet        </span><br><span class="line">tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      8941/kubelet        </span><br><span class="line">tcp6       0      0 :::10250                :::*                    LISTEN      8941/kubelet</span><br></pre></td></tr></table></figure><ul><li><strong>10248</strong>: healthz http æœåŠ¡</li><li><strong>10250</strong>: https æœåŠ¡ï¼Œè®¿é—®è¯¥ç«¯å£æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼ˆå³ä½¿è®¿é—® /healthz ä¹Ÿéœ€è¦ï¼‰</li><li>æœªå¼€å¯åªè¯»ç«¯å£ 10255</li><li>ä» K8S v1.10 å¼€å§‹ï¼Œå»é™¤äº† â€“cadvisor-port å‚æ•°ï¼ˆé»˜è®¤ 4194 ç«¯å£ï¼‰ï¼Œä¸æ”¯æŒè®¿é—® cAdvisor UI &amp; API</li></ul><a id="more"></a><p>kubelet æ¥æ”¶ 10250 ç«¯å£çš„ https è¯·æ±‚ï¼Œå¯ä»¥è®¿é—®å¦‚ä¸‹èµ„æºï¼š</p><ul><li>/podsã€/runningpods</li><li>/metricsã€/metrics/cadvisorã€/metrics/probes</li><li>/spec</li><li>/statsã€/stats/container</li><li>/logs</li><li>/run/ã€/exec/, /attach/, /portForward/, /containerLogs/<br><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/server/server.go#L434:3" target="_blank" rel="noopener">è¯¦æƒ…å‚è€ƒ</a></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºå…³é—­äº†åŒ¿åè®¤è¯ï¼ŒåŒæ—¶å¼€å¯äº† webhook æˆæƒï¼Œæ‰€æœ‰è®¿é—® 10250 ç«¯å£ https API çš„è¯·æ±‚éƒ½éœ€è¦è¢«è®¤è¯å’Œæˆæƒã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;é¢„å®šä¹‰çš„ ClusterRole system:kubelet-api-admin æˆäºˆè®¿é—® kubelet æ‰€æœ‰ API çš„æƒé™(kube-apiserver ä½¿ç”¨çš„ kubernetes è¯ä¹¦ User æˆäºˆäº†è¯¥æƒé™)ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kubelet-api-admin</span></span><br><span class="line">Name:         system:kubelet-api-admin</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources      Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------      -----------------  --------------  -----</span><br><span class="line">  nodes/<span class="built_in">log</span>      []                 []              [*]</span><br><span class="line">  nodes/metrics  []                 []              [*]</span><br><span class="line">  nodes/proxy    []                 []              [*]</span><br><span class="line">  nodes/spec     []                 []              [*]</span><br><span class="line">  nodes/stats    []                 []              [*]</span><br><span class="line">  nodes          []                 []              [get list watch proxy]</span><br></pre></td></tr></table></figure><h3 id="kubelet-api-è®¤è¯å’Œæˆæƒ"><a href="#kubelet-api-è®¤è¯å’Œæˆæƒ" class="headerlink" title="kubelet api è®¤è¯å’Œæˆæƒ"></a>kubelet api è®¤è¯å’Œæˆæƒ</h3><p>kubelet é…ç½®äº†å¦‚ä¸‹è®¤è¯å‚æ•°:</p><ul><li><strong>â€“anonymous-auth=false</strong>: è®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åï¿½è®¿é—® 10250 ç«¯å£</li><li><strong>â€“authentication-token-webhook=true</strong>: æŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTPs è¯ä¹¦è®¤è¯</li><li><strong>â€“client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem</strong>: å¼€å¯ HTTPs bearer token è®¤è¯</li><li><strong>â€“authorization-mode=Webhook</strong>: å¼€å¯ RBAC æˆæƒ</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;kubelet æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ clientCAFile å¯¹è¯ä¹¦ç­¾åè¿›è¡Œè®¤è¯ï¼Œæˆ–è€…æŸ¥è¯¢ bearer token æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœä¸¤è€…éƒ½æ²¡é€šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚ï¼Œæç¤º Unauthorized</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 ~]<span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem https://172.21.16.204:10250/metrics</span></span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡è®¤è¯åï¼Œkubelet ä½¿ç”¨ SubjectAccessReview API å‘ kube-apiserver å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢è¯ä¹¦æˆ– token å¯¹åº”çš„ userã€group æ˜¯å¦æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</p><h3 id="è¯ä¹¦è®¤è¯å’Œæˆæƒ"><a href="#è¯ä¹¦è®¤è¯å’Œæˆæƒ" class="headerlink" title="è¯ä¹¦è®¤è¯å’Œæˆæƒ"></a>è¯ä¹¦è®¤è¯å’Œæˆæƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æƒé™ä¸è¶³</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem  --cert /etc/kubernetes/ssl/kube-controller-manager.pem --key /etc/kubernetes/ssl/kube-controller-manager-key.pem https://172.21.16.204:10250/metrics</span></span><br><span class="line">Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.16.204:10250/metrics|head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"21600"</span>&#125; 0</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>: â€“cacertã€â€“certã€â€“key çš„å‚æ•°å€¼å¿…é¡»æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦åˆ™è¿”å› 401 Unauthorizedï¼›</li></ul><h4 id="bear-token-è®¤è¯å’Œæˆæƒ"><a href="#bear-token-è®¤è¯å’Œæˆæƒ" class="headerlink" title="bear token è®¤è¯å’Œæˆæƒ"></a>bear token è®¤è¯å’Œæˆæƒ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ª ServiceAccountï¼Œå°†å®ƒå’Œ ClusterRole system:kubelet-api-admin ç»‘å®šï¼Œä»è€Œå…·æœ‰è°ƒç”¨ kubelet API çš„æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">horization.k8s.io/kubelet-api-test created</span><br><span class="line"><span class="comment"># SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># TOKEN=$(kubectl describe secret $&#123;SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;TOKEN&#125;</span></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6Imt1YmVsZXQtYXBpLXRlc3QtdG9rZW4tNGJra3MiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoia3ViZWxldC1hcGktdGVzdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6Ijk3MDRhZDEwLWNlYjQtMTFlOS04ZDIwLWZhMTYzZTVhZjgzMyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0Omt1YmVsZXQtYXBpLXRlc3QifQ.ishvOaC5tppYKDNpEOXIiVhVtgjyqzjySZjzndot5Z5U9MkY9LN8ZSMWRe6lNsB1UuTgEWTsHlG3OIRfExnHehYhWIt59V9e39KKbeY17hHoT-RZSaD6GoB449t_vUdIJedd1FGZ8DckQvDr6X5fMuD7MSU3vRL077j-uls-y4IW5kaJHeAGJfc6eWoCnv96DCbI8mQ8yuYbwLFpfIPLb4u6FPkwMQL2KXy6FhWPY1va6zAh4LdjGWhH6IAkKleq0aqfMwvmlnk1_OUmnmBoGJGuB96IwqBATP0jFzrd-Sv6af3RsSYz2r8YzJUj3kat9bd__HNCCXampYYr8ffu8YEdn-J9p6HK13FWU4O9QSIDrRONNIOpUXclJ-ov3z6N1hiIcVq5UJU6xR2z4ccvPXmH9Sj7p8CquqKEuobZxK97TFtECGlb2Ex43u4t0UHRo23UCQA-qP2Zs4-U2Zmf_qu3I-Lm7jzuYzXFCAb27yZx_XOUY-ycnKhtM6PpUfVKhkcHfWBOYY-QtBEbYf6yHRqCWcjrsZ63C_B56qAYaU5ca3hAcr6RBuHmmHISGESlLbmrpGgJ_ajd5mrJSh3Z_qdqu-Xt0Ya0NLfXgAcGi5n8xWJLztRTeyHrFTj7g82MqERUfFk9bdLHcz77xmrNLnhRZ87GW9sTZLw8QRUjF1g</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem -H "Authorization: Bearer $&#123;TOKEN&#125;" https://172.21.16.204:10250/metrics|head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"21600"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="cadvisor-å’Œ-metrics"><a href="#cadvisor-å’Œ-metrics" class="headerlink" title="cadvisor å’Œ metrics"></a>cadvisor å’Œ metrics</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;cadvisor æ˜¯å†…åµŒåœ¨ kubelet äºŒè¿›åˆ¶ä¸­çš„ï¼Œç»Ÿè®¡æ‰€åœ¨èŠ‚ç‚¹å„å®¹å™¨çš„èµ„æº(CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘å¡)ä½¿ç”¨æƒ…å†µçš„æœåŠ¡.</p><blockquote><p>åœ¨è®¿é—®api-serverå®‰å…¨ç«¯å£ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›æ“ä½œæ‰èƒ½è®¿é—®ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œè®¿é—®</p></blockquote><h5 id="åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£"><a href="#åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£" class="headerlink" title="åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£"></a>åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;æç¤ºè¯ä¹¦ä¸è¢«ä¿¡ä»»,è¿™æ˜¯å› ä¸º kube-apiserver çš„ server è¯ä¹¦æ˜¯æˆ‘ä»¬åˆ›å»ºçš„æ ¹è¯ä¹¦ ca.pem ç­¾åçš„ï¼Œéœ€è¦å°†æ ¹è¯ä¹¦ ca.pem å¯¼å…¥æ“ä½œç³»ç»Ÿï¼Œå¹¶è®¾ç½®æ°¸ä¹…ä¿¡ä»»ã€‚<br><img src="https://img.xxlaila.cn/1567564092242.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ç»™æµè§ˆå™¨ç”Ÿæˆä¸€ä¸ª client è¯ä¹¦ï¼Œè®¿é—® apiserver çš„ 6443 https ç«¯å£æ—¶ä½¿ç”¨ã€‚è¿™é‡Œä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ admin è¯ä¹¦ã€ç§é’¥å’Œä¸Šé¢çš„ ca è¯ä¹¦ï¼Œåˆ›å»ºä¸€ä¸ªæµè§ˆå™¨å¯ä»¥ä½¿ç”¨ PKCS#12/PFX æ ¼å¼çš„è¯ä¹¦ï¼š</p><ul><li><p>ä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œè¿™é‡Œå¯†ç éœ€è¦è®°ä½ï¼Œä¸€ä¼šå€’å…¥è¯ä¹¦åˆ°æµè§ˆå™¨çš„æ—¶å€™éœ€è¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl pkcs12 -export -out admin.pfx -inkey admin-key.pem -in admin.pem -certfile kubernetes-ca.pem</span></span><br><span class="line">Enter Export Password:</span><br><span class="line">Verifying - Enter Export Password:</span><br></pre></td></tr></table></figure></li><li><p>å°†åˆ›å»ºçš„ admin.pfx å¯¼å…¥åˆ°ç³»ç»Ÿçš„è¯ä¹¦ä¸­,<br><img src="https://img.xxlaila.cn/1567564289155.jpg" alt="img"></p></li></ul><p>å†æ¬¡è®¿é—® apiserver åœ°å€ï¼Œæç¤ºé€‰æ‹©ä¸€ä¸ªæµè§ˆå™¨è¯ä¹¦ï¼Œè¿™é‡Œé€‰ä¸­ä¸Šé¢å¯¼å…¥çš„ admin.pfx<br><img src="https://img.xxlaila.cn/1567564393274.jpg" alt="img"></p><ul><li><p>æç¤ºéœ€è¦è¾“å…¥ç³»ç»Ÿçš„å¯†ç ,è¿™é‡Œæ˜¯macçš„ç”µè„‘<br><img src="https://img.xxlaila.cn/1567564441293.jpg" alt="img"></p></li><li><p>è¢«æˆæƒè®¿é—® kube-apiserver çš„å®‰å…¨ç«¯å£<br><img src="https://img.xxlaila.cn/1567564526664.jpg" alt="img"></p></li></ul><h5 id="å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†"><a href="#å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†" class="headerlink" title="å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†"></a>å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†</h5><ul><li>è¯ä¹¦é€‰æ‹©æ˜¯åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ SSL/TLS æ¡æ‰‹åå•†é˜¶æ®µå•†å®šçš„ï¼›</li><li>æœåŠ¡ç«¯å¦‚æœè¦æ±‚å®¢æˆ·ç«¯æä¾›è¯ä¹¦ï¼Œåˆ™åœ¨æ¡æ‰‹æ—¶ä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå®ƒæ¥å—çš„ CA åˆ—è¡¨ï¼›</li><li>å®¢æˆ·ç«¯æŸ¥æ‰¾å®ƒçš„è¯ä¹¦åˆ—è¡¨(ä¸€èˆ¬æ˜¯æ“ä½œç³»ç»Ÿçš„è¯ä¹¦ï¼Œå¯¹äº Mac ä¸º keychain)ï¼Œçœ‹æœ‰æ²¡æœ‰è¢« CA ç­¾åçš„è¯ä¹¦ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†å®ƒä»¬æä¾›ç»™ç”¨æˆ·é€‰æ‹©ï¼ˆè¯ä¹¦çš„ç§é’¥ï¼‰ï¼›</li><li>ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªè¯ä¹¦ç§é’¥ï¼Œç„¶åå®¢æˆ·ç«¯å°†ä½¿ç”¨å®ƒå’ŒæœåŠ¡ç«¯é€šä¿¡ï¼›</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨è®¿é—® <a href="https://172.21.16.204:10250/metrics" target="_blank" rel="noopener">https://172.21.16.204:10250/metrics</a> å’Œ <a href="https://172.21.16.204:10250/metrics/cadvisor" target="_blank" rel="noopener">https://172.21.16.204:10250/metrics/cadvisor</a> åˆ†åˆ«è¿”å› kubelet å’Œ cadvisor çš„ metricsã€‚<br><img src="https://img.xxlaila.cn/1567563858215.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567564733531.jpg" alt="img"></p><ul><li><strong>åŸå› </strong>: kubeleté…ç½®æ–‡ä»¶è®¾ç½®<code>--anonymous-auth=false</code>ä¸å…è®¸åŒ¿åè¯ä¹¦è®¿é—® 10250 çš„ https æœåŠ¡,æ‰€ä»¥æˆ‘ä»¬æ‰éœ€è¦é…ç½®è¯ä¹¦æ¥è¿›è¡Œè®¿é—®</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubelet</tag>
      </tags>
  </entry>
  <entry>
    <title>centos-nfs-512é”™è¯¯</title>
    <url>/2019/09/03/centos-nfs-512%E9%94%99%E8%AF%AF/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:15 GMT+0800 (China Standard Time) --><p>nfs é”™è¯¯kernel: NFS: nfs4_discover_server_trunking unhandled error -512. Exiting with error EIO</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¾ˆä¹…æ²¡æŒ‚è½½è¿‡nfsï¼Œå¿˜è®°å®¢æˆ·ç«¯æ€ä¹ˆæŒ‚åœ¨nfsçš„äº†ï¼ŒæœåŠ¡ç«¯å¾ˆæ—©å°±å®‰è£…å¥½äº†ï¼Œä»Šå¤©ä¸€å°å®¢æˆ·æœºéœ€è¦æŒ‚è½½nfsï¼Œç„¶åå±…ç„¶æŠ¥é”™äº†ï¼Œç„¶åæ‰¾äº†ä¸€åœˆå±…ç„¶æ²¡æ‰¾åˆ°æ€ä¹ˆè§£å†³ï¼Œç„¶ååˆé‡æ–°çœ‹äº†ä¸€æ¬¡centos nfsçš„é…ç½®ï¼Œäºæ˜¯ä¹å°±æå®šäº†</p><p>åœ¨æŒ‚è½½nfsçš„æç¤ºå¾ˆæ…¢ï¼Œé•¿æ—¶é—´æ— å“åº”ï¼Œå¼ºè¡Œç»“æŸçœ‹çœ‹æ˜¯ä»€ä¹ˆé—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo tail -f /var/<span class="built_in">log</span>/messages</span><br><span class="line">Sep  3 11:23:51 dev-application kernel: NFS: nfs4_discover_server_trunking unhandled error -512. Exiting with error EIO</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind-service"><a href="#1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind-service" class="headerlink" title="1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind.service"></a>1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind.service</h3><p>åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹<code>rpcbind.service</code>æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼Œæ²¡æœ‰æ­£å¸¸å¯åŠ¨ï¼Œå°±éœ€è¦å¯åŠ¨ï¼Œæ²¡æœ‰å®‰è£…æœåŠ¡ï¼Œå°±éœ€è¦å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum -y install rpcbind</span><br><span class="line">$ sudo systemctl start rpcbind.service &amp;&amp; sudo systemctl <span class="built_in">enable</span> rpcbind.service</span><br></pre></td></tr></table></figure><ul><li>å†æ¬¡æŒ‚è½½çš„æ—¶å€™è¿˜æ˜¯æŒ‚è½½è¡¥ä¸Šï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æŒ‚è½½çš„æ—¶å€™å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€äº†æ•°æ®è¯·æ±‚ï¼Œè€Œä¸”è¿˜æ²¡æœ‰æ­£å¸¸çš„æ–­å¼€é“¾æ¥ï¼Œå¯ä»¥åœ¨æœåŠ¡ç«¯ç”¨<code>netstat -anp|grep tcp</code>æŸ¥çœ‹æœ‰æ²¡æœ‰å®¢æˆ·ç«¯çš„é“¾æ¥ä¿¡æ¯,çŠ¶æ€æ˜¯<code>ESTABLISHED</code>ï¼Œæœ‰çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒç»“æŸæ‰</li></ul><h3 id="2ã€linux-ç»“æŸtcpä¼šè¯"><a href="#2ã€linux-ç»“æŸtcpä¼šè¯" class="headerlink" title="2ã€linux ç»“æŸtcpä¼šè¯"></a>2ã€linux ç»“æŸtcpä¼šè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›®å‰ä¸çŸ¥é“ä»€ä¹ˆå‘½ä»¤,åæœŸæ›´æ–°</span></span><br><span class="line"><span class="comment"># é‡å¯nfsæœåŠ¡</span></span><br><span class="line">$ sudo systemctl restart nfs.service</span><br></pre></td></tr></table></figure><h3 id="3ã€å®¢æˆ·ç«¯æŒ‚è½½"><a href="#3ã€å®¢æˆ·ç«¯æŒ‚è½½" class="headerlink" title="3ã€å®¢æˆ·ç«¯æŒ‚è½½"></a>3ã€å®¢æˆ·ç«¯æŒ‚è½½</h3><p>å†æ¬¡æ¥åˆ°å®¢æˆ·æœºæŒ‚è½½ï¼Œå¯ä»¥æˆåŠŸçš„æŒ‚è½½</p><h3 id="4ã€rpcbindæœåŠ¡ä»‹ç»"><a href="#4ã€rpcbindæœåŠ¡ä»‹ç»" class="headerlink" title="4ã€rpcbindæœåŠ¡ä»‹ç»"></a>4ã€rpcbindæœåŠ¡ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿéœ€è¦æœåŠ¡ï¼Œçº¢å¸½ä¼ä¸šLinuxä½¿ç”¨æ ¸å¿ƒçº§çš„æ”¯æŒå’Œå®ˆæŠ¤è¿›ç¨‹çš„ç»„åˆæ¥æä¾›NFSæ–‡ä»¶å…±äº«.NFSä¾é è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è·¯ç”±è¯·æ±‚ã€‚åœ¨Linuxä¸‹RPCæœåŠ¡ç”±portmapæœåŠ¡æ§åˆ¶ã€‚</p><h4 id="4-1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ"><a href="#4-1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ" class="headerlink" title="4.1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ:"></a>4.1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ:</h4><ul><li>nfs - å¯åŠ¨ç›¸åº”RPCæœåŠ¡è¿›ç¨‹æ¥æœåŠ¡å¯¹äºNFSæ–‡ä»¶ç³»ç»Ÿçš„è¯·æ±‚.</li><li>nfslock - ä¸€ä¸ªå¯é€‰çš„æœåŠ¡ï¼Œç”¨äºå¯åŠ¨ç›¸åº”çš„RPCè¿›ç¨‹ï¼Œå…è®¸NFSå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ä¸Šå¯¹æ–‡ä»¶åŠ é”.</li><li>portmap - Linuxçš„RPCæœåŠ¡,å®ƒå“åº”RPCæœåŠ¡çš„è¯·æ±‚å’Œä¸è¯·æ±‚çš„RPCæœåŠ¡å»ºç«‹è¿æ¥.</li></ul><h4 id="4-2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡"><a href="#4-2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡" class="headerlink" title="4.2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡"></a>4.2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡</h4><ul><li>rpc.mountd - è¿™ä¸ªè¿›ç¨‹æ¥å—æ¥è‡ªNFSå®¢æˆ·ç«¯çš„åŠ è½½è¯·æ±‚å’ŒéªŒè¯è¯·æ±‚çš„æ–‡ä»¶ç³»ç»Ÿæ­£åœ¨è¢«è¾“å‡º.è¿™ä¸ªè¿›ç¨‹ç”±NFSæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li><li>rpc.nfsd - è¿™ä¸ªè¿›ç¨‹æ˜¯NFSæœåŠ¡å™¨.å®ƒå’ŒLinuxæ ¸å¿ƒä¸€èµ·å·¥ä½œæ¥æ»¡è¶³NFSå®¢æˆ·ç«¯çš„åŠ¨æ€éœ€æ±‚ï¼Œä¾‹å¦‚æä¾›ä¸ºæ¯ä¸ªNFSå®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚æœåŠ¡å™¨çº¿ç¨‹.è¿™ä¸ªè¿›ç¨‹å¯¹åº”äºnfsæœåŠ¡.</li><li>rpc.lockd - ä¸€ä¸ªå¯é€‰çš„è¿›ç¨‹ï¼Œå®ƒå…è®¸NFSå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ä¸Šå¯¹æ–‡ä»¶åŠ é”.è¿™ä¸ªè¿›ç¨‹å¯¹åº”äºnfslockæœåŠ¡.</li><li>rpc.statd - è¿™ä¸ªè¿›ç¨‹å®ç°äº†ç½‘ç»œçŠ¶æ€ç›‘æ§(NSM)RPCåè®®,é€šçŸ¥NFSå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ä¸€ä¸ªNFSæœåŠ¡å™¨éæ­£å¸¸é‡å¯åŠ¨.è¿™ä¸ªè¿›ç¨‹è¢«nfslockæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li><li>rpc.rquotad - è¿™ä¸ªè¿›ç¨‹å¯¹äºè¿œç¨‹ç”¨æˆ·æä¾›ç”¨æˆ·é…é¢ä¿¡æ¯. è¿™ä¸ªè¿›ç¨‹è¢«nfsæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sé›†ç¾¤éƒ¨ç½²heapster</title>
    <url>/2019/09/02/k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2heapster/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>kubernetesé›†ç¾¤å¯ç”¨tlsè®¤è¯éƒ¨ç½²heapsterï¼Œåœ¨éƒ¨ç½²æœŸé—´é‡åˆ°äº†å¾ˆå¤šçš„å‘ï¼Œèµ°è¿‡å¾ˆå¤šé›·ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹,ä¸è¿‡åœ¨æ–°ç‰ˆæœ¬ä¸­heapsterè¢«metrics-serverä»£æ›¿äº†ï¼Œmetrics-serveråç¯‡ä»‹ç»å’Œä½¿ç”¨</p><h2 id="1ã€å‡†å¤‡å·¥ä½œ"><a href="#1ã€å‡†å¤‡å·¥ä½œ" class="headerlink" title="1ã€å‡†å¤‡å·¥ä½œ"></a>1ã€å‡†å¤‡å·¥ä½œ</h2><p>ä¸‹è½½éœ€è¦çš„æ–‡ä»¶ï¼Œè¿™é‡Œç”¨ä¹‹å‰k8s-heapsteréƒ¨ç½²çš„æ–‡ä»¶æ‹¿æ¥è¿›è¡Œä¿®æ”¹ï¼Œ<a href="https://github.com/xxlaila/kubernetes-yaml/" target="_blank" rel="noopener">æ–‡ä»¶åœ°å€</a></p><h3 id="2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º"><a href="#2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º" class="headerlink" title="2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º"></a>2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes-yaml/heapster-influxdb-grafana</span></span><br><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li><strong>é”™è¯¯æç¤º</strong>: è¿™é‡Œåœ¨æ‰§è¡Œåˆ›å»ºåï¼Œæ²¡æœ‰å›¾åƒæ˜¾ç¤ºï¼ŒæŸ¥çœ‹podsæ—¥å¿—å‘ç°é”™è¯¯<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system|grep he</span></span><br><span class="line">heapster-7b7b4754d-5p7tb                1/1     Running   0          17m</span><br><span class="line"><span class="comment"># kubectl logs heapster-7b7b4754d-5p7tb -n kube-system</span></span><br><span class="line">E0902 10:57:11.804543       1 reflector.go:190] k8s.io/heapster/metrics/processors/namespace_based_enricher.go:89: Failed to list *v1.Namespace: namespaces is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list resource <span class="string">"namespaces"</span> <span class="keyword">in</span> API group <span class="string">""</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br><span class="line">E0902 10:57:12.071117       1 reflector.go:190] k8s.io/heapster/metrics/util/util.go:30: Failed to list *v1.Node: nodes is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list resource <span class="string">"nodes"</span> <span class="keyword">in</span> API group <span class="string">""</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br></pre></td></tr></table></figure></li></ul><ul><li>æ’é”™<br>æŸ¥çœ‹ClusterRole: system:heapsterçš„æƒé™,å‘ç°å¹¶æ²¡æœ‰</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:heapster</span></span><br><span class="line">Error from server (NotFound): clusterroles.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br></pre></td></tr></table></figure><p>æç¤ºè¿™ä¸ªé”™è¯¯ï¼Œåº”è¯¥æ˜¯æˆ‘ä¹‹å‰éƒ¨ç½²è¿‡ï¼Œç„¶åä¿®æ”¹è¿‡æƒé™ï¼Œä¸å°å¿ƒç»™åˆ æ‰å•¦ï¼Œè¿™é‡Œéœ€è¦å§æƒé™é‡å»ºä¸€æ¬¡å°±å¥½äº†ï¼Œ<a href="https://www.cnblogs.com/vincenshen/p/9638162.html" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><ul><li>æ–°å»ºheapster-clusterrole.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster-clusterrole.yaml </span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:heapster</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  - namespaces</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br></pre></td></tr></table></figure></li></ul><p>å¹¶æ‰§è¡Œ kubectl apply -f heapster-clusterrole.yaml,åœ¨æ¬¡æŸ¥çœ‹æ—¥å¿—ï¼Œå‘ç°ä¹‹å‰çš„é”™è¯¯æ²¡æœ‰äº†ï¼Œä½†æ˜¯åˆå‡ºç°äº†ä¸€ä¸ªæ–°çš„é”™è¯¯<br><code>E0902 11:27:05.025300 1 manager.go:101] Error in scraping containers from kubelet:172.21.16.204:10250: failed to get all container stats from Kubelet URL &quot;https://172.21.16.204:10250/stats/container/&quot;: request failed - &quot;401 Unauthorized&quot;, response: &quot;Unauthorized&quot;</code></p><ul><li><p>ä¿®æ”¹heapster-clusterrole.yamlæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶é‡Œé¢æˆ‘ä»¬æ·»åŠ å‡ ä¸ªæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster-clusterrole.yaml </span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:heapster</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  - namespaces</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f heapster-clusterrole.yaml</span></span><br><span class="line"><span class="comment"># é‡æ–°åˆ›å»ºheapster</span></span><br><span class="line"><span class="comment"># kubectl delete -f heapster.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f heapster.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>å®Œæˆä»¥åæˆ‘ä»¬ç»§ç»­çœ‹heapster podçš„æ—¥å¿—ï¼Œå‘ç°æ—¥å¿—é‡Œé¢è¿˜æ˜¯å‡ºç°<code>401 Unauthorized&quot;, response: &quot;Unauthorized&quot;</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹nodeèŠ‚ç‚¹ kubelet å¯åŠ¨çš„é…ç½®å‚æ•°ï¼Œæ·»åŠ <code>--authentication-token-webhook</code>å‚æ•°: ä½¿ç”¨tokenreview APIæ¥è¿›è¡Œä»¤ç‰Œè®¤è¯ã€‚Kubelet åœ¨é…ç½®çš„ API server ä¸Šè°ƒç”¨ TokenReview API ä»¥ç¡®å®šæ¥è‡ª bearer token çš„ç”¨æˆ·ä¿¡æ¯ã€‚<a href="https://k8smeetup.github.io/docs/admin/kubelet-authentication-authorization/" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a>ï¼Œ<a href="https://github.com/kubernetes-retired/heapster/issues/1936" target="_blank" rel="noopener">githubä¸Šé”™è¯¯è§£å†³</a>ï¼Œ <a href="https://jimmysong.io/posts/user-authentication-in-kubernetes/" target="_blank" rel="noopener">å‚æ•°æ–‡ç« å­¦ä¹ </a></p><p>åˆ°æ­¤ä¸ºæ­¢: é”™è¯¯æ²¡æœ‰å•¦ï¼Œä½†æ˜¯ç•Œé¢æ•°æ®æ²¡å‡ºæ¥ï¼Œç¨ç­‰ç‰‡åˆ»</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>heapster</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sé…ç½®Dashboard</title>
    <url>/2019/08/29/k8s%E9%85%8D%E7%BD%AEDashboard/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;K8S Dashboardæ˜¯å®˜æ–¹çš„ä¸€ä¸ªåŸºäºWEBçš„ç”¨æˆ·ç•Œé¢ï¼Œä¸“é—¨ç”¨æ¥ç®¡ç†K8Sé›†ç¾¤ï¼Œå¹¶å¯å±•ç¤ºé›†ç¾¤çš„çŠ¶æ€ã€‚K8Sé›†ç¾¤å®‰è£…å¥½åé»˜è®¤æ²¡æœ‰åŒ…å«Dashboardï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–åˆ›å»ºå®ƒã€‚</p><h3 id="1ã€å®‰è£…dashboard"><a href="#1ã€å®‰è£…dashboard" class="headerlink" title="1ã€å®‰è£…dashboard"></a>1ã€å®‰è£…dashboard</h3><h4 id="1-1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶"><a href="#1-1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶" class="headerlink" title="1.1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶"></a>1.1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶</h4><p>ç»è¿‡ä¿®æ”¹è¿‡åçš„æ–‡ä»¶ï¼Œå·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„<a href="https://github.com/xxlaila/kubernetes-yaml/" target="_blank" rel="noopener">æ–‡ä»¶</a></p><a id="more"></a><ul><li>åˆ›å»ºdashboard<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl create -f kubernetes-dashboard.yaml </span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br></pre></td></tr></table></figure></li></ul><h4 id="1-2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod"><a href="#1-2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod" class="headerlink" title="1.2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod"></a>1.2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl get service --all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">default       kubernetes             ClusterIP   10.254.0.1      &lt;none&gt;        443/TCP         18h</span><br><span class="line">kube-system   coredns                ClusterIP   10.254.0.10     &lt;none&gt;        53/UDP,53/TCP   16h</span><br><span class="line">kube-system   kubernetes-dashboard   NodePort    10.254.51.226   &lt;none&gt;        443:30001/TCP   15h</span><br></pre></td></tr></table></figure><ul><li><p>æŸ¥çœ‹serviceæè¿°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl describe  service kubernetes-dashboard -n kube-system</span></span><br><span class="line">Name:                     kubernetes-dashboard</span><br><span class="line">Namespace:                kube-system</span><br><span class="line">Labels:                   k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 k8s-app=kubernetes-dashboard</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP:                       10.254.51.226</span><br><span class="line">Port:                     &lt;<span class="built_in">unset</span>&gt;  443/TCP</span><br><span class="line">TargetPort:               8443/TCP</span><br><span class="line">NodePort:                 &lt;<span class="built_in">unset</span>&gt;  30001/TCP</span><br><span class="line">Endpoints:                10.254.39.3:8443</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹podæè¿°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl describe pod kubernetes-dashboard-6c655d9445-6zntr --namespace=kube-system</span></span><br><span class="line">Name:           kubernetes-dashboard-6c655d9445-6zntr</span><br><span class="line">Namespace:      kube-system</span><br><span class="line">Node:           172.21.17.31/172.21.17.31</span><br><span class="line">Start Time:     Thu, 29 Aug 2019 17:47:20 +0800</span><br><span class="line">Labels:         k8s-app=kubernetes-dashboard</span><br><span class="line">                pod-template-hash=6c655d9445</span><br><span class="line">Annotations:    &lt;none&gt;</span><br><span class="line">Status:         Running</span><br><span class="line">IP:             10.254.39.3</span><br></pre></td></tr></table></figure></li></ul><h3 id="2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™"><a href="#2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™" class="headerlink" title="2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™"></a>2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™</h3><p>è‹¥æœä¸è¿›è¡Œæˆæƒæ“ä½œï¼Œæ‰“å¼€dashboardä¼šæŠ¥é”™ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/WechatIMG28864.png" alt="img"></p><ul><li><p>æ–°å»ºkubrnetes-dashboard-admin-rbac.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubernetes-dashboard-admin-rbac.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Create ClusterRoleBinding</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f kubernetes-dashboard-admin-rbac.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>æ‰¾åˆ°kubernete-dashboard-adminçš„tokenï¼Œå¤åˆ¶tokenåœ¨dashboardé¡µé¢è¿›è¡Œç™»å½•ï¼Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl -n kube-system get secret | grep admin-user</span></span><br><span class="line">admin-user-token-qv49g             kubernetes.io/service-account-token   3      15h</span><br><span class="line"></span><br><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '&#123;print $1&#125;')</span></span><br><span class="line">Name:         admin-user-token-qv49g</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: ea3f0e3f-ca42-11e9-8716-fa163effd55b</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1359 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXF2NDlnIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlYTNmMGUzZi1jYTQyLTExZTktODcxNi1mYTE2M2VmZmQ1NWIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.AbdsJdgi9d0rCYrmvoJkWf32HKSMT03OyOX55aRhPptjzIjDcGxxQYecT0w58N7Z_2L2RwTBfOrm4B3wTEDfFZKgYsnGJQOzJMtZDN9w5YJg2xGQ27E3KisTbbQzd_I5DgxSZWW75GwWf756_bIQpWuXNRO_KjheyWuNNv0tSEYRiXpcboSQpb-8R-Km-vP85mxke6s5cJFSk0WLMjFWow1vOF1ns23NZ5nslEmYOMZF3_Fxybh3LbiCyrpD4c0FtfRcXaBIBqACeyCPRriYMIIJq3OJjI-DzuqUedu1x2xH2prB4mNjxlKt2-7q0M1zCuvm5JhW_LzWgveu9ni2ig</span><br></pre></td></tr></table></figure><h3 id="3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜"><a href="#3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜" class="headerlink" title="3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜"></a>3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;dashboard æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œé»˜è®¤çš„tokenå¤±æ•ˆçš„æ—¶é—´æ˜¯900ç§’ï¼Œ15åˆ†é’Ÿï¼Œæ¯15åˆ†é’Ÿå°±è¦è¿›è¡Œä¸€æ¬¡è®¤è¯ï¼Œè¿™æ ·å¯¹äºè¿ç»´äººå‘˜æ¥è¯´å°±ä¸æ˜¯ç‰¹åˆ«çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹token-ttlå‚æ•°æ¥è®¾ç½®ï¼Œä¸»è¦æ˜¯ä¿®æ”¹dashboradçš„yamlæ–‡ä»¶ï¼Œå¹¶é‡æ–°å»ºç«‹å³å¯</p><h4 id="3-1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹-æ·»åŠ "><a href="#3-1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹-æ·»åŠ " class="headerlink" title="3.1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹/æ·»åŠ "></a>3.1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹/æ·»åŠ </h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- containerPort: 8443</span><br><span class="line">  protocol: TCP</span><br><span class="line">args:</span><br><span class="line">  - --auto-generate-certificates</span><br><span class="line">  - --token-ttl=43200</span><br></pre></td></tr></table></figure><ul><li>é‡å»ºpod<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl apply -f kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>æˆ‘ä»¬å¯ä»¥è¾“å…¥ä»»æ„èŠ‚ç‚¹çš„ipåŠ 30001ç«¯å£å°±å¯ä»¥è®¿é—®dashboard, https://{ip}:30001ã€‚</p><h3 id="å…¶ä»–æ“ä½œ"><a href="#å…¶ä»–æ“ä½œ" class="headerlink" title="å…¶ä»–æ“ä½œ"></a>å…¶ä»–æ“ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ¯å¤©æˆ‘ä»¬æ¥å…¬å¸è¦ç™»å½•dashboardçš„æ—¶å€™éƒ½è¦å»è¾“å…¥ä¸€æ¬¡tokenï¼Œæ¯æ¬¡å»è·å–tokençš„æ—¶å€™éƒ½è¦è¾“å…¥å¾ˆé•¿çš„ä¸€ä¸²ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥å†™ä¸€ä¸ªè„šæœ¬ï¼Œè¦tokençš„æ—¶å€™æ‰§è¡Œä¸€ä¸‹è„šæœ¬ï¼Œå°±å¯ä»¥ã€‚</p><ul><li><p>åˆ›å»ºè„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim kube-token</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®è„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chmod +x kube-token</span></span><br><span class="line"><span class="comment"># mv kube-token /usr/bin</span></span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>k8såˆ é™¤nodeé‡æ–°åŠ å…¥</title>
    <url>/2019/08/29/k8s%E5%88%A0%E9%99%A4node%E9%87%8D%E6%96%B0%E5%8A%A0%E5%85%A5/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;æœ‰æ—¶å€™k8s node åœ¨åŠ å…¥é›†ç¾¤çš„æ—¶å€™ä¸ç»æ„çš„æ—¶å€™å¼„é”™å•¦æŸäº›ä¸œè¥¿ï¼Œè¿™æ—¶å€™å¯ä»¥æŠŠè¿™ä¸ªnodeåˆ é™¤ï¼Œç„¶åé‡æ–°åŠ å…¥ï¼Œåˆ é™¤èŠ‚ç‚¹ä¹‹å‰æˆ‘ä»¬éœ€è¦åšä¸€ä¸‹å¸¸è§„åŒ–çš„æ“ä½œï¼Œæ¥ä¿éšœè¿è¡Œåœ¨è¯¥èŠ‚ç‚¹çš„podè¿ç§»åˆ°å…¶ä»–çš„nodeä¸Šã€‚</p><a id="more"></a><ul><li><p>1ã€å…ˆé©±èµ¶ä¸Šé¢çš„pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl drain 172.21.110 --delete-local-data</span></span><br><span class="line">node/172.21.110 cordoned</span><br><span class="line">node/172.21.110 drained</span><br></pre></td></tr></table></figure></li><li><p>2ã€åˆ é™¤èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl delete node 172.21.110</span></span><br><span class="line">node <span class="string">"172.21.110"</span> deleted</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>kubectl delete</code> å‘½ä»¤æœ¬èº«æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥è¿›è¡Œä»»ä½•èµ„æºçš„åˆ é™¤<code>kubectl delete type typename</code>ï¼Œtypeæ˜¯èµ„æºç±»å‹ï¼Œå¯ä»¥æ˜¯<code>node, pod, rs, rc, deployment, service</code>ç­‰ç­‰ï¼Œtypenameæ˜¯è¿™ä¸ªèµ„æºçš„åç§°</p><ul><li><p>3ã€æŸ¥çœ‹nodeæ˜¯å¦è¢«åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.17.30   Ready    &lt;none&gt;   20m   v1.13.3</span><br><span class="line">172.21.17.31   Ready    &lt;none&gt;   10m   v1.13.3</span><br></pre></td></tr></table></figure></li><li><p>4ã€å½»åº•åˆ é™¤node<br>è¿›å…¥è¯¥èŠ‚ç‚¹ã€‚åˆ é™¤<code>kubelet.kubeconfig</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-3 kubernetes]<span class="comment"># rm -rf  kubelet.kubeconfig</span></span><br></pre></td></tr></table></figure></li><li><p>4ã€nodeé‡æ–°åŠ å…¥é›†ç¾¤<br>&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬çš„nodeæ‰§è¡Œåˆ é™¤ä»¥åï¼Œé‡æ–°å¯åŠ¨kubeletæœåŠ¡ä»¥åã€‚nodeåˆä¼šè‡ªåŠ¨çš„åŠ å…¥åˆ°é›†ç¾¤é‡Œé¢æ¥ï¼Œæ€ä¹ˆå½»åº•çš„åˆ é™¤ï¼Œè®©åé‡å¯kubeletçš„æ—¶å€™é‡æ–°åƒé›†ç¾¤é‡Œé¢å‘å‡ºcsrè¯·æ±‚ï¼Œé›†ç¾¤é‡æ–°é€šè¿‡è¯¥èŠ‚ç‚¹çš„csrè¯·æ±‚å§è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤æ¥ï¼Œ<code>kubelet.kubeconfig</code>ä¹Ÿé‡æ–°ç”Ÿæˆ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE     REQUESTOR           CONDITION</span><br><span class="line">node-csr-H1CAqJw4VZYY67-tk4Akuso_uuPPwpj3d5jK3xcL88M   8m      kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-YPvpbITaxGBrOxuCpGiY7jrGpPNSZ4sdbKhSkUEcdnc   7m54s   kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek   5s      kubelet-bootstrap   Pending</span><br><span class="line">node-csr-u4oi5e0Upt-ZmejSDEFm9Q0RU3wZf9bThU_o51nclgg   17m     kubelet-bootstrap   Approved,Issued</span><br></pre></td></tr></table></figure></li><li><p>5ã€é‡æ–°é€šè¿‡csr</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl certificate approve node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek </span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek approved</span><br></pre></td></tr></table></figure></li><li><p>6ã€åœ¨é›†ç¾¤æŸ¥çœ‹èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.16.110   Ready    &lt;none&gt;   36s   v1.13.3</span><br><span class="line">172.21.17.30    Ready    &lt;none&gt;   28m   v1.13.3</span><br><span class="line">172.21.17.31    Ready    &lt;none&gt;   17m   v1.13.3</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>node</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos routeç­–ç•¥</title>
    <url>/2019/08/28/Centos-route%E7%AD%96%E7%95%A5/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:15 GMT+0800 (China Standard Time) --><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸ä¸šåŠ¡åœ¨ä¸€ä¸ªæ–°çš„äº‘å¹³å°ä¸Šçº¿ï¼Œè¯¥äº‘å¹³å°ä½¿ç”¨çš„æ˜¯æ¯”è¾ƒä¼ ç»Ÿçš„VMware vSphereæ¥åšçš„è™šæ‹ŸåŒ–ï¼Œè€Œä¸”è¯¥äº‘å¹³å°ç½‘ç»œä¹Ÿæ˜¯æˆ‘ä»¬ä¸æ¸…æ¥šçš„ï¼Œåæ­£å°±æ˜¯ä¸èƒ½è®¾ç½®(ä¸èƒ½åƒç°åœ¨ä¸»æµäº‘å¹³å°è‡ªå®šä¹‰ç½‘ç»œæˆ–è€…æ˜¯åœ°å€æ®µ)ï¼Œæ˜¯ä¸€ä¸ªæ”¿åºœçš„äº‘å¹³å°ï¼Œå…·ä½“å„ç§å¥‡è‘©çš„é™åˆ¶å°±ä¸è¯´å•¦ï¼Œä½ æ‡‚çš„â€¦â€¦</p></blockquote><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;æ ¹æ®æˆ‘ä»¬è‡ªèº«ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå†…ç½‘åœ°å€æ®µï¼Œå’Œå¯¹æ–¹åå•†åç»™æˆ‘ä»¬å¼€äº†ä¸€ä¸ª10ç½‘æ®µï¼Œ20çš„å­ç½‘ï¼Œç„¶åè¦äº†ä¸¤å°å¸¦æœ‰å¤–ç½‘ipçš„æœåŠ¡å™¨ï¼Œä¸€ä¸ªç”¨æ¥åšè·³æ¿æœºï¼Œä¸€ä¸ªç”¨æ¥åšåå‘ä»£ç†ã€‚ç„¶åç­‰äº†ä¸¤å¤©å¯¹æ–¹å§æœåŠ¡å™¨ç»™æˆ‘ä»¬å¼€å¥½äº†ï¼Œæˆ‘ä»¬ç™»å½•è·³æ¿æœºï¼Œå‘ç°åªæœ‰å¤–ç½‘ipçš„æœåŠ¡å™¨æ‰èƒ½ä¸Šç½‘ï¼Œå…¶ä»–çš„å‡ä¸èƒ½ä¸Šç½‘ï¼Œåšnatä¹Ÿä¸èƒ½ä¸Šï¼Œä½†æ˜¯è·³æ¿æœºæ˜¯å…¬ç½‘ï¼Œæ²¡æœ‰å†…ç½‘ï¼Œå¯ä»¥é€šå†…ç½‘çš„ipæœåŠ¡å™¨ï¼Œæ‰€ä»¥çŒœæµ‹ç½‘ç»œç­–ç•¥è‚¯å®šæ˜¯ä»–ä»¬åœ¨äº¤æ¢æœºä¸Šåšçš„ã€‚ç„¶åæˆ‘ä»¬è‡ªå·±yumæºæ¥å®‰è£…ä¸€äº›ä¸­é—´ä»¶ã€‚ï¼ˆä¸è¯´äº†ï¼Œåé¢è¿˜æœ‰ä¸€å †çš„å¥‡è‘©é—®é¢˜ï¼Œè¿›å…¥æ­£é¢˜å§ï¼‰</p><h3 id="åæœŸé—®é¢˜"><a href="#åæœŸé—®é¢˜" class="headerlink" title="åæœŸé—®é¢˜"></a>åæœŸé—®é¢˜</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬æŠŠä¸šåŠ¡éƒ¨ç½²ä¸Šçº¿ä»¥åï¼Œè¿è¡Œä¸€æ®µæ—¶é—´åå‡ºç°å¾®æœåŠ¡ä¹‹é—´è°ƒç”¨è¶…æ—¶ï¼Œç„¶åæˆ‘ä»¬ç™»å½•æœåŠ¡å™¨æ’æŸ¥ç½‘ç»œé—®é¢˜ï¼Œåœ¨æœåŠ¡å™¨ä¹‹é—´pingå†…ç½‘æ²¡é—®é¢˜ï¼Œpingæ³¨å†Œä¸­å¿ƒã€æ•°æ®åº“éƒ½æ²¡é—®é¢˜ã€‚æœåŠ¡å™¨æœ‰å…¬ç½‘ï¼Œç„¶åå…¬ç½‘ä¹‹é—´pingéƒ½æ²¡é—®é¢˜ï¼Œç½‘ç»œå±‚é¢æ²¡æœ‰ä»»ä½•çš„é—®é¢˜ï¼ŒæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ä¹Ÿæœ‰å‘ç°é”™è¯¯ï¼Œç„¶åå•ç‹¬çš„å§å€Ÿå£åœ°å€æ‹¿å‡ºæ¥è¿›è¡Œ<code>curl</code>èƒ½è¿‡ä½†æ˜¯æœ‰ç‚¹æ…¢ï¼Œç„¶åå°±å§è¿™ä¸ªå‘½ä»¤å†™åœ¨è„šæœ¬é‡Œé¢ï¼Œè®©ä»–æ¯30ç§’è·‘ä¸€æ¬¡ï¼Œç„¶åè¿½åŠ æ—¥å¿—ï¼Œè·‘äº†ä¸¤ä¸‰ä¸ªå°æ—¶ï¼Œæˆ‘ä»¬æŸ¥çœ‹æ—¥å¿—ï¼Œæ—¥å¿—é‡Œé¢ä¹Ÿæœ‰è¶…æ—¶ç°è±¡ï¼Œå¥‡æ€ªäº†ï¼Œç„¶åå§è¿™ä¸ªé—®é¢˜è”ç³»å¯¹æ–¹äº‘å¹³å°çš„å·¥ç¨‹å¸ˆï¼Œç³»ç»Ÿå·¥ç¨‹å¸ˆã€ç½‘ç»œå·¥ç¨‹å¸ˆæ‹‰ç¾¤è®¨è®ºï¼Œæœ€åå¯¹æ–¹ç³»ç»Ÿå·¥ç¨‹å¸ˆæç¤ºæˆ‘ä»¬è®©æˆ‘ä»¬å§è·¯ç”±çš„<code>Metric</code>å€¼ä¸¤ä¸ªç½‘å¡ä¸è¦ä¸€æ ·ï¼Œå¯¹<code>Metric</code>åˆšå¼€å§‹ä¸€å¹´æ‡µé€¼ï¼Œå…ˆä¸ç®¡ï¼Œè§£å†³é—®é¢˜å†è¯´ï¼š</p><ul><li><p>ä¿®æ”¹Metric(å†…ç½‘å¡)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br><span class="line">$ sudo route add -net 10.10.20.0/22 dev ens160 metric 98</span><br><span class="line">$ sudo route  del -net 10.10.20.0/22 dev ens160 metric 100</span><br></pre></td></tr></table></figure></li><li><p>è®°ä½æ˜¯å…ˆæ·»åŠ åˆ é™¤ï¼Œé¡ºåºä¸è¦é¢ å€’</p></li><li><p>æŸ¥çœ‹è·¯ç”±</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         119.126.116.254 0.0.0.0         UG    100    0        0 ens192</span><br><span class="line">10.10.20.0      0.0.0.0         255.255.252.0   U     98     0        0 ens160</span><br><span class="line">119.126.116.128 0.0.0.0         255.255.255.128 U     100    0        0 ens192</span><br></pre></td></tr></table></figure></li><li><p>ens192(å¤–ç½‘å¡)</p></li><li><p>ens160(å†…ç½‘å¡)</p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;æ¶‰åŠåˆ°çš„ä¸šåŠ¡æœåŠ¡å™¨éƒ½ä¿®æ”¹ï¼Œä¿®æ”¹Metricå€¼ä»¥åï¼Œæˆ‘ä»¬<code>curl</code>ä¸€æ¬¡ï¼Œé€Ÿåº¦æ¯”ä»¥å‰å¿«å¤šäº†ï¼Œåˆè·‘äº†ä¸€æ¬¡è„šæœ¬ï¼Œè§‚å¯Ÿäº†å‡ ä¸ªå°æ—¶æ²¡é—®é¢˜ï¼Œè§‚å¯Ÿäº†ä¸¤å¤©ï¼Œä¸šåŠ¡æ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œæ—¥å¿—é‡Œé¢ä¹Ÿæ²¡æœ‰å‡ºç°è¶…æ—¶ï¼Œé—®é¢˜å¾—åˆ°è§£å†³</p><h3 id="Metric-ä»‹ç»"><a href="#Metric-ä»‹ç»" class="headerlink" title="Metric ä»‹ç»"></a>Metric ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºè·¯ç”±æŒ‡å®šæ‰€éœ€è·ƒç‚¹æ•°çš„æ•´æ•°å€¼ï¼ˆèŒƒå›´æ˜¯ 1 ~ 9999ï¼‰ï¼Œå®ƒç”¨æ¥åœ¨è·¯ç”±è¡¨é‡Œçš„å¤šä¸ªè·¯ç”±ä¸­é€‰æ‹©ä¸è½¬å‘åŒ…ä¸­çš„ç›®æ ‡åœ°å€æœ€ä¸ºåŒ¹é…çš„è·¯ç”±ã€‚æ‰€é€‰çš„è·¯ç”±å…·æœ‰æœ€å°‘çš„è·ƒç‚¹æ•°ã€‚è·ƒç‚¹æ•°èƒ½å¤Ÿåæ˜ è·ƒç‚¹çš„æ•°é‡ã€è·¯å¾„çš„é€Ÿåº¦ã€è·¯å¾„å¯é æ€§ã€è·¯å¾„ååé‡ä»¥åŠç®¡ç†å±æ€§ã€‚Metricçš„å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼›å¦‚æœä¸¤å—ç½‘å¡çš„Metricçš„å€¼ç›¸åŒï¼Œå°±ä¼šå‡ºç°æŠ¢å ä¼˜å…ˆçº§ç»§è€Œç½‘å¡å†²çªï¼Œå°†ä¼šæœ‰ä¸€å—ç½‘å¡æ— æ³•è¿æ¥</p><p>æ›´å¤šä»‹ç»<a href="https://www.cyberciti.biz/faq/what-is-a-routing-table/" target="_blank" rel="noopener">å‚è€ƒ</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>route</tag>
        <tag>Metric</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²ingress</title>
    <url>/2019/08/26/k8s%E9%83%A8%E7%BD%B2ingress/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>åœ¨kubernetes é›†ç¾¤ä¸­ï¼Œä¸€ä¸ªæœåŠ¡å®‰è£…ä»¥åæ€ä¹ˆå¯¹å¤–æä¾›è®¿é—®ï¼Œå¤–éƒ¨ç”¨æˆ·æ€ä¹ˆæ¥è®¿é—®æˆ‘ä»¬å®¹å™¨ä¸­ä¸šåŠ¡ã€‚</p><p><img src="https://img.xxlaila.cn/2373874sds43.png" alt="img"></p><h3 id="1ã€Ingress-ä»‹ç»"><a href="#1ã€Ingress-ä»‹ç»" class="headerlink" title="1ã€Ingress ä»‹ç»"></a>1ã€Ingress ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes æš´éœ²æœåŠ¡çš„æ–¹å¼ç›®å‰åªæœ‰ä¸‰ç§ï¼šLoadBlancer Serviceã€NodePort Serviceã€Ingressï¼›æœ¬æ–‡ä¸»è¦é€šè¿‡Ingressæ¥è®¿é—®</p><h3 id="2ã€Ingress-æ˜¯ä»€ä¹ˆ"><a href="#2ã€Ingress-æ˜¯ä»€ä¹ˆ" class="headerlink" title="2ã€Ingress æ˜¯ä»€ä¹ˆ"></a>2ã€Ingress æ˜¯ä»€ä¹ˆ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Ingress å°±æ˜¯èƒ½åˆ©ç”¨ Nginxã€Haproxy å•¥çš„è´Ÿè½½å‡è¡¡å™¨æš´éœ²é›†ç¾¤å†…æœåŠ¡çš„å·¥å…·é—®é¢˜æ¥äº†ï¼Œé›†ç¾¤å†…æœåŠ¡æƒ³è¦æš´éœ²å‡ºå»é¢ä¸´ç€å‡ ä¸ªé—®é¢˜ï¼š</p><a id="more"></a><ul><li><p>Pod æ¼‚ç§»é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¼—æ‰€å‘¨çŸ¥ Kubernetes å…·æœ‰å¼ºå¤§çš„å‰¯æœ¬æ§åˆ¶èƒ½åŠ›ï¼Œèƒ½ä¿è¯åœ¨ä»»æ„å‰¯æœ¬(Pod)æŒ‚æ‰æ—¶è‡ªåŠ¨ä»å…¶ä»–æœºå™¨å¯åŠ¨ä¸€ä¸ªæ–°çš„ï¼Œè¿˜å¯ä»¥åŠ¨æ€æ‰©å®¹ç­‰ï¼Œæ€»ä¹‹ä¸€å¥è¯ï¼Œè¿™ä¸ª Pod å¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»å‡ºç°åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»æ­»åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šï¼›é‚£ä¹ˆè‡ªç„¶éšç€ Pod çš„åˆ›å»ºå’Œé”€æ¯ï¼ŒPod IP è‚¯å®šä¼šåŠ¨æ€å˜åŒ–ï¼›é‚£ä¹ˆå¦‚ä½•æŠŠè¿™ä¸ªåŠ¨æ€çš„ Pod IP æš´éœ²å‡ºå»ï¼Ÿè¿™é‡Œå€ŸåŠ©äº Kubernetes çš„ Service æœºåˆ¶ï¼ŒService å¯ä»¥ä»¥æ ‡ç­¾çš„å½¢å¼é€‰å®šä¸€ç»„å¸¦æœ‰æŒ‡å®šæ ‡ç­¾çš„ Podï¼Œå¹¶ç›‘æ§å’Œè‡ªåŠ¨è´Ÿè½½ä»–ä»¬çš„ Pod IPï¼Œé‚£ä¹ˆæˆ‘ä»¬å‘å¤–æš´éœ²åªæš´éœ² Service IP å°±è¡Œäº†ï¼›è¿™å°±æ˜¯ NodePort æ¨¡å¼ï¼šå³åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¼€èµ·ä¸€ä¸ªç«¯å£ï¼Œç„¶åè½¬å‘åˆ°å†…éƒ¨ Service IP ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://img.xxlaila.cn/4dfs98347sdhsfs.png" alt="img"></p></li><li><p>ç«¯å£ç®¡ç†é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;é‡‡ç”¨ NodePort æ–¹å¼æš´éœ²æœåŠ¡é¢ä¸´ä¸€ä¸ªå‘çˆ¹çš„é—®é¢˜æ˜¯ï¼ŒæœåŠ¡ä¸€æ—¦å¤šèµ·æ¥ï¼ŒNodePort åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¼€å¯çš„ç«¯å£ä¼šåŠå…¶åºå¤§ï¼Œè€Œä¸”éš¾ä»¥ç»´æŠ¤ï¼›è¿™æ—¶å€™å¼•å‡ºçš„æ€è€ƒé—®é¢˜æ˜¯ â€œèƒ½ä¸èƒ½ä½¿ç”¨ Nginx å•¥çš„åªç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œæ¯”å¦‚ 80ï¼Œç„¶åæŒ‰ç…§åŸŸåå‘åè½¬å‘ï¼Ÿâ€ ç®€å•çš„å®ç°å°±æ˜¯ä½¿ç”¨ DaemonSet åœ¨æ¯ä¸ª node ä¸Šç›‘å¬ 80ï¼Œç„¶åå†™å¥½è§„åˆ™ï¼Œå› ä¸º Nginx å¤–é¢ç»‘å®šäº†å®¿ä¸»æœº 80 ç«¯å£(å°±åƒ NodePort)ï¼Œæœ¬èº«åˆåœ¨é›†ç¾¤å†…ï¼Œé‚£ä¹ˆå‘åç›´æ¥è½¬å‘åˆ°ç›¸åº” Service IP å°±è¡Œäº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://img.xxlaila.cn/85793kdfksdo43.png" alt="img"></p></li><li><p>åŸŸååˆ†é…åŠåŠ¨æ€æ›´æ–°é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢çš„æ€è·¯ï¼Œé‡‡ç”¨ Nginx ä¼¼ä¹å·²ç»è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯å…¶å®è¿™é‡Œé¢æœ‰ä¸€ä¸ªå¾ˆå¤§ç¼ºé™·ï¼šæ¯æ¬¡æœ‰æ–°æœåŠ¡åŠ å…¥æ€ä¹ˆæ”¹ Nginx é…ç½®ï¼Ÿæ€»ä¸èƒ½æ‰‹åŠ¨æ”¹æˆ–è€…æ¥ä¸ª Rolling Update å‰ç«¯ Nginx Pod å§ï¼Ÿè¿™æ—¶å€™ â€œä¼Ÿå¤§è€Œåˆæ­£ç›´å‹‡æ•¢çš„â€ Ingress ç™»åœºï¼Œå¦‚æœä¸ç®—ä¸Šé¢çš„ Nginxï¼ŒIngress åªæœ‰ä¸¤å¤§ç»„ä»¶ï¼šIngress Controller å’Œ Ingress<br>&nbsp;&nbsp;&nbsp;&nbsp;Ingress ç®€å•çš„ç†è§£å°±æ˜¯ ä½ åŸæ¥è¦æ”¹ Nginx é…ç½®ï¼Œç„¶åé…ç½®å„ç§åŸŸåå¯¹åº”å“ªä¸ª Serviceï¼Œç°åœ¨æŠŠè¿™ä¸ªåŠ¨ä½œæŠ½è±¡å‡ºæ¥ï¼Œå˜æˆä¸€ä¸ª Ingress å¯¹è±¡ï¼Œä½ å¯ä»¥ç”¨ yml åˆ›å»ºï¼Œæ¯æ¬¡ä¸è¦å»æ”¹ Nginx äº†ï¼Œç›´æ¥æ”¹ yml ç„¶ååˆ›å»º/æ›´æ–°å°±è¡Œäº†ï¼›é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šâ€Nginx å’‹æ•´ï¼Ÿâ€<br>&nbsp;&nbsp;&nbsp;&nbsp;Ingress Controller è¿™ä¸œè¥¿å°±æ˜¯è§£å†³ â€œNginx å’‹æ•´â€ çš„ï¼›Ingress Controoler é€šè¿‡ä¸ Kubernetes API äº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ Ingress è§„åˆ™å˜åŒ–ï¼Œç„¶åè¯»å–ä»–ï¼ŒæŒ‰ç…§ä»–è‡ªå·±æ¨¡æ¿ç”Ÿæˆä¸€æ®µ Nginx é…ç½®ï¼Œå†å†™åˆ° Nginx Pod é‡Œï¼Œæœ€å reload ä¸€ä¸‹ï¼Œå·¥ä½œæµç¨‹å¦‚ä¸‹å›¾:</p></li></ul><p><img src="https://img.xxlaila.cn/3248kjfiy4789wodjkshf3.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;å½“ç„¶åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæœ€æ–°ç‰ˆæœ¬ Kubernetes å·²ç»å°† Nginx ä¸ Ingress Controller åˆå¹¶ä¸ºä¸€ä¸ªç»„ä»¶ï¼Œæ‰€ä»¥ Nginx æ— éœ€å•ç‹¬éƒ¨ç½²ï¼Œåªéœ€è¦éƒ¨ç½² Ingress Controller å³å¯ã€‚</p><h3 id="3ã€Nginx-Ingress"><a href="#3ã€Nginx-Ingress" class="headerlink" title="3ã€Nginx Ingress"></a>3ã€Nginx Ingress</h3><h4 id="3-1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶"><a href="#3-1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶" class="headerlink" title="3.1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶"></a>3.1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶</h4><p>å®˜æ–¹çš„mandatory.yamlæ–‡ä»¶é‡Œé¢åŒ…å«äº†ingress RBACï¼Œé‡è¦çš„ç»„ä»¶ <a href="https://github.com/kubernetes/ingress-nginx/tree/nginx-0.20.0/deploy" target="_blank" rel="noopener">Nginx+Ingres Controller</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mandatory.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-configuration</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: udp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-serviceaccount</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - endpoints</span><br><span class="line">      - nodes</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - nodes</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">"extensions"</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - events</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">      - patch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">"extensions"</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses/status</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">      - namespaces</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    resourceNames:</span><br><span class="line">      <span class="comment"># Defaults to "&lt;election-id&gt;-&lt;ingress-class&gt;"</span></span><br><span class="line">      <span class="comment"># Here: "&lt;ingress-controller-leader&gt;-&lt;nginx&gt;"</span></span><br><span class="line">      <span class="comment"># This has to be adapted if you change either parameter</span></span><br><span class="line">      <span class="comment"># when launching the nginx-ingress-controller.</span></span><br><span class="line">      - <span class="string">"ingress-controller-leader-nginx"</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - endpoints</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role-nisa-binding</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">      app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: <span class="string">"10254"</span></span><br><span class="line">        prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx-ingress-controller</span><br><span class="line">          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.22.0</span><br><span class="line">          args:</span><br><span class="line">            - /nginx-ingress-controller</span><br><span class="line">            - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class="line">            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class="line">            - --publish-service=$(POD_NAMESPACE)/ingress-nginx</span><br><span class="line">            - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line">     --default-ssl-certificate=$(POD_NAMESPACE)/ingress-secret</span><br><span class="line">      --default-backend-service=$(POD_NAMESPACE)/default-http-backend</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: <span class="literal">true</span></span><br><span class="line">            capabilities:</span><br><span class="line">              drop:</span><br><span class="line">                - ALL</span><br><span class="line">              add:</span><br><span class="line">                - NET_BIND_SERVICE</span><br><span class="line">            <span class="comment"># www-data -&gt; 33</span></span><br><span class="line">            runAsUser: 33</span><br><span class="line">          env:</span><br><span class="line">            - name: POD_NAME</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.name</span><br><span class="line">            - name: POD_NAMESPACE</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.namespace</span><br><span class="line">          ports:</span><br><span class="line">            - name: http</span><br><span class="line">              containerPort: 80</span><br><span class="line">              hostPort: 80</span><br><span class="line">            - name: https</span><br><span class="line">              containerPort: 443</span><br><span class="line">              hostPort: 443</span><br><span class="line">          livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">          readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>hostNetwork: true</code>æ˜¯å¢åŠ çš„ï¼Œ å®˜æ–¹çš„ Ingress Controller æœ‰ä¸ªå‘ï¼Œé»˜è®¤æ³¨é‡Šäº†hostNetwork å·¥ä½œæ–¹å¼ã€‚ä»¥é˜²æ­¢ç«¯å£çš„åœ¨å®¿ä¸»æœºçš„å†²çªã€‚æ²¡æœ‰ç»‘å®šåˆ°å®¿ä¸»æœº 80 ç«¯å£ï¼Œä¹Ÿå°±æ˜¯è¯´å‰ç«¯ Nginx æ²¡æœ‰ç›‘å¬å®¿ä¸»æœº 80 ç«¯å£ï¼›æ‰€ä»¥éœ€è¦æŠŠé…ç½®æä¸‹æ¥è‡ªå·±åŠ ä¸€ä¸‹ hostNetworkã€‚</p><h4 id="3-2ã€éƒ¨ç½²é»˜è®¤åç«¯"><a href="#3-2ã€éƒ¨ç½²é»˜è®¤åç«¯" class="headerlink" title="3.2ã€éƒ¨ç½²é»˜è®¤åç«¯"></a>3.2ã€éƒ¨ç½²é»˜è®¤åç«¯</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬çŸ¥é“ å‰ç«¯çš„ Nginx æœ€ç»ˆè¦è´Ÿè½½åˆ°åç«¯ service ä¸Šï¼Œé‚£ä¹ˆå¦‚æœè®¿é—®ä¸å­˜åœ¨çš„åŸŸåå’‹æ•´ï¼Ÿå®˜æ–¹ç»™å‡ºçš„å»ºè®®æ˜¯éƒ¨ç½²ä¸€ä¸ª é»˜è®¤åç«¯ï¼Œå¯¹äºæœªçŸ¥è¯·æ±‚å…¨éƒ¨è´Ÿè½½åˆ°è¿™ä¸ªé»˜è®¤åç«¯ä¸Šï¼›è¿™ä¸ªåç«¯å•¥ä¹Ÿä¸å¹²ï¼Œå°±æ˜¯è¿”å› 404ï¼Œéƒ¨ç½²å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat default-backend.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: default-http-backend</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - name: default-http-backend</span><br><span class="line">        <span class="comment"># Any image is permissable as long as:</span></span><br><span class="line">        <span class="comment"># 1. It serves a 404 page at /</span></span><br><span class="line">        <span class="comment"># 2. It serves 200 on a /healthz endpoint</span></span><br><span class="line">        image: docker.io/xxlaila/defaultbackend:1.4</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line"><span class="comment">#      nodeSelector:</span></span><br><span class="line"><span class="comment">#        kubernetes.io/hostname: 172.21.16.231</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: default-http-backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: default-http-backend</span><br></pre></td></tr></table></figure><h4 id="3-3ã€æ‰§è¡Œåˆ›å»º-å®Œæˆåå¯ä»¥çœ‹åˆ°"><a href="#3-3ã€æ‰§è¡Œåˆ›å»º-å®Œæˆåå¯ä»¥çœ‹åˆ°" class="headerlink" title="3.3ã€æ‰§è¡Œåˆ›å»º,å®Œæˆåå¯ä»¥çœ‹åˆ°"></a>3.3ã€æ‰§è¡Œåˆ›å»º,å®Œæˆåå¯ä»¥çœ‹åˆ°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f mandatory.yaml </span></span><br><span class="line"><span class="comment"># kubectl create -f default-backend.yaml</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/34dnksjfh384yksfkjdsfsd.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n ingress-nginx</span></span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">default-http-backend-66cdcb6c7d-pb9sp      1/1     Running   0          8h</span><br><span class="line">nginx-ingress-controller-69585dbb4-m6fcm   1/1     Running   0          8h</span><br><span class="line"><span class="comment"># kubectl get svc -n ingress-nginx</span></span><br><span class="line">NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default-http-backend   ClusterIP   10.102.60.154   &lt;none&gt;        80/TCP    8h</span><br></pre></td></tr></table></figure><h3 id="4ã€éƒ¨ç½²-Ingress"><a href="#4ã€éƒ¨ç½²-Ingress" class="headerlink" title="4ã€éƒ¨ç½² Ingress"></a>4ã€éƒ¨ç½² Ingress</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢å¯ä»¥çŸ¥é“ Ingress å°±æ˜¯ä¸ªè§„åˆ™ï¼ŒæŒ‡å®šå“ªä¸ªåŸŸåè½¬å‘åˆ°å“ªä¸ª Serviceï¼Œæ‰€ä»¥è¯´é¦–å…ˆæˆ‘ä»¬å¾—æœ‰ä¸ª Serviceï¼Œå½“ç„¶ Service å»å“ªæ‰¾è¿™é‡Œå°±ä¸ç®¡äº†ï¼›è¿™é‡Œé»˜è®¤ä¸ºå·²ç»æœ‰äº†ä¸¤ä¸ªå¯ç”¨çš„ Serviceï¼Œä»¥ä¸‹ä»¥ jenkinsã€Dashboard ä¸ºä¾‹<br>&nbsp;&nbsp;&nbsp;&nbsp;å…ˆå†™ä¸€ä¸ª Ingress æ–‡ä»¶ï¼Œè¯­æ³•æ ¼å¼å•¥çš„è¯·å‚è€ƒ å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºæˆ‘çš„ jenkinsåœ¨kube-opsï¼ŒDashboard åœ¨kube-system è¿™ä¸ªå‘½åç©ºé—´ï¼Œæ‰€ä»¥è¦æŒ‡å®š namespace.å‚è€ƒä¸‹é¢å®ä¾‹</p><h4 id="4-1ã€éƒ¨ç½²jenkinså®ä¾‹"><a href="#4-1ã€éƒ¨ç½²jenkinså®ä¾‹" class="headerlink" title="4.1ã€éƒ¨ç½²jenkinså®ä¾‹"></a>4.1ã€éƒ¨ç½²jenkinså®ä¾‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-ingress</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: ci.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: jenkins2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"><span class="comment"># kubectl create -f jenkins-ingress.yaml</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒåŸŸåè§£æåˆ°ipåœ°å€ï¼Œè®¿é—®jenkins</p><p><img src="https://img.xxlaila.cn/1566808344775.jpg" alt="img"></p><h4 id="4-2ã€éƒ¨ç½²kubernetes-dashboard"><a href="#4-2ã€éƒ¨ç½²kubernetes-dashboard" class="headerlink" title="4.2ã€éƒ¨ç½²kubernetes-dashboard"></a>4.2ã€éƒ¨ç½²kubernetes-dashboard</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat nginx-kubernetes-dashboard.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/ingress.class: nginx</span><br><span class="line">    nginx.ingress.kubernetes.io/secure-backends: <span class="string">"true"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-passthrough: <span class="string">"true"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - k8s.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">    - host: dashboard.xxlaila.io</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: kubernetes-dashboard</span><br><span class="line">            servicePort: 443</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/786jg656iojhf0.png" alt="img"></p><h3 id="5ã€éƒ¨ç½²-Ingress-TLS"><a href="#5ã€éƒ¨ç½²-Ingress-TLS" class="headerlink" title="5ã€éƒ¨ç½² Ingress TLS"></a>5ã€éƒ¨ç½² Ingress TLS</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢å·²ç»åšå¥½äº† Ingressï¼Œæ¥ä¸‹æ¥é…ç½®TLS ï¼›å®˜æ–¹ç»™å‡ºçš„æ ·ä¾‹å¾ˆç®€å•ï¼Œå¤§è‡´æ­¥éª¤å°±ä¸¤æ­¥ï¼šåˆ›å»ºä¸€ä¸ªå«æœ‰è¯ä¹¦çš„ secretã€åœ¨ Ingress å¼€å¯è¯ä¹¦ï¼›ä½†æ˜¯å®˜æ–¹çš„æœ‰å‘ï¼Œä¸‹é¢æ˜¯æ“ä½œæ­¥éª¤</p><h4 id="5-1ã€åˆ›å»ºè¯ä¹¦"><a href="#5-1ã€åˆ›å»ºè¯ä¹¦" class="headerlink" title="5.1ã€åˆ›å»ºè¯ä¹¦"></a>5.1ã€åˆ›å»ºè¯ä¹¦</h4><p>é¦–å…ˆç¬¬ä¸€æ­¥å½“ç„¶è¦æœ‰ä¸ªè¯ä¹¦ï¼Œç”±äºæˆ‘è¿™ä¸ª Ingress æœ‰ä¸¤ä¸ªæœåŠ¡åŸŸåï¼Œæ‰€ä»¥è¯ä¹¦è¦æ”¯æŒä¸¤ä¸ªåŸŸåï¼›ç”Ÿæˆè¯ä¹¦å‘½ä»¤å¦‚ä¸‹ï¼š</p><ul><li><p>ç”ŸæˆCAè¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir cert &amp;&amp; cd cert</span></span><br></pre></td></tr></table></figure></li><li><p>ç¼–è¾‘ openssl é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /etc/pki/tls/openssl.cnf .</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ä¸»è¦é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi openssl.cnf</span></span><br><span class="line">	[req]</span><br><span class="line">	req_extensions = v3_req <span class="comment"># è¿™è¡Œé»˜è®¤æ³¨é‡Šå…³ç€çš„ æŠŠæ³¨é‡Šåˆ æ‰</span></span><br></pre></td></tr></table></figure></li><li><p>å¢åŠ é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi openssl.cnf</span></span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = dashboard.mritd.me		<span class="comment">#éœ€è¦å¢åŠ çš„åŸŸå</span></span><br><span class="line">DNS.2 = kibana.mritd.me</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆè¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl genrsa -out ingress-key.pem 2048</span></span><br><span class="line"><span class="comment"># openssl req -new -key ingress-key.pem -out ingress.csr -subj "/CN=kube-ingress" -config openssl.cnf</span></span><br><span class="line"><span class="comment"># openssl x509 -req -in ingress.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out ingress.pem -days 365 -extensions v3_req -extfile openssl.cnf</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç”Ÿæˆåçš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">ca-key.pem  ca.pem  ca.srl  ingress-key.pem  ingress.csr  ingress.pem  openssl.cnf</span><br></pre></td></tr></table></figure></li></ul><h4 id="5-2ã€åˆ›å»º-secret"><a href="#5-2ã€åˆ›å»º-secret" class="headerlink" title="5.2ã€åˆ›å»º secret"></a>5.2ã€åˆ›å»º secret</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå¥½è¯ä¹¦ä»¥åï¼Œéœ€è¦å°†è¯ä¹¦å†…å®¹æ”¾åˆ° secret ä¸­ï¼Œsecret ä¸­å…¨éƒ¨å†…å®¹éœ€è¦ base64 ç¼–ç ï¼Œç„¶åæ³¨æ„å»æ‰æ¢è¡Œç¬¦(å˜æˆä¸€è¡Œ)ï¼›ä»¥ä¸‹æ˜¯æˆ‘çš„ secret æ ·ä¾‹(ä¸Šä¸€æ­¥ä¸­ ingress.pem æ˜¯è¯ä¹¦crtï¼Œingress-key.pem æ˜¯è¯ä¹¦çš„ key)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ingress-secret.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  tls.crt: MIIDAjCCAeqgAwIBAgIJAIUNBpFKFrg4MA0GCSqGSIb3DQEBCwUAMBIxEDAOBgNVBAMMB2t1YmUtY2EwHhcNMTkwMTI5MTAzMzQ3WhcNMjAwMTI5MTAzMzQ3WjAXMRUwEwYDVQQDDAxrdWJlLWluZ3Jlc3MwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC0rLcpYHdqVjN84vCJYF2l61F+LYuPRczPNWyo8Rba4XpT6MMMqoGqgmI164r4of2klBEMPZ0dm1mJaYnjb1Zq/qzVUlqaednxfXsr6u8Xm0a6l7ep+Yr+XcRISZC9AjgyqlFtgjzbNJauHkHTy0i+jqV2A4SkVUT2whBqF00WEKC6kQLhw4Ab1XBG5aOK2Jz4TZdP+Mw4n3AsihycHgjhFvhGNixKl4mpfHfLvFeKxmBa8ZoWT+3AGgkX186EXhdhsfdYqHeLT2TvwsqbUJI8E8F7nleo5VMifr9KGHxaCJ+ynr/WFX1c+0wYAGmSKsw4CnXh4EE+IvaeQjBz8O2HAgMBAAGjVjBUMAkGA1UdEwQCMAAwCwYDVR0PBAQDAgXgMDoGA1UdEQQzMDGCFmNpLnp4Yy5raW5neHVubGlhbi5jb22CF2s4cy56eGMua2luZ3h1bmxpYW4uY29tMA0GCSqGSIb3DQEBCwUAA4IBAQCShThVXg3Fnkrm82sHowxCEc9UG9uzOY2LbxhVN7mcm8U0cXy3acAXdKWLHUwdZnOxNJytpaBBWb/6KFFKrIekaSK+tSD+oRISJf43c1tbt0QEpplUaDagQ35NANyQY2VHQntDdVK4/NNJULbHNEqsu19vDDvmDFi0aLHvqPFAvlGnEBPgO1Ac297pDR2thHyMCGBzRKTQOJy2q3HKexa1pItHjAVmv/k71HBeTJ1en2tFHLUlR0kEhYYPBeRclVZ1oYWn7THRaBW8NtugdM6mxVNFAWQTq5goP0VcW44lWYiUF6mX/UZa2c+5FwsGWdSwbTqmZj7ptA2QcveUcN2/</span><br><span class="line">  tls.key: MIIEowIBAAKCAQEAtKy3KWB3alYzfOLwiWBdpetRfi2Lj0XMzzVsqPEW2uF6U+jDDKqBqoJiNeuK+KH9pJQRDD2dHZtZiWmJ429Wav6s1VJamnnZ8X17K+rvF5tGupe3qfmK/l3ESEmQvQI4MqpRbYI82zSWrh5B08tIvo6ldgOEpFVE9sIQahdNFhCgupEC4cOAG9VwRuWjitic+E2XT/jMOJ9wLIocnB4I4Rb4RjYsSpeJqXx3y7xXisZgWvGaFk/twBoJF9fOhF4XYbH3WKh3i09k78LKm1CSPBPBe55XqOVTIn6/Shh8Wgifsp6/1hV9XPtMGABpkirMOAp14eBBPiL2nkIwc/DthwIDAQABAoIBACLj97sV1fnDC85iRPFCmtMfzmz/fqP8ZsDdIE6/wBok0OrDWGdpxgCXjT+8bOn23nSZ43DptR2ykmfm6anyJk4jQF0xui16uovYH6ErjWCRq+b8xYsdlanpka4kBr95XkDqgy8Sp43taevWDABKkZG7Gljf9Q2HKfo9H85dEZXg7RKKz77wahcHpZofthNo0s5kkH2ckVpjwh5svM+M/gm8KhZkKayndr1ezEAmndT+K/P4EVuYbpPQyk5A6E1G7Dh9M2TczZZa6oiR5etloDk2sOIYxysIZqAblyMN2IrIO0hf4nGqSmfe0TZMCKzSXoVOV2Qe+ckJ+mSyOPcdbIECgYEA3EMWrrr4oc9R8o35mQ2FDCG0FUyXrCo9SN/CyhScdeUx1IRV00CBwL340H1CwzEpj5g4bj6LGGSeEw2g8qfPoPdzr1yxNnCv43dhaGrWRrSxGL6kGfKmIlbgHTPIuzRkAXGWiCgo5JnzPjQtjmpUTmwmxXwqDih8kpRsBSTsmx0CgYEA0f1ORGtmrj/bRBQU0NF+ztTVFJQbPV3lTHl21Qgd8QcEIcOHqzpI2fmkeGZdyYQXIfODA/X+PFng+Z6J5ubtvplN5jPzpQuQRtIZ47NRmtgn4DoH+GAqxIb2hFbwXpXuSR/LelFtzxb91nGiVKpdizvuwnitgOuAIbgGHYbgpfMCgYAvvA5fYb/eeWq+EUzFgauS3H8FmqrIMgNEFtJFL0BVQI2TC/b5qGI2XjVdIbhlSvNB3nBkXAOTDsM/R9XYoMubi+UzXPg+3x8PQeEHWxgDDMfQoAg6Y17j1EYPrhhTkeAWfAJukZ2DJWYU1gQFeD+7Gy8v31/R365XqfjbCIyKdQKBgD+/3tr2oB2WVUK9tfQPJag1BNtSe1KOBubImULjS/O4ZZC6g51//E3wc/X5Xc+nwj4UZ1n0fFJmFt6xOrxWryaF9BhG/VjFwe8+KY3vCn8v0CtKctD8oP842e4jVqXgbo7UkDl6LxQHrthDdzys2+lBMKLpcAMLe8LA01pzcA/xAoGBAK3KXGXz0AsM+5FBbUFVZFOROUQLcd+N8esHnSqD8i7/J0PJsxm9irutuLht0cYK7Fcq65fYmZ4lrJO7bpiBRzONR78lMgm/rcKfCCNr4o4n6almvuFxA+jGgEM2W7iYb9pW+FFOqIOjl0cSHy2hsN7seGv3JBcz5StRjtwuSWf6</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-secret</span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºå®Œæˆå create<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ingress-secret.yml</span></span><br><span class="line">secret/ingress-secret created</span><br></pre></td></tr></table></figure></li></ul><h4 id="5-3ã€å¿«é€Ÿåˆ›å»º"><a href="#5-3ã€å¿«é€Ÿåˆ›å»º" class="headerlink" title="5.3ã€å¿«é€Ÿåˆ›å»º"></a>5.3ã€å¿«é€Ÿåˆ›å»º</h4><p>5.2æ­¥éª¤å¯ä»¥ç®€åŒ–åˆ›å»ºï¼Œå¯ä»¥æ‰§è¡Œä¸€æ¡å‘½ä»¤è¿›è¡Œåˆ›å»ºï¼Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create secret tls ingress-secret --key cert/ingress-key.pem --cert cert/ingress.pem</span></span><br></pre></td></tr></table></figure><h4 id="5-4ã€é‡æ–°éƒ¨ç½²-Ingress"><a href="#5-4ã€é‡æ–°éƒ¨ç½²-Ingress" class="headerlink" title="5.4ã€é‡æ–°éƒ¨ç½² Ingress"></a>5.4ã€é‡æ–°éƒ¨ç½² Ingress</h4><p>åœ¨tlsç”Ÿæˆå®Œæˆåï¼Œéœ€è¦é‡æ–°éƒ¨ç½²Ingressï¼Œè®©Ingressèƒ½å¤Ÿå®¶åœ¨tlsã€‚ä¿®æ”¹é…ç½®æ–‡ä»¶</p><h5 id="5-4-1ã€jenkins-tls"><a href="#5-4-1ã€jenkins-tls" class="headerlink" title="5.4.1ã€jenkins tls"></a>5.4.1ã€jenkins tls</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi jenkins-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-ingress</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ci.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ci.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: jenkins2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"><span class="comment"># kubect create -f jenkins-ingress.yaml</span></span><br></pre></td></tr></table></figure><p>è®¿é—®jenkinsåŸŸåï¼Œè¿™é‡Œè¾“å…¥httpè®¿é—®ä¼šå¼ºåˆ¶è·³è½¬åˆ°https<br><img src="https://img.xxlaila.cn/1566808668453.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566808711171.jpg" alt="img"></p><h5 id="5-4-2ã€kubernetes-dashboard-tls"><a href="#5-4-2ã€kubernetes-dashboard-tls" class="headerlink" title="5.4.2ã€kubernetes dashboard tls"></a>5.4.2ã€kubernetes dashboard tls</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim nginx-kubernetes-dashboard.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - k8s.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: k8s.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 80</span><br><span class="line"><span class="comment"># kubectl create -f nginx-kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure><h3 id="6ã€ingress-é«˜çº§ç”¨æ³•"><a href="#6ã€ingress-é«˜çº§ç”¨æ³•" class="headerlink" title="6ã€ingress é«˜çº§ç”¨æ³•"></a>6ã€ingress é«˜çº§ç”¨æ³•</h3><p><img src="https://img.xxlaila.cn/34324kjsdfh8234ks.png" alt="img"></p><ul><li>lvs åå‘ä»£ç†åˆ° ç‰©ç†nginxã€‚å®Œæˆhttpsæ‹†åŒ…ï¼Œç»§æ‰¿nginxæ‰€æœ‰åŠŸèƒ½</li><li>nginx åå‘ä»£ç†åˆ°ingress-controlã€‚ ingress-control æœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ ã€‚<ul><li>ingress-control ä½¿ç”¨nodePort æ–¹å¼æš´æ¼æœåŠ¡</li><li>ingress-control ä½¿ç”¨hostNetwork æ–¹å¼æš´æ¼æœåŠ¡</li></ul></li></ul><h3 id="7ã€æ€»ç»“åˆ†æ"><a href="#7ã€æ€»ç»“åˆ†æ" class="headerlink" title="7ã€æ€»ç»“åˆ†æ"></a>7ã€æ€»ç»“åˆ†æ</h3><ul><li>ingress-control åœ¨è‡ªå·±çš„æ‰€å±çš„namespace=ingress, æ˜¯å¯ä»¥å¤¸ä¸åŒnamespaceæä¾›åå‘ä»£ç†æœ.</li><li>å¦‚æœéœ€è¦æä¾›å¤¸NS è®¿é—®ingressï¼Œå…ˆç»™ ingress-controlåˆ›å»ºRBAC</li><li>ingress-control ä½¿ç”¨hostnetwork æ¨¡å¼ æ€§èƒ½æ¯”ä½¿ç”¨service nodePort æ€§èƒ½å¥½å¾ˆå¤šã€‚å› ä¸ºhostnetwork æ˜¯ç›´æ¥è·å–pod çš„IPï¼Ÿ</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Ingress</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²Weave Scope</title>
    <url>/2019/08/26/k8s%E9%83%A8%E7%BD%B2Weave-Scope/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="1ã€Weave-Scopeä»‹ç»"><a href="#1ã€Weave-Scopeä»‹ç»" class="headerlink" title="1ã€Weave Scopeä»‹ç»"></a>1ã€Weave Scopeä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;weave scope æ˜¯Dockerå’ŒKubernetesçš„æ•…éšœæ’é™¤å’Œç›‘æ§ï¼Œè‡ªåŠ¨ç”Ÿæˆåº”ç”¨ç¨‹åºçš„åœ°å›¾ï¼Œèƒ½å¤Ÿç›´è§‚åœ°äº†è§£ï¼Œç›‘æ§å’Œæ§åˆ¶åŸºäºå®¹å™¨çš„ï¼ŒåŸºäºå¾®æœåŠ¡çš„åº”ç”¨ç¨‹åºã€‚å¯ä»¥å®æ—¶çš„äº†è§£dockerå®¹å™¨ï¼Œé€‰æ‹©å®¹å™¨åŸºç¡€æ¶æ„çš„æ¦‚è¿°ï¼Œæˆ–å…³æ³¨ç‰¹å®šçš„å¾®æœåŠ¡ã€‚è½»æ¾è¯†åˆ«å’Œçº æ­£é—®é¢˜ï¼Œç¡®ä¿é›†è£…ç®±åŒ–åº”ç”¨çš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼ŒæŸ¥çœ‹å®¹å™¨çš„ä¸Šä¸‹æ–‡æŒ‡æ ‡ï¼Œæ ‡è®°å’Œå…ƒæ•°æ®ã€‚è½»æ¾åœ°åœ¨å®¹å™¨å†…çš„è¿›ç¨‹ä¹‹é—´å¯¼èˆªï¼Œä»¥è¿è¡Œå®¹å™¨ï¼Œåœ¨å¯æ‰©å±•çš„å¯æ’åºè¡¨ä¸­è¿›è¡Œæ’åˆ—ã€‚ä½¿ç”¨ç»™å®šä¸»æœºæˆ–æœåŠ¡çš„æœ€å¤§CPUæˆ–å†…å­˜è½»æ¾æ‰¾åˆ°å®¹å™¨ã€‚ç›´æ¥ä¸æ‚¨çš„å®¹å™¨äº¤äº’ï¼šæš‚åœï¼Œé‡æ–°å¯åŠ¨å’Œåœæ­¢å®¹å™¨ã€‚å¯åŠ¨å‘½ä»¤è¡Œã€‚å…¨éƒ¨ä¸ç¦»å¼€èŒƒå›´æµè§ˆå™¨çª—å£ã€‚</p><p><img src="https://img.xxlaila.cn/378246bsjfhsajkdq.png" alt="img"></p><h3 id="2ã€éƒ¨ç½²weave-scope"><a href="#2ã€éƒ¨ç½²weave-scope" class="headerlink" title="2ã€éƒ¨ç½²weave scope"></a>2ã€éƒ¨ç½²weave scope</h3><p>åˆæ¬¡å­¦ä¹ ï¼Œç›´æ¥ä¸‹è½½å®˜æ–¹é…ç½®æ–‡ä»¶ï¼Œæ²¡æœ‰ç»è¿‡ä»»ä½•ä¿®æ”¹ï¼Œä¸è¿‡ç›¸ä¿¡è‡ªå·±éšç€å­¦ä¹ çš„è¿›æ­¥ï¼Œä¼šé€æ¸æ·±å…¥ã€‚<a href="https://github.com/weaveworks/scope" target="_blank" rel="noopener">githubåœ°å€</a>ï¼Œ<a href="https://www.weave.works/docs/cloud/latest/overview/" target="_blank" rel="noopener">å®˜æ–¹åœ°å€</a></p><a id="more"></a><h4 id="2-1ã€ä¸‹è½½é…ç½®æ–‡ä»¶"><a href="#2-1ã€ä¸‹è½½é…ç½®æ–‡ä»¶" class="headerlink" title="2.1ã€ä¸‹è½½é…ç½®æ–‡ä»¶"></a>2.1ã€ä¸‹è½½é…ç½®æ–‡ä»¶</h4><p><a href="https://github.com/weaveworks/scope/tree/master/examples/k8s" target="_blank" rel="noopener">ä¸‹è½½é…ç½®æ–‡ä»¶</a>,é…ç½®æ–‡ä»¶å¦‚ä¸‹åˆ—è¡¨:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -l</span></span><br><span class="line">cluster-role-binding.yaml</span><br><span class="line">cluster-role.yaml</span><br><span class="line">deploy.yaml</span><br><span class="line">ds.yaml</span><br><span class="line">ns.yaml</span><br><span class="line">psp.yaml</span><br><span class="line">sa.yaml</span><br><span class="line">scope.yaml</span><br><span class="line">svc.yaml</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ›å»º<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ./</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2ã€æŸ¥çœ‹éƒ¨ç½²"><a href="#2-2ã€æŸ¥çœ‹éƒ¨ç½²" class="headerlink" title="2.2ã€æŸ¥çœ‹éƒ¨ç½²"></a>2.2ã€æŸ¥çœ‹éƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc,pods -n weave</span></span><br><span class="line">NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/weave-scope-app   ClusterIP   10.99.252.207   &lt;none&gt;        80/TCP    25m</span><br><span class="line"></span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/weave-scope-agent-gpwmw            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-lmf22            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-r8vft            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-rph5p            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-zfrnc            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-app-5c46dd7467-s8cp8   1/1     Running   0          24m</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/3489hdnsjkhd8324sd.png" alt="img"></p><h4 id="2-3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€"><a href="#2-3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€" class="headerlink" title="2.3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€"></a>2.3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services -n weave</span></span><br><span class="line">NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">weave-scope-app   ClusterIP   10.99.252.207   &lt;none&gt;        80/TCP    27m</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ°è¿™é‡Œweave-scopeéƒ¨ç½²å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œè®¿é—®ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¹‹å‰å­¦ä¹ çš„nginx Ingressæ¥å¯¹scopeé…ç½®ä¸€ä¸ªåŸŸåï¼Œç„¶åå§åŸŸåè§£æåˆ°åˆ¶å®šçš„ipåœ°å€ä¸Šè¿›è¡Œè®¿é—®</p><h3 id="3ã€é…ç½®scopeåŸŸå"><a href="#3ã€é…ç½®scopeåŸŸå" class="headerlink" title="3ã€é…ç½®scopeåŸŸå"></a>3ã€é…ç½®scopeåŸŸå</h3><p>æ–°å»ºç«‹ä¸€ä¸ªyamlæ–‡ä»¶ï¼Œå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat scope-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: scope-ingress</span><br><span class="line">  namespace: weave</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: scope.xxlaila.io</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: weave-scope-app</span><br><span class="line">            servicePort: 80</span><br><span class="line"><span class="comment"># kubectl create -f scope-ingress.yaml</span></span><br></pre></td></tr></table></figure><blockquote><p>é€šè¿‡åŸŸåè®¿é—®ï¼š<a href="http://scope.xxlaila.io" target="_blank" rel="noopener">http://scope.xxlaila.io</a></p></blockquote><p><img src="https://img.xxlaila.cn/287346jskbdjy784kjs.png" alt="img"><br><img src="https://img.xxlaila.cn/3o4wndk9234sd.png" alt="img"><br><img src="https://img.xxlaila.cn/34873i24dfsd.png" alt="img"><br><img src="https://img.xxlaila.cn/458dskjfhu2y4skdsds.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Weave Scope</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²zookeeperé›†ç¾¤</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2zookeeper%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>zkå±äºæœ‰çŠ¶æ€æœåŠ¡ï¼Œéœ€è¦è¿æ¥å¤–éƒ¨å­˜å‚¨ï¼Œå§æ•°æ®å­˜æ”¾åœ¨æ•°æ®ç›˜é‡Œé¢ï¼Œå¦åˆ™å®¹å™¨æŒ‚äº†ï¼Œæ•°æ®æ²¡æœ‰äº†</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å‡†å¤‡zkçš„yamlæ–‡ä»¶</p><a id="more"></a><h3 id="1ã€é…ç½®zk-dataæ–‡ä»¶"><a href="#1ã€é…ç½®zk-dataæ–‡ä»¶" class="headerlink" title="1ã€é…ç½®zk-dataæ–‡ä»¶"></a>1ã€é…ç½®zk-dataæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat zk-data.yaml</span></span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk1</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">---</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk2</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">---</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk3</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line"><span class="comment"># cat zookeeper.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-hs</span><br><span class="line">  labels:</span><br><span class="line">    app: zk</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2888</span><br><span class="line">    name: server</span><br><span class="line">  - port: 3888</span><br><span class="line">    name: leader-election</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-cs</span><br><span class="line">  labels:</span><br><span class="line">    app: zk</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2181</span><br><span class="line">    name: client</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodDisruptionBudget</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-pdb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  maxUnavailable: 1</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: zk</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  serviceName: zk-hs</span><br><span class="line">  replicas: 3</span><br><span class="line">  updateStrategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">  podManagementPolicy: Parallel</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: zk</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: <span class="string">"app"</span></span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                    - zk</span><br><span class="line">              topologyKey: <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-zookeeper</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        image: <span class="string">"xxlaila/kubernetes-zookeeper:1.0-3.4.10"</span></span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"1Gi"</span></span><br><span class="line">            cpu: <span class="string">"0.5"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 2181</span><br><span class="line">          name: client</span><br><span class="line">        - containerPort: 2888</span><br><span class="line">          name: server</span><br><span class="line">        - containerPort: 3888</span><br><span class="line">          name: leader-election</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - <span class="string">"start-zookeeper \</span></span><br><span class="line"><span class="string">          --servers=3 \</span></span><br><span class="line"><span class="string">          --data_dir=/var/lib/zookeeper/data \</span></span><br><span class="line"><span class="string">          --data_log_dir=/var/lib/zookeeper/data/log \</span></span><br><span class="line"><span class="string">          --conf_dir=/opt/zookeeper/conf \</span></span><br><span class="line"><span class="string">          --client_port=2181 \</span></span><br><span class="line"><span class="string">          --election_port=3888 \</span></span><br><span class="line"><span class="string">          --server_port=2888 \</span></span><br><span class="line"><span class="string">          --tick_time=2000 \</span></span><br><span class="line"><span class="string">          --init_limit=10 \</span></span><br><span class="line"><span class="string">          --sync_limit=5 \</span></span><br><span class="line"><span class="string">          --heap=512M \</span></span><br><span class="line"><span class="string">          --max_client_cnxns=60 \</span></span><br><span class="line"><span class="string">          --snap_retain_count=3 \</span></span><br><span class="line"><span class="string">          --purge_interval=12 \</span></span><br><span class="line"><span class="string">          --max_session_timeout=40000 \</span></span><br><span class="line"><span class="string">          --min_session_timeout=4000 \</span></span><br><span class="line"><span class="string">          --log_level=INFO"</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">            - -c</span><br><span class="line">            - <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        livenessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">            - -c</span><br><span class="line">            - <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: datadir</span><br><span class="line">          mountPath: /var/lib/zookeeper</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 1000</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: datadir</span><br><span class="line">      annotations:</span><br><span class="line">        volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 3Gi</span><br></pre></td></tr></table></figure><h3 id="2ã€æ‰§è¡Œéƒ¨ç½²"><a href="#2ã€æ‰§è¡Œéƒ¨ç½²" class="headerlink" title="2ã€æ‰§è¡Œéƒ¨ç½²"></a>2ã€æ‰§è¡Œéƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f zookeeper.yaml -n kube-dev</span></span><br></pre></td></tr></table></figure><h3 id="3ã€æŸ¥çœ‹éƒ¨ç½²"><a href="#3ã€æŸ¥çœ‹éƒ¨ç½²" class="headerlink" title="3ã€æŸ¥çœ‹éƒ¨ç½²"></a>3ã€æŸ¥çœ‹éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide -n kube-dev</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">zk-0                            1/1     Running   0          6m13s   10.254.62.4   172.21.17.15    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">zk-1                            1/1     Running   0          6m12s   10.254.21.4   172.21.16.96    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">zk-2                            1/1     Running   0          6m12s   10.254.96.4   172.21.16.193   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜"><a href="#4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜" class="headerlink" title="4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜"></a>4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv -o wide -n kube-dev</span></span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                             STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-d1cb6a1c-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-0             managed-nfs-storage            6m18s</span><br><span class="line">pvc-d20a95ec-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-1             managed-nfs-storage            6m18s</span><br><span class="line">pvc-d23577af-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-2             managed-nfs-storage            6m23s</span><br></pre></td></tr></table></figure><h3 id="5ã€æŸ¥çœ‹pvc"><a href="#5ã€æŸ¥çœ‹pvc" class="headerlink" title="5ã€æŸ¥çœ‹pvc"></a>5ã€æŸ¥çœ‹pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pvc -o wide -n kube-dev</span></span><br><span class="line">NAME                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">datadir-zk-0             Bound    pvc-d1cb6a1c-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m38s</span><br><span class="line">datadir-zk-1             Bound    pvc-d20a95ec-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m37s</span><br><span class="line">datadir-zk-2             Bound    pvc-d23577af-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m37s</span><br></pre></td></tr></table></figure><h3 id="6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸"><a href="#6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸" class="headerlink" title="6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸"></a>6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in 0 1 2; do kubectl exec zk-$i zkServer.sh status -n kube-dev; done</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><h3 id="7ã€é›†ç¾¤çš„è®¿é—®åœ°å€"><a href="#7ã€é›†ç¾¤çš„è®¿é—®åœ°å€" class="headerlink" title="7ã€é›†ç¾¤çš„è®¿é—®åœ°å€"></a>7ã€é›†ç¾¤çš„è®¿é—®åœ°å€</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server.1=zk-0.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br><span class="line">server.2=zk-1.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br><span class="line">server.3=zk-2.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²coredns</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2coredns/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;k8sé›†ç¾¤ä¸­çš„åº”ç”¨é€šå¸¸æ˜¯é€šè¿‡ingresså®ç°å¾®æœåŠ¡å‘å¸ƒçš„ï¼Œå‰æ–‡ä»‹ç»è¿‡åœ¨K8Sé›†ç¾¤ä¸­ä½¿ç”¨traefikå®ç°æœåŠ¡çš„è‡ªåŠ¨å‘å¸ƒï¼Œå…¶å®ç°æ–¹å¼æ˜¯traefiké€šè¿‡é›†ç¾¤çš„DNSæœåŠ¡æ¥è§£æserviceå¯¹åº”çš„é›†ç¾¤åœ°å€ï¼ˆclusteripï¼‰ï¼Œä»è€Œå°†ç”¨æˆ·çš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤åœ°å€ä¸Šã€‚å› æ­¤ï¼Œåœ¨éƒ¨ç½²å®Œé›†ç¾¤åçš„ç¬¬ä¸€ä»¶äº‹æƒ…åº”è¯¥æ˜¯é…ç½®DNSæœåŠ¡ï¼Œç›®å‰å¯é€‰çš„æ–¹æ¡ˆæœ‰skydns, kube-dns, corednsã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;kubednsæ˜¯Kubernetesä¸­çš„ä¸€ä¸ªå†…ç½®æ’ä»¶ï¼Œç›®å‰ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¼€æºé¡¹ç›®ç»´æŠ¤ï¼Œè§<a href="https://github.com/kubernetes/dnsã€‚è¯¥DNSæœåŠ¡å™¨åˆ©ç”¨SkyDNSçš„åº“æ¥ä¸ºKubernetes" target="_blank" rel="noopener">https://github.com/kubernetes/dnsã€‚è¯¥DNSæœåŠ¡å™¨åˆ©ç”¨SkyDNSçš„åº“æ¥ä¸ºKubernetes</a> podå’ŒæœåŠ¡æä¾›DNSè¯·æ±‚ã€‚CoreDNSé¡¹ç›®æ˜¯SkyDNS2çš„ä½œè€…ï¼ŒMiek Giebené‡‡ç”¨æ›´æ¨¡å—åŒ–ï¼Œå¯æ‰©å±•çš„æ¡†æ¶æ„å»º,å°†æ­¤DNSæœåŠ¡å™¨ä½œä¸ºKubeDNSçš„æ›¿ä»£å“ã€‚CoreDNSä½œä¸ºCNCFä¸­çš„æ‰˜ç®¡çš„ä¸€ä¸ªé¡¹ç›®ï¼Œåœ¨Kuberentes1.9ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨kubeadmæ–¹å¼å®‰è£…çš„é›†ç¾¤å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç›´æ¥å®‰è£…CoreDNSã€‚kubeadm init â€“feature-gates=CoreDNS=true</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å‡†å¤‡corednsçš„<a href="https://github.com/coredns/deployment.git" target="_blank" rel="noopener">yamlæ–‡ä»¶</a></p><a id="more"></a><p>é¦–å…ˆæˆ‘ä»¬çš„æŸ¥çœ‹<code>cat /etc/kubernetes/kubelet</code> dnsçš„ipåœ°å€æ˜¯å¤šå°‘ï¼Œè¿™é‡Œæˆ‘çš„æ˜¯<code>10.254.0.2</code>ï¼Œæ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œä¿®æ”¹</p><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./deploy.sh -i 10.254.0.2 | kubectl apply -f -</span></span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure></li><li><p>æ“¦çœ‹corednsä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deployment,rc -n kube-system|grep dns</span></span><br><span class="line">pod/coredns-799775f9b6-mgdc9                1/1     Running   0          12m</span><br><span class="line">pod/coredns-799775f9b6-v95lp                1/1     Running   0          12m</span><br><span class="line">service/kube-dns               ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   12m</span><br><span class="line"></span><br><span class="line">deployment.extensions/coredns                2/2     2            2           12m</span><br></pre></td></tr></table></figure></li></ul><h3 id="éƒ¨ç½²-DNS-è‡ªåŠ¨æ‰©å®¹"><a href="#éƒ¨ç½²-DNS-è‡ªåŠ¨æ‰©å®¹" class="headerlink" title="éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹"></a>éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å¤§è§„æ¨¡é›†ç¾¤çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦é›†ç¾¤ DNS è‡ªåŠ¨æ‰©å®¹ï¼Œå…·ä½“æ–‡æ¡£è¯·å‚è€ƒ DNS Horizontal Autoscalerï¼ŒDNS æ‰©å®¹ç®—æ³•å¯å‚è€ƒ Githubï¼Œå¦‚æœ‰éœ€è¦è¯·è‡ªè¡Œä¿®æ”¹ï¼›ä»¥ä¸‹ä¸ºå…·ä½“é…ç½®</p><ul><li><p>dns-horizontal-autoscaler.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kind: ServiceAccount</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns-autoscaler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"nodes"</span>]</span><br><span class="line">    verbs: [<span class="string">"list"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"replicationcontrollers/scale"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"deployments/scale"</span>, <span class="string">"replicasets/scale"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>]</span><br><span class="line"><span class="comment"># Remove the configmaps rule once below issue is fixed:</span></span><br><span class="line"><span class="comment"># kubernetes-incubator/cluster-proportional-autoscaler#16</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"configmaps"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>]</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kube-dns-autoscaler</span><br><span class="line">    namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns-autoscaler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns-autoscaler</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns-autoscaler</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns-autoscaler</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: autoscaler</span><br><span class="line">        image: gcr.azk8s.cn/google_containers/cluster-proportional-autoscaler-amd64:1.1.2-r2</span><br><span class="line">        resources:</span><br><span class="line">            requests:</span><br><span class="line">                cpu: <span class="string">"20m"</span></span><br><span class="line">                memory: <span class="string">"10Mi"</span></span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">          - /cluster-proportional-autoscaler</span><br><span class="line">          - --namespace=kube-system</span><br><span class="line">          - --configmap=kube-dns-autoscaler</span><br><span class="line">          <span class="comment"># Should keep target in sync with cluster/addons/dns/kube-dns.yaml.base</span></span><br><span class="line">          - --target=Deployment/coredns</span><br><span class="line">          <span class="comment"># When cluster is using large nodes(with more cores), "coresPerReplica" should dominate.</span></span><br><span class="line">          <span class="comment"># If using small nodes, "nodesPerReplica" should dominate.</span></span><br><span class="line">          - --default-params=&#123;<span class="string">"linear"</span>:&#123;<span class="string">"coresPerReplica"</span>:256,<span class="string">"nodesPerReplica"</span>:16,<span class="string">"preventSinglePointFailure"</span>:<span class="literal">true</span>&#125;&#125;</span><br><span class="line">          - --logtostderr=<span class="literal">true</span></span><br><span class="line">          - --v=2</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line">        operator: <span class="string">"Exists"</span></span><br><span class="line">      serviceAccountName: kube-dns-autoscaler</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f dns-horizontal-autoscaler.yaml </span></span><br><span class="line">serviceaccount/kube-dns-autoscaler created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:kube-dns-autoscaler created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:kube-dns-autoscaler created</span><br><span class="line">deployment.apps/kube-dns-autoscaler created</span><br></pre></td></tr></table></figure></li></ul><p>æ‰§è¡Œåˆ›å»ºä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°pod åˆ›å»ºäº†ä¸¤ä¸ªdns</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system|grep coredns</span></span><br><span class="line">coredns-68676b6b88-pw9c2                1/1     Running   0          7m18s</span><br><span class="line">coredns-68676b6b88-tgbbv                1/1     Running   0          100m</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²mysql</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2mysql/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;åç«¯å­˜å‚¨åˆ©ç”¨nfsæ¥è¿›è¡Œå­˜å‚¨æ•°æ®ï¼Œnfså®‰è£…ä¸é˜è¿°ï¼Œéœ€è¦æ³¨æ„æ³¨æ„çš„æ˜¯åœ¨åˆ›å»ºmysql çš„å…±äº«ç›®å½•çš„æ—¶å€™å‚æ•°è®¾å®š<code>/data/mysql *(rw,sync,no_root_squash,no_subtree_check)</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl  restart nfs.service</span><br><span class="line">$ sudo exportfs -arv</span><br></pre></td></tr></table></figure><h3 id="1ã€åˆ›å»ºmysqlå­˜å‚¨"><a href="#1ã€åˆ›å»ºmysqlå­˜å‚¨" class="headerlink" title="1ã€åˆ›å»ºmysqlå­˜å‚¨"></a>1ã€åˆ›å»ºmysqlå­˜å‚¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-pvc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc001</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  nfs:</span><br><span class="line">    server: 172.21.16.240</span><br><span class="line">    path: /data/mysql</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pvc</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 10Gi</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2ã€éƒ¨ç½²mysql"><a href="#2ã€éƒ¨ç½²mysql" class="headerlink" title="2ã€éƒ¨ç½²mysql"></a>2ã€éƒ¨ç½²mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-deploy.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-deploy</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: mysql-ops</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        name: mysql-ops</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: mysql</span><br><span class="line">          image: mysql:8.0.12</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          env:</span><br><span class="line">          - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">            value: <span class="string">"noc-mysql"</span></span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 3306</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: mysql-persistent-storage</span><br><span class="line">              mountPath: <span class="string">"/var/lib/mysql"</span></span><br><span class="line">      volumes:</span><br><span class="line">        - name: mysql-persistent-storage</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">            claimName: mysql-pvc</span><br></pre></td></tr></table></figure><h3 id="3ã€è®¾ç½®ç«¯å£æ˜ å°„"><a href="#3ã€è®¾ç½®ç«¯å£æ˜ å°„" class="headerlink" title="3ã€è®¾ç½®ç«¯å£æ˜ å°„"></a>3ã€è®¾ç½®ç«¯å£æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-svc</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  labels: </span><br><span class="line">    name: mysql-svc</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3306</span><br><span class="line">    name: http</span><br><span class="line">    nodePort: 30003</span><br><span class="line">  selector:</span><br><span class="line">    name: mysql-ops</span><br></pre></td></tr></table></figure><h3 id="4ã€æŸ¥çœ‹podéƒ¨ç½²"><a href="#4ã€æŸ¥çœ‹podéƒ¨ç½²" class="headerlink" title="4ã€æŸ¥çœ‹podéƒ¨ç½²"></a>4ã€æŸ¥çœ‹podéƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/8364iqhkdaskda.png" alt="img"></p><h3 id="5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹"><a href="#5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹" class="headerlink" title="5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹"></a>5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/42joud02jef24.png" alt="img"></p><h3 id="6ã€è¿›å…¥mysqlå®¹å™¨"><a href="#6ã€è¿›å…¥mysqlå®¹å™¨" class="headerlink" title="6ã€è¿›å…¥mysqlå®¹å™¨"></a>6ã€è¿›å…¥mysqlå®¹å™¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker ps -a</span><br><span class="line">$ sudo docker <span class="built_in">exec</span> -it ded7f2990db5 /bin/bash</span><br><span class="line">root@mysql-deploy-6dc5d9786b-lgkxk:/<span class="comment"># mysql -h127.0.0.1 -uroot -pnoc-mysql</span></span><br></pre></td></tr></table></figure><h4 id="6-1ã€è®¾ç½®mysql"><a href="#6-1ã€è®¾ç½®mysql" class="headerlink" title="6.1ã€è®¾ç½®mysql"></a>6.1ã€è®¾ç½®mysql</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter user <span class="string">'root'</span>@<span class="string">'%'</span> identified with mysql_native_password by<span class="string">'root'</span>;</span><br><span class="line">mysql&gt; alter  user <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'mysql'</span>;</span><br><span class="line">mysql&gt; alter  user <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'noc-mysql'</span>;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é€€å‡ºmysqlå’Œå®¹å™¨ï¼Œæ‰§è¡Œquit;é€€å‡ºmysqlï¼ŒæŒ‰ctrl+p+qä»å®¹å™¨ä¸­è¿”å›nodeä¸»æœºã€‚åˆ©ç”¨navicat é€šè¿‡nodeä¸»æœºçš„ipåœ°å€å’Œç«¯å£30003è¿æ¥mysqlæ•°æ®åº“<br><img src="https://img.xxlaila.cn/2348wndssmadklj3.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sè§’è‰²è®¿é—®RBAC</title>
    <url>/2019/08/24/k8s%E8%A7%92%E8%89%B2%E8%AE%BF%E9%97%AERBAC/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="1ã€rbacä»‹ç»"><a href="#1ã€rbacä»‹ç»" class="headerlink" title="1ã€rbacä»‹ç»"></a>1ã€rbacä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesä¸­çš„ä¸¤ä¸ªç”¨äºé…ç½®ä¿¡æ¯çš„é‡è¦èµ„æºå¯¹è±¡ï¼šConfigMapå’ŒSecretï¼Œå…¶å®åˆ°è¿™é‡Œæˆ‘ä»¬åŸºæœ¬ä¸Šå­¦ä¹ çš„å†…å®¹å·²ç»è¦†ç›–åˆ°Kubernetesä¸­ä¸€äº›é‡è¦çš„èµ„æºå¯¹è±¡äº†ï¼Œæ¥éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åºæ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„äº†ã€‚åœ¨æˆ‘ä»¬æ¼”ç¤ºä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»™å¤§å®¶è®²è§£ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼šRBAC - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;RBACä½¿ç”¨rbac.authorization.k8s.io API Group æ¥å®ç°æˆæƒå†³ç­–ï¼Œå…è®¸ç®¡ç†å‘˜é€šè¿‡ Kubernetes API åŠ¨æ€é…ç½®ç­–ç•¥ï¼Œè¦å¯ç”¨RBACï¼Œéœ€è¦åœ¨ apiserver ä¸­æ·»åŠ å‚æ•°â€“authorization-mode=RBACï¼Œå¦‚æœä½¿ç”¨çš„kubeadmå®‰è£…çš„é›†ç¾¤ï¼Œ1.6 ç‰ˆæœ¬ä»¥ä¸Šçš„éƒ½é»˜è®¤å¼€å¯äº†RBACï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ Master èŠ‚ç‚¹ä¸Š apiserver çš„é™æ€Podå®šä¹‰æ–‡ä»¶ï¼š</p><h3 id="2ã€-kubernetes-å…³äºç©ºé—´æƒé™èµ‹äºˆ"><a href="#2ã€-kubernetes-å…³äºç©ºé—´æƒé™èµ‹äºˆ" class="headerlink" title="2ã€ kubernetes å…³äºç©ºé—´æƒé™èµ‹äºˆ"></a>2ã€ kubernetes å…³äºç©ºé—´æƒé™èµ‹äºˆ</h3><h4 id="1ã€è·å–å¹¶æŸ¥çœ‹"><a href="#1ã€è·å–å¹¶æŸ¥çœ‹" class="headerlink" title="1ã€è·å–å¹¶æŸ¥çœ‹"></a>1ã€è·å–å¹¶æŸ¥çœ‹</h4><ul><li>Role</li><li>ClusterRole</li><li>RoleBinding</li><li>ClusterRoleBinding</li></ul><a id="more"></a><ul><li><p>1.1ã€æŸ¥çœ‹kube-system namespaceä¸‹çš„æ‰€æœ‰role</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get role -n kube-system</span><br></pre></td></tr></table></figure></li><li><p>1.2ã€æŸ¥çœ‹æŸä¸ªroleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get role &lt;role-name&gt; -n kube-system -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.3ã€æŸ¥çœ‹kube-system namespaceä¸‹æ‰€æœ‰çš„rolebinding</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get rolebinding -n kube-system</span><br></pre></td></tr></table></figure></li><li><p>1.4ã€æŸ¥çœ‹kube-system namespaceä¸‹çš„æŸä¸ªrolebindingè¯¦ç»†ä¿¡æ¯ï¼ˆç»‘å®šçš„Roleå’Œsubjectï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get rolebinding &lt;rolebind-name&gt; -n kube-system -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.5ã€æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰çš„clusterrole</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole</span><br></pre></td></tr></table></figure></li><li><p>1.6ã€æŸ¥çœ‹æŸä¸ªclusterroleå®šä¹‰çš„èµ„æºæƒé™è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole &lt;clusterrole-name&gt; -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.7ã€æŸ¥çœ‹æ‰€æœ‰çš„clusterrolebinding</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrolebinding</span><br></pre></td></tr></table></figure></li><li><p>1.8ã€æŸ¥çœ‹æŸä¸€clusterrolebindingçš„è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrolebinding &lt;clusterrolebinding-name&gt; -o yaml</span><br></pre></td></tr></table></figure></li></ul><h4 id="2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚"><a href="#2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚" class="headerlink" title="2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚"></a>2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚</h4><ul><li><p>åœ¨æŸä¸€ç‰¹å®šåå­—ç©ºé—´å†…æˆäºˆRoleæˆ–è€…ClusterRoleã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding</span><br></pre></td></tr></table></figure></li><li><p>åœ¨åä¸ºâ€acmeâ€çš„åå­—ç©ºé—´ä¸­å°†admin ClusterRoleæˆäºˆç”¨æˆ·â€bobâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding bob-admin-binding --clusterrole=admin --user=bob --namespace=acme</span><br></pre></td></tr></table></figure></li><li><p>åœ¨åä¸ºâ€acmeâ€çš„åå­—ç©ºé—´ä¸­å°†view ClusterRoleæˆäºˆæœåŠ¡è´¦æˆ·â€myappâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding myapp-view-binding --clusterrole=view --serviceaccount=acme:myapp --namespace=acme</span><br><span class="line">kubectl create clusterrolebinding</span><br></pre></td></tr></table></figure></li></ul><h4 id="3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š"><a href="#3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š" class="headerlink" title="3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š"></a>3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</h4><ul><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†cluster-admin ClusterRoleæˆäºˆç”¨æˆ·â€rootâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding root-cluster-admin-binding --clusterrole=cluster-admin --user=root</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†system:node ClusterRoleæˆäºˆç”¨æˆ·â€kubeletâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-node-binding --clusterrole=system:node --user=kubelet</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†view ClusterRoleæˆäºˆåå­—ç©ºé—´â€acmeâ€å†…çš„æœåŠ¡è´¦æˆ·â€myappâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding myapp-view-binding --clusterrole=view --serviceaccount=acme:myapp</span><br></pre></td></tr></table></figure></li></ul><h4 id="4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™"><a href="#4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™" class="headerlink" title="4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™"></a>4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™</h4><ul><li><p>æŸ¥çœ‹kube-ops ä¸‹é¢çš„è§’è‰²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role -n kube-ops</span></span><br><span class="line">NAME       AGE</span><br><span class="line">jenkins2   2d6h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹roleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role jenkins2 -n kube-ops -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2019-01-14T03:07:25Z"</span></span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  resourceVersion: <span class="string">"2389179"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/kube-ops/roles/jenkins2</span><br><span class="line">  uid: 84762132-17a9-11e9-8991-fa163e14c5bd</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">exec</span></span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">log</span></span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºjenkins2çš„æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test-3 ~]<span class="comment"># kubectl -n kube-system create sa jenkins2</span></span><br><span class="line">serviceaccount/jenkins2 created</span><br></pre></td></tr></table></figure></li><li><p>æˆæƒè®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test-3 ~]<span class="comment"># kubectl create clusterrolebinding jenkins2 --clusterrole cluster-admin --serviceaccount=kube-ops:jenkins2</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/jenkins2 created</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>RBAC</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s heapster</title>
    <url>/2019/08/24/k8s-heapster/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="1ã€heapster-ä»‹ç»"><a href="#1ã€heapster-ä»‹ç»" class="headerlink" title="1ã€heapster ä»‹ç»"></a>1ã€heapster ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Heapsteræ˜¯å®¹å™¨é›†ç¾¤ç›‘æ§å’Œæ€§èƒ½åˆ†æå·¥å…·,æ”¯æŒKuberneteså’ŒCoreOSã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesæœ‰ä¸ªç›‘æ§agentâ€”cAdvisorã€‚åœ¨æ¯ä¸ªkubernetes Nodeä¸Šéƒ½ä¼šè¿è¡ŒcAdvisor,å®ƒä¼šæ”¶é›†æœ¬æœºä»¥åŠå®¹å™¨çš„ç›‘æ§æ•°æ®(cpu,memory,filesystem,network,uptime)ã€‚åœ¨è¾ƒæ–°çš„ç‰ˆæœ¬ä¸­ï¼ŒK8Så·²ç»å°†cAdvisoråŠŸèƒ½é›†æˆåˆ°kubeletç»„ä»¶ä¸­ã€‚æ¯ä¸ªNodeèŠ‚ç‚¹å¯ä»¥ç›´æ¥è¿›è¡Œwebè®¿é—®ã€‚</p><h3 id="2ã€heapster-å®‰è£…"><a href="#2ã€heapster-å®‰è£…" class="headerlink" title="2ã€heapster å®‰è£…"></a>2ã€heapster å®‰è£…</h3><p>ä¸‹è½½heapsterçš„<a href="https://github.com/kubernetes-retired/heapster/tree/master/deploy/kube-config" target="_blank" rel="noopener">yamlæ–‡ä»¶</a>ï¼Œä¸‹è½½å®Œæˆåæˆ‘ä»¬éœ€è¦å¯¹æ–‡ä»¶ä¿®æ”¹ï¼Œä»¥æ»¡è¶³æˆ‘ä»¬çš„çš„éœ€æ±‚.</p><h4 id="2-1ã€grafanaä¿®æ”¹"><a href="#2-1ã€grafanaä¿®æ”¹" class="headerlink" title="2.1ã€grafanaä¿®æ”¹"></a>2.1ã€grafanaä¿®æ”¹</h4><p>grafanaæ·»åŠ nodePort: 30003è®©grafanaæ”¯æŒå¤–éƒ¨è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç«¯å£è¿›è¡Œä½†å•ç‹¬çš„é¡µé¢é…ç½®ã€‚</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: k8s.gcr.io/heapster-grafana-amd64:v5.0.4</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/certs</span><br><span class="line">          name: ca-certificates</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">        - mountPath: /var</span><br><span class="line">          name: grafana-storage</span><br><span class="line">        env:</span><br><span class="line">        - name: INFLUXDB_HOST</span><br><span class="line">          value: monitoring-influxdb</span><br><span class="line">        - name: GF_SERVER_HTTP_PORT</span><br><span class="line">          value: <span class="string">"3000"</span></span><br><span class="line">          <span class="comment"># The following env variables are required to make Grafana accessible via</span></span><br><span class="line">          <span class="comment"># the kubernetes api-server proxy. On production clusters, we recommend</span></span><br><span class="line">          <span class="comment"># removing these env variables, setup auth for grafana, and expose the grafana</span></span><br><span class="line">          <span class="comment"># service using a LoadBalancer or a public IP.</span></span><br><span class="line">        - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">          value: <span class="string">"false"</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class="line">          value: Admin</span><br><span class="line">        - name: GF_SERVER_ROOT_URL</span><br><span class="line">          <span class="comment"># If you're only using the API Server proxy, set this value instead:</span></span><br><span class="line">          <span class="comment"># value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span></span><br><span class="line">          value: /</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ca-certificates</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/ssl/certs</span><br><span class="line">      - name: grafana-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></span><br><span class="line">    kubernetes.io/name: monitoring-grafana</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># In a production setup, we recommend accessing Grafana through an external Loadbalancer</span></span><br><span class="line">  <span class="comment"># or through a public IP.</span></span><br><span class="line">  <span class="comment"># type: LoadBalancer</span></span><br><span class="line">  <span class="comment"># You could also use NodePort to expose the service at a randomly-generated port</span></span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 3000</span><br><span class="line">    nodePort: 30003</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: grafana</span><br></pre></td></tr></table></figure><h4 id="2-2ã€heapsteræ–‡ä»¶ä¿®æ”¹"><a href="#2-2ã€heapsteræ–‡ä»¶ä¿®æ”¹" class="headerlink" title="2.2ã€heapsteræ–‡ä»¶ä¿®æ”¹"></a>2.2ã€heapsteræ–‡ä»¶ä¿®æ”¹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- --<span class="built_in">source</span>=kubernetes:https://kubernetes.default?useServiceAccount=<span class="literal">true</span>&amp;kubeletHttps=<span class="literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="literal">true</span></span><br><span class="line">è¿æ¥k8s apiçš„åœ°å€ï¼Œé»˜è®¤æ˜¯kubernetes.defaultï¼Œåé¢ä¸€æ®µåŠ å…¥ç”¨æˆ·è®¤è¯ï¼Œç«¯å£ï¼Œä»¥åŠhttps;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</span><br><span class="line">æŒ‡å®š influxdbæ•°æ®åº“çš„åœ°å€ï¼Œè¿™ä¸ªåœ¨infuxdbæ–‡ä»¶é‡Œé¢æœ‰è¿™ä¸ªåŸŸå</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: heapster</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: k8s.gcr.io/heapster-amd64:v1.5.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - /heapster</span><br><span class="line">        - --<span class="built_in">source</span>=kubernetes:https://kubernetes.default?useServiceAccount=<span class="literal">true</span>&amp;kubeletHttps=<span class="literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="literal">true</span></span><br><span class="line">        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></span><br><span class="line">    kubernetes.io/name: Heapster</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: heapster</span><br></pre></td></tr></table></figure><h3 id="3ã€æ‰§è¡Œåˆ›å»ºheapster"><a href="#3ã€æ‰§è¡Œåˆ›å»ºheapster" class="headerlink" title="3ã€æ‰§è¡Œåˆ›å»ºheapster"></a>3ã€æ‰§è¡Œåˆ›å»ºheapster</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubect create -f ./</span></span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œåˆ›å»ºå®Œæˆåï¼Œç­‰å¾…ä¸€ä¼šæ˜¾ç¤ºå›¾åƒ<br><img src="https://img.xxlaila.cn/459348skndiy923s.png" alt="img"><br><img src="https://img.xxlaila.cn/34293knsdalsk0329.png" alt="img"></p><h4 id="3-1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸"><a href="#3-1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸" class="headerlink" title="3.1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸"></a>3.1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸</h4><p>å‰é¢åœ¨grafanaæ–‡ä»¶é‡Œé¢å¢åŠ äº†nodePoer: 30003çš„ç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»æ„èŠ‚ç‚¹ip:30003è¿›è¡Œè®¿é—®grafanaç•Œé¢ã€‚</p><p><img src="https://img.xxlaila.cn/453847sndkniuy234wds.png" alt="img"><br><strong>å¯ä»¥è¿›è¡Œé…ç½®grafanaã€‚</strong></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>heapster</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²eurekaé›†ç¾¤</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2eureka%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>eureka ä¸é˜è¿°ä»‹ç»ï¼Œè¿™é‡Œç›´æ¥å¼€å§‹åœ¨kubernetesä¸‹éƒ¨ç½²eurekaé›†ç¾¤</p><h3 id="1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ "><a href="#1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ " class="headerlink" title="1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ "></a>1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ </h3><p>eureka åªä¸€ä¸ªæœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œéƒ¨ç½²æœ‰çŠ¶æ€æœåŠ¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨StatefulSet</p><h4 id="1-1ã€å¢åŠ dockerfile"><a href="#1-1ã€å¢åŠ dockerfile" class="headerlink" title="1.1ã€å¢åŠ dockerfile"></a>1.1ã€å¢åŠ dockerfile</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat Dockerfile</span><br><span class="line">FROM docker.io/xxlaila/centos7.6-jdk1.8:latest</span><br><span class="line">MAINTAINER xxlaila <span class="string">"cq_xxlaila@163.com"</span></span><br><span class="line"><span class="comment"># Install dependent plugin</span></span><br><span class="line"></span><br><span class="line">ADD target/kxl-eureka.jar /opt/webapps/kxl-eureka.jar</span><br><span class="line">ADD application.yaml /opt/webapps/application.yaml</span><br><span class="line"></span><br><span class="line">WORKDIR /opt/webapps</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"-Dspring.profiles.active=dev"</span>, <span class="string">"kxl-eureka.jar"</span>]</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#1-2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="1.2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>1.2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><p>åœ¨åšeurekaé›†ç¾¤çš„æ—¶å€™ï¼Œapplication.yamlçš„é…ç½®æ–‡ä»¶å¾ˆé‡è¦ï¼Œé…ç½®æ–‡ä»¶åšä¸å¥½ï¼Œå°†ä¼šç›´æ¥å½±å“åˆ°eurekaçš„å¯åŠ¨ï¼Œè¿˜æœ‰é›†ç¾¤çš„æ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat application.yaml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: kxl-eureka</span><br><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line"><span class="comment">#    prefer-ip-address: true</span></span><br><span class="line">    hostname: <span class="variable">$&#123;EUREKA_HOST_NAME:peer1&#125;</span> <span class="comment">#æœåŠ¡ä¸»æœºå</span></span><br><span class="line">    appname: <span class="variable">$&#123;spring.application.name&#125;</span>  <span class="comment">#æœåŠ¡åç§°ï¼Œé»˜è®¤ä¸º unknow è¿™é‡Œç›´æ¥å– spring.application.name äº†</span></span><br><span class="line">    <span class="comment"># server ä»æœ€åä¸€æ¬¡æ”¶åˆ°å¿ƒè·³åˆ°ç§»é™¤åºŸå¼ƒæœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    lease-expiration-duration-in-seconds: 90</span><br><span class="line">    <span class="comment"># client ç»™ server å‘é€å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæ¯” lease-expiration-duration-in-seconds å°</span></span><br><span class="line">    lease-renewal-interval-in-seconds: 30</span><br><span class="line"></span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: <span class="variable">$&#123;EUREKA_URL_LIST:http://peer1:8761/eureka/&#125;</span> <span class="comment"># æŒ‡å®šæœåŠ¡ä¸­å¿ƒ eureka serverçš„åœ°å€</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦ä»eurekaä¸Šæ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    fetch-registry: <span class="variable">$&#123;BOOL_FETCH:true&#125;</span>   <span class="comment"># æ˜¯å¦æ‹‰å– eureka server çš„æ³¨å†Œä¿¡æ¯ã€‚ é»˜è®¤ä¸ºtrue</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦æ³¨å†Œåˆ°eurekaä¸Šï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    register-with-eureka: <span class="variable">$&#123;BOOL_REGISTER:true&#125;</span>  <span class="comment"># æ˜¯å¦æŠŠæœåŠ¡ä¸­å¿ƒæœ¬èº«å½“åšeureka client æ³¨å†Œã€‚é»˜è®¤ä¸ºtrue</span></span><br><span class="line">    <span class="comment"># client é—´éš”å¤šä¹…å»æ‹‰å»æœåŠ¡ä¿¡æ¯(ç§’)</span></span><br><span class="line">    registry-fetch-interval-seconds: 30</span><br><span class="line">  server:</span><br><span class="line">    <span class="comment"># è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåº”å¯¹ç½‘ç»œé—ªæ–­æƒ…å†µï¼Œå¤§é¢ç§¯ä¸¢å¤±è¿‡å¤šçš„clientï¼Œä¸åˆ é™¤æœåŠ¡</span></span><br><span class="line">    <span class="built_in">enable</span>-self-preservation: <span class="variable">$&#123;SELF_PRESERVATION:true&#125;</span>     <span class="comment"># æ˜¯å¦å¼€å¯è‡ªæˆ‘ä¿æŠ¤ã€‚ é»˜è®¤ä¸º true.</span></span><br><span class="line">    <span class="comment"># æ¯åˆ†é’Ÿå¿ƒè·³æ•° å®é™…/æœŸæœ›ï¼Œå¦‚æœå°äºé˜ˆå€¼(threshold)ï¼Œåˆ™è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</span></span><br><span class="line">    renewal-percent-threshold: 0.85</span><br><span class="line">    <span class="comment"># æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">    eviction-interval-timer-in-ms: 60000</span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: <span class="variable">$&#123;EUREKA_APPLICATION_NAME:eureka-server&#125;</span></span><br></pre></td></tr></table></figure><h4 id="1-3ã€åˆ›å»º-eureka-dockeré•œåƒ"><a href="#1-3ã€åˆ›å»º-eureka-dockeré•œåƒ" class="headerlink" title="1.3ã€åˆ›å»º eureka dockeré•œåƒ"></a>1.3ã€åˆ›å»º eureka dockeré•œåƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t xxlaila/kxl-eureka:v1 .</span><br><span class="line">$ docker push xxlaila/kxl-eureka:v1</span><br></pre></td></tr></table></figure><h3 id="2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤"><a href="#2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤" class="headerlink" title="2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤"></a>2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤</h3><h4 id="2-1ã€åˆ›å»ºeurekaé›†ç¾¤"><a href="#2-1ã€åˆ›å»ºeurekaé›†ç¾¤" class="headerlink" title="2.1ã€åˆ›å»ºeurekaé›†ç¾¤"></a>2.1ã€åˆ›å»ºeurekaé›†ç¾¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat kxl-eureka.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  labels:</span><br><span class="line">    app: eureka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8761</span><br><span class="line">    name: eureka</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"eureka"</span></span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: eureka</span><br><span class="line">        image:  docker.io/xxlaila/kxl-eureka:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8761</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">          <span class="comment"># Due to camelcase issues with "defaultZone" and "preferIpAddress", _JAVA_OPTIONS is used here</span></span><br><span class="line">        - name: eureka_client_serviceUrl_defaultZone</span><br><span class="line">          <span class="comment">#value: http://eureka-0.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/,http://eureka-1.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/</span></span><br><span class="line">          value: http://eureka-0.eureka:8761/eureka/,http://eureka-1.eureka:8761/eureka/,http://eureka-2.eureka:8761/eureka/</span><br><span class="line">        - name: EUREKA_CLIENT_REGISTERWITHEUREKA</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: EUREKA_CLIENT_FETCHREGISTRY</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">          <span class="comment"># In the docker image, this is set to localhost. Otherwise, we could leave this empty.</span></span><br><span class="line">          <span class="comment"># The hostnames must match with the the eureka serviceUrls, otherwise the replicas are reported as unavailable in the eureka dashboard</span></span><br><span class="line">        - name: EUREKA_INSTANCE_HOSTNAME</span><br><span class="line">          <span class="comment">#value: "$(MY_POD_NAME).eureka.&lt;namespace.svc.cluster.local"</span></span><br><span class="line">          value: <span class="string">"<span class="variable">$(MY_POD_NAME)</span>.eureka"</span></span><br><span class="line">          <span class="comment">#value: eureka</span></span><br><span class="line">          <span class="comment"># For the other (stateless) services, this should probably be set to true, since their pods have no DNS-resolvable  hostnames</span></span><br><span class="line">       <span class="comment">#- name: EUREKA_INSTANCE_PREFERIPADDRESS</span></span><br><span class="line">       <span class="comment">#  value: "false"</span></span><br><span class="line">  <span class="comment"># No need to start the pods in order. We just need the stable network identity</span></span><br><span class="line">  podManagementPolicy: <span class="string">"Parallel"</span></span><br></pre></td></tr></table></figure><p>åœ¨åšè¿™ä¸ªçš„æ—¶å€™å…¶å®é‡åˆ°äº†å¾ˆå¤šå‘ï¼Œä¹Ÿæ˜¯å‚è€ƒä¸€äº›æ–‡ç« æ‰å®Œæˆçš„,<a href="https://github.com/kingschan1204/blog/issues/5" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><h4 id="2-2ã€åˆ›å»ºeureka-Ingress"><a href="#2-2ã€åˆ›å»ºeureka-Ingress" class="headerlink" title="2.2ã€åˆ›å»ºeureka Ingress"></a>2.2ã€åˆ›å»ºeureka Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat eureka-ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka-ingress</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/secure-backends: <span class="string">"true"</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: eureka.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: eureka</span><br><span class="line">          servicePort: 8761</span><br></pre></td></tr></table></figure><h4 id="2-3ã€æ‰§è¡Œåˆ›å»º"><a href="#2-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="2.3ã€æ‰§è¡Œåˆ›å»º"></a>2.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f .</span><br><span class="line">$ kubectl get pods -n kube-dev</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">eureka-0   1/1     Running   0          21m</span><br><span class="line">eureka-1   1/1     Running   0          21m</span><br><span class="line">eureka-2   1/1     Running   0          21m</span><br><span class="line">$ kubectl get pods,svc,rs -n kube-dev</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/eureka-0   1/1     Running   0          21m</span><br><span class="line">pod/eureka-1   1/1     Running   0          21m</span><br><span class="line">pod/eureka-2   1/1     Running   0          21m</span><br><span class="line"></span><br><span class="line">NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/eureka   ClusterIP   None         &lt;none&gt;        8761/TCP   21m</span><br></pre></td></tr></table></figure><h4 id="2-4ã€è®¿é—®éªŒè¯"><a href="#2-4ã€è®¿é—®éªŒè¯" class="headerlink" title="2.4ã€è®¿é—®éªŒè¯"></a>2.4ã€è®¿é—®éªŒè¯</h4><p><img src="https://img.xxlaila.cn/34239uskdnksjda.png" alt="img"><br>é€šè¿‡åŸŸåè®¿é—®ï¼š<br><img src="https://img.xxlaila.cn/89745jkndklsajkdhsajkbfa.png" alt="img"></p><h3 id="3ã€eureka-ç¯å¢ƒ"><a href="#3ã€eureka-ç¯å¢ƒ" class="headerlink" title="3ã€eureka ç¯å¢ƒ"></a>3ã€eureka ç¯å¢ƒ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ ¹æ®2.4å°èŠ‚å¯ä»¥çœ‹åˆ°ï¼Œenviroonmentä¸ºtestï¼Œæˆ‘ä»¬åœ¨dockerfileæŒ‡å®šçš„ä¸ºdevï¼Œæ‰€ä»¥è¿™é‡Œå°±æœ‰ç‚¹å·®æ± ï¼Œä½†æ˜¯æŸ¥çœ‹äº†ä¸€ä¸‹èµ„æ–™ï¼Œè¿™ä¸ªè¦ä¹ˆå°±å†™å¤šä¸ªapplication.yamlçš„é…ç½®æ–‡ä»¶ï¼Œè¦ä¹ˆå°±æ‰“å¤šä¸ªåŒ…ï¼Œè¿™æ ·å°±æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”è€ƒè™‘åˆ°å…¬å¸å¾®æœåŠ¡çš„ç‰¹æ®Šæ€§ï¼Œæ—¢è¦æ»¡è¶³äºå…¬å¸çš„å¾®æœåŠ¡æ¶æ„ï¼Œæœ‰è¦è€ƒè™‘çš„æ¨¡ç‰ˆçš„é€šç”¨æ€§ï¼Œè¿˜éœ€è¦è€ƒè™‘è¿ç»´ç»´æŠ¤çš„ä¾¿æ·æ€§ã€‚ä¸‹é¢ä¸€èµ·æ¥çœ‹çœ‹åŸºäºå…¬å¸çš„å®šåˆ¶åŒ–æ¥æ”¹å˜è¿™ä¸ªå±€é™æ€§ã€‚</p><h4 id="3-1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡"><a href="#3-1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡" class="headerlink" title="3.1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡"></a>3.1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CONFIG_API_SERVER=http://api.conf.xxlaila.io</span><br><span class="line">RUN_CLUSTER=default</span><br><span class="line">RUN_MODE=AUTO</span><br><span class="line">RUN_ENV=demo</span><br><span class="line">CONFIG_API_SERVERï¼šå…¬å¸é…ç½®ä¸­å¿ƒapiçš„åœ°å€ï¼Œappæ‹‰å–é…ç½®ä¸­å¿ƒçš„é…ç½®</span><br><span class="line">RUN_CLUSTERï¼šé»˜è®¤é›†ç¾¤ï¼Œåšç°åº¦å‘å¸ƒä½¿ç”¨</span><br><span class="line">RUN_MODEï¼š</span><br><span class="line">RUN_ENVï¼šå½“å‰ç³»ç»Ÿæ‰€è¿è¡Œçš„ç¯å¢ƒ</span><br></pre></td></tr></table></figure><h4 id="3-2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶"><a href="#3-2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶" class="headerlink" title="3.2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶"></a>3.2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶</h4><p>å¢åŠ é…ç½®eureka:<code>environment: ${RUN_ENV}</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat application.yaml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: kxl-eureka</span><br><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  environment: <span class="variable">$&#123;RUN_ENV&#125;</span></span><br><span class="line">  instance:</span><br><span class="line"><span class="comment">#    prefer-ip-address: true</span></span><br><span class="line">    hostname: <span class="variable">$&#123;EUREKA_HOST_NAME:peer1&#125;</span></span><br><span class="line">    appname: <span class="variable">$&#123;spring.application.name&#125;</span></span><br><span class="line">    <span class="comment"># server ä»æœ€åä¸€æ¬¡æ”¶åˆ°å¿ƒè·³åˆ°ç§»é™¤åºŸå¼ƒæœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    lease-expiration-duration-in-seconds: 90</span><br><span class="line">    <span class="comment"># client ç»™ server å‘é€å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæ¯” lease-expiration-duration-in-seconds å°</span></span><br><span class="line">    lease-renewal-interval-in-seconds: 30</span><br><span class="line"></span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: <span class="variable">$&#123;EUREKA_URL_LIST:http://peer1:8761/eureka/&#125;</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦ä»eurekaä¸Šæ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    fetch-registry: <span class="variable">$&#123;BOOL_FETCH:true&#125;</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦æ³¨å†Œåˆ°eurekaä¸Šï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    register-with-eureka: <span class="variable">$&#123;BOOL_REGISTER:true&#125;</span></span><br><span class="line">    <span class="comment"># client é—´éš”å¤šä¹…å»æ‹‰å»æœåŠ¡ä¿¡æ¯(ç§’)</span></span><br><span class="line">    registry-fetch-interval-seconds: 30</span><br><span class="line">  server:</span><br><span class="line">    <span class="comment"># è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåº”å¯¹ç½‘ç»œé—ªæ–­æƒ…å†µï¼Œå¤§é¢ç§¯ä¸¢å¤±è¿‡å¤šçš„clientï¼Œä¸åˆ é™¤æœåŠ¡</span></span><br><span class="line">    <span class="built_in">enable</span>-self-preservation: <span class="variable">$&#123;SELF_PRESERVATION:true&#125;</span></span><br><span class="line">    <span class="comment"># æ¯åˆ†é’Ÿå¿ƒè·³æ•° å®é™…/æœŸæœ›ï¼Œå¦‚æœå°äºé˜ˆå€¼(threshold)ï¼Œåˆ™è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</span></span><br><span class="line">    renewal-percent-threshold: 0.85</span><br><span class="line">    <span class="comment"># æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">    eviction-interval-timer-in-ms: 60000</span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: <span class="variable">$&#123;EUREKA_APPLICATION_NAME:eureka-server&#125;</span></span><br></pre></td></tr></table></figure><h4 id="3-3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶"><a href="#3-3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶" class="headerlink" title="3.3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶"></a>3.3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat kxl-eureka.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  labels:</span><br><span class="line">    app: eureka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8761</span><br><span class="line">    name: eureka</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"eureka"</span></span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: eureka</span><br><span class="line">        image:  docker.io/xxlaila/kxl-eureka:v2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8761</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">          <span class="comment"># Due to camelcase issues with "defaultZone" and "preferIpAddress", _JAVA_OPTIONS is used here</span></span><br><span class="line">        - name: eureka_client_serviceUrl_defaultZone</span><br><span class="line">          <span class="comment">#value: http://eureka-0.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/,http://eureka-1.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/</span></span><br><span class="line">          value: http://eureka-0.eureka:8761/eureka/,http://eureka-1.eureka:8761/eureka/,http://eureka-2.eureka:8761/eureka/</span><br><span class="line">        - name: EUREKA_CLIENT_REGISTERWITHEUREKA</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: EUREKA_CLIENT_FETCHREGISTRY</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">          <span class="comment"># In the docker image, this is set to localhost. Otherwise, we could leave this empty.</span></span><br><span class="line">          <span class="comment"># The hostnames must match with the the eureka serviceUrls, otherwise the replicas are reported as unavailable in the eureka dashboard</span></span><br><span class="line">        - name: EUREKA_INSTANCE_HOSTNAME</span><br><span class="line">          <span class="comment">#value: "$(MY_POD_NAME).eureka.&lt;namespace.svc.cluster.local"</span></span><br><span class="line">          value: <span class="string">"<span class="variable">$(MY_POD_NAME)</span>.eureka"</span></span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: <span class="built_in">test</span></span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.io</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">          <span class="comment">#value: eureka</span></span><br><span class="line">          <span class="comment"># For the other (stateless) services, this should probably be set to true, since their pods have no DNS-resolvable  hostnames</span></span><br><span class="line">       <span class="comment">#- name: EUREKA_INSTANCE_PREFERIPADDRESS</span></span><br><span class="line">       <span class="comment">#  value: "false"</span></span><br><span class="line">  <span class="comment"># No need to start the pods in order. We just need the stable network identity</span></span><br><span class="line">  podManagementPolicy: <span class="string">"Parallel"</span></span><br></pre></td></tr></table></figure><h4 id="3-4ã€é‡å»ºpod"><a href="#3-4ã€é‡å»ºpod" class="headerlink" title="3.4ã€é‡å»ºpod"></a>3.4ã€é‡å»ºpod</h4><p>podé‡å»ºä»¥åæˆ‘ä»¬ç»è¿‡è®¿é—®å¯ä»¥çœ‹åˆ°</p><p><img src="https://img.xxlaila.cn/453khskdha324.png" alt="img"><br><img src="https://img.xxlaila.cn/3746dfnks324.png" alt="img"></p><p><em>åç»­æŒç»­ä¼˜åŒ–</em></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>eureka</tag>
      </tags>
  </entry>
  <entry>
    <title>jiraæ¥å…¥LDAP</title>
    <url>/2019/08/24/jira%E6%8E%A5%E5%85%A5LDAP/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰ä»‹ç»äº†jira å’Œconfluenceçš„è´¦æˆ·ç»“åˆï¼Œjiraå’Œconfluenceå¯ä»¥ä½¿ç”¨ä¸€ä¸ªè´¦æˆ·ï¼Œæœ‰äººå‘˜ç¦»èŒä¹‹åç›´æ¥åœ¨jiraå§ç”¨æˆ·ç¦ç”¨å³å¯ï¼Œä¸€ç«¯æ“ä½œï¼Œæ–¹ä¾¿ä¸¤ç«¯ï¼Œä½†æ˜¯éšç€å…¬å¸äººå‘˜è¶Šæ¥è¶Šå¤šï¼Œè¿™æ ·çš„æ–¹å¼å·²ç»ä¸åœ¨é€‚åˆè¿™ç§äº†ï¼Œæ¥ä¸€ä¸ªç”¨æˆ·å°±éœ€è¦å»åˆ›å»ºï¼Œå¯¹è¿ç»´æ¥è¯´ï¼Œè¿™æ˜¯é‡å¤çš„å·¥ä½œï¼Œæå‡ä¸äº†ä»»ä½•æ•ˆç‡ï¼Œè€Œä¸”æ¯è‰æ— å‘³ã€‚è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ldapï¼Œjiraå’Œconfluenceéƒ½æ˜¯æ”¯æŒldapï¼Œldapçš„å¥½å¤„ï¼Œè¿™é‡Œä¸é˜è¿°ï¼Œä¸‹é¢æ¥çœ‹çœ‹å¦‚ä½•é…ç½®jiraä»‹å…¥ldapã€‚confluenceè¿˜æ˜¯æ¥å…¥jiraï¼Œè¿™æ ·æˆ‘ä»¬å°±åªæ“ä½œladpå’Œjiraï¼Œç®€å•çœäº‹ã€‚</p></blockquote><blockquote><p>é—®é¢˜ç‚¹:<br>&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºåœ¨å»ºç«‹jiraå’Œconfluenceçš„æ—¶å€™è¿˜æ²¡æœ‰ldapï¼Œldapæ˜¯åæœŸæ‰æ¥å…¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±å­˜åœ¨äºæ€ä¹ˆå§ä»¥å‰æœ‰jiraç™»å½•çš„è´¦æˆ·è®¤è¯åˆ‡æ¢åˆ°ldapã€‚è€Œä¸”ä¸å½±å“ä¹‹å‰çš„æ–‡æ¡£ï¼Œä½†æ˜¯ç”¨æˆ·æƒé™ä¼šå½±å“ï¼Œé—®é¢˜ä¸å¤§ï¼Œå¯ä»¥æ·»åŠ ã€‚ä¸‹é¢å¼€å§‹æ“ä½œ</p></blockquote><a id="more"></a><h3 id="1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢"><a href="#1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢" class="headerlink" title="1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢"></a>1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢</h3><p><img src="https://img.xxlaila.cn/image2018-7-12_11-12-55.png" alt="img"></p><h3 id="2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢"><a href="#2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢" class="headerlink" title="2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢"></a>2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-32-32.png" alt="img"><br><img src="https://img.xxlaila.cn/image2019-6-12_15-32-48.png" alt="img"></p><h3 id="3ã€é«˜çº§è®¾ç½®"><a href="#3ã€é«˜çº§è®¾ç½®" class="headerlink" title="3ã€é«˜çº§è®¾ç½®"></a>3ã€é«˜çº§è®¾ç½®</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-17.png" alt="img"></p><h3 id="4ã€é…ç½®ç”¨æˆ·æ¨¡å¼"><a href="#4ã€é…ç½®ç”¨æˆ·æ¨¡å¼" class="headerlink" title="4ã€é…ç½®ç”¨æˆ·æ¨¡å¼"></a>4ã€é…ç½®ç”¨æˆ·æ¨¡å¼</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-35.png" alt="img"></p><h3 id="5ã€è®¾ç½®ç»„æ¨¡å¼"><a href="#5ã€è®¾ç½®ç»„æ¨¡å¼" class="headerlink" title="5ã€è®¾ç½®ç»„æ¨¡å¼"></a>5ã€è®¾ç½®ç»„æ¨¡å¼</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-55.png" alt="img"></p><h3 id="6ã€è®¾ç½®æˆå‘˜æ¨¡å¼"><a href="#6ã€è®¾ç½®æˆå‘˜æ¨¡å¼" class="headerlink" title="6ã€è®¾ç½®æˆå‘˜æ¨¡å¼"></a>6ã€è®¾ç½®æˆå‘˜æ¨¡å¼</h3><p>è¿™é‡Œldapä¸€å®šè¦å­˜åœ¨ä¸ladpçš„groupé‡Œé¢<br><img src="https://img.xxlaila.cn/image2019-6-12_15-34-23.png" alt="img"></p><h3 id="7ã€æµ‹è¯•å¹¶ä¿å­˜"><a href="#7ã€æµ‹è¯•å¹¶ä¿å­˜" class="headerlink" title="7ã€æµ‹è¯•å¹¶ä¿å­˜"></a>7ã€æµ‹è¯•å¹¶ä¿å­˜</h3><p>è¿™é‡Œæµ‹è¯•è´¦æˆ·ä¸€å®šæ˜¯ladpçš„è´¦æˆ·<br><img src="https://img.xxlaila.cn/image2019-6-12_15-34-58.png" alt="img"></p><h3 id="8ã€åŒæ­¥è´¦æˆ·"><a href="#8ã€åŒæ­¥è´¦æˆ·" class="headerlink" title="8ã€åŒæ­¥è´¦æˆ·"></a>8ã€åŒæ­¥è´¦æˆ·</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-35-50.png" alt="img"></p><h3 id="9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•"><a href="#9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•" class="headerlink" title="9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•"></a>9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-36-53.png" alt="img"></p><h2 id="jiraè´¦æˆ·åˆ‡æ¢è‡³ldap"><a href="#jiraè´¦æˆ·åˆ‡æ¢è‡³ldap" class="headerlink" title="jiraè´¦æˆ·åˆ‡æ¢è‡³ldap"></a>jiraè´¦æˆ·åˆ‡æ¢è‡³ldap</h2><blockquote><p>jiraé…ç½®ldapä»¥åé»˜è®¤æ˜¯æœ¬åœ°è´¦æˆ·å’Œldapæ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œç”¨æˆ·å¯ä»¥ç”¨ä»¥å‰çš„æœ¬åœ°è´¦æˆ·å’Œldapéƒ½ç™»å½•ï¼Œè¿™é‡Œå®ç°ldapç™»å½•ï¼Œç¦æ­¢æœ¬åœ°ç™»å½•ã€‚</p></blockquote><h3 id="å‰ç½®æ¡ä»¶"><a href="#å‰ç½®æ¡ä»¶" class="headerlink" title="å‰ç½®æ¡ä»¶"></a>å‰ç½®æ¡ä»¶</h3><ul><li>jiraçš„æœ¬åœ°è´¦æˆ·å’Œldapçš„è´¦æˆ·åç§°å¿…é¡»ä¸€æ ·</li><li>æ“ä½œå‰è¯·å¤‡ä»½æ•°æ®åº“</li><li>ç”¨æˆ·é‚®ç®±ä¿æŒä¸€è‡´</li><li>å¯†ç æ— æ‰€è°“ï¼Œä¸éœ€è¦ç»Ÿä¸€</li></ul><h3 id="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”"><a href="#æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”" class="headerlink" title="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”"></a>æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”</h3><p>ç™»å½•jiraçš„æ•°æ®åº“ã€‚ç„¶åæ‰¾åˆ°cwd_userè¡¨</p><h4 id="cwd-userè¡¨"><a href="#cwd-userè¡¨" class="headerlink" title="cwd_userè¡¨"></a>cwd_userè¡¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;jiraçš„å‰å°ä¸èƒ½ç›´æ¥å»æ›´æ”¹ï¼Œåªæœ‰æ›´æ”¹æ•°æ®åº“ï¼Œè¿›å…¥æ•°æ®åº“ï¼Œæ‰¾åˆ°ä¸€å¼ cwd_userçš„è¡¨ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰ç”¨æˆ·çš„ç™»å½•è´¦å·ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå­—æ®µdirectory_idçš„ï¼Œè¿™ä¸ªå­—æ®µæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ¬åœ°è´¦æˆ·çš„idæ˜¯1ï¼ŒldapåŒæ­¥è¿‡æ¥çš„è´¦æˆ·æ˜¯10001ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://img.xxlaila.cn/1566617986314.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ç»§ç»­çœ‹è¯¥è¡¨çš„credentialå­—æ®µï¼Œå¯†ç ä¹Ÿæœ‰åŒºåˆ«,æœ¬åœ°è´¦æˆ·æ˜¯æœ‰ä¸€ä¸²åŠ å¯†åçš„å­—ç¬¦ä¸²ï¼Œldapè®¤è¯çš„æ˜¯nopassï¼ŒåŒ…æ‹¬åé¢çš„external_id ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/1566618124910.jpg" alt="img"></p><h4 id="cwd-directoryè¡¨"><a href="#cwd-directoryè¡¨" class="headerlink" title="cwd_directoryè¡¨"></a>cwd_directoryè¡¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰“å¼€cwd_directoryè¡¨ï¼Œé‡Œé¢æœ‰ä¸¤æ¡æ•°æ®ï¼Œä¸€ä¸ªå¯¹åº”çš„æ˜¯ldapï¼Œä¸€ä¸ªå¯¹åº”çš„æœ¬åœ°ï¼Œå’Œcwd_useræ˜¯å¯¹åº”çš„ï¼Œå¦‚å›¾ï¼š<br><img src="https://img.xxlaila.cn/image2019-6-13_10-0-47.png" alt="img"></p><h4 id="ä¿®æ”¹æ•°æ®åº“"><a href="#ä¿®æ”¹æ•°æ®åº“" class="headerlink" title="ä¿®æ”¹æ•°æ®åº“"></a>ä¿®æ”¹æ•°æ®åº“</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;è®°ä½ldapç›®å½•çš„idï¼Œç„¶ååœ¨cwd_userè¡¨é‡Œé¢åˆ é™¤ldapçš„ç›¸åŒè´¦æˆ·çš„æ•´æ¡è®°å½•ï¼Œå› ä¸ºè¦ä¼ªè£…åŸæœ¬ç³»ç»Ÿè‡ªå¸¦çš„ç›®å½•æœåŠ¡å™¨ï¼ŒåŸæ¥ç¼–è¾‘çš„æ–‡ä»¶å’Œå†…å®¹ä¸ºåŸå…ˆè¿™ä¸ªç”¨æˆ·çš„idã€‚ä¿®æ”¹directory_id ä¸ºldapçš„idï¼Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦ä¿®æ”¹çš„åœ°æ–¹ä¸ºCREDENTIALçš„å­—æ®µï¼ŒæŠŠå®ƒä¿®æ”¹ä¸ºnopassã€‚ä¿®æ”¹å®Œæˆåéœ€è¦é‡å¯jiraï¼Œä¸é‡å¯ä¸ä¼šç”Ÿæ•ˆï¼Œè€Œä¸”ç™»å½•æœåŠ¡å™¨è¿˜ä¼šæŠ¥é”™ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œjiraå’Œconfluenceæ˜¯åšäº†å…³è”çš„ï¼Œjiraä¿®æ”¹ä»¥åï¼Œconfluenceä¹Ÿå¯ä»¥è¿›è¡Œç™»å½•ï¼Œæ— éœ€åœ¨confluenceåœ¨è®¾ç½®ä¸€æ¬¡ldap;ä¿®æ”¹å®Œæˆåï¼Œä»¥å‰ç”¨æˆ·çš„ç®¡ç†å‘˜æƒé™æœ‰é—®é¢˜ï¼Œé‡æ–°æ·»åŠ ä¸€æ¬¡å³å¯ã€‚ä¸ä¼šå½±å“å…¶ä»–çš„ã€‚è®¾ç½®æ–‡æ¡£ï¼Œldapæƒé™è¦é€‰æ‹©ä¸ºåªè¯»ï¼Œä¸”ä¸ºæœ¬åœ°ç»„ã€‚ç„¶åå§jiaå’Œconfluenceçš„æ™®é€šç»„æ·»åŠ è¿›å»ï¼Œå¦åˆ™ç”¨æˆ·è¿›æ¥æ²¡æœ‰æƒé™</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jira</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>confluenceä¸jiraè´¦æˆ·æ‰“é€š</title>
    <url>/2019/08/24/confluence%E4%B8%8Ejira%E8%B4%A6%E6%88%B7%E6%89%93%E9%80%9A/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:15 GMT+0800 (China Standard Time) --><p><a href="http://xxlaila.github.io/2019/08/24/confluence-install/" target="_blank" rel="noopener">confluence</a>å®‰è£…</p><h3 id="ç™»å½•confluence"><a href="#ç™»å½•confluence" class="headerlink" title="ç™»å½•confluence"></a>ç™»å½•confluence</h3><p>ç‚¹å‡»ç”¨æˆ·ç®¡ç†</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1566615435701.jpg" alt="img"></p><ul><li>ç‚¹å‡»ç”¨æˆ·ç›®å½•<br><img src="https://img.xxlaila.cn/1566615500778.jpg" alt="img"></li></ul><h3 id="å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥"><a href="#å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥" class="headerlink" title="å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥"></a>å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥</h3><ul><li>ç‚¹å‡»æ·»åŠ ç›®å½•</li></ul><p><img src="https://img.xxlaila.cn/1566615580951.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566616502650.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566616536151.jpg" alt="img"></p><p>ç‚¹å‡»æµ‹è¯•è¿æ¥ï¼Œè¿æ¥æˆåŠŸä»¥åï¼Œç‚¹å‡»æµ‹è¯•ä¿å­˜ã€‚å›åˆ°ç•Œé¢å¯ä»¥ç‚¹å‡»åŒæ­¥<br><img src="https://img.xxlaila.cn/1566616609967.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>confluence</category>
      </categories>
      <tags>
        <tag>confluence,jira</tag>
      </tags>
  </entry>
  <entry>
    <title>jiraå®‰è£…å’Œé…ç½®</title>
    <url>/2019/08/24/jira%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;JIRAæ˜¯Atlassianå…¬å¸å‡ºå“çš„é¡¹ç›®ä¸äº‹åŠ¡è·Ÿè¸ªå·¥å…·ï¼Œè¢«å¹¿æ³›åº”ç”¨äºç¼ºé™·è·Ÿè¸ªã€å®¢æˆ·æœåŠ¡ã€éœ€æ±‚æ”¶é›†ã€æµç¨‹å®¡æ‰¹ã€ä»»åŠ¡è·Ÿè¸ªã€é¡¹ç›®è·Ÿè¸ªå’Œæ•æ·ç®¡ç†ç­‰å·¥ä½œé¢†åŸŸã€‚</p><ul><li>ç¯å¢ƒå‡†å¤‡</li></ul><table><thead><tr><th>åº”ç”¨</th><th>æœåŠ¡å™¨é…ç½®</th><th>æ“ä½œç³»ç»Ÿ</th><th>æ’ä»¶</th></tr></thead><tbody><tr><td>mysql 5.6 +</td><td>2/4G/50G</td><td>centos 7.4</td><td></td></tr><tr><td>jira</td><td>4/8G/200G</td><td>centos 7.4</td><td>jdk1.8</td></tr></tbody></table><a id="more"></a><h3 id="å®‰è£…JIRA"><a href="#å®‰è£…JIRA" class="headerlink" title="å®‰è£…JIRA"></a>å®‰è£…JIRA</h3><ul><li>æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./atlassian-jira-software-7.2.2-x64.bin</span></span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1524710136913-900.png" alt="img"></p><ul><li><p>å®‰è£…å®Œæˆååœæ­¢JIRA</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒ/etc/init.d/jira stop</span><br></pre></td></tr></table></figure></li><li><p>å¤åˆ¶ç ´è§£åŒ…å’Œæ•°æ®åº“é©±åŠ¨è¿æ¥å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒcp mysql-connector-java-5.1.39-bin.jar atlassian-extras-3.1.2.jar /opt/atlassian/jira/atlassian-jira/WEB-INF/lib/</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨JIRA</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒ/etc/init.d/jira start</span><br></pre></td></tr></table></figure></li></ul><p>ç™»é™†ç½‘é¡µæ§åˆ¶å°è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œç•¥è¿‡ï¼Œè¿™é‡Œè¿™æ˜¯å®Œæˆï¼Œæ— æ³•æˆªå›¾(åæœŸæœ‰æœºä¼šå®‰è£…æˆªå›¾è¡¥ä¸Š)ï¼Œè®¾ç½®ä»¥åçš„æˆªå›¾<br><img src="https://img.xxlaila.cn/1524710090658-810.png" alt="img"></p><h3 id="é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨"><a href="#é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨" class="headerlink" title="é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨"></a>é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨</h3><p><img src="https://img.xxlaila.cn/1524710057086-739.png" alt="img"><br><img src="https://img.xxlaila.cn/1524710038583-516.png" alt="img"></p><p>é…ç½®å®Œæˆåç‚¹å‡»æœ€ä¸‹é¢çš„æµ‹è¯•è¿æ¥</p><p><img src="https://img.xxlaila.cn/1524710027432-202.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jira</category>
      </categories>
      <tags>
        <tag>jira</tag>
      </tags>
  </entry>
  <entry>
    <title>gitæ¸…ç©ºcommitè®°å½•æ–¹æ³•</title>
    <url>/2019/08/24/git%E6%B8%85%E7%A9%BAcommit%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><blockquote><p>è¯´æ˜:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¾‹å¦‚å°†ä»£ç æäº¤åˆ°gitä»“åº“ï¼Œå°†ä¸€äº›æ•æ„Ÿä¿¡æ¯æäº¤ï¼Œæ‰€ä»¥éœ€è¦åˆ é™¤æäº¤è®°å½•ä»¥å½»åº•æ¸…é™¤æäº¤ä¿¡æ¯ï¼Œä»¥å¾—åˆ°ä¸€ä¸ªå¹²å‡€çš„ä»“åº“ä¸”ä»£ç ä¸å˜</p></blockquote><h3 id="1-Checkout"><a href="#1-Checkout" class="headerlink" title="1.Checkout"></a>1.Checkout</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git checkout --orphan latest_branch</span><br></pre></td></tr></table></figure><h3 id="2-Add-all-the-files"><a href="#2-Add-all-the-files" class="headerlink" title="2. Add all the files"></a>2. Add all the files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add -A</span><br></pre></td></tr></table></figure><h3 id="3-Commit-the-changes"><a href="#3-Commit-the-changes" class="headerlink" title="3. Commit the changes"></a>3. Commit the changes</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git commit -am <span class="string">"commit message"</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="4-Delete-the-branch"><a href="#4-Delete-the-branch" class="headerlink" title="4. Delete the branch"></a>4. Delete the branch</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch -D master</span><br></pre></td></tr></table></figure><h3 id="5-Rename-the-current-branch-to-master"><a href="#5-Rename-the-current-branch-to-master" class="headerlink" title="5.Rename the current branch to master"></a>5.Rename the current branch to master</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch -m master</span><br></pre></td></tr></table></figure><h3 id="6-Finally-force-update-your-repository"><a href="#6-Finally-force-update-your-repository" class="headerlink" title="6.Finally, force update your repository"></a>6.Finally, force update your repository</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git push -f origin master</span><br></pre></td></tr></table></figure><h2 id="git-ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥"><a href="#git-ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥" class="headerlink" title="git ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥"></a>git ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥</h2><h3 id="1ã€è¿œç¨‹åˆ†æ”¯"><a href="#1ã€è¿œç¨‹åˆ†æ”¯" class="headerlink" title="1ã€è¿œç¨‹åˆ†æ”¯"></a>1ã€è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹å½“å‰çš„è¿œç¨‹åˆ†æ”¯</span><br><span class="line">$ git remote -v</span><br></pre></td></tr></table></figure><h3 id="2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯"><a href="#2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯" class="headerlink" title="2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯"></a>2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git remote add latest https://github.com/xxlaila/work.git</span><br></pre></td></tr></table></figure><h3 id="3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯"><a href="#3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯" class="headerlink" title="3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯"></a>3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ›´æ–°è¿œç¨‹åˆ†æ”¯</span><br><span class="line">$ git fetch latest</span><br></pre></td></tr></table></figure><h3 id="4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç "><a href="#4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç " class="headerlink" title="4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç "></a>4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç </h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç </span><br><span class="line">$ git rebase latest/dev</span><br></pre></td></tr></table></figure><h3 id="5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“"><a href="#5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“" class="headerlink" title="5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“"></a>5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ¨é€è¿œç¨‹ä»“åº“</span><br><span class="line">$ git push</span><br></pre></td></tr></table></figure><h2 id="git-ä»£ç ä¿¡æ¯ç»Ÿè®¡"><a href="#git-ä»£ç ä¿¡æ¯ç»Ÿè®¡" class="headerlink" title="git ä»£ç ä¿¡æ¯ç»Ÿè®¡"></a>git ä»£ç ä¿¡æ¯ç»Ÿè®¡</h2><blockquote><p>è¯´æ˜: å…¬å¸æ¯ä¸ªå­£åº¦éƒ½è¦å¯¹å…¬å¸å¼€å‘äººå‘˜çš„å·¥ä½œé‡è¿›è¡Œæ•´ä½“è¯„ä¼°ï¼Œè¯„ä¼°gitä¸Šæ‰€æœ‰ä»£ç åº“çš„commitæ•°é‡å’Œä¿®æ”¹æ–‡ä»¶çš„æ€»è¡Œæ•°</p></blockquote><h3 id="ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡"><a href="#ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡" class="headerlink" title="ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡"></a>ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline --since==2019-04-1 --until=2019-06-30 | wc -l</span><br></pre></td></tr></table></figure><h3 id="ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°"><a href="#ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°" class="headerlink" title="ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°"></a>ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span> --<span class="built_in">stat</span> --since=<span class="string">"2019-4-01"</span> --before=<span class="string">"2019-06-30"</span> |perl -ne <span class="string">'END &#123; print $c &#125; $c += $1 if /(\d+) insertions/'</span></span><br></pre></td></tr></table></figure><h2 id="git-stashä½¿ç”¨"><a href="#git-stashä½¿ç”¨" class="headerlink" title="git stashä½¿ç”¨"></a>git stashä½¿ç”¨</h2><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»Šå¤©é‡åˆ°ä¸€ä¸ªç‰¹æ®Šçš„åœºæ™¯ï¼Œå†™çš„ä¸€ä¸ªpythonç¨‹åºåˆ°æœåŠ¡å™¨ä¸Šæœ‰ä¸€ä¸ªå°bugè¿è¡ŒæŠ¥é”™ï¼Œç„¶åå°±ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šè°ƒè¯•ï¼Œä¿®æ”¹äº†ç¨‹åºï¼Œç¨‹åºæ­£å¸¸è·‘èµ·ï¼Œç„¶è€Œæœ¬åœ°ä¹Ÿè¦ä¿®æ”¹ï¼Œä¿®æ”¹çš„æ—¶å€™åŒæ—¶ä¿®æ”¹äº†å…¶ä»–çš„åœ°æ–¹ï¼Œç„¶åæäº¤äº†gitä¸Šï¼Œè¿™æ—¶ï¼Œéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šæ›´æ–°æœ€æ–°çš„ä»£ç ï¼Œä½†æ˜¯æœåŠ¡å™¨ä¸Šçš„ä»£ç å’Œgitä¸Šçš„ä¸ä¸€è‡´ï¼Œè¿™å°±ä¼šå¯¼è‡´é”™è¯¯ï¼Œè¿™æ—¶gitçš„å¼ºå¤§ä¹‹å¤„å°±ä½“ç°å‡ºæ¥äº†ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git status</span><br><span class="line">èƒ½å¤Ÿå°†æ‰€æœ‰æœªæäº¤çš„ä¿®æ”¹ï¼ˆå·¥ä½œåŒºå’Œæš‚å­˜åŒºï¼‰ä¿å­˜è‡³å †æ ˆä¸­ï¼Œç”¨äºåç»­æ¢å¤å½“å‰å·¥ä½œç›®å½•ã€‚</span><br></pre></td></tr></table></figure><ul><li>æ›´æ–°ä»£ç <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git pull</span><br></pre></td></tr></table></figure></li></ul><p>å°†å½“å‰stashä¸­çš„å†…å®¹å¼¹å‡ºï¼Œå¹¶åº”ç”¨åˆ°å½“å‰åˆ†æ”¯å¯¹åº”çš„å·¥ä½œç›®å½•ä¸Šã€‚</p><blockquote><p>æ³¨:<br>&nbsp;&nbsp;&nbsp;&nbsp;è¯¥å‘½ä»¤å°†å †æ ˆä¸­æœ€è¿‘ä¿å­˜çš„å†…å®¹åˆ é™¤ï¼ˆæ ˆæ˜¯å…ˆè¿›åå‡ºï¼‰</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git stash pop</span><br></pre></td></tr></table></figure><p>æ›´å¤šçš„git stash å‘½ä»¤è¯¦è§£è¯·<a href="https://git-scm.com/book/zh/v1/Git-%E5%B7%A5%E5%85%B7-%E5%82%A8%E8%97%8F%EF%BC%88Stashing%EF%BC%89" target="_blank" rel="noopener">ç‚¹å‡»</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>confluence_install</title>
    <url>/2019/08/24/confluence-install/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Confluenceæ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼ä¸šçŸ¥è¯†ç®¡ç†ä¸ååŒè½¯ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨äºæ„å»ºä¼ä¸šwikiã€‚ä½¿ç”¨ç®€å•ï¼Œä½†å®ƒå¼ºå¤§çš„ç¼–è¾‘å’Œç«™ç‚¹ç®¡ç†ç‰¹å¾èƒ½å¤Ÿå¸®åŠ©å›¢é˜Ÿæˆå‘˜ä¹‹é—´å…±äº«ä¿¡æ¯ã€æ–‡æ¡£åä½œã€é›†ä½“è®¨è®ºï¼Œä¿¡æ¯æ¨é€ã€‚ä¸ºå›¢é˜Ÿæä¾›ä¸€ä¸ªåä½œç¯å¢ƒã€‚åœ¨è¿™é‡Œï¼Œå›¢é˜Ÿæˆå‘˜é½å¿ƒååŠ›ï¼Œå„æ“…å…¶èƒ½ï¼ŒååŒåœ°ç¼–å†™æ–‡æ¡£å’Œç®¡ç†é¡¹ç›®ã€‚ä»æ­¤æ‰“ç ´ä¸åŒå›¢é˜Ÿã€ä¸åŒéƒ¨é—¨ä»¥åŠä¸ªäººä¹‹é—´ä¿¡æ¯å­¤å²›çš„åƒµå±€ï¼ŒConfluenceçœŸæ­£å®ç°äº†ç»„ç»‡èµ„æºå…±äº«ã€‚</p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ç³»ç»Ÿç‰ˆæœ¬</th><th>æ’ä»¶</th><th>è½¯ä»¶</th><th>ç‰ˆæœ¬</th><th>æœåŠ¡é…ç½®</th></tr></thead><tbody><tr><td>centos 7.4</td><td></td><td>mysql</td><td>5.6+</td><td>2/4G/50G</td></tr><tr><td>centos 7.4</td><td>jdk 1.8</td><td>confluence</td><td>6.12.2</td><td>4/8G/200G</td></tr></tbody></table><p>confluence 6.12.2å®‰è£…å¹¶ç ´è§£ï¼Œmysql ç‰ˆæœ¬è¿™é‡Œä½¿ç”¨çš„æ˜¯5.7.24</p><a id="more"></a><h2 id="å®‰è£…mysql-5-7-24-ç‰ˆæœ¬"><a href="#å®‰è£…mysql-5-7-24-ç‰ˆæœ¬" class="headerlink" title="å®‰è£…mysql 5.7.24 ç‰ˆæœ¬"></a>å®‰è£…mysql 5.7.24 ç‰ˆæœ¬</h2><h3 id="å®‰è£…mysql"><a href="#å®‰è£…mysql" class="headerlink" title="å®‰è£…mysql"></a>å®‰è£…mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -ivh http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum list |grep "mysql"</span></span><br><span class="line"><span class="comment"># yum install -y mysql-community-server</span></span><br></pre></td></tr></table></figure><ul><li><p>åŠ¨mysql</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysqld.service</span></span><br><span class="line"><span class="comment"># systemctl enable mysqld.service</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹myslqå¯†ç </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grep 'temporary password' /var/log/mysqld.log</span></span><br><span class="line">mysql&gt; SET PASSWORD = PASSWORD(<span class="string">'news password'</span>);</span><br><span class="line">mysql&gt; ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> PASSWORD EXPIRE NEVER;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚"><a href="#ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚" class="headerlink" title="ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚"></a>ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚</h3><blockquote><p>åœ¨my.cnfé…ç½®æ–‡ä»¶[mysqld]é‡Œé¢æ·»åŠ ä¸‹é¢é…ç½®å‚æ•°</p></blockquote><ul><li><p>å°†é»˜è®¤å­—ç¬¦é›†æŒ‡å®šä¸ºUTF-8</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_bin</span><br></pre></td></tr></table></figure></li><li><p>å°†é»˜è®¤å­˜å‚¨å¼•æ“è®¾ç½®ä¸ºInnoDB</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">default-storage-engine=INNODB</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šå€¼max_allowed_packetè‡³å°‘ä¸º256M</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">max_allowed_packet=512M</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šå€¼ innodb_log_file_size è‡³å°‘ä¸º2GB</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">innodb_log_file_size=2GB</span><br></pre></td></tr></table></figure></li><li><p>ç¡®ä¿æ•°æ®åº“çš„å…¨å±€äº‹åŠ¡éš”ç¦»çº§åˆ«å·²è®¾ç½®ä¸ºREAD-COMMITTED</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">transaction-isolation=READ-COMMITTED</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥äºŒè¿›åˆ¶æ—¥å¿—è®°å½•æ ¼å¼æ˜¯å¦é…ç½®ä¸ºä½¿ç”¨â€œåŸºäºè¡Œâ€çš„äºŒè¿›åˆ¶æ—¥å¿—è®°å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">binlog_format=row</span><br></pre></td></tr></table></figure></li><li><p>ç¡®ä¿sql_modeå‚æ•°æœªæŒ‡å®šNO_AUTO_VALUE_ON_ZERO</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sql_mode = <span class="string">"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯mysqlæ•°æ®åº“</p></li></ul><h3 id="ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“"><a href="#ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“" class="headerlink" title="ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“"></a>ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE confluence CHARACTER SET utf8 COLLATE utf8_bin;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON confluence.* TO confluence@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'password'</span></span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…Confluence"><a href="#å®‰è£…Confluence" class="headerlink" title="å®‰è£…Confluence"></a>å®‰è£…Confluence</h2><p>ä¸‹è½½Confluenceï¼Œè¿™é‡Œä¸‹è½½binæ–‡ä»¶è¿›è¡Œå®‰è£…ï¼Œ<a href="https://www.atlassian.com/software/confluence/download-archives" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a>,ä¸‹è½½çš„ç‰ˆæœ¬ä¸ºatlassian-confluence-6.12.2-x64.bin,åŒ…æœ‰ç‚¹å¤§ï¼Œéœ€è¦ç­‰å¾…â€¦â€¦</p><ul><li><p>èµ‹äºˆæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chmod a+x atlassian-confluence-6.12.2-x64.bin</span></span><br></pre></td></tr></table></figure></li><li><p>å¼€å§‹å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./atlassian-confluence-6.12.2-x64.bin</span></span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…è¿‡ç¨‹ä¸­éœ€è¦åšä¸€äº›åŸºæœ¬çš„é…ç½®ï¼Œè¯¦æƒ…æŸ¥çœ‹æˆ‘çš„é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Unpacking JRE ...</span><br><span class="line">Starting Installer ...</span><br><span class="line"></span><br><span class="line">This will install Confluence 6.12.2 on your computer.</span><br><span class="line">OK [o, Enter], Cancel [c]</span><br><span class="line">o ï¼ˆè¾“å…¥oåŒæ„ï¼‰</span><br><span class="line">Click Next to <span class="built_in">continue</span>, or Cancel to <span class="built_in">exit</span> Setup.</span><br><span class="line"></span><br><span class="line">Choose the appropriate installation or upgrade option.</span><br><span class="line">Please choose one of the following:</span><br><span class="line">Express Install (uses default settings) [1], </span><br><span class="line">Custom Install (recommended <span class="keyword">for</span> advanced users) [2, Enter], </span><br><span class="line">Upgrade an existing Confluence installation [3]</span><br><span class="line">2   (é€‰æ‹©2è‡ªå®šä¹‰å®‰è£…ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€äº›å®šåˆ¶çš„é…ç½®)</span><br></pre></td></tr></table></figure></li><li><p>å¼€å§‹è¿›è¡Œå®‰è£…å‚æ•°çš„é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Select the folder <span class="built_in">where</span> you would like Confluence 6.12.2 to be installed,</span><br><span class="line"><span class="keyword">then</span> click Next.</span><br><span class="line">Where should Confluence 6.12.2 be installed?</span><br><span class="line">[/opt/atlassian/confluence](å®‰è£…ç›®å½•,ç›®å½•å˜åŒ–å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥ï¼Œè¿™é‡Œç›´æ¥å›è½¦)</span><br><span class="line"></span><br><span class="line">Default location <span class="keyword">for</span> Confluence data</span><br><span class="line">[/var/atlassian/application-data/confluence]ï¼ˆæ•°æ®çš„å­˜æ”¾ç›®å½•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¿®æ”¹åˆ°æˆ‘ä»¬çš„æ•°æ®ç›˜ï¼‰</span><br><span class="line">/opt/atlassian/confluence-data/</span><br><span class="line"></span><br><span class="line">Configure <span class="built_in">which</span> ports Confluence will use.</span><br><span class="line">Confluence requires two TCP ports that are not being used by any other</span><br><span class="line">applications on this machine. The HTTP port is <span class="built_in">where</span> you will access</span><br><span class="line">Confluence through your browser. The Control port is used to Startup and</span><br><span class="line">Shutdown Confluence.</span><br><span class="line">Use default ports (HTTP: 8090, Control: 8000) - Recommended [1, Enter], Set custom value <span class="keyword">for</span> HTTP and Control ports [2]</span><br><span class="line">ï¼ˆè¿™é‡Œæ˜¯è®¾ç½®ä½¿ç”¨çš„ç«¯å£ï¼Œé»˜è®¤å³å¯ï¼‰</span><br><span class="line"></span><br><span class="line">Confluence can be run <span class="keyword">in</span> the background.</span><br><span class="line">You may choose to run Confluence as a service, <span class="built_in">which</span> means it will start</span><br><span class="line">automatically whenever the computer restarts.</span><br><span class="line">Install Confluence as Service?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y</span><br><span class="line"></span><br><span class="line">Extracting files ...</span><br><span class="line">                                                                           </span><br><span class="line"></span><br><span class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> we configure Confluence.</span><br><span class="line"></span><br><span class="line">Installation of Confluence 6.12.2 is complete</span><br><span class="line">Start Confluence now?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y</span><br><span class="line"></span><br><span class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> Confluence starts up.</span><br><span class="line">Launching Confluence ...</span><br><span class="line">è¾“å…¥yå›è½¦åConfluenceä¼šè¿›è¡Œåå°å®‰è£…ï¼Œè¿™é‡Œç­‰å¾…å®‰è£…å®Œæˆå³å¯</span><br><span class="line"></span><br><span class="line">Installation of Confluence 6.12.2 is complete</span><br><span class="line">Your installation of Confluence 6.12.2 is now ready and can be accessed via</span><br><span class="line">your browser.</span><br><span class="line">Confluence 6.12.2 can be accessed at http://localhost:8090</span><br><span class="line">å®‰è£…å®Œæˆ</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>é€šè¿‡æµè§ˆå™¨è®¿é—®è¯•ä¸€ä¸‹: <a href="http://ip:8090" target="_blank" rel="noopener">http://ip:8090</a></p></blockquote><h2 id="è¿›è¡Œè®¿é—®é…ç½®"><a href="#è¿›è¡Œè®¿é—®é…ç½®" class="headerlink" title="è¿›è¡Œè®¿é—®é…ç½®"></a>è¿›è¡Œè®¿é—®é…ç½®</h2><h3 id="å®‰è£…nginx-è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®"><a href="#å®‰è£…nginx-è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®" class="headerlink" title="å®‰è£…nginx è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®"></a>å®‰è£…nginx è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum install nginx -y</span></span><br><span class="line"><span class="comment"># systemctl start nginx.service</span></span><br><span class="line"><span class="comment"># systemctl enable nginx.service</span></span><br><span class="line">é…ç½®nginxçš„upstreamè¿™é‡Œå°†ä¸å†é˜è¿°</span><br></pre></td></tr></table></figure><h3 id="æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®"><a href="#æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®" class="headerlink" title="æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®"></a>æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®</h3><ul><li>æ‰“å¼€é¡µé¢</li></ul><p><img src="https://img.xxlaila.cn/1566609337530.jpg" alt="img"></p><ul><li>è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡å’Œäº§å“å®‰è£…</li></ul><p><img src="https://img.xxlaila.cn/1566609486131.jpg" alt="img"></p><p>åœ¨ä¸‹é¢çš„ä¸€ä¸ªç•Œé¢éœ€è¦è®°ä½æœåŠ¡å™¨çš„IDï¼Œè¿™ä¸ªipåœ¨åé¢ç ´è§£çš„æ—¶å€™éœ€è¦çš„</p><ul><li>åœæ­¢confluence<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/init.d/confluence stop</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ç ´è§£Confluence"><a href="#ç ´è§£Confluence" class="headerlink" title="ç ´è§£Confluence"></a>ç ´è§£Confluence</h3><ul><li>åœ¨æœ¬åœ°ä¸‹è½½ç ´è§£å™¨</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/xxlaila/work/blob/master/zip/confluence.zip</span></span><br><span class="line"><span class="comment"># unzip confluence.zip</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨æœåŠ¡å™¨ä¸ŠæŠŠatlassian-extras-decoder-v2-3.4.1.jarè¿›è¡Œå¦‚ä¸‹æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /opt/atlassian/confluence/confluence/WEB-INF/lib</span></span><br><span class="line"><span class="comment"># cp atlassian-extras-decoder-v2-3.4.1.jar /opt/atlassian-extras-2.4.jar</span></span><br><span class="line"><span class="comment"># mv atlassian-extras-decoder-v2-3.4.1.jar atlassian-extras-decoder-v2-3.4.1.jar.bak</span></span><br></pre></td></tr></table></figure></li><li><p>æŠŠ/opt/atlassian-extras-2.4.jarä¸‹è½½åˆ°æœ¬åœ°,åœ¨æœ¬åœ°å¯åŠ¨Confluenceç ´è§£å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ java -jar confluence_keygen.jar</span><br></pre></td></tr></table></figure><ul><li>ç‚¹å‡».patch! é€‰æ‹©ä¸‹è½½åˆ°æœ¬åœ°çš„atlassian-extras-2.4.jaråŒ…ï¼Œæ–‡ä»¶ç±»å‹ä¸å˜ï¼Œç‚¹å‡»æ‰“å¼€ï¼Œè‡ªåŠ¨ç”Ÿäº§ä¸€ä¸ªæ–°çš„atlassian-extras-2.4.jaråŒ…</li></ul><p><img src="https://img.xxlaila.cn/FA8682F205BB1655E20AAD392DF13417.jpg" alt="img"></p><ul><li>æŠŠæœåŠ¡å™¨idè¾“å…¥åˆ°server idï¼Œnameé¡¹éšä¾¿è¾“å…¥ï¼Œåç§°ä¸è¦è¿‡çŸ­ï¼Œåº—å®¶.gen!ç”Ÿæˆæˆæƒå—ï¼Œç„¶åæŠŠæˆæƒå¤åˆ¶åˆ°confluenceæ¡†é‡Œé¢</li></ul><p><img src="https://img.xxlaila.cn/CB99372F30342EBABC1125510FBC50B9.jpg" alt="img"></p><ul><li>æŠŠæ–°ç”Ÿæˆçš„åŒ…ä¸Šä¼ åˆ°/opt/atlassian/confluence/confluence/WEB-INF/lib/ç›®å½•ä¸‹é¢</li></ul><h3 id="ä¸‹è½½mysqlé©±åŠ¨"><a href="#ä¸‹è½½mysqlé©±åŠ¨" class="headerlink" title="ä¸‹è½½mysqlé©±åŠ¨"></a>ä¸‹è½½mysqlé©±åŠ¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.47.zip</span></span><br></pre></td></tr></table></figure><ul><li><p>å®Œæˆåè¿›è¡Œè§£å‹ï¼Œå¹¶æŠŠmysql-connector-java-5.1.47-bin.jar å¤åˆ¶åˆ°libç›®å½•ä¸‹é¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp mysql-connector-java-5.1.47-bin.jar /opt/atlassian/confluence/confluence/WEB-INF/lib</span></span><br><span class="line"><span class="comment"># /etc/init.d/confluence start</span></span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®æ•°æ®åº“</p></li></ul><p><img src="https://img.xxlaila.cn/EFF70DEA9DFBCA88E24BE83BEE9DFFC8.jpg" alt="img"><br><img src="https://img.xxlaila.cn/BF70624FCFA9E5ECFD4E121E02D08FD3.jpg" alt="img"></p><blockquote><p>è¿™æ˜¯å®Œæˆä»¥åè¿›è¡Œæµ‹è¯•ï¼Œæ˜¯å¦è”é€šï¼Œåœ¨ä¸‹ä¸€æ­¥ï¼ˆéœ€è¦è¿›è¡Œç­‰å¾…ï¼Œåå°åœ¨ç”Ÿæˆæ•°æ®åº“ï¼‰,ç”Ÿæˆå®Œæˆåï¼Œç³»ç»Ÿä¼šè·³è½¬åˆ°å¦å¤–ä¸€ä¸ªé¡µé¢ï¼Œè¿™é‡Œå¿˜è®°æˆªå›¾,æ˜¯è¿›è¡Œæ•°æ®å¯¼å…¥ã€ç«™ç‚¹æ¢å¤ç­‰</p></blockquote><ul><li><p>é‡æ–°æ‰“å¼€ç½‘å€è¿æ¥<br><img src="https://img.xxlaila.cn/BEE317A48B4CEE0407638F47CDBDF31F.jpg" alt="img"></p></li><li><p>ç”±äºè¿™é‡Œæ²¡æœ‰ladpå’Œjira,æ‰€ä»¥é€‰æ‹©åœ¨confluenceä¸­ç®¡ç†ç”¨æˆ·å’Œç»„</p></li><li><p>è®¾ç½®ç³»ç»Ÿç®¡ç†è´¦æˆ·</p></li></ul><p><img src="https://img.xxlaila.cn/93FDD95874C661340531C27CC77298FD.jpg" alt="img"><br><img src="https://img.xxlaila.cn/6B1F3A2EBF1B3DAF1A962317AA59DC15.jpg" alt="img"></p><blockquote><p>è¿™é‡Œè·³è¿‡ä¸ªäººå¤´åƒè®¾å®š,å¤´åƒè®¾å®šå®Œæˆåä¼šæç¤ºä½ æ–°å»ºä¸€ä¸ªç©ºé—´</p></blockquote><p><img src="https://img.xxlaila.cn/FCE130BD8B121A290010FEA2C2342898.jpg" alt="img"></p><ul><li>æŸ¥çœ‹æˆæƒæœŸé™</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è®¾ç½®â€”â€”&gt;ä¸€èˆ¬è®¾ç½®â€”â€”&gt;ç®¡ç†â€”â€”&gt;æˆæƒç»†èŠ‚</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/EEB25C9704F4C76C30E1DF32A2E1EDE0.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>confluence</category>
      </categories>
      <tags>
        <tag>confluence</tag>
      </tags>
  </entry>
  <entry>
    <title>nexus3æ­å»ºnpmç§æœ</title>
    <url>/2019/08/23/nexus3%E6%90%AD%E5%BB%BAnpm%E7%A7%81%E6%9C%8D/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸å‰ç«¯å…¨æ˜¯nodejsçš„ï¼Œnodejsåœ¨installçš„æ—¶å€™å¾€å¾€æ˜¯è¿æ¥å¤–ç½‘ï¼Œæˆ–è€…æ˜¯è®¾ç½®taobaoæºï¼Œå³ä½¿æ˜¯è®¾ç½®äº†taobaoæºï¼Œä½†æ˜¯è¿˜æ˜¯è§£å†³ä¸äº†æ…¢çš„é—®é¢˜ï¼Œä¸ºæ­¤æ­å»ºäº†ä¸€ä¸ªå†…éƒ¨çš„npmç§æœï¼Œè¿™é‡Œç”¨googleä¸€ä¸‹æœ‰å¾ˆå¤šéƒ½å¯ä»¥æ¥è¿›è¡Œæ­å»ºnpmç§æœï¼Œç„¶åä¹Ÿçœ‹åˆ°äº†nexusä¹Ÿå¯ä»¥æ¥åšï¼Œæ­£å¥½mavenç§æœä¹Ÿæ˜¯ç”¨çš„è¿™ä¸ªï¼Œéƒ½æ˜¯3ç‰ˆæœ¬ï¼Œä¸ºæ­¤é€‰æ‹©äº†nexusæ¥åšnpmçš„ç§æœï¼Œå’Œmavenä¸€å¥—ä¾¿äºç»´æŠ¤ã€‚</p><h3 id="nexuså®‰è£…"><a href="#nexuså®‰è£…" class="headerlink" title="nexuså®‰è£…"></a>nexuså®‰è£…</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸ä»‹ç»ï¼Œå®‰è£…å®Œæˆnexusåï¼Œåœ¨æµè§ˆå™¨æ‰“å¼€å¹¶è¿›è¡Œç™»å½•ï¼Œç¬¬ä¸€æ¬¡å®‰è£…ç™»å½•nexusçš„é»˜è®¤ç”¨æˆ·<code>admin</code>,é»˜è®¤å¯†ç æ˜¯<code>admin123</code></p><a id="more"></a><h3 id="1ã€åˆ›å»ºrepository"><a href="#1ã€åˆ›å»ºrepository" class="headerlink" title="1ã€åˆ›å»ºrepository"></a>1ã€åˆ›å»ºrepository</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Nexus Repository Manager 3 å¯ä»¥ç”¨äºå¤šç§ç±»å‹çš„åŒ…ç®¡ç†ã€‚æ­¤å¤„æˆ‘ä»¬è¦æ­å»ºçš„æ˜¯npmåŒ…ç®¡ç†ç§æœã€‚ç™»å½•åœ¨ç•Œé¢ç‚¹å‡»ä¸‹å›¾æ‰€ç¤ºæŒ‰é’®ã€‚<br><img src="https://img.xxlaila.cn/1566524933898.jpg" alt="img"></p><ul><li>è¿›å…¥è®¾ç½®ç•Œé¢<br><img src="https://img.xxlaila.cn/1566525058628.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šå›¾ä¸­å·¦é¢èœå•æœ‰å¾ˆå¤šåŠŸèƒ½ã€‚å¯ä»¥åœ¨ Security ä¸‹çš„ Users å¯ä»¥åˆ›å»ºç”¨æˆ·å¹¶è®¾ç½®ç”¨æˆ·æƒé™ï¼Œä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ã€‚Logging ä¸‹çš„ Log Viewer å¯ä»¥æŸ¥çœ‹è¿è¡Œæ—¥å¿—ã€‚è€Œæœ¬æ¬¡é…ç½®ä¸»è¦ç”¨åˆ°äº† Repository -&gt; Repositories å’Œ Security -&gt; Realms ä¸¤é¡¹</p><ul><li>é¦–å…ˆåœ¨ Repositories åˆ›å»ºä»“åº“</li></ul><p><img src="https://img.xxlaila.cn/1566526054409.jpg" alt="img"></p><ul><li><p>æ¥ä¸‹æ¥ä¼šè¿›å…¥åˆ° Repositorty çš„é€‰æ‹©ï¼šï¼ˆnpm æœ‰ä¸‰ç§ï¼‰<br><img src="https://img.xxlaila.cn/1566526144738.jpg" alt="img"></p></li><li><p>ç¬¬ä¸€ç§ï¼šä»£ç† npm ä»“åº“</p></li></ul><p><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Proxying npm Registries</a>å¯äº§çœ‹å®˜æ–¹æ–‡æ¡£</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å°†å…¬å…± npm æœåŠ¡å™¨çš„èµ„æºä»£ç†ç¼“å­˜ï¼Œå‡å°‘é‡å¤ä¸‹è½½ï¼ŒåŠ å¿«å¼€å‘äººå‘˜å’ŒCIæœåŠ¡å™¨çš„ä¸‹è½½é€Ÿåº¦ã€‚åˆ›å»ºæ—¶é€‰æ‹© npm(proxy) ï¼Œåªéœ€å¡«å†™ Name å’Œ Remote storage ï¼ˆå…¬æœ‰åº“åŸŸåï¼‰å³å¯ã€‚<br><img src="https://img.xxlaila.cn/1566526375641.jpg" alt="img"></p><ul><li>ç¬¬äºŒç§ï¼šç§æœ‰ npm ä»“åº“<br><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Private npm Registries</a>å®˜æ–¹æ–‡æ¡£</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äº ä¸Šä¼ è‡ªå·±çš„npmåŒ… ä»¥åŠç¬¬ä¸‰æ–¹npmåŒ…ã€‚åŒæ ·çš„åˆ›å»ºæ­¥éª¤ï¼Œåªä¸è¿‡é€‰æ‹©çš„ ä»“åº“ç±»å‹ä¸º npm(hosted)ã€‚ åªå¡«å†™ Name å³å¯</p><p><img src="https://img.xxlaila.cn/1566526835511.jpg" alt="img"></p><ul><li>ç¬¬ä¸‰ç§ï¼šnpm ä»“åº“ç»„<br><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Grouping npm Registries</a>å®˜æ–¹æ–‡æ¡£</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºå°†å¤šä¸ªå†…éƒ¨æˆ–å¤–éƒ¨ npm ä»“åº“ç»Ÿä¸€ä¸ºä¸€ä¸ª npmä»“åº“ã€‚è¢«æ·»åŠ åˆ° npmä»“åº“ç»„ ä¸­çš„ å…¶ä»–ä»“åº“å†…çš„åŒ…éƒ½èƒ½å¤Ÿé€šè¿‡è¯¥ npmä»“åº“ç»„ è®¿é—®åˆ°ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¾‹å¦‚ï¼šå¯ä»¥æ–°å»ºä¸€ä¸ªnpmä»“åº“ç»„å°† ä¸Šé¢ä¸¤ä¸ªåˆšåˆšåˆ›å»ºçš„ npm ä»“åº“éƒ½æ·»åŠ è¿›å»ã€‚è¿™æ ·å¯ä»¥é€šè¿‡è¿™ä¸ª npmä»“åº“ç»„ï¼Œæ—¢å¯ä»¥è®¿é—® å…¬æœ‰npmä»“åº“ åˆå¯ä»¥è®¿é—®è‡ªå·±çš„ ç§æœ‰npmä»“åº“ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»“åº“ç±»å‹ä¸º npm(group)ï¼Œèµ·ä¸€ä¸ªåå­— Nameï¼Œç„¶åé€‰æ‹©éœ€è¦æ·»åŠ åˆ°ç»„é‡Œçš„ å…¶ä»– npm ä»“åº“ã€‚æ­¤å¤„æˆ‘é€‰æ‹©çš„æ˜¯ npm-kxl-external å’Œ npm-kxl-internal</p><p><img src="https://img.xxlaila.cn/1566527053731.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»“åº“éƒ½åˆ›å»ºå®Œæ¯•äº†ã€‚æ¥ä¸‹æ¥éœ€è¦éªŒè¯ä¸€ä¸‹æ˜¯å¦å¯ç”¨,åœ¨ Repositories ä¸­ç‚¹å‡»åˆ›å»ºçš„ ä»“åº“ã€‚å¯ä»¥æŸ¥çœ‹è¯¥ä»“åº“çš„ URLã€‚<br>åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º .npmrc æ–‡ä»¶ã€‚æ–‡ä»¶å†…å®¹ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">registry=http://172.21.16.90:8081/repository/npm-kxl-all/</span><br></pre></td></tr></table></figure><p>ç„¶åéšä¾¿å®‰è£…ä¸€ä¸ª åŒ… è¯•è¯•ï¼ˆæ—¥å¿—çº§åˆ«è®¾ç½®ä¸º infoï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm --loglevel info install react</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1566528241640.jpg" alt="img"></p><p>å¦‚å›¾ã€‚ç¡®å®æ˜¯ä»è®¾ç½®çš„ npm ç§æœä¸‹è½½çš„reactã€‚æˆåŠŸ</p><h3 id="å‘å¸ƒåˆ°-npm-ç§æœ"><a href="#å‘å¸ƒåˆ°-npm-ç§æœ" class="headerlink" title="å‘å¸ƒåˆ° npm ç§æœ"></a>å‘å¸ƒåˆ° npm ç§æœ</h3><p>é™¤äº†ä» npm ä»“åº“å®‰è£…ä¾èµ–ã€‚æˆ‘ä»¬è¿˜éœ€è¦å°†å…¬å¸å†…éƒ¨çš„ ä»£ç æ‰“åŒ… å‘å¸ƒåˆ° npm çš„ç§æœã€‚è¿™é‡Œæ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå°±æ˜¯éœ€è¦è®¾ç½®ä¸€ä¸‹ Nexus Repository Manager çš„æƒé™ã€‚è¿™æ ·æ‰èƒ½ä½¿ç”¨ npm login è®¤è¯ç™»å½•åˆ°æˆ‘ä»¬çš„ç§æœã€‚</p><p><img src="https://img.xxlaila.cn/1566528346695.jpg" alt="img"></p><p>æ­¤å¤„åœ¨ Realms ä¸‹ã€‚å°† npm Bearer Token Realm æ·»åŠ åˆ° Active åˆ—è¡¨å†…ä¿å­˜å³å¯ã€‚<br>ç„¶åå¯ä»¥æ‰§è¡Œï¼ˆç™»å½• ç§æœ‰npmä»“åº“ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm login --registry=http://172.21.16.90:8081/repository/npm-kxl-internal/</span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Email: (this IS public) 1@qq.com</span><br><span class="line">Logged <span class="keyword">in</span> as admin on http://172.21.16.90:8081/repository/npm-kxl-internal/.</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤ï¼Œæç¤ºå¡«å†™è´¦å·å¯†ç å’Œé‚®ç®±ï¼ŒéªŒè¯é€šè¿‡åå°†ä¼šåœ¨ ç”¨æˆ·ä¸»ç›®å½•ä¸‹çš„ .npmrc æ–‡ä»¶ä¸­æ’å…¥ä¸€æ¡ æ­¤ä»“åº“ url å’Œå¯¹åº”çš„ tokenã€‚</p><p><img src="https://img.xxlaila.cn/1566528452423.jpg" alt="img"></p><p>åœ¨ç¡®ä¿é¡¹ç›®æœ‰ package.json å‰æä¸‹ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm publish --registry=http://172.21.16.90:8081/repository/npm-kxl-internal/</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œä½¿ç”¨ Nexus Repository Manager 3 æ­å»º npm ç§æœç»“æŸã€‚æ•´ä½“æµç¨‹å¹¶ä¸å¤æ‚ï¼Œæ–‡æ¡£å¾ˆè¯¦å°½,ç›´æ¥è¯»æ–‡æ¡£å¯èƒ½ä¼šé—æ¼ä¸€äº›ä¸œè¥¿ã€‚å¯ä»¥å‚è€ƒ<a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://xxlaila.github.io/2019/10/15/nexusé…ç½®ldap/" target="_blank" rel="noopener">nexus ldapé…ç½®</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nexus</category>
      </categories>
      <tags>
        <tag>npm</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx URL æ–œæ é—®é¢˜</title>
    <url>/2019/08/22/nginx-URL-%E6%96%9C%E6%9D%A0%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä»Šå¤©å…¬å¸æ–°ä¸Šçš„ä¸€ä¸ªå‰ç«¯åº”ç”¨é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯åœ¨å¾®ä¿¡ç™»å½•ç•Œé¢æ‰«ç ç™»å½•ä¹‹åï¼Œå¾®ä¿¡å›è°ƒç»™æˆ‘ä»¬çš„åœ°å€å¤šåŠ äº†ä¸€ä¸ªæ–œæ ;</p><blockquote><p>é”™è¯¯çš„åœ°å€:<a href="http://a.xxlaila.com/wx.html/?code=011amZet0h1IUf19Fvht0jg4ft0amZeN" target="_blank" rel="noopener">http://a.xxlaila.com/wx.html/?code=011amZet0h1IUf19Fvht0jg4ft0amZeN</a><br>æ­£ç¡®çš„åœ°å€:<a href="http://a.xxlaila.com/wx.html?code=011amZet0h1IUf19Fvht0jg4ft0amZeN" target="_blank" rel="noopener">http://a.xxlaila.com/wx.html?code=011amZet0h1IUf19Fvht0jg4ft0amZeN</a></p></blockquote><p>åœ¨nginxä¸Šé…ç½®éœ€è¦å§è¿™ä¸ªæ–œæ åˆ é™¤æ‰ã€‚ç”¨æˆ·æ‰èƒ½æ­£å¸¸çš„è®¿é—®ï¼›</p><h3 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><p>åœ¨é…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®é¡¹</p><a id="more"></a><ul><li>åˆ é™¤URLç»“å°¾çš„æ–œæ </li></ul><p><em>rewrite ^/(.</em>)/$ /$1 permanent;*</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  a.xxlaila.com;</span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)/$</span> /<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">  <span class="attribute">index</span> index.html index.htm index.jsp index.php;</span><br><span class="line">  <span class="attribute">root</span> /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> <span class="regexp">~* /</span> &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span>   /var/log/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨URLç»“å°¾æ·»åŠ æ–œæ <br>åœ¨é…ç½®æ–‡ä»¶å¢åŠ å¦‚ä¸‹é…ç½®é¡¹ç›®</li></ul><p><em>rewrite ^(.</em>[^/])$ $1/ permanent;*</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  a.xxlaila.com;</span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^(.*[^/])$</span> <span class="variable">$1</span>/ <span class="literal">permanent</span>;</span><br><span class="line">  <span class="attribute">index</span> index.html index.htm index.jsp index.php;</span><br><span class="line">  <span class="attribute">root</span> /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> <span class="regexp">~* /</span> &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span>   /var/log/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h2><p>åœ¨æµè§ˆå™¨è®¿é—®æŸä¸€ä¸ªurl/é¡µé¢çš„æ—¶å€™ï¼Œé€šå¸¸æœ‰æ—¶å€™å¸¦æœ‰.htmlçš„ä¸€ä¸ªæ‰©å±•åï¼Œç°éœ€æ±‚æ˜¯å¸¦<code>.html</code>å’Œä¸å¸¦<code>.html</code>éƒ½å¯ä»¥è®¿é—®</p><h3 id="ä¾‹"><a href="#ä¾‹" class="headerlink" title="ä¾‹"></a>ä¾‹</h3><p>å¢åŠ å¦‚ä¸‹é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;    </span><br><span class="line">       rewrite ^(.*)$ /<span class="variable">$1</span>.html last;</span><br><span class="line">       <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  charset utf-8;</span><br><span class="line">  server_name  a.xxlaila.com;</span><br><span class="line">  rewrite ^/(.*)/$ /<span class="variable">$1</span> permanent;</span><br><span class="line">  index index.html index.htm index.jsp index.php;</span><br><span class="line">  root /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  location ~* / &#123;</span><br><span class="line">    <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">       rewrite ^(.*)$ /<span class="variable">$1</span>.html last;</span><br><span class="line">       <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  access_log   /var/<span class="built_in">log</span>/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(å››)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E5%9B%9B/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h2 id="1ã€Blue-Ocean"><a href="#1ã€Blue-Ocean" class="headerlink" title="1ã€Blue Ocean"></a>1ã€Blue Ocean</h2><p>å®‰è£…Blue Oceanæ’ä»¶</p><h3 id="1-1ã€åˆ›å»ºpipeline"><a href="#1-1ã€åˆ›å»ºpipeline" class="headerlink" title="1.1ã€åˆ›å»ºpipeline"></a>1.1ã€åˆ›å»ºpipeline</h3><p><img src="https://img.xxlaila.cn/348knfnsdlds.png" alt="img"></p><ul><li>é…ç½®ä»£ç åº“çš„åœ°å€</li><li>ç„¶åé…ç½®æˆæƒè´¦æˆ·</li></ul><p><img src="https://img.xxlaila.cn/9857jksdhfjkhdsfds.png" alt="img"></p><p>åœ¨è¿™å„¿ä¹‹å‰gitåº“é‡Œé¢å¿…é¡»å­˜åœ¨äºjenkinsfileæ–‡ä»¶ï¼Œpipelineä¼šè‡ªåŠ¨å»æ‰«æä»£ç åº“é‡Œé¢çš„åˆ†æ”¯ï¼Œç„¶åæ ¹æ®æ¯ä¸€ä¸ªåˆ†æ”¯å»ºç«‹ä¸€ä¸ªç±»ä¼¼äºjobçš„å½¢å¼ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æ ¹æ®æ¯ä¸€ä¸ªåˆ†æ”¯è¿›è¡Œéƒ¨ç½²ï¼Œå¯ä»¥æ‰§è¡Œå®šæ—¶è§¦å‘ï¼Œéƒ¨ç½²</p><p><img src="https://img.xxlaila.cn/382dklfjdskjfs.png" alt="img"></p><p>è¿™å„¿ï¼Œåªæœ‰ä¸€ä¸ªåˆ†æ”¯å­˜åœ¨äºjenkinsfileï¼Œæ‰€ä»¥åªæ˜¾ç¤ºä¸€ä¸ªåˆ†æ”¯ï¼Œå¦‚ä¸‹å›¾ï¼š</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>jenkins, ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(ä¸‰)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E4%B8%89/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;jenkins é…ç½®å®Œæˆåï¼Œæœ€ç»ˆå®ç°çš„æ˜¯ci/cdï¼Œåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°åç«¯javaçš„ï¼Œå‰ç«¯nodejsçš„ï¼Œè¿™é‡Œå°±éœ€è¦è¿›è¡Œä¸€ä¸ªk8såœ¨è°ƒåº¦çš„æ—¶å€™ç”Ÿäº§podæ¥è¿›è¡ŒæŒ‡å®špodè¿›è¡Œç¼–è¯‘</p><h3 id="1ã€åˆ¶ä½œå®¹å™¨"><a href="#1ã€åˆ¶ä½œå®¹å™¨" class="headerlink" title="1ã€åˆ¶ä½œå®¹å™¨"></a>1ã€åˆ¶ä½œå®¹å™¨</h3><p>è‡ªå®šä¹‰ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢åŒ…å«äº† javaï¼Œnodejsçš„æ‰€éœ€è¦çš„ç¯å¢ƒï¼ŒåŒæ—¶éœ€è¦åŒæ­¥å®¹å™¨çš„æ—¶é—´ï¼ŒåŒ…å«æ¥jenkinsçš„node</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat Dockerfile</span></span><br><span class="line"><span class="attr">FROM</span> <span class="string">docker.io/centos:latest</span></span><br><span class="line"><span class="attr">MAINTAINER</span> <span class="string">xxlaila "cq_xxlaila@163.com"</span></span><br><span class="line"><span class="comment"># Install dependent plugin</span></span><br><span class="line"><span class="attr">ENV</span> <span class="string">VERSION v10.15.1</span></span><br><span class="line"><span class="attr">RUN</span> <span class="string">yum install -y wget \</span></span><br><span class="line">    <span class="attr">git</span> <span class="string">\</span></span><br><span class="line">    <span class="meta">java-1.8.0-openjdk.x86_64</span> <span class="string">\</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">curl -sL https://rpm.nodesource.com/setup_11.x | bash - \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum install -y gcc gcc-c++ make \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum install -y nodejs \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum clean all</span></span><br><span class="line"><span class="comment"># System variable setting</span></span><br><span class="line"><span class="attr">RUN</span> <span class="string">echo "LANG=zh_CN.UTF-8" &gt;&gt; /etc/locale.conf \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">source /etc/locale.conf \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">echo "Asia/shanghai" &gt;&gt; /etc/timezone \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">groupadd -g 10000 jenkins \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">useradd -g jenkins -u 10000 jenkins</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">EXPOSE</span> <span class="string">50000</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li><p>æ‰§è¡Œå®¹å™¨æ‰“åŒ…</p><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="attr"># docker build -t centos7</span><span class="number">.6</span>/<span class="symbol">node11</span>:latest .\</span><br></pre></td></tr></table></figure></li><li><p>æ¨é€å®¹å™¨åˆ°ç§æœ‰é•œåƒä»“åº“</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># docker tag centos7<span class="number">.6</span>/node11:latest docker.io/xxlaila/centos<span class="number">-7</span>-jdk1<span class="number">.8</span>-nodejs11<span class="number">.10</span>-jenkins:latest</span><br><span class="line"># docker push docker.io/xxlaila/centos<span class="number">-7</span>-jdk1<span class="number">.8</span>-nodejs11<span class="number">.10</span>-jenkins:latest</span><br></pre></td></tr></table></figure></li></ul><h3 id="2ã€jenkinsçš„é…ç½®"><a href="#2ã€jenkinsçš„é…ç½®" class="headerlink" title="2ã€jenkinsçš„é…ç½®"></a>2ã€jenkinsçš„é…ç½®</h3><h4 id="2-1ã€ç³»ç»Ÿé…ç½®"><a href="#2-1ã€ç³»ç»Ÿé…ç½®" class="headerlink" title="2.1ã€ç³»ç»Ÿé…ç½®"></a>2.1ã€ç³»ç»Ÿé…ç½®</h4><p>jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;ç³»ç»Ÿè®¾ç½®<br><strong>åç§°</strong>ï¼škubernetes<br><strong>åœ°å€</strong>ï¼š<a href="https://kubernetes.default.svc.cluster.local" target="_blank" rel="noopener">https://kubernetes.default.svc.cluster.local</a><br><strong>jenkinsåœ°å€</strong>ï¼š<a href="http://jenkins2.kube-ops.svc.cluster.local:8080" target="_blank" rel="noopener">http://jenkins2.kube-ops.svc.cluster.local:8080</a><br><img src="https://img.xxlaila.cn/489kdngkdhfkodsmf.png" alt="img"></p><h4 id="2-2ã€å¢åŠ ä¸€ä¸ªkubenetes-pod-templates"><a href="#2-2ã€å¢åŠ ä¸€ä¸ªkubenetes-pod-templates" class="headerlink" title="2.2ã€å¢åŠ ä¸€ä¸ªkubenetes pod templates"></a>2.2ã€å¢åŠ ä¸€ä¸ªkubenetes pod templates</h4><p><img src="https://img.xxlaila.cn/83jknfkdslfds.png" alt="img"></p><h4 id="2-3ã€é…ç½®å®¹å™¨ç¯å¢ƒ"><a href="#2-3ã€é…ç½®å®¹å™¨ç¯å¢ƒ" class="headerlink" title="2.3ã€é…ç½®å®¹å™¨ç¯å¢ƒ"></a>2.3ã€é…ç½®å®¹å™¨ç¯å¢ƒ</h4><p><img src="https://img.xxlaila.cn/42clkdsjfkldsfs.png" alt="img"></p><h4 id="2-4ã€é…ç½®æƒé™"><a href="#2-4ã€é…ç½®æƒé™" class="headerlink" title="2.4ã€é…ç½®æƒé™"></a>2.4ã€é…ç½®æƒé™</h4><p><img src="https://img.xxlaila.cn/3486238kmxnfksd.png" alt="img"></p><h3 id="3ã€æµ‹è¯•job"><a href="#3ã€æµ‹è¯•job" class="headerlink" title="3ã€æµ‹è¯•job"></a>3ã€æµ‹è¯•job</h3><p>å»ºç«‹ä¸€ä¸ªtest job çš„pipelineæ¥è¿›è¡Œå®¹å™¨æ˜¯å¦æ­£å¸¸</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node (<span class="string">'agent-node'</span>)&#123;</span><br><span class="line">    container(<span class="string">'nodejs'</span>) &#123;</span><br><span class="line">        sh <span class="string">'whoami'</span></span><br><span class="line">        sh <span class="string">'hostname'</span></span><br><span class="line">        sh <span class="string">'echo $PATH'</span></span><br><span class="line">        sh <span class="string">'npm version'</span></span><br><span class="line">        sh <span class="string">'node -v'</span></span><br><span class="line">        sh <span class="string">'npx -v'</span></span><br><span class="line">        sh <span class="string">'java -version'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1ã€å»ºç«‹pipeline"><a href="#3-1ã€å»ºç«‹pipeline" class="headerlink" title="3.1ã€å»ºç«‹pipeline"></a>3.1ã€å»ºç«‹pipeline</h4><h5 id="3-1-1ã€å»ºç«‹ä¸€ä¸ªåç«¯"><a href="#3-1-1ã€å»ºç«‹ä¸€ä¸ªåç«¯" class="headerlink" title="3.1.1ã€å»ºç«‹ä¸€ä¸ªåç«¯"></a>3.1.1ã€å»ºç«‹ä¸€ä¸ªåç«¯</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'agent-build'</span>) &#123;</span><br><span class="line">   stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git credentialsId:<span class="string">'gitlabUser'</span>, url: <span class="string">'http://gitlab.xxlaila.com/plat/middleware/kxl-eureka.git'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'build'</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2. Start build <span class="variable">$&#123;JOB_NAME&#125;</span>"</span></span><br><span class="line">        sh <span class="string">'/opt/bin/mvn clean package'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'show package'</span>) &#123;</span><br><span class="line">        sh <span class="string">'pwd'</span></span><br><span class="line">        sh <span class="string">'ls -ltrh target/'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1-2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯"><a href="#3-1-2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯" class="headerlink" title="3.1.2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯"></a>3.1.2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯</h4><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'agent-build'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git credentialsId:<span class="string">'gitlabUser'</span>, ur<span class="variable">l:</span> <span class="string">'http://gitlab.xxlaila.com/front-end/portal/kts-platform.git'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'install'</span>) &#123;</span><br><span class="line">        container(<span class="string">'nodejs'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"2. Start install $&#123;JOB_NAME&#125;"</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'node -v'</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'npm install'</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'npm run build production'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'show package'</span>) &#123;</span><br><span class="line">        <span class="keyword">sh</span> <span class="string">'pwd'</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">'ls -ltrh'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(äºŒ)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E4%BA%8C/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h1 id="åŸºäºjenkins-pipelineè¿›è¡Œéƒ¨ç½²"><a href="#åŸºäºjenkins-pipelineè¿›è¡Œéƒ¨ç½²" class="headerlink" title="åŸºäºjenkins  pipelineè¿›è¡Œéƒ¨ç½²"></a>åŸºäºjenkins pipelineè¿›è¡Œéƒ¨ç½²</h1><h2 id="1ã€jenkins-pipelineä»‹ç»"><a href="#1ã€jenkins-pipelineä»‹ç»" class="headerlink" title="1ã€jenkins pipelineä»‹ç»"></a>1ã€jenkins pipelineä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;è¦å®ç°åœ¨ Jenkins ä¸­çš„æ„å»ºå·¥ä½œï¼Œå¯ä»¥æœ‰å¤šç§æ–¹å¼ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨æ¯”è¾ƒå¸¸ç”¨çš„ Pipeline è¿™ç§æ–¹å¼ã€‚Pipelineï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸€å¥—è¿è¡Œåœ¨ Jenkins ä¸Šçš„å·¥ä½œæµæ¡†æ¶ï¼Œå°†åŸæ¥ç‹¬ç«‹è¿è¡Œäºå•ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ç‚¹çš„ä»»åŠ¡è¿æ¥èµ·æ¥ï¼Œå®ç°å•ä¸ªä»»åŠ¡éš¾ä»¥å®Œæˆçš„å¤æ‚æµç¨‹ç¼–æ’å’Œå¯è§†åŒ–çš„å·¥ä½œã€‚</p><p>Jenkins Pipeline æœ‰å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µ:</p><ul><li>Nodeï¼šèŠ‚ç‚¹ï¼Œä¸€ä¸ª Node å°±æ˜¯ä¸€ä¸ª Jenkins èŠ‚ç‚¹ï¼ŒMaster æˆ–è€… Agentï¼Œæ˜¯æ‰§è¡Œ Step çš„å…·ä½“è¿è¡Œç¯å¢ƒï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹‹å‰åŠ¨æ€è¿è¡Œçš„ Jenkins Slave å°±æ˜¯ä¸€ä¸ª Node èŠ‚ç‚¹</li><li>Stageï¼šé˜¶æ®µï¼Œä¸€ä¸ª Pipeline å¯ä»¥åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ª Stageï¼Œæ¯ä¸ª Stage ä»£è¡¨ä¸€ç»„æ“ä½œï¼Œæ¯”å¦‚ï¼šBuildã€Testã€Deployï¼ŒStage æ˜¯ä¸€ä¸ªé€»è¾‘åˆ†ç»„çš„æ¦‚å¿µï¼Œå¯ä»¥è·¨å¤šä¸ª Node</li><li>Stepï¼šæ­¥éª¤ï¼ŒStep æ˜¯æœ€åŸºæœ¬çš„æ“ä½œå•å…ƒï¼Œå¯ä»¥æ˜¯æ‰“å°ä¸€å¥è¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æ„å»ºä¸€ä¸ª Docker é•œåƒï¼Œç”±å„ç±» Jenkins æ’ä»¶æä¾›ï¼Œæ¯”å¦‚å‘½ä»¤ï¼šsh â€˜makeâ€™ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å¹³æ—¶ shell ç»ˆç«¯ä¸­æ‰§è¡Œ make å‘½ä»¤ä¸€æ ·ã€‚</li></ul><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åˆ›å»º Jenkins Pipline å‘¢ï¼Ÿ</p><ul><li>Pipeline è„šæœ¬æ˜¯ç”± Groovy è¯­è¨€å®ç°çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡å¿…è¦å•ç‹¬å»å­¦ä¹  Groovyï¼Œå½“ç„¶ä½ ä¼šçš„è¯æœ€å¥½</li><li>Pipeline æ”¯æŒä¸¤ç§è¯­æ³•ï¼šDeclarative(å£°æ˜å¼)å’Œ Scripted Pipeline(è„šæœ¬å¼)è¯­æ³•</li><li>Pipeline ä¹Ÿæœ‰ä¸¤ç§åˆ›å»ºæ–¹æ³•ï¼šå¯ä»¥ç›´æ¥åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­è¾“å…¥è„šæœ¬ï¼›ä¹Ÿå¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª Jenkinsfile è„šæœ¬æ–‡ä»¶æ”¾å…¥é¡¹ç›®æºç åº“ä¸­</li><li>ä¸€èˆ¬æˆ‘ä»¬éƒ½æ¨èåœ¨ Jenkins ä¸­ç›´æ¥ä»æºä»£ç æ§åˆ¶(SCMD)ä¸­ç›´æ¥è½½å…¥ Jenkinsfile Pipeline è¿™ç§æ–¹æ³•åˆ›å»ºä¸€ä¸ªç®€å•çš„ Pipeline<blockquote><p>æˆ‘ä»¬è¿™é‡Œæ¥ç»™å¤§å®¶å¿«é€Ÿåˆ›å»ºä¸€ä¸ªç®€å•çš„ Pipelineï¼Œç›´æ¥åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­è¾“å…¥è„šæœ¬è¿è¡Œã€‚</p></blockquote></li><li>æ–°å»º Jobï¼šåœ¨ Web UI ä¸­ç‚¹å‡» New Item -&gt; è¾“å…¥åç§°ï¼špipeline-demo -&gt; é€‰æ‹©ä¸‹é¢çš„ Pipeline -&gt; ç‚¹å‡» OK</li><li>é…ç½®ï¼šåœ¨æœ€ä¸‹æ–¹çš„ Pipeline åŒºåŸŸè¾“å…¥å¦‚ä¸‹ Script è„šæœ¬ï¼Œç„¶åç‚¹å‡»ä¿å­˜ã€‚</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell node &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span> </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span> </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"3.Build Stage"</span> </span><br><span class="line">        </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"4. Deploy Stage"</span> </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ„å»ºï¼šç‚¹å‡»å·¦ä¾§åŒºåŸŸçš„ Build Nowï¼Œå¯ä»¥çœ‹åˆ° Job å¼€å§‹æ„å»ºäº†<blockquote><p>éš”ä¸€ä¼šå„¿ï¼Œæ„å»ºå®Œæˆï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¾§åŒºåŸŸçš„ Console Outputï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºä¿¡æ¯ï¼š</p></blockquote></li></ul><p><img src="https://img.xxlaila.cn/sdsdsjid23874823ehsj.png" alt="img"></p><ul><li>åœ¨ Slave ä¸­æ„å»ºä»»åŠ¡<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ Pipeline ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªä»»åŠ¡å¹¶æ²¡æœ‰åœ¨ Jenkins çš„ Slave ä¸­è¿è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•è®©æˆ‘ä»¬çš„ä»»åŠ¡è·‘åœ¨ Slave ä¸­å‘¢ï¼Ÿè¿˜è®°å¾—ä¸ŠèŠ‚è¯¾æˆ‘ä»¬åœ¨æ·»åŠ  Slave Pod çš„æ—¶å€™ï¼Œä¸€å®šè¦è®°ä½æ·»åŠ çš„ label å—ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°è¿™ä¸ª labelï¼Œæˆ‘ä»¬é‡æ–°ç¼–è¾‘ä¸Šé¢åˆ›å»ºçš„ Pipeline è„šæœ¬ï¼Œç»™ node æ·»åŠ ä¸€ä¸ª label å±æ€§ï¼Œå¦‚ä¸‹:</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'jnlp-agent'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4. Deploy Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯ç»™ node æ·»åŠ äº†ä¸€ä¸ªjnlp-agentè¿™æ ·çš„ä¸€ä¸ªlabelï¼Œç„¶åæˆ‘ä»¬ä¿å­˜ï¼Œæ„å»ºä¹‹å‰æŸ¥çœ‹ä¸‹ kubernetes é›†ç¾¤ä¸­çš„ Podï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[<span class="built_in">test</span>] [root@k8s-zxc-test-3 ~]<span class="comment"># kubectl get pods -n kube-ops</span></span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">jenkins2-696b8fbdbb-q24nm   1/1     Running             0          45h</span><br><span class="line">jnlp-agent-342fv            0/1     ContainerCreating   0          0s</span><br><span class="line">[<span class="built_in">test</span>] [root@k8s-zxc-test-3 ~]<span class="comment"># kubectl get pods -n kube-ops</span></span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">jenkins2-696b8fbdbb-q24nm   1/1     Running             0          45h</span><br><span class="line">jnlp-agent-342fv            0/1     ContainerCreating   0          1s</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/dhf482390dsfjkdsg.png" alt="img"></p><ul><li><p>kubernetes ç•Œé¢æ˜¾ç¤º<br><img src="https://img.xxlaila.cn/9374hkdhskfjsdd.png" alt="img"></p></li><li><p>jenkinsæ‰§è¡Œç»“æœæ˜¾ç¤º<br><img src="https://img.xxlaila.cn/23cvkndiuyriens.png" alt="img"></p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp; è¯æ˜æˆ‘ä»¬å½“å‰çš„ä»»åŠ¡åœ¨è·‘åœ¨ä¸Šé¢åŠ¨æ€ç”Ÿæˆçš„è¿™ä¸ª Pod ä¸­ï¼Œä¹Ÿç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚æˆ‘ä»¬å›åˆ° Job çš„ä¸»ç•Œé¢ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°å¤§å®¶å¯èƒ½æ¯”è¾ƒç†Ÿæ‚‰çš„ Stage View ç•Œé¢ï¼š<br><img src="https://img.xxlaila.cn/45ksfh9whnkxa.png" alt="img"></p><h5 id="éƒ¨ç½²-Kubernetes-åº”ç”¨"><a href="#éƒ¨ç½²-Kubernetes-åº”ç”¨" class="headerlink" title="éƒ¨ç½² Kubernetes åº”ç”¨"></a>éƒ¨ç½² Kubernetes åº”ç”¨</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å·²ç»çŸ¥é“äº†å¦‚ä½•åœ¨ Jenkins Slave ä¸­æ„å»ºä»»åŠ¡äº†ï¼Œé‚£ä¹ˆå¦‚ä½•æ¥éƒ¨ç½²ä¸€ä¸ªåŸç”Ÿçš„ Kubernetes åº”ç”¨å‘¢ï¼Ÿ è¦éƒ¨ç½² Kubernetes åº”ç”¨ï¼Œæˆ‘ä»¬å°±å¾—å¯¹æˆ‘ä»¬ä¹‹å‰éƒ¨ç½²åº”ç”¨çš„æµç¨‹è¦éå¸¸ç†Ÿæ‚‰æ‰è¡Œï¼Œæˆ‘ä»¬ä¹‹å‰çš„æµç¨‹æ˜¯æ€æ ·çš„ï¼š</p><ul><li>1ã€ç¼–å†™ä»£ç </li><li>2ã€æµ‹è¯•</li><li>3ã€ç¼–å†™ Dockerfile</li><li>4ã€æ„å»ºæ‰“åŒ… Docker é•œåƒ</li><li>5ã€æ¨é€ Docker é•œåƒåˆ°ä»“åº“</li><li>6ã€ç¼–å†™ Kubernetes YAML æ–‡ä»¶</li><li>7ã€æ›´æ”¹ YAML æ–‡ä»¶ä¸­ Docker é•œåƒ TAG</li><li>8ã€åˆ©ç”¨ kubectl å·¥å…·éƒ¨ç½²åº”ç”¨</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬ä¹‹å‰åœ¨ Kubernetes ç¯å¢ƒä¸­éƒ¨ç½²ä¸€ä¸ªåŸç”Ÿåº”ç”¨çš„æµç¨‹åº”è¯¥åŸºæœ¬ä¸Šæ˜¯ä¸Šé¢è¿™äº›æµç¨‹å§ï¼Ÿç°åœ¨æˆ‘ä»¬å°±éœ€è¦æŠŠä¸Šé¢è¿™äº›æµç¨‹æ”¾å…¥ Jenkins ä¸­æ¥è‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆ(å½“ç„¶ç¼–ç é™¤å¤–)ï¼Œä»æµ‹è¯•åˆ°æ›´æ–° YAML æ–‡ä»¶å±äº CI æµç¨‹ï¼Œåé¢éƒ¨ç½²å±äº CD çš„æµç¨‹ã€‚å¦‚æœæŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬ç°åœ¨è¦æ¥ç¼–å†™ä¸€ä¸ª Pipeline çš„è„šæœ¬ã€‚</p><ul><li><p>ä¿®æ”¹test-spring-social-wechat-sample pipelineè„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'jnlp-agent'</span>) &#123;</span><br><span class="line">   stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'YAML'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"6. Deploy Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>1ï¼‰ã€å¢åŠ gitåœ°å€ï¼Œè¿›è¡Œä»£ç çš„clone</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Clone'</span>)</span></span> &#123;</span><br><span class="line">   echo <span class="string">"1.Clone Stage"</span></span><br><span class="line">   git url: <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>2ï¼‰ã€è¿›è¡Œæµ‹è¯•</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Test'</span>)</span></span> &#123;</span><br><span class="line">  echo <span class="string">"2.Test Stage"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>3ï¼‰ã€æ„å»ºä¸€ä¸ªdockeré•œåƒ</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Build'</span>)</span></span> &#123;</span><br><span class="line">  echo <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">  sh <span class="string">"docker build -t xxlaila/jenkins-demo:$&#123;build_tag&#125; ."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;å¹³æ—¶æ„å»ºçš„æ—¶å€™æ˜¯ä¸æ˜¯éƒ½æ˜¯ç›´æ¥ä½¿ç”¨docker buildå‘½ä»¤è¿›è¡Œæ„å»ºå°±è¡Œäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹å‘¢ï¼Ÿæˆ‘ä»¬ä¸ŠèŠ‚è¯¾ç»™å¤§å®¶æä¾›çš„ Slave Pod çš„é•œåƒé‡Œé¢æ˜¯ä¸æ˜¯é‡‡ç”¨çš„ Docker In Docker çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ Slave ä¸­ä½¿ç”¨ docker build å‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç›´æ¥ä½¿ç”¨ sh ç›´æ¥æ‰§è¡Œ docker build å‘½ä»¤å³å¯ï¼Œä½†æ˜¯é•œåƒçš„ tag å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬ä½¿ç”¨é•œåƒ tagï¼Œåˆ™æ¯æ¬¡éƒ½æ˜¯ latest çš„ tagï¼Œè¿™å¯¹äºä»¥åçš„æ’æŸ¥æˆ–è€…å›æ»šä¹‹ç±»çš„å·¥ä½œä¼šå¸¦æ¥å¾ˆå¤§éº»çƒ¦ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨å’Œgit commitçš„è®°å½•ä¸ºé•œåƒçš„ tagï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯é•œåƒçš„ tag å¯ä»¥å’Œ git æäº¤è®°å½•å¯¹åº”èµ·æ¥ï¼Œä¹Ÿæ–¹ä¾¿æ—¥åå¯¹åº”æŸ¥çœ‹ã€‚ä½†æ˜¯ç”±äºè¿™ä¸ª tag ä¸åªæ˜¯æˆ‘ä»¬è¿™ä¸€ä¸ª stage éœ€è¦ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªæ¨é€é•œåƒæ˜¯ä¸æ˜¯ä¹Ÿéœ€è¦ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æŠŠè¿™ä¸ª tag ç¼–å†™æˆä¸€ä¸ªå…¬å…±çš„å‚æ•°ï¼ŒæŠŠå®ƒæ”¾åœ¨ Clone è¿™ä¸ª stage ä¸­ï¼Œä¿®æ”¹å‰é¢ä¸¤ä¸ª stage:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git url: <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line">      script &#123;</span><br><span class="line">        build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">      sh <span class="string">"docker build -t xxlaila/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span> ."</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>4ï¼‰ã€æ¨é€é•œåƒ<br>&nbsp;&nbsp;&nbsp;&nbsp;é•œåƒæ„å»ºå®Œæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬å°±éœ€è¦å°†æ­¤å¤„æ„å»ºçš„é•œåƒæ¨é€åˆ°é•œåƒä»“åº“ä¸­å»ï¼Œå½“ç„¶å¦‚æœä½ æœ‰ç§æœ‰é•œåƒä»“åº“ä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰è‡ªå·±æ­å»ºç§æœ‰çš„ä»“åº“ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ docker hub å³å¯ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬çŸ¥é“ docker hub æ˜¯å…¬å…±çš„é•œåƒä»“åº“ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å–ä¸Šé¢çš„é•œåƒï¼Œä½†æ˜¯è¦å¾€ä¸Šæ¨é€é•œåƒæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°ä¸€ä¸ªå¸å·äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æå‰æ³¨å†Œä¸€ä¸ª docker hub çš„å¸å·ï¼Œè®°ä½ç”¨æˆ·åå’Œå¯†ç ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦ä½¿ç”¨ã€‚æ­£å¸¸æ¥è¯´æˆ‘ä»¬åœ¨æœ¬åœ°æ¨é€ docker é•œåƒçš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯éœ€è¦ä½¿ç”¨docker loginå‘½ä»¤ï¼Œç„¶åè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œè®¤è¯é€šè¿‡åï¼Œå°±å¯ä»¥ä½¿ç”¨docker pushå‘½ä»¤æ¥æ¨é€æœ¬åœ°çš„é•œåƒåˆ° docker hub ä¸Šé¢å»äº†ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬è¿™é‡Œçš„ Pipeline æ˜¯ä¸æ˜¯å°±è¯¥è¿™æ ·å†™äº†ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">      sh <span class="string">"docker login -u cq_xxlaila@163.com -p 111111"</span></span><br><span class="line">      sh <span class="string">"docker push xxlaila/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span>"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœåªæ˜¯åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡çš„è¯ï¼Œæˆ‘ä»¬è¿™é‡Œçš„ Pipeline æ˜¯å¯ä»¥è¿™æ ·å†™çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯ä¸æ˜¯æ¨èä½¿ç”¨ Jenkinsfile çš„å½¢å¼æ”¾å…¥æºç ä¸­è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬ç›´æ¥æŠŠ docker ä»“åº“çš„ç”¨æˆ·åå’Œå¯†ç æš´éœ²ç»™åˆ«äººè¿™æ ·å¾ˆæ˜¾ç„¶æ˜¯éå¸¸éå¸¸ä¸å®‰å…¨çš„ï¼Œæ›´ä½•å†µæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ github çš„å…¬å…±ä»£ç ä»“åº“ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥ç›´æ¥çœ‹åˆ°æˆ‘ä»¬çš„æºç ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ç”¨ä¸€ç§æ–¹å¼æ¥éšè—ç”¨æˆ·åå’Œå¯†ç è¿™ç§ç§å¯†ä¿¡æ¯ï¼Œå¹¸è¿çš„æ˜¯ Jenkins ä¸ºæˆ‘ä»¬æä¾›äº†è§£å†³æ–¹æ³•ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨é¦–é¡µç‚¹å‡» Credentials -&gt; Stores scoped to Jenkins ä¸‹é¢çš„ Jenkins -&gt; Global credentials (å‡­æ®) -&gt;system(ç³»ç»Ÿ)-&gt;å…¨å±€å‡­æ® (unrestricted)-&gt; å·¦ä¾§çš„ Add Credentials( æ·»åŠ å‡­æ®)ï¼šæ·»åŠ ä¸€ä¸ª Username with password ç±»å‹çš„è®¤è¯ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š<br><img src="https://img.xxlaila.cn/374kdjfkskfdsd.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;Add Credentials è¾“å…¥ docker hub çš„ç”¨æˆ·åå’Œå¯†ç ï¼ŒID éƒ¨åˆ†æˆ‘ä»¬è¾“å…¥dockerHubï¼Œæ³¨æ„ï¼Œè¿™ä¸ªå€¼éå¸¸é‡è¦ï¼Œåœ¨åé¢ Pipeline çš„è„šæœ¬ä¸­æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ª ID å€¼ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†ä¸Šé¢çš„ docker hub çš„ç”¨æˆ·åå’Œå¯†ç çš„è®¤è¯ä¿¡æ¯ï¼Œç°åœ¨ä¿®æ”¹ Pipeline ä¸­çš„ç¬¬å››éƒ¨ï¼Œä½¿ç”¨è¿™é‡Œçš„ç”¨æˆ·åå’Œå¯†ç ï¼š</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">stage('Push') &#123;</span><br><span class="line">     echo <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">     <span class="keyword">with</span><span class="constructor">Credentials([<span class="params">usernamePassword</span>(<span class="params">credentialsId</span>: '<span class="params">dockerHub</span>', <span class="params">passwordVariable</span>: '<span class="params">dockerHubPassword</span>', <span class="params">usernameVariable</span>: '<span class="params">dockerHubUser</span>')</span>]) &#123;</span><br><span class="line">         sh <span class="string">"docker login -u $&#123;dockerHubUser&#125; -p $&#123;dockerHubPassword&#125;"</span></span><br><span class="line">         sh <span class="string">"docker push xxlaila/jenkins-demo:$&#123;build_tag&#125;"</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><blockquote><p><em>æ³¨æ„</em>:<br>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è¿™é‡Œåœ¨ stage ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæ–°çš„å‡½æ•°withCredentialsï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªcredentialsIdå€¼å°±æ˜¯æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ ID å€¼ï¼Œç„¶åå°±å¯ä»¥åœ¨è„šæœ¬ä¸­ç›´æ¥ä½¿ç”¨è¿™é‡Œä¸¤ä¸ªå˜é‡å€¼æ¥ç›´æ¥æ›¿æ¢æ‰ä¹‹å‰çš„ç™»å½• docker hub çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿™æ ·æ“ä½œå°±ç›¸å¯¹æ¥è¯´å°±å¾ˆå®‰å…¨äº†ï¼Œåªæ˜¯ä¼ é€’è¿›å»äº†ä¸¤ä¸ªå˜é‡è€Œå·²ï¼Œåˆ«äººå¹¶ä¸çŸ¥é“çœŸæ­£ç”¨æˆ·åå’Œå¯†ç ï¼Œåªæœ‰æˆ‘ä»¬è‡ªå·±çš„ Jenkins å¹³å°ä¸Šæ·»åŠ çš„æ‰çŸ¥é“ã€‚<br><em>æµ‹è¯•ç»“æœ</em>:</p></blockquote><p><img src="https://img.xxlaila.cn/4ykjdbfjdshfkojdsl.png" alt="img"></p><ul><li>5ï¼‰ã€æ›´æ”¹ YAML<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢å·²ç»å®Œæˆäº†é•œåƒçš„æ‰“åŒ…ã€æ¨é€çš„å·¥ä½œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥æ›´æ–° Kubernetes ç³»ç»Ÿä¸­åº”ç”¨çš„é•œåƒç‰ˆæœ¬äº†ï¼Œå½“ç„¶ä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç”¨ YAML æ–‡ä»¶çš„å½¢å¼æ¥ç¼–å†™åº”ç”¨éƒ¨ç½²è§„åˆ™ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„ YAML æ–‡ä»¶ï¼š(k8s.yaml)<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cat k8s.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins-demo</span><br><span class="line"><span class="symbol">  namespace:</span> default</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      labels:</span></span><br><span class="line"><span class="symbol">        app:</span> jenkins-demo</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">      - image: xxlaila/jenkins-demo:<span class="params">&lt;BUILD_TAG&gt;</span></span><br><span class="line"><span class="symbol">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="symbol">        name:</span> jenkins-demo</span><br><span class="line"><span class="symbol">        env:</span></span><br><span class="line">        - name: branch</span><br><span class="line"><span class="symbol">          value:</span> <span class="params">&lt;BRANCH_NAME&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨ä¸€ä¸ª Deployment èµ„æºå¯¹è±¡æ¥ç®¡ç† Podï¼Œè¯¥ Pod ä½¿ç”¨çš„å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ¨é€çš„é•œåƒï¼Œå”¯ä¸€ä¸åŒçš„åœ°æ–¹æ˜¯ Docker é•œåƒçš„ tag ä¸æ˜¯æˆ‘ä»¬å¹³å¸¸è§çš„å…·ä½“çš„ tagï¼Œè€Œæ˜¯ä¸€ä¸ª çš„æ ‡è¯†ï¼Œå®é™…ä¸Šå¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªæ ‡è¯†æ›¿æ¢æˆä¸Šé¢çš„ Docker é•œåƒçš„ tagï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯æœ€ç»ˆæˆ‘ä»¬æœ¬æ¬¡æ„å»ºéœ€è¦ä½¿ç”¨åˆ°çš„é•œåƒï¼Ÿæ€ä¹ˆæ›¿æ¢å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªsedå‘½ä»¤å°±å¯ä»¥å®ç°äº†ï¼š</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'YAML'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">      sh <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>sed å‘½ä»¤å°±æ˜¯å°† k8s.yaml æ–‡ä»¶ä¸­çš„ æ ‡è¯†ç»™æ›¿æ¢æˆå˜é‡ build_tag çš„å€¼ã€‚</p></blockquote><ul><li>6ï¼‰ã€éƒ¨ç½²<br>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes åº”ç”¨çš„ YAML æ–‡ä»¶å·²ç»æ›´æ”¹å®Œæˆäº†ï¼Œä¹‹å‰æˆ‘ä»¬æ‰‹åŠ¨çš„ç¯å¢ƒä¸‹ï¼Œæ˜¯ä¸æ˜¯ç›´æ¥ä½¿ç”¨ kubectl apply å‘½ä»¤å°±å¯ä»¥ç›´æ¥æ›´æ–°åº”ç”¨ã€‚å½“ç„¶è¿™é‡Œåªæ˜¯å†™å…¥åˆ°äº† Pipeline é‡Œé¢ï¼Œæ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ï¼š</li></ul><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Deploy'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"6. Deploy Stage"</span></span><br><span class="line">      sh <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>ç‚¹å‡»jenkinsè¿›è¡Œæ„å»º<br><img src="https://img.xxlaila.cn/56hjkshdfdksnfkldsj.png" alt="img"></li></ul><blockquote><p>å½“ç„¶ï¼Œè¿™é‡Œéƒ¨ç½²å¤±è´¥ï¼Œå…ˆåˆ«ç®¡ï¼Œè¯æ˜æµç¨‹æ˜¯å¯¹çš„ï¼Œå¯ä»¥è¿™ä¹ˆèµ°</p></blockquote><p><img src="https://img.xxlaila.cn/3947dnfdsflskfjdsf.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»¥ä¸Šçš„é…ç½®åŸºæœ¬å·²ç»å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬çš„å®é™…é¡¹ç›®å®è·µè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€äº›äººå·¥å¹²é¢„çš„æ­¥éª¤ï¼Œæ¯”å¦‚æˆ‘ä»¬æäº¤äº†ä¸€æ¬¡ä»£ç ï¼Œæµ‹è¯•ä¹Ÿé€šè¿‡äº†ï¼Œé•œåƒä¹Ÿæ‰“åŒ…ä¸Šä¼ äº†ï¼Œä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬å¹¶ä¸ä¸€å®šå°±æ˜¯è¦ç«‹åˆ»ä¸Šçº¿åˆ°ç”Ÿäº§ç¯å¢ƒçš„ã€‚æˆ‘ä»¬å¯èƒ½éœ€è¦å°†è¯¥ç‰ˆæœ¬å…ˆå‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒã€QA ç¯å¢ƒã€æˆ–è€…é¢„è§ˆç¯å¢ƒä¹‹ç±»çš„ï¼Œæ€»ä¹‹ç›´æ¥å°±å‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒå»è¿˜æ˜¯æŒºå°‘è§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¢åŠ äººå·¥ç¡®è®¤çš„ç¯èŠ‚ï¼Œä¸€èˆ¬éƒ½æ˜¯åœ¨ CD çš„ç¯èŠ‚æ‰éœ€è¦äººå·¥å¹²é¢„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„æœ€åä¸¤æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å‰é¢åŠ ä¸Šç¡®è®¤ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'YAML'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">      def userInput = <span class="built_in">input</span>(</span><br><span class="line">          id: <span class="string">'userInput'</span>,</span><br><span class="line">          message: <span class="string">'Choose a deploy environment'</span>,</span><br><span class="line">          parameter<span class="variable">s:</span> [</span><br><span class="line">              [</span><br><span class="line">                  #clas<span class="variable">s:</span> <span class="string">'ChoiceParameterDefinition'</span>,</span><br><span class="line">                  choice<span class="variable">s:</span> <span class="string">"Dev\nTest\nUat\nDemo\nPord"</span>,</span><br><span class="line">                  name: <span class="string">'Env'</span></span><br><span class="line">                  ]</span><br><span class="line">              ]</span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"This is a deploy step to $&#123;userInput.Env&#125;"</span></span><br><span class="line">          <span class="keyword">sh</span> <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä½¿ç”¨äº† input å…³é”®å­—ï¼Œé‡Œé¢ä½¿ç”¨ä¸€ä¸ª Choice çš„åˆ—è¡¨æ¥è®©ç”¨æˆ·è¿›è¡Œé€‰æ‹©ï¼Œç„¶ååœ¨æˆ‘ä»¬é€‰æ‹©äº†éƒ¨ç½²ç¯å¢ƒåï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿå¯ä»¥é’ˆå¯¹ä¸åŒçš„ç¯å¢ƒå†åšä¸€äº›æ“ä½œï¼Œæ¯”å¦‚å¯ä»¥ç»™ä¸åŒç¯å¢ƒçš„ YAML æ–‡ä»¶éƒ¨ç½²åˆ°ä¸åŒçš„ namespace ä¸‹é¢å»ï¼Œå¢åŠ ä¸åŒçš„æ ‡ç­¾ç­‰ç­‰æ“ä½œï¼š</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Deploy'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"6. Deploy Stage"</span></span><br><span class="line">      <span class="keyword">if</span> (userInput<span class="selector-class">.Env</span> == <span class="string">"Dev"</span>)&#123;</span><br><span class="line">          <span class="comment">// deploy dev stuff</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userInput<span class="selector-class">.Env</span> == <span class="string">"Test"</span>)&#123;</span><br><span class="line">          <span class="comment">// deploy test stuff</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// deploy prod stuff</span></span><br><span class="line">      &#125;</span><br><span class="line">      sh <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸€æ­¥ä¹Ÿå±äºéƒ¨ç½²çš„èŒƒç•´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æœ€åä¸¤æ­¥éƒ½åˆå¹¶æˆä¸€æ­¥ï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ Pipeline è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'node-jnlp'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">        git ur<span class="variable">l:</span> <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line">        script &#123;</span><br><span class="line">            build_tag = <span class="keyword">sh</span>(returnStdou<span class="variable">t:</span> true, <span class="keyword">scrip</span><span class="variable">t:</span> <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"docker build -t xxlaila/jenkins-demo:$&#123;build_tag&#125; ."</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">        withCredentials([usernamePassword(credentialsId: <span class="string">'dockerHub'</span>, passwordVariable: <span class="string">'dockerHubPassword'</span>, usernameVariable: <span class="string">'dockerHubUser'</span>)]) &#123;</span><br><span class="line">            <span class="keyword">sh</span> <span class="string">"docker login -u $&#123;dockerHubUser&#125; -p $&#123;dockerHubPassword&#125;"</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">"docker push cnych/jenkins-demo:$&#123;build_tag&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"5. Deploy Stage"</span></span><br><span class="line">        def userInput = <span class="built_in">input</span>(</span><br><span class="line">            id: <span class="string">'userInput'</span>,</span><br><span class="line">            message: <span class="string">'Choose a deploy environment'</span>,</span><br><span class="line">            parameter<span class="variable">s:</span> [</span><br><span class="line">                [</span><br><span class="line">                    $clas<span class="variable">s:</span> <span class="string">'ChoiceParameterDefinition'</span>,</span><br><span class="line">                    choice<span class="variable">s:</span> <span class="string">"Dev\nQA\nProd"</span>,</span><br><span class="line">                    name: <span class="string">'Env'</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"This is a deploy step to $&#123;userInput&#125;"</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">"Dev"</span>) &#123;</span><br><span class="line">            // deploy dev stuff</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userInput == <span class="string">"QA"</span>)&#123;</span><br><span class="line">            // deploy <span class="keyword">qa</span> stuff</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            // deploy prod stuff</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>é”™è¯¯</em>: åœ¨jenkinsæ‰§è¡Œæ„å»ºçš„æ—¶å€™æç¤º:</p><p><img src="https://img.xxlaila.cn/2846djkfhklsdjdklsd.png" alt="img"></p><blockquote><p>æ²¡æœ‰æƒé™è¿›è¡Œéƒ¨ç½²ï¼Œä¸‹é¢è¿›è¡Œæƒé™çš„åˆ†é…ã€‚</p></blockquote><ul><li><p>æŸ¥çœ‹kube-ops ä¸‹é¢çš„è§’è‰²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role -n kube-ops</span></span><br><span class="line">NAME       AGE</span><br><span class="line">jenkins2   2d6h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹roleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role jenkins2 -n kube-ops -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2019-01-14T03:07:25Z"</span></span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  resourceVersion: <span class="string">"2389179"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/kube-ops/roles/jenkins2</span><br><span class="line">  uid: 84762132-17a9-11e9-8991-fa163e14c5bd</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">exec</span></span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">log</span></span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºjenkins2çš„æƒé™</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">[<span class="symbol">root@</span>k8s-zxc-test<span class="number">-3</span> ~]# kubectl -n kube-system create sa jenkins2</span><br><span class="line">serviceaccount/jenkins2 created</span><br></pre></td></tr></table></figure></li><li><p>æˆæƒè®¿é—®</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test<span class="number">-3</span> ~]# kubectl <span class="built_in">create</span> clusterrolebinding jenkins2 <span class="comment">--clusterrole cluster-admin --serviceaccount=kube-ops:jenkins2</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/jenkins2 created</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>zabbixä¼ä¸šå¾®ä¿¡å‘Šè­¦</title>
    <url>/2019/08/20/zabbix%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Zabbixå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼æŠŠå‘Šè­¦ä¿¡æ¯å‘é€åˆ°æŒ‡å®šäººï¼Œå¸¸ç”¨çš„æœ‰é‚®ä»¶ï¼ŒçŸ­ä¿¡æŠ¥è­¦æ–¹å¼ï¼Œä½†æ˜¯è¶Šæ¥è¶Šå¤šçš„ä¼ä¸šå¼€å§‹ä½¿ç”¨zabbixç»“åˆå¾®ä¿¡ä½œä¸ºä¸»è¦çš„å‘Šè­¦æ–¹å¼ï¼Œè¿™æ ·å¯ä»¥åŠæ—¶æœ‰æ•ˆçš„æŠŠå‘Šè­¦ä¿¡æ¯æ¨é€åˆ°æ¥æ”¶äººï¼Œæ–¹ä¾¿å‘Šè­¦çš„åŠæ—¶å¤„ç†ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;å¾®ä¿¡ä¼ä¸šå·éœ€è¦å…ˆåœ¨ä¼ä¸šé€šä¿¡å½•æ–°å»ºè¯¥å‘˜å·¥ï¼Œè¯¥å‘˜å·¥æ‰èƒ½å…³æ³¨è¯¥ä¼ä¸šå·ï¼Œè¿™æ ·å°±èƒ½å®ç°å‘Šè­¦ä¿¡æ¯çš„ç§å¯†æ€§ã€‚å¦‚æœä½¿ç”¨å…¬ä¼—å·ï¼Œåˆ™åªè¦æ‰€æœ‰å…³æ³¨äº†è¯¥å…¬ä¼—å·çš„äººéƒ½èƒ½æ”¶åˆ°å‘Šè­¦æ¶ˆæ¯ï¼Œå®¹æ˜“é€ æˆä¿¡æ¯æ³„éœ²ã€‚è€Œä¸”å‘˜å·¥æ•°å°‘äº200äººçš„ä¼ä¸šå·æ˜¯ä¸ç”¨é’±çš„ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ç”³è¯·é™åˆ¶.</p><h3 id="1ã€è„šæœ¬å­˜æ”¾ç›®å½•"><a href="#1ã€è„šæœ¬å­˜æ”¾ç›®å½•" class="headerlink" title="1ã€è„šæœ¬å­˜æ”¾ç›®å½•"></a>1ã€è„šæœ¬å­˜æ”¾ç›®å½•</h3><p>/usr/lib/zabbix/alertscriptsï¼Œè„šæœ¬çš„æƒé™æ˜¯zabbix è´¦æˆ·ï¼Œå…·æœ‰å¯æ‰§è¡Œæƒé™</p><a id="more"></a><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat wechat.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/python2.7</span></span><br><span class="line"><span class="comment">#_*_coding:utf-8 _*_</span></span><br><span class="line"><span class="built_in">import</span> requests,sys,json</span><br><span class="line"><span class="built_in">import</span> urllib3</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding('utf-<span class="number">8</span>')</span><br><span class="line">def GetToken(Corpid,Secret):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/gettoken"</span></span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"corpid"</span>:Corpid,</span><br><span class="line">        <span class="string">"corpsecret"</span>:Secret</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.get(<span class="attr">url=Url,params=Data,verify=False)</span></span><br><span class="line">    <span class="attr">Token</span> = r.json()['access_token']</span><br><span class="line">    return Token</span><br><span class="line">def SendMessage(Token,User,Agentid,Subject,Content):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s"</span> % Token</span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"touser"</span>: User,                                 <span class="comment"># ä¼ä¸šå·ä¸­çš„ç”¨æˆ·å¸å·ï¼Œåœ¨zabbixç”¨æˆ·Mediaä¸­é…ç½®ï¼Œå¦‚æœé…ç½®ä¸æ­£å¸¸ï¼Œå°†æŒ‰éƒ¨é—¨å‘é€ã€‚</span></span><br><span class="line">        <span class="comment">#"totag": Tagid,                                # ä¼ä¸šå·ä¸­çš„æ ‡ç­¾idï¼Œç¾¤å‘ä½¿ç”¨ï¼ˆæ¨èï¼‰</span></span><br><span class="line">        <span class="string">"toparty"</span>: <span class="string">"2"</span>,                            <span class="comment"># ä¼ä¸šå·ä¸­çš„éƒ¨é—¨idï¼Œç¾¤å‘æ—¶ä½¿ç”¨ã€‚</span></span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,                              <span class="comment"># æ¶ˆæ¯ç±»å‹ã€‚</span></span><br><span class="line">        <span class="string">"agentid"</span>: Agentid,                             <span class="comment"># ä¼ä¸šå·ä¸­çš„åº”ç”¨idã€‚</span></span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: Subject + '\n' + Content</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"safe"</span>: <span class="string">"0"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.post(<span class="attr">url=Url,data=json.dumps(Data),verify=False)</span></span><br><span class="line">    return r.text</span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == '__main__':</span><br><span class="line">    <span class="attr">User</span> = sys.argv[<span class="number">1</span>]                                                              <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Subject</span> = sys.argv[<span class="number">2</span>]                                                           <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Content</span> = sys.argv[<span class="number">3</span>]                                                           <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Corpid</span> = <span class="string">"wwa9c9999"</span>                                                   <span class="comment"># CorpIDæ˜¯ä¼ä¸šå·çš„æ ‡è¯†</span></span><br><span class="line">    <span class="attr">Secret</span> = <span class="string">"VGbZvXJ5RiLskdksh2dkhaskdu92uihsjdhjksadh"</span>     <span class="comment"># Secretæ˜¯ç®¡ç†ç»„å‡­è¯å¯†é’¥</span></span><br><span class="line">    <span class="comment">#Tagid = "1"                                                                     # é€šè®¯å½•æ ‡ç­¾ID</span></span><br><span class="line">    <span class="attr">Agentid</span> = <span class="string">"1000001"</span>                                                                   <span class="comment"># åº”ç”¨ID</span></span><br><span class="line">    <span class="comment">#Partyid = "1"                                                                  # éƒ¨é—¨ID</span></span><br><span class="line">    <span class="attr">Token</span> = GetToken(Corpid, Secret)</span><br><span class="line">    <span class="attr">Status</span> = SendMessage(Token,User,Agentid,Subject,Content)</span><br><span class="line">    print Status</span><br></pre></td></tr></table></figure><h3 id="2ã€é‡è¦å‚æ•°ä»‹ç»"><a href="#2ã€é‡è¦å‚æ•°ä»‹ç»" class="headerlink" title="2ã€é‡è¦å‚æ•°ä»‹ç»"></a>2ã€é‡è¦å‚æ•°ä»‹ç»</h3><ul><li>topartyï¼šâ€2â€ è¿™ä¸ªå‚æ•°æ˜¯åœ¨ä¼ä¸šå¾®ä¿¡é‡Œé¢éƒ¨é—¨çš„id</li><li>Corpidï¼šä¼ä¸šçš„CorpIDæ ‡ç¤º</li><li>Secretï¼šç®¡ç†ç»„çš„å¯†é’¥å‡­è¯</li><li>Agentidï¼šæ–°å»ºåº”ç”¨çš„id</li><li>åªéœ€è¦æ±‚ä¿®æ”¹ä»¥ä¸Šå‚æ•°å³å¯</li></ul><p><img src="https://img.xxlaila.cn/image2018-8-23_16-8-30.png" alt="img"></p><ul><li>ä»¥ä¸Šéƒ¨é—¨æ²¡æœ‰æ–°å»ºï¼Œåªæ˜¯åœ¨è¿™ä¸ªåº”ç”¨ä¸­æ–°å¢åŠ äº†å‡ ä¸ªç”¨æˆ·ã€‚æœ€å¥½çš„æ–¹å¼æ˜¯å¢åŠ ä¸€ä¸ªéƒ¨é—¨ç»„ï¼Œç”¨æˆ·æ·»åŠ åˆ°éƒ¨é—¨ç»„é‡Œé¢ï¼Œè¿™ç§æ–¹å¼æœ€ç§‘å­¦</li></ul><h3 id="3ã€ç™»é™†zabbix-è¿›è¡Œé…ç½®"><a href="#3ã€ç™»é™†zabbix-è¿›è¡Œé…ç½®" class="headerlink" title="3ã€ç™»é™†zabbix è¿›è¡Œé…ç½®"></a>3ã€ç™»é™†zabbix è¿›è¡Œé…ç½®</h3><h4 id="3-1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹"><a href="#3-1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹" class="headerlink" title="3.1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹"></a>3.1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-11-59.png" alt="img"></p><h4 id="3-2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«"><a href="#3-2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«" class="headerlink" title="3.2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«"></a>3.2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-12-53.png" alt="img"><br><img src="https://img.xxlaila.cn/image2018-8-23_16-13-9.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME}æ•…éšœ!</p><p>å‘Šè­¦ä¸»æœº:{HOST.NAME}<br>å‘Šè­¦åœ°å€:{HOST.IP}<br>ç›‘æ§é¡¹ç›®:{ITEM.NAME}<br>ç›‘æ§å–å€¼:{ITEM.LASTVALUE}<br>å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY}<br>å½“å‰çŠ¶æ€:{TRIGGER.STATUS}<br>å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME}<br>å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME}<br>äº‹ä»¶ID:{EVENT.ID}</p></blockquote><p><img src="https://img.xxlaila.cn/image2018-8-23_16-13-20.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME}å·²æ¢å¤!</p><p>å‘Šè­¦ä¸»æœº:{HOST.NAME}<br>å‘Šè­¦åœ°å€:{HOST.IP}<br>ç›‘æ§é¡¹ç›®:{ITEM.NAME}<br>ç›‘æ§å–å€¼:{ITEM.LASTVALUE}<br>å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY}<br>å½“å‰çŠ¶æ€:{TRIGGER.STATUS}<br>å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME}<br>å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME}<br>æ¢å¤æ—¶é—´:{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}<br>æŒç»­æ—¶é—´:{EVENT.AGE}<br>äº‹ä»¶ID:{EVENT.ID}</p></blockquote><p><img src="https://img.xxlaila.cn/image2018-8-23_16-13-28.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}: æŠ¥è­¦ç¡®è®¤</p><p>ç¡®è®¤äºº:{USER.FULLNAME}<br>æ—¶é—´:{ACK.DATE} {ACK.TIME}<br>ç¡®è®¤ä¿¡æ¯å¦‚ä¸‹:<br>â€œ{ACK.MESSAGE}â€<br>é—®é¢˜æœåŠ¡å™¨IP:{HOSTNAME1}<br>é—®é¢˜ID:{EVENT.ID}<br>å½“å‰çš„é—®é¢˜æ˜¯: {TRIGGER.NAME}</p></blockquote><h4 id="3-3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹"><a href="#3-3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹" class="headerlink" title="3.3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹"></a>3.3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-21-58.png" alt="img"><br>è¿™é‡Œä¸ºadminç”¨æˆ·æ·»åŠ çš„ å‘Šè­¦æ–¹å¼ã€‚æ³¨æ„ä¸€ä¸‹send to è¿™ä¸ªå‚æ•°ï¼Œè¿™é‡Œä¸€å®šè¦æ˜¯@allã€‚å¦åˆ™ä¸æˆåŠŸ</p><h3 id="4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•"><a href="#4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•" class="headerlink" title="4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•"></a>4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•</h3><p><img src="https://img.xxlaila.cn/image2018-8-23_16-23-14.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
      </tags>
  </entry>
  <entry>
    <title>å¸§ä¸­ç»§é…ç½®</title>
    <url>/2019/08/19/%E5%B8%A7%E4%B8%AD%E7%BB%A7%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="ç‚¹å¯¹ç‚¹é…ç½®"><a href="#ç‚¹å¯¹ç‚¹é…ç½®" class="headerlink" title="ç‚¹å¯¹ç‚¹é…ç½®"></a>ç‚¹å¯¹ç‚¹é…ç½®</h3><p><img src="https://img.xxlaila.cn/1566222269423.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">102</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li></ul><a id="more"></a><ul><li>FRAME-RELAYé…ç½®:<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching                 å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>pvc 201<span class="built_in"> interface </span>s0/0 102    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰"><a href="#ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰" class="headerlink" title="ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰"></a>ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222529208.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">102</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">103</span>                 </span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">103</span>  </span><br><span class="line">[RA-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>     é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCI</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">301</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">301</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching      å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰"><a href="#ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰" class="headerlink" title="ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰"></a>ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222807499.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA]int s0/<span class="number">0.1</span> multipoint</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">102</span>     è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">103</span>                 </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">103</span>  </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">301</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">301</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>    é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                    æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching    å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰"><a href="#ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰" class="headerlink" title="ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰"></a>ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222918549.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span> </span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh               æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RA]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">102</span>        è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·              </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br><span class="line">[RA]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RA-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">103</span>        è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·              </span><br><span class="line">[RA-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">103</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.2</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>    é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RB-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                   æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RB]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RB-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">201</span>     è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·             </span><br><span class="line">[RB-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>     é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RB-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">203</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·             </span><br><span class="line">[RB-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">203</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.3</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RC-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RC]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RC-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">301</span>         è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·                </span><br><span class="line">[RC-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.3</span><span class="number">.1</span> <span class="number">301</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.3</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RC-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">302</span>         è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·                </span><br><span class="line">[RC-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.2</span><span class="number">.1</span> <span class="number">302</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.2</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching                 å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201     é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301     é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay           å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>pvc 203<span class="built_in"> interface </span>s0/0 302    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay           å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>302<span class="built_in"> interface </span>s0/0 203    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>å¸§ä¸­ç»§</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes ci/cd(ä¸€)</title>
    <url>/2019/08/12/kubernetes-ci-cd-%E4%B8%80/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><blockquote><p>åŸºäºjenkinsçš„CI/CDå®‰è£…</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jenkinsä¸€ä¸ªæµè¡Œçš„æŒç»­é›†æˆ/å‘å¸ƒå·¥å…·ï¼Œåœ¨Kubernetesä½¿ç”¨,æŒç»­æ„å»ºä¸å‘å¸ƒæ˜¯æˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ­¥éª¤ï¼Œç›®å‰å¤§å¤šå…¬å¸éƒ½é‡‡ç”¨ Jenkins é›†ç¾¤æ¥æ­å»ºç¬¦åˆéœ€æ±‚çš„ CI/CD æµç¨‹ï¼Œç„¶è€Œä¼ ç»Ÿçš„ Jenkins Slave ä¸€ä¸»å¤šä»æ–¹å¼ä¼šå­˜åœ¨ä¸€äº›ç—›ç‚¹ï¼Œæ¯”å¦‚ï¼šä¸» Master å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ï¼Œæ•´ä¸ªæµç¨‹éƒ½ä¸å¯ç”¨äº†ï¼›æ¯ä¸ª Slave çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²ï¼›èµ„æºåˆ†é…ä¸å‡è¡¡ï¼Œæœ‰çš„ Slave è¦è¿è¡Œçš„ job å‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„ Slave å¤„äºç©ºé—²çŠ¶æ€ï¼›æœ€åèµ„æºæœ‰æµªè´¹ï¼Œæ¯å° Slave å¯èƒ½æ˜¯å®ä½“æœºæˆ–è€… VMï¼Œå½“ Slave å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æºã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æåˆ°åŸºäºKuberneteçš„CI/CDï¼Œå¯ä»¥ä½¿ç”¨çš„å·¥å…·æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚Jenkinsã€Gitlab CIå·²ç»æ–°å…´çš„droneä¹‹ç±»çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä¼šä½¿ç”¨å¤§å®¶æœ€ä¸ºç†Ÿæ‚‰çš„Jeninsæ¥åšCI/CDçš„å·¥å…·ã€‚</p><ul><li>ä¼˜ç‚¹:<ul><li>Jenkins å®‰è£…å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸ç”¨æ€¥ç€å°±å»ä½¿ç”¨ï¼Œæˆ‘ä»¬è¦äº†è§£ä¸‹åœ¨ Kubernetes ç¯å¢ƒä¸‹é¢ä½¿ç”¨ Jenkins æœ‰ä»€ä¹ˆå¥½å¤„ã€‚éƒ½çŸ¥é“æŒç»­æ„å»ºä¸å‘å¸ƒæ˜¯æˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ­¥éª¤ï¼Œç›®å‰å¤§å¤šå…¬å¸éƒ½é‡‡ç”¨ Jenkins é›†ç¾¤æ¥æ­å»ºç¬¦åˆéœ€æ±‚çš„ CI/CD æµç¨‹ï¼Œç„¶è€Œä¼ ç»Ÿçš„ Jenkins Slave ä¸€ä¸»å¤šä»æ–¹å¼ä¼šå­˜åœ¨ä¸€äº›ç—›ç‚¹ï¼Œæ¯”å¦‚:<ul><li>E ä¸» Master å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ï¼Œæ•´ä¸ªæµç¨‹éƒ½ä¸å¯ç”¨äº†ã€‚</li><li>E æ¯ä¸ª Slave çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²ã€‚</li><li>E èµ„æºåˆ†é…ä¸å‡è¡¡ï¼Œæœ‰çš„ Slave è¦è¿è¡Œçš„ job å‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„ Slave å¤„äºç©ºé—²çŠ¶æ€ã€‚</li><li>E èµ„æºæœ‰æµªè´¹ï¼Œæ¯å° Slave å¯èƒ½æ˜¯ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºï¼Œå½“ Slave å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æºã€‚</li></ul></li><li>æ­£å› ä¸ºè¿™äº›ç§ç§ç—›ç‚¹ï¼Œæˆ‘ä»¬æ¸´æœ›ä¸€ç§æ›´é«˜æ•ˆæ›´å¯é çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ª CI/CD æµç¨‹ï¼Œè€Œ Docker è™šæ‹ŸåŒ–å®¹å™¨æŠ€æœ¯èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªç—›ç‚¹ï¼Œåˆç‰¹åˆ«æ˜¯åœ¨ Kubernetes é›†ç¾¤ç¯å¢ƒä¸‹é¢èƒ½å¤Ÿæ›´å¥½æ¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä¸‹å›¾æ˜¯åŸºäº Kubernetes æ­å»º Jenkins é›†ç¾¤çš„ç®€å•ç¤ºæ„å›¾<br><img src="https://img.xxlaila.cn/xjfhs84we.png" alt="img"></li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ° Jenkins Master å’Œ Jenkins Slave ä»¥ Pod å½¢å¼è¿è¡Œåœ¨ Kubernetes é›†ç¾¤çš„ Node ä¸Šï¼ŒMaster è¿è¡Œåœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†å…¶é…ç½®æ•°æ®å­˜å‚¨åˆ°ä¸€ä¸ª Volume ä¸Šå»ï¼ŒSlave è¿è¡Œåœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”å®ƒä¸æ˜¯ä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå®ƒä¼šæŒ‰ç…§éœ€æ±‚åŠ¨æ€çš„åˆ›å»ºå¹¶è‡ªåŠ¨åˆ é™¤ã€‚</p><a id="more"></a><ul><li>è¿™ç§æ–¹å¼çš„å·¥ä½œæµç¨‹å¤§è‡´ä¸º<ul><li>å½“ Jenkins Master æ¥å—åˆ° Build è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®é…ç½®çš„ Label åŠ¨æ€åˆ›å»ºä¸€ä¸ªè¿è¡Œåœ¨ Pod ä¸­çš„ Jenkins Slave å¹¶æ³¨å†Œåˆ° Master ä¸Šï¼Œå½“è¿è¡Œå®Œ Job åï¼Œè¿™ä¸ª Slave ä¼šè¢«æ³¨é”€å¹¶ä¸”è¿™ä¸ª Pod ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤ï¼Œæ¢å¤åˆ°æœ€åˆçŠ¶æ€ã€‚é‚£ä¹ˆä½¿ç”¨è¿™ç§æ–¹å¼å¸¦æ¥äº†å“ªäº›å¥½å¤„å‘¢ï¼Ÿ</li><li>E æœåŠ¡é«˜å¯ç”¨ï¼Œå½“ Jenkins Master å‡ºç°æ•…éšœæ—¶ï¼ŒKubernetes ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Jenkins Master å®¹å™¨ï¼Œå¹¶ä¸”å°† Volume åˆ†é…ç»™æ–°åˆ›å»ºçš„å®¹å™¨ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä»è€Œè¾¾åˆ°é›†ç¾¤æœåŠ¡é«˜å¯ç”¨ã€‚</li><li>E åŠ¨æ€ä¼¸ç¼©ï¼Œåˆç†ä½¿ç”¨èµ„æºï¼Œæ¯æ¬¡è¿è¡Œ Job æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Jenkins Slaveï¼ŒJob å®Œæˆåï¼ŒSlave è‡ªåŠ¨æ³¨é”€å¹¶åˆ é™¤å®¹å™¨ï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸” Kubernetes ä¼šæ ¹æ®æ¯ä¸ªèµ„æºçš„ä½¿ç”¨æƒ…å†µï¼ŒåŠ¨æ€åˆ†é… Slave åˆ°ç©ºé—²çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œé™ä½å‡ºç°å› æŸèŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œè¿˜æ’é˜Ÿç­‰å¾…åœ¨è¯¥èŠ‚ç‚¹çš„æƒ…å†µã€‚</li><li>E æ‰©å±•æ€§å¥½ï¼Œå½“ Kubernetes é›†ç¾¤çš„èµ„æºä¸¥é‡ä¸è¶³è€Œå¯¼è‡´ Job æ’é˜Ÿç­‰å¾…æ—¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„æ·»åŠ ä¸€ä¸ª Kubernetes Node åˆ°é›†ç¾¤ä¸­ï¼Œä»è€Œå®ç°æ‰©å±•ã€‚</li></ul></li></ul><h2 id="1ã€å®‰è£…jenkins"><a href="#1ã€å®‰è£…jenkins" class="headerlink" title="1ã€å®‰è£…jenkins"></a>1ã€å®‰è£…jenkins</h2><h3 id="1-1ã€æ–°å»ºä¸€ä¸ª-Deployment"><a href="#1-1ã€æ–°å»ºä¸€ä¸ª-Deployment" class="headerlink" title="1.1ã€æ–°å»ºä¸€ä¸ª Deployment"></a>1.1ã€æ–°å»ºä¸€ä¸ª Deployment</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#cat  jenkins-deployment.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">jenkins/jenkins:lts</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">512</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">          subPath:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LIMITS_MEMORY</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">limits.memory</span></span><br><span class="line"><span class="attr">              divisor:</span> <span class="number">1</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="bullet">-Xmx$(LIMITS_MEMORY)m</span> <span class="attr">-XshowSettings:vm</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.initialDelay=0</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN=50</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN0=0.85</span> <span class="bullet">-Duser.timezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">        persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">          claimName:</span> <span class="string">opspvc</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30002</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">agent</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å¯¹è±¡èµ„æºéƒ½æ”¾ç½®åœ¨ä¸€ä¸ªåä¸º kube-ops çš„ namespace ä¸‹é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ åˆ›å»ºä¸€ä¸ª namespace,namespace è¯·å‚è€ƒnamspaceç« èŠ‚çš„å…·ä½“ä»‹ç»</p><figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line"># kubectl <span class="keyword">create</span> <span class="keyword">namespace</span> kube-ops</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä½¿ç”¨ä¸€ä¸ªåä¸º jenkins/jenkins:lts çš„å®˜æ–¹é•œåƒï¼Œè¿™æ˜¯ jenkins å®˜æ–¹çš„ Docker é•œåƒï¼Œç„¶åä¹Ÿæœ‰ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å®šåˆ¶ä¸€ä¸ªé•œåƒï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å°†ä¸€äº›æ’ä»¶æ‰“åŒ…åœ¨è‡ªå®šä¹‰çš„é•œåƒå½“ä¸­ï¼Œ<a href="https://github.com/jenkinsci/docker" target="_blank" rel="noopener">å¯ä»¥å‚è€ƒæ–‡æ¡£</a>ã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨é»˜è®¤çš„å®˜æ–¹é•œåƒå°±è¡Œï¼Œå¦å¤–ä¸€ä¸ªè¿˜éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å°†å®¹å™¨çš„ /var/jenkins_home ç›®å½•æŒ‚è½½åˆ°äº†ä¸€ä¸ªåä¸º opspvc çš„ PVC å¯¹è±¡ä¸Šé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ ·è¿˜å¾—æå‰åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ PVC å¯¹è±¡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ä»¬å‰é¢çš„ StorageClass å¯¹è±¡æ¥è‡ªåŠ¨åˆ›å»ºï¼š(jenkins-pvc.yaml)</p><h3 id="1-2-Jenkins-StorageClass-åˆ›å»º"><a href="#1-2-Jenkins-StorageClass-åˆ›å»º" class="headerlink" title="1.2 Jenkins StorageClass åˆ›å»º"></a>1.2 Jenkins StorageClass åˆ›å»º</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">opspv</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">172.21</span><span class="number">.16</span><span class="number">.231</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/jenkins</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">opspvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºpvcå¯¹è±¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-pvc.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–è¿™é‡Œè¿˜éœ€è¦ä½¿ç”¨åˆ°ä¸€ä¸ªæ‹¥æœ‰ç›¸å…³æƒé™çš„ serviceAccountï¼šjenkins2ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ç»™jenkins èµ‹äºˆäº†ä¸€äº›å¿…è¦çš„æƒé™ï¼Œå½“ç„¶å¦‚æœä½ å¯¹ serviceAccount çš„æƒé™ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯ï¼Œæˆ‘ä»¬ç»™è¿™ä¸ª sa ç»‘å®šä¸€ä¸ª cluster-admin çš„é›†ç¾¤è§’è‰²æƒé™ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå½“ç„¶è¿™æ ·å…·æœ‰ä¸€å®šçš„å®‰å…¨é£é™©ï¼šï¼ˆjenkins-rbac.yamlï¼‰</p><h3 id="1-3-Jenkins-serviceAccount"><a href="#1-3-Jenkins-serviceAccount" class="headerlink" title="1.3 Jenkins serviceAccount"></a>1.3 Jenkins serviceAccount</h3><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cat jenkins-rbac.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> ServiceAccount</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line"><span class="symbol">kind:</span> Role</span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"><span class="symbol">rules:</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"create"</span>,<span class="string">"delete"</span>,<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"patch"</span>,<span class="string">"update"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods/exec"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"create"</span>,<span class="string">"delete"</span>,<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"patch"</span>,<span class="string">"update"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods/log"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"secrets"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"get"</span>]</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="symbol">kind:</span> RoleBinding</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"><span class="symbol">roleRef:</span></span><br><span class="line"><span class="symbol">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="symbol">  kind:</span> Role</span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">subjects:</span></span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line"><span class="symbol">    name:</span> jenkins2</span><br><span class="line"><span class="symbol">namespace:</span> kube-ops</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»º rbac ç›¸å…³çš„èµ„æºå¯¹è±¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-rbac.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé€šè¿‡ ingressçš„å½¢å¼æ¥è®¿é—®Jenkins çš„ web æœåŠ¡ï¼ŒJenkins æœåŠ¡ç«¯å£ä¸º8080ï¼Œ50000 ç«¯å£ä¸ºagentï¼Œè¿™ä¸ªç«¯å£ä¸»è¦æ˜¯ç”¨äº Jenkins çš„ master å’Œ slave ä¹‹é—´é€šä¿¡ä½¿ç”¨çš„ã€‚(jenkins-ingress.yaml)</p><h3 id="1-4-Jenkins-å¯¹å¤–æä¾›è®¿é—®"><a href="#1-4-Jenkins-å¯¹å¤–æä¾›è®¿é—®" class="headerlink" title="1.4 Jenkins å¯¹å¤–æä¾›è®¿é—®"></a>1.4 Jenkins å¯¹å¤–æä¾›è®¿é—®</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">ci.xxlaila.cn</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»º Jenkins æœåŠ¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-deployment.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>åˆ›å»ºå®Œæˆådockeå›å»æ‹‰å»é•œåƒï¼Œéœ€è¦ç­‰å¾…ä¸€ä¼šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹jenkinsæ˜¯å¦éƒ¨ç½²æˆåŠŸ</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># kubectl <span class="keyword">get</span> pods -n kube-ops</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">jenkins2<span class="number">-84f</span>476cbb-vz4b2   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d19h</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å®Œæˆä»¥åæˆ‘ä¹ˆå¯ä»¥é€šè¿‡åœ¨jenkins-ingress.yamlé‡Œé¢ç»‘å®šè¿‡çš„åŸŸåè¿›è¡Œè®¿é—®ï¼Œç„¶åè¿›è¡Œå®‰è£…é…ç½®ï¼š<br><img src="https://img.xxlaila.cn/sfdsfdsf38432.png" alt="img"></p><blockquote><p>åˆå§‹åŒ–çš„å¯†ç æˆ‘ä»¬å¯ä»¥åœ¨ jenkins çš„å®¹å™¨çš„æ—¥å¿—ä¸­è¿›è¡ŒæŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ nfs çš„å…±äº«æ•°æ®ç›®å½•ä¸­æŸ¥çœ‹</p><p>$ cat /data/jenkins/jenkins2/secrets/initialAdminPassword</p></blockquote><p>å®Œæˆé…ç½®ï¼Œå°±å¯ä»¥åˆ°jenkinsçš„ç•Œé¢ï¼Œå°±å’Œæˆ‘ä»¬åœ¨vmä¸‹å®‰è£…çš„jenkinsæ²¡æœ‰ä»»ä½•çš„åŒºåˆ«ã€‚<br><img src="https://img.xxlaila.cn/isdy823723894324.png" alt="img"></p><h2 id="2-é…ç½®jenkins"><a href="#2-é…ç½®jenkins" class="headerlink" title="2 é…ç½®jenkins"></a>2 é…ç½®jenkins</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ¥é…ç½® Jenkinsï¼Œè®©ä»–èƒ½å¤ŸåŠ¨æ€çš„ç”Ÿæˆ Slave çš„ Podï¼Œå®‰è£…jenkinsçš„æ’ä»¶æ¸…å•</p><p><code>Kubernetes This plugin integrates Jenkins with Kubernetes</code><br>2.1 Kuberneteså’ŒJenkinsçš„ç»“åˆ<br>&nbsp;&nbsp;&nbsp;&nbsp;ç‚¹å‡» ç³»ç»Ÿç®¡ç†(Manage Jenkins) â€”&gt; ç³»ç»Ÿé…ç½®(Configure System) â€”&gt; (æ‹–åˆ°æœ€ä¸‹æ–¹)Add a new cloud â€”&gt; é€‰æ‹© Kubernetesï¼Œç„¶åå¡«å†™ Kubernetes å’Œ Jenkins é…ç½®ä¿¡æ¯ã€‚</p><p><img src="https://img.xxlaila.cn/di32sdsf.png" alt="img"></p><blockquote><p>æ³¨æ„ namespaceï¼Œæˆ‘ä»¬è¿™é‡Œå¡« kube-opsï¼Œç„¶åç‚¹å‡»Test Connectionï¼Œå¦‚æœå‡ºç° Connection test successful çš„æç¤ºä¿¡æ¯è¯æ˜Jenkins å·²ç»å¯ä»¥å’Œ Kubernetes ç³»ç»Ÿæ­£å¸¸é€šä¿¡äº†ï¼Œç„¶åä¸‹æ–¹çš„ Jenkins URL åœ°å€ï¼š<a href="http://jenkins2.kube-ops.svc.cluster.local:8080ï¼Œè¿™é‡Œçš„æ ¼å¼ä¸ºæœåŠ¡å.namespace.svc.cluster.local:8080ï¼Œæ ¹æ®ä¸Šé¢åˆ›å»ºçš„jenkinsçš„æœåŠ¡åå¡«å†™ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¹‹å‰åˆ›å»ºçš„åä¸ºjenkinsï¼Œå¦‚æœæ˜¯ç”¨ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å°±åº”è¯¥æ˜¯jenkins2" target="_blank" rel="noopener">http://jenkins2.kube-ops.svc.cluster.local:8080ï¼Œè¿™é‡Œçš„æ ¼å¼ä¸ºæœåŠ¡å.namespace.svc.cluster.local:8080ï¼Œæ ¹æ®ä¸Šé¢åˆ›å»ºçš„jenkinsçš„æœåŠ¡åå¡«å†™ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¹‹å‰åˆ›å»ºçš„åä¸ºjenkinsï¼Œå¦‚æœæ˜¯ç”¨ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å°±åº”è¯¥æ˜¯jenkins2</a></p></blockquote><h3 id="2-2ã€é…ç½®-Pod-Template"><a href="#2-2ã€é…ç½®-Pod-Template" class="headerlink" title="2.2ã€é…ç½® Pod Template"></a>2.2ã€é…ç½® Pod Template</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;é…ç½® Jenkins Slave è¿è¡Œçš„ Pod æ¨¡æ¿ï¼Œå‘½åç©ºé—´æˆ‘ä»¬åŒæ ·æ˜¯ç”¨kube-opsï¼ŒLabels è¿™é‡Œä¹Ÿéå¸¸é‡è¦ï¼Œå¯¹äºåé¢æ‰§è¡Œ Job çš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥å€¼ï¼Œç„¶åæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ cnych/jenkins:jnlp è¿™ä¸ªé•œåƒï¼Œè¿™ä¸ªé•œåƒæ˜¯åœ¨å®˜æ–¹çš„ jnlp é•œåƒåŸºç¡€ä¸Šå®šåˆ¶çš„ï¼ŒåŠ å…¥äº† kubectl ç­‰ä¸€äº›å®ç”¨çš„å·¥å…·ã€‚<br><img src="https://img.xxlaila.cn/897kdfhgdkjb4.png" alt="img"><br><img src="https://img.xxlaila.cn/kjgsadsad8234632.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–éœ€è¦æ³¨æ„æˆ‘ä»¬è¿™é‡Œéœ€è¦åœ¨ä¸‹é¢æŒ‚è½½ä¸€ä¸ªä¸»æœºç›®å½•ï¼Œä¸€ä¸ªæ˜¯ /var/run/docker.sockï¼Œè¯¥æ–‡ä»¶æ˜¯ç”¨äº Pod ä¸­çš„å®¹å™¨èƒ½å¤Ÿå…±äº«å®¿ä¸»æœºçš„ Dockerï¼Œè¿™å°±æ˜¯è¯´çš„ docker in docker çš„æ–¹å¼ï¼ŒDocker äºŒè¿›åˆ¶æ–‡ä»¶æˆ‘ä»¬å·²ç»æ‰“åŒ…åˆ°ä¸Šé¢çš„é•œåƒä¸­äº†ã€‚å¦‚æœåœ¨slave agentä¸­æƒ³è¦è®¿é—®kubernetes é›†ç¾¤ä¸­å…¶ä»–èµ„æºï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»‘å®šä¹‹å‰åˆ›å»ºçš„Service Account è´¦å·:jenkins2</p><p><img src="https://img.xxlaila.cn/khsdif28734knsdfkds.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–è¿˜æœ‰å‡ ä¸ªå‚æ•°éœ€è¦æ³¨æ„ï¼Œä¸Šå›¾æœ‰ä¸€ä¸ªpodå¯¿å‘½ä»£ç†çš„ç©ºé—²å­˜æ´»æ—¶é—´ï¼ˆåˆ†ï¼‰ï¼Œæ„æ€æ˜¯å½“å¤„äºç©ºé—²çŠ¶æ€çš„æ—¶å€™ä¿ç•™ Slave Podå¤šé•¿æ—¶é—´ï¼Œè¿™ä¸ªå‚æ•°æœ€å¥½æˆ‘ä»¬ä¿å­˜é»˜è®¤å°±è¡Œäº†ï¼Œå¦‚æœä½ è®¾ç½®è¿‡å¤§çš„è¯ï¼ŒJob ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå¯¹åº”çš„ Slave Pod å°±ä¸ä¼šç«‹å³è¢«é”€æ¯åˆ é™¤ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬çš„ Kubernetes Pluginæ’ä»¶å°±ç®—é…ç½®å®Œæˆäº†</p><h3 id="2-3-Jenkins-æµ‹è¯•"><a href="#2-3-Jenkins-æµ‹è¯•" class="headerlink" title="2.3 Jenkins æµ‹è¯•"></a>2.3 Jenkins æµ‹è¯•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes æ’ä»¶çš„é…ç½®å·¥ä½œå®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ·»åŠ ä¸€ä¸ª Job ä»»åŠ¡ï¼Œçœ‹æ˜¯å¦èƒ½å¤Ÿåœ¨ Slave Pod ä¸­æ‰§è¡Œï¼Œä»»åŠ¡æ‰§è¡Œå®Œæˆåçœ‹ Pod æ˜¯å¦ä¼šè¢«é”€æ¯åœ¨ Jenkins é¦–é¡µç‚¹å‡»create new jobsï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•çš„ä»»åŠ¡ï¼Œè¾“å…¥ä»»åŠ¡åç§°ï¼Œç„¶åæˆ‘ä»¬é€‰æ‹© Freestyle project ç±»å‹çš„ä»»åŠ¡<br>&nbsp;&nbsp;&nbsp;&nbsp;æ–°å»ºä¸€ä¸ªjobä¸ºsimple-testï¼Œå¢åŠ ä¸€ä¸ªshellæ¨¡å—ï¼Œshellæ¨¡å—é‡Œé¢å¢åŠ ç®€å•çš„echoæ¥æµ‹è¯•slaveçš„åŠ¨æ€éƒ¨ç½²ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"æµ‹è¯• Kubernetes åŠ¨æ€ç”Ÿæˆ jenkins slave"</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"==============docker in docker==========="</span></span><br><span class="line">docker info</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=============kubectl============="</span></span><br><span class="line">kubectl <span class="built_in">get</span> pods -n kube-<span class="built_in">system</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/s94uskljdslfd.png" alt="img"></p><p>ç°åœ¨æˆ‘ä»¬ç›´æ¥åœ¨é¡µé¢ç‚¹å‡»åšæˆçš„ Build now è§¦å‘æ„å»ºå³å¯ï¼Œç„¶åè§‚å¯Ÿ Kubernetes é›†ç¾¤ä¸­ Pod çš„å˜åŒ–</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl get pods -n kube-ops</span></span><br></pre></td></tr></table></figure><p>Kubernetes ç•Œé¢ä¹Ÿä¼šå‡ºç°jenkins agentçš„è¿›è¡Œpodçš„è¿›è¡Œéƒ¨ç½²ã€‚éƒ¨ç½²å®ŒæˆåéšåŠåˆ é™¤podã€‚</p><p><img src="https://img.xxlaila.cn/sakhd89234klmds.png" alt="img"><br><img src="https://img.xxlaila.cn/nslkfhio3rsd.png" alt="img"></p><h2 id="3ã€Jenkinsé”™è¯¯è§£å†³"><a href="#3ã€Jenkinsé”™è¯¯è§£å†³" class="headerlink" title="3ã€Jenkinsé”™è¯¯è§£å†³"></a>3ã€Jenkinsé”™è¯¯è§£å†³</h2><p>ç¬¬ä¸€æ¬¡å­¦ä¹ å®‰è£…jenkinsè¸©äº†å¾ˆå¤šå‘ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå­¦ä¹ äº†å¾ˆå¤šçš„ï¼Œä¸‹é¢æ˜¯åœ¨k8sä¸Šå®‰è£…jenkinsé‡åˆ°çš„ä¸€äº›é”™è¯¯ï¼š</p><ul><li>æ‰“å¼€jenkinsé¡µé¢çš„æ—¶å€™æç¤ºdnsä¸èƒ½è§£æï¼Œæ´é¢å¦‚ä¸‹å›¾ï¼š</li></ul><p><img src="https://img.xxlaila.cn/skajdh823648uesd.png" alt="img"></p><ul><li>æŸ¥çœ‹jenkinsçš„æ—¥å¿—æç¤º</li></ul><p><img src="https://img.xxlaila.cn/8243ihkdfnklsads.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¯¼è‡´çš„é—®é¢˜æœ‰httpsã€ç½‘ç»œè¿æ¥ä¸é€šç•…ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å§httpsä¿®æ”¹ä¸ºhttpï¼Œéœ€è¦ä¿®æ”¹jenkinsçš„é…ç½®æ–‡ä»¶ã€‚ç„¶åå†é‡æ–°å»ºç«‹jenkinsçš„podã€‚è¿›å…¥jenkinsçš„ç›®å½•ä¿®æ”¹hudson.model.UpdateCenter.xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">$ cat hudson.model.UpdateCenter.xml</span><br><span class="line"><span class="meta">&lt;?xml version='1.1' encoding='UTF-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sites</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">site</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://updates.jenkins.io/update-center.json<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨åšk8sçš„æ—¶å€™ä¸€å®šè¦ç”¨è¯ä¹¦ï¼Œä¸ç„¶åæœŸåœ¨åšå„ç§æœåŠ¡çš„æ—¶å€™éƒ½ä¼šé‡åˆ°é”™è¯¯ï¼Œå› ä¸ºdockeré»˜è®¤å»ç§æœ‰registoryè¦httpsï¼Œkuber-apiè¦httpsã€‚å½“ç„¶æ²¡æœ‰ä½¿ç”¨httpséƒ½å¯ä»¥æ¢æˆhttpï¼Œåœ¨æ¬¡é‡æ–°éƒ¨ç½²jenkinsä»¥åæç¤ºç³»åˆ—ä¿¡æ¯ã€‚è®¿é—®ç›®å½•æ²¡æœ‰æƒé™ã€‚</p><p><img src="https://img.xxlaila.cn/2864jksfhjdsh.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿›å…¥nfsç›®å½•ï¼Œéœ€è¦ä¿®æ”¹ä¸‹ç›®å½•æƒé™, å› ä¸ºå½“æ˜ å°„æœ¬åœ°æ•°æ®å·æ—¶ï¼Œ/home/docker/jenkinsç›®å½•çš„æ‹¥æœ‰è€…ä¸ºrootç”¨æˆ·ï¼Œè€Œå®¹å™¨ä¸­jenkins userçš„uidä¸º1000</p><p><code>$ sudo chown -R 1000:1000 /data/jenkins</code></p><blockquote><p>è¿™é‡Œå§httpsè§£å†³äº†è¿˜æ˜¯é‡åˆ°æç¤ºç½‘ç»œä¸é€šã€‚ä¸‹å›¾</p></blockquote><p><img src="https://img.xxlaila.cn/xnks94uoildsfs.png" alt="img"></p><blockquote><p>è¿™é‡Œæ˜¯dnsçš„ä¸èƒ½è§£æçš„é—®é¢˜ï¼Œä»¥ä¸‹æ’é”™æ€è·¯ï¼šç™»é™†jenkinsçš„å®¹å™¨é‡Œé¢æŸ¥çœ‹è·¯ç”±æ˜¯å¦æ­£ç¡®</p></blockquote><p><img src="https://img.xxlaila.cn/382468365324.png" alt="img"></p><blockquote><p>ç„¶ååœ¨ç¡®è®¤å®¹å™¨æ˜¯å¦å¯ä»¥è”é€šå¤–ç½‘ï¼Œè¿˜æ˜¯dnsä¸èƒ½è§£æ<br><img src="https://img.xxlaila.cn/fnijwy4nkdsfkhdsf.png" alt="img"></p></blockquote><blockquote><p>è¿™é‡Œping 114æ²¡æœ‰é—®é¢˜ï¼ŒpingåŸŸåä¸èƒ½è§£æï¼Œè¯´æ˜æ˜¯dnsè§£ææœ‰é—®é¢˜ã€‚æ¥ç€æˆ‘ä»¬åœ¨æŸ¥çœ‹å®¹å™¨çš„dnsé…ç½®</p></blockquote><p><img src="https://img.xxlaila.cn/dkjfsg328943242.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæ˜¯dnsé—®é¢˜ã€‚è¿™é‡Œä¸é˜è¿°dnsï¼Œå‚è€ƒç¬¬äºŒç« k8s dns,jenkins åœ¨æ‰§è¡Œç¼–è¯‘çš„æ—¶å€™æç¤º: <code>â€˜Jenkinsâ€™ doesnâ€™t have label â€˜jnlp-agentâ€™</code>,åœ¨ç³»ç»Ÿé…ç½®é…ç½®é‡Œé¢è¿›è¡Œæµ‹è¯•è¿æ¥k8s çš„apiæç¤ºå¦‚ä¸‹é”™è¯¯</p><p><img src="https://img.xxlaila.cn/324768ksdjsfhds.png" alt="img"></p><ul><li>æ·»åŠ jenkinsçš„secretè®¤è¯</li></ul><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"># kubectl get secret  -<span class="keyword">n</span> kube-ops</span><br><span class="line">NAME                     <span class="keyword">TYPE</span>                                  DATA   AGE</span><br><span class="line">default-<span class="keyword">token</span>-4gzkv      kubernetes.io/service-account-<span class="keyword">token</span>   3      13d</span><br><span class="line">jenkins2-<span class="keyword">token</span>-mjnw4     kubernetes.io/service-account-<span class="keyword">token</span>   3      14m</span><br><span class="line">prometheus-<span class="keyword">token</span>-84p87   kubernetes.io/service-account-<span class="keyword">token</span>   3      13d</span><br><span class="line"># kubectl <span class="keyword">describe</span> secret jenkins2-<span class="keyword">token</span>-mjnw4 -<span class="keyword">n</span> kube-ops</span><br><span class="line">Name:         jenkins2-<span class="keyword">token</span>-mjnw4</span><br><span class="line">Namespace:    kube-ops</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: jenkins2</span><br><span class="line">              kubernetes.io/service-account.uid: ffced652-2f6c-11e9-98a4-fa163e14c5bd</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span>:  kubernetes.io/service-account-<span class="keyword">token</span></span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line"><span class="keyword">ca</span>.crt:     1025 bytes</span><br><span class="line">namespace:  8 bytes</span><br><span class="line"><span class="keyword">token</span>:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLW9wcyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJqZW5raW5zMi10b2tlbi1tam53NCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJqZW5raW5zMiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImZmY2VkNjUyLTJmNmMtMTFlOS05OGE0LWZhMTYzZTE0YzViZCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLW9wczpqZW5raW5zMiJ9.PlPvO_AST4Q6tJJ2i2zGFfufFN1xjWLlHZ5ipTK0aU5CdR49OAropPQhQ0TjLRWf4Z66h847g28OCABmxO1cSG_-8UpwVsohFROTCOjx9Ka3KACmaIkw9Bvihm_lPQlaLykdyXxVDrfI6TobtG0Y5KnKPFj8CjkIFPk5ewTKpOm5pDKVDKu4W_4uOhSnISfLVUvHp8A_ojK_JCVnBBr0Py3UeuEF8vjJES0_yKNxPUtXQq-vkWEZecnAC_x5sfFJTA5aB18sEnxCaeMzgUxzi4IflNxxyVjdZrbq0UdS8llmfnGg5Ur7Zf-lu2ajdOlRdQp6VRPMcQmQaWoHUuoevg</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/2372837934232.png" alt="img"><br><img src="https://img.xxlaila.cn/djfjsr3897493432.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kube nfs åŠ¨æ€å­˜å‚¨</title>
    <url>/2019/08/12/kube-nfs-%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;nfs-client-provisioneræ˜¯ä¸€ä¸ªautomatic provisionerï¼Œä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œè‡ªåŠ¨åˆ›å»ºPVå’Œå¯¹åº”çš„PVCï¼Œæœ¬èº«ä¸æä¾›NFSå­˜å‚¨ï¼Œéœ€è¦å¤–éƒ¨å…ˆæœ‰ä¸€å¥—NFSå­˜å‚¨æœåŠ¡ã€‚</p><ul><li>PVä»¥ ${namespace}-${pvcName}-${pvName}çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">å®˜æ–¹è®¿é—®åœ°å€</a></p><h2 id="1ã€æƒé™ä½“ç³»æ„å»º"><a href="#1ã€æƒé™ä½“ç³»æ„å»º" class="headerlink" title="1ã€æƒé™ä½“ç³»æ„å»º"></a>1ã€æƒé™ä½“ç³»æ„å»º</h2><h3 id="1-1ã€åˆ›å»ºserviceaccount"><a href="#1-1ã€åˆ›å»ºserviceaccount" class="headerlink" title="1.1ã€åˆ›å»ºserviceaccount"></a>1.1ã€åˆ›å»ºserviceaccount</h3><p>ServiceAccountä¹Ÿæ˜¯ä¸€ç§è´¦å·, ä¾›è¿è¡Œåœ¨podä¸­çš„è¿›ç¨‹ä½¿ç”¨, ä¸ºpodä¸­çš„è¿›ç¨‹æä¾›å¿…è¦çš„èº«ä»½è¯æ˜.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat serviceaccount.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: kube-test</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1-2ã€åˆ›å»ºrole"><a href="#1-2ã€åˆ›å»ºrole" class="headerlink" title="1.2ã€åˆ›å»ºrole"></a>1.2ã€åˆ›å»ºrole</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat  clusterrole.yaml</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  namespace: kube-test</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    resources: [<span class="string">"storageclasses"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"events"</span>]</span><br><span class="line">    verbs: [<span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services"</span>, <span class="string">"endpoints"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>,<span class="string">"list"</span>, <span class="string">"watch"</span>,<span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"podsecuritypolicies"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"nfs-client-provisioner"</span>]</span><br><span class="line">    verbs: [<span class="string">"use"</span>]</span><br></pre></td></tr></table></figure><h3 id="1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"><a href="#1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š" class="headerlink" title="1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"></a>1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat clusterrolebinding.yaml </span></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: kube-test</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">æ‰§è¡Œåˆ›å»º</span><br><span class="line">kubectl create -f serviceaccount.yaml -f clusterrole.yaml -f clusterrolebinding.yaml</span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…éƒ¨ç½²"><a href="#2ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="2ã€å®‰è£…éƒ¨ç½²"></a>2ã€å®‰è£…éƒ¨ç½²</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹è½½deployment.yamlæ–‡ä»¶,éœ€è¦ä¿®æ”¹NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ10.10.10.60ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/ifs/kubernetesï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><h3 id="2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"><a href="#2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·" class="headerlink" title="2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"></a>2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·</h3><blockquote><p>æ ¹æ®PVCçš„è¯·æ±‚, åŠ¨æ€åˆ›å»ºPVå­˜å‚¨.</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat deployment.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: quay.io/external_storage/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.21.16.244</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /data</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 10.10.10.60</span><br><span class="line">            path: /ifs/kubernetes</span><br></pre></td></tr></table></figure><pre><code>* ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²class.yaml</code></pre><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´</p><h3 id="2-2ã€åˆ›å»ºstorageclass"><a href="#2-2ã€åˆ›å»ºstorageclass" class="headerlink" title="2.2ã€åˆ›å»ºstorageclass"></a>2.2ã€åˆ›å»ºstorageclass</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat class.yaml</span></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br></pre></td></tr></table></figure><h4 id="2-2-1ã€æŸ¥çœ‹StorageClass"><a href="#2-2-1ã€æŸ¥çœ‹StorageClass" class="headerlink" title="2.2.1ã€æŸ¥çœ‹StorageClass"></a>2.2.1ã€æŸ¥çœ‹StorageClass</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get sc</span></span><br><span class="line"><span class="comment"># kubectl get storageclass</span></span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   19h</span><br></pre></td></tr></table></figure><h4 id="2-2-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"><a href="#2-2-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨" class="headerlink" title="2.2.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"></a>2.2.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨</h4><p>è®¾ç½®è¿™ä¸ªdefaultåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch storageclass managed-nfs-storage -p '&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3ã€æµ‹è¯•åˆ›å»ºPVC"><a href="#2-2-3ã€æµ‹è¯•åˆ›å»ºPVC" class="headerlink" title="2.2.3ã€æµ‹è¯•åˆ›å»ºPVC"></a>2.2.3ã€æµ‹è¯•åˆ›å»ºPVC</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat test-claim.yaml </span></span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-claim</span><br><span class="line">  namespace: kube-test</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br></pre></td></tr></table></figure><h4 id="2-2-4ã€å¯åŠ¨æµ‹è¯•POD"><a href="#2-2-4ã€å¯åŠ¨æµ‹è¯•POD" class="headerlink" title="2.2.4ã€å¯åŠ¨æµ‹è¯•POD"></a>2.2.4ã€å¯åŠ¨æµ‹è¯•POD</h4><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat test-pod.yaml </span></span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-pod</span><br><span class="line">  namespace: kube-test</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: <span class="built_in">test</span>-pod</span><br><span class="line">    image: docker.io/busybox:1.24</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"/bin/sh"</span></span><br><span class="line">    args:</span><br><span class="line">      - <span class="string">"-c"</span></span><br><span class="line">      - <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        mountPath: <span class="string">"/mnt"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: <span class="built_in">test</span>-claim</span><br></pre></td></tr></table></figure><h4 id="2-2-5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ"><a href="#2-2-5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ" class="headerlink" title="2.2.5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ"></a>2.2.5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ</h4><p>å»NFSå…±äº«ç›®å½•æŸ¥çœ‹æœ‰æ²¡æœ‰SUCCESSæ–‡ä»¶<br><img src="https://img.xxlaila.cn/%E6%88%AA%E5%9B%BE.png" alt="img"><br><img src="https://img.xxlaila.cn/8934nsdlsa.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pvc -n kube-test</span></span><br><span class="line">NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line"><span class="built_in">test</span>-claim   Bound    pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd   1Mi        RWX            managed-nfs-storage   20h</span><br></pre></td></tr></table></figure><h3 id="2-3ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"><a href="#2-3ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥" class="headerlink" title="2.3ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"></a>2.3ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥</h3><ul><li><p>æŸ¥çœ‹é›†ç¾¤ä¸­PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch pv pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd -p '&#123;"spec":&#123;"persistentVolumeReclaimPolicy":"Retain"&#125;&#125;'</span></span><br><span class="line">persistentvolume/pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd patched</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ›´æ”¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>pvc pv</title>
    <url>/2019/08/12/pvc-pv/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h2 id="1ã€ä»‹ç»"><a href="#1ã€ä»‹ç»" class="headerlink" title="1ã€ä»‹ç»"></a>1ã€ä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;PersistentVolumeï¼ˆpvï¼‰å’ŒPersistentVolumeClaimï¼ˆpvcï¼‰æ˜¯k8sæä¾›çš„ä¸¤ç§APIèµ„æºï¼Œç”¨äºæŠ½è±¡å­˜å‚¨ç»†èŠ‚ã€‚ç®¡ç†å‘˜å…³æ³¨äºå¦‚ä½•é€šè¿‡pvæä¾›å­˜å‚¨åŠŸèƒ½è€Œæ— éœ€å…³æ³¨ç”¨æˆ·å¦‚ä½•ä½¿ç”¨ï¼ŒåŒæ ·çš„ç”¨æˆ·åªéœ€è¦æŒ‚è½½pvcåˆ°å®¹å™¨ä¸­è€Œä¸éœ€è¦å…³æ³¨å­˜å‚¨å·é‡‡ç”¨ä½•ç§æŠ€æœ¯å®ç°ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;pvcå’Œpvçš„å…³ç³»ä¸podå’Œnodeå…³ç³»ç±»ä¼¼ï¼Œå‰è€…æ¶ˆè€—åè€…çš„èµ„æºã€‚pvcå¯ä»¥å‘pvç”³è¯·æŒ‡å®šå¤§å°çš„å­˜å‚¨èµ„æºå¹¶è®¾ç½®è®¿é—®æ¨¡å¼,è¿™å°±å¯ä»¥é€šè¿‡Provision -&gt; Claim çš„æ–¹å¼ï¼Œæ¥å¯¹å­˜å‚¨èµ„æºè¿›è¡Œæ§åˆ¶ã€‚</p><h2 id="2ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#2ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2ã€ç”Ÿå‘½å‘¨æœŸ"></a>2ã€ç”Ÿå‘½å‘¨æœŸ</h2><p>pvå’Œpvcéµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š</p><ul><li>ä¾›åº”å‡†å¤‡ã€‚é€šè¿‡é›†ç¾¤å¤–çš„å­˜å‚¨ç³»ç»Ÿæˆ–è€…äº‘å¹³å°æ¥æä¾›å­˜å‚¨æŒä¹…åŒ–æ”¯æŒã€‚</li></ul><ul><li><p>é™æ€æä¾›ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¤šä¸ªPVï¼Œä¾›PVCä½¿ç”¨ã€‚</p></li><li><p>åŠ¨æ€æä¾›ï¼šåŠ¨æ€åˆ›å»ºPVCç‰¹å®šçš„PVï¼Œå¹¶ç»‘å®šã€‚</p><ul><li>ç»‘å®šã€‚ç”¨æˆ·åˆ›å»ºpvcå¹¶æŒ‡å®šéœ€è¦çš„èµ„æºå’Œè®¿é—®æ¨¡å¼ã€‚åœ¨æ‰¾åˆ°å¯ç”¨pvä¹‹å‰ï¼Œpvcä¼šä¿æŒæœªç»‘å®šçŠ¶æ€ã€‚</li><li>ä½¿ç”¨ã€‚ç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvcã€‚</li><li>é‡Šæ”¾ã€‚ç”¨æˆ·åˆ é™¤pvcæ¥å›æ”¶å­˜å‚¨èµ„æºï¼Œpvå°†å˜æˆâ€œreleasedâ€çŠ¶æ€ã€‚ç”±äºè¿˜ä¿ç•™ç€ä¹‹å‰çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†ï¼Œå¦åˆ™è¿™äº›å­˜å‚¨èµ„æºæ— æ³•è¢«å…¶ä»–pvcä½¿ç”¨ã€‚</li><li>å›æ”¶(Reclaiming)ã€‚pvå¯ä»¥è®¾ç½®ä¸‰ç§å›æ”¶ç­–ç•¥ï¼šä¿ç•™ï¼ˆRetainï¼‰ï¼Œå›æ”¶ï¼ˆRecycleï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</li></ul></li><li><p>ä¿ç•™ç­–ç•¥ï¼šå…è®¸äººå·¥å¤„ç†ä¿ç•™çš„æ•°æ®ã€‚</p></li><li><p>åˆ é™¤ç­–ç•¥ï¼šå°†åˆ é™¤pvå’Œå¤–éƒ¨å…³è”çš„å­˜å‚¨èµ„æºï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</p></li><li><p>å›æ”¶ç­–ç•¥ï¼šå°†æ‰§è¡Œæ¸…é™¤æ“ä½œï¼Œä¹‹åå¯ä»¥è¢«æ–°çš„pvcä½¿ç”¨ï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</p></li></ul><blockquote><p><em>ç›®å‰åªæœ‰NFSå’ŒHostPathç±»å‹å·æ”¯æŒå›æ”¶ç­–ç•¥ï¼ŒAWS EBS,GCE PD,Azure Diskå’ŒCinderæ”¯æŒåˆ é™¤(Delete)ç­–ç•¥ã€‚</em></p></blockquote><h3 id="2-1ã€Provisioning"><a href="#2-1ã€Provisioning" class="headerlink" title="2.1ã€Provisioning"></a>2.1ã€Provisioning</h3><p>ä¸¤ç§æ–¹å¼æä¾›çš„PVèµ„æºä¾›ç»™</p><a id="more"></a><p>static</p><ul><li>é€šè¿‡é›†ç¾¤ç®¡ç†è€…åˆ›å»ºå¤šä¸ªPVï¼Œä¸ºé›†ç¾¤â€œä½¿ç”¨è€…â€æä¾›å­˜å‚¨èƒ½åŠ›è€Œéšè—çœŸå®å­˜å‚¨çš„ç»†èŠ‚ã€‚å¹¶ä¸”å­˜åœ¨äºkubenretes apiä¸­ï¼Œå¯è¢«ç›´æ¥ä½¿ç”¨ã€‚</li></ul><p>dynamic</p><ul><li>åŠ¨æ€å·ä¾›ç»™æ˜¯kubernetesç‹¬æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¸€åŠŸèƒ½å…è®¸æŒ‰éœ€åˆ›å»ºå­˜å‚¨å»ºã€‚åœ¨æ­¤ä¹‹å‰ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦äº‹å…ˆåœ¨é›†ç¾¤å¤–ç”±å­˜å‚¨æä¾›è€…æˆ–è€…äº‘æä¾›å•†åˆ›å»º</li><li>å­˜å‚¨å·ï¼ŒæˆåŠŸä¹‹åå†åˆ›å»ºPersistentVolumeå¯¹è±¡ï¼Œæ‰èƒ½å¤Ÿåœ¨kubernetesä¸­ä½¿ç”¨ã€‚åŠ¨æ€å·ä¾›ç»™èƒ½è®©é›†ç¾¤ç®¡ç†å‘˜ä¸å¿…è¿›è¡Œé¢„å…ˆåˆ›å»ºå­˜å‚¨å·ï¼Œè€Œæ˜¯éšç€ç”¨æˆ·éœ€æ±‚è¿›è¡Œåˆ›å»ºã€‚åœ¨1.5ç‰ˆæœ¬æé«˜äº†åŠ¨æ€å·çš„å¼¹æ€§å’Œå¯ç”¨æ€§ã€‚</li></ul><h2 id="3ã€PVç±»å‹"><a href="#3ã€PVç±»å‹" class="headerlink" title="3ã€PVç±»å‹"></a>3ã€PVç±»å‹</h2><p>pvæ”¯æŒä»¥ä¸‹ç±»å‹:</p><pre><code>* GCEPersistentDisk
* AWSElasticBlockStore
* NFS
* iSCSI
* RBD (Ceph Block Device)
* Glusterfs
* AzureFile
* AzureDisk
* CephFS
* cinder
* FC
* FlexVolume
* Flocker
* PhotonPersistentDisk
* Quobyte
* VsphereVolume
* HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</code></pre><h3 id="3-1ã€PVå±æ€§"><a href="#3-1ã€PVå±æ€§" class="headerlink" title="3.1ã€PVå±æ€§"></a>3.1ã€PVå±æ€§</h3><ul><li>è®¿é—®æ¨¡å¼,ä¸pvçš„è¯­ä¹‰ç›¸åŒã€‚åœ¨è¯·æ±‚èµ„æºæ—¶ä½¿ç”¨ç‰¹å®šæ¨¡å¼ã€‚</li><li>èµ„æº,ç”³è¯·çš„å­˜å‚¨èµ„æºæ•°é¢ã€‚</li></ul><h3 id="3-2ã€PVå·é˜¶æ®µçŠ¶æ€"><a href="#3-2ã€PVå·é˜¶æ®µçŠ¶æ€" class="headerlink" title="3.2ã€PVå·é˜¶æ®µçŠ¶æ€"></a>3.2ã€PVå·é˜¶æ®µçŠ¶æ€</h3><ul><li>Available â€“ èµ„æºå°šæœªè¢«claimä½¿ç”¨</li><li>Bound â€“ å·å·²ç»è¢«ç»‘å®šåˆ°claimäº†</li><li>Released â€“ claimè¢«åˆ é™¤ï¼Œå·å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æœªè¢«é›†ç¾¤å›æ”¶ã€‚</li><li>Failed â€“ å·è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><h2 id="4ã€åˆ©ç”¨nfsåˆ›å»ºpv-pvc"><a href="#4ã€åˆ©ç”¨nfsåˆ›å»ºpv-pvc" class="headerlink" title="4ã€åˆ©ç”¨nfsåˆ›å»ºpv_pvc"></a>4ã€åˆ©ç”¨nfsåˆ›å»ºpv_pvc</h2><p>å‡†å¤‡ä¸€å°æœºå™¨ï¼Œæ­å»ºNFSæœåŠ¡ï¼Œnfsæ­å»ºè¿™é‡Œä¸é˜è¿°ï¼Œ</p><h3 id="4-1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv"><a href="#4-1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv" class="headerlink" title="4.1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv"></a>4.1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat pv.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: opspv</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/jenkins</span><br><span class="line">    server: 172.21.16.236</span><br><span class="line"><span class="comment"># kubectl create -f pv.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure><h3 id="4-2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc"><a href="#4-2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc" class="headerlink" title="4.2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc"></a>4.2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat pvc.yaml</span></span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: opspv</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line"><span class="comment"># kubectl create -f pvc.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pvc</span></span><br></pre></td></tr></table></figure><h3 id="4-3ã€åˆ›å»ºpodæŒ‚è½½pv-pvc"><a href="#4-3ã€åˆ›å»ºpodæŒ‚è½½pv-pvc" class="headerlink" title="4.3ã€åˆ›å»ºpodæŒ‚è½½pv_pvc"></a>4.3ã€åˆ›å»ºpodæŒ‚è½½pv_pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-deployment.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: jenkins2</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins</span><br><span class="line">        image: jenkins/jenkins:lts</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: web</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 50000</span><br><span class="line">          name: agent</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 512Mi</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: jenkinshome</span><br><span class="line">          subPath: jenkins2</span><br><span class="line">          mountPath: /var/jenkins_home</span><br><span class="line">        env:</span><br><span class="line">        - name: LIMITS_MEMORY</span><br><span class="line">          valueFrom:</span><br><span class="line">            resourceFieldRef:</span><br><span class="line">              resource: limits.memory</span><br><span class="line">              divisor: 1Mi</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx$(LIMITS_MEMORY)m -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85 -Duser.timezone=Asia/Shanghai</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">      volumes:</span><br><span class="line">      - name: jenkinshome</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: opspvc</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  labels:</span><br><span class="line">    app: jenkins2</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: jenkins2</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30002</span><br><span class="line">  - name: agent</span><br><span class="line">    port: 50000</span><br><span class="line">    targetPort: agent</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <tags>
        <tag>pvc,pv,kubernetes,å­˜å‚¨</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes å•æœºå®‰è£…</title>
    <url>/2019/08/12/kubernetes-%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h2 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1.ç¯å¢ƒå‡†å¤‡"></a>1.ç¯å¢ƒå‡†å¤‡</h2><blockquote><p>ä¸€ä¸ªmasterèŠ‚ç‚¹ï¼Œå››ä¸ªnodeèŠ‚ç‚¹<br>masterèŠ‚ç‚¹ip</p><ul><li>172.21.16.244<br>nodeèŠ‚ç‚¹ip</li><li>172.21.16.24</li><li>172.21.16.231</li><li>172.21.16.202</li><li>172.21.16.55</li></ul></blockquote><ul><li>ä»¥ä¸‹æ˜¯æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå‡è¿›è¡Œæ“ä½œ</li></ul><h2 id="2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº"><a href="#2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº" class="headerlink" title="2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº"></a>2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">  http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="3ã€é‡æ–°å»ºç«‹yumç¼“å­˜"><a href="#3ã€é‡æ–°å»ºç«‹yumç¼“å­˜" class="headerlink" title="3ã€é‡æ–°å»ºç«‹yumç¼“å­˜"></a>3ã€é‡æ–°å»ºç«‹yumç¼“å­˜</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install epel-release &amp;&amp;yum clean all &amp;&amp;yum makecach</span></span><br></pre></td></tr></table></figure><ul><li>è®°å¾—åŒæ­¥ç³»ç»Ÿçš„æ—¶é—´</li></ul><h2 id="3ã€é…ç½®è½¬å‘è¯·æ±‚"><a href="#3ã€é…ç½®è½¬å‘è¯·æ±‚" class="headerlink" title="3ã€é…ç½®è½¬å‘è¯·æ±‚"></a>3ã€é…ç½®è½¬å‘è¯·æ±‚</h2><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">å…³é—­swap</span><br><span class="line"><span class="comment"># sudo swapoff -a</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># sysctl --system</span></span><br></pre></td></tr></table></figure><h2 id="4ã€å®‰è£…docker"><a href="#4ã€å®‰è£…docker" class="headerlink" title="4ã€å®‰è£…docker"></a>4ã€å®‰è£…docker</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install docker</span></span><br><span class="line"><span class="comment"># systemctl enable docker &amp;&amp; systemctl start docker</span></span><br></pre></td></tr></table></figure><h2 id="5ã€å®‰è£…k8s-éœ€è¦çš„æ’ä»¶"><a href="#5ã€å®‰è£…k8s-éœ€è¦çš„æ’ä»¶" class="headerlink" title="5ã€å®‰è£…k8s éœ€è¦çš„æ’ä»¶"></a>5ã€å®‰è£…k8s éœ€è¦çš„æ’ä»¶</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install kubelet kubeadm kubectl kubernetes-cni</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet &amp;&amp; systemctl start kubelet</span></span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ä¸º kubelet ä¸ºCgroupæ¨¡å¼</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CGROUP_ARGS=--cgroup-driver=systemd"</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure><h2 id="6ã€æ‹‰å–é•œåƒ"><a href="#6ã€æ‹‰å–é•œåƒ" class="headerlink" title="6ã€æ‹‰å–é•œåƒ"></a>6ã€æ‹‰å–é•œåƒ</h2><p>æ–°å»ºä¸€ä¸ªshell æ‹‰å–é•œåƒåˆ°æœ¬åœ°(æ‰€æœ‰èŠ‚ç‚¹å‡æ“ä½œ)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">images=(kube-proxy:v1.13.0 kube-scheduler:v1.13.0 kube-controller-manager:v1.13.0 kube-apiserver:v1.13.0 etcd:3.2.24 coredns:1.2.6 pause:3.1 kubernetes-dashboard-amd64:v1.10.0 kubernetes-dashboard-init-amd64:v1.0.1  k8s-dns-sidecar-amd64:1.14.9 k8s-dns-kube-dns-amd64:1.14.9 k8s-dns-dnsmasq-nanny:1.15.0 heapster:v1.5.2 kubernetes-dashboard-arm:v1.10.0)</span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">docker pull xxlaila/<span class="variable">$imageName</span></span><br><span class="line">docker tag xxlaila/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">docker rmi xxlaila/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>ä»¥ä¸‹æ“ä½œæ˜¯åœ¨k8sçš„masterè¿›è¡Œæ“ä½œ</li></ul><h2 id="7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ"><a href="#7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ" class="headerlink" title="7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ"></a>7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm init --kubernetes-version=v1.13.0 --pod-network-cidr=10.244.0.0/16</span></span><br><span class="line"><span class="comment"># è®°ä¸‹è¿™å¥è¯ï¼Œåé¢nodeèŠ‚ç‚¹åŠ å…¥éœ€è¦</span></span><br><span class="line"><span class="comment"># kubeadm join 172.21.17.4:6443 --token 0mdk7x.du3cn19qm1jl2b0e --discovery-token-ca-cert-hash sha256:19bf79b41a931735b1f2f5138e1daa436ab26a4f19781ccf2015cff749ddb4b9</span></span><br></pre></td></tr></table></figure><h3 id="7-1ã€æ‰§è¡Œåˆ›å»ºç›®å½•"><a href="#7-1ã€æ‰§è¡Œåˆ›å»ºç›®å½•" class="headerlink" title="7.1ã€æ‰§è¡Œåˆ›å»ºç›®å½•"></a>7.1ã€æ‰§è¡Œåˆ›å»ºç›®å½•</h3><p>åé¢åœ¨ç”Ÿæˆè¯ä¹¦çš„æ—¶å€™éœ€è¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><h3 id="7-2ã€æŸ¥çœ‹éªŒè¯"><a href="#7-2ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="7.2ã€æŸ¥çœ‹éªŒè¯"></a>7.2ã€æŸ¥çœ‹éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatus</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br><span class="line"><span class="comment"># kubectl get cs</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="8ã€å®‰è£…flannel-ç½‘ç»œ"><a href="#8ã€å®‰è£…flannel-ç½‘ç»œ" class="headerlink" title="8ã€å®‰è£…flannel ç½‘ç»œ"></a>8ã€å®‰è£…flannel ç½‘ç»œ</h2><blockquote><p>(é…ç½®æ–‡ä»¶å’Œç›®å½•æ¯ä¸ªnodeéƒ½è¦å»ºç«‹)</p></blockquote><h3 id="8-1-åˆ›å»ºflannelé…ç½®æ–‡ä»¶"><a href="#8-1-åˆ›å»ºflannelé…ç½®æ–‡ä»¶" class="headerlink" title="8.1 åˆ›å»ºflannelé…ç½®æ–‡ä»¶"></a>8.1 åˆ›å»ºflannelé…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/cni/net.d/</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF&gt; /etc/cni/net.d/10-flannel.conf</span></span><br><span class="line">&#123;</span><br><span class="line">â€œnameâ€: â€œcbr0â€,</span><br><span class="line">â€œ<span class="built_in">type</span>â€: â€œflannelâ€,</span><br><span class="line">â€œdelegateâ€: &#123;</span><br><span class="line">â€œisDefaultGatewayâ€: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="8-2-åˆ›å»ºç½‘ç»œé…ç½®"><a href="#8-2-åˆ›å»ºç½‘ç»œé…ç½®" class="headerlink" title="8.2 åˆ›å»ºç½‘ç»œé…ç½®"></a>8.2 åˆ›å»ºç½‘ç»œé…ç½®</h3><blockquote><p>(åªéœ€è¦åœ¨ä¸»èŠ‚ç‚¹æ“ä½œå³å¯)</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-amd64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-ppc64le created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-s390x created</span><br></pre></td></tr></table></figure><h2 id="9ã€æŸ¥çœ‹å‘½åç©ºé—´"><a href="#9ã€æŸ¥çœ‹å‘½åç©ºé—´" class="headerlink" title="9ã€æŸ¥çœ‹å‘½åç©ºé—´"></a>9ã€æŸ¥çœ‹å‘½åç©ºé—´</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get ns</span></span><br><span class="line">NAME          STATUS   AGE</span><br><span class="line">default       Active   27m</span><br><span class="line">kube-public   Active   27m</span><br><span class="line">kube-system   Active   27m</span><br></pre></td></tr></table></figure><h2 id="10ã€æŸ¥çœ‹systemçš„pod"><a href="#10ã€æŸ¥çœ‹systemçš„pod" class="headerlink" title="10ã€æŸ¥çœ‹systemçš„pod"></a>10ã€æŸ¥çœ‹systemçš„pod</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-86c58d9df4-4gfvd                     1/1     Running   0          27m</span><br><span class="line">coredns-86c58d9df4-cxtz5                     1/1     Running   0          27m</span><br><span class="line">etcd-k8s-zxc-test-3.kxl                      1/1     Running   0          26m</span><br><span class="line">kube-apiserver-k8s-zxc-test-3.kxl            1/1     Running   0          26m</span><br><span class="line">kube-controller-manager-k8s-zxc-test-3.kxl   1/1     Running   0          26m</span><br><span class="line">kube-flannel-ds-nh95x                        1/1     Running   0          15m</span><br><span class="line">kube-proxy-kvlng                             1/1     Running   0          27m</span><br><span class="line">kube-scheduler-k8s-zxc-test-3.kxl            1/1     Running   0          27m</span><br></pre></td></tr></table></figure><h2 id="11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter"><a href="#11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter" class="headerlink" title="11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter"></a>11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter</h2><ul><li>ä»¥ä¸‹æ˜¯æ¯ä¸ªnodeèŠ‚ç‚¹æ‰§è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm join 172.21.17.4:6443 --token 0mdk7x.du3cn19qm1jl2b0e --discovery-token-ca-cert-hash sha256:19bf79b41a931735b1f2f5138e1daa436ab26a4f19781ccf2015cff749ddb4b9</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦åŠ å…¥</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨kubectl get podså‘½ä»¤æ¥æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€</span></span><br><span class="line"><span class="comment"># kubectl get pods --all-namespaces</span></span><br></pre></td></tr></table></figure><h2 id="12ã€å®‰è£…kubernetes-dashboard"><a href="#12ã€å®‰è£…kubernetes-dashboard" class="headerlink" title="12ã€å®‰è£…kubernetes dashboard"></a>12ã€å®‰è£…kubernetes dashboard</h2><p>ä¸‹è½½å®˜ç½‘çš„dashboardæ–‡ä»¶ä¿®æ”¹kubernetes-dashboard.yamlæ–‡ä»¶,ç”¨ä¿®æ”¹ä¹‹åçš„kubernetes-dashboard.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»ºdashboard</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/kubernetes-dashboard</span></span><br><span class="line"><span class="comment"># kubectl apply -f kubernetes-dashboard.yaml</span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br></pre></td></tr></table></figure><h2 id="13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ"><a href="#13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ" class="headerlink" title="13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ"></a>13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system</span></span><br></pre></td></tr></table></figure><h3 id="13-1ã€æŸ¥çœ‹dashboard-info"><a href="#13-1ã€æŸ¥çœ‹dashboard-info" class="headerlink" title="13.1ã€æŸ¥çœ‹dashboard info"></a>13.1ã€æŸ¥çœ‹dashboard info</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe svc kubernetes-dashboard -n kube-system</span></span><br></pre></td></tr></table></figure><h3 id="13-2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹"><a href="#13-2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹" class="headerlink" title="13.2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹"></a>13.2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get pods -n kube-system -o wide</span></span><br></pre></td></tr></table></figure><h3 id="13-3ã€æŸ¥çœ‹service-èŠ‚ç‚¹ç«¯å£"><a href="#13-3ã€æŸ¥çœ‹service-èŠ‚ç‚¹ç«¯å£" class="headerlink" title="13.3ã€æŸ¥çœ‹service èŠ‚ç‚¹ç«¯å£"></a>13.3ã€æŸ¥çœ‹service èŠ‚ç‚¹ç«¯å£</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get service -n kube-system -o wide</span></span><br></pre></td></tr></table></figure><h3 id="13-4ã€åˆ›å»ºdashboard-admin-è´¦æˆ·"><a href="#13-4ã€åˆ›å»ºdashboard-admin-è´¦æˆ·" class="headerlink" title="13.4ã€åˆ›å»ºdashboard admin è´¦æˆ·"></a>13.4ã€åˆ›å»ºdashboard admin è´¦æˆ·</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f admin-user.yaml</span></span><br><span class="line">è·å–tokens</span><br><span class="line"><span class="comment"># kubectl describe serviceaccount admin -n kube-system</span></span><br><span class="line">Name:                admin</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:         kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                       &#123;<span class="string">"apiVersion"</span>:<span class="string">"v1"</span>,<span class="string">"kind"</span>:<span class="string">"ServiceAccount"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"labels"</span>:&#123;<span class="string">"k8s-app"</span>:<span class="string">"kubernetes-dashboard"</span>&#125;,<span class="string">"name"</span>:<span class="string">"admin"</span>,<span class="string">"namesp...</span></span><br><span class="line"><span class="string">Image pull secrets:  &lt;none&gt;</span></span><br><span class="line"><span class="string">Mountable secrets:   admin-token-kxs6k</span></span><br><span class="line"><span class="string">Tokens:              admin-token-kxs6k</span></span><br><span class="line"><span class="string">Events:              &lt;none&gt;</span></span><br><span class="line"><span class="string">æŸ¥çœ‹token ä¿¡æ¯</span></span><br><span class="line"><span class="string"># kubectl describe secret admin-token-kxs6k -n kube-system</span></span><br></pre></td></tr></table></figure><h2 id="14ã€dashboard-è®¿é—®"><a href="#14ã€dashboard-è®¿é—®" class="headerlink" title="14ã€dashboard è®¿é—®"></a>14ã€dashboard è®¿é—®</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ©ç”¨èŠ‚ç‚¹ip+30001 ç«¯å£è¿›è¡Œè®¿é—®ã€‚è®¿é—®ä¹‹å‰éœ€è¦åœ¨masterèŠ‚ç‚¹ç”Ÿæˆè¯ä¹¦ï¼ŒæŠŠè¯ä¹¦(kubecfg.p12)ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè¿›è¡Œå¯¼å…¥åˆ°æµè§ˆå™¨ï¼Œè¿™é‡Œä½¿ç”¨ç«ç‹æµè§ˆå™¨ï¼Œgoogleæµè§ˆå™¨å¯¼å…¥,ä¸æˆåŠŸï¼Œç”Ÿäº§è¯ä¹¦ä¹‹å‰è®°å¾—ç¬¬9æ­¥å·²æ“ä½œ</p><h3 id="14-1ã€ç”Ÿæˆè¯ä¹¦"><a href="#14-1ã€ç”Ÿæˆè¯ä¹¦" class="headerlink" title="14.1ã€ç”Ÿæˆè¯ä¹¦"></a>14.1ã€ç”Ÿæˆè¯ä¹¦</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grep 'client-certificate-data' ~/.kube/config | head -n 1 | awk '&#123;print $2&#125;' | base64 -d &gt;&gt; kubecfg.crt</span></span><br><span class="line"><span class="comment"># grep 'client-key-data' ~/.kube/config | head -n 1 | awk '&#123;print $2&#125;' | base64 -d &gt;&gt; kubecfg.key</span></span><br><span class="line"><span class="comment"># openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name "kubernetes-client"</span></span><br></pre></td></tr></table></figure><h3 id="14-2ã€dashboard-é…ç½®ä¿®æ”¹"><a href="#14-2ã€dashboard-é…ç½®ä¿®æ”¹" class="headerlink" title="14.2ã€dashboard é…ç½®ä¿®æ”¹"></a>14.2ã€dashboard é…ç½®ä¿®æ”¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;kubernetes dashboard v1.10.0ä½¿ç”¨çš„æ˜¯åŒå› å­ç™»é™†ï¼Œé»˜è®¤tokenå¤±æ•ˆçš„æ—¶é—´æ˜¯900ç§’ï¼Œ15åˆ†é’Ÿï¼Œæ¯15åˆ†é’Ÿå°±è¦è¿›è¡Œä¸€æ¬¡è®¤è¯ã€‚æˆ‘ä»¬å¯ä»¥åŠŸè¿‡ä¿®æ”¹token-ttlå‚æ•°æ¥è®¾ç½®ï¼Œä¸»è¦æ˜¯ä¿®æ”¹dashboard.yamlæ–‡ä»¶ï¼Œå¹¶é‡æ–°å»ºç«‹å³å¯</p><ul><li>åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ·»åŠ <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- containerPort: 8443</span><br><span class="line">  protocol: TCP</span><br><span class="line">args:</span><br><span class="line">  - --auto-generate-certificates</span><br><span class="line">  - --token-ttl=43200</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>é‡å»ºdashboard,é€šè¿‡åˆ©ç”¨httpæ·»åŠ ç«¯å£30001ï¼Œç„¶ååˆ©ç”¨tonkenè¿›è¡ŒéªŒè¯ç™»é™†,å®‰è£…å¤±è´¥æ¸…ç†ç¯å¢ƒ</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm reset</span></span><br><span class="line">æŸ¥çœ‹åŠ å…¥é›†ç¾¤token</span><br><span class="line"><span class="comment"># kubeadm token list</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos 5.5 å®‰è£…DRBD</title>
    <url>/2019/08/11/Centos-5-5-%E5%AE%89%E8%A3%85DRBD/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:15 GMT+0800 (China Standard Time) --><p>Centos5.5 32bitå®‰è£…DRBD</p><ul><li>å®‰è£…å‰å‡†å¤‡</li></ul><table><thead><tr><th>èŠ‚ç‚¹ç±»å‹</th><th>IPåœ°å€è§„åˆ’</th><th>ä¸»æœºå</th></tr></thead><tbody><tr><td>ä¸»ç”¨èŠ‚ç‚¹</td><td>192.168.1.101</td><td>node2</td></tr><tr><td>å¤‡ç”¨èŠ‚ç‚¹</td><td>192.168.1.102</td><td>node1</td></tr><tr><td>ç£ç›˜</td><td>ä¸¤å°10Gç£ç›˜</td><td></td></tr></tbody></table><h2 id="åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD"><a href="#åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD" class="headerlink" title="åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD"></a>åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># yum -y install kmod-drbd83 drbd83</span></span><br></pre></td></tr></table></figure><p>å®‰è£…æˆåŠŸä¹‹å/sbinç›®å½•ä¸‹é¢æœ‰drbdadmï¼Œdrbdmetaï¼Œdrbdsetupå‘½ä»¤ï¼Œä»¥åŠ/etc /init.d/drbdå¯åŠ¨è„šæœ¬ã€‚</p><ul><li>å¤‡ç”¨èŠ‚ç‚¹å®‰è£…DRBD</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># yum -y install kmod-drbd83 drbd83</span></span><br></pre></td></tr></table></figure><blockquote><p>å®‰è£…å®Œæˆåã€‚é»˜è®¤é…ç½®æ–‡ä»¶/etc/drbd.confï¼Œä»¥ä¸‹æ˜¯ä¸¤å°çš„ä¸»æœºé…ç½®å®ä¾‹:</p></blockquote><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># cat /etc/drbd.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># please have a a look at the example configuration file in</span></span><br><span class="line"><span class="comment"># /usr/share/doc/drbd83/drbd.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># drbd.conf</span></span><br><span class="line"><span class="comment"># create by dba.gao@gmail.com at 2010-10-11</span></span><br><span class="line">global &#123;</span><br><span class="line">    <span class="comment"># minor-count 64;</span></span><br><span class="line">    <span class="comment"># dialog-refresh 5; # 5 seconds</span></span><br><span class="line">    <span class="comment"># disable-ip-verification;</span></span><br><span class="line">usage-count no; <span class="comment">#æ˜¯å¦å‚åŠ DRBDä½¿ç”¨è€…ç»Ÿè®¡ï¼Œé»˜è®¤yes</span></span><br><span class="line">&#125;</span><br><span class="line">common &#123;</span><br><span class="line">    syncer &#123; rate <span class="comment">#è®¾ç½®ä¸»å¤‡èŠ‚ç‚¹åŒæ­¥æ—¶çš„ç½‘ç»œé€Ÿç‡æœ€å¤§å€¼ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚</span></span><br><span class="line">        200M; &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource r0 &#123;</span><br><span class="line">protocol C;</span><br><span class="line"><span class="comment"># ä½¿ç”¨drbdçš„ç¬¬ä¸‰ç§åŒæ­¥åè®®,è¡¨ç¤ºæ”¶åˆ°è¿œç¨‹ä¸»æœºçš„å†™å…¥ç¡®è®¤å,åˆ™è®¤ä¸ºå†™å…¥å®Œæˆ</span></span><br><span class="line">handlers &#123;</span><br><span class="line">    pri-on-incon-degr <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">    pri-lost-after-sb <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">    <span class="built_in">local</span>-io-error <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">fence-peer <span class="string">"/usr/lib64/heartbeat/drbd-peer-outdater -t 5"</span>;</span><br><span class="line">pri-lost <span class="string">"echo pri-lost. Have a look at the log files. | mail -s 'DRBD Alert' root"</span>;</span><br><span class="line">    split-brain <span class="string">"/usr/lib/drbd/notify-split-brain.sh root"</span>;</span><br><span class="line">    out-of-sync <span class="string">"/usr/lib/drbd/notify-out-of-sync.sh root"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">net &#123;</span><br><span class="line"><span class="comment"># timeout 60;</span></span><br><span class="line"><span class="comment"># connect-int 10;</span></span><br><span class="line"><span class="comment"># ping-int 10;</span></span><br><span class="line"><span class="comment"># max-buffers 2048;</span></span><br><span class="line"><span class="comment"># max-epoch-size 2048;</span></span><br><span class="line">cram-hmac-alg <span class="string">"sha1"</span>;</span><br><span class="line">shared-secret <span class="string">"MySQL-HA"</span>;</span><br><span class="line"><span class="comment"># DRBDåŒæ­¥æ—¶ä½¿ç”¨çš„éªŒè¯æ–¹å¼å’Œå¯†ç ä¿¡æ¯ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line">disk &#123;</span><br><span class="line">    on-io-error detach;</span><br><span class="line">fencing resource-only;</span><br><span class="line">&#125;</span><br><span class="line">startup &#123;</span><br><span class="line">    wfc-timeout 120;</span><br><span class="line">    degr-wfc-timeout 120;</span><br><span class="line">  &#125;</span><br><span class="line">  device        /dev/drbd0;</span><br><span class="line"><span class="comment">#è¿™é‡Œé…ç½®æ¡£æˆ‘ä»¬æŒ‚åœ¨çš„ç³»ç»Ÿçš„ç£ç›˜æ ‡ç¤ºé©±åŠ¨ç›˜ç¬¦; on node2 &#123;</span></span><br><span class="line"><span class="comment">#æ¯ä¸ªä¸»æœºçš„è¯´æ˜ä»¥onå¼€å¤´,åé¢æ˜¯hostname(uname - n)ï¼Œåœ¨åé¢çš„&#123;&#125;ä¸­ä¸ºè¿™ä¸ªä¸»æœºçš„é…ç½®ã€‚</span></span><br><span class="line">disk /dev/sdb5;</span><br><span class="line"><span class="comment">#/dev/drbd0ä½¿ç”¨çš„ç£ç›˜åˆ†åŒºæ˜¯/dev/sdb5</span></span><br><span class="line">address     192.168.1.101:7788;</span><br><span class="line">IPåœ°å€ä»¥åŠDRBDä½¿ç”¨çš„ç«¯å£ meta-disk internal;</span><br><span class="line">&#125;</span><br><span class="line">on node1 &#123;</span><br><span class="line">disk /dev/sdb5;</span><br><span class="line">address 192.168.1.102:7788; å’Œä¸Šè¿°ä¸€æ ·</span><br><span class="line">meta-disk internal; <span class="comment">#drbdçš„å…ƒæ•°æ®å­˜æ”¾æ–¹å¼ &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆåå¯åŠ¨èŠ‚ç‚¹ï¼Œåœ¨å¯åŠ¨DRBDä¹‹å‰,ä½ éœ€è¦åˆ†åˆ«åœ¨ä¸¤å°ä¸»æœºçš„hdåˆ†åŒºä¸Š,åˆ›å»ºä¾›DRBDè®°å½•ä¿¡æ¯çš„æ•°æ®å—.åˆ†åˆ«åœ¨ä¸¤å°ä¸»æœºä¸Šæ‰§è¡Œ(è¿™é‡Œæ³¨æ„:åœ¨åˆ›å»ºåˆ†åŒºä¹‹å‰æˆ‘ä»¬éœ€è¦å§ç£ç›˜çš„åˆ†åŒºåˆ†å¥½)</p><p><img src alt="img"></p><p>åˆ†åŒºåˆ†å¥½ä»¥åå…ˆä¸è¦æŒ‚åœ¨å’Œæ ¼å¼åŒ–(æŒ‚åœ¨ä»¥ååˆ›å»ºä¼šæŠ¥é”™)ï¼Œç„¶ååˆ›å»ºä¾›DRBDè®° å½•ä¿¡æ¯çš„æ•°æ®å—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># drbdadm create-md r0</span></span><br><span class="line">[root@node1 ~]<span class="comment"># drbdadm create-md r0</span></span><br><span class="line">æˆ–è€…æ‰§è¡Œdrbdadm create-md all</span><br></pre></td></tr></table></figure><ul><li><p>åœ¨ä¸¤ä¸ªèŠ‚ç‚¹å¯åŠ¨æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># /etc/init.d/drbd start</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /etc/init.d/drbd start</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨ä»»æ„èŠ‚ç‚¹æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</p></li></ul><blockquote><p>1: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C râ€”-<br>ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:2007644</p></blockquote><blockquote><p>å¯¹è¾“å‡ºçš„å«ä¹‰è§£é‡Šå¦‚ä¸‹:<br>roè¡¨ç¤ºè§’è‰²ä¿¡æ¯ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨drbdæ—¶ï¼Œä¸¤ä¸ªdrbdèŠ‚ç‚¹é»˜è®¤éƒ½å¤„äºSecondaryçŠ¶æ€,<br>dsæ˜¯ç£ç›˜çŠ¶æ€ä¿¡æ¯ï¼Œâ€œInconsistent/Inconsistenâ€ï¼Œå³ä¸ºâ€œä¸ä¸€è‡´/ä¸ä¸€è‡´â€ çŠ¶æ€ï¼Œè¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹çš„ç£ç›˜æ•°æ®å¤„äºä¸ä¸€è‡´çŠ¶æ€ã€‚<br>Nsè¡¨ç¤ºç½‘ç»œå‘é€çš„æ•°æ®åŒ…ä¿¡æ¯ã€‚</p></blockquote><h3 id="è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2"><a href="#è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2" class="headerlink" title="è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2"></a>è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># drbdsetup /dev/drbd1 primary â€“o æˆ–è€…æ‰§è¡Œä¸‹é¢å‘½ä»¤ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line">[root@node2 ~]<span class="comment">#drbdadm -- --overwrite-data-of-peer primary all</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæ­¤å‘½ä»¤åï¼Œåœ¨åé¢å¦‚æœéœ€è¦è®¾ç½®å“ªä¸ªæ˜¯ä¸»èŠ‚ç‚¹æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨å¦ å¤–ä¸€ä¸ªå‘½ä»¤:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment">#/sbin/drbdadm primary r0æˆ–è€…/sbin/drbdadm primary all</span></span><br></pre></td></tr></table></figure><blockquote><p>æ‰§è¡Œæ­¤å‘½ä»¤åï¼Œå¼€å§‹åŒæ­¥ä¸¤å°æœºå™¨å¯¹åº”ç£ç›˜çš„æ•°æ®</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ node2 ~]<span class="comment">#cat /proc/drbd</span></span><br><span class="line">1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r--- -</span><br><span class="line">ns:576224 nr:0 dw:0 dr:581760 al:0 bm:34 lo:84 pe:369 ua:256 ap:0 ep:1 wo:b oos:1443196</span><br><span class="line">[====&gt;...............] sync<span class="string">'ed: 28.4% (1443196/2007644)K delay_probe: 69</span></span><br><span class="line"><span class="string">finish: 0:03:56 speed: 6,024 (5,876) K/sec</span></span><br></pre></td></tr></table></figure><blockquote><p>æœ€åæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ,ç”±äºmountæ“ä½œåªèƒ½åœ¨ä¸»èŠ‚ç‚¹è¿›è¡Œï¼Œæ‰€ä»¥åªæœ‰è®¾ç½®äº†ä¸»èŠ‚ç‚¹åæ‰èƒ½æ ¼å¼åŒ–ç£ç›˜åˆ† åŒºï¼Œç„¶åæŒ‚è½½:</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># mkfs -t ext3 /dev/drbd0</span></span><br><span class="line">[root@node2 ~]<span class="comment"># mount /dev/drbd0 /data/</span></span><br><span class="line">[root@node2 ~]<span class="comment"># df -h</span></span><br><span class="line">Filesystem</span><br><span class="line">/dev/sda3</span><br><span class="line">/dev/sda1</span><br><span class="line">tmpfs</span><br><span class="line">/dev/drbd0</span><br><span class="line">Size  Used Avail Use% Mounted on</span><br><span class="line"> 28G  3.7G   23G  15% /</span><br><span class="line">487M   22M  440M   5% /boot</span><br><span class="line">125M     0  125M   0% /dev/shm</span><br><span class="line">9.9G  151M  9.2G   2% /data</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;Dwæ˜¯ç£ç›˜å†™ä¿¡æ¯;Dræ˜¯ç£ç›˜è¯»ä¿¡æ¯;å¯åŠ¨DRBDåè®¾ç½®ä¸»æ¬¡èŠ‚ç‚¹ï¼Œé€‰æ‹©éœ€è¦è®¾ç½®ä¸»æœºçš„ä¸»èŠ‚ç‚¹ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤: è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>å­˜å‚¨,Centos</category>
      </categories>
      <tags>
        <tag>drdb</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle ORA-12519</title>
    <url>/2019/08/10/oracle-ORA-12519/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><blockquote><p>oracle ORA-12519é”™è¯¯è§£å†³<br>ä»Šå¤©é‡åˆ°åšç³»ç»Ÿå‹åŠ›æµ‹è¯•çš„æ—¶å€™ï¼Œç³»ç»ŸæŠ¥äº†ä¸€ä¸ªé”™è¯¯<br>OERR: ORA-12519 TNS:no appropriate service handler found</p></blockquote><p><img src="https://img.xxlaila.cn/ORA-12519-error.png" alt="img"></p><p>åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€ä¸‹oralcçš„é”™è¯¯ä¿¡æ¯ORA-12519ï¼Œè§£å†³åŠæ³•æŒºå¤šçš„ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p><h3 id="ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“"><a href="#ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“" class="headerlink" title="ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“"></a>ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlplus <span class="string">"/as sysdba"</span></span><br></pre></td></tr></table></figure><blockquote><p>é¦–å…ˆæ£€æŸ¥processå’Œsessionçš„ä½¿ç”¨æƒ…å†µ</p></blockquote><p><img src="https://img.xxlaila.cn/parameter_%20processes_1.png" alt="img"><br><img src="https://img.xxlaila.cn/parameter_%20session_3.png" alt="img"></p><a id="more"></a><ul><li>è¿™é‡Œå¯ä»¥çœ‹åˆ°processå‡ ä¹å·²ç»æ»¡äº†</li></ul><h3 id="ä¿®æ”¹oracleçš„processå’Œsessionå€¼"><a href="#ä¿®æ”¹oracleçš„processå’Œsessionå€¼" class="headerlink" title="ä¿®æ”¹oracleçš„processå’Œsessionå€¼"></a>ä¿®æ”¹oracleçš„processå’Œsessionå€¼</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œæˆ‘ä»¬æŠŠè¿™äº›å€¼ä¿®æ”¹ä¸º1000å’Œ1135</span><br><span class="line">SQL&gt; alter system <span class="built_in">set</span> processes=1000 scope=spfile;</span><br><span class="line">ç³»ç»Ÿå·²æ›´æ”¹ã€‚</span><br><span class="line">SQL&gt; alter system <span class="built_in">set</span> sessions=1135 scope=spfile;</span><br><span class="line">ç³»ç»Ÿå·²æ›´æ”¹ã€‚</span><br></pre></td></tr></table></figure><h3 id="é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ"><a href="#é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ" class="headerlink" title="é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ"></a>é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; shutdown abort;</span><br><span class="line">ORACLE ä¾‹ç¨‹å·²ç»å…³é—­ã€‚</span><br><span class="line">SQL&gt; startup;</span><br><span class="line">ORACLE ä¾‹ç¨‹å·²ç»å¯åŠ¨ã€‚</span><br><span class="line">Total System Global Area  534462464 bytes</span><br><span class="line">Fixed Size                  2215064 bytes</span><br><span class="line">Variable Size             234881896 bytes</span><br><span class="line">Database Buffers          289406976 bytes</span><br><span class="line">Redo Buffers                7958528 bytes</span><br><span class="line">æ•°æ®åº“è£…è½½å®Œæ¯•ã€‚</span><br><span class="line">æ•°æ®åº“å·²ç»æ‰“å¼€ã€‚</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹å¹¶éªŒè¯"><a href="#æŸ¥çœ‹å¹¶éªŒè¯" class="headerlink" title="æŸ¥çœ‹å¹¶éªŒè¯"></a>æŸ¥çœ‹å¹¶éªŒè¯</h2><p><img src="https://img.xxlaila.cn/W.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>oracle</category>
      </categories>
      <tags>
        <tag>ORA-12519</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx https</title>
    <url>/2019/08/10/nginx-https/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>nginx http å¼ºåˆ¶è·³è½¬åˆ°https</p><h2 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$server_port</span> = 80 ) &#123;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$server_port</span> = 80 ) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123; <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>; &#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$host</span> != xxx.test.com) &#123; <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://xxx.test.com<span class="variable">$request_uri</span>; &#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123; <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$host</span> != xxx.test.com) &#123; <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://xxx.test.com<span class="variable">$request_uri</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•å››"><a href="#æ–¹æ³•å››" class="headerlink" title="æ–¹æ³•å››"></a>æ–¹æ³•å››</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    rewrite ^(.*) https://www.test.com<span class="variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¾‹å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    rewrite ^(.*) https://www.test.com<span class="variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    root ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•äº”"><a href="#æ–¹æ³•äº”" class="headerlink" title="æ–¹æ³•äº”"></a>æ–¹æ³•äº”</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>https</tag>
      </tags>
  </entry>
  <entry>
    <title>haproxy keepalived </title>
    <url>/2019/08/10/haproxy-keepalived/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>æœ¬æ–‡ä¸»è¦æ˜¯ä»£ç†kubernetes masterçš„é«˜å¯ç”¨ã€‚</p><h2 id="å®‰è£…haproxyå’Œkeepalived"><a href="#å®‰è£…haproxyå’Œkeepalived" class="headerlink" title="å®‰è£…haproxyå’Œkeepalived"></a>å®‰è£…haproxyå’Œkeepalived</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install keepalived.x86_64</span></span><br><span class="line"><span class="comment"># yum -y install haproxy18u.x86_64</span></span><br></pre></td></tr></table></figure><h2 id="2ã€é…ç½®haproxy"><a href="#2ã€é…ç½®haproxy" class="headerlink" title="2ã€é…ç½®haproxy"></a>2ã€é…ç½®haproxy</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/haproxy/haproxy.cfg</span></span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  uid 99</span><br><span class="line">  gid 99</span><br><span class="line">  <span class="comment">#daemon</span></span><br><span class="line">  nbproc 1</span><br><span class="line">  pidfile haproxy.pid</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  retries 3</span><br><span class="line">  timeout connect 5s</span><br><span class="line">  timeout client 30s</span><br><span class="line">  timeout server 30s</span><br><span class="line">  timeout check 2s</span><br><span class="line"></span><br><span class="line">listen admin_stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:1080</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  stats refresh 30s</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    admin:admin1</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats admin <span class="keyword">if</span> TRUE</span><br><span class="line"></span><br><span class="line">frontend k8s-https</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  default_backend k8s-http</span><br><span class="line"></span><br><span class="line">backend k8s-http</span><br><span class="line">  mode tcp</span><br><span class="line">  balance roundrobin</span><br><span class="line">  server k8s-master-01 172.21.17.4:6443</span><br><span class="line">  server k8s-master-02 172.21.16.230:6443</span><br><span class="line">  server k8s-master-03 172.21.240:6443</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="3ã€keepalivedé…ç½®"><a href="#3ã€keepalivedé…ç½®" class="headerlink" title="3ã€keepalivedé…ç½®"></a>3ã€keepalivedé…ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  notification_email &#123;</span><br><span class="line">    cq_xxlaila@163.com</span><br><span class="line">    &#125;</span><br><span class="line">  notification_email_from cq_xxlaila@163.com</span><br><span class="line">  smtp_server 127.0.0.1</span><br><span class="line">  smtp_connect_timeout 30</span><br><span class="line">  router_id haproxy-01</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/haproxy_check.sh"</span></span><br><span class="line">  interval 2</span><br><span class="line">  timeout 2</span><br><span class="line">  fall 3</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    dont_track_primary</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass 57D0BC82E074C9D6</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      172.21.16.45</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç›‘æµ‹è„šæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat haproxy_check.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">A=`ps -C haproxy --no-header | wc -l`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$A</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    systemctl start haproxy</span><br><span class="line">    sleep 3</span><br><span class="line">    <span class="keyword">if</span> [ `ps -C haproxy --no-header | wc -l ` -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        systemctl stop haproxy</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æœåŠ¡</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl enable haproxy &amp;&amp;systemctl enable keepalived</span></span><br><span class="line"><span class="comment"># systemctl start keepalived &amp;&amp;systemctl start haproxy</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>haproxy,keepalived,kubernetes</category>
      </categories>
      <tags>
        <tag>haproxy,keepalived</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s-prometheus</title>
    <url>/2019/08/10/k8s-prometheus/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p><a href="https://prometheus.io/" target="_blank" rel="noopener">Prometheus</a>æ˜¯ä¸€ä¸ªé›†æ•°æ®æ”¶é›†å­˜å‚¨ã€æ•°æ®æŸ¥è¯¢å’Œæ•°æ®å›¾è¡¨æ˜¾ç¤ºäºä¸€èº«çš„å¼€æºç›‘æ§ç»„ä»¶ã€‚æœ¬æ–‡ä¸»è¦è®²è§£å¦‚ä½•æ­å»ºPrometheusï¼Œå¹¶ä½¿ç”¨å®ƒç›‘æ§Kubernetesé›†ç¾¤ã€‚</p><h2 id="1ã€ä¸‹è½½ç›¸å…³yaml"><a href="#1ã€ä¸‹è½½ç›¸å…³yaml" class="headerlink" title="1ã€ä¸‹è½½ç›¸å…³yaml"></a>1ã€ä¸‹è½½ç›¸å…³yaml</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/xxlaila/kubernetes-yaml/tree/master/prometheus-grafana</span></span><br><span class="line"><span class="comment"># ls -l</span></span><br><span class="line">configmap.yaml</span><br><span class="line">grafana-deploy.yaml</span><br><span class="line">grafana-ingress.yaml</span><br><span class="line">grafana-svc.yaml</span><br><span class="line">node-exporter.yaml</span><br><span class="line">prometheus-deploy.yaml</span><br><span class="line">prometheus-svc.yaml</span><br><span class="line">rbac-setup.yaml</span><br><span class="line">prometheus-ingress.yaml</span><br></pre></td></tr></table></figure><h2 id="2ã€å¼€å§‹éƒ¨ç½²"><a href="#2ã€å¼€å§‹éƒ¨ç½²" class="headerlink" title="2ã€å¼€å§‹éƒ¨ç½²"></a>2ã€å¼€å§‹éƒ¨ç½²</h2><h3 id="2-1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶"><a href="#2-1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶" class="headerlink" title="2.1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶"></a>2.1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f  node-exporter.yaml</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2-2ã€éƒ¨ç½²prometheusç»„ä»¶"><a href="#2-2ã€éƒ¨ç½²prometheusç»„ä»¶" class="headerlink" title="2.2ã€éƒ¨ç½²prometheusç»„ä»¶"></a>2.2ã€éƒ¨ç½²prometheusç»„ä»¶</h3><h4 id="2-2-1ã€rbacæ–‡ä»¶"><a href="#2-2-1ã€rbacæ–‡ä»¶" class="headerlink" title="2.2.1ã€rbacæ–‡ä»¶"></a>2.2.1ã€rbacæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f rbac-setup.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶"><a href="#2-2-2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶" class="headerlink" title="2.2.2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶"></a>2.2.2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f configmap.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3ã€Prometheus-deployment-æ–‡ä»¶"><a href="#2-2-3ã€Prometheus-deployment-æ–‡ä»¶" class="headerlink" title="2.2.3ã€Prometheus deployment æ–‡ä»¶"></a>2.2.3ã€Prometheus deployment æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f  prometheus-deploy.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-4ã€Prometheus-serviceæ–‡ä»¶"><a href="#2-2-4ã€Prometheus-serviceæ–‡ä»¶" class="headerlink" title="2.2.4ã€Prometheus serviceæ–‡ä»¶"></a>2.2.4ã€Prometheus serviceæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f prometheus-svc.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-5ã€é…ç½®Ingress"><a href="#2-2-5ã€é…ç½®Ingress" class="headerlink" title="2.2.5ã€é…ç½®Ingress"></a>2.2.5ã€é…ç½®Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f prometheus-ingress.yaml</span></span><br></pre></td></tr></table></figure><h3 id="2-3ã€éƒ¨ç½²grafanaç»„ä»¶"><a href="#2-3ã€éƒ¨ç½²grafanaç»„ä»¶" class="headerlink" title="2.3ã€éƒ¨ç½²grafanaç»„ä»¶"></a>2.3ã€éƒ¨ç½²grafanaç»„ä»¶</h3><h4 id="2-3-1ã€grafana-deploymenté…ç½®æ–‡ä»¶"><a href="#2-3-1ã€grafana-deploymenté…ç½®æ–‡ä»¶" class="headerlink" title="2.3.1ã€grafana deploymenté…ç½®æ–‡ä»¶"></a>2.3.1ã€grafana deploymenté…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-deploy.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-3-2ã€grafana-serviceé…ç½®æ–‡ä»¶"><a href="#2-3-2ã€grafana-serviceé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.2ã€grafana serviceé…ç½®æ–‡ä»¶"></a>2.3.2ã€grafana serviceé…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-svc.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-3-3ã€grafana-ingressé…ç½®æ–‡ä»¶"><a href="#2-3-3ã€grafana-ingressé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.3ã€grafana ingressé…ç½®æ–‡ä»¶"></a>2.3.3ã€grafana ingressé…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-ingress.yaml</span></span><br></pre></td></tr></table></figure><h3 id="2-4ã€WEBç•Œé¢é…ç½®"><a href="#2-4ã€WEBç•Œé¢é…ç½®" class="headerlink" title="2.4ã€WEBç•Œé¢é…ç½®"></a>2.4ã€WEBç•Œé¢é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc,pods -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/46ds9824.png" alt="img"></p><h4 id="2-4-1-æŸ¥çœ‹node-exporter"><a href="#2-4-1-æŸ¥çœ‹node-exporter" class="headerlink" title="2.4.1 æŸ¥çœ‹node-exporter"></a>2.4.1 æŸ¥çœ‹node-exporter</h4><p><img src="https://img.xxlaila.cn/8764kjfnks.png" alt="img"></p><h4 id="2-4-2ã€æŸ¥çœ‹promethues"><a href="#2-4-2ã€æŸ¥çœ‹promethues" class="headerlink" title="2.4.2ã€æŸ¥çœ‹promethues"></a>2.4.2ã€æŸ¥çœ‹promethues</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;prometheuså¯¹åº”çš„nodeportç«¯å£ä¸º30005ï¼Œé€šè¿‡è®¿é—®<a href="http://172.21.17.4:30005/targets" target="_blank" rel="noopener">http://172.21.17.4:30005/targets</a> å¯ä»¥çœ‹åˆ°prometheuså·²ç»æˆåŠŸè¿æ¥ä¸Šäº†k8sçš„apiserver,è¿™é‡Œæˆ‘ä»¬å‰é¢å¢åŠ äº†prometheusçš„ingressï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥é€šè¿‡åŸŸåè¿›è¡Œè®¿é—®</p><p><img src="https://img.xxlaila.cn/skd9234342.png" alt="img"></p><h4 id="2-4-3ã€è®¿é—®grafana"><a href="#2-4-3ã€è®¿é—®grafana" class="headerlink" title="2.4.3ã€è®¿é—®grafana"></a>2.4.3ã€è®¿é—®grafana</h4><p>é€šè¿‡åŸŸåè®¿é—®grafanaï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç å‡ä¸ºadminï¼Œé…ç½®æ•°æ®æº<br><img src="https://img.xxlaila.cn/sld023423.png" alt="img"></p><ul><li>åˆ°grafanaå®˜æ–¹<a href="https://grafana.com/dashboards/315" target="_blank" rel="noopener">ä¸‹è½½æ¨¡ç‰ˆ</a>ï¼Œå¯¼å…¥jsonæ¨¡ç‰ˆ</li></ul><p><img src="https://img.xxlaila.cn/kf24skdsfds.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>kubednsæ’ä»¶é…ç½®</title>
    <url>/2019/08/10/kubedns%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h1 id="å®‰è£…å’Œé…ç½®kubednsæ’ä»¶"><a href="#å®‰è£…å’Œé…ç½®kubednsæ’ä»¶" class="headerlink" title="å®‰è£…å’Œé…ç½®kubednsæ’ä»¶"></a>å®‰è£…å’Œé…ç½®kubednsæ’ä»¶</h1><h2 id="1ã€é…ç½®æ–‡ä»¶å‡†å¤‡"><a href="#1ã€é…ç½®æ–‡ä»¶å‡†å¤‡" class="headerlink" title="1ã€é…ç½®æ–‡ä»¶å‡†å¤‡"></a>1ã€é…ç½®æ–‡ä»¶å‡†å¤‡</h2><p>ä¸‹è½½å®˜æ–¹çš„yamlæ–‡ä»¶ç›®å½•ï¼škubernetes/cluster/addons/dnsã€‚è¯¥æ’ä»¶ç›´æ¥ä½¿ç”¨kuberneteséƒ¨ç½²,yamlæ–‡ä»¶ç»è¿‡ä¿®æ”¹å®Œæˆéƒ¨ç½²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/coredns</span></span><br><span class="line"><span class="comment"># sed -i 's/10.96.0.10/10.254.0.2/g' coredns-service.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods,svc,rs -n kube-system</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-68676b6b88-l7b5g   1/1     Running   0          16m</span><br><span class="line"></span><br><span class="line">NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/coredns   ClusterIP   10.254.0.2   &lt;none&gt;        53/UDP,53/TCP   16m</span><br><span class="line"></span><br><span class="line">NAME                                       DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.extensions/coredns-68676b6b88   1         1         1       16m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-68676b6b88-l7b5g                1/1     Running   0          40m     10.254.28.2   172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…å’Œé…ç½®dashboard"><a href="#2ã€å®‰è£…å’Œé…ç½®dashboard" class="headerlink" title="2ã€å®‰è£…å’Œé…ç½®dashboard"></a>2ã€å®‰è£…å’Œé…ç½®dashboard</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;å®˜æ–¹é…ç½®æ–‡ä»¶kubernetes/cluster/addons/dashboardï¼Œè¿™é‡Œå·²ç»ä¿®æ”¹è¿‡äº†ï¼Œç»è¿‡æµ‹è¯•éƒ¨ç½²ï¼Œç›´æ¥è¿›å…¥dashboardç›®å½•ï¼Œä¿®æ”¹inageså‚æ•°è¿›è¡Œéƒ¨ç½²</p><a id="more"></a><h3 id="2-1ã€å®‰è£…dashboard"><a href="#2-1ã€å®‰è£…dashboard" class="headerlink" title="2.1ã€å®‰è£…dashboard"></a>2.1ã€å®‰è£…dashboard</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ../kubernetes-dashboard</span></span><br><span class="line"><span class="comment"># kubectl create -f kubernetes-dashboard.yaml </span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">kubernetes-dashboard-6c655d9445-4557x   1/1     Running   0          6m54s   10.254.90.2   172.21.16.110   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="2-2ã€é…ç½®è´¦æˆ·æˆæƒ"><a href="#2-2ã€é…ç½®è´¦æˆ·æˆæƒ" class="headerlink" title="2.2ã€é…ç½®è´¦æˆ·æˆæƒ"></a>2.2ã€é…ç½®è´¦æˆ·æˆæƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f admin-user.yaml </span></span><br><span class="line">serviceaccount/admin created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin created</span><br><span class="line"><span class="comment"># kubectl describe serviceaccount admin -n kube-system</span></span><br><span class="line">Name:                admin</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   admin-token-wwjw8</span><br><span class="line">Tokens:              admin-token-wwjw8</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"><span class="comment"># kubectl describe secret admin-token-wwjw8 -n kube-system</span></span><br><span class="line">åœ¨æµè§ˆå™¨è®¿é—®ä»»æ„èŠ‚ç‚¹IPåœ°å€http://&lt;node_ip&gt;:30001</span><br></pre></td></tr></table></figure><h2 id="3ã€ç›‘æ§å®‰è£…"><a href="#3ã€ç›‘æ§å®‰è£…" class="headerlink" title="3ã€ç›‘æ§å®‰è£…"></a>3ã€ç›‘æ§å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ../heapster-influxdb-grafana</span></span><br><span class="line"><span class="comment"># kubectl create -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE   IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">heapster-658646db69-lh5tx               1/1     Running   0          11m   10.254.28.3   172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">monitoring-grafana-7bfc56ffcd-kgh56     1/1     Running   0          11m   10.254.90.3   172.21.16.110   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">monitoring-influxdb-7478d7675c-9255v    1/1     Running   0          11m   10.254.85.2   172.21.16.244   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé‡åˆ°ä¸€ä¸ªæ€ªäº‹æƒ…ï¼›heapsterå®‰è£…ä»¥åå›¾å§‹ç»ˆæ— æ³•å‡ºæ¥ï¼Œè¿™é‡ŒæŠ˜è…¾å·®ä¸å¤šå¤§åŠå¤©ã€‚æœ€ååœ¨dashboardçš„yamlæ–‡ä»¶é‡Œé¢æ·»åŠ äº†ä»¥ä¸‹å‚æ•°ï¼Œå›¾å°±å¯ä»¥äº†ï¼Œ</p><p><img src="https://img.xxlaila.cn/4udfs93.png" alt="img"></p><p>args:<br>- â€“auto-generate-certificates<br>- â€“token-ttl=43200<br><em>- â€“heapster-host=<a href="http://heapster" target="_blank" rel="noopener">http://heapster</a></em></p><p><img src="https://img.xxlaila.cn/ds832948dk.png" alt="img"></p><p>Prometheusçš„å®‰è£…è¯·å‚è€ƒ<a href="http://xxlaila.github.io/2019/08/10/k8s-prometheus/" target="_blank" rel="noopener">ã€ŠPrometheus å…¥é—¨ã€‹</a>æ–‡ç« ï¼Œgrafanaä¸éœ€è¦é‡å¤éƒ¨ç½²ã€‚åªéœ€è¦åœ¨grafanaé‡Œé¢å¢åŠ ç›®å½•æŒ‚åœ¨ï¼Œå§kube-ops ä¿®æ”¹kube-systemå³å¯</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kube-dns,dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes nodeèŠ‚ç‚¹å®‰è£…</title>
    <url>/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>More: <a href="https://xxlaila.github.io/2019/08/09/kubernetes-v1-13-3%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">masterèŠ‚ç‚¹å®‰è£…è¯·å‚è€ƒ</a></p><h2 id="1ã€éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹"><a href="#1ã€éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹" class="headerlink" title="1ã€éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹"></a>1ã€éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹</h2><p>Kubernetes nodeèŠ‚ç‚¹åŒ…å«å¦‚ä¸‹ç»„ä»¶ï¼š</p><ul><li><strong>Flanneld</strong>: ä¹‹å‰å•æœºèŠ‚ç‚¹å®‰è£…æ²¡æœ‰é…ç½®TLSï¼Œç°åœ¨éœ€è¦åœ¨serviceé…ç½®æ–‡ä»¶ä¸­å¢åŠ TLSé…ç½®</li><li><strong>Docker</strong>: version 18.06.2-ce</li><li><strong>kubelet</strong></li><li><strong>kube-proxy</strong></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls /etc/kubernetes/</span></span><br><span class="line">bootstrap.kubeconfig  kubelet   kube-proxy.kubeconfig  proxy  ssl</span><br><span class="line"><span class="comment"># ls /etc/kubernetes/ssl</span></span><br><span class="line">admin-key.pem  kube-apiserver-key.pem  kube-controller-manager-key.pem  kubelet-api-admin-key.pem   kube-proxy-key.pem  kubernetes-ca-key.pem  kube-scheduler-key.pem</span><br><span class="line">admin.pem      kube-apiserver.pem      kube-controller-manager.pem      kubelet-api-admin.pem       kube-proxy.pem      kubernetes-ca.pem      kube-scheduler.pem</span><br></pre></td></tr></table></figure><h3 id="å¢åŠ docker-æº"><a href="#å¢åŠ docker-æº" class="headerlink" title="å¢åŠ docker æº"></a>å¢åŠ docker æº</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum-config-manager \</span></span><br><span class="line">  --add-repo \</span><br><span class="line">  https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><ul><li><p>æ ¹æ®å®é™…æŸ¥æ‰¾å½“å‰ç‰ˆæœ¬ (å¯é€‰)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum list docker-ce --showduplicates | sort -r</span></span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœç¡®å®šäº†ç‰ˆæœ¬,ç›´æ¥å®‰è£…,å¦‚æœè¦è£…17ã€‚03ç›´æ¥ä¿®æ”¹ä¸‹é¢æ•°å­—å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install docker-ce-18.06.2.ce-3.el7  # ä¸»æ„ç‰ˆæœ¬å¡«å†™åŒ…åçš„æ ¼å¼.</span></span><br></pre></td></tr></table></figure></li><li><p>å¯dockeræœåŠ¡,å’Œå¼€æœºå¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="1-1ã€å®‰è£…flanneld"><a href="#1-1ã€å®‰è£…flanneld" class="headerlink" title="1.1ã€å®‰è£…flanneld"></a>1.1ã€å®‰è£…flanneld</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mv kubernetes  /etc/ &amp;&amp; chown -R root: /etc/kubernetes</span></span><br><span class="line"><span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf flannel-v0.11.0-linux-amd64.tar.gz &amp;&amp; mv flanneld mk-docker-opts.sh /usr/bin/ &amp;&amp; rm -rf flannel-v0.11.0-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><h4 id="1-1-1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶"><a href="#1-1-1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶" class="headerlink" title="1.1.1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶"></a>1.1.1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/flanneld.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=etcd.service</span><br><span class="line">Before=docker.service</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/etc/sysconfig/flanneld</span><br><span class="line">ExecStart=/usr/bin/flanneld -etcd-endpoints=<span class="variable">$&#123;FLANNEL_ETCD&#125;</span> <span class="variable">$FLANNEL_OPTIONS</span></span><br><span class="line">ExecStartPost=/usr/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">RequiredBy=docker.service</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-1-2ã€flanneldé…ç½®æ–‡ä»¶"><a href="#1-1-2ã€flanneldé…ç½®æ–‡ä»¶" class="headerlink" title="1.1.2ã€flanneldé…ç½®æ–‡ä»¶"></a>1.1.2ã€flanneldé…ç½®æ–‡ä»¶</h4><p>flanneld é…ç½®æ–‡ä»¶è¿æ¥äº†etcdï¼Œè€Œåœ¨é…ç½®etcdçš„æ—¶å€™éœ€è¦è¯ä¹¦ï¼Œæ‰€ä»¥è®°çš„å§è¯ä¹¦copyåˆ°nodeèŠ‚ç‚¹ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/sysconfig/flanneld</span></span><br><span class="line"><span class="comment"># Flanneld configuration options</span></span><br><span class="line"><span class="comment"># etcd url location.  Point this to the server where etcd runs</span></span><br><span class="line">FLANNEL_ETCD=<span class="string">"https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379"</span></span><br><span class="line"><span class="comment"># etcd config key.  This is the configuration key that flannel queries</span></span><br><span class="line"><span class="comment"># For address range assignment</span></span><br><span class="line">FLANNEL_ETCD_PREFIX=<span class="string">"/coreos.com/network"</span></span><br><span class="line"><span class="comment"># Any additional options that you want to pass</span></span><br><span class="line">FLANNEL_OPTIONS=<span class="string">"-etcd-cafile=/etc/etcd/ssl/etcd-ca.pem -etcd-certfile=/etc/etcd/ssl/etcd.pem -etcd-keyfile=/etc/etcd/ssl/etcd-key.pem"</span></span><br></pre></td></tr></table></figure><ul><li>åœ¨å¯åŠ¨flanneldä¹‹å‰ï¼Œéœ€è¦åœ¨etcdä¸­æ·»åŠ ä¸€æ¡ç½‘ç»œé…ç½®è®°å½•ï¼Œè¿™ä¸ªé…ç½®å°†ç”¨äºflanneldåˆ†é…ç»™æ¯ä¸ªdockerçš„è™šæ‹Ÿipåœ°å€æ®µ,</li><li>åœ¨ä»»æ„ä¸€å°masteræ‰§è¡Œ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl set /coreos.com/network/config '&#123; "Network": "10.254.0.0/16" &#125;'</span></span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"10.254.0.0/16"</span> &#125;</span><br><span class="line"><span class="comment"># etcdctl get  /coreos.com/network/config </span></span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"10.254.0.0/16"</span> &#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰§è¡Œçš„æ—¶å€™æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºå‰é¢etcdæ˜¯å¯ç”¨äº†httpsçš„ï¼Œå¦åˆ™çš„è¯ï¼Œä¼šæŠ¥<code>Error: client: etcd cluster is unavailable or misconfigured; error #0: x509: certificate signed by unknown authority</code>çš„é”™è¯¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcd.rc</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_ENDPOINT=https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CERT_FILE=/etc/etcd/ssl/etcd.pem</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_KEY_FILE=/etc/etcd/ssl/etcd-key.pem</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CA_FILE=/etc/etcd/ssl/etcd-ca.pem</span><br></pre></td></tr></table></figure><h3 id="1-1-3ã€å¯åŠ¨flanneld"><a href="#1-1-3ã€å¯åŠ¨flanneld" class="headerlink" title="1.1.3ã€å¯åŠ¨flanneld"></a>1.1.3ã€å¯åŠ¨flanneld</h3><p>åœ¨å¯åŠ¨flanneldä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹dockerçš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/docker.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable flanneld &amp;&amp;systemctl start flanneld &amp;&amp;systemctl status flanneld</span></span><br></pre></td></tr></table></figure><p>é‡å¯äº†dockerå’Œflanneldä»¥åï¼Œæˆ‘ä»¬åœ¨ä»»æ„ä¸€å°nodeèŠ‚ç‚¹ä¸Šé€šè¿‡ip add så¯ä»¥æŸ¥çœ‹ã€‚flanneld å’Œdocker ç½‘ç»œç»‘å®šçš„æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip add s</span></span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…å’Œé…ç½®kubelet"><a href="#2ã€å®‰è£…å’Œé…ç½®kubelet" class="headerlink" title="2ã€å®‰è£…å’Œé…ç½®kubelet"></a>2ã€å®‰è£…å’Œé…ç½®kubelet</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;kubeletå¯åŠ¨æ—¶å‘kube-apiserverå‘é€tls bootstrappingè¯·æ±‚ï¼Œéœ€è¦å°†bootstrap tokenæ–‡ä»¶ä¸­kube-bootsrapç”¨æˆ·æˆäºˆsystem:node-bootstrapper clusterè§’è‰²ï¼ˆroleï¼‰ï¼Œç„¶åkubeletæ‰èƒ½æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚ï¼ˆcertificate signing requestsï¼‰</p><h3 id="2-1ã€å®‰è£…kubelet"><a href="#2-1ã€å®‰è£…kubelet" class="headerlink" title="2.1ã€å®‰è£…kubelet"></a>2.1ã€å®‰è£…kubelet</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.13.3/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzf kubernetes-server-linux-amd64.tar.gz &amp;&amp;cp -r ./kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; /usr/bin/ &amp;&amp; rm -rf ./kubernetes*</span></span><br></pre></td></tr></table></figure><h3 id="2-2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶"><a href="#2-2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶" class="headerlink" title="2.2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶"></a>2.2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kubelet.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kubelet</span><br><span class="line">ExecStart=/usr/bin/kubelet \</span><br><span class="line">           <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">           <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">           <span class="variable">$KUBELET_API_SERVER</span> \</span><br><span class="line">           <span class="variable">$KUBELET_ADDRESS</span> \</span><br><span class="line">           <span class="variable">$KUBELET_PORT</span> \</span><br><span class="line">           <span class="variable">$KUBELET_HOSTNAME</span> \</span><br><span class="line">           <span class="variable">$KUBE_ALLOW_PRIV</span> \</span><br><span class="line">           <span class="variable">$KUBELET_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="2-3ã€kubeleté…ç½®æ–‡ä»¶"><a href="#2-3ã€kubeleté…ç½®æ–‡ä»¶" class="headerlink" title="2.3ã€kubeleté…ç½®æ–‡ä»¶"></a>2.3ã€kubeleté…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kubelet</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes kubelet (minion) config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span></span><br><span class="line">KUBELET_ADDRESS=<span class="string">"--node-ip=&#123;node_ip&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The port for the info server to serve on</span></span><br><span class="line"><span class="comment"># KUBELET_PORT="--port=10250"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may leave this blank to use the actual hostname</span></span><br><span class="line">KUBELET_HOSTNAME=<span class="string">"--hostname-override=&#123;node_ip&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># location of the api-server</span></span><br><span class="line"><span class="comment"># KUBELET_API_SERVER=""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBELET_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                --allow-privileged \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --authorization-mode=Webhook \</span></span><br><span class="line"><span class="string">                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --cgroup-driver=cgroupfs \</span></span><br><span class="line"><span class="string">                --cert-dir=/etc/kubernetes/ssl \</span></span><br><span class="line"><span class="string">                --cluster-dns=10.254.0.2 \</span></span><br><span class="line"><span class="string">                --cluster-domain=cluster.local \</span></span><br><span class="line"><span class="string">                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% \</span></span><br><span class="line"><span class="string">                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m \</span></span><br><span class="line"><span class="string">                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% \</span></span><br><span class="line"><span class="string">                --eviction-max-pod-grace-period=30 \</span></span><br><span class="line"><span class="string">                --image-gc-high-threshold=80 \</span></span><br><span class="line"><span class="string">                --image-gc-low-threshold=70 \</span></span><br><span class="line"><span class="string">                --image-pull-progress-deadline=30s \</span></span><br><span class="line"><span class="string">                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">                --max-pods=100 \</span></span><br><span class="line"><span class="string">                --minimum-image-ttl-duration=720h0m0s \</span></span><br><span class="line"><span class="string">                --node-labels=node.kubernetes.io/k8s-node=true \</span></span><br><span class="line"><span class="string">                --pod-infra-container-image=docker.io/kubernetes/pause:latest \</span></span><br><span class="line"><span class="string">                --port=10250 \</span></span><br><span class="line"><span class="string">                --read-only-port=0 \</span></span><br><span class="line"><span class="string">                --rotate-certificates \</span></span><br><span class="line"><span class="string">                --rotate-server-certificates \</span></span><br><span class="line"><span class="string">                --fail-swap-on=false \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure><h3 id="2-4ã€å¯åŠ¨kubelet"><a href="#2-4ã€å¯åŠ¨kubelet" class="headerlink" title="2.4ã€å¯åŠ¨kubelet"></a>2.4ã€å¯åŠ¨kubelet</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /var/lib/kubelet -p</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet &amp;&amp;systemctl start kubelet &amp;&amp; systemctl status kubelet</span></span><br><span class="line"><span class="comment"># journalctl -fxeu kubelet</span></span><br></pre></td></tr></table></figure><h2 id="3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚"><a href="#3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚" class="headerlink" title="3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚"></a>3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚</h2><p>kubeleté¦–æ¬¡å¯åŠ¨æ—¶åƒkube-apiserverå‘é€è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œå¿…é¡»é€šè¿‡åkubernetesç³»ç»Ÿæ‰ä¼šå°†è¯¥nodeåŠ å…¥é›†ç¾¤ï¼š</p><h3 id="3-1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚"><a href="#3-1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚" class="headerlink" title="3.1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚"></a>3.1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚</h3><ul><li>ä»»æ„masterèŠ‚ç‚¹å‡å¯</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE   REQUESTOR                   CONDITION</span><br><span class="line">csr-kxfql                                              78m   system:node:172.21.16.204   Pending</span><br><span class="line">node-csr-QptfMgAu2y4GmUZX1Ph9B0XomA0Rg-fxcgs0Yzd-XRU   79m   system:bootstrap:ff90fd     Approved,Issued</span><br><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure><h3 id="3-2ã€é€šè¿‡csrè¯·æ±‚"><a href="#3-2ã€é€šè¿‡csrè¯·æ±‚" class="headerlink" title="3.2ã€é€šè¿‡csrè¯·æ±‚"></a>3.2ã€é€šè¿‡csrè¯·æ±‚</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl certificate approve csr-kxfql</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-kxfql approved</span><br></pre></td></tr></table></figure><ul><li>è‡ªåŠ¨ç”Ÿæˆkubelet kubeconfigæ–‡ä»¶å’Œå…¬ç§é’¥,æ–°ç‰ˆæœ¬ kubelet server çš„è¯ä¹¦è‡ªåŠ¨ç­¾å‘å·²ç»è¢«å…³é—­,æ‰€ä»¥å¯¹äº kubelet server çš„è¯ä¹¦ä»éœ€è¦æ‰‹åŠ¨ç­¾ç½²</li></ul><h2 id="4ã€é…ç½®kube-proxy"><a href="#4ã€é…ç½®kube-proxy" class="headerlink" title="4ã€é…ç½®kube-proxy"></a>4ã€é…ç½®kube-proxy</h2><h3 id="4-1ã€kupe-proxy-å¯åŠ¨æ–‡ä»¶"><a href="#4-1ã€kupe-proxy-å¯åŠ¨æ–‡ä»¶" class="headerlink" title="4.1ã€kupe-proxy å¯åŠ¨æ–‡ä»¶"></a>4.1ã€kupe-proxy å¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-proxy.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/proxy</span><br><span class="line">ExecStart=/usr/bin/kube-proxy \</span><br><span class="line">       <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">       <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">       <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">       <span class="variable">$KUBE_PROXY_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="4-2ã€kube-proxyé…ç½®æ–‡ä»¶"><a href="#4-2ã€kube-proxyé…ç½®æ–‡ä»¶" class="headerlink" title="4.2ã€kube-proxyé…ç½®æ–‡ä»¶"></a>4.2ã€kube-proxyé…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/proxy</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes proxy config</span></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_PROXY_ARGS=<span class="string">"   --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                    --cleanup-ipvs=true \</span></span><br><span class="line"><span class="string">                    --cluster-cidr=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                    --hostname-override=docker4.node \</span></span><br><span class="line"><span class="string">                    --healthz-bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                    --healthz-port=10256 \</span></span><br><span class="line"><span class="string">                    --masquerade-all=true \</span></span><br><span class="line"><span class="string">                    --proxy-mode=ipvs \</span></span><br><span class="line"><span class="string">                    --ipvs-min-sync-period=5s \</span></span><br><span class="line"><span class="string">                    --ipvs-sync-period=5s \</span></span><br><span class="line"><span class="string">                    --ipvs-scheduler=wrr \</span></span><br><span class="line"><span class="string">                    --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \</span></span><br><span class="line"><span class="string">                    --logtostderr=true \</span></span><br><span class="line"><span class="string">                    --v=2"</span></span><br></pre></td></tr></table></figure><h3 id="4-3ã€å¯åŠ¨kube-proxy"><a href="#4-3ã€å¯åŠ¨kube-proxy" class="headerlink" title="4.3ã€å¯åŠ¨kube-proxy"></a>4.3ã€å¯åŠ¨kube-proxy</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-proxy &amp;&amp; systemctl start kube-proxy &amp;&amp; systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure><h3 id="4-4-åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰"><a href="#4-4-åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰" class="headerlink" title="4.4 åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰"></a>4.4 åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰</h3><p>ç”±äº kubelet ç»„ä»¶æ˜¯é‡‡ç”¨ TLS Bootstrap å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆåˆ›å»ºç›¸å…³é…ç½®</p><ul><li>åˆ›å»ºç”¨äº tls bootstrap çš„ token secret<blockquote><p>masterèŠ‚ç‚¹æ“ä½œ</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f bootstrap.secret.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>ä¸ºäº†èƒ½è®© kubelet å®ç°è‡ªåŠ¨æ›´æ–°è¯ä¹¦ï¼Œéœ€è¦é…ç½®ç›¸å…³ clusterrolebinding</p><ul><li><p>å…è®¸ kubelet tls bootstrap åˆ›å»º csr è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding create-csrs-for-bootstrapping \</span><br><span class="line">    --clusterrole=system:node-bootstrapper \</span><br><span class="line">    --group=system:bootstrappers</span><br></pre></td></tr></table></figure></li><li><p>è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding auto-approve-csrs-for-group \</span><br><span class="line">    --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient \</span><br><span class="line">    --group=system:bootstrappers</span><br></pre></td></tr></table></figure></li><li><p>è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding auto-approve-renewals-for-nodes \</span><br><span class="line">    --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient \</span><br><span class="line">    --group=system:nodes</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ kubelet server å¼€å¯ api è®¤è¯çš„æƒ…å†µä¸‹ï¼Œapiserver åå‘è®¿é—® kubelet 10250 éœ€è¦æ­¤æˆæƒ(eg: kubectl logs)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding system:kubelet-api-admin \</span><br><span class="line">    --clusterrole=system:kubelet-api-admin \</span><br><span class="line">    --user=system:kubelet-api-admin</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>é—®é¢˜</strong>:<br>åœ¨å¯åŠ¨kubeletçš„æ—¶å€™ï¼ŒnodeèŠ‚ç‚¹åœ¨masterèŠ‚ç‚¹æ— æ³•æŸ¥çœ‹ï¼ŒæŸ¥çœ‹kubeletçš„æ—¥å¿—æç¤ºå¦‚ä¸‹ï¼š</li><li>æŸ¥çœ‹kubeletçš„æ—¥å¿—æ–¹å¼æœ‰ä¸¤ç§</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># journalctl -f -u kubelet</span></span><br><span class="line"><span class="comment"># systemctl  status kubelet -l</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹nodes<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.16.244   Ready    &lt;none&gt;   12m   v1.13.3</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>éªŒè¯æµ‹è¯•é›†ç¾¤</strong><br>åˆ›å»ºä¸€ä¸ªnginxæµ‹è¯•é›†ç¾¤æ˜¯å¦å¯ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl run nginx --image=docker.io/nginx:latest --replicas=2 --labels run=nginx</span></span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line"><span class="comment"># kubectl expose deployment nginx --port=80 --type=NodePort</span></span><br><span class="line">service/nginx exposed</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹podæƒ…å†µ</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                     READY   STATUS              RESTARTS   AGE   IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-766994fc9f-gcv4n   0/1     ContainerCreating   0          55s   &lt;none&gt;        172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-766994fc9f-w2j8p   1/1     Running             0          55s   10.254.45.2   172.21.16.83    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹å¯¹å¤–çš„æœåŠ¡</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc nginx</span></span><br><span class="line">NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">nginx   NodePort   10.254.11.147   &lt;none&gt;        80:48713/TCP   31s</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å®Œæˆåï¼Œé€šè¿‡ä»»æ„nodeèŠ‚ç‚¹IPçš„åœ°å€åŠ ç«¯å£48713å³å¯è®¿é—®<br><a href="http://node-ip:48713/" target="_blank" rel="noopener">http://node-ip:48713/</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes v13.3 node</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes v1.13.3å®‰è£…</title>
    <url>/2019/08/09/kubernetes-v1-13-3%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h2 id="1ã€-ç¯å¢ƒå‡†å¤‡"><a href="#1ã€-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ ç¯å¢ƒå‡†å¤‡"></a>1ã€ ç¯å¢ƒå‡†å¤‡</h2><table><thead><tr><th>ip</th><th>type</th><th>docker</th><th>os</th><th>k8s version</th></tr></thead><tbody><tr><td>172.21.17.4</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td>v1.13.3</td></tr><tr><td>172.21.16.230</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.240</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.244</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.248</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.45</td><td>vip</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr></tbody></table><h2 id="2ã€éƒ¨ç½²ETCé›†ç¾¤"><a href="#2ã€éƒ¨ç½²ETCé›†ç¾¤" class="headerlink" title="2ã€éƒ¨ç½²ETCé›†ç¾¤"></a>2ã€éƒ¨ç½²ETCé›†ç¾¤</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;etcdçš„æ­£å¸¸è¿è¡Œæ˜¯k8sé›†ç¾¤è¿è¡Œçš„æå‰æ¡ä»¶ï¼Œå› æ­¤éƒ¨ç½²k8sé›†ç¾¤é¦–å…ˆéƒ¨ç½²etcdé›†ç¾¤ã€‚å®‰è£…CAè¯ä¹¦ï¼Œå®‰è£…CFSSLè¯ä¹¦ç®¡ç†å·¥å…·ã€‚ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…</p><a id="more"></a><h3 id="2-1ã€ä¸‹è½½cfssl"><a href="#2-1ã€ä¸‹è½½cfssl" class="headerlink" title="2.1ã€ä¸‹è½½cfssl"></a>2.1ã€ä¸‹è½½cfssl</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -o cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="comment"># chmod +x * &amp;&amp;mv cfssl* /usr/bin/</span></span><br></pre></td></tr></table></figure><h3 id="2-2-ã€åˆ›å»ºetcdè¯ä¹¦"><a href="#2-2-ã€åˆ›å»ºetcdè¯ä¹¦" class="headerlink" title="2.2 ã€åˆ›å»ºetcdè¯ä¹¦"></a>2.2 ã€åˆ›å»ºetcdè¯ä¹¦</h3><ul><li><p>etcd-ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir etcd_ssl &amp;&amp; cd etcd_ssl</span></span><br><span class="line"><span class="comment"># cat etcd-ca-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd-ca"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 4096</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"etcd Security"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"ca"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>etcd-gencert.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat etcd-gencert.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">          <span class="string">"signing"</span>,</span><br><span class="line">          <span class="string">"key encipherment"</span>,</span><br><span class="line">          <span class="string">"server auth"</span>,</span><br><span class="line">          <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>etcd-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat etcd-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"etcd Security"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"172.21.17.4"</span>,</span><br><span class="line">        <span class="string">"172.21.16.231"</span>,</span><br><span class="line">        <span class="string">"172.21.16.240"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥æ‰§è¡Œç”Ÿæˆå³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert --initca=true etcd-ca-csr.json | cfssljson --bare etcd-ca</span></span><br><span class="line"><span class="comment"># cfssl gencert --ca etcd-ca.pem --ca-key etcd-ca-key.pem --config etcd-gencert.json etcd-csr.json | cfssljson --bare etcd</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/etcd/ssl &amp;&amp;mkdir -p /var/lib/etcd</span></span><br><span class="line"><span class="comment"># cp *.pem /etc/etcd/ssl</span></span><br><span class="line"><span class="comment"># ls /etc/etcd/ssl/</span></span><br><span class="line">etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem</span><br><span class="line"><span class="comment"># scp -r /etc/etcd k8s-master-02:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/etcd k8s-master-03:/etc</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="2-3ã€å¼€å§‹é…ç½®etcd"><a href="#2-3ã€å¼€å§‹é…ç½®etcd" class="headerlink" title="2.3ã€å¼€å§‹é…ç½®etcd"></a>2.3ã€å¼€å§‹é…ç½®etcd</h3><h4 id="2-3-1ã€ä¸‹è½½etcd"><a href="#2-3-1ã€ä¸‹è½½etcd" class="headerlink" title="2.3.1ã€ä¸‹è½½etcd"></a>2.3.1ã€ä¸‹è½½etcd</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.3.15/etcd-v3.3.15-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf etcd-v3.3.15-linux-amd64.tar.gz &amp;&amp;cd etcd-v3.3.15-linux-amd64 &amp;&amp;cp -arp etcd* /usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="2-3-2ã€åˆ›å»ºetcdçš„Systemd-unit-æ–‡ä»¶"><a href="#2-3-2ã€åˆ›å»ºetcdçš„Systemd-unit-æ–‡ä»¶" class="headerlink" title="2.3.2ã€åˆ›å»ºetcdçš„Systemd unit æ–‡ä»¶"></a>2.3.2ã€åˆ›å»ºetcdçš„Systemd unit æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;Etcd è¿™é‡Œé‡‡ç”¨æœ€æ–°çš„ 3.3.15 ç‰ˆæœ¬ï¼Œå®‰è£…æ–¹å¼ç›´æ¥å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ã€systemd service é…ç½®å³å¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„ç›¸å…³ç”¨æˆ·æƒé™é—®é¢˜ï¼Œä»¥ä¸‹è„šæœ¬é…ç½®ç­‰å‚è€ƒäº† etcd rpm å®‰è£…åŒ…</p><h4 id="2-3-3ã€é…ç½®etcd-conf"><a href="#2-3-3ã€é…ç½®etcd-conf" class="headerlink" title="2.3.3ã€é…ç½®etcd.conf"></a>2.3.3ã€é…ç½®etcd.conf</h4><ul><li>k8s-master-01<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd1</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.17.4:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.17.4:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.17.4:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.17.4:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p>k8s-master-02</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd2</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.16.231:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.16.231:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.16.231:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.16.231:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li><li><p>k8s-master-03</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd3</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.16.240:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.16.240:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-3-4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶"><a href="#2-3-4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶" class="headerlink" title="2.3.4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶"></a>2.3.4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/etcd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">User=etcd</span><br><span class="line"><span class="comment"># set GOMAXPROCS to number of processors</span></span><br><span class="line">ExecStart=/bin/bash -c <span class="string">"GOMAXPROCS=<span class="variable">$(nproc)</span> /usr/bin/etcd --name=\"<span class="variable">$&#123;ETCD_NAME&#125;</span>\" --data-dir=\"<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span>\" --listen-client-urls=\"<span class="variable">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>\""</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="2-3-5ã€etcdæˆæƒ"><a href="#2-3-5ã€etcdæˆæƒ" class="headerlink" title="2.3.5ã€etcdæˆæƒ"></a>2.3.5ã€etcdæˆæƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># groupadd -r etcd</span></span><br><span class="line"><span class="comment"># useradd -r -g etcd -d /var/lib/etcd -s /sbin/nologin -c "etcd user" etcd</span></span><br><span class="line"><span class="comment"># chown -R etcd:etcd /etc/etcd &amp;&amp; chmod -R 755 /etc/etcd/ssl &amp;&amp;chown -R etcd:etcd /var/lib/etcd</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp;systemctl start etcd &amp;&amp; systemctl status etcd</span></span><br></pre></td></tr></table></figure><h4 id="2-3-6ã€éªŒè¯etcd"><a href="#2-3-6ã€éªŒè¯etcd" class="headerlink" title="2.3.6ã€éªŒè¯etcd"></a>2.3.6ã€éªŒè¯etcd</h4><p>ç”±äºetcdä½¿ç”¨äº†è¯ä¹¦ï¼Œæ‰€ä»¥etcdå‘½ä»¤éœ€è¦å¸¦ä¸Šè¯ä¹¦</p><ul><li><p>æŸ¥çœ‹æˆå‘˜åˆ—è¡¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl --key-file /etc/etcd/ssl/etcd-key.pem --cert-file /etc/etcd/ssl/etcd.pem --ca-file /etc/etcd/ssl/etcd-ca.pem member list</span></span><br><span class="line">93c04a995ff8aa8: name=etcd3 peerURLs=https://172.21.16.240:2380 clientURLs=https://172.21.16.240:2379 isLeader=<span class="literal">false</span></span><br><span class="line">7cc4daf6e4db3a8a: name=etcd2 peerURLs=https://172.21.16.231:2380 clientURLs=https://172.21.16.231:2379 isLeader=<span class="literal">false</span></span><br><span class="line">ec7ea930930d012e: name=etcd1 peerURLs=https://172.21.17.4:2380 clientURLs=https://172.21.17.4:2379 isLeader=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl --key-file /etc/etcd/ssl/etcd-key.pem --cert-file /etc/etcd/ssl/etcd.pem --ca-file /etc/etcd/ssl/etcd-ca.pem cluster-health</span></span><br><span class="line">member 93c04a995ff8aa8 is healthy: got healthy result from https://172.21.16.240:2379</span><br><span class="line">member 7cc4daf6e4db3a8a is healthy: got healthy result from https://172.21.16.231:2379</span><br><span class="line">member ec7ea930930d012e is healthy: got healthy result from https://172.21.17.4:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure></li></ul><h2 id="3ã€éƒ¨ç½²kubernetes"><a href="#3ã€éƒ¨ç½²kubernetes" class="headerlink" title="3ã€éƒ¨ç½²kubernetes"></a>3ã€éƒ¨ç½²kubernetes</h2><h3 id="3-1-ä»‹ç»"><a href="#3-1-ä»‹ç»" class="headerlink" title="3.1 ä»‹ç»"></a>3.1 ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ–°ç‰ˆæœ¬å·²ç»è¶Šæ¥è¶Šè¶‹è¿‘å…¨é¢ TLS + RBAC é…ç½®ï¼Œæ‰€ä»¥æœ¬æ¬¡å®‰è£…å°†ä¼šå¯åŠ¨å¤§éƒ¨åˆ† TLS + RBAC é…ç½®ï¼ŒåŒ…æ‹¬ kube-controler-managerã€kube-scheduler ç»„ä»¶ä¸å†è¿æ¥æœ¬åœ° kube-apiserver çš„ 8080 éè®¤è¯ç«¯å£ï¼Œkubelet ç­‰ç»„ä»¶ API ç«¯ç‚¹å…³é—­åŒ¿åè®¿é—®ï¼Œå¯åŠ¨ RBAC è®¤è¯ç­‰ï¼›ä¸ºäº†æ»¡è¶³è¿™äº›è®¤è¯ï¼Œéœ€è¦ç­¾ç½²ä»¥ä¸‹è¯ä¹¦</p><h3 id="3-2ã€åˆ›å»ºCA"><a href="#3-2ã€åˆ›å»ºCA" class="headerlink" title="3.2ã€åˆ›å»ºCA"></a>3.2ã€åˆ›å»ºCA</h3><h4 id="3-2-1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶"><a href="#3-2-1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶" class="headerlink" title="3.2.1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶"></a>3.2.1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶</h4><ul><li><p>kubernetes-ca-csr.jsoné›†ç¾¤CAæ ¹è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir ssl &amp;&amp; cd ssl/</span></span><br><span class="line"><span class="comment"># cat kubernetes-ca-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 4096</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"ca"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>â€œCNâ€</strong>: Common Nameï¼Œkube-apiserver ä»è¯¥è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·åï¼ˆUser Nameï¼‰;æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™åˆæ³•æ€§ï¼›</li><li><strong>â€œOâ€</strong>: Organizationï¼Œkube-apiserverä»è¯¥è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±ç»„ï¼ˆGroupï¼‰ï¼›</li></ul></li><li><p>kubernetes-gencert.json<br>ç”¨äºç”Ÿæˆå…¶ä»–è¯ä¹¦çš„æ ‡å‡†</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubernetes-gencert.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"signing"</span>: &#123;</span><br><span class="line">        <span class="string">"default"</span>: &#123;</span><br><span class="line">            <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"profiles"</span>: &#123;</span><br><span class="line">            <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">                <span class="string">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"server auth"</span>,</span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-apiserver-csr.json<br>apiserver TLS è®¤è¯ç«¯å£éœ€è¦çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-apiserver-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"10.254.0.1"</span>,</span><br><span class="line">        <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"172.21.16.45"</span>,</span><br><span class="line">        <span class="string">"*.master.kubernetes.node"</span>,</span><br><span class="line">        <span class="string">"kubernetes"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>172.21.16.45</strong>: vipåœ°å€</li><li>å¦‚æœhostså­—æ®µä¸ä¸ºç©ºåˆ™éœ€è¦æŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ipæˆ–åŸŸååˆ—è¡¨,kube-apiserveræŒ‡å®šçš„service-cluster-ip-rangeç½‘æ®µçš„ç¬¬ä¸€ä¸ªipï¼Œå¦‚10.254.0.1</li></ul><ul><li><p>kube-controller-manager-csr.json<br>controller manager è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« 10257 ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-controller-manager-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"localhost"</span>,</span><br><span class="line">    <span class="string">"*.master.kubernetes.node"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-scheduler-csr.json<br>schedulerè¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« 10259 ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-scheduler-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"localhost"</span>,</span><br><span class="line">    <span class="string">"*.master.kubernetes.node"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-proxy-csr.json<br>proxy ç»„ä»¶è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-proxy-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kubelet-api-admin-csr.json<br>apiserver åå‘è¿æ¥ kubelet ç»„ä»¶ 10250 ç«¯å£éœ€è¦ä½¿ç”¨çš„è¯ä¹¦(ä¾‹å¦‚æ‰§è¡Œ kubectl logs)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubelet-api-admin-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kubelet-api-admin"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:kubelet-api-admin"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>admin-csr.json<br>é›†ç¾¤ç®¡ç†å‘˜(kubectl)è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat admin-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>æ³¨æ„</strong>: è¯ä¹¦æ–‡ä»¶é‡Œé¢çš„CNã€Oå­—æ®µï¼Œä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„å­—æ®µï¼ŒåŸºæœ¬éƒ½æ˜¯system:å¼€å¤´ï¼Œæ˜¯ä¸ºäº†åŒ¹é…RBACè§„åˆ™,<a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings" target="_blank" rel="noopener">è¯¦æƒ…å‚è€ƒ</a></p><h4 id="3-3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯"><a href="#3-3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯" class="headerlink" title="3.3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯"></a>3.3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert --initca=true kubernetes-ca-csr.json | cfssljson --bare kubernetes-ca</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for targetName in kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet-api-admin admin; do</span></span><br><span class="line">  cfssl gencert --ca kubernetes-ca.pem --ca-key kubernetes-ca-key.pem --config kubernetes-gencert.json --profile kubernetes <span class="variable">$targetName</span>-csr.json | cfssljson --bare <span class="variable">$targetName</span>; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="3-4ã€åˆ†å‘è¯ä¹¦"><a href="#3-4ã€åˆ†å‘è¯ä¹¦" class="headerlink" title="3.4ã€åˆ†å‘è¯ä¹¦"></a>3.4ã€åˆ†å‘è¯ä¹¦</h4><p>å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ï¼ˆåç¼€åä¸º.pemï¼‰æ‹·è´åˆ°æ‰€æœ‰æœºå™¨ï¼›kubernetesç³»ç»Ÿçš„å„ä¸ªç»„å»ºéœ€è¦ä½¿ç”¨tlsè¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†ã€‚</p><h5 id="1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š"><a href="#1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š" class="headerlink" title="1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š"></a>1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š</h5><ul><li>admin-key.pem</li><li>admin.pem</li><li>kube-apiserver-key.pem</li><li>kube-apiserver.pem</li><li>kube-controller-manager-key.pem</li><li>kube-controller-manager.pem</li><li>kubelet-api-admin-key.pem</li><li>kubelet-api-admin.pem</li><li>kube-proxy-key.pem</li><li>kube-proxy.pem</li><li>kubernetes-ca-key.pem</li><li>kubernetes-ca.pem</li><li>kube-scheduler-key.pem</li><li>kube-scheduler.pem</li></ul><h5 id="3ï¼‰ã€è¯ä¹¦æ‹·è´"><a href="#3ï¼‰ã€è¯ä¹¦æ‹·è´" class="headerlink" title="3ï¼‰ã€è¯ä¹¦æ‹·è´"></a>3ï¼‰ã€è¯ä¹¦æ‹·è´</h5><ul><li><p><strong>master èŠ‚ç‚¹æ‹·è´</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/kubernetes/ssl</span></span><br><span class="line"><span class="comment"># cp *.pem /etc/kubernetes/ssl/</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes k8s-master-02:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes k8s-master-03:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes node-01:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes node-02:/etc</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºç›®å½•</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/kube-audit &amp;&amp; mkdir /var/lib/kubelet -p &amp;&amp; mkdir /usr/libexec -p</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="4ã€åˆ›å»ºkube-configæ–‡ä»¶"><a href="#4ã€åˆ›å»ºkube-configæ–‡ä»¶" class="headerlink" title="4ã€åˆ›å»ºkube configæ–‡ä»¶"></a>4ã€åˆ›å»ºkube configæ–‡ä»¶</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;kubeletã€kube-proxyç­‰Nodeæœºå™¨ä¸Šçš„ç»å¸¸ä¸masteræœºå™¨çš„kube-apiserverè¿›ç¨‹é€šä¿¡æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼›kubernetes 1.4 å¼€å§‹æ”¯æŒæœ‰kube-apiserverä¸ºå®¢æˆ·ç«¯ç”Ÿæˆtlsè¯ä¹¦çš„ TLS BootstrappingåŠŸèƒ½ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦äº†ï¼Œè¯¥åŠŸèƒ½å½“å‰ä»…æ”¯æŒä¸ºkueletç”Ÿæˆè¯ä¹¦ï¼›</p><h3 id="4-1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶"><a href="#4-1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶" class="headerlink" title="4.1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶"></a>4.1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶</h3><ul><li>bootstrap.kubeconfig kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µéœ€è¦ä½¿ç”¨çš„é…ç½®æ–‡ä»¶</li><li>kube-controller-manager.kubeconfig controller manager ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li><li>kube-scheduler.kubeconfig scheduler ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li><li>kube-proxy.kubeconfig proxy ç»„ä»¶è¿æ¥ apiserver æ‰€éœ€é…ç½®æ–‡ä»¶</li><li>audit-policy.yaml apiserver RBAC å®¡è®¡æ—¥å¿—é…ç½®æ–‡ä»¶</li><li>bootstrap.secret.yaml kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µä½¿ç”¨ Bootstrap Token æ–¹å¼å¼•å¯¼ï¼Œéœ€è¦é¢„å…ˆåˆ›å»ºæ­¤ Token</li></ul><h3 id="4-2ã€åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶"><a href="#4-2ã€åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶" class="headerlink" title="4.2ã€åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶"></a>4.2ã€åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶</h3><p>åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦ä¸‹è½½kubernetes ç›¸å…³çš„äºŒè¿›åˆ¶åŒ…ï¼ŒæŠŠå¯¹åº”çš„å·¥å…·å’Œå‘½ä»¤æ‹·è´åˆ°/usr/binç›®å½•ä¸‹é¢;ä¸‹è½½äºŒè¿›åˆ¶åŒ…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.13.3/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf kubernetes-server-linux-amd64.tar.gz &amp;&amp; cd kubernetes/server/bin</span></span><br></pre></td></tr></table></figure><ul><li>masterèŠ‚ç‚¹æ‹·è´</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mv apiextensions-apiserver cloud-controller-manager hyperkube kube-apiserver kube-controller-manager kube-proxy kube-scheduler kubectl kubelet mounter kubeadm /usr/bin/ &amp;&amp; cd &amp;&amp;rm -rf kubernetes kubernetes-server-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><h4 id="4-2-1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping"><a href="#4-2-1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping" class="headerlink" title="4.2.1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping"></a>4.2.1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping</h4><ul><li>master-01<br>&nbsp;&nbsp;&nbsp;&nbsp;config æ˜¯ä¸€ä¸ªé€šç”¨é…ç½®æ–‡ä»¶è¦è¿æ¥æœ¬åœ°çš„ 6443 åŠ å¯†ç«¯å£ï¼›è€Œè¿™ä¸ªå˜é‡å°†ä¼šè¦†ç›– kubeconfig ä¸­æŒ‡å®šçš„master_vipåœ°å€172.21.16.45:6443 åœ°å€</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export KUBE_APISERVER="https://172.21.16.45:6443"</span></span><br></pre></td></tr></table></figure><ul><li>ç”Ÿæˆ Bootstrap Token<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># BOOTSTRAP_TOKEN_ID=$(head -c 6 /dev/urandom | md5sum | head -c 6)</span></span><br><span class="line"><span class="comment"># BOOTSTRAP_TOKEN_SECRET=$(head -c 16 /dev/urandom | md5sum | head -c 16)</span></span><br><span class="line"><span class="comment"># BOOTSTRAP_TOKEN="$&#123;BOOTSTRAP_TOKEN_ID&#125;.$&#123;BOOTSTRAP_TOKEN_SECRET&#125;"</span></span><br><span class="line"><span class="comment"># echo "Bootstrap Tokne: $&#123;BOOTSTRAP_TOKEN&#125;"</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="4-2-2ã€ç”Ÿæˆ-kubelet-tls-bootstrap-é…ç½®"><a href="#4-2-2ã€ç”Ÿæˆ-kubelet-tls-bootstrap-é…ç½®" class="headerlink" title="4.2.2ã€ç”Ÿæˆ kubelet tls bootstrap é…ç½®"></a>4.2.2ã€ç”Ÿæˆ kubelet tls bootstrap é…ç½®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:bootstrap:$&#123;BOOTSTRAP_TOKEN_ID&#125;" \</span></span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=<span class="string">"system:bootstrap:<span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span>"</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-3ã€ç”Ÿæˆ-kube-controller-manager-é…ç½®æ–‡ä»¶"><a href="#4-2-3ã€ç”Ÿæˆ-kube-controller-manager-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.3ã€ç”Ÿæˆ kube-controller-manager é…ç½®æ–‡ä»¶"></a>4.2.3ã€ç”Ÿæˆ kube-controller-manager é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-controller-manager" \</span></span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-4ã€ç”Ÿæˆ-kube-scheduler-é…ç½®æ–‡ä»¶"><a href="#4-2-4ã€ç”Ÿæˆ-kube-scheduler-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.4ã€ç”Ÿæˆ kube-scheduler é…ç½®æ–‡ä»¶"></a>4.2.4ã€ç”Ÿæˆ kube-scheduler é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-scheduler" \</span></span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-5ã€ç”Ÿæˆ-kube-proxy-é…ç½®æ–‡ä»¶"><a href="#4-2-5ã€ç”Ÿæˆ-kube-proxy-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.5ã€ç”Ÿæˆ kube-proxy é…ç½®æ–‡ä»¶"></a>4.2.5ã€ç”Ÿæˆ kube-proxy é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-proxy" \</span></span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-6ã€ç”Ÿæˆ-apiserver-RBAC-å®¡è®¡é…ç½®æ–‡ä»¶"><a href="#4-2-6ã€ç”Ÿæˆ-apiserver-RBAC-å®¡è®¡é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.6ã€ç”Ÿæˆ apiserver RBAC å®¡è®¡é…ç½®æ–‡ä»¶"></a>4.2.6ã€ç”Ÿæˆ apiserver RBAC å®¡è®¡é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; audit-policy.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="comment"># Log all requests at the Metadata level.</span></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">- level: Metadata</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-2-7ã€ç”Ÿæˆ-tls-bootstrap-token-secret-é…ç½®æ–‡ä»¶"><a href="#4-2-7ã€ç”Ÿæˆ-tls-bootstrap-token-secret-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.7ã€ç”Ÿæˆ tls bootstrap token secret é…ç½®æ–‡ä»¶"></a>4.2.7ã€ç”Ÿæˆ tls bootstrap token secret é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; bootstrap.secret.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># Name MUST be of form "bootstrap-token-&lt;token id&gt;"</span></span><br><span class="line">  name: bootstrap-token-<span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span></span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="comment"># Type MUST be 'bootstrap.kubernetes.io/token'</span></span><br><span class="line"><span class="built_in">type</span>: bootstrap.kubernetes.io/token</span><br><span class="line">stringData:</span><br><span class="line">  <span class="comment"># Human readable description. Optional.</span></span><br><span class="line">  description: <span class="string">"The default bootstrap token."</span></span><br><span class="line">  <span class="comment"># Token ID and secret. Required.</span></span><br><span class="line">  token-id: <span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span></span><br><span class="line">  token-secret: <span class="variable">$&#123;BOOTSTRAP_TOKEN_SECRET&#125;</span></span><br><span class="line">  <span class="comment"># Expiration. Optional.</span></span><br><span class="line">  expiration: $(date -d<span class="string">'+2 day'</span> -u +<span class="string">"%Y-%m-%dT%H:%M:%SZ"</span>)</span><br><span class="line">  <span class="comment"># Allowed usages.</span></span><br><span class="line">  usage-bootstrap-authentication: <span class="string">"true"</span></span><br><span class="line">  usage-bootstrap-signing: <span class="string">"true"</span></span><br><span class="line">  <span class="comment"># Extra groups to authenticate the token as. Must start with "system:bootstrappers:"</span></span><br><span class="line"><span class="comment">#  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-3ã€å¤åˆ¶æ–‡ä»¶"><a href="#4-3ã€å¤åˆ¶æ–‡ä»¶" class="headerlink" title="4.3ã€å¤åˆ¶æ–‡ä»¶"></a>4.3ã€å¤åˆ¶æ–‡ä»¶</h4><p>æŠŠåˆšç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°<code>/etc/kubernetes</code>ç›®å½•ä¸‹é¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># cp audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig /etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig k8s-master-02:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig k8s-master-03:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># node èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp -r  bootstrap.kubeconfig kube-proxy.kubeconfig node-01:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r  bootstrap.kubeconfig kube-proxy.kubeconfig node-02:/etc/kubernetes</span></span><br></pre></td></tr></table></figure><h4 id="4-4ã€å¤„ç†-ipvs-åŠä¾èµ–"><a href="#4-4ã€å¤„ç†-ipvs-åŠä¾èµ–" class="headerlink" title="4.4ã€å¤„ç† ipvs åŠä¾èµ–"></a>4.4ã€å¤„ç† ipvs åŠä¾èµ–</h4><p>&nbsp;&nbsp;&nbsp;&nbsp; æ–°ç‰ˆæœ¬ç›®å‰ kube-proxy ç»„ä»¶å…¨éƒ¨é‡‡ç”¨ ipvs æ–¹å¼è´Ÿè½½ï¼Œæ‰€ä»¥ä¸ºäº† kube-proxy èƒ½æ­£å¸¸å·¥ä½œéœ€è¦é¢„å…ˆå¤„ç†ä¸€ä¸‹ ipvs é…ç½®ä»¥åŠç›¸å…³ä¾èµ–(æ¯å° node éƒ½è¦å¤„ç†)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># sysctl -p</span></span><br></pre></td></tr></table></figure><p>kubernetes ä¸­å¯ç”¨ ipvs,è¯¦ç»†ä»‹ç»ï¼Œ<a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/proxy/ipvs" target="_blank" rel="noopener">å®˜æ–¹</a>,<a href="https://juejin.im/entry/5b7e409ce51d4538b35c03df" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install ipvsadm</span></span><br><span class="line"><span class="comment"># cat &gt;&gt; /etc/modules &lt;&lt;EOF</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver"><a href="#5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver" class="headerlink" title="5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver"></a>5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver</h2><h3 id="5-1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶"><a href="#5-1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶"></a>5.1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶</h3><ul><li><strong>kube-apiserver.service</strong><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service</span></span><br><span class="line">[Unit]</span><br><span class="line">  Description=Kubernetes API Service</span><br><span class="line">  Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">  After=network.target</span><br><span class="line">  After=etcd.service</span><br><span class="line">[Service]</span><br><span class="line">  EnvironmentFile=-/etc/kubernetes/apiserver</span><br><span class="line">  ExecStart=/usr/bin/kube-apiserver \</span><br><span class="line">          <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">          <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">          <span class="variable">$KUBE_ETCD_SERVERS</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_ADDRESS</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_PORT</span> \</span><br><span class="line">          <span class="variable">$KUBELET_PORT</span> \</span><br><span class="line">          <span class="variable">$KUBE_ALLOW_PRIV</span> \</span><br><span class="line">          <span class="variable">$KUBE_SERVICE_ADDRESSES</span> \</span><br><span class="line">          <span class="variable">$KUBE_ADMISSION_CONTROL</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_ARGS</span></span><br><span class="line">  Restart=on-failure</span><br><span class="line">  Type=notify</span><br><span class="line">  LimitNOFILE=65536</span><br><span class="line">[Install]</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-2ã€apiserveré…ç½®æ–‡ä»¶"><a href="#5-2ã€apiserveré…ç½®æ–‡ä»¶" class="headerlink" title="5.2ã€apiserveré…ç½®æ–‡ä»¶"></a>5.2ã€apiserveré…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/apiserver</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes system config</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The following values are used to configure the kube-apiserver</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address on the local server to listen to.</span></span><br><span class="line">KUBE_API_ADDRESS=<span class="string">"--advertise-address=172.21.17.4 --bind-address=0.0.0.0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The port on the local server to listen on.</span></span><br><span class="line">KUBE_API_PORT=<span class="string">"--secure-port=6443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port minions listen on</span></span><br><span class="line"><span class="comment"># KUBELET_PORT="--kubelet-port=10250"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Comma separated list of nodes in the etcd cluster</span></span><br><span class="line">KUBE_ETCD_SERVERS=<span class="string">"--etcd-servers=https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Address range to use for services</span></span><br><span class="line">KUBE_SERVICE_ADDRESSES=<span class="string">"--service-cluster-ip-range=10.254.0.0/16"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default admission control policies</span></span><br><span class="line">KUBE_ADMISSION_CONTROL=<span class="string">"--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,Priority,ResourceQuota"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_API_ARGS=<span class="string">" --allow-privileged=true \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --alsologtostderr \</span></span><br><span class="line"><span class="string">                --apiserver-count=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">                --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">                --audit-log-path=/var/log/kube-audit/audit.log \</span></span><br><span class="line"><span class="string">                --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span></span><br><span class="line"><span class="string">                --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">                --enable-garbage-collector \</span></span><br><span class="line"><span class="string">                --enable-logs-handler \</span></span><br><span class="line"><span class="string">                --endpoint-reconciler-type=lease \</span></span><br><span class="line"><span class="string">                --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span></span><br><span class="line"><span class="string">                --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">                --etcd-compaction-interval=0s \</span></span><br><span class="line"><span class="string">                --event-ttl=168h0m0s \</span></span><br><span class="line"><span class="string">                --kubelet-https=true \</span></span><br><span class="line"><span class="string">                --kubelet-certificate-authority=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem \</span></span><br><span class="line"><span class="string">                --kubelet-timeout=3s \</span></span><br><span class="line"><span class="string">                --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">                --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">                --service-account-key-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure><ul><li><strong>â€“client-ca-file</strong>: å®šä¹‰å®¢æˆ·ç«¯ CA</li><li><strong>â€“endpoint-reconciler-type</strong>: master endpoint ç­–ç•¥</li><li><strong>â€“kubelet-client-certificateã€â€“kubelet-client-key</strong>: master åå‘è¿æ¥ kubelet ä½¿ç”¨çš„è¯ä¹¦</li><li><strong>â€“service-account-key-file</strong>: service account ç­¾å key(ç”¨äºæœ‰æ•ˆæ€§éªŒè¯)</li><li><strong>â€“tls-cert-fileã€â€“tls-private-key-file</strong>: master apiserver 6443 ç«¯å£è¯ä¹¦<br>è¯¦ç»†å‚æ•°<a href="https://www.jianshu.com/p/36ad3028a710" target="_blank" rel="noopener">ä»‹ç»</a></li></ul><h3 id="5-2-1ã€å¯åŠ¨kube-apiserver"><a href="#5-2-1ã€å¯åŠ¨kube-apiserver" class="headerlink" title="5.2.1ã€å¯åŠ¨kube-apiserver"></a>5.2.1ã€å¯åŠ¨kube-apiserver</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-apiserver &amp;&amp;systemctl start kube-apiserver &amp;&amp;systemctl status kube-apiserver</span></span><br></pre></td></tr></table></figure><h3 id="5-3ã€é…ç½®kube-controller-manager"><a href="#5-3ã€é…ç½®kube-controller-manager" class="headerlink" title="5.3ã€é…ç½®kube-controller-manager"></a>5.3ã€é…ç½®kube-controller-manager</h3><p>åˆ›å»ºkube-controller-managerçš„serviceé…ç½®æ–‡ä»¶</p><h3 id="5-3-1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶"><a href="#5-3-1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.3.1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶"></a>5.3.1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-controller-manager.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/controller-manager</span><br><span class="line">ExecStart=/usr/bin/kube-controller-manager \</span><br><span class="line">	    <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">	    <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">	    <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">	    <span class="variable">$KUBE_CONTROLLER_MANAGER_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="5-3-2ã€é…ç½®controller-manageræ–‡ä»¶"><a href="#5-3-2ã€é…ç½®controller-manageræ–‡ä»¶" class="headerlink" title="5.3.2ã€é…ç½®controller-manageræ–‡ä»¶"></a>5.3.2ã€é…ç½®controller-manageræ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/controller-manager</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># The following values are used to configure the kubernetes controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defaults from config and apiserver should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">                                --cluster-signing-cert-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --cluster-signing-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">                                --deployment-controller-sync-period=10s \</span></span><br><span class="line"><span class="string">                                --experimental-cluster-signing-duration=87600h0m0s \</span></span><br><span class="line"><span class="string">                                --enable-garbage-collector=true \</span></span><br><span class="line"><span class="string">                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --leader-elect=true \</span></span><br><span class="line"><span class="string">                                --node-monitor-grace-period=20s \</span></span><br><span class="line"><span class="string">                                --node-monitor-period=5s \</span></span><br><span class="line"><span class="string">                                --port=10252 \</span></span><br><span class="line"><span class="string">                                --pod-eviction-timeout=2m0s \</span></span><br><span class="line"><span class="string">                                --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --terminated-pod-gc-threshold=50 \</span></span><br><span class="line"><span class="string">                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">                                --root-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --secure-port=10257 \</span></span><br><span class="line"><span class="string">                                --service-cluster-ip-range=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                                --service-account-private-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">                                --v=2"</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;controller manager å°†ä¸å®‰å…¨ç«¯å£ 10252 ç»‘å®šåˆ° 127.0.0.1 ç¡®ä¿ kuebctl get cs æœ‰æ­£ç¡®è¿”å›ï¼›å°†å®‰å…¨ç«¯å£ 10257 ç»‘å®šåˆ° 0.0.0.0 å…¬å¼€ï¼Œæä¾›æœåŠ¡è°ƒç”¨ï¼›ç”±äº controller manager å¼€å§‹è¿æ¥ apiserver çš„ 6443 è®¤è¯ç«¯å£ï¼Œæ‰€ä»¥éœ€è¦ â€“use-service-account-credentials é€‰é¡¹æ¥è®© controller manager åˆ›å»ºå•ç‹¬çš„ service account(é»˜è®¤ system:kube-controller-manager ç”¨æˆ·æ²¡æœ‰é‚£ä¹ˆé«˜æƒé™)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused   </span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused   </span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="5-3-3ã€å¯åŠ¨kube-controller-manager"><a href="#5-3-3ã€å¯åŠ¨kube-controller-manager" class="headerlink" title="5.3.3ã€å¯åŠ¨kube-controller-manager"></a>5.3.3ã€å¯åŠ¨kube-controller-manager</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl enable kube-controller-manager &amp;&amp;systemctl start kube-controller-manager &amp;&amp;systemctl status kube-controller-manager</span></span><br></pre></td></tr></table></figure><h3 id="5-4ã€é…ç½®kube-scheduler"><a href="#5-4ã€é…ç½®kube-scheduler" class="headerlink" title="5.4ã€é…ç½®kube-scheduler"></a>5.4ã€é…ç½®kube-scheduler</h3><p>åˆ›å»ºkube-schedulerçš„serviceé…ç½®æ–‡ä»¶</p><h4 id="5-4-1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶"><a href="#5-4-1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.4.1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶"></a>5.4.1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/kube-scheduler.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler Plugin</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/scheduler</span><br><span class="line">ExecStart=/usr/bin/kube-scheduler \</span><br><span class="line">	    <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">	    <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">	    <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">	    <span class="variable">$KUBE_SCHEDULER_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="5-4-2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶"><a href="#5-4-2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶" class="headerlink" title="5.4.2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶"></a>5.4.2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/scheduler </span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes scheduler config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_SCHEDULER_ARGS=<span class="string">"   --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                        --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                        --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                        --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                        --secure-port=10259 \</span></span><br><span class="line"><span class="string">                        --leader-elect=true \</span></span><br><span class="line"><span class="string">                        --port=10251 \</span></span><br><span class="line"><span class="string">                        --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \</span></span><br><span class="line"><span class="string">                        --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem \</span></span><br><span class="line"><span class="string">                        --v=2"</span></span><br></pre></td></tr></table></figure><p>shceduler åŒ controller manager ä¸€æ ·å°†ä¸å®‰å…¨ç«¯å£ç»‘å®šåœ¨æœ¬åœ°ï¼Œå®‰å…¨ç«¯å£å¯¹å¤–å…¬å¼€</p><h4 id="5-4-3ã€å¯åŠ¨kube-scheduler"><a href="#5-4-3ã€å¯åŠ¨kube-scheduler" class="headerlink" title="5.4.3ã€å¯åŠ¨kube-scheduler"></a>5.4.3ã€å¯åŠ¨kube-scheduler</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-scheduler &amp;&amp;systemctl start kube-scheduler &amp;&amp;systemctl status kube-scheduler</span></span><br></pre></td></tr></table></figure><h3 id="5-4ã€éªŒè¯masterèŠ‚ç‚¹"><a href="#5-4ã€éªŒè¯masterèŠ‚ç‚¹" class="headerlink" title="5.4ã€éªŒè¯masterèŠ‚ç‚¹"></a>5.4ã€éªŒè¯masterèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤masterèŠ‚ç‚¹éƒ¨ç½²å®Œæ¯•</p><p>kubernetesé«˜å¯ç”¨ä½¿ç”¨haproxyè¿›è¡Œä»£ç†,<a href="https://xxlaila.github.io/2019/08/10/haproxy-keepalived/" target="_blank" rel="noopener">haproxy</a>ä»£ç†å®‰è£…</p><p><a href="https://xxlaila.github.io/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">nodeèŠ‚ç‚¹å®‰è£…</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes v1.13.3</tag>
      </tags>
  </entry>
  <entry>
    <title>vsftpdå®‰è£…</title>
    <url>/2019/08/09/vsftpd%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Centosä¸‹ftpçš„å®‰è£…ä¸€èˆ¬é‡‡ç”¨çš„æ˜¯vsftpdï¼Œä½†æ˜¯åœ¨ftpçš„æ¨¡å¼ä¸­åˆæœ‰å‡ ä¸ªç”¨æˆ·é…ç½®é¡¹éœ€è¦æ³¨æ„ï¼Œæœ‰äº›äººå–œæ¬¢ç”¨æœ¬åœ°ç”¨æˆ·å»ç™»é™†FTPï¼Œè™½ç„¶åœ¨å»ºç«‹æœ¬åœ°ç”¨æˆ·çš„æ—¶å€™åŠ äº†/sbin/nologinå‚æ•°ï¼Œä½†æ˜¯è¿™ä¸ªè¿˜æ˜¯ä¸å¤Ÿå®‰å…¨ï¼Œè€Œä¸”è¿™æ ·æƒé™æ§åˆ¶ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼Œä»–ä»¬éƒ½æ˜¯ç»Ÿä¸€çš„æ§åˆ¶æƒé™ï¼Œè¿™é‡Œé‡‡ç”¨è™šæ‹Ÿç”¨æˆ·å‰æ¥é…ç½®ã€‚è™šæ‹Ÿç”¨æˆ·é…åˆé˜²ç«å¢™selinuxè¿˜æœ‰å•ä¸ªç”¨æˆ·çš„æƒé™ï¼Œè¿™ä½¿å¾—FTPæœ‰ç€è¶³å¤Ÿçš„å®‰å…¨ã€‚è€Œä¸”æƒé™æ§åˆ¶ç‰¹åˆ«çµæ´»ï¼Œä¿®æ”¹ä¸€ä¸ªç”¨æˆ·çš„æƒé™ä¸ä¼šå½±å“åˆ°å…¶ä»–ç”¨æˆ·ã€‚<br>centos ç³»ç»Ÿç‰ˆæœ¬(5.5ã€5.3ã€6.0ã€6.5)<br>centos 7.4 å·²ç»éªŒè¯</p><h3 id="é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd"><a href="#é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd" class="headerlink" title="é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd"></a>é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum â€“y install vsftpd</span></span><br></pre></td></tr></table></figure><h3 id="2ã€å¯åŠ¨å’ŒåŠ è½½vsftp"><a href="#2ã€å¯åŠ¨å’ŒåŠ è½½vsftp" class="headerlink" title="2ã€å¯åŠ¨å’ŒåŠ è½½vsftp"></a>2ã€å¯åŠ¨å’ŒåŠ è½½vsftp</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># service vsftpd restart</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chkconfig â€“level 35 vsftpd on</span></span><br></pre></td></tr></table></figure><h3 id="3ã€å¼€å§‹é…ç½®vsftpd"><a href="#3ã€å¼€å§‹é…ç½®vsftpd" class="headerlink" title="3ã€å¼€å§‹é…ç½®vsftpd"></a>3ã€å¼€å§‹é…ç½®vsftpd</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Vsftpdçš„é…ç½®æ–‡ä»¶åœ¨/etc/vsftpdä¸‹é¢ï¼Œåœ¨é…ç½®ä¹‹å‰æˆ‘ä»¬å…ˆcpä¸€ä»½åšå¤‡ä»½ç”¨ä»¥å…å‘ç”Ÿæ„å¤–(åšä»€ä¹ˆéƒ½è¦éšæ‰‹å¤‡ä»½ï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸‡ï¼Œåªæœ‰ä¸‡ä¸€ã€‚)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment">#  cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.bak</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vim /etc/vsftpd/vsftpd.conf</span></span><br></pre></td></tr></table></figure><ul><li><strong>vsftpdçš„å‚æ•°ä»‹ç»</strong></li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reverse_lookup_enable=NO <span class="comment">#æ·»åŠ æ­¤è¡Œï¼Œè§£å†³å®¢æˆ·ç«¯ç™»é™†ç¼“æ…¢é—®é¢˜ï¼é‡è¦ï¼é»˜è®¤vsftpdå¼€å¯äº†DNSåå“è§£æï¼è¿™é‡Œéœ€è¦å…³é—­ï¼Œå¦‚æœå¯åŠ¨æœ‰é”™è¯¯ï¼Œè¯·æ³¨é”€ï¼</span></span><br><span class="line">listen_port=21 <span class="comment">#é»˜è®¤æ— æ­¤è¡Œï¼Œftpç«¯å£ä¸º21ï¼Œæ·»åŠ listen_port=2222æŠŠé»˜è®¤ç«¯å£ä¿®æ”¹ä¸º2222ï¼Œæ³¨æ„ï¼šé˜²ç«å¢™åŒæ—¶è¦å¼€å¯2222ç«¯å£</span></span><br><span class="line">anonymous_enable=NOã€€ã€€ <span class="comment">#ç¦æ­¢åŒ¿åç”¨æˆ·</span></span><br><span class="line">local_enable=YES</span><br><span class="line">è®¾å®šæœ¬åœ°ç”¨æˆ·å¯ä»¥è®¿é—®ã€‚æ³¨æ„ï¼šä¸»è¦æ˜¯ä¸ºè™šæ‹Ÿå®¿ä¸»ç”¨æˆ·ï¼Œå¦‚æœè¯¥é¡¹ç›®è®¾å®šä¸ºNOé‚£ä¹ˆæ‰€æœ‰è™šæ‹Ÿç”¨æˆ·å°†æ— æ³•è®¿é—®</span><br><span class="line">write_enable=YES <span class="comment">#å…¨å±€è®¾ç½®ï¼Œæ˜¯å¦å®¹è®¸å†™å…¥ï¼ˆæ— è®ºæ˜¯åŒ¿åç”¨æˆ·è¿˜æ˜¯æœ¬åœ°ç”¨æˆ·ï¼Œè‹¥è¦å¯ç”¨ä¸Šä¼ æƒé™çš„è¯ï¼Œå°±è¦å¼€å¯ä»–ï¼‰</span></span><br><span class="line">local_umask=022 è®¾å®šä¸Šä¼ åæ–‡ä»¶çš„æƒé™æ©ç ã€‚</span><br><span class="line">anon_upload_enable=NO ç¦æ­¢åŒ¿åç”¨æˆ·ä¸Šä¼ ã€‚</span><br><span class="line">anon_mkdir_write_enable=NO ç¦æ­¢åŒ¿åç”¨æˆ·å»ºç«‹ç›®å½•ã€‚</span><br><span class="line">dirmessage_enable=YES è®¾å®šå¼€å¯ç›®å½•æ ‡è¯­åŠŸèƒ½ã€‚</span><br><span class="line">xferlog_enable=YES è®¾å®šå¼€å¯æ—¥å¿—è®°å½•åŠŸèƒ½ã€‚</span><br><span class="line">connect_from_port_20=YES è®¾å®šç«¯å£20è¿›è¡Œæ•°æ®è¿æ¥ã€‚</span><br><span class="line">chown_uploads=NO è®¾å®šç¦æ­¢ä¸Šä¼ æ–‡ä»¶æ›´æ”¹å®¿ä¸»ã€‚</span><br><span class="line">xferlog_file=/var/<span class="built_in">log</span>/vsftpd.log æ—¥å¿—ä¿å­˜è·¯å¾„ï¼ˆå…ˆåˆ›å»ºå¥½æ–‡ä»¶ï¼‰</span><br><span class="line">xferlog_std_format=YESã€€ã€€ <span class="comment">#ä½¿ç”¨æ ‡å‡†æ ¼å¼</span></span><br><span class="line">async_abor_enable=YES è®¾å®šæ”¯æŒå¼‚æ­¥ä¼ è¾“åŠŸèƒ½ã€‚</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES è®¾å®šæ”¯æŒASCIIæ¨¡å¼çš„ä¸Šä¼ å’Œä¸‹è½½åŠŸèƒ½ã€‚</span><br><span class="line">ftpd_banner=Welcome to Awei FTP servers è®¾å®šVsftpdçš„ç™»é™†æ ‡è¯­ã€‚</span><br><span class="line">chroot_local_user=YES ç¦æ­¢æœ¬åœ°ç”¨æˆ·ç™»å‡ºè‡ªå·±çš„FTPä¸»ç›®å½•ã€‚</span><br><span class="line">pam_service_name=vsftpd è®¾å®šPAMæœåŠ¡ä¸‹Vsftpdçš„éªŒè¯é…ç½®æ–‡ä»¶åã€‚å› æ­¤ï¼ŒPAMéªŒè¯å°†å‚è€ƒ/etc/pam.d/ä¸‹çš„vsftpdæ–‡ä»¶é…ç½®ã€‚</span><br><span class="line">userlist_enable=YES è®¾ä¸ºYESçš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·åæ˜¯åœ¨userlist_fileå‚æ•°æŒ‡å®šçš„æ–‡ä»¶ä¸­ï¼Œ</span><br><span class="line"> é‚£ä¹ˆåœ¨è¦æ±‚ä»–ä»¬è¾“å…¥å¯†ç ä¹‹å‰ï¼Œä¼šç›´æ¥æ‹’ç»ä»–ä»¬ç™»é™†ã€‚</span><br><span class="line">tcp_wrappers=YES æ˜¯å¦æ”¯æŒtcp_wrappers</span><br></pre></td></tr></table></figure><ul><li><strong>ä»¥ä¸‹æ˜¯æˆ‘ä½¿ç”¨çš„å‚æ•°,ä½¿ç”¨çš„æ˜¯è¢«åŠ¨æ¨¡å¼</strong><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">anonymous_enable=No</span><br><span class="line">listen_port=21</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"><span class="comment">#chown_uploads=YES</span></span><br><span class="line">xferlog_file=/var/<span class="built_in">log</span>/vsftpd.log</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">async_abor_enable=YES</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES</span><br><span class="line">ftpd_banner=Welcome to blah FTP service.</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">listen=YES</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line">reverse_lookup_enable=No</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=vsftpd</span><br><span class="line">user_config_dir=/etc/vsftpd/vconf</span><br><span class="line">virtual_use_local_privs=YES</span><br><span class="line">pasv_min_port=9000</span><br><span class="line">pasv_max_port=9045</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">allow_writeable_chroot=YES</span><br><span class="line"><span class="comment">#port_enable=YES</span></span><br><span class="line"><span class="comment">#connect_from_port_20=YES</span></span><br><span class="line">pasv_enable=yes</span><br></pre></td></tr></table></figure></li></ul><ul><li>å¤‡æ³¨: è¿™é‡Œvsftpé‡‡ç”¨çš„è¢«åŠ¨æ¨¡å¼ï¼Œè¢«åŠ¨æ¨¡å¼å¼€æ”¾äº†ä¸€ä¸ªç«¯å£æ®µï¼Œå…¬å¸è·¯ç”±å™¨ä¸Šéœ€è¦å¼€æ”¾è¿™ä¸€ä¸ªç«¯å£ç«¯ï¼Œ<a href="https://xxlaila.github.io/2019/09/10/è·¯ç”±å™¨ç«¯å£æ˜ å°„/" target="_blank" rel="noopener">è·¯ç”±å™¨ç«¯å£æ˜ å°„</a></li></ul><h3 id="4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶"><a href="#4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶" class="headerlink" title="4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶"></a>4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶</h3><p>ç¼–è¾‘è™šæ‹Ÿç”¨æˆ·çš„åå•ï¼šï¼ˆç¬¬ä¸€è¡Œç”¨æˆ·åã€‚ç¬¬äºŒè¡Œå¯†ç ã€‚ä¸èƒ½ä½¿ç”¨rootï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># vim /etc/vsftpd/xuniusers</span></span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">23123213</span><br><span class="line">test1</span><br><span class="line">34dsfds</span><br><span class="line">test2</span><br><span class="line">df43sd</span><br></pre></td></tr></table></figure><h3 id="5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶"><a href="#5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶" class="headerlink" title="5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶"></a>5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶</h3><p>è¿™é‡Œéœ€è¦å®‰è£…db4,è®¾ç½®PAMæ–‡ä»¶æƒé™ï¼Œå¹¶åˆ¶å®šè™šæ‹Ÿç”¨æˆ·æ•°æ®åº“æ–‡ä»¶è¯»å–</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum â€“y install db4-utils</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># db_load -T -t hash -f /etc/vsftpd/xuniusers /etc/vsftpd/xuniusers.db</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chmod 600 /etc/vsftpd/xuniusers.db</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨/etc/pam.d/vsftpdçš„æ–‡ä»¶å¤´éƒ¨åŠ å…¥ä»¥ä¸‹ä¿¡æ¯ï¼ˆæ³¨*è¿™é‡Œä¸€å®šè¦åœ¨å‰é¢ï¼Œä¸èƒ½å†åé¢ï¼Œåˆšå¼€å§‹æˆ‘ä¹ŸåŠ è½½åˆ°åé¢ç™»é™†çš„æ—¶å€™æç¤ºé”™è¯¯ï¼‰,ä¿®æ”¹å‰å…ˆå¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># cp /etc/pam.d/vsftpd /etc/pam.d/vsftpd.bak</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vi /etc/pam.d/vsftpd</span></span><br><span class="line">auth sufficient /lib/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br><span class="line">account sufficient /lib/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/%E5%9B%BE%E7%89%87%201.png" alt="img"></p><ul><li>æ³¨*64ä½çš„æ“ä½œç³»ç»Ÿï¼Œåˆ™ä¸Šé¢libæ”¹ä¸º64ã€‚ä¸ç„¶é…ç½®ä¹Ÿä¼šæ— æ•ˆ</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">auth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br><span class="line">account sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å»ºç«‹ä¸€ä¸ªç³»ç»Ÿç”¨æˆ·vsftpdï¼Œç”¨æˆ·çš„ä¸»ç›®å½•å¯ä»¥è‡ªå·±è®¾ç½®ï¼Œ/home/wwwrootï¼Œè®¾ç½®ç”¨æˆ·ç™»é™†çš„ç»ˆç«¯ä¸º/bin/false</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># useradd vsftpd -d /home/wwwroot -s /bin/false</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chown vsftpd:vsftpd /home/wwwroot -R</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chown www:www /home/wwwroot â€“R #å¦‚æœè™šæ‹Ÿç”¨æˆ·çš„å®¿ä¸»ç”¨æˆ·ä¸ºnginxï¼Œéœ€è¦è¿™æ ·è®¾ç½®ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶"><a href="#6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶" class="headerlink" title="6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶"></a>6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># mkdir /etc/vsftpd/vconf</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># cd /etc/vsftpd/vconf</span></span><br><span class="line">touch test1 test2 test3 <span class="comment">#è¿™é‡Œåˆ›å»ºä¸‰ä¸ªè™šæ‹Ÿç”¨æˆ·é…ç½®æ–‡ä»¶</span></span><br><span class="line">vi web1 <span class="comment">#ç¼–è¾‘ç”¨æˆ·test1é…ç½®æ–‡ä»¶ï¼Œå…¶ä»–çš„è·Ÿè¿™ä¸ªé…ç½®æ–‡ä»¶ç±»ä¼¼</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vim test1</span></span><br><span class="line">local_root=/home/wwwroot/test1/</span><br><span class="line">write_enable=YES</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod u-w /home/wwwroot</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;æœ€åé‡å¯vsftpdæœåŠ¡,ä¸å…³é—­Selinuxå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é€šè¿‡FTPã€‚é˜²ç«å¢™å¼€æ”¾ç«¯å£<code>setsebool -P ftpd_disable_trans 1</code><br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¿°é…ç½®å®Œæˆåè¿˜å¯ä»¥é€šè¿‡#adduser -d /ç›®å½•è·¯å¾„ -g vsftpd -s /sbin/nologin ç”¨æˆ·å è¿™ä¸ªå‘½ä»¤æ¥æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œä¸éœ€è¦é…ç½®ä»»ä½•æƒé™éƒ½å¯ä»¥è¿›è¡ŒFTPçš„è®¿é—®,æœ€åè¡¥å……è¯´æ˜ï¼Œéœ€è¦å®‰è£…çš„å…¶ä»–æ’ä»¶</p><ul><li><p>éœ€è¦å®‰è£…çš„çš„æ˜¯pan</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum install -y pam</span></span><br></pre></td></tr></table></figure></li><li><p>è¿™é‡Œæˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹æ—¥å¿—ï¼Œå¯ä»¥æ ¹æ®æç¤ºçš„æç¤ºæ¥åˆ¤æ–­ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># cat /var/log/secure</span></span><br></pre></td></tr></table></figure></li></ul><p>æµ‹è¯•ç”¨æˆ·ç™»å½•è™šæ‹Ÿç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±æœ¬èº«çš„ç›®å½• ï¼Œä¸èƒ½å»å…¶ä»–ç›®å½•æŸ¥çœ‹(åˆ°è¿™é‡Œvsftpdé…ç½®ç»“æŸ)</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>vsftpd</tag>
      </tags>
  </entry>
  <entry>
    <title>TeamViewer macç ´è§£</title>
    <url>/2019/08/09/TeamViewer-mac%E7%A0%B4%E8%A7%A3/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:15 GMT+0800 (China Standard Time) --><h2 id="TeamViewer14-4-MACç ´è§£"><a href="#TeamViewer14-4-MACç ´è§£" class="headerlink" title="TeamViewer14.4 MACç ´è§£"></a>TeamViewer14.4 MACç ´è§£</h2><h3 id="åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤"><a href="#åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤" class="headerlink" title="åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤"></a>åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo python TeamViewer-id-changer.py</span><br><span class="line">ä½¿ç”¨macè‡ªå¸¦python2.7 æ‰§è¡Œå³å¯</span><br></pre></td></tr></table></figure><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim TeamViewer-id-changer.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2019/8/1 14:57</span></span><br><span class="line"><span class="comment"># @Author  : xxlaila</span></span><br><span class="line"><span class="comment"># @Site    : </span></span><br><span class="line"><span class="comment"># @File    : TeamViewer-id-changer.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">import platform</span><br><span class="line">import random</span><br><span class="line">import re</span><br><span class="line">import string</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">--------------------------------</span></span><br><span class="line"><span class="string">TeamViewer 14 ID Changer for MAC OS</span></span><br><span class="line"><span class="string">Version: 0.2 2019</span></span><br><span class="line"><span class="string">--------------------------------</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> platform.system() != <span class="string">"Darwin"</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"This script can be run only on MAC OS."</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.geteuid() != 0:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"This script must be run form root."</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">"SUDO_USER"</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">    USERNAME = os.environ[<span class="string">"SUDO_USER"</span>]</span><br><span class="line">    <span class="keyword">if</span> USERNAME == <span class="string">"root"</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Can not find user name. Run this script via sudo from regular user"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Can not find user name. Run this script via sudo from regular user"</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line">HOMEDIRLIB = <span class="string">"/Users/"</span> + USERNAME + <span class="string">"/library/preferences/"</span></span><br><span class="line">GLOBALLIB = <span class="string">"/library/preferences/"</span></span><br><span class="line"></span><br><span class="line">CONFIGS = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Find config files</span></span><br><span class="line"></span><br><span class="line">def listdir_fullpath(d):</span><br><span class="line">    <span class="built_in">return</span> [os.path.join(d, f) <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(d)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> listdir_fullpath(HOMEDIRLIB):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'teamviewer'</span> <span class="keyword">in</span> file.lower():</span><br><span class="line">        CONFIGS.append(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> listdir_fullpath(GLOBALLIB):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'teamviewer'</span> <span class="keyword">in</span> file.lower():</span><br><span class="line">        CONFIGS.append(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not CONFIGS:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">            There is no TemViewer configs found.</span></span><br><span class="line"><span class="string">            Maybe you have deleted it manualy or never run TeamViewer after installation.</span></span><br><span class="line"><span class="string">            Nothing to delete.</span></span><br><span class="line"><span class="string">            '</span><span class="string">''</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Delete config files</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Configs found:\n"</span>)</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> CONFIGS:</span><br><span class="line">        <span class="built_in">print</span>(file)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">        This files will be DELETED permanently.</span></span><br><span class="line"><span class="string">        All TeamViewer settings will be lost</span></span><br><span class="line"><span class="string">        '</span><span class="string">''</span>)</span><br><span class="line">        raw_input(<span class="string">"Press Enter to continue or CTR+C to abort..."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> CONFIGS:</span><br><span class="line">        try:</span><br><span class="line">            os.remove(file)</span><br><span class="line">        except:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Cannot delete config files. Permission denied?"</span>)</span><br><span class="line">            sys.exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Done."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find binaryes</span></span><br><span class="line"></span><br><span class="line">TMBINARYES = [</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/MacOS/TeamViewer'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/MacOS/TeamViewer_Service'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/Helpers/TeamViewer_Desktop'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/Helpers/TeamViewer_Assignment'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> TMBINARYES:</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(file):</span><br><span class="line">        pass</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"File not found: "</span> + file)</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">"Install TeamViewer correctly"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Patch files</span></span><br><span class="line"></span><br><span class="line">def idpatch(fpath, platf, serial):</span><br><span class="line">    file = open(fpath, <span class="string">'r+b'</span>)</span><br><span class="line">    binary = file.read()</span><br><span class="line">    PlatformPattern = <span class="string">"IOPlatformExpert.&#123;6&#125;"</span></span><br><span class="line">    SerialPattern = <span class="string">"IOPlatformSerialNumber%s%s%s"</span></span><br><span class="line"></span><br><span class="line">    binary = re.sub(PlatformPattern, platf, binary)</span><br><span class="line">    binary = re.sub(SerialPattern % (chr(0), <span class="string">"[0-9a-zA-Z]&#123;8,8&#125;"</span>, chr(0)), SerialPattern % (chr(0), serial, chr(0)), binary)</span><br><span class="line"></span><br><span class="line">    file = open(fpath, <span class="string">'wb'</span>).write(binary)</span><br><span class="line">    <span class="built_in">return</span> True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def random_generator(size=8, chars=string.ascii_uppercase + string.ascii_lowercase + string.digits):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join(random.choice(chars) <span class="keyword">for</span> _ <span class="keyword">in</span> range(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RANDOMSERIAL = random_generator(8)</span><br><span class="line">RANDOMPLATFORM = <span class="string">"IOPlatformExpert"</span> + random_generator(6)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> TMBINARYES:</span><br><span class="line">    try:</span><br><span class="line">        idpatch(file, RANDOMPLATFORM, RANDOMSERIAL)</span><br><span class="line">    except:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Error: can not patch file "</span> + file)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"PlatformDevice: "</span> + RANDOMPLATFORM)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"PlatformSerial: "</span> + RANDOMSERIAL)</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">"sudo codesign -f -s - /Applications/TeamViewer.app/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">ID changed sucessfully.</span></span><br><span class="line"><span class="string">!!! Restart computer before using TeamViewer !!!!</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span>)</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>TeamViewer</category>
      </categories>
      <tags>
        <tag>TeamViewer</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkins jobç®¡ç†</title>
    <url>/2019/08/09/jenkins-job%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><ul><li><strong>ä»‹ç»</strong>: ç”±äºå…¬å¸çš„ciç”¨äºç¼–è¯‘çš„ç¯å¢ƒæ¯”è¾ƒå¤šï¼Œä¸ºäº†æ›´å¥½çš„åŒºåˆ†ï¼Œä¸ºæ¯ä¸€ä¸ªç¯å¢ƒå»ºç«‹äº†ä¸€ä¸ªview</li><li><strong>ç—›ç‚¹</strong>: è¿ç»´äººå‘˜åœ¨å»ºç«‹jobçš„æ—¶å€™éœ€è¦åˆ°å¯¹åº”çš„viewä¸‹é¢å»ºç«‹ï¼Œè™½ç„¶è¿™ä¸æ˜¯ç‹ ç—›è‹¦ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚</li><li><strong>è§£å†³</strong>: äººå‘˜ç™»é™†é»˜è®¤æ˜¯åœ¨all viewä¸‹é¢ï¼Œæ¯ä¸ªè¿ç»´äººå‘˜åœ¨è¿™ä¸‹é¢å»ºç«‹jobï¼Œç„¶åæ¯ä¸ªviewæ ¹æ®è‡ªå·±çš„è§„åˆ™å§å¯¹åº”çš„jobæ·»åŠ è¿›æ¥ã€‚jobè§„åˆ™è‡ªå·±æå‰å®šä¹‰å¥½</li></ul><h2 id="1ã€å®‰è£…jenkinsæ’ä»¶"><a href="#1ã€å®‰è£…jenkinsæ’ä»¶" class="headerlink" title="1ã€å®‰è£…jenkinsæ’ä»¶"></a>1ã€å®‰è£…jenkinsæ’ä»¶</h2><p>view job è¿‡æ»¤æ’ä»¶view-job-filtersï¼Œå®‰è£…è¿‡ç¨‹ä¸ç´¯èµ˜</p><h2 id="2ã€é…ç½®viewè§„åˆ™"><a href="#2ã€é…ç½®viewè§„åˆ™" class="headerlink" title="2ã€é…ç½®viewè§„åˆ™"></a>2ã€é…ç½®viewè§„åˆ™</h2><p>è¿™é‡Œè®¾ç½®ä¸¤ä¸ªå‰ç«¯å’Œä¸€ä¸ªåç«¯å®ä¾‹</p><a id="more"></a><h3 id="2-1ã€å‰ç«¯1"><a href="#2-1ã€å‰ç«¯1" class="headerlink" title="2.1ã€å‰ç«¯1"></a>2.1ã€å‰ç«¯1</h3><p><img src="https://img.xxlaila.cn/image2018-5-29_10-47-20.png" alt="img"></p><h3 id="2-2ã€å‰ç«¯test"><a href="#2-2ã€å‰ç«¯test" class="headerlink" title="2.2ã€å‰ç«¯test"></a>2.2ã€å‰ç«¯test</h3><p>test æˆ‘ä»¬ç”¨å®‰è£…çš„è¿™ä¸ªæ’ä»¶æ¥è¿›è¡Œé…ç½®,ç‚¹å‡»Add Job Filterâ€”â€”&gt;ä¼šæœ‰å¾ˆå¤šçš„è§„åˆ™ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„çŠ¶æ€ã€æ ç›®æ¥è¿›è¡Œå´åˆ†ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©</p><p><img src="https://img.xxlaila.cn/image2018-5-29_10-49-46.png" alt="img"><br><img src="https://img.xxlaila.cn/image2018-5-29_10-52-49.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæ·»åŠ äº†ä¸¤æ¡è§„åˆ™ï¼Œè¿™ä¸ªæ˜¯å»ºç«‹jobçš„æ—¶å€™æœ‰ç‚¹ç‰¹æ®Šæ€§ï¼Œç”¨ç¬¬ä¸€ç§æ–¹å¼å®ç°å°±ä¼šæœ‰é—®é¢˜ï¼Œç¬¬ä¸€æ¡è§„åˆ™æ˜¯ç°å®æ‰€æœ‰testç±»çš„jobï¼Œä½†æ˜¯å§ä¸‹é¢çš„ä¸€æ¡ç»™åŠ è¿›æ¥äº†ï¼Œä¸ç°å®è¿™ç±»jobã€‚ä¿æŒå³å¯</p><h2 id="åç«¯javaç¨‹åº"><a href="#åç«¯javaç¨‹åº" class="headerlink" title="åç«¯javaç¨‹åº"></a>åç«¯javaç¨‹åº</h2><p>devç¯å¢ƒä¸ºä¾‹å­</p><p><img src="https://img.xxlaila.cn/image2018-5-29_10-54-54.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins job</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsç”¨æˆ·æƒé™é…ç½®</title>
    <url>/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><h3 id="1ã€jenkinsç”¨æˆ·æƒé™"><a href="#1ã€jenkinsç”¨æˆ·æƒé™" class="headerlink" title="1ã€jenkinsç”¨æˆ·æƒé™"></a>1ã€jenkinsç”¨æˆ·æƒé™</h3><ul><li>å¯ä»¥é›†æˆgitlabã€jenkinsä¸“æœ‰è´¦æˆ·ã€LDAPã€Servletå®¹å™¨ä»£ç†ã€Unixç”¨æˆ·/ç»„æ•°æ®åº“</li></ul><h3 id="2ã€æˆæƒç­–ç•¥"><a href="#2ã€æˆæƒç­–ç•¥" class="headerlink" title="2ã€æˆæƒç­–ç•¥"></a>2ã€æˆæƒç­–ç•¥</h3><ul><li>Gitlab Commiter Authorization Strategy</li><li>Role-Based Strategy</li><li>ä»»ä½•ç”¨æˆ·å¯ä»¥åšä»»ä½•äº‹(æ²¡æœ‰ä»»ä½•é™åˆ¶)</li><li>å®‰å…¨çŸ©é˜µ</li><li>ç™»å½•ç”¨æˆ·å¯ä»¥åšä»»ä½•äº‹</li><li>é—ç•™æ¨¡å¼</li><li>é¡¹ç›®çŸ©é˜µæˆæƒç­–ç•¥</li></ul><h3 id="3ã€æ’ä»¶å®‰è£…"><a href="#3ã€æ’ä»¶å®‰è£…" class="headerlink" title="3ã€æ’ä»¶å®‰è£…"></a>3ã€æ’ä»¶å®‰è£…</h3><p>å®‰è£…æ’ä»¶ï¼šRole-based Authorization Strategy</p><a id="more"></a><h3 id="4ã€jenkinsè®¾ç½®"><a href="#4ã€jenkinsè®¾ç½®" class="headerlink" title="4ã€jenkinsè®¾ç½®"></a>4ã€jenkinsè®¾ç½®</h3><p>ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®â€”â€”&gt;<br><img src="https://img.xxlaila.cn/image2018-5-11_14-26-37.png" alt="img"></p><p>å›åˆ°ç³»ç»Ÿç®¡ç†ç•Œé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°å¤šå‡ºæ¥ä¸€ä¸ªæ’ä»¶: Mangge and Assing Roles</p><h3 id="5ã€æƒé™è®¾ç½®"><a href="#5ã€æƒé™è®¾ç½®" class="headerlink" title="5ã€æƒé™è®¾ç½®"></a>5ã€æƒé™è®¾ç½®</h3><p>è¿›å…¥Manager and Assign Rolesâ€”â€”&gt;Manage Roles,è¿™é‡Œå»ºç«‹äº†å››ä¸ªæƒé™ï¼Œåˆ†åˆ«æ¥å¯¹åº”ä¸åŒçš„äººå‘˜<br><img src="https://img.xxlaila.cn/image2018-5-24_11-35-15.png" alt="img"></p><ul><li>åˆ›å»ºé¡¹ç›®è§’è‰²:</li></ul><p><img src="https://img.xxlaila.cn/image2018-5-24_11-35-27.png" alt="img"></p><p>å›åˆ°Manage and Assign Rolesç•Œé¢</p><h3 id="6ã€é…ç½®è§’è‰²"><a href="#6ã€é…ç½®è§’è‰²" class="headerlink" title="6ã€é…ç½®è§’è‰²"></a>6ã€é…ç½®è§’è‰²</h3><p>é€‰æ‹©Assign Roles,ç”¨æˆ·æ–°å»ºä»¥åï¼Œæ ¹æ®ç”¨æˆ·ä¸åŒç±»å‹çš„å‹¾é€‰ä¸åŒçš„æƒé™,</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodbå‰¯æœ¬é›†</title>
    <url>/2019/08/09/mongodb%E5%89%AF%E6%9C%AC%E9%9B%86/</url>
    <content><![CDATA[<!-- build time:Tue Nov 05 2019 17:53:16 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Mongodb replica setå®‰è£…åŠ è®¤è¯ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯keyFileè¿›è¡Œè®¤è¯ï¼Œä¹‹å‰çœ‹è¿‡å¾ˆå¤šæ–‡ç« ï¼Œå‘ä¸€å¤§å †ï¼Œè¿™é‡Œæ˜¯çœ‹äº†ä¸¤å¤©çš„å®˜æ–¹æ–‡æ¡£è¿›è¡Œçš„å®‰è£…ï¼Œå¹¶ç”¨æˆ·ç”Ÿäº§ï¼Œé…ç½®æ–‡ä»¶å‚æ•°è´´ä¸€éƒ¨åˆ†,ä¸‰ä¸ªå¸¦æœ‰æ•°æ®é›†çš„èŠ‚ç‚¹ç»„æˆçš„å¤åˆ¶é›†æ‹¥æœ‰ï¼Œæ¶æ„å›¾å¦‚ä¸‹ï¼Œå‚è€ƒå®˜æ–¹</p><p><img src="https://img.xxlaila.cn/image2018-8-13_15-27-53.png" alt="img"><br>ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ï¼Œè¿™ä¸¤ä¸ªä»èŠ‚ç‚¹éƒ½å¯ä»¥åœ¨é€‰ä¸¾ä¸­å‡çº§ä¸ºä¸»èŠ‚ç‚¹</p><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>ä¸‰å°æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">primary: 192.168.32.7</span><br><span class="line">secaodray: 192.168.32.11</span><br><span class="line">secondary: 192.168.32.14</span><br></pre></td></tr></table></figure><h2 id="1ã€å®‰è£…mongodb"><a href="#1ã€å®‰è£…mongodb" class="headerlink" title="1ã€å®‰è£…mongodb"></a>1ã€å®‰è£…mongodb</h2><h3 id="1-1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ"><a href="#1-1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ" class="headerlink" title="1.1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ"></a>1.1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo vim /etc/yum.repos.d/mongodb-enterprise.repo</span></span><br><span class="line">[mongodb-enterprise]</span><br><span class="line">name=MongoDB Enterprise Repository</span><br><span class="line">baseurl=https://repo.mongodb.com/yum/redhat/<span class="variable">$releasever</span>/mongodb-enterprise/3.4/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc   </span><br><span class="line"></span><br><span class="line"><span class="comment"># sudo yum install -y mongodb-enterprise</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå¦‚æœé‡‡ç”¨æºç åŒ…æ–¹å¼å®‰è£…éœ€è¦å®‰è£…ä¸€ä¸‹æ’ä»¶</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo yum install cyrus-sasl cyrus-sasl-plain cyrus-sasl-gssapi krb5-libs lm_sensors-libs net-snmp-agent-libs net-snmp openssl rpm-libs tcp_wrappers-libs libcurl</span></span><br></pre></td></tr></table></figure><h2 id="2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶-æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ"><a href="#2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶-æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ" class="headerlink" title="2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶(æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ)"></a>2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶(æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ)</h2><h3 id="è‡ªå®šä¹‰mongodbçš„ç›®å½•"><a href="#è‡ªå®šä¹‰mongodbçš„ç›®å½•" class="headerlink" title="è‡ªå®šä¹‰mongodbçš„ç›®å½•"></a>è‡ªå®šä¹‰mongodbçš„ç›®å½•</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /opt/mongodb/&#123;data,conf,logs&#125; -p</span></span><br><span class="line"><span class="comment"># sudo vim /etc/mongod.conf</span></span><br><span class="line"> systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /opt/mongodb/logs/mongod.log</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /opt/mongodb/data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  pidFilePath: /opt/mongodb/logs/mongod.pid</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0</span><br></pre></td></tr></table></figure><h3 id="3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶-åœ¨mong01ä¸Šæ“ä½œ"><a href="#3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶-åœ¨mong01ä¸Šæ“ä½œ" class="headerlink" title="3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶(åœ¨mong01ä¸Šæ“ä½œ)"></a>3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶(åœ¨mong01ä¸Šæ“ä½œ)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl rand -base64 756 &gt; ï¼opt/mongodb/conf/mongo-keyfile</span></span><br><span class="line"><span class="comment"># sudo chmod 400 /opt/mongo/mongo-keyfile</span></span><br><span class="line"><span class="comment"># scp â€“r mongo-keyfile user@192.168.32.11:/opt/mongodb/conf</span></span><br><span class="line"><span class="comment"># scp â€“r mongo-keyfile user@192.168.32.14:/opt/mongodb/conf</span></span><br></pre></td></tr></table></figure><h3 id="4ã€ä¿®æ”¹mongodbçš„é…ç½®"><a href="#4ã€ä¿®æ”¹mongodbçš„é…ç½®" class="headerlink" title="4ã€ä¿®æ”¹mongodbçš„é…ç½®"></a>4ã€ä¿®æ”¹mongodbçš„é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">security:</span><br><span class="line">  keyFile: /opt/mongodb/conf/mongo-keyfile</span><br><span class="line">replication:</span><br><span class="line">  replSetName: xxlaila01ï¼ˆå¯å˜åŒ–ï¼Œè‡ªå®šä¹‰ï¼‰</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«åœ¨ä¸‰å°æœåŠ¡å™¨ä¸Šå¯åŠ¨mongodb</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mongod --config /etc/mongod.conf</span></span><br></pre></td></tr></table></figure><h3 id="5ã€å»ºç«‹é›†ç¾¤"><a href="#5ã€å»ºç«‹é›†ç¾¤" class="headerlink" title="5ã€å»ºç«‹é›†ç¾¤"></a>5ã€å»ºç«‹é›†ç¾¤</h3><p>åœ¨ä½ éœ€è¦è®¤ä¸ºæ˜¯ä¸»èŠ‚ç‚¹çš„æœåŠ¡å™¨è¿›è¡Œmongodbçš„ç™»é™†ï¼Œå’Œè´¦æˆ·æƒé™çš„å»ºç«‹ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©çš„192.168.32.7</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongo --shell --host 127.0.0.1</span><br></pre></td></tr></table></figure><p>ç™»é™†è¿›å»ä»¥åå¯ä»¥è¿›è¡Œä¸€ä¸ªç®€å•çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹</p><p><img src="https://img.xxlaila.cn/image2018-8-13_15-37-2.png" alt="img"></p><h3 id="6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†"><a href="#6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†" class="headerlink" title="6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†"></a>6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise &gt; config = &#123; _id:<span class="string">"kxlprod01"</span>,members:[ &#123;_id:0,host:<span class="string">"192.168.32.7:27017"</span>&#125;,</span><br><span class="line">...   &#123;_id:1,host:<span class="string">"192.168.32.11:27017"</span>&#125; ,&#123;_id:2,host:<span class="string">"192.168.32.14:27017"</span>&#125;] &#125;</span><br></pre></td></tr></table></figure><p>config = { _id:â€kxlprod01â€,members:[ {_id:0,host:â€192.168.32.7:27017â€},{_id:1,host:â€192.168.32.11:27017â€} ,{_id:2,host:â€192.168.32.14:27017â€}] }ï¼Œå¢åŠ å†…å®¹</p><h4 id="6-1-çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€"><a href="#6-1-çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€" class="headerlink" title="6.1 çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€"></a>6.1 çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€</h4><p>åˆ©ç”¨rs.status()å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; rs.status()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæç¤ºé…ç½®è¿˜æ²¡æœ‰åŠ è½½åˆ°mongodbå‰¯æœ¬é‡Œé¢</p><h4 id="6-2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†"><a href="#6-2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†" class="headerlink" title="6.2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†"></a>6.2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; rs.initiate(config)</span><br></pre></td></tr></table></figure><p>å†æ¬¡æŸ¥çœ‹å‰¯æœ¬çš„çŠ¶æ€å°±å¯ä»¥çœ‹åˆ°mongodbçš„å‰¯æœ¬é›†å·²å»ºç«‹ï¼Œå¦‚æœæ­¤æ—¶ä¸»èŠ‚ç‚¹æœªè¢«é€‰ä¸¾å‡ºæ¥ï¼Œç¨å¾®ç­‰ä¸€ä¼šå°±æˆåŠŸ</p><h3 id="7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯"><a href="#7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯" class="headerlink" title="7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯"></a>7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯</h3><p>ä¸‹é¢ä¸¤è¡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡ä¸»èŠ‚ç‚¹æ²¡æœ‰é€‰ä¸¾æˆåŠŸï¼Œéšå³æˆ‘ä»¬åœ¨å›è½¦PRIMARYèŠ‚ç‚¹é€‰ä¸¾æˆåŠŸäº†ï¼Œä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise xxlaila01:SECONDARY&gt; admin = db.getSiblingDB(<span class="string">"admin"</span>)</span><br><span class="line">MongoDB Enterprise xxlaila01:PRIMARY&gt;</span><br><span class="line">admin.createUser(</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    user: <span class="string">"root"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"123456"</span>,</span><br><span class="line"></span><br><span class="line">    roles: [ &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"root"</span>, <span class="string">"123456"</span> )</span><br></pre></td></tr></table></figure><h4 id="7-1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·"><a href="#7-1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·" class="headerlink" title="7.1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·"></a>7.1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·</h4><p>åˆ›å»ºä¸€ä¸ªé›†ç¾¤ç®¡ç†è´¦æˆ·ï¼Œé›†ç¾¤è´¦æˆ·å…·æœ‰ç®¡ç†æ•´ä¸ªå‰¯æœ¬é›†çš„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo -u <span class="string">"root"</span> -p <span class="string">"123456"</span> --authenticationDatabase <span class="string">"admin"</span></span><br><span class="line"></span><br><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"user"</span> : <span class="string">"manger"</span>,</span><br><span class="line">    <span class="string">"pwd"</span> : <span class="string">"123456"</span>,</span><br><span class="line">    roles: [ &#123; <span class="string">"role"</span> : <span class="string">"clusterAdmin"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span> &#125; ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="7-2-åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·"><a href="#7-2-åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·" class="headerlink" title="7.2 åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·"></a>7.2 åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"user"</span> : <span class="string">"systemprod"</span>,</span><br><span class="line">    <span class="string">"pwd"</span> : <span class="string">"123456"</span>,</span><br><span class="line">    roles: [ &#123; <span class="string">"role"</span> : <span class="string">"root"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è‡³æ­¤mongodbçš„å‰¯æœ¬é›†åˆ›å»ºå®Œæˆã€‚æµ‹è¯•æ²¡æœ‰é—®é¢˜,ç™»é™†å…¶ä¸­ä¸€å°SECONDARYæœåŠ¡å™¨è¿›è¡Œæµ‹è¯•,è¿™é‡Œæµ‹è¯•192.168.32.11æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo</span><br><span class="line"></span><br><span class="line">&gt; rs.status()    <span class="comment"># è¿™é‡Œæç¤ºæ²¡æœ‰æƒé™ï¼ˆç™»å½•è¿›æ¥ä»¥åå¦‚æœä¸æ˜¯ä¸»å‡ ç‚¹ï¼Œmognodbå°±ä¼šé»˜è®¤æ˜¾ç¤ºæœªsecondaryï¼‰</span></span><br><span class="line"></span><br><span class="line">&gt; use admin 	<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">&gt; db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"manger"</span>, <span class="string">"123456"</span>)</span><br></pre></td></tr></table></figure><p>å®Œæˆåæˆ‘ä»¬åœ¨æ‰§è¡Œrs.status()å°±å¯ä»¥çœ‹åˆ°å‰¯æœ¬é›†çš„ä¿¡æ¯</p><h4 id="7-3-æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·"><a href="#7-3-æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·" class="headerlink" title="7.3 æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·"></a>7.3 æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise xxlaila01:SECONDARY&gt; db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"systemprod"</span>, <span class="string">"123456"</span> )</span><br><span class="line">&gt; show dbs;	<span class="comment">#ä¼šæç¤º â€œnot master and slaveok=falseâ€</span></span><br><span class="line"></span><br><span class="line">&gt; db.getMongo().setSlaveOk()</span><br><span class="line">&gt; show dbs;	<span class="comment">#åœ¨æ¬¡æ‰§è¡Œä¼šæ˜¾ç¤ºå‡ºç»“æœ</span></span><br></pre></td></tr></table></figure><p>å‰¯æœ¬é›†æ²¡æœ‰è¯»çš„æƒé™ï¼Œéœ€è¦æ‰§è¡Œdb.getMongo().setSlaveOk()</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>mongodb,mongodbå‰¯æœ¬é›†,mongodbé«˜å¯ç”¨</tag>
      </tags>
  </entry>
</search>
