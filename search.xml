<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>istioéƒ¨ç½²</title>
    <url>/2019/10/29/istio%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="Istioä»‹ç»"><a href="#Istioä»‹ç»" class="headerlink" title="Istioä»‹ç»"></a>Istioä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;istioä»£è¡¨çš„æ˜¯Service Meshçš„æ–¹æ¡ˆå®ç°ï¼ŒIstio æœ‰åŠ©äºé™ä½è¿™äº›éƒ¨ç½²çš„å¤æ‚æ€§ï¼Œå¹¶å‡è½»å¼€å‘å›¢é˜Ÿçš„å‹åŠ›ã€‚æä¾›ä¸€ç§ç®€å•çš„æ–¹å¼æ¥ä¸ºå·²éƒ¨ç½²çš„æœåŠ¡å»ºç«‹ç½‘ç»œï¼Œä¸”æä¾›å…·æœ‰è´Ÿè½½å‡è¡¡ã€æœåŠ¡é—´è®¤è¯ã€ç›‘æ§ã€æµé‡ç®¡ç†ç­‰åŠŸèƒ½ã€‚</p><a id="more"></a><h3 id="æœåŠ¡ç½‘æ ¼ï¼ˆService-Meshï¼‰"><a href="#æœåŠ¡ç½‘æ ¼ï¼ˆService-Meshï¼‰" class="headerlink" title="æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰"></a>æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰ç”¨äºæè¿°æ„æˆè¿™äº›åº”ç”¨ç¨‹åºçš„å¾®æœåŠ¡ç½‘ç»œä»¥åŠåº”ç”¨ä¹‹é—´çš„äº¤äº’ã€‚éšç€è§„æ¨¡å’Œå¤æ‚æ€§çš„å¢é•¿ï¼ŒæœåŠ¡ç½‘æ ¼è¶Šæ¥è¶Šéš¾ä»¥ç†è§£å’Œç®¡ç†ã€‚å®ƒçš„éœ€æ±‚åŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœæ¢å¤ã€æŒ‡æ ‡æ”¶é›†å’Œç›‘æ§ä»¥åŠé€šå¸¸æ›´åŠ å¤æ‚çš„è¿ç»´éœ€æ±‚ï¼Œä¾‹å¦‚ A/B æµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒã€é™æµã€è®¿é—®æ§åˆ¶å’Œç«¯åˆ°ç«¯è®¤è¯ç­‰ã€‚è€Œistioåˆšå¥½æä¾›äº†ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡æ§åˆ¶æ•´ä¸ªæœåŠ¡å™¨ç½‘æ ¼æä¾›è¡Œä¸ºæ´å¯Ÿå’Œæ“ä½œæ§åˆ¶æ¥æ»¡è¶³å¾®æœåŠ¡åº”ç”¨çš„å¤šæ ·åŒ–</p><h3 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio æœåŠ¡ç½‘æ ¼é€»è¾‘ä¸Šåˆ†ä¸ºæ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ã€‚</p><ul><li>æ•°æ®å¹³é¢ç”±ä¸€ç»„ä»¥ sidecar æ–¹å¼éƒ¨ç½²çš„æ™ºèƒ½ä»£ç†ï¼ˆEnvoyï¼‰ç»„æˆã€‚è¿™äº›ä»£ç†å¯ä»¥è°ƒèŠ‚å’Œæ§åˆ¶å¾®æœåŠ¡åŠ Mixer ä¹‹é—´æ‰€æœ‰çš„ç½‘ç»œé€šä¿¡ã€‚</li><li>æ§åˆ¶å¹³é¢è´Ÿè´£ç®¡ç†å’Œé…ç½®ä»£ç†æ¥è·¯ç”±æµé‡ã€‚æ­¤å¤–æ§åˆ¶å¹³é¢é…ç½® Mixer ä»¥å®æ–½ç­–ç•¥å’Œæ”¶é›†é¥æµ‹æ•°æ®ã€‚</li></ul><p>æ„æˆæ¯ä¸ªé¢æ¿çš„ä¸åŒç»„ä»¶:<br><img src="https://img.xxlaila.cn/1567136153850.jpg" alt="img"></p><h4 id="istio-ç»„ä»¶"><a href="#istio-ç»„ä»¶" class="headerlink" title="istio ç»„ä»¶"></a>istio ç»„ä»¶</h4><ul><li>Envoy: Istio ä½¿ç”¨ Envoy ä»£ç†çš„æ‰©å±•ç‰ˆæœ¬ï¼Œç”¨äºè°ƒè§£æœåŠ¡ç½‘æ ¼ä¸­æ‰€æœ‰æœåŠ¡çš„æ‰€æœ‰å…¥ç«™å’Œå‡ºç«™æµé‡ï¼Œå±äºæ•°æ®å±‚é¢ã€‚Istioåˆ©ç”¨Envoyçš„å†…ç½®åŠŸèƒ½å®ç°å¦‚ä¸‹æŒ‡æ ‡:<ul><li>åŠ¨æ€æœåŠ¡å‘ç°</li><li>è´Ÿè½½å‡è¡¡</li><li>TLSç»ˆæ­¢</li><li>HTTP/2å’ŒgRPCä»£ç†</li><li>æ–­è·¯å™¨</li><li>å¥åº·æ£€æŸ¥</li><li>åˆ†é˜¶æ®µæ¨å‡ºï¼ŒæŒ‰ç™¾åˆ†æ¯”åˆ†é…æµé‡</li><li>æ•…éšœæ³¨å…¥</li><li>ä¸°å¯Œçš„æŒ‡æ ‡</li></ul></li><li>Mixer: æ˜¯ä¸€ä¸ªç‹¬ç«‹äºå¹³å°çš„ç»„ä»¶ï¼Œè´Ÿè´£åœ¨æœåŠ¡ç½‘æ ¼ä¸Šæ‰§è¡Œè®¿é—®æ§åˆ¶å’Œä½¿ç”¨ç­–ç•¥ï¼Œå¹¶ä» Envoy ä»£ç†å’Œå…¶ä»–æœåŠ¡æ”¶é›†é¥æµ‹æ•°æ®</li><li>Pilot: ä¸º Envoy sidecar æä¾›æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œä¸ºæ™ºèƒ½è·¯ç”±ï¼ˆä¾‹å¦‚ A/B æµ‹è¯•ã€é‡‘ä¸é›€éƒ¨ç½²ç­‰ï¼‰å’Œå¼¹æ€§ï¼ˆè¶…æ—¶ã€é‡è¯•ã€ç†”æ–­å™¨ç­‰ï¼‰æä¾›æµé‡ç®¡ç†åŠŸèƒ½</li><li>Citadel: é€šè¿‡å†…ç½®èº«ä»½å’Œå‡­è¯ç®¡ç†èµ‹èƒ½å¼ºå¤§çš„æœåŠ¡é—´å’Œæœ€ç»ˆç”¨æˆ·èº«ä»½éªŒè¯ã€‚å¯ç”¨äºå‡çº§æœåŠ¡ç½‘æ ¼ä¸­æœªåŠ å¯†çš„æµé‡ï¼Œå¹¶ä¸ºè¿ç»´äººå‘˜æä¾›åŸºäºæœåŠ¡æ ‡è¯†è€Œä¸æ˜¯ç½‘ç»œæ§åˆ¶çš„å¼ºåˆ¶æ‰§è¡Œç­–ç•¥çš„èƒ½åŠ›</li><li>Galley: ä»£è¡¨å…¶ä»–çš„ Istio æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œç”¨æ¥éªŒè¯ç”¨æˆ·ç¼–å†™çš„ Istio API é…ç½®ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒGalley å°†æ¥ç®¡ Istio è·å–é…ç½®ã€ å¤„ç†å’Œåˆ†é…ç»„ä»¶çš„é¡¶çº§è´£ä»»</li></ul><h3 id="Istion-å®‰è£…"><a href="#Istion-å®‰è£…" class="headerlink" title="Istion å®‰è£…"></a>Istion å®‰è£…</h3><h4 id="ä¸‹è½½istioåŒ…"><a href="#ä¸‹è½½istioåŒ…" class="headerlink" title="ä¸‹è½½istioåŒ…"></a>ä¸‹è½½istioåŒ…</h4><p>æ‰§è¡Œä¸‹è½½å’Œè‡ªåŠ¨è§£å‹ç¼©</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://git.io/getLatestIstio | ISTIO_VERSION=1.2.8 sh -</span></span><br><span class="line"><span class="comment"># cd istio-1.2.8/bin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp istioctl /usr/bin/</span></span><br></pre></td></tr></table></figure><p>å®‰è£…ç›®å½•ä¸­åŒ…å«ï¼š</p><ul><li><code>åœ¨ install/</code>: ç›®å½•ä¸­åŒ…å«äº† Kubernetes å®‰è£…æ‰€éœ€çš„ .yaml æ–‡ä»¶</li><li><code>samples/</code>: ç›®å½•ä¸­æ˜¯ç¤ºä¾‹åº”ç”¨</li><li><code>istioctl</code>: istioctlå®¢æˆ·ç«¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ‰‹åŠ¨å°†Envoyä½œä¸ºSidecarä»£ç†æ³¨å…¥å¹¶åˆ›å»ºè·¯ç”±è§„åˆ™å’Œç­–ç•¥æ—¶ï¼Œå°†ä½¿ç”¨æ­¤å·¥å…·ã€‚</li><li><code>istio.VERSION</code>: é…ç½®æ–‡ä»¶</li></ul><h3 id="åœ¨kubernetes-é›†ç¾¤ä¸­å®‰è£…"><a href="#åœ¨kubernetes-é›†ç¾¤ä¸­å®‰è£…" class="headerlink" title="åœ¨kubernetes é›†ç¾¤ä¸­å®‰è£…"></a>åœ¨kubernetes é›†ç¾¤ä¸­å®‰è£…</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio ä¼šè¢«å®‰è£…åˆ°è‡ªå·±çš„ istio-system å‘½åç©ºé—´ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¯¹æ‰€æœ‰å…¶ä»–å‘½åç©ºé—´çš„æœåŠ¡è¿›è¡Œç®¡ç†ã€‚è¿™é‡Œé‡‡ç”¨helmè¿›è¡Œå®‰è£…ï¼Œ<a href="https://xxlaila.github.io/2019/09/04/k8s-helm/" target="_blank" rel="noopener">helmå®‰è£…å‚è€ƒ</a>ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºKialiè®¾ç½®èº«ä»½éªŒè¯å‡­æ®ï¼ˆç›‘è§†ï¼‰ã€‚ç”¨äºåé¢çš„ç™»å½•è®¤è¯</p><h4 id="è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡"><a href="#è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡" class="headerlink" title="è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡"></a>è®¾ç½®ç”¨æˆ·åå’Œå¯†ç çš„ç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># KIALI_USERNAME=$(read -p 'Kiali Username: ' uval &amp;&amp; echo -n $uval | base64)</span></span><br><span class="line"><span class="comment"># KIALI_PASSPHRASE=$(read -sp 'Kiali Passphrase: ' pval &amp;&amp; echo -n $pval | base64)</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºå‘½åç©ºé—´"><a href="#åˆ›å»ºå‘½åç©ºé—´" class="headerlink" title="åˆ›å»ºå‘½åç©ºé—´"></a>åˆ›å»ºå‘½åç©ºé—´</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># NAMESPACE=istio-system</span></span><br><span class="line"><span class="comment"># kubectl create namespace $NAMESPACE</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºç”¨äºå­˜å‚¨ä¸Šé¢è®¾ç½®çš„ç”¨æˆ·å/å¯†ç çš„æœºå¯†<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: kiali</span><br><span class="line">  namespace: <span class="variable">$NAMESPACE</span></span><br><span class="line">  labels:</span><br><span class="line">    app: kiali</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  username: <span class="variable">$KIALI_USERNAME</span></span><br><span class="line">  passphrase: <span class="variable">$KIALI_PASSPHRASE</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="ä½¿ç”¨helmå®‰è£…istio-CRD"><a href="#ä½¿ç”¨helmå®‰è£…istio-CRD" class="headerlink" title="ä½¿ç”¨helmå®‰è£…istio CRD"></a>ä½¿ç”¨helmå®‰è£…istio CRD</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm install install/kubernetes/helm/istio-init --name istio-init --namespace istio-system</span></span><br><span class="line">NAME:   istio-init</span><br><span class="line">LAST DEPLOYED: Fri Nov  1 10:13:22 2019</span><br><span class="line">NAMESPACE: istio-system</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/ClusterRole</span><br><span class="line">NAME                     AGE</span><br><span class="line">istio-init-istio-system  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ClusterRoleBinding</span><br><span class="line">NAME                                        AGE</span><br><span class="line">istio-init-admin-role-binding-istio-system  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME          DATA  AGE</span><br><span class="line">istio-crd-10  1     0s</span><br><span class="line">istio-crd-11  1     0s</span><br><span class="line">istio-crd-12  1     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Job</span><br><span class="line">NAME                     COMPLETIONS  DURATION  AGE</span><br><span class="line">istio-init-crd-10-1.2.8  0/1          0s</span><br><span class="line">istio-init-crd-11-1.2.8  0/1          0s</span><br><span class="line">istio-init-crd-12-1.2.8  0/1          0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ServiceAccount</span><br><span class="line">NAME                        SECRETS  AGE</span><br><span class="line">istio-init-service-account  0        0s</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod"><a href="#æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod" class="headerlink" title="æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod"></a>æŸ¥çœ‹å®‰è£…çš„CRDå’Œpod</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¿°å®‰è£…ä¼šæŠŠistioçš„23ä¸ªcrdéƒ½æäº¤ç»™kubernetes api æœåŠ¡å™¨ã€‚å¦‚æœå¯ç”¨äº†è¯ä¹¦ç®¡ç†ï¼Œcrdè®¡æ•°å™¨ä¸º28ä¸ªã€‚æˆ‘è¿™é‡Œæœªå¯ç”¨è¯ä¹¦ç®¡ç†ï¼Œåªæœ‰23ä¸ªã€‚è¿˜ç”Ÿæˆä¸‰ä¸ªpod</p><ul><li><p>CRD</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get CustomResourceDefinition</span></span><br><span class="line">NAME                                   CREATED AT</span><br><span class="line">adapters.config.istio.io               2019-10-29T08:41:31Z</span><br><span class="line">attributemanifests.config.istio.io     2019-10-29T08:41:30Z</span><br><span class="line">authorizationpolicies.rbac.istio.io    2019-10-29T08:41:36Z</span><br><span class="line">certificates.certmanager.k8s.io        2019-10-29T08:41:38Z</span><br><span class="line">challenges.certmanager.k8s.io          2019-10-29T08:41:40Z</span><br><span class="line">clusterissuers.certmanager.k8s.io      2019-10-29T08:41:37Z</span><br><span class="line">clusterrbacconfigs.rbac.istio.io       2019-10-29T08:41:26Z</span><br><span class="line">destinationrules.networking.istio.io   2019-10-29T08:41:25Z</span><br><span class="line">envoyfilters.networking.istio.io       2019-10-29T08:41:26Z</span><br><span class="line">gateways.networking.istio.io           2019-10-29T08:41:26Z</span><br><span class="line">handlers.config.istio.io               2019-10-29T08:41:33Z</span><br><span class="line">httpapispecbindings.config.istio.io    2019-10-29T08:41:27Z</span><br><span class="line">httpapispecs.config.istio.io           2019-10-29T08:41:28Z</span><br><span class="line">instances.config.istio.io              2019-10-29T08:41:32Z</span><br><span class="line">issuers.certmanager.k8s.io             2019-10-29T08:41:37Z</span><br><span class="line">meshpolicies.authentication.istio.io   2019-10-29T08:41:27Z</span><br><span class="line">orders.certmanager.k8s.io              2019-10-29T08:41:40Z</span><br><span class="line">policies.authentication.istio.io       2019-10-29T08:41:27Z</span><br><span class="line">quotaspecbindings.config.istio.io      2019-10-29T08:41:28Z</span><br><span class="line">quotaspecs.config.istio.io             2019-10-29T08:41:29Z</span><br><span class="line">rbacconfigs.rbac.istio.io              2019-10-29T08:41:31Z</span><br><span class="line">rules.config.istio.io                  2019-10-29T08:41:30Z</span><br><span class="line">serviceentries.networking.istio.io     2019-10-29T08:41:25Z</span><br><span class="line">servicerolebindings.rbac.istio.io      2019-10-29T08:41:31Z</span><br><span class="line">serviceroles.rbac.istio.io             2019-10-29T08:41:31Z</span><br><span class="line">sidecars.networking.istio.io           2019-10-29T08:41:34Z</span><br><span class="line">templates.config.istio.io              2019-10-29T08:41:32Z</span><br><span class="line">virtualservices.networking.istio.io    2019-10-29T08:41:25Z</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get crds | grep 'istio.io\|certmanager.k8s.io' | wc -l</span></span><br><span class="line">23</span><br></pre></td></tr></table></figure></li><li><p>pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">istio-init-crd-10-1.2.8-wxxjn             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-11-1.2.8-brjhh             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-12-1.2.8-w8wnc             0/1     Completed   0          3h20m</span><br></pre></td></tr></table></figure></li></ul><h4 id="ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶"><a href="#ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶" class="headerlink" title="ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶"></a>ä½¿ç”¨helmå®‰è£…å„ä¸ªç»„ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install install/kubernetes/helm/istio \</span><br><span class="line">    --name istio \</span><br><span class="line">    --namespace istio-system \</span><br><span class="line">    --<span class="built_in">set</span> global.mtls.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> kiali.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> tracing.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> grafana.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> servicegraph.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> <span class="string">"kiali.dashboard.jaegerURL=http://jaeger-query:16686"</span> \</span><br><span class="line">    --<span class="built_in">set</span> <span class="string">"kiali.dashboard.grafanaURL=http://grafana:3000"</span> \</span><br><span class="line">    --<span class="built_in">set</span> gateways.istio-ingressgateway.type=NodePort \</span><br><span class="line">    --<span class="built_in">set</span> gateways.istio-egressgateway.type=NodePort</span><br></pre></td></tr></table></figure><h4 id="éªŒè¯å®‰è£…"><a href="#éªŒè¯å®‰è£…" class="headerlink" title="éªŒè¯å®‰è£…"></a>éªŒè¯å®‰è£…</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éªŒè¯æ–‡ä»¶é‡Œé¢çš„æœåŠ¡æ˜¯å¦éƒ½éƒ¨ç½²åœ¨kubernetes æœåŠ¡ä¸­ã€‚ç¡®ä¿éƒ¨ç½²çš„pod åœ¨å¯¹åº”çš„kubernetes namespace é‡Œé¢ï¼Œå¹¶æ­£å¸¸å¯åŠ¨ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æœŸé—´å°†åˆ›å»ºæ‰€éœ€çš„RBACæƒé™ï¼Œå¹¶éƒ¨ç½²Istio-Pilotï¼ŒIstio-Mixerï¼ŒIstio-Ingressï¼ŒIstio-Egresså’ŒIstio-CAï¼ˆè¯ä¹¦é¢å‘æœºæ„ï¼‰ã€‚</p><h5 id="æœåŠ¡å™¨éªŒè¯"><a href="#æœåŠ¡å™¨éªŒè¯" class="headerlink" title="æœåŠ¡å™¨éªŒè¯"></a>æœåŠ¡å™¨éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®ä¿éƒ¨ç½²äº†ä»¥ä¸‹KubernetesæœåŠ¡ï¼šistio-pilotï¼Œistio-mixerï¼Œistio-ingressã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc -n istio-system</span></span><br><span class="line">NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                                                      AGE</span><br><span class="line">grafana                  ClusterIP   10.254.113.150   &lt;none&gt;        3000/TCP                                                                                                                                     3h22m</span><br><span class="line">istio-citadel            ClusterIP   10.254.27.143    &lt;none&gt;        8060/TCP,15014/TCP                                                                                                                           3h22m</span><br><span class="line">istio-galley             ClusterIP   10.254.155.177   &lt;none&gt;        443/TCP,15014/TCP,9901/TCP                                                                                                                   3h22m</span><br><span class="line">istio-ingressgateway     NodePort    10.254.170.109   &lt;none&gt;        15020:31952/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32532/TCP,15030:31518/TCP,15031:31525/TCP,15032:30404/TCP,15443:30309/TCP   3h22m</span><br><span class="line">istio-pilot              ClusterIP   10.254.228.182   &lt;none&gt;        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       3h22m</span><br><span class="line">istio-policy             ClusterIP   10.254.13.184    &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP                                                                                                                 3h22m</span><br><span class="line">istio-sidecar-injector   ClusterIP   10.254.154.169   &lt;none&gt;        443/TCP                                                                                                                                      3h22m</span><br><span class="line">istio-telemetry          ClusterIP   10.254.71.72     &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       3h22m</span><br><span class="line">jaeger-agent             ClusterIP   None             &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP                                                                                                                   3h22m</span><br><span class="line">jaeger-collector         ClusterIP   10.254.100.29    &lt;none&gt;        14267/TCP,14268/TCP                                                                                                                          3h22m</span><br><span class="line">jaeger-query             ClusterIP   10.254.18.117    &lt;none&gt;        16686/TCP                                                                                                                                    3h22m</span><br><span class="line">kiali                    ClusterIP   10.254.156.117   &lt;none&gt;        20001/TCP                                                                                                                                    3h22m</span><br><span class="line">prometheus               ClusterIP   10.254.145.181   &lt;none&gt;        9090/TCP                                                                                                                                     3h22m</span><br><span class="line">tracing                  ClusterIP   10.254.87.72     &lt;none&gt;        80/TCP                                                                                                                                       3h22m</span><br><span class="line">zipkin                   ClusterIP   10.254.39.22     &lt;none&gt;        9411/TCP                                                                                                                                     3h22m</span><br></pre></td></tr></table></figure><h5 id="pod-éªŒè¯"><a href="#pod-éªŒè¯" class="headerlink" title="pod éªŒè¯"></a>pod éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®ä¿å·²éƒ¨ç½²ç›¸åº”çš„Kubernetes Podï¼Œå¹¶ä¸”æ‰€æœ‰å®¹å™¨éƒ½å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">grafana-6fb9f8c5c7-n2plk                  1/1     Running     0          3h19m</span><br><span class="line">istio-citadel-7c9b84ddb6-n5h2n            1/1     Running     0          3h19m</span><br><span class="line">istio-galley-64f7d8cc97-zdbb6             1/1     Running     0          3h19m</span><br><span class="line">istio-grafana-post-install-1.2.8-98grv    0/1     Completed   0          3h19m</span><br><span class="line">istio-ingressgateway-65c7498b78-dfmfp     1/1     Running     0          3h19m</span><br><span class="line">istio-init-crd-10-1.2.8-wxxjn             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-11-1.2.8-brjhh             0/1     Completed   0          3h20m</span><br><span class="line">istio-init-crd-12-1.2.8-w8wnc             0/1     Completed   0          3h20m</span><br><span class="line">istio-pilot-569499d666-vhgn5              2/2     Running     0          3h19m</span><br><span class="line">istio-policy-5dbbc56db5-dmr4p             2/2     Running     3          3h19m</span><br><span class="line">istio-sidecar-injector-747cf74498-99drh   1/1     Running     0          3h19m</span><br><span class="line">istio-telemetry-7db5dd4c57-zngq7          2/2     Running     4          3h19m</span><br><span class="line">istio-tracing-5d8f57c8ff-vt2kn            1/1     Running     0          3h19m</span><br><span class="line">kiali-7d749f9dcb-68tlt                    1/1     Running     0          3h19m</span><br><span class="line">prometheus-776fdf7479-zbrxl               1/1     Running     0          3h19m</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio ä»¥ä¸€ä¸ªé¡¹ç›®çš„å½¢å¼éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œéƒ¨ç½²å¥½çš„ pods ä¸­ï¼Œé™¤äº†æœ‰ istio-citadelã€ã€istio-ingressgatewayã€istio-pilot ç­‰ Istio æœ¬èº«çš„åŠŸèƒ½ç»„ä»¶ï¼Œè¿˜é›†æˆäº†å¾®æœåŠ¡ç›¸å…³çš„ç›‘æ§å·¥å…·ï¼Œï¼Œå¦‚ï¼šgrafanaã€jaeger-queryã€kialiã€prometheusã€‚è¿™äº›åŠŸèƒ½ä¸°å¯Œä¸”å¼ºå¤§çš„ç›‘æ§å·¥å…·ï¼Œå¸®åŠ© Istioå®ç°äº†å¾®æœåŠ¡çš„å¯è§†åŒ–ç®¡ç†ã€‚</p><h3 id="éƒ¨ç½²BookInfoç”¨ç¨‹åº"><a href="#éƒ¨ç½²BookInfoç”¨ç¨‹åº" class="headerlink" title="éƒ¨ç½²BookInfoç”¨ç¨‹åº"></a>éƒ¨ç½²BookInfoç”¨ç¨‹åº</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨å¼€å§‹éƒ¨ç½² Bookinfo ç¤ºä¾‹ç¨‹åºã€‚éƒ¨ç½²Bookinfoæ¡ä»¶æ˜¯é›†ç¾¤ä¸­è‡³å°‘æœ‰4ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸”æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸å¾—ä½äº4Gã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥éƒ¨ç½²å®‰è£…éšé™„çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºä¹‹ä¸€-BookInfoã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿä¹¦åº—åº”ç”¨ç¨‹åºï¼Œç”±å››ä¸ªæœåŠ¡ç»„æˆï¼Œè¿™äº›æœåŠ¡æä¾›ä¸€ä¸ªWebäº§å“é¡µé¢ï¼Œä¹¦ç±è¯¦ç»†ä¿¡æ¯ï¼Œè¯„è®ºï¼ˆå¸¦æœ‰å¤šä¸ªç‰ˆæœ¬çš„è¯„è®ºæœåŠ¡ï¼‰å’Œè¯„åˆ†-æ‰€æœ‰è¿™äº›éƒ½ä½¿ç”¨Istioè¿›è¡Œç®¡ç†ã€‚</p><ul><li><p>BookInfoåº”ç”¨ç¨‹åºåˆ†ä¸ºå››ä¸ªå•ç‹¬çš„å¾®æœåŠ¡:</p><ul><li>productpage ï¼šproductpage å¾®æœåŠ¡ä¼šè°ƒç”¨ details å’Œ reviews ä¸¤ä¸ªå¾®æœåŠ¡ï¼Œç”¨æ¥ç”Ÿæˆé¡µé¢ã€‚</li><li>details ï¼šè¿™ä¸ªå¾®æœåŠ¡åŒ…å«äº†ä¹¦ç±çš„ä¿¡æ¯ã€‚</li><li>reviews ï¼šè¿™ä¸ªå¾®æœåŠ¡åŒ…å«äº†ä¹¦ç±ç›¸å…³çš„è¯„è®ºã€‚å®ƒè¿˜ä¼šè°ƒç”¨ ratings å¾®æœåŠ¡ã€‚</li><li>ratings ï¼šratings å¾®æœåŠ¡ä¸­åŒ…å«äº†ç”±ä¹¦ç±è¯„ä»·ç»„æˆçš„è¯„çº§ä¿¡æ¯ã€‚</li></ul></li><li><p>reviews å¾®æœåŠ¡æœ‰ 3 ä¸ªç‰ˆæœ¬ï¼š</p><ul><li>v1 ç‰ˆæœ¬ä¸ä¼šè°ƒç”¨ ratings æœåŠ¡.</li><li>v2 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªé»‘è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li><li>v3 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªçº¢è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li></ul></li><li><p>ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸ªåº”ç”¨çš„ç«¯åˆ°ç«¯æ¶æ„<br><img src="https://img.xxlaila.cn/1572576628250.jpg" alt="img"></p></li></ul><h4 id="æ‰“æ ‡ç­¾"><a href="#æ‰“æ ‡ç­¾" class="headerlink" title="æ‰“æ ‡ç­¾"></a>æ‰“æ ‡ç­¾</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸º default å‘½åç©ºé—´æ‰“ä¸Šæ ‡ç­¾ istio-injection=enabledï¼Œå®ç° Sidecar è‡ªåŠ¨æ³¨å…¥ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label namespace default istio-injection=enabled</span></span><br><span class="line">namespace/default labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get namespace --show-labels</span></span><br><span class="line">NAME              STATUS   AGE   LABELS</span><br><span class="line">default           Active   43d   istio-injection=enabled</span><br><span class="line">istio-system      Active   29m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   43d   &lt;none&gt;</span><br><span class="line">kube-public       Active   43d   &lt;none&gt;</span><br><span class="line">kube-system       Active   43d   &lt;none&gt;</span><br><span class="line">monitoring        Active   35d   &lt;none&gt;</span><br><span class="line">weave             Active   35d   &lt;none&gt;</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„:</strong> æ­¤æ­¥éª¤å…ˆä¸æ‰§è¡Œï¼Œå¦‚æœè¿™è¿™ä¸ªæ‰§è¡Œäº†ï¼Œåœ¨åé¢éƒ¨ç½²Bookinfoçš„æ—¶å€™ä¼šæç¤ºå¦‚ä¸‹é”™è¯¯<code>Error creating: Internal error occurred: failed calling webhook &quot;sidecar-injector.istio.io&quot;: Post https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</code>è¿™ä¸€æ­¥æœ‰æ‰§è¡Œçš„å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œåˆ é™¤</li></ul><ul><li>åˆ é™¤nsçš„label<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get ns --show-labels</span></span><br><span class="line">NAME              STATUS   AGE    LABELS</span><br><span class="line">default           Active   2d4h   istio-injection=enabled</span><br><span class="line">istio-system      Active   174m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-public       Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-system       Active   2d4h   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl label namespace default istio-injection-</span></span><br><span class="line">namespace/default labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get ns --show-labels</span></span><br><span class="line">NAME              STATUS   AGE    LABELS</span><br><span class="line">default           Active   2d4h   &lt;none&gt;</span><br><span class="line">istio-system      Active   175m   &lt;none&gt;</span><br><span class="line">kube-node-lease   Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-public       Active   2d4h   &lt;none&gt;</span><br><span class="line">kube-system       Active   2d4h   &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><h4 id="éƒ¨ç½²Bookinfo"><a href="#éƒ¨ç½²Bookinfo" class="headerlink" title="éƒ¨ç½²Bookinfo"></a>éƒ¨ç½²Bookinfo</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›´æ¥ä½¿ç”¨kubectl createå…¶å¸¸è§„çš„YAMLéƒ¨ç½²æ–‡ä»¶æ¥éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚å°†ä½¿ç”¨istioctlå°†Envoyå®¹å™¨æ³¨å…¥åˆ°åº”ç”¨ç¨‹åºå®¹å™¨ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)</span></span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥å‘½ä»¤å°†å¯åŠ¨bookinfoåº”ç”¨ç¨‹åºä½“ç³»ç»“æ„å›¾ä¸­æ˜¾ç¤ºçš„æ‰€æœ‰å››ä¸ªæœåŠ¡ã€‚å·²å¯åŠ¨è¯„è®ºæœåŠ¡çš„æ‰€æœ‰3ä¸ªç‰ˆæœ¬ï¼Œå³v1ï¼Œv2å’Œv3ã€‚è€Œåœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ä¼šéƒ¨ç½²æ–°ç‰ˆæœ¬çš„å¾®æœåŠ¡ï¼Œè€Œä¸æ˜¯åŒæ—¶éƒ¨ç½²æ‰€æœ‰ç‰ˆæœ¬ã€‚</p><h4 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç¡®è®¤æ‰€æœ‰æœåŠ¡å’ŒPodå‡å·²æ­£ç¡®å®šä¹‰å¹¶æ­£åœ¨è¿è¡Œã€‚</p><ul><li><p>æ£€æŸ¥ services</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   10.254.61.113    &lt;none&gt;        9080/TCP   2m27s</span><br><span class="line">kubernetes    ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP    43d</span><br><span class="line">productpage   ClusterIP   10.254.130.5     &lt;none&gt;        9080/TCP   2m23s</span><br><span class="line">ratings       ClusterIP   10.254.186.181   &lt;none&gt;        9080/TCP   2m26s</span><br><span class="line">reviews       ClusterIP   10.254.200.107   &lt;none&gt;        9080/TCP   2m25s</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥ pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-c5b5f496d-lphgd        1/1     Running   0          15h</span><br><span class="line">load-generator-7fbcc7489f-vbpnx   1/1     Running   2          20d</span><br><span class="line">nginx-deploy-d494b9564-vx97s      1/1     Running   1          20d</span><br><span class="line">productpage-v1-c7765c886-97spj    1/1     Running   0          15h</span><br><span class="line">ratings-v1-f745cf57b-mdgxr        1/1     Running   0          15h</span><br><span class="line">reviews-v1-75b979578c-ghqqm       1/1     Running   0          15h</span><br><span class="line">reviews-v2-597bf96c8f-r659w       1/1     Running   0          15h</span><br><span class="line">reviews-v3-54c6c64795-tvsmq       1/1     Running   0          15h</span><br></pre></td></tr></table></figure></li><li><p>ç¡®è®¤Bookinfoåº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œè¯·é€šè¿‡curlæŸä¸ªpodä¸­çš„å‘½ä»¤å‘å…¶å‘é€è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec -it $(kubectl get pod -l app=ratings -o jsonpath='&#123;.items[0].metadata.name&#125;') -c ratings -- curl productpage:9080/productpage | grep -o "&lt;title&gt;.*&lt;/title&gt;"</span></span><br><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ¯ä¸ªæœåŠ¡æ—è¾¹éƒ½æ³¨å…¥äº†Envoyï¼Œæ¶æ„å°†å¦‚ä¸‹<br><img src="https://img.xxlaila.cn/1572577460804.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BookinfoæœåŠ¡å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œï¼Œæ‚¨éœ€è¦ä½¿è¯¥åº”ç”¨ç¨‹åºå¯ä»¥ä»Kubernetesé›†ç¾¤å¤–éƒ¨è®¿é—®ï¼Œä¾‹å¦‚ï¼Œä»æµè§ˆå™¨è®¿é—®ã€‚Istioç½‘å…³ç”¨äºæ­¤ç›®çš„ã€‚ä½†æ˜¯æˆ‘åœ¨éƒ¨ç½² bookinfo-gateway çš„æ—¶å€™å‡ºç°é”™è¯¯ï¼Œé”™è¯¯å¦‚ä¸‹ï¼›ç„¶åçœ‹äº†ä¸€ä¸‹ bookinfo-gatewayå°±æ˜¯æä¾›ä¸€ä¸ªwebè®¿é—®çš„ç¨‹åºï¼Œæ—¢ç„¶æ˜¯æä¾›çš„ä¸€ä¸ªwebè®¿é—®ï¼Œæˆ‘å°±ä½¿ç”¨äº†Traefixæ¥æä¾›è¿™ä¸ªæœåŠ¡ã€‚</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Timeout): <span class="builtin-name">error</span> when creating <span class="string">"samples/bookinfo/networking/bookinfo-gateway.yaml"</span>: Timeout: request did <span class="keyword">not</span> complete within requested timeout 30s</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Timeout): <span class="builtin-name">error</span> when creating <span class="string">"samples/bookinfo/networking/bookinfo-gateway.yaml"</span>: Timeout: request did <span class="keyword">not</span> complete within requested timeout 30s</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»º-bookinfo-gateway"><a href="#åˆ›å»º-bookinfo-gateway" class="headerlink" title="åˆ›å»º bookinfo-gateway"></a>åˆ›å»º bookinfo-gateway</h4><ul><li>istio-Ingress.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: istio-web-ui</span><br><span class="line">  namespace: </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: productpage</span><br><span class="line">          servicePort: 9080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨è¾“å…¥<code>http://istio.xxlaila.cn</code> æ¥è®¿é—®ã€‚ç”¨ productpageä»¥æŸ¥çœ‹BookInfoç½‘é¡µã€‚å¦‚æœæ‚¨å¤šæ¬¡åˆ·æ–°é¡µé¢ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°äº§å“é¡µé¢ä¸Šæ˜¾ç¤ºçš„è¯„è®ºç‰ˆæœ¬ä¸åŒï¼Œå¹¶ä»¥å¾ªç¯æ–¹å¼æ˜¾ç¤ºï¼ˆçº¢è‰²æ˜Ÿæ˜Ÿï¼Œé»‘è‰²æ˜Ÿæ˜Ÿï¼Œæ— æ˜Ÿæ˜Ÿï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬å°šæœªä½¿ç”¨Istioæ¥æ§åˆ¶ç‰ˆæœ¬è·¯ç”±<br><img src="https://img.xxlaila.cn/1572578398765.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1572578189667.jpg" alt="img"></p><p>åŸºæœ¬é“è¿™é‡Œï¼ŒåŠ¨æ€æ›´æ”¹è¯·æ±‚è·¯ç”±å­¦ä¹ ä¸­ï¼ŒğŸ˜‚ğŸ˜‚ğŸ˜‚</p><h3 id="ç›‘æ§æ–¹å¼"><a href="#ç›‘æ§æ–¹å¼" class="headerlink" title="ç›‘æ§æ–¹å¼"></a>ç›‘æ§æ–¹å¼</h3><h4 id="ç”ŸæˆæœåŠ¡å›¾"><a href="#ç”ŸæˆæœåŠ¡å›¾" class="headerlink" title="ç”ŸæˆæœåŠ¡å›¾"></a>ç”ŸæˆæœåŠ¡å›¾</h4><p>è¦éªŒè¯Kialiæ˜¯å¦åœ¨æ‚¨çš„é›†ç¾¤ä¸­è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n istio-system get svc kiali</span></span><br><span class="line">NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">kiali   ClusterIP   10.254.156.117   &lt;none&gt;        20001/TCP   4h38m</span><br></pre></td></tr></table></figure><p>æµé‡å‘é€åˆ°ç½‘æ ¼ï¼Œæœ‰ä¸‰ç§é€‰æ‹©:<br>1.åœ¨ç½‘ç»œæµè§ˆå™¨ä¸­è®¿é—®<a href="http://istio.xxlaila.cn/productpage" target="_blank" rel="noopener">http://istio.xxlaila.cn/productpage</a><br>2.å¤šæ¬¡ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl http://istio.xxlaila.cn/productpage</span></span><br></pre></td></tr></table></figure><p>3.ä½¿ç”¨ä»¥ä¸‹watchå‘½ä»¤è¿ç»­å‘é€è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># watch -n 1 curl -o /dev/null -s -w %&#123;http_code&#125; http://istio.xxlaila.cn/productpage</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œéœ€è¦é…ç½®Kiali UIï¼Œæˆ‘ä»¬åŒæ ·é€‚ç”¨Traefixæ¥è¿›è¡Œé…ç½®</p><ul><li>kialiâ€“Ingress.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kiali--Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kiali-web-ui</span><br><span class="line">  namespace: istio-system </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: istio-kiali.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kiali</span><br><span class="line">          servicePort: 20001</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://istio-kiali.xxlaila.cn" target="_blank" rel="noopener">http://istio-kiali.xxlaila.cn</a> ï¼Œ è¦ç™»å½•Kiali UIï¼Œè¯·è½¬åˆ°Kialiç™»å½•å±å¹•ï¼Œç„¶åè¾“å…¥å­˜å‚¨åœ¨Kialiæœºå¯†ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ã€‚è´¦æˆ·å¯†ç æ˜¯å‰é¢æˆ‘ä»¬è®¾ç½®çš„</p><h4 id="1-ç½‘æ ¼æ¦‚è¿°"><a href="#1-ç½‘æ ¼æ¦‚è¿°" class="headerlink" title="1.ç½‘æ ¼æ¦‚è¿°"></a>1.ç½‘æ ¼æ¦‚è¿°</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•åç«‹å³æ˜¾ç¤ºçš„â€œæ¦‚è¿°â€é¡µé¢ä¸­æŸ¥çœ‹ç½‘æ ¼çš„æ¦‚è¿°ã€‚â€œæ¦‚è¿°â€é¡µé¢æ˜¾ç¤ºäº†ç½‘æ ¼ä¸­å…·æœ‰æœåŠ¡çš„æ‰€æœ‰åç§°ç©ºé—´ã€‚ä»¥ä¸‹å±å¹•æˆªå›¾æ˜¾ç¤ºäº†ç±»ä¼¼çš„é¡µé¢<br><img src="https://img.xxlaila.cn/1572578943386.jpg" alt="img"></p><h4 id="2-ç©ºé—´å›¾"><a href="#2-ç©ºé—´å›¾" class="headerlink" title="2.ç©ºé—´å›¾"></a>2.ç©ºé—´å›¾</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¦æŸ¥çœ‹åç§°ç©ºé—´å›¾ï¼Œè¯·åœ¨bookinfoBookinfoåç§°ç©ºé—´å¡ä¸­å•å‡»å›¾å›¾æ ‡ã€‚å›¾å½¢å›¾æ ‡ä½äºåç§°ç©ºé—´å¡çš„å·¦ä¸‹æ–¹ï¼Œçœ‹èµ·æ¥åƒæ˜¯ä¸€ç»„ç›¸è¿çš„åœˆå­ã€‚è¯¥é¡µé¢ç±»ä¼¼äº<br><img src="https://img.xxlaila.cn/1572579048298.jpg" alt="img"></p><h3 id="åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ"><a href="#åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ" class="headerlink" title="åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ"></a>åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ç”¨Istioçš„åº”ç”¨ç¨‹åºå¯ä»¥é…ç½®ä¸ºä½¿ç”¨æµè¡Œçš„Jaegeråˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿæ¥æ”¶é›†è·Ÿè¸ªèŒƒå›´ã€‚åˆ†å¸ƒå¼è·Ÿè¸ªä½¿æ‚¨å¯ä»¥æŸ¥çœ‹ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­å‘å‡ºçš„è¯·æ±‚æµï¼Œè€ŒIstioçš„æ¨¡å‹åˆ™å…è®¸è¿™æ ·åšï¼Œè€Œä¸æ„å»ºåº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„è¯­è¨€/æ¡†æ¶/å¹³å°æ— å…³ã€‚ä½¿ç”¨Traefixæ¥æä¾›è¿™ä¸ªæœåŠ¡ã€‚</p><ul><li><p>Jaeger-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; Jaeger-Ingress.yaml  &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jaeger-web-ui</span><br><span class="line">  namespace: istio-system </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: jaeger.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: jaeger-query</span><br><span class="line">          servicePort: 16686</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f Jaeger-Ingress.yaml </span></span><br><span class="line">ingress.extensions/jaeger-web-ui unchanged</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://jaeger.xxlaila.cn" target="_blank" rel="noopener">http://jaeger.xxlaila.cn</a> ï¼Œ ä½¿ç”¨Bookinfoç¤ºä¾‹ç”Ÿæˆè·Ÿè¸ªï¼Œè¦æŸ¥çœ‹è·Ÿè¸ªæ•°æ®ï¼Œå¿…é¡»å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡ã€‚è¯·æ±‚æ•°é‡å–å†³äºIstioçš„é‡‡æ ·ç‡ã€‚æ‚¨åœ¨å®‰è£…Istioæ—¶è®¾ç½®æ­¤é€Ÿç‡ã€‚é»˜è®¤é‡‡æ ·ç‡ä¸º1ï¼…ã€‚æ‚¨éœ€è¦è‡³å°‘å‘é€100ä¸ªè¯·æ±‚ï¼Œæ‰èƒ½æ˜¾ç¤ºç¬¬ä¸€æ¡è·Ÿè¸ªã€‚è¦å°†100ä¸ªè¯·æ±‚å‘é€åˆ°productpageæœåŠ¡ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in `seq 1 100`; do curl -s -o /dev/null http://istio.xxlaila.cn/productpage; done</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨ä»ªè¡¨æ¿çš„å·¦ä¾§çª—æ ¼ä¸­ï¼Œä»â€œæœåŠ¡â€ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©productpage.defaultï¼Œç„¶åå•å‡»â€œæŸ¥æ‰¾è·Ÿè¸ªâ€<br><img src="https://img.xxlaila.cn/1572592255728.jpg" alt="img"></p></li><li><p>å•å‡»é¡¶éƒ¨çš„æœ€æ–°è·Ÿè¸ªä»¥æŸ¥çœ‹ä¸å¯¹/ productpageçš„æœ€æ–°è¯·æ±‚ç›¸å¯¹åº”çš„è¯¦ç»†ä¿¡æ¯<br><img src="https://img.xxlaila.cn/1572592385675.jpg" alt="img"></p></li></ul><h3 id="ç›‘è§†Istio"><a href="#ç›‘è§†Istio" class="headerlink" title="ç›‘è§†Istio"></a>ç›‘è§†Istio</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚ä½•è®¾ç½®å’Œä½¿ç”¨Istioä»ªè¡¨æ¿ç›‘è§†ç½‘æ ¼æµé‡ã€‚ä½œä¸ºç›‘æ§çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦å°†å®‰è£…Grafana Istioæ’ä»¶ï¼Œå¹¶ä½¿ç”¨åŸºäºWebçš„ç•Œé¢æŸ¥çœ‹æœåŠ¡ç½‘æ ¼æµé‡æ•°æ®ã€‚Grafanaå°†ç”¨äºå¯è§†åŒ–æ™®ç½—ç±³ä¿®æ–¯æ•°æ®ã€‚åœ¨æ‰§è¡Œéƒ¨ç½²çš„æ—¶å€™ä¹Ÿéƒ¨ç½²äº†è¿™ä¸¤ä¸ªæœåŠ¡ã€‚</p><h4 id="åˆ›å»ºgrafana-Ingress"><a href="#åˆ›å»ºgrafana-Ingress" class="headerlink" title="åˆ›å»ºgrafana Ingress"></a>åˆ›å»ºgrafana Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;grafana-istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-istio-web-ui</span><br><span class="line">  namespace: istio-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana-istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ›å»ºï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨ä»¥å‰çš„grafanaé‡Œé¢æ·»åŠ æ•°æ®åº“æºï¼Œå°±ä¸ç”¨åœ¨æ–°èµ·ä¸€ä¸ªåŸŸåæ¥è¿›è¡Œè®¿é—®<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†æ¬¡åŠ è½½Bookinfoåº”ç”¨ç¨‹åºï¼ˆ<a href="http://istio.xxlaila.cn/productpageï¼‰" target="_blank" rel="noopener">http://istio.xxlaila.cn/productpageï¼‰</a> ï¼Œ åˆ·æ–°é¡µé¢å‡ æ¬¡ï¼ˆæˆ–å‘é€å‘½ä»¤å‡ æ¬¡ï¼‰ä»¥äº§ç”Ÿå°‘é‡æµé‡ã€‚å†æ¬¡æŸ¥çœ‹Istioä»ªè¡¨æ¿ã€‚å®ƒåº”è¯¥åæ˜ æ‰€äº§ç”Ÿçš„æµé‡ã€‚<br><img src="https://img.xxlaila.cn/1572593852626.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;istio è¿˜æä¾›äº†ç½‘æ ¼çš„å…¨å±€è§†å›¾ä»¥åŠç½‘æ ¼ä¸­çš„æœåŠ¡å’Œå·¥ä½œè´Ÿè½½ã€‚æ‚¨å¯ä»¥é€šè¿‡å¯¼èˆªåˆ°ç‰¹å®šçš„ä»ªè¡¨æ¿æ¥è·å–æœ‰å…³æœåŠ¡å’Œå·¥ä½œè´Ÿè½½çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚<br><img src="https://img.xxlaila.cn/1572594150893.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æä¾›äº†æœ‰å…³æœåŠ¡æŒ‡æ ‡çš„è¯¦ç»†ä¿¡æ¯ï¼Œç„¶åæ˜¯è¯¥æœåŠ¡çš„å®¢æˆ·ç«¯å·¥ä½œè´Ÿè½½ï¼ˆæ­£åœ¨è°ƒç”¨æ­¤æœåŠ¡çš„å·¥ä½œè´Ÿè½½ï¼‰å’ŒæœåŠ¡å·¥ä½œè´Ÿè½½ï¼ˆæ­£åœ¨æä¾›è¯¥æœåŠ¡çš„å·¥ä½œè´Ÿè½½ï¼‰ã€‚<br><img src="https://img.xxlaila.cn/1572594261333.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istio åœ¨grafana æä¾›äº†å¾ˆå¤šçš„ç›‘æ§æŒ‡æ ‡ï¼Œå¯ä»¥åˆ†åˆ«ç‚¹å‡»çœ‹çœ‹<br><img src="https://img.xxlaila.cn/1572594330246.jpg" alt="img"></p><h3 id="æŸ¥è¯¢IstioæŒ‡æ ‡"><a href="#æŸ¥è¯¢IstioæŒ‡æ ‡" class="headerlink" title="æŸ¥è¯¢IstioæŒ‡æ ‡"></a>æŸ¥è¯¢IstioæŒ‡æ ‡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Istioçš„æ•°æ®æ˜¯å­˜å‚¨åœ¨prometheusé‡Œé¢çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡prometheusè¿›è¡Œç›´æ¥æ•°æ®çš„æŸ¥è¯¢</p><h4 id="æŸ¥çœ‹prometheusæœåŠ¡"><a href="#æŸ¥çœ‹prometheusæœåŠ¡" class="headerlink" title="æŸ¥çœ‹prometheusæœåŠ¡"></a>æŸ¥çœ‹prometheusæœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n istio-system get svc prometheus</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">prometheus   ClusterIP   10.254.145.181   &lt;none&gt;        9090/TCP   5h35m</span><br></pre></td></tr></table></figure><h4 id="prometheus-traefix"><a href="#prometheus-traefix" class="headerlink" title="prometheus traefix"></a>prometheus traefix</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡traefix æ¥ä»£ç†prometheusï¼Œç„¶åæˆ‘ä»¬å°†æµé‡å‘é€åˆ°ç½‘æ ¼ã€‚</p><ul><li><p>prometheus-istio.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; prometheus-istio-Ingress.yaml &lt;&lt;EOF</span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-istio-web-ui</span><br><span class="line">  namespace: istio-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus-istio.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f prometheus-istio-Ingress.yaml </span></span><br><span class="line">ingress.extensions/prometheus-istio-web-ui created</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨æ‰“å¼€<a href="http://prometheus-istio.xxlaila.cn" target="_blank" rel="noopener">http://prometheus-istio.xxlaila.cn</a> ï¼Œå¯ä»¥åœ¨è¾“å…¥æ¡†é‡Œé¢è¾“å…¥è¡¨è¾¾å¼æ¥è·å–æŒ‡ï¼Œè¾“å…¥æ–‡æœ¬ï¼šistio_requests_total<br><img src="https://img.xxlaila.cn/1572594888435.jpg" alt="img"></p><ul><li><p>å…¶ä»–æŸ¥è¯¢å°è¯•ï¼š</p><ul><li><p>å¯¹productpageæœåŠ¡çš„æ‰€æœ‰è¯·æ±‚æ€»æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">istio_requests_total&#123;destination_service=<span class="string">"productpage.default.svc.cluster.local"</span>&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯¹v3ç‰ˆæœ¬çš„è¯„è®ºæœåŠ¡çš„æ‰€æœ‰è¯·æ±‚æ€»æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">istio_requests_total&#123;destination_service=<span class="string">"reviews.default.svc.cluster.local"</span>, destination_version=<span class="string">"v3"</span>&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>è¯¥æŸ¥è¯¢å°†æ‰€æœ‰è¯·æ±‚çš„å½“å‰æ€»æ•°è¿”å›åˆ°è¯„è®ºæœåŠ¡çš„v3ã€‚</p><ul><li>è¿‡å»5åˆ†é’Ÿå†…å¯¹productpageæœåŠ¡æ‰€æœ‰å®ä¾‹çš„è¯·æ±‚ç‡ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rate(istio_requests_total&#123;destination_service=~<span class="string">"productpage.*"</span>, response_code=<span class="string">"200"</span>&#125;[5m])</span><br></pre></td></tr></table></figure></li></ul></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>istio</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineæ ¸å¿ƒé«˜çº§ç¯‡</title>
    <url>/2019/10/26/pipeline%E9%AB%98%E7%BA%A7%E7%AF%87/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢çš„ä¸¤ç¯‡æ–‡ç« ä»‹ç»äº†pipelineçš„åŸºæœ¬ä½¿ç”¨å’Œä¸€äº›å®é™…ä½¿ç”¨çš„ä¾‹å­ï¼Œçœ‹ä¼¼å¾ˆä¸é”™ï¼Œä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¹Ÿä¼šå‡ºç°å¾ˆå¤šçš„ä¸è¶³å’Œé—®é¢˜ï¼Œéšä¹‹ç³»ç»Ÿçš„åºå¤§ã€æœåŠ¡çš„å¢åŠ ã€äººå‘˜çš„å‚å·®ä¸é½ä¼šå¯¼è‡´å¾ˆå¤šçš„é—®é¢˜ã€‚<a id="more"></a>å±Šæ—¶ä¼šå¸¦æ¥å¾ˆå¤§çš„ç»´æŠ¤æˆæœ¬å’Œä¸€äº›æ”¹åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åšäº‹æƒ…ä¹‹å‰å°±è¦è€ƒè™‘è¿›å»ï¼Œä¸€äº›æ„å¤–äº‹ä»¶çš„å‘ç”Ÿã€æˆ–è€…æ˜¯åœ¨å°†æ¥å³å°†ä¼šå‘ç”Ÿå’Œéœ€è¦æ”¹å˜çš„äº‹æƒ…æˆ‘ä»¬éƒ½è¦æƒ³åˆ°æˆ–è€…æ˜¯é¢„ç•™å£å­ï¼Œè¿™æ ·æ‰åœ¨ä»Šåæ‰©å±•ã€ä¿®æ”¹ã€å¼•å…¥éƒ½èƒ½æœ‰å¾ˆå¥½å¯å¡‘æ€§ã€‚</p><h3 id="jenkins-jobä»‹ç»"><a href="#jenkins-jobä»‹ç»" class="headerlink" title="jenkins jobä»‹ç»"></a>jenkins jobä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨jenkinsçš„æ™®é€šjobï¼Œæ™®é€šçš„jobå¥½å¤„æ˜¯é…ç½®ç®€å•ï¼Œç»“æ„åŒ–å¯ä»¥å¤æ‚ï¼Œä¹Ÿå¯ä»¥å•ä¸€ã€‚åœ¨ä½¿ç”¨jenkins jobçš„æ—¶å€™æˆ‘ä»¬åˆ†ä¸ºä¸¤ç§ï¼šä¸€ç§æ˜¯å•ä¸€jobï¼Œä¸€ç§æ˜¯å…·æœ‰è€¦åˆæ€§çš„ã€‚ä¸‹é¢å¯¹ä¸¤ç§æƒ…å†µè¿›è¡Œå¯¹æ¯”å’Œæ¯”è¾ƒã€‚</p><h4 id="jenkins-å•ä¸€job"><a href="#jenkins-å•ä¸€job" class="headerlink" title="jenkins å•ä¸€job"></a>jenkins å•ä¸€job</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨jenkinsçš„ä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œå•ä¸€çš„çš„jobå¯ä»¥è®©ç»´æŠ¤äººå‘˜å¯ä»¥å¾ˆå¥½çš„æŸ¥çœ‹é‡Œé¢çš„é€»è¾‘æ­¥éª¤ï¼Œjobé‡Œé¢æ‰€æœ‰çš„ä»»åŠ¡éƒ½åœ¨è¿™ä¸ªæ‰€å±çš„ç©ºé—´é‡Œé¢æ‰§è¡Œï¼Œå®ƒé‡Œé¢åŒ…å«äº†ï¼šä»£ç pullã€ç¼–è¯‘ã€æ‰“åŒ…ã€å¤åˆ¶åŒ…ã€å‘å¸ƒåŒ…ï¼ˆä½¿ç”¨å†…ç½®çš„shellæ¨¡å—æ¥å†™shellï¼Œè¿™ç§åº”è¯¥ä¸å­˜åœ¨ï¼‰ã€‚ç§å•ä¸€jobæœåŠ¡ç®—å¾—ä¸Šæ˜¯æœåŠ¡å‘¨åˆ°ï¼Œä¸å½±å“å…¶ä»–äººï¼Œè‡ªå·±ç®¡ç†å¥½è‡ªå·±çš„ä¸€äº©ä¸‰åˆ†åœ°ã€‚å¥½å¤„æ˜¯å½“å‡ºé”™ä»¥åå½±å“èŒƒå›´å°ï¼Œå®¹æ˜“æ§åˆ¶ã€‚å¦‚ä¸‹å›¾ï¼š<br><img src="https://img.xxlaila.cn/1572064519037.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¿™ä¸­æ¨¡å¼ä¸‹ï¼Œç»´æŠ¤äººå‘˜å‰æœŸç”¨çœ‹ä¼¼æ¯”è¾ƒè½»æ¾çš„å·¥ä½œå»ºç«‹èµ·äº†æ•´ä¸ªå‘å¸ƒæµç¨‹ã€‚ä½†æ˜¯åˆ°äº†åæœŸå°±ä¸è¡Œäº†ã€‚ä¹‹å‰æˆ‘åœ¨çš„è¿™å®¶å…¬å¸å‰æœŸä¹Ÿæ˜¯è¿™ä¹ˆè¿™ä¹ˆåšçš„ã€‚å¼€å‘å®Œæˆåæäº¤gitï¼Œç„¶åè‡ªåŠ¨è§¦å‘ã€æ„å»ºã€åˆ¶å“åº“ã€å‘å¸ƒï¼Œåœ¨ä¸€ä¸ªjobé‡Œé¢å°±å®Œæˆäº†ã€‚åæ¥æˆ‘ä»¬å‡†å¤‡æ¨è¡Œæ›´å¥½çš„devopsæ–¹æ¡ˆçš„æ—¶å€™ï¼›å‘ç°ä»¥å‰çš„è¿™ä¸ªjobå»ºç«‹æœ‰é—®é¢˜ï¼Œä¸€æƒ³åˆ°å‡ ç™¾ä¸ªå¾®æœåŠ¡ï¼Œå‡ ç™¾ä¸ªjobéœ€è¦å»è¿›è¡Œæ”¹é€ ã€‚é¡¿æ—¶æˆ‘ä»¬è¿ç»´è„¸çº¿ä¸€é»‘ï¼Œè™½ç„¶æˆ‘ä»¬è‡ªå·±å†™äº†ä¸€ä¸ªå¿«é€Ÿåœ¨jenkinsä¸Šå»ºç«‹jobï¼Œä½†æ˜¯ä¸€æƒ³åˆ°å‡ ç™¾ä¸ªè¿˜æ˜¯ä¸å¥½ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†jobä¹‹é—´çš„ä»»åŠ¡å…³è”ï¼Œç„¶åé€šè¿‡å‚æ•°ä¼ é€’å®Œæˆæ•´ä¸ªæµç¨‹æœåŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™ç§æ¨¡å¼ä¸‹çš„å¼Šç«¯å°±å¦‚ä¸Šé¢æ‰€è¯´çš„ä¸€æ ·ï¼Œä½†ä»€ä¹ˆæ—¶å€™å¥½çš„æœåŠ¡å‘¢ï¼Ÿå¥½çš„æœåŠ¡åˆæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™é‡Œä¹Ÿå¯ä»¥åµŒå¥—ä¸€äº›å¾®æœåŠ¡çš„æ¦‚å¿µç†è®ºã€‚å¦‚æœæˆ‘ä»¬è¦åšåˆ°ä»€ä¹ˆæ—¶å€™å¥½çš„æœåŠ¡ï¼Œæˆ‘ä»¬å¾—äº†è§£äº†è§£ä¸€ä¸‹: ä½è€¦åˆå’Œé«˜å†…èšã€‚äº†è§£è¿™ä¸ªä¸œè¥¿æœ‰åŠ©äºæˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„pipeline æµæ°´çº¿çš„è®¾è®¡ï¼ŒåŒ…æ‹¬åœ¨åæœŸdevopsçš„è®¾è®¡ä»¥åŠæ’¸ç éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚</p><h3 id="è€¦åˆæ€§"><a href="#è€¦åˆæ€§" class="headerlink" title="è€¦åˆæ€§"></a>è€¦åˆæ€§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆæˆ‘ä»¬æ¥äº†è§£è¿™ä¸€æ¦‚å¿µ: â€œé«˜å†…èšä½è€¦åˆâ€ã€‚åœ¨è½¯ä»¶è®¾è®¡ä¸­é€šå¸¸ç”¨è€¦åˆåº¦å’Œå†…èšåº¦ä½œä¸ºè¡¡é‡æ¨¡å—ç‹¬ç«‹ç¨‹åº¦çš„æ ‡å‡†ã€‚åˆ’åˆ†æ¨¡å—çš„ä¸€ä¸ªå‡†åˆ™æ˜¯é«˜å†…èšä½è€¦åˆã€‚ä»æ¨¡å—ç²’åº¦æ¥çœ‹ï¼Œé«˜å†…èšï¼šå°½å¯èƒ½ç±»çš„æ¯ä¸ªæˆå‘˜æ–¹æ³•åªå®Œæˆä¸€ä»¶äº‹ï¼ˆæœ€å¤§é™åº¦çš„èšåˆï¼‰ï¼›ä½è€¦åˆï¼šå‡å°‘ç±»å†…éƒ¨ï¼Œä¸€ä¸ªæˆå‘˜æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæˆå‘˜æ–¹æ³•ã€‚ä»ç±»è§’åº¦æ¥çœ‹ï¼Œé«˜å†…èšä½è€¦åˆï¼šå‡å°‘ç±»å†…éƒ¨ï¼Œå¯¹å…¶ä»–ç±»çš„è°ƒç”¨ï¼›ä»åŠŸèƒ½å—æ¥çœ‹ï¼Œé«˜å†…èšä½è€¦åˆï¼šå‡å°‘æ¨¡å—ä¹‹é—´çš„äº¤äº’å¤æ‚åº¦ï¼ˆæ¥å£æ•°é‡ï¼Œå‚æ•°æ•°æ®ï¼‰å³æ¨ªå‘ï¼šç±»ä¸ç±»ä¹‹é—´ã€æ¨¡å—ä¸æ¨¡å—ä¹‹é—´ï¼›çºµå‘ï¼šå±‚æ¬¡ä¹‹é—´ï¼›å°½å¯èƒ½ï¼Œå†…å®¹å†…èšï¼Œæ•°æ®è€¦åˆã€‚</p><h4 id="ä½è€¦åˆ"><a href="#ä½è€¦åˆ" class="headerlink" title="ä½è€¦åˆ"></a>ä½è€¦åˆ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸åŒæ¨¡å—ç›¸äº’ä¾èµ–å¤šå°‘ï¼Ÿæ¨¡å—åº”å°½å¯èƒ½ç‹¬ç«‹äºå…¶ä»–æ¨¡å—ï¼Œä»¥ä½¿å¯¹æ¨¡å—çš„æ›´æ”¹ä¸ä¼šä¸¥é‡å½±å“å…¶ä»–æ¨¡å—ã€‚</p><h4 id="é«˜è€¦åˆ"><a href="#é«˜è€¦åˆ" class="headerlink" title="é«˜è€¦åˆ"></a>é«˜è€¦åˆ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é«˜è€¦åˆå°†æ„å‘³ç€æ‚¨çš„æ¨¡å—å¯¹å…¶ä»–æ¨¡å—çš„å†…éƒ¨è¿ä½œäº†è§£å¤ªå¤šã€‚å¯¹å…¶ä»–æ¨¡å—äº†è§£å¤ªå¤šçš„æ¨¡å—ä¼šä½¿æ›´æ”¹éš¾ä»¥åè°ƒï¼Œå¹¶ä½¿æ¨¡å—èƒ½åŠ›å˜å¼±ã€‚å¦‚æœæ¨¡å—Aå¯¹æ¨¡å—Bçš„äº†è§£è¿‡å¤šï¼Œåˆ™å¯¹æ¨¡å—Bå†…éƒ¨çš„æ›´æ”¹å¯èƒ½ä¼šç ´åæ¨¡å—Açš„åŠŸèƒ½ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡å®ç°ä½è€¦åˆï¼Œå¯ä»¥è½»æ¾æ›´æ”¹æ¨¡å—å†…éƒ¨ï¼Œä¸å¿…æ‹…å¿ƒå®ƒä»¬å¯¹ç³»ç»Ÿä¸­å…¶ä»–æ¨¡å—çš„å½±å“ã€‚ä½è€¦åˆè¿˜ä½¿æˆ‘ä»¬çš„æ¨¡å—å½¼æ­¤ä¹‹é—´ä¸ç›¸äº’ä¾èµ–ï¼Œå› æ­¤æ›´æ˜“äºè®¾è®¡ï¼Œç¼–å†™å’Œæµ‹è¯•ä»£ç ã€‚æˆ‘ä»¬è¿˜è·å¾—äº†æ˜“äºé‡ç”¨å’Œå¯ç»„åˆçš„æ¨¡å—çš„ä¼˜åŠ¿ã€‚é—®é¢˜ä¹Ÿè¢«éš”ç¦»åˆ°å°çš„ï¼Œç‹¬ç«‹çš„ä»£ç å•å…ƒä¸­ã€‚</p><p><strong>å¥½å¤„:</strong></p><ul><li>å¯ç»´æŠ¤æ€§: æ›´æ”¹é™åˆ¶åœ¨ä¸€ä¸ªæ¨¡å—ä¸­</li><li>å¯æµ‹è¯•æ€§: å•å…ƒæµ‹è¯•ä¸­æ¶‰åŠçš„æ¨¡å—å¯ä»¥é™åˆ¶åœ¨æœ€ä½é™åº¦</li><li>å¯è¯»æ€§: éœ€è¦åˆ†æçš„ç±»å‡å°‘</li></ul><h4 id="é«˜å†…èš"><a href="#é«˜å†…èš" class="headerlink" title="é«˜å†…èš"></a>é«˜å†…èš</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…èšæ€§é€šå¸¸æ˜¯æŒ‡æ¨¡å—çš„å…ƒç´ å¦‚ä½•ç›¸äº’ç»„åˆã€‚ç›¸å…³ä»£ç åº”å½¼æ­¤æ¥è¿‘ï¼Œä»¥ä½¿å…¶å…·æœ‰é«˜åº¦çš„å‡èšåŠ›ã€‚æ˜“äºç»´æŠ¤çš„ä»£ç é€šå¸¸å…·æœ‰å¾ˆé«˜çš„å†…èšæ€§ã€‚æ¨¡å—ä¸­çš„å…ƒç´ ä¸è¯¥æ¨¡å—è¦æä¾›çš„åŠŸèƒ½ç›´æ¥ç›¸å…³ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ï¼Œæœ€å¥½æ˜¯åœ¨ä¸€ä¸ªåœ°æ–¹è¿›è¡Œä¿®æ”¹ï¼Œç„¶åå¯ä»¥å°½å¿«çš„å‘å¸ƒã€‚å¦‚æœå¾ˆå¤šä¸åŒçš„åœ°æ–¹è¦è¿›è¡Œä¿®æ”¹ï¼Œå°±æœ‰å¯èƒ½éœ€è¦å‘å¸ƒå¤šä¸ªå¾®æœåŠ¡æ‰èƒ½äº¤äº’è¿™ä¸ªåŠŸèƒ½ã€‚åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œä¿®æ”¹ï¼Œä¸ä»…ä¿®æ”¹é€Ÿåº¦å¾ˆæ…¢ï¼ŒåŒæ—¶éƒ¨ç½²å¤šä¸ªå¾®æœåŠ¡ä¹Ÿæé«˜äº†é£é™©ã€‚æ‰€ä»¥åœ¨æ‰¾åˆ°é—®é¢˜åŸŸçš„è¾¹ç•ŒåŸŸåå¯ä»¥ç¡®ä¿ç›¸å…³çš„è¡Œä¸ºèƒ½æ”¾åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼Œå¹¶ä¸”å®ƒä»¬ä¼šå’Œå…¶å®ƒè¾¹ç•Œä»¥å°½é‡ä½è€¦åˆçš„å½¢å¼è¿›è¡Œé€šä¿¡ã€‚</p><p><strong>å¥½å¤„:</strong></p><ul><li>å¯è¯»æ€§: åŠŸèƒ½åŒ…å«åœ¨å•ä¸ªæ¨¡å—ä¸­</li><li>å¯ç»´æŠ¤æ€§: è°ƒè¯•å¾€å¾€åŒ…å«åœ¨å•ä¸ªæ¨¡å—ä¸­</li><li>å¯é‡ç”¨æ€§: å…·æœ‰é›†ä¸­åŠŸèƒ½ä¸ä¼šè¢«æ— ç”¨çš„å¹²æ‰°</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…èšæ€§ä½æ„å‘³ç€ç»„æˆæŸäº›åŠŸèƒ½çš„ä»£ç ä¼šæ•£å¸ƒåœ¨æ‚¨çš„æ•´ä¸ªä»£ç åº“ä¸­ã€‚ä¸ä»…å¾ˆéš¾å‘ç°ä¸æ‚¨çš„æ¨¡å—ç›¸å…³çš„ä»£ç ï¼Œè€Œä¸”å¾ˆéš¾åœ¨ä¸åŒçš„æ¨¡å—ä¹‹é—´è·³è½¬å¹¶è·Ÿè¸ªçš„æ‰€æœ‰ä»£ç ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šä¿—çš„æ¥è®²ï¼Œå†…èšæ˜¯ä»åŠŸèƒ½è§’åº¦æ¥åº¦é‡æ¨¡å—å†…çš„è”ç³»ï¼Œå¥½çš„å†…èšæ¨¡å—åº”æ°å¥½åšä¸€ä»¶äº‹ã€‚æè¿°çš„æ˜¯æ¨¡å—å†…çš„åŠŸèƒ½è”ç³»ã€‚è€¦åˆæ˜¯è½¯ä»¶ç»“æ„ä¸­å„æ¨¡å—ä¹‹é—´ç›¸äº’è¿æ¥çš„ä¸€ç§åº¦é‡ï¼Œè€¦åˆå¼ºå¼±å–å†³äºæ¨¡å—é—´æ¥å£çš„å¤æ‚ç¨‹åº¦ã€è¿›å…¥æˆ–è®¿é—®ä¸€ä¸ªæ¨¡å—ç‚¹ä»¥åŠé€šè¿‡æ¥å£çš„æ•°æ®ã€‚</p><h4 id="å¯ç»´æŠ¤çš„ä»£ç "><a href="#å¯ç»´æŠ¤çš„ä»£ç " class="headerlink" title="å¯ç»´æŠ¤çš„ä»£ç "></a>å¯ç»´æŠ¤çš„ä»£ç </h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸€èˆ¬åœ¨ç¼–å†™å¯ç»´æŠ¤çš„ä»£ç æœ‰åŠ©äºæé«˜å¼€å‘äººå‘˜çš„ç”Ÿäº§åŠ›ã€‚å…·æœ‰é«˜åº¦å¯ç»´æŠ¤çš„ä»£ç ä½¿è®¾è®¡æ–°åŠŸèƒ½å’Œç¼–å†™ä»£ç å˜å¾—æ›´åŠ å®¹æ˜“ã€‚æ¨¡å—åŒ–ï¼ŒåŸºäºç»„ä»¶çš„åˆ†å±‚ä»£ç å¯æé«˜ç”Ÿäº§ç‡å¹¶é™ä½è¿›è¡Œæ›´æ”¹æ—¶çš„é£é™©ã€‚é€šè¿‡ä½¿ä»£ç ä¿æŒæ¾æ•£è€¦åˆï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ¨¡å—å†…ç¼–å†™ä»£ç ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–æ¨¡å—ã€‚é€šè¿‡ä¿æŒä»£ç çš„å†…èšæ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ›´è½»æ¾åœ°ç¼–å†™æ˜“äºä½¿ç”¨çš„DRYä»£ç ã€‚</p><p><strong>é—®é¢˜</strong>: å½“æˆ‘ä»¬é‡åˆ°é—®é¢˜æ—¶ï¼Œè¯·è¯„ä¼°ä¿®å¤ã€ä¿®æ”¹ç¨‹åºçš„ç¨‹åº¦ã€‚æ˜¯æ›´æ”¹ä¸€ä¸ªæ¨¡å—ï¼Œè¿˜æ˜¯æ›´æ”¹åˆ†æ•£åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ï¼Ÿåœ¨è¿›è¡Œæ›´æ”¹æ—¶ï¼Œå®ƒæ˜¯å¦å¯ä»¥è§£å†³æ‰€æœ‰çš„é—®é¢˜ï¼Œè¿˜æ˜¯ä¼šäº§ç”Ÿå…¶ä»–ä¸€äº›ä¸å¯é¢„çŸ¥çš„é—®é¢˜ï¼Ÿ</p><p>åœ¨ç¼–å†™å’Œä½¿ç”¨ä»£ç åº“æ—¶:</p><ul><li>æˆ‘è¦ä¿®å¤å’Œåˆ›å»ºçš„æ­¤åŠŸèƒ½æ¨¡å—æ˜¯å¤šå°‘ï¼Ÿ</li><li>æ­¤æ›´æ”¹æ˜¯è¦åœ¨å‡ ä¸ªä¸åŒçš„åœ°æ–¹è¿›è¡Œï¼Ÿ</li><li>æˆ‘èƒ½å¦ç‹¬ç«‹æµ‹è¯•ä»£ç ï¼Œæµ‹è¯•æ•´ä¸ªä»£ç æœ‰å¤šéš¾ï¼Ÿ</li><li>æˆ‘ä»¬æ˜¯å¦å¯ä»¥ä½¿ä»£ç æ›´æ¾æ•£åœ°è€¦åˆæ¥æ”¹å–„ï¼Ÿå¯ä»¥ä½¿ç”¨é«˜å†…èšæ¥æ”¹å–„æˆ‘ä»¬çš„ä»£ç å—ï¼Ÿ</li></ul><h3 id="Jenkins-è®¾è®¡"><a href="#Jenkins-è®¾è®¡" class="headerlink" title="Jenkins è®¾è®¡"></a>Jenkins è®¾è®¡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†ä¸Šé¢çš„çš„ç†è®ºä¸æ¦‚å¿µã€‚æ ¹æ®è¿™é‡Œç†è®ºå’Œæ¦‚å¿µæˆ‘ä»¬å°±å¯ä»¥è®¾è®¡å‡ºä¸€å¥—æ›´å¥½çš„devopsæµç¨‹ã€‚æœ¬æ–‡å°†kuberneteså¹³å°ä¸Šæ¥åšè¿™ä¸€å¥—è®¾è®¡ï¼Œå¹¶åœ¨å®é™…çš„ç¯å¢ƒä¸­åº”ç”¨ã€‚æ¶‰åŠçš„åŠŸèƒ½å¦‚ä¸‹: æœåŠ¡ Jobã€Code Jobã€Releaseã€Noticeå››ä¸ªåŠŸèƒ½ä»»åŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¯ä¸€ä¸ªç¯å¢ƒæœ‰é”™è¯¯ï¼Œå°±ä¼šæ‰§è¡Œå‘Šè­¦ä»»åŠ¡æ¨¡å—ï¼Œå‘Šè­¦ç›®å‰ä½¿ç”¨çš„æ˜¯<a href="https://github.com/xxlaila/jenkins-wechat-notice" target="_blank" rel="noopener">ä¼ä¸šå¾®ä¿¡</a>ã€‚jobä¹‹é—´éœ€è¦ä¼ é€’JOB_NAMEï¼Œenvï¼Œversionä¸‰ä¸ªå‚æ•°ã€‚åœ¨ä¹‹å‰çš„devopsè®¾è®¡é‡Œé¢æ•´ä¸ªjobçš„è°ƒç”¨è®¾è®¡è¿˜è¦å¤šã€‚å½¢æˆäº†ä¸€ä¸ªé€šç”¨ä½“ç³»ã€‚åœ¨è¿™ä¸ªè®¾è®¡é‡Œé¢ï¼Œå½“è¿˜éœ€è¦å¢åŠ ä¸€ä¸ªä»»åŠ¡æµç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹pipelineï¼Œç„¶åå¢åŠ ä¸€ä¸ªjobï¼Œåœ¨ä¸‹æ¬¡æ„å»ºçš„æ—¶å€™å°±ä¼šæŠŠæˆ‘ä»¬æ–°å¢åŠ çš„æµç¨‹ç»™åŠ è¿›å»ï¼Œéå¸¸çš„æ–¹ä¾¿ã€‚è®¾è®¡å›¾å¦‚ä¸‹ï¼š<br><img src="https://img.xxlaila.cn/1572081425995.jpg" alt="img"></p><h4 id="Project-Name"><a href="#Project-Name" class="headerlink" title="Project Name"></a>Project Name</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤jobä¸€èˆ¬å°±æ˜¯æœåŠ¡ï¼Œjobåç§°ä»¥æœåŠ¡çš„åç§°è¿›è¡Œå‘½åã€‚é‡Œé¢åŒ…å«äº†å››ä¸ªåŠŸèƒ½.</p><ul><li>Clone Code: clone ä»£ç ã€‚</li><li>Build Code: å°±æ˜¯å¯¹å¼€å‘æäº¤çš„ä»£ç è¿›è¡Œç¼–è¯‘ã€‚</li><li>Env Version: è·å–æœ¬æ¬¡æäº¤çš„hashï¼Œä»¥hashä¸ºç‰ˆæœ¬ï¼Œç»“åˆç¯å¢ƒæ¥åšä¸€ä¸ªç‰ˆæœ¬è®°å½•ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œåˆ¤æ–­ã€‚uat/prodç¯å¢ƒä¸éœ€è¦envå‰ç¼€ã€‚</li><li>Build Docker: æŠŠç¼–è¯‘å®Œæˆåçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰“åŒ…æˆä¸€ä¸ªdockeré•œåƒã€‚</li></ul><h4 id="Code-Test"><a href="#Code-Test" class="headerlink" title="Code Test"></a>Code Test</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºæµ‹è¯•è¿›è¡Œå¯¹ä»£ç çš„è‡ªåŠ¨åŒ–æµ‹è¯•ï¼›è‡ªåŠ¨åŒ–æµç¨‹ã€æ€§èƒ½ç­‰æµ‹è¯•</p><h4 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸»è¦æ˜¯è¿›è¡Œå‘å¸ƒæœåŠ¡ã€‚å½“æ¥å—åˆ°ä¸Šæ¸¸jobä¼ é€’æ¥çš„å‚æ•°ä¿¡æ¯åï¼Œç»“åˆå‚æ•°ä¿¡æ¯æ¥è¿›è¡Œå¯¹åº”çš„å‘å¸ƒåˆ°kubernetesä¸­namespaceä¸­ï¼Œä¸»è¦åŒ…å«äº†ä»¥ä¸‹åŠŸèƒ½</p><ul><li>Push Docker: æŠŠå‰é¢æ‰“åŒ…çš„dockeré•œåƒæ¨é€åˆ°harbor</li><li>Edit Files: ä¿®æ”¹å‘å¸ƒçš„è„šæœ¬</li><li>Release: æ‰§è¡Œ<code>kubectl</code>è¿›è¡Œå‘å¸ƒ<ul><li>å½“å‘å¸ƒåˆ°kubernetesä¸­ï¼Œkubernetes ä¼šæ‰§è¡Œ<a href="https://xxlaila.github.io/2019/09/27/k8s-pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/" target="_blank" rel="noopener">healthæ£€æµ‹</a>ï¼Œå¦‚æœå¯åŠ¨å¤±è´¥ï¼Œä¼šè¿›è¡Œé€šçŸ¥</li></ul></li></ul><h4 id="Notice"><a href="#Notice" class="headerlink" title="Notice"></a>Notice</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤jobä¸»è¦ç”¨äºé€šçŸ¥ã€‚å½“æ¥å—åˆ°è§„åˆ™çš„å‘Šè­¦é€šçŸ¥ä»¥åï¼Œå°±ä¼šè¿›è¡Œè§¦å‘é€šçŸ¥ç›¸å…³çš„äººå‘˜ã€‚</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineå¤šåˆ†æ”¯gitlabè§¦å‘</title>
    <url>/2019/10/25/pipeline%E5%A4%9A%E5%88%86%E6%94%AFgitlab%E8%A7%A6%E5%8F%91/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="enter password to read." />
    <label for="hbePass">enter password to read.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="63d7f763d0e0c56f9f2b1fcc9e94e9e559752980106663f4de94be3bb8d5c212">d69a90776b8106231e3f5503e1ddcc136de8bd46ea761b7fee0bb1563c6f63d33ee7fe314e91a233c8e9fec56138e12922d3b2c1384fdc444e3fa18c023af9c85cd9f16c2daf3908810840b7385dfd5f0c1aab84c4580f989b88f276c199d7fc3bfb7626f9808f4ff576f576f887a539c867aaaf3a9d4427cb3b8ade8deff9ea5fbd8204acb5ae6cb6c3de25db4861b63413634d1217e38a21265a50fb7ac670177e4c200f8fe988fbca804dbf7a858a301c3656baa828454fef99ea3954f040eccc3a6a7b0c59dcd2a98d451c8390dfe249e0929b3f4c2e6026c78346ed63997083efc103917ff60286a9aac1503543810da145710961389d698fc2b8f45089b4537bc6858bdacf9010565e32ca487990a3e36bb6e08e9951315d3a59f537bf870ccc85c7e1ff85e965ee6bb2434370bda3e4873bb84c88a665fae01a74b2a326e03aee44615fa21d8a217956e5af2f3f84914ab01a5ba2bd71d78bf092409b2457ac1163e87d5f0bd3880fa2ba6380c51c78fc4cb3db302d6f85b886ffec707228bc687f8d9f15db52b00c0730a2049f5864bcbe0f3014340f58f4ed04fda6fbc9a162fc684f770ca5f68efe5c5764ee93b91fe599db4213b01d329827a165864b18a309a066b4895fa2c75a39bce53cd913898b7e37fb092156329e53b293ca07e9815770ad29555873948647559dac38cc29aea965afe6d68764e10b0b97bdebf84d227e55da76ad89993b4d7d5c460e75e30c0dcf52ea10bf6a4c4fcadde4924c18ecdadb9d690b9334fafcb645730765bb08a25817775f4f5e427a1c69ddb90d9f02acc4e5a4e2855bfaf20132442b92edcff39ece17303ac88c54bfb5b36b045f1471785d61ec1cfad9cb4512a5fda52c700e433d7dd4d9141f89beaeadd66cdd1be2cf2cd0ef141cbff8f37871f5645e03f3153ceed6ee206494734184412a0d3fb5d279f33c8f7db28c5b3db6a61c6c39dbd295e6aa7d58991a973e7c7d873214e4069b0c42de744cd6658878532c25fd2120c08496f8ecf9789fc40454b8bb5871248fe7aa4461e008c8c22e16d645f539c2864132fbbc7b6c9efeae942de5c95ee2e313632656760586c34829fc0522ecb816440ad4603b3c459250c57d4d47839dbae2e9832489a079bbbe0dca316482ff21b37d028524a66763f050145932d64a6638d581c5fe26f70c441976b14ac8cb08d037a465c78241b8db356e6bf1a333d2b704a055da1a76c1a23f80111296beab2aa84cccc0c75d044cbc755c6987a7420f385d2c9ffaf239777c6f4ee1a370b1cefe5570375ed208b9b5e6f7318824fcd64b57f2bc00fbf3466505c3d5ec84079aadef18559bcfc399441066cd6070153591dad2dd7b78e3477841e85d03de5d69f3288ecedf79536373b4d87f2e4edac9bf4837d4766d428fd98e68275bdc16b72088e35a1d466af4c2e3c65332c3e71ab5e07e9714c39bd2c9d615bc46cb65107d9b64eda01a695dc3236f38ae188a2629f4b78e4004073a3fa916249feae32a3e568fed1f161bf7f66555e3a6f791040ed9684b492f47db7322fb933660ba85f9562f230fbfcafa1897fcfac659467aee8875839e5d76df996a2143d4af742c746873dc10925ca93f8e795924eb2d9b1119478afd5df127df3513713b57c470a77ce431df9412b5de8f61a529ffdf2ea8f72c283c643cb6a31397689d79b8d48ba9538b2e98a1135085925449de687934dce3e8438311ecf1ffb778699cece8bb7d9e320c12962bd39f66140322b8ec4c36f2a13c1a8906c2baec8cfc397174a2b728b79a6d0df6b6d40124462d018a968e5e4de7bf15e8be4cb32068521fca3580ab8657560b37c79930cd42f728ef8d85a528733ea2436d869f6c26830d895e57c6922dca9e97d5047cd6810ccc9f3b3d92174cdfbae8c6e878bdefcd3794d15a53aef524e0ef2360a76df3e3e93bc2f73d56609ee24b61e7c1cab6083a86dd71deb82cd74e5a1ef6b529f1e8128e9198b029c73ea461eb4b4229b43340eba7543731c191f94b410cabf173ee6f493dcf2b3f776aec75c107ba431f8d6c148a177776eb4d9d09a31dcbee3b70b3876b0474b2633cb0bb110280aba3b80022ddc8e4fcb81aee08c234bb9497b775bc30a983823bce7d2160c538f5948428d180929e7065d72d624a197eb138e7e66f23797ac8b62f3b4dc94f6d48deb7a6dad0c681f58d628a8a2e283b07a508cc655b44f99e399e379226dcdc0e598c23a701d25c9e30fdb662c3d17d04f690132e1169518058c2e722a0378cbb01eb20c421e5776df2b6197886f8353479e58a475a6fc584455360b4f6b15f1388721b2ea78f55a644a5f74d1def63505bad8dd6f5de0d8d00c66e390cf40a663dcf159214c3ea7257c6b84c0c3cea156062f755ac590142508d88a025e2c93f5ba98d0ba0be0ac9bea30f0a5a037b18037cb9e20e19a55e89f4fe2e237fb542bd842c684f33e23cecd88d9f83d6d4ec2774b06bbc00aed9ebab00e5b633afa695a58507dadc5775c45879f59c54b9dc38fd4954bd1d6f94341e2ced97b00ca3f00799bdfc5f8225e5ce8fe3ec5f1054dab85285b297272ea4fe170d644a0807c6b039a6f973bc4c1811a6ddedea9408f8605f39cd7f33d8db218c9083a1105d669fb91fcacd52bec8df0d923c87dc78e512b00cf886a7447ffcb4f56726e31693cc7461e4aed2aa9f79816201030199000acf11e89f353d600b1630b2cd1b137b9c33eab07351e984a5ed62d28f7f0e5684335bf77dc78521f802161cbd443f7fcd43291ef1ff78ba3eb2cc45416854f200c99611415900c451e01ab65231ed046bd6a7537baa907047595e1852332b902d66f744592c579199cfa407be2d7f9492a6f7cdbcfbbacb046583f57e48072794d78c667a6be2bd5d322424a19f812d69334c0cd8750d6cf5c16e777401ea4dba759e00f8d5b3b4b633fcaa78f33650354a5f969660a0b9b4520a0f850bf86ee06a107ecd12eeea7860b4e6ca6b43aa42add0c94f952643ddf252379a19f3916a34244b6ad3d7eed5a25e8bd96430bfd59f514aadc1456987e444f6f824d11308584f2670ec673b830e4e26b3ac90bcdf18a8ec5323a644f174f647317e50e98203a4e8f4961995af1f8a74281a4862b1ff5a37d43878d314df6195a5d9ddc49a9ef910a04309b9b5329ecdc5a3b8c11f473083cc5a43306f986a1380351e2688530b2d81aec6192e4369eb6a0732e2e7c6298a028c9f5aaa099b45334e4c2f656255baeeca026ac4b7a7f84e9ddc69e9b7e55a06fd0a77e591aa21197dad7db34713979f146e64eeeb75f0f94eb9a869e8e7ca682ac0be450151dab0313fa9c8838a8adc4fb1b316269b01da1255c8338df7fe484c9cf0c4fe1e1abcf5c22e242d522f2e289688feeaef3890b9a8a4c7cb21d563da264b31ef41e21f4581691bb5aa2e3d0c4c31c0fd9659fbde166e0e35e58236da0cfb53dde1ef7a1335f86821262f53c47411938d02c6b886e6bf52f41d642079767aee32820612eefaeacf0356f67bff5cb6b3e86a65540680bb9eaf5d3783dfac49c087de7b19896343f58694d36cfee694981984c971c3930815c2ff0d15cd42e34cfa49d8cd9dab2f270229021f379dd6f8ab162832066526a00670d4c4f76ba3819a260f437c963332ab47b95c7d1f94aa1a16d6b3bc367753304c9db0f32494f0a6b23cb94cae8a8d64146c17f8d4cd83d7e66307eac22e8080023352e39d94bad40df3e7e04274a768d20b4b569747802f4d9988068ebf5719bc863194e3c7b2cf5c5686cb61d0ccc107dc6a75b518a474ddba4428cc24b1db2d5aac9d5654c07b6aca547c2af2846a5f4b15ccce5004c8dfc2d58c3fcd609880431bbbd814cb598e33c2d11267ceee19380509687e54fc81800fcd2285ff622c20cb6a79fa3d9823bf5efe9f62a091c69ae9dbd0f6f8f48a150ff39082e772d2b4d9efaae751917f00c55c40843f1b27e8075871ce2fbdd8b4621281a85a4dce0a6e96c042eed4f9743cbdcaa18f77ed1803afd61a2851bbf2e3e0d9ee3de397a85c5843fb9cb15faaef55183d26c139e7b5c279a736bef9cd56bd4c3338fa49a8845fd904a12562bed71f06eb0b47d20ddfb0c616cda8adf0d9d388cff12319165c768346537f47c3116b0d23b176cb6c18712b6e5a288eaacb2539a5164c878a38e6ae314b3e851cd595b6cf75c600f2b6033a7de533a442291fe3a37fdc1770ed8795b5a33f398e5777faa2a2ff495648054ab11941c2dd3439391193f9579f735499ae101eb1e3b0d2bb23a1824665af878ec62bd75008c72f3f0f0fd8098b8aa05e5058cbadccfd37a7515d86e9bf0f4fb8e9d664c25cffd010e8ede68f3d04df86e135853176253b1ddbaf742c26b5c12a2caf7d2a199736389acf0e551ae05c3533aa8a028cb2c4e73f23f1464404f449e9c1d0bce3fb746240be3acac812eae5ebb0e3191552a3c6dfc449cd6e8fe8cd60126b04b3e72b63ba5a12db4c0c093c9ce9c3a9da263ba8f2efa0cac3036ae2fc3c1905efd681edfd1890c0893ea519aedc62ebd1028fdfa4304fa43689288889c53248ae0f90d86cfb8f190a37ffa53206c0eec1795ffca18f8c300b790a0512083c9f5ee1533c01a69540629ffa4ace3c6381d56108eef6764fc63c5e3a3cac14ee0b2373428507f1ab49d5a831ca8fce97c5b4dd39476882b13ff947914e7a80e9bdc73f330de88b5315643103671ef3d4edb1147244771d8483a794a58d7ca12f07931144a587b757ba9ad00b39a348e4c6d0925110b5111d0fa36299ffc855469b698d370078b16bf2676a70a12666b2e468d2bdc1e39af0ad0f91f30d3f16bfe25b38c5535d8c923974174f7be37820db7bd4ddf0a0ef80978d9808799d7243e9bd37f6df7537b060d4503316aef2aa0db397246606c184017b82ce33ef7d1760de9e3986a4d198805df46d2f48b2d8043ad44ddf1b9fdc5734545f1cd16b4fe49b87910dff98958a005de18cb005c44cbd776fc228448d69a5d4c7984c6a613384557b58b2b74c7d1c32d81ade3dd1dffcdae6947b711159c4dcf5244cfa2119134fe57bded6b049df6f077f26e3e824ea0051de291d52785be38cebc0c3a8109d863ec1ca9c14bdb39a41f459262552f9329fa3b1a9757c923c357665aa74426e932331e1033bec367432228b592622245fbe666ceb4e2a1f8f1b115047a07f8fc2ee9bac6f2f3952b69c95b8798714e883d9c4907f2c290c3bc4663d1ae9cb6eb30fdc263b76ecf944ffd257788e5c55c432053ae3aec0a6c57b55eac4847aab38d29c15c7978ecdeca78f7bacfc5306d18aa5c5e3d3fb76e99abfe30e98b7be423ad872aa08da6fada3396852a483d35fe7a62bd09b83307f07e2b6eecd76b85173b1a39edcc7068635ba2f6822a23915e2f3e4fd78132b9d1481556ec49733e22ab5f2834e2289cafba4b04e82179af9cefa5f68e2b882b413285c81b2f0376716ef6428020413025c69749e77efbbc5a3a668a66ae27d990b1648628cc615726098867a14ef38cea84dd9e3d7997f75eb1e3c39622c498feda8b09623715c1d3810bd72cf84a9ad36ca0428bea008afd739a5660b091dc1931b7c01aa5c923e6ee0347b124754b2cdea479da9bff731a5fd6a7b6619bd73158ee52736bcc888c5472948477e54b30f9d54e1705fb9dafc36a3935cc80738b6698a9788e64107be5f90678c77f1eb86f7b6bbf89e4e1c0e67c8f8915823cfe79dec60e0c365877222cbe544fec5ac04ab80ceb120f32f25519bce90e6be4267c0a2970b1adff2a3fcf953e138aaf60c998d32f6dff8c8f79a32aea711c69766c78e924c15b6a7d9e5527f6e94af72508f257236670990053b9c1ba5c5c8f28f6642ee1b4e6322201c3cc74049ec411b0ab09e9ee04f680023ffd246902f9f73ba1a300ddbd7722beaffb355cdccbfd3b470d5b4fbb7f9a8dcda8525c1bcadf127e4a1cdffcb63d53b549ebb67b408d93da5b29be8ea65d01aa7927315a2ee7232342bc16f9c203e613e96032329307a4c4d792deb403ad5fd88488d1a0df1741fa076e6d76c9f1f1fda188fff1c42813499d78ac8ad9b69b3cc2e609470fd90710acf18ae708b58ea9b639da6be8a80f26f822e9d2617b716cf2b4ee99633269fdc4de1cc263f8467ba83708ea39326bdae2b5dfa7d4b062716c359c0ca599ed09dc2cdb170429b4ca2368c16af0987995a73143c3fd330b6def2170ed3e8979d40f38b4529cfeaab9d5ebecf0c9e9afb8c9cc137b1cd70b70219bc9b9ef3e0d89781a50b465a2f1aa5e3cabc91bae8c426b9622659dd41d14a25a0606a5e3421078d8a976f23a14282751645a494851b53e61f2847340f67fd49bc86ef84374a6fe0f12dc689d7c7adb96a6d29c1c5484d1db833e90b3ddb557487e05f99871c9f9d49f5919f72d98dcfdbd3a8b0d64726bb15b61b6e1c1c1e66c8f2eaf027a6457ce4342745129d32a35d242a1245dc05020218aa7c03627bd9ac9cbc2b077bbfb982a5ccf5a99dcb168457e28e02f719b5a657b5f890ca11ec6db25520f0a8f373354401d455a9e5021d09fa46b717a299f4e1feb288b227a46e90f7aa092d02a4158e9ec69d5391bf5078b50767911585309940329b48a3ddae123825ebcd4d1800997ccbce6fbe5b273d8cda28095e6bb3212ff2c24471e294ada0e24c85965385daba6fa7493329b9e5dec182c445afb9f4d73c88a628b2a66103a95ece901b388db945d0fcee096b06055deb2c2a7525f767077b4fde5de14db770be73882475207aa1835fc6ac2ab4d52d5ca39eab1f73db7edabba4425e9318c29d92bac4563df324be9cce8b99015738c476c18471b407fc465f735850527601b723d634dc0f186e31119bc319e2e76d234a60b7b7584b4ff6161141c53476dfeee7e7aec779f239fd64df80074715be8c974a6c52e0030da2083c7b2ca5b51d7d6b5e133de2a196b6e93f88eb45bc168e2c9c63e287fae13afd42ef4ce64e301b91f184b258b07853b5763dfcc4531c0122bc07a13122335fea4e85dac73f62e6ce863c2d3bb0ac5bc8d2cdd9797c3bfc0b6c96f3ca59a15ac725327d968dde49b0e8cd2c7953bda80ddcaa14a4f772d6873914a684bd343f0c245669d248bf83422f05e5e33b584146a70876920fd2b00786b933a4179588f8a8b26d384f6da7759fb28713678fe458b7fbb5914f371faef2fd735197f09488322016d4998bbf724ec125025f79925c81d871045b587e7950f5f78798fa70a1a52aa3f6e43d7d89a3dd398fd25c5de665a0f80c097f84a06929535cca4c864498b664f4c0ebddac9fd1ee411cac4eb233a211f7497cbfd433bb25298c1e425723582890c559f20e48b7161ed1a35a6b378057c59ed4c7067f244ec4e77c0c3b66511adc5975f74a6b016edeed31d20e5f4db1d28f8fa8a4f09dcc1bf7d8422c284c3851afe9dc6b665dd4444623491b30c9f234965792a22f4f46df523c86ee0987ea5d659261d12cfdcdb98a5c33b2b6bcb1f0dc600062b802a84484febbe65ca1e5f7a2d2691301924316669f75932b98317d5f83f1199a7f4164760d346a1d03f8035db50913c207e228bddb852a747bcd73a1b06f8d53e93e78326e8dee93feee014e3df6d3c651b06f97018155644d0b3cd69039996b486141498a22d1fc375fa70196444d51beb807fe897bce2bfcb5d49d86f4b569c31c14667745d3ebc282594bfe1646a3376287af900350536cf8216e92c804726cb6e78522dcd27dfe3b93a8099ae1cd5dcba6831f4e6431d668a8f76ef74c627ab4f4cf355a96fd9b88732c03dbdfe132763f0b89631b69cde7a9e1f073030223ac05fafe6905c9fd445c78cc4097cd25df0c033526db7aa259b2b3f5c8d740ffbaa7eaf67ba876915f871187de03ecd887e3da833dc65ac8c59467239e6f44437415c099be46c3993bd8f92416f0117447e69ce0c0135590112e4036033bc7a19a33b0ac8e527f3f1d75dc4b52163e902d29854058e6eb5f0b2ddd9c83f6e3753945078bc01a321b7981cc659ffc197ee6e031901bd76a42c2717f56b3f9a97649cb375af7bbe252e794bc908eb09317e9a69d2e92dcb4fc95857f5409aa7a0437a9ec97b2d689faea08f370657e2373663e8fc9694bdf615e18077adadf6ba3692d5a016d072b303e8177f839364752676982c215221e469bd908f577648fad0538065f6cdd384d8e23f1cbed541bbe8ed53fe3552e2daf9e1ace1b1474b3e3b1591643cec59a909e569f495d80731f2ea14d2b0836442f5fb58cee4754266ede3c87ab1546e1774aee31dd718817f5bf93b27873192c710547cf40064b71f0f1fd0c7ddfa70cb8392cda3fca707aad999d911a3836aa2866e6e50bdf61db5f5ed327155c90e1c0ac667b046b89e157281956549b40b57381754baeb4ca06f37012fd7981d1dd015d919ba933b806f3c31e4daa0216baac5a423bcd508bc0a1c186f53fbbe4499e23e54f4a5f7ca8a25fe316217eddba2486f38a36aa13ae31b323dfe4cc3c5c4a0a7b0b5c72b7dbb6241a46e835eb6f29ef68ee18c9a740f01104f09090d0c29355ccda9d29121abbb810c37905a352a5beab5ece665431ba132a3a3f2f8274b749d1a813d22e71108698c012d907acc42a2672040ea2f00dc19c46dfdb5f9cabf0b290e05df840efc30786eb5da933fdc73e4a1781892d515e9f51a5489f819fccb9e1e2d848a81cc8f70cdd24395fcc7769adcf600ad993fbd27121d4b31527493d50df1f94ffeb6f24899a30eb280a09c16887ffe3876dd89381399011b7944d7efeaac725111e949d0434abe714abfdc214c49cc973adf11b6a5269352052dc59811ffb44b3a9560a09d3431347ca071b976e996585a14ddbbb8959110c7e74151101f06a6c93db2f4a25456a9484f5eb1936b659dcb8d0e70e2bda33e1acabd7e781f4315c48673bdb1a17af069f43220d52f0df22c5e4d77a484de42582fe09f3a908887a22a2f57ff2bfb563fc1fb654b70487d8b5c1cfd54d18782dfdf85834a9f2a554f24d23a2b7101a323474f44646f4cd5a90007352df0b49f924caa2ed7641bc2d0f7af4312d0e0b4acb6f16b60cca58813b8237306796fa97cceb8b107273eb58411457f15ae4ca93d86e5e9dd263cea109890bbc89cd14ef2354e2db23449969c81adbb110a5125f25e6bfe811c7a9d2180841a89c956ac46226c7cd529ac73257ec1d25a4b51beb43ae6db958519e8eda48cd972b65f2ffdf37068c29fd2450001e12f6f685620024c1b9f82bb396396bbda8b906b3afe5a1c5f553d6ec49caab3b1e5b3173c34e758fdad7d424f5d35e2c4e303dd585d43f2dcb956c554338ab5f0181fb72a357ccd64a25706c81fe62d8e4dd6ff08227ff9d91743bc5b30fa67b5f5a3a123b72aa3a85e18fa230aeb5a6652933f18eec92d73058407ceb2faca27a7f499881815de343a48be3ef1789a6dc5d571845aedd53686f7d28ce96f03139d51be82750f092a65cc1983d72868d0b63e4d3bd7fbc0374a3d325efdef4356a3648790c390f0f2b225e9b4ac9befe8d1e69d75deb9a361deab5dae066dccc71478882874832ed7ec08cdda7101fcae376c2067725913b3e25b39cbe4ece8d3b2a4f4300f0dacb3fd831821fc1cb0ec6bb3c9d17c56b2e704f3741b78d850efd238d7bc017e0f6a244cff9f75445d55b28924eba0a1b4697b6ec98df0526f3ef0b14ccd10ec106de88148e75b08843c3e0f86901e9c7532f2e8369e799fe2d13b23dafd58d5b8cc2082dd3fdff20d8bd04946ef8ccf69ee6643fc27d49b46470f168939f9917afa2ca2800878081e6ec1d15491f50873c377b66a81145890f6c68848ddc4366a3349ddb7dd7f8a9b612fe0337b3d2467e7393198c5bd5a4b4b8cd24044bb2d00f2950e9705f397228e5fa38377928d27d55e81edc8606e0b7283944ab11d054971e6cfc829b54824ec9d9dac5e99e81b24a2722236f5ae8739d4a25d7cc652d0898db05244f2c1b0f1b78581eff0540d13da6e6b9af32107a6ad8d7707416d4cf258a4dce59d729d8fef3710f3f3a927268faff7d00fde78bf4ad2bf1709513fc16f258eedef3ebbaebdab73c3a50dbe47cc708d886acd97492399531c7927dbc9975e42ef885115b9c66bb8afaa8c765ec354addde9405d3b8589108871df8dd0049920d49252e6b7cf2f7168533e608c11899c42bf8ba55fbc56ad235abaf0c3adc25d4feec5ea0aad16b0c36cd41066dd4bb52eba11bcaba697d152cb17480585755cf851251da30c1a449d95a593f61f64932ae213db78d776d70838bb63f04114c06e6764695b820c47a92e5ac15aa7098b080073d5b40a2a9220b64c3202869728b4e8c65d9b738f768c231c000a092fa5a70a6e2dfe2f6bef8a740c99adc7bf0acf660e3e960871b69594f488e1a2a75a13a09baffe07873542a3ffbc2b757ebb218780c85c2f33981d99a9072b76cda809e0cbd50b4a4ffcf4293dbaefee55d6f52bffe37c7b890ab9c9014e046d1a7b695f1b12901e53f5a775790a93b505b794cccb8ffd6234e88672ff966a795e3b64845314870fbd3a3d19652ca3d5068657b70305791b667e23a8c278c40ad024db38c658c558f495dfc2c9d182264417418a4040162d951e456c64085017feaafb160ba165710072412d2b2ff285470f1c565588968af8d77279f94537639419a141ae7152ed18ffb80a3303eca0506d1095d61b74781600f190c0a15e0143deb78e7b14e0e96dbd51622e9eef85f58aecc2a8f07cc210146c268f4667f46ee36baae364e7ae941e266d128e42ad5c0dbaf8b401a30c6893f7a4c1c1efc1192d13b813163ce12c39fe7dbde4ffcbc3d855b14b8fd011f2535391490b6b02296bf457a9c4420fcd3503fb600b8b54bcfec836dc777c7605ec6f7b88b1d3830da2d082e467736172f568253fa74ec9acbab444405694340b98c7bf5c57a7626691d08733740c6281b5f0f89e49dff5c707a6a9905a8db645d1a1000fdcabb50d20075ed3dd85e2c81e47f3c10c8e950bdfed6320ac2cf1e97e200cf4f8d56a1f7d220d493bcd60b11e961537594dd69623f25aa0adcc3bab96998ab6f260798f6443541ca1ddcffdc6d4c1dc59674bc28ce492f49961519a863d45a13e690222b2be712bb60052d3f9058d605a0b97b774e2d41db419cd21efd9a1e0625cd713d4f4f414ff0a35d2f8a9f9a59f5d80a538f98e8e634e352e574fe2b2f4780e85dbad45a3c584db9fb1d604470aef93f79a93a6ed91b533a2a7599c37c7152a9ddb4f8cb19dfcb7619056724066af7b9d6671dd3323e328dc7bd47279564135d593418554e95eeb6628900eb2a98e5d2e155f8aea3de8e556c42a5be2561dc84e4e795e84a44100cd8f84f2b0730e384d74657bccb639447d7ed5e06037ea2707c510cb44be0cdf0c6ea65730db97ac647bc2605cef322037ea364e471bee3b69f5c21a18329989bd7e9bb2f1331aab74676f4313ef658fd5224a5ac04aaba4f6fcc42722eacd41ea3c6579a9dcef326d052ecd45bec3c71d8e696936fd9148ba96491740bb2433af0af50d8b518c29e0006dc26755e9068133e8b8dc648961e9d9330e5f429bebd80366b04baaf7079c8cbcf86d088c5a6a86270b1d614b16d37b6ecc2d34b82e246886ce2b648df0544b64bc333783d6912dcab553298aeeea87812d0b0c92de7ed1b4baa6b5262f3343df1c69cc0b3336340db97de649847491e0b4117a18567f881d9dda8a2c21fa310be859bd7c3d20744dc586230202c2e6a05c2ae722859dce15c1f35b1239a6e33eecb10bdf3918ea8daf18983d75a4535ae72b02be8dd2d14c7184f36aad6fe8ff5b675222ce4dbe7997e6578f2bc201aaff10c404cbfadd2b1ef634d0ca9a387bc6ea62f8eab18018008e3c260fb0cbac68bf9babc2c1359a94d62fa6872c49991f2cf5627995988c1745fea6ceb298c4bf2a98d7474a461f503769a92be21c8bd27ca34eca6d2de20f9258424a5305d57b878e9d8608744adf977c5c2ce7e36b97c9df7323d82f27290e10c9978f12689487d625b287979cf694430993b70fd2f18d27a9ba3a0332142bd0fcee4241138d8b0912987a10fc29f1eef752607a19e6c02923ac2d0a459af3c88ed414cb824a7edc1523a2c18186175abe64d8c647346143a3e5d9a1d041f95350d4ba98363129604a816110ec34869845780a1260f340b084b8dbb424039c1a8fb54e60b87d7e57a129d03695dc2e4a1847b6fc03ea67118728babb595990007dc1bf0828fdbecdb9c79127c31dae6bcb0106ea53041fc9454339f828cb40ff0056cdf0814d81c05e984908dd35a6adf24dddda9fd9f29633b6c5a9ff3399fede3fb0629b3e7384bc4ea31a37ed6083fbefa6cee0c2c6da40b207d7f497bfd9be01f120fa124607b80035a018bc417f908b26c2678736e1cf4711146c43e07a7a8de9dad17cf69fce4cc30a7126a8b9e1ec7d6c9faf8c2167eeef2d95c07a8ae6bcfbdd7a8270dedc6418193f344e22a33874921b833f243f9df39c501bede925b04fd00ffecd3fc92c2b59f4d11983221608bdb19db569df8ce10ff5b5c253ee8f38d8ac0e6f41bbe730c9e24c0f170f8e4efcc05433245537fe240dc4f42fe17685e422af7299d208e46eeec7bbcadc86aab82f4bfec73ce5812635c7ccc41b1168cef652b9241af3cf7eabe6c01b052b71d5eee2b78a6485fb04c44f09c9411cfa33902662803b1a4ae50198493e9e17c0904ab98b7faf72892c8f4948daaff7bd17236c47485e9c1045253779cfdb286baf6b162fb39c166e23141e118389564fd78cbad1c41acc0aaab818c9215f48903848fcd8dfc1bd3baf56b95f618544b09367ab16364b1c59d7bd4aca366f471d45607ea299619b4876128a88cf0bb8e85d8ef11936c2763c1aa28d77908493228b98ca222721285282a7ba395219d7e64ca2a0ef26298b8fd9c74fd0c6da091770e217506f55f5c52988119e0c0195ce158d4b78e5dc0992836938b949a9d3edeacb550585046db40e25fbb898850b3bea6bb82412515507184d0d33fddcce57d0eb78f648a9171a64067ad91fdc0ec3f23dd28a1651a9e5a353ad9df5cf975f6f13d328371abf3c8cffcbc57e39f43fb66006897b9aea4c5f9286014a6aaf6c660d8eaf83da3ebc0b7ca1e3925effaf4224f7e1c144cb27870b349d8de28d0f7575d742d694da4b8f467897d15224feed359fe35f0b9a86ccbd83122f7c3eadbea776c60a431d9fab3935732733157e938506232c37a206baaf7e00f0df94484600586f68b8cec741ea0436f870973cccd252e6a4e1bc8503ab401d9b7218d554a77005be6efcff13ded38cb52289a3af3c80542d83469f9523bff4ab0509a3d11ac901ac4dd6f25f02b1b0abe35b8993cf91935610fd711facefb55f2745b20cc53c12ef45df202e0c52227cc7d75efbae679472a720288dcd381d7b258b8969abd38f66d8c01886fa84bb20b87edaef12bad020860b3b76ba2458c7070835bb8a59fdafa27c641593376b3f8f203734293d40b97c9330304cf5fe87a2c39b445e4c35d1c5844d63c0444a84c51873bc283150a40eb405c640382b7efd54aeae81e06f85a649dff6ba047d06797fc1d283dfcf6b12aae9bd7bc3d1d932c4216c06b18f2b67d23af32918588360b5533ff2d0eb194ebe45fc8ec1d1d9d4c235a2364da6bfc93dd0109fae131c6e34f22e7d21cd4d396afd189fef6fc2440ece82491bf1b1bc672cb93176645e227955c4dcc6b6b45e2006528a68cc0bf8db04c9a3f5a2907cd47b0cd1051a2d8fd54ff606163bd14f97c9e07a4ac94bae2f8eb1e6a12335ae338f3ef1edfa6ca51c492993c1de886e2b39bf72bf0a598c1ec1d43d65f4e3a893b907bbc857b007ea30402e1ecff60a1ec1140df7409ec52bb3b0fb0f8d0d0ef867cf52af180f4e8dfaf25a744f40328e0e9bbe2e5f820cbcd5356accc253b0d26d3cdd714ed1e126cb7ea277f6323825fc2ed6ca300a72007b1391ed49b1670a7ba48732fc83ddcb17fe5a0d52eb2eb50676f5d67f103d01bf614bf3f23bacb0e022ac2a5d8347834491e993114a93a061d9439fedf21597446ea3311a08e99ec1e6d5ddddce14e3098a40b90ad47414effefc6917c95d66864bcae08a385f6040001a08c633a2a07533b183b1b98c81db2ebbe704bcd0ae3577516460f5d75526d2af4cec20cb83e1ef5293aa5ed70209d03d20560d1004835c2d9dee6c14a9bbbc13f03ef76a87a2d1d0a1ab7761eb14d411edd65d1153f0b2b72417b1f441097f9b97be48a38ebed15880bc9fb7258e0482c19645cebb6df34422fc87b5975a49351125f0165527e2f1a3807d73bb0a90230e1f2bc4f2719125c9f6c1a18d7b8a2559d7f47d07400ed9d568496cd8aebd97d14012d8003b8667567bd09ca601e7aa520e40e9ff372976b4d5d5aba95d25dfc5b04c43637534cc0622f0f72c492ffeae8453b4d012a035e09292d6bd5d147d0f2050e36b9d476945704c29f1032d344103755127e72ce3ec91b2da6d4a0d78531c2ae1becb40038b4a9fee76d51e1d08beb6286c3b19c8d3326d6920fba8eb57e08794d97def1cb74b1f2e1c50940a566f00f3625ea8b9cd906c9c25b850830055b52212c00dbdb61ac59bf5db9fe019bec0d547398968b9141ef2062a8ca921444407f562ecb79aa20197c3aa5bc56f7d43de4be568bca17c4a401dae4048f7cbe9a78b6e6c752b3faf36bbb5c43d8fac85daba9cb535543eb54df5a50a8a87fd02819d8d9d191d28f233f2a59c81c0691173bd1eec470fab84d79b16f5fa65215edd0546864e674c782b34c7a9d2545689336318553aa8ee6407218d3dd799fb80853d32b278ceb187b8df4041664892422c191899fe85548bcdaab382b94781b4e5501d8225b949ef68273b12a9244926bbb7a08bb05bb4c36b727c1acddccf0812f2033fe8f4fc962afc02ca3168875d9a4f71c219efb1f08490ab63f700a2fcdcdeadaa295eb878e965b562f214dd4bac4ab6360053350154caffb1a197288f0b180fad672b5d0a1206cc74010a52394296b883029f0193e7525d04b7f824f473b3972dd00d5da7ae5fe290c23293c364fb7b1d860c5f10a417e5cbb212a2a3c58e7371bc9468914c9214f510b7e9997dad0313631071c812cdbe32613698518cba2965ceca4c18972f8cc852cb34c6bc1d1d7fdbfe89e2db16bd86849a93adb75d1a77d1db73f2099bf33a9dde9fd9a0e641fce8da98152de57b25e8c4937b43c98193e3e0258f4a1dad2c915e6d0887406ef7b6777d6748767cb7f60bbdb370630d8e9ec4d07d83a7c0696d62b111fd7f05d5334da8d087655da14264cd3144e1f9cd1e6ac2023052c516a39f0ad61b6c3b8b2292623a42b9c2176d9c5b837b038c05c0fb20004bab18650e95269ec7f398c7235d1cff574d2ad42ab7265f2667f86d14327247d879bdb17a8b3e7a124c9bf4e0e8ab94fb6b56e66612512e4c8845f9e0067dff0cd2ac78bea071a8326b41f5a3035a2fa903f34634405423f235772d36214baeaf7a95379c8325779143cff54ad1df9985312be96a7bf0be9efb71394c218ae09c42580d9ff816db9b93717f30e8da64b957fc59ad4dd96b3b5312b7272bc578884cb21c1baae2075b739fbc2e0d29d91651f7498632543402e04e7c610fcdd20cc68386a02530196fc3fc98b5aea489b6015e18f74dfe7e4bed4537aa65e05b5b5d4aa4d2cab25af675d23f2b69caefb5b636307ac1a14550576d53bfe0be91b769be00829cb804477ffe7a83c1050162f5d20798730ef6edb35d2ce38a15852598f9fd0fcb8dae8215accf8553d2fdc16dfc35cfa0e02f9e9e3236bc932645de4e953828df19b1fada10c0af03ab636b40ce72a906ebb24ab250bdeb8efc120448598fb51ab6f30c1938a84895d9bae23b78b61d64ab26a9f2ad2502f10be977535c86e01e6f65e82d4c62db5cd83e486f7ba1295c8e1dcc9e0f9b2d4b6dc6013fc33a1f842043252566916c8f2ea92cec0757536da51505d415a515009c7dedbbf0c081ca9466667b45335b8929eeecfa377fbedad5479b5fd7ec15e49659bfb2aba111103d80e94f9fce00e59bb20dde841d346656f0f4b14d0aa333435cb645a6caaeeb31f87765cc37bc328a05e6884318fcf853a95c9cbbb38c7d024709f91fcd3695e71b39a5d8b49b2a37dfc61c00d57f704cec6958cb787d5fddabed8522750967fc60bffa430111114f34f5f979ef0f7cc958fbcc2821b89b6612bf375dc1dafa5fe9978aa33e031de0d93288aeca39b7b0b77671834bd43cd5ec910713f30997b0da7313319154bd6c9fb5ab24ce234013d698e313438cac12c5de1fd3e4bd1c28b31b5bf51518cdfb7ffc5a93fb24c2a4fe95023f3334d76a1309f8c258274a4b4158ab4ddc0a3c93a8013b7ce3f0acd1482d7ea354686718233f2acf71894ad31d6e1cdbbf5b8f77f672e4ba8ba7afc259f5610c90b0dadc1a9e7ad7ee04a0242a139b28a39a3468597ea6eb9294ad46994684aa98d5cf452c2810f8014374d799041e6196d45db334b2442cf70b751526277e35fa6440bfe02e4aa44ca4497cdfe310df136d46ced81331424fff9a8dd8fb794b4422c9ce5dfbcebd8e1c80f5b033bf76f87444379513066bea6497072f5a24d3d31318bc1cd31f7cd9465fca8f5948cd801e2c216d7dab62aba2d1041aade882e4a7f99cf71cb5d16553d5107a0e7dafa8e723b1c78bc3f114927e53467679cd0687e3e9b1d370adc6d082a1c5a15721bcc9ab3758a4acbe5dc9f733a9e371c7a9622f40307355bcf02367efd2b0c3ee5fd6302d9156da253366c90123bc0df54fd723385e939b8e5c685777129c92630b2f034035bc0999170a98d80b15de9c6711b1c5208422a3731e847fa872ab2850b3e72395c92a59d0fed85b2c4e3967d70229a6714bfd20d941b6704b5356ff957cb0a6d462526a45817d3d7fed5368bc9d1ba24a92523fbf470430c80a40b7591d642b08b868ddd592c087b9e746d0772baa16bbe21152d156441b04dccc3566fb881e076218e0ac3fbca86d743fdf98472fe60d004cdcf961e8f57a4dac628ccd5a2b260e6755e3fb746639cb35eddb8a78cb22a56340d97ca34245b494d8f4b831c53698777d25d108891a83c09c7f488744d0dfa238543e5d96ca0d23fd7d7ed03e05e71e1f6c7dd806cbb2f4e1728cc7191c67ab91e7819f834220cf27a628a0b537b1efe912be670cb4373e1d7ddea229b2e794662cc92b90dde69ff9863784476071c1dbeba321fc4e627f60a7da0135c226f0963d3903f1df9dac770ddbb71e0b8cb970c6babaff9a2e339d85b3599fe05bb889d83e3ab0d67aabcfddeb40681a65291c09279a4b0905e13fcf63324271ea04b8cbac314f5be2cd96c1f0c84fc3340e444b6765e1caf528a60362515b7208d2ea25c9015dddaf148aeb78897111bf1ef4106a4f1522bfa72c31bc68b61fdd19aee26fbc589350161ff59dbf9ed42540a566f90be932483c52e28c06db7d8016852e064c2c3749a3daa53837f2aecdc05c3720dc995f446e8f7c182961fb7627cd58ebfe685a3140bad9f5d535928054bd469c6f079e305b5256719741f46340a4045cd87f29ba78913554f9cfff5348e9ec9b5fff2bc670d37c93e00f1ca636d1eecc28de83b9220d772d7c8c0041a2e30a5b0d60fdc4107b99cf972a4e4f75751aba1067158a298ffe4bedbbaa93fb613cb7fa4531d01242e34ffa8b27e6f012d1438793c713affcb3106512689a7f2fafa957dd33e345f5fb58aa12cb7acfa2f1cf9131f8ee5a5e088d724c6ab3f21dd881e82672b6f87f6a230d204d055a1f29c56b26d4b07dd3bffcab9fbf4361bba2903ef1b006f1d2ac9d01368c9fbf51d0989247404f5da98e54e6e844f915ced473b6bcb32b99cb14f79b08f2cdb895f6fc79129fa99968edf2ef490b55dba2f574d87cfe9e06f4640b4f1ff6bbb15cf211a58b381c94f11c0860fd4ac2b2a9ae3add1e6b841f13ec35baaa9f3f579e855c2fdbbff44f95d3941a71f27b3ecf9d9978f7134e15d75546e57a28588c5b2d45ced1249cc2de53bbfdc6f27a49194f62ee8c39cf7bb95fb046980afc1df45a69ca65b0b80a98a3a44c47a537c521c9f8b0c0c760c9cb3e3d6a78391296a081b5a3f2c23f8ca5f5c0af074d97e53b8636b35aae57691ace4380835e1801fe8b9c5a376a524edae55183aec0c267922c6234d841ad661653e5311cfa432ba30111f5d4281c5528b61d43b15bede0271a033da13ecf03d1661578345ebde3fd8990d2dbbcbbd0b0a6bfb37083b4e23dc7b51ed330ea62536662f4946390b4b7c3964d8e18233d90bb1951994f33deef3dbb9443dd0271202b61ccd4390d120f551fae3bb8362616304ee3034142b496f9ee7bc9fdb1685ff9077dc5c684134692f78d2448c0a4ab2b8189427fc61ecc7c2503617b9db8ca7936e9968dd724d3eefaf4f00a7d00c17a7c95e0c545822ee2ce9d1e4e599b2098daf565ebfb97542caed22cd11f40f0bc22b7ac3336cd8b471dabc17f611bf92f8968b70a786d8fabf8ce4a90a39bc300c6526ad136cdcf3ff37d981fb76f8014cf85f623d8d2cce0f1804ac9187579520b0857b4d80f2e22be2e6b8a8587d34155d3f66ef8a1c0dbb5bb8c25ede0bb82c5ee97989dc1853555397cc71a331b8eb92557e097caef394796d492209875974dfc14c96f5aaee2841bf07e1859e993a4ad0bcd96d2300cceeac66115afdcfb92ba6f6677722635fba0fc4b2722c4929583e135f82f072453faf3b4a6322e6713d6f8dbe2de2c2de274727df0f234df2051df96b8c50c94c97efe0119e3decdb14765136380e46ee75ee05046526dd9b514c249ef1f3095868668286c90016d1368856de933af2e13ef4c76946bd05430cd16d2c055128e52cc71d81335bd6b48eea61ea25229e0d06077e65377ab6b6be06d83b2849f1f7125742be9fd98b5ce66a62bdf6728eebc528f9d20af08748403fc01f5bb2d50f60a0086e14f4cc8c81c91da7e968909f83b384b20fe97d47ca7d8482a4f0b1b5efb8e633817580e730f643d82e3be2862fc0203745a2fdf8e7c631cc865fd34471e939ffbf1e4a86f17201fa7f6934bbff7d77fa54b45ac1304f5d8501478d138c0873fcaa4feac0e451974e94d3c13e708ed04d11ca7ace2bacd0cf2b0c55b867c589b319c572cf6726c70e91804a0f17a10dea9644c2c04d64bff959409a17ddf343dffeea53dac37d0cf5f92c2977fe79e73b43ec42cbea43231a3ca6664e8293f719cbf6249501a1f1587a6f92449177741776236e512f095283783e3079f1db914389c3f4e3548c7c02c3a70e9130a6d43efd7e6f2c7ad1d1ad9b6f5346eb5a00b380720cb793bb458180c31fdb58a40ab8bc182c2a4e4d84137e235e846ecdf2ca9acee9ef724b1a61153348d39b4904aac1f828680c499500dbae9431a270fab186d1ae9f0edf743dbfae19108b9c24bf49aaa834e16ba6b28d4802e42c67fdf3b4dcd5f8f931fe14b05c6d4f4fc273947a9f56381213506e88f4abdf37b7c90fb61911de98ed412d02fffb32ee4c72a5f34045e0e8255dcf3e75d5ea01afb4299a058a78ea65150523787b3482c5a77646528c0fa11628c83784f128afc07c6d9467f198d0ff4158b46629eedf6a81ae3790c159fb4536613592ccc2db54c442362df0058d0d13913a4b6f3350ac3c05a0536fd18cb8927731329f157ace7b09e7944283166daaac99272bb4ce2b76db7711daea2830377c71b030296d3e79faed40ae7d45ee92b158205d6aa64c082ab99732e327410f3c4592db9d295976e185e1cd744e6c201bef1576281f22d11f2d254d331eeb771aecf38580546d9e30dfc03c77cf602a77d48ecfc5f3cc4d4564716faa82d7406b9b4295288761773185150a97450be5717b463e0ec3e9b74315fd7a4d25098b8b111d4e6816ff0cd5b1009537a76ae5d01a9012eea7bc91694e0b2c3f80bec2a4dcfc3a96ea34e3e95dd8341de63fe74221882d645988bc8d03e3a20c2b7bb131aa4f2c44b91cb12aa140a7679b4136cab167af5296fd41b5fe8939b43e7ced53731cb6b4d2a1eeb5132b072683fd5fbf0865290fbe4cd6060459b3cef923aa583f08ab95e65d4ade238e884bbd20ae9b7c7c4858a6219b60ed82461092122d2aa35c969b0c52cf2b2d6de3be34122c17c95a9912a2e3dc91a5fd14b5be962e669fa5836894cbde7bc02bd6acf1ff05123a370d32d75ed3b022fc34caa494afc4e4dcfca105f21ff5b6b1cd801e7912047b8527d8315f3ffef526e3e5747464cfac08259e392383ed1e1b999cdac3ff64ed82d48a24c257a9c77fbbe6c60d89a31a32b7906cb681417e20b55cf2d57ee63205b91218009be9ff14c348fad5e2d4ad924b32b8d4aeedae4b077e898359a70239db3fc8a593f94012227c3c3095c7637f38554ef30f2c2738ef4c31dc36805bb316b68ff2029757af915bb469acb0efd505ba7d7e8159d1ed53399d016f4940206aea90eb1733ad63ba90d24a58c3975eb1c63f9da1aefa56a35e5b96cf0145c0b0d529bcefc381bb8f43f6ff7e91deb1cd1963e368dd1af01c64b803add528caf815103e5c394c6a68dbc03c112bd0e7b8d45e9a80dfd7851cad841dba009b7832d007b9c36e52fb4f1946ede70fb5c6f03c62a580173cc5b3a5d27c70a83393d380362fa5608719421dfb54a95ec43c99b9e40afd7259e8e510311b386011c78a9c376e2dca0dd7e680df60179e6b9d8d4e5d22625eaa434046f25a0324c5c5f94cc5aed36b884465626104e88b594f53675740d4790a4bcf00ad9dc2ff9e680408d4391c3a31de6f8fd1ed89539b13d2f4d0918949766f5225d281036b85597f856ca7b370e2358e71fee13ab004e553b60d2a097249d631b40739238f909cb21bac43516c28053d3d368d52976c7552ecf477dfe90f1ee6d064619a952b273b2a468f0683ef79f88b65dda32b66c34998e97edb49d9443260d2ac6abe2cc01501d120d983499b77fcc901da44d50897640024f6719e56b334cb0b1f0de263a10e185e6847bf75b1f2e3eedbeed49a1e7ccfa85305ad2a29a0052e35cb20d8dbeb6c7718b0ef7c39d9d28afbbd21adcf298f22a2066fbb067cc821844b1833d1cf8a89576cd519e53d92e6626c7f5c4626893bb518d8c20f8da75c849d929298651992cf1d14bbbfec0c6fddee2aee615cfd94877bdcd7731e05f4824ac42d726777e4f44d75155351a4facbeb5ad2f18557285e965af15d9817dcac424f236af1705b5b49433f7ef74d168566e6d8fbecda2123d7a1b25e2a4f08a72bc4b1a78d61376f91e650c6ea223d284dc5443f5d855df384d538645d7b6b5c9adb6b3cf4f3ce4bd31b9f87d4d96b4902ecabbc7aa9a249e286a74353e3799b51e8a6cfcd599086f1b89bdb91c31fc6bf55615836c4c83713e97384e53f3f66d12075efa068323785d6f49480c059cbc98ae978a8f11a05a7f39ac17100a3ce997b6aaec0bca157eb08ed5329559023690b5893777c0e2d66badb0fc99b269e2666a3525ed9f21b737ec22dec3cdeafbe4264f18a41fbf2460eee02a1815707afac927e5ebc02f54cec9d911d1f69cba7d635743e5eac20c8c1b414d8150637cdce850d6d1ea5e1cf4ee0e0dd98ebb528d2160a05184f54445ed284f96ca4d6c8a97f640cbff3d3187c0a4d286436fdb8b2f351429e4ee30e829695e80d8eb399c1bcb01d28b530c2efcfada7d28dd571b5fefe91da268bfde3a7185207b630f4a6448111602f4fd70c30fc82d2b7144cce9c7a73b2fa2f6ca532ed05f334c61bec9521361c1405de04c50552fe6c0856a87bc0c17ea2514b873b2322bfe01d4a3d50bfb1b50913be2de3f161f899e16e21f71e31dc30e4d72876bd8ebc16ca44b1df527c0b6d39d5dc6bce7e72fab13e7489b2ab95f8110fc789f899c37282a9428f757fac3017e3979b86c0310e2482392fa0aaf8f59e59a6015e20f49878f0606ef56cc6c0cec4e37470cab624742b2f4a7f51d4b0ea4e6bfe45f1ae0111235e46763b632938427188cd9797809a2376d41ce3fa4a48a7345cc0d644eac5091387a35930d173c5c0e92d4495370115355c8d5aca6fb66a4e0ad202d500f037bf051fe05fbc268de307d5905909813a87c82b3d0834722a74759adbc0f9d2611a2a8f09b19c37692c363f24f0e38bc43f888faa31f219b7b8beb1b9892b533172631c4694634677d2d10da510cd3d725f9802435c6cc43748497fd8ce01bcfc3295a7da4144d67d1a0c0355849913813a516021915e766b13287c192d4ce883bf10fceb04a08cb2dae571799953655c4a73794a66b04773f729024bfebdb51b60706d34bf6437e61abd45f06999876cccb8e94269b7600c81ee3086bf447a0c0036b185fc6db77969efbdf1df131410411ddea02ab80c3a6e9617066d84f85717696efb57ac2d23a5c75d03a135ca1eb4460c35ab5836f3dea61cdea63c30ca4b63633033eaa012f66ae798574729db3765696d1d6f4b8dbb1ab14e1bb00bf10759f95819f6ee762e1cd025ec1bea45c55bce463980bf3be2f37c1c2c86055da6b88a2baf9b61998314a5ae3b9da684589e28619849f92f128c1b46ffcc9c56b1ee78bad16b1fd4387f4ea0d77e8ab09e98e10317307362adcf5e0d4214560b33eed21fbb0984998bdd6b666e5da20684977be1e445ba91f461d5ba41465d1a0a17bb06bb2f62fad01b65af73a068c5aa31141477b4aa3974f195f19eb7585f4a1d05e7b7df9aaf15edc49263eee9334c79d434fd522da3253d5014f2245133a58b6a5a33ee35c653d08573ee6b9a6e703115ab74eb2ccc21a40379674682abd8c73f1ad07049b480439808e82968608e283dcd312d126ae3020b0c5358fa5884025b61f8e07035ab14b938f02958ee36bfb7fc8067a48c92c7c02c6ee28abd941f338a85731d2ad0a9b269ef09277b1b18645b868b73a5dea519fd9c10d85e5685afed28cde4e07b3d57dfaf9443e4528bd5f0136926fa475d3953ee4e43ab6b55143577480ab973897c10b7fcea688dbd4e6633f3d84ccc5f2659d1c8e833a8f832191ba4fe053b4e504e06ffb7266308f0af4f1afe13cb7187bb878a8b117759d92d5d0c978b02ea50f3a2c6e3ed282dc4e466116a9b65a031760a5a9b6635bb2e92824d64243714fab1a0a348b0107528da091a310a849b1c73d097d14a3ba32a1c7b2b1df5ac89285be22bb6487fe13ce808a92409b99a4c55fc67a8a819082bc64c2f09f313b61afdf8491f2f144d2ae12371ec92b6057dab97a16e193fc286df6ec6968d62f9ba91febb7974c7d3608d00f266a3bd10c301d49222db2afad784d2ea9205717ddc5b4355f7dfec5b4e3eaa0bf38031631c53d77f67c2657b17235b653b9b563ceeb612ac99c7df409dce6370f003e1b84af3311fc52a917c8d690ba90eb6fdeeb816cf3cf51399366005441b1dc7647e440366bf8b0c7b7ffe33b5c7b550bb8b08539db95e5e32552bbb10ac795173f11ea17e4e973ffb84b176cadb8ecc718d0a32f5b711dde29373d4485295d5f12676d5689b06e3a5fceea15d1962d1af009bc83a21734a6f415804e74effa4fce5a714f5ca949a023cd75e65a4a13b2932c8dbe2a26a0fd2166ea8d57162dee8948b83d2e970b5b6937f10b1cb9da80ab52fdc818e879a53ce715aa0763c46e78dbd6939c57d7509bbd6bb9ea635fa354d204965176734dccbe3798e67741cdd4ce202d52a07af73cfa62e67f11979a7f25701947198a5d4bcbc27a15aede9f62b440b8bf61ffdac844af54693067ec0ad44ce2f080a7b8c374f49d5273406ccb7e8aaf4241a9120336a887e1222c490d45a5cf80d5e7385e2694b65250faa49e4af7948c4773b641e5b76aaeda731d3a6cc37766f4d5fbf8bd08e636a5ac53f3bf243e0476defc011c443a0ae4fcf9db3bb7286ac0dece5da9993e35a91b30e4f870be88cd2d9e3bca4c4043c4a649f05d3d88b3a4b6f9a1b4335ff2901678e50e91b72e1dd33e60a523db76d9c29d23ca29a9457c89d38d6274bd629da718848af98ad482ce36b2860776af7e8f2d5ffdc6498713b09ef2779951966bfe06fff72884ecad91134b6eb081127f4ed53c0b566df99636f66e2e2de3ad6f58d7ec5c439010520021295dc34004bb623289030607873e2c7e97b97175860ab121517b62a4d50d1f3430638fbc1cb5892466477b607a8917ce28b86024a326b4211d5aa1c92cca646ec2d61b9936f7f871b80cdfbe99b363917254858e63c9862d97b90e6eb2a7822068c7eae801992c545af29ac92d9d17225334e4977c256b3c575df78282b7d5899ae47fc08a1db34a93aae1d83e559791add203a098d939c3702b2747018b38f7f737196322a8c127f58a4d882928e9224e07193908d320d85bdf1724f003c0499c8c9ba197201d3199e0d22692c0e87efc471aabf089bc764e6b237c50ccd2b4a2b034b263f46227895b2ca5bc67552851b4bd658226b5485e15fa857bb69f9896ef83317c7afe98f8452ed509fa7668b9627a630f032eb6fac4d80bf07a45b90f301770d1243a28e8517ab5d404d29d0d773009d2273712ddb67aca91afaa69132a91ad92dccd91300ddb270e89a8c50d91115025270a46be40373283e62e353f1d85689101702f8e426705e8ed36ce67d8fd222017d386ea6eb3b6080ff57dabe970f235b6f70a7427f04ca1ecc38f625ed7703f53f45eb5a3dc7fca6a068206951ebb4bc8da9253008bca41b73313299246f7f29cb021f4867cd896aaccf86d85254f49b06c36554e9293ecb0af6d70ee1b987516391c667a66c1cdd2097e8ad068e0eed20d0330d2df4bfaa2de6313da79d17adb923a7ad4420a67de4f438e1d0bb7016cc48b2dc841f2dcbb01855276941e83dd4399ddec5d66ac1112181ccfbc376fadadb4a779f15afb57bafd3b5612d036882ba9b39383e87c550df080059356d963001e9c93273cc4298b60683e6b2035dfb357125fba6ede5ad957080f2bdca9771645d6d06df2189371fc62d3132213408ad1aacb2c34ee9c2fffed41597e6b8677431ce7b9d0049b098bace034e70231b55c186f94963e8edb2e65adf9e86f77f888e594dca8342332f93bf5af7d6aef6da323a3a3ba2c0c30361a4783c1dc790e4be86aa30f02bd022bc6b59330707cab5b393de08f23abde4eba8c984f4baf53a064edcc48e2bd7c64e212a5e0408906d0824dc505942f11f70aca9cd1d9be5aca9ff25b6645e586a45956407ad8b7e0b071905bfcdee5dc723158ea373f74b364390cf770f6dbced2030ff259cb151e38174ece9a3f3c7564527f179da0269f96f698f22b687b5e4d879f7165716bc4b9fa46e1e8bf68a0275678afa71d66beec6511fde705a86ae9b7820538d6ac44d5e3c64640a28e752c5aef32d555a62f7c9c3cfeeafa382620f33460e24e4ba554635952de73f91434ca10be6a0d7a1c9a3f79b55b8d415cd23c70ee415b0012ac6905256a6a80b3a8ef4a9867e98cc0c621ee53f4026e69c037db3fc6766e6b3ade6fbe8c6dfd428d4a624d500a20523a7e305e2a1153ebd5950e50bb686b45653a32cedaeb57c5a851176e82bb4730364cbbc13c6e1c6113bf1f6d17f4d0d3047fb730e77f15eb57f5f47a45ffdea3e67eac988b915c6f78af0c25090c0cfa6f49c7e4a61a0d5fb60c9a3c728d400e372086e9945fb4354533be73f918f488f1024cc8a8da2963a116bb54f986299b18ba9147f953e2460cce4704bca477ecbc6954dc10dbe22813694b2ccbcb5224b3ac686d3a7ea42dff2bcd6dd118e365fcfc2b03b9e74e7230ca91ff1b950c2c4fa0f6647e84d153af71446a03018185d04ea753dcf156f8e826bdb4bdde0e107d7a2f3210ecb25253522ad54119e2eca50cd218b8fb2a6ef86d1cb27c02a5b44096e291afb0be72bbb008563e49b54d99129adf89adecdb1dc3f2b92eba981cb83bef18bc8e26239ade9ff654e057a3c0a556cb3636b3aff0f91daae8f3c21830ffe5d9bd7f4a10c5c066160398bb547cb92a005a6edf8ce36298453fd2e5e98f4a1843647dbaffebd43411736a332cac21cc30fb9e092b442619bb74f22b65f05df3223e725c918ff805015e937acc5989eacb61f5e362b4bccb9ccfb56357bc68467b86bf673526f5429375b2ec4376865275863cb8f4e7d394052f19019c05e3df03374ec51da4c148219044f2d4d54deaf7a77fd7435e24b2bb07ce67833a53ebea35f3fc8b1f6f727c258eec74b53cfaa9439dab486d7be8443f050e650f8ee6a5f9140f35f20bc9e700247806ef864dfdef9f1d6bfc19dbccd2605081e8390f9ceb9b113236abdee2e1409a6957f9532b9013572c3b8dabdf49249b6aefc155f19bb6bdefde6386bb1594209c34d493c70e53ab3af921f06fd3f3bf55513ef0b5b7d377953fa3c95c5c2bf19f0f7f8fac3333b24e2a6671b538957cacb3ecde69322f27309a168f222e2d969690f3cd0b0f072b6703dc272c49120b44e8b83f42064b202036b2f1f50dc527ee9016200243f06f610febca18ebdb85e901ea5d709f61e8ecff3e2de9922c426c6529bccdfa269dbd940e798a2b32b1f2d4fe74da4f3694e5e1e3f7257d74535ce2d41e5dee9a0c4f477156c88146f36a99f8f6637102419f0a909c28ac54e2dd031c2aa405a003db8d8ec818d9ccd72a7150f6db2fe7b654bc34fc9e05234fdd8a94e696cc9c2b2a4b03bb5619114535bab1a7fbb6fda417ea7b7be7fccfe8a6362a054b5c0822458fa9fb92f6d125f574cc481d1611a3cadf3b6969a294698c9935861370b21cd1f8ff63dcd3847d258084ddea177727edbccb33c37db8f22078ec4ee215d16558ee03efc533c4d891839ea277a0b319f3e7b1895a9c57635bf94f2499631cdf649eb093b9907a35ea6e48c43bd597f92e1a250d4a471885292eb9604adb3696669d5eceb72f7d1e2dd5c5e2e31421df5afe6bf228efce960220ae93ad85204795dde028d93dee62cafe83d2a58f9c5fa54142e7de97bca0e77320710bb6716b8c593a1d2212094d1de9de1d053c058672921fcdbf7e7c609fef2ee64c95942b46888e5f569761e138fb74e96a0c1186832e5dbfe91869620877deae32e387d31745718986b7a68215e4fe42a730a589f759bb959eb678553c662afc0f3273825ca07262d9cbd370e7c2b92b9f6d262d36877ff8c8165628754800a71919e5dcb8fd8549f01664753ae43b09b8eee4e5de3681623298ff484ee1c3109a3a1a980005a91a257286571c527894df81409d9a270788a5054bb3c450d032b7e96e5701eb15936925440df223ec8317f46a264924849c473271dafd26942d1725f5129bc25a01e985b2b420124fdd6fdf6520385b4d098ff5fb0a5f955072cbf1ef2c11a77cab0968e027d966f89485d83d501a77bae94847d935d3c8c8710e047ae1635c00f97d8274eb050d370f13fcd28d9f383dd49091fd43fab5ee257f918b322af47458c580186310d5b4594256b2cd38a9c10033c00795152b7c73be5c35ef21330de443c836c373312ab512203e79e2b4ee4710283ca2fe01db46961516f5c4cf5839aa9faa85c67560b1a3fdee7e647724c311edbf4ede7ccd865d1fc0fc87c97a663459eecb027211778f603ae6f48ee3dfb2e4ebf010bb7e3e613ad67f2df5a86f65341d7ce7c41791ad77a27da3af213c15a82c82ea811b8244aa59c09ca5b04b4862d47b409c3fb15dfd8d9d425009e5e36235723d27863ecfa75080f879d3516179bf3cf62075926e66721d4870fbecf17059a13d1620ae18df35b1db19eaacacd7ed38e28bdf34afbd661aa8db809bb6244c32f3fc24e340c91998c361d0bb29fa8541249c532c71c5d62cd06c34e6c270fc820ab692e4664ec1ffc8973fab0eea5138156f51528f8e973bb08e8d935d5881fe9ac37bc50dbbd12190a850b5b3223de1df03612c5fbf6535ecc8652e7629decb164f9247e9787c5f51a521fd37ece05c74b0cf41aecf4aaf409efcac80a89e22e79afcd92edbe43ebde568c3fec2f5e447adc4e06dd5ed373c10e3c13ff221f17064a7acc493546ef64fc83cbc1ca9ce645c03ccb2aa195e1845bdff2c18a05c2bfb09165391da01f95ba3592cb9f5784bb813220da11cf1fd756f3eefc13fe9162a411abdda7e4e0f02fb910a6673f5759c231728111588413e408ed8f54d7583cba7160022246361c6dcd65e025c078f013c1cb584f4e7cde929a75c5cfdab58d7f09d51366f59d29b6a9e5f64e17a39caf27cba85eabd12fd04ea0778b5bc17ea601eb4ceb10c3b14b35134d3979044d5515d13895c947fc4cc5d0ac4f975d02c6fba88a7e16d43386b3dbce2525e9476d29f87d8b6c937e4ce31f427c4b1b1552dd1aaffe9de26cb9538e6dbd39aba28193cf201a475099bf4ef48215b097220d7ab5dd5bd6aa27a173ce90037a9d783ca0c723989bdd3de85dd19678988683bf619f333974b1933462182ed6030e72ecc5b495b8373a92b9e51ce513adc58dc0bc166288c4c45fbc0e01fe73b7ccfb65151ce734c5f997a08afe17126893ac5bfd9a916bea1bd645673672a2ad8d100945f6f45687b1afd8ee3b3d5c9af1455784085889d63eab018c58a063891d8f8e43a314774014278d5b1029cb67d5b5e4a133ffee36f27feea7e98daba2083307edf4cfbcc2313f4963918790d692bbfaa00954012d30f9105440afe22e22a8119c3a3a104b63095f501ac86a496b4f0b9d4b61d113353fb6602fd717ab4440867ee8d0a372d16e7eee510a40e382bed6c5421424e83a544e49a09f6f8b18f9bb39e2f3bb68d02e65afebae50e0eaffba66030468b938189ef597fdce5da1c15fede470a35ceb96d40c9f310a3a27e02d00f82513377d0a9c3628448a9a05b517342e35b2e6b1df89f00acf6836d949c42799cffa738814009a9291bed029dee846c211469341c9aa6ed8b0ef04a9ff72ee9483ddb6dcccc61192ee1e4034db9a1e2729711afbf4bd16d522c2a2f06b420d3cdef97bcd601d68f9834fa709d078ce76314e5405f46a23b65104856c1e7f62cffa45bca6fbde26cdea30962a595eb44374bde112086370646eb5d5ba87987d5329ab1dca0153db74b4d151ff7cd745d4b5ba3069c5ab10ed57e7ba9d6a8f3bea8ca4c617025a4387ea119860644ed42084bdc90a72f2539a72db2ea9d1f113f7a1103096bfe3256b15c8c1601d7063e4a398bb9d681121edc379a76b4401f1aaeb19a6ffa6bea3443200a4529d12273e74618dfbc1bf339ef212a84525cbaf3e0219ce18d17faa88c98b2a70cf0356eecadc4e62d8a48e9d3509a58277820897485d766b7429898ae0fb4f10b9e54d62dd2b024db38eb63ab3f00efe48324e606325da01ee3b716f96c215531fbb20aaac6a7f4791489663e1e676635cbf1cae32f7cbda19924bb2346619aa25106dea4e013417055d175c17f793e619c7656380c966abcd26a68451f5dec331b5e3184715ddbc6b17f53172ae5dda7e67530ef580978d7b31ae570342a1798cfefce629ac17c13ab00ab2b471f396af852759046ea066ca3745f9b4e563f5473180aa19225a7c0ab0fc4e2826ad9c5b4fb712cc784019f2ca63bdca3064d1da44e41a7f4c9370e6b342527f8a0ead69d5f993b159714fc8d923995dfe99d2514cfdbebbcb2ab68bf3421cff93e4da203bd0f22827bb615e5f6b5bf67782b1a7016f348d4914887277c803fc13673cc49a0f41ed365b69c162c6ca3e752f1f116d00f87ee7e226a3606dc7cc6a572c091f08222898a6966999d254efa9acad35cb7e41e3a14def9b28f301a4f47107dec4bbe70d7662a9c66347e17566fa0837a8ef521d3c42e46dc4a0fcd0f090307ec64e3e7a3b2792f48df92b2e6bc972b54d11901ec968dce4495a89ede3d7512bcd8832fd24611a49d78c9fa8fcda433a528e4e3a48f4580e2ad205c9ab0e589d7b88cbf22c472fd0a0eb8e5d0a7653f8d8b788966a096d5283ab8f7f855e47be75ca15b74cde2e3c81b31451caee2da0fa11a22446933a98031466de667a8714eda5008e226896b4b5de74e504fc1ebfb561d037446974078672e1125897d658499ac650c99bb981e73b7595dd262b8fa248dfd010dc7307dad0b1e7317607cc885fa27fce6a181a37b453d1bd72a10f7ed99ab7b2c920b8916f8de91ae611e4fdeaa57dfe510f9fb12ded1c57638b758e93e25ef6cd23bad0770a2b93f170fc1d0ea674bf26060c45295235e48f8b75bff010d541f9be10f21cc837bcb5ec7b3acb1cb9576bbc30b3d15c62d0850fe0f01e6c40b32fc2d79b21b0e2dc8fb449be1cd0fa60863feb875f954b6bbe7c831ff92b9be74bc1c7cda8fe864ee5f8f05c2aaf55147e9cb3fe79539f338aa9d5db4dc04eb84ec3638825571649dd51702752e55421d6d47fb299a4860aca307440d63f96e6f715c3a9869725779f01711e4ac0f53426aca3854507bb1a0b8ff5d2e72e5efc58b4e439793ded3879b69f2e526bb67c97ac38efd561171253031ad5a10f48c440c6a86882cba6c63e19b8991f7b6174efbf67e08adfbae18c435f8871bf5c7acdbffc6644f7a1b635369419726d40937cc22aa87d8903ca2f0cc85922d2c1900c61542752984b0cf59cfe3b830697bbbe455ce64633d334ebcf7840c64a69189d8e965eeab26ad3d1834427cf9c74be9967faab32f9cda3f7d98f1bdafc207c4d68d5bad05ceabae6525851ceb27ac4f25ba7433e274fda9666309a56b800af2cb12af1aa7e210fbf2e1f7ace468b2ea5826548de981c30c9e9e95ed34651c3bf7e75c7b5e0657fc562401bc92d548d58010f607c85a0ea5aee568f73ebc5070b3a8dfee847ed4fb24698d853f4cfab87a17e10be5fd63615a2c157e208f35f5cf0574e99978482e5db94c95d3667b43254eac6fd4e325b3182d2894e25ebdad95d519269f330ff0e68c6b3a245f0a4129a43bddc2e31070e043e376bec681b165f39ee43edac9eee6eaaa7473072c1836f497f3adeddc6865839b62f087a2e7bf70f98054a3550b82e241ea3a6e92d11af615b0bfa419fcd68f6de76803d7ef2faf9de42c04b10fe66e902eeb5ad7de1a71e82a6bbf3613c5024dd48fc3b0ce6cfa91e7660176c98143ca742916a6ce451509793b2654989fad22bc5e4856945ce9acd1f6e31ebc3e19d4d5f4eb135b51db9db89d5aa6dfcf91cbe720be9f42b8e562f2319faff125d23a4477cab404f605444cbfd06c40f3a2125ecab2a1946d657fac66ea939fc2441c74868323d6ec6c7540b36cc6ae53ed4b700ece5a28b4939a677606a23e66fcff080b828c7b896ad7ae1cfd24d47a3e76f2c65fa76c6414f5e8ea22ffd02f8b9a67ee81dfc23388e70f437856c3357998036d0898b75003e368fde5d7c58722bdd2ed80c5959f0d2b9f2d700fbe96ed154d59b692e80dd8f684043b23ee3a11ffaae3187a64efc111faf3f9a348f10ac0d7fb5333b814e1a4c8fddafb5549c48f1a5530ef6de09d80d026c7a813020719a98e9abc8c86079ca5347ba03690735bc10bc7bcb8a68eee93bf2b9b37feab103198dfb7acb0c3a6c7f3f537e1ffb8976ff23ad82f47b123b318b83acedf05e3ef0b2088c45cf987fb58746a3acd7086125814ad34ef06d415c0bf8f88cc49aad30b71ff5c25373a7f005e6aa6cb14fd0e9b0bf5f253aa44e7f09418e2e3c32c35611796712a00bd5f133fec45e5e1daef84eef35a2248718868f31afe1b1be149c6614de32e594dcf7fcf76a0e99d29191859f0e98e24f66d5c5dfd8ecbe42d66a07c7feb79b63cebdd3c9fefbdb2e194ac4b8b62561239b4db3072bedb607572ba1154dc88878d307d4849b2230f096707962dc5c194eb8f924d8008b7e10e297b5ec36ffdc3c4c2abc56e7c77db8286aa05c92ec8760d60246ee9336b3939ae6984593d58a71c47f463fe66867554cae756ae1d04cc17e814c9a35e14bcf9f941a617bdb97c0314812765d2013326d53cb88bfc6fb8953ba90fd04e2012c3e91fc1b2bb4837befb09d393c3c2b85bd3d9e27aaf18be13229f673bdf6bf3986672ea4ff9121044c7724f9aa447bcbd7e6807b82e45294d2f27228906fc4fa914c12977d2aeeabe48e5970ebaaea0d0b983c3b84a90ac646f84c5d784662c792ad264c4cbe4f1dfe0802eb86bb3ee334d7c5602a06833bbd0377ca5405ea1e7219bdb043e8029935283809f5b6d922583a41039e16a06c6d7b6d33ff77d521aaacef606e3193666449c6cb5e028fea62fafc49e0a8d0537c0bbcf93f797256bc2532a673efa799655d8bf372276811c2f382991f1224bf553ccac233286715f94e069676aa5f901a6506aa56fdedeacb77085e1ff882037e685143bb53ec52c117dd508c5df19bbc1a377040dc0d16a8d8e27cdcca03dcc7a3f35bf5591a9415747e5ed9fb702093581dab71d330db1383f5d65a952becbeee3a973b38cf490d679d691bc9379b8711adda2d1bdddde80b94a3caa3dcb7f70ea8a51ff313af72633e38132adcc31f62e58da21e4ae680b1d585b187adf0d551d40264bb9d7267de81240568861b777980d180cb3b9120cd70dc0556621fe01fa804687916c45c103bf4c2790244ebeb4434af7d3e786308acdac4c84b77befe794bb1503d546449b21a8b7e2ea9cb98b6129490126c20a38e8d7b0d27a46c54681ce6ab04b371abd247f60115b2f3ca00a25324879d76010ade645dc88fb26ff48fa806a1cdbef233618f234cdc6d37df01d5cdd198a948c36cd6284d14df61f1102f7711e40df759365afb1d22a202d789c99d66478ec663f14dd516c6dc595011de9e96880a1e74757536a7de5fba909c750a536ce75f193a9be6d8bfff6c5bb30aab749e773d5370569c53bc39ab6b4fcaacc0e67750f045e6acbc2a74ae7abf713a60dbf7d69c2d33b81078208c8ea352a90fe8a21c2051cbc2fec30cfd4a00d011e185c5e6e89649172e594f4e26d458edc6a17263aec848be325bee56c4f8d2cb9193e633f00d47dc449082255c805b4feaa614653d1279a8fe9cee5df1bde550d309591c10575e88b2c96599830bea93748a28e0a01a30b67dd85ae7594f1910b79306ec652fbb25242bde66b12c6b4435740702f9b0cf9494a42d0fa0ab49a62e55d9c7e0ab47f59ab7e7bc962dfa923a402d543391c406bc447bab9741633a46e69b9525788f56f69b9b84963dba3c6793656cc46152137e464ed6b0d9c4ab214e5d34fde963a1197d023476fc3331acccf4d2d1296af3022813744257f379a45d7c3f68bdc284cb3c70542d09da00d53be26de3f5ae37fb0539baa7359086dfe52e2b953279984fc8af34f9db655e2d6823fd4f22bc5ebe04e1416db2a73ac7a474018de914092d609d20047067f1ebb7ec54420b25b97dde28d6272c0121617536402403171bb107da02ed98c98a85f20619d13bb6732fd69b1855475fa55c0417d49361fd32141fd602785bb7c288486c7c21afb1638aaaf3acfa344d1610c1c95207a8e2711b7b40d50cdbc11a2f40e618e9c460c70bf852e2acaa2a5e2322098fdd30fd292e35f7eb3ee4e12f54860b10b81bb0e0b815b856986eb499d070193aff1eaa4feb7cd451b0655b36d57456fd4809ba024e07ccbd25cacc2ee09cd5925bf6acbdec90c9c1e3154c8f6ee3f7451edec2fa02ba81c688b4efd5ceb0a370daaa04577b906419db2be9c777b1c0e60fb8aef61724264711b5896514f8407034e47cefb6c19d40a7a49f0a3659c86ff2a67f5abf51dd30a83a044877d6a98df1084330e9f739ec7eeb0348deaee16871aebafae167c980dd366f3f619da2ede639604c11e5f72cf000332b92f55b70e6c49f63338c9c9a5b41c5ceafbde342288dfbf4d47333f83dc7bb36637ef5f2cd5d10631602199b073f400889b716054bd3818bb144cbcc370f8336dc1f5be94ba8eb86daecf000b4898c473f8c98393d847d8d0fe9e4843148bd451f3656a6811d9f4ff13c513ecd0fb637cf3bcdf26455957065eff618369b2ac9e722b26e2e264796ca1d76d13f93e085915ff8a88973243bae4f361dd4dba7787770b4c1476c7c5d2b7db52f2f76d1d4432d3e272b755dc3be30b02831720ee040f6a99fdaca25546fdf177be13b25b51286497b9caa236f1a615fe46afa5039107733c64ce1995941f8fcc712ea1be3cf06cc987e69c238774b2c052447995402048d2dab5af8f72b84359668d57a3584fdb4f963b9874a246a0630a79ea6e86050978a5fd208ebe4ca8fc2bf54d92e0a6315d9c8c529de51e6f06bbbe741e9a5706848190ace43b4d0cb113983e30fde06177de6dbcabb8eb1687978b1fbdfd408a597ae0710bb852c41c59e2d11939205ef01d0cd4c32263ffad3cffcb7532213b9da6356f4cc989a9c4e888f580b8ea1f63defa472e4ccd686bb6a7c2f4094572b5a37b007cde97ad5f3749e5d593b7f6e7e57d50822b4dd89c252b545291b208e67cafbf34c6a02f797f5fa26552258910faa1576e3f1b3a5f5bc3098421473576c31087a46e515c0c3967ee9e1576b10e2bb3bbaf6f2f64e7e0b78ae098e32148290cca65863fb51cf42d8160ae751935c72a2d9f0352bf20855edcf9350078c7ee6aa9b56c0aa68b35552a142055f3475e63ac691720b7fb8ab58a890df1acd0436d12d74ff4cd11cd0afd72d104fc1455d11a284a4525410696869a04fcbf0d7d2ac1a4991ea630d5b17222c7aac810840f77fac6917d72dd54cd77652c159fcefb758c07282a090566b95d8259c5d5fc124493c786dfb2808b09e86c01c26106374af28f2c35ac890aa453d0926134cfa9467b17bc17cc591470069a3d5b1e4885d9f3c11660ab9e36bc540eca976dfee2f0467e88449bb90146a4e695fb6e78da4dc78630926003abd742f34e4c6647c7ca66a9625e741d9b21f0763c43b27be558b80b92e1c8d514b60aa6c33c6a0fef064cc81ccabc798f9632c3428d4ca6f25fea0159480865328e536f6c86d731edf795f097a6c74b79bcc8de26fa8ed53736cc673d752dfcaed42040d78845de295f7b5270e1318636da73839ece0f3971c7799f47edd9fa7e46cf9d2d7e889e17f32d3f7baea4186bf4b2a641f8d4925d70c36d23fc425cc8167df1228315928b5577bc37837e243a207b40d47bb6a87d02770f40564e1e56d116adf98e4d40b1c7209354ce3879b9aadec9875c4230a7aa14ecfbb2a9b5fe1d9f53beae9a374544f30f4edd16b6dd5f8ca394dfa6bbb52462ed19db5ebf5fe18c4b2d004bf207a248b2d76ab525b6f0f0346397ef3487c1423fb8a0601cc6e01fa801aab64575533f3ebb733dd71eae3e7c0c79df6c722c6b2e4f8f68793773527d74eb3f03cafa68705fc3896a116a09237329511d0653c0eb4207741caf4d619bae31d01b50fa9021318cc9b440989bc15f7ab0d9c7bf6d43b24ca578c3ce001c321cac88cc95453e2fa87b878447f4902ed8f74c4cb46bc3f716af985975229a2812c8a6aed45888fae2d7f11adb1f93a1607d7854f81c7b337c4062e8a7b6dce9b33359fec56612f929697540296a19ae0d8cf6fe03bbe89ac94aa732f11f72b455514a9ffff6385d2bc8685e7f170c160352c6c94dc0866f0530f3b2ca431b1d039a52be80df552b116995b62fe8d1ab3f417f32efe43bde2563cbf758a05959dc4776086b900faf281993f927e1ede0c3fafad9b309824565995007b3478d66940b4120eeeac0908d3a6b62c4e25cc2774abddbc8c028952527b1015ba1650f59e4d6e9eb73dae8e8be5253fdebc391285070b09a5b8a964ef1861fc694bc0ade693de1b6071c3abe5f01f21d75f9b5aab3bda1cfb559a3239e594b7b21aa8776fa0df1f56caa5c138e3323ba24aff4cc206794abb6e6c7770489d0e4a33637eb0dc6a342b8810cb8c865282149a786a6db3a3b9ac55b95323ea3f9a81ad7668036b2b18c973666afb7a9053ffe0d09e6e6368ba0b91e72449da04f3f6e692a5f3756858fbc5a2ec63d4cc12b8361273335f65924f55e9aa02f39abb7d9315fc33463d5e39d74153d99c9fc45ed85c321eb4ec8891d1c0de7ae143418f7f602e6fc8290b413d707346aa5d38761a7aa3c9bfb965edd82024d50ee669539662c147f783e5615c2a66503b78b874a0e90aa2b8af9a167cf84676932ad5d6b13bdb5d94607fe9576eccb96fbad3e908a82ddb93432654dfc35d986edb3bbb511d15a289507d16be4967731d64fb7025731f5c2e704fea709fe89435f16a9f41150cb680553fcd0ccfa085c426a3833295ab3f4db4e3620bde78349bd550fbee7e95f251453ed3db02caf9c525dd93fcb96bf614ebedcc2b3bd10d001b9b0865b35b26a3d8b46e5a0843cd4f3043873838832500f460563daa92524de02231f998ab365670e5225b930160e933ee81b40fccc634fcd2b61beeedd2bead7d81c621e49b61b47a09cca738eeed52cda211adefac0a8df4bbabc10300d497e7d101c109b52ce17673f1edbca5d2b3c238b9af713adf915e838024ccd8f2717b79536145bace456bf68148fea6e95dd770301594603de8c7c880221e8fbc47b6c847ea5acc0feb1b5ae3228dc1d93ea34e8283225ea6ea7b5a271ef7a8c333c102655c1e009bc65adf0544bf43671fabf893e2caf24e98fc8d2d27621f856b0bf176afe437c2bd2631b5c5d221ce28ab464a0b6d33e4acda2940c9f899d235b9309fc227e9f7be91a76f455f3a9bbf21a0f9098f9678eb787370dc8e40648ee84980b7ad840b85810f9657d2efb0631b5339a00dc6cf08a5ba1d766029332f7141dbcc82f7fd2d738e37e7dd214465a2d22945013ed6766e34b9964c72b881f3573fd3b948514d4b55280018926b9c62cfe49438c3e6fa67477b95b8f7cd049276884b9e0be63cb52aeec3b0b6c9992eba48382811c993f52f23d016bc758376d43fe83fb317f8f3a8d5cf259ebc76027b3483754ebcf1c8f713c0623410b38d9c883e62183eb78e2fac2652ee7879fdffdb47f6b391fa8c24d6c0a3585e997c9649e2b2505ff1d7b48c48db1ad007f0d427c4182d5d75b4f0e9e1d6f5624d97fcda7fb773b344b63a35133d737c95f87a3a454fdf9cada6a39857db62b66f3bf5b450919aacfe6823ee77d295032141992aa33ebf3e374e4bf457864978aa9a2aa839b6f7be53937641d52866538b5403bcfbca614ac0865a8486134291af90c01ad5ec06c5a888d324bdebff182790d7f865a2cd578d73f1cde3d1db291ec6f85e85986632626ecd089512ffcc834d837ff945a1514d8d39bfd25b6c964c9b7892bf7d7ad387d49f61b58eab4098081d180cb0721d0a7479baa4dcdd1f0154eda4cd3d74546df88b78bc4b0f10d1fb21cd61dc768bbb205567b78c565564c0e2898e52102faed38aba851a5b3f270a96a5cce080b67e9fba23cce1a7a7f9edc4ca7116c446caec48adfba19b17656f29a3c7632bef960c07c18df56ee2a2a0890e46fe235df7f8192c767a65f90155cb2987934b493ea5cf59cc9b0680e1fccb1a5e305076f76c46c57055590b94906e615fb6ab77e1470afe3103a2257d8db1964a5a9ba93a87cfb8020bcae0797ec0471e2992f9f40acafb1212c27ec74d9de39d0463fe23bf127f0158cb54f6dd10697f1c7785a470e4005f75e64c192de0ef0a851356f7bea71de7d8f9ac6df8d4c719aa2a57069db03809be23e9ce322827a175bd557cdeeeff6ad1d76ee3fb1e041916eb52dacdb359f89af6e6c127e6c8ee872f6adcffd1d4b541688cfef5ef0b353b368bbed4e02d09444ebbcd8a76f211300d922c838b3c9da14b0c74217f55d54f229e19d0a63f1ce59dc615c6d7fa94ddc192f3162fc6602a08a7381631b65b190c52f65bf9400f531773227e45b96e65d587666da8fd8687d0158adacb43dd0ba393b577e742b274e5bfaf5a15a1cac06ed9c8966c4e867506e9a660b4a8e137dd6d95e6b3b61b2b45db66d25b84a52e7269eca7d1e9c7205405c467bd0aa7f99a5849971cdea5c98c2db73162d68bff9a57a0d20b326618a0e9c47954bdc6fb9a3b81183ca22b0706c48ea5c60c09818ff5e96f28354fca37fd7b45f9c688c99a660b26034a45d3de397373d1e600da36c030cf636a858c3b3e62ef61e7e19988e8c74dd1c9eabe18293d3b877d512df269e29b92d076d8c5045bc0f5ad7c805c16cd9cc61c76bf79813cdffa527cd9da55d2ff5f1429ba70f48c5cc29a725aeb398e1fd914ce493fb833edd2494b0b8ceafc994d8ffbca9d5ebbe23f5b0b43f52d4076519737fb9eaf5c4066f43e4bc656155632d82eeeaacb5ef11fbc0dc0dfa2354a84d3bb83f3d1fc1735c7e64bbaed29eafb74f6e846b6d03312313e7284ceedc209d2653a38393e0abe2d4c4b0d5b0baa7e00ce758239d5c6da40f714d491b4f09ff60bcefa8ad4a02774466be1e8d102e256863a9446f1db54cdd752de46e59769e52efe642bc1aae15e73e0d8bce04acd526cc99c7d1460af5bb4ced918bfa57c84615ce04c148a0ab2e93c7b2361c04688ef20fc53e0c9cf0e2dd875ecde24e5d49a0367cdfe177dcbc9568e356bc16fab4c908ccd82ad3340c96ac050031316e4b78ac64ad67bf55e22857d757104ba2daeaca24755eda26e7b149a9bbefa27c0043993c991ed9088c593a77ed653057eac9d6253c3cc50550cc5ff72b3cf8148a3cc1b6d66575583bd158f4ef18aee5f0a27967bdfade65ece1d33223b9a8f4b96e80a354041bb46bb3eaef57e296e4c5a246c61eacbd12b62d9fb5a7ee5035a41a4ca0f79545b94f660b9f65e0e9219ca29db5f6ae9f1f79a5e6cee5db7c4560c80a5dbe2a96571e022472fe6546abf6c2e71813624d1ec210f49e439897a4c48f14885e475e771f88076c2d1d51ba1e938f98bf2ede8cf0071b132a0ea522a778912b49aa12810ef55360e615cb98f060ab5074d73e3ac1bf809e2828ace74aa2a0cd9494cd4050151ca47d08c34c10aea5253ad8a83c6091254dc956cd8a53a34d0433b4df9b897fb6fd0b2f95dd65944a5645247be9dc93edd8bebdfd675f5bd8e61c642fedb1390567ebd19ba5b002680eef9b72988ffebc84606eb75cf2cb6c35c9bfc9b37b454013d7eb0ccc1fb51cb118069ffd04d78819f66b24c1b65a38262f6d2c2355d723d3ee5add20a49cc8e2040a866b56f32425cd0b17438370ca49bbaf314c9e780d1ec7641f75f3ad8fc2be2a369deff1578bce37f53b051b381fa9e0b24e34989e946880d9addc7aeaa7f9a4e107421eb196ffdcf5fca649bf553891c4545e5d97ee90f4d1c2a21bf56b57f9be373046a42241d8883f3dc48d331ad9e109a124f4b2c8760aec543818e59d49595d9f9bb4bb184737d29de074e98ae6b86b4705caeaeb5856ef4333ea575650a2c3a7dff9e9ffc39e76ea53c56a9e6787df571b92c6716f88941869b95403015d461fc00aead175a0b7607cbf042344c510ee3d5b8a7f049d72ec5c909a8aada76576f032737290c91e7b254d39079e5c841208402032ebccf0456f1dae6913dce91fd4df621583275087f7add099c4860e8e8475d2480d29afe624ddca62132f6b408466bde7370443d28813eb322b8af12eff00ffb622856829639ab7cba66912279e87bf7beec91e5792510fd1ce2dde911cddf21161c5f5676572fb5766d0113d25b1cc98ffe91b006734b9af9e963427f4798a8d22671e79e5ef2367017d489212800fe17ed4d9513e4b41070db39eb2de84461000f803e747e13b76320fd902d3d0fb132d46085d1a5307a5977c0c3af1a89130aaa9872ea03fc29865a846f4991fae2c170dc5b218cfe004d3a1b0c28c1dbabeb049d8831d935a3edfaec5805f67608f3f493d62f06b9aaf8a488ec52f2ac73bbc64966a0b0956360912cf175c7d5a00afec0d8db28a00170c4891d8f8f8def57c46ec94991c989ec3ee5a63005d22e6a22334d6ab0d71a423c9ba34baa92d75e72a7a6362a403368d8a2f67a592a8e36aff7e4897f0c35f409cccac9a71998845929de1e69b8e47aa551f002d8964270ba5ab7a9d8571a82189e3b1c16b8016198f42e25d35735bd88629e18fa59292ee76cc4effacc272bb504769ec7db07b65a7faad07b9c72ed7a79a6228d8372fe0dc21f33bb3e920c4c1bb1c874363d85f3f41e6ec8b7afb56097b51f2a0a48054fbb572a30cc54c0f439bec2f8efb9d0a21f7ba123c73f3cf1e1165b8ce03059a6e666bb74d0b77ea7b21fb3ef831058f74939c9b86aac8ece9c1611be5d6b99b1325f0375ca972764d8adcb6e6db3a2f0180b090465830e6c3b3ed8e3e148e58bcabd6e79b9dc973fbb439c82ffe8ddb028f1c4c0a5f841e2387a48d14d9c9e3e04ba22d6281c4bc628ea0fa21a66853ad50a6bce183f3444f7b4ae9f59afa4b4dfce6cf00546f63e2170caab0e21d9e518065edc35da1cd5815bfcc4c5706a76704814c30f924b180425a2eee931a5324dd56ca29a0c432936c7bafb69eb37720f860f48007efa0ea1c5209326300d1b04eb190814f3bf88f6240cc94e5a4ee2f2e31e144b061e9e72ae2064a1bf62b0bf7c08841e902670d7a7804274535bfd5b8a54de8044c341e071377da24b51d6fd143d911c06f172920a1fd1c549cc85a76405458bbf035668ff01f56a0482f191dec1693a028c26d7bac31029d70e444d1abf90bc9b798c1b4c7e749d912f85ec84e8868656972d0f876d21f26eff30d2dea074a082d2da2ea69c11fd9ec91612418045a6f05b105d61aa732d8a06c83ba6280b9e98da1d643cb9af8d13a0113d045f6537935bc22058ca1b4ac9234f2a104f177dd0cc14a3cf94f35a0e299aea8b470503f056f424f721987fdf72bd0abe1644896956c48f2215a4c7132b08a1d2160653f2537488eaebadb906e73f1ee1c1f35d90ed3a607a724476d1e13ce8998edc489a6f6b617c291447a0e5989fc7ef9cfaa0e325d202981c01dda05808015e01e6fd16f047d16f96859c0ed02966087393d745d6505f129bfe66a70cfff15ff23a8f8dc46f607d208e2a6d8416fca62d5f9a171cb46bfe3462152b445ecd5483f89c72094d2d9ae6c8858d6d9526049792005dae6b29d1968f1b23a7359613a03fdb8a416dc8c15aeec5361f7242b03290092718fdd4ec4a6e35ee6f9c9ebd2dcb1f1607d522012be42c6e1ba74a0f23fd90fb4a663597b21e3f1a842d45849acdba0f0694102c9452b50bcd3f5f596c194cc9214efc27ca85af242eb222f0cf2ca06f3552fe2cdd3df690c9fd90d194a82c081e735fde52b3ac6f134fe6a5ee0cb4997aba58ebd9b2e66a7935410fc98fff5a849790fc9ebca52ad600daf66ad645e2233029a16a2177c3415df8bc1b437f86f82fae6c6e67f6ad97891dcf800828b06d9b98c6bc6df8aa5ff2b7e7d3449a479ad4e63f3f7151e9b3d469c8feb55328495100c3a54255a6c767b019ae487be679e69e2ff81d14d53a6d53c2ca17993bb8420e76d840490d04c15d55cbb1e7f71214e6a0d5a108ee686e5ef4fedf2b8cdde4ec4f1a01e872e3bef81854ea23fe0648e9f62790f4e32eeb5cbc897edd7873ba85da5b5b8ee193686404c6cefbf6697fa3c45102fb15f7233bf91079efaad7b050d31ba5f3bf31fe934c3f4f8d6a75bc74a9cc9e18759c2c14edaeaf332c84bfba25191918780b366afadb5f967ea5fb9bffadff860519f27109123d1acdbf22d1f3911a06ee6a1ba384cf374edf730e7198c35759e2ac1f3878e6dedebd489812c12922d670c2ffc0fef1b94333b204e93cc8e7cb9c5150246867faa1d25fe4dbd1ac7ed4f543d06a77cc214f1d6c3d05af0831885c743778374cbc77b51e4940eac6856d536be244be070465e56ad8491337af64ec37e5bc86025c1ddd61f7956e4f2d29ed375d4e974f0def1cda223c7e780f8bb866dc4dd99e27774965193b724a2fd10a87dfdadaa6168e9bd500c8d8575b77a0dec6ddd173d82cd04bba2ba6db54a700640d0531007eaea116595fd24473986e2b94e7925d74d0f74ac2ec9fb962d6b24ceae4ecec936b3224f115b533c044297426bf55b9c5423aaa9dc8de2a7f3dba4fce33976da975d62e95f70fd8d6537358d3ccece23a1d076e4d3be39985a6cee8e7faab28109f14084b4391608adef214223dead939fa9329d0aaa41b4c43379f9f663ed679f071ae9f73dfa0b1baa151bd7e7d205c8725b4e872a6260688acfb979a8b8c10018412dbc086e9bac196e6626f21029a2843ffb72ef3fa8cb676520fd2aa8d5505a33f2efd2db5ff2bbd8585f81bd23d4a9768cae75b149aa18f269f61bbe7ce46f4c74b34f01f78f39e51b67154c2ec66750c5f0e6df476f67246fd6ed9aaf9416d635e0f2924dee6734faa34f4477b241abefc5ebb9bdf1389656ea75162b14cc9d831cc425214eb15d105717d4d7986b78984f1da683d40c68b42142ff5b180ea7fafffeb45512345e266030535575c3abc3c7029a6b0d0033a865c6b830d333ef569a650c4958dc6f0a333c91f1f9202b6108381b6787eec5d2ec236ff5cdb4b87ff2ed0feedc2459d95ee6ce5f6e366a45e67bb38ace3e3aa48e0dac2b673ef82c53c477e8d36c70dba10c838fdb17096f348c99c725c97da658bf095d270f063d67c808ce6f842242621d6089e95089a72a6018f80c851253c3522addb976c2fb4f49bc2e4de9e2fd0752469ac897712a4ac7d29fce9bab5de973a94d5da9bf727f007765e52848ae4bf7c4d494eff477b4b677e4269f96ee18c3a1f3094e31b5f859c608b5cb2184ad7d0bee6d4ce6fece4d7e3a1bb0e43895b1163612fb26330eccd5b5a84206f38bc2c58f2cb4c7db527899161adfcae20589ea8619a3b55ecc01c1b7700c57902caf4ad5d92146fa0cf973777ef9ee061a647d9c4ca7610c8b8d148dab8515d7256d282ca4eb99e2637cae660a814517f292db6ef9f65f941cfe60a9032073aa1b1117c71045affd929c7ba9949b9cb016028094cf38522d6e38c6274423dec1817fe3e8a0c1d169e5e57e2d8b42f1d32aed9a3c38fad8049e73c541865b06523a222d9808b0bc22ed9031d01cc6a84fbe033904ad9b43091098cc886aaa01aa32a9f9f56b8aa7a1b97b085fc9e3ea1cdb314c7f2bd4b9769b45c409311f8258cbaf72981ef165f4b3b3f792c9ffe47065a6d5f5d611b7d6674e609b23a83a4655368ed38055b6df359830d3ffb1894d132a730e20e1f572e910b43565252e518d4b30be32d6079ad90ed2004a553a81717c6ff27cdb7e26e3940095d51a3c26b5cd9917d0d548d3d0e5f09f150f70d34b4a4dad1a0d3da64acb80e412a3f787da4b6ddfe3e64e568d60c54809bb31270bea507ac95717e1799451e9fce12c09a3256e744ffadb52d111b140cd79b22b9385cc879a34d60f2f6a1756b36e187a57972d1177fac36893b07f45927980404db4b95342c8d95d2e4b90eaa94c81fb72ff4c1dae6fca833cdbd6f78f9ec2defa1bc8d0f4cf3f5e5bdc9c2d700dcb0e49edeec402b2707e2c27a67451234c9ad960ed3a9101d195d781b0b164c671b4d5443c01269d14c8a030f47b2b71b79b19dd5fedf6b0d812602eddae4ef793e83df4f29fe9c9cb6d15b9045746c1006ffd5a6c856bceb71d9da907f390f3f7ae1fb064e6bc7a1f1439cb60abb59f42d3dcbdc3c93d4a216355e37b2af9b52a5f52aef37c75492423b6cf6456fcb83ecf9e60d30a04719a931f4179df9c42da9719bad6e0193ae3a446a824bf3e530fb0352a37a344910c9f72bed4e6d0253d66d1c5990b361e7c0103f4496391d7e61e3e550a9217505ebfa4cd94206575453371cfe060b037ba8de049a2e7e8fd839692ed773a6a1e5c2b23d8bc65cc5018f6c1a8f3d576a8ff6873f59bce499b51295e7c84a07f6de75293557f1bf3a1b8eb3ff4cd1ca1aace8d52f5a68b0434a396fc15018113c3091a9bb6bff076cd63843b3c8ecd5cd572cb3fee362e35eaa68b98eb8ea3032dfdb9d4b278cdd9c343048d8121a32b9cb998047fc925907ae255cf5bf4b92f71f18b296739e217d9f7fb838654814a3b901879a514cb2d05fae22331ac7c2190923079d6f9f2fb2d0e9eb0b842eea52fd61203f9aa171b92c926e50b35a754c3ba93689651ca8f3d4225dd9ec14f70f30aaec9af7ad984d4b5b7a0d2399d43ed421425844cd5e51466927cd94c220165add410bc25f98a54e5b49db7e315b05155bb1d163b4605146465de3968769a30cb6b865083965cbd94e1b968f5159801f984d575c55cd5b885bb229ff19a7afef86e21beff61d932d862aa3caf46d52573dac084bd20a3b162843917402c08fa7c39ec02cc41b61ca1ae0c759aeb7e345cd4e3be69454ce3454bee8a2a5ff19639740f62c6ab149f7a76122739f335f14f011f8c426fe51d523dd4e07a4496e3692d448f442182797dc96cb3a650b4ae37afc54f51d8094c07dc7d152bda0eb3475565804bb6651f57a6fd36313b0074b8d79322acf34626387405521d1390ffa53441731b00e402e039af4c617af25616bd7cfd796bc84585347e02f0e80f5325f84e11b1525debec68b955b88a90e616ec48d56ce259403f4379147353c69181ec7754903594ded4b506052b225e229cca0708003bc157e93dbac4254485824afb8cf4594dd09664d973b13b08fb6d63c6507687f31f83a3140396b1a2b079531fef3e6a9e6bbf31cd610536fd16c2c038b39cc9d4c1b2457cae7f920d13f82fd1250dce31b89154c00f9c4d45251893077d0b0ca74c3b6dc0779638f8adc9b53da6f0e6d8f666aeea51594715568875d8dfd08d17f4ba15defd4816a7c364da62cf8c095b51103c3a9901a7dbe7791a05eabe5fded8c40b9544054a74ddd47cb23c342594196f4b5a478107e920538bfd309625f4110df5a38358f69c96b6b4d36339b6a0bf9f4c0fe18651edbf32fb1d830093b0986a87d622bd409ca280f40263ee628ddd5fcdd0a8388159c4e9e4833b563b61ca7db8c6a3497b519e84b2e1eb165cf7a310c980e6feff8c2d8d23cfcbff9acd3787212fbaaa6835423ed8d16a9c8621b967f100ed51fdf63f368d36848e8054ac6e4d02a3daf11e5777a11ae5d1bcab432eecbc03a7f2d30bfbcb7b357fb34bef7a666541bcd7c32c7d361a0b94051b534515e6f6a445b5d4eb508dde32ccc2143cb51328b710a1598797f8665cb00c1ec75a23552f7e65213af3c6f34e4ba809b653f0e87547e00f5ddb6be17430424a3dcb7cf4c51ecea36392886b2627ae11d37a708f937e00130643602483f6612f96721c51157e3bc365bbc8be5107088045dc24ca44c13b9d8afcfb5c78307e98f686e293d53fca86b6a128c3808d2785175c609f991f6c68febc97a24927d0e9d210af15eece9f960a3b2d1099fbf4f2a5e6f61b9911515195df4ea3d316743d4cf178c8d98259ef6aef5fdb3acccbc8ff147a0de080b6175f70df585066bc8d2a00a63c2768076641869ac89578fc2a6c52dd3067456b1d55779febb7feb140fb0118a35bee3111d9bb27cd52026c6a6d7b2d9702d1c02011acaf600e16695e43a7457eaeebd616d471e5a701251b92fc3ae15e0152258545ec59867482f39651769e366181137139c5f0e0f420bd2721affa740cbb07a47e01e653f2b2215c4191f2ed25d159092fe03e4a5fba7956798fefc874b44c8019e8c9cef04e9bcf9836981a6dd802a760270e010501cfa762583b855b67800b2fabdab9d0254fa2b1c3a0bfc90b219cf02e5f8be644bf3d739cb2887f6e3b5cecc078ce81490b564128cad7b0ab7167633eafdb3b57624de3a802f2563bf9bd5b175a74413504f44388d01c35adbbebc2feb65d86b80ad01d910b90ec9235d2a6a0fd54e7f00d42cd85f151cd4aa80bceedaea49522b206f69573babdfc9a9f23a3af99ebdca8eecdecc49e910a672f7a17d807f10d591f244e12495d4961aa1f012ab63052a5b7271b36deee68c43b79517137d3a377b0b29a64e77b56b424d03323338684a8340da136be58571d94dff3bbf5eddd9e20e9cb6d2b774af424dcccb65901b40c1673f77797121966a4610d75d78585ec580c21b27ef9e8c0065237922caf5b23b5e3c84040338b1bb90f6951bf40a96b6a2e6ee4a4be7764609019597b774303e4035a83cbd48508ab9619cc05d4fbc228a0dbe4ace075e8d9a05504be163718dcfdb8ce298170d0b52c18b9607ccd9097550e16fef81424f2c3205a80a39c0b47e339e9f6bf47ea0f6ca78f7d8aa2379ac117db62d0c0c80f5d98820eb78342c3fbce5e4432897e0f5f8c22e77d5130d16b4b049a860fb7d171db35dd0e218430e202b3a0a711eff2614db5a114018a2535ee3bfa7966d933c11d4f090f6f9e18fe2876f0a91ad44419a0430f2f848866b924a27cc5806b4d5f08a58db8ac780b104b5c8a8d13c6a7c8cecf4e9d4857d0a414c9913c516bdbb846fe1e636202a0ba9ef3fae19fa71197fbdd3afea8864150ab967d5064e8bfc2199b7e3a549804062dc11630cd85cb521fe7082ab67a9e295f1d0eadf992246130ea9b78fc6e958dc19e10c97b735fa4a145e1fa1b0a52370b55a8f904582356211c91aee6180b0f553daddc3f599eff8538191d18c8a6c1a7dd1d1dc99cb36778c4a1c7d09191375ddb634f248d4eae6b383b783b73bf36f8f715b0d29d9ce5aa2d3e56064fbfc3c9cb55fbd23ab3e80d31651e098ff42e0378fccd68974c97217d3a3f521e190338f1bf6074888d89c477f495dd790b450f494d5c1d9e298bc78b255480eebde8148190f74da4f93648a43b5985cfd2e19ae519cb92a0236934b39aa58ac688e20301e026137d2c81684435c6df5f19d4b7cf50001a6cc0b4d289ac7aa7159b44ebc4aeec0ec61d22d22a61e0e0d58624fc274c27110ed7f735ec8ff1b118be00a67f65ac040bfb5c4c9a7bd50c1d67b60ecab4ff193bdad0dcde181d90286261f283a4b5d6da493cbc617c43139756c5e2e2926f6f33435e20ea6f276e9214bd332f5c429c5dbd84bad8f9e31ca43a25d1d28a0598fb8b81a3c77cacdeb99e851e5962f6aa4930f6137eada88458b5c0f36e2c7583b7bd95b367b7b45fb323e047eaff0473f182d696c2ac9180d087c61a89b5bc8ea7e17cf876f608b82e3dbd7824e72ddb76c4335809dd1e325daacb9d65d81449ae007bf4440bd620a180dc2e5e9cd5373888ed5600917cfed693905f03965a773b0ebfafc9ed402445e7e4f13404848ff1cb1d1be971d87c18ccd89b2a17f266e45d1242b42271b4f050441c6765cda14d4d19c4819632b5b56d259bca15c4bbe38437910094d5a815e2c6af657afc3bdf30318856a34a6af9ce1d0e946d58b19b3643816100e8815953108962116b7d165dc1f9feb609427d1d0d37b3cfa2ecffdfff8bc07956807260c10262fa7950128af159cc0037a4283205d88c91575a6e04057b53f09e4ba125bbfbf4adf77a1df6b531821ab5f6fded441db43b21645a9422cd3b7459b0d9a761e62db95023294bcc6b50f857a126614abcbf794b4796d2cd2665fa105866455cc86bc1e7ada8e9b3b7bb28b4295a3043aa7a8aa8e436e183cb0c6f517a6e0c15738e4ff1aae66fa57070668ea27efdea46249524f4df3ce2553f0f84c9f5f2a0b791246ab4f6e212fd76cf6544088547d2d9d372788f6b40dd2502b9c8214f0ed2ca0eb14e2a401ee479dccfc02fda295603aab36addee6f0ec67ee2e7be2f71ab1a441696999503bf0486add98bac4b05d543842d9666c1d95ed9c7054eca1b817fc93a5d0e40cc975ff2760af31feaa895f55f106cadfa2331af3bc42e25360ddf8a7bcd2061395534b6976fc87357a1e87a1f885755c59a418faa28862ac1d7441d73ac47e426e1cac66f68b290534d0284d36721f9306708ec0ccf30412cc8d1eab8bc1094e39708df8147d62ff251418cce646f073ddef230474109f9a14a854b42756f4cce902df8697417fc5282d5b5c5d97a7cda7afe532bfdbcaca61219f0e1fe53fc0c6639691522881d5336e0bc561d9738c3edb5ef7900f8916b7f1595c56cbb32d7c1b21fa461c9845f6a7a70684267b84ca356b21a546f40c594ca7b4f5fa7c3e76cd2fe79e63e94c5b919aca860033a4e55b926e0a78cc2a9ac3fb5df4832c2cfb55cc000e429977f64f61a90a02b4ce2dc0f2949ae41b44103076e2276a687309341446fd90e842eb2c7f3247ec4dc3ecee27de1ecff43d2eb4dcc8fbbd354b29621388d64ef9b728a398d40f239ac8f86ff28e15b85eb6e6c5ba8d69d7d45b61bddcaafb4718719b3a6664df0a7d9445e6e97d6f63eb107cfc272bbec967b6f96aeadbbb1231c7ac4b3093422c1b538b4f6947e1290a161d02690e52d3e97bda60812cae98992e9f9e91ee285360abb9757f2b681bbf4a2d8009a532a573261d8c103e40679f034108e9477a958d9a9511892241247a8fb88a3bc03717aa89df561e588616cb8ea9c3f27e05773366b62e48e7d95a5cb2bbdf8fd38abbf59174c1719774ba5acea40861747ab08c75487ea0ea1f01e26fdcb7cfeec8b715472f28f88502dd1d64d7752c51fa074289cf74a57e5445eb36368bc4b4d82b026f6989168b501f796ce2fb1bf7914877e811f120ff14ccd5e31cf79c8594997c35105f46b9dba6244aa2e0fb1cac3475255be54e7d306ed4cf7ea7ce9952ab494029ffac0c1428a970fae4c3227b362cae02c4945bf26055807e4fb780af803f11ee95f16260212dd5a9ae34e8077325aded3f87c297904c9312fe44d4eabed648d39d07b141dbc8c189a79c629b95118df0c56466cc4b69e1093966e4501befd6fad7e2c6dade85078bd2cfc71049d8f6e901bf7e81aa0f75bb8bc036569c55cada1583acc1da2e170cb0e59967525e6468520c254eb6c8a623f0823e3c43194331277ca9d7872bfad9e0218b24a5be452079b00da3ba0aa367a4fe3fe1fcb5e50bd803a9efbb4784f53e45e62368adaec1cfe6e893d829d3eba3593046c55e579d4c89618dcdedf91b60572ce25b21922c8ed7e60e2c5ce903723d5e66fe93c68a3a178dfe469566fc598c66e1c93f46a6983c41c02cef77f1748a2361f83e30236b4a87fcf5de510d4491e767deffa952c648f4ea278693fbc23cb0d11692716473e4b1768171a5816cfe823f3d6bb192d4cd24afb14edd03d2ef10e7cfa738ed5952c92e062d1a61dea5ef03a2317ca3f29477ecfdb3bce72c601e8327755a861163def9161c15248fec7baca697001160c53ade936d68323d5d1283ecceeb566e81ec3d8820a20aa32a323337aaf5f47a0d5d72d1f3ad134072e2d9e613cb7a2fa88c0ce591a7ec16c2657e03a854ae41bb609b7d7ade7921a0f26c5daedd11f00ff1657d378930596f0879cf788520116d74975c45dc0c10a904751655f99a4aceb44f40e5cdd1cf5016a3668b4eaa165406552732b2d5c05af12142a5a643b5481492a6bf62d6292f26fbb5a6f7fb7a0db5e05f0a4fd5b7e4e7236cef7e8a3fe902820022966c3b3455ea35567f01b3a0ab195ce64cbaeb6cabf19e67d06173965d71edebf47a93d8fe16f9233f082a44795776034e83d3f50b088a58e9b90ae3d03ab145026c64f75996869e873063bf9a67c32868ea4616abccbe1fec35d59c33dbc5cfbc2ea94130411876e9dcc2cf1c3da5f9b0c4423a0e8f3468c1b73aa29b64210159ca58e462507d1fa3f15da7a1d35998318551767d63e9f3bd12f79a1291f8a1c871088716c9e11462d6566f75fdf17d76f624ee8e5ca300c56940f0ede28b0006911d442de6e5c97493d7322df8544b22dce97b0d9df555a977d50e3c86cf897a6709aaaef5c8ade0dac23321c129a92f2783809a66dc0acd3eb8f17b30178a420bf03611f7ed95c919fac121cd205f1cc25f8f8b70279c6b0a0ac88455f080defa5eadb5c50e5b323ee07f42ad1c6a7ed0b1af6fe8552d7c348a708ba20c6e1324bfd7dbe8fc483389b129951db98fe144c598b1f48baeef47c415ad222a3a71f649af64db824771006c10d445670b5df045c5cc134435ea48c949e977f864ea59595159e442f10b0bc27983f7ea93b71b43de7c98690c4e7e5bff869686f02a319fe9d8088fbc19806a07ddd996196dd86dd8608d71a266cae9fc248539854dd0839dcb901d497e2da8ad12617e4faa63058845993efd155ddcef621179c12b2038846516a7408c8c2b0a93632ebece80077e140c379157ec1f5d91d188905b1e25c96f92ccd3d9a3b24a90c114dd27e2e7a7e73e621ea68562fe0ddaf579d17cf74ef2fe808e80e5d03269dc32f2ef81fd566f8bf1177929b99cc23918e26c9eaf2ad76a03cef19bbd2b8ae3b31c37122cc254360fefba4cf528040f2f00e3ff13cbfbe90efe33084037df812c7a002b15e3369e64e41bc681d4dbf6ba091e5e62879249aa500e9b84c7e59968ca90197de22ba27a28e6f6769ef966109ab3584e5aaf619a69c73d5b8c118436fceb46df51d844a258c1cf66da67ade71c12f7ae52c4aa648d0441dca0ab026502a0c89d7fea70c4b96eb88ed6380e3f07fdd7e7efec1539c5d14e9663ace901ae94bddaf2e4721d820c92240a911dee20d97ca8a03988951f89f2b3f8cdc45b51bc5d99410658ec2e1292641b5b32ba431be86f49c14f2a6848920d062be91e0d71808e96641d32003fb8b5b7c7ff7552cc1d587c52343432a4b74ecb2967e345d1e4f989112547a49f5cc9f29317bae3cb12d1d7a9b6414a1a62fbbc64f03c83e4c02c1686884b7648f1ae1b72e1362dddf2470ed3e9b0d921884d7cd8f60dfecbc66043bab5c48acc1dd1f5aefffa99763e752b4c88bcbdbdd7cb499f871a77a32279332b6f6fdb2316bc458669678283e4b5930ed8b9da08acf1e2a1765bdc6171c8e714b89521cbdb551078df90b57b778378968d34a2c370f059a7ca88bed93645207edb77246829246019b81a65d6b5bef47267393f6b94fc85abad3b20e202dd8b96c1403690be2dfa8ba124abc245dd7a290a18cf897eef43f65422b34344e5cfdf70d87f24b8032f3b966a1ca5c5fa866a1dccf0a082ccea8c75585be5fc707e79220cdce567a85976b0d44e1dfcb39949595e43b08e1f4e97ae0a17f11c979bcf92068b15929d55d3b0f581299860e9148bb8a3e5f1ab58665633f5da3404676455375c82ed838c37f54983707d3a8e27bb80189bb8b13482d548a9eb8f34a7ee72e03082eca7f04209868725b995851f0363329d035179feeaacc5bfd950140d50a37572b7bbd721dad3cfd2f48928f05cee9f2a3f9f9edbe805b7c3845f29de643375bbd1fca8b86fdc619a71573cf522c3c754f898c04230fb74b1193f7c5aec54b902a550852570ca01f8a8d185d6348c7dd7681b3061680bf8f2eb200fed3266ae81db3df6da6577849a137447b59ea37e3c8b38cb0e98e8abe83d646fcbb192845e0c2c0df96d6054b5f666f6bd8b30a610778f56c88ae79dfce38287fd1e42655fe932a7882d68112a0606a8976645f86032984cb05dd8221b1f4ec3bbf3cfcb96c1a388a25e0e07bae9315b0c30d783cce9c5ed2db857a3920c1e4aa97bdfd4d44418b86c5697333b84fc61fbf095b606e4a57cb05a6f56e96f54e47ec242cf6a795182d2f55de1eaa9300d4485ef2fb9f852b5fe7d3d3890e9dae637e1a7b78dc4333f20af24852aa78ebaee351a82cc0798f7cbb22e472affafcd7ab044efb9c9c0ab336a07972c3510af3d508d3172557501c091422c8b4c4fdf484ba2adc4af583e5699d6399208eb2f92e8c657a33b0d4ca8c308341cb4eaea60f6f267e3ccf0c940ca8b47ecd713623a6e761577b3c11bc6fc6a536d457dcd946ef16eca6e5908159ba0e4dd2bb1e56cf417aff341f712f759c0576e2204d8cb3b4771aeb27440c41781a26c8821dd5be7c7ad2d8c3a6616412da01035bbfbd3bdf44ae605b7c4ec4ac2b6620ee4368b6e2e2b2e11acb6425524d471ecb498e6d7bc8e87834049a14b718b61e145cebdf57e49f2b214f61a65bdacac93b0a8ec7984fbaa95137f2f4bc5e347239912307fd33faef9b0df9e42f6daedd5dffc9edbea0f1f55ea25d0856f1e49587a78b1b6eb0d954e384548004468e2a8bdc24d446a92ba6253192bdcb50f0ad531d8a49fbabe33119a2de336003107a4b17ea210d25a75e23a4e1f1225b03a8305c4d6fdf23af12be53553e2c94ec20efeca83f6d5566004e8e25e88990e3ded90d899e2107a1a06f558e7ee1f3a9845c046475da0dc142e75b9a2d49b91e60d26d86536d542ecfe292b992e4e57543e07dbf8ee57a7b55d6a5c1fed0a20793d11cdc5fc8bdde07cc6bf79a7c54e95579cc38fc41b85f3e4564e9fa04f2c720780b868663fcdceec14c19dd92740ecc98eca1ec06175cd212156f75d1218ac24eefbd360dfd1ff8503f3fd201f2e5ca56d375cac13233a022ba27bfc8554449aa612c1429c5ad8bf2da257becaccdd457a02830540f6dd512c8bbb2f176bcf1dac957cab3e0c8eb490b6a1028b125d9fdd548cbb47407bf73410560cacf24548d8da68af9dba126ac2ea0e131326d163d2a7278132b258a8c252dc72d35b9e124df101ba547c8c534eeb33ec7a67f9a6801b02edd9c8c3706c18142a18d8efd6930bfd730a01a0c425667fc35ace24d7dc3ed777002bc852fe77a4b003292198a855645a60f35a5f4ecacedb92b1ce1e238d6c6cd8aa190ab323e67f9d5a84b8c52d971836cc087387cf70ead72a66693d5cd01cb812c001b9619469c9b8976ffe568d0f77d5a1a18d62686e4eccae7cc82396308f76e8f2d6120396270dc6e1791f645eb7c3c11875e1e3f40789ff039c2ed1586a3f5f643326a8588a7d03d35fb5042c6247801f62bc6d0dba45731dc9ec0cdc405ca565db62ce9ff16ec0768495c749e6050ca7d516d9c6c158448b253174fbb68289c513f046f730b72398c0f313341a3d3e6af9ce367fe5897f2027b0b8f669283eec5661246e3143c52db59e61713601260cc8f1d9ed7ea97cb5f8406a4db938d8ede3cd83e1d747892b5b15718faf1458512dcc85ead776cd7b293d34fd4c36394720c77a05373721bd4b752af3132947897c4a067e65ed278afa2092a16590607b7aedd5c20b15d268415fc99055cbb34f8c702bfe1ea304e1671e4ccc67ac69b53d1535ffd1100174d4d607dc6367229435345bce66ed8efababe687afc12f7e664e21a29ed51ca36d02a85ed05c87ca80d9ca180a217e040623b84ea08b213c1bf92c309f4c43d31aad241a6af79b6e76bfcf1e581b87895ce5ac23c58a62b7ae2a2ae406a3102b93269a73d586cb3a4d9ec9278a73f987241bf5adb9c0fd127ad85905b778a18c42f2ae7d1b34ada5af12a10d165a8f252eec732f4d4127c24ecbb29522e3baf3894da0b7634af87bf3e2c2d6711ac0ff30b6c9bdc8166e6c4eae53beb30c16ebc9b1149f70a8fbd1ea48210db86d570e43d4641e668295d287715490f26f93f8967a50c76ad14cf56bd296192b30f66cbe2c3b97267f53048337f6f1fae397dccac4fe1492cb755a3596e110b1feb20b0dd90f18c520a8050c7afc635366116afac5a3854b654038e204c21290d21a197b349db858c2f939420e829af9b87517ee68f597fd9e54d4a9bd2f9462c4b9b29b1b6d14d931eea1b8fa4cd73897ba6a9acc1e48be23a6af8598ea40db40be62b60ef5596913c5677c62fc1158a48fb8ef28772268b33254e44a669bb32da7dbb6f37702d7dd1d7f078c53a8c056a2b16d8dee27db74076f3a15956bed99001eaae32e2dabf1a17afbc48e441688a26ca0cad8824548830dc0b261bfada4f5d0c019d713ad4c613591c32d7dc7a07bedc40978b2b69aecc71c6b2a83bea1d70a57957ec8b9a93db5d163d260ac8bf378cddff3a767e72c63b32446c680ae742db4fd6c712e889465476414194d3c1839aaea928c433e62de7494af13113c1167eac2e9d210efbec773a0b298321c481e2de3345f6b76d695d14744a15f5bc2a011ac981ab10d724718efcdc5b8b2b4d7f1f51d9765a37ad77d7a7522ad62740cc4eadd27ef828311a87c4a6bdba3abca6833aa14937ef6095a9ccfd932d34fd473e6e1e0f83097740d41f1b9cf27034c4be73e639585cb9fc388b34cbae203b09f16c4ea530bc221b04d369d11c2fb8deb850dbbfc5058f347ab449bfa4900b7676ed126c23af2fe5d16516be76f24e258c44ba762745b59cd97cf2f62c78fd5ee8060a29bf8f01657246ac1a02431008ec8a129ae5027edd1005f86f35579523aa130cdf08caee0d29eb27f62fb4208247c044d633c4370d7869ff681ac6d54f6a792229b038ff6d3d738d48d2a7b538a1be0a1c54ee1db4600e4331e1b137fb0c17cc59d988f11e1789ebec108821ab7b875814978e373f2d404e210b146bb2bb9a7999985a1da815fcf7025ba288ce618c3eaf01a174ff593beb84ef0b2cb3d0b4aac397ccaed61dc7f496cffb21ab9b78a7e9ef9a4bceeaa8fdda493144f2d82e6398782e84a8e37f7b9fa7c614ac1746bd95c2990c5b3b9d9c7f9859ff7ed422067c76695e126ae04920744ad02d565b0a48859598d60e160a54e38c88cf6f7bd8553c38ddf22732c8189b1b7c295eb317583b744fa8178ea7d410b2f1ed29b9014c6dbb74f5d5e07f36125c822e383136405ab2c33a66e668ed0e35abc8b05d1e42f3dba568ddfa4621a785b3f1b8f5edd958e6f4a08281719545ff44d3a13ea1dfadd8cfd975433af9d45e4a452d1393a517660288d3d22dff74cbcfa6fb5a001eacf41e259578c108af643b4e8b1e65584e21aaf9bf82de4357398dd4246b06c21ae2cc2630ab96bd7bd6a4560b3f58aab2e034c3bf750b99306047ea5ca4e91fe7817700d136d938af146aaa3cc70c6a62c0b013bac910ee366596438bbf31eae3e4918d5063dff8fbb13a0a748a2767109ad31511bbb16a8e9639c461d8d5f292a42267abec564adf6f3a883a7d9902c03feaff25627d7e3f7343cce13cdf9c0f2db7a33de87b0c0be7c18ed08fc4098c40989211f468de8b0ba48af01a66e4c0db7376a652d736dd0929d51ca1a1eea39a5fa09aecae7026dc7bda5888022cb8ce51f724a59dedc056def893a48702cdebdfca3bf95afd501faaa4fe8650da90f1763a89025861a495e7af95586caf345f4adaae25402f25a1d2c8f6d3f707e4b641b2a57ac28cc61ec7c7fbdd275d17cc5df159f84c78330a1cdb4afed62db6bcaa6a513765a5422e3d33e8af36ed449617cfbbf8d66368aa67f021d03da7ebf7cc7ef1123ceece091abc8c494d7fd698c5866e8113cf98044550169da6a6178a6e8661e5e632ad110c39bdd8293032b5c9823ade2ce510d9c5b02d10a61e479a9c71cb5c6a03ef80841bb6cd7779eb3732f8855e7f347f295331707dd44d67b132d1ee47eb0a5a8dc26ba0f7a0c7c24191e6d7c2d1d19b76fc287c46b4561fed12c1fb31bce54d36c463a7a6a579c652c0e8b68d979c33409e3291b17c62e5bc2356c073cd7e9c886bc2c7fbabc46029020a1e8fd5d112d8e16605f60eaaf229516c1b8897058b4988515f454d2c87dc2799e08ecdfdc7ff16fcebcf607f17c8559807ef9444c22f4a499b7e50644e990e187ebeb61740ea75e2b07cc4271ca3c7b3533173146b37b2f090930157446bcb33cc7d3b55783ebeb7c6337c91dbdf5a77b89854e7a79518af9978154a5a809cb821db09b6b4e1f69bed5682b3b637e37ff47e092987246892ed0955ecec6110fd4cb44020957f7f61e87068fe02f7144af80c947bbd374f0ef5422941dadbe8788bbdc96cd81ba82f279050c63a5c155b3c9a5e46858dc8c35dfbf0a9f0a6d4d70bcb8f4b0a8737a0fb5e966b7040a576f7e5e10ac921f2fcc0f28495860fdc3c2a54468434855f8c025caee10fc4771fe30907b966de73ce758048e4d3bb9a888ff26662176cce9463deb2bfef97c51c9ab025879acde2399cf9c451bfd4391131727a68dcd98ce115e547d963db59dae728cfa7207e72b565382f4ad9de7e1594d0accf2a814c96cb59d975492c5b758e63e163126396fbecfa4855a76e2e572b4591343eca03c52b0f8f0af01e47a909ab6f0899e65db8ae7ae93fca0da9dcff343b09f9dee13f54167f5d6c8e38ecc8e9cf669d8c44cb4590c217997dd5f03c78701231de01273ca957a196c7aeaf5d8c9b92bab7ab16e60d405340df8caab58a2fb3f063f3453a5d90b1a85adaa824907004bbf449cd65be3214ad44931ead35e3f037a887908bbc71e47e416965d4b4be45541cd6dac6bef9386e0e68e19778c5ce9cf70d1a0bfcb1ba92d3ece0875a1d1a8bce8db8e833ab4cee9dda393663de10aecdf93d097055f4697c5ff255be066957302b280dc55697a3da5dd39fd0e4598ed93871360e98af2aa29c5a566b5b51e3b8e184874a60e4e832547acae017820c60cc7d5219964642c28e48ea11816f4c170262e12ebd3c2cb94b98269b75c8a2a25f6580a64578ca5723a631dc1555824a2b74497bf8aa7d1add6d16dcd3c749e00756a73916c6f38a7a5ca389748e2db53b626f892baec455e2eb2d59d86c80002b3db359b6253d32e2def218f0eb1e63a59f5e975bb2cd0ad464c339b58a2836365ef7acd1c90c2057dd4569f91c31a3ee0280334133f60fdf193b07209a772ad2ec754909305177b8ef91a89c827cbc4b66d3e8c50d67d0359f6f257ff78e4be69be4510ab991b659bd57024e914807639d9a0124777810f32bdd0a2da429367f5c2cff21392f7751e42e31e761da3f8873fd36768beb5a8ffbcb72866ee2d2a6e605f5ddc6d1f91b5bd0afbed98d41c85ceca33ae8ed93088dcaf06ee53d356d44544c49daa417baef1f3b762a69865c604514ffd17be87817cb639fe062d4050e7e83e2ea94d85b866d579496403464e8e4294b60c5a760f110f11d9da371fabc6ca92e253500a580ac0bc09f59bea7f16eaad0e9de25ee839b9497066cc32fbae28ea76f80d5054dcac331b11764e6b320c663c1ee691849f3006b2bfea3bf9c75739be3effe1058d612cc194f606b2f06b61e66a8facb40d96cd943f0f1e182bc5900a634b2f67c8c459045532b7eeaf0fb6630575453a00c3051bf522b0e1ddbe835f1b07692c4778989d601f0df0e2fa4ce156275cc0014012c842d689b39ddf22690c7c34322f56c361385e562e7d229399c37f4d5f9263f338574842be39c98b082a6fe8d25bcba3589a90e6137bafb4fe142c654cc99892131778b54f48940c00ffddffbecfee9a4a6869d6a4750fbc92f1d6116c91b6364dcc4395d95af2676f2937df9c8e47b65eef21c0745807c5f968fd7da1db1317220634cc1beb3093e870a24f0c237722ed26a5fa41e6732edf036bdbc59260de00283bbe8847f594e45edf7ae36318bad34284d86c6ae9f03b0d0415fed9901562b66faac6fb2c80d933874e8e3354390aaf5c16078272680ec34e98fbfc62a1dcec8c83e75b43ed7ef598aac5dc9529ea94454d725700688e8a3261c1666ecadd2338795a3df7f08584383c8c97143e9a797555a376dda733be63217100819be68e0c3643970d1b680d2b6ef4e7b0044feb8cb22457bae40e193d67c66d539de35357b944a0ccabdbb49bff0257b3a9d05bfb7181b3c219a539c9ac6639979edf60df6d20a0399bca3e709b22d74500eb928ce12626c4f89eb8c0770a5870763bf56f31c9164bee8abd26d4244f6497462ad800d550c68cf476d19d25da3ecd73f19adc516958f083aa1fd3ba6b065ba0bf6ae27d21e21867bc7a9f6115ff7b07574c23d012d9041bbd915a74a1c4952f03575a9b00b3200b6aff409ddc192c2b6fbba41404b29bc3b77976d9519a4e1527dcc70f33e55facb888c44f8bd65e799d039dc8561e4cb08996e9ca861ea674bb255b160f93a3c818574a71080323b0a1e9e7299f1d8f37ae9496dbf1f4a925bf2ae70a796b1bc940645c9ffd2a4657129a02b78100ff1a27d21a56fa94bdea462c2bbde987fff57a325d83d73949b257180a8d889388729adbf2d6641c06d28b7b20b947835dc10acf877c430fcba39a70248a1a83485ea3d7cf520fbe954e9c1f121c2ac3b5ff98b39e5d3186362a9bfb9a3c75e18af947bd49ea23032a9b957990d907901fc2fa0d64a22be245d005483852e992a2b4a2f810ac761a94fb9fe9bf4b1261c3f6a0e169b589f2a47d0d1a109da2481f51728540a5657444e5bda24f3681db4e0f7b0f68c3051a2e92726c51c886da05ef80f393db58fa718eb16ee8ac8ae62ea6b1a20a9ab9e58fd3514ca9aaa8962f052d96266d54eb85b72b1279ad02894d1978a1b76d1502aa35b840c99542f13d6dd5cb2e3b1af381ad6493d0ab53a2a5d85cec64ab167a2996aeed3dae097eed62f5ff9404ba8c3b79765f7bc1672947ebf63c6ea14c1812b12b7dff0a7c8dd8ae1ac347ce22750c34b93b5343e7aa6567ec13db875faeaa13e208c6b5eea7d8b4a48774371348d1fb597f88dc6e8a17e5c5434dd0bde9ab947679b1023816782659c659e8ad8af3f1ae996927576394b50234156ba54cb677df86667bf0c73edb89346730f6ddc60b4f07bc8bad929d4e44b53fd779b408b82fb84f014b77338f630e30df6b5551565d4e634bce3f6c811ad929af6b036b9304587000488fcdf47151e37ec8563e8fcecabaf031960b468b987ec1935150b0f323f926a5f51bb5e2d0e5f8526781c7816f33fea25be45b74f68e195ace55ae972fe72964fb9e2f1f61a4e1b25fa336eba67b2833f29b80b9bf7fdebff7d3d4a55d24c05670a1a2f9812eb1b817422fc372d42a99109abf39ff6760f84433d2734a920b1ac77fa0e068931d5ea5eeaae9b16243ef8ee7c398017287876b720eb7e82a2eddaa9d330788fc41541ef5a50fbe4f920180e18f645511658af21029823fed5ce322a3d8f8d86800135b209d5384086282c00cef49d22ed5bb199972478a4e5f15e640a8bc126a71dbc0ca234185dedb44fd9d6d722e3ffe76c00fdf450959c36b2af5c394f88b53f5edea0034346065cc85395d98e851a77399ab95200ae4f408ab9ed13ec8485a960da78bac7d6d1a3f5fc755cb8f0c29ece9d826dd65628973191ed35042a5c4b1362ef247b8289e05d090edd8b11546e5e19d2c38c5f34bf881ff4201fbbe481b73ac4e5b2f6c9dd2d2bcb11428f91c157cee10e4eee4c7b639f861dd0aa3928f005017cfad78d0235c4a1c528030a8c76102e52c897c0777a9d974e65e2aa417ec794f7a9969398b7cc7ff10a9119d4ec415064e5f638ff22742b919838d2cc687fabf687a5d7ddcd0fdc25d25b5e441fa1972cd34282fa3dc78950b3e49798375f787d32055bfa7051dc772616b5ba6b79b479a91e7f0524ad4f6a56bb92c28a0aba4d71019afcd0f67348994f009d7c559cf452f38726474f07142480e3d0d9a7e2c2106f5a57af1ac82391e36277023372c624a40f723503009a58e38945d8c81182b09fb1651c3c4c2c6a71be2ec13fb284d35ae0333883f93c00632d65c33a11a6ffe5b07dc4e3f859a342940c2b5173df8c51acd11f96f84babfa869b58cc8fbf648fb5a0ef7c221daaa315fefa65aabf4f134c861612e557c17a8e13ca4f4b646080c9f4e1a6f6c3f0baf5d1f7f1597b83175dc915bc7eae41b0ef754024c4e309ac3f67c9dbb5d643e89151c6d42a9a6070b40c547c33ee96dcfeb2cd5e91f335d8f3536b4c86e0ecabb00d7ab89c13335a0393398785776635175775a3980b22b4587b2993fcc1b67db7d82789bf05e64011a11d9dace35c9d866b3f65bcb6232f6e9c1378a6239e35da8d2b18ad999ab1ef3aa01dd84b63191cef7edb272de9ed9316848ab0937750718b6fbdcb0c688a8cbb377783868e69855f59549bd3e14f13787b1d7396eb2ea0e8a7006d2bee3574bc6d7412de7a0cac3e8de50999d1707534f23c11700288608db4471dabd4de5bb50a5d173206a6d40788870257c826674b6dac39d3ea3c63432e30d2510b5e077998067519c961f25359fc29e81531ec9cbbd794c564db4ca142250ed998a0f64e821243c62af64d1c066e1a16644dfd6429c999e467fcf2279f286d552c3d0cde8b818301848a4eec9c67ea6d750bdf1246858f2ad4293aae4f47ac97f5c9e33de19dcb680e15c8db991e6019ec818341df30753f85b52f6296e1f3aef3871472c0c3fe07a9a47b6b8515cbfee3ee330ba09935a39a5249b9ff586b67ba0d9220d95429808c0f58d675954d914f8a3bc87f2dadfe5d54f7742ae8287d3fd34e133623ebcc8261039be78c9226cbb84a9b3f7393052bc5405d7c8da6c735ed181d8971011429a3558e2ec3d0043b2ba4e12a660a3a25b47dcd95e59275e29ed3b2806710a3b3dfa67ed0c4a6c7507bfeb722937f9e8459801baffc05070792f87bc8bb3a76b11befb78b89347b8c3171325483f5dbca8f6e357ad191f1d5e4a220e5513d4dc3f97404b02af98a5aaff6eac2786ae256f1d4bf78194ecadd41efdaf1d1303203c830eea950f6a942f519139c63d4f066fa76830e5f2ae1112c50a4c1b4a25adc9671c9b6d58aded558e5b64f6bc83e92d79e6ebd74d99c2a6437e129fe6020f9a6a023c1a66eb0980955a092f6898fd659e441baef3913b09c7bb5fdd4317366b3b36df8a1cb6c4a4efdd2d4f887201191c8f9ca273465777208b082b12630c9104c36a1f867dd46687c60e38d92f2e880759656488b2fcd71935c39eaea4ccab069cc9e51301b74185af9a9df4a5247ad73d164de90e578e3c3b5402955c9f04d60cb59c0182ff24e921ba05ce32c601013a1dc3f10ba8f89be05fbf22ffe514336f24f33dd939253f11c7afcc32d929e0c1354a4042d4a1df2e57a7c63338b691e145f5bd89c8cdb0be058b46b61355c9076baa17193eb75f6c533b3c70fe9a4cc9501922b465c23ffbd7504cd4fdf75957a65f5e8be9ea32636419da1188044c530680949bbae14330518aa482cd199c79b268b5ca7c6b503556e0b24ea4b31959f0bf0be1b64b88f20e610d37601871a0e8ce71d4a34890d6181c453cc916a6eea8e675fc31e9774cb6497952f8d473b390496f1e2f2b88090d10c460a1f32492366a4098ac46477863144fd7cdf953ee8840458ec6fcca120a09198b9a94ed3f6dbed94d0864ea44af08e76c3865d2c8b1ec83009f20175ec608621bf710831039ce1ded3a8b779e0972935ad9ee42c56fcbb1dfb851419b8087363dadea93807c1eca92ca0c615b60d4a44ce839eaa4ecffd09afc43ff2d2fce1a75be161555cbbec403a2d03ac15aa8abb948be497fd69dc62d34b9d6783190d8c3b834c09484a4afc6b72c1f4b6615b7654d18b2381c639c32c9cecb93dcf037f980648a2496d7ad09651e82c74374c6ac654c40d11c1af8396b634ecc1d1252064878491d007ee73e676d14714a17b0d6f3d4d0f3a5e3ab1d039e2ec8df8a9b07ebc3e407bd60e18d8892caffbb4d5b82142212de48260258d36d3e34cd4d1fd05fbc8dac77070ccdeae75b640c8a4d7aab1308d2a3b2cfa680e59cacfb64958c52da083b3c0e2d2f8b3cdf2fdb9f97b861cb099693b4546e0c8a5f867279bfa9b5bf143b29ec83ba422fa5eb8a678a5ccc01fdbac92f3b23d32ca1ce1d5040c6b258b39dcfb539df819f05bb1c0e55cd264d523d5988e6ef3905a9659cc936574341c5aac56810f75a3f2de72a43efe6140624fbba93b23b54bb46c6d612931fede1db14897f519c8c645f2917412edc12fe4d7c5e0a0e1061a4a5e95797ac42d6be3c2c066731e8c14143dfb01cdac952ba7f7ac098c34bea6bf3463295bf3e345da229111db7d6c59c6c123314eb0c6da67225aaed833b4b7433d2f32d4dd8d58e71233e8fdeabaf0d265f7150300ddd74a33f2014d3feff842ad3b183f359a538b1ed83522e749c19557112a583dbe4755196e485e8aa1ca69f8f4989d4b4a8983d99836281e9f3d660ac48f85078a5c39ac30836ecf771ba2c980d81724c76740704b6dcae96de799c34dab826fc8d81e5dc05ae06ecd3b863aa8ab4a399c6da7dbfebfd00e0c5250133ab0232bbeecf6562b1db42971aaa9137ad4681dc7d988406c6badc695d9af1a3c6cc31ff43bd8f079a70f0c481a7b16bbee900d9ec5f2436afabc63df19077c08d87b45f371ee9f2005670decc2c63e2f30423a945a9d8c56416605cd727274447b9bb561152f32e26d8e44db11a56ec2265c8e87898e2eab8b8389da2c9758f1bd2022190e9c2754679cea56dd20c698a8e82e7b0ea38e87dda46e1eaba2ec8acd6946839579f60b138001e38bf3401ea7b4434c30ce520f738b603cb81017df4939b107a5ce655e0317d624e56c9de85be22fb08b93f61cd13c527ee489b56d6416dc05560774f37a190d098b0bf35db9af0935954b050eedb77af0cac4c607941870cf27c56c80d7d038fdf3e9aa588521a1c3728b41b127edfd2211f20b48601b29e2386ff358b35b2bf7c7da7e134cc5cf3e00119ace98798fc4ba6aa20f462803ce736f52342703d833c911e417441a1ce2d603a4fc8251b98c4d522f02f1ad8a308ea08e86ab0015d865a83285dee8fb9079ad775cd5bea7d7f845363161b683c4ab9e4182760764bd0cb8d83667f855c8c868080d5d87b401496081a355717e472e3e6b7a3eac14878bae19b1e9a326bd5c0a2e700eda0146c67c079d5cd203930da9555fb61e2c2c863d250d2abc6a0018afd8615e472f049a655c80848e3b7e15a652cd222f384cf0b1b87dec7388610c8d35c3ac7be455e0dc1f199e4734e5d7f0e8d711804a885d75eeec772a8c4535d66bed52760b124c79bc349b74625fa8539698d491588cda5e86fe9e92206f4469e695d37f74a920018fb19f32335c269eaad93ea27156d11c89494b27156c60fab7c93794287809eb50c1bde591335c706de1260d140f2f3834d5014f4b191154d804c773769184fc5f22ca63e7ca50cd6c98789b7932e007573277c18ca1750c02279cb8b99449eacc861f408c3b0dc86728e66aa7d57b474f082bc8fb7ca2e9b51b4b2d3fc3a7ac87b56818f682dcc06effc5327b04326f1f47902c1c08c0548613771bd6ef7f4e94062f4b2cb37a7eece071618bdaefa8f474ce0c0cfcebbf25822bd2c177bf7aff1917b7510b2e3254073e2c2bfb4f79c0f49cebe788c6e5ae13c5fd14a68d17dfac140b9010759e1e31f03ad2e127001af95f0478970a3ab2577139ba50c99c455f6f5e85d51f6d49e7121483842dee08718b344b95a3be1a09d0f9532c2828a7aac4bc7bad3639d2c3634d3f11b340a02b3e89356f4b0960da555471bbbcf4680e601999d6537789d8cf3759f13e647adf474c9f068bc24b8558319abf3a92cff1347ed2868eefd59725e3aa4f5b360c779fff24d1e04baebeaa2e11077574f4283a7043757cb4e5aae81464e59301c9b562772b736a4d0d4674fe774a8d6c045654a43bd69e64534d1541533c0cd880c6d01035731486093eb7daae580261b2b31a71911f0ea70a00df2f04313dd928ef6abe64bd889d0c5ad98b026aa3b8e0cda61d3bfa62f8e005c1708248890f4e0a00a1883f4682d1d693efdad535662012053cfcc5be24138f1a387f66be13cbc4de5d6c9028c09698da07bef82ce400a4dceea179bb830487db524f3fa12b02defa68b9196af7c183f198eb4b006374e587bc5358e7ddd74c9003dd2f74c89fc266c783e8b83db43589217e2bf48ed9501504d662348b9cb226be48b632082f55302898f47072bceb2621cbf3c08a19cec1c284ae9dbc434149697dce710ea9450d9bd438f5b780068179e28f0ce2709cd98d6994a88fc2cc03669ab07447e829230153d810ed2c81dcfe3289b593c06df9fe4339fb1e1848b84065f870f445f9ba3b398607503a742e072d72fff43df06c4b7e98ec7660c38f6176b16d9a81de6ab97c79be3d858d177a07583f155aab3c7a9fcc99e89b82bdddbbf3a3c8388e4e3e9e4018d8a2149e7a31ad5bd768487005c73c8399feace9126285b7bbeae9e07b0490dc605b2cd573f4d22c1e1b518409ec9d46292f1f0117e23215f5f5cea62635dae7426f9e4637a971b1befd91ee1855ffaaec8c039c593b0866ed258eacd2da9bda783accf63ebfd3cd1a816cc90cbe66062f2f05bee010ac0bebe849f0c4352b82410e975729e3a30ab8487be2c401a2f8bf84e77538c24912368614b10267f90432b62fa8ce853de23896b7763c7d5f1294dfd05dae990d67b3d3779adafedfb182ac8e48eebd16fe74696d9aad62b0cb1492a48228c2510bfcd1193dc1233f21b279ce0cefe24605f28189d0def6a07e48d768698283563eb0bffe7db1e297e4c82caadb9873db506fe7ed5f6d5ecac65c21042e37605afd074ef21fbee122f300bef1783b4d2704c042c362edf80363270e503c7151ec370f7d7865086458346aff8cf3ced5b462382096a6d9371100c5d64d9cd2e663bb26e5c451fce5caa093c398625a70f36f242a214fceea669333547820b8d13ebdbc03fc440e7c655037954f43c8d6898ef14fc55f5305a25e0f124fa09045516d8bd5782221f7fe7323f9629a82f9464f8e11739cf3a0e82ce793017a1238570b1eb690ad09fa7a85e059a814fba8a61225c3b17880a4c8ae9f2dbdf5e46dbd687ea76fd0a69bf792e35f391609e51d02f9b62c312561ed3f8f176d5839be8355d236c86920258a786ddcd042ad4a0b66fc7be38a669b3df79511dce5d8f6f26919393cbb7aa09d88c856cc428906ab0ff8dd5e29956bf6dea7b73b47b7eb1eb90936551d2111ad03cb65f37dd44da75694527bc4e980f444f03202b9826315adf248f760868034e7a27b5b7264652e8fb00d4ab1125f77c4cdd06acd9aa4e99002469503859057049bbac4d480993f9decc7ce3aef58627ace9f03ebf34b6b75e8e01572244969c1d8a81a5c25fa7472b1f11d4a336f8957c4f28d3b953ca17c8311bf165ad8ff5c11b39aa6d7ab33ee5c4b21f0cb3b77bff457c39b7edfff22e45abfe043ae9f1673979fb48a751e5bd5608bc6b713f8b6772aef61d44d8fc4563eb6d506db95cd99ddeae4f3d8848ccb752061caba2b17d24dae8fc450a5b6e824ff5c230bab611e35c584eaed4a07a7de25d44bab916655bc594925ba93ea6352d66b680b07854370d36aac513d4cfed52fffd9f1474473f9bb83a6d6c1f21bea1a8647489454353e6ad8aa5b277e8c828d713a14e1ab512059a50567e5d7a8ad0fb030fe33fa47a1bf69a1ad252445afefa0be518098f9a943f02d364e586db6d5dd39ce047e9e89234a4c59fdda21ec87b81fa252803d2c825b617cc733eb3e633427f7d0541d9f9afd8723bcd72b17e2085de721378c0668b326ae80bec0d31ccba5e010d2fe366a5e1cce0e2530c38b1c3cf6744aefb81734f88557209d51e11e992becf7ba199d2af2cb4a002e53d0490ee470bab074446d5d8ed96c7eb082a9c174cb58190c67c589070833d1884399cc02d9d66b14f78c50885199c42d2e7f2d4fc0254b9bf4a8d9fe1f93d3940b0fe92a440d229876470bc35dde9d9c0f5b1f72fac288e81377a3444d10640c16a8a16d87647fb89971d04d49842ef06ab8b7c2b628e89eca32e9a037e5893b0c662614838815463e0a8b23da5b97948fdbcc6d2eefb2abf4534b64cd647eaa3031905e47e26b038930442c674f60704fcb6ec9dec3c40edd1498b980918a40954b65506ddc088997c985731bf4bab322f2ac3dfddfa49cf25f1b1d19d1da883ed1c392f934f03b030762c6775025e82f1cdef0775e19ef9dbed2a5c5271a690f79490bf2fe7b389108e808a7e4743b7130cb85d195925294c9fc6d4d45868ae807844cd1eac12ab26f48eb4a2873750c7826fa4f353eb34d1bdc47f72288d07202ebd833be15e62d7a78f5ac55ccc411755ceac4168970af3b9bc062df1876300e1727c1f74aa0e4c3a4817e921ce9a3cc7760f73bb0926277a751286ecd976e52ba4a710ed5c311f159f96e4885df4b21cd1120c7cbb6745325d166d9828c0417412c3cbdf6385c4dda85ca42b286f78509993d539134b337943c84e5c6576f2075714e7ab6c35cfe012002ee014ab022fea7e1fe488c9ad3d069e3e240ef5421a49a68c8e32ab19580c6e87df03e8dbd55409e30fe66338a8d6a597fb2333e5870e28687e7e87abe51e5e4e0e1fe0567e85c22a1f583809dd7cd7b075dc2f61a907c846448ebf4737f489974f8092336def2dfe645c1334e8c1589c3e138a926e6dca295fa6d67082adca33e440b04c25b5873f0788f5216d2e7d97316df62ce83e9ef7ead267cb3dfd3cc8bc1665e493d7da1c7453ea6f728b240ec9dfc070f5a04799496d2f895537be3b7c3e344ae5cb2bfddafa81358b6803a104ea4b6b186e8cbdc2eff629ed8b8e1db4335a09296c55695db778f4518bebefadbc2ae520dd0aae7e7a23f82e89ad02742288bc3bb14fe10d65160c7dc3a55c0b6d0fd5b5797ee9825e7576ec23295f2322e16d0f5ed27914872395fa6c363ec68d57a46dc8724b4dfdccf54fcc467b076cc8b4fa683dffa8411f0477357942f0c471d3332fd833e3e57b4dce302b419428f24d58f6cec8784e83b1e418bce5d43df2924045c8f7749cc92ccea95a0040eb31eef5b43461361c50a97ee01fb26e4d25c696b48438f8fae7be6ee84c86b8327838cec4d968c6e31499b9b40ee0c64aac95c28d7189f862097eca5cc203a4ed42cfae391bc69975649e3890e21912b581e258fefbd301b624244ba3842943882344ca611f93440f303d1e6792271b2c7a061ea6bfdfc61a3a57c0f8907340bec6f85983f62e16ef0bfffb3437ad5877138ed32a081b8cb77ea558c58695b265d742fef6b9fffc9dd5f1203e07831fb36a8f913ba101051f80605e8a5e0d15ef87ecaec1f16e9751626a2346e78aff141f386b76e7e6aa6f49104e533fceed1a7a247d2a08e9af06fde9a0c8e6b12a7d102bbb24a37837fe3b832d411ca0cd19ffbe76641ddc162ac392445ff8495b2b1bb7597023d449e61d60175e662e4092274490ba18d3c10d626f70c85c4ea0dec92f739f875b427619a82b213dbaac8f41ca5c8c18e44fc74982ead87852cbbcc5ad766718077fe2a1515af89f84005d4ee31d897a9fd7d03464f9374cc62f148a836a4234f06bc0f23c736a68310e9ce3905cc9dd6b6fdfc9aecd68d66938d6b69bb42d94abfea8733a45d47fd058c97398fcae6922181dd01549d8d05ece272a05a20183365acba769b3619038228bfc5a73e4a1e76ec5ef946c2498a31bd2d1e4df7d5758553cb752771cb11db4c000083aecaddbb180bcafc449f36aedca7739a053f67ec7ec2b6e63f7c7fbbf819cf68614630a0db45284070335e74ffb10a58b187d1d8a0b94101633483fcc0466d6f0945f83190fb04bcade34b236e72c396db45f2a469da8bc98dd8a408866f6ac96415f5fbf437af3f4d5943c7f5c4215340fbd8249066b9f6cb34085a252957f5a1ce5e4d15c64386ebb029180cfd71286b88ebc30c3111e051fce7547b2ba92d5a07fe82495394930e8d1a3fe7f77687007a972a4e1f9f3d80b146b176b3df4ad799319338e78fc2ba2f4796d89d6af491fef8586762d94cbed2080fc02870378eb3b1f6434b4e9cc4cdf361d992fc2abb8ea511c1d15639fca1554e45c171d1b7b9d9d2441596da831085f9cef700bc23c6709b29d7de4de8f8a34547acd3978de4f602b2e389f01026cb9238f0fead81015c40d1a28b7b281b2b00298eb512d4ad00d4088ca4cda6f92faf86a782d1e14c13d8b213ed58f0d5ac87e15d575622f720532a0f924ae006d191f433a31a26f971a2f846fa3f74545c009ba9eb194679cf42a8a10ca9e319e95835df7afa6dbe1e71505dce2241949971de34cf708a8ab80b5b662f682e5394d0425e312c664c18b44eda1e6d0810effa3dd9732b9c2c885fb4c0f1d949786354fb0203a26fdbf972c4052a750793e740b45f0830364c15a7542a1330d6dd09f77b57c29b35707844d02ad749f26fbc83814c1151445c2ed74aafd5148a9c02ace47127ef02bd22ff99facf574ad522e0fd2693a40dd7b033458186a420d324c2c4ed76ed352d0589bca754e4f374408d5ea0c346cf3433266797f8426cf90aec67b36c1966ca2180a91155a902752e23ec524062b186ca9b018a2a34c527fcc7b5c2c6a059190545a1e0805dc1a8cb8732eba611955ea60f04c38daafa00a484ea8eeb65e0cf97f6c198a3c4a1755fa5ebc9c0d00e4315ff12c79f0fc11d0861fe6d9254ef195c29675a86c18739068819a4cbc47a2082b512ecb727625dacb9b14b4a24fb6dea6c8714fe2df0ee0e5b30c41f40ab8402b772433fc71775b5884f7efa258c31359e4d288d2dc5a97e5669f8889e86ad499521769ddf2db34881b4ed97e7b6fad543629ac55e10beab9eab01b626aaa1b353275129a3beb5ce7d0384c8edfbc22a4cf3aa780c8bf97181fc01214da90295ef37c416c23f5f3c89425daf62a0aed3e5824cfc4a6373bf99fe27d24f9c38955e0fa0f291ab2aeb36467d9f44ccab73a408135094096960c76ff2b0c559b35e9a0d8a271fa15fd5defbcb61cc627dbdd5e183083c74db2ce5725a3324fe577a49bad3dfe185a1b839078f083e1baee5e90a509238d0edefd140c0fde3017cc5528dad2e9066267c43bd09f19353766200ba97b4e260704393425c56e95d0b5343f487d32c9770b6a47c1e2a59392dc56de6d48a09a81b208fb464545c5d19f083fdb779079f491fb22568321e64e77b92eb774e76105551a8b9b8eda3c2433a84f943cffc4e1a09ad81067ca7b74bac9354771d1f89b11aa340631a3824e08c2f799b584bf6561c737a06b32ca561e9bf5fd8cb708d33c56c2724e98c1f83073e0509164c454c1fa3b07bb7608c9f0833ea9936b628984e257b90887533f417bc5c95bfb0178323d75d93d7f88bf94228029741ab968c2dab88cadb59e9d37573d619aba5e89ea829fd7fd4a9ada0884144d9dc41b5bd058c7a177cfd013f981fbb3e5946e587cfbc6c96d04762a76c65148ca1b5a173d78ff5777de8099185cc72a9b17e049e90ea883553d10daa3011e437f960883368c9e6e3809442ae01a1fe446cdc0d81e0301b9bffefc23a13a7cc70264379ac83827466cf9647581b00a2674583f34bbfa43b854d877f87331070a3a568d3279bfd58c1b79b94ffa764f5fd6bef71ccc3c31064b00f9d05fe839739deea464ee3de654dfcd43be34fef2ae70e1f197e7865104be2aef61888242520f6b3055eb335574dbb840428e2b55af72c98d9c3b33d3a8355ce73fc61f1e7f7105473e7de81f380a469822286cbb0881d07aae66f83cdd7034a04946065eb5bfc91e290bde667836fef6999979405cab47344b03697d487c1a296b6cb00ce397c2d00883b524aa0f71bebf1c8573fafca77b547908682097ce3d12354530f2e736370b850dba7f64fc56b0fc65d4d74d8d6fc2d9e7b0a0d194aee1c18300f4a909d29c848cede27d5012107532065faccb2620ec9d274bb01f57415ed45c2070c08fafedca4d538a12eeb4d1d1c12acf8cd801022e84c8785f3b4bab7e8cfb1d89860e386f17be63959de35ef9212e375d51b74ce446540169b3bea3e3f3bc9bccc4d3e96a295b857bb2137c9c89b0da0281c74a79021c4a2422daebafbb1c38ca8f445dd7ec30d0a76f2637c2a02367222793d73c21cef177972c37584a2e9262b57046fcfa8ffb30cce9d6de3c4ab9c5060729d8eca416a54e04c8412a535df8cd74016ca62a59beeac7286443d6315f1bf84c113958d51552285ef17ce449e2e5f8042881d1f836cba58e6f796b51befef16d60ae07087f8d31fd11dd1fb17c2cf73d90923bb6a613c5147d59255653814b9899a124dd78d00d18906326c7bf64ac492a5d3dac554c664c622d53d8ecd8a3ad973657604179c9fde633e8311f9b77f2d276ff000696c7d878bb0dec147fe4cbf0ddb2d264184ea4390c4aa33a794564ff28df6064718d25c0080ac794e4dd9287118fbcf495e441152d9f7e9e9b5acfb2f31d7fe95abf0d6cee71f6d9d89fb6104d381141fdd7d1caab3fd7a1d8ac8790a54ffcf120fd17838d2e6b23cab99e378c60105106b94b39b25d38e7539f9ccec339a1f48b4b6894efcbcc09b9eb114fdc7def635f5862a995db6993aaa363cd05140d8dfd59d1479607233d4856def33da85c5e45cf28db829ab8a8afa8c402657588acffe0239bca651b2611d022b8c177f0572399acceef9a97cc8c405214588272ba333914255d9481b168ff285bf5fc9a2b5e1ffebb128f9802899d4f5fbfe2335a95f0c0194aca0a637abc45eb1fbaf11a12ea1457d1c480ed360178c5a0725bade75d89e87525118aa7321f8e61b9a993401a046427933ffc45a7916ead1275ccdba6f8c46abf72ce13c5effd627e293bed3035784b4a69b3f588d5e3ee70d64e2fb2813210755485189feb80c22059b9740ddbe67e91c83ebfc15405f9f1dc8c55362ea64c103697f7b55d98b0b589292fdfa5500ccecb9cbca521da11bd809b14d26d27ecfd504af8b2b7e9b824865222ecd895528c04d7ef41e3e766a98eeb328ff57008694b67972eda509bb888f11c61581e9c53947d80352876da81fa1f1003317065cd026a5230ddf219b1d8d6fdc3ca4ac29a1cfa7df53ccbfb193a898a3f9c4132c2f3cf6f14952038b903ab93e6fe8e4de619aab1455bb59b9262aa15ee380984f39243f5a9e827cc5f77687a327f9deacbde849b9cac37f663ca85128b5f0647f6d83893d7391c0e06594ad9f51ca0db4b33b75914cba63ec488116b124fa524e035a3c2e9aeec75aa8612a5fbbfb2ded1e809ede99865ae6166f8e204ee35779ed76692dfec016ecaef905532312fa8c41f5fe3d91d15920fc61eb1e719abd6af717ee51ac1e85c7a98931d6febb8ea18132dd4896cc6b0f1642237ffcfe2003282958023d11700e28a2b2196904267134415f6c68537f6a4dad2eae4971bae7ecb9a4539e16764bc45f981b8a74fd4955a1e73c42c85282faf941b0e554139047568c86d2ba8809f5b10f7754e02071555b4e2301dc6b7537074e1a5ad6138fba87b9e907e87871a19045eb82d26ca418ebfab248f8cf448a62e38453282e447abc1409a2f5330afb5635f4899fadc1d5a94e2ef49fc151f66a802f2710d06d5cc77eb0d48cc02d0101d978c16c73f2ec604b357bf80f5546b9c4e469602a3c12246c0a5af85d8674e9dd8e9045a558ec8baa6c656380970dca2f39def4777e54feb47f77eb772579af988ca230afb2082881893f0b643f047e06750564bc2690c79519abc05e05767d5fd9cae5c2cab458b9221cec74a289ffdecd827d8db0a3f7ccde11de468a0c6b85a9bad95d2ebc189b4c9de73554e8a7e841588f76d3994fb98308f4a608d33398c355000685c68368c52586e08fe503273b98f6ca07f935369e8b933ed9e8d0121c1654178e7c902e555b7b8f1d3214fbe67675d501ce5aa0dc208912e47d2eaae678846c3ca07903c1c3fdf8b7e04958bdace6571be362dae4412125ff9a7cf27874a70538897b4e64a2886bb2436f0544bccf83b3b9494c2f13dcd9d38e3a2614351297a6ed2aede45f8c14045b586bd5be4e97a2c7abc90508a4306e4c8018770152d1a2f309fa5b65d8bbc7f7a4a61f373d030638a7cc5f1b92fb2b14c62fe673aac58f219040acbd2e31715f449cf7f4ffa30c6a06637fcd69a6bbbc019519db4121639e62d0f174b0e6030481b144ea105b44e4920178acfbe50f0acbb21cb6fda80b92c48aeeb182f625141127c20261deb451b0b8bedc696a6df3784e11a42a5687a59b24b3a48143e40a9f799eb570d8ab3c30cc6ab891d17df6c02a7462f4e3657f12c194971a0882f51dba24c0c2bf163ac63d29093e6ab703596acb1ea29dadb40f0dac2d681e7764e626aa4ff3eb3625359ff752322b8966491296966e61fc0fbcff84df89b50274027cb889f7c62a83c15d4aea87b42b3d946f97d6560f42af607b837b3e1ed443100d20cf48b60c4571799c0b3553a72a158b22b1ffd32c3b950504502709685d0630d6085185682a8faa0fa79306716e8691e89e91beacfba7bca15003aaba16633b9cfaa309d3f9e9d57289d605d97469fa89695a53cfb03f2b5c631f8983ead6c85584d74b67fb4843c10f5f3a7f461babf4196cf6bdae30cf1392255916d719db4489d9db1df8ee1336256748b2fea99a2c7ea5d69dd3200c42d6e6d53c12a6eedfe32c57827242f95f6707724df056f439bc23f2198fcdec3896081d432fab7bb6f651367382730b2a751d82594f5a4e98ca6bb0c63ae107c7ee41235c3b45ddcf814d573745ed357d7ca319469a8778589e19e07e69ddb94d57d9d97cba749f2357722f6bf0daf0142e596497b02aee4bc916a97e63e398eb3b4ce099429d91350a752e96814806e578780d2615dc006d4f3d76bf3fe3e3c3fab59055e10717e52627e66243d411b736dd40a0f3152ec4a841785bf6a285e76b9b682ac604d2c44c567cc6b74af2768fba8470310455ef9c758744178d0a399302e5b6b4de1f5959beeabb241ed9db6046fa36dc4808600183299c6060d110fc69405b14fb6069e76f78cd81709782365156c79d55b359419cb4adf326a4fdb0124d5411fc34b27ed75e07c73518f57b9cf02226849e6100314e717eb13d420c6dacec997928100e786e808eab38ab182d3eaef44f3c5726a0c2a7b26cd3b06b1d9a9193320950bd78fe8d666e2b45e2a63ee6b3e012613866a7a95014e9183ca0145c10f9766f4dcedd882b448ca176a9fd80536c3ffee679b8337b65f7e90166cfbbfbc945ad9465ebeb0cfa46e48e0c1cf0a9d7a6c0cf78b557604f88a4d7188b636ae3b5d0367e85ee2a92c54eb17f208ecd4e245f258c9c52033dba73a3da2a9008ba6ee2c40d633a78765ea9a463663e3bc0aa4b6e6d9f4c60313857beee9cd1c8554154cce9195626c87ca9008458771f9db2e5e4145bf09d64b0092a69c4d2b35eaeba3454c8ac5667524163934f1682b3f19ad8e8879d1d9083929477666f1d9c68bdfe215aeaf1a6012c28be212b51d317cbe5565811c3f2626cb88e768f4f2a19765789b61d278823d4f9e1f2e3b2321d07cdea83a8ed989680fb5c8d696bcec9dce448c774d8c1d8abc4d70366d2683865f218a0094377c4ae80cfc418a6a8f61721e21978b9276d6e95ea4e32856e0cffd76ea1e58fbce2fccc5867fda82653cc5d75d01dd9aeb35d05dca205fee09ff3bdd680c0971b98a33a0f9f46323dc13dbe75e2dcf78e2d7bc88eee6d85e91492fc8d6958fedecc63f6336701c2de7c2b3a173f89f5c8a96146a624ba41563cb83fec57bd38f666c96bfe88bc21a35182888e472e2928453fe8fb82387ec6bd15726564d39ff75a640d01239e13eb51c5905151234897e4dba0ec023b04a3cbae6d739b62de5831068bbece42bafc3a76a6c27a0d1f1f8fa691524741d9a3822bd4746d68ba8bf26cdd3f7224d479883fc0e2b6eaf1869821d8d9be96110e879059c65f4b979f7a19ca5c036c00e314284c192a6473b4fddc1e127e991d038297b9603bbc2a6d681c1ce635f1b328a0567b7ace60952562bef0d180ca885630ba8d80d4b59cad49f439e43fccc8a75f15ac29c237ce2c2fb52d624c887c93efdce520bc41f9843930824cc8506b5f50244a0bd4274dc0bc6301a709387045961d1c1d726c44374e02cb94fa87ad64f92197a03f9a5b79a6c9c78bb28a252e90564a6dad9b43d55b9063e27f315b6de257a0141efc84609b223f49859676952ac0b4bfa97cbeb7159e472d993d582be79b8ed3901667eb97737b39c13ebb9a7e3ad0a2119cf68a7bda7b03b2ce1629d207ab2380b9130cf0cec3898c9bd802f485cf2348e63007c3985ef5afebc4fe29dccdf8697621e3e9d5117e7b082090d2d91bdf9ffd0cf7f7470a00860358ebb3cfcfd0b9e928ac7fcf78e626e3009d4a74eb169e845998d2056d76bb3123dac796c46d7bb89cbf4c0b31c4340a696b9ef44e887e477e0562bf40489d1527b34300d6848e4696d598c22fea72039c0788b81f2244b4ea0be28edbe23610485099be7ef6346b6e524b75af97bcfa56ce7458ff6760312720e27387575c36b8c305488cf8b4be97557f59a534f12f19acd40b0d02236ed084408086d379376b9f14c0e7d5e9035309d7c71e416b0e3b9c6ea49fb07fbc1ee1dd113543aa03825979b69e126b76c966a90a44b7ef78307d8329015b9798e95688fcfc60ee89a0ec29510e1bc2c4264feee9723f80565b6156576d8fee4182c7818bc8f81f3aaa66c629358909edfa1d03ca9608f04c1ef96e3f6e0789007c4619f229b3365fbda1055fad7669a21e817664a44dd1aa75cf4c3a1de367e98b0cd8dac9e325802dcac80fe6dbb2e857cc1b1849fc5c14429979f6178f3d4d721292ecf0d009a45d737c612fdf1c39678d07878dcef2fc5e540e9ff9bba8d7c8e1b27dc1b6835e8114ffc297fa15537b47e18711504bb586e1c6d098718a6a050ba5b3d0bc9cabfc34adfaa91efbe77458362c8fee662d23097e5f141137b20cb764767455fce1c2f157319705217b910135a598d8adc06188754424eb795bf1ec45938e0e79e746d80e72e485fde5dd6bc37b7653fe7a70ff949edd35c4d78d6c9f49f74491c112146454e23318f5ab814df3cad8e0149c85c13cfe0017a6d86f9aadd8deec0f37889c6cc2acd41ee2e9655ef363556f075ac74e5c270b9e3602e425a66a1ad99b376e37eaa64515ebb87166f6f5abebfca30e5b21af1573711cdf76876496c549e8c9ffd3cac8faf93b4be39b27cde7ea5d6bc361953157d504b9ad3542e4b9bbed8990b3fa47e9294c9555177e6b8467910d1cabc9c6f642d63d25e9ff2cc82412ffbc7e723dcfe5a7fdbd9635a65f1219d21b60bde035864e107ca2f48a63c40d16b58848241554ac36d4aa9bb82261c6eb45b4603f1473e5fc9599dc500c6ebeff29ba9d9e46f25e55c640044f033ce1c6c3b8fe3ef979d90a95ddfda6026747ed99dd2cc360eaad84621d4e463deaa757d5b31b4a07eb2eb0effea04147ca87a3cb5c216d25ca19496c528a689e22aa896bae0b455392fc9f54d663ca93841a1f35c70b4626a34be8cc7276e414b9685038f5e5d1bc034642475beea5f8eada5818942ff14337124a53c31fd3d03fc8d922d34410121115841a353dbef104ff1ea266f5095d11ce78894cf0b7f76a8f412a81c90bf4ccaf09e819a428492d4455571baf192a1ff312748b865a618785f2cb84a030e8a7848d9722d3aceb0ed45c00cecae381e876d5464f4efd9855d465a951b03bd16789f14256c87ee1dfc34c3cd786f66ab7efec0afc721de408c304660a52a7d559284b0e08bf35e1c40684e565a6042dbf5d5a3bff4bf68aa51160109c39bfa7a4b2d5e647b12644968faf139696044e1d63d8c537be1a4e97714ee675ebd317388fa3444efefb57cecb1aa887a4a54c05445f46e123f6ef69a17c2489fb7f5d34bb057b37805b44187f466307c8faad39998647fc345bdec956f8d2f4ee53a2d3dc272d875a33eaceb915eb96eb54f8083fc58751c480d6131cea0a7227babb42c984c126efff4bd15c8899f82d5e41c14bc7dc025b68c966a97b86d32f6249790b19189447527438db1b488f93d0d3957cbb8e103fc49c2c330ee9f0d72b10f6383b813267415f36f94a3a1d0ce7184a47184819f2f10b41861fae584f9b5177a10c836358b541142a6f8f0de09598be87c38c7cf38fcb24a91d417756d6dab169d1d8fdcacac5638a788a3a3ee42c0d7254e8c507871dcb7fd0677d8adee07ff9cae602e27fd6dbcc6d41197d030fd846f671ba5ab242021086ed9eab414056655ba81d89cc1882c9392c4c06e588d980a17733882e8b2f9bc743118687b8e0d823276d2e0abad100d85df6d7609dc604a1f9da4db8af087fa1f6163b234135dd35391e3e5be41f7cfa4732efbd68b768d5af34406946ee11642ba296cdd18ece839165b22db7a3122dd44161b6ed73a7d424c80722a2e38b4965b5780f280870b71f2ed700d01f36aa20c9841112a7cea86a638763ae64f2c61ac76ac8b0eeac66409fc948395fdb5b822ebc6912f42512d993341cb141de0738c6e3a6ee3f8b8312c2f509d1e3c4ac849fa467baee7789d05ba9062dec2a504364f5bc0a53d06c7daf583de37032fac214889fec163a5ccb2fba7c3e2272906b71fc1b635c033c350299f97ffa19290928f3ae2d8dfa46419a02379b480294afc5315d84395971c73a1eae7891a724d01a69c4910c1607cc2882b769ded6a60950558c1b33a64f511508d4c39f8979876afc424fdc53098e56422056638eded40a94427ee269262914271d7ab751a53fac48d80bc350122f626e32c8ec2b17616baace79bc4d18622fdd53d8e416324776c6e9cd9bb722248b1b3fe982121d7944c90a8ff9bf7ee91ba5a3176f5c34939fc6e804135d66009a0905ea27bbe3eaef96b5e2bd47a526721e4bf87f0dda6e100a10de5ea10192834504daedabeb8b2d7a4ede5dc91aa3ab01e1e2f4ddb649be3fa0723703a6bdcb304367623e1a7048f85dc0028f4ff05e594cd6d7f0eb591d20abe8ae63d85acf91bbae6d9ec1a5caa25d4645566ab607bdb8cac3cd3b3ebb7f11aa7ef961d9218f95af4e687f66c405bba4e3547b3fd287626531e53f13e686b79d11cf5881aea9bed84e6918cfa77cc29580d76b6a65aab4e4a7c702815796d966ed60a0ff1154ea2659be96d3cb77c824e40b4e58357d545ebbc48be0c7c7e1ad01bbd011c52187aeaeb82533d6748026982b2931bb4d7a262ab631130969eb7ee03aad7f5f5d7df4e5aaf4754cc033fc85c8189dccc92b00fe74f90e4cf69e6913d042c899970df9f4c0f45f1b9a543d8c12e1ecf212dc55290189cf1f68cefb7a265ee44a699dfec0a1a73c13fb36b01f1798c4e5c32b03e90c29f0bfb024071f4b0e2fbee637fadd4343627361434ff93733fd3f2c3846c457835a7362e419f24c02ba39a81885a1a4b81ef1ff54bc6bdf0c6c3a3b9779ccbb64a628928ada56bad5ba21d9083613ecbdbd2f0b5ed17c327c403a28eae13722d28a61ed3bc00de334eb597176894b280411f92b8b45ef3e6275d3973f80e6fc02dc612706711131384c41a453063250f63346694678f3f2a162784712bd1110566de4e1ca1500c10edf8ea152f53f1681755f63aa4ce33ececb3224109139e0d2f9d0459fe64edc2d1959346c4638cfda4928a90d7fb7cc0dffbb5a85667d645672a13a18b218ff213840e108e232314a07797fbf6174c971c732ac8dd350cce0f5a1e14a2c2a4fc7a49e2752e40c73f0e5046e66e195455a848fe51000ff5d60708f9866133d2ec429642e2853982cfbefa691f432aa7b17f4a95050f44ceffb293a0903d26857f8c4dd593bdf667253505cc095d08f00fdacd3054fedc389ac842f6a59f230f9d345312a3b3abfbdbd8fe5e121ae6a6b955cc5833823c6f35c2bccfebf4d6b3b4f2da5d7e9fe4852f943fd0fc9ce1a13a0767265985c180bd4f2b849c1ae8ef106056386a296c5fccec1798a8d36816e4c08e42599b4b1e3b694a4a84ac655d5381cc4056e6d1dda8a0647b2806154bceda5b5a2cc338cbc6a4edc2dd4c9e39fe4e230d45cba12344deeb4f7b60b99a66b97737755b569c5161c12b08277e2e0531b46383e3a6445c452df7c35939dc527e95f38d9216e4f888fe36e89fe13b0d045fbf63449369cbd99595f79ba3db2e95de910666e9930a72b5a56fd477321c86520512ee1812ee3dbc091e41b6e3228fbb6844287ff7ddb0f3613aed91a97c4886b31b915f205cdbe479b1ca5b2082707a69c0bee66bfe51bd22e9e2d63246e528d2df0070a25701460a1deccc0e95ad54133d3a6fcd49dfe172bb0238ffbd87054692e94780d1b1ccac24a4266aee4882c95f1119dbaea4dd4861037d1ac3bcd42197e867f3fac5b4fe30b4d6d49607a563a766aa6692e94918404ce2140465af7418904d73adea156094d87b33d630c3ca3b9a2faf9435019f6f36b7f09e16d9ae97df29905d0fac666266ca73a2e33e07bf39a2e05c3f9abdb61e1406a2b8a258696242c4ba36bbe5f8abd4ac0262034d05e0deed000ff75fa7541b5196b8c150539f1601362b787a8a9728ba9cc35be6694181db938ce137384badb2a8815f0c80966b527288c6490971fb720ba2fb74c1cdb86da4528fd671669e8fb451e7cd7ff26619a135a98cb79a4795695b7c01a59988e2e7d27ed003bbaeafda5029a9d16ed4ef7428835996f679ba0fcdaf281f9a3d38f939bf18d5bae5484a6d9702f5568156380f2b4c522bdd32e4db496ea46e2a7f36a2f8f69e699735581e2f2947022af5488a10681432349ad7f16f51e6befc83aeb7a591cd046a7495e93e09555c1c6cb8af77251f79e7db08869f03b17225c7c9a233230881b031410d6a7f613dd872d5e531b042491cc74773217910373a46e104b5811a357234ba83faa628f2cd1c159278f0ca65fdcc682be3ef7faa18bab70418abce7d68c4faee51230e8e0b21ac76471dbf3015054fdf9ed45ecb9e91e9ab213d04655b6643ba1617e5bd8bef751f08e0d32ad2f041f4f91fd61d5c3c825375d69a66a29ae68a2ab71fe286a29483e9612d135d5a26188e353f7b772d3898c1d2af501c5c7475fdebd430f97ca4772445fb40f877be5a362bf5e96be6c2aea1cca4b8200fb0fe9609f9db70d2fa81a746ada0b24b6907c2678ca4c0fb4037a752a20941e00df859bf7d231fbd6460945dddaa84d1966e509793288f1037871dd2c7cf808aea19412dfa05ed0514c6b3169d1307622eadabc4fbde0f4417ebb5698356da0d7a07e126ecdefcccb9e737bb2c271a4155e2688a34c685019c244946a7f281c6eeca357310d8de06aef6fa46c35a7890a524f8a94036de16cf661a2662a52c03ba948da9ac826d4ce5cc99947cb70b629548522a948fdd5ccd4a55666e20bfc6e58a0b4406af2e39238d0a73053f380733a2b1d8df4fd78cf414691a74a908903426da028a8096c850142dd6642a303fd6b9fc16865665c2890e1549a206d0aaf2fb098e0ab05aab05d75fa41339a4b7dcb9ea0fff21d2dbc5884f78e5167831aeae2f0d138a2b79d328f26d90cfde805e09bc2cfc5d98d57b6e3565aeb15bc6b1ff0ada8300a952e5855220b5c85c8134fff32105572c398bc8da7598ce335bebc38987ae89e591d4f22f480edbe6e938fc7c1b2591257f742db33cc7fb072d62d94d177b01dcf35a9ca74508c42a41a3d32f2adc0dba28659f244ac8aaed2c8bdffb88054f4cf065db87e9f71be52b659db54537907b08684f1538e382b456c711c5ff74326d98a81f806f68e8060d4562e756bae15d5e08909ffa6453aa19948c999c3c0c1b0cef8e7f282d7a6c4299cccf9e01b6402aec23d171e0d47706830a78c763a84fca77ebd055b762a07b1054caa3b1d92107f86da923bbc36912231b872e2a6ac3bd808a118fdfae0e057b4d5ed0ba068e4208a29565c1ec6f92634a4c162a08408ada4cfaf10679e382ac210195e31347a0c9c161fb8c6c4087878ad3131b3ca1d322fd8f89ebea65a8f3e65c90fb7aeb943979ae7c11086b051660e64cad531a194d35874bf217713050ad6b55deea0ab3f53321d118ef72d31040f54ea1399d47be6d5bf20d6f694540b6634c5cc5f609655c6402b8b0beb9944b3ba7ef5ef6c2309230efde16c292727276d8f42f924657100502467afc891273659e048c0ce2e7839597bdf75c94fa5ecd9903aca3221a07c4c4232df8aa402975357f95fbe1d5177d369b06e452660c851c6061d684b4fb7390461cb6f362ed89858de178e82d2cad2a7fc947efe4d956c0093841a7c72b2847c6e86c8f60184cfd53ad4b04b660443018fa43189f254a65307cdc6607c49315fd3d05b94011df7214b833b1d9b6de8ded105b414bbfb7cab705fcb9a8e8d85679f8b30ca42903cfab948d7ec8db8ddc60b7206d77742479718a2097c40f412f191b053086e7d64c18426f0dcbe23bfd3fda3fad9fb85be6d2680684a53b284f538790041d3256b509d4aaaf43508e2a7453ea594ea9848f15cae6fa9499e728e4a6b2d7836547bf16d339c2e6eec62a28e4a03cde59339115dbf903b54ad299c6c80c568fab52a310e9a22a8906fa3df36ec091ad82cd7f770453a55e757f5b160a5d28972eb263f5edb76a2cea1805620b89193d9c13d2a97a7891234f7dd542463d8c2de7c3000a11eb3d5d384788f368e3c5c037ff5c800ba9834f8d8b33b435a0b0eff5967e67cb126d1fbd7c295d1ba84eff0c80ffab78fbba3666e5decf734888f4e6eabe4ef8dab575acf303e57bbb30d2194f7c0df0e312dfe99471bafd19e827115b95890e9180b60222226036b94d0aa36619f59407ab90905b90039527e50059d40392ea7849489dbf5f72dd639e11e005aff12764631fd449a4fca97bcc471df4fde3be0b9f5f6ecda40e4e9213e408274e99644d189b156411afc85c68cfc7e9ceb0ad64a6e4b902335977066dc6d0664d7f2b5522e55497d0731a5ae465e6afb2abffef263e0c362fa7c7c991650f073994ef2c58792859a84d15791e669ab22ec4868a72ba2f2b59087c691bb36ac709421d918442fd0b2851b48847c53eb19d280aa57014d30e5801720ead6f00c37e3bb8da9be8e5f55c9d71130e04d20f869b6cb3591338c4086a631fa6f86d3af786bc3ef05d4f411f628d179d792cc9d94a759be3c604de529aa4021809e10bdc9e64b46878e8aebcb2a2d0643772d73336db56eedd98caa856b3fd30b3563d15ef6d1a36f678a2d229dfd684e01808831b5092719d81d69ba2eb546fe051d9fd224e8cb90b2134380bcee342990835080e79c3bb457d4a2e651a7c3a658c5677fcfb1d77ddf1f18c3f07fa85aa7fb2db2bd918f7995d0def7143680c2f79febe46940934ad2be3d72b906db24f44797f54e857d67fb72af28e764ccdfa47f734e187255c50ad36e3a72a735dfc2f04e105cc5410a0f9afa4b21a153c4ef24905befa11daa24193619508782c3c4be45654199abe8d4b91b83ad441900faa06410f28f6b7796adcdef08a2419173fc9a86e03b6ffd8aa4fc1ad4210df6ff9958166d01dfa381b59216729f7d7511c76e4ce62f17e932ea41bbf62b4e9b1675cc8fd14fc44952576d060a9cf6db5f9afdc18ffee5aeea36ae45c10015935a5a564531b2a48fff6150e369d73f0b588f2febb465a6e6fed7a87270bd25d804f93e423940ee383aa43de587ae33ec609b21ea31c8fbdea83fa14642e9b5557e06347fee11775f142a165f9a926849ac2b202cc0ed1dc2b8d02cf064c23f69188de467cc9ba23303d53408b0911987d9dd144a3d63c5ef6cabf5dca6aa5e4df821011899d8e50c9b4d804b9b7b524906a7fea4748f4d8ae6980e9d73ecc794bf8b9bfac3e2beea2bec33d6fac48d978541191f217cc1492e25bc340f41f49fdf4f273f594123410446458a75a1412c0ab93fcc0827bde0bb835389a800d8eec4f5a10a96d168051fd9a56abf43e0ce00027488f86cee9e4c4aafaf97ea445e99045032f466eb137fd3e2834a812fad1e049f4aa7c72c7f6de33452c0823ad146e0496f4ef5fda8f30a3e592f2e484388119ff0957210699e9ddc2faac5672374dcd68786391022a82e248a0a6b4c1a94bf49dc05ae80c9ad5fc551730047106a2c16cefa6cfc3a27482ee6e1e3b440e8fbfbd28ca8ab99380ebe751d8489954daf868d0db1f5eb492a1593171b6a50ff2b36a8ff8b15e3834ed7b944d9f7934b4d5d646ab9b0f087db4a4181293d90311517aad4f1828c7ea95ba963717e852514f8d35664ac0fe275e386e14aa0794a7d73b0338429cd49ddd4b5303c21853bab4d65fa39e06c4bb66f953b59f6899de173017a0ef07addb5fd546162e3df7f957bd7da3b7f6299f98cc4412b31fc8ad725381dd1385f093aae490f09f678b1b049dc6c64a87216d15d24deb4944b966aa5cf5fc8ca2b28c60a6118a2f5d74eeb3d3b8c673d048141bf25a2c5b3e3516de4fc179937a2536bf6b5354e0cf1afe8ae3887164254a7a22f25bbe66eed23ce73734a580c2ff58f45bec809215f63ee05f999f16d94142aa471b2809ec462b9626536b941459218e32644273ee397d5953d1a59576e9954235fb483f04e9b93cf9ae4d7fd947b2d118d82427d98f71f6366a51e6173d4e8399daec08a0776a0d915ed033c0778fdd086c22daedc98f2390dd1814f9556f41d89287421a5d0cb471bceb8f406c10cd320871c8ce7c102b2d50b3af970010383bc1217d385b9c869a19c64b69b41e20a9b5b876462138985a0ded5457aab27f61f9d03c0b7d75f010caff04895aacc4ed973ca349cf592d4c9b58ed1602ea169c6dff75817698960aef7c4379447dec3d2307a85046d6cd2328794c130bb2a92f70b966eabb657d3868abf25a599e1a361fb011fc6dcb4fbec8f0921e5fc2a3d743ceed9276e1a6d31922603b40d7e0f383b60c1fbc487d85054a98a3acacb1827b1137c15317181f2ce66698069f5c9590ff6d0ac95820310f868d6e7508795149ae4db9d151b0e29f2e20bc2a0caeeb317cbd930b4ffbde3f2b1fda7b968910739b4752083f6aea2be2cfdecd4303dbb2503505fdd17d19e07a80e23e7ad7ee680c9bb7d6038a10e73e228ae48f7b3e6428be864fd66af685a3aa06becc05bf88b42437d31394aa6bb8767e209f3be790f17a06050bcb6016571ed85cdcb0a24ca93abc6529edd17038e0e0617f90a9e4722867a8cca2778dd87b55bcf07053b44dfe18230a0f85a6801fa1f1ff158dd932de9b2e5dcdb0e96545bb04de8046fed5819ddd35ca9cb6bae7c6a8278325a95756bb7f06880cd6f33d56a1ae53923f5236826c100303caf1ba763bb681a63ad40a26975a4568aff567cf9f9c7cd623398d2672a6dce64539d634572f5bd5ec0b33a3369847fda7660072c5ff7d7e89555fbc6ec9b9f2f9d750bf6f0eee63a8d3590379b7a4f39ae289b5ccaf4be3c2857da10d9d9cd66b6205ca2e10a106fe905c6e944a976aceed7b08ecbff80271d5744e34ce30746425b30f65bd3b1c3206f0cf334b94c635de2904c7a4ab185ebcd024bc8861c12283467eb7d038f16fd7cb8994223e4044d1b3d1842700e0940f9fcff5dfda40869f1d34b26d7e1b6e848fad6b0e19a2aec81ca71d6c55a0d0b999f45bbb399a4d19ab90b82d1ea3ee34d9e1f6a76c9aa45102aaf242cb889970853106a0bfdb99c9615a98d6d36c4fb4a72462eaa279f113a5c3a5d181167d1e2faaeb5e004af75bc7e3b1233b22d3d7665bc89fb15314df7849ef9a959d7e8c76b2b2bf086ecd18415ff65b4d81a83e50cd4ce69c40926042ff42772b126209c4dd6c4dba57d8999f192271a14e883b32bab45afc95e1e5026c8766bcc040742261cc2a8f7c967b696eb672eeba11eb8b8464aaa06147062c5ba679aed31c161a12ea9684efe06f05a1e669789e346ea9a7f6f4d8b1e888d8652741ee3ed1866394e58c6f7d342c9088de425950e302b43ae7f8e375c16694956432f8ecfaf2bccc79b6a17159e26a58b14efd74c8f8491444bc9ed37b93a8a3c94b7c48da93c74d808174cab781d0fa4aa4be18f6bdd87575d7d0f9eadf893d30053414a297ea9931f1180f86ec81d24595eadd8ea1d2fbe141068e48f1ab0225238baa2c76979b34e322ac2b525f9e6ba9f774c2e89362f85574e13585a122dcc3c486d8cfae87d6aa70980641116e918a55eb343293b473fcc042628f29f06351265808bfd0956f62737f8dd209e1c106040ab6bfe5b43de9258a4b14307dc242f67e0c3f89f9d204cf4edc4e4a7d1ea125bd8230594fba6e04a675b7f35bdfcf51716fce375e5758eea66d473aaad4e41a7d479dec90fc1d74cac9b433fa568392521aece760d7de2d698be19b2284392408c2649b11b7a46f9809c3c35f05b8fef360e28d116afd03820a5a7feec86def4df68dd198ee2a4956ee8abada775c6e82bb417a64720b9f5dc40257ed5778199f385c42909f15cf82285bb51827e88461f8e0673263d3d985e06a76f35766cf65014644af74a70a372dda42ffd28c0bd444113715be552fad6427e2521824f40bd059b9bff9d5bf9e49323bd7e92262570c70229a8845f58cbc02926d7fe314a2390cb52b71e42fc51ad31a5973c194f5e579d5a203532fa9b696086f0062061feb607a3258495040e85690ad7e0408958becaf6be9a717fd1f1756159688ef742a27f3e2efb4275db0e305635d73b1ae1cce88558e47762521d99d82ac4cab8977b37b94f08091327d0c9a9d4b3e9054a900ba6dd5812d9c9de7a04c18106a70c137ae7c500f310372b3cb1653b132a911b67b8ccb89498ebfb89c5b82fd33aeae3998019ea4545c5584d9199e3ecc65adee9598a1ff4b02cbff8fb92993459555802d66348a5cce699eca10dccb5eeb64496880243890a7f7d5481d30ad9783f74cc378cec00a97a7eb8a04c32ecb97db5124c647f4c047f04f5ac0a73459696ac200e2556235a2bf18bbea72b707d5674aad25b1eb1083937712ad8480d90c068bb5d4b650662d92b1d8cd3224941e3567fbb8b417828f73958adce348195bc78701bd6ef557a56183fa1992385affc56c84504571487d5a6b1b97498ba8066be56fc7a57410e76fdc25bb9d2b29fb675be48a107cd46650f544e61d0ed42945bfea07cc8144fff79293b0a36b180c78b22c3d1be51d4b948d76a1b2c3d48a0d99418dfe80c496829c5503ddf4e049b40231f8719980be2a57b199ee7872161d9b23be428aad8c6da243b0da1cfc2cf8a37f5f12f464c5a6c164116bd26d67a2201828aa798fc43470bce0bff5725d61127f6a651d89860afd972df8453ee92a452f36823e4363aecfc02d332d0c9c742fca1408046a513997541aab4df1b39271b10fbd0017f71e7625cebc808422752dee32167aeb376cb196236c738abbef5c7c383990f6adec8c0db094b66ce04c4424fe2ef097c9d5271187c49a162eb2fc4920fdc1b288d9817b14b72e2852e0bd597ffedcb0142913a59b916bf63d9069d30fb88875c6b251b7e5b9a952c9f03a05fa86281d9578e6f03fbd07ab59028a6d3a50c29d325b77a764f5742cd8c7694486b130a449a8a660a3b332a7d26435b5e51e1bf452dc7e7507e46206618581afbe3a09ddce7a9d851b64f884707d35478fd7f5725ea0c8809855727e3658317955d71516db17fed7e4d57c402ce30601b9935a77839d797e62a0c3f67cb331dad6006962fd1e14e5dc57a85be92cc06477dc3a9d978a5458f5de74400591239c813ae456604f67d0f691acf29424f4cbe073c0b7f5519bfc4a8bd68598c986b2c82053a670608b9a0d0c04cff32a1a5993114cc4d60bd9ff219facbff37e51cd64e2f0b288fe504f7cf5b63a943b6aa4804e949cce351060c4db16858239b41aad4398e2951e17e9c28db68219bc73450794e77ab0034fb7c24a8f89631e8db7782a74901668a50bd11a083ae743fcc2b2c9092b1b203bb1de7610b64826f081d54614dcf725b1b33e96d2e3eb068a0e3789bf1180cae0acda57deb0c6862f39b9bb1c0103c1dbff46593dbb89751f7d1637a9987a0d2aa7242b1f25c1bc25af55440c6d9a99c702e2cac592d29d0cab277c8008b68253330eb7c2b0878d084a2ca2502fcecc23e231784966f21004b5a2a43d4c641f4de6ae14ea6f13eebbd99b8262f6c8c8d3f087cc627753eae8aa8e52d2790b0e3f174f1e147915c810a029fc9a697a92b02e334ff8e9d40cf56953c9e0b65957031a72789740ee38663e50cbf087f8325bcd7e216b3e206fa401da5c78475ea230d50708f3db367a74fcfc6910932a5321f5c36acac71219aedd15b90b0a7f81dfdf2cb047a509e73dfe8ba841284a43d4152fa19ba511622a02d485c1516cd1f165d29810a38a8d5160d0dba0a4ab3e80f33b8769619150cb566587308f0b4f5eac35ad28f7a2f3a70991ba919e4ae2dd5d2c652016afa7ef37bc291dc375a0c0d5761dd3c9d074e96da1e1df4ef69efc05cfb10251598f737397bd2c1c475a268a80945013f07cb3b1e0d184bfc8668424006cb34f7bc04e4beb0dd03e3d19a9f9389b2918413d96ab2fc103e41e2413b602674e1a1e99a1aa9e3ad404decb51c8acaac53edfa97e984cac4da3c11eece6158cdbf838a6581af91dd7e07c24c373bc7f02176afe343c0db62b79cc122e32d7916eea1b1a3088a0126975e428e2c00fce2110f671a399fab17af47a1020e29d46870a0523aa3e371f82f82552e3b4233304c298c51758e3cad695b807fd807729b53b447a8afef751468e6fb08e1164ce970a6bbefd0318dabe4ac6a7ec01da36ccfb150f88f3f21ebc2e9b8cc7fcdaf9b272f7cf7546f287db058490eb514769955bda076f60912f27ecb423e75a7ca88619adf20fcb13148a3d0cf39fe79ada3a9c0b0a975e1a92f65ccd1b9a059ddde43309bdffd6bf39c386864508851faa708760fa9a141e4be84cd599fcc132be8947f91ae6d74aea4ab8001d355e1abd077ca2d40ec82fb161e3608722f6501f9e0442dfc89ca1356909c5c94fc63e4f44bd37c01934c7ef4c3646bff316e5fd3dd54403adbbae1ce7f1e354eb2261eaae45932ac355415eb13fcf37c7e7011037b7e58b7445442169db3764b2f2fb7d8b4c71a1e0cbf617092b2693ccdf2c13b8d65a1d36419294ce8a3da91fcfc43981be7de980d3162d2613730cf4399f1244e249727842d4bc98395480e8ac607c2d3119b5424252544db45b971151d83dd5e2f0c06793f5bfedb69d84477fcd612fd662e636484f06b0bc7d16c28609ce97c58b7cc06beb632db6cff7f15f3c6ab8238b1d1c99aeab048104e847f66cda50cb3d4ed7dd5b1bb893418f1a995a17cb7456d62755c222943f265aa2bd1a47bb20b032bf9517fccd5b9da19a7c0b7eba2b9ae5e1125f29875de614d13f1494e9aeae5188b791b66fdb11e5f14203b66b214eba548d61aec7e016c766522b741b002b4efe442240a815eadcb65db3a685e0918436f69206c76793d9d97b818525cd315955ea03fbb379d81896ace48d354e562f44930dc35d1c65b48929ca848a11484e7519a5cd5ede279c84980264252f0af95e6b1de455474861212b6f046df5d67c4e887955265fb04868dc45376e17c56c319b43f8ec9b675cff44cc5fa7f5d066eccfc440b33f27213580c58b8ea771090bdf570ced7720131435cd358153c7dfae1b264321e1a56ae1fdab01cfa33aa1c4118b22c8d53e95b679cf78b042316c5654f8d8c33d350461c39f97273b0cb6998cf5a09b6c0179476f15e36473b144f43099afed514283f2f66cc1d9ff1489478a9d34f75ab551de2175f39a9d0f6c0a5d55ce7fbe82cd069d937299a6ca3bdd2054406b72867dc05deb81dff113b0f5170fb01149fc85c97f98f2b2f733edf57d1265c8a88059f73f01a454dca5037fceacb9d3841abe0cc17ba6fdaf6293241c1494f2e4ab90261eb7105a9f0e96e839cc00a628be9b496911e839f316c3d02e87845938232c0baea72888b828c5609e82d0a5ef49926ca6084bc003df9e38be8bde0d1353602129349dbade02459994aef2fa10e78119ceced5f4618efc061d8a8c49ea6f338c6db15f7edf2d58922481073bab9c7641c04a1f8d42a37f0ffd47d55fa23c3eaecdba1d1bb1b89f194c6e0158d9dbfeb897cca32d5bf92060ec2adce99431d950f7a0243aacb35faef143626aaa77598a0768ba5895b6eb281e15f463cbad6bc0329960fa8726e67c12c0c96ae33b65d40fcb7725ae72d2d02ceaaa055d83493a31f28ec47fa69ba25334f1934892d13e38aadfb95d54d87d2cb1e680dbe3c81f5884ebb0a4171c23db6e72d61bae1e8bc06f7d6e98fccf9fc621269251847ad337813b7d660e7c202559b9e9e2cc83ad54829b8fce1f15e4b76bf803f219564c574f9ee88ae3b2e41e3cee2e6cca59eed6c9b87c9932a70cc69a0371b31d1d4ec78efb7f6c8a083737ca6b02bb3b99cd710de7678efe841a7838bfc599e46eeccc432ccfca3735db9af25f015e7b678236bfffe8d26fe9de30d35d6dd1ec1e96dbca5f96c8f347f0df1f3ebb1daaa11010ecf6b3dcdb4e57f67995f87db2bf18eda042cc7025a3ace7a429d21188e051679833553d60e8a1dfa5629968f2909d90796bd00ffbd2a3bf7c0e80466179011c63c792a90ec264cf41c231a6f2bfd6c1b17edf6197a19fe043a7e1717b2ea20833ff87fd6b1529877a6053494a913343f9b45b1ecc908eaef6b4ea21e41da813ff06e7220f9caf8f530594721c420160ae589ca2fa09500aeaded225f77db2d0cca2154389e8fad27bd2e60a194e95911a8198511d570b46e0a5da7a1d31a41a4dc982797c3938ed8a833ec169a5d32fa721840f84e439e5770770a1b9ffc59f812d0c918b37938cac6932705dc40f523b10aea19c109b38c8c41ab787078aeb8036a2d93fd329f954f38170a59317fa37d0244970fb86810acad4f12a12b07d995d057455e9cd7709021dfc8cc4fc219b61f5e8ec36aeb547491fcb333cf0529a043994f8963e8c3c63f3c09c902a15bfa93769de45ba4b924da031c54b8f56c3a320b005af3f9496597634b03675560459c5d199b7d00bf707f3381f0ba1d28972c69f1fc2b3e5d024a6dbba0a53211289903d58e89a1f1845493c32b5f18f659ed719760b1fd750b5c5a9f3398e2c395f22a65983a6188c921de647233d0de9ed289d1f4d5fda94de3c71cb63b37e1b01a38b5ba351de3e6987bee48c0a8edf80f11cb1ec449cc9e022b6d8b866e27cd096d7178c8c61c8fefdfdd3cd15def06b581c15949fbc90d09eedd9ea138c7f535f7f305c0a164b76b15077ede87bcf3a60f2334065076d9ced2100a22df39462385039788</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsè¿ç»´ç¯‡</title>
    <url>/2019/10/22/jenkins%E8%BF%90%E7%BB%B4%E7%AF%87/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="jenkins-å¯è§†åŒ–æ„å»º"><a href="#jenkins-å¯è§†åŒ–æ„å»º" class="headerlink" title="jenkins å¯è§†åŒ–æ„å»º"></a>jenkins å¯è§†åŒ–æ„å»º</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ä¹‹å‰é‡åˆ°è¿‡å¼€å‘æäº¤ä»£ç åï¼Œå®Œå…¨ä¸ç®¡æäº¤çš„ä»£ç æ˜¯å¦å‘å¸ƒæˆåŠŸï¼ŒåŠæ—¶åæ¥åŠ å…¥äº†ä¼ä¸šå¾®ä¿¡çš„å‘Šè­¦æœºåˆ¶ï¼Œä½†æ˜¯ä¾ç„¶æœ‰äººä¸ä¼šå»å…³æ³¨è¿™ä¸ªã€‚<a id="more"></a> åªæœ‰åœ¨æµ‹è¯•äººå‘˜åœ¨åé¦ˆxxxä½ çš„ä»£ç æäº¤äº†æ²¡æœ‰ï¼Œè¿™æ—¶å€™ç ”å‘äººå‘˜æ‰å›å»çœ‹ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªè§¦å‘æ„å»ºå¤±è´¥äº†ï¼Œæ‘†åœ¨é‚£é‡Œå¾ˆä¹…ï¼Œå¦‚æœ‰ä¸‹ä¸€ä¸ªå¼€å‘äººå‘˜è¦å¯¹è¿™ä¸ªå·¥ç¨‹ä¿®æ”¹æäº¤çš„æ—¶å€™å‘ç°è¿‡ä¸äº†ï¼Œè¿™æ—¶å€™å†æ¥è§£å†³ï¼Œæˆæœ¬å°±æœ‰ç‚¹å¤§ã€‚è¿™é‡Œå¯ä»¥å€ŸåŠ©çœ‹æ¿çš„å½¢å¼è®©ç ”å‘äººå‘˜å¯ä»¥éšæ—¶å…³æ³¨åˆ°è‡ªå·±çš„æäº¤çš„å·¥ç¨‹ï¼Œç»“åˆå‘Šè­¦æ¥åšï¼Œæ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚</p><h4 id="æ’ä»¶å®‰è£…"><a href="#æ’ä»¶å®‰è£…" class="headerlink" title="æ’ä»¶å®‰è£…"></a>æ’ä»¶å®‰è£…</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®‰è£…Build Monitor View æ’ä»¶ï¼Œç„¶ååœ¨ä¸»é¡µé¢æ·»åŠ <code>+</code>ä¸€ä¸ªè§†å›¾<br><img src="https://img.xxlaila.cn/1571707794737.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥æ ¹æ®jobçš„ç±»å‹æˆ–è€…æ ¹æ®è‡ªå·±çš„æ¡ä»¶è¿›è¡Œ<a href="https://xxlaila.github.io/2019/08/09/jenkins-job%E7%AE%A1%E7%90%86/" target="_blank" rel="noopener">è¿‡æ»¤job</a>æ¥ç”Ÿæˆçœ‹æ¿ã€‚</p><ul><li>Build Monitor - View Settings: æ ¹æ®jobçš„ä¸€äº›çŠ¶æ€æ¥è¿›è¡Œæ’åº<br><img src="https://img.xxlaila.cn/1571708048469.jpg" alt="img"></li></ul><h3 id="jenkins-ç›‘æ§"><a href="#jenkins-ç›‘æ§" class="headerlink" title="jenkins ç›‘æ§"></a>jenkins ç›‘æ§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰æ—¶å€™æˆ‘ä»¬æ²¡æœ‰ç›‘æ§ï¼Œä½†æ˜¯æœ‰æ—¶å€™éœ€è¦çœ‹çœ‹jenkinsçš„ä¸€äº›ç›‘æ§ä¿¡æ¯ï¼Œå¦‚ï¼šå†…å­˜ã€cpuã€ç³»ç»Ÿè´Ÿå€ºã€httpå“åº”æ—¶é—´ã€ç³»ç»Ÿè¿›ç¨‹æ•°ã€çº¿ç¨‹æ•°ç­‰ï¼Œæœ‰æ‡’å¾—å®‰è£…ç›‘æ§ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å€ŸåŠ©jenkinsè‡ªå¸¦çš„ä¸€ä¸ªæ’ä»¶<code>Monitoring</code>ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ’ä»¶å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç³»ç»Ÿç®¡ç†èœå•ä¸‹é¢çœ‹åˆ°<code>Monitoring of Jenkins master</code><br><img src="https://img.xxlaila.cn/1571708499625.jpg" alt="img"></p><p>ç‚¹å‡»è¿›å…¥ä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571708561404.jpg" alt="img"><br>é¡µé¢æ˜¾ç¤ºä¹±ç ï¼Œè¿™ä¸ªå¯ä»¥è‡ªå·±googleè§£å†³</p><h3 id="Build-Trigger-Badge"><a href="#Build-Trigger-Badge" class="headerlink" title="Build Trigger Badge"></a>Build Trigger Badge</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ­¤æ’ä»¶ç›´æ¥åœ¨æ„å»ºå†å²è®°å½•ä¸­æ˜¾ç¤ºä»£è¡¨æ„å»ºåŸå› çš„å›¾æ ‡ã€‚å®ƒå¯ä»¥è®©æ‚¨å¿«é€ŸçŸ¥é“æ˜¯å“ªä¸ªåŸå› è§¦å‘äº†æ„å»ºã€‚å¦‚æœæ²¡æœ‰æ­¤æ’ä»¶ï¼Œæ‚¨æœ‰æ—¶å¯èƒ½ä¼šæƒ³çŸ¥é“æ˜¯ä»€ä¹ˆè§¦å‘äº†æ„å»ºå†å²ä¸­æ˜¾ç¤ºçš„&gt;&gt;ç‰¹å®šæ„å»ºã€‚è¦çŸ¥é“è¿™ä¸€ç‚¹ï¼Œæ‚¨å¿…é¡»å•ç‹¬æ‰“å¼€æ¯ä¸ªé“¾æ¥ï¼Œè¿™å¯èƒ½å¾ˆéº»çƒ¦ã€‚<br><img src="https://img.xxlaila.cn/1572059619062.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>pipelineè¯­æ³•</title>
    <url>/2019/10/21/pipeline%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ€è¿‘åœ¨æµ‹è¯•k8sä¸Šçš„ci/cdï¼Œä¹‹å‰çš„ci/cdå…¶å®ä¹Ÿèƒ½æ»¡è¶³ç›®å‰å…ˆä¸šåŠ¡çš„éœ€æ±‚ï¼Œä½†æ˜¯æƒ³å°è¯•æ”¹è¿›ä¸€ä¸‹ï¼Œä¼˜åŒ–ä»¥å‰çš„jobï¼Œå¸Œæœ›åœ¨ç™»å½•ciçš„æ—¶å€™æ›´åŠ çš„ç®€æ´ï¼Œ<a id="more"></a> è€Œä¸”æŸ¥æ‰¾jobçš„æ—¶å€™ï¼Œç‚¹å‡»ä¸€ä¸ªjobå°±èƒ½æŸ¥çœ‹å®Œæ•´çš„ä¿¡æ¯ï¼Œä¸éœ€è¦jobä¹‹é—´çš„æ¥å›åˆ‡æ¢ï¼Œç­‰ç­‰å„ç§ç†ç”±ï¼ŒğŸ˜ğŸ˜ã€‚è¿™é‡Œä½¿ç”¨jenkins pipelineï¼Œèµ·åˆæµ‹è¯•çš„æ—¶å€™ä½¿ç”¨pipelineï¼Œæ²¡é—®é¢˜ä»¥åï¼Œä½¿ç”¨jenkinsfileã€‚</p><h3 id="pipeline-å¸¸ç”¨ä»‹ç»"><a href="#pipeline-å¸¸ç”¨ä»‹ç»" class="headerlink" title="pipeline å¸¸ç”¨ä»‹ç»"></a>pipeline å¸¸ç”¨ä»‹ç»</h3><h4 id="æ¸…ç†å†å²build"><a href="#æ¸…ç†å†å²build" class="headerlink" title="æ¸…ç†å†å²build"></a>æ¸…ç†å†å²build</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ™®é€šjobçš„æ—¶å€™æ¸…ç†å’Œä¿ç•™å†å²jobçš„build å¾ˆç®€å•ï¼Œå‹¾å‹¾å°±å¯ä»¥å•¦ï¼Œä½†æ˜¯pipelineå°±çš„ä½¿ç”¨ä¸€ä¸‹æ–¹å¼ï¼Œè€Œä¸”è¿˜çš„å†™åœ¨æœ€å‰é¢ï¼Œä¸ç„¶è¯†åˆ«ä¸äº†ï¼Œä¼šæŠ¥é”™çš„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        buildDiscarder(logRotar(numToKeepStr: <span class="string">'8'</span>))</span><br><span class="line">        disableConcurrentBuilds()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>buildDiscarder: ä¿æŒæ„å»ºçš„æœ€å¤§ä¸ªæ•°</li><li>disableConcurrentBuilds: ç¦æ­¢å¹¶å‘æ„å»º</li></ul><p>è¯¦ç»†å‚æ•°:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">buildDiscarder(logRotator(numToKeepStr: <span class="string">'8'</span>, artifactNumToKeepStr: <span class="string">'8'</span>, daysToKeepStr: <span class="string">'8'</span>, artifactDaysToKeepStr: <span class="string">'7'</span>))</span><br></pre></td></tr></table></figure><ul><li>artifactDaysToKeepStr: å‘å¸ƒåŒ…ä¿ç•™å¤©æ•°</li><li>artifactNumToKeepStr: å‘å¸ƒåŒ…æœ€å¤§ä¿ç•™#ä¸ªæ„å»º</li><li>daysToKeepStr: ä¿æŒæ„å»ºçš„å¤©æ•°</li><li>numToKeepStr: ä¿æŒæ„å»ºçš„æœ€å¤§ä¸ªæ•°</li></ul><h4 id="gitlabäº‹ä»¶è§¦å‘"><a href="#gitlabäº‹ä»¶è§¦å‘" class="headerlink" title="gitlabäº‹ä»¶è§¦å‘"></a>gitlabäº‹ä»¶è§¦å‘</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰çš„æˆ‘ä»¬çš„ci/cdéƒ½æ˜¯å¼€å‘æäº¤åˆ°æŸä¸€ä¸ªåˆ†æ”¯ï¼Œç„¶åjenkinsä¼šè‡ªåŠ¨è§¦å‘ç¼–è¯‘ã€å‘å¸ƒï¼Œè€Œä¸”é…ç½®è¿™ä¸ªæ­¥éª¤ä¹Ÿéœ€è¦å¥½å‡ æ­¥æ‰èƒ½å®ç°ï¼Œä½†åœ¨pipelineä¸­ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç å½¢å¼æœ€è¿™ç§è§¦å‘å™¨(å‹¾å­)è¿›è¡Œé…ç½®ã€‚è¿™æ ·è®©æ¯ä¸ªé¡¹ç›®éƒ½å’Œjenkinsè¿›è¡Œè€¦åˆï¼›è¿ç»´äººå‘˜åªéœ€è¦ä¸“æ³¨çš„ç»´æŠ¤Jenkinsfileï¼Œåˆ›å»ºå¯¹åº”çš„é¡¹ç›®å³å¯ã€‚gitlabè§¦å‘jenkinsçš„æ„å»ºéœ€è¦ä¾èµ–Gitlabæ’ä»¶ã€‚è¿™é‡Œéœ€è¦è‡ªè¡Œå®‰è£…</p><ul><li><p>æ¥å—å›ºå®šçš„åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">        gitlab(triggersOnPush: <span class="literal">true</span>,</span><br><span class="line">              triggersOnMergeRequest: <span class="literal">true</span>,</span><br><span class="line">              branchFilterType: <span class="string">"NameBasedFilter"</span>,</span><br><span class="line">              includeBranchesSpec: <span class="string">"dev,test,master"</span>,</span><br><span class="line">              secretToken: <span class="string">"<span class="variable">$&#123;env.git_token&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>triggerOnPush: å½“Gitlabè§¦å‘pushäº‹ä»¶æ—¶ï¼Œæ˜¯å¦æ‰§è¡Œæ„å»º</p></li><li><p>triggerOnMergeRequest: å½“Gitlabè§¦å‘mergeRequestäº‹ä»¶æ—¶ï¼Œæ˜¯å¦æ‰§è¡Œæ„å»º</p></li><li><p>branchFilterType: åªæœ‰ç¬¦åˆæ¡ä»¶çš„åˆ†æ”¯æ‰ä¼šè§¦å‘æ„å»ºï¼Œå¿…é€‰ï¼Œå¦åˆ™æ— æ³•å®ç°è§¦å‘ã€‚</p><ul><li>All: æ‰€æœ‰åˆ†æ”¯</li><li>NameBasedFilter: åŸºäºåˆ†æ”¯åè¿›è¡Œè¿‡æ»¤ï¼Œå¤šä¸ªåˆ†æ”¯åä½¿ç”¨é€—å·åˆ†éš”<ul><li>includeBranchesSpec: åŸºäºbranchFilterTypeå€¼ï¼Œè¾“å…¥æœŸæœ›åŒ…æ‹¬çš„åˆ†æ”¯çš„è§„åˆ™</li><li>excludeBranchesSpec: åŸºäºbranchFilterTypeå€¼ï¼Œè¾“å…¥æœŸæœ›æ’é™¤çš„åˆ†æ”¯çš„è§„åˆ™</li></ul></li><li>RegexBasedFilter: åŸºäºæ­£åˆ™è¡¨è¾¾å¼å¯¹åˆ†æ”¯åè¿›è¡Œè¿‡æ»¤<ul><li>sourceBranchRegex: å®šä¹‰æœŸæœ›çš„é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼é™åˆ¶çš„åˆ†æ”¯è§„åˆ™</li></ul></li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰€ä»¥åˆ†æ”¯ä¸é˜è¿°ï¼Œå…¶ä»–çš„ä¸¤ä¸ªé€‰é¡¹æ˜¯æœ€å®ç”¨çš„ï¼Œæˆ‘ä»¬åœ¨æ­£å¼ä½¿ç”¨çš„æ—¶å€™ä¸€å®šä¼šç”¨åˆ°è¿™ä¸ªï¼Œä¸Šé¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªæ¥å—å›ºå®šçš„å‡ ä¸ªåˆ†æ”¯</p><ul><li>åŒ¹é…çš„æ–¹å¼<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">        gitlab(triggersOnPush: <span class="literal">true</span>,</span><br><span class="line">              triggersOnMergeRequest: <span class="literal">true</span>,</span><br><span class="line">              branchFilterType: <span class="string">"RegexBasedFilter"</span>,</span><br><span class="line">              sourceBranchRegex: <span class="string">"dev.*"</span>,</span><br><span class="line">              secretToken: <span class="string">"<span class="variable">$&#123;env.git_token&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œçš„git_tokenéœ€è¦åœ¨jenkinsçš„å…¨å±€å˜é‡é‡Œé¢æ·»åŠ ä¸€ä¸ª<code>Environment variables</code>å¯¹åº”çš„ä¸€ä¸ªé”®å€¼å³å¯ã€‚</p><p><strong>æ³¨</strong>: æ‰€æœ‰çš„è§¦å‘å™¨éƒ½éœ€è¦å…ˆæ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ï¼Œè®©jenkinså®¶åœ¨å…¶ä¸­çš„é…ç½®ï¼Œå¯¹åº”çš„æŒ‡ä»¤æ‰ä¼šç”Ÿæ•ˆã€‚</p><ul><li><p>jenkins éªŒè¯<br><img src="https://img.xxlaila.cn/1571644117201.jpg" alt="img"></p></li><li><p>gitlabéªŒè¯<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éœ€è¦å°†é¡¹ç›®å›è°ƒåœ°å€å†™å…¥åˆ°Gitlabé’©å­å½“ä¸­æ‰å¯ä»¥ã€‚ç»è¿‡æµ‹è¯•ä¸€ä¸ªpipelineçš„jobå¯ä»¥ç®¡ç†å¤šä¸ªåˆ†æ”¯çš„è§¦å‘ï¼Œé¿å…ä¹‹å‰çš„æ¯ä¸€ä¸ªåˆ†æ”¯çš„jobè¿›è¡Œè§¦å‘ã€‚</p></li></ul><h4 id="parameters-æ¨¡å—"><a href="#parameters-æ¨¡å—" class="headerlink" title="parameters æ¨¡å—"></a>parameters æ¨¡å—</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥æ¨¡å—éœ€è¦å®‰è£…ï¼ŒparametersæŒ‡ä»¤æä¾›ç”¨æˆ·åœ¨è§¦å‘Pipelineæ—¶åº”æä¾›çš„å‚æ•°åˆ—è¡¨ã€‚è¿™äº›ç”¨æˆ·æŒ‡å®šçš„å‚æ•°çš„å€¼é€šè¿‡è¯¥paramså¯¹è±¡å¯ç”¨äºPipelineæ­¥éª¤ã€‚ç ”å‘ç»å¸¸ä¼šæœ‰æ‰“å‡ºä¸€ä¸ªç‰¹æ€§åˆ†æ”¯ï¼Œè¿™ä¸ªåˆ†æ”¯ç”¨äºhotfixï¼Œè¿™ä¸ªæ—¶å€™å°±è¦ç»™ç ”å‘æäº¤ä¸€ä¸ªå¯ä»¥é€‰æ‹©çš„åˆ†æ”¯ï¼Œç„¶ä»–ä»¬å»éƒ¨ç½²åˆ°å¯¹åº”çš„ç¯å¢ƒã€‚</p><ul><li><p>å­—ç¬¦ä¸²å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥åœ¨Jenkins UIä¸Šè¾“å…¥å­—ç¬¦ä¸²ï¼Œå¸¸è§ä½¿ç”¨è¿™ä¸ªå‚æ•°çš„åœºæ™¯æœ‰ï¼Œç”¨æˆ·åï¼Œæ”¶ä»¶äººé‚®ç®±ï¼Œæ–‡ä»¶ç½‘ç»œè·¯å¾„ï¼Œä¸»æœºåç§°çš„æˆ–è€…urlç­‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    string(name: <span class="string">'DEPLOY_ENV'</span>, defaultValue: <span class="string">'staging'</span>, description: <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¸ƒå°”å€¼å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå¸ƒå°”ç±»å‹å‚æ•°ï¼Œç”¨æˆ·å¯ä»¥åœ¨Jenkins UIä¸Šé€‰æ‹©æ˜¯è¿˜æ˜¯å¦ï¼Œé€‰æ‹©æ˜¯è¡¨ç¤ºä»£ç ä¼šæ‰§è¡Œè¿™éƒ¨åˆ†ï¼Œå¦‚æœé€‰æ‹©å¦ï¼Œä¼šè·³è¿‡è¿™éƒ¨åˆ†ã€‚ä¸€èˆ¬éœ€è¦ä½¿ç”¨å¸ƒå°”å€¼çš„åœºæ™¯æœ‰ï¼Œæ‰§è¡Œä¸€äº›ç‰¹å®šé›†æˆçš„è„šæœ¬æˆ–åˆ™å·¥ä½œï¼Œæˆ–è€…äº‹åæ¸…é™¤ç¯å¢ƒï¼Œä¾‹å¦‚æ¸…æ¥šJenkinsçš„workspaceè¿™æ ·çš„åŠ¨ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    booleanParam(name: <span class="string">'DEBUG_BUILD'</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€‰æ‹©å‚æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€‰æ‹©ï¼ˆchoiceï¼‰çš„å‚æ•°å°±æ˜¯æ”¯æŒç”¨æˆ·ä»å¤šä¸ªé€‰æ‹©é¡¹ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªå€¼ç”¨æ¥è¡¨ç¤ºè¿™ä¸ªå˜é‡çš„å€¼ã€‚å·¥ä½œä¸­å¸¸ç”¨çš„åœºæ™¯ï¼Œæœ‰é€‰æ‹©æœåŠ¡å™¨ç±»å‹ï¼Œé€‰æ‹©ç‰ˆæœ¬å·ç­‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    choice(name: <span class="string">'ENV_TYPE'</span>, choices: [<span class="string">'dev'</span>, <span class="string">'test'</span>, <span class="string">'product'</span>], description: <span class="string">'dev env test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“ç„¶parametersæ¨¡å—æˆ‘ä»¬ç”¨çš„æœ€å¤šçš„æ˜¯åœ¨æ‰‹åŠ¨çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»è¿›è¡Œæ„å»ºéƒ¨ç½²ï¼Œè‡³äºå…¶ä»–çš„ç›®å‰æˆ‘æš‚æ—¶æœªç”¨åˆ°</p><ul><li>é€‰æ‹©åˆ†æ”¯éƒ¨ç½²<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;label <span class="string">'agent-node'</span>&#125;</span><br><span class="line">    parameters &#123;</span><br><span class="line">        gitParameter branchFilter: <span class="string">'origin/(.*)'</span>, defaultValue: <span class="string">'dev'</span>, name: <span class="string">'BRANCH'</span>, <span class="built_in">type</span>: <span class="string">'PT_BRANCH'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'gitlib code'</span>) &#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                git branch:<span class="string">"<span class="variable">$&#123;params.BRANCH&#125;</span>"</span>, credentialsId:<span class="string">'gitlabUser'</span>, url: <span class="string">"http://gitlab.xxlaila.cn/xxx/kxl-eureka.git"</span></span><br><span class="line">                script &#123;</span><br><span class="line">                    build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>parameters<a href="https://wiki.jenkins.io/display/JENKINS/Git+Parameter+Plugin" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a>ï¼Œä»‹ç»å¾—æŒºè¯¦ç»†çš„ï¼Œ<a href="https://mohamicorp.atlassian.net/wiki/spaces/DOC/pages/136740885/Triggering+Jenkins+Based+on+New+Tags" target="_blank" rel="noopener">è¾…åŠ©å‚è€ƒ</a><br><img src="https://img.xxlaila.cn/1571651950634.jpg" alt="img"></p><ul><li>è¿˜å¯ä»¥å†™æˆ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">    gitParameter(</span><br><span class="line">        branch: <span class="string">''</span>,</span><br><span class="line">        branchFilter: <span class="string">'origin/(.*)'</span>,</span><br><span class="line">        defaultValue: <span class="string">'dev'</span>,</span><br><span class="line">        description: <span class="string">'test code'</span>,</span><br><span class="line">        name: <span class="string">'BRANCH'</span>,</span><br><span class="line">        quickFilterEnabled: <span class="literal">false</span>,</span><br><span class="line">        selectedValue: <span class="string">'NONE'</span>,</span><br><span class="line">        sortMode: <span class="string">'NONE'</span>,</span><br><span class="line">        tagFilter: <span class="string">'*'</span>,</span><br><span class="line">        <span class="built_in">type</span>: <span class="string">'PT_BRANCH'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå½“è¿™é‡Œè®¾ç½®äº†å¯ä»¥é€‰æ‹©åˆ†æ”¯çš„æ—¶å€™ï¼Œç„¶ååœ¨ä¹‹å‰çš„è‡ªåŠ¨è§¦å‘å°±ä¼šæœ‰é—®é¢˜ï¼Œå°±æ˜¯åœ¨å»åˆ†æ”¯æ‹‰å»ä»£ç çš„æ—¶å€™å°±ä¸€åªæ˜¯devåˆ†æ”¯ï¼Œè€Œä¸æ˜¯å…¶ä»–çš„åˆ†æ”¯ï¼Œè¿™é‡Œä»ç„¶åœ¨æ¢ç´¢çš„æµ‹è¯•ä¸­ã€‚<br>ç¼–è¾‘jobå¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571903055002.jpg" alt="img"></p><h3 id="å¤šåˆ†æ”¯pipeline"><a href="#å¤šåˆ†æ”¯pipeline" class="headerlink" title="å¤šåˆ†æ”¯pipeline"></a>å¤šåˆ†æ”¯pipeline</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æŒ‰ç…§ä¸Šé¢çš„åˆè¦æ”¯æŒç”¨æˆ·å¯ä»¥é€‰æ‹©åˆ†æ”¯ï¼Œåˆè¦é€‚åˆè‡ªåŠ¨è§¦å‘åŠŸèƒ½ã€‚ç”¨å•åˆ†æ”¯pipelineæ¥ç®¡ç†é¡¹ç›®ï¼Œåˆè¦å›åˆ°æˆ‘ä»¬æœ€åˆçš„æ¨¡å¼ï¼Œè€Œåœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åˆ°å¤šåˆ†æ”¯åŒæ—¶è¿›è¡Œå¼€å‘ã€‚è¿™æ ·å°±æ»¡è¶³äº†æˆ‘ä»¬çš„å®é™…éœ€æ±‚ã€‚å¤šåˆ†æ”¯ä»»åŠ¡è¿™é‡Œä¸åšè¿‡å¤šçš„è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œé˜è¿°ä¸¤ä¸ªåŠŸèƒ½ç‚¹ï¼›åˆ†åˆ«æ˜¯åˆ†æ”¯çš„æ‰«æç­–ç•¥å’Œå­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)ã€‚</p><h4 id="åˆ†æ”¯çš„æ‰«æç­–ç•¥"><a href="#åˆ†æ”¯çš„æ‰«æç­–ç•¥" class="headerlink" title="åˆ†æ”¯çš„æ‰«æç­–ç•¥"></a>åˆ†æ”¯çš„æ‰«æç­–ç•¥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ†æ”¯æ‰«ææ˜¯jenkinsæ ¹æ®ä¸€å®šçš„ç­–ç•¥å»ä»£ç ä»“åº“æ‰«æåˆ†æ”¯ï¼Œå¦‚æœæœ‰æ–°åˆ†æ”¯å°±åˆ›å»ºä¸€ä¸ªä»¥æ–°åˆ†æ”¯å‘½åçš„ä»»åŠ¡ï¼Œå¦‚æœå‘ç°åˆ†æ”¯è¢«åˆ é™¤ï¼Œå°±åˆ é™¤å¯¹åº”çš„jenkinsä»»åŠ¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨â€æ‰«æå¤šåˆ†æ”¯æµæ°´çº¿è§¦å‘å™¨(Scan Multibranch Pipeline Triggers)â€ä¸‹æœ‰ä¸€ä¸ª: Periodically if not otherwise runï¼ˆæ²¡æœ‰æ‰‹åŠ¨è§¦å‘ï¼Œå°±å®šæœŸæ‰«æåˆ†æ”¯ï¼‰ã€‚é€‰æ‹©æ­¤é¡¹ï¼Œè®¾ç½®ä¸€ä¸ªæ‰«æé—´éš”æ—¶é•¿ã€‚å¯ä»¥æ ¹æ®é¡¹ç›®åˆ†æ”¯çš„é¢‘ç¹ç¨‹åº¦è®¾ç½®å‘¨æœŸçš„é•¿çŸ­ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡é¡µé¢æ‰‹åŠ¨è§¦å‘jenkinsè¿›è¡Œæ‰«æã€‚<br><img src="https://img.xxlaila.cn/1571973819297.jpg" alt="img"></p><h4 id="å­¤å„¿é¡¹ç­–ç•¥-Orphaned-Item"><a href="#å­¤å„¿é¡¹ç­–ç•¥-Orphaned-Item" class="headerlink" title="å­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)"></a>å­¤å„¿é¡¹ç­–ç•¥(Orphaned Item)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥åŠŸèƒ½æ˜¯åœ¨ä»£ç ä»“åº“ä¸­åˆ é™¤äº†releaseåˆ†æ”¯ï¼Œé‚£ä¹ˆåœ¨å¤šä»»åŠ¡é¡µé¢ä¸Šï¼Œè¯¥åˆ†æ”¯åœ¨jenkinsä¸Šçš„ä»»åŠ¡ä¹Ÿåº”è¯¥å¯¹åº”åˆ é™¤ã€‚ä»€ä¹ˆæ—¶å€™åˆ é™¤ï¼Œå–å†³äºä¸‹æ¬¡åˆ†æ”¯æ‰«ææ—¶é—´ã€‚å¦‚æœä»£ç ä»“åº“ä¸­çš„åˆ†æ”¯è¢«åˆ é™¤ï¼Œè€Œjenkinsä¸Šå“åº”çš„ä»»åŠ¡æ²¡æœ‰è¢«åˆ é™¤ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°±æ˜¯æ‰€è¯´çš„å­¤å„¿ä»»åŠ¡ã€‚å¯¹äºåˆ†æ”¯ä»»åŠ¡çš„å†å²è®°å½•ï¼Œä¿å­˜å¤šé•¿æ—¶é—´è®¾ç½®</p><ul><li><p>ç•Œé¢é…ç½®<br><img src="https://img.xxlaila.cn/1571974190710.jpg" alt="img"></p></li><li><p>pipeline å†™æ³•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">orphanedItemStrategy &#123;</span><br><span class="line">    discardolditems &#123;</span><br><span class="line">        daysTokeep(10)</span><br><span class="line">        numToKeep(5)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>æ³¨</strong>: è¿™é‡Œå­¤å„¿ç­–ç•¥pipeline éœ€è¦å¦å¤–ä¸€ç§æ–¹å¼æ¥æ”¯æŒï¼Œ<a href="https://gitee.com/jenkins-zh/gitlab-branch-source-plugin" target="_blank" rel="noopener">Setting up GitLab Server Configuration on Jenkins</a>ï¼Œè¿™é‡Œæ²¡æœ‰ç”¨åˆ°è¿™ä¸ªï¼Œä¸åšè¿‡å¤šçš„é˜è¿°ã€‚<a href="https://github.com/jenkinsci/job-dsl-plugin/wiki/Migration" target="_blank" rel="noopener">githubå‚è€ƒ</a></p><h3 id="å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘"><a href="#å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘" class="headerlink" title="å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘"></a>å¤šåˆ†æ”¯çš„è‡ªåŠ¨è§¦å‘</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ†æ”¯çš„è§¦å¥½å¤„æ˜¯å¤šå¤šçš„ï¼Œè‡ªç„¶åœ¨å¤šåˆ†æ”¯é¢å‰è‡ªåŠ¨è§¦å‘è‚¯å®šä¹Ÿå°‘ä¸äº†ã€‚å¤šåˆ†æ”¯çš„è§¦å‘æœ‰ä¸¤ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯å‰é¢æåˆ°çš„Gitlab triggerå’ŒGeneric Webhook Triggerã€‚ä¸‹é¢åˆ†åˆ«å¯¹ä¸¤ç§æ¨¡å¼è¿›è¡Œé˜è¿°å’Œå®é™…çš„æµ‹è¯•</p><h4 id="Generic-Webhook-Trigger"><a href="#Generic-Webhook-Trigger" class="headerlink" title="Generic Webhook Trigger"></a>Generic Webhook Trigger</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Generic Webhook Trigger æ’ä»¶éœ€è¦æå‰å®‰è£…ï¼ŒGenericTriggerè§¦å‘æ¡ä»¶æ˜¯ç”±GWTæ’ä»¶æä¾›ï¼ŒGenericTriggerè§¦å‘çš„æ¡ä»¶åˆ†ä¸º5ä¸ªéƒ¨åˆ†ã€‚<a href="https://wiki.jenkins.io/display/JENKINS/Generic+Webhook+Trigger+Plugin" target="_blank" rel="noopener">GenericTriggerå®˜æ–¹å‚è€ƒ</a></p><ul><li>ä»HTTP POSTè¯·æ±‚ä¸­æå–å‚æ•°</li><li>tokenï¼ŒGWTæ’ä»¶ç”¨äºæ ‡è¯†jenkinsé¡¹ç›®çš„å”¯ä¸€æ€§</li><li>æ ¹æ®è¯·æ±‚å‚æ•°å€¼åˆ¤æ–­æ˜¯å¦è§¦å‘Jenkinsé¡¹ç›®æ‰§è¡Œ</li><li>æ—¥å¿—æ§åˆ¶æ‰“å°</li><li>webhookå“åº”æ§åˆ¶</li></ul><h4 id="GerenericTrigger-çš„å†™æ³•"><a href="#GerenericTrigger-çš„å†™æ³•" class="headerlink" title="GerenericTrigger çš„å†™æ³•"></a>GerenericTrigger çš„å†™æ³•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">    GenericTrigger(</span><br><span class="line">        genericVariables:[</span><br><span class="line">            [key: <span class="string">'ref'</span>, value: <span class="string">'$.ref'</span>]</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        token: env.JOB_NAME,</span><br><span class="line">        regexpFilterText: <span class="string">'$ref'</span>,</span><br><span class="line">        regexpFilterExpression: <span class="string">'refs/heads/'</span> + env.BRANCH_NAME</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env.BRANCH_NAME è¿™é‡ŒæŒ‡çš„æ˜¯åˆ†æ”¯åã€‚å½“ç„¶è¿™æ ·ä¿®æ”¹ä»¥åæ˜¯ä¸è¡Œçš„ï¼Œæ˜¯è¾¾ä¸åˆ°è‡ªåŠ¨è§¦å‘çš„ï¼Œéœ€è¦è‡ªè¡Œå»gitlabä¸Šæ·»åŠ é’©å­ï¼Œè¿™é‡Œç»è¿‡æµ‹è¯•æµç¨‹ï¼šç”¨æˆ·ä¿®æ”¹devåˆ†æ”¯ï¼Œpushåˆ°gitlab devåˆ†æ”¯å¯ä»¥è§¦å‘ä»»åŠ¡çš„devåˆ†æ”¯è‡ªåŠ¨æ„å»ºï¼›åˆå¹¶åˆ°teståˆ†æ”¯ï¼Œä¹Ÿå¯ä»¥è§¦å‘teståˆ†æ”¯è‡ªåŠ¨æ„å»ºï¼›åœ¨åˆå¹¶åˆ°masteråˆ†æ”¯ä¹Ÿèƒ½è‡ªåŠ¨è§¦å‘ä»»åŠ¡çš„masteråˆ†æ”¯è‡ªåŠ¨æ„å»ºã€‚<br><img src="https://img.xxlaila.cn/1571984557618.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è¦å®ç°è¿™å—ï¼Œè¦ç†è§£çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œé¦–å…ˆè¦çŸ¥é“gitlab push æ•°æ®çš„æ ¼å¼ï¼ŒçŸ¥é“äº†gitlab pushæ ¼å¼ï¼Œæˆ‘ä»¬æ‰çŸ¥é“åº”è¯¥æ€ä¹ˆæ“ä½œï¼Œ<a href="https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#webhooks" target="_blank" rel="noopener">gitlab pushæ•°æ®çš„æ ¼å¼å‚è€ƒ</a>ï¼Œ</p><ul><li>å‚è€ƒ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"object_kind"</span>: <span class="string">"push"</span>,</span><br><span class="line">  <span class="string">"before"</span>: <span class="string">"95790bf891e76fee5e1747ab589903a6a1f80f22"</span>,</span><br><span class="line">  <span class="string">"after"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">  <span class="string">"ref"</span>: <span class="string">"refs/heads/master"</span>,</span><br><span class="line">  <span class="string">"checkout_sha"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">  <span class="string">"user_id"</span>: 4,</span><br><span class="line">  <span class="string">"user_name"</span>: <span class="string">"John Smith"</span>,</span><br><span class="line">  <span class="string">"user_username"</span>: <span class="string">"jsmith"</span>,</span><br><span class="line">  <span class="string">"user_email"</span>: <span class="string">"john@example.com"</span>,</span><br><span class="line">  <span class="string">"user_avatar"</span>: <span class="string">"https://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=8://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=80"</span>,</span><br><span class="line">  <span class="string">"project_id"</span>: 15,</span><br><span class="line">  <span class="string">"project"</span>:&#123;</span><br><span class="line">    <span class="string">"id"</span>: 15,</span><br><span class="line">    <span class="string">"name"</span>:<span class="string">"Diaspora"</span>,</span><br><span class="line">    <span class="string">"description"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="string">"web_url"</span>:<span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"avatar_url"</span>:null,</span><br><span class="line">    <span class="string">"git_ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"git_http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"namespace"</span>:<span class="string">"Mike"</span>,</span><br><span class="line">    <span class="string">"visibility_level"</span>:0,</span><br><span class="line">    <span class="string">"path_with_namespace"</span>:<span class="string">"mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"default_branch"</span>:<span class="string">"master"</span>,</span><br><span class="line">    <span class="string">"homepage"</span>:<span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"repository"</span>:&#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"Diaspora"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"description"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"homepage"</span>: <span class="string">"http://example.com/mike/diaspora"</span>,</span><br><span class="line">    <span class="string">"git_http_url"</span>:<span class="string">"http://example.com/mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"git_ssh_url"</span>:<span class="string">"git@example.com:mike/diaspora.git"</span>,</span><br><span class="line">    <span class="string">"visibility_level"</span>:0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"commits"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327"</span>,</span><br><span class="line">      <span class="string">"message"</span>: <span class="string">"Update Catalan translation to e38cb41."</span>,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2011-12-12T14:27:31+02:00"</span>,</span><br><span class="line">      <span class="string">"url"</span>: <span class="string">"http://example.com/mike/diaspora/commit/b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327"</span>,</span><br><span class="line">      <span class="string">"author"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"Jordi Mallach"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"jordi@softcatala.org"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"added"</span>: [<span class="string">"CHANGELOG"</span>],</span><br><span class="line">      <span class="string">"modified"</span>: [<span class="string">"app/controller/application.rb"</span>],</span><br><span class="line">      <span class="string">"removed"</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">      <span class="string">"message"</span>: <span class="string">"fixed readme"</span>,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2012-01-03T23:36:29+02:00"</span>,</span><br><span class="line">      <span class="string">"url"</span>: <span class="string">"http://example.com/mike/diaspora/commit/da1560886d4f094c3e6c9ef40349f7d38b5d27d7"</span>,</span><br><span class="line">      <span class="string">"author"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"GitLab dev user"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"gitlabdev@dv6700.(none)"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"added"</span>: [<span class="string">"CHANGELOG"</span>],</span><br><span class="line">      <span class="string">"modified"</span>: [<span class="string">"app/controller/application.rb"</span>],</span><br><span class="line">      <span class="string">"removed"</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"total_commits_count"</span>: 4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸åŒçš„åˆ†æ”¯æäº¤æ¥è§¦å‘jenkinsçš„æ„å»ºï¼Œé‚£å°±åº”è¯¥çŸ¥é“postæ•°æ®å“ªä¸€ä¸ªå±æ€§ä»£è¡¨äº†ä¸åŒçš„åˆ†æ”¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¬¬å››è¡Œçœ‹åˆ°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">"ref"</span>: <span class="string">"refs/heads/master"</span>,</span><br></pre></td></tr></table></figure><p><strong>æ³¨é‡Š</strong>: ä¹Ÿå¯ä»¥é€šè¿‡IDEAå·¥å…·æäº¤çš„æ—¶å€™çœ‹åˆ°æäº¤çš„é€‰é¡¹ã€‚å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”¨refå¯ä»¥å¾ˆå¥½çš„åŒºåˆ†ä¸åŒåˆ†æ”¯ï¼Œè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆè¦å¡«å†™refçš„åŸå› ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡pipelineä»£ç çš„ç”Ÿæˆå™¨æ¥ç”Ÿæˆ</p><ul><li>pipeline ä»£ç ç”Ÿæˆå™¨<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">  GenericTrigger causeString: <span class="string">'Generic Cause'</span>, genericVariables: [[defaultValue: <span class="string">''</span>, key: <span class="string">'ref'</span>, regexpFilter: <span class="string">''</span>, value: <span class="string">'$.ref'</span>]], printContributedVariables: <span class="literal">true</span>, printPostContent: <span class="literal">true</span>, regexpFilterExpression: <span class="string">'\'</span>refs/heads/\<span class="string">' + evn.BRANCH_NAME'</span>, regexpFilterText: <span class="string">'$ref'</span>, token: <span class="string">'env.JOB_NAME'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1571982583457.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571982622070.jpg" alt="img"></p><p><strong>æ³¨</strong>: tokenå‚æ•°çš„ä½œç”¨æ˜¯æ ‡è¯†ä¸€ä¸ªpipelineåœ¨jenkinsä¸­çš„å”¯ä¸€æ€§ï¼Œè¿™ä¸ªå‚æ•°çš„é‡è¦æ€§å°±å¾—æèµ·GWTæ’ä»¶çš„åŸç†ã€‚å½“jenkinsæ”¶åˆ°generic-webhook-trgger/invokeæ¥å£çš„è¯·æ±‚æ—¶ï¼Œä¼šå°†è¯·æ±‚ä»£ç†ç»™GWTæ’ä»¶å¤„ç†ï¼ŒGWTæ’ä»¶å†…å®¹ä¼šä»jenkinså®ä¾‹å¯¹è±¡ä¸­å–å‡ºæ‰€æœ‰çš„å‚æ•°åŒ–jenkinsé¡¹ç›®ï¼ŒåŒ…æ‹¬pipelineï¼Œç„¶åè¿›è¡Œéå†ã€‚å¦‚æœæˆ‘ä»¬åœ¨å‚æ•°åŒ–é¡¹ç›®ä¸­Generic Triggeré…ç½®tokençš„å€¼ä¸webhookè¯·æ±‚æ—¶çš„tokenä¸€è‡´ï¼Œå°±ä¼šè§¦å‘æ”¹é¡¹ç›®ã€‚å¦‚æœå¤šä¸ªå‚æ•°åŒ–é¡¹ç›®çš„tokenä¸€æ ·ï¼Œåˆ™éƒ½ä¼šè¿›è¡Œè§¦å‘ï¼Œæ‰€ä»¥è¿™é‡Œçš„tokenæœ€å¥½æ—¶JOB_NAMEé¡¹ç›®åï¼Œå› ä¸ºè¿™ä¸ªæ˜¯åœ¨é¡¹ç›®æˆ–è€…æ˜¯åœ¨ä¸ºæœåŠ¡é¢†åŸŸä»–éƒ½æ˜¯å”¯ä¸€çš„ã€‚</p><ul><li>å‚æ•°ä»‹ç»:<ul><li>regexpFilterText: éœ€è¦è¿›è¡ŒåŒ¹é…çš„keyï¼Œä¾‹å­ä¸­ï¼Œä½¿ç”¨ä»post bodyä¸­æå–çš„refå˜é‡å€¼ã€‚</li><li>regexpFilterExpression: <a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html" target="_blank" rel="noopener">æ­£åˆ™è¡¨è¾¾å¼</a>ï¼›å¦‚æœregexpFilterTextå‚æ•°ç¬¦åˆregexpFilterExpressionå‚æ•°çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ™è§¦å‘æ‰§è¡Œã€‚</li><li>printPostContent: å¸ƒå°”å€¼ï¼Œå°†webhookè¯·æ±‚ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—ä¸Š</li><li>printContributedVariables: å¸ƒå°”å€¼ï¼Œå°†æå–åçš„å˜é‡ååŠå˜é‡å€¼æ‰“å°å‡ºæ¥</li><li>causeString: å­—ç¬¦ä¸²å‹ï¼Œè§¦å‘åŸå› ï¼Œå¯ä»¥ç›´æ¥åº”ç”¨æå–åçš„å˜é‡ï¼Œå¦‚ causeString: â€˜Triggered on $msgâ€™</li><li>Silent response: å¸ƒå°”å‹ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“webhookè¯·æ±‚æˆåŠŸåï¼ŒGWTæ’ä»¶ä¼šè¿”å›HTTP 200çŠ¶æ€ç å’Œè§¦å‘ç»“æœç»™å¯¹æ–¹è°ƒç”¨ï¼Œä½†æ˜¯å½“Silentresponseè®¾ç½®ä¸ºtrueæ—¶ï¼Œå°±åªè¿”å›HTTP 200çŠ¶æ€ç ï¼Œä¸åæ‚”è§¦å‘ç»“æœ</li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢çš„çœ‹çš„å‡ºæ¥ï¼Œæˆ‘ä»¬åªè¦æ˜¯æäº¤äº†åˆ†æ”¯éƒ½å¯ä»¥è¿›è¡Œè§¦å‘æ„å»ºï¼Œä½†æ˜¯å‘¢ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†devâ€”â€”&gt;testâ€”â€”master åˆ†æ”¯ï¼Œå°±æ˜¯åªæƒ³è¦è¿™å‡ ä¸ªè¿›è¡Œè§¦å‘æ„å»ºï¼Œå…¶ä»–çš„ä¸è¿›è¡Œè§¦å‘ï¼Œè®©å¼€å‘è‡ªå·±å»ç‚¹å‡»ã€‚</p><ul><li><p>æŒ‡å®šåˆ†æ”¯æ„å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">triggers &#123;</span><br><span class="line">  GenericTrigger causeString: <span class="string">'Triggered on $msg'</span>, genericVariables: [[defaultValue: <span class="string">''</span>, key: <span class="string">'ref'</span>, regexpFilter: <span class="string">''</span>, value: <span class="string">'$.ref'</span>]], printContributedVariables: <span class="literal">true</span>, printPostContent: <span class="literal">true</span>, regexpFilterExpression: <span class="string">'\'</span>refs/heads/(dev|<span class="built_in">test</span>|master)\<span class="string">''</span>, regexpFilterText: <span class="string">'$ref'</span>, token: <span class="string">'env.JOB_NAME'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¤šåˆ†æ”¯Gitlab trigger<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤šåˆ†æ”¯çš„Gitlab triggerå’Œæˆ‘ä»¬å‰é¢ä»‹ç»çš„gitlabäº‹ä»¶è§¦å‘ä¸€æ ·çš„ï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œè¿™é‡Œæˆ‘æµ‹è¯•äº†ä¸€ä¸ªjobï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚åŒæ—¶æ–°å»ºäº†ä¸€ä¸ªåˆ†æ”¯ï¼Œjenkinsä¼šè‡ªåŠ¨çš„æ‰«ææ–°å»ºä¸€ä¸ªä»¥åˆ†æ”¯ä¸ºåçš„ä»»åŠ¡ï¼Œè¿›è¡Œè‡ªåŠ¨è§¦å‘ã€‚å½“æˆ‘åˆ é™¤äº†æŸä¸€ä¸ªåˆ†æ”¯ï¼Œå°±ä¼šè§¦å‘è‡ªåŠ¨æ‰«æï¼Œç„¶åæŸ¥çœ‹åˆ†æ”¯ä¸ºåˆ é™¤ã€‚</p></li><li><p>åˆ é™¤åˆ†æ”¯<br><img src="https://img.xxlaila.cn/1571996378764.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571996257688.jpg" alt="img"></p></li><li><p>æ•´ä½“æ•ˆæœå›¾<br><img src="https://img.xxlaila.cn/1571990331005.jpg" alt="img"></p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä»‹ç»ä¸€ä¸‹éƒ¨ç½²è¿™å—ï¼Œæ ¹æ®branchæ¥è¿›è¡Œåˆ¤æ–­ï¼Œä¸åŒçš„branchéƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒï¼Œå½“è®¾å®šçš„å€¼ä¸åœ¨branchèŒƒå›´å†…ï¼Œå°±éœ€è¦äººä¸ºçš„åˆ¶å®šéƒ¨ç½²ç¯å¢ƒã€‚å½“äººå‘˜ä¸‰åˆ†é’Ÿå†…æ²¡æœ‰æ¥è¿›è¡Œç¯å¢ƒéƒ¨ç½²çš„é€‰æ‹©ï¼Œç³»ç»Ÿå°±ä¼šæ–­å¼€ï¼Œå¯¹è¯¥åˆ†æ”¯æ ‡è®°ä¸ºç»“æŸã€‚</p><p><a href="http://xxlaila.github.io/2019/10/25/pipeline%E5%A4%9A%E5%88%86%E6%94%AFgitlab%E8%A7%A6%E5%8F%91/" target="_blank" rel="noopener">å®Œæ•´æ–‡ä»¶</a><br><a href="https://jenkinsci.github.io/job-dsl-plugin/#path/buildPipelineView" target="_blank" rel="noopener">æ¨èå­¦ä¹ å‚è€ƒåœ°å€</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>pipeline</tag>
      </tags>
  </entry>
  <entry>
    <title>elasticserch</title>
    <url>/2019/10/17/elasticserch%E6%97%A5%E5%B8%B8%E7%BB%B4%E6%8A%A4/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="days-1"><a href="#days-1" class="headerlink" title="days 1"></a>days 1</h3><a id="more"></a><h4 id="elasticserch-ç´¢å¼•å’Œæ•°æ®æ“ä½œ"><a href="#elasticserch-ç´¢å¼•å’Œæ•°æ®æ“ä½œ" class="headerlink" title="elasticserch ç´¢å¼•å’Œæ•°æ®æ“ä½œ"></a>elasticserch ç´¢å¼•å’Œæ•°æ®æ“ä½œ</h4><ul><li><p>æŸ¥çœ‹ç´¢å¼•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/indices?v'</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ç´¢å¼•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/indices?v' |grep "red"|awk '&#123;print $3&#125;'|uniq &gt;l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in `cat a`;do  curl -XDELETE http://127.0.0.1:9200/$&#123;i&#125;;done</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹shards</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET http://127.0.0.1:9200/_cat/shards</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shards æœ‰å‡ ç§ç±»å‹ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹<code>UNASSIGNED</code>ï¼Œes é›†ç¾¤é‡Œé¢çš„åˆ†ç‰‡æ˜¯åˆ†é…åœ¨å¤šå°nodeä¸Šçš„ï¼Œä¸ºçš„å°±æ˜¯é«˜å¯ç”¨ï¼Œæ¯”å¦‚ä½ çš„æŸå°æœºå™¨crashäº†ï¼Œé‚£ä¹ˆé›†ç¾¤å°±ä¼šè®©å…¶ä»–å‰¯æœ¬é¡¶ä¸Šæ¥ï¼Œé¿å…å‡ºç°æŸä¸ªåˆ†ç‰‡ä¸èƒ½æä¾›æœåŠ¡çš„æƒ…å†µï¼Œä½†æ˜¯éš¾å…è¿˜æ˜¯ä¼šå‡ºç° UNASSIGNED shards çš„é”™è¯¯ã€‚</p><ul><li>åˆ é™¤shards UNASSIGNED<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -XGET 'http://127.0.0.1:9200/_cat/shards'|grep "UNASSIGNED"|awk '&#123;print $1&#125;'|uniq &gt;l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in `cat l`;do curl -XDELETE http://127.0.0.1:9200/$i;done</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="elasticserchéªŒè¯é›†ç¾¤"><a href="#elasticserchéªŒè¯é›†ç¾¤" class="headerlink" title="elasticserchéªŒè¯é›†ç¾¤"></a>elasticserchéªŒè¯é›†ç¾¤</h4><ul><li><p>é›†ç¾¤ç›¸å…³API</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat</span><br><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/tasks</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br><span class="line">/_cat/count</span><br><span class="line">/_cat/count/&#123;index&#125;</span><br><span class="line">/_cat/recovery</span><br><span class="line">/_cat/recovery/&#123;index&#125;</span><br><span class="line">/_cat/health</span><br><span class="line">/_cat/pending_tasks</span><br><span class="line">/_cat/aliases</span><br><span class="line">/_cat/aliases/&#123;<span class="built_in">alias</span>&#125;</span><br><span class="line">/_cat/thread_pool</span><br><span class="line">/_cat/thread_pool/&#123;thread_pools&#125;</span><br><span class="line">/_cat/plugins</span><br><span class="line">/_cat/fielddata</span><br><span class="line">/_cat/fielddata/&#123;fields&#125;</span><br><span class="line">/_cat/nodeattrs</span><br><span class="line">/_cat/repositories</span><br><span class="line">/_cat/snapshots/&#123;repository&#125;</span><br><span class="line">/_cat/templates</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤åç§°ç­‰ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"elk_elasticsearch_data_2"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elk_elasticsearch"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"T47wQwa6TT-6MHJVFM40Tw"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"6.4.0"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"rpm"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"595516e"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2018-08-17T23:18:47.308994Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"7.4.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"5.6.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"5.0.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/nodes?v</span><br><span class="line">ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">172.21.16.198           29          85   0    0.10    0.04     0.05 mdi       -      elk_elasticsearch_data_2</span><br><span class="line">172.21.16.187           48          85   0    0.00    0.01     0.05 mdi       *      elk_elasticsearch_master</span><br><span class="line">172.21.16.206           25          86   0    0.08    0.03     0.05 mdi       -      elk_elasticsearch_data_3</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯é›†ç¾¤ç£ç›˜åˆ†é…æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/allocation?v</span><br><span class="line">shards disk.indices disk.used disk.avail disk.total disk.percent host          ip            node</span><br><span class="line">    98          1gb     3.6gb     96.3gb     99.9gb            3 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2</span><br><span class="line">    99      887.1mb     4.5gb     95.4gb     99.9gb            4 172.21.16.187 172.21.16.187 elk_elasticsearch_master</span><br><span class="line">    99        957mb     3.5gb     96.4gb     99.9gb            3 172.21.16.206 172.21.16.206 elk_elasticsearch_data_3</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯é›†ç¾¤å¥åº·çŠ¶å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/health?v </span><br><span class="line">epoch      timestamp cluster           status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1571648406 17:00:06  elk_elasticsearch green           3         3    296 148    0    0        0             0                  -                100.0%</span><br><span class="line"></span><br><span class="line">$</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ä¸Šè¢«fielddataæ‰€ä½¿ç”¨çš„å †å†…å­˜å¤§å°ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/_cat/fielddata?v</span><br><span class="line">id                     host          ip            node                     field                    size</span><br><span class="line">VNcRqM30T3axzVjiPkDTmA 172.21.16.187 172.21.16.187 elk_elasticsearch_master event.resultCode.keyword 352b</span><br><span class="line">VNcRqM30T3axzVjiPkDTmA 172.21.16.187 172.21.16.187 elk_elasticsearch_master <span class="built_in">type</span>                     720b</span><br><span class="line">HNc5BrMWQcummBeAskQc4A 172.21.16.206 172.21.16.206 elk_elasticsearch_data_3 event.resultCode.keyword 704b</span><br><span class="line">z3zUA8KxTH6B7C8CmVRUIQ 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2 <span class="built_in">type</span>                     720b</span><br><span class="line">z3zUA8KxTH6B7C8CmVRUIQ 172.21.16.198 172.21.16.198 elk_elasticsearch_data_2 event.resultCode.keyword 704b</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>elasticserch</category>
      </categories>
      <tags>
        <tag>elasticserch</tag>
      </tags>
  </entry>
  <entry>
    <title>nexusé…ç½®ldap</title>
    <url>/2019/10/15/nexus%E9%85%8D%E7%BD%AEldap/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="é…ç½®nexus"><a href="#é…ç½®nexus" class="headerlink" title="é…ç½®nexus"></a>é…ç½®nexus</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•nexusåœ¨è®¾ç½®é¡µï¼Œç‚¹å‡»ldapï¼Œ</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1571131890608.jpg" alt="img"><br>å‚æ•°ä»‹ç»:</p><ul><li>Name: éšä¾¿å†™</li><li>LDAP server address: æ”¯æŒldapså’Œldap,è€Œç«¯å£åˆ™å–å†³äºé…ç½®ã€‚ å¦‚æœæ²¡æœ‰ç‰¹æ®Šé…ç½®ï¼Œldapé»˜è®¤ç«¯å£æ˜¯389</li><li>Search base: åªéœ€è¦å¡«DCå³å¯ï¼Œæ¯”å¦‚DC=example,DC=comã€‚ å…¶å®ƒå†…å®¹ï¼Œæ¯”å¦‚CNã€OUç­‰ï¼Œä¸éœ€è¦å¡«å†™</li><li>Authentication methodæœ‰ä»¥ä¸‹é€‰é¡¹:<ul><li>Simple Authentication</li><li>Anonymous Authentication</li><li>DIGEST-MD5</li><li>CRAM-MD5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šå¸¸é€‰æ‹©Simple Authenticationå³å¯ã€‚Username or DNã€Passwordé‡Œå¡«å†™è´¦æˆ·ã€å¯†ç ï¼Œè€Œ Connection rulesæ— éœ€ä¿®æ”¹ã€‚å¡«å†™å®Œæ¯•åï¼Œç‚¹å‡»ã€Verify connectionã€‘æŒ‰é’®ï¼Œå¯ä»¥éªŒè¯ä¿¡æ¯ã€‚ å¦‚æœæˆåŠŸï¼Œå³å¯ä¿å­˜ã€‚</li></ul></li></ul><h4 id="Choose-Users-and-Groups"><a href="#Choose-Users-and-Groups" class="headerlink" title="Choose Users and Groups"></a>Choose Users and Groups</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é¡¹æ•…åæ€ä¹‰å°±æ˜¯é…ç½®ç”¨æˆ·å’Œç»„çš„ï¼Œåœ¨æœ€å¼€å¤´çš„Configuration templateä¸­ï¼Œæœ‰å››ç§æ¨¡æ¿å¯é€‰ï¼š</p><ul><li>Active Directory</li><li>Generic Ldap Server</li><li>Posix with Dynamic Groups</li><li>Posix with Static Groups</li></ul><p>è¿™é‡Œé€‰æ‹©<code>Generic Ldap Server</code></p><ul><li>Base DN åœ¨LDAPä¸­æ‰¾åˆ°ç”¨æˆ·çš„åŸºæœ¬ä½ç½®ã€‚è¿™æ˜¯ç›¸å¯¹äºæœç´¢åŸºç¡€çš„ï¼ˆä¾‹å¦‚ou = peopleï¼‰ã€‚</li><li>User subtreeé€šå¸¸éœ€è¦å‹¾é€‰ã€‚ å¦‚æœæŠŠLDAPçš„Treeæ¯”ä½œç›®å½•çš„è¯ï¼Œå‹¾é€‰ä»¥åç›¸å½“äºé€’å½’æŸ¥æ‰¾å­ç›®å½•ã€‚</li><li>User filteré€šè¿‡è¿‡æ»¤è§„åˆ™ï¼Œå‡å°‘æœç´¢ä¿¡æ¯ï¼Œç”¨äºæå‡æ€§èƒ½ã€‚ ä»…ä»…åªæ˜¯æå‡æ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä¸æ‡‚å®ƒç‰¹æ®Šçš„åŒ¹é…è§„åˆ™ï¼Œä¹Ÿå¯ä»¥ä¸å¡«ã€‚</li><li>ä¹‹å‰é€‰æ‹©äº†<code>Generic Ldap Server</code>æ¨¡ç‰ˆåï¼ŒUser ID attributeé»˜è®¤ä¸ºuidï¼ŒReal name attributeé»˜è®¤ä¸ºcnã€Email attributeé»˜è®¤ä¸ºmailã€Password attributeä¸ºç©ºã€‚</li><li>Map LDAP groups as roleså¦‚æœä¸å‹¾é€‰ï¼Œå°±ä¸ä¼šåŒæ­¥ç”¨æˆ·ç»„ä¿¡æ¯ã€‚ å¦‚æœå‹¾é€‰ï¼Œåˆ™å¯ä»¥é€‰æ‹©Group typeå’ŒGroup member of attributeã€‚ è‹¥æ— å¿…è¦ï¼Œä¿æŒé»˜è®¤å³å¯ï¼Œé»˜è®¤æ˜¯å‹¾é€‰çš„ã€‚<br><img src="https://img.xxlaila.cn/1571133103461.jpg" alt="img"></li><li>å¡«å†™å®Œæˆåï¼Œé€šè¿‡ã€Verify user mappingã€‘å¯ä»¥éªŒè¯æŸ¥è¯¢ç»“æœ<br><img src="https://img.xxlaila.cn/1571133221971.jpg" alt="img"><br>ç‚¹å‡»åˆ›å»º<br><img src="https://img.xxlaila.cn/1571133286829.jpg" alt="img"></li></ul><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°èµ·ä¸€ä¸ªçª—å£åˆ©ç”¨ldapé‡Œé¢çš„è´¦å·è¿›è¡Œç™»å½•ï¼Œå¯ä»¥ç™»å½•ï¼Œæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ç™»å½•ä¹‹åç”¨æˆ·æ²¡æœ‰ä»»ä½•æƒé™ï¼Œè¿™å¯¹äºç ”å‘æ¥è¯´åˆæ˜¯ä¸€ä¸ªä¸å¯æ¥å—çš„äº‹æƒ…ã€‚æ¥ä¸‹æ¥é…ç½®æƒé™</p><h5 id="ç¦æ­¢åŒ¿åè®¿é—®"><a href="#ç¦æ­¢åŒ¿åè®¿é—®" class="headerlink" title="ç¦æ­¢åŒ¿åè®¿é—®"></a>ç¦æ­¢åŒ¿åè®¿é—®</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ˜¯ä¸å…è®¸åŒ¿åç”¨æˆ·ä¸å¯ä»¥ç™»å½•å°±èƒ½è®¿é—®çš„ï¼Œè¿™æ ·æˆ‘ä»¬ldapå°±æ²¡æœ‰ä»»ä½•æ„ä¹‰äº†<br><img src="https://img.xxlaila.cn/1571133691247.jpg" alt="img"></p><ul><li>ç¦æ­¢åŒ¿åç”¨æˆ·<br><img src="https://img.xxlaila.cn/1571133811908.jpg" alt="img"></li></ul><h5 id="åˆ›å»ºè§’è‰²"><a href="#åˆ›å»ºè§’è‰²" class="headerlink" title="åˆ›å»ºè§’è‰²"></a>åˆ›å»ºè§’è‰²</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨Securityâ€”â€”&gt;Rolesâ€”â€”&gt;Create roleï¼Œè¿™é‡Œåˆ›å»ºè§’è‰²æœ‰ä¸¤ç§ã€‚ä¸€ç§æ˜¯nexus relosæœ¬åœ°è§’è‰²ï¼Œä¸€ç§æ˜¯External roles mappingå¤–éƒ¨æ˜ å°„çš„å½¢å¼ã€‚ä¸ºäº†æ»¡è¶³æˆ‘ä»¬ldapè´¦æˆ·ç™»å½•è¿›æ¥æœ‰æµè§ˆåº“çš„æƒé™ï¼Œç ”å‘åˆå¯ä»¥ä¸Šä¼ ç¬¬ä¸‰æ–¹ä¾èµ–åº“çš„æƒé™ï¼Œä½†æ˜¯ä¸èƒ½åˆ é™¤å’Œç§ä¸‹å¢åŠ åº“Repositoriesã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å•ç‹¬å»ºç«‹ä¸€ä¸ªæœ¬åœ°çš„relosï¼Œç„¶ååœ¨æ˜ å°„å¤–éƒ¨çš„ldapåˆ°è¿™ä¸ªæœ¬åœ°çš„rolesï¼Œè¿™æ ·ldapè´¦æˆ·ç™»å½•è¿›æ¥å°±èƒ½å®ç°æ—¥å¸¸çš„åŸºæœ¬æ“ä½œã€‚</p><ul><li><p>åˆ›å»ºnexus relosæœ¬åœ°è§’è‰²<br><img src="https://img.xxlaila.cn/1571296771150.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä»–èµ‹äºˆæƒé™ï¼Œå¯¹ç”¨æˆ·è¿›è¡Œæƒé™æ§åˆ¶ï¼Œæ²¡æœ‰æƒé™æ§åˆ¶ï¼Œå°±æ²¡åŠæ³•è¾¾æˆæˆ‘ä»¬ä¸Šé¢çš„ç›®æ ‡ã€‚ä¸‹é¢æ˜¯æˆ‘èµ‹äºˆçš„æƒé™ï¼Œå¯ä»¥ç»“åˆå®é™…éœ€æ±‚æ¥è¿›è¡Œèµ‹äºˆã€‚</p></li><li><p>æƒé™ä»‹ç»:</p><ul><li>ng-component-upload: æœ‰ä¸Šä¼ çš„æƒé™ï¼Œæ¯”å¦‚javaä¾èµ–çš„ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œç ”å‘å¯ä»¥è‡ªå·±è¿›è¡Œä¸Šä¼ </li><li>ng-repository-admin-<em>-</em>-browse: æµè§ˆæ‰€æœ‰çš„repository</li><li>ng-repository-admin-<em>-</em>-read: å¯ä»¥æ‰€æœ‰è¯»å–repositoryçš„é…ç½®ä¿¡æ¯</li><li>ng-repository-view-maven2-maven-central-browse: å…·æœ‰æµè§ˆmaven-centralå†…å®¹</li><li>ng-repository-view-maven2-maven-central-read: è¯»å–maven-centralå†…å®¹ï¼Œåœ¨mavenç¼–è¯‘çš„æ—¶å€™å…·æœ‰ä¸‹è½½çš„æƒé™ï¼Œ(åé¢ä¸ä¸€ä¸€ä»‹ç»)</li><li>ng-repository-view-maven2-maven-public-browse</li><li>ng-repository-view-maven2-maven-public-read</li><li>ng-repository-view-maven2-maven-releases-browse</li><li>ng-repository-view-maven2-maven-releases-read</li><li>ng-repository-view-maven2-maven-snapshots-browse</li><li>ng-repository-view-maven2-maven-snapshots-read</li><li>ng-repository-view-npm-npm-kxl-all-browse: ä»¥ä¸‹æ˜¯è‡ªå·±åšçš„npmä»£ç†ç¼“å­˜ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://xxlaila.github.io/2019/08/23/nexus3æ­å»ºnpmç§æœ/" target="_blank" rel="noopener">nexus3æ­å»ºnpmç§æœ</a></li><li>ng-repository-view-npm-npm-kxl-all-read</li><li>ng-repository-view-npm-npm-external-browse</li><li>ng-repository-view-npm-npm-external-read</li><li>ng-repository-view-npm-npm-internal-browse</li><li>ng-repository-view-npm-npm-internal-read</li><li>ng-search-read: è®©ç”¨æˆ·å…·æœ‰æ‰€æœ‰æƒé™ï¼Œæ²¡æœ‰æ­¤æƒé™ï¼Œç ”å‘æŸ¥æ‰¾ä¸€ä¸ªåŒ…ï¼Œä¼°è®¡ä¼šæ­»</li></ul></li><li><p>åˆ›å»ºæ˜¯External roles mappingå¤–éƒ¨æ˜ å°„<br><img src="https://img.xxlaila.cn/1571134166780.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571297568491.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¿›è¡ŒRoles ID è¿™æ ç›®ï¼Œéœ€è¦å¡«å†™çš„æ˜¯Usersï¼Œè¿™ä¸ªUsersä¼šåœ¨ldapä¸ŠåŒæ­¥Usersçš„ä¸€ä¸ªç”¨æˆ·ç»„ã€‚æ ¹æ®è‡ªå·±çš„ldapè´¦æˆ·ç»„è®¾ç½®æ¥è¿›è¡Œå¡«å†™ã€‚ä¸‹å›¾æ˜¯ldapçš„ç»„è®¾ç½®<br><img src="https://img.xxlaila.cn/1571298567078.jpg" alt="img"></p></li></ul><p><strong>æ³¨</strong>: å…¶å®åœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›è¡ŒPrivilegesçš„æƒé™èµ‹äºˆï¼Œä½†æ˜¯æˆ‘é€‰æ‹©çš„æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªæœ¬åœ°çš„nexus relosã€‚ç„¶åæˆ‘ä»¬åœ¨Rolesæ å…³è”ä¹‹å‰åˆ›å»ºçš„<code>Developer</code>ï¼Œå®Œæˆä»¥åé€šè¿‡ldapè´¦æˆ·ç™»å½•è¿›è¡Œæµ‹è¯•</p><h5 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä¸»è¦æ˜¯ä»å››ä¸ªæ–¹é¢æ¥æµ‹è¯•ldapè´¦æˆ·ã€‚åˆ†åˆ«æ˜¯: ç™»å½•é»˜è®¤çš„æƒé™ã€æµè§ˆæ‰€æœ‰åº“çš„æƒé™ã€Browseçš„æµè§ˆã€Browseåº“çš„ä¸Šä¼ </p><ul><li><p>ç™»å½•é»˜è®¤çš„æƒé™<br><img src="https://img.xxlaila.cn/1571297962563.jpg" alt="img"></p></li><li><p>æµè§ˆæ‰€æœ‰åº“çš„æƒé™<br><img src="https://img.xxlaila.cn/1571298121188.jpg" alt="img"></p></li><li><p>Browseçš„æµ<br><img src="https://img.xxlaila.cn/1571298018356.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571298167348.jpg" alt="img"></p></li><li><p>Browseåº“çš„ä¸Šä¼ <br><img src="https://img.xxlaila.cn/1571298224331.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571298260091.jpg" alt="img"></p></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nexus</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsé…ç½®å¤‡ä»½</title>
    <url>/2019/10/15/jenkins%E9%85%8D%E7%BD%AE%E5%A4%87%E4%BB%BD/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="jenkins-å¤‡ä»½"><a href="#jenkins-å¤‡ä»½" class="headerlink" title="jenkins å¤‡ä»½"></a>jenkins å¤‡ä»½</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“jenkinsåœ¨ç”¨èµ·æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éš¾ä¿ä»–ä¸ä¼šå‡ºæ•…éšœï¼Œä½†æ˜¯å‡ºäº†æ•…éšœæˆ‘ä»¬æ€ä¹ˆåšåˆ°å¿«é€Ÿçš„æ¢å¤å‘¢ï¼Œè¿™æ—¶å¤‡ä»½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚ä½†jenkinsæœ¬èº«ä¸æä¾›å¤‡ä»½çš„åŠŸèƒ½ï¼Œ<a id="more"></a> æ‰€ä»¥è¿™é‡Œå°±éœ€è¦å€ŸåŠ©å¤–åŠ›ã€‚å¤‡ä»½å¯ä»¥å¤šæ ·åŒ–ï¼Œä¸€ç§æ˜¯æˆ‘ä»¬ç›´æ¥åˆ°jenkinsçš„ç›®å½•ä¸‹é¢æ‰‹åŠ¨å¤‡ä»½jenkinsç›®å½•ã€‚ä¸€ç§æ˜¯æˆ‘ä»¬å°±jenkinsè‡ªå¸¦çš„æ’ä»¶<code>thinBackup</code>å’Œ<code>Periodic Backup</code>è¿›è¡Œå¤‡ä»½æ¢å¤ï¼Œä¸‹é¢è¿›è¡Œåˆ†åˆ«ä»‹ç»</p><h3 id="thinBackupå¤‡ä»½"><a href="#thinBackupå¤‡ä»½" class="headerlink" title="thinBackupå¤‡ä»½"></a>thinBackupå¤‡ä»½</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;æ’ä»¶ç®¡ç†<br><img src="https://img.xxlaila.cn/1571101180571.jpg" alt="img"><br>å®‰è£…å®Œæˆä¹‹åé‡å¯jenkinsæœåŠ¡ï¼Œç™»å½•jenkinsåœ¨ç³»ç»Ÿç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1571101557754.jpg" alt="img"></p><h4 id="é…ç½®ThinBackup"><a href="#é…ç½®ThinBackup" class="headerlink" title="é…ç½®ThinBackup"></a>é…ç½®ThinBackup</h4><ul><li>ç‚¹å‡»ThinBackup<br><img src="https://img.xxlaila.cn/1571101640273.jpg" alt="img"><br>å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªé€‰é¡¹:</li><li>Backup Now: æ‰‹åŠ¨ç«‹å³å¤‡ä»½</li><li>Restore: æ¢å¤å¤‡ä»½</li><li>Settings: å¤‡ä»½å‚æ•°çš„è®¾ç½®</li></ul><h5 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹é¢æ˜¯æˆ‘çš„å¤‡ä»½å‚æ•°ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è‡ªå·±è®¾å®šå¤‡ä»½å‚æ•°ï¼Œè®¾ç½®å¥½å‹saveå³å¯ï¼Œ<code>Backup schedule for full backups</code>æ„æ€æ˜¯å‘¨ä¸€åˆ°å‘¨äº”æ¯å¤©å‡Œæ™¨ä¸¤ç‚¹è¿›è¡Œå¤‡ä»½<br><img src="https://img.xxlaila.cn/1571102057919.jpg" alt="img"></p><h5 id="Restore"><a href="#Restore" class="headerlink" title="Restore"></a>Restore</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤‡ä»½æ–‡ä»¶æ˜¯ä»¥æ—¥æœŸ+æ—¶é—´èŠ‚ç‚¹ç»„æˆçš„æ–‡ä»¶åï¼Œæˆ‘ä»¬æ¢å¤ä»€ä¹ˆæ—¶é—´æ®µçš„ï¼Œç‚¹å‡»è¿›è¡Œæ¢å¤ï¼Œ<br><img src="https://img.xxlaila.cn/1571102188007.jpg" alt="img"></p><h3 id="Periodic-Backup"><a href="#Periodic-Backup" class="headerlink" title="Periodic Backup"></a>Periodic Backup</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¤‡ä»½é™¤äº†ä¸Šé¢æåˆ°çš„æ’ä»¶è¿˜æœ‰ä¸€ä¸ªæ’ä»¶æ˜¯<code>Periodic Backup</code>ï¼Œå®‰è£…<code>Periodic Backup</code>ä¸é˜è¿°ï¼Œå®‰è£…å®Œæˆåå¯ä»¥åœ¨ç³»ç»Ÿç®¡ç†èœå•ä¸‹é¢æœ‰ä¸€ä¸ª<code>Periodic Backup Manager</code>èœå•<br><img src="https://img.xxlaila.cn/1571709136813.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰“å¼€<code>Periodic Backup Manager</code>ï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€æ˜¯æ²¡æœ‰ä»»ä½•ä¸œè¥¿çš„ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å»å»ºç«‹ä¸€ä¸ªè§„åˆ™ï¼Œç‚¹å‡»<code>Configure</code><br><img src="https://img.xxlaila.cn/1571709270639.jpg" alt="img"></p><p>é…ç½®é¡¹å¾ˆç®€å•:</p><ul><li>Temporary Directory: ä¸´æ—¶ç›®å½•</li><li>Backup schedule (cron): è¿›è¡Œå¤‡ä»½cronçš„è¡¨è¾¾å¼ï¼Œå¡«å†™å®Œæˆåç‚¹å‡»<code>Validate cron syntax</code>è¿›è¡ŒéªŒè¯</li><li>Maximum backups in location: æœ€å¤§ä½ç½®å¤‡ä»½ï¼Œä¿ç•™å¤šå°‘ä¸ªå¤‡ä»½æ–‡ä»¶</li><li>Store no older than (days): ä¿ç•™çš„æ—¶é—´</li><li>File Management Strategy: å¤‡ä»½ç­–ç•¥<ul><li>ConfigOnly: åªå¤‡ä»½é…ç½®æ–‡ä»¶</li><li>FullBackup: è¿›è¡Œå…¨é‡å¤‡ä»½ï¼Œå¯ä»¥é€šè¿‡Excludes listä¸­å¡«å…¥Anté£æ ¼è¡¨è¾¾å¼ï¼Œæ’é™¤ä¸å¸Œæœ›å¤‡ä»½çš„æ–‡ä»¶ï¼Œå¤šä¸ªè¡¨è¾¾å¼ä½¿ç”¨åˆ†å·åˆ†éš”</li></ul></li><li>Storage Strategy: å­˜å‚¨ç­–ç•¥ï¼Œå°±æ˜¯æ˜¯å¦éœ€è¦è¿›è¡Œå‹ç¼©å­˜å‚¨</li><li>Backup Location: å¤‡ä»½çš„ä½ç½®ï¼Œéƒ½æ˜¯æœ¬åœ°ç›®å½•<br><img src="https://img.xxlaila.cn/1571709879768.jpg" alt="img"></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsé…ç½®ldap</title>
    <url>/2019/10/14/jenkins%E9%85%8D%E7%BD%AEldap/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸ç ”å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜ï¼Œè¿˜æœ‰è¿ç»´äººå‘˜æœ‰æ—¶å€™ç™»å½•jenkinså»æŸ¥çœ‹ä¸€äº›jobçš„çŠ¶æ€æˆ–è€…æ˜¯å…¶ä»–çš„ä¸œè¥¿ï¼Œè™½ç„¶æœ‰ä¼ä¸šå¾®ä¿¡çš„é€šçŸ¥ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯ä¸èƒ½æ»¡è¶³ï¼Œ<a id="more"></a> æ¯”å¦‚jobé”™è¯¯äº†ï¼Œä¼ä¸šå¾®ä¿¡è™½ç„¶å§é”™è¯¯å‘ç»™äº†ç ”å‘äººå‘˜ï¼Œä½†æ˜¯ç ”å‘è¿˜æ˜¯è¦ç™»å½•jenkinsä¸Šå»çœ‹ï¼Œå°±æ„Ÿè§‰è¦èˆ’æœä¸€ç‚¹ï¼Œæµ‹è¯•ä¸Šåšçš„ä¸€äº›è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæœ‰æ—¶å€™å¤±è´¥äº†ä»–ä»¬ä¹Ÿä¼šå»çœ‹æˆ–è€…æ˜¯å»å»ºç«‹ä¸€äº›è‡ªåŠ¨åŒ–çš„jobã€‚ä¹‹å‰å»ºç«‹äº†å…¬å…±çš„è´¦å·ï¼Œå¼€å‘å’Œæµ‹è¯•äººå‘˜éƒ½å»ç™»å½•ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä»–ä»¬è¯¯æ“ä½œäº†ï¼Œå¯¼è‡´ä¸€äº›å…¶ä»–çš„ä¸œè¥¿å¤±è´¥æˆ–è€…é”™è¯¯ï¼Œè™½ç„¶åšäº†æƒé™æ§åˆ¶ï¼Œä½†æ˜¯ä»–ä»¬è¿˜æ˜¯æ­»ä¸æ‰¿è®¤ï¼Œæ‰€ä»¥è¿™é‡Œä»‹å…¥ldapã€‚è°åŠ¨çš„å°±çŸ¥é“äº†ï¼Œè¿™æ ·å°±ä¸æ€•äº†ã€‚</p><h3 id="å¼€å§‹é…ç½®"><a href="#å¼€å§‹é…ç½®" class="headerlink" title="å¼€å§‹é…ç½®"></a>å¼€å§‹é…ç½®</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç™»å½•jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®<br><img src="https://img.xxlaila.cn/1571025388007.jpg" alt="img"><br>è®¿é—®æ§åˆ¶â€”â€”&gt;LDAP<br><img src="https://img.xxlaila.cn/1571027524602.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆä»¥åæˆ‘ä»¬éœ€è¦æµ‹è¯•ä¸€ä¸‹è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œç‚¹å‡»<code>Test LDAP setttings</code>ï¼Œè¾“å…¥åœ¨ldapçš„å…¶ä¸­ä¸€ä¸ªè´¦æˆ·æ¥è¿›è¡ŒéªŒè¯ï¼Œæ²¡é—®é¢˜çš„ç»“æœå¦‚ä¸‹:<br><img src="https://img.xxlaila.cn/1571027696951.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆå¹¶æµ‹è¯•é€šè¿‡åå°±å¯ä»¥ç”¨LDAPç›´æ¥ç™»å½•äº†<br><strong>æ³¨</strong>: å¯ç”¨äº†LDAPç™»å½•åå°†æ— æ³•å†ç”¨ä¹‹å‰çš„ç™»å½•æ–¹å¼ï¼ˆæœ¬åœ°è®¤è¯å°†æ— æ³•åœ¨ä½¿ç”¨ï¼‰ç™»å½•ï¼Œç™»å½•è¿›æ¥çš„ä»»ä½•ä¸€ä¸ªè´¦å·éƒ½æ˜¯ç®¡ç†å‘˜ï¼Œéƒ½æ˜¯ç®¡ç†ç€è‚¯å®šæ¥è¯´ä¸å®‰å…¨ï¼Œæƒé™é…ç½®è¯·ä¸‹çœ‹</p><p><a href="https://wiki.jenkins.io/display/JENKINS/LDAP+Plugin" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a></p><h3 id="é…ç½®ldapçš„è´¦æˆ·æƒé™"><a href="#é…ç½®ldapçš„è´¦æˆ·æƒé™" class="headerlink" title="é…ç½®ldapçš„è´¦æˆ·æƒé™"></a>é…ç½®ldapçš„è´¦æˆ·æƒé™</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢æˆ‘ä»¬è™½ç„¶å§ldapé…ç½®å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å¯¹ç”¨æˆ·è¿›è¡Œæƒé™çš„é…ç½®ï¼Œä¸å¯èƒ½æ¯ä¸ªäººç™»å½•éƒ½èƒ½å¯¹æˆ‘ä»¬jenkinsè¿›è¡Œæ— é™åˆ¶çš„æ“ä½œï¼Œè¿™ä¸ç¬¦åˆæˆ‘ä»¬ä¹‹å‰çš„æ„å›¾ã€‚å®‰è£…<code>Role-based Authorization Strategy</code>æ’ä»¶</p><ul><li>åœ¨ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®,å¯ä»¥çœ‹åˆ°ä¸‹é¢é€‰é¡¹ï¼Œæ¯é¡¹ä»‹<a href="https://xxlaila.github.io/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" target="_blank" rel="noopener">å‚è€ƒ</a><br><img src="https://img.xxlaila.cn/1571034253089.jpg" alt="img"></li></ul><p>ä¿å­˜ä»¥åï¼Œè¿”å›ç³»ç»Ÿç®¡ç†ç•Œé¢å°±å¯ä»¥çœ‹åˆ°å¤šå¤„ä¸€ä¸ª<code>Manage and Assign Roles</code><br><img src="https://img.xxlaila.cn/1571034433352.jpg" alt="img"><br>ç‚¹å‡»è¿›å»</p><p><img src="https://img.xxlaila.cn/1571034507945.jpg" alt="img"></p><ul><li><strong>Manage Roles</strong>: è§’è‰²åˆ†ä¸ºGlobalå’ŒProjectï¼Œå¯åˆ›å»ºè§’è‰²åˆ†ç»„å’Œæ·»åŠ é¡¹ç›®ã€‚</li><li><strong>Assign Roles</strong>: å¢åŠ å…·ä½“çš„ç”¨æˆ·ï¼Œåˆ†é…åˆ°è§’è‰²ç»„ï¼ŒæŒ‡å®šé¡¹ç›®æƒé™ã€‚</li></ul><p><a href="https://xxlaila.github.io/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" target="_blank" rel="noopener">æƒé™è®¾ç½®</a></p><ul><li>ä¸‹é¢æˆ‘çš„é…ç½®ï¼Œå’Œä¹‹å‰çš„å¤§åŒå°å¼‚<br><img src="https://img.xxlaila.cn/1571038684383.jpg" alt="img"></li></ul><p><strong>æ³¨</strong>: è¿™é‡Œæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œè¿™æ ·é…ç½®ä»¥åï¼Œæ–°ç”¨æˆ·ç™»å½•è¿›æ¥ä»¥åå°±ä¼šæç¤ºæ²¡æœ‰æƒé™ï¼Œ<code>Access Denied,xxxxæ²¡æœ‰å…¨éƒ¨/Readæƒé™</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ‰“å¼€jenkinsåï¼Œæ²¡æœ‰åˆ›å»ºç”¨æˆ·å‰ï¼Œå…ˆä¸è¦å‹¾é€‰ç³»ç»Ÿè®¾ç½®ä¸­å¯ç”¨å®‰å…¨é€‰é¡¹ï¼Œå¦‚æœå‹¾é€‰äº†ï¼Œå°±ä¼šå‡ºç°æ— æ³•è¿›å…¥jenkinsçš„ç°è±¡<br><img src="https://img.xxlaila.cn/1571037187865.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ç½‘ä¸Šçœ‹åˆ°æœ‰è¿™ç§çš„è§£å†³åŠæ³•ï¼Œæœ‰å‡ ç§æ–¹æ¡ˆï¼Œä¸€ä¸ªæ˜¯ä¿®æ”¹confing.xmlçš„æ–‡ä»¶ï¼Œä¿®æ”¹config.xmlæ–‡ä»¶çš„ä¸‰ç§æ–¹å¼æ„Ÿè§‰éƒ½ä¸å¤ªåˆ‡åˆå®é™…çš„ä¸šåŠ¡ï¼›ä¸‹é¢æ˜¯æˆ‘åšçš„ä¸¤ç§åŠæ³•ï¼Œæ¨èä½¿ç”¨ç¬¬äºŒç§</p><ul><li><p>Role-Based Strategy<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨<code>Assign Roles</code>å§ç”¨æˆ·æ·»åŠ è¿›æ¥ï¼Œç„¶åå‹¾é€‰æƒé™ï¼Œ<br>ç³»ç»Ÿç®¡ç†â€”â€”&gt;Manage and Assign Rolesâ€”â€”&gt;Assign Roles<br><img src="https://img.xxlaila.cn/1571037604678.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½†æ˜¯è¿™æœ‰ä¸€ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯æ¯æ¬¡æ–°æ¥ä¸€ä¸ªç”¨æˆ·å°±å¾—å»æ·»åŠ ä¸€æ¬¡ç”¨æˆ·æƒé™ï¼Œè™½ç„¶æ»¡è¶³äº†ä¸šåŠ¡éœ€æ±‚ï¼Œä½†æ˜¯ä¸ç§‘å­¦</p></li><li><p>é¡¹ç›®çŸ©é˜µæˆæƒç­–ç•¥<br><img src="https://img.xxlaila.cn/1571041499340.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æ˜¯ä¸€ä¸ªå…¨å±€çš„é…ç½®ï¼Œç‰¹å®šç»„åªèƒ½æŒ‰ç…§æœ€å°çš„æƒé™æˆæƒï¼Œé¢å¤–çš„æƒé™å¯ä»¥åœ¨å…·ä½“çš„é¡¹ç›®æƒé™çŸ©é˜µé‡Œé¢åœ¨æ·»åŠ ã€‚ é»˜è®¤åªæœ‰<code>Anonymous Users</code>å’Œ<code>Authenticated Users</code>ï¼Œç®¡ç†å‘˜ç»„æ˜¯éœ€è¦æ·»åŠ çš„<code>admin</code></p></li><li><p>Anonymous Users: åŒ¿åç”¨æˆ·ï¼Œæ˜¾ç„¶ä¸èƒ½</p></li><li><p>Authenticated Users: è®¤è¯ç”¨æˆ·ï¼Œå°±æ˜¯åªè¦æ˜¯è®¤è¯çš„è´¦å·éƒ½å¯ä»¥æ‹¥æœ‰çš„æƒé™</p></li><li><p>admin: å°±æ˜¯æ‹¥æœ‰æ‰€æœ‰çš„æƒé™äº†ï¼Œè¿™ä¸ªç»„ä¸€èˆ¬åªèƒ½è¿ç»´äººå‘˜å’Œéƒ¨é—¨è€å¤§åŠ å…¥ã€‚</p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ å…¥adminç»„ä»¥åï¼Œä»–ä¼šè‡ªåŠ¨å»åŒæ­¥ldapçš„ç»„ç”¨æˆ·ï¼Œå¦‚æœç”¨æˆ·åœ¨ldapæ˜¯adminç»„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°±ä¼šæ˜¯ç®¡ç†å‘˜æƒé™ï¼Œå¦‚æœç”¨æˆ·æ˜¯æ™®é€šç»„ï¼Œé‚£ä¹ˆå°±æ˜¯<code>Authenticated Users</code>ç»„èµ‹äºˆçš„æƒé™ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼åªè¦ç”¨æˆ·æ˜¯ldapé‡Œé¢çš„ï¼Œå°±å¯ä»¥ç™»å½•æŸ¥çœ‹ã€‚è¿™æ ·å°±æ»¡è¶³äº†ä¸šåŠ¡åœºæ™¯éœ€æ±‚</p><h3 id="æ—¥å¿—è®°å½•"><a href="#æ—¥å¿—è®°å½•" class="headerlink" title="æ—¥å¿—è®°å½•"></a>æ—¥å¿—è®°å½•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è®°å½•ç”¨æˆ·æ—¥å¿—éœ€è¦å•ç‹¬çš„å®‰è£…<code>Audit Trail</code>æ’ä»¶ï¼Œè¯¥æ’ä»¶åœ¨Jenkinsä¸»é…ç½®é¡µé¢ä¸­æ·»åŠ äº†ä¸€ä¸ªé…ç½®éƒ¨åˆ†ï¼Œå¯ä»¥åœ¨æ­¤å¤„é…ç½®æ—¥å¿—ä½ç½®å’Œè®¾ç½®ï¼ˆæ–‡ä»¶å¤§å°å’Œå¾ªç¯æ—¥å¿—æ–‡ä»¶çš„æ•°é‡ï¼‰ï¼Œä»¥åŠç”¨äºè®°å½•è¯·æ±‚çš„URIæ¨¡å¼ã€‚é»˜è®¤é€‰é¡¹é€‰æ‹©æ•ˆæœæ˜¾ç€çš„å¤§å¤šæ•°æ“ä½œï¼Œä¾‹å¦‚åˆ›å»º/é…ç½®/åˆ é™¤ä½œä¸šå’Œè§†å›¾æˆ–æ°¸ä¹…åˆ é™¤/ä¿å­˜/å¼€å§‹æ„å»ºã€‚æ—¥å¿—å°†æŒ‰ç…§é…ç½®å†™å…¥ç£ç›˜ï¼Œæœ€è¿‘çš„æ¡ç›®ä¹Ÿå¯ä»¥åœ¨â€œç®¡ç†/ç³»ç»Ÿæ—¥å¿—â€éƒ¨åˆ†ä¸­æŸ¥çœ‹ã€‚<br><img src="https://img.xxlaila.cn/1572057054289.jpg" alt="img"><br><a href="https://plugins.jenkins.io/audit-trail" target="_blank" rel="noopener">Audit Trailå®˜æ–¹å‚è€ƒ</a></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé…ç½®ä»¥åè¿˜ä¸èƒ½è®°å½•jobçš„æ—¥å¿—ï¼Œéœ€è¦å¯¹jobè¿›è¡Œè®°å½•éœ€è¦å¦å¤–çš„å®‰è£…<a href="https://wiki.jenkins.io/display/JENKINS/JobConfigHistory+Plugin" target="_blank" rel="noopener">Job Configuration Historyæ’ä»¶</a>ï¼Œæ ¹æ®å®˜æ–¹çš„ä»‹ç»ï¼Œå¯ç”¨äºæŸ¥çœ‹æ‰€æœ‰ä½œä¸šé…ç½®å†å²è®°å½•æˆ–ä»…æŸ¥çœ‹å·²åˆ é™¤çš„ä½œä¸šæˆ–æ‰€æœ‰ç±»å‹çš„é…ç½®å†å²è®°å½•æ¡ç›®ã€‚åŒæ—¶ï¼Œå¦‚æœé…ç½®äº†å®‰å…¨ç­–ç•¥ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹å“ªä¸ªç”¨æˆ·è¿›è¡Œäº†å“ªäº›æ›´æ”¹ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬åœ¨jobé‡Œé¢å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>Job Config History</code>çš„èœå•ã€‚æœ€å¼€å§‹æ²¡æœ‰æ²¡æœ‰ä»»ä½•è®°å½•ï¼Œåªæœ‰å½“æ„å»ºjobæˆ–è€…ä¿®æ”¹è¿‡jobä»¥åæ‰ä¼šæœ‰è®°å½•<br><img src="https://img.xxlaila.cn/1572057782047.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1572057958019.jpg" alt="img"></p><ul><li>ç‚¹å‡»Show Diffs å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å…·ä½“ä¿®æ”¹äº†ä»€ä¹ˆä¸œè¥¿<br><img src="https://img.xxlaila.cn/1572058118436.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬å®‰è£…å¥½è¿™ä¸ªæ’ä»¶ä»¥åï¼Œä¹Ÿæµ‹è¯•å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½è®©æ‰€æœ‰çš„jobæ—¥å¿—è®°å½•ä¿å­˜å†å²è¿‡ä¹…ï¼Œå¦‚æœjobè¿‡å¤šï¼Œè®°å½•è¿‡å¤šï¼Œè¿™ä¼šå¯¹æˆ‘ä»¬çš„ç£ç›˜ç©ºé—´æ¥è¯´ï¼Œè‚¯å®šæ˜¯ä¸€ä¸ªå‹åŠ›ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦è¿›è¡Œé…ç½®ï¼Œä¿å­˜å¤šå°‘æ¬¡çš„è®°å½•ï¼Œè€Œä¸”è¿˜å¯ä»¥è®¾ç½®æ’é™¤çš„æ–‡ä»¶ã€‚<br><img src="https://img.xxlaila.cn/1572058857084.jpg" alt="img"></p><p><a href="https://wiki.jenkins.io/display/JENKINS/JobConfigHistory+Plugin" target="_blank" rel="noopener">Job Configuration Historyå®˜æ–¹</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>javaåº”ç”¨éƒ¨ç½²</title>
    <url>/2019/10/12/java%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="Welcome to my blog, enter password to read." />
    <label for="hbePass">Welcome to my blog, enter password to read.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="762879c2105bb4dfd8ef1efdb11920e401fd3c30ae1ae476d4c978e8e0697330">d69a90776b8106231e3f5503e1ddcc136de8bd46ea761b7fee0bb1563c6f63d3ca9dd51cba83b500b561e875e755d83e45370b2cce79e3c7afba98a0a85687741edbecdf7e081dea8cc9087c6dde265ecb43b289a54d191b8bc39966e4bf8a827fac2b57afd4bf9ab3e0d24bfd340809ee0d026336fda77c51c108bfea1a3222a05b4b1bf5b47588e535fc4c21d07f99f53d933b3e71513c72c7e4a2589b4142284b47f1ba14906a0ffc356807545390162718a29173c37c85ad26cd6483da68e6e6833ba0de4db78df04daf38d015da283b59b5338ba6a4ef174dbbf373fd1767d0aafb6839bcb40e289e6aa52dbeaf93fa703b165549bcd8eabac8c96abb982f76766ecf5e382de5a62de361a98332ef7f2a39d6f26dce8966a98f169609ad52f19992e7033ca0acb5190f124985506400afb2acd5f3614a5fd50bb96810d3cb025984f9c90c98b2553bf9cd4efac0294671919f6765e2ee5161dba883a97f94971631e849b7ca96194b79fe3e3373530088a6780ecebe183f9931d7b00fb011d6a0196acaf2f2de86afccb744fd4450693a855c1955ecd16056d544d253aca4ea656b4c521fdc20f664e881e1d88eef015bec7c3692b75bb872443a8aa4ff4393ee2f7c24483cb6dbb114196af16c8bd93f271f5bd482e0cbe237f666737b6018a5f496aa46c4f96355f64b57b1ddfe3e17f7e9886685280567f6c9c7a6061fa8343c9f7f60930920048b8592d133c3d2d2756d1580212ecd95150790d616cc8208591e8716459593bbe8e840d230a239cb1d267e7bbe057fd6dd9a3ca2b26c2e92cb6bc214e5cf1136b6a680d334c45fb7d9e328abce35075fb47e5300c988d5f09993a6ffb5462f672dd7569392df19c7baaca7ce6f61deacf578b74f075d516fbf58cc20d9e15a5121c94da8dfc02791a1528f794848105f68186721b910d0db38f878d9c4d029341ba185d2a756153d8f64e034ecf2963ec2477ed22085477d910884159081dfdd3ece158f791b9e593606c16689cec4f13160c5d284bdc1a0378d7486f25160e459a42399e2f00716aae767d9bd7c1bc8cd67e768ccbdfbfeb5a13865ef9eaa5d2fa254f8e1d3d1797e7a68f51d093727929e365ad3d0e348fc96e807210b0aff9ec5f9eea2caea1d0b1940301994d3560183dc5440fe6c6ff082710ab9175623d44ecaa860d76227daa38f11a760fc2e3b570a94c8792c47310ae120313dd0051013f52ef391d1c32363efc7a85be7e288847d7f3e8b73a44ba70db4bca5f8eacfcd03374b8426cc00a8c6bddcc820afb7e0bf1db2656206c99339455b672a1c5b56e03a1819c1a0ee6e90ede0d1ee160767bd70db8e27706c69312a5ff366b543683e0c6ef5f0550aeb94f5714c924ecee34226e3d0c3432a46b85eed3ab1797ab5dfb09eea406c88ec97f20de8edad891b97ac020e0f38cfefd99ef808809d256e82ea3837cacc3b355611de2403b117c375c332618c99e87f0c21a42e9ddb71e3c5d37338bd292d0dd2c8f4eb0c8bafa33f1f94914749f759bb3433c1ebc6caba203cf263c4f411d4a377731e1c7e0983faf778f00d2ec66834b6c4436de19ac463791c6669a83fcca139620489ba8c51213b0cc5d81c7523d88c4778c044b508e5ec8b38628082b9dd9f211e1eca1d0b4e8735d16f4bddec0d157d8befe2320b5c0fc97fbb332673f4bd85fe0a44667249fe3fb47bdbd7b9b1452b589e91f45a55e82a1e31e241036485f995c4f1b645a175c28ec7ffc79635ebd478c38307b9f9a4eaef7aa48110d63826eb43ec082c575b301d87a5781bc7452f5a19fb0d5dbc795636d2c3ef05220baecc3d868960ec4b84aef66c25e631a387e63bffe37ad889477d6f788322df0b37a123a23e6be0cbc7ac3ac8921bdfc303badf25e4ae98269068378d27a2d62f73d001549a568865cadb0697fc473ff325b430ce98b2f14a57de7b3246dae0f4cf9c4928e1b9f224aeadd5f9fad3c17152b05e525c3b7b7fdc5e3ed5d5ae8ffdc108e5bcdc54348543c34708535ade3f6690c797a6d491785532b60bcb90267676965eaf7276085434b1c6f1bdfcdfd0b8f4de3669d68a3024177b7eddb2c97e6ad78a7691d571ac80fb104e446b4d26174c3f10188043ac84355e18e92d407d0fb2a90bd0c1c44ec4c961a48ceba7755887903a57e588b8b3c11bf952720e6dc982134b0d0fe61b3da63edd4023847f826c5026b7beed960b6e7a2e864cb7ac05d0d8cac6ee311b7d5c92ed30aa155a4f32ca24b6719506b596800271e22dfab9985fb918793f3096f8a4c3aebde0eae88e374a3207fc7b4d567411f763bd029e6968784cd4ee3c9fb760850fe61a1c05ec6176c1086c09b097238ac18b8237cb4f1bcf8db1a1cc3fa278067af8ec97a0fd77337a859661d6060a2aa236549bf43111b72d2d7aa34111d4c4d70d8ff1bcb28498504a910e61bb4e04be07910766f36ca4ae45f5b7286ff2f9fe9946ba3f1025a6de6fe803491787e86df44e3d2853958f06f8f0cbdb8567ffd0e642124193b4bfc11e0e261e2cb1d6ffb9a71d3c2dc48e284db6bc309141db9ae05510a168d6067f48baf46ce6172a47ba0b64f388691ffe69d38ab626bac03548ed297cc16706d36e6294fa07db678761be2866d4021075dcbeed3d993c8ad1e8d9eeb25004101be4c6a890d0231ab48f0c9b64836f6795f0cb4dd63282df9031cd252a30cb472d567e2ca122ac3501f05246be4a79cbb6d032db0ad5e367f547e7324c88864bab64984e9a0bf22ee02f0149d0075267478961e7ae7c5b617d64dacadffbf5d75c1d3a907635d548a2ce18f738b5936db1b3c0d106c037a41f641ddbe2aa2647cfb51284799a6f7cd21c172198c59c829647f33a3765261717252a335a46108991a3d6691137e57b8ecf5e24f42b007a882ca881f1c8425e2990247c6b0c1e50e45a6733f8d17590efa7849d431568c0ea25cefd1b50c48a8139fddee5ff7aa4c240d6d71d02a8d9a9c40f2ca8429dbf4cc98dd7289cefada5243841392cd75066a0e25e8ed536386a9c09f951c7c9baa2ed0746673f90af12836ce47f8084ecd3cb093ac5e3d7624aff50acfc27d923c51c01c8a63dfe787b52ef995389c4b2c0b8c5a872b28ee7783a6bc8d6cf3a0773028e73a23030b6afd57b2dbb780483a8079ff49904df8af61ee31210fbe0d56816e7a5f7baf81b10532efb6799615b728cd07717185babc9156daefddcb35f4a3b448400ad9e4a93d96e1415701d1a9e372e5530fd820870f9642a709ce1fb6bf8d255fd25f56bc4bb3bea1b85a4bf2548524d278cc266ab5689eeb3873668ee2c4b7e7f2719d77501a16c7b6b78514ef97976be19cf547128c8d049652542e061ef970bcdfc20e49444c4633b65c47f8beb4a17968d4a3797852292ad5d9166f3dc66df80458da950ab717a7ce5320fcecf096997f0aaa5910d1e8e8092306c87af1625943fc3bdb5e7bec60c515ea028c4f4b44b166896da1607f129ffeb836c9f6b309e29f054623838b5f9790b409a2548a19b1aac889915b886dbba9da24ac2e0749712c182244393ec0f63ccef2c887aeac8e75d0e7846c2de4b3688c63144f3fd9ae148e4431eb3d8c4cb67b2b57d163a80364ab3e6bdc309e11cc3937827824a31ffe4ad133b765e775a9ebd421bc8563de54582ed95e5a994eb96d24337c7e562cc796f06db1457a119133a3bdcaabee985354224d61c815ec76edc95a98a89c145788099fa3d16dfd3387fc902c7f1b196e36231a3fc70a50841213493807c025459ac24d6665326c06e6948397ea0a4382f0f7eb180f82392e83c0862265d658dcd9e2db1cd6656cd65d60dc620043251983b570c5d21b0bee540905245702e6c3cd6acd93deb7761bd3582d3f55d96f8176e8b5f5b2dad39a2dcce6177388380c5190a61b4b9655c87d6b24f4e26199fb0d01796ed377b10680a887b529e1c76689b22f3e55a0e8025a42ccf512f436e99dddd77461eb5c057631bd3e4470abe1982f63761e02b886792129cf41a860daae491e8a3f80f3ed1fa4d69a38a7ecddc01490c9536bee63efc5d7321bfdf97edd941cfcbcd551e1f619e22de948043a2a1620218f7271807a1eb80612a11dc64a404f9914adacbb3929d6af9adc5c51a54c0aca7e731fe0c6505e1d55ff6dc52d9c4c283360a2f292f1611bf5d2e55382df5eae5c015055f75fd3017a7e2c630f2d6d376c0b91d228d5a658f477d6946b700f7f66e67f48ac50b55f9fb22d2c8377d193b128f1a5d60881db9f6ade20099874a2bce52864842f0867d04b81e115c1fc5066883a3b7e689d9b9e6f706997b457dc86964d4bf0d1312473fd0af7d04a1051941ebfb4a3f16e8f17be9d8efd5237a325a44b85219898fe4c526871b13ef16054b87cbbe47c4310fc180d76205fb32542b6e7c54a3e7b927d1337ad54127d7fc5c8d05d6a775ab14f9e215965b9f3317f6e8175af32aee38c423d3dde57d9b42155cf62998f1d01aec9ea4a6770bcaad26b999c9f00ebc2417cfe7e3ac06ca2cdcb26b48cd1f0b0c3447ee4703419a762cf4fee4cfad5395dab9af3c50e9503ab805a4f65b9219c9654cd7b07d9bef649c5ce837f2499d645be40607e839839bcd6a526d46fc13ab709433777bc58bc07266856ede3c2764cfbd3be7ab0371527a97f61802a3eb2d4c7f46716ced162bc795b8c65c4ee0a4a85e0a0da95ebb4ea384d69291ec1493e4b1e1e491cf8e83ad69ab79ff3b9ed8bd8963cdedcf90c0b49903fa9e1a7bdbb196b2cf1bc0c31e7698dc0aa5ec34b956f82cf7c1088a62ba40eb80ba042fd5edc686786f58aa4b58b9abd28d5c7952732ea4c190f60b4fbfe1ac3ebcd53ed8cdcc04b97e23eb371e59872cce36606187a6f97c7f9b42dc0e0facea7f60377533b766f30264f7c93a6c864d289cbc3b71ff56f94804317654452a4be1cdb2782ad422781958940dff3d871c80d711fa36ab0c8f09b9a19f04f91f35fccfe61948c9afe1640009faea4e74b0382ceb2135755133ad0044ff85b1fdc6226b0c9d8af37f5468578e6918c60a9972bc767d5e628b9ba75c1f705381b0afe02b343f172ad3ee9813bd854e0090ad011b69c87418230595d92d6f14f8cf7690dfa453e6776e3d398ba636561dc081129ba9cff43233e101d997aa22e34bce148f86034ff9604c555998ef4a5c06f277301d649a3dc3eeb27959a90728d02d342468ead7fc5880f9f1003c7dd348822b8c1ce28f39510ceadb8fa436aa5c17f749035cd8e14681feb5754d7b40ff56af93a7504a6910fa51c0639c8cb5817a158b821223c77f0036786a820a6302dbe7a18b66f482b18389c070b4dd0846669e44721d04440d8ff1cde638d17cff8ca175a330d78374655ffaaffc3db7b6d686ae56e1ff56a6237311e1ba845823329e42071119fd6d2ab7ae23a9be9d766275c25e7950b4cfcccb8c1a53ac3e22b660207c115573365e33b9a42986e1fedd861e6fd9d814f1b0419a381dfe97d97a4fa6ee741939472b142bf77bac23e57d7154e20d39458172bbce8dd0506e141e3e1cdb81295c47536d7b384db3250f1d7fc331cd473b94d6a8c61c5ddef5b49beb3afb4d519c274eafc6b297f6adb62d736b89023125ae341495358f7c5de95af0d3a598e7350df343c2574bba7c0bc3a858948d1e39f2e65aeda040b8a0203a66b23e2756116e6c6e92634fe8ee0ff1a4094732e473473d200e02c28dacd22fc9ddb92271fee7ee89adce669e81f2e540d96ebca57338964d7333bf993a372c33bdcdab2697a4f2ca9c5d83d29ae6c203557783929aa2c9e0379e4f005028ff58bb3f5429276b25204e08a2ca4fac93149b37ed1defca3f0be00556906f4f782ae55dbcda20d6069a5b8104e910a68325d4c010b79c89ebdaf15d939d1f54e9c36bb8ddfbd473da4693170a26a75b37be1ab8a30c3ed1f988fa2387a98533fe9f72eb4c7f5fbb7badfdd924a35ea615e598fc968f26045deddb2f77bcc0eab6b3fe7ff01a886fd64a1a5057b92c13da8f2fc21b2eeb9b9eae077a1c968501d252a01848e918ba51bc955aa8a29c591e80700d31a35637cfa603bdc6bbb3601db4be3d51d7e4aa48b6de9dc97144859e8f5959e77182aa75ad3191af3cb3c8aac50903143e6f2109bc3ae16ccc44163942728173a786fba42c65a77af4380abcf6fe82c093b86c9fa7f156fe761893809239242c92e5b8d3fc2aa3841ff4c80487529ff5264718402d07d7e358e9761810b58f5dfcc8ce4c5c8d20e06c03dc66a080fcf714a218c4a395f3c7eb2f89788048e3ed322ce1dfe7a22d425fb0c04bdab36b8cef93cfe429b55ac6c330c04bd9f0c8a04c9fe355d27452c5987241538b887b7bc4a2b7de079d6f9a7df371e808a28670929906422583afd84c7f035c6a9a428a9a7097f214de88e1e771fcac7517d208d87fd8670157fe6b28acf55eddc77d3c10f7eb7531e2756077bf9f4ccd6356215a16bc52f77c5d5ef8c677a0b0d7487f9140a9707d0f692905171e12648ccd83621ff292a99862f714f03799a309b465605e210e6d4095af8a989e1569b39e36584db14ed9409fa6a75165ed0265f9d1595b7c3256440bf0b285639bf629020e30c6464f1f238d906e25c7a193c1242c9769775edeac9ef261feb616efe848520032944556798be841d06740e21be69160dc37270773e9bfbf63a2b232b7456400042b8aa5b304213c953d0db7e192cdc9b8039fa7e5f081f793ba84e5f453fd87bde15dfc9da1666da7a05d2a115739dc8c0d3e8bc119d4e2198a05551b073e5c29ea5f602a71f9a5c3e3d29f3dd83fe99b864436c8b16ae2aa946997530643c3ab30c87a093a37c790bdaa4fc8d79c75a5729f94c53b27c043ef2ce9c6b648448350a1d615b1fc5e1b6e8b2745efa1cc5dbfe17ba9f77b284831964bf37599698ea88a6ed02483ba74c95d8fd56397378ec18b8ffb889a00f100d774d58874b0a7f7cb92849fb549b368b270e775bd82bf2a5410c5b5b24f14de212409493c668dd84bd24bbfff203995a6990e0de52c52f7c8f1f79762553beed33c9aa854d9ea8eed3e9ec3c7b6ceedfb8d6b5f55902601e60007cac413a9d44f7e6f36318f3e074507ec62b8b0fac452a35de5914236f0d77df3975ab36f4f8becdc4f3edf227dde7fce621afacaa4fda56be900c059b2b546ae2db142b5d6104ea20ba81a93636377cc39499a615aceb85d496222b656acc969314b09131643fc390176cae2bac40dfec127d324ce25143b05c5fbb33f4f0eb2530d3c0c6c9af6e0930a1c007e0f79c563169e64b1d1d606daad72746bfd9f053c1740c4c2b67ee341f90b64a2c96edd959c008c10e8c7eade79495122bb97ad860a9451b75427571a935b317a867a2a5f97b1bab1928bff6d9da4556c7d399ff3e40080b2a5d867ad7446097f2992a7ae1cad2821005b34296e7bd66444ce8c3d5ee38020236e9122b4c5fb6bcc3aeeccd7d47bff9b8c95aec4ce80deef0c9f3cd790fe2af309f1e7ce993cb3fa3cdb3facb384d8855c1f80fb264d885ac36ce3b62d3e4eface6de2dbebf0fe47b956e696ad76295251a70494ed9d8d0454941f987224fa7a3cc94fae180a7934cc72576feb8a5f64141ce887bb9623136eab46e62057a4da149642ed1a2fee35da4a2ca9e367eec29e2e1907aae7f69f0b78b56c9e765482617d41b50a538ae9af0e0a9175c8af137b508091ec5565cc51711032f270474e733e0963d5f1449455bf87a52626705753067a347086b55664492d4ddac542c21008793f4e03260b27d0960dc26a303c8be2435296a84d670bec1c1db678e9dba807b0ba36988c051df91d3cb9d89ac90c25a633dd45e041e3988904635f8853df5361812924f391e3e08f44affeff12d6e983b4d73f34de1b904f1bcf3d29a5eb8e9474e4a348d41f4d3f442143861c8897d4905fd4f3d17325c2b2dfde10fa3ad8d200ca4db7c02bb1f4fd21e102aedca30acb16c803d48b8cb336bdb053677f7ff9036252d2d805419a333b9e7ae73ff3d13edac50ef2911db7345d1de4b54f917a2cb9489a004cb89f71daa5ad022bd549506464ecd0c0527d478f419bf7106045e7e1fee25c92c032af77f8f89368afe8e418c54b0519c8a63992be08ad63a6fbf95ab94d25a48b7e3cd24660b77e43f6a8c64a8384a3767269c412f91582029df496391be7efd382bf82de3c398132b33bbe82aeae7746b09bc8954eb81751e9612e974c841751ebd3ee817efc8f0291fb5b5814a3c71bc9153015fd6ce8acce3b78634de3c499ccc93b1cd84620ebffe51be478ed428f5fba32b944fe34e0b6b3c185475df1fb1c4ce693ca9ee80cf847bcf36731160af552568878e1287341648b36712c0b76b87ea82f3b5e9df9297365eaedbeefd419e273120cd9e1ac943a37760e4783c05b3586746b488f053f8cf3b40a708ca997c8ef5733c0db64d3b2da810c8c220687c9f949df33e9c724c141467d3015be73c5f7769f4dc1ff7a83cd42d1cfacae15dc04b3ba4f0b2e7b629fde5d01ba63b02efe54de3795a835402e52cfff993d51d4c4dedca0b29d23b7af7f41c95b9460c4e47543882537261c2288dc80ddb889521598691ec68a473b3fc8a9a3cf9b398e4497056699ccebaa6dbd047c97ae1783dfb7b7868aa81b41d66625eaa75acd4d01eef8909db463f221c9b6dbb9a6d6e68507746a07ebb321ee75bef50b78d2a4d2c545a8e4d9c14a9f0128b0b62cdb82b365a625d8a03dfb66b43e84dff75455dbd2225e4b681084536f375b43a099ae3e8f83bc1a20760b7da0e91d78f4598281e4122c2bd11d1cd2f98fdd153517c8abd7e4e881eb4e39ead4f08234998015e0f2a12aa2659a2da095701340bbe89692aa86284133945fb7b5c24ff2bc77e660e0a48968d49e952db97d6311bab9cffd9f934f7ca6513a1cb95d615d4418153b0300f71ccce8e28ccaabfb74e0601bc84b692dc97928260cddbd0dfc6d0cfa60fbd1a684c233f18294b380d4c9ee07a16f716cf4ea882a6e097f467c3800ed31e5fdc2fd355107861ae254e7704a122b6ac71865e9633f0d14543ce062dc9d4851b57b30626b107b92605ebe0dd95663eb21caf126f89da80526e67e9481807134cff47d44c944ea51861df09ef72c71281092db6e4289152af708b697f6a626433a71e73a4c729307f5c8d28ea18afc6f76bafe16cd077f2fae13c2ac22c6ee8c39037e051ff122f66147aeda358f6d5e01b65537cd99de66bf0beb595bc62f98fb0c6e87df9026de2634e2ea5cf81453f85ace4ffde31c14f6ef561458f50fb24fcfb06ce9b16eba5dd3868f80afdf99efc60aca49183aa159225066fa398fe3b3994608d177ac75e48a0ac17d158663616e9e371233a22c37456e687bb766a5108b04bda5d991402f80528b215c8dd0fc11399fac1a1d9747e1d5224035df377aa5e245460b36b8cf1dfe40ce002adfbae13fb88854d97eae5791fb11f1518c066e31096257c353e2e1a0cce22de58e83fff8ac9bcef59ff4391cc9f52648707ccf4873df70bf6340657d7513daac6f1e91fb2c9327a7579d033e209c77f68aeb985be5632efe8eddf81f7bfdfda8023f276d5875946ee073ce32271ae19e6cc3843efe9cf5125699e4df3bee9e73d02018892f7e51a9825d33a29c1be51ee504ad9adcdddb677796312c8da0e1ce71a0dffcfa14682d652e5fb59cbd9d69f751413acc559916b8be488f82b64909becc0f362921ef85b5d0f79bc56a927c230557d1ac07cdd1bc20d00e47b899aad2164620e87f5117b7a358ee32de52ac04efa0c76c45ac7e33b1c8f8328336c290dea44b0122003661769d646e8e54e895d127902538c318f8ffb9a64bc37b1f747d6b525dac55662d8daa817f7cd6dfe6bfe7faf6add9111a1c634fcb9223ca4ef4f1207e7e646934a6c27c2bdf18a3c44c7d215bbba0f20a5e796f1636d01d5093817346ab7ab14749930c1b47337cbc8167f536ea51cd42a3c57ceaea6a7f854b82d97f633d9c91d6d7d7ccc5ac42f34888d6e6bf2773df2ca622556abf1d56051e0d8532ec2975a1134881c07840fb2c6133b4f97b8cd35c3bcadbe24152b3be9bca86ccaa12a4039fc44e20d4300cdecf2433712ecec33104c63a66b8421405d15074fe7e0779638ac43034334be2d038a0c0c143d2f368de05c8269bf2ad6ae6ab1dc755616f227c6812b2ac7381e3ddaf900c539edafe5758b4c128d0eb1d682056e3fae08196424dfe0d29d8b7824ba40774117fcac70f8689f6bb37ae1515606cd786504dd4910c19e7cd6d196b9a7fb03308e31ffb016a127f2f800479c5a954b427323f75057c55ee2de8d3b8d8070e1fc8f250c5ad46302e022670d8d19508da2f1f94918613e0dd20b8e361c8647f2e465eecd724097f038d27e2971ed09fa8038e1b03352e5f32c1d38f6b67014db6310524ff45a265c937fcc7afd876bb7a4de4ee738e8cea35ab7a8514dfff9f773acbd2faaba05a854f79922932cf024fece1bb9f9a305d937ba04b532b598d27b02c12b5fbe41d74e3e950ddb4a220804e9088582d083e47c7886d8edfcad1d54d933e546da54c4f9a5e81d361e3c0ee455ca87329a5841ed7ebcd04bea421f21824db7a0aca720399cb4251f9d587bb32862c271eff13e69aad933ffeb72fac95140a7d30af232f3df2b01b421b0770763eb5e357b0895312577327b8e8d244c121c14c8c8a7ce4ff9749d41c7d5a4f3192e57b64e28035699e1520a6535d71cdfc0cd46cc461a64980145028a1084ac51ecbcbaa64afc1d1e26d60f803ba43f41f54a883f78f4a268c03c7efe2de1016120b25661d844afb8a2582a2615f8db3ae0a83b952dabdc7397aff578b1e78c510ea89c39033b38ecbdb82f3b53dc80149b48386fb221381745abf3c687e09c16002b5c196c75c725bfb9355a64222ee198516048c840947b55f4a75c9e67466b0f7a953d25231cf9725bc73c3a1ad5fd7f0cf45ae7fba56f7014f99c54404c1531d1c4c869ca76aed168f37df1f60627ca922375d1cc685f83c5fcdd2efd7df9e470d696321e30db0f24a5125ffca8347b45bbc7cd45002f2c20f7a85c03a67420391a2b9bb48813fd151ec0d5ced969b3b68f32c18e5516ebfbb33d9f51bcaf0aebe6a6a3ffae4270bb7dbc4be6f15fb154ba2a6dba186122efc879e403d1b249f4af4577980e7c94c94a5bf51b72bb464e69a79aa51b0dc5f14f8aa5b0fe0daa2723510a6f3c50aa60bc41179c1123088e7e08b5f25b62b1fdb4700a01b51d480bc1ab1e99bd064e3335fc7c6a442714b54000e0d4b08203405d517ba4b6bdc1b55430ebe75db31450f2b195de3e6c5987ff2be61481733349767ff20294976f8235672fad323c3cac8e6b3262288eccdd8c02299d041321e46308aba0da480e3604272023a22a9db7808142a90de68c46649ed862483c3d40cbd26ecc37c06a5db09055a70ace83029e896f74e051b7e98575e65a8f414e0b27151fad7516e529ba8a669015bc647e7e56d19ad13b83ea0d5ea4844e2b9afa40aa2f148a1024257ed4b0f12279d2fb30be693d1e5148cb092b1fd2c9c9a28f198513b47e7d977805a5e7b06ce0357c0922b8b72fa0355fa32d85ddcd3616281c0ac2709a08b14890f9d35b50eb2910621d5da22a9eb07295ee2ea5d0050c2d96fa527cc43200a8c01106c2b0d9f300c58984db5dd9794fde8c3c0142498c88237d7906ac78efa8dce1287e457ec7d39d6f2fa7e26ceaf1a829aa08beca8c70f44bac09877cc5abb0f894911ca37f0f498c4ed5d7575e0a561998003a6348479048d25098ac01dc82b78e56ed1027a93a4428186a4a9fa1eac851b063e2c2b9e117ac9a7598d465c70efdbbdf661026a05c60efbc2644343500ec5c0e8665afb9c7877610b857641d7cbb7cb902c48e9dd2d97f2aa28063b5a565503c68001245e933705a876f19bdcab9c0f2e4659182f060af2df628bc213ddd2ae828c55f4ed47eebecd7480b926fb6a8d63a68c8a8e2404cc9906703d8f03b42c945c112dd9781cf22a2ad7f01df529e582e29b0fa9ead5ecb603281fcf581be78ee783dd53d719fc72b8d40ac5ad5c6789a7c0e47cf1e2b90b0102ed443ac90e1e1e8182078a573016bb04e14b74a023acc36b4c8fa3b6c2bb2517ec37644feb4a328f16e0e525e3028dbf35efd45eb6c6a7ca2ea0f0be712f7fb8c9cd028bcedfbd198912e23c78c35d81244ea02b86cfe3f50093da3d8e3e4300648adc584455a07cffbbc53b59e7fe8870fa270740e1ed5bbdfc2d11ec2fea1fe0ab8a4f68ffb6ac0faada03715db07b21034b29cbb69344a1a6e2d8ab8b5444af7db85e07e6f8b649f58171c9ba890fee74f0d500245e8c7f8b96e7c39d136160969ee9cafb92fa225344191f81f58ef9fc4e940f9d3f190fbb8af1ed5da4ca6797671dab2c561241c4b30336c754d9b80b5f4396e694db241d2cb34bcaeafb8e88d841193b90e8f43b72f0315836f9f85cd1d8bd48bbf841a09a8c594a0177f1cd75289648a2e67c0cd9d07861d4bfc1bcc10c5b258770a06b8295416d0857d3fa76953d84759f18cd3fd07e3b111b806d05608a05f137bd3fb3c3fbfd812e4d0774d47d5856384eadc43b772d40784e3e9fa172cb759833cd6b6ea8a2a22db47b5944fcef8ab908dc6bc765514934a2190f095f116098b18524cf04ebbc6bd70c3dfa54b2892559dc4b8611bb4735c6912baa87e4b6377c4bb49e08d33fa5d9dbad5719a1211e3b2de35f6d3f72ea80d7dd0c1aa42d916abdd38d69d65eedb27abf5c24080f858a660fcb5ec9a5b5072c771217231be6e0b332f23f0b4bb77766e27c6e08f2ecce744fb02072f498836d3700f03c05c8f3d06c347499cd7df5ea6230ba3ffb38584a30082f5c66bcc170e0c202f2b075260f98e48dd1d05b74c1f1bde80d258d8195d1fea63166ae3b05a960068fd8b480102acf6cabc5d1ce341850ae69c9770fe1ec73c8b8ca37d576b4734f0553d9fc9db68e809f26ae9975cf1e1edb5d0ec201acc2d944b694d47728cd504f9f22ce7319c944bb5b68293380b948485c838c8e468e0066ae268576c86d52870b5f244ca1e291de7e4b619ecbff406ed748e3456775ddc8ee6979ee839db8e3819d9d6c1359a1bb69f1ed990ef7504e06929948d227bb004121e5053620af72bca824f8dfbb3011b0a6bef2aef16b6e2db493107d17b53707aed356d639fc03ab6aa7411d2d4085080374454192dbd4fe54b3c73ca88f43f3bf19c3e9f5759286814fa468c51f069e260759e90d12d02e2d8422cc79d25864608d19a4f036559090424a1d087525a69744553a198303c50ffdae435ef20ebc30d0f89de55913731411348a567b333a56e52d86b257a860293f75d05914652433e16b04584db1c198b51be69df58e0324b29bc0cdd8e738c16cbdcaf58989fef275b33d67b31c99952991e7efdd1e5144047c796dc0059448b04ec904e46289fb1b66a9a1511d8abc164a262c62c79cb5ffeda58a1489985d2607173115adfbac22c1c2d01f45c4af6e38f3e9507d3181e1020ad497fc7156229ca7360467b70981a2a3ee761b6c2a891864fde70e8d875448e26a9044b19e5d586b001168c6111fa773d9ad4735dc55bca508e0894365bd6531de1ec1e6c407316bd61b2ab689aa0c3ffab1cb85a70100e4c69291519ef3ddbab3bd4dc3675bcd66a36e31d0cd08916b23fc5764ecc1847deaf8ca7f49a6be879475cd11a983a052d9f28e33474ae4308d4a29ce260e543dca434c224c58cefecf8cd5ad01d100b3c9ddeca51e12483fd505d0562202d2797992f71a7a6e73b2435a0f6f5773eb887fe0d72ce7551680e2aa31e1e602212ed59e9c3d0b57d0156a6d6765a9580f3d2d427a1523641708bf06e3cf63d3826882b36bcc886ec4c2f5973c90d2d9465ec9a7b20edc4b2276630ca77741cd8865f98b3b244bb97a26060f5cdb0c3bcdf7323d6a3d44ab799598fb70b6350d883ba67d4beda83031908c56af0ff1ac3748d568771ba6a0a8fe0f8647a40cccf10e0fbc67b9e56e432a778f05bf75c65800540689fefd918471984a2e8dd46d1aca935bd8cee1630ce02596d70e43635f5ef6fa2a845937b6054529473637b176b78c98a1cb2595220dfadf5c2ec4c395f8cf96081f7ac2ce44f7db05e11b3ff09d3841c169b65fa5acc56fe471afc9797a354a814ff6ec4da40dfab4685baee967763d1b6a7876811e47a70b3d3c9ec6623378ca42a5bcd7a57a1ab3f73ec705220ded0ddfcc9318a984db36c2f4d2bc6e21314ea58023cebe720c755f3f44864ac4151834397c5f087181f9f9dba2fd6141e8c6ce81e215e2b1ac95d6a48f988be5da9fbf9b0f40548f9a5dab9740c40de3287aaac9807b4bb0084fb92cfa19f62f15ceb58ef1bab623b380fda9cfa3a02e5887d5c1d7bcd3df690ee36ca2fb1c7748077b0a40216680e4e68747f127cee515a012999e6276efc27d1ae82052ce5c234dc76b6c0d680105d99c335778e5817aa0bbbb1ca83b84dab9be1d77f0e55c588aa29566fa7280917be0df01193e4ee084e9f1f867d1a9c9674bc5cca8077b6b7faabf848ca2e79a061fbaf467f8b28329db5fa90311d535cf26bc07c75dedb9adb596ecfec8b2a34d4b23292c99ec192018f79d1b3125f4684672c019588cc405a69ee15a583ed98cafe7b19a247aa6ce10f63bc87dccddd80b8c12d905c84e9cb694db50d2d29bb9bef944e389d23af0a2ce1181ad8c7aec556a9fcd44c8079945fd68794d4b427ef915d6424f720f73c278716c76b7074ce8f3cee85c87eb82bd17abe21ad9109498fe5269de88f9c88ac6911d986e4b0818499f9234a446ecf4e3d0ba801469944566c538eee81e780a40b22f28601b3261cb304ec2e9766d63d9e57d84e7e98085bce01eea34132535c343c09bad8881ae8a397dcc5a3c15256c94c3be518543f830e7b9e5c03d35e6a22e49b4c71cf9e8329e76f2ffaf1739167c4e3c7c10841f42974ef351af67428728b5c7d461f6f3975e60d45b34ab919f0519ad2f0a85e25e22b445d255030fc89ceb43a58713a3074c4850a03da573af54ca64dca0680c9364402b2dc0d7379fc93e0f0295353a00dbc7efbdd0cc63fbd3b1e189774e3e664dcf317280bca78c253749f08b4c876238a6c01a9b07cb0177eb629a0da6df971fe126adea8d4248d0283821f92c5ee3861e785ebf800a2b8ec855c22d8db63ba5e81aa6a87cd5e9b35f93b5b4fe297d69438d0df3f27f84b64e97d4e6a25e6cbe6a3416fe4e76abb47c3295f051c3df855ceb6e00f76f9844ec0898e5106f36b788999e3c5e745aba45796d829b7d11eddf2442863de8711392fb51c2537064fee59801b28aa304d9bb3fdb220bc71a9aa0cc04af87ae1820b8e4ba249f3295dffe06432f1b25204545afa382ca1611303e2bc9b4ca4659cb975f4b1a285decf8b2a23568ec2285ea47a759ab69be88b58cf22766379de4851b146837fbfc794eb41a6b89fd23afa288b60350813b39d094a89198a37532953024ff874f9a7c7f6c223a165aa1aaea6509169aaa287a8c5ff744510d57b378e10a14bf95334513ded6b155760911a184f37d1fe37ea964f301b376edabac0af9d5b246750816ce7cf1852cd3cf3ec2035ed4324813049fe47d46e3bf23a2749aff7b0a2a60b7c494c9faaf405c91fc81ed86d92d639729fc608d6ce53533213da5e883d440aedeb02f01704c793c64dfb96678c1e54a41ace7eb5ecf0da1cf23291d059460c7ef58051ac82dffccd6060d10fc9669e2d580a46e330454619253fd58f031f536c8400a25848afd017c40bd7bcaf55d9c0a20885958194b2818153ccbecbaf546fcb09dbad899450644d655cda7595237ad2639d19221f626b3a46cd455ac52156ab922609cdff9012355e1a37adf1b65ea7cbdd65043dd3900305ed9b89aa2ca5c8168a88e37d70e4cc40771907567d3daf8fce62f58d4101d67c1177735ae86a6aaa60a711ced03be1df77053b184b94697c0764ce165d08c8b91c6a90162d474ba974bdede720f3afb3399004f2d43d8566d7d95a9f71682f649760297ab87418e8a1709b6b478128f35b5c36b42fa92c14a3cf4019bca20612cd110b1d795451885992013781115adc639f4bf21e628f0398550e9115ceebdbc2773fe6d7396aed6b7da8ac05691126fdefa1c60de2f6ab865ce184ff7325100827d9962a00b2a47eacb284748a09b83b814af9653c1483ee5d50ae2c8400fc84b12c1f473bec56e9c333b7324f997f3a7bc018a0d62c31cb51293728d886355a80bf6932d0f87077fcf931f0a3692cc9032ed2a9ca8a67d1b491af9773e098963d5aadde58192f5cdd256a04d0549a5b806e30f80626ac544174d219ecdcbbf0f8824fc201533251f790fe6675c2b438aa3e7c3b14999166404e15e23b54977624e699124c3437dff00737b21d5831009cadbe0e878d62c80c6006896d1a09660d00b2780205d2ebb2bba3289a714c24503931c30c94b75cfd6396247893b90f56c050c0a3052688bccbbe1835b067450a266c64ef877e8b5ff35e031dde4de5ef0a5ecdb3cf8ada1e85ee0d85b7b9d1168f5cd6873a1e761bd7e6cdb53f8b7bac1cab1fac070fa97b024e5473b2adef09d0261cba23955e4c5e8ff7b8c34cfff9d064a2a6bc0c314c89abbfd76acc05e2ea076141004da8c81009cd34ecfd48dface65bab350a744603759fac1f77ad3346072db1cac29d025fb0be0afaa6e40ebd3f75e72ae57e23fc893c5983c9842924c4972c469fe14da0328fc8b5546beacd5073b5b67a23d99b34ffb55770a638fe815899ad125ecb9023dec76e61274ddf8267852c6db6adb30712a1e173b26b587fc8524ed2672f2a33400338d09a3c5ebc3806fd3b510932489b794bf73d210e56eb439b481453d8bdd44d694942b4874611c8f710398b84ffaf9714a8ca52243b4d1e19fb730402c47eb435498c645ac48861bfec8cb5a5e20a37804c93ecc0cc028bfa899fc3b99b862b3c5a2a68ed3ad8d6911c418e57943840f8a25e6b1eee623f4ae32542ff8ea6608109dd8d80e64680a997c1a932371e7b7414bc2c75fa7cdbe22a38929c96953b32360da19f2519c95ac2225bdf825a66db4903c94e811145c532134bc9301f126a9b1508215a0109da3da2d44a03b9d37844187f32280b4dd36b64695ea530175b81ad6d98e8232d79918c8741527f8b434a91deffbf5195b27f73b6036e71f0d8655ed2a65a6fb736530118a3630f56424c55da21ec4390b8864605a4f8078d11ea6ff42d700eb66b85143a00bc230b6f1114ce377011167491f66538452595a658856e9e99012aa62f7b85416c8ae7c829c85d00e8434f09d6881ba7ba7c24b89bc3bc35bb5d6a530b92d423e75cada891f0714fab6764358128a9f934ac45e9e9c4761798ad41a085e88bb12b3ec5af647f44d052fabe3adbbdb2cca6cc647a50d00c1bc137345a2b6d09233025aeb17c9312c59d347e31170e4d4109b7ef0493137c92ec84cc5f2da18a4f47346168570b0eb4466aaac983b252e17f24eaa9f3a21e34d73c91019d75c9b60a644d75bf069b1789696d161cc2d8d04ce77289169cbf4f77d3a9db821994943b7c64ef47df882130826e534a42b666c1698dc957dad2d23be998045c4b383f86d83d421e6580dc6857d301ac31e970db741d3f789b1a020ce5ef47a73531bff065e2f99466828a1dabbe5e04a3e01ba21a671f0150daaba20011e28d5cc6e284415f129f56d9379b3917678d869b40c619e3b430af1f4f3bdcace2986524bb5d141b4ce360cf869389a8832552aa6625546a299da98bd34363364e93d202cfe3de89f9ead4604c5d42f76017a845e93bac73d9b7f2586dcb70b57458ca6001d9aa66ef3a24599ee82fa1af17ebe298457dfd77204ae1817376470050c72dd973c346dbaf7b52f97eda43d10a56390f16d39ff44dea7f9e04e0fc85a2fdeeb0672f5377c491a1ebda27bd38a1e671ce128b36530a54e0b021160f298287963b0051b7640ba227b416facd239198fb6a9b2e390b6debad6cf14a0ef31404d222acbeb93d9305a5dd432ba225dd244c722a8f818533f0f039a08b438aba1fa1ef9500f2300539203fb7d2297454d257e01432e52dea1c83e1fe8c69a249550027b4bfebc3355922f4e24e6675c1fade500706edb9f08002c8f9704d8b7079c3084cf4ca2d89ad93d2086f22adbfb3df4ccd47867d32d621721b98fcf3051162be85119bd2bf197c5e863c881e2e664132778802a5962d2ccc7bbba995c9d86c0e71d8662b5611185024daff5cbe0a2205e2a8488dc6bb3e3813db2b5f583315d2e39b0412ab67f64feb13c9aeff8f7a7d2d2cddb0587b0013a00eb0c251a64c0aef7e4b06d2a7971cc9d81b096a66c76c17f96d1a50743170cda8e9860f427ab16d4ebe002dd08a2f4d044c2ceefae9b63036cfe9a91605c0793554a8088c217ad2594db12c836034155005a03fe307435600112d827d67e30e7cbcc61687d4a24766f06091d80fb7e83678f312f33d6c39b976377d1b3f5c0842e3d8c590474a0fa461933ab3e84b99ee58c19a279edfda94616297f9b27a9c22d2c471530be65b71742208e2c55ebc8ad88ac3a391b8a2e89dacdddc9fadbf4344bd54e4b04a30b9e580fb697bd20c703716777db91248d79bc60a740e4f0915d5e235382fc752f97b8f5b31a72a86f32009fb246eaed9c7b7b4e4d83e7794e36135a8d7c759eac64daf21bbd2224352fdc8f5f7606f87fd0b20312b6956825025fdb4e022fdac4bf93b1f399eb13084588e9feb363d7dfce4701eb5998b56112b317f40cfb5e4be4663f17ad913027d0f9d91475511be175303e2bb7247adfef4bfd875c894f472003bed122d2d3986101ae97a2f87d6aaad31adb6de5313d0367e3f0afd8465b1a6fac4bc8567e69473affa50f7ffbb5210f8f2bdae0610d30dbe57ac7e35806f8c38beac74a2fdd28db6b877791593352e76a79727d00664acdefacf1607adeaa0aeea8126de1c80afda8619c0e95bf4d8ff450965ea0647c3d88239cbe906d256c783739870bfe5522ff1b0b230ac272c81930eadd66cb673a8dbb3db3ebca5faa2089119819b4384029ed370bb4a5cb7c59fa8bda0d7d5e21d9763ad958c6ea44492d4b3d1e4bc0bf6c4ab05ddae7a71a6ff5d9f4f30367b93cd01bb58fd8c373b0c72c896517ccae959dad6b39884e43891efb44a984558d45484f94002938f7a564f394ec3c18aa0084a4fab58871b01b120c883c660694299f701126e8eea22963d4ce0752c4086ca88f5678966bf3aae5ae7c90c98fedee98d5ba3e1721766ecd76ebd53fc7be8c4f4561403093e1dffea32e38adcbbf225929db8add3b9b2b505431867e7cbbf702e4ef386381fde3e8dcfc9246e54e1ab5f0e6fec09dfe8bf39b5e3f65c110501e3f49e2986dde7bf6b1dd105f6a2da684e93ae375cf62ee234530837ea16fcc33fe06a52e27ca854163d97b83e8fc2e5ec499f5dcfd086ebdcc6d6459e7fceb15a91eba01c319e5f8763e5f4d5cf5954a8b201af4adb51a66a9d0bbcda0c31e3a0ee364c564b36f0f8797f29a0cff555fedaca912ae2776a8314884ef24b5311a9aa1d32ac24e6ab2eaca568492e5194e98507f8fd3b98eb359cef0447ea0bce3df9fa921365ec90801daf745d753906b193eb90febfe8e25a0c44a54050e1bcf3221ce7a1877c8de8df4557d240b13bd1c8b53dfd09b00eef824593a4d90401a28c75be749befd80d8d763c6290864e3d1b6ae5969d7359f009bd38099fdd0fc5119924e94f338ff9520397913519eb933cc6665c06cbd993476ec56f02ca35a39ab7ba53157f0a0c966967eecfb7b1cb7691b330c45aeb7cba981915edcad7ca31d6f30648a62e499444353a805bb91933ebc13bb29499b7d21f16d18218222254ae75489198f9068f7a718593353a3b6c4ed4159cb29bfcc8a4cb35f2de4880242d4e43d29ab218b3dfa3720b43982f1600ae31daad57dd00d37780a5d3a42e09f8397ab23cf88cd15e47259d0ccf0518a650384229f9fc003e532bdf45312f55d59ccbdd759e1dda49cdf2dd55d2dea366326774347e3b20e2cf5c4b021f18a9a095102f38509ace25a6e35b712116daff9731ba7dbdd68ac945faf08a16415c83d2aeac4c07fa4ef8de1d0dcab80177ee4136aaa267bb88cb2238b4aa8035b31b9bb414f8c5de265037aeba152fa7830eaa8462a0e881ac9b56c1f407a6666a385893b10fdbd065ad1cc814fa3063cb3fba468faace4d49c98a3c2803a9cde0634d3ee836fa2f38da2f8855bf79c426cefa9435a89112ab34b50f97aa8c82aa6cf18a91f78b9bb64555df19f16d7be77a739b577e0868756835c6b43b7c1a9d02cbc3d8003bf9c1ad2a65c3e6f65b5e9a1b04d023258931b3cd2e443bff0e9280c7dc2fbea139689a33c8b2b82b7ac458081a526406b3922aa936dd733913610924b27b52cc883ea2cee1636490aa495847d2ce842b7e17d7b0a6f07a05328cbb3d18dceca121bc079ba4eaa287e8646c2aa3661a2466fbbf2880508dced4791302a5c6b7b0f3bcce23ff90898b5e5e32eee1eb62287601f539aab09d7c51a6a4b701da96064a961ebc77aa2ef7396e03b8a725a2553f3b92b5f8f4abedae7bc7a0f529cd4d1a9f41a395751394aa4cbd88341ba1ce9f53550c828766ce03fe1fb91e7454ec71a922850b55b44f3980dae04e24edadb0b27bd0785dc3f11bcf6f3141ab2613f14f2f054ae414a6e7bf0773b39eb060e2e5082237490cf47623582213e384385b35e3193540ca0853ceaae8fe9e470991eeb1dd7dd45e40e4d4e76c66bd508550c6a5db4bf73c715abdcba7bbb18029211f7ca9b07e3d4cf94b9252803288831fe7879fb3fca10bb9b6df5e96a5069ab9dec62d207c28826bc89f7c59dc413273baa9fe46384c233d4bc3a03cc29402a0a99b70371a9a30335451b624ade7442867e25af3090776787c3349d5da8f7201faa7c164a70dcd106255881e2d5b13a8437785b50a1568cc51cea40a4e74d3e8be10216a2792f32497ea92ee85be595caf9351b3844561562a4d2566489b37c032688e3003c7a0ba91bedeaf08b8744c2ee6ed40388998e697aec6cc2c15f405f57a94e6268fdb5c4318e951dd5e0fb39568044218f3e33bfb10c8f950f06d5fafe20109104921ad8ab018b27e724b6e61d705490d8cc7abbe0b9363d689e4a23bf66f426adf2abd832d879bdb88a3ba63b687e316b7f9d632f10b4eb8c5319546bf96b85e123eedeac90f24f47decdba444f9ec7e1d1857c10e5b2206527f0690a6eb517ee33f392885370fb977e617f77fa86181db395800d4308ffb9bac9b76c19561d85d1cbe5c599ad3daae9c05d1ec9dff3cdda7d6788b9d8b823f98ac5b52354ac6cd8a5e9d56cedea21b4d7168d02493aa4d85614fb0fe6ce967d21541690408dbf906a5994bcc31c94b106376370f3656ebdbc109a1da3e47306dd1efa66efc049eb93111bbbb0ca7db390d8a699d85babc542e68d14d78d5dd893b17b2bd6e151e37445891e11642ae25345b8be40f0cf9eca75ce2fbc5525ebcd6d5b8ee3d1b905cc73989bea17d980c0fee19a0e78c258362a75410e2a04e1042123841ac46a7831e51ea4b57306ece509a2e47601cd1f777a4ac53f52fe571a1e073ceecb45f7803faf27588bd0150ca77d905509ae2847fb987f20ff255e5710580311c1ed2560846fefac50ae028cc2a66b012383b3c538b0f618fa4a4bb83328ad69258cf86976ea2ef4fd90e5c96584596acaacc07e13fcffe2ad52e4c60e5659e9d7da17820d887cd7c6982d3e8951fcaabcadef2ad86ab92db06f336695ae0f25bdfd3d1dc141a60fb243a67dfe676f00b3b560a843f50f9dc2a813b7d84a04c76dfafcd0cc0f48c19979991b808b4ac821102fb7dc862713fad54cc9c362ecb841f5cbe1830299d5160dbb41c942f3e156f8809694936eb5bf3c88bd280e9a4c0cc41245ba7adfbaa10501de932489baa3913052d6157f092d6324c16a1428ed0aa3d05619a5cd5140c8ed77f16c5c4b97b76e54412eb71af208c2d8341483735640289b75a8fd7556e1b1a7398300188f23675cbcb1a25a8ac4ebf05883152b226acf0a709999b02d93673f3e8710be2b161901003f6aff611187839432941920ded55457edbc887aefb0c504a6c8908aaac6dd1411ebd9c3e56cfa0847ded0e682db3e910d34bafd411edac4d91a0b62a8dab46ed34c5c0285466f55793bc873f84f05380eab7970ae2c9fdf4c210e39f18446e8070321c08dd09a7b1d42ed4864a98f43db104a5753868698679b1c567eff5651e0541d5d3ba58da2d076b2510ef553807b6471</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>harbor ä½¿ç”¨</title>
    <url>/2019/10/10/harbor-%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h4 id="days-2019-10-10"><a href="#days-2019-10-10" class="headerlink" title="days(2019-10-10)"></a>days(2019-10-10)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢æ–‡ç« ä»‹ç»äº†harborçš„éƒ¨ç½²ï¼Œä»Šå¤©ç¬¬ä¸€æ¬¡å­¦ä¹ å…¥é—¨ä½¿ç”¨ã€‚</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœåŠ¡å™¨å®‰è£…dockerä»¥åï¼Œæˆ‘ä»¬æ€ä¹ˆå§é•œåƒpushåˆ°æˆ‘ä»¬çš„ç§æœ‰ä»“åº“ï¼Œå’Œæ€ä¹ˆå§é•œåƒpullåˆ°æœ¬åœ°ï¼Œé¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šè£…å¤‡dockerç¯å¢ƒ</p><h5 id="è¿æ¥harbor"><a href="#è¿æ¥harbor" class="headerlink" title="è¿æ¥harbor"></a>è¿æ¥harbor</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker login reg.xxlaila.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Error response from daemon: Get https://172.21.16.90/v1/users/: dial tcp reg.xxlaila.cn:443: connect: connection refused</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œç¬¬ä¸€æ¬¡è¿æ¥æŠ¥é”™ï¼ŒDockerè‡ªä»1.3.Xä¹‹ådocker registryäº¤äº’é»˜è®¤ä½¿ç”¨çš„æ˜¯HTTPSï¼Œä½†æ˜¯æˆ‘ä»¬æ­å»ºç§æœ‰é•œåƒé»˜è®¤ä½¿ç”¨çš„æ˜¯HTTPæœåŠ¡ï¼Œæ‰€ä»¥ä¸ç§æœ‰é•œåƒäº¤æ—¶å‡ºç°ä»¥ä¸Šé”™è¯¯ã€‚</p><h5 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h5><ul><li><p>æ–¹æ³•ä¸€: ä¿®æ”¹æˆ–æ·»åŠ é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"insecure-registries"</span> : [<span class="string">"reg.xxlaila.cn"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é‡æ–°å¯åŠ¨dockerï¼Œå¹¶é‡æ–°ç™»å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl restart docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  docker login reg.xxlaila.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure></li><li><p>æ–¹æ³•äºŒï¼šä¿®æ”¹å¯åŠ¨æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/lib/systemd/system/docker.service  </span></span><br><span class="line">ExecStart=/usr/bin/dockerd --insecure-registry reg.xxlaila.cn <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨"><a href="#Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨" class="headerlink" title="Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨"></a>Harborä¸Šåˆ›å»ºæ–°é¡¹ç›®ä¾›ä¸Šä¼ ä½¿ç”¨</h5><p><img src="https://img.xxlaila.cn/1570697850857.jpg" alt="img"></p><h5 id="DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾"><a href="#DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾" class="headerlink" title="DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾"></a>DockeræœåŠ¡å™¨ç»™é•œåƒæ‰“æ ‡ç­¾</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                     TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/xxlaila/kxl-eureka   v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker tag docker.io/xxlaila/kxl-eureka:v2 reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/xxlaila/kxl-eureka    v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br><span class="line">reg.xxlaila.cn/kxl/kxl-eureka   v2                  eb8cf7e3f24f        7 months ago        474 MB</span><br></pre></td></tr></table></figure><h5 id="ä¸Šä¼ é•œåƒ"><a href="#ä¸Šä¼ é•œåƒ" class="headerlink" title="ä¸Šä¼ é•œåƒ"></a>ä¸Šä¼ é•œåƒ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker push reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line">The push refers to a repository [reg.xxlaila.cn/kxl/kxl-eureka]</span><br><span class="line">f6026bf67b63: Pushed </span><br><span class="line">1489a4b0f1dd: Pushed </span><br><span class="line">2af6e035aa36: Pushed </span><br><span class="line">472cfce4528e: Pushed </span><br><span class="line">071d8bd76517: Pushed </span><br><span class="line">v2: digest: sha256:20d3bc74fdcb2fc4cdfc9066f742c828898c728f7e3f2114498ebe2848b71653 size: 1368</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1570698233987.jpg" alt="img"></p><h5 id="ä¸‹è½½é•œåƒ"><a href="#ä¸‹è½½é•œåƒ" class="headerlink" title="ä¸‹è½½é•œåƒ"></a>ä¸‹è½½é•œåƒ</h5><ul><li><p>åˆ é™¤æœ¬åœ°é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker rmi reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker rmi docker.io/xxlaila/kxl-eureka:v2</span></span><br></pre></td></tr></table></figure></li><li><p>ä¸‹è½½harborä¸Šçš„é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker pull reg.xxlaila.cn/kxl/kxl-eureka:v2</span></span><br><span class="line">Trying to pull repository reg.xxlaila.cn/kxl/kxl-eureka ... </span><br><span class="line">v2: Pulling from reg.xxlaila.cn/kxl/kxl-eureka</span><br><span class="line">a02a4930cb5d: Pull complete </span><br><span class="line">6ea3dcbee0db: Extracting [==================================================&gt;]  81.4 MB/81.4 MB</span><br><span class="line">6ea3dcbee0db: Pull complete </span><br><span class="line">c423a7a79cc1: Pull complete </span><br><span class="line">7418081934c1: Pull complete </span><br><span class="line">f89b73853622: Pull complete </span><br><span class="line">Digest: sha256:20d3bc74fdcb2fc4cdfc9066f742c828898c728f7e3f2114498ebe2848b71653</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> reg.xxlaila.cn/kxl/kxl-eureka:v2</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1570698681073.jpg" alt="img"></p><h4 id="days-2019-10-12"><a href="#days-2019-10-12" class="headerlink" title="days(2019-10-12)"></a>days(2019-10-12)</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºå…¬å¸éœ€æ±‚ï¼Œå¼€å‘äººå‘˜æ¯”è¾ƒå¤šï¼Œåˆä¸æƒ³ç ”å‘ç”¨ä¸€ä¸ªè´¦å·ï¼Œä¹Ÿä¸æƒ³ç»™ç ”å‘ä¸€ä¸ªä¸ªçš„å¼€è´¦å·ï¼Œä½ç½®harboræ”¯æŒäº†ldapã€‚æœ‰äº†è¿™ä¹ˆä¸€ä¸ªä¸œè¥¿ï¼Œæˆ‘ä»¬å°±èƒ½å¾ˆå¥½çš„ä¸ºç ”å‘åˆ›å»ºè´¦å·æ”¯æŒç ”å‘éšæ—¶æŸ¥çœ‹dockerçš„é•œåƒã€‚</p><h4 id="é…ç½®harbor-ldap"><a href="#é…ç½®harbor-ldap" class="headerlink" title="é…ç½®harbor ldap"></a>é…ç½®harbor ldap</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°ç‰ˆæœ¬çš„harborå¾ˆå¤šä¸œè¥¿éƒ½å¯ä»¥ç›´æ¥åœ¨ç•Œé¢é…ç½®ï¼Œä¸éœ€è¦å»ä¿®æ”¹æ–‡ä»¶ï¼Œçœå»äº†å¤§é‡çš„å·¥ä½œï¼Œwebç•Œé¢é…ç½®æ›´åŠ æ–¹ä¾¿å¿«æ·ï¼Œç™»å½•harborå¹³å°ï¼Œç‚¹å‡»é…ç½®ç®¡ç†â€”â€”&gt;ä¿®æ”¹è®¤è¯æ¨¡å¼ï¼Œè®¤è¯æ¨¡å¼æ”¯æŒå¾ˆå¤šç±»å‹ï¼Œè¿™é‡Œé€‰æ‹©ldapã€‚<br><img src="https://img.xxlaila.cn/1571019665079.jpg" alt="img"><br><strong>æ³¨</strong>: åœ¨å¯†ç è¿™æ å¡«å†™éœ€è¦å¡«å†™ç®¡ç†å‘˜çš„å¯†ç ï¼Œæ™®é€šç”¨æˆ·çš„å¯†ç æ˜¯ä¸è¡Œçš„ï¼Œå³ä½¿æ˜¯åœ¨ç®¡ç†å‘˜çš„ç”¨æˆ·ä¹Ÿæ˜¯ä¸è¡Œçš„ã€‚<br>ç‚¹å‡»æµ‹è¯•ldapï¼Œæç¤ºè¿æ¥æˆåŠŸåä¿å­˜<br><img src="https://img.xxlaila.cn/1571019741060.jpg" alt="img"></p><h4 id="é…ç½®é‚®ç®±"><a href="#é…ç½®é‚®ç®±" class="headerlink" title="é…ç½®é‚®ç®±"></a>é…ç½®é‚®ç®±</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨é…ç½®ldapé¡µé¢æ—è¾¹æœ‰ä¸€ä¸ªé‚®ç®±é…ç½®ï¼Œé‚®ä»¶æœåŠ¡å™¨ç”¨äºå‘è¯·æ±‚é‡è®¾å¯†ç çš„ç”¨æˆ·å‘é€å“åº”ã€‚<br><img src="https://img.xxlaila.cn/1570873497729.jpg" alt="img"><br>ç‚¹å‡»æµ‹è¯•ï¼Œæµ‹è¯•æ²¡é—®é¢˜ä¹‹åç‚¹å‡»ä¿å­˜ã€‚</p><h4 id="æµ‹è¯•ladpè¿æ¥"><a href="#æµ‹è¯•ladpè¿æ¥" class="headerlink" title="æµ‹è¯•ladpè¿æ¥"></a>æµ‹è¯•ladpè¿æ¥</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–°æ‰“å¼€ä¸€ä¸ªä¸€ä¸ªæµè§ˆå™¨çª—å£ï¼Œåˆ©ç”¨ladpè´¦æˆ·è¿›è¡Œç™»å½•ã€‚<br><img src="https://img.xxlaila.cn/1571019859287.jpg" alt="img"><br><strong>æ³¨é‡Š</strong>: æ–°ç‰ˆæœ¬çš„åœ¨ç™»å½•ç•Œé¢æ²¡æœ‰ä»€ä¹ˆé€‰æ‹©ldapç™»å½•ï¼Œç›´æ¥ä½¿ç”¨ldapè´¦å·ç™»å½•å°±ok</p><h4 id="å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP-ADç»„"><a href="#å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP-ADç»„" class="headerlink" title="å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP / ADç»„"></a>å°†é¡¹ç›®è§’è‰²åˆ†é…ç»™LDAP / ADç»„</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¿®æ”¹ä¹‹å‰çš„ldapé…ç½®ï¼Œå¢åŠ ç»„çš„é…ç½®<br><img src="https://img.xxlaila.cn/1571023069387.jpg" alt="img"><br>åœ¨é¡¹ç›®-&gt;æˆå‘˜-&gt; +ç»„ä¸­ã€‚<br><img src="https://img.xxlaila.cn/1571023177214.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1571023223796.jpg" alt="img"></p><h4 id="è®¾ç½®ldapè´¦æˆ·çš„æƒé™"><a href="#è®¾ç½®ldapè´¦æˆ·çš„æƒé™" class="headerlink" title="è®¾ç½®ldapè´¦æˆ·çš„æƒé™"></a>è®¾ç½®ldapè´¦æˆ·çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“ldapé…ç½®ä»¥åï¼Œldapè´¦æˆ·ç™»å½•æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œæˆ‘ä»¬ç®¡ç†harborè¿˜çš„ä½¿ç”¨<code>harbor</code>çš„adminè´¦æˆ·ç™»å½•ï¼Œè¿™æ ·æ— ç–‘å¯¹è¿ç»´äººå‘˜ç»´æŠ¤å¸¦æ¥äº†ä¸ä¾¿åˆ©ã€‚å½“ldapç”¨æˆ·ç™»å½•ï¼Œharborå°±ä¼šè®°å½•è¯¥ç”¨æˆ·ï¼Œæˆ‘ä»¬è®¾ç½®è¿ç»´ç”¨æˆ·ä¸ºè¶…çº§ç®¡ç†å‘˜ï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªè´¦å·ç™»å½•ï¼Œç»´æŠ¤çš„æ—¶å€™ä¹Ÿä¸ç”¨è´¦å·åˆ‡æ¢<br><img src="https://img.xxlaila.cn/1571023451423.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>harbor</tag>
      </tags>
  </entry>
  <entry>
    <title>HPAè®¤è¯†</title>
    <url>/2019/10/09/hpa/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="Pod-è‡ªåŠ¨æ‰©ç¼©å®¹"><a href="#Pod-è‡ªåŠ¨æ‰©ç¼©å®¹" class="headerlink" title="Pod è‡ªåŠ¨æ‰©ç¼©å®¹"></a>Pod è‡ªåŠ¨æ‰©ç¼©å®¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesæä¾›äº†è¿™æ ·ä¸€ä¸ªèµ„æºå¯¹è±¡: <code>Horizontal Pod Autoscaling</code> Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼‰ï¼Œç®€ç§°HPAã€‚HAPé€šè¿‡ç›‘æ§åˆ†æRCæˆ–è€…Deploymentæ§åˆ¶çš„æ‰€æœ‰Podçš„è´Ÿè½½å˜åŒ–æƒ…å†µæ¥ç¡®å®šæ˜¯å¦éœ€è¦è°ƒæ•´Podçš„å‰¯æœ¬æ•°é‡ï¼Œè¿™æ˜¯HPAæœ€åŸºæœ¬çš„åŸç†ã€‚</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1570605234009.jpg" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HPAåœ¨kubernetesé›†ç¾¤ä¸­è¢«è®¾è®¡æˆä¸€ä¸ªKubernetes APIèµ„æºå’Œæ§åˆ¶å™¨ï¼Œå¯ä»¥é€šè¿‡kubectl autoscaleå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªHPAèµ„æºå¯¹è±¡ï¼ŒHPA Controlleré»˜è®¤15sè½®è¯¢ä¸€æ¬¡ï¼ˆå¯é€šè¿‡kube-controller-managerçš„æ ‡å¿—â€“horizontal-pod-autoscaler-sync-periodè¿›è¡Œè®¾ç½®ï¼‰ï¼ŒæŸ¥è¯¢æŒ‡å®šçš„èµ„æºï¼ˆRCæˆ–è€…Deploymentï¼‰ä¸­Podçš„èµ„æºä½¿ç”¨ç‡ï¼Œå¹¶ä¸”ä¸åˆ›å»ºæ—¶è®¾å®šçš„å€¼å’ŒæŒ‡æ ‡åšå¯¹æ¯”ï¼Œä»è€Œå®ç°è‡ªåŠ¨ä¼¸ç¼©çš„åŠŸèƒ½ã€‚<br><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener">è¯¦ç»†ä»‹ç»</a></p><h3 id="Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ "><a href="#Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ " class="headerlink" title="Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ "></a>Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ç»ƒä¹ </h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºHorizontal Pod Autoscalerä½¿ç”¨æ­¤APIæ”¶é›†æŒ‡æ ‡ï¼Œå› æ­¤éœ€è¦åœ¨ç¾¤é›†ä¸­éƒ¨ç½²metrics-serverç›‘è§†ä»¥é€šè¿‡èµ„æºæŒ‡æ ‡APIæä¾›æŒ‡æ ‡,</p><h4 id="è¿è¡Œphp-apacheæœåŠ¡å™¨"><a href="#è¿è¡Œphp-apacheæœåŠ¡å™¨" class="headerlink" title="è¿è¡Œphp-apacheæœåŠ¡å™¨"></a>è¿è¡Œphp-apacheæœåŠ¡å™¨</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†å¼€å§‹è¿è¡Œè¯¥æ˜ åƒçš„éƒ¨ç½²ï¼Œå¹¶å°†å…¶æœåŠ¡å…¬å¼€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run php-apache --image=0layfolk0/hpa-example --requests=cpu=200m --limits=cpu=500m --expose --port=80</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">service/php-apache created</span><br><span class="line">deployment.apps/php-apache created</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨"><a href="#åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨" class="headerlink" title="åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨"></a>åˆ›å»ºæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æœåŠ¡è¿è¡Œä»¥åã€‚æˆ‘ä»¬å°†ä½¿ç”¨kubectl autoscaleåˆ›å»ºè‡ªåŠ¨ ç¼©æ”¾å™¨ã€‚ä»¥ä¸‹å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªæ°´å¹³Podè‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œè¯¥ç¼©æ”¾å™¨å°†ç»´æŠ¤ç”±æˆ‘ä»¬åœ¨è¿™äº›è¯´æ˜çš„ç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„php-apacheéƒ¨ç½²æ§åˆ¶çš„Podçš„1è‡³10ä¸ªå‰¯æœ¬ã€‚ç²—ç•¥åœ°è¯´ï¼ŒHPAå°†ï¼ˆé€šè¿‡éƒ¨ç½²ï¼‰å¢åŠ æˆ–å‡å°‘å‰¯æœ¬æ•°ï¼Œä»¥å°†æ‰€æœ‰Podçš„å¹³å‡CPUåˆ©ç”¨ç‡ç»´æŒåœ¨50ï¼…ï¼ˆå› ä¸ºæ¯ä¸ªpodé€šè¿‡kubectlè¿è¡Œè¯·æ±‚200æ¯«æ ¸ï¼Œè¿™æ„å‘³ç€å¹³å‡CPUåˆ©ç”¨ç‡ä¸º100æ¯«-æ ¸å¿ƒï¼‰ã€‚<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#algorithm-details" target="_blank" rel="noopener">ç®—æ³•æ›´å¤šä¿¡æ¯</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span><br><span class="line">horizontalpodautoscaler.autoscaling/php-apache autoscaled</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥è‡ªåŠ¨å®šæ ‡å™¨çš„å½“å‰çŠ¶æ€:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         10        1          14s</span><br></pre></td></tr></table></figure><p><strong>æ³¨é‡Š</strong>: ç”±äºæˆ‘ä»¬æ²¡æœ‰å‘æœåŠ¡å™¨å‘é€ä»»ä½•è¯·æ±‚ï¼Œå› æ­¤å½“å‰CPUæ¶ˆè€—ä¸º0ï¼…ï¼ˆâ€œ CURRENTâ€åˆ—æ˜¾ç¤ºäº†ç”±ç›¸åº”éƒ¨ç½²æ§åˆ¶çš„æ‰€æœ‰Podçš„å¹³å‡å€¼ï¼‰ã€‚</p><h4 id="å¢åŠ å‹åŠ›æµ‹è¯•"><a href="#å¢åŠ å‹åŠ›æµ‹è¯•" class="headerlink" title="å¢åŠ å‹åŠ›æµ‹è¯•"></a>å¢åŠ å‹åŠ›æµ‹è¯•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨æˆ‘ä»¬è¦å¯¹<code>php-apache</code>åšå‹åŠ›æµ‹è¯•æ¥è§‚çœ‹è‡ªåŠ¨ç¼©æ”¾å¦‚ä½•å¯¹å¢åŠ çš„è´Ÿè½½åšå‡ºååº”ï¼Œæˆ‘ä»¬å°†å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶å°†æ— é™å¾ªç¯çš„æŸ¥è¯¢å‘é€åˆ°php-apacheæœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty load-generator --image=busybox /bin/sh</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # while true; do wget -q -O- http://php-apache.default.svc.cluster.local; done</span></span><br><span class="line"><span class="string">OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!O</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸€åˆ†é’Ÿå·¦å³çš„æ—¶é—´å†…ï¼Œæˆ‘ä»¬åº”è¯¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥çœ‹åˆ°æ›´é«˜çš„CPUè´Ÿè½½ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   250%/50%   1         10        1          9m12s</span><br><span class="line"></span><br><span class="line">$ kubectl get deployment php-apache</span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   3/5     5            3           88m</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”±äºç½‘ç»œé—®é¢˜å’Œpull é•œåƒå¤ªæ…¢äº†ï¼Œæˆ‘å°±ç›´æ¥ç»“æŸäº†æµ‹è¯•</p><h4 id="åœæ­¢å‹åŠ›æµ‹è¯•"><a href="#åœæ­¢å‹åŠ›æµ‹è¯•" class="headerlink" title="åœæ­¢å‹åŠ›æµ‹è¯•"></a>åœæ­¢å‹åŠ›æµ‹è¯•</h4><p>æˆ‘ä»¬åœ¨<code>busybox</code>å®¹å™¨çš„ç»ˆç«¯é‡Œé¢æ‰§è¡Œ<code>&lt;Ctrl&gt; + C</code>æ¥ç»“æŸå‹åŠ›æµ‹è¯•ï¼Œç„¶åæˆ‘ä»¬åœ¨è§‚å¯Ÿç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl get hpa</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   91%/50%   1         10        5          10m</span><br><span class="line"></span><br><span class="line">$ kubectl get deployment php-apache</span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   2/2     2            2           99m</span><br></pre></td></tr></table></figure><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener">è‡ªåŠ¨ç¼©æ”¾å¤šä¸ªæŒ‡æ ‡å’Œè‡ªå®šä¹‰æŒ‡æ ‡</a></p><h3 id="nginx-æµ‹è¯•"><a href="#nginx-æµ‹è¯•" class="headerlink" title="nginx æµ‹è¯•"></a>nginx æµ‹è¯•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ©ç”¨ä¹‹å‰<a href="https://xxlaila.github.io/2019/10/09/Deployment%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">Deployment</a>é‡Œé¢çš„nginxåšæµ‹è¯•ï¼Œæˆ‘ä»¬åªéœ€è¦å§ä¹‹å‰çš„yamlæ–‡ä»¶ç¨ä½œä¿®æ”¹å³å¯</p><h4 id="ä¿®æ”¹nginx-deployment-yaml"><a href="#ä¿®æ”¹nginx-deployment-yaml" class="headerlink" title="ä¿®æ”¹nginx-deployment.yaml"></a>ä¿®æ”¹nginx-deployment.yaml</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-deploy</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-deploy</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"200Mi"</span></span><br><span class="line">            cpu: <span class="string">"200m"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="æ–°å»ºç«‹nginx-deploy-hpa-yaml"><a href="#æ–°å»ºç«‹nginx-deploy-hpa-yaml" class="headerlink" title="æ–°å»ºç«‹nginx-deploy-hpa.yaml"></a>æ–°å»ºç«‹nginx-deploy-hpa.yaml</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deploy-hpa.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 5</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: extensions/v1beta1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx-deploy</span><br><span class="line">  targetCPUUtilizationPercentage: 10</span><br><span class="line">status:</span><br><span class="line">  currentCPUUtilizationPercentage: 8</span><br><span class="line">  currentReplicas: 1</span><br><span class="line">  desiredReplicas: 0</span><br></pre></td></tr></table></figure><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">$ kubectl apply -f kubectl apply -f nginx-deploy-hpa.yaml</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   0%/10%    1         5         2          45s</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       8m28s</span><br><span class="line">nginx-deploy-d494b9564      2         2         2       13m</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œå‹åŠ›æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty load-generator --image=busybox /bin/sh</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # while true; do wget -q -O- http://172.30.224.5:80; done</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ•ˆæœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   28%/10%   1         5         4          4m48s</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       12m</span><br><span class="line">nginx-deploy-d494b9564      5         5         5       18m</span><br><span class="line"></span><br><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   16%/10%   1         5         5          5m39s</span><br></pre></td></tr></table></figure></li><li><p>ç»“æŸå‹æµ‹<br>ç­‰å¾…ä¸€ä¼šæŸ¥çœ‹ç»“æœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get hpa</span><br><span class="line">NAME           REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">nginx-deploy   Deployment/nginx-deploy   0%/10%    1         5         1          12m</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">load-generator-7fbcc7489f   1         1         1       19m</span><br><span class="line">nginx-deploy-d494b9564      1         1         1       25m</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>hpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Deploymentä½¿ç”¨</title>
    <url>/2019/10/09/Deployment%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="Deploymentå’Œrcçš„å¯¹æ¯”"><a href="#Deploymentå’Œrcçš„å¯¹æ¯”" class="headerlink" title="Deploymentå’Œrcçš„å¯¹æ¯”"></a>Deploymentå’Œrcçš„å¯¹æ¯”</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆRCæ˜¯Kubernetesçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå½“æˆ‘ä»¬æŠŠåº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤ä¹‹åï¼Œéœ€è¦ä¿è¯åº”ç”¨èƒ½å¤ŸæŒç»­ç¨³å®šçš„è¿è¡Œï¼ŒRCå°±æ˜¯è¿™ä¸ªä¿è¯çš„å…³é”®ï¼Œä¸»è¦åŠŸèƒ½å¦‚:</p><ul><li>ç¡®ä¿Podæ•°é‡: å®ƒä¼šç¡®ä¿Kubernetesä¸­æœ‰æŒ‡å®šæ•°é‡çš„Podåœ¨è¿è¡Œï¼Œå¦‚æœå°‘äºæŒ‡å®šæ•°é‡çš„Podï¼ŒRCå°±ä¼šåˆ›å»ºæ–°çš„ï¼Œåä¹‹è¿™ä¼šåˆ é™¤å¤šä½™çš„ï¼Œä¿è¯Podçš„å‰¯æœ¬æ•°é‡ä¸å˜ã€‚</li><li>ç¡®ä¿Podå¥åº·: å½“Podä¸å¥åº·ï¼Œæ¯”å¦‚è¿è¡Œå‡ºé”™äº†ï¼Œæ€»ä¹‹æ— æ³•æä¾›æ­£å¸¸æœåŠ¡æ—¶ï¼ŒRCä¹Ÿä¼šæ€æ­»ä¸å¥åº·çš„Podï¼Œé‡æ–°åˆ›å»ºæ–°çš„ã€‚</li><li>å¼¹æ€§ä¼¸ç¼©: åœ¨ä¸šåŠ¡é«˜å³°æˆ–è€…ä½å³°çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨è¿‡RCæ¥åŠ¨æ€çš„è°ƒæ•´Podæ•°é‡æ¥æä¾›èµ„æºçš„åˆ©ç”¨ç‡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡å¦‚æœä½¿ç”¨HPAè¿™ç§èµ„æºå¯¹è±¡çš„è¯å¯ä»¥åšåˆ°è‡ªåŠ¨ä¼¸ç¼©ã€‚</li><li>æ»šåŠ¨å‡çº§: æ»šåŠ¨å‡çº§æ˜¯ä¸€ç§å¹³æ»‘çš„å‡çº§æ–¹å¼ï¼Œé€šè¿‡é€æ­¥æ›¿æ¢çš„ç­–ç•¥ï¼Œä¿è¯æ•´ä½“ç³»ç»Ÿçš„ç¨³å®šæ€§</li></ul><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeploymentåŒæ ·ä¹Ÿæ˜¯Kubernetesç³»ç»Ÿçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œä¸»è¦èŒè´£å’ŒRCä¸€æ ·çš„éƒ½æ˜¯ä¿è¯Podçš„æ•°é‡å’Œå¥åº·ï¼ŒäºŒè€…å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªå‡çº§ç‰ˆçš„RCæ§åˆ¶å™¨ï¼ŒDeploymentå…·å¤‡çš„æ–°ç‰¹æ€§</p><ul><li>RCçš„å…¨éƒ¨åŠŸèƒ½: Deploymentå…·å¤‡ä¸Šé¢æè¿°çš„RCçš„å…¨éƒ¨åŠŸèƒ½</li><li>äº‹ä»¶å’ŒçŠ¶æ€æŸ¥çœ‹: å¯ä»¥æŸ¥çœ‹Deploymentçš„å‡çº§è¯¦ç»†è¿›åº¦å’ŒçŠ¶æ€</li><li>å›æ»š: å½“å‡çº§Podçš„æ—¶å€™å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å›æ»šæ“ä½œå›æ»šåˆ°ä¹‹å‰çš„ä»»ä¸€ç‰ˆæœ¬</li><li>ç‰ˆæœ¬è®°å½•: æ¯ä¸€æ¬¡å¯¹Deploymentçš„æ“ä½œï¼Œéƒ½èƒ½å¤Ÿä¿å­˜ä¸‹æ¥ï¼Œè¿™ä¹Ÿæ˜¯ä¿è¯å¯ä»¥å›æ»šåˆ°ä»»ä¸€ç‰ˆæœ¬çš„åŸºç¡€</li><li>æš‚åœå’Œå¯åŠ¨: å¯¹äºæ¯ä¸€æ¬¡å‡çº§éƒ½èƒ½å¤Ÿéšæ—¶æš‚åœå’Œå¯åŠ¨</li></ul><p><strong>å¯¹æ¯”</strong>: Deploymentä½œä¸ºæ–°ä¸€ä»£çš„RCï¼Œåœ¨åŠŸèƒ½ä¸Šæ›´ä¸ºä¸°å¯Œï¼ŒåŒæ—¶å®˜æ–¹ä¹Ÿæ˜¯æ¨èä½¿ç”¨Deploymentæ¥ç®¡ç†Podï¼Œæ¯”å¦‚ä¸€äº›å®˜æ–¹ç»„ä»¶kube-dnsã€kube-proxyä¹Ÿéƒ½æ˜¯ä½¿ç”¨çš„Deploymentæ¥ç®¡ç†çš„ï¼Œæ‰€ä»¥æœ€å¥½ä½¿ç”¨Deploymentæ¥ç®¡ç†Podã€‚</p><h3 id="Deployment-ä»‹ç»"><a href="#Deployment-ä»‹ç»" class="headerlink" title="Deployment ä»‹ç»"></a>Deployment ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Deploymentæ‹¥æœ‰å¤šä¸ªReplica Setï¼Œè€Œä¸€ä¸ªReplica Setæ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªPodã€‚ä¸€ä¸ªDeploymentæ§åˆ¶å¤šä¸ªrsä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒå›æ»šæœºåˆ¶ï¼Œæ¯å½“Deploymentæ“ä½œæ—¶ï¼ŒKubernetesä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªReplica Setå¹¶ä¿ç•™ï¼Œä»¥åæœ‰éœ€è¦çš„è¯å°±å¯ä»¥å›æ»šè‡³ä¹‹å‰çš„çŠ¶æ€ã€‚</p><p><strong>å®ä¾‹</strong>: åˆ›å»ºä¸€ä¸ªDeploymentï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªReplica Setæ¥å¯åŠ¨3ä¸ªnginx podï¼Œyamlæ–‡ä»¶å¦‚ä¸‹:</p><ul><li><p>nginx-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; nginx-deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f nginx-deployment.yaml</span><br><span class="line">deployment.apps/nginx-deploy created</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œä¸€ä¸‹å‘½ä»¤æŸ¥çœ‹åˆšåˆšåˆ›å»ºçš„Deployment</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   0/3     3            0           12s</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡æ‰§è¡Œä¸Šé¢å‘½ä»¤</span></span><br><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   1/3     3            1           35s</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥çœ‹åˆ°Deploymentå·²ç»åˆ›å»ºäº†1ä¸ªReplica Setäº†ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹rså’Œpod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get rs</span><br><span class="line">NAME                     DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d   3         3         2       70s</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ kubectl get pod --show-labels</span><br><span class="line">NAME                           READY   STATUS              RESTARTS   AGE   LABELS</span><br><span class="line">nginx-deploy-6dd86d77d-9n9vf   1/1     Running             0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br><span class="line">nginx-deploy-6dd86d77d-bhrsk   0/1     ContainerCreating   0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br><span class="line">nginx-deploy-6dd86d77d-jdnrh   1/1     Running             0          99s   app=nginx,pod-template-hash=6dd86d77d</span><br></pre></td></tr></table></figure></li></ul><p>ä¸Šé¢çš„Deploymentçš„yamlæ–‡ä»¶ä¸­çš„replicas:3å°†ä¼šä¿è¯æˆ‘ä»¬å§‹ç»ˆæœ‰3ä¸ªPODåœ¨è¿è¡Œã€‚</p><h3 id="æ»šåŠ¨å‡çº§"><a href="#æ»šåŠ¨å‡çº§" class="headerlink" title="æ»šåŠ¨å‡çº§"></a>æ»šåŠ¨å‡çº§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¿®æ”¹ä¹‹å‰ä½¿ç”¨çš„nginx-deployment.yamlæ–‡ä»¶ä¸­çš„nginxé•œåƒä¿®æ”¹ä¸ºnginx:1.13.3ï¼Œç„¶ååœ¨specä¸‹é¢æ·»åŠ æ»šåŠ¨å‡çº§ç­–ç•¥ï¼š</p><ul><li><p>nginx-deploments.yml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure></li><li><p>minReadySeconds:</p><ul><li>æ»šåŠ¨å‡çº§æ—¶5såè®¤ä¸ºè¯¥podå°±ç»ª</li><li>å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼ŒKubernetesä¼šå‡è®¾è¯¥å®¹å™¨å¯åŠ¨èµ·æ¥åå°±æä¾›æœåŠ¡äº†</li><li>å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼Œåœ¨æŸäº›æç«¯æƒ…å†µä¸‹å¯èƒ½ä¼šé€ æˆæœåŠ¡ä¸æ­£å¸¸è¿è¡Œ</li></ul></li><li><p>rollingUpdate:</p><ul><li>äºreplicasä¸º3,åˆ™æ•´ä¸ªå‡çº§,podä¸ªæ•°åœ¨2-4ä¸ªä¹‹é—´</li></ul></li><li><p>maxSurge:</p><ul><li>å‡çº§è¿‡ç¨‹ä¸­æœ€å¤šå¯ä»¥æ¯”åŸå…ˆè®¾ç½®å¤šå‡ºçš„PODæ•°é‡</li><li>ä¾‹å¦‚ï¼šmaxSurage=1ï¼Œreplicas=3,åˆ™è¡¨ç¤ºKubernetesä¼šå…ˆå¯åŠ¨1ä¸€ä¸ªæ–°çš„Podåæ‰åˆ æ‰ä¸€ä¸ªæ—§çš„PODï¼Œæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰3+1ä¸ªPODã€‚</li></ul></li><li><p>maxUnavaible:</p><ul><li>å‡çº§è¿‡ç¨‹ä¸­æœ€å¤šæœ‰å¤šå°‘ä¸ªPODå¤„äºæ— æ³•æä¾›æœåŠ¡çš„çŠ¶æ€</li><li>å½“maxSurgeä¸ä¸º0æ—¶ï¼Œè¯¥å€¼ä¹Ÿä¸èƒ½ä¸º0</li><li>ä¾‹å¦‚ï¼šmaxUnavaible=1ï¼Œåˆ™è¡¨ç¤ºKubernetesæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰1ä¸ªPODå¤„äºæ— æ³•æœåŠ¡çš„çŠ¶æ€ã€‚</li></ul></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">deployment.apps/nginx-deploy configured</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨rolloutå‘½ä»¤</span></span><br><span class="line">$ kubectl rollout status deployment/nginx-deploy</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line"></span><br><span class="line"><span class="comment"># æš‚åœå‡çº§</span></span><br><span class="line">$ kubectl rollout pause deployment deployment/nginx-deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­å‡çº§</span></span><br><span class="line">$ kubectl rollout resume deployment deployment/nginx-deploy</span><br></pre></td></tr></table></figure></li></ul><p>å‡çº§ç»“æŸåï¼Œç»§ç»­æŸ¥çœ‹rsçš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    0         0         0       21m</span><br><span class="line">nginx-deploy-799d666985   3         3         3       10m</span><br></pre></td></tr></table></figure><p>æ ¹æ®AGEæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¦»æˆ‘ä»¬æœ€è¿‘çš„å½“å‰çŠ¶æ€æ˜¯ï¼š3ï¼Œå’Œæˆ‘ä»¬çš„yamlæ–‡ä»¶æ˜¯ä¸€è‡´çš„ï¼Œè¯æ˜å‡çº§æˆåŠŸäº†ã€‚ç”¨describeå‘½ä»¤å¯ä»¥æŸ¥çœ‹å‡çº§çš„å…¨éƒ¨ä¿¡æ¯:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe deploy nginx-deploy</span><br><span class="line">Name:                   nginx-deploy</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Wed, 09 Oct 2019 10:12:56 +0800</span><br><span class="line">Labels:                 k8s-app=nginx-demo</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 2</span><br><span class="line">                        kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                          &#123;<span class="string">"apiVersion"</span>:<span class="string">"apps/v1beta1"</span>,<span class="string">"kind"</span>:<span class="string">"Deployment"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"labels"</span>:&#123;<span class="string">"k8s-app"</span>:<span class="string">"nginx-demo"</span>&#125;,<span class="string">"name"</span>:<span class="string">"nginx-deploy"</span>,<span class="string">"nam...</span></span><br><span class="line"><span class="string">Selector:               app=nginx</span></span><br><span class="line"><span class="string">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span></span><br><span class="line"><span class="string">StrategyType:           RollingUpdate</span></span><br><span class="line"><span class="string">MinReadySeconds:        5</span></span><br><span class="line"><span class="string">RollingUpdateStrategy:  1 max unavailable, 1 max surge</span></span><br><span class="line"><span class="string">Pod Template:</span></span><br><span class="line"><span class="string">  Labels:  app=nginx</span></span><br><span class="line"><span class="string">  Containers:</span></span><br><span class="line"><span class="string">   nginx:</span></span><br><span class="line"><span class="string">    Image:        nginx:1.13.3</span></span><br><span class="line"><span class="string">    Port:         80/TCP</span></span><br><span class="line"><span class="string">    Host Port:    0/TCP</span></span><br><span class="line"><span class="string">    Environment:  &lt;none&gt;</span></span><br><span class="line"><span class="string">    Mounts:       &lt;none&gt;</span></span><br><span class="line"><span class="string">  Volumes:        &lt;none&gt;</span></span><br><span class="line"><span class="string">Conditions:</span></span><br><span class="line"><span class="string">  Type           Status  Reason</span></span><br><span class="line"><span class="string">  ----           ------  ------</span></span><br><span class="line"><span class="string">  Available      True    MinimumReplicasAvailable</span></span><br><span class="line"><span class="string">  Progressing    True    NewReplicaSetAvailable</span></span><br><span class="line"><span class="string">OldReplicaSets:  &lt;none&gt;</span></span><br><span class="line"><span class="string">NewReplicaSet:   nginx-deploy-799d666985 (3/3 replicas created)</span></span><br><span class="line"><span class="string">Events:</span></span><br><span class="line"><span class="string">  Type    Reason             Age   From                   Message</span></span><br><span class="line"><span class="string">  ----    ------             ----  ----                   -------</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  23m   deployment-controller  Scaled up replica set nginx-deploy-6dd86d77d to 3</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 1</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 2</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 2</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 1</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled up replica set nginx-deploy-799d666985 to 3</span></span><br><span class="line"><span class="string">  Normal  ScalingReplicaSet  10m   deployment-controller  Scaled down replica set nginx-deploy-6dd86d77d to 0</span></span><br></pre></td></tr></table></figure><h3 id="å›æ»šDeployment"><a href="#å›æ»šDeployment" class="headerlink" title="å›æ»šDeployment"></a>å›æ»šDeployment</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰é¢å·²ç»æ»šåŠ¨å¹³æ»‘çš„å‡çº§Deploymentï¼Œä½†æ˜¯å¦‚æœå‡çº§åçš„PODå‡ºäº†é—®é¢˜è¯¥æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬èƒ½å¤Ÿæƒ³åˆ°çš„æœ€å¥½æœ€å¿«çš„æ–¹å¼å½“ç„¶æ˜¯å›é€€åˆ°ä¸Šä¸€æ¬¡èƒ½å¤Ÿæä¾›æ­£å¸¸å·¥ä½œçš„ç‰ˆæœ¬ï¼ŒDeploymentå°±ä¸ºæˆ‘ä»¬æä¾›äº†å›æ»šæœºåˆ¶ã€‚</p><ul><li>é¦–å…ˆï¼ŒæŸ¥çœ‹Deploymentçš„å‡çº§å†å²:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment nginx-deploy</span><br><span class="line">deployment.extensions/nginx-deploy </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºåœ¨æ‰§è¡ŒDeploymentå‡çº§çš„æ—¶å€™æœ€å¥½å¸¦ä¸Šrecordå‚æ•°ï¼Œä¾¿äºæˆ‘ä»¬æŸ¥çœ‹å†å²ç‰ˆæœ¬ä¿¡æ¯ã€‚<code>kubectl apply --filename=nginx-deployment.yaml --record=true</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰é€šè¿‡kubectl xxxx â€“recordéƒ½ä¼šè¢«kubernetesè®°å½•åˆ°etcdè¿›è¡ŒæŒä¹…åŒ–ï¼Œè¿™æ— ç–‘ä¼šå ç”¨èµ„æºï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæ—¶é—´ä¹…äº†ï¼Œå½“ä½ kubectl get rsæ—¶ï¼Œä¼šæœ‰æˆç™¾ä¸Šåƒçš„åƒåœ¾RSè¿”å›ï¼Œè¿™å¯¹äºè¿ç»´æ¥è¯´ç»´æŠ¤å¾ˆä¸ä¾¿åˆ©ï¼Œ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬åœ¨ä¸Šç”Ÿäº§æ—¶ï¼Œæˆ‘ä»¬æœ€å¥½é€šè¿‡è®¾ç½®Deploymentçš„.spec.revisionHistoryLimitæ¥é™åˆ¶æœ€å¤§ä¿ç•™çš„revision numberï¼Œæ¯”å¦‚15ä¸ªç‰ˆæœ¬ï¼Œå›æ»šçš„æ—¶å€™ä¸€èˆ¬åªä¼šå›æ»šåˆ°æœ€è¿‘çš„å‡ ä¸ªç‰ˆæœ¬å°±è¶³å¤Ÿäº†ã€‚å…¶å®rollout historyä¸­è®°å½•çš„revisionéƒ½å’ŒReplicaSetsä¸€ä¸€å¯¹åº”ã€‚å¦‚æœæ‰‹åŠ¨deleteæŸä¸ªReplicaSetï¼Œå¯¹åº”çš„rollout historyå°±ä¼šè¢«åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯è¿˜è¯´ä½ æ— æ³•å›æ»šåˆ°è¿™ä¸ªrevisonã€‚rollout historyå’ŒReplicaSetçš„å¯¹åº”å…³ç³»ï¼Œå¯ä»¥åœ¨kubectl describe rs $RSNAMEè¿”å›çš„revisionå­—æ®µä¸­å¾—åˆ°ï¼Œè¿™é‡Œçš„revisionå°±å¯¹åº”ç€rollout historyè¿”å›çš„revisonã€‚</p><ul><li><p>yamlä¾‹å­</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat nginx-deployment.yaml </span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deploy</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  minReadySeconds: 5</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.13.3</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å•ä¸ªrevisonçš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment nginx-deploy --revision=2</span><br><span class="line">deployment.extensions/nginx-deploy with revision <span class="comment">#2</span></span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:	app=nginx</span><br><span class="line">	pod-template-hash=799d666985</span><br><span class="line">  Annotations:	kubernetes.io/change-cause: kubectl apply --filename=nginx-deployment.yaml --record=<span class="literal">true</span></span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:	nginx:1.13.3</span><br><span class="line">    Port:	80/TCP</span><br><span class="line">    Host Port:	0/TCP</span><br><span class="line">    Environment:	&lt;none&gt;</span><br><span class="line">    Mounts:	&lt;none&gt;</span><br><span class="line">  Volumes:	&lt;none&gt;</span><br></pre></td></tr></table></figure></li><li><p>ç›´æ¥å›é€€åˆ°å½“å‰ç‰ˆæœ¬çš„å‰ä¸€ä¸ªç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout undo deployment nginx-deploy</span><br><span class="line">deployment.extensions/nginx-deploy rolled back</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥ç”¨revisionå›é€€åˆ°æŒ‡å®šçš„ç‰ˆæœ¬</span></span><br><span class="line">$ kubectl rollout undo deployment nginx-deploy --to-revision=1</span><br><span class="line">deployment.extensions/nginx-deploy rolled back</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹Deploymentç°åœ¨çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get deployments</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deploy   2/3     3            2           56m</span><br><span class="line"></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    1         1         1       56m</span><br><span class="line">nginx-deploy-799d666985   3         3         1       46m</span><br><span class="line"></span><br><span class="line">$ kubectl rollout status deployment/nginx-deploy</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 of 3 updated replicas are available...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"nginx-deploy"</span> rollout to finish: 2 of 3 updated replicas are available...</span><br><span class="line">deployment <span class="string">"nginx-deploy"</span> successfully rolled out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ŒæˆåæŸ¥çœ‹</span></span><br><span class="line">$ kubectl get rs</span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deploy-6dd86d77d    0         0         0       57m</span><br><span class="line">nginx-deploy-799d666985   3         3         3       47m</span><br></pre></td></tr></table></figure></li></ul><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Deployment</tag>
      </tags>
  </entry>
  <entry>
    <title>harborç§æœ‰ä»“åº“éƒ¨ç½²</title>
    <url>/2019/09/30/harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Harboræ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨å’Œåˆ†å‘Dockeré•œåƒçš„ä¼ä¸šçº§RegistryæœåŠ¡å™¨ï¼Œé€šè¿‡æ·»åŠ ä¸€äº›ä¼ä¸šå¿…éœ€çš„åŠŸèƒ½ç‰¹æ€§ï¼Œä¾‹å¦‚å®‰å…¨ã€æ ‡è¯†å’Œç®¡ç†ç­‰ï¼Œæ‰©å±•äº†å¼€æºDocker Distributionã€‚ä½œä¸ºä¸€ä¸ªä¼ä¸šçº§ç§æœ‰RegistryæœåŠ¡å™¨ï¼ŒHarboræä¾›äº†æ›´å¥½çš„æ€§èƒ½å’Œå®‰å…¨ã€‚æå‡ç”¨æˆ·ä½¿ç”¨Registryæ„å»ºå’Œè¿è¡Œç¯å¢ƒä¼ è¾“é•œåƒçš„æ•ˆç‡ã€‚Harboræ”¯æŒå®‰è£…åœ¨å¤šä¸ªRegistryèŠ‚ç‚¹çš„é•œåƒèµ„æºå¤åˆ¶ï¼Œé•œåƒå…¨éƒ¨ä¿å­˜åœ¨ç§æœ‰Registryä¸­ï¼Œ ç¡®ä¿æ•°æ®å’ŒçŸ¥è¯†äº§æƒåœ¨å…¬å¸å†…éƒ¨ç½‘ç»œä¸­ç®¡æ§ã€‚å¦å¤–ï¼ŒHarborä¹Ÿæä¾›äº†é«˜çº§çš„å®‰å…¨ç‰¹æ€§ï¼Œè¯¸å¦‚ç”¨æˆ·ç®¡ç†ï¼Œè®¿é—®æ§åˆ¶å’Œæ´»åŠ¨å®¡è®¡ç­‰ã€‚</p><a id="more"></a><h3 id="éƒ¨ç½²ç¯å¢ƒå‡†å¤‡"><a href="#éƒ¨ç½²ç¯å¢ƒå‡†å¤‡" class="headerlink" title="éƒ¨ç½²ç¯å¢ƒå‡†å¤‡"></a>éƒ¨ç½²ç¯å¢ƒå‡†å¤‡</h3><h4 id="æœåŠ¡å™¨é…ç½®"><a href="#æœåŠ¡å™¨é…ç½®" class="headerlink" title="æœåŠ¡å™¨é…ç½®"></a>æœåŠ¡å™¨é…ç½®</h4><table><thead><tr><th>ç³»ç»Ÿ</th><th>é…ç½®</th><th>ip</th></tr></thead><tbody><tr><td>centos 7.4</td><td>4/8G/200G</td><td>172.21.16.90</td></tr></tbody></table><h4 id="ä¸‹è½½æ‰€éœ€æ–‡ä»¶"><a href="#ä¸‹è½½æ‰€éœ€æ–‡ä»¶" class="headerlink" title="ä¸‹è½½æ‰€éœ€æ–‡ä»¶"></a>ä¸‹è½½æ‰€éœ€æ–‡ä»¶</h4><h5 id="docker-compose-ä¸‹è½½"><a href="#docker-compose-ä¸‹è½½" class="headerlink" title="docker-compose ä¸‹è½½"></a>docker-compose ä¸‹è½½</h5><p>docker compose <a href="https://github.com/docker/compose/releases" target="_blank" rel="noopener">å‘å¸ƒé¡µé¢</a>ä¸‹è½½æœ€æ–°çš„ docker-compose äºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/docker/compose/releases/download/1.24.1/docker-compose-Linux-x86_64</span></span><br><span class="line"><span class="comment"># mv ~/docker-compose-Linux-x86_64 /usr/bin/docker-compose </span></span><br><span class="line"><span class="comment"># chmod a+x  /ur/bin/docker-compose</span></span><br></pre></td></tr></table></figure><ul><li>å®˜æ–¹çš„å®‰è£…<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class="line"><span class="comment"># chmod +x /usr/local/bin/docker-compose</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="harbor-ä¸‹è½½"><a href="#harbor-ä¸‹è½½" class="headerlink" title="harbor ä¸‹è½½"></a>harbor ä¸‹è½½</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harbor å®‰è£…æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨çº¿å®‰è£…ï¼Œä¸€ç§æ˜¯ç¦»çº¿å®‰è£…ï¼Œè¿™é‡Œç”±äºç½‘ç»œä¸å¥½ï¼Œä½¿ç”¨çš„æ˜¯ç¦»çº¿å®‰è£…ï¼Œharbor<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">å‘å¸ƒé¡µé¢</a>ä¸‹è½½æœ€æ–°çš„ harbor ç¦»çº¿å®‰è£…åŒ…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://storage.googleapis.com/harbor-releases/release-1.9.0/harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line"><span class="comment"># tar -zxvf harbor-offline-installer-v1.9.0.tgz</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹å®‰è£…"><a href="#å¼€å§‹å®‰è£…" class="headerlink" title="å¼€å§‹å®‰è£…"></a>å¼€å§‹å®‰è£…</h3><h4 id="docker-å®‰è£…"><a href="#docker-å®‰è£…" class="headerlink" title="docker å®‰è£…"></a>docker å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum-config-manager   --add-repo   https://download.docker.com/linux/centos/docker-ce.repo</span></span><br><span class="line"><span class="comment"># sudo yum -y install docker-ce-18.09.6-3.el7.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables: 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables: 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># sysctl -p /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="comment"># systemctl  start docker</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>: ä¸æ·»åŠ <code>/etc/sysctl.d/k8s.conf</code> å¯åŠ¨dockerä¼šæç¤º<code>WARNING: bridge-nf-call-iptables is disabled WARNING: bridge-nf-call-ip6tables is disabled</code></p><h4 id="å¯¼å…¥-docker-images"><a href="#å¯¼å…¥-docker-images" class="headerlink" title="å¯¼å…¥ docker images"></a>å¯¼å…¥ docker images</h4><p>å¯¼å…¥ç¦»çº¿å®‰è£…åŒ…ä¸­harborç›¸å…³çš„ docker imagesï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd harbor</span></span><br><span class="line"><span class="comment"># docker load -i harbor.v1.9.0.tar.gz </span></span><br><span class="line"><span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                      TAG                        IMAGE ID            CREATED             SIZE</span><br><span class="line">goharbor/chartmuseum-photon     v0.9.0-v1.9.0              00c12627cbd7        2 weeks ago         131MB</span><br><span class="line">goharbor/harbor-migrator        v1.9.0                     75d4de5e0f16        2 weeks ago         362MB</span><br><span class="line">goharbor/redis-photon           v1.9.0                     3249afaa9965        2 weeks ago         109MB</span><br><span class="line">goharbor/clair-photon           v2.0.9-v1.9.0              e54ad567c58f        2 weeks ago         165MB</span><br><span class="line">goharbor/notary-server-photon   v0.6.1-v1.9.0              2cdecba59f38        2 weeks ago         138MB</span><br><span class="line">goharbor/notary-signer-photon   v0.6.1-v1.9.0              973378593def        2 weeks ago         135MB</span><br><span class="line">goharbor/harbor-registryctl     v1.9.0                     30a01bf0f4df        2 weeks ago         99.6MB</span><br><span class="line">goharbor/registry-photon        v2.7.1-patch-2819-v1.9.0   32571099a9fe        2 weeks ago         82.3MB</span><br><span class="line">goharbor/nginx-photon           v1.9.0                     f933d62f9952        2 weeks ago         43.9MB</span><br><span class="line">goharbor/harbor-log             v1.9.0                     28e27d511335        2 weeks ago         82.6MB</span><br><span class="line">goharbor/harbor-jobservice      v1.9.0                     f3cd0b181a89        2 weeks ago         141MB</span><br><span class="line">goharbor/harbor-core            v1.9.0                     f2814ed8aadd        2 weeks ago         155MB</span><br><span class="line">goharbor/harbor-portal          v1.9.0                     0778d4c5d27e        2 weeks ago         51.3MB</span><br><span class="line">goharbor/harbor-db              v1.9.0                     a809e14d2d49        2 weeks ago         147MB</span><br><span class="line">goharbor/prepare                v1.9.0                     aa594772c1e8        2 weeks ago         147MB</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-harbor-yml-æ–‡ä»¶"><a href="#ä¿®æ”¹-harbor-yml-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ harbor.yml æ–‡ä»¶"></a>ä¿®æ”¹ harbor.yml æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim harbor.yml</span></span><br><span class="line">hostname: reg.xxlaila.cn</span><br><span class="line"></span><br><span class="line"><span class="comment"># email configure</span></span><br><span class="line">email_server: smtp.exmail.qq.com</span><br><span class="line">email_server_port: 465</span><br><span class="line">email_username: admin@xxlaila.cn</span><br><span class="line">email_password: 123</span><br><span class="line">email_from: admin&lt;admin@xxlaila.cn&gt;</span><br><span class="line">email_ssl: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User registration is prohibited</span></span><br><span class="line">self_registration: off</span><br><span class="line"></span><br><span class="line"><span class="comment"># LDAP authentication configuration item</span></span><br><span class="line"><span class="comment">#ldap_url: ldaps://ldap.xxlaila.cn</span></span><br><span class="line"><span class="comment">#ldap_searchdn: uid=username,ou=people,dc=xxlaila,dc=com</span></span><br><span class="line"><span class="comment">#ldap_search_pwd: password</span></span><br><span class="line"><span class="comment">#ldap_basedn: ou=people,dc=xxlaila,dc=com</span></span><br><span class="line"><span class="comment">#ldap_filter: (objectClass=person)</span></span><br><span class="line"><span class="comment">#ldap_uid: uid </span></span><br><span class="line"><span class="comment">#ldap_scope: 3 </span></span><br><span class="line"><span class="comment">#ldap_timeout: 5</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨</strong>: æ–°ç‰ˆæœ¬çš„é‚®ç®±ã€ldapç°åœ¨éƒ½ä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ¥æ·»åŠ é…ç½®äº†ï¼Œç›´æ¥é€šè¿‡webç•Œé¢æ¥è¿›è¡Œé…ç½®å³å¯ï¼Œè¿™é‡Œæˆ‘åªæ˜¯æ·»åŠ è¿›æ¥ï¼Œä¿ç•™ï¼ŒğŸ˜ğŸ˜ğŸ˜</p><h4 id="åŠ è½½å’Œå¯åŠ¨-harbor-é•œåƒ"><a href="#åŠ è½½å’Œå¯åŠ¨-harbor-é•œåƒ" class="headerlink" title="åŠ è½½å’Œå¯åŠ¨ harbor é•œåƒ"></a>åŠ è½½å’Œå¯åŠ¨ harbor é•œåƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /data</span></span><br><span class="line"><span class="comment"># chmod 777 /var/run/docker.sock /data</span></span><br><span class="line"><span class="comment"># ./install.sh </span></span><br><span class="line"></span><br><span class="line">[Step 0]: checking installation environment ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 19.03.2</span><br><span class="line"></span><br><span class="line">Note: docker-compose version: 1.24.1</span><br><span class="line"></span><br><span class="line">[Step 1]: loading Harbor images ...</span><br><span class="line">Loaded image: goharbor/harbor-portal:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-core:v1.9.0</span><br><span class="line">Loaded image: goharbor/nginx-photon:v1.9.0</span><br><span class="line">Loaded image: goharbor/notary-signer-photon:v0.6.1-v1.9.0</span><br><span class="line">Loaded image: goharbor/registry-photon:v2.7.1-patch-2819-v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-migrator:v1.9.0</span><br><span class="line">Loaded image: goharbor/chartmuseum-photon:v0.9.0-v1.9.0</span><br><span class="line">Loaded image: goharbor/prepare:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-log:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-db:v1.9.0</span><br><span class="line">Loaded image: goharbor/clair-photon:v2.0.9-v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-jobservice:v1.9.0</span><br><span class="line">Loaded image: goharbor/harbor-registryctl:v1.9.0</span><br><span class="line">Loaded image: goharbor/redis-photon:v1.9.0</span><br><span class="line">Loaded image: goharbor/notary-server-photon:v0.6.1-v1.9.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 2]: preparing environment ...</span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /opt/harbor</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated and saved secret to file: /secret/keys/secretkey</span><br><span class="line">Generated certificate, key file: /secret/core/private_key.pem, cert file: /secret/registry/root.crt</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 3]: starting Harbor ...</span><br><span class="line">Creating network <span class="string">"harbor_harbor"</span> with the default driver</span><br><span class="line">Creating harbor-log ... <span class="keyword">done</span></span><br><span class="line">Creating registryctl   ... <span class="keyword">done</span></span><br><span class="line">Creating redis         ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-portal ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-db     ... <span class="keyword">done</span></span><br><span class="line">Creating registry      ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-core   ... <span class="keyword">done</span></span><br><span class="line">Creating nginx             ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-jobservice ... <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">âœ” ----Harbor has been installed and started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able to visit the admin portal at http://reg.xxlaila.cn. </span><br><span class="line">For more details, please visit https://github.com/goharbor/harbor .</span><br></pre></td></tr></table></figure><h4 id="è®¿é—®ç®¡ç†ç•Œé¢"><a href="#è®¿é—®ç®¡ç†ç•Œé¢" class="headerlink" title="è®¿é—®ç®¡ç†ç•Œé¢"></a>è®¿é—®ç®¡ç†ç•Œé¢</h4><p>ç¡®è®¤æ‰€æœ‰ç»„ä»¶éƒ½å·¥ä½œæ­£å¸¸ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker-compose  ps</span></span><br><span class="line">      Name                     Command                       State                     Ports          </span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-core         /harbor/harbor_core              Up (healthy)                                     </span><br><span class="line">harbor-db           /docker-entrypoint.sh            Up (healthy)            5432/tcp                 </span><br><span class="line">harbor-jobservice   /harbor/harbor_jobservice  ...   Up (health: starting)                            </span><br><span class="line">harbor-log          /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up (healthy)            127.0.0.1:1514-&gt;10514/tcp</span><br><span class="line">harbor-portal       nginx -g daemon off;             Up (healthy)            8080/tcp                 </span><br><span class="line">nginx               nginx -g daemon off;             Up (healthy)            0.0.0.0:80-&gt;8080/tcp     </span><br><span class="line">redis               redis-server /etc/redis.conf     Up (healthy)            6379/tcp                 </span><br><span class="line">registry            /entrypoint.sh /etc/regist ...   Up (healthy)            5000/tcp                 </span><br><span class="line">registryctl         /harbor/start.sh                 Up (healthy)</span><br></pre></td></tr></table></figure><h5 id="harbor-ç»„å»ºä»‹ç»"><a href="#harbor-ç»„å»ºä»‹ç»" class="headerlink" title="harbor ç»„å»ºä»‹ç»"></a>harbor ç»„å»ºä»‹ç»</h5><ul><li>harbor-core: Harborçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸»è¦æä¾›ä»¥ä¸‹æœåŠ¡ï¼š<ul><li>UIï¼šæä¾›å›¾å½¢åŒ–ç•Œé¢ï¼Œå¸®åŠ©ç”¨æˆ·ç®¡ç†registryä¸Šçš„é•œåƒï¼ˆimageï¼‰, å¹¶å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒã€‚</li><li>webhookï¼šä¸ºäº†åŠæ—¶è·å–registry ä¸ŠimageçŠ¶æ€å˜åŒ–çš„æƒ…å†µï¼Œ åœ¨Registryä¸Šé…ç½®webhookï¼ŒæŠŠçŠ¶æ€å˜åŒ–ä¼ é€’ç»™UIæ¨¡å—ã€‚</li><li>token æœåŠ¡ï¼šè´Ÿè´£æ ¹æ®ç”¨æˆ·æƒé™ç»™æ¯ä¸ªdocker push/pullå‘½ä»¤ç­¾å‘token. Docker å®¢æˆ·ç«¯å‘RegiÃ¸stryæœåŠ¡å‘èµ·çš„è¯·æ±‚,å¦‚æœä¸åŒ…å«tokenï¼Œä¼šè¢«é‡å®šå‘åˆ°è¿™é‡Œï¼Œè·å¾—tokenåå†é‡æ–°å‘Registryè¿›è¡Œè¯·æ±‚ã€‚</li></ul></li><li>harbor-db: ä¸ºcore servicesæä¾›æ•°æ®åº“æœåŠ¡ï¼Œè´Ÿè´£å‚¨å­˜ç”¨æˆ·æƒé™ã€å®¡è®¡æ—¥å¿—ã€Docker imageåˆ†ç»„ä¿¡æ¯ç­‰æ•°æ®ã€‚</li><li>harbor-jobservice: harbor-jobservice æ˜¯harborçš„jobç®¡ç†æ¨¡å—ï¼Œjobåœ¨harboré‡Œé¢ä¸»è¦æ˜¯ä¸ºäº†é•œåƒä»“åº“ä¹‹å‰åŒæ­¥ä½¿ç”¨çš„;</li><li>harbor-log: ä¸ºäº†å¸®åŠ©ç›‘æ§Harborè¿è¡Œï¼Œè´Ÿè´£æ”¶é›†å…¶ä»–ç»„ä»¶çš„logï¼Œä¾›æ—¥åè¿›è¡Œåˆ†æã€‚</li><li>nginx: nginxè´Ÿè´£æµé‡è½¬å‘å’Œå®‰å…¨éªŒè¯ï¼Œå¯¹å¤–æä¾›çš„æµé‡éƒ½æ˜¯ä»nginxä¸­è½¬ï¼Œæ‰€ä»¥å¼€æ”¾httpsçš„443ç«¯å£ï¼Œå®ƒå°†æµé‡åˆ†å‘åˆ°åç«¯çš„uiå’Œæ­£åœ¨dockeré•œåƒå­˜å‚¨çš„docker registryã€‚</li><li>redis: å­˜å‚¨ç¼“å­˜ä¿¡æ¯</li><li>registry: è´Ÿè´£å‚¨å­˜Dockeré•œåƒï¼Œå¹¶å¤„ç†docker push/pull å‘½ä»¤ã€‚ç”±äºæˆ‘ä»¬è¦å¯¹ç”¨æˆ·è¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œå³ä¸åŒç”¨æˆ·å¯¹Docker imageæœ‰ä¸åŒçš„è¯»å†™æƒé™ï¼ŒRegistryä¼šæŒ‡å‘ä¸€ä¸ªtokenæœåŠ¡ï¼Œå¼ºåˆ¶ç”¨æˆ·çš„æ¯æ¬¡docker pull/pushè¯·æ±‚éƒ½è¦æºå¸¦ä¸€ä¸ªåˆæ³•çš„token, Registryä¼šé€šè¿‡å…¬é’¥å¯¹token è¿›è¡Œè§£å¯†éªŒè¯ã€‚</li><li>registryctl: æ˜¯harborçš„ç®¡ç†å‘˜é…ç½®harborçš„ä¸€äº›å¸¸ç”¨é…ç½®å’Œé«˜çº§é…ç½®</li></ul><p>åœ¨æµè§ˆå™¨è®¿é—®<a href="http://reg.xxlaila.cnï¼Œ" target="_blank" rel="noopener">http://reg.xxlaila.cnï¼Œ</a> ç”¨è´¦å· admin å’Œ harbor.yml é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å¯†ç  Harbor12345 ç™»é™†ç³»ç»Ÿ<br><img src="https://img.xxlaila.cn/8095d05-b9b7-4bdc-b0fc-7810db649e23.png" alt="img"><br><img src="https://img.xxlaila.cn/4bfab8be-e5de-4165-9268-fa591c5f12f8.png" alt="img"></p><h4 id="harbor-è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•"><a href="#harbor-è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•" class="headerlink" title="harbor è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•"></a>harbor è¿è¡Œæ—¶äº§ç”Ÿçš„æ–‡ä»¶ã€ç›®å½•</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;harbor å°†æ—¥å¿—æ‰“å°åˆ° /var/log/harbor çš„ç›¸å…³ç›®å½•ä¸‹ï¼Œä¼ ç»Ÿçš„docker logs XXX æˆ– docker-compose logs XXX çœ‹ä¸åˆ°å®¹å™¨çš„æ—¥å¿—ã€‚åªæœ‰ä½¿ç”¨å¸¸ç”¨ç³»ç»Ÿå‘½ä»¤æ¥è¿›è¡Œæ—¥å¿—çš„æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># # æ—¥å¿—ç›®å½•</span></span><br><span class="line"><span class="comment"># ls /var/log/harbor</span></span><br><span class="line">core.log  jobservice.log  portal.log  postgresql.log  proxy.log  redis.log  registryctl.log  registry.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># # æ•°æ®ç›®å½•ï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€é•œåƒä»“åº“</span></span><br><span class="line"><span class="comment"># ls /data/</span></span><br><span class="line">ca_download  database  job_logs  psc  redis  registry  secret</span><br></pre></td></tr></table></figure><h4 id="å…¶å®ƒæ“ä½œ"><a href="#å…¶å®ƒæ“ä½œ" class="headerlink" title="å…¶å®ƒæ“ä½œ"></a>å…¶å®ƒæ“ä½œ</h4><p>ä¸‹åˆ—æ“ä½œçš„å·¥ä½œç›®å½•å‡ä¸ºè§£å‹ç¦»çº¿å®‰è£…æ–‡ä»¶åç”Ÿæˆçš„ harbor ç›®å½•ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># # åœæ­¢ harbor</span></span><br><span class="line"><span class="comment"># docker-compose down -v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # å¯åŠ¨ harbor</span></span><br><span class="line"><span class="comment"># docker-compose up -d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # æ›´ä¿®æ”¹çš„é…ç½®æ›´æ–°åˆ° docker-compose.yml æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># ./prepare</span></span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /opt/harbor</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Clearing the configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Clearing the configuration file: /config/nginx/nginx.conf</span><br><span class="line">Clearing the configuration file: /config/core/env</span><br><span class="line">Clearing the configuration file: /config/core/app.conf</span><br><span class="line">Clearing the configuration file: /config/registry/config.yml</span><br><span class="line">Clearing the configuration file: /config/registry/root.crt</span><br><span class="line">Clearing the configuration file: /config/registryctl/env</span><br><span class="line">Clearing the configuration file: /config/registryctl/config.yml</span><br><span class="line">Clearing the configuration file: /config/db/env</span><br><span class="line">Clearing the configuration file: /config/jobservice/env</span><br><span class="line">Clearing the configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/rsyslog_docker.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">loaded secret from file: /secret/keys/secretkey</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>harbor</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s podå¥åº·æ£€æµ‹</title>
    <url>/2019/09/27/k8s-pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="Podå¥åº·æ£€æµ‹æœºåˆ¶"><a href="#Podå¥åº·æ£€æµ‹æœºåˆ¶" class="headerlink" title="Podå¥åº·æ£€æµ‹æœºåˆ¶"></a>Podå¥åº·æ£€æµ‹æœºåˆ¶</h3><p>å¯¹äºPodçš„å¥åº·çŠ¶æ€æ£€æµ‹ï¼Œkubernetesæä¾›äº†ä¸¤ç±»æ¢é’ˆ(Probe)æ¥æ‰§è¡Œå¯¹Podçš„å¥åº·çŠ¶æ€æ£€æµ‹:</p><ul><li><strong>LivenessProbeæ¢é’ˆ</strong>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå³Podæ˜¯å¦ä¸ºrunningçŠ¶æ€ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†killæ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥æ˜¯å¦é‡å¯ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œåˆ™Kubeletè®¤ä¸ºå®¹å™¨çš„LivenessProbeæ¢é’ˆçš„è¿”å›å€¼æ°¸è¿œæˆåŠŸ.</li></ul><a id="more"></a><ul><li><strong>ReadinessProbeæ¢é’ˆ</strong>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œå³å®¹å™¨çš„Readyæ˜¯å¦ä¸ºTrueï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœReadinessProbeæ¢æµ‹å¤±è´¥ï¼Œåˆ™å®¹å™¨çš„Readyå°†ä¸ºFalseï¼Œæ§åˆ¶å™¨å°†æ­¤Podçš„Endpointä»å¯¹åº”çš„serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»æ­¤ä¸å†å°†ä»»ä½•è¯·æ±‚è°ƒåº¦æ­¤Podä¸Šï¼Œç›´åˆ°ä¸‹æ¬¡æ¢æµ‹æˆåŠŸã€‚</li></ul><!--more--><p>æ¯ç±»æ¢é’ˆéƒ½æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹æ³•:</p><ul><li><strong>exec</strong>: é€šè¿‡æ‰§è¡Œå‘½ä»¤æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œé’ˆå¯¹å¤æ‚æ£€æµ‹æˆ–æ— HTTPæ¥å£çš„æœåŠ¡ï¼Œå‘½ä»¤è¿”å›å€¼ä¸º0åˆ™è¡¨ç¤ºå®¹å™¨å¥åº·ã€‚</li><li><strong>httpGet</strong>: é€šè¿‡å‘é€httpè¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œè¿”å›200-399çŠ¶æ€ç åˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li><li><strong>tcpSocket</strong>: é€šè¿‡å®¹å™¨çš„IPå’ŒPortæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li></ul><p>æ¢é’ˆæ¢æµ‹çš„ç»“æœæœ‰ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€:</p><ul><li><strong>Success</strong>: Containeré€šè¿‡äº†æ£€æŸ¥</li><li><strong>Failure</strong>: Containeræœªé€šè¿‡æ£€æŸ¥</li><li><strong>Unknown</strong>: æœªèƒ½æ‰§è¡Œæ£€æŸ¥ï¼Œå› æ­¤ä¸é‡‡å–ä»»ä½•æªæ–½</li></ul><h3 id="LivenessProbeæ¢é’ˆé…ç½®"><a href="#LivenessProbeæ¢é’ˆé…ç½®" class="headerlink" title="LivenessProbeæ¢é’ˆé…ç½®"></a>LivenessProbeæ¢é’ˆé…ç½®</h3><h4 id="ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹ä¸€ï¼šé€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹</h4><ul><li>exec-liveness.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; <span class="built_in">exec</span>-liveness.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">test</span>: liveness</span><br><span class="line">  name: liveness-exec</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">    - /bin/sh</span><br><span class="line">    - -c</span><br><span class="line">    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><br><span class="line">    livenessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - cat</span><br><span class="line">        - /tmp/healthy</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 5</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹å®¹å™¨æ‰§è¡ŒlivenessProbeæ£€æŸ¥ï¼ŒperiodSecondså­—æ®µæŒ‡å®škubeletæ¯5sæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œæ£€æŸ¥çš„å‘½ä»¤ä¸ºcat /tmp/healthyï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletåº”è¯¥åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ä¹‹å‰ç­‰å¾…5ç§’ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›0ï¼Œé‚£ä¹ˆkubeletå°±è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸ºé0ï¼Œåˆ™Kubeletä¼šKillæ‰å®¹å™¨å¹¶æ ¹æ®é‡å¯ç­–ç•¥æ¥å†³å®šæ˜¯å¦éœ€è¦é‡å¯ã€‚</p><ul><li>å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/bin/sh -c <span class="string">"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯¹äºå®¹å™¨çš„å‰30ç§’ï¼Œæœ‰ä¸€ä¸ª/tmp/healthyæ–‡ä»¶ã€‚å› æ­¤ï¼Œåœ¨å‰30ç§’å†…ï¼Œè¯¥å‘½ä»¤cat /tmp/healthyè¿”å›æˆåŠŸä»£ç ã€‚30ç§’åï¼Œcat /tmp/healthyè¿”å›å¤±è´¥ä»£ç ã€‚</p><ul><li><p>åˆ›å»ºPod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl create -f  <span class="built_in">exec</span>-liveness.yaml </span><br><span class="line">pod/liveness-exec created</span><br></pre></td></tr></table></figure></li><li><p>åœ¨30ç§’å†…ï¼ŒæŸ¥çœ‹Podäº‹ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                   Message</span><br><span class="line">  ----    ------     ----  ----                   -------</span><br><span class="line">  Normal  Scheduled  23s   default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Normal  Pulling    20s   kubelet, 172.21.17.34  Pulling image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Pulled     2s    kubelet, 172.21.17.34  Successfully pulled image <span class="string">"busybox"</span></span><br><span class="line">  Normal  Created    2s    kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal  Started    1s    kubelet, 172.21.17.34  Started container liveness</span><br></pre></td></tr></table></figure></li><li><p>35ç§’åï¼Œå†æ¬¡æŸ¥çœ‹Podäº‹ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age              From                   Message</span><br><span class="line">  ----     ------     ----             ----                   -------</span><br><span class="line">  Normal   Scheduled  58s              default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Normal   Pulling    55s              kubelet, 172.21.17.34  Pulling image <span class="string">"busybox"</span></span><br><span class="line">  Normal   Pulled     37s              kubelet, 172.21.17.34  Successfully pulled image <span class="string">"busybox"</span></span><br><span class="line">  Normal   Created    37s              kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal   Started    36s              kubelet, 172.21.17.34  Started container liveness</span><br><span class="line">  Warning  Unhealthy  0s (x2 over 5s)  kubelet, 172.21.17.34  Liveness probe failed: cat: can<span class="string">'t open '</span>/tmp/healthy<span class="string">': No such file or directory</span></span><br></pre></td></tr></table></figure></li><li><p>å†ç­‰30ç§’ï¼Œç¡®è®¤Containerå·²é‡æ–°å¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod liveness-exec</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-exec   1/1     Running   1          115s</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                 From                   Message</span><br><span class="line">  ----     ------     ----                ----                   -------</span><br><span class="line">  Normal   Scheduled  2m7s                default-scheduler      Successfully assigned default/liveness-exec to 172.21.17.34</span><br><span class="line">  Warning  Unhealthy  64s (x3 over 74s)   kubelet, 172.21.17.34  Liveness probe failed: cat: can<span class="string">'t open '</span>/tmp/healthy<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">  Normal   Killing    64s                 kubelet, 172.21.17.34  Container liveness failed liveness probe, will be restarted</span></span><br><span class="line"><span class="string">  Normal   Pulling    34s (x2 over 2m4s)  kubelet, 172.21.17.34  Pulling image "busybox"</span></span><br><span class="line"><span class="string">  Normal   Pulled     25s (x2 over 106s)  kubelet, 172.21.17.34  Successfully pulled image "busybox"</span></span><br><span class="line"><span class="string">  Normal   Created    25s (x2 over 106s)  kubelet, 172.21.17.34  Created container liveness</span></span><br><span class="line"><span class="string">  Normal   Started    25s (x2 over 105s)  kubelet, 172.21.17.34  Started container liveness</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; http-liveness.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">test</span>: liveness</span><br><span class="line">  name: liveness-http</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: carlziess/liveness</span><br><span class="line">    args:</span><br><span class="line">    - /server</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /healthz</span><br><span class="line">        port: 8080</span><br><span class="line">        httpHeaders:</span><br><span class="line">        - name: X-Custom-Header</span><br><span class="line">          value: Awesome</span><br><span class="line">      initialDelaySeconds: 3</span><br><span class="line">      periodSeconds: 3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ªPodï¼Œå…¶ä¸­periodSecondså­—æ®µæŒ‡å®škubeletæ¯3ç§’æ‰§è¡Œä¸€æ¬¡æ¢æµ‹ï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletå»¶è¿Ÿç­‰å¾…3ç§’ï¼Œæ¢æµ‹æ–¹å¼ä¸ºå‘å®¹å™¨ä¸­è¿è¡Œçš„æœåŠ¡å‘é€HTTP GETè¯·æ±‚ï¼Œè¯·æ±‚8080ç«¯å£ä¸‹çš„/healthz, ä»»ä½•å¤§äºæˆ–ç­‰äº200ä¸”å°äº400çš„ä»£ç è¡¨ç¤ºæˆåŠŸã€‚ä»»ä½•å…¶ä»–ä»£ç è¡¨ç¤ºå¤±è´¥ã€‚</p><ul><li><p>åˆ›å»ºpod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f http-liveness.yaml </span><br><span class="line">pod/liveness-http created</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod liveness-http</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                   From                   Message</span><br><span class="line">  ----     ------     ----                  ----                   -------</span><br><span class="line">  Normal   Scheduled  2m59s                 default-scheduler      Successfully assigned default/liveness-http to 172.21.17.34</span><br><span class="line">  Normal   Pulled     119s (x3 over 2m46s)  kubelet, 172.21.17.34  Successfully pulled image <span class="string">"carlziess/liveness"</span></span><br><span class="line">  Normal   Created    119s (x3 over 2m46s)  kubelet, 172.21.17.34  Created container liveness</span><br><span class="line">  Normal   Started    118s (x3 over 2m45s)  kubelet, 172.21.17.34  Started container liveness</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-http   1/1     Running   0          26s</span><br></pre></td></tr></table></figure></li><li><p><strong>httpGet</strong>æ¢æµ‹æ–¹å¼æœ‰å¦‚ä¸‹å¯é€‰çš„æ§åˆ¶å­—æ®µ</p><ul><li>host: è¦è¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤ä¸ºPod IPï¼Œå¯ä»¥åœ¨http request headä¸­è®¾ç½®hostå¤´éƒ¨ã€‚</li><li>scheme: ç”¨äºè¿æ¥hostçš„åè®®ï¼Œé»˜è®¤ä¸ºHTTPã€‚</li><li>path: httpæœåŠ¡å™¨ä¸Šçš„è®¿é—®URL</li><li>httpHeaders: è‡ªå®šä¹‰HTTPè¯·æ±‚headersï¼ŒHTTPå…è®¸é‡å¤headers</li><li>port: å®¹å™¨ä¸Šè¦è®¿é—®ç«¯å£å·æˆ–åç§°</li></ul></li></ul><h4 id="ä¾‹ä¸‰-é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ä¾‹ä¸‰-é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ä¾‹ä¸‰: é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ä¾‹ä¸‰: é€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹</h4><p>Kubeletå°†å°è¯•åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šæ‰“å¼€å®¹å™¨ä¸Šçš„å¥—æ¥å­—ï¼Œå¦‚æœèƒ½å»ºç«‹è¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; tcp-liveness-readiness.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: goproxy</span><br><span class="line">  labels:</span><br><span class="line">    app: goproxy</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: goproxy</span><br><span class="line">    image: goproxy/goproxy</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    readinessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      periodSeconds: 20</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCPæ£€æŸ¥æ–¹å¼å’ŒHTTPæ£€æŸ¥æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œç¤ºä¾‹ä¸­ä¸¤ç§æ¢é’ˆéƒ½ä½¿ç”¨äº†ï¼Œåœ¨å®¹å™¨å¯åŠ¨5ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªreadinessProbeæ¢é’ˆï¼Œè¿™å°†è¿æ¥åˆ°å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœæ¢æµ‹æˆåŠŸï¼Œåˆ™è¯¥Podå°†è¢«æ ‡è¯†ä¸ºreadyï¼Œ10ç§’åï¼Œkubeletå°†è¿›è¡Œç¬¬äºŒæ¬¡è¿æ¥ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é™¤æ­¤ï¼Œé…ç½®è¿˜åŒ…å«äº†livenessProbeæ¢é’ˆï¼Œåœ¨å®¹å™¨å¯åŠ¨15ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªlivenessProbeæ¢é’ˆï¼Œä»ç„¶å°è¯•è¿æ¥å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœè¿æ¥å¤±è´¥åˆ™é‡å¯å®¹å™¨ã€‚</p><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f tcp-liveness-readiness.yaml</span><br><span class="line">pod/goproxy created</span><br></pre></td></tr></table></figure></li><li><p>15ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ä»¥éªŒè¯æ´»åŠ¨æ¢æµ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod goproxy</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 360s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                    Message</span><br><span class="line">  ----    ------     ----  ----                    -------</span><br><span class="line">  Normal  Scheduled  26s   default-scheduler       Successfully assigned default/goproxy to 172.21.16.231</span><br><span class="line">  Normal  Pulling    22s   kubelet, 172.21.16.231  Pulling image <span class="string">"goproxy/goproxy"</span></span><br></pre></td></tr></table></figure></li></ul><p>å½“å®¹å™¨æœ‰å¤šä¸ªç«¯å£æ—¶ï¼Œé€šå¸¸ä¼šç»™æ¯ä¸ªç«¯å£å‘½åï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ¢é’ˆæ¢æµ‹æ—¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™è‡ªå®šä¹‰çš„ç«¯å£åç§°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- name: liveness-port</span><br><span class="line">  containerPort: 8080</span><br><span class="line">  hostPort: 8080</span><br><span class="line">livenessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /healthz</span><br><span class="line">    port: liveness-port</span><br></pre></td></tr></table></figure><h3 id="ReadinessProbeæ¢é’ˆé…ç½®"><a href="#ReadinessProbeæ¢é’ˆé…ç½®" class="headerlink" title="ReadinessProbeæ¢é’ˆé…ç½®"></a>ReadinessProbeæ¢é’ˆé…ç½®</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeæ¢é’ˆçš„ä½¿ç”¨åœºæ™¯livenessProbeç¨æœ‰ä¸åŒï¼Œæœ‰çš„æ—¶å€™åº”ç”¨ç¨‹åºå¯èƒ½æš‚æ—¶æ— æ³•æ¥å—è¯·æ±‚ï¼Œæ¯”å¦‚Podå·²ç»Runningäº†ï¼Œä½†æ˜¯å®¹å™¨å†…åº”ç”¨ç¨‹åºå°šæœªå¯åŠ¨æˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰ReadinessProbeï¼Œåˆ™Kubernetesè®¤ä¸ºå®ƒå¯ä»¥å¤„ç†è¯·æ±‚äº†ï¼Œç„¶è€Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ç¨‹åºè¿˜æ²¡å¯åŠ¨æˆåŠŸæ˜¯ä¸èƒ½æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¸å¸Œæœ›kubernetesæŠŠè¯·æ±‚è°ƒåº¦ç»™å®ƒï¼Œåˆ™ä½¿ç”¨ReadinessProbeæ¢é’ˆã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeå’ŒlivenessProbeå¯ä»¥ä½¿ç”¨ç›¸åŒæ¢æµ‹æ–¹å¼ï¼Œåªæ˜¯å¯¹Podçš„å¤„ç½®æ–¹å¼ä¸åŒï¼ŒReadinessProbeæ˜¯å°†Pod IP:Portä»å¯¹åº”çš„EndPointåˆ—è¡¨ä¸­åˆ é™¤ï¼Œè€ŒlivenessProbeåˆ™Killå®¹å™¨å¹¶æ ¹æ®Podçš„é‡å¯ç­–ç•¥æ¥å†³å®šä½œå‡ºå¯¹åº”çš„æªæ–½ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢é’ˆæ¢æµ‹å®¹å™¨æ˜¯å¦å·²å‡†å¤‡å°±ç»ªï¼Œå¦‚æœæœªå‡†å¤‡å°±ç»ªåˆ™kubernetesä¸ä¼šå°†æµé‡è½¬å‘ç»™æ­¤Podã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReadinessProbeæ¢é’ˆä¸livenessProbeä¸€æ ·ä¹Ÿæ”¯æŒexecã€httpGetã€TCPçš„æ¢æµ‹æ–¹å¼ï¼Œé…ç½®æ–¹å¼ç›¸åŒï¼Œåªä¸è¿‡æ˜¯å°†livenessProbeå­—æ®µä¿®æ”¹ä¸ºReadinessProbeã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">readinessProbe:</span><br><span class="line">  <span class="built_in">exec</span>:</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - cat</span><br><span class="line">    - /tmp/healthy</span><br><span class="line">  initialDelaySeconds: 5</span><br><span class="line">  periodSeconds: 5</span><br></pre></td></tr></table></figure><p>ReadinessProbeæ¢é’ˆçš„HTTPã€TCPçš„æ¢æµ‹æ–¹å¼ä¹Ÿä¸livenessProbeçš„åŸºæœ¬ä¸€è‡´ã€‚</p><h4 id="ä¾‹å››-ReadinessProbeç¤ºä¾‹"><a href="#ä¾‹å››-ReadinessProbeç¤ºä¾‹" class="headerlink" title="ä¾‹å››: ReadinessProbeç¤ºä¾‹"></a>ä¾‹å››: ReadinessProbeç¤ºä¾‹</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ å…¥ReadinessProbeæ¢é’ˆå’Œä¸€ä¸ªæ²¡æœ‰ReadinessProbeæ¢é’ˆçš„ç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªdeployï¼Œåä¸ºJavaAppï¼Œå¯åŠ¨çš„å®¹å™¨è¿è¡Œä¸€ä¸ªjavaåº”ç”¨ç¨‹åºï¼Œç¨‹åºç›‘å¬ç«¯å£ä¸º9093ã€‚</p><ul><li><p>æ²¡æœ‰ReadinessProbe</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; k8s.yaml &lt;&lt; EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  labels:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9093</span><br><span class="line">    name: biz-gateway</span><br><span class="line">  selector:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: biz-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: biz-gateway</span><br><span class="line">        image: docker.io/xxlaila/biz-gateway:dev-08c8a4e</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9093</span><br><span class="line">        env:</span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: dev</span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.cn</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f k8s.yaml </span><br><span class="line">service/biz-gateway created</span><br><span class="line">deployment.extensions/biz-gateway created</span><br></pre></td></tr></table></figure></li><li><p>åˆšåˆ›å»ºåï¼Œç­‰ä¸€ä¼šåï¼ŒæŸ¥çœ‹PodçŠ¶æ€ï¼Œè®°ç€è¦ç»™imageç•™ä¸‹pullçš„æ—¶é—´</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods  |grep <span class="string">"biz-gateway"</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">biz-gateway-95f6b677f-rnz22   1/1     Running   0          2m8s</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªè¿‡ç¨‹Podç”¨äº†2m8sï¼Œè‡ªèº«çŠ¶æ€å·²Runningï¼Œå…¶READå­—æ®µï¼Œ1/1 è¡¨ç¤º1ä¸ªå®¹å™¨çŠ¶æ€å·²å‡†å¤‡å°±ç»ªäº†ï¼Œæ­¤æ—¶ï¼Œå¯¹äºkubernetesè€Œè¨€ï¼Œå·²ç»å¯ä»¥æ¥æ”¶è¯·æ±‚äº†,è€Œå®é™…ä¸ŠæœåŠ¡è¿˜æ— æ³•è®¿é—®ï¼Œå› ä¸ºJAVAç¨‹åºè¿˜å°šå¯åŠ¨èµ·æ¥ï¼Œ2m8ssåæ–¹å¯æ­£å¸¸è®¿é—®ï¼Œæ‰€ä»¥é’ˆå¯¹æ­¤ç±»ç¨‹åºï¼Œå¿…é¡»é…ç½®ReadinessProbeã€‚</p><ul><li>åŠ å…¥readinessProbe<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; k8s.yaml &lt;&lt; EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  labels:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 9093</span><br><span class="line">    name: biz-gateway</span><br><span class="line">  selector:</span><br><span class="line">    app: biz-gateway</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: biz-gateway</span><br><span class="line">  namespace:</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: biz-gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: biz-gateway</span><br><span class="line">        image: docker.io/xxlaila/biz-gateway:dev-08c8a4e</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9093</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9093</span><br><span class="line">          initialDelaySeconds: 140</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        env:</span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: dev</span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.cn</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼ŒReadinessProbeæ¢é’ˆçš„æ¢æµ‹æ–¹å¼ä¸ºtcpSocketï¼Œå› ä¸ºç¨‹åºç›‘å¬åœ¨9093ç«¯å£ï¼Œæ‰€ä»¥è¿™é‡Œæ¢æµ‹ä¸ºå¯¹9093å»ºç«‹è¿æ¥,è¿™é‡Œç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æ˜¯åœ¨Pod Runingå140ç§’åï¼Œé—´éš”10ç§’åæ‰§è¡Œç¬¬äºŒæ¬¡æ¢æµ‹ã€‚</p><ul><li><p>åˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f ./</span><br><span class="line">service/biz-gateway created</span><br><span class="line">deployment.extensions/biz-gateway created</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåç­‰å¾…äº†60s</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP            NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">biz-gateway-f69cc8678-qs8s7   0/1     Running   0          60s   172.30.56.6   172.21.17.40   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­ç­‰å¾…ä¸€ä¼š</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">biz-gateway-f69cc8678-qs8s7   1/1     Running   0          2m36s   172.30.56.6   172.21.17.40   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°åœ¨2m36ç§’åï¼Œpodå¯åŠ¨okï¼Œåœ¨ç¬¬ä¸€æ¬¡æŸ¥çœ‹çš„æ—¶å€™ï¼ŒPodè™½ç„¶å·²å¤„äºRunnigçŠ¶æ€ï¼Œä½†æ˜¯ç”±äºç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æœªåˆ°ï¼Œæ‰€ä»¥READYå­—æ®µä¸º0/1ï¼Œå³å®¹å™¨çš„çŠ¶æ€ä¸ºæœªå‡†å¤‡å°±ç»ªï¼Œåœ¨æœªå‡†å¤‡å°±ç»ªçš„æƒ…å†µä¸‹ï¼Œå…¶Podå¯¹åº”çš„Serviceä¸‹çš„Endpointä¹Ÿä¸ºç©ºï¼Œæ‰€ä»¥æ‰ä¸ä¼šæœ‰ä»»ä½•è¯·æ±‚è¢«è°ƒåº¦è¿›æ¥ã€‚</p><ul><li>æŸ¥çœ‹Endpoint<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ¬¡æ‰§è¡Œ</span></span><br><span class="line">$ kubectl get endpoints</span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">biz-gateway                                                            57s</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   13d</span><br><span class="line"></span><br><span class="line">åœ¨2m36sååœ¨æ¬¡æ‰§è¡Œ</span><br><span class="line">$ kubectl get endpoints</span><br><span class="line">NAME          ENDPOINTS                                                AGE</span><br><span class="line">biz-gateway   172.30.56.6:9093                                         2m41s</span><br><span class="line">kubernetes    172.21.16.110:6443,172.21.17.30:6443,172.21.17.31:6443   13d</span><br></pre></td></tr></table></figure></li></ul><h3 id="é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§"><a href="#é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§" class="headerlink" title="é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§"></a>é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢é’ˆ(Probe)æœ‰è®¸å¤šå¯é€‰å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æ›´åŠ ç²¾ç¡®çš„æ§åˆ¶Livenesså’ŒReadinessä¸¤ç§æ¢é’ˆçš„è¡Œä¸º(Probe)ï¼š</p><ul><li>initialDelaySecondsï¼šPodå¯åŠ¨åå»¶è¿Ÿå¤šä¹…æ‰è¿›è¡Œæ£€æŸ¥ï¼Œå•ä½ï¼šç§’</li><li>periodSecondsï¼šæ£€æŸ¥çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º10ï¼Œå•ä½ï¼šç§’ã€‚</li><li>timeoutSecondsï¼šæ¢æµ‹çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º1ï¼Œå•ä½ï¼šç§’ã€‚</li><li>successThresholdï¼šæ¢æµ‹å¤±è´¥åè®¤ä¸ºæˆåŠŸçš„æœ€å°è¿æ¥æˆåŠŸæ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œåœ¨Livenessæ¢é’ˆä¸­å¿…é¡»ä¸º1ï¼Œæœ€å°å€¼ä¸º1ã€‚</li><li>failureThresholdï¼šæ¢æµ‹å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•ä¸€å®šæ¬¡æ•°åå°†è®¤ä¸ºå¤±è´¥ï¼Œåœ¨readinessæ¢é’ˆä¸­ï¼ŒPodä¼šè¢«æ ‡è®°ä¸ºæœªå°±ç»ªï¼Œé»˜è®¤ä¸º3ï¼Œæœ€å°å€¼ä¸º1ã€‚</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>ä¹‹å‰é”™è¯¯å‚è€ƒæ’æŸ¥ä»‹ç»</strong>: åœ¨ä¹‹å‰å®‰è£…jenkinsçš„æ—¶å€™ï¼Œåˆ›å»ºpodå°±ä¸€å€¼å¤„äº<code>running</code>,ä½†æ˜¯è¿‡ä¸€ä¼šï¼Œç•Œé¢å°±æŠ¥é”™ï¼Œé”™è¯¯å¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/15008WechatIMG.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç„¶åæŸ¥çœ‹podæ—¥å¿—å’Œç³»ç»Ÿç³»ç»Ÿï¼Œéƒ½æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œpodæ—¥å¿—å¦‚ä¸‹ï¼Œç„¶åå°±é—®äº†æœ‹å‹ï¼Œå°±è¯´æœ‰å¯èƒ½æ˜¯podçš„å¥åº·æ£€æµ‹æœºåˆ¶ï¼Œæœ€åå°±ä¿®æ”¹äº†podçš„å¥åº·æ£€æµ‹æœºåˆ¶ï¼ŒjenkinsæœåŠ¡å™¨éƒ¨ç½²okã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">log</span> $(kubectl get pods -n kube-ops | awk <span class="string">'&#123;print $1&#125;'</span> | grep jenkins) -n kube-ops</span><br><span class="line"><span class="built_in">log</span> is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use logs instead.</span><br><span class="line">VM settings:</span><br><span class="line">    Max. Heap Size: 3.00G</span><br><span class="line">    Ergonomics Machine Class: server</span><br><span class="line">    Using VM: OpenJDK 64-Bit Server VM</span><br><span class="line"></span><br><span class="line">Running from: /usr/share/jenkins/jenkins.war</span><br><span class="line">webroot: EnvVars.masterEnvVars.get(<span class="string">"JENKINS_HOME"</span>)</span><br><span class="line">2019-09-27 03:02:24.133+0000 [id=1] INFO org.eclipse.jetty.util.log.Log<span class="comment">#initialized: Logging initialized @429ms to org.eclipse.jetty.util.log.JavaUtilLog</span></span><br><span class="line">2019-09-27 03:02:24.247+0000 [id=1] INFO winstone.Logger<span class="comment">#logInternal: Beginning extraction from war file</span></span><br></pre></td></tr></table></figure><p><strong>åç»­</strong>: è™½ç„¶å¥åº·æ£€æµ‹å¯ä»¥å–æ¶ˆï¼Œä¸åŠ å…¥ï¼Œä½†æ˜¯å½“æˆ‘ä»¬åœ¨ä¸Šç”Ÿäº§ç¯å¢ƒçš„æ—¶å€™è¿˜æ˜¯è¦åŠ ä¸Šï¼Œæ­£å¦‚ä¾‹å››ä»‹ç»çš„é‚£æ ·ã€‚å¦‚æœæˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒé”™æ•…éšœè‡ªæ„ˆã€è½®è¯¢å‘å¸ƒç­‰ã€‚éƒ½éœ€è¦è¿™ä¸ªä¸œè¥¿ï¼ŒåŠ å…¥å†å‡çº§çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨éƒ½è¿˜æ²¡èµ·æ¥ï¼Œk8så°±å§æµé‡ç»™è°ƒåº¦è¿‡æ¥ï¼Œå‡çº§ä¸‹ä¸€ä¸ªpodï¼Œå¤–éƒ¨ç”¨æˆ·è®¿é—®å°±ä¼šæŠ¥é”™ï¼Œé‚£å°±æ˜¯å¾ˆå°´å°¬</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pod</tag>
      </tags>
  </entry>
  <entry>
    <title>EFK</title>
    <url>/2019/09/25/EFK/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡"><a href="#åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡" class="headerlink" title="åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡"></a>åˆå§‹åŒ–é…ç½®æ–‡ä»¶å‡†å¤‡</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚<code>kubernetes/cluster/addons/fluentd-elasticsearch</code>è¿™æ˜¯æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;es æ•°æ®é»˜è®¤çš„å­˜å‚¨åœ¨dockeré‡Œé¢ï¼Œåœ¨ç”¨çš„æ˜¯nodeèŠ‚ç‚¹çš„ç©ºé—´ï¼Œè€ŒnodeèŠ‚ç‚¹æˆ‘ä»¬ä¸å¯èƒ½éƒ½å‡†å¤‡å¾ˆå¤§çš„ç©ºé—´ï¼Œé‚£æ ·å¾ˆæµªè´¹èµ„æºï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å‡†å¤‡å¤–éƒ¨çš„nfså­˜å‚¨ç©ºé—´ï¼Œç„¶åé€šè¿‡<a href="https://xxlaila.github.io/2019/09/24/%E5%88%A9%E7%94%A8NFS%E5%8A%A8%E6%80%81%E6%8F%90%E4%BE%9BKubernetes%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8%E5%8D%B7/" target="_blank" rel="noopener">pv</a>çš„æ¨¡å¼è¿›è¡ŒæŒ‚è½½ï¼Œæ•°æ®å­˜å‚¨åˆ°nfsæœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·ä¿éšœäº†esæ”¶é›†æ•°æ®çš„å¯ç”¨æ€§ã€‚</p><a id="more"></a><h3 id="åˆ›å»ºå­˜å‚¨ä»‹è´¨"><a href="#åˆ›å»ºå­˜å‚¨ä»‹è´¨" class="headerlink" title="åˆ›å»ºå­˜å‚¨ä»‹è´¨"></a>åˆ›å»ºå­˜å‚¨ä»‹è´¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; pvc.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: es-nfs-data</span><br><span class="line">provisioner: fuseim.pri/ifs</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc.yaml</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><ul><li><p>es-statefulset.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># RBAC authn and authz</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - <span class="string">"services"</span></span><br><span class="line">  - <span class="string">"namespaces"</span></span><br><span class="line">  - <span class="string">"endpoints"</span></span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">"get"</span></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># Elasticsearch deployment itself</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    version: v6.6.1</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  serviceName: elasticsearch-logging</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: elasticsearch-logging</span><br><span class="line">      version: v6.6.1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: elasticsearch-logging</span><br><span class="line">        version: v6.6.1</span><br><span class="line">        kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: elasticsearch-logging</span><br><span class="line">      containers:</span><br><span class="line">      - image: elasticsearch:6.6.1</span><br><span class="line">        name: elasticsearch-logging</span><br><span class="line">        resources:</span><br><span class="line">          <span class="comment"># need more cpu upon initialization, therefore burstable class</span></span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9200</span><br><span class="line">          name: db</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9300</span><br><span class="line">          name: transport</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: elasticsearch-logging</span><br><span class="line">          mountPath: /data</span><br><span class="line">        env:</span><br><span class="line">        - name: <span class="string">"NAMESPACE"</span></span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">      <span class="comment"># Elasticsearch requires vm.max_map_count to be at least 262144.</span></span><br><span class="line">      <span class="comment"># If your OS already sets up this number to a higher value, feel free</span></span><br><span class="line">      <span class="comment"># to remove this init container.</span></span><br><span class="line">      initContainers:</span><br><span class="line">      - image: alpine:3.6</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">"/sbin/sysctl"</span>, <span class="string">"-w"</span>, <span class="string">"vm.max_map_count=262144"</span>]</span><br><span class="line">        name: elasticsearch-logging-init</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: <span class="literal">true</span></span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: elasticsearch-logging</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteMany"</span> ]</span><br><span class="line">      storageClassName: <span class="string">"es-nfs-data"</span></span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 30Gi</span><br></pre></td></tr></table></figure></li><li><p>fluentd-es-ds.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - <span class="string">"namespaces"</span></span><br><span class="line">  - <span class="string">"pods"</span></span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">"get"</span></span><br><span class="line">  - <span class="string">"watch"</span></span><br><span class="line">  - <span class="string">"list"</span></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  apiGroup: <span class="string">""</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es-v2.4.0</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    version: v2.4.0</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: fluentd-es</span><br><span class="line">      version: v2.4.0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: fluentd-es</span><br><span class="line">        kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">        version: v2.4.0</span><br><span class="line">      <span class="comment"># This annotation ensures that fluentd does not get evicted if the node</span></span><br><span class="line">      <span class="comment"># supports critical pod annotation based priority scheme.</span></span><br><span class="line">      <span class="comment"># Note that this does not guarantee admission on the nodes (#40573).</span></span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'docker/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-node-critical</span><br><span class="line">      serviceAccountName: fluentd-es</span><br><span class="line">      containers:</span><br><span class="line">      - name: fluentd-es</span><br><span class="line">        image: docker.io/xxlaila/fluentd-elasticsearch:v2.4.0</span><br><span class="line">        env:</span><br><span class="line">        - name: FLUENTD_ARGS</span><br><span class="line">          value: --no-supervisor -q</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: varlog</span><br><span class="line">          mountPath: /var/<span class="built_in">log</span></span><br><span class="line">        - name: varlibdockercontainers</span><br><span class="line">          mountPath: /var/lib/docker/containers</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/fluent/config.d</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: varlog</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/<span class="built_in">log</span></span><br><span class="line">      - name: varlibdockercontainers</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/lib/docker/containers</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: fluentd-es-config-v0.2.0</span><br></pre></td></tr></table></figure></li><li><p>kibana-deployment.yaml<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ³¨é‡Šé‡Œé¢çš„ä¸¤è¡Œé…ç½®,ä¸æ³¨é‡Šçš„è¯ï¼Œæ‰“å¼€kibanaçš„æ—¶å€™ä¼šæç¤º<code>kibana {&quot;statusCode&quot;:404,&quot;error&quot;:&quot;Not Found&quot;,&quot;message&quot;:&quot;Not Found&quot;}</code>,å‚è€ƒ<a href="https://github.com/kubernetes-sigs/kubespray/issues/3322" target="_blank" rel="noopener">è§£å†³æ–¹æ¡ˆ</a>,æ³¨é‡Šé…ç½®å¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- name: SERVER_BASEPATH</span><br><span class="line">  value: /api/v1/namespaces/kube-system/services/kibana-logging/proxy</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f ./</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹åˆ›å»º"><a href="#æŸ¥çœ‹åˆ›å»º" class="headerlink" title="æŸ¥çœ‹åˆ›å»º"></a>æŸ¥çœ‹åˆ›å»º</h4><ul><li><p>æŸ¥çœ‹pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system |egrep <span class="string">"kibana|elasticsearch|fluentd"</span></span><br><span class="line">elasticsearch-logging-0                       1/1     Running   0          65m</span><br><span class="line">elasticsearch-logging-1                       1/1     Running   0          61m</span><br><span class="line">fluentd-es-v2.4.0-4fp28                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-b7k67                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-f8jzp                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-shwzm                       1/1     Running   0          30m</span><br><span class="line">fluentd-es-v2.4.0-ww8r8                       1/1     Running   0          30m</span><br><span class="line">kibana-logging-57b55f58bc-xh5lp               1/1     Running   0          6m35s</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹service</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc -n kube-system |egrep <span class="string">"kibana|elasticsearch"</span></span><br><span class="line">elasticsearch-logging     ClusterIP   10.254.30.110    &lt;none&gt;        9200/TCP                 9s</span><br><span class="line">kibana-logging            ClusterIP   10.254.188.5     &lt;none&gt;        5601/TCP                 16h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹pvï¼Œpvc</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$  kubectl get pv,pvc -n kube-system</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                                       STORAGECLASS   REASON   AGE</span><br><span class="line">persistentvolume/pvc-65fdd14e-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            Delete           Bound    kube-system/elasticsearch-logging-elasticsearch-logging-0   es-nfs-data             21m</span><br><span class="line">persistentvolume/pvc-fe818f55-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            Delete           Bound    kube-system/elasticsearch-logging-elasticsearch-logging-1   es-nfs-data             16m</span><br><span class="line"></span><br><span class="line">NAME                                                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">persistentvolumeclaim/elasticsearch-logging-elasticsearch-logging-0   Bound    pvc-65fdd14e-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            es-nfs-data    21m</span><br><span class="line">persistentvolumeclaim/elasticsearch-logging-elasticsearch-logging-1   Bound    pvc-fe818f55-dffc-11e9-bc90-fa163e5af833   30Gi       RWX            es-nfs-data    17m</span><br></pre></td></tr></table></figure></li></ul><h3 id="åˆ›å»ºwebè®¿é—®"><a href="#åˆ›å»ºwebè®¿é—®" class="headerlink" title="åˆ›å»ºwebè®¿é—®"></a>åˆ›å»ºwebè®¿é—®</h3><ul><li><p>kibana-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; kibana-Ingress.yaml &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: kibana.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kibana-logging</span><br><span class="line">          servicePort: 5601</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>es-Ingress.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; es-Ingress &lt;&lt;EOF</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: es-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: es.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: elasticsearch-logging</span><br><span class="line">          servicePort: 9200</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f es-Ingress.yaml kibana-Ingress.yaml</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æµè§ˆå™¨è®¿é—®es<br><img src="https://img.xxlaila.cn/1569462606884.jpg" alt="img"></p></li><li><p>æµè§ˆå™¨è®¿é—®kibana<br><img src="https://img.xxlaila.cn/1569464839630.jpg" alt="img"><br>å»ºç«‹ç´¢å¼•ï¼Œé»˜è®¤çš„ç´¢å¼•æ˜¯æ ¹æ®å¤©æ¥è‡ªåŠ¨åˆ›å»ºåœ¨esé‡Œé¢ï¼Œè¿™é‡Œæˆ‘æ˜¯åœ¨kibanaé‡Œé¢æ˜¯æ ¹æ®æœˆæ¥å´åˆ†çš„<br><img src="https://img.xxlaila.cn/1569464950776.jpg" alt="img"></p></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>efk</tag>
      </tags>
  </entry>
  <entry>
    <title>ç½‘ç»œçŠ¶æ€ç›‘æ§</title>
    <url>/2019/09/25/%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›‘æ§IDCæœºæˆ¿ç½‘ç»œè´¨é‡æƒ…å†µï¼Œæœ¬åœ°åŒºåˆ°å…¶ä»–åœ°åŒºï¼Œå…¶ä»–åœ°åŒºåˆ°æœ¬èŠ‚ç‚¹ï¼Œæˆ–è€…å„çœå¸‚æ—¶é—´ç½‘ç»œã€è¿è¥å•†ç½‘ç»œçŠ¶æ€ï¼Œç›‘è§†ç½‘ç»œæ€§èƒ½ï¼ŒåŒ…æ‹¬å¸¸è§„çš„ pingï¼Œç”¨ fpingã€echopingã€tracert ç›‘è§† www æœåŠ¡å™¨æ€§èƒ½ï¼Œç›‘è§† dns æŸ¥è¯¢æ€§èƒ½ï¼Œç›‘è§† ssh æ€§èƒ½ç­‰ã€‚åº•å±‚ä¹Ÿæ˜¯ rrdtool åšæ”¯æŒï¼Œç‰¹ç‚¹æ˜¯ç”»çš„å›¾éå¸¸æ¼‚äº®ï¼Œç½‘ç»œä¸¢åŒ…å’Œå»¶è¿Ÿç”¨é¢œè‰²å’Œé˜´å½±æ¥è¡¨ç¤ºã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Smokepingã€‚æœ€æ–°ç‰ˆæœ¬çš„ Smokeping æ”¯æŒå¤šä¸ªèŠ‚ç‚¹çš„æ£€æµ‹ç»“æœä»ä¸€ä¸ªå›¾ä¸Šç”»å‡ºæ¥</p><a id="more"></a><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><h4 id="å®‰è£…yumæº"><a href="#å®‰è£…yumæº" class="headerlink" title="å®‰è£…yumæº"></a>å®‰è£…yumæº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm               </span></span><br><span class="line"><span class="comment"># rpm â€“Uvh http://mirrors.neusoft.edu.cn/epel/6/i386/epel-release-6-8.noarch.rpm</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ä¾èµ–åŒ…"><a href="#å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="å®‰è£…ä¾èµ–åŒ…"></a>å®‰è£…ä¾èµ–åŒ…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum â€“y install perl perl-Net-Telnet perl-Net-DNS perl-LDAP perl-libwww-perl perl-RadiusPerl perl-IO-Socket-SSL perl-Socket6 perl-CGI-SpeedyCGI perl-FCGI perl-CGI-SpeedCGI perl-Time-HiRes perl-ExtUtils-MakeMaker perl-RRD-Simple rrdtool rrdtool-perl curl fping echo</span></span><br><span class="line">ping  httpd httpd-devel gcc make  wget libxml2-devel libpng-devel glib pango pango-devel freetype freetype-devel fontconfig cairo cairo-devel libart_lgpl libart_lgpl-devel mod_fastcgi</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…smokeping"><a href="#å®‰è£…smokeping" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h3><h4 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget http://oss.oetiker.ch/smokeping/pub/smokeping-2.6.11.tar.gz è¿™é‡Œä¸‹è½½çš„æœ€æ–°ç‰ˆ</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…FCGI"><a href="#å®‰è£…FCGI" class="headerlink" title="å®‰è£…FCGI"></a>å®‰è£…FCGI</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf CGI-4.33.tar.gz</span></span><br><span class="line"><span class="comment"># cd CGI-4.33</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Config-Grammar"><a href="#å®‰è£…Config-Grammar" class="headerlink" title="å®‰è£…Config-Grammar"></a>å®‰è£…Config-Grammar</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Config-Grammar-1.10.tar.gz</span></span><br><span class="line"><span class="comment"># cd Config-Grammar-1.10</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ExtUtils-MakeMaker"><a href="#å®‰è£…ExtUtils-MakeMaker" class="headerlink" title="å®‰è£…ExtUtils-MakeMaker"></a>å®‰è£…ExtUtils-MakeMaker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf ExtUtils-MakeMaker-7.24.tar.gz</span></span><br><span class="line"><span class="comment"># cd ExtUtils-MakeMaker</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Simple"><a href="#å®‰è£…Simple" class="headerlink" title="å®‰è£…Simple"></a>å®‰è£…Simple</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Test-Simple-1.302056.tar.gz</span></span><br><span class="line"><span class="comment"># cd Test-Simple-1.302056</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">`</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-OpenSSH"><a href="#å®‰è£…Net-OpenSSH" class="headerlink" title="å®‰è£…Net-OpenSSH"></a>å®‰è£…Net-OpenSSH</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Net-OpenSSH-0.73.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-OpenSSH-0.73</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-SNMP"><a href="#å®‰è£…Net-SNMP" class="headerlink" title="å®‰è£…Net-SNMP"></a>å®‰è£…Net-SNMP</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar Net-SNMP-v6.0.1.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-SNMP-v6.0.1</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…perl-ldap"><a href="#å®‰è£…perl-ldap" class="headerlink" title="å®‰è£…perl-ldap"></a>å®‰è£…perl-ldap</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf perl-ldap-0.65.tar.gz</span></span><br><span class="line"><span class="comment"># cd perl-ldap-0.65</span></span><br><span class="line"><span class="comment"># ./install-nomake</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Net-DNS"><a href="#å®‰è£…Net-DNS" class="headerlink" title="å®‰è£…Net-DNS"></a>å®‰è£…Net-DNS</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf Net-DNS-1.06.tar.gz</span></span><br><span class="line"><span class="comment"># cd Net-DNS-1.06</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…IO-Tty"><a href="#å®‰è£…IO-Tty" class="headerlink" title="å®‰è£…IO-Tty"></a>å®‰è£…IO-Tty</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar IO-Tty-1.12.tar.gz</span></span><br><span class="line"><span class="comment"># cd IO-Tty-1.12</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…libwww-perl"><a href="#å®‰è£…libwww-perl" class="headerlink" title="å®‰è£…libwww-perl"></a>å®‰è£…libwww-perl</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf libwww-perl-6.15.tar.gz</span></span><br><span class="line"><span class="comment"># cd libwww-perl-6.15</span></span><br><span class="line"><span class="comment"># perl Makefile.PL</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…smokeping-1"><a href="#å®‰è£…smokeping-1" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf smokeping-2.6.11.tar.gz</span></span><br><span class="line"><span class="comment"># cd smokeping-2.6.11</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/smokeping</span></span><br><span class="line"><span class="comment"># /usr/bin/gmake install</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œé’ˆå¯¹ç½‘ç»œä¸èƒ½ç¿»å¢™ã€‚ä¹Ÿå¯ä»¥é‡‡å–smokepingä¸€é”®å®‰è£…çš„æ–¹å¼è¿›è¡Œå®‰è£…</p><h3 id="smokepingä¸€é”®å®‰è£…"><a href="#smokepingä¸€é”®å®‰è£…" class="headerlink" title="smokepingä¸€é”®å®‰è£…"></a>smokepingä¸€é”®å®‰è£…</h3><h4 id="å®‰è£…smokeping-2"><a href="#å®‰è£…smokeping-2" class="headerlink" title="å®‰è£…smokeping"></a>å®‰è£…smokeping</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar zxf smokeping-2.6.11.tar.gz</span></span><br><span class="line"><span class="comment"># cd smokeping-2.6.11</span></span><br><span class="line"><span class="comment"># ./setup/build-perl-modules.sh /usr/local/smokeping/thirdparty</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/smokeping</span></span><br><span class="line"><span class="comment"># /usr/bin/gmake install</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®smkeping"><a href="#é…ç½®smkeping" class="headerlink" title="é…ç½®smkeping"></a>é…ç½®smkeping</h3><h4 id="åˆ›å»ºcacheã€dataã€varç›®å½•"><a href="#åˆ›å»ºcacheã€dataã€varç›®å½•" class="headerlink" title="åˆ›å»ºcacheã€dataã€varç›®å½•"></a>åˆ›å»ºcacheã€dataã€varç›®å½•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/smokeping/</span></span><br><span class="line"><span class="comment"># mkdir &#123;cache,data,var&#125;</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ—¥å¿—æ–‡ä»¶"><a href="#åˆ›å»ºæ—¥å¿—æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæ—¥å¿—æ–‡ä»¶"></a>åˆ›å»ºæ—¥å¿—æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># touch /var/log/smokeping.log</span></span><br></pre></td></tr></table></figure><h4 id="èµ‹æƒé™"><a href="#èµ‹æƒé™" class="headerlink" title="èµ‹æƒé™"></a>èµ‹æƒé™</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chown apache:apache cache/ data/ var/</span></span><br><span class="line"><span class="comment"># chown  apache:apache /var/log/smokeping.log</span></span><br><span class="line"><span class="comment"># chmod 755 cache/ data/ var/    #è¿™é‡Œä¹Ÿè¦èµ‹æƒé™ï¼Œä¼šå½±å“å›¾ç‰‡æ— æ³•åŠ è½½</span></span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/local/smokeping/htdocs</span></span><br><span class="line"><span class="comment"># cp -arp smokeping.fcgi.dist smokeping.fcgi</span></span><br><span class="line"><span class="comment"># cd ../etc/</span></span><br><span class="line"><span class="comment"># cp -arp config.dist config</span></span><br><span class="line"><span class="comment"># chmod 600 /usr/local/smokeping/etc/smokeping_secrets.dist</span></span><br><span class="line"><span class="comment"># vim config</span></span><br><span class="line">*** General ***</span><br><span class="line">owner    = Peter Random</span><br><span class="line">contact  = some@address.nowhere</span><br><span class="line">mailhost = my.mail.host</span><br><span class="line">sendmail = /usr/sbin/sendmail</span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> do not put the Image Cache below cgi-bin</span></span><br><span class="line"><span class="comment"># since all files under cgi-bin will be executed ... this is not</span></span><br><span class="line"><span class="comment"># good for images.</span></span><br><span class="line">imgcache = /usr/<span class="built_in">local</span>/smokeping/cache</span><br><span class="line">imgurl   = http://172.16.1.100/cache                                                      <span class="comment">#è¿™é‡Œå¦‚æœä¸é…ç½®æ­£ç¡®ï¼Œä¼šå½±å“åé¢å‡ºå›¾ï¼Œè¿™é‡Œä¸€ä¸ªå‘</span></span><br><span class="line">datadir  = /usr/<span class="built_in">local</span>/smokeping/data</span><br><span class="line">piddir  = /usr/<span class="built_in">local</span>/smokeping/var</span><br><span class="line">cgiurl   = http://172.16.1.100/smokeping/smokeping.cgi</span><br><span class="line"><span class="comment">#cgiurl   = http://some.url/smokeping.cgi</span></span><br><span class="line">smokemail = /usr/<span class="built_in">local</span>/smokeping/etc/smokemail.dist</span><br><span class="line">tmail = /usr/<span class="built_in">local</span>/smokeping/etc/tmail.dist</span><br><span class="line"><span class="comment"># specify this to get syslog logging</span></span><br><span class="line">syslogfacility = local0</span><br><span class="line"><span class="comment"># each probe is now run in its own process</span></span><br><span class="line"><span class="comment"># disable this to revert to the old behaviour</span></span><br><span class="line"><span class="comment"># concurrentprobes = no</span></span><br><span class="line">*** Alerts ***</span><br><span class="line">to = alertee@address.somewhere</span><br><span class="line">from = smokealert@company.xy</span><br><span class="line">+someloss</span><br><span class="line"><span class="built_in">type</span> = loss</span><br><span class="line"><span class="comment"># in percent</span></span><br><span class="line">pattern = &gt;0%,*12*,&gt;0%,*12*,&gt;0%</span><br><span class="line">comment = loss 3 <span class="built_in">times</span>  <span class="keyword">in</span> a row</span><br><span class="line">*** Database ***</span><br><span class="line">step     = 60                                              <span class="comment">#æ£€æµ‹æ—¶é—´ï¼Œé»˜è®¤300</span></span><br><span class="line">pings    = 20</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸Šè¿°ä¿®æ”¹å¸¦æœ‰æ³¨è§†éƒ¨åˆ†ï¼Œå…¶ä»–å‚æ•°å‚è€ƒå®˜æ–¹ï¼Œè€Œä¸”éƒ½èƒ½çœ‹æ‡‚ã€‚åé¢æœ‰å¾ˆå¤šé…ç½®ä¸å…¨éƒ¨è´´å‡ºæ¥</p><h3 id="é…ç½®apache"><a href="#é…ç½®apache" class="headerlink" title="é…ç½®apache"></a>é…ç½®apache</h3><h4 id="é…ç½®httpd-conf"><a href="#é…ç½®httpd-conf" class="headerlink" title="é…ç½®httpd.conf"></a>é…ç½®httpd.conf</h4><p>åœ¨DocumentRoot â€œ/var/www/htmlâ€è¿™è¡Œå¢åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">Alias /cache <span class="string">"/usr/local/smokeping/cache"</span></span><br><span class="line">Alias /cropper <span class="string">"/usr/local/smokeping/htdocs/cropper"</span></span><br><span class="line">Alias /smokeping <span class="string">"/usr/local/smokeping/htdocs/smokeping.fcgi"</span></span><br><span class="line">&lt;Directory <span class="string">"/usr/local/smokeping"</span>&gt;</span><br><span class="line">        AllowOverride None</span><br><span class="line">        Options All</span><br><span class="line">        AddHandler cgi-script .fcgi .cgi</span><br><span class="line">        Order allow,deny</span><br><span class="line">        Allow from all</span><br><span class="line">        AuthName <span class="string">"Smokeping"</span></span><br><span class="line">        AuthType Basic</span><br><span class="line">        AuthUserFile /usr/<span class="built_in">local</span>/smokeping/htdocs/htpasswd</span><br><span class="line">        Require valid-user</span><br><span class="line">        DirectoryIndex smokeping.fcgi</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure><h4 id="apacheç™»å½•è®¤è¯"><a href="#apacheç™»å½•è®¤è¯" class="headerlink" title="apacheç™»å½•è®¤è¯"></a>apacheç™»å½•è®¤è¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/local/smokeping/htdocs</span></span><br><span class="line"><span class="comment"># htpasswd -c /usr/local/smokeping/htdocs/htpasswd admin                   #å›è½¦è®¾ç½®adminè´¦æˆ·çš„å¯†ç </span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“"><a href="#å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“" class="headerlink" title="å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“"></a>å®‰è£…ç½‘é¡µæ”¯æŒçš„ä¸­æ–‡å­—ä½“</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install wqy-zenhei-fonts.noarch</span></span><br></pre></td></tr></table></figure><h4 id="smokepingå¼€æœºè„šæœ¬"><a href="#smokepingå¼€æœºè„šæœ¬" class="headerlink" title="smokepingå¼€æœºè„šæœ¬"></a>smokepingå¼€æœºè„šæœ¬</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/init.d/smokeping</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">PIDFILE=/usr/<span class="built_in">local</span>/smokeping/var/smokeping.pid</span><br><span class="line">SMOKEPING=/usr/<span class="built_in">local</span>/smokeping/bin/smokeping</span><br><span class="line">ERROR=0</span><br><span class="line">RUNNING=0</span><br><span class="line">ARGV=<span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x<span class="variable">$ARGV</span>"</span> = <span class="string">"x"</span> ] ; <span class="keyword">then</span></span><br><span class="line">ARGS=<span class="built_in">help</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">for</span> ARG <span class="keyword">in</span> <span class="variable">$@</span> <span class="variable">$ARGS</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$PIDFILE</span> ] ; <span class="keyword">then</span></span><br><span class="line">PID=`cat <span class="variable">$PIDFILE</span>`</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> -0 <span class="variable">$PID</span> 2&gt;/dev/null ; <span class="keyword">then</span></span><br><span class="line"><span class="comment"># smokeping is running</span></span><br><span class="line">RUNNING=1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># smokeping not running but PID file exists =&gt; delete PID file</span></span><br><span class="line">rm -f <span class="variable">$PIDFILE</span></span><br><span class="line">RUNNING=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># smokeping (no pid file) not running</span></span><br><span class="line">RUNNING=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$ARG</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 0 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$SMOKEPING</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping started"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be started"</span></span><br><span class="line">ERROR=1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is running with PID <span class="variable">$PID</span>"</span></span><br><span class="line">ERROR=2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> <span class="variable">$PID</span> ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping (<span class="variable">$PID</span>) stopped"</span></span><br><span class="line">rm <span class="variable">$PIDFILE</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be stopped"</span></span><br><span class="line">ERROR=3</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping not running"</span></span><br><span class="line">ERROR=4</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$SMOKEPING</span> --restart &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping restarted"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping could not be started"</span></span><br><span class="line">ERROR=5</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="variable">$0</span> start</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">strace_debug)</span><br><span class="line">rm -f /tmp/strace_smokeping</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> strace -o/tmp/strace_smokeping <span class="variable">$SMOKEPING</span> --restart &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping restarted with strace debug in /tmp/strace_smokeping"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping strace debug could not be started"</span></span><br><span class="line">ERROR=6</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">if</span> strace -o/tmp/strace_smokeping <span class="variable">$SMOKEPING</span> &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping started with strace debug in /tmp/strace_smokeping"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping strace debug could not be started"</span></span><br><span class="line">ERROR=7</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$RUNNING</span> -eq 1 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is running with PID (<span class="variable">$PID</span>)"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> <span class="variable">$ARG</span>: smokeping is not running"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$0</span> (start|stop|restart|status|strace_debug|help)"</span></span><br><span class="line">cat</span><br><span class="line">start - start smokeping</span><br><span class="line">stop - stop smokeping</span><br><span class="line">restart - restart smokeping <span class="keyword">if</span> running or start <span class="keyword">if</span> not running</span><br><span class="line">status - show status <span class="keyword">if</span> smokeping is running or not</span><br><span class="line"><span class="built_in">help</span> - this screen</span><br><span class="line">EOF</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$ERROR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod +x /etc/init.d/smokeping</span></span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service httpd start</span></span><br><span class="line"><span class="comment"># /etc/init.d/smokeping start</span></span><br></pre></td></tr></table></figure><p>æ‰“å¼€æµè§ˆå™¨æµ‹è¯•http://{ip}/smokeping ä¼šæç¤ºè¾“å…¥ç”¨æˆ·å’Œå¯†ç <br><img src="https://img.xxlaila.cn/74D2C8DE-129F-4219-87C5-D6A771D19484.png" alt="img"><br><img src="https://img.xxlaila.cn/91D9FA70-65B1-4752-8F15-68A158E72A49.png" alt="img"></p><h4 id="é…ç½®æ–‡ä»¶æ·»åŠ "><a href="#é…ç½®æ–‡ä»¶æ·»åŠ " class="headerlink" title="é…ç½®æ–‡ä»¶æ·»åŠ "></a>é…ç½®æ–‡ä»¶æ·»åŠ </h4><p>é…ç½®æ–‡ä»¶æ·»ä»‹ç»ï¼Œåœ¨é…ç½®æ–‡ä»¶é‡Œé¢+è¡¨ç¤ºä¸€çº§++è¡¨ç¤ºäºŒçº§+++ä¸‰çº§<br>æœ¬æ¬¡æ·»åŠ çš„å†…å®¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">+ Other</span><br><span class="line">menu = å…¶ä»–ç½‘ç»œç›‘æ§</span><br><span class="line">title = å…¶ä»–æ‰€æœ‰ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">++ dianxin</span><br><span class="line">menu = ç”µä¿¡ç½‘ç»œç›‘æ§</span><br><span class="line">title = ç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/dianxin/dianxin-hlj /Other/dianxin/dianxin-gd /Other/dianxin/dianxin-gs /Other/dianxin/dianxin-sh /Other/dianxin/dianxin-sc /Other/dianxin/dianxin-cq /Other/dianxin/dianxin-gz /Other/dianxin/dianxin-ln /Other/dianxin/dianxin-zj /Other/dianxin/dianxin-sd /Other/dianxin/dianxin-hib /Other/dianxin/dianxin-ah /Other/dianxin/dianxin-hb /Other/dianxin/dianxin-jl /Other/dianxin/dianxin-jx</span><br><span class="line">+++ dianxin-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿç”µä¿¡</span><br><span class="line">title = é»‘é¾™æ±Ÿç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 219.150.32.132</span><br><span class="line">+++ dianxin-gd</span><br><span class="line">menu = å¹¿ä¸œç”µä¿¡</span><br><span class="line">title = å¹¿ä¸œç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.96.134.133</span><br><span class="line">+++ dianxin-gs</span><br><span class="line">menu = ç”˜è‚ƒç”µä¿¡</span><br><span class="line">title = ç”˜è‚ƒç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.100.64.68</span><br><span class="line">+++ dianxin-sh</span><br><span class="line">menu = ä¸Šæµ·ç”µä¿¡</span><br><span class="line">title = ä¸Šæµ·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.96.209.5</span><br><span class="line">+++ dianxin-sc</span><br><span class="line">menu = å››å·ç”µä¿¡</span><br><span class="line">title = å››å·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.6.145.111</span><br><span class="line">+++ dianxin-cq</span><br><span class="line">menu = é‡åº†ç”µä¿¡</span><br><span class="line">title = é‡åº†ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 61.128.128.68</span><br><span class="line">+++ dianxin-gz</span><br><span class="line">menu = è´µå·ç”µä¿¡</span><br><span class="line">title = è´µå·ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.98.192.68</span><br><span class="line">+++ dianxin-ln</span><br><span class="line">menu = è¾½å®ç”µä¿¡</span><br><span class="line">title = è¾½å®ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 219.149.6.99</span><br><span class="line">+++ dianxin-zj</span><br><span class="line">menu = æµ™æ±Ÿç”µä¿¡</span><br><span class="line">title = æµ™æ±Ÿç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.96.96.68</span><br><span class="line">+++ dianxin-sd</span><br><span class="line">menu = å±±ä¸œç”µä¿¡</span><br><span class="line">title = å±±ä¸œç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 222.173.95.53</span><br><span class="line">+++ dianxin-hib</span><br><span class="line">menu = æ¹–åŒ—ç”µä¿¡</span><br><span class="line">title = æ¹–åŒ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.103.0.68</span><br><span class="line">+++ dianxin-ah</span><br><span class="line">menu = å®‰å¾½ç”µä¿¡</span><br><span class="line">title = å®‰å¾½ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 220.178.75.134</span><br><span class="line">+++ dianxin-hb</span><br><span class="line">menu = æ²³åŒ—ç”µä¿¡</span><br><span class="line">title = æ²³åŒ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.99.160.68</span><br><span class="line">+++ dianxin-jl</span><br><span class="line">menu = å‰æ—ç”µä¿¡</span><br><span class="line">title = å‰æ—ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host =  219.149.194.55</span><br><span class="line">+++ dianxin-jx</span><br><span class="line">menu = æ±Ÿè¥¿ç”µä¿¡</span><br><span class="line">title = æ±Ÿè¥¿ç”µä¿¡</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.101.224.68</span><br><span class="line"><span class="comment">#+++ dianxin-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªç”µä¿¡ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/dianxin/dianxin-hlj /Other/dianxin/dianxin-gd /Other/dianxin/dianxin-gs /Other/dianxin/dianxin-sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">++ liantong</span><br><span class="line">menu = è”é€šç½‘ç»œç›‘æ§</span><br><span class="line">title = è”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/liantong/liantong-hlj /Other/liantong/liantong-gd /Other/liantong/liantong-gs /Other/liantong/liantong-sh /Other/liantong/liantong-sc /Other/liantong/liantong-cq /Other/liantong/liantong-gz /Other/liantong/liantong-ln /Other/liantong/liantong-zj /Other/liantong/liantong-sd /Other/liantong/liantong-hib /Other/liantong/liantong-ah /Other/liantong/liantong-hb /Other/liantong/liantong-jl /Other/liantong/liantong-jx</span><br><span class="line">+++ liantong-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿè”é€š</span><br><span class="line">title = é»‘é¾™æ±Ÿè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.97.224.68</span><br><span class="line">+++ liantong-gd</span><br><span class="line">menu = å¹¿ä¸œè”é€š</span><br><span class="line">title = å¹¿ä¸œè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 221.4.66.66</span><br><span class="line">+++ liantong-gs</span><br><span class="line">menu = ç”˜è‚ƒè”é€š</span><br><span class="line">title = ç”˜è‚ƒè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 221.7.34.10</span><br><span class="line">+++ liantong-sh</span><br><span class="line">menu = ä¸Šæµ·è”é€š</span><br><span class="line">title = ä¸Šæµ·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 210.22.70.3</span><br><span class="line">+++ liantong-sc</span><br><span class="line">menu = å››å·è”é€š</span><br><span class="line">title = å››å·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 119.6.6.6</span><br><span class="line">+++ liantong-cq</span><br><span class="line">menu = é‡åº†è”é€š</span><br><span class="line">title = é‡åº†è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.7.92.98</span><br><span class="line">+++ liantong-gz</span><br><span class="line">menu = è´µå·è”é€š</span><br><span class="line">title = è´µå·è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.13.30.242</span><br><span class="line">+++ liantong-ln</span><br><span class="line">menu = è¾½å®è”é€š</span><br><span class="line">title = è¾½å®è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 124.161.97.234</span><br><span class="line">+++ liantong-zj</span><br><span class="line">menu = æµ™æ±Ÿè”é€š</span><br><span class="line">title = æµ™æ±Ÿè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 221.12.33.227</span><br><span class="line">+++ liantong-sd</span><br><span class="line">menu = å±±ä¸œè”é€š</span><br><span class="line">title = å±±ä¸œè”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.102.152.3</span><br><span class="line">+++ liantong-hib</span><br><span class="line">menu = æ¹–åŒ—è”é€š</span><br><span class="line">title = æ¹–åŒ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.104.111.114</span><br><span class="line">+++ liantong-ah</span><br><span class="line">menu = å®‰å¾½è”é€š</span><br><span class="line">title = å®‰å¾½è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.91.88.129</span><br><span class="line">+++ liantong-hb</span><br><span class="line">menu = æ²³åŒ—è”é€š</span><br><span class="line">title = æ²³åŒ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.99.160.68</span><br><span class="line">+++ liantong-jl</span><br><span class="line">menu = å‰æ—è”é€š</span><br><span class="line">title = å‰æ—è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 202.98.5.6</span><br><span class="line">+++ liantong-jx</span><br><span class="line">menu = æ±Ÿè¥¿è”é€š</span><br><span class="line">title = æ±Ÿè¥¿è”é€š</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 220.248.192.12</span><br><span class="line"><span class="comment">#+++ liantong-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªè”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªè”é€šç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/liantong/liantong-hlj /Other/liantong/liantong-gd /Other/liantong/liantong-gs /Other/liantong/liantong-sh</span></span><br><span class="line">++ yidong</span><br><span class="line">menu = ç§»åŠ¨ç½‘ç»œç›‘æ§</span><br><span class="line">title = ç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/yidong/yidong-hlj /Other/yidong/yidong-gd /Other/yidong/yidong-gs /Other/yidong/yidong-sh /Other/yidong/yidong-sc /Other/yidong/yidong-cq /Other/yidong/yidong-gz /Other/yidong/yidong-ln /Other/yidong/yidong-zj /Other/yidong/yidong-sd /Other/yidong/yidong-hib /Other/yidong/yidong-ah /Other/yidong/yidong-hb</span><br><span class="line">+++ yidong-hlj</span><br><span class="line">menu = é»‘é¾™æ±Ÿç§»åŠ¨</span><br><span class="line">title = é»‘é¾™æ±Ÿç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 211.137.241.34</span><br><span class="line">+++ yidong-gd</span><br><span class="line">menu = å¹¿ä¸œç§»åŠ¨</span><br><span class="line">title = å¹¿ä¸œç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 211.137.241.34</span><br><span class="line">+++ yidong-gs</span><br><span class="line">menu = ç”˜è‚ƒç§»åŠ¨</span><br><span class="line">title = ç”˜è‚ƒç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 218.203.160.194</span><br><span class="line">+++ yidong-sh</span><br><span class="line">menu = ä¸Šæµ·ç§»åŠ¨</span><br><span class="line">title = ä¸Šæµ·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 117.131.0.22</span><br><span class="line">+++ yidong-sc</span><br><span class="line">menu = å››å·ç§»åŠ¨</span><br><span class="line">title = å››å·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.96.205</span><br><span class="line">+++ yidong-cq</span><br><span class="line">menu = é‡åº†ç§»åŠ¨</span><br><span class="line">title = é‡åº†ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.201.4.3</span><br><span class="line">+++ yidong-gz</span><br><span class="line">menu = è´µå·ç§»åŠ¨</span><br><span class="line">title = è´µå·ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.139.1.3</span><br><span class="line">+++ yidong-ln</span><br><span class="line">menu = è¾½å®ç§»åŠ¨</span><br><span class="line">title = è¾½å®ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 218.59.181.182</span><br><span class="line">+++ yidong-zj</span><br><span class="line">menu = æµ™æ±Ÿç§»åŠ¨</span><br><span class="line">title = æµ™æ±Ÿç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.140.10.2</span><br><span class="line">+++ yidong-sd</span><br><span class="line">menu = å±±ä¸œç§»åŠ¨</span><br><span class="line">title = å±±ä¸œç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.191.26</span><br><span class="line">+++ yidong-hib</span><br><span class="line">menu = æ¹–åŒ—ç§»åŠ¨</span><br><span class="line">title = æ¹–åŒ—ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.137.76.68</span><br><span class="line">+++ yidong-ah</span><br><span class="line">menu = å®‰å¾½ç§»åŠ¨</span><br><span class="line">title = å®‰å¾½ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.138.180.2</span><br><span class="line">+++ yidong-hb</span><br><span class="line">menu = æ²³åŒ—ç§»åŠ¨</span><br><span class="line">title = æ²³åŒ—ç§»åŠ¨</span><br><span class="line">alerts = someloss</span><br><span class="line">host = 211.98.2.4</span><br><span class="line"><span class="comment">#+++ yidong-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªç§»åŠ¨ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/yidong/yidong-hlj /Other/yidong/yidong-gd /Other/yidong/yidong-gs /Other/yidong/yidong-sh</span></span><br><span class="line">++ jiaoyu</span><br><span class="line">menu = æ•™è‚²ç½‘ç»œç›‘æ§</span><br><span class="line">title = æ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span><br><span class="line">host = /Other/jiaoyu/jiaoyu-qh /Other/jiaoyu/jiaoyu-sh /Other/jiaoyu/jiaoyu-wh /Other/jiaoyu/jiaoyu-hn</span><br><span class="line">+++ jiaoyu-qh</span><br><span class="line">menu = æ¸…åå¤§å­¦</span><br><span class="line">title = æ¸…åå¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 166.111.8.28</span><br><span class="line">+++ jiaoyu-sh</span><br><span class="line">menu = ä¸Šæµ·äº¤å¤§</span><br><span class="line">title = ä¸Šæµ·äº¤å¤§</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.112.26.34</span><br><span class="line">+++ jiaoyu-wh</span><br><span class="line">menu = æ­¦æ±‰ç§‘æŠ€å¤§å­¦</span><br><span class="line">title = æ­¦æ±‰ç§‘æŠ€å¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.114.240.6</span><br><span class="line">+++ jiaoyu-hn</span><br><span class="line">menu = åå—å†œä¸šå¤§å­¦</span><br><span class="line">title = åå—å†œä¸šå¤§å­¦</span><br><span class="line">alerts = someloss</span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line">host = 202.116.160.33</span><br><span class="line"><span class="comment">#+++ jiaoyu-multi</span></span><br><span class="line"><span class="comment">#menu = å¤šä¸ªæ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#title = å¤šä¸ªæ•™è‚²ç½‘ç»œç›‘æ§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#alerts = someloss</span></span><br><span class="line"><span class="comment">#slaves = boomer slave2</span></span><br><span class="line"><span class="comment">#host = /Other/jiaoyu/jiaoyu-qh /Other/jiaoyu/jiaoyu-sh /Other/jiaoyu/jiaoyu-wh /Other/jiaoyu/jiaoyu-hn</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Smokeping</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux å¸¸ç”¨å‘½ä»¤å­¦ä¹ </title>
    <url>/2019/09/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h4 id="æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤"><a href="#æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤" class="headerlink" title="æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤"></a>æŸ¥æ‰¾æ–‡ä»¶ä½¿ç”¨å‘½ä»¤</h4><ul><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹é¢å¤§å°è¶…è¿‡5Mçš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ -size +5M</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹100å¤©ä¹‹å‰ä¿®æ”¹è¿‡çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ -mtime +100</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹60å¤©æœªè¢«è®¿é—®è¿‡çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /home/ \! atime -60</span><br></pre></td></tr></table></figure></li></ul><a id="more"></a><ul><li>æŸ¥æ‰¾ç›®å½•ä¸‹é¢æ–‡ä»¶â€œcoreâ€œï¼Œå¦‚æœå‘ç°æ— éœ€æç¤ºç›´æ¥åˆ é™¤ã€‚<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find / -name core -<span class="built_in">exec</span> rm &#123;&#125; \</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾æ’é™¤æŸä¸€ä¸ªæ–‡ä»¶ç„¶åè¿›è¡Œåˆ é™¤</span></span><br><span class="line">$ find / -<span class="built_in">type</span> f ! -name <span class="string">"test"</span> -<span class="built_in">exec</span> rm &#123;&#125; \;</span><br><span class="line">$ find ./ -mtime +3 -name <span class="string">"*.log"</span> -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br><span class="line">$ find /tmp -mtime +30 -<span class="built_in">type</span> f -name <span class="string">"*.sh[ab]"</span> -<span class="built_in">exec</span> rm -f &#123;&#125; \;</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨ä¸€ä¸ªç›®å½•ä¸­ä¿ç•™æœ€è¿‘30å¤©çš„æ–‡ä»¶ï¼Œ30å¤©å‰çš„æ–‡ä»¶è‡ªåŠ¨åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /tmp -mtime +30 -<span class="built_in">type</span> f -name <span class="string">"*.sh[ab]"</span> -<span class="built_in">exec</span> rm -f &#123;&#125; \;</span><br></pre></td></tr></table></figure><ul><li>/tmp â€“è®¾ç½®æŸ¥æ‰¾çš„ç›®å½•ï¼›</li><li>-mtime +30 â€“è®¾ç½®æ—¶é—´ä¸º30å¤©å‰ï¼›</li><li>-type f â€“è®¾ç½®æŸ¥æ‰¾çš„ç±»å‹ä¸ºæ–‡ä»¶ï¼›</li><li>-name *.sh[ab] â€“è®¾ç½®æ–‡ä»¶åç§°ä¸­åŒ…å«shaæˆ–è€…shbï¼›</li><li>-exec rm -f â€“æŸ¥æ‰¾å®Œæ¯•åæ‰§è¡Œåˆ é™¤æ“ä½œï¼›</li><li><strong>æç¤º</strong>ï¼šå°†æ­¤å‘½ä»¤å†™å…¥crontabåå³å¯è‡ªåŠ¨å®ŒæˆæŸ¥æ‰¾å¹¶åˆ é™¤çš„å·¥ä½œ</li></ul><ul><li>æ˜¾ç¤ºç›®å½•æ–‡ä»¶çš„æ–‡ä»¶åå’Œå®ƒä»¬çš„æ‹¥æœ‰è€…<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ll | awk <span class="string">'&#123;print $3,"owns",$9&#125;'</span></span><br></pre></td></tr></table></figure></li></ul><p>æ˜¾ç¤ºä½ çš„ç³»ç»Ÿä¸ŠPCIæ€»çº¿å’Œé™„åŠ è®¾å¤‡çš„ä¿¡æ¯ã€‚æŒ‡å®š-vï¼Œ-vvæˆ–-vvvæ¥è·å–è¶Šæ¥è¶Šè¯¦ç»†çš„è¾“å‡º</p><ul><li><p>lspci å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum whatprovides */lspci</span><br><span class="line">pciutils-3.5.1-2.el7.x86_64 : PCI bus related utilities</span><br><span class="line">Repo        : base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /usr/sbin/lspci</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pciutils-3.5.1-3.el7.x86_64 : PCI bus related utilities</span><br><span class="line">Repo        : base</span><br><span class="line">Matched from:</span><br><span class="line">Filename    : /usr/sbin/lspci</span><br><span class="line"></span><br><span class="line">$ sudo yum install pciutils</span><br><span class="line"></span><br><span class="line">lspci æ›´å¤š[è¯¦ç»†ä½¿ç”¨](https://blog.csdn.net/styshoo/article/details/51281437)</span><br><span class="line"></span><br><span class="line">$ lspci -vvvvv</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å½“å‰çš„LinuxæœåŠ¡å™¨çš„è¿è¡Œçº§åˆ«</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ who -r</span><br><span class="line">$ who -b </span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿæœ€åä¸€æ¬¡å¯åŠ¨çš„æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">$ last reboot</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿå†å²å¯åŠ¨çš„æ—¶é—´</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿè¿è¡Œäº†å¤šé•¿æ—¶é—´</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /proc/uptime| awk -F. <span class="string">'&#123;run_days=$1 / 86400;run_hour=($1 % 86400)/3600;run_minute=($1 % 3600)/60;run_second=$1 % 60;printf("ç³»ç»Ÿå·²è¿è¡Œï¼š%då¤©%dæ—¶%dåˆ†%dç§’",run_days,run_hour,run_minute,run_second)&#125;'</span></span><br><span class="line">$ w</span><br><span class="line">$ uptime</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿå¯åŠ¨çš„æ—¥æœŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ date -d <span class="string">"<span class="variable">$(awk -F. '&#123;print $1&#125;' /proc/uptime)</span> second ago"</span> +<span class="string">"%Y-%m-%d %H:%M:%S"</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶å†…å®¹æ²¡æœ‰åŒ…æ‹¬â€œnginxâ€ã€â€œmsgTypeâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep -r -l -v <span class="string">"nginx"</span> /data/</span><br><span class="line">$ grep -r  -v <span class="string">"msgType"</span> /data/</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶å†…å®¹åŒ…æ‹¬â€nginxâ€å­—ç¬¦ä¸²çš„æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep -r <span class="string">"nginx"</span> /data/                                             ä¼šæŠŠ<span class="string">"nginx"</span>å­—ç¬¦ä¸²æ‰€åœ¨è¿™è¡Œçš„å†…å®¹æ˜¾ç¤ºå‡ºæ¥</span><br><span class="line">$ grep -o â€œnginxâ€ /data/</span><br><span class="line">$ grep -r -l <span class="string">"nginx"</span> /data/                                          ä¸æ˜¾ç¤º<span class="string">"nginx"</span>å­—ç¬¦ä¸²æ‰€åœ¨è¡Œï¼Œæ˜¯æ˜¾ç¤ºæ–‡ä»¶</span><br></pre></td></tr></table></figure></li><li><p>catä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat sentry.conf.py |grep -v <span class="string">"^#"</span>          æŸ¥çœ‹é…ç½®æ–‡ä»¶ä¸åŒ…æ‹¬æ³¨é‡Šå†…å®¹</span><br><span class="line">$ cat -b `find /var/<span class="built_in">log</span>/httpd/ -cmin -60 -<span class="built_in">print</span> |sed <span class="string">"1d"</span>`\ |awk <span class="string">'&#123;print $2&#125;'</span>|sort |uniq -c |sort -n -k 1 -r |head -n 1               ç»Ÿè®¡å½“å‰ç›®å½•ä¸‹æ—¥å¿—æ–‡ä»¶é‡Œé¢Iå¹³è®¿é—®é‡æœ€å¤šçš„ä¸€ä¸ªIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŸä¸€ä¸ªæ—¶é—´æ®µçš„IPåœ°å€è®¿é—®æ’åå‰10</span></span><br><span class="line">$ cat nginx_access.log|grep <span class="string">'+0800'</span>|awk <span class="string">'&#123;split($1,array,"[");if(array[2]&gt;="25/Jul/2017:14:17:30" &amp;&amp; array[2]&lt;="25/Jul/2017:20:17:30")&#123;print $0&#125;&#125;'</span>|awk -F<span class="string">"^`"</span> &amp;&amp; <span class="string">"-"</span> &amp;&amp; <span class="string">"^`"</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å½“å‰æ—¥å¿—ipè®¿é—®å‰10</span></span><br><span class="line">$ cat nginx_access.log |awk -F<span class="string">"^"</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br></pre></td></tr></table></figure></li><li><p>è·å–IPåœ°å€é€šç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig |sed -n 2p |awk <span class="string">'&#123;print $1$2&#125;'</span>|sed <span class="string">'s/^.*[^0-9]\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)\.\([0-9]\&#123;1,3\&#125;\)$/\1\.\2\.\3\.\4/g'</span></span><br></pre></td></tr></table></figure></li><li><p>curlä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›‘æ§ç½‘é¡µçš„å“åº”æ—¶é—´</span></span><br><span class="line">$ curl -o /dev/null -s -w <span class="string">"time_connect: %&#123;time_connect&#125;\ntime_starttransfer: %&#123;time_starttransfer&#125;\ntime_total: %&#123;time_total&#125;\n"</span> <span class="string">"http://www.baidu.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›‘æ§ç«™ç‚¹å¯ç”¨æ€§</span></span><br><span class="line">$ curl -o /dev/null -s -w %&#123;http_code&#125; <span class="string">"http://www.baidu.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯gzipè¯·æ±‚</span></span><br><span class="line">$ curl -I http://www.sina.com.cn/ -H Accept-Encoding:gzip,defalte</span><br></pre></td></tr></table></figure></li><li><p>æ¯10ç§’æ˜¾ç¤ºä¸€æ¬¡å¤åˆ¶çš„å¤§å°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ watch -n 10 du -sh /root</span><br></pre></td></tr></table></figure></li><li><p>ç»Ÿè®¡ç›®å½•(åŒ…æ‹¬å­ç›®å½•)ä¸‹é¢æ–‡ä»¶ä¸ªæ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find ./ -<span class="built_in">type</span> f | wc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨findå‘½ä»¤æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ˜¯æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶ï¼Œç„¶åç”¨wcæ¥è®¡æ•°</span></span><br><span class="line">$ ls -lR|grep <span class="string">"^-"</span>|wc -l</span><br><span class="line"><span class="comment"># lså‘½ä»¤åŠ Rå‚æ•°ï¼Œåˆ—å‡ºä¸‹çº§å­ç›®å½•ï¼Œä½¿ç”¨grepå‘½ä»¤è¿‡æ»¤ä»¥â€œ-â€å¼€å¤´çš„ï¼Œå¦‚æœæ˜¯ç›®å½•å°±æ”¹æˆâ€œ^dâ€ï¼Œåé¢ç”¨wcè®¡æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line">$ find ./ -name <span class="string">"*.*"</span> |xargs cat|grep -v ^$|wc -l</span><br><span class="line">$ find . \( ! -name <span class="string">'*.png'</span> ! -name <span class="string">'*.gif'</span> ! -name <span class="string">'*.jpg'</span> ! -name <span class="string">'*.swf'</span> \) -<span class="built_in">type</span> f |wc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„çš„è¡Œæ•°ï¼Œå»æ‰ç©ºè¡Œ</span></span><br><span class="line">$ find ./ -name <span class="string">"*.*"</span> |xargs cat|wc -l   </span><br><span class="line">$ find . \( ! -name <span class="string">'*.png'</span> ! -name <span class="string">'*.gif'</span> ! -name <span class="string">'*.jpg'</span> ! -name <span class="string">'*.swf'</span> \) -<span class="built_in">type</span> f |xargs cat|wc -l</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç³»ç»Ÿtcpè¿æ¥ä¸­å„ä¸ªçŠ¶æ€çš„è¿æ¥æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -an | awk '/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºæ¯ä¸ªIPçš„è¿æ¥æ•°ï¼Œä»¥åŠæ€»çš„å„ä¸ªçŠ¶æ€çš„è¿æ¥æ•°</span></span><br><span class="line">$ netstat -n | awk <span class="string">'/^tcp/ &#123;n=split($(NF-1),array,":");if(n&lt;=2)++S[array[(1)]];else++S[array[(4)]];++s[$NF];++N&#125; END &#123;for(a in S)&#123;printf("%-20s %s\n", a, S[a]);++I&#125;printf("%-20s %s\n","TOTAL_IP",I);for(a in s) printf("%-20s %s\n",a, s[a]);printf("%-20s %s\n","TOTAL_LINK",N);&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å½“å‰tcp/ipé“¾æ¥æ•°æ’åå‰10çš„IP</span></span><br><span class="line">$ netstat -n|awk <span class="string">'/^tcp/ &#123;print $5&#125;'</span>|awk -F<span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span>|sort|uniq -c|sort -n -k 1 -r|head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨grepç»Ÿè®¡å½“å‰æ–‡ä»¶é‡Œé¢æ‰€æœ‰çš„IPåœ°å€</span></span><br><span class="line">$ grep -E -o <span class="string">"(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"</span> nginx_access.log</span><br></pre></td></tr></table></figure></li></ul><p>æŸ¥çœ‹ç³»ç»Ÿå½“å‰è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„æ•°ï¼ŒæŒ‰ç…§æœ€å¤§çš„è¿›è¡Œæ’åº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lsof -n | awk <span class="string">'&#123;print $2&#125;'</span> | sort | uniq -c | sort -nr | more</span><br></pre></td></tr></table></figure><ul><li>pingå‘½ä»¤æ˜¾ç¤ºæ—¶é—´ä»¥åŠæ—¥æœŸ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping www.sina.com.cn -i 3 | awk <span class="string">'&#123; print $0"\t" strftime("%Y-%m-%d %H:%M:%S",systime()) &#125; '</span> &gt; /opt/sina.log &amp;</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>iptables</title>
    <url>/2019/09/25/iptables/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="Iptables"><a href="#Iptables" class="headerlink" title="Iptables"></a>Iptables</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iptalbes æ˜¯ç”¨æ¥è®¾ç½®ã€ç»´æŠ¤å’Œæ£€æŸ¥Linuxå†…æ ¸çš„IPåŒ…è¿‡æ»¤è§„åˆ™çš„ã€‚å¯ä»¥å®šä¹‰ä¸åŒçš„è¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½åŒ…å«å‡ ä¸ªå†…éƒ¨çš„é“¾ï¼Œä¹Ÿèƒ½åŒ…å«ç”¨æˆ·å®šä¹‰çš„é“¾ã€‚æ¯ä¸ªé“¾éƒ½æ˜¯ä¸€ä¸ªè§„åˆ™åˆ—è¡¨ï¼Œå¯¹å¯¹åº”çš„åŒ…è¿›è¡ŒåŒ¹é…ï¼šæ¯æ¡è§„åˆ™æŒ‡å®šåº”å½“å¦‚ä½•å¤„ç†ä¸ä¹‹ç›¸åŒ¹é…çš„åŒ…ã€‚è¿™è¢«ç§°ä½œâ€™targetâ€™ï¼ˆç›®æ ‡ï¼‰ï¼Œä¹Ÿå¯ä»¥è·³å‘åŒä¸€ä¸ªè¡¨å†…çš„ç”¨æˆ·å®šä¹‰çš„é“¾ã€‚</p><a id="more"></a><h4 id="iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£"><a href="#iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£" class="headerlink" title="iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£"></a>iptablesé™åˆ¶IPè®¿é—®ç‰¹å®šç«¯å£</h4><ul><li><p>å…è®¸æŸä¸ªIP ï¼ˆ192.168.6.100ï¼‰çš„æœºå™¨è¿›è¡ŒSSHè¿æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 192.168.6.100 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.100 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li><li><p>å…è®¸æŸä¸€æ®µçš„IP è®¿é—®SSH</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 192.168.6.0/24 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.0/24 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li><li><p>é™åˆ¶æŸä¸€IP è®¿é—®SSH</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp -s ! 192.168.6.100 --dport 22 -j ACCEPT --æ³¨æ„ï¼å·æœ‰ä¸ªç©ºæ ¼</span><br><span class="line">$ iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target prot opt <span class="built_in">source</span> destination</span><br><span class="line">ACCEPT tcp -- 192.168.6.0/24 0.0.0.0/0 tcp dpt:22</span><br></pre></td></tr></table></figure></li></ul><h3 id="é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™"><a href="#é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™" class="headerlink" title="é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™"></a>é…ç½®ä¸€ä¸ªNATè¡¨æ”¾ç«å¢™</h3><ul><li><p>é˜²æ­¢å¤–ç½‘ç”¨å†…ç½‘IPæ¬ºéª—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 10.0.0.0/8 -j DROP</span><br><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 172.16.0.0/12 -j DROP</span><br><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -s 192.168.0.0/16 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>ç¦æ­¢ä¸211.101.46.253çš„æ‰€æœ‰è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -d 211.101.46.253 -j DROP</span><br></pre></td></tr></table></figure></li><li><p>ç¦ç”¨FTP(21)ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 21 -j DROP</span><br><span class="line"><span class="comment"># è¿™æ ·å†™èŒƒå›´å¤ªå¤§äº†,æˆ‘ä»¬å¯ä»¥æ›´ç²¾ç¡®çš„å®šä¹‰.</span></span><br><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 21 -d 211.101.46.253 -j DROP</span><br><span class="line"><span class="comment"># è¿™æ ·åªç¦ç”¨211.101.46.253åœ°å€çš„FTPè¿æ¥,å…¶ä»–è¿æ¥è¿˜å¯ä»¥.å¦‚web(80ç«¯å£)è¿æ¥.</span></span><br></pre></td></tr></table></figure></li><li><p>iptablesç™½åå•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 80 -j DROP</span><br><span class="line"><span class="comment"># æ‹’ç»æ‰€æœ‰IPé“¾æ¥80ç«¯å£</span></span><br><span class="line"></span><br><span class="line">$ iptables -A INPUT -s 58.17.245.222 -p tcp --dport 80 -j ACCEPT</span><br><span class="line"><span class="comment"># å…è®¸æŒ‡å®šIPè®¿é—®80ç«¯å£</span></span><br></pre></td></tr></table></figure></li><li><p>å…è®¸æ‰€æœ‰å·²ç»å»ºç«‹çš„å’Œç›¸å…³çš„è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p>dropéæ³•è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state INVALID -j DROP</span><br><span class="line">$ iptables -A OUTPUT -m state --state INVALID -j DROP</span><br><span class="line">$ iptables -A FORWARD -m state --state INVALID -j DROP</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç«¯å£æ˜ å°„"><a href="#ç«¯å£æ˜ å°„" class="headerlink" title="ç«¯å£æ˜ å°„"></a>ç«¯å£æ˜ å°„</h3><ul><li>è¿™é‡Œä½¿ç”¨çš„æ˜¯FTPæœåŠ¡(36542)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -p tcp --dport 36542 -j DNAT --to 192.168.50.2:36542</span><br><span class="line">$ iptables -t nat -A POSTROUTING -p tcp --dport 36542 -j MASQUERADE</span><br><span class="line"><span class="comment"># å› ä¸ºFTPä½¿ç”¨äº†ä¸¤ä¸ªç«¯å£21å’Œ20ï¼Œ21åªæ˜¯ç”¨äºè¿æ¥ï¼Œ20æ˜¯æ‰§è¡Œå‘½ä»¤çš„ã€‚20æ²¡åŠæ³•ä¿®æ”¹ï¼Œè¿™é‡Œä½¿ç”¨äº†è¢«åŠ¨æ¨¡å¼è¿æ¥ã€‚</span></span><br><span class="line"></span><br><span class="line">$ iptables -t nat -I PREROUTING -p tcp --dport 60000:65000 -j DNAT --to 192.168.50.2</span><br><span class="line"><span class="comment"># è¢«åŠ¨è¿æ¥ç«¯å£60000-65000å…¨éƒ¨è½¬å‘ç»™50.2</span></span><br><span class="line"></span><br><span class="line">$ iptables -t nat -I POSTROUTING -p tcp --dport 60000:65000 -j MASQUERADE</span><br><span class="line"><span class="comment"># éœ€è¦å¼€æ”¾60000:65000ç«¯å£ï¼Œ</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ç«¯å£è½¬å‘"><a href="#ç«¯å£è½¬å‘" class="headerlink" title="ç«¯å£è½¬å‘"></a>ç«¯å£è½¬å‘</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸æœ‰ä¸€å°æœåŠ¡å™¨è¿æ¥å¤–ç½‘ï¼Œå…¶ä»–çš„æœåŠ¡å™¨éƒ½ä¸èƒ½ä¸Šå¤–ç½‘ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå¤–ç½‘æœåŠ¡å™¨ç”¨ä½œç½‘å…³æœåŠ¡å™¨ï¼Œåšç«¯å£è½¬å‘ï¼Œè¿æ¥åˆ°å†…ç½‘æœåŠ¡å™¨</p><ul><li><p>è¿™é‡Œä½¿ç”¨æ•°æ®åº“çš„3306æ˜ å°„åˆ°å¤–ç½‘çš„çš„36544</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING  -m tcp -p tcp --dport 36544 -j DNAT --to-destination 172.16.1.11:3306</span><br><span class="line">$ iptables -t nat -A POSTROUTING -m tcp -p tcp --dport 3306 -d 172.16.1.11 -j SNAT --to-source 172.16.1.1</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ è¿ç»­ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp --dport 60000:65000 -j ACCEPT</span><br><span class="line"><span class="comment"># å†’å·è¡¨ç¤ºæ·»åŠ ä¸€ä¸ªè¿ç»­çš„ç«¯å£</span></span><br><span class="line"></span><br><span class="line">$ iptables -A INPUT -p tcp -m multiport â€“dport 21:25,135:139 -j DROP</span><br><span class="line"><span class="comment">#ä½¿ç”¨multiportå‚æ•°é…ç½®ä¸è¿ç»­ç«¯å£å’Œå¤šä¸ªç«¯å£</span></span><br></pre></td></tr></table></figure></li><li><p>ä»£ç†ä¸Šç½‘<br>å†…ç½‘æœºå­æ— æ³•ä¸Šç½‘ï¼Œé€šè¿‡ä¸€å°å¯ä»¥ä¸Šç½‘çš„ç”µè„‘ï¼Œåœ¨å¯ä»¥è®¿é—®å¤–ç½‘çš„serverä¸Šiptablesè®©å…¶ä¸€ä¸ªç½‘æ®µå†…çš„æœºå­è®¿é—®å¤–ç½‘ï¼Œè¿™é‡Œæ˜¯é˜¿é‡Œäº‘ç¯å¢ƒæ¥åšçš„ï¼Œå¼€å¯IPè½¬å‘åŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sed -i <span class="string">'s/net.ipv4.ip_forward = 0/net.ipv4.ip_forward = 1/g'</span> /etc/sysctl.conf</span><br><span class="line">$ iptables -t nat -I POSTROUTING -s 172.16.3.0/24 -j SNAT --to-source 172.16.3.2</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ“ä½œiptablesçš„natè§„åˆ™"><a href="#æ“ä½œiptablesçš„natè§„åˆ™" class="headerlink" title="æ“ä½œiptablesçš„natè§„åˆ™"></a>æ“ä½œiptablesçš„natè§„åˆ™</h4><ul><li><p>æŸ¥çœ‹è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -nvL -t nat</span><br><span class="line">$ iptables -t nat -L -n --line-numbers</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -D POSTROUTING 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptablesçš„è§„åˆ™å·</span></span><br><span class="line">$ iptables -nL --line-number</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹/æ›¿æ¢è§„åˆ™</span></span><br><span class="line">$ iptbales -R INPUT &#123;1&#125; -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è§„åˆ™</span></span><br><span class="line">$ iptables -D INPUT &#123;1&#125;</span><br></pre></td></tr></table></figure></li><li><p>iptalesç«¯å£é€šè¿‡ä¸€å¼ ç½‘å¡å‡ºå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLESHED -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p>æœ¬æœºç«¯å£ï¼Œæ˜ å°„åˆ°æœ¬æœºç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 25 -j REDIRECT --to-port 2525</span><br><span class="line">$ iptables -t nat -I PREROUTING --src 0/0 --dst 192.168.1.5 -p tcp --dport 80 -j REDIRECT --to-ports 8123</span><br><span class="line">$ iptables -t nat -I OUTPUT --src 0/0 --dst 192.168.1.5 -p tcp --dport 80 -j REDIRECT --to-ports 8123</span><br></pre></td></tr></table></figure></li><li><p>ä¿å­˜é˜²ç«å¢™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo /usr/libexec/iptables/iptables.init save</span><br></pre></td></tr></table></figure></li><li><p>å¥‡è‘©éœ€æ±‚ï¼Œå¼€æ”¾sshç«¯å£æŒ‡å®šçš„IPåœ°å€è®¿é—®ï¼Œå…¶ä»–ç«¯å£å¤ªå¤šä¸æƒ³æ·»åŠ èƒ½å¯¹å¤–è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"><span class="comment"># sample configuration for iptables service</span></span><br><span class="line"><span class="comment"># you can edit this manually or use system-config-firewall</span></span><br><span class="line"><span class="comment"># please do not ask us to add additional ports/services to this default configuration</span></span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT -s 192.168.10.1/32 -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m tcp --dport 22 -j  REJECT --reject-with icmp-port-unreachable</span><br><span class="line"><span class="comment">#-A INPUT -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line"><span class="comment">#-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span></span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>iptables</tag>
      </tags>
  </entry>
  <entry>
    <title>äº¤æ¢æœºåšç«¯å£èšåˆ</title>
    <url>/2019/09/25/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%81%9A%E7%AB%AF%E5%8F%A3%E8%81%9A%E5%90%88/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šh3c s5500 (Switch A)ã€‚huawei s5720S-SI-ACï¼ˆSwitch Bï¼‰</p><p>Switch A ä½œä¸ºä¸Šè¡Œäº¤æ¢æœºï¼ŒSwitch Bä½œä¸ºä¸‹è¡Œäº¤æ¢æœº</p><p><strong>ç»„ç½‘</strong>ï¼šä¸¤ä¸ªäº¤æ¢æœºçš„idã€vlanå·è¿™é‡Œä½¿ç”¨çš„æ˜¯ç›¸åŒ</p><a id="more"></a><p><img src="https://img.xxlaila.cn/2846sjdhausiy84yhks.png" alt="img"></p><h3 id="Switch-Aé…ç½®"><a href="#Switch-Aé…ç½®" class="headerlink" title="Switch Aé…ç½®"></a>Switch Aé…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]vlan 50</span><br><span class="line">[Switch A-SW-vlan50]quit</span><br><span class="line">[Switch A-SW]interface Bridge-Aggregation 50</span><br><span class="line">[Switch A-SW-Bridge-Aggregation50]port access vlan 50</span><br><span class="line">[Switch A-SW]interface GigabitEthernet 1/0/19</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/19]port link-aggregation group 50</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/19] port access vlan 50</span><br><span class="line">[Switch A-SW]interface GigabitEthernet 1/0/20</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/20]port link-aggregation group 50</span><br><span class="line">[Switch A-SW-GigabitEthernet1/0/20]port access vlan 50</span><br><span class="line">[Switch A-SW]link-aggregation load-sharing mode <span class="built_in">source</span>-mac destination-mac</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ç«¯å£èšåˆ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]dis link-aggregation verbose</span><br></pre></td></tr></table></figure></li></ul><h3 id="Switch-Bé…ç½®"><a href="#Switch-Bé…ç½®" class="headerlink" title="Switch Bé…ç½®"></a>Switch Bé…ç½®</h3><h4 id="1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜"><a href="#1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜" class="headerlink" title="1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜"></a>1ã€åˆ›å»ºeth-trunkæ¥å£å¹¶åŠ å…¥æˆå‘˜</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] interface eth-trunk 50</span><br><span class="line">[Switch B-Eth-Trunk1] trunkport gigabitethernet 0/0/1 to 0/0/3</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h4 id="2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan"><a href="#2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan" class="headerlink" title="2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan"></a>2ã€åˆ›å»ºvlanå¹¶å§ä¸²è¡ŒåŠ å…¥vlan</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] vlan batch 50</span><br><span class="line">[Switch B] interface eth-trunk 50</span><br><span class="line">[Switch B-Eth-Trunk1] port link-type trunk</span><br><span class="line">[Switch B-Eth-Trunk1] port trunk allow-pass vlan 50</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h4 id="3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼"><a href="#3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼" class="headerlink" title="3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼"></a>3ã€é…ç½®eth-trunkçš„è´Ÿè½½åˆ†æ‹…æ–¹å¼</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch B] interface eth-trunk 1</span><br><span class="line">[Switch B-Eth-Trunk1] load-balance src-dst-mac</span><br><span class="line">[Switch B-Eth-Trunk1] quit</span><br></pre></td></tr></table></figure><h3 id="Switch-Aé…ç½®åœ°å€æ®µ"><a href="#Switch-Aé…ç½®åœ°å€æ®µ" class="headerlink" title="Switch Aé…ç½®åœ°å€æ®µ"></a>Switch Aé…ç½®åœ°å€æ®µ</h3><p>åœ¨vlané‡Œé¢èµ·ä¸€ä¸ªç½‘ç»œï¼Œä½†ä¸å¯ç”¨dhcpæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Switch A-SW]int vlan 50</span><br><span class="line">[Switch A-SW-Vlan-interface50]ip ad 172.21.16.1 20</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>äº¤æ¢æœº</tag>
      </tags>
  </entry>
  <entry>
    <title>pv pvc</title>
    <url>/2019/09/25/pv-pvc/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="1ã€ä»‹ç»"><a href="#1ã€ä»‹ç»" class="headerlink" title="1ã€ä»‹ç»"></a>1ã€ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PersistentVolumeï¼ˆpvï¼‰å’ŒPersistentVolumeClaimï¼ˆpvcï¼‰æ˜¯k8sæä¾›çš„ä¸¤ç§APIèµ„æºï¼Œç”¨äºæŠ½è±¡å­˜å‚¨ç»†èŠ‚ã€‚ç®¡ç†å‘˜å…³æ³¨äºå¦‚ä½•é€šè¿‡pvæä¾›å­˜å‚¨åŠŸèƒ½è€Œæ— éœ€å…³æ³¨ç”¨æˆ·å¦‚ä½•ä½¿ç”¨ï¼ŒåŒæ ·çš„ç”¨æˆ·åªéœ€è¦æŒ‚è½½pvcåˆ°å®¹å™¨ä¸­è€Œä¸éœ€è¦å…³æ³¨å­˜å‚¨å·é‡‡ç”¨ä½•ç§æŠ€æœ¯å®ç°ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pvcå’Œpvçš„å…³ç³»ä¸podå’Œnodeå…³ç³»ç±»ä¼¼ï¼Œå‰è€…æ¶ˆè€—åè€…çš„èµ„æºã€‚pvcå¯ä»¥å‘pvç”³è¯·æŒ‡å®šå¤§å°çš„å­˜å‚¨èµ„æºå¹¶è®¾ç½®è®¿é—®æ¨¡å¼,è¿™å°±å¯ä»¥é€šè¿‡Provision -&gt; Claim çš„æ–¹å¼ï¼Œæ¥å¯¹å­˜å‚¨èµ„æºè¿›è¡Œæ§åˆ¶ã€‚</p><a id="more"></a><h3 id="2ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#2ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2ã€ç”Ÿå‘½å‘¨æœŸ"></a>2ã€ç”Ÿå‘½å‘¨æœŸ</h3><p>pvå’Œpvcéµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸ:</p><ul><li>ä¾›åº”å‡†å¤‡ã€‚é€šè¿‡é›†ç¾¤å¤–çš„å­˜å‚¨ç³»ç»Ÿæˆ–è€…äº‘å¹³å°æ¥æä¾›å­˜å‚¨æŒä¹…åŒ–æ”¯æŒã€‚<ul><li><strong>é™æ€æä¾›</strong>: ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¤šä¸ªPVï¼Œä¾›PVCä½¿ç”¨ã€‚</li><li><strong>åŠ¨æ€æä¾›</strong>: åŠ¨æ€åˆ›å»ºPVCç‰¹å®šçš„PVï¼Œå¹¶ç»‘å®šã€‚</li></ul></li><li>ç»‘å®šã€‚ç”¨æˆ·åˆ›å»ºpvcå¹¶æŒ‡å®šéœ€è¦çš„èµ„æºå’Œè®¿é—®æ¨¡å¼ã€‚åœ¨æ‰¾åˆ°å¯ç”¨pvä¹‹å‰ï¼Œpvcä¼šä¿æŒæœªç»‘å®šçŠ¶æ€ã€‚</li><li>ä½¿ç”¨ã€‚ç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvcã€‚</li><li>é‡Šæ”¾ã€‚ç”¨æˆ·åˆ é™¤pvcæ¥å›æ”¶å­˜å‚¨èµ„æºï¼Œpvå°†å˜æˆâ€œreleasedâ€çŠ¶æ€ã€‚ç”±äºè¿˜ä¿ç•™ç€ä¹‹å‰çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†ï¼Œå¦åˆ™è¿™äº›å­˜å‚¨èµ„æºæ— æ³•è¢«å…¶ä»–pvcä½¿ç”¨ã€‚</li><li>å›æ”¶(Reclaiming)ã€‚pvå¯ä»¥è®¾ç½®ä¸‰ç§å›æ”¶ç­–ç•¥ï¼šä¿ç•™ï¼ˆRetainï¼‰ï¼Œå›æ”¶ï¼ˆRecycleï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</li></ul><ul><li><strong>ä¿ç•™ç­–ç•¥</strong>: å…è®¸äººå·¥å¤„ç†ä¿ç•™çš„æ•°æ®ã€‚</li><li><strong>åˆ é™¤ç­–ç•¥</strong>: å°†åˆ é™¤pvå’Œå¤–éƒ¨å…³è”çš„å­˜å‚¨èµ„æºï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</li><li><strong>å›æ”¶ç­–ç•¥</strong>: å°†æ‰§è¡Œæ¸…é™¤æ“ä½œï¼Œä¹‹åå¯ä»¥è¢«æ–°çš„pvcä½¿ç”¨ï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç›®å‰åªæœ‰NFSå’ŒHostPathç±»å‹å·æ”¯æŒå›æ”¶ç­–ç•¥ï¼ŒAWS EBS,GCE PD,Azure Diskå’ŒCinderæ”¯æŒåˆ é™¤(Delete)ç­–ç•¥ã€‚</p><h4 id="2-1ã€Provisioning"><a href="#2-1ã€Provisioning" class="headerlink" title="2.1ã€Provisioning"></a>2.1ã€Provisioning</h4><p>ä¸¤ç§æ–¹å¼æä¾›çš„PVèµ„æºä¾›ç»™ï¼š</p><ul><li><p>static:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡é›†ç¾¤ç®¡ç†è€…åˆ›å»ºå¤šä¸ªPVï¼Œä¸ºé›†ç¾¤â€œä½¿ç”¨è€…â€æä¾›å­˜å‚¨èƒ½åŠ›è€Œéšè—çœŸå®å­˜å‚¨çš„ç»†èŠ‚ã€‚å¹¶ä¸”å­˜åœ¨äºkubenretes apiä¸­ï¼Œå¯è¢«ç›´æ¥ä½¿ç”¨ã€‚</p></li><li><p>dynamic:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŠ¨æ€å·ä¾›ç»™æ˜¯kubernetesç‹¬æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¸€åŠŸèƒ½å…è®¸æŒ‰éœ€åˆ›å»ºå­˜å‚¨å»ºã€‚åœ¨æ­¤ä¹‹å‰ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦äº‹å…ˆåœ¨é›†ç¾¤å¤–ç”±å­˜å‚¨æä¾›è€…æˆ–è€…äº‘æä¾›å•†åˆ›å»º<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å­˜å‚¨å·ï¼ŒæˆåŠŸä¹‹åå†åˆ›å»ºPersistentVolumeå¯¹è±¡ï¼Œæ‰èƒ½å¤Ÿåœ¨kubernetesä¸­ä½¿ç”¨ã€‚åŠ¨æ€å·ä¾›ç»™èƒ½è®©é›†ç¾¤ç®¡ç†å‘˜ä¸å¿…è¿›è¡Œé¢„å…ˆåˆ›å»ºå­˜å‚¨å·ï¼Œè€Œæ˜¯éšç€ç”¨æˆ·éœ€æ±‚è¿›è¡Œåˆ›å»ºã€‚åœ¨1.5ç‰ˆæœ¬æé«˜äº†åŠ¨æ€å·çš„å¼¹æ€§å’Œå¯ç”¨æ€§ã€‚</p></li></ul><h3 id="PVç±»å‹"><a href="#PVç±»å‹" class="headerlink" title="PVç±»å‹"></a>PVç±»å‹</h3><p>pvæ”¯æŒä»¥ä¸‹ç±»å‹:</p><ul><li>GCEPersistentDisk</li><li>AWSElasticBlockStore</li><li>NFS</li><li>iSCSI</li><li>RBD (Ceph Block Device)</li><li>Glusterfs</li><li>AzureFile</li><li>AzureDisk</li><li>CephFS</li><li>cinder</li><li>FC</li><li>FlexVolume</li><li>Flocker</li><li>PhotonPersistentDisk</li><li>Quobyte</li><li>VsphereVolume</li><li>HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</li></ul><h4 id="3-1ã€PVå±æ€§"><a href="#3-1ã€PVå±æ€§" class="headerlink" title="3.1ã€PVå±æ€§"></a>3.1ã€PVå±æ€§</h4><ul><li>è®¿é—®æ¨¡å¼,ä¸pvçš„è¯­ä¹‰ç›¸åŒã€‚åœ¨è¯·æ±‚èµ„æºæ—¶ä½¿ç”¨ç‰¹å®šæ¨¡å¼ã€‚</li><li>èµ„æº,ç”³è¯·çš„å­˜å‚¨èµ„æºæ•°é¢ã€‚</li></ul><h4 id="3-2ã€PVå·é˜¶æ®µçŠ¶æ€"><a href="#3-2ã€PVå·é˜¶æ®µçŠ¶æ€" class="headerlink" title="3.2ã€PVå·é˜¶æ®µçŠ¶æ€"></a>3.2ã€PVå·é˜¶æ®µçŠ¶æ€</h4><ul><li>Available â€“ èµ„æºå°šæœªè¢«claimä½¿ç”¨</li><li>Bound â€“ å·å·²ç»è¢«ç»‘å®šåˆ°claimäº†</li><li>Released â€“ claimè¢«åˆ é™¤ï¼Œå·å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æœªè¢«é›†ç¾¤å›æ”¶ã€‚</li><li>Failed â€“ å·è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pv, pvc</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ©ç”¨NFSåŠ¨æ€æä¾›Kubernetesåç«¯å­˜å‚¨å·</title>
    <url>/2019/09/24/%E5%88%A9%E7%94%A8NFS%E5%8A%A8%E6%80%81%E6%8F%90%E4%BE%9BKubernetes%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8%E5%8D%B7/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nfs-client-provisioneræ˜¯ä¸€ä¸ªautomatic provisionerï¼Œä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œè‡ªåŠ¨åˆ›å»ºPVå’Œå¯¹åº”çš„PVCï¼Œæœ¬èº«ä¸æä¾›NFSå­˜å‚¨ï¼Œéœ€è¦å¤–éƒ¨å…ˆæœ‰ä¸€å¥—NFSå­˜å‚¨æœåŠ¡ã€‚</p><ul><li>PVä»¥ ${namespace}-${pvcName}-${pvName}çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">å®˜æ–¹è®¿é—®åœ°å€</a></p><a id="more"></a><h3 id="1ã€æƒé™ä½“ç³»æ„å»º"><a href="#1ã€æƒé™ä½“ç³»æ„å»º" class="headerlink" title="1ã€æƒé™ä½“ç³»æ„å»º"></a>1ã€æƒé™ä½“ç³»æ„å»º</h3><h4 id="1-1ã€åˆ›å»ºserviceaccount"><a href="#1-1ã€åˆ›å»ºserviceaccount" class="headerlink" title="1.1ã€åˆ›å»ºserviceaccount"></a>1.1ã€åˆ›å»ºserviceaccount</h4><p>ServiceAccountä¹Ÿæ˜¯ä¸€ç§è´¦å·, ä¾›è¿è¡Œåœ¨podä¸­çš„è¿›ç¨‹ä½¿ç”¨, ä¸ºpodä¸­çš„è¿›ç¨‹æä¾›å¿…è¦çš„èº«ä»½è¯æ˜</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; serviceaccount.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-2ã€åˆ›å»ºrole"><a href="#1-2ã€åˆ›å»ºrole" class="headerlink" title="1.2ã€åˆ›å»ºrole"></a>1.2ã€åˆ›å»ºrole</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt;clusterrole.yaml&lt;&lt;EOF</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    resources: [<span class="string">"storageclasses"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"events"</span>]</span><br><span class="line">    verbs: [<span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services"</span>, <span class="string">"endpoints"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>,<span class="string">"list"</span>, <span class="string">"watch"</span>,<span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"podsecuritypolicies"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"nfs-client-provisioner"</span>]</span><br><span class="line">    verbs: [<span class="string">"use"</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"><a href="#1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š" class="headerlink" title="1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"></a>1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt;clusterrolebinding.yaml &lt;&lt;EOF</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: kube-ops</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-4ã€æ‰§è¡Œåˆ›å»º"><a href="#1-4ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="1.4ã€æ‰§è¡Œåˆ›å»º"></a>1.4ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f serviceaccount.yaml -f clusterrole.yaml -f clusterrolebinding.yaml</span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span><br></pre></td></tr></table></figure><h3 id="2ã€å®‰è£…éƒ¨ç½²"><a href="#2ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="2ã€å®‰è£…éƒ¨ç½²"></a>2ã€å®‰è£…éƒ¨ç½²</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹è½½deployment.yamlæ–‡ä»¶,éœ€è¦ä¿®æ”¹NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ10.10.10.60ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/ifs/kubernetesï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><h4 id="2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"><a href="#2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·" class="headerlink" title="2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"></a>2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·</h4><p>æ ¹æ®PVCçš„è¯·æ±‚, åŠ¨æ€åˆ›å»ºPVå­˜å‚¨.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; deployment.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: quay.io/external_storage/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.21.17.39</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /opt</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: /opt</span><br><span class="line">            path: 172.21.17.39</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²class.yaml</li></ul><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´</p><h4 id="2-2ã€åˆ›å»ºstorageclass"><a href="#2-2ã€åˆ›å»ºstorageclass" class="headerlink" title="2.2ã€åˆ›å»ºstorageclass"></a>2.2ã€åˆ›å»ºstorageclass</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; class.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-3ã€æ‰§è¡Œåˆ›å»º"><a href="#2-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="2.3ã€æ‰§è¡Œåˆ›å»º"></a>2.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f deployment.yaml </span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">deployment.extensions/nfs-client-provisioner created</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f class.yaml </span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage created</span><br></pre></td></tr></table></figure><h5 id="2-3-1ã€æŸ¥çœ‹StorageClass"><a href="#2-3-1ã€æŸ¥çœ‹StorageClass" class="headerlink" title="2.3.1ã€æŸ¥çœ‹StorageClass"></a>2.3.1ã€æŸ¥çœ‹StorageClass</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get storageclass</span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   18s</span><br></pre></td></tr></table></figure><h5 id="2-3-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"><a href="#2-3-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨" class="headerlink" title="2.3.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"></a>2.3.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨</h5><p>è®¾ç½®è¿™ä¸ªdefaultåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl patch storageclass managed-nfs-storage -p <span class="string">'&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage patched</span><br></pre></td></tr></table></figure><ul><li>storage.yaml (å’Œä¸Šé¢ä¸€æ ·)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; storage.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">  annotations:</span><br><span class="line">    storageclass.kubernetes.io/is-default-class: <span class="string">"true"</span></span><br><span class="line">provisioner: fuseim.pri/ifs</span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-3-3ã€æŸ¥çœ‹éªŒè¯"><a href="#2-3-3ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="2.3.3ã€æŸ¥çœ‹éªŒè¯"></a>2.3.3ã€æŸ¥çœ‹éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get all -n kube-ops</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-77f678858b-8d2d6   1/1     Running   0          26m</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nfs-client-provisioner   1/1     1            1           29m</span><br><span class="line"></span><br><span class="line">NAME                                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nfs-client-provisioner-77f678858b   1         1         1       26m</span><br></pre></td></tr></table></figure><h3 id="3ã€éªŒè¯æµ‹è¯•"><a href="#3ã€éªŒè¯æµ‹è¯•" class="headerlink" title="3ã€éªŒè¯æµ‹è¯•"></a>3ã€éªŒè¯æµ‹è¯•</h3><h4 id="3-1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨"><a href="#3-1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨" class="headerlink" title="3.1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨"></a>3.1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­˜å‚¨</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; <span class="built_in">test</span>-claim.yaml &lt;&lt;EOF</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-claim</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2ã€å¯åŠ¨æµ‹è¯•POD"><a href="#3-2ã€å¯åŠ¨æµ‹è¯•POD" class="headerlink" title="3.2ã€å¯åŠ¨æµ‹è¯•POD"></a>3.2ã€å¯åŠ¨æµ‹è¯•POD</h4><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat  &gt; <span class="built_in">test</span>-pod.yaml &lt;&lt;EOF</span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-pod</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: <span class="built_in">test</span>-pod</span><br><span class="line">    image: docker.io/busybox:1.24</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"/bin/sh"</span></span><br><span class="line">    args:</span><br><span class="line">      - <span class="string">"-c"</span></span><br><span class="line">      - <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        mountPath: <span class="string">"/mnt"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: <span class="built_in">test</span>-claim</span><br></pre></td></tr></table></figure><h4 id="3-3ã€æ‰§è¡Œåˆ›å»º"><a href="#3-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="3.3ã€æ‰§è¡Œåˆ›å»º"></a>3.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f ./</span><br><span class="line">persistentvolumeclaim/<span class="built_in">test</span>-claim created</span><br><span class="line">pod/<span class="built_in">test</span>-pod created</span><br></pre></td></tr></table></figure><h4 id="3-4ã€æŸ¥çœ‹éªŒè¯"><a href="#3-4ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="3.4ã€æŸ¥çœ‹éªŒè¯"></a>3.4ã€æŸ¥çœ‹éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod,pv -n kube-ops</span><br><span class="line">NAME                                          READY   STATUS      RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-77f678858b-8d2d6   1/1     Running     0          3h26m</span><br><span class="line">pod/<span class="built_in">test</span>-pod                                  0/1     Completed   0          172m</span><br><span class="line"></span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">persistentvolume/pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Retain           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            172m</span><br></pre></td></tr></table></figure><ul><li>ç™»å½•nfsæœåŠ¡å™¨æŸ¥çœ‹æ˜¯å¦æˆåŠŸçš„åˆ›å»ºç›®å½•<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /opt/</span><br><span class="line">kube-ops-test-claim-pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-5ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"><a href="#3-5ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥" class="headerlink" title="3.5ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"></a>3.5ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥</h4><ul><li><p>æŸ¥çœ‹é›†ç¾¤ä¸­PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pv -n kube-ops</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Delete           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            3m6s</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl patch pv pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8  -p <span class="string">'&#123;"spec":&#123;"persistentVolumeReclaimPolicy":"Retain"&#125;&#125;'</span></span><br><span class="line">persistentvolume/pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8 patched</span><br><span class="line"></span><br><span class="line">$ kubectl get pv -n kube-ops</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-2f0057b0-df35-11e9-ad62-fa163e53d4c8   1Mi        RWX            Retain           Bound    kube-ops/<span class="built_in">test</span>-claim   managed-nfs-storage            3m54s</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>pvc,pv</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 prometheus</title>
    <url>/2019/09/20/k8s-v1-14-prometheus/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h1 id="Prometheusã€Grafana-éƒ¨ç½²"><a href="#Prometheusã€Grafana-éƒ¨ç½²" class="headerlink" title="Prometheusã€Grafana éƒ¨ç½²"></a>Prometheusã€Grafana éƒ¨ç½²</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Grafanaæ˜¯ä¸€ä¸ªå¼€æºçš„åº¦é‡åˆ†æä¸å¯è§†åŒ–å¥—ä»¶ã€‚ç»å¸¸è¢«ç”¨ä½œåŸºç¡€è®¾æ–½çš„æ—¶é—´åºåˆ—æ•°æ®å’Œåº”ç”¨ç¨‹åºåˆ†æçš„å¯è§†åŒ–ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨å®ƒæ¥åšKubernetesé›†ç¾¤ç›‘æ§æ•°æ®çš„å¯è§†åŒ–ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆªè‡³å½“å‰ï¼Œprometheusã€grafanaå‡é‡‡ç”¨æœ€æ–°çš„é•œåƒåŒ…ï¼Œåœ¨åœ¨ç¬¬ä¸€æ¬¡éƒ¨ç½²çš„æ—¶å€™grafanaæŠ¥äº†ä¸€ä¸ªé”™è¯¯<code>mkdir: cannot create directory &#39;/var/lib/grafana/plugins&#39;: No such file or directory</code>,è¿™æ˜¯å› ä¸ºGrafanaå¯åŠ¨ä½¿ç”¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„éƒ½æ˜¯472ï¼Œé€ æˆå¯¹å¤–æŒ‚å­˜å‚¨æ²¡æœ‰æƒé™ã€‚<a href="https://grafana.com/docs/installation/docker/#migration-from-a-previous-version-of-the-docker-container-to-5-1-or-later" target="_blank" rel="noopener">å‚è€ƒå®˜æ–¹</a></p><a id="more"></a><h3 id="å¼€å§‹éƒ¨ç½²"><a href="#å¼€å§‹éƒ¨ç½²" class="headerlink" title="å¼€å§‹éƒ¨ç½²"></a>å¼€å§‹éƒ¨ç½²</h3><p>æ–°å»ºyamlæ–‡ä»¶</p><ul><li>monitor-namespace.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat  monitor-namespace.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring</span><br></pre></td></tr></table></figure></li></ul><p>å…¶ä»–çš„æ–‡ä»¶å‡é‡‡ç”¨ä»¥å‰å†å²çš„ï¼Œç„¶åç¨åŠ ä¿®æ”¹ï¼Œå…¶ä»–<a href="https://github.com/xxlaila/kubernetes-yaml.git" target="_blank" rel="noopener">yaml</a>æ–‡ä»¶,ç§»é™¤<code>grafana-ingress.yaml</code>ã€<code>prometheus-ingress.yaml</code></p><h3 id="æ–‡ä»¶ä¿®æ”¹"><a href="#æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="æ–‡ä»¶ä¿®æ”¹"></a>æ–‡ä»¶ä¿®æ”¹</h3><ul><li><p>grafana-deploy.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-core</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: grafana</span><br><span class="line">        component: core</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: grafana/grafana:latest</span><br><span class="line">        name: grafana-core</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment"># env:</span></span><br><span class="line">        resources:</span><br><span class="line">          <span class="comment"># keep request = limit to keep this container in guaranteed class</span></span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        env:</span><br><span class="line">          <span class="comment"># The following env variables set up basic auth twith the default admin user and admin password.</span></span><br><span class="line">          - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">            value: <span class="string">"true"</span></span><br><span class="line">          - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">            value: <span class="string">"false"</span></span><br><span class="line">          <span class="comment"># - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span></span><br><span class="line">          <span class="comment">#   value: Admin</span></span><br><span class="line">          <span class="comment"># does not really work, because of template variables in exported dashboards:</span></span><br><span class="line">          <span class="comment"># - name: GF_DASHBOARDS_JSON_ENABLED</span></span><br><span class="line">          <span class="comment">#   value: "true"</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 3000</span><br><span class="line">          <span class="comment"># initialDelaySeconds: 30</span></span><br><span class="line">          <span class="comment"># timeoutSeconds: 1</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: grafana-persistent-storage</span><br><span class="line">          mountPath: /var/lib/grafana</span><br><span class="line">      volumes:</span><br><span class="line">      - name: grafana-persistent-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>prometheus-deploy.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/prometheus:latest</span><br><span class="line">        name: prometheus</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - <span class="string">"/bin/prometheus"</span></span><br></pre></td></tr></table></figure></li><li><p>prometheus-svc.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    targetPort: 9090</span><br><span class="line">    <span class="comment">#nodePort: 30005</span></span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br></pre></td></tr></table></figure></li><li><p>grafana-svc.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#type: NodePort</span></span><br><span class="line">  ports:</span><br><span class="line">    - port: 3000</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">    component: core</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šæ‰§è¡Œå‡ æ¬¡</span></span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deploy -n monitoring</span></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/grafana-core-7b5989cf9d-snbk5   1/1     Running   0          2m31s</span><br><span class="line">pod/node-exporter-dddv7             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-fhfp6             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-m46bf             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-xkrzp             1/1     Running   0          12m</span><br><span class="line">pod/node-exporter-zfcxh             1/1     Running   0          12m</span><br><span class="line">pod/prometheus-67bcf457db-999ns     1/1     Running   0          12m</span><br><span class="line"></span><br><span class="line">NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/grafana         ClusterIP   10.254.95.151    &lt;none&gt;        3000/TCP         12m</span><br><span class="line">service/node-exporter   ClusterIP   10.254.114.12    &lt;none&gt;        9100/TCP         12m</span><br><span class="line">service/prometheus      ClusterIP   10.254.104.216   &lt;none&gt;        9090/TCP         12m</span><br><span class="line"></span><br><span class="line">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.extensions/grafana-core   1/1     1            1           12m</span><br><span class="line">deployment.extensions/prometheus     1/1     1            1           12m</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºIngress"><a href="#åˆ›å»ºIngress" class="headerlink" title="åˆ›å»ºIngress"></a>åˆ›å»ºIngress</h3><h4 id="prometheus-Ingress"><a href="#prometheus-Ingress" class="headerlink" title="prometheus Ingress"></a>prometheus Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat prometheus-Ingress.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-web-ui</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br></pre></td></tr></table></figure><h4 id="grafana-Ingress"><a href="#grafana-Ingress" class="headerlink" title="grafana Ingress"></a>grafana Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana-Ingress.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-web-ui</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br></pre></td></tr></table></figure><h4 id="æ‰§è¡Œåˆ›å»º-1"><a href="#æ‰§è¡Œåˆ›å»º-1" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f prometheus-Ingress.yaml </span></span><br><span class="line">ingress.extensions/prometheus-web-ui created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f grafana-Ingress.yaml </span></span><br><span class="line">ingress.extensions/grafana-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨è¾“å…¥prometheus.xxlaila.cnè®¿é—®prometheusï¼Œè¾“å…¥grafana.xxlaila.cnè®¿é—®grafanaã€‚</p><h3 id="è®¿é—®prometheus"><a href="#è®¿é—®prometheus" class="headerlink" title="è®¿é—®prometheus"></a>è®¿é—®prometheus</h3><p><img src="https://img.xxlaila.cn/1569218750254.jpg" alt="img"></p><h3 id="é…ç½®grafana"><a href="#é…ç½®grafana" class="headerlink" title="é…ç½®grafana"></a>é…ç½®grafana</h3><p><img src="https://img.xxlaila.cn/1568968344227.jpg" alt="img"></p><p>åˆ°grafanaçš„å®˜æ–¹ä¸‹è½½å¯¹åº”çš„æ¨¡ç‰ˆæ–‡ä»¶å¯¼å…¥ï¼Œå°±å¯ä»¥å‡ºå›¾å•¦<br><img src="https://img.xxlaila.cn/1568968420655.jpg" alt="img"></p><p><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/prometheus" target="_blank" rel="noopener">åç»­åˆ©ç”¨pvc</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14,prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 weave-scope</title>
    <url>/2019/09/20/k8s-v1-14-weave-scope/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="å‰æ²¿"><a href="#å‰æ²¿" class="headerlink" title="å‰æ²¿"></a>å‰æ²¿</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes é›†ç¾¤å¹¶éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨åªæ˜¯ç¬¬ä¸€æ­¥ã€‚ä¸€æ—¦é›†ç¾¤è¿è¡Œèµ·æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ä¸€èµ·æ­£å¸¸ï¼Œæ‰€æœ‰å¿…è¦ç»„ä»¶å°±ä½å¹¶å„å¸å…¶èŒï¼Œæœ‰è¶³å¤Ÿçš„èµ„æºæ»¡è¶³åº”ç”¨çš„éœ€æ±‚ã€‚Kubernetes æ˜¯ä¸€ä¸ªå¤æ‚ç³»ç»Ÿï¼Œè¿ç»´å›¢é˜Ÿéœ€è¦æœ‰ä¸€å¥—å·¥å…·å¸®åŠ©ä»–ä»¬è·çŸ¥é›†ç¾¤çš„å®æ—¶çŠ¶æ€ï¼Œå¹¶ä¸ºæ•…éšœæ’æŸ¥æä¾›åŠæ—¶å’Œå‡†ç¡®çš„æ•°æ®æ”¯æŒã€‚</p><h3 id="weave-scope-ä»‹ç»"><a href="#weave-scope-ä»‹ç»" class="headerlink" title="weave scope ä»‹ç»"></a>weave scope ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Weave Scopeæ˜¯Dockerå’ŒKubernetesçš„å¯è§†åŒ–å’Œç›‘æ§å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€ä¸ªè‡ªä¸Šè€Œä¸‹çš„åº”ç”¨ç¨‹åºä»¥åŠæ•´ä¸ªåŸºç¡€æ¶æ„è§†å›¾ï¼Œå¹¶å…è®¸æ‚¨åœ¨éƒ¨ç½²åˆ°äº‘æä¾›å•†æ—¶å®æ—¶è¯Šæ–­åˆ†å¸ƒå¼å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ä»»ä½•é—®é¢˜ã€‚</p><a id="more"></a><h3 id="åŠŸèƒ½ä»‹ç»"><a href="#åŠŸèƒ½ä»‹ç»" class="headerlink" title="åŠŸèƒ½ä»‹ç»"></a>åŠŸèƒ½ä»‹ç»</h3><ul><li>podæ‹“æ‰‘æ˜ å°„</li><li>å›¾å½¢æˆ–è¡¨æ ¼æ¨¡å¼</li><li>çµæ´»è¿‡æ»¤</li><li>å¼ºå¤§çš„æœç´¢åŠŸèƒ½</li><li>å®æ—¶åº”ç”¨å’Œå®¹å™¨æŒ‡æ ‡</li><li>æ’é™¤æ•…éšœå¹¶ç®¡ç†å®¹å™¨</li><li>ä½¿ç”¨Plugin APIç”Ÿæˆè‡ªå®šä¹‰æŒ‡æ ‡</li></ul><p><a href="https://www.weave.works/docs/scope/latest/features/" target="_blank" rel="noopener">ä»‹ç»å‚è€ƒ</a></p><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>åœ¨ K8s é›†ç¾¤ä¸­å®‰è£… Scope çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f "https://cloud.weave.works/k8s/scope.yaml?k8s-version=$(kubectl version | base64 | tr -d '\n')"</span></span><br><span class="line">namespace/weave created</span><br><span class="line">serviceaccount/weave-scope created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">deployment.apps/weave-scope-app created</span><br><span class="line">service/weave-scope-app created</span><br><span class="line">deployment.apps/weave-scope-cluster-agent created</span><br><span class="line">daemonset.extensions/weave-scope-agent created</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥"><a href="#æ£€æŸ¥" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deploy -n weave</span></span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/weave-scope-agent-2t4m5                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-6tfp5                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-fxj5f                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-gkxc6                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-agent-qnbbv                      1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-app-b99fb9585-wld6n              1/1     Running   0          15m</span><br><span class="line">pod/weave-scope-cluster-agent-77bc946585-8fcjj   1/1     Running   0          15m</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/weave-scope-app   ClusterIP   10.254.184.106   &lt;none&gt;        80/TCP    15m</span><br><span class="line"></span><br><span class="line">NAME                                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.extensions/weave-scope-app             1/1     1            1           15m</span><br><span class="line">deployment.extensions/weave-scope-cluster-agent   1/1     1            1           15m</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºweave-scope-ingress"><a href="#åˆ›å»ºweave-scope-ingress" class="headerlink" title="åˆ›å»ºweave-scope ingress"></a>åˆ›å»ºweave-scope ingress</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat weave-scope.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: weave-web-ui</span><br><span class="line">  namespace: weave</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: weave-scope.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: weave-scope-app</span><br><span class="line">          servicePort: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f weave-scope.yaml </span></span><br><span class="line">ingress.extensions/weave-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆè¾“å…¥<code>weave-scope.xxlaila.cn</code>å³å¯è®¿é—®<br><img src="https://img.xxlaila.cn/1568958836846.jpg" alt="img"></p><h4 id="æ‹“æ‰‘ç»“æ„"><a href="#æ‹“æ‰‘ç»“æ„" class="headerlink" title="æ‹“æ‰‘ç»“æ„"></a>æ‹“æ‰‘ç»“æ„</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scope ä¼šè‡ªåŠ¨æ„å»ºåº”ç”¨å’Œé›†ç¾¤çš„é€»è¾‘æ‹“æ‰‘ã€‚æ¯”å¦‚ç‚¹å‡»é¡¶éƒ¨ Podsï¼Œä¼šæ˜¾ç¤ºæ‰€æœ‰ Pod ä»¥åŠ Pod ä¹‹é—´çš„ä¾èµ–å…³ç³»<br><img src="https://img.xxlaila.cn/1568958666089.jpg" alt="img"><br>ç‚¹å‡» Hostsï¼Œä¼šæ˜¾ç¤ºå„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œå¯ä»¥åœ¨ Scope ä¸­æŸ¥çœ‹èµ„æºçš„ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚<br><img src="https://img.xxlaila.cn/1568958913275.jpg" alt="img"></p><h3 id="åœ¨çº¿æ“ä½œ"><a href="#åœ¨çº¿æ“ä½œ" class="headerlink" title="åœ¨çº¿æ“ä½œ"></a>åœ¨çº¿æ“ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Scope è¿˜æä¾›äº†ä¾¿æ·çš„åœ¨çº¿æ“ä½œåŠŸèƒ½ï¼Œæ¯”å¦‚é€‰ä¸­æŸä¸ª Hostï¼Œç‚¹å‡» &gt;_æŒ‰é’®å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€èŠ‚ç‚¹çš„å‘½ä»¤è¡Œç»ˆç«¯ï¼š<br><img src="https://img.xxlaila.cn/1568959004395.jpg" alt="img"></p><ul><li><p>ç‚¹å‡» Deployment çš„ + å¯ä»¥æ‰§è¡Œæ–°å¢ä¸€ä¸ªpodå®åˆ—<br><img src="https://img.xxlaila.cn/1568959269040.jpg" alt="img"></p></li><li><p>æŸ¥çœ‹podçš„æ—¥å¿—<br><img src="https://img.xxlaila.cn/1568959359334.jpg" alt="img"></p></li><li><p>attachã€restartã€stop å®¹å™¨ï¼Œä»¥åŠç›´æ¥åœ¨ Scope ä¸­æ’æŸ¥é—®é¢˜<br><img src="https://img.xxlaila.cn/1568959467442.jpg" alt="img"></p></li></ul><p>æ›´å¤šåŠŸå‘¢ä¸ªè¯·<a href="https://www.weave.works/docs/scope/latest/plugins/" target="_blank" rel="noopener">å‚è€ƒå®˜æ–¹</a>,æˆ–è€…å®æ“</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14, weave-scope</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 traefikéƒ¨ç½²</title>
    <url>/2019/09/20/k8s-v1-14-traefik%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefix å‰ç¯‡æ˜¯å¯ä»¥ä½¿ç”¨ï¼Œè¿™é‡Œk8s v1.14 ä¹‹å‰çš„æ‹¿æ¥ç”¨ä¸ä¸Šï¼Œç„¶åæŠ˜è…¾äº†ä¸€ä¸‹ï¼Œå‚è€ƒå®˜æ–¹çš„æŠ˜è…¾èµ·æ¥äº†</p><h3 id="åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes-1-6-ï¼‰"><a href="#åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes-1-6-ï¼‰" class="headerlink" title="åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes 1.6+ï¼‰"></a>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é…ç½®ï¼ˆä»…é™Kubernetes 1.6+ï¼‰</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesåœ¨1.6+ä¸­å¼•å…¥äº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼Œä»¥å…è®¸å¯¹Kubernetesèµ„æºå’ŒAPIè¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚ç¾¤é›†é…ç½®äº†RBACï¼Œåˆ™éœ€è¦æˆæƒTraefikä½¿ç”¨Kubernetes APIã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®¾ç½®é€‚å½“çš„æƒé™ï¼šé€šè¿‡ç‰¹å®šäºå‘½åç©ºé—´çš„RoleBindingsæˆ–å•ä¸ªå…¨å±€ClusterRoleBindingã€‚</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¯ä¸ªå‘½åç©ºé—´çš„RoleBindingå¯ä»¥é™åˆ¶æˆäºˆæƒé™ï¼Œåªæœ‰Traefikæ­£åœ¨ç›‘è§†çš„åç§°ç©ºé—´æ‰èƒ½ä½¿ç”¨ï¼Œä»è€Œéµå¾ªæœ€å°æƒé™åŸåˆ™ã€‚å¦‚æœTraefikä¸åº”è¯¥ç›‘è§†æ‰€æœ‰åç§°ç©ºé—´ï¼Œå¹¶ä¸”åç§°ç©ºé—´é›†ä¸ä¼šåŠ¨æ€æ›´æ”¹ï¼Œé‚£ä¹ˆè¿™æ˜¯é¦–é€‰æ–¹æ³•ã€‚å¦åˆ™ï¼Œå¿…é¡»ä½¿ç”¨å•ä¸ªClusterRoleBindingã€‚</p><p><a href="https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">traefikå­¦ä¹ </a><br><a href="https://docs.traefik.io/v1.7/user-guide/kubernetes/" target="_blank" rel="noopener">traefikå®˜æ–¹</a></p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>ä¸‹è½½trarfixä»£ç ï¼Œç„¶ååˆ‡æ¢åˆ°v1.7çš„åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/containous/traefik.git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git branch --all</span></span><br><span class="line">* master</span><br><span class="line">  remotes/origin/HEAD -&gt; origin/master</span><br><span class="line">  remotes/origin/add-plugin-support</span><br><span class="line">  remotes/origin/gh-pages</span><br><span class="line">  remotes/origin/master</span><br><span class="line">  remotes/origin/v1.0</span><br><span class="line">  remotes/origin/v1.1</span><br><span class="line">  remotes/origin/v1.2</span><br><span class="line">  remotes/origin/v1.3</span><br><span class="line">  remotes/origin/v1.4</span><br><span class="line">  remotes/origin/v1.5</span><br><span class="line">  remotes/origin/v1.6</span><br><span class="line">  remotes/origin/v1.7</span><br><span class="line">  remotes/origin/v2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># git checkout v1.7</span></span><br><span class="line">Branch <span class="string">'v1.7'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'v1.7'</span> from <span class="string">'origin'</span>.</span><br><span class="line">Switched to a new branch <span class="string">'v1.7'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /root/traefik/examples/k8s</span></span><br></pre></td></tr></table></figure><h3 id="å®‰è£…éƒ¨ç½²"><a href="#å®‰è£…éƒ¨ç½²" class="headerlink" title="å®‰è£…éƒ¨ç½²"></a>å®‰è£…éƒ¨ç½²</h3><h4 id="ä½¿ç”¨ClusterRoleBinding"><a href="#ä½¿ç”¨ClusterRoleBinding" class="headerlink" title="ä½¿ç”¨ClusterRoleBinding"></a>ä½¿ç”¨ClusterRoleBinding</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik-rbac.yaml </span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br></pre></td></tr></table></figure><p>å¯¹äºå‘½åç©ºé—´é™åˆ¶ï¼Œæ¯ä¸ªç›‘è§†å‘½åç©ºé—´éœ€è¦ä¸€ä¸ªRoleBindingä»¥åŠTraefik kubernetes.namespaceså‚æ•°çš„ç›¸åº”é…ç½®ã€‚</p><h4 id="ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet"><a href="#ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet" class="headerlink" title="ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet"></a>ä½¿ç”¨Deploymentséƒ¨ç½²æˆ–éƒ¨ç½²DaemonSet</h4><p>å¯ä»¥å°†Traefikä¸Deploymentæˆ–DaemonSetå¯¹è±¡ä¸€èµ·ä½¿ç”¨ï¼Œè€Œè¿™ä¸¤ä¸ªé€‰é¡¹å„æœ‰åˆ©å¼Šï¼š</p><ul><li>ä½¿ç”¨éƒ¨ç½²æ—¶ï¼Œå¯ä¼¸ç¼©æ€§å¯ä»¥æ›´å¥½ï¼Œå› ä¸ºåœ¨ä½¿ç”¨DaemonSetæ—¶æ‚¨å°†æ‹¥æœ‰æ¯ä¸ªèŠ‚ç‚¹çš„Single-Podæ¨¡å‹ï¼Œè€Œåœ¨ä½¿ç”¨éƒ¨ç½²æ—¶ï¼Œå¯èƒ½éœ€è¦æ›´å°‘çš„åŸºäºç¯å¢ƒçš„å‰¯æœ¬ã€‚</li><li>å½“èŠ‚ç‚¹åŠ å…¥ç¾¤é›†æ—¶ï¼ŒDaemonSetä¼šè‡ªåŠ¨æ‰©å±•åˆ°æ–°èŠ‚ç‚¹ï¼Œè€Œéƒ¨ç½²çª—æ ¼ä»…åœ¨éœ€è¦æ—¶åœ¨æ–°èŠ‚ç‚¹ä¸Šè¿›è¡Œè°ƒåº¦ã€‚</li><li>DaemonSetsç¡®ä¿åªæœ‰ä¸€ä¸ªpodå‰¯æœ¬åœ¨ä»»ä½•å•ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚å¦‚æœè¦ç¡®ä¿ä¸¤ä¸ªpodä¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œåˆ™éƒ¨ç½²éœ€è¦å…³è”è®¾ç½®</li><li>å¯ä»¥ä½¿ç”¨è¯¥NET_BIND_SERVICEåŠŸèƒ½è¿è¡ŒDaemonSet ï¼Œè¿™å°†å…è®¸å®ƒç»‘å®šåˆ°æ¯ä¸ªä¸»æœºä¸Šçš„ç«¯å£80/443 / etcã€‚è¿™å°†å…è®¸ç»•è¿‡kube-proxyï¼Œå¹¶å‡å°‘æµé‡è·³è·ƒã€‚è¯·æ³¨æ„ï¼Œè¿™è¿åäº†Kubernetesæœ€ä½³å®è·µæŒ‡å—ï¼Œå¹¶æå‡ºäº†è°ƒåº¦/æ‰©å±•é—®é¢˜çš„å¯èƒ½æ€§ã€‚å°½ç®¡å­˜åœ¨æ½œåœ¨é—®é¢˜ï¼Œä½†è¿™ä»ç„¶æ˜¯å¤§å¤šæ•°å…¥å£æ§åˆ¶å™¨çš„é€‰æ‹©ã€‚</li></ul><h4 id="Deploymentséƒ¨ç½²"><a href="#Deploymentséƒ¨ç½²" class="headerlink" title="Deploymentséƒ¨ç½²"></a>Deploymentséƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  apply -f  traefik-deployment.yaml</span></span><br><span class="line">serviceaccount/traefik-ingress-controller created</span><br><span class="line">deployment.extensions/traefik-ingress-controller created</span><br><span class="line">service/traefik-ingress-service created</span><br></pre></td></tr></table></figure><h4 id="DaemonSets-éƒ¨ç½²-å¯é€‰"><a href="#DaemonSets-éƒ¨ç½²-å¯é€‰" class="headerlink" title="DaemonSets éƒ¨ç½²(å¯é€‰)"></a>DaemonSets éƒ¨ç½²(å¯é€‰)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f traefik-ds.yaml</span></span><br></pre></td></tr></table></figure><ul><li>Deploymentså’ŒDaemonSetsä¹‹é—´å­˜åœ¨ä¸€äº›æ˜¾ç€å·®å¼‚:<ul><li>éƒ¨ç½²å…·æœ‰æ›´å®¹æ˜“çš„å‘ä¸Šå’Œå‘ä¸‹æ‰©å±•å¯èƒ½æ€§ã€‚å®ƒå¯ä»¥å®ç°å®Œæ•´çš„podç”Ÿå‘½å‘¨æœŸï¼Œå¹¶æ”¯æŒKubernetes 1.2çš„æ»šåŠ¨æ›´æ–°ã€‚è¿è¡Œéƒ¨ç½²è‡³å°‘éœ€è¦ä¸€ä¸ªPodã€‚</li><li>DaemonSetä¼šè‡ªåŠ¨æ‰©å±•åˆ°æ»¡è¶³ç‰¹å®šé€‰æ‹©å™¨çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶ä¿è¯ä¸€æ¬¡å¡«å……ä¸€ä¸ªèŠ‚ç‚¹ã€‚Kubernetes 1.7ä¹Ÿå®Œå…¨æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œé€‚ç”¨äºDaemonSets</li></ul></li></ul><h3 id="æ£€æŸ¥éƒ¨ç½²"><a href="#æ£€æŸ¥éƒ¨ç½²" class="headerlink" title="æ£€æŸ¥éƒ¨ç½²"></a>æ£€æŸ¥éƒ¨ç½²</h3><ul><li><p>æŸ¥çœ‹pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl --namespace=kube-system get pods</span></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5579b8778b-xw8m9                     1/1     Running   2          3d21h</span><br><span class="line">kubernetes-dashboard-65dfbf6f4f-hcgbb        1/1     Running   0          2d16h</span><br><span class="line">metrics-server-94ff5d4cc-b97l5               1/1     Running   1          3d</span><br><span class="line">tiller-deploy-5cbcf75545-rbzld               1/1     Running   0          17h</span><br><span class="line">traefik-ingress-controller-c595665d6-cm7kh   1/1     Running   0          3m20s</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹services</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services --namespace=kube-system</span></span><br><span class="line">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                       AGE</span><br><span class="line">kube-dns                  ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP        3d21h</span><br><span class="line">kubernetes-dashboard      NodePort    10.254.214.153   &lt;none&gt;        443:32533/TCP                 3d21h</span><br><span class="line">metrics-server            ClusterIP   10.254.61.132    &lt;none&gt;        443/TCP                       3d</span><br><span class="line">tiller-deploy             ClusterIP   10.254.207.227   &lt;none&gt;        44134/TCP                     17h</span><br><span class="line">traefik-ingress-service   NodePort    10.254.246.158   &lt;none&gt;        80:32146/TCP,8080:30455/TCP   3m53s</span><br></pre></td></tr></table></figure></li></ul><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯nodeportæ¨¡å¼è¿›è¡Œéƒ¨ç½²çš„ï¼Œå¯ä»¥çœ‹åˆ°ç«¯å£ä¸º32146ï¼Œè¿™é‡Œè®¿é—®ä¼šè¿”å›<code>404 page not found</code>,é‚£æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ç»™Traefikä»»ä½•é…ç½®ã€‚</p><h3 id="åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik-Web-UIçš„Ingres"><a href="#åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik-Web-UIçš„Ingres" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik Web UIçš„Ingres"></a>åˆ›å»ºä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªå°†å…¬å¼€Traefik Web UIçš„Ingres</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ui.yaml </span></span><br><span class="line">service/traefik-web-ui created</span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure><p>åœ¨/etc/hosts æ–‡ä»¶è®¾ç½®ä¸€ä¸ªè·¯ç”±æ¡ç›®<code>traefik-ui.minikube</code></p><p>åœ¨æµè§ˆå™¨è¿›è¡Œè®¿é—®å¯ä»¥çœ‹åˆ°Traefik Web UI</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s v1.14, traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 metrics-server</title>
    <url>/2019/09/17/k8s-v1-14-metrics-server/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><p>metrics-serverè¿™é‡Œä¸è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/metrics-serverå®‰è£…å­£/" target="_blank" rel="noopener">metrics-serverå®‰è£…å­£</a></p><h3 id="å®‰è£…metrics-server"><a href="#å®‰è£…metrics-server" class="headerlink" title="å®‰è£…metrics-server"></a>å®‰è£…metrics-server</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œå®‰è£…å’Œä¹‹å‰çš„<strong>metrics-serverå®‰è£…å­£</strong>ç¨å¾®æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œä¹‹å‰é›†ç¾¤å®‰è£…æ²¡æœ‰ä½¿ç”¨httpsè¯ä¹¦ï¼Œåé¢å»å„ç§ç”Ÿæˆçš„è¯ä¹¦å’Œè¸©å‘ï¼Œè¿™é‡Œæ˜¯åœ¨å®‰è£…çš„æ—¶å€™ä¸€å¼€å§‹å°±ä½¿ç”¨äº†httpså…¨è¯ä¹¦,æ‰€æœ‰ç¨å¾®æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œè¿™é‡Œåªåˆ—å‡ºæœ‰åŒºåˆ«çš„åœ°æ–¹ï¼Œå…¶ä»–çš„å®Œå…¨å¯ä»¥å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/metrics-serverå®‰è£…å­£/" target="_blank" rel="noopener">metrics-serverå®‰è£…å­£</a>ï¼Œè¿™é‡Œhttpsè¯ä¹¦<strong>ä¸éœ€è¦</strong>é‡æ–°ç”Ÿæˆï¼›</p><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®æ–‡ä»¶ä¹Ÿä¸éœ€è¦æ·»åŠ ï¼Œåœ¨v1.14å®‰è£…çš„æ—¶å€™å°±å·²ç»å§é…ç½®æ–‡ä»¶æ·»åŠ è¿›å»äº†ï¼Œæ‰€ä»¥è¿™é‡Œé…ç½®æ–‡ä»¶ä¹Ÿä¸éœ€è¦å¢åŠ </p><h3 id="æ–‡ä»¶çš„ä¿®æ”¹"><a href="#æ–‡ä»¶çš„ä¿®æ”¹" class="headerlink" title="æ–‡ä»¶çš„ä¿®æ”¹"></a>æ–‡ä»¶çš„ä¿®æ”¹</h3><ul><li><p>ä¿®æ”¹ metrics-server-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat metrics-server-deployment.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      hostNetwork: <span class="literal">true</span> è¿™ä¸ªè¿˜æ˜¯éœ€è¦å¢åŠ </span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span><br><span class="line">      - name: tmp-dir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: mirrorgooglecontainers/metrics-server-amd64:v0.3.4</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        args:  <span class="comment"># è¿™é‡Œä¸ä¸€æ ·</span></span><br><span class="line">        - --metric-resolution=30s</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp-dir</span><br><span class="line">          mountPath: /tmp</span><br></pre></td></tr></table></figure></li><li><p>â€“metric-resolution=30sï¼šä» kubelet é‡‡é›†æ•°æ®çš„å‘¨æœŸï¼›</p></li><li><p>â€“kubelet-preferred-address-typesï¼šä¼˜å…ˆä½¿ç”¨ InternalIP æ¥è®¿é—® kubeletï¼Œè¿™æ ·å¯ä»¥é¿å…èŠ‚ç‚¹åç§°æ²¡æœ‰ DNS è§£æè®°å½•æ—¶ï¼Œé€šè¿‡èŠ‚ç‚¹åç§°è°ƒç”¨èŠ‚ç‚¹ kubelet API å¤±è´¥çš„æƒ…å†µï¼ˆæœªé…ç½®æ—¶é»˜è®¤çš„æƒ…å†µï¼‰ï¼›</p></li><li><p><strong>hostNetwork: true:</strong> è¿™ä¸ªä¸å¢åŠ çš„ä¼šæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Error from server (ServiceUnavailable): the server is currently unable to handle the request</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ resource-reader.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat resource-reader.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/stats</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups: <span class="comment"># å¢åŠ </span></span><br><span class="line">  - <span class="string">"extensions"</span></span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ‰§è¡Œåˆ›å»º"><a href="#æ‰§è¡Œåˆ›å»º" class="headerlink" title="æ‰§è¡Œåˆ›å»º"></a>æ‰§è¡Œåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹è¿è¡Œæƒ…å†µ"><a href="#æŸ¥çœ‹è¿è¡Œæƒ…å†µ" class="headerlink" title="æŸ¥çœ‹è¿è¡Œæƒ…å†µ"></a>æŸ¥çœ‹è¿è¡Œæƒ…å†µ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods -l k8s-app=metrics-server</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-94ff5d4cc-b97l5   1/1     Running   0          21m</span><br><span class="line"></span><br><span class="line"><span class="comment">#  kubectl get svc -n kube-system  metrics-server</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">metrics-server   ClusterIP   10.254.61.132   &lt;none&gt;        443/TCP   27m</span><br></pre></td></tr></table></figure><h3 id="è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯"><a href="#è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯" class="headerlink" title="è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯"></a>è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get apiservice</span></span><br><span class="line">NAME                                   SERVICE                      AVAILABLE   AGE</span><br><span class="line">v1.                                    Local                        True        23h</span><br><span class="line">v1.apps                                Local                        True        23h</span><br><span class="line">v1.authentication.k8s.io               Local                        True        23h</span><br><span class="line">v1.authorization.k8s.io                Local                        True        23h</span><br><span class="line">v1.autoscaling                         Local                        True        23h</span><br><span class="line">v1.batch                               Local                        True        23h</span><br><span class="line">v1.coordination.k8s.io                 Local                        True        23h</span><br><span class="line">v1.networking.k8s.io                   Local                        True        23h</span><br><span class="line">v1.rbac.authorization.k8s.io           Local                        True        23h</span><br><span class="line">v1.scheduling.k8s.io                   Local                        True        23h</span><br><span class="line">v1.storage.k8s.io                      Local                        True        23h</span><br><span class="line">v1alpha1.auditregistration.k8s.io      Local                        True        23h</span><br><span class="line">v1alpha1.node.k8s.io                   Local                        True        23h</span><br><span class="line">v1alpha1.rbac.authorization.k8s.io     Local                        True        23h</span><br><span class="line">v1alpha1.scheduling.k8s.io             Local                        True        23h</span><br><span class="line">v1alpha1.settings.k8s.io               Local                        True        23h</span><br><span class="line">v1alpha1.storage.k8s.io                Local                        True        23h</span><br><span class="line">v1beta1.admissionregistration.k8s.io   Local                        True        23h</span><br><span class="line">v1beta1.apiextensions.k8s.io           Local                        True        23h</span><br><span class="line">v1beta1.apps                           Local                        True        23h</span><br><span class="line">v1beta1.authentication.k8s.io          Local                        True        23h</span><br><span class="line">v1beta1.authorization.k8s.io           Local                        True        23h</span><br><span class="line">v1beta1.batch                          Local                        True        23h</span><br><span class="line">v1beta1.certificates.k8s.io            Local                        True        23h</span><br><span class="line">v1beta1.coordination.k8s.io            Local                        True        23h</span><br><span class="line">v1beta1.events.k8s.io                  Local                        True        23h</span><br><span class="line">v1beta1.extensions                     Local                        True        23h</span><br><span class="line">v1beta1.metrics.k8s.io                 kube-system/metrics-server   True        27m</span><br><span class="line">v1beta1.networking.k8s.io              Local                        True        23h</span><br><span class="line">v1beta1.node.k8s.io                    Local                        True        23h</span><br><span class="line">v1beta1.policy                         Local                        True        23h</span><br><span class="line">v1beta1.rbac.authorization.k8s.io      Local                        True        23h</span><br><span class="line">v1beta1.scheduling.k8s.io              Local                        True        23h</span><br><span class="line">v1beta1.storage.k8s.io                 Local                        True        23h</span><br><span class="line">v1beta2.apps                           Local                        True        23h</span><br><span class="line">v2alpha1.batch                         Local                        True        23h</span><br><span class="line">v2beta1.autoscaling                    Local                        True        23h</span><br><span class="line">v2beta2.autoscaling                    Local                        True        23h</span><br></pre></td></tr></table></figure><h3 id="metrics-server-çš„å‘½ä»¤è¡Œå‚æ•°"><a href="#metrics-server-çš„å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="metrics-server çš„å‘½ä»¤è¡Œå‚æ•°"></a>metrics-server çš„å‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec --namespace kube-system -it metrics-server-94ff5d4cc-b97l5 -- /metrics-server --help</span></span><br><span class="line">Launch metrics-server</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">   [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --alsologtostderr                                         <span class="built_in">log</span> to standard error as well as files</span><br><span class="line">      --authentication-kubeconfig string                        kubeconfig file pointing at the <span class="string">'core'</span> kubernetes server with enough rights to create tokenaccessreviews.authentication.k8s.io.</span><br><span class="line">      --authentication-skip-lookup                              If <span class="literal">false</span>, the authentication-kubeconfig will be used to lookup missing authentication configuration from the cluster.</span><br><span class="line">      --authentication-token-webhook-cache-ttl duration         The duration to cache responses from the webhook token authenticator. (default 10s)</span><br><span class="line">      --authentication-tolerate-lookup-failure                  If <span class="literal">true</span>, failures to look up missing authentication configuration from the cluster are not considered fatal. Note that this can result <span class="keyword">in</span> authentication that treats all requests as anonymous.</span><br><span class="line">      --authorization-always-allow-paths strings                A list of HTTP paths to skip during authorization, i.e. these are authorized without contacting the <span class="string">'core'</span> kubernetes server.</span><br><span class="line">      --authorization-kubeconfig string                         kubeconfig file pointing at the <span class="string">'core'</span> kubernetes server with enough rights to create subjectaccessreviews.authorization.k8s.io.</span><br><span class="line">      --authorization-webhook-cache-authorized-ttl duration     The duration to cache <span class="string">'authorized'</span> responses from the webhook authorizer. (default 10s)</span><br><span class="line">      --authorization-webhook-cache-unauthorized-ttl duration   The duration to cache <span class="string">'unauthorized'</span> responses from the webhook authorizer. (default 10s)</span><br><span class="line">      --<span class="built_in">bind</span>-address ip                                         The IP address on <span class="built_in">which</span> to listen <span class="keyword">for</span> the --secure-port port. The associated interface(s) must be reachable by the rest of the cluster, and by CLI/web clients. If blank, all interfaces will be used (0.0.0.0 <span class="keyword">for</span> all IPv4 interfaces and :: <span class="keyword">for</span> all IPv6 interfaces). (default 0.0.0.0)</span><br><span class="line">      --cert-dir string                                         The directory <span class="built_in">where</span> the TLS certs are located. If --tls-cert-file and --tls-private-key-file are provided, this flag will be ignored. (default <span class="string">"apiserver.local.config/certificates"</span>)</span><br><span class="line">      --client-ca-file string                                   If <span class="built_in">set</span>, any request presenting a client certificate signed by one of the authorities <span class="keyword">in</span> the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.</span><br><span class="line">      --contention-profiling                                    Enable lock contention profiling, <span class="keyword">if</span> profiling is enabled</span><br><span class="line">  -h, --<span class="built_in">help</span>                                                    <span class="built_in">help</span> <span class="keyword">for</span> this <span class="built_in">command</span></span><br><span class="line">      --http2-max-streams-per-connection int                    The <span class="built_in">limit</span> that the server gives to clients <span class="keyword">for</span> the maximum number of streams <span class="keyword">in</span> an HTTP/2 connection. Zero means to use golang<span class="string">'s default.</span></span><br><span class="line"><span class="string">      --kubeconfig string                                       The path to the kubeconfig used to connect to the Kubernetes API server and the Kubelets (defaults to in-cluster config)</span></span><br><span class="line"><span class="string">      --kubelet-certificate-authority string                    Path to the CA to use to validate the Kubelet'</span>s serving certificates.</span><br><span class="line">      --kubelet-insecure-tls                                    Do not verify CA of serving certificates presented by Kubelets.  For testing purposes only.</span><br><span class="line">      --kubelet-port int                                        The port to use to connect to Kubelets. (default 10250)</span><br><span class="line">      --kubelet-preferred-address-types strings                 The priority of node address types to use when determining <span class="built_in">which</span> address to use to connect to a particular node (default [Hostname,InternalDNS,InternalIP,ExternalDNS,ExternalIP])</span><br><span class="line">      --<span class="built_in">log</span>-flush-frequency duration                            Maximum number of seconds between <span class="built_in">log</span> flushes (default 5s)</span><br><span class="line">      --log_backtrace_at traceLocation                          when logging hits line file:N, emit a stack trace (default :0)</span><br><span class="line">      --log_dir string                                          If non-empty, write <span class="built_in">log</span> files <span class="keyword">in</span> this directory</span><br><span class="line">      --log_file string                                         If non-empty, use this <span class="built_in">log</span> file</span><br><span class="line">      --logtostderr                                             <span class="built_in">log</span> to standard error instead of files (default <span class="literal">true</span>)</span><br><span class="line">      --metric-resolution duration                              The resolution at <span class="built_in">which</span> metrics-server will retain metrics. (default 1m0s)</span><br><span class="line">      --profiling                                               Enable profiling via web interface host:port/debug/pprof/ (default <span class="literal">true</span>)</span><br><span class="line">      --requestheader-allowed-names strings                     List of client certificate common names to allow to provide usernames <span class="keyword">in</span> headers specified by --requestheader-username-headers. If empty, any client certificate validated by the authorities <span class="keyword">in</span> --requestheader-client-ca-file is allowed.</span><br><span class="line">      --requestheader-client-ca-file string                     Root certificate bundle to use to verify client certificates on incoming requests before trusting usernames <span class="keyword">in</span> headers specified by --requestheader-username-headers. WARNING: generally <span class="keyword">do</span> not depend on authorization being already <span class="keyword">done</span> <span class="keyword">for</span> incoming requests.</span><br><span class="line">      --requestheader-extra-headers-prefix strings              List of request header prefixes to inspect. X-Remote-Extra- is suggested. (default [x-remote-extra-])</span><br><span class="line">      --requestheader-group-headers strings                     List of request headers to inspect <span class="keyword">for</span> groups. X-Remote-Group is suggested. (default [x-remote-group])</span><br><span class="line">      --requestheader-username-headers strings                  List of request headers to inspect <span class="keyword">for</span> usernames. X-Remote-User is common. (default [x-remote-user])</span><br><span class="line">      --secure-port int                                         The port on <span class="built_in">which</span> to serve HTTPS with authentication and authorization.If 0, don<span class="string">'t serve HTTPS at all. (default 443)</span></span><br><span class="line"><span class="string">      --skip_headers                                            If true, avoid header prefixes in the log messages</span></span><br><span class="line"><span class="string">      --stderrthreshold severity                                logs at or above this threshold go to stderr</span></span><br><span class="line"><span class="string">      --tls-cert-file string                                    File containing the default x509 Certificate for HTTPS. (CA cert, if any, concatenated after server cert). If HTTPS serving is enabled, and --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to the directory specified by --cert-dir.</span></span><br><span class="line"><span class="string">      --tls-cipher-suites strings                               Comma-separated list of cipher suites for the server. If omitted, the default Go cipher suites will be use.  Possible values: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_RC4_128_SHA,TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_RC4_128_SHA,TLS_RSA_WITH_3DES_EDE_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA256,TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_RC4_128_SHA</span></span><br><span class="line"><span class="string">      --tls-min-version string                                  Minimum TLS version supported. Possible values: VersionTLS10, VersionTLS11, VersionTLS12</span></span><br><span class="line"><span class="string">      --tls-private-key-file string                             File containing the default x509 private key matching --tls-cert-file.</span></span><br><span class="line"><span class="string">      --tls-sni-cert-key namedCertKey                           A pair of x509 certificate and private key file paths, optionally suffixed with a list of domain patterns which are fully qualified domain names, possibly with prefixed wildcard segments. If no domain patterns are provided, the names of the certificate are extracted. Non-wildcard matches trump over wildcard matches, explicit domain patterns trump over extracted names. For multiple key/certificate pairs, use the --tls-sni-cert-key multiple times. Examples: "example.crt,example.key" or "foo.crt,foo.key:*.foo.com,foo.com". (default [])</span></span><br><span class="line"><span class="string">  -v, --v Level                                                 number for the log level verbosity</span></span><br><span class="line"><span class="string">      --vmodule moduleSpec                                      comma-separated list of pattern=N settings for file-filtered logging</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>metrics-server</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 dashboard</title>
    <url>/2019/09/16/k8s-v1-14-dashboard/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><p>kuberntes è‡ªå¸¦æ’ä»¶çš„ manifests yaml æ–‡ä»¶ä½¿ç”¨ gcr.io çš„ docker registryï¼Œå›½å†…è¢«å¢™ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä¸ºå…¶å®ƒ registry åœ°å€</p><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-src.tar.gz</span></span><br></pre></td></tr></table></figure><p>dashboard å¯¹åº”çš„ç›®å½•æ˜¯ï¼šcluster/addons/dashboardï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd cluster/addons/dashboard</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ service å®šä¹‰ï¼ŒæŒ‡å®šç«¯å£ç±»å‹ä¸º NodePortï¼Œè¿™æ ·å¤–ç•Œå¯ä»¥é€šè¿‡åœ°å€ NodeIP:NodePort è®¿é—® dashboardï¼›</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat dashboard-service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort <span class="comment"># å¢åŠ è¿™ä¸€è¡Œ</span></span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat dashboard-controller.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'docker/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: docker.io/xxlaila/kubernetes-dashboard-amd64:v1.10.0  <span class="comment">#ä¿®æ”¹è¿™ä¸€è¡Œ</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶"><a href="#æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶" class="headerlink" title="æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶"></a>æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls *.yaml</span></span><br><span class="line">dashboard-configmap.yaml  dashboard-controller.yaml  dashboard-rbac.yaml  dashboard-secret.yaml  dashboard-service.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f  .</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹åˆ†é…çš„-NodePort"><a href="#æŸ¥çœ‹åˆ†é…çš„-NodePort" class="headerlink" title="æŸ¥çœ‹åˆ†é…çš„ NodePort"></a>æŸ¥çœ‹åˆ†é…çš„ NodePort</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get deployment kubernetes-dashboard  -n kube-system</span></span><br><span class="line">NAME                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kubernetes-dashboard   1/1     1            1           5h10m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl --namespace kube-system get pods -o wide</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP             NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-5579b8778b-xw8m9                1/1     Running   1          5h15m   172.30.232.3   172.21.16.204   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-6cc78dfc99-hb4l5   1/1     Running   0          5h10m   172.30.176.3   172.21.16.240   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get services kubernetes-dashboard -n kube-system</span></span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.254.214.153   &lt;none&gt;        443:32533/TCP   5h10m</span><br></pre></td></tr></table></figure><ul><li>NodePort 32533 æ˜ å°„åˆ° dashboard pod 443 ç«¯å£ï¼›</li></ul><h3 id="æŸ¥çœ‹-dashboard-æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°"><a href="#æŸ¥çœ‹-dashboard-æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="æŸ¥çœ‹ dashboard æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°"></a>æŸ¥çœ‹ dashboard æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec --namespace kube-system -it kubernetes-dashboard-6cc78dfc99-hb4l5  -- /dashboard --help</span></span><br><span class="line">2019/09/16 09:51:33 Starting overwatch</span><br><span class="line">Usage of /dashboard:</span><br><span class="line">      --alsologtostderr                  <span class="built_in">log</span> to standard error as well as files</span><br><span class="line">      --api-log-level string             Level of API request logging. Should be one of <span class="string">'INFO|NONE|DEBUG'</span>. Default: <span class="string">'INFO'</span>. (default <span class="string">"INFO"</span>)</span><br><span class="line">      --apiserver-host string            The address of the Kubernetes Apiserver to connect to <span class="keyword">in</span> the format of protocol://address:port, e.g., http://localhost:8080. If not specified, the assumption is that the binary runs inside a Kubernetes cluster and <span class="built_in">local</span> discovery is attempted.</span><br><span class="line">      --authentication-mode strings      Enables authentication options that will be reflected on login screen. Supported values: token, basic. Default: token.Note that basic option should only be used <span class="keyword">if</span> apiserver has <span class="string">'--authorization-mode=ABAC'</span> and <span class="string">'--basic-auth-file'</span> flags <span class="built_in">set</span>. (default [token])</span><br><span class="line">      --auto-generate-certificates       When <span class="built_in">set</span> to <span class="literal">true</span>, Dashboard will automatically generate certificates used to serve HTTPS. Default: <span class="literal">false</span>.</span><br><span class="line">      --<span class="built_in">bind</span>-address ip                  The IP address on <span class="built_in">which</span> to serve the --secure-port (<span class="built_in">set</span> to 0.0.0.0 <span class="keyword">for</span> all interfaces). (default 0.0.0.0)</span><br><span class="line">      --default-cert-dir string          Directory path containing <span class="string">'--tls-cert-file'</span> and <span class="string">'--tls-key-file'</span> files. Used also when auto-generating certificates flag is <span class="built_in">set</span>. (default <span class="string">"/certs"</span>)</span><br><span class="line">      --<span class="built_in">disable</span>-settings-authorizer      When enabled, Dashboard settings page will not require user to be logged <span class="keyword">in</span> and authorized to access settings page.</span><br><span class="line">      --<span class="built_in">disable</span>-skip                     When enabled, the skip button on the login page will not be shown. Default: <span class="literal">false</span>.</span><br><span class="line">      --<span class="built_in">enable</span>-insecure-login            When enabled, Dashboard login view will also be shown when Dashboard is not served over HTTPS. Default: <span class="literal">false</span>.</span><br><span class="line">      --heapster-host string             The address of the Heapster Apiserver to connect to <span class="keyword">in</span> the format of protocol://address:port, e.g., http://localhost:8082. If not specified, the assumption is that the binary runs inside a Kubernetes cluster and service proxy will be used.</span><br><span class="line">      --insecure-bind-address ip         The IP address on <span class="built_in">which</span> to serve the --port (<span class="built_in">set</span> to 0.0.0.0 <span class="keyword">for</span> all interfaces). (default 127.0.0.1)</span><br><span class="line">      --insecure-port int                The port to listen to <span class="keyword">for</span> incoming HTTP requests. (default 9090)</span><br><span class="line">      --kubeconfig string                Path to kubeconfig file with authorization and master location information.</span><br><span class="line">      --log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace (default :0)</span><br><span class="line">      --log_dir string                   If non-empty, write <span class="built_in">log</span> files <span class="keyword">in</span> this directory</span><br><span class="line">      --logtostderr                      <span class="built_in">log</span> to standard error instead of files</span><br><span class="line">      --metric-client-check-period int   Time <span class="keyword">in</span> seconds that defines how often configured metric client health check should be run. Default: 30 seconds. (default 30)</span><br><span class="line">      --port int                         The secure port to listen to <span class="keyword">for</span> incoming HTTPS requests. (default 8443)</span><br><span class="line">      --stderrthreshold severity         logs at or above this threshold go to stderr (default 2)</span><br><span class="line">      --system-banner string             When non-empty displays message to Dashboard users. Accepts simple HTML tags. Default: <span class="string">''</span>.</span><br><span class="line">      --system-banner-severity string    Severity of system banner. Should be one of <span class="string">'INFO|WARNING|ERROR'</span>. Default: <span class="string">'INFO'</span>. (default <span class="string">"INFO"</span>)</span><br><span class="line">      --tls-cert-file string             File containing the default x509 Certificate <span class="keyword">for</span> HTTPS.</span><br><span class="line">      --tls-key-file string              File containing the default x509 private key matching --tls-cert-file.</span><br><span class="line">      --token-ttl int                    Expiration time (<span class="keyword">in</span> seconds) of JWE tokens generated by dashboard. Default: 15 min. 0 - never expires (default 900)</span><br><span class="line">  -v, --v Level                          <span class="built_in">log</span> level <span class="keyword">for</span> V logs</span><br><span class="line">      --vmodule moduleSpec               comma-separated list of pattern=N settings <span class="keyword">for</span> file-filtered logging</span><br><span class="line">pflag: <span class="built_in">help</span> requested</span><br><span class="line"><span class="built_in">command</span> terminated with <span class="built_in">exit</span> code 2</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashboard çš„ â€“authentication-mode æ”¯æŒ tokenã€basicï¼Œé»˜è®¤ä¸º tokenã€‚å¦‚æœä½¿ç”¨ basicï¼Œåˆ™ kube-apiserver å¿…é¡»é…ç½® â€“authorization-mode=ABAC å’Œ â€“basic-auth-file å‚æ•°</p><h3 id="è®¿é—®-dashboard"><a href="#è®¿é—®-dashboard" class="headerlink" title="è®¿é—® dashboard"></a>è®¿é—® dashboard</h3><p>ä½¿ç”¨httpsåè®®ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ä»»æ„nodeçš„ipåŠ ç«¯å£å³å¯è®¿é—®<br><img src="https://img.xxlaila.cn/1568961339763.jpg" alt="img"></p><h3 id="åˆ›å»ºç™»å½•-Dashboard-çš„-token-å’Œ-kubeconfig-é…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºç™»å½•-Dashboard-çš„-token-å’Œ-kubeconfig-é…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºç™»å½• Dashboard çš„ token å’Œ kubeconfig é…ç½®æ–‡ä»¶"></a>åˆ›å»ºç™»å½• Dashboard çš„ token å’Œ kubeconfig é…ç½®æ–‡ä»¶</h3><p>dashboard é»˜è®¤åªæ”¯æŒ token è®¤è¯ï¼ˆä¸æ”¯æŒ client è¯ä¹¦è®¤è¯ï¼‰ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨ Kubeconfig æ–‡ä»¶ï¼Œéœ€è¦å°† token å†™å…¥åˆ°è¯¥æ–‡ä»¶ã€‚</p><h4 id="åˆ›å»ºç™»å½•-token"><a href="#åˆ›å»ºç™»å½•-token" class="headerlink" title="åˆ›å»ºç™»å½• token"></a>åˆ›å»ºç™»å½• token</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create sa dashboard-admin -n kube-system</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span></span><br><span class="line"><span class="comment"># ADMIN_SECRET=$(kubectl get secrets -n kube-system | grep dashboard-admin | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># DASHBOARD_LOGIN_TOKEN=$(kubectl describe secret -n kube-system $&#123;ADMIN_SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;DASHBOARD_LOGIN_TOKEN&#125;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¾“å‡ºçš„ token ç™»å½• Dashboardã€‚</p><h3 id="åˆ›å»ºä½¿ç”¨-token-çš„-KubeConfig-æ–‡ä»¶"><a href="#åˆ›å»ºä½¿ç”¨-token-çš„-KubeConfig-æ–‡ä»¶" class="headerlink" title="åˆ›å»ºä½¿ç”¨ token çš„ KubeConfig æ–‡ä»¶"></a>åˆ›å»ºä½¿ç”¨ token çš„ KubeConfig æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°ï¼Œä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ Token</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials dashboard_user \</span><br><span class="line">  --token=<span class="variable">$&#123;DASHBOARD_LOGIN_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=dashboard_user \</span><br><span class="line">  --kubeconfig=dashboard.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context default --kubeconfig=dashboard.kubeconfig</span><br></pre></td></tr></table></figure><p>å¦‚å›¾:<br><img src="https://img.xxlaila.cn/1568961447890.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”¨ç”Ÿæˆçš„ dashboard.kubeconfig ç™»å½• Dashboardã€‚ç”±äºk8s é»˜è®¤çš„Dashboard 15åˆ†é’Ÿåå°±ä¼šå¼¹å‡ºï¼Œåˆè¦é‡æ–°ç™»å½•å’Œè·å–tokenéº»çƒ¦ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://xxlaila.github.io/2019/08/29/k8sé…ç½®Dashboard/" target="_blank" rel="noopener">k8sé…ç½®Dashboard</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14 dnsæ’ä»¶</title>
    <url>/2019/09/16/k8s-v1-14-dns%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="éƒ¨ç½²-coredns-æ’ä»¶"><a href="#éƒ¨ç½²-coredns-æ’ä»¶" class="headerlink" title="éƒ¨ç½² coredns æ’ä»¶"></a>éƒ¨ç½² coredns æ’ä»¶</h3><p><strong>æ³¨æ„:</strong></p><ul><li>kuberntes è‡ªå¸¦æ’ä»¶çš„ manifests yaml æ–‡ä»¶ä½¿ç”¨ gcr.io çš„ docker registryï¼Œå›½å†…è¢«å¢™ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ä¸ºå…¶å®ƒ registry åœ°å€;</li></ul><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>å°†ä¸‹è½½çš„ kubernetes-server-linux-amd64.tar.gz è§£å‹åï¼Œå†è§£å‹å…¶ä¸­çš„ kubernetes-src.tar.gz æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-src.tar.gz</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li>coredns ç›®å½•æ˜¯ cluster/addons/dns<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd cluster/addons/dns/coredns</span></span><br><span class="line"><span class="comment"># cp coredns.yaml.base coredns.yaml</span></span><br><span class="line"><span class="comment"># sed -i -e "s/__PILLAR__DNS__DOMAIN__/cluster.local/" -e "s/__PILLAR__DNS__SERVER__/10.254.0.2/" coredns.yaml</span></span><br><span class="line"><span class="comment"># sed -i "s/k8s.gcr.io/coredns/" coredns.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f coredns.yaml</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="æ£€æŸ¥-coredns-åŠŸèƒ½"><a href="#æ£€æŸ¥-coredns-åŠŸèƒ½" class="headerlink" title="æ£€æŸ¥ coredns åŠŸèƒ½"></a>æ£€æŸ¥ coredns åŠŸèƒ½</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get all -n kube-system</span></span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-5579b8778b-xw8m9                1/1     Running   1          5h7m</span><br><span class="line"></span><br><span class="line">NAME                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/kube-dns               ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   5h7m</span><br><span class="line"></span><br><span class="line">NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/coredns                1/1     1            1           5h7m</span><br><span class="line"></span><br><span class="line">NAME                                              DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/coredns-5579b8778b                1         1         1       5h7m</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-9fb46   1/1     Running   0          5h14m</span><br><span class="line">nginx-ds-bgfzt   1/1     Running   0          5h14m</span><br><span class="line">nginx-ds-t22wj   1/1     Running   0          5h14m</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -it exec nginx-ds-9fb46 bash</span></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># cat /etc/resolv.conf</span></span><br><span class="line">nameserver 10.254.0.2</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local openstacklocal novalocal</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping www.baidu.com</span></span><br><span class="line">PING www.wshifen.com (104.193.88.77): 48 data bytes</span><br><span class="line">56 bytes from 104.193.88.77: icmp_seq=0 ttl=45 time=191.953 ms</span><br><span class="line">56 bytes from 104.193.88.77: icmp_seq=1 ttl=45 time=191.680 ms</span><br><span class="line">^C--- www.wshifen.com ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 191.680/191.817/191.953/0.137 ms</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.120 ms</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=1 ttl=64 time=0.116 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.116/0.118/0.120/0.000 ms</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.079 ms</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=1 ttl=64 time=0.152 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.079/0.115/0.152/0.037 ms</span><br><span class="line"></span><br><span class="line">root@nginx-ds-9fb46:/<span class="comment"># ping kube-dns.kube-system.svc.cluster.local.</span></span><br><span class="line">PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 48 data bytes</span><br><span class="line">56 bytes from 10.254.0.2: icmp_seq=0 ttl=64 time=0.080 ms</span><br><span class="line">^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 0.080/0.080/0.080/0.000 ms</span><br><span class="line">`</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14 coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s v1.14é›†ç¾¤éªŒè¯</title>
    <url>/2019/09/16/k8s-v1-14%E9%9B%86%E7%BE%A4%E9%AA%8C%E8%AF%81/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="éªŒè¯é›†ç¾¤åŠŸèƒ½"><a href="#éªŒè¯é›†ç¾¤åŠŸèƒ½" class="headerlink" title="éªŒè¯é›†ç¾¤åŠŸèƒ½"></a>éªŒè¯é›†ç¾¤åŠŸèƒ½</h3><h3 id="æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€"><a href="#æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€"></a>æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   5h50m   v1.14.6</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   5h48m   v1.14.6</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   5h45m   v1.14.6</span><br></pre></td></tr></table></figure><p>éƒ½ä¸º Ready æ—¶æ­£å¸¸ã€‚</p><a id="more"></a><h3 id="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"><a href="#åˆ›å»ºæµ‹è¯•æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"></a>åˆ›å»ºæµ‹è¯•æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat nginx-ds.yml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f nginx-ds.yml</span></span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥å„èŠ‚ç‚¹çš„-Pod-IP-è¿é€šæ€§"><a href="#æ£€æŸ¥å„èŠ‚ç‚¹çš„-Pod-IP-è¿é€šæ€§" class="headerlink" title="æ£€æŸ¥å„èŠ‚ç‚¹çš„ Pod IP è¿é€šæ€§"></a>æ£€æŸ¥å„èŠ‚ç‚¹çš„ Pod IP è¿é€šæ€§</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods  -o wide|grep nginx-ds</span></span><br><span class="line">nginx-ds-9fb46   1/1     Running   0          5h2m   172.30.232.2   172.21.16.204   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-bgfzt   1/1     Running   0          5h2m   172.30.128.2   172.21.16.87    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-t22wj   1/1     Running   0          5h2m   172.30.176.2   172.21.16.240   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥æœåŠ¡-IP-å’Œç«¯å£å¯è¾¾æ€§"><a href="#æ£€æŸ¥æœåŠ¡-IP-å’Œç«¯å£å¯è¾¾æ€§" class="headerlink" title="æ£€æŸ¥æœåŠ¡ IP å’Œç«¯å£å¯è¾¾æ€§"></a>æ£€æŸ¥æœåŠ¡ IP å’Œç«¯å£å¯è¾¾æ€§</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc |grep nginx-ds</span></span><br><span class="line">nginx-ds     NodePort    10.254.232.104   &lt;none&gt;        80:30349/TCP   5h2m</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨åœ¨30349è¿›è¡Œè®¿é—®å¯ä»¥çœ‹åˆ°neinxçš„æ¬¢è¿ç•Œé¢</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-v1.14 nodeå®‰è£…</title>
    <url>/2019/09/16/kubernetes-v1-14-node%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="1ã€å®‰è£…docker"><a href="#1ã€å®‰è£…docker" class="headerlink" title="1ã€å®‰è£…docker"></a>1ã€å®‰è£…docker</h3><h4 id="1-1ã€å¢åŠ docker-æº"><a href="#1-1ã€å¢åŠ docker-æº" class="headerlink" title="1.1ã€å¢åŠ docker æº"></a>1.1ã€å¢åŠ docker æº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">  --add-repo \</span><br><span class="line">  https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h4 id="1-2ã€å®‰è£…docker"><a href="#1-2ã€å®‰è£…docker" class="headerlink" title="1.2ã€å®‰è£…docker"></a>1.2ã€å®‰è£…docker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  yum -y install docker-ce</span></span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-3ã€ä¿®æ”¹docker-systemd-unit-æ–‡ä»¶"><a href="#1-3ã€ä¿®æ”¹docker-systemd-unit-æ–‡ä»¶" class="headerlink" title="1.3ã€ä¿®æ”¹docker systemd unit æ–‡ä»¶"></a>1.3ã€ä¿®æ”¹docker systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/docker.service |egrep -Ev "^$|^#"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">BindsTo=containerd.service</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/run/flannel/docker</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>dockerd è¿è¡Œæ—¶ä¼šè°ƒç”¨å…¶å®ƒ docker å‘½ä»¤ï¼Œå¦‚ docker-proxyï¼Œæ‰€ä»¥éœ€è¦å°† docker å‘½ä»¤æ‰€åœ¨çš„ç›®å½•åŠ åˆ° PATH ç¯å¢ƒå˜é‡ä¸­ï¼›</li><li>flanneld å¯åŠ¨æ—¶å°†ç½‘ç»œé…ç½®å†™å…¥ /run/flannel/docker æ–‡ä»¶ä¸­ï¼Œdockerd å¯åŠ¨å‰è¯»å–è¯¥æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡ DOCKER_NETWORK_OPTIONS ï¼Œç„¶åè®¾ç½® docker0 ç½‘æ¡¥ç½‘æ®µï¼›</li><li>å¦‚æœæŒ‡å®šäº†å¤šä¸ª EnvironmentFile é€‰é¡¹ï¼Œåˆ™å¿…é¡»å°† /run/flannel/docker æ”¾åœ¨æœ€å(ç¡®ä¿ docker0 ä½¿ç”¨ flanneld ç”Ÿæˆçš„ bip å‚æ•°)ï¼›</li><li>docker éœ€è¦ä»¥ root ç”¨äºè¿è¡Œï¼›</li></ul><h4 id="1-4ã€å¯åŠ¨-docker-æœåŠ¡"><a href="#1-4ã€å¯åŠ¨-docker-æœåŠ¡" class="headerlink" title="1.4ã€å¯åŠ¨ docker æœåŠ¡"></a>1.4ã€å¯åŠ¨ docker æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable docker &amp;&amp; systemctl restart docker &amp;&amp; systemctl status docker</span></span><br></pre></td></tr></table></figure><h4 id="1-5ã€æ£€æŸ¥-docker0-ç½‘æ¡¥"><a href="#1-5ã€æ£€æŸ¥-docker0-ç½‘æ¡¥" class="headerlink" title="1.5ã€æ£€æŸ¥ docker0 ç½‘æ¡¥"></a>1.5ã€æ£€æŸ¥ docker0 ç½‘æ¡¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/sbin/ip addr show flannel.1 &amp;&amp; /usr/sbin/ip addr show docker0</span></span><br><span class="line">3: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether 8a:be:12:b9:ab:b8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.128.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:eb:ec:ae:94 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.128.1/21 brd 172.30.135.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h4 id="1-5ã€æŸ¥çœ‹-docker-çš„çŠ¶æ€ä¿¡æ¯"><a href="#1-5ã€æŸ¥çœ‹-docker-çš„çŠ¶æ€ä¿¡æ¯" class="headerlink" title="1.5ã€æŸ¥çœ‹ docker çš„çŠ¶æ€ä¿¡æ¯"></a>1.5ã€æŸ¥çœ‹ docker çš„çŠ¶æ€ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ps -elfH|grep docker</span></span><br><span class="line">0 S root      1436   975  0  80   0 - 28167 -      10:54 pts/0    00:00:00                 grep --color=auto docker</span><br><span class="line">4 S root      1265     1  1  80   0 - 122095 futex_ 10:54 ?       00:00:00   /usr/bin/dockerd --bip=172.30.112.1/21 --ip-masq=<span class="literal">false</span> --mtu=1450</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker info</span></span><br><span class="line">vClient:</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 0</span><br><span class="line">  Running: 0</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 0</span><br><span class="line"> Images: 0</span><br><span class="line"> Server Version: 18.09.6</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: xfs</span><br><span class="line">  Supports d_type: <span class="literal">true</span></span><br><span class="line">  Native Overlay Diff: <span class="literal">true</span></span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: <span class="built_in">local</span></span><br><span class="line">  Network: bridge host macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk syslog</span><br><span class="line"> Swarm: inactive</span><br><span class="line"> Runtimes: runc</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version: 894b81a4b802e4eb2a91d1ce216b8817763c29fb</span><br><span class="line"> runc version: 425e105d5a03fabd737a126ad93d62a9eeede87f</span><br><span class="line"> init version: fec3683</span><br><span class="line"> Security Options:</span><br><span class="line">  seccomp</span><br><span class="line">   Profile: default</span><br><span class="line"> Kernel Version: 4.4.193-1.el7.elrepo.x86_64</span><br><span class="line"> Operating System: CentOS Linux 7 (Core)</span><br><span class="line"> OSType: linux</span><br><span class="line"> Architecture: x86_64</span><br><span class="line"> CPUs: 4</span><br><span class="line"> Total Memory: 7.796GiB</span><br><span class="line"> Name: k8s-node-2.kxl</span><br><span class="line"> ID: GJEA:U6PT:NMHM:KWD2:DOIJ:U6XW:6N3U:4QZN:F5PT:CQXH:MZKU:VATL</span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Registry: https://index.docker.io/v1/</span><br><span class="line"> Labels:</span><br><span class="line"> Experimental: <span class="literal">false</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Live Restore Enabled: <span class="literal">false</span></span><br><span class="line"> Product License: Community Engine</span><br></pre></td></tr></table></figure><h3 id="2ã€éƒ¨ç½²-kubelet-ç»„ä»¶"><a href="#2ã€éƒ¨ç½²-kubelet-ç»„ä»¶" class="headerlink" title="2ã€éƒ¨ç½² kubelet ç»„ä»¶"></a>2ã€éƒ¨ç½² kubelet ç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet è¿è¡Œåœ¨æ¯ä¸ª worker èŠ‚ç‚¹ä¸Šï¼Œæ¥æ”¶ kube-apiserver å‘é€çš„è¯·æ±‚ï¼Œç®¡ç† Pod å®¹å™¨ï¼Œæ‰§è¡Œäº¤äº’å¼å‘½ä»¤ï¼Œå¦‚ execã€runã€logs ç­‰ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨æ—¶è‡ªåŠ¨å‘ kube-apiserver æ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œå†…ç½®çš„ cadvisor ç»Ÿè®¡å’Œç›‘æ§èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºç¡®ä¿å®‰å…¨ï¼Œéƒ¨ç½²æ—¶å…³é—­äº† kubelet çš„éå®‰å…¨ http ç«¯å£ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒï¼Œæ‹’ç»æœªæˆæƒçš„è®¿é—®(å¦‚ apiserverã€heapster çš„è¯·æ±‚)ã€‚</p><h4 id="2-1ã€åˆ›å»º-kubelet-bootstrap-kubeconfig-æ–‡ä»¶"><a href="#2-1ã€åˆ›å»º-kubelet-bootstrap-kubeconfig-æ–‡ä»¶" class="headerlink" title="2.1ã€åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶"></a>2.1ã€åˆ›å»º kubelet bootstrap kubeconfig æ–‡ä»¶</h4><p>NODE_NAMES é‡Œé¢çš„å€¼æ˜¯nodeçš„ä¸»æœºå</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># NODE_NAMES=(node-01 node-02 node-03)</span></span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»º token</span></span><br><span class="line">    <span class="built_in">export</span> BOOTSTRAP_TOKEN=$(kubeadm token create \</span><br><span class="line">      --description kubelet-bootstrap-token \</span><br><span class="line">      --groups system:bootstrappers:<span class="variable">$&#123;node_name&#125;</span> \</span><br><span class="line">      --kubeconfig ~/.kube/config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">      --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">      --embed-certs=<span class="literal">true</span> \</span><br><span class="line">      --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</span><br><span class="line">      --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">    kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">      --cluster=kubernetes \</span><br><span class="line">      --user=kubelet-bootstrap \</span><br><span class="line">      --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">    kubectl config use-context default --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for node_name in $&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">    scp kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig root@<span class="variable">$&#123;node_name&#125;</span>:/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li><p>å‘ kubeconfig å†™å…¥çš„æ˜¯ tokenï¼Œbootstrap ç»“æŸå kube-controller-manager ä¸º kubelet åˆ›å»º client å’Œ server è¯ä¹¦ï¼›</p></li><li><p>æŸ¥çœ‹ kubeadm ä¸ºå„èŠ‚ç‚¹åˆ›å»ºçš„ token:<br>master èŠ‚ç‚¹æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm token list --kubeconfig ~/.kube/config</span></span><br><span class="line">TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION               EXTRA GROUPS</span><br><span class="line">016e9x.306t91l832suzg8i   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-03</span><br><span class="line">4l4tcx.juy6qs9rmrnfpbig   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-01</span><br><span class="line">64pk36.vbhvbmtojpskyclt   19h       2019-09-17T11:29:43+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node-02</span><br></pre></td></tr></table></figure><ul><li>token æœ‰æ•ˆæœŸä¸º 1 å¤©ï¼Œè¶…æœŸåå°†ä¸èƒ½å†è¢«ç”¨æ¥ boostrap kubeletï¼Œä¸”ä¼šè¢« kube-controller-manager çš„ tokencleaner æ¸…ç†ï¼›</li><li>kube-apiserver æ¥æ”¶ kubelet çš„ bootstrap token åï¼Œå°†è¯·æ±‚çš„ user è®¾ç½®ä¸º system:bootstrap:<token>ï¼Œgroup è®¾ç½®ä¸º system:bootstrappersï¼Œåç»­å°†ä¸ºè¿™ä¸ª group è®¾ç½® ClusterRoleBindingï¼›</token></li></ul></li><li><p>æŸ¥çœ‹å„ token å…³è”çš„ Secretï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get secrets  -n kube-system|grep bootstrap-token</span></span><br><span class="line">bootstrap-token-016e9x                           bootstrap.kubernetes.io/token         7      4h25m</span><br><span class="line">bootstrap-token-4l4tcx                           bootstrap.kubernetes.io/token         7      4h25m</span><br><span class="line">bootstrap-token-64pk36                           bootstrap.kubernetes.io/token         7      4h25m</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2ã€åˆ›å»ºå’Œåˆ†å‘-kubelet-å‚æ•°é…ç½®æ–‡ä»¶"><a href="#2-2ã€åˆ›å»ºå’Œåˆ†å‘-kubelet-å‚æ•°é…ç½®æ–‡ä»¶" class="headerlink" title="2.2ã€åˆ›å»ºå’Œåˆ†å‘ kubelet å‚æ•°é…ç½®æ–‡ä»¶"></a>2.2ã€åˆ›å»ºå’Œåˆ†å‘ kubelet å‚æ•°é…ç½®æ–‡ä»¶</h4><p>ä» v1.10 å¼€å§‹ï¼Œéƒ¨åˆ† kubelet å‚æ•°éœ€åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œkubelet â€“help ä¼šæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DEPRECATED: This parameter should be <span class="built_in">set</span> via the config file specified by the Kubelet<span class="string">'s --config flag</span></span><br></pre></td></tr></table></figure><ul><li><p>åˆ›å»º kubelet å‚æ•°é…ç½®æ–‡ä»¶æ¨¡æ¿</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kubelet-config.yaml</span></span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: <span class="string">"0.0.0.0"</span></span><br><span class="line">staticPodPath: <span class="string">""</span></span><br><span class="line">syncFrequency: 1m</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">staticPodURL: <span class="string">""</span></span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 0</span><br><span class="line">rotateCertificates: <span class="literal">true</span></span><br><span class="line">serverTLSBootstrap: <span class="literal">true</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">registryPullQPS: 0</span><br><span class="line">registryBurst: 20</span><br><span class="line">eventRecordQPS: 0</span><br><span class="line">eventBurst: 20</span><br><span class="line">enableDebuggingHandlers: <span class="literal">true</span></span><br><span class="line">enableContentionProfiling: <span class="literal">true</span></span><br><span class="line">healthzPort: 10248</span><br><span class="line">healthzBindAddress: <span class="string">"172.21.16.87"</span> <span class="comment"># nodeèŠ‚ç‚¹ip</span></span><br><span class="line">clusterDomain: <span class="string">"cluster.local"</span></span><br><span class="line">clusterDNS:</span><br><span class="line">  - <span class="string">"10.254.0.2"</span></span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">nodeStatusReportFrequency: 1m</span><br><span class="line">imageMinimumGCAge: 2m</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">volumeStatsAggPeriod: 1m</span><br><span class="line">kubeletCgroups: <span class="string">""</span></span><br><span class="line">systemCgroups: <span class="string">""</span></span><br><span class="line">cgroupRoot: <span class="string">""</span></span><br><span class="line">cgroupsPerQOS: <span class="literal">true</span></span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">runtimeRequestTimeout: 10m</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">maxPods: 100</span><br><span class="line">podCIDR: <span class="string">"172.30.0.0/16"</span></span><br><span class="line">podPidsLimit: -1</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">kubeAPIQPS: 1000</span><br><span class="line">kubeAPIBurst: 2000</span><br><span class="line">serializeImagePulls: <span class="literal">false</span></span><br><span class="line">evictionHard:</span><br><span class="line">  memory.available:  <span class="string">"100Mi"</span></span><br><span class="line">nodefs.available:  <span class="string">"10%"</span></span><br><span class="line">nodefs.inodesFree: <span class="string">"5%"</span></span><br><span class="line">imagefs.available: <span class="string">"15%"</span></span><br><span class="line">evictionSoft: &#123;&#125;</span><br><span class="line">enableControllerAttachDetach: <span class="literal">true</span></span><br><span class="line">failSwapOn: <span class="literal">true</span></span><br><span class="line">containerLogMaxSize: 20Mi</span><br><span class="line">containerLogMaxFiles: 10</span><br><span class="line">systemReserved: &#123;&#125;</span><br><span class="line">kubeReserved: &#123;&#125;</span><br><span class="line">systemReservedCgroup: <span class="string">""</span></span><br><span class="line">kubeReservedCgroup: <span class="string">""</span></span><br><span class="line">enforceNodeAllocatable: [<span class="string">"pods"</span>]</span><br></pre></td></tr></table></figure><ul><li>addressï¼škubelet å®‰å…¨ç«¯å£ï¼ˆhttpsï¼Œ10250ï¼‰ç›‘å¬çš„åœ°å€ï¼Œä¸èƒ½ä¸º 127.0.0.1ï¼Œå¦åˆ™ kube-apiserverã€heapster ç­‰ä¸èƒ½è°ƒç”¨ kubelet çš„ APIï¼›</li><li>readOnlyPort=0ï¼šå…³é—­åªè¯»ç«¯å£(é»˜è®¤ 10255)ï¼Œç­‰æ•ˆä¸ºæœªæŒ‡å®šï¼›</li><li>authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åï¿½è®¿é—® 10250 ç«¯å£ï¼›</li><li>authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTP è¯ä¹¦è®¤è¯ï¼›</li><li>authentication.webhook.enabled=trueï¼šå¼€å¯ HTTPs bearer token è®¤è¯ï¼›</li><li>å¯¹äºæœªé€šè¿‡ x509 è¯ä¹¦å’Œ webhook è®¤è¯çš„è¯·æ±‚(kube-apiserver æˆ–å…¶ä»–å®¢æˆ·ç«¯)ï¼Œå°†è¢«æ‹’ç»ï¼Œæç¤º Unauthorizedï¼›</li><li>authroization.mode=Webhookï¼škubelet ä½¿ç”¨ SubjectAccessReview API æŸ¥è¯¢ kube-apiserver æŸ userã€group æ˜¯å¦å…·æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</li><li>featureGates.RotateKubeletClientCertificateã€featureGates.RotateKubeletServerCertificateï¼šè‡ªåŠ¨ rotate è¯ä¹¦ï¼Œè¯ä¹¦çš„æœ‰æ•ˆæœŸå–å†³äº kube-controller-manager çš„ â€“experimental-cluster-signing-duration å‚æ•°ï¼›</li><li>éœ€è¦ root è´¦æˆ·è¿è¡Œï¼›</li></ul></li></ul><h4 id="2-3ã€åˆ›å»ºkubelet-systemd-unit-æ–‡ä»¶"><a href="#2-3ã€åˆ›å»ºkubelet-systemd-unit-æ–‡ä»¶" class="headerlink" title="2.3ã€åˆ›å»ºkubelet systemd unit æ–‡ä»¶"></a>2.3ã€åˆ›å»ºkubelet systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kubelet.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kubelet</span><br><span class="line">ExecStart=/usr/bin/kubelet \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \</span><br><span class="line">  --cert-dir=/etc/kubernetes/ssl \</span><br><span class="line">  --cni-conf-dir=/etc/cni/net.d \</span><br><span class="line">  --container-runtime=docker \</span><br><span class="line">  --container-runtime-endpoint=unix:///var/run/dockershim.sock \</span><br><span class="line">  --root-dir=/var/lib/kubelet \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  --config=/etc/kubernetes/kubelet-config.yaml \</span><br><span class="line">  --hostname-override=172.21.16.87 \ <span class="comment"># node èŠ‚ç‚¹ip</span></span><br><span class="line">  --pod-infra-container-image=registry.cn-beijing.aliyuncs.com/images_k8s/pause-amd64:3.1 \</span><br><span class="line">  --image-pull-progress-deadline=15m \</span><br><span class="line">  --volume-plugin-dir=/var/lib/kubelet/kubelet-plugins/volume/<span class="built_in">exec</span>/ \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœè®¾ç½®äº† â€“hostname-override é€‰é¡¹ï¼Œåˆ™ kube-proxy ä¹Ÿéœ€è¦è®¾ç½®è¯¥é€‰é¡¹ï¼Œå¦åˆ™ä¼šå‡ºç°æ‰¾ä¸åˆ° Node çš„æƒ…å†µï¼›</li><li>â€“bootstrap-kubeconfigï¼šæŒ‡å‘ bootstrap kubeconfig æ–‡ä»¶ï¼Œkubelet ä½¿ç”¨è¯¥æ–‡ä»¶ä¸­çš„ç”¨æˆ·åå’Œ token å‘ kube-apiserver å‘é€ TLS Bootstrapping è¯·æ±‚ï¼›</li><li>K8S approve kubelet çš„ csr è¯·æ±‚åï¼Œåœ¨ â€“cert-dir ç›®å½•åˆ›å»ºè¯ä¹¦å’Œç§é’¥æ–‡ä»¶ï¼Œç„¶åå†™å…¥ â€“kubeconfig æ–‡ä»¶ï¼›</li><li>â€“pod-infra-container-image ä¸ä½¿ç”¨ redhat çš„ pod-infrastructure:latest é•œåƒï¼Œå®ƒä¸èƒ½å›æ”¶å®¹å™¨çš„åƒµå°¸ï¼›</li></ul><h4 id="2-4ã€Bootstrap-Token-Auth-å’Œæˆäºˆæƒé™"><a href="#2-4ã€Bootstrap-Token-Auth-å’Œæˆäºˆæƒé™" class="headerlink" title="2.4ã€Bootstrap Token Auth å’Œæˆäºˆæƒé™"></a>2.4ã€Bootstrap Token Auth å’Œæˆäºˆæƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨æ—¶æŸ¥æ‰¾ â€“kubeletconfig å‚æ•°å¯¹åº”çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ â€“bootstrap-kubeconfig æŒ‡å®šçš„ kubeconfig æ–‡ä»¶å‘ kube-apiserver å‘é€è¯ä¹¦ç­¾åè¯·æ±‚ (CSR)ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-apiserver æ”¶åˆ° CSR è¯·æ±‚åï¼Œå¯¹å…¶ä¸­çš„ Token è¿›è¡Œè®¤è¯ï¼Œè®¤è¯é€šè¿‡åå°†è¯·æ±‚çš„ user è®¾ç½®ä¸º system:bootstrap:<token>ï¼Œgroup è®¾ç½®ä¸º system:bootstrappersï¼Œè¿™ä¸€è¿‡ç¨‹ç§°ä¸º Bootstrap Token Authã€‚</token></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ª user å’Œ group æ²¡æœ‰åˆ›å»º CSR çš„æƒé™ï¼Œkubelet å¯åŠ¨å¤±è´¥ï¼Œé”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.858672   20385 reflector.go:126] k8s.io/client-go/informers/factory.go:133: Failed to list *v1beta1.RuntimeClass: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.860429   20385 reflector.go:126] k8s.io/client-go/informers/factory.go:133: Failed to list *v1beta1.CSIDriver: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.903098   20385 kubelet.go:2244] node <span class="string">"172.21.16.240"</span> not found</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.985568   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/kubelet.go:442: Failed to list *v1.Service: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.986781   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: Failed to list *v1.Pod: Unauthorized</span><br><span class="line">Sep 16 11:39:43 node-02 kubelet[20385]: E0916 11:39:43.987454   20385 reflector.go:126] k8s.io/kubernetes/pkg/kubelet/kubelet.go:451: Failed to list *v1.Node: Unauthorized</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•æ˜¯ï¼šåˆ›å»ºä¸€ä¸ª clusterrolebindingï¼Œå°† group system:bootstrappers å’Œ clusterrole system:node-bootstrapper ç»‘å®šï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span></span><br></pre></td></tr></table></figure><h4 id="2-5ã€å¯åŠ¨-kubelet-æœåŠ¡"><a href="#2-5ã€å¯åŠ¨-kubelet-æœåŠ¡" class="headerlink" title="2.5ã€å¯åŠ¨ kubelet æœåŠ¡"></a>2.5ã€å¯åŠ¨ kubelet æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kubelet</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet &amp;&amp; systemctl status kubelet</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æœåŠ¡å‰å¿…é¡»å…ˆåˆ›å»ºå·¥ä½œç›®å½•ï¼›</li><li>å…³é—­ swap åˆ†åŒºï¼Œå¦åˆ™ kubelet ä¼šå¯åŠ¨å¤±è´¥ï¼›</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet å¯åŠ¨åä½¿ç”¨ â€“bootstrap-kubeconfig å‘ kube-apiserver å‘é€ CSR è¯·æ±‚ï¼Œå½“è¿™ä¸ª CSR è¢« approve åï¼Œkube-controller-manager ä¸º kubelet åˆ›å»º TLS å®¢æˆ·ç«¯è¯ä¹¦ã€ç§é’¥å’Œ â€“kubeletconfig æ–‡ä»¶ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>æ³¨æ„</strong>ï¼škube-controller-manager éœ€è¦é…ç½® â€“cluster-signing-cert-file å’Œ â€“cluster-signing-key-file å‚æ•°ï¼Œæ‰ä¼šä¸º TLS Bootstrap åˆ›å»ºè¯ä¹¦å’Œç§é’¥ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                 CONDITION</span><br><span class="line">csr-bwcbm   82s     system:bootstrap:016e9x   Pending</span><br><span class="line">csr-gqdhf   105s    system:bootstrap:64pk36   Pending</span><br><span class="line">csr-q995g   6m57s   system:bootstrap:4l4tcx   Pending</span><br><span class="line">csr-xx45v   7m33s   system:bootstrap:4l4tcx   Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure><h4 id="2-6ã€è‡ªåŠ¨-approve-CSR-è¯·æ±‚"><a href="#2-6ã€è‡ªåŠ¨-approve-CSR-è¯·æ±‚" class="headerlink" title="2.6ã€è‡ªåŠ¨ approve CSR è¯·æ±‚"></a>2.6ã€è‡ªåŠ¨ approve CSR è¯·æ±‚</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/csr-crb.yaml</span></span><br><span class="line"><span class="comment"># Approve all CSRs for the group "system:bootstrappers"</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: auto-approve-csrs-for-group</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:bootstrappers</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own credentials</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: node-client-cert-renewal</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:nodes</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="comment"># serving cert matching its client cert.</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: approve-node-server-renewal-csr</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  resources: [<span class="string">"certificatesigningrequests/selfnodeserver"</span>]</span><br><span class="line">  verbs: [<span class="string">"create"</span>]</span><br><span class="line">---</span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own server credentials</span></span><br><span class="line"> kind: ClusterRoleBinding</span><br><span class="line"> apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"> metadata:</span><br><span class="line">   name: node-server-cert-renewal</span><br><span class="line"> subjects:</span><br><span class="line"> - kind: Group</span><br><span class="line">   name: system:nodes</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br><span class="line"> roleRef:</span><br><span class="line">   kind: ClusterRole</span><br><span class="line">   name: approve-node-server-renewal-csr</span><br><span class="line">   apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure><ul><li>auto-approve-csrs-for-groupï¼šè‡ªåŠ¨ approve node çš„ç¬¬ä¸€æ¬¡ CSRï¼› æ³¨æ„ç¬¬ä¸€æ¬¡ CSR æ—¶ï¼Œè¯·æ±‚çš„ Group ä¸º system:bootstrappersï¼›</li><li>node-client-cert-renewalï¼šè‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ client è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodes;</li><li>node-server-cert-renewalï¼šè‡ªåŠ¨ approve node åç»­è¿‡æœŸçš„ server è¯ä¹¦ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ Group ä¸º system:nodes;</li></ul><h4 id="2-6ã€ç­‰æŸ¥çœ‹-kubelet-çš„æƒ…å†µ"><a href="#2-6ã€ç­‰æŸ¥çœ‹-kubelet-çš„æƒ…å†µ" class="headerlink" title="2.6ã€ç­‰æŸ¥çœ‹ kubelet çš„æƒ…å†µ"></a>2.6ã€ç­‰æŸ¥çœ‹ kubelet çš„æƒ…å†µ</h4><p>å¾…ä¸€æ®µæ—¶é—´(1-10 åˆ†é’Ÿ)ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„ CSR éƒ½è¢«è‡ªåŠ¨ approvedï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                   CONDITION</span><br><span class="line">csr-2t4bj   2m58s   system:node:172.21.16.240   Pending</span><br><span class="line">csr-2z2mq   4m14s   system:node:172.21.16.204   Pending</span><br><span class="line">csr-bwcbm   6m6s    system:bootstrap:016e9x     Approved,Issued</span><br><span class="line">csr-gqdhf   6m29s   system:bootstrap:64pk36     Approved,Issued</span><br><span class="line">csr-q995g   11m     system:bootstrap:4l4tcx     Approved,Issued</span><br><span class="line">csr-xx45v   12m     system:bootstrap:4l4tcx     Pending</span><br></pre></td></tr></table></figure><ul><li>æ‰€æœ‰èŠ‚ç‚¹å‡ readyï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   4m17s   v1.14.6</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   3m2s    v1.14.6</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   3s      v1.14.6</span><br></pre></td></tr></table></figure></li></ul><p>kube-controller-manager ä¸ºå„ node ç”Ÿæˆäº† kubeconfig æ–‡ä»¶å’Œå…¬ç§é’¥ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -l /etc/kubernetes/kubelet.kubeconfig</span></span><br><span class="line">-rw------- 1 root root 2311 Sep 16 11:31 /etc/kubernetes/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls -l /etc/kubernetes/ssl/|grep kubelet</span></span><br><span class="line">-rw------- 1 root root 1281 Sep 16 11:43 kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:43 kubelet-client-current.pem -&gt; /etc/kubernetes/ssl/kubelet-client-2019-09-16-11-43-20.pem</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆ kubelet server è¯ä¹¦ï¼›</p><h4 id="2-8ã€æ‰‹åŠ¨-approve-server-cert-csr"><a href="#2-8ã€æ‰‹åŠ¨-approve-server-cert-csr" class="headerlink" title="2.8ã€æ‰‹åŠ¨ approve server cert csr"></a>2.8ã€æ‰‹åŠ¨ approve server cert csr</h4><p>åŸºäº<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#kubelet-configuratio" target="_blank" rel="noopener">å®‰å…¨æ€§è€ƒè™‘</a>ï¼ŒCSR approving controllers ä¸ä¼šè‡ªåŠ¨ approve kubelet server è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œéœ€è¦æ‰‹åŠ¨ approveï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                   CONDITION</span><br><span class="line">csr-2t4bj   3m5s    system:node:172.21.16.240   Pending</span><br><span class="line">csr-2z2mq   4m21s   system:node:172.21.16.204   Pending</span><br><span class="line">csr-bwcbm   6m13s   system:bootstrap:016e9x     Approved,Issued</span><br><span class="line">csr-gqdhf   6m36s   system:bootstrap:64pk36     Approved,Issued</span><br><span class="line">csr-gtkrt   7s      system:node:172.21.16.87    Pending</span><br><span class="line">csr-q995g   11m     system:bootstrap:4l4tcx     Approved,Issued</span><br><span class="line">csr-xx45v   12m     system:bootstrap:4l4tcx     Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-2t4bj</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-2t4bj approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-2z2mq </span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-2z2mq approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl certificate approve csr-gtkrt</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-gtkrt approved</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls -l /etc/kubernetes/ssl/|grep kubelet</span></span><br><span class="line">-rw------- 1 root root 1281 Sep 16 11:43 kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:43 kubelet-client-current.pem -&gt; /etc/kubernetes/ssl/kubelet-client-2019-09-16-11-43-20.pem</span><br><span class="line">-rw------- 1 root root 1305 Sep 16 11:44 kubelet-server-2019-09-16-11-44-12.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Sep 16 11:44 kubelet-server-current.pem -&gt; /etc/kubernetes/ssl/kubelet-server-2019-09-16-11-44-12.pem</span><br></pre></td></tr></table></figure><h4 id="2-9ã€kubelet-æä¾›çš„-API-æ¥å£"><a href="#2-9ã€kubelet-æä¾›çš„-API-æ¥å£" class="headerlink" title="2.9ã€kubelet æä¾›çš„ API æ¥å£"></a>2.9ã€kubelet æä¾›çš„ API æ¥å£</h4><p>kubelet å¯åŠ¨åç›‘å¬å¤šä¸ªç«¯å£ï¼Œç”¨äºæ¥æ”¶ kube-apiserver æˆ–å…¶å®ƒå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kubelet</span></span><br><span class="line">tcp        0      0 127.0.0.1:43042         0.0.0.0:*               LISTEN      22726/kubelet       </span><br><span class="line">tcp        0      0 172.21.16.87:10248      0.0.0.0:*               LISTEN      22726/kubelet       </span><br><span class="line">tcp6       0      0 :::10250                :::*                    LISTEN      22726/kubelet</span><br></pre></td></tr></table></figure><ul><li>10248: healthz http æœåŠ¡ï¼›</li><li>10250: https æœåŠ¡ï¼Œè®¿é—®è¯¥ç«¯å£æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼ˆå³ä½¿è®¿é—® /healthz ä¹Ÿéœ€è¦ï¼‰ï¼›</li><li>æœªå¼€å¯åªè¯»ç«¯å£ 10255ï¼›</li><li>ä» K8S v1.10 å¼€å§‹ï¼Œå»é™¤äº† â€“cadvisor-port å‚æ•°ï¼ˆé»˜è®¤ 4194 ç«¯å£ï¼‰ï¼Œä¸æ”¯æŒè®¿é—® cAdvisor UI &amp; APIã€‚</li></ul><p>ç”±äºå…³é—­äº†åŒ¿åè®¤è¯ï¼ŒåŒæ—¶å¼€å¯äº† webhook æˆæƒï¼Œæ‰€æœ‰è®¿é—® 10250 ç«¯å£ https API çš„è¯·æ±‚éƒ½éœ€è¦è¢«è®¤è¯å’Œæˆæƒã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¢„å®šä¹‰çš„ ClusterRole system:kubelet-api-admin æˆäºˆè®¿é—® kubelet æ‰€æœ‰ API çš„æƒé™(kube-apiserver ä½¿ç”¨çš„ kubernetes è¯ä¹¦ User æˆäºˆäº†è¯¥æƒé™)ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kubelet-api-admin</span></span><br><span class="line">Name:         system:kubelet-api-admin</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources      Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------      -----------------  --------------  -----</span><br><span class="line">  nodes/<span class="built_in">log</span>      []                 []              [*]</span><br><span class="line">  nodes/metrics  []                 []              [*]</span><br><span class="line">  nodes/proxy    []                 []              [*]</span><br><span class="line">  nodes/spec     []                 []              [*]</span><br><span class="line">  nodes/stats    []                 []              [*]</span><br><span class="line">  nodes          []                 []              [get list watch proxy]</span><br></pre></td></tr></table></figure><h4 id="2-10ã€kubelet-api-è®¤è¯å’Œæˆæƒ"><a href="#2-10ã€kubelet-api-è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.10ã€kubelet api è®¤è¯å’Œæˆæƒ"></a>2.10ã€kubelet api è®¤è¯å’Œæˆæƒ</h4><p>kubelet é…ç½®äº†å¦‚ä¸‹è®¤è¯å‚æ•°:</p><ul><li>authentication.anonymous.enabledï¼šè®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åè®¿é—® 10250 ç«¯å£ï¼›</li><li>authentication.x509.clientCAFileï¼šæŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTPs è¯ä¹¦è®¤è¯ï¼›</li><li>authentication.webhook.enabled=trueï¼šå¼€å¯ HTTPs bearer token è®¤è¯ï¼›</li></ul><p>åŒæ—¶é…ç½®äº†å¦‚ä¸‹æˆæƒå‚æ•°:</p><ul><li>authroization.mode=Webhookï¼šå¼€å¯ RBAC æˆæƒ</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubelet æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ clientCAFile å¯¹è¯ä¹¦ç­¾åè¿›è¡Œè®¤è¯ï¼Œæˆ–è€…æŸ¥è¯¢ bearer token æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœä¸¤è€…éƒ½æ²¡é€šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚ï¼Œæç¤º Unauthorizedï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line">Unauthorized</span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem -H "Authorization: Bearer 123456"  https://172.21.16.87:10250/metrics</span></span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡è®¤è¯åï¼Œkubelet ä½¿ç”¨ SubjectAccessReview API å‘ kube-apiserver å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢è¯ä¹¦æˆ– token å¯¹åº”çš„ userã€group æ˜¯å¦æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</p><h4 id="2-11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ"><a href="#2-11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ"></a>2.11ã€è¯ä¹¦è®¤è¯å’Œæˆæƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æƒé™ä¸è¶³çš„è¯ä¹¦ï¼›</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/kube-controller-manager.pem --key /etc/kubernetes/ssl/kube-controller-manager-key.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line">Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼›</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.16.87:10250/metrics</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><ul><li>â€“cacertã€â€“certã€â€“key çš„å‚æ•°å€¼å¿…é¡»æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ä¸Šé¢çš„ ./admin.pem ä¸èƒ½çœç•¥ ./ï¼Œå¦åˆ™è¿”å› 401 Unauthorizedï¼›</li></ul><h4 id="2-12ã€bear-token-è®¤è¯å’Œæˆæƒ"><a href="#2-12ã€bear-token-è®¤è¯å’Œæˆæƒ" class="headerlink" title="2.12ã€bear token è®¤è¯å’Œæˆæƒ"></a>2.12ã€bear token è®¤è¯å’Œæˆæƒ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ª ServiceAccountï¼Œå°†å®ƒå’Œ ClusterRole system:kubelet-api-admin ç»‘å®šï¼Œä»è€Œå…·æœ‰è°ƒç”¨ kubelet API çš„æƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create sa kubelet-api-test</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding kubelet-api-test --clusterrole=system:kubelet-api-admin --serviceaccount=default:kubelet-api-test</span></span><br><span class="line"><span class="comment"># SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># TOKEN=$(kubectl describe secret $&#123;SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;TOKEN&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem -H "Authorization: Bearer $&#123;TOKEN&#125;" https://172.21.16.87:10250/metrics|head</span></span><br></pre></td></tr></table></figure><h3 id="3ã€cadvisor-å’Œ-metrics"><a href="#3ã€cadvisor-å’Œ-metrics" class="headerlink" title="3ã€cadvisor å’Œ metrics"></a>3ã€cadvisor å’Œ metrics</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cadvisor æ˜¯å†…åµŒåœ¨ kubelet äºŒè¿›åˆ¶ä¸­çš„ï¼Œç»Ÿè®¡æ‰€åœ¨èŠ‚ç‚¹å„å®¹å™¨çš„èµ„æº(CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘å¡)ä½¿ç”¨æƒ…å†µçš„æœåŠ¡ã€‚<br>æµè§ˆå™¨è®¿é—® <a href="https://172.21.16.87:10250/metrics" target="_blank" rel="noopener">https://172.21.16.87:10250/metrics</a> å’Œ <a href="https://172.21.16.87:10250/metrics/cadvisor" target="_blank" rel="noopener">https://172.21.16.87:10250/metrics/cadvisor</a> åˆ†åˆ«è¿”å› kubelet å’Œ cadvisor çš„ metricsã€‚<br><img src="https://img.xxlaila.cn/1568624798589.jpg" alt="img"></p><p><strong>æ³¨æ„:</strong></p><ul><li>kubelet.config.json è®¾ç½® authentication.anonymous.enabled ä¸º falseï¼Œä¸å…è®¸åŒ¿åè¯ä¹¦è®¿é—® 10250 çš„ https æœåŠ¡ï¼›</li><li>å‚è€ƒ<a href="https://xxlaila.github.io/2019/09/04/kubeletæä¾›apiè¯·æ±‚æ¥å£/" target="_blank" rel="noopener">kubeletæä¾›apiè¯·æ±‚æ¥å£</a>ï¼Œåˆ›å»ºå’Œå¯¼å…¥ç›¸å…³è¯ä¹¦ï¼Œç„¶åè®¿é—®ä¸Šé¢çš„ 10250 ç«¯å£ï¼›</li></ul><h4 id="3-1ã€è·å–-kubelet-çš„é…ç½®"><a href="#3-1ã€è·å–-kubelet-çš„é…ç½®" class="headerlink" title="3.1ã€è·å– kubelet çš„é…ç½®"></a>3.1ã€è·å– kubelet çš„é…ç½®</h4><p>ä» kube-apiserver è·å–å„èŠ‚ç‚¹ kubelet çš„é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ï¼›</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># curl -sSL --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem $&#123;KUBE_APISERVER&#125;/api/v1/nodes/172.21.16.87/proxy/configz | jq  '.kubeletconfig|.kind="KubeletConfiguration"|.apiVersion="kubelet.config.k8s.io/v1beta1"'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"syncFrequency"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"fileCheckFrequency"</span>: <span class="string">"20s"</span>,</span><br><span class="line">  <span class="string">"httpCheckFrequency"</span>: <span class="string">"20s"</span>,</span><br><span class="line">  <span class="string">"address"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">  <span class="string">"port"</span>: 10250,</span><br><span class="line">  <span class="string">"rotateCertificates"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"serverTLSBootstrap"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"authentication"</span>: &#123;</span><br><span class="line">    <span class="string">"x509"</span>: &#123;</span><br><span class="line">      <span class="string">"clientCAFile"</span>: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"cacheTTL"</span>: <span class="string">"2m0s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"anonymous"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"authorization"</span>: &#123;</span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"Webhook"</span>,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"cacheAuthorizedTTL"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">      <span class="string">"cacheUnauthorizedTTL"</span>: <span class="string">"30s"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"registryPullQPS"</span>: 0,</span><br><span class="line">  <span class="string">"registryBurst"</span>: 20,</span><br><span class="line">  <span class="string">"eventRecordQPS"</span>: 0,</span><br><span class="line">  <span class="string">"eventBurst"</span>: 20,</span><br><span class="line">  <span class="string">"enableDebuggingHandlers"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"enableContentionProfiling"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"healthzPort"</span>: 10248,</span><br><span class="line">  <span class="string">"healthzBindAddress"</span>: <span class="string">"172.21.16.87"</span>,</span><br><span class="line">  <span class="string">"oomScoreAdj"</span>: -999,</span><br><span class="line">  <span class="string">"clusterDomain"</span>: <span class="string">"cluster.local"</span>,</span><br><span class="line">  <span class="string">"clusterDNS"</span>: [</span><br><span class="line">    <span class="string">"10.254.0.2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"streamingConnectionIdleTimeout"</span>: <span class="string">"4h0m0s"</span>,</span><br><span class="line">  <span class="string">"nodeStatusUpdateFrequency"</span>: <span class="string">"10s"</span>,</span><br><span class="line">  <span class="string">"nodeStatusReportFrequency"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"nodeLeaseDurationSeconds"</span>: 40,</span><br><span class="line">  <span class="string">"imageMinimumGCAge"</span>: <span class="string">"2m0s"</span>,</span><br><span class="line">  <span class="string">"imageGCHighThresholdPercent"</span>: 85,</span><br><span class="line">  <span class="string">"imageGCLowThresholdPercent"</span>: 80,</span><br><span class="line">  <span class="string">"volumeStatsAggPeriod"</span>: <span class="string">"1m0s"</span>,</span><br><span class="line">  <span class="string">"cgroupsPerQOS"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"cgroupDriver"</span>: <span class="string">"cgroupfs"</span>,</span><br><span class="line">  <span class="string">"cpuManagerPolicy"</span>: <span class="string">"none"</span>,</span><br><span class="line">  <span class="string">"cpuManagerReconcilePeriod"</span>: <span class="string">"10s"</span>,</span><br><span class="line">  <span class="string">"runtimeRequestTimeout"</span>: <span class="string">"10m0s"</span>,</span><br><span class="line">  <span class="string">"hairpinMode"</span>: <span class="string">"promiscuous-bridge"</span>,</span><br><span class="line">  <span class="string">"maxPods"</span>: 100,</span><br><span class="line">  <span class="string">"podCIDR"</span>: <span class="string">"172.30.0.0/16"</span>,</span><br><span class="line">  <span class="string">"podPidsLimit"</span>: -1,</span><br><span class="line">  <span class="string">"resolvConf"</span>: <span class="string">"/etc/resolv.conf"</span>,</span><br><span class="line">  <span class="string">"cpuCFSQuota"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"cpuCFSQuotaPeriod"</span>: <span class="string">"100ms"</span>,</span><br><span class="line">  <span class="string">"maxOpenFiles"</span>: 1000000,</span><br><span class="line">  <span class="string">"contentType"</span>: <span class="string">"application/vnd.kubernetes.protobuf"</span>,</span><br><span class="line">  <span class="string">"kubeAPIQPS"</span>: 1000,</span><br><span class="line">  <span class="string">"kubeAPIBurst"</span>: 2000,</span><br><span class="line">  <span class="string">"serializeImagePulls"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"evictionHard"</span>: &#123;</span><br><span class="line">    <span class="string">"memory.available"</span>: <span class="string">"100Mi"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"evictionPressureTransitionPeriod"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">  <span class="string">"enableControllerAttachDetach"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"makeIPTablesUtilChains"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"iptablesMasqueradeBit"</span>: 14,</span><br><span class="line">  <span class="string">"iptablesDropBit"</span>: 15,</span><br><span class="line">  <span class="string">"failSwapOn"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"containerLogMaxSize"</span>: <span class="string">"20Mi"</span>,</span><br><span class="line">  <span class="string">"containerLogMaxFiles"</span>: 10,</span><br><span class="line">  <span class="string">"configMapAndSecretChangeDetectionStrategy"</span>: <span class="string">"Watch"</span>,</span><br><span class="line">  <span class="string">"enforceNodeAllocatable"</span>: [</span><br><span class="line">    <span class="string">"pods"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"KubeletConfiguration"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"kubelet.config.k8s.io/v1beta1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4ã€éƒ¨ç½²-kube-proxy-ç»„ä»¶"><a href="#4ã€éƒ¨ç½²-kube-proxy-ç»„ä»¶" class="headerlink" title="4ã€éƒ¨ç½² kube-proxy ç»„ä»¶"></a>4ã€éƒ¨ç½² kube-proxy ç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-proxy è¿è¡Œåœ¨æ‰€æœ‰ worker èŠ‚ç‚¹ä¸Šï¼Œå®ƒç›‘å¬ apiserver ä¸­ service å’Œ endpoint çš„å˜åŒ–æƒ…å†µï¼Œåˆ›å»ºè·¯ç”±è§„åˆ™ä»¥æä¾›æœåŠ¡ IP å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p><h4 id="4-1ã€åˆ›å»º-kube-proxy-è¯ä¹¦"><a href="#4-1ã€åˆ›å»º-kube-proxy-è¯ä¹¦" class="headerlink" title="4.1ã€åˆ›å»º kube-proxy è¯ä¹¦"></a>4.1ã€åˆ›å»º kube-proxy è¯ä¹¦</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><p>CNï¼šæŒ‡å®šè¯¥è¯ä¹¦çš„ User ä¸º system:kube-proxyï¼›</p></li><li><p>é¢„å®šä¹‰çš„ RoleBinding system:node-proxier å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼›</p></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kube-proxy å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ls kube-proxy*.pem</span></span><br><span class="line">kube-proxy-key.pem  kube-proxy.pem</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#4-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="4.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>4.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials kube-proxy \</span></span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br></pre></td></tr></table></figure><ul><li>â€“embed-certs=trueï¼šå°† ca.pem å’Œ admin.pem è¯ä¹¦å†…å®¹åµŒå…¥åˆ°ç”Ÿæˆçš„ kubectl-proxy.kubeconfig æ–‡ä»¶ä¸­(ä¸åŠ æ—¶ï¼Œå†™å…¥çš„æ˜¯è¯ä¹¦æ–‡ä»¶è·¯å¾„)</li></ul><h4 id="4-3ã€åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶"><a href="#4-3ã€åˆ›å»º-kube-proxy-é…ç½®æ–‡ä»¶" class="headerlink" title="4.3ã€åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶"></a>4.3ã€åˆ›å»º kube-proxy é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kube-proxy-config.yaml</span></span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-proxy.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">healthzBindAddress: 172.21.16.87:10256 <span class="comment">#node</span></span><br><span class="line">metricsBindAddress: 172.21.16.87:10249 <span class="comment">#node</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">clusterCIDR: 172.30.0.0/16</span><br><span class="line">hostnameOverride: 172.21.16.87 <span class="comment">#node </span></span><br><span class="line">mode: <span class="string">"ipvs"</span></span><br><span class="line">portRange: <span class="string">""</span></span><br><span class="line">kubeProxyIPTablesConfiguration:</span><br><span class="line">  masqueradeAll: <span class="literal">false</span></span><br><span class="line">kubeProxyIPVSConfiguration:</span><br><span class="line">  scheduler: rr</span><br><span class="line">  excludeCIDRs: []</span><br></pre></td></tr></table></figure><ul><li>bindAddress: ç›‘å¬åœ°å€ï¼›</li><li>clientConnection.kubeconfig: è¿æ¥ apiserver çš„ kubeconfig æ–‡ä»¶ï¼›</li><li>clusterCIDR: kube-proxy æ ¹æ® â€“cluster-cidr åˆ¤æ–­é›†ç¾¤å†…éƒ¨å’Œå¤–éƒ¨æµé‡ï¼ŒæŒ‡å®š â€“cluster-cidr æˆ– â€“masquerade-all é€‰é¡¹å kube-proxy æ‰ä¼šå¯¹è®¿é—® Service IP çš„è¯·æ±‚åš SNATï¼›</li><li>hostnameOverride: å‚æ•°å€¼å¿…é¡»ä¸ kubelet çš„å€¼ä¸€è‡´ï¼Œå¦åˆ™ kube-proxy å¯åŠ¨åä¼šæ‰¾ä¸åˆ°è¯¥ Nodeï¼Œä»è€Œä¸ä¼šåˆ›å»ºä»»ä½• ipvs è§„åˆ™ï¼›</li><li>mode: ä½¿ç”¨ ipvs æ¨¡å¼ï¼›</li></ul><h4 id="4-4ã€åˆ›å»ºkube-proxy-systemd-unit-æ–‡ä»¶"><a href="#4-4ã€åˆ›å»ºkube-proxy-systemd-unit-æ–‡ä»¶" class="headerlink" title="4.4ã€åˆ›å»ºkube-proxy systemd unit æ–‡ä»¶"></a>4.4ã€åˆ›å»ºkube-proxy systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-proxy.service </span></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-proxy</span><br><span class="line">ExecStart=/usr/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy-config.yaml \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="4-5ã€å¯åŠ¨-kube-proxy-æœåŠ¡"><a href="#4-5ã€å¯åŠ¨-kube-proxy-æœåŠ¡" class="headerlink" title="4.5ã€å¯åŠ¨ kube-proxy æœåŠ¡"></a>4.5ã€å¯åŠ¨ kube-proxy æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy &amp;&amp; systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure><h4 id="4-5ã€æ£€æŸ¥"><a href="#4-5ã€æ£€æŸ¥" class="headerlink" title="4.5ã€æ£€æŸ¥"></a>4.5ã€æ£€æŸ¥</h4><ul><li><p>æŸ¥çœ‹ç›‘å¬ç«¯å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kube-prox</span></span><br><span class="line">tcp        0      0 172.21.16.87:10256      0.0.0.0:*               LISTEN      27423/kube-proxy    </span><br><span class="line">tcp        0      0 172.21.16.87:10249      0.0.0.0:*               LISTEN      27423/kube-proxy</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ ipvs è·¯ç”±è§„åˆ™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ipvsadm -ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.254.0.1:443 rr</span><br><span class="line">  -&gt; 172.21.17.30:6443            Masq    1      0          0         </span><br><span class="line">  -&gt; 172.21.17.31:6443            Masq    1      0          0 </span><br><span class="line">  -&gt; 172.21.16.110:6443           Masq    1      0          0</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>v1.14 nodeå®‰è£…</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-v1.14å®‰è£…</title>
    <url>/2019/09/11/kubernetes-v1-14%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="1ã€ç¯å¢ƒå‡†å¤‡"><a href="#1ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ç¯å¢ƒå‡†å¤‡"></a>1ã€ç¯å¢ƒå‡†å¤‡</h3><table><thead><tr><th>ip</th><th>type</th><th>docker</th><th>os</th><th>k8s version</th></tr></thead><tbody><tr><td>172.21.17.30</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td>v1.14.6</td></tr><tr><td>172.21.17.31</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.110</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.87</td><td>node,flanneld</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.240</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.204</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.45</td><td>vip</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr></tbody></table><h3 id="2ã€åˆå§‹åŒ–ç³»ç»Ÿ"><a href="#2ã€åˆå§‹åŒ–ç³»ç»Ÿ" class="headerlink" title="2ã€åˆå§‹åŒ–ç³»ç»Ÿ"></a>2ã€åˆå§‹åŒ–ç³»ç»Ÿ</h3><h4 id="2-1ã€å®‰è£…ä¾èµ–åŒ…"><a href="#2-1ã€å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="2.1ã€å®‰è£…ä¾èµ–åŒ…"></a>2.1ã€å®‰è£…ä¾èµ–åŒ…</h4><a id="more"></a><p>æ¯å°æœåŠ¡å™¨å‡æ“ä½œ,å…³é—­é˜²ç«å¢™,å…³é—­selinux</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y epel-release</span></span><br><span class="line"><span class="comment"># yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wget</span></span><br></pre></td></tr></table></figure><h4 id="2-2ã€å…³é—­-swap-åˆ†åŒº"><a href="#2-2ã€å…³é—­-swap-åˆ†åŒº" class="headerlink" title="2.2ã€å…³é—­ swap åˆ†åŒº"></a>2.2ã€å…³é—­ swap åˆ†åŒº</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœå¼€å¯äº† swap åˆ†åŒºï¼Œkubelet ä¼šå¯åŠ¨å¤±è´¥(å¯ä»¥é€šè¿‡å°†å‚æ•° â€“fail-swap-on è®¾ç½®ä¸º false æ¥å¿½ç•¥ swap on)ï¼Œæ•…éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šå…³é—­ swap åˆ†åŒºã€‚åŒæ—¶æ³¨é‡Š /etc/fstab ä¸­ç›¸åº”çš„æ¡ç›®ï¼Œé˜²æ­¢å¼€æœºè‡ªåŠ¨æŒ‚è½½ swap åˆ†åŒºã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># swapoff -a</span></span><br><span class="line"><span class="comment"># sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab</span></span><br></pre></td></tr></table></figure><h4 id="2-3ã€åŠ è½½å†…æ ¸æ¨¡å—"><a href="#2-3ã€åŠ è½½å†…æ ¸æ¨¡å—" class="headerlink" title="2.3ã€åŠ è½½å†…æ ¸æ¨¡å—"></a>2.3ã€åŠ è½½å†…æ ¸æ¨¡å—</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># modprobe ip_vs_rr</span></span><br><span class="line"><span class="comment"># modprobe br_netfilter</span></span><br></pre></td></tr></table></figure><h4 id="2-4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°"><a href="#2-4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°" class="headerlink" title="2.4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°"></a>2.4ã€ä¼˜åŒ–å†…æ ¸å‚æ•°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/sysctl.d/kubernetes.conf </span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line"><span class="comment"># sysctl -p /etc/sysctl.d/kubernetes.conf</span></span><br></pre></td></tr></table></figure><ul><li>å¿…é¡»å…³é—­ tcp_tw_recycleï¼Œå¦åˆ™å’Œ NAT å†²çªï¼Œä¼šå¯¼è‡´æœåŠ¡ä¸é€šï¼›</li><li>å…³é—­ IPV6ï¼Œé˜²æ­¢è§¦å‘ docker BUGï¼›</li></ul><h4 id="2-5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº"><a href="#2-5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº" class="headerlink" title="2.5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº"></a>2.5ã€è®¾ç½®ç³»ç»Ÿæ—¶åŒº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># timedatectl set-timezone Asia/Shanghai</span></span><br><span class="line"><span class="comment"># timedatectl set-local-rtc 0</span></span><br><span class="line"><span class="comment"># systemctl restart rsyslog </span></span><br><span class="line"><span class="comment"># systemctl restart crond</span></span><br></pre></td></tr></table></figure><h4 id="2-6ã€å…³é—­æ— å…³çš„æœåŠ¡"><a href="#2-6ã€å…³é—­æ— å…³çš„æœåŠ¡" class="headerlink" title="2.6ã€å…³é—­æ— å…³çš„æœåŠ¡"></a>2.6ã€å…³é—­æ— å…³çš„æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl stop postfix &amp;&amp; systemctl disable postfix</span></span><br></pre></td></tr></table></figure><h3 id="3ã€å‡çº§å†…æ ¸"><a href="#3ã€å‡çº§å†…æ ¸" class="headerlink" title="3ã€å‡çº§å†…æ ¸"></a>3ã€å‡çº§å†…æ ¸</h3><p>ä»¥ä¸‹åœ¨masterèŠ‚ç‚¹æ“ä½œ<br>CentOS 7.x ç³»ç»Ÿè‡ªå¸¦çš„ 3.10.x å†…æ ¸å­˜åœ¨ä¸€äº› Bugsï¼Œå¯¼è‡´è¿è¡Œçš„ Dockerã€Kubernetes ä¸ç¨³å®šï¼Œä¾‹å¦‚:</p><ul><li>1.é«˜ç‰ˆæœ¬çš„ docker(1.13 ä»¥å) å¯ç”¨äº† 3.10 kernel å®éªŒæ”¯æŒçš„ kernel memory account åŠŸèƒ½(æ— æ³•å…³é—­)ï¼Œå½“èŠ‚ç‚¹å‹åŠ›å¤§å¦‚é¢‘ç¹å¯åŠ¨å’Œåœæ­¢å®¹å™¨æ—¶ä¼šå¯¼è‡´ cgroup memory leakï¼›</li><li>2.ç½‘ç»œè®¾å¤‡å¼•ç”¨è®¡æ•°æ³„æ¼ï¼Œä¼šå¯¼è‡´ç±»ä¼¼äºæŠ¥é”™ï¼šâ€kernel:unregister_netdevice: waiting for eth0 to become free. Usage count = 1â€;<br>è§£å†³æ–¹æ¡ˆå¦‚ä¸‹:</li><li>1.å‡çº§å†…æ ¸åˆ° 4.4.X ä»¥ä¸Š</li><li>2.æˆ–è€…ï¼Œæ‰‹åŠ¨ç¼–è¯‘å†…æ ¸ï¼Œdisable CONFIG_MEMCG_KMEM ç‰¹æ€§</li><li>æˆ–è€…ï¼Œå®‰è£…ä¿®å¤äº†è¯¥é—®é¢˜çš„ Docker 18.09.1 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚ä½†ç”±äº kubelet ä¹Ÿä¼šè®¾ç½® kmemï¼ˆå®ƒ vendor äº† runcï¼‰ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç¼–è¯‘ kubelet å¹¶æŒ‡å®š GOFLAGS=â€-tags=nokmemâ€</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --branch v1.14.1 --single-branch --depth 1 https://github.com/kubernetes/kubernetes</span><br><span class="line"><span class="built_in">cd</span> kubernetes</span><br><span class="line">KUBE_GIT_VERSION=v1.14.1 ./build/run.sh make kubelet GOFLAGS=<span class="string">"-tags=nokmem"</span></span><br></pre></td></tr></table></figure><h4 id="3-1ã€å†…æ ¸å‡çº§æ–¹æ³•"><a href="#3-1ã€å†…æ ¸å‡çº§æ–¹æ³•" class="headerlink" title="3.1ã€å†…æ ¸å‡çº§æ–¹æ³•"></a>3.1ã€å†…æ ¸å‡çº§æ–¹æ³•</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span></span><br><span class="line"><span class="comment"># å®‰è£…å®Œæˆåæ£€æŸ¥ /boot/grub2/grub.cfg ä¸­å¯¹åº”å†…æ ¸ menuentry ä¸­æ˜¯å¦åŒ…å« initrd16 é…ç½®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å®‰è£…ä¸€æ¬¡ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yum --enablerepo=elrepo-kernel install -y kernel-lt</span></span><br><span class="line"><span class="comment"># è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨</span></span><br><span class="line"><span class="comment"># grub2-set-default 0</span></span><br></pre></td></tr></table></figure><h4 id="3-2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶"><a href="#3-2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶" class="headerlink" title="3.2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶"></a>3.2ã€å®‰è£…å†…æ ¸æºæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum --enablerepo=elrepo-kernel install kernel-lt-devel-$(uname -r) kernel-lt-headers-$(uname -r)</span></span><br></pre></td></tr></table></figure><h4 id="3-3ã€å…³é—­-NUMA"><a href="#3-3ã€å…³é—­-NUMA" class="headerlink" title="3.3ã€å…³é—­ NUMA"></a>3.3ã€å…³é—­ NUMA</h4><p>åœ¨å…¶ä¸­ä¸€å°masterèŠ‚ç‚¹æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /etc/default/grub&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># åœ¨ GRUB_CMDLINE_LINUX ä¸€è¡Œæ·»åŠ  `numa=off` å‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤º</span></span><br><span class="line"><span class="comment"># cat /etc/default/grub</span></span><br><span class="line">GRUB_TIMEOUT=1</span><br><span class="line">GRUB_DISTRIBUTOR=<span class="string">"<span class="variable">$(sed 's, release .*$,,g' /etc/system-release)</span>"</span></span><br><span class="line">GRUB_DEFAULT=saved</span><br><span class="line">GRUB_DISABLE_SUBMENU=<span class="literal">true</span></span><br><span class="line">GRUB_TERMINAL=<span class="string">"serial console"</span></span><br><span class="line">GRUB_SERIAL_COMMAND=<span class="string">"serial --speed=115200"</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">"console=tty0 crashkernel=auto console=ttyS0,115200"</span></span><br><span class="line">numa=off</span><br><span class="line">GRUB_DISABLE_RECOVERY=<span class="string">"true"</span></span><br></pre></td></tr></table></figure><ul><li>é‡æ–°ç”Ÿæˆ grub2 é…ç½®æ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /boot/grub2/grub.cfg&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥"><a href="#4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥" class="headerlink" title="4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥"></a>4ã€åˆ›å»ºCAè¯ä¹¦å’Œç§˜é’¥</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºç¡®ä¿å®‰å…¨ï¼Œkubernetes ç³»ç»Ÿå„ç»„ä»¶éœ€è¦ä½¿ç”¨ x509 è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚CA (Certificate Authority) æ˜¯è‡ªç­¾åçš„æ ¹è¯ä¹¦ï¼Œç”¨æ¥ç­¾ååç»­åˆ›å»ºçš„å…¶å®ƒè¯ä¹¦ã€‚ä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl åˆ›å»ºæ‰€æœ‰è¯ä¹¦ï¼Œè¯ä¹¦å‡åœ¨ä¸€å°masterèŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œç„¶åé€šè¿‡è¿œç¨‹åˆ†å‘åˆ°å…¶ä»–çš„æœåŠ¡å™¨ä¸Šå»ã€‚</p><ul><li><strong>æ³¨æ„</strong>: æ¯ç”Ÿæˆçš„è¯ä¹¦å‡è¦è¿›è¡Œåˆ†å‘åˆ°å…¶ä»–çš„masterèŠ‚ç‚¹</li></ul><h4 id="4-1ã€å®‰è£…-cfssl-å·¥å…·é›†"><a href="#4-1ã€å®‰è£…-cfssl-å·¥å…·é›†" class="headerlink" title="4.1ã€å®‰è£… cfssl å·¥å…·é›†"></a>4.1ã€å®‰è£… cfssl å·¥å…·é›†</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -o cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="comment"># chmod +x * &amp;&amp;mv cfssl* /usr/bin/</span></span><br><span class="line"><span class="comment"># scp /usr/bin/cfssl* &#123;master-ip&#125;:/usr/bin</span></span><br></pre></td></tr></table></figure><h4 id="4-2ã€åˆ›å»ºæ ¹è¯ä¹¦-CA"><a href="#4-2ã€åˆ›å»ºæ ¹è¯ä¹¦-CA" class="headerlink" title="4.2ã€åˆ›å»ºæ ¹è¯ä¹¦ (CA)"></a>4.2ã€åˆ›å»ºæ ¹è¯ä¹¦ (CA)</h4><p>CA è¯ä¹¦æ˜¯é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹å…±äº«çš„ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ª CA è¯ä¹¦ï¼Œåç»­åˆ›å»ºçš„æ‰€æœ‰è¯ä¹¦éƒ½ç”±å®ƒç­¾åã€‚</p><h4 id="4-3ã€åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#4-3ã€åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="4.3ã€åˆ›å»ºé…ç½®æ–‡ä»¶"></a>4.3ã€åˆ›å»ºé…ç½®æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CA é…ç½®æ–‡ä»¶ç”¨äºé…ç½®æ ¹è¯ä¹¦çš„ä½¿ç”¨åœºæ™¯ (profile) å’Œå…·ä½“å‚æ•° (usageï¼Œè¿‡æœŸæ—¶é—´ã€æœåŠ¡ç«¯è®¤è¯ã€å®¢æˆ·ç«¯è®¤è¯ã€åŠ å¯†ç­‰)ï¼Œåç»­åœ¨ç­¾åå…¶å®ƒè¯ä¹¦æ—¶éœ€è¦æŒ‡å®šç‰¹å®šåœºæ™¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir k8s &amp;&amp; cd k8s#åé¢k8sç”Ÿæˆæ‰€éœ€è¦çš„è¯ä¹¦å‡åœ¨è¯¥ç›®å½•æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><ul><li><p>ca-config.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼Œç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼›</p></li><li><p>server authï¼šè¡¨ç¤º client å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ server æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p></li><li><p>client authï¼šè¡¨ç¤º server å¯ä»¥ç”¨è¯¥è¯¥è¯ä¹¦å¯¹ client æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p></li></ul><h4 id="4-4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"><a href="#4-4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶" class="headerlink" title="4.4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶"></a>4.4ã€åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</h4><ul><li><p>ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"ca"</span>: &#123;</span><br><span class="line">    <span class="string">"expiry"</span>: <span class="string">"876000h"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>CNï¼šCommon Nameï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼›</p></li><li><p>Oï¼šOrganizationï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼›</p></li><li><p>kube-apiserver å°†æå–çš„ Userã€Group ä½œä¸º RBAC æˆæƒçš„ç”¨æˆ·æ ‡è¯†ï¼›</p></li><li><p>ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span></span><br><span class="line"><span class="comment"># ls ca*</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/kubernetes/ssl &amp;&amp; cp ca*.pem ca-config.json /etc/kubernetes/ssl</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="5-éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·"><a href="#5-éƒ¨ç½²-kubectl-å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="5.éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·"></a>5.éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubectl é»˜è®¤ä» ~/.kube/config æ–‡ä»¶è¯»å– kube-apiserver åœ°å€å’Œè®¤è¯ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ‰§è¡Œ kubectl å‘½ä»¤æ—¶å¯èƒ½ä¼šå‡ºé”™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>:</li></ul><ul><li>1.å¦‚æœæ²¡æœ‰ç‰¹æ®ŠæŒ‡æ˜ï¼Œæœ¬æ–‡æ¡£çš„æ‰€æœ‰æ“ä½œå‡åœ¨ zhangjun-k8s01 èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œç„¶åè¿œç¨‹åˆ†å‘æ–‡ä»¶å’Œæ‰§è¡Œå‘½ä»¤ï¼›</li><li>2.æœ¬æ–‡æ¡£åªéœ€è¦éƒ¨ç½²ä¸€æ¬¡ï¼Œç”Ÿæˆçš„ kubeconfig æ–‡ä»¶æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥æ‹·è´åˆ°éœ€è¦æ‰§è¡Œ kubectl å‘½ä»¤çš„æœºå™¨ï¼Œé‡å‘½åä¸º ~/.kube/configï¼›</li></ul><h4 id="5-1ã€ä¸‹è½½å’Œåˆ†å‘-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#5-1ã€ä¸‹è½½å’Œåˆ†å‘-kubectl-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="5.1ã€ä¸‹è½½å’Œåˆ†å‘ kubectl äºŒè¿›åˆ¶æ–‡ä»¶"></a>5.1ã€ä¸‹è½½å’Œåˆ†å‘ kubectl äºŒè¿›åˆ¶æ–‡ä»¶</h4><p>è¿™é‡Œå§æŠŠnodeå’Œmasteræ‰€éœ€è¦çš„åŒ…å‡ç»™ä¸€æ¬¡æ€§åˆ†å‘</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.14.6/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzvf kubernetes-client-linux-amd64.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># master èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp kubernetes/server/bin/&#123;apiextensions-apiserver,cloud-controller-manager,kube-apiserver,kube-controller-manager,kube-proxy,kube-scheduler,kubeadm,kubectl,kubelet,mounter&#125; &#123;master-ip&#125;:/usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># node èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; &#123;node-ip&#125;:/usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="5-2ã€åˆ›å»º-admin-è¯ä¹¦å’Œç§é’¥"><a href="#5-2ã€åˆ›å»º-admin-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="5.2ã€åˆ›å»º admin è¯ä¹¦å’Œç§é’¥"></a>5.2ã€åˆ›å»º admin è¯ä¹¦å’Œç§é’¥</h4><p>kubectl ä¸ apiserver https å®‰å…¨ç«¯å£é€šä¿¡ï¼Œapiserver å¯¹æä¾›çš„è¯ä¹¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚<br>kubectl ä½œä¸ºé›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œéœ€è¦è¢«æˆäºˆæœ€é«˜æƒé™ï¼Œè¿™é‡Œåˆ›å»ºå…·æœ‰<strong>æœ€é«˜æƒé™</strong>çš„ admin è¯ä¹¦ã€‚</p><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; admin-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>O ä¸º system:mastersï¼Œkube-apiserver æ”¶åˆ°è¯¥è¯ä¹¦åå°†è¯·æ±‚çš„ Group è®¾ç½®ä¸º system:mastersï¼›</p></li><li><p>é¢„å®šä¹‰çš„ ClusterRoleBinding cluster-admin å°† Group system:masters ä¸ Role cluster-admin ç»‘å®šï¼Œè¯¥ Role æˆäºˆæ‰€æœ‰ APIçš„æƒé™ï¼›</p></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kubectl å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json  -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></span><br><span class="line"><span class="comment"># ls admin*</span></span><br><span class="line"><span class="comment"># cp admin*.pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="5-3ã€åˆ›å»º-kubeconfig-æ–‡ä»¶"><a href="#5-3ã€åˆ›å»º-kubeconfig-æ–‡ä»¶" class="headerlink" title="5.3ã€åˆ›å»º kubeconfig æ–‡ä»¶"></a>5.3ã€åˆ›å»º kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubeconfig ä¸º kubectl çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«è®¿é—® apiserver çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¦‚ apiserver åœ°å€ã€CA è¯ä¹¦å’Œè‡ªèº«ä½¿ç”¨çš„è¯ä¹¦ï¼›</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤APIåœ°å€</span></span><br><span class="line"><span class="comment"># KUBE_APISERVER="https://172.21.16.45:8443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials admin \</span><br><span class="line">  --client-certificate=admin.pem \</span><br><span class="line">  --client-key=admin-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context kubernetes \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=admin \</span><br><span class="line">  --kubeconfig=kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=kubectl.kubeconfig</span><br></pre></td></tr></table></figure><ul><li><strong>æç¤º</strong>: åˆ†å‘<code>kubectl.kubeconfig</code>æ–‡ä»¶ï¼Œå§æ–‡ä»¶å‘½å<code>~/.kube/config</code>;</li><li>â€“certificate-authorityï¼šéªŒè¯ kube-apiserver è¯ä¹¦çš„æ ¹è¯ä¹¦ï¼›</li><li>â€“client-certificateã€â€“client-keyï¼šåˆšç”Ÿæˆçš„ admin è¯ä¹¦å’Œç§é’¥ï¼Œè¿æ¥ kube-apiserver æ—¶ä½¿ç”¨ï¼›</li><li>â€“embed-certs=trueï¼šå°† ca.pem å’Œ admin.pem è¯ä¹¦å†…å®¹åµŒå…¥åˆ°ç”Ÿæˆçš„ kubectl.kubeconfig æ–‡ä»¶ä¸­(ä¸åŠ æ—¶ï¼Œå†™å…¥çš„æ˜¯è¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼Œåç»­æ‹·è´ kubeconfig åˆ°å…¶å®ƒæœºå™¨æ—¶ï¼Œè¿˜éœ€è¦å•ç‹¬æ‹·è´è¯ä¹¦æ–‡ä»¶ï¼Œä¸æ–¹ä¾¿ã€‚)ï¼›</li></ul><h3 id="6ã€éƒ¨ç½²etcdé›†ç¾¤"><a href="#6ã€éƒ¨ç½²etcdé›†ç¾¤" class="headerlink" title="6ã€éƒ¨ç½²etcdé›†ç¾¤"></a>6ã€éƒ¨ç½²etcdé›†ç¾¤</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etcd æ˜¯åŸºäº Raft çš„åˆ†å¸ƒå¼ key-value å­˜å‚¨ç³»ç»Ÿï¼Œç”± CoreOS å¼€å‘ï¼Œå¸¸ç”¨äºæœåŠ¡å‘ç°ã€å…±äº«é…ç½®ä»¥åŠå¹¶å‘æ§åˆ¶ï¼ˆå¦‚ leader é€‰ä¸¾ã€åˆ†å¸ƒå¼é”ç­‰ï¼‰ã€‚kubernetes ä½¿ç”¨ etcd å­˜å‚¨æ‰€æœ‰è¿è¡Œæ•°æ®ã€‚</p><p>ä¸‰èŠ‚ç‚¹é«˜å¯ç”¨ etcd é›†ç¾¤çš„æ­¥éª¤ï¼š</p><ul><li>ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶ï¼›</li><li>åˆ›å»º etcd é›†ç¾¤å„èŠ‚ç‚¹çš„ x509 è¯ä¹¦ï¼Œç”¨äºåŠ å¯†å®¢æˆ·ç«¯(å¦‚ etcdctl) ä¸ etcd é›†ç¾¤ã€etcd é›†ç¾¤ä¹‹é—´çš„æ•°æ®æµï¼›</li><li>åˆ›å»º etcd çš„ systemd unit æ–‡ä»¶ï¼Œé…ç½®æœåŠ¡å‚æ•°</li><li>æ£€æŸ¥é›†ç¾¤å·¥ä½œçŠ¶æ€;</li></ul><ul><li><strong>æ³¨æ„</strong>: å‡åœ¨ä¸€å°master<code>[etcd]</code>èŠ‚ç‚¹æ“ä½œï¼Œå…¶ä»–master<code>[etcd]</code>èŠ‚ç‚¹é€šè¿‡åˆ†å‘</li></ul><h4 id="6-1ã€ä¸‹è½½å’Œåˆ†å‘-etcd-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#6-1ã€ä¸‹è½½å’Œåˆ†å‘-etcd-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="6.1ã€ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶"></a>6.1ã€ä¸‹è½½å’Œåˆ†å‘ etcd äºŒè¿›åˆ¶æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir etcd &amp;&amp;cd etcd</span></span><br><span class="line"><span class="comment"># https://github.com/coreos/etcd/releases/download/v3.3.13/etcd-v3.3.13-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xvf etcd-v3.3.13-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># scp etcd* &#123;master-ip&#125;:/usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="6-2ã€åˆ›å»º-etcd-è¯ä¹¦å’Œç§é’¥"><a href="#6-2ã€åˆ›å»º-etcd-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="6.2ã€åˆ›å»º etcd è¯ä¹¦å’Œç§é’¥"></a>6.2ã€åˆ›å»º etcd è¯ä¹¦å’Œç§é’¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; etcd-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"172.21.17.30"</span>,</span><br><span class="line">    <span class="string">"172.21.17.31"</span>,</span><br><span class="line">    <span class="string">"172.21.16.110"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ etcd èŠ‚ç‚¹ IP æˆ–åŸŸååˆ—è¡¨ï¼Œéœ€è¦å°† etcd é›†ç¾¤çš„ä¸‰ä¸ªèŠ‚ç‚¹ IP éƒ½åˆ—åœ¨å…¶ä¸­ï¼›</li><li>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem cfssl gencert -ca=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span></span><br><span class="line"><span class="comment"># ls etcd*pem</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/etcd/ssl &amp;&amp; cp etcd*pem /etc/etcd/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="6-3ã€åˆ›å»º-etcd-çš„-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#6-3ã€åˆ›å»º-etcd-çš„-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="6.3ã€åˆ›å»º etcd çš„ systemd unit æ¨¡æ¿æ–‡ä»¶"></a>6.3ã€åˆ›å»º etcd çš„ systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/systemd/system/etcd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/data</span><br><span class="line">ExecStart=/usr/bin/etcd \</span><br><span class="line">  --data-dir=/var/lib/etcd/data \</span><br><span class="line">  --wal-dir=/var/lib/etcd/wal \</span><br><span class="line">  --name=etcd1 \<span class="comment">#æ ¹æ®èŠ‚ç‚¹åç§°è¿›è¡Œå˜åŒ–</span></span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --listen-peer-urls=https://172.21.17.30:2380 \</span><br><span class="line">  --initial-advertise-peer-urls=https://172.21.17.30:2380 \</span><br><span class="line">  --listen-client-urls=https://172.21.17.30:2379,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls=https://172.21.17.30:2379 \</span><br><span class="line">  --initial-cluster-token=etcd-cluster-0 \</span><br><span class="line">  --initial-cluster=etcd1=https://172.21.17.30:2380,etcd2=https://172.21.17.31:2380,etcd3=https://172.21.16.110:2380 \</span><br><span class="line">  --initial-cluster-state=new \</span><br><span class="line">  --auto-compaction-mode=periodic \</span><br><span class="line">  --auto-compaction-retention=1 \</span><br><span class="line">  --max-request-bytes=33554432 \</span><br><span class="line">  --quota-backend-bytes=6442450944 \</span><br><span class="line">  --heartbeat-interval=250 \</span><br><span class="line">  --election-timeout=2000</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /var/lib/etcd/&#123;data,wal&#125;</span></span><br></pre></td></tr></table></figure><ul><li>WorkingDirectoryã€â€“data-dirï¼šæŒ‡å®šå·¥ä½œç›®å½•å’Œæ•°æ®ç›®å½•ä¸º ${ETCD_DATA_DIR}ï¼Œéœ€åœ¨å¯åŠ¨æœåŠ¡å‰åˆ›å»ºè¿™ä¸ªç›®å½•ï¼›</li><li>â€“wal-dirï¼šæŒ‡å®š wal ç›®å½•ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œä¸€èˆ¬ä½¿ç”¨ SSD æˆ–è€…å’Œ â€“data-dir ä¸åŒçš„ç£ç›˜ï¼›</li><li>â€“nameï¼šæŒ‡å®šèŠ‚ç‚¹åç§°ï¼Œå½“ â€“initial-cluster-state å€¼ä¸º new æ—¶ï¼Œâ€“name çš„å‚æ•°å€¼å¿…é¡»ä½äº â€“initial-cluster åˆ—è¡¨ä¸­ï¼›</li><li>â€“cert-fileã€â€“key-fileï¼šetcd server ä¸ client é€šä¿¡æ—¶ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥ï¼›</li><li>â€“trusted-ca-fileï¼šç­¾å client è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œç”¨äºéªŒè¯ client è¯ä¹¦ï¼›</li><li>â€“peer-cert-fileã€â€“peer-key-fileï¼šetcd ä¸ peer é€šä¿¡ä½¿ç”¨çš„è¯ä¹¦å’Œç§é’¥ï¼›</li><li>â€“peer-trusted-ca-fileï¼šç­¾å peer è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œç”¨äºéªŒè¯ peer è¯ä¹¦ï¼›</li></ul><h4 id="6-4ã€å¯åŠ¨-etcd-æœåŠ¡"><a href="#6-4ã€å¯åŠ¨-etcd-æœåŠ¡" class="headerlink" title="6.4ã€å¯åŠ¨ etcd æœåŠ¡"></a>6.4ã€å¯åŠ¨ etcd æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd &amp;&amp; systemctl status etcd</span></span><br></pre></td></tr></table></figure><h4 id="6-5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ"><a href="#6-5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ" class="headerlink" title="6.5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ"></a>6.5ã€æ£€æŸ¥å¯åŠ¨ç»“æœ</h4><ul><li>ç¡®ä¿çŠ¶æ€ä¸º active (running)ï¼Œå¦åˆ™æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤åŸå› ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># journalctl -u etcd</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="6-6ã€éªŒè¯æœåŠ¡çŠ¶æ€"><a href="#6-6ã€éªŒè¯æœåŠ¡çŠ¶æ€" class="headerlink" title="6.6ã€éªŒè¯æœåŠ¡çŠ¶æ€"></a>6.6ã€éªŒè¯æœåŠ¡çŠ¶æ€</h4><p>éƒ¨ç½²å®Œ etcd é›†ç¾¤åï¼Œåœ¨ä»»ä¸€ etcd èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">    --endpoints=https://172.21.17.31:2379 \</span><br><span class="line">    --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-key.pem endpoint health</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥è¾“å‡ºå‡ä¸º healthy æ—¶è¡¨ç¤ºé›†ç¾¤æœåŠ¡æ­£å¸¸</p><h4 id="6-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#6-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="6.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>6.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCD_ENDPOINTS="https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379"</span></span><br><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">  -w table --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> endpoint status </span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|  https://172.21.17.30:2379 | 5d23ebc4382fa16f |  3.3.13 |  1.2 MB |     <span class="literal">false</span> |        83 |      58127 |</span><br><span class="line">|  https://172.21.17.31:2379 |  ceaae5134701946 |  3.3.13 |  1.2 MB |     <span class="literal">false</span> |        83 |      58127 |</span><br><span class="line">| https://172.21.16.110:2379 | 575020c8e15d3a06 |  3.3.13 |  1.2 MB |      <span class="literal">true</span> |        83 |      58128 |</span><br><span class="line">+----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></figure><ul><li>å½“å‰çš„ leader ä¸º 172.21.16.110</li></ul><h3 id="7ã€éƒ¨ç½²-flannel-ç½‘ç»œ"><a href="#7ã€éƒ¨ç½²-flannel-ç½‘ç»œ" class="headerlink" title="7ã€éƒ¨ç½² flannel ç½‘ç»œ"></a>7ã€éƒ¨ç½² flannel ç½‘ç»œ</h3><p>flannel ç½‘ç»œéƒ¨ç½²åœ¨nodeèŠ‚ç‚¹ï¼Œè¯ä¹¦åœ¨masterèŠ‚ç‚¹ç”Ÿæˆåˆ†å‘</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kubernetes è¦æ±‚é›†ç¾¤å†…å„èŠ‚ç‚¹(åŒ…æ‹¬ master èŠ‚ç‚¹)èƒ½é€šè¿‡ Pod ç½‘æ®µäº’è”äº’é€šã€‚flannel ä½¿ç”¨ vxlan æŠ€æœ¯ä¸ºå„èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªå¯ä»¥äº’é€šçš„ Pod ç½‘ç»œï¼Œä½¿ç”¨çš„ç«¯å£ä¸º UDP 8472ï¼ˆéœ€è¦å¼€æ”¾è¯¥ç«¯å£ï¼‰<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flanneld ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œä» etcd è·å–é…ç½®çš„ Pod ç½‘æ®µä¿¡æ¯ï¼Œä¸ºæœ¬èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªæœªä½¿ç”¨çš„åœ°å€æ®µï¼Œç„¶ååˆ›å»º flannedl.1 ç½‘ç»œæ¥å£ï¼ˆä¹Ÿå¯èƒ½æ˜¯å…¶å®ƒåç§°ï¼Œå¦‚ flannel1 ç­‰ï¼‰<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flannel å°†åˆ†é…ç»™è‡ªå·±çš„ Pod ç½‘æ®µä¿¡æ¯å†™å…¥ /run/flannel/docker æ–‡ä»¶ï¼Œdocker åç»­ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡è®¾ç½® docker0 ç½‘æ¡¥ï¼Œä»è€Œä»è¿™ä¸ªåœ°å€æ®µä¸ºæœ¬èŠ‚ç‚¹çš„æ‰€æœ‰ Pod å®¹å™¨åˆ†é… IPã€‚</p><h4 id="7-1ã€ä¸‹è½½å’Œåˆ†å‘-flanneld-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#7-1ã€ä¸‹è½½å’Œåˆ†å‘-flanneld-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="7.1ã€ä¸‹è½½å’Œåˆ†å‘ flanneld äºŒè¿›åˆ¶æ–‡ä»¶"></a>7.1ã€ä¸‹è½½å’Œåˆ†å‘ flanneld äºŒè¿›åˆ¶æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir flannel &amp;&amp;cd flannel</span></span><br><span class="line"><span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzvf flannel-v0.11.0-linux-amd64.tar.gz -C flannel</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†å‘flanneld å¯æ‰§è¡Œæ–‡ä»¶åˆ°nodeèŠ‚ç‚¹</li></ul><h4 id="7-2ã€åˆ›å»º-flannel-è¯ä¹¦å’Œç§é’¥"><a href="#7-2ã€åˆ›å»º-flannel-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="7.2ã€åˆ›å»º flannel è¯ä¹¦å’Œç§é’¥"></a>7.2ã€åˆ›å»º flannel è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>flanneld-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; flanneld-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"flanneld"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>è¯¥è¯ä¹¦åªä¼šè¢« kubectl å½“åš client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld </span></span><br><span class="line"><span class="comment"># ls flanneld*pem</span></span><br><span class="line"><span class="comment"># scp flanneld*pem &#123;node-ip&#125;:/etc/flanneld/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="7-3ã€å‘-etcd-å†™å…¥é›†ç¾¤-Pod-ç½‘æ®µä¿¡æ¯"><a href="#7-3ã€å‘-etcd-å†™å…¥é›†ç¾¤-Pod-ç½‘æ®µä¿¡æ¯" class="headerlink" title="7.3ã€å‘ etcd å†™å…¥é›†ç¾¤ Pod ç½‘æ®µä¿¡æ¯"></a>7.3ã€å‘ etcd å†™å…¥é›†ç¾¤ Pod ç½‘æ®µä¿¡æ¯</h4><p><strong>æ³¨æ„</strong>ï¼šæœ¬æ­¥éª¤åªéœ€æ‰§è¡Œä¸€æ¬¡ã€‚åœ¨etcdé›†ç¾¤ä¸Šæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=flanneld.pem \</span><br><span class="line">  --key-file=flanneld-key.pem \</span><br><span class="line">  mk /kubernetes/network/config <span class="string">'&#123;"Network":"172.30.0.0/16", "SubnetLen": 21, "Backend": &#123;"Type": "vxlan"&#125;&#125;'</span></span><br></pre></td></tr></table></figure><ul><li>flanneld å½“å‰ç‰ˆæœ¬ (v0.11.0) ä¸æ”¯æŒ etcd v3ï¼Œæ•…ä½¿ç”¨ etcd v2 API å†™å…¥é…ç½® key å’Œç½‘æ®µæ•°æ®ï¼›</li><li>å†™å…¥çš„ Pod ç½‘æ®µ ${CLUSTER_CIDR} åœ°å€æ®µï¼ˆå¦‚ /16ï¼‰å¿…é¡»å°äº SubnetLenï¼Œå¿…é¡»ä¸ kube-controller-manager çš„ â€“cluster-cidr å‚æ•°å€¼ä¸€è‡´ï¼›</li></ul><h4 id="7-4ã€åˆ›å»º-flanneld-çš„-systemd-unit-æ–‡ä»¶"><a href="#7-4ã€åˆ›å»º-flanneld-çš„-systemd-unit-æ–‡ä»¶" class="headerlink" title="7.4ã€åˆ›å»º flanneld çš„ systemd unit æ–‡ä»¶"></a>7.4ã€åˆ›å»º flanneld çš„ systemd unit æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/flanneld.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=etcd.service</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/flanneld \</span><br><span class="line">  -etcd-cafile=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  -etcd-certfile=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  -etcd-keyfile=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  -etcd-endpoints=https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379 \</span><br><span class="line">  -etcd-prefix=/kubernetes/network \</span><br><span class="line">  -iface=eth0 \</span><br><span class="line">  -ip-masq</span><br><span class="line">ExecStartPost=/usr/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">RequiredBy=docker.service</span><br></pre></td></tr></table></figure><ul><li>mk-docker-opts.sh è„šæœ¬å°†åˆ†é…ç»™ flanneld çš„ Pod å­ç½‘æ®µä¿¡æ¯å†™å…¥ /run/flannel/docker æ–‡ä»¶ï¼Œåç»­ docker å¯åŠ¨æ—¶ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡é…ç½® docker0 ç½‘æ¡¥ï¼›</li><li>flanneld ä½¿ç”¨ç³»ç»Ÿç¼ºçœè·¯ç”±æ‰€åœ¨çš„æ¥å£ä¸å…¶å®ƒèŠ‚ç‚¹é€šä¿¡ï¼Œå¯¹äºæœ‰å¤šä¸ªç½‘ç»œæ¥å£ï¼ˆå¦‚å†…ç½‘å’Œå…¬ç½‘ï¼‰çš„èŠ‚ç‚¹ï¼Œå¯ä»¥ç”¨ -iface å‚æ•°æŒ‡å®šé€šä¿¡æ¥å£;</li><li>flanneld è¿è¡Œæ—¶éœ€è¦ root æƒé™ï¼›</li><li>-ip-masq: flanneld ä¸ºè®¿é—® Pod ç½‘ç»œå¤–çš„æµé‡è®¾ç½® SNAT è§„åˆ™ï¼ŒåŒæ—¶å°†ä¼ é€’ç»™ Docker çš„å˜é‡ â€“ip-masqï¼ˆ/run/flannel/docker æ–‡ä»¶ä¸­ï¼‰è®¾ç½®ä¸º falseï¼Œè¿™æ · Docker å°†ä¸å†åˆ›å»º SNAT è§„åˆ™ï¼› Docker çš„ â€“ip-masq ä¸º true æ—¶ï¼Œåˆ›å»ºçš„ SNAT è§„åˆ™æ¯”è¾ƒâ€œæš´åŠ›â€ï¼šå°†æ‰€æœ‰æœ¬èŠ‚ç‚¹ Pod å‘èµ·çš„ã€è®¿é—®é docker0 æ¥å£çš„è¯·æ±‚åš SNATï¼Œè¿™æ ·è®¿é—®å…¶ä»–èŠ‚ç‚¹ Pod çš„è¯·æ±‚æ¥æº IP ä¼šè¢«è®¾ç½®ä¸º flannel.1 æ¥å£çš„ IPï¼Œå¯¼è‡´ç›®çš„ Pod çœ‹ä¸åˆ°çœŸå®çš„æ¥æº Pod IPã€‚ flanneld åˆ›å»ºçš„ SNAT è§„åˆ™æ¯”è¾ƒæ¸©å’Œï¼Œåªå¯¹è®¿é—®é Pod ç½‘æ®µçš„è¯·æ±‚åš SNATã€‚</li></ul><h4 id="7-5ã€å¯åŠ¨-flanneld-æœåŠ¡"><a href="#7-5ã€å¯åŠ¨-flanneld-æœåŠ¡" class="headerlink" title="7.5ã€å¯åŠ¨ flanneld æœåŠ¡"></a>7.5ã€å¯åŠ¨ flanneld æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable flanneld &amp;&amp; systemctl restart flanneld &amp;&amp; systemctl status flanneld</span></span><br></pre></td></tr></table></figure><h4 id="7-6ã€æ£€æŸ¥åˆ†é…ç»™å„-flanneld-çš„-Pod-ç½‘æ®µä¿¡æ¯"><a href="#7-6ã€æ£€æŸ¥åˆ†é…ç»™å„-flanneld-çš„-Pod-ç½‘æ®µä¿¡æ¯" class="headerlink" title="7.6ã€æ£€æŸ¥åˆ†é…ç»™å„ flanneld çš„ Pod ç½‘æ®µä¿¡æ¯"></a>7.6ã€æ£€æŸ¥åˆ†é…ç»™å„ flanneld çš„ Pod ç½‘æ®µä¿¡æ¯</h4><ul><li><p>æŸ¥çœ‹é›†ç¾¤ Pod ç½‘æ®µ(/16)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  get /kubernetes/network/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 21, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å·²åˆ†é…çš„ Pod å­ç½‘æ®µåˆ—è¡¨(/24):</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  ls /kubernetes/network/subnets</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">/kubernetes/network/subnets/172.30.232.0-21</span><br><span class="line">/kubernetes/network/subnets/172.30.128.0-21</span><br><span class="line">/kubernetes/network/subnets/172.30.176.0-21</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æŸä¸€ Pod ç½‘æ®µå¯¹åº”çš„èŠ‚ç‚¹ IP å’Œ flannel æ¥å£åœ°å€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl \</span></span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-file=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  get /kubernetes/network/subnets/172.30.232.0-21</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"172.21.16.204"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"f6:50:05:5c:9a:20"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>172.30.232.0/21 è¢«åˆ†é…ç»™èŠ‚ç‚¹172.21.16.204ï¼‰ï¼›</p></li><li><p>VtepMAC ä¸º172.21.16.204èŠ‚ç‚¹çš„ flannel.1 ç½‘å¡ MAC åœ°å€ï¼›</p></li></ul><h4 id="7-7ã€æ£€æŸ¥èŠ‚ç‚¹-flannel-ç½‘ç»œä¿¡æ¯"><a href="#7-7ã€æ£€æŸ¥èŠ‚ç‚¹-flannel-ç½‘ç»œä¿¡æ¯" class="headerlink" title="7.7ã€æ£€æŸ¥èŠ‚ç‚¹ flannel ç½‘ç»œä¿¡æ¯"></a>7.7ã€æ£€æŸ¥èŠ‚ç‚¹ flannel ç½‘ç»œä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip addr show</span></span><br></pre></td></tr></table></figure><ul><li><p>flannel.1 ç½‘å¡çš„åœ°å€ä¸ºåˆ†é…çš„ Pod å­ç½‘æ®µçš„ç¬¬ä¸€ä¸ª IPï¼ˆ.0ï¼‰ï¼Œä¸”æ˜¯ /32 çš„åœ°å€ï¼›</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip route show |grep flannel.1</span></span><br><span class="line">172.30.128.0/21 via 172.30.128.0 dev flannel.1 onlink </span><br><span class="line">172.30.176.0/21 via 172.30.176.0 dev flannel.1 onlink</span><br></pre></td></tr></table></figure></li><li><p>åˆ°å…¶å®ƒèŠ‚ç‚¹ Pod ç½‘æ®µè¯·æ±‚éƒ½è¢«è½¬å‘åˆ° flannel.1 ç½‘å¡ï¼›</p></li><li><p>flanneld æ ¹æ® etcd ä¸­å­ç½‘æ®µçš„ä¿¡æ¯ï¼Œå¦‚/kubernetes/network/subnets/172.30.232.0-21 ï¼Œæ¥å†³å®šè¿›è¯·æ±‚å‘é€ç»™å“ªä¸ªèŠ‚ç‚¹çš„äº’è” IPï¼›</p></li><li><p>éªŒè¯å„èŠ‚ç‚¹èƒ½é€šè¿‡ Pod ç½‘æ®µäº’é€š</p></li></ul><h3 id="8ã€masterèŠ‚ç‚¹éƒ¨ç½²"><a href="#8ã€masterèŠ‚ç‚¹éƒ¨ç½²" class="headerlink" title="8ã€masterèŠ‚ç‚¹éƒ¨ç½²"></a>8ã€masterèŠ‚ç‚¹éƒ¨ç½²</h3><p>kubernetes master èŠ‚ç‚¹è¿è¡Œå¦‚ä¸‹ç»„ä»¶ï¼š</p><ul><li>kube-apiserver</li><li>kube-scheduler</li><li>kube-controller-manager<br>kube-apiserverã€kube-scheduler å’Œ kube-controller-manager å‡ä»¥å¤šå®ä¾‹æ¨¡å¼è¿è¡Œï¼š<br>1ã€kube-scheduler å’Œ kube-controller-manager ä¼šè‡ªåŠ¨é€‰ä¸¾äº§ç”Ÿä¸€ä¸ª leader å®ä¾‹ï¼Œå…¶å®ƒå®ä¾‹å¤„äºé˜»å¡æ¨¡å¼ï¼Œå½“ leader æŒ‚äº†åï¼Œé‡æ–°é€‰ä¸¾äº§ç”Ÿæ–°çš„ leaderï¼Œä»è€Œä¿è¯æœåŠ¡å¯ç”¨æ€§ï¼›<br>2ã€kube-apiserver æ˜¯æ— çŠ¶æ€çš„ï¼Œéœ€è¦é€šè¿‡<a href="https://xxlaila.github.io/2019/08/10/haproxy-keepalived/" target="_blank" rel="noopener">haproxy+keepalived</a>è¿›è¡Œä»£ç†è®¿é—®ï¼Œä»è€Œä¿è¯æœåŠ¡å¯ç”¨æ€§ï¼›</li></ul><h4 id="8-1ã€åˆ›å»º-kubernetes-è¯ä¹¦å’Œç§é’¥"><a href="#8-1ã€åˆ›å»º-kubernetes-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="8.1ã€åˆ›å»º kubernetes è¯ä¹¦å’Œç§é’¥"></a>8.1ã€åˆ›å»º kubernetes è¯ä¹¦å’Œç§é’¥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kubernetes-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"172.21.17.30"</span>,</span><br><span class="line">    <span class="string">"172.21.17.31"</span>,</span><br><span class="line">    <span class="string">"172.21.16.110"</span>,</span><br><span class="line">    <span class="string">"172.21.16.45"</span>,</span><br><span class="line">    <span class="string">"10.254.0.1"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local."</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><p>hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ IP å’ŒåŸŸååˆ—è¡¨ï¼Œè¿™é‡Œåˆ—å‡ºäº† master èŠ‚ç‚¹ IPã€kubernetes æœåŠ¡çš„ IP å’ŒåŸŸå,ä»¥åŠVIPåœ°å€ï¼›</p></li><li><p>kubernetes æœåŠ¡ IP æ˜¯ apiserver è‡ªåŠ¨åˆ›å»ºçš„ï¼Œä¸€èˆ¬æ˜¯ â€“service-cluster-ip-range å‚æ•°æŒ‡å®šçš„ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIP,åç»­å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤è·å–ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc kubernetes</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.254.0.1   &lt;none&gt;        443/TCP   4h13m</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span></span><br><span class="line"><span class="comment"># ls kubernetes*pem</span></span><br><span class="line">kubernetes-key.pem  kubernetes.pem</span><br><span class="line"><span class="comment"># cp kubernetes*pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="8-2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶"><a href="#8-2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶" class="headerlink" title="8.2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶"></a>8.2ã€åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)</span></span><br><span class="line"><span class="comment"># cat &gt; encryption-config.yaml &lt;&lt;EOF</span></span><br><span class="line">kind: EncryptionConfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">resources:</span><br><span class="line">  - resources:</span><br><span class="line">      - secrets</span><br><span class="line">    providers:</span><br><span class="line">      - aescbc:</span><br><span class="line">          keys:</span><br><span class="line">            - name: key1</span><br><span class="line">              secret: <span class="variable">$&#123;ENCRYPTION_KEY&#125;</span></span><br><span class="line">      - identity: &#123;&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># cp encryption-config.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="8-3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"><a href="#8-3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶" class="headerlink" title="8.3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶"></a>8.3ã€åˆ›å»ºå®¡è®¡ç­–ç•¥æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; audit-policy.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: audit.k8s.io/v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># The following requests were manually identified as high-volume and low-risk, so drop them.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">          - services</span><br><span class="line">          - services/status</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-proxy'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes</span><br><span class="line">          - nodes/status</span><br><span class="line">    userGroups:</span><br><span class="line">      - <span class="string">'system:nodes'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    namespaces:</span><br><span class="line">      - kube-system</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">      - <span class="string">'system:kube-scheduler'</span></span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:endpoint-controller'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - namespaces</span><br><span class="line">          - namespaces/status</span><br><span class="line">          - namespaces/finalize</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:apiserver'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log HPA fetching metrics.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log these read-only URLs.</span></span><br><span class="line">  - level: None</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">      - <span class="string">'/healthz*'</span></span><br><span class="line">      - /version</span><br><span class="line">      - <span class="string">'/swagger*'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log events requests.</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - events</span><br><span class="line"></span><br><span class="line">  <span class="comment"># node and pod status calls from nodes are high-volume and can be large, don't log responses for expected updates from nodes</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes/status</span><br><span class="line">          - pods/status</span><br><span class="line">    users:</span><br><span class="line">      - kubelet</span><br><span class="line">      - <span class="string">'system:node-problem-detector'</span></span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:node-problem-detector'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - nodes/status</span><br><span class="line">          - pods/status</span><br><span class="line">    userGroups:</span><br><span class="line">      - <span class="string">'system:nodes'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  <span class="comment"># deletecollection calls can be large, don't log responses for expected namespace deletions</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    users:</span><br><span class="line">      - <span class="string">'system:serviceaccount:kube-system:namespace-controller'</span></span><br><span class="line">    verbs:</span><br><span class="line">      - deletecollection</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span><br><span class="line">  <span class="comment"># so only log at the Metadata level.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">        resources:</span><br><span class="line">          - secrets</span><br><span class="line">          - configmaps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">        resources:</span><br><span class="line">          - tokenreviews</span><br><span class="line">  <span class="comment"># Get repsonses can be large; skip them.</span></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default level for known APIs</span></span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: <span class="string">""</span></span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">      </span><br><span class="line">  <span class="comment"># Default level for all other requests.</span></span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp audit-policy.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="8-4ã€åˆ›å»ºåç»­è®¿é—®-metrics-server-ä½¿ç”¨çš„è¯ä¹¦"><a href="#8-4ã€åˆ›å»ºåç»­è®¿é—®-metrics-server-ä½¿ç”¨çš„è¯ä¹¦" class="headerlink" title="8.4ã€åˆ›å»ºåç»­è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦"></a>8.4ã€åˆ›å»ºåç»­è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; proxy-client-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"aggregator"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>CN åç§°éœ€è¦ä½äº kube-apiserver çš„ â€“requestheader-allowed-names å‚æ•°ä¸­ï¼Œå¦åˆ™åç»­è®¿é—® metrics æ—¶ä¼šæç¤ºæƒé™ä¸è¶³ã€‚</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem  -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes proxy-client-csr.json | cfssljson -bare proxy-client</span></span><br><span class="line"><span class="comment"># ls proxy-client*.pem</span></span><br><span class="line">proxy-client-key.pem  proxy-client.pem</span><br><span class="line"><span class="comment"># cp proxy-client*.pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="8-5ã€åˆ›å»º-kube-apiserver-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#8-5ã€åˆ›å»º-kube-apiserver-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="8.5ã€åˆ›å»º kube-apiserver systemd unit æ¨¡æ¿æ–‡ä»¶"></a>8.5ã€åˆ›å»º kube-apiserver systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-apiserver</span><br><span class="line">ExecStart=/usr/bin/kube-apiserver \</span><br><span class="line">  --advertise-address=172.21.17.30 \<span class="comment">#master èŠ‚ç‚¹çš„ip</span></span><br><span class="line">  --default-not-ready-toleration-seconds=360 \</span><br><span class="line">  --default-unreachable-toleration-seconds=360 \</span><br><span class="line">  --feature-gates=DynamicAuditing=<span class="literal">true</span> \</span><br><span class="line">  --max-mutating-requests-inflight=2000 \</span><br><span class="line">  --max-requests-inflight=4000 \</span><br><span class="line">  --default-watch-cache-size=200 \</span><br><span class="line">  --delete-collection-workers=2 \</span><br><span class="line">  --encryption-provider-config=/etc/kubernetes/encryption-config.yaml \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --etcd-servers=https://172.21.17.30:2379,https://172.21.17.31:2379,https://172.21.16.110:2379 \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --insecure-port=0 \</span><br><span class="line">  --audit-dynamic-configuration \</span><br><span class="line">  --audit-log-maxage=15 \</span><br><span class="line">  --audit-log-maxbackup=3 \</span><br><span class="line">  --audit-log-maxsize=100 \</span><br><span class="line">  --audit-log-truncate-enabled \</span><br><span class="line">  --audit-log-path=/var/<span class="built_in">log</span>/k8s/kube-apiserver/audit.log \</span><br><span class="line">  --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span><br><span class="line">  --profiling \</span><br><span class="line">  --anonymous-auth=<span class="literal">false</span> \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --<span class="built_in">enable</span>-bootstrap-token-auth \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">"aggregator"</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --runtime-config=api/all=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">enable</span>-admission-plugins=NodeRestriction \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --apiserver-count=3 \</span><br><span class="line">  --event-ttl=168h \</span><br><span class="line">  --kubelet-certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --kubelet-https=<span class="literal">true</span> \</span><br><span class="line">  --kubelet-timeout=10s \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/ssl/proxy-client.pem \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/ssl/proxy-client-key.pem \</span><br><span class="line">  --service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">  --service-node-port-range=30000-32767 \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">enable</span>-aggregator-routing=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-apiserver</span></span><br></pre></td></tr></table></figure><ul><li>â€“advertise-addressï¼šapiserver å¯¹å¤–é€šå‘Šçš„ IPï¼ˆkubernetes æœåŠ¡åç«¯èŠ‚ç‚¹ IPï¼‰ï¼›</li><li>â€“default-*-toleration-secondsï¼šè®¾ç½®èŠ‚ç‚¹å¼‚å¸¸ç›¸å…³çš„é˜ˆå€¼ï¼›</li><li>â€“max-*-requests-inflightï¼šè¯·æ±‚ç›¸å…³çš„æœ€å¤§é˜ˆå€¼ï¼›</li><li>â€“etcd-*ï¼šè®¿é—® etcd çš„è¯ä¹¦å’Œ etcd æœåŠ¡å™¨åœ°å€ï¼›</li><li>â€“experimental-encryption-provider-configï¼šæŒ‡å®šç”¨äºåŠ å¯† etcd ä¸­ secret çš„é…ç½®ï¼›</li><li>â€“bind-addressï¼š https ç›‘å¬çš„ IPï¼Œä¸èƒ½ä¸º 127.0.0.1ï¼Œå¦åˆ™å¤–ç•Œä¸èƒ½è®¿é—®å®ƒçš„å®‰å…¨ç«¯å£ 6443ï¼›</li><li>â€“secret-portï¼šhttps ç›‘å¬ç«¯å£ï¼›</li><li>â€“insecure-port=0ï¼šå…³é—­ç›‘å¬ http éå®‰å…¨ç«¯å£(8080)ï¼›</li><li>â€“tls-*-fileï¼šæŒ‡å®š apiserver ä½¿ç”¨çš„è¯ä¹¦ã€ç§é’¥å’Œ CA æ–‡ä»¶ï¼›</li><li>â€“audit-*ï¼šé…ç½®å®¡è®¡ç­–ç•¥å’Œå®¡è®¡æ—¥å¿—æ–‡ä»¶ç›¸å…³çš„å‚æ•°ï¼›</li><li>â€“client-ca-fileï¼šéªŒè¯ client (kue-controller-managerã€kube-schedulerã€kubeletã€kube-proxy ç­‰)è¯·æ±‚æ‰€å¸¦çš„è¯ä¹¦ï¼›</li><li>â€“enable-bootstrap-token-authï¼šå¯ç”¨ kubelet bootstrap çš„ token è®¤è¯ï¼›</li><li>â€“requestheader-*ï¼škube-apiserver çš„ aggregator layer ç›¸å…³çš„é…ç½®å‚æ•°ï¼Œproxy-client &amp; HPA éœ€è¦ä½¿ç”¨ï¼›</li><li>â€“requestheader-client-ca-fileï¼šç”¨äºç­¾å â€“proxy-client-cert-file å’Œ â€“proxy-client-key-file æŒ‡å®šçš„è¯ä¹¦ï¼›åœ¨å¯ç”¨äº† metric aggregator æ—¶ä½¿ç”¨ï¼›</li><li>â€“requestheader-allowed-namesï¼šä¸èƒ½ä¸ºç©ºï¼Œå€¼ä¸ºé€—å·åˆ†å‰²çš„ â€“proxy-client-cert-file è¯ä¹¦çš„ CN åç§°ï¼Œè¿™é‡Œè®¾ç½®ä¸º â€œaggregatorâ€ï¼›</li><li>â€“service-account-key-fileï¼šç­¾å ServiceAccount Token çš„å…¬é’¥æ–‡ä»¶ï¼Œkube-controller-manager çš„ â€“service-account-private-key-file æŒ‡å®šç§é’¥æ–‡ä»¶ï¼Œä¸¤è€…é…å¯¹ä½¿ç”¨ï¼›</li><li>â€“runtime-config=api/all=trueï¼š å¯ç”¨æ‰€æœ‰ç‰ˆæœ¬çš„ APIsï¼Œå¦‚ autoscaling/v2alpha1ï¼›</li><li>â€“authorization-mode=Node,RBACã€â€“anonymous-auth=falseï¼š å¼€å¯ Node å’Œ RBAC æˆæƒæ¨¡å¼ï¼Œæ‹’ç»æœªæˆæƒçš„è¯·æ±‚ï¼›</li><li>â€“enable-admission-pluginsï¼šå¯ç”¨ä¸€äº›é»˜è®¤å…³é—­çš„ pluginsï¼›</li><li>â€“allow-privilegedï¼šè¿è¡Œæ‰§è¡Œ privileged æƒé™çš„å®¹å™¨ï¼›</li><li>â€“apiserver-count=3ï¼šæŒ‡å®š apiserver å®ä¾‹çš„æ•°é‡ï¼›</li><li>â€“event-ttlï¼šæŒ‡å®š events çš„ä¿å­˜æ—¶é—´ï¼›</li><li>â€“kubelet-<em>ï¼šå¦‚æœæŒ‡å®šï¼Œåˆ™ä½¿ç”¨ https è®¿é—® kubelet APIsï¼›éœ€è¦ä¸ºè¯ä¹¦å¯¹åº”çš„ç”¨æˆ·(ä¸Šé¢ kubernetes</em>.pem è¯ä¹¦çš„ç”¨æˆ·ä¸º kubernetes) ç”¨æˆ·å®šä¹‰ RBAC è§„åˆ™ï¼Œå¦åˆ™è®¿é—® kubelet API æ—¶æç¤ºæœªæˆæƒï¼›</li><li>â€“proxy-client-*ï¼šapiserver è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦ï¼›</li><li>â€“service-cluster-ip-rangeï¼š æŒ‡å®š Service Cluster IP åœ°å€æ®µï¼›</li><li>â€“service-node-port-rangeï¼š æŒ‡å®š NodePort çš„ç«¯å£èŒƒå›´ï¼›</li><li>å¦‚æœ kube-apiserver æœºå™¨æ²¡æœ‰è¿è¡Œ kube-proxyï¼Œåˆ™è¿˜éœ€è¦æ·»åŠ  â€“enable-aggregator-routing=true å‚æ•°</li></ul><p><strong>æ³¨æ„</strong>:<br>1.requestheader-client-ca-file æŒ‡å®šçš„ CA è¯ä¹¦ï¼Œå¿…é¡»å…·æœ‰ client auth and server authï¼›<br>2.å¦‚æœ â€“requestheader-allowed-names ä¸ºç©ºï¼Œæˆ–è€… â€“proxy-client-cert-file è¯ä¹¦çš„ CN åç§°ä¸åœ¨ allowed-names ä¸­ï¼Œåˆ™åç»­æŸ¥çœ‹ node æˆ– pods çš„ metrics å¤±è´¥ï¼Œæç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl top nodes</span></span><br><span class="line">Error from server (Forbidden): nodes.metrics.k8s.io is forbidden: User <span class="string">"aggregator"</span> cannot list resource <span class="string">"nodes"</span> <span class="keyword">in</span> API group <span class="string">"metrics.k8s.io"</span> at the cluster scope</span><br></pre></td></tr></table></figure><h4 id="8-6ã€å¯åŠ¨-kube-apiserver-æœåŠ¡"><a href="#8-6ã€å¯åŠ¨-kube-apiserver-æœåŠ¡" class="headerlink" title="8.6ã€å¯åŠ¨ kube-apiserver æœåŠ¡"></a>8.6ã€å¯åŠ¨ kube-apiserver æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver &amp;&amp;systemctl status kube-apiserver</span></span><br><span class="line"><span class="comment"># systemctl status kube-apiserver |grep 'Active:'</span></span><br><span class="line">   Active: active (running) since Mon 2019-09-16 14:38:31 CST; 1min 41s ago</span><br></pre></td></tr></table></figure><h4 id="8-6ã€æ‰“å°-kube-apiserver-å†™å…¥-etcd-çš„æ•°æ®"><a href="#8-6ã€æ‰“å°-kube-apiserver-å†™å…¥-etcd-çš„æ•°æ®" class="headerlink" title="8.6ã€æ‰“å° kube-apiserver å†™å…¥ etcd çš„æ•°æ®"></a>8.6ã€æ‰“å° kube-apiserver å†™å…¥ etcd çš„æ•°æ®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ETCDCTL_API=3 etcdctl \</span></span><br><span class="line">    --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">    --cacert=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">    get /registry/ --prefix --keys-only</span><br></pre></td></tr></table></figure><h4 id="8-9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯"><a href="#8-9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯" class="headerlink" title="8.9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯"></a>8.9ã€æ£€æŸ¥é›†ç¾¤ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl cluster-info</span></span><br><span class="line">Kubernetes master is running at https://172.21.16.45:8443</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get all --all-namespaces</span></span><br><span class="line">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default     service/kubernetes   ClusterIP   10.254.0.1   &lt;none&gt;        443/TCP   12m</span><br><span class="line"></span><br><span class="line"><span class="comment">#  kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused</span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused</span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œ kubectl get componentstatuses å‘½ä»¤æ—¶ï¼Œapiserver é»˜è®¤å‘ 127.0.0.1 å‘é€è¯·æ±‚ã€‚å½“ controller-managerã€scheduler ä»¥é›†ç¾¤æ¨¡å¼è¿è¡Œæ—¶ï¼Œæœ‰å¯èƒ½å’Œ kube-apiserver ä¸åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œè¿™æ—¶ controller-manager æˆ– scheduler çš„çŠ¶æ€ä¸º Unhealthyï¼Œä½†å®é™…ä¸Šå®ƒä»¬å·¥ä½œæ­£å¸¸ã€‚</li></ul><h4 id="8-10ã€æ£€æŸ¥-kube-apiserver-ç›‘å¬çš„ç«¯å£"><a href="#8-10ã€æ£€æŸ¥-kube-apiserver-ç›‘å¬çš„ç«¯å£" class="headerlink" title="8.10ã€æ£€æŸ¥ kube-apiserver ç›‘å¬çš„ç«¯å£"></a>8.10ã€æ£€æŸ¥ kube-apiserver ç›‘å¬çš„ç«¯å£</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt|grep kube</span></span><br><span class="line">tcp6       0      0 :::6443                 :::*                    LISTEN      10845/kube-apiserve</span><br></pre></td></tr></table></figure><ul><li>6443: æ¥æ”¶ https è¯·æ±‚çš„å®‰å…¨ç«¯å£ï¼Œå¯¹æ‰€æœ‰è¯·æ±‚åšè®¤è¯å’Œæˆæƒï¼›</li><li>ç”±äºå…³é—­äº†éå®‰å…¨ç«¯å£ï¼Œæ•…æ²¡æœ‰ç›‘å¬ 8080ï¼›</li></ul><h4 id="8-11ã€æˆäºˆ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™"><a href="#8-11ã€æˆäºˆ-kube-apiserver-è®¿é—®-kubelet-API-çš„æƒé™" class="headerlink" title="8.11ã€æˆäºˆ kube-apiserver è®¿é—® kubelet API çš„æƒé™"></a>8.11ã€æˆäºˆ kube-apiserver è®¿é—® kubelet API çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰§è¡Œ kubectl execã€runã€logs ç­‰å‘½ä»¤æ—¶ï¼Œapiserver ä¼šå°†è¯·æ±‚è½¬å‘åˆ° kubelet çš„ https ç«¯å£ã€‚è¿™é‡Œå®šä¹‰ RBAC è§„åˆ™ï¼Œæˆæƒ apiserver ä½¿ç”¨çš„è¯ä¹¦ï¼ˆkubernetes.pemï¼‰ç”¨æˆ·åï¼ˆCNï¼škuberntesï¼‰è®¿é—® kubelet API çš„æƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span><br></pre></td></tr></table></figure><h3 id="9ã€éƒ¨ç½²é«˜å¯ç”¨-kube-controller-manager"><a href="#9ã€éƒ¨ç½²é«˜å¯ç”¨-kube-controller-manager" class="headerlink" title="9ã€éƒ¨ç½²é«˜å¯ç”¨ kube-controller-manager"></a>9ã€éƒ¨ç½²é«˜å¯ç”¨ kube-controller-manager</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¯¥é›†ç¾¤åŒ…å« 3 ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨åå°†é€šè¿‡ç«äº‰é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“ leader èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œé˜»å¡çš„èŠ‚ç‚¹å°†å†æ¬¡è¿›è¡Œé€‰ä¸¾äº§ç”Ÿæ–°çš„ leader èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚<br>ä¸ºä¿è¯é€šä¿¡å®‰å…¨ï¼Œæœ¬æ–‡æ¡£å…ˆç”Ÿæˆ x509 è¯ä¹¦å’Œç§é’¥ï¼Œkube-controller-manager åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥è¯ä¹¦ï¼š<br>1ã€ä¸ kube-apiserver çš„å®‰å…¨ç«¯å£é€šä¿¡;<br>2ã€åœ¨å®‰å…¨ç«¯å£(httpsï¼Œ10252) è¾“å‡º prometheus æ ¼å¼çš„ metricsï¼›</p><h4 id="9-1ã€åˆ›å»º-kube-controller-manager-è¯ä¹¦å’Œç§é’¥"><a href="#9-1ã€åˆ›å»º-kube-controller-manager-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="9.1ã€åˆ›å»º kube-controller-manager è¯ä¹¦å’Œç§é’¥"></a>9.1ã€åˆ›å»º kube-controller-manager è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.21.17.30"</span>,</span><br><span class="line">      <span class="string">"172.21.17.31"</span>,</span><br><span class="line">      <span class="string">"172.21.16.110"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>hosts åˆ—è¡¨åŒ…å«æ‰€æœ‰ kube-controller-manager èŠ‚ç‚¹ IPï¼›</p></li><li><p>CN å’Œ O å‡ä¸º system:kube-controller-managerï¼Œkubernetes å†…ç½®çš„ ClusterRoleBindings system:kube-controller-manager èµ‹äºˆ kube-controller-manager å·¥ä½œæ‰€éœ€çš„æƒé™ã€‚</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json   -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span><br><span class="line"><span class="comment"># ls kube-controller-manager*pem</span></span><br><span class="line">kube-controller-manager-key.pem  kube-controller-manager.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-controller-manager*pem /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="9-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#9-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="9.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>9.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-controller-manager ä½¿ç”¨ kubeconfig æ–‡ä»¶è®¿é—® apiserverï¼Œè¯¥æ–‡ä»¶æä¾›äº† apiserver åœ°å€ã€åµŒå…¥çš„ CA è¯ä¹¦å’Œ kube-controller-manager è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials system:kube-controller-manager \</span></span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context system:kube-controller-manager \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-controller-manager.kubeconfig /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="9-3ã€åˆ›å»º-kube-controller-manager-systemd-unitæ–‡ä»¶"><a href="#9-3ã€åˆ›å»º-kube-controller-manager-systemd-unitæ–‡ä»¶" class="headerlink" title="9.3ã€åˆ›å»º kube-controller-manager systemd unitæ–‡ä»¶"></a>9.3ã€åˆ›å»º kube-controller-manager systemd unitæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-controller-manager.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-controller-manager</span><br><span class="line">ExecStart=/usr/bin/kube-controller-manager \</span><br><span class="line">  --profiling \</span><br><span class="line">  --cluster-name=kubernetes \</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">  --kube-api-qps=1000 \</span><br><span class="line">  --kube-api-burst=2000 \</span><br><span class="line">  --leader-elect \</span><br><span class="line">  --use-service-account-credentials\</span><br><span class="line">  --concurrent-service-syncs=2 \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=10252 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span><br><span class="line">  --port=0 \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">""</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --experimental-cluster-signing-duration=876000h \</span><br><span class="line">  --horizontal-pod-autoscaler-sync-period=10s \</span><br><span class="line">  --concurrent-deployment-syncs=10 \</span><br><span class="line">  --concurrent-gc-syncs=30 \</span><br><span class="line">  --node-cidr-mask-size=24 \</span><br><span class="line">  --service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="line">  --pod-eviction-timeout=6m \</span><br><span class="line">  --terminated-pod-gc-threshold=10000 \</span><br><span class="line">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>â€“port=0ï¼šå…³é—­ç›‘å¬éå®‰å…¨ç«¯å£ï¼ˆhttpï¼‰ï¼ŒåŒæ—¶ â€“address å‚æ•°æ— æ•ˆï¼Œâ€“bind-address å‚æ•°æœ‰æ•ˆï¼›</li><li>â€“secure-port=10252ã€â€“bind-address=0.0.0.0: åœ¨æ‰€æœ‰ç½‘ç»œæ¥å£ç›‘å¬ 10252 ç«¯å£çš„ https /metrics è¯·æ±‚ï¼›</li><li>â€“kubeconfigï¼šæŒ‡å®š kubeconfig æ–‡ä»¶è·¯å¾„ï¼Œkube-controller-manager ä½¿ç”¨å®ƒè¿æ¥å’ŒéªŒè¯ kube-apiserverï¼›</li><li>â€“authentication-kubeconfig å’Œ â€“authorization-kubeconfigï¼škube-controller-manager ä½¿ç”¨å®ƒè¿æ¥ apiserverï¼Œå¯¹ client çš„è¯·æ±‚è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚kube-controller-manager ä¸å†ä½¿ç”¨ â€“tls-ca-file å¯¹è¯·æ±‚ https metrics çš„ Client è¯ä¹¦è¿›è¡Œæ ¡éªŒã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™ä¸¤ä¸ª kubeconfig å‚æ•°ï¼Œåˆ™ client è¿æ¥ kube-controller-manager https ç«¯å£çš„è¯·æ±‚ä¼šè¢«æ‹’ç»(æç¤ºæƒé™ä¸è¶³)ã€‚</li><li>â€“cluster-signing-*-fileï¼šç­¾å TLS Bootstrap åˆ›å»ºçš„è¯ä¹¦ï¼›</li><li>â€“experimental-cluster-signing-durationï¼šæŒ‡å®š TLS Bootstrap è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼›</li><li>â€“root-ca-fileï¼šæ”¾ç½®åˆ°å®¹å™¨ ServiceAccount ä¸­çš„ CA è¯ä¹¦ï¼Œç”¨æ¥å¯¹ kube-apiserver çš„è¯ä¹¦è¿›è¡Œæ ¡éªŒï¼›</li><li>â€“service-account-private-key-fileï¼šç­¾å ServiceAccount ä¸­ Token çš„ç§é’¥æ–‡ä»¶ï¼Œå¿…é¡»å’Œ kube-apiserver çš„ â€“service-account-key-file æŒ‡å®šçš„å…¬é’¥æ–‡ä»¶é…å¯¹ä½¿ç”¨ï¼›</li><li>â€“service-cluster-ip-range ï¼šæŒ‡å®š Service Cluster IP ç½‘æ®µï¼Œå¿…é¡»å’Œ kube-apiserver ä¸­çš„åŒåå‚æ•°ä¸€è‡´ï¼›</li><li>â€“leader-elect=trueï¼šé›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œå¯ç”¨é€‰ä¸¾åŠŸèƒ½ï¼›è¢«é€‰ä¸º leader çš„èŠ‚ç‚¹è´Ÿè´£å¤„ç†å·¥ä½œï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ï¼›</li><li>â€“controllers=*,bootstrapsigner,tokencleanerï¼šå¯ç”¨çš„æ§åˆ¶å™¨åˆ—è¡¨ï¼Œtokencleaner ç”¨äºè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ Bootstrap tokenï¼›</li><li>â€“horizontal-pod-autoscaler-*ï¼šcustom metrics ç›¸å…³å‚æ•°ï¼Œæ”¯æŒ autoscaling/v2alpha1ï¼›</li><li>â€“tls-cert-fileã€â€“tls-private-key-fileï¼šä½¿ç”¨ https è¾“å‡º metrics æ—¶ä½¿ç”¨çš„ Server è¯ä¹¦å’Œç§˜é’¥ï¼›</li><li>â€“use-service-account-credentials=true: kube-controller-manager ä¸­å„ controller ä½¿ç”¨ serviceaccount è®¿é—® kube-apiserverï¼›</li></ul><h4 id="9-4ã€å¯åŠ¨-kube-controller-manager-æœåŠ¡"><a href="#9-4ã€å¯åŠ¨-kube-controller-manager-æœåŠ¡" class="headerlink" title="9.4ã€å¯åŠ¨ kube-controller-manager æœåŠ¡"></a>9.4ã€å¯åŠ¨ kube-controller-manager æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-controller-manager</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager &amp;&amp; systemctl status kube-controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # netstat -lnpt | grep kube-cont</span></span><br><span class="line">tcp6       0      0 :::10252                :::*                    LISTEN      8335/kube-controlle</span><br></pre></td></tr></table></figure><h4 id="9-5ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics"><a href="#9-5ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics" class="headerlink" title="9.5ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics"></a>9.5ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics</h4><p><strong>æ³¨æ„:</strong> ä»¥ä¸‹å‘½ä»¤åœ¨ kube-controller-manager èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.17.30:10252/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="9-6-kube-controller-manager-çš„æƒé™"><a href="#9-6-kube-controller-manager-çš„æƒé™" class="headerlink" title="9.6 kube-controller-manager çš„æƒé™"></a>9.6 kube-controller-manager çš„æƒé™</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClusteRole system:kube-controller-manager çš„æƒé™å¾ˆå°ï¼Œåªèƒ½åˆ›å»º secretã€serviceaccount ç­‰èµ„æºå¯¹è±¡ï¼Œå„ controller çš„æƒé™åˆ†æ•£åˆ° ClusterRole system:controller:XXX ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kube-controller-manager</span></span><br><span class="line">Name:         system:kube-controller-manager</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                                  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                                  -----------------  --------------  -----</span><br><span class="line">  secrets                                    []                 []              [create delete get update]</span><br><span class="line">  endpoints                                  []                 []              [create get update]</span><br><span class="line">  serviceaccounts                            []                 []              [create get update]</span><br><span class="line">  events                                     []                 []              [create patch update]</span><br><span class="line">  tokenreviews.authentication.k8s.io         []                 []              [create]</span><br><span class="line">  subjectaccessreviews.authorization.k8s.io  []                 []              [create]</span><br><span class="line">  configmaps                                 []                 []              [get]</span><br><span class="line">  namespaces                                 []                 []              [get]</span><br><span class="line">  *.*                                        []                 []              [list watch]</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éœ€è¦åœ¨ kube-controller-manager çš„å¯åŠ¨å‚æ•°ä¸­æ·»åŠ  â€“use-service-account-credentials=true å‚æ•°ï¼Œè¿™æ · main controller ä¼šä¸ºå„ controller åˆ›å»ºå¯¹åº”çš„ ServiceAccount XXX-controllerã€‚å†…ç½®çš„ ClusterRoleBinding system:controller:XXX å°†èµ‹äºˆå„ XXX-controller ServiceAccount å¯¹åº”çš„ ClusterRole system:controller:XXX æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get clusterrole|grep controller</span></span><br><span class="line">system:controller:attachdetach-controller                              4h52m</span><br><span class="line">system:controller:certificate-controller                               4h52m</span><br><span class="line">system:controller:clusterrole-aggregation-controller                   4h52m</span><br><span class="line">system:controller:cronjob-controller                                   4h52m</span><br><span class="line">system:controller:daemon-set-controller                                4h52m</span><br><span class="line">system:controller:deployment-controller                                4h52m</span><br><span class="line">system:controller:disruption-controller                                4h52m</span><br><span class="line">system:controller:endpoint-controller                                  4h52m</span><br><span class="line">system:controller:expand-controller                                    4h52m</span><br><span class="line">system:controller:generic-garbage-collector                            4h52m</span><br><span class="line">system:controller:horizontal-pod-autoscaler                            4h52m</span><br><span class="line">system:controller:job-controller                                       4h52m</span><br><span class="line">system:controller:namespace-controller                                 4h52m</span><br><span class="line">system:controller:node-controller                                      4h52m</span><br><span class="line">system:controller:persistent-volume-binder                             4h52m</span><br><span class="line">system:controller:pod-garbage-collector                                4h52m</span><br><span class="line">system:controller:pv-protection-controller                             4h52m</span><br><span class="line">system:controller:pvc-protection-controller                            4h52m</span><br><span class="line">system:controller:replicaset-controller                                4h52m</span><br><span class="line">system:controller:replication-controller                               4h52m</span><br><span class="line">system:controller:resourcequota-controller                             4h52m</span><br><span class="line">system:controller:route-controller                                     4h52m</span><br><span class="line">system:controller:service-account-controller                           4h52m</span><br><span class="line">system:controller:service-controller                                   4h52m</span><br><span class="line">system:controller:statefulset-controller                               4h52m</span><br><span class="line">system:controller:ttl-controller                                       4h52m</span><br><span class="line">system:kube-controller-manager                                         4h52m</span><br></pre></td></tr></table></figure><ul><li>ä»¥ deployment controller ä¸ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:controller:deployment-controller</span></span><br><span class="line">Name:         system:controller:deployment-controller</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                          Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                          -----------------  --------------  -----</span><br><span class="line">  replicasets.apps                   []                 []              [create delete get list patch update watch]</span><br><span class="line">  replicasets.extensions             []                 []              [create delete get list patch update watch]</span><br><span class="line">  events                             []                 []              [create patch update]</span><br><span class="line">  pods                               []                 []              [get list update watch]</span><br><span class="line">  deployments.apps                   []                 []              [get list update watch]</span><br><span class="line">  deployments.extensions             []                 []              [get list update watch]</span><br><span class="line">  deployments.apps/finalizers        []                 []              [update]</span><br><span class="line">  deployments.apps/status            []                 []              [update]</span><br><span class="line">  deployments.extensions/finalizers  []                 []              [update]</span><br><span class="line">  deployments.extensions/status      []                 []              [update]</span><br></pre></td></tr></table></figure></li></ul><h4 id="9-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#9-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="9.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>9.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get endpoints kube-controller-manager --namespace=kube-system  -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"k8s-master-01-2.kxl_8890f530-d829-11e9-873f-fa163e5af833","leaseDurationSeconds":15,"acquireTime":"2019-09-16T06:00:15Z","renewTime":"2019-09-16T07:05:38Z","leaderTransitions":1&#125;'</span></span><br><span class="line">  creationTimestamp: <span class="string">"2019-09-16T02:27:06Z"</span></span><br><span class="line">  name: kube-controller-manager</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"25734"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager</span><br><span class="line">  uid: 7a5b872e-d829-11e9-9b67-fa163effd55b</span><br></pre></td></tr></table></figure><p>å½“å‰çš„ leader ä¸ºk8s-master-01-2èŠ‚ç‚¹ã€‚</p><p>æµ‹è¯• kube-controller-manager é›†ç¾¤çš„é«˜å¯ç”¨,åœæ‰ä¸€ä¸ªæˆ–ä¸¤ä¸ªèŠ‚ç‚¹çš„ kube-controller-manager æœåŠ¡ï¼Œè§‚å¯Ÿå…¶å®ƒèŠ‚ç‚¹çš„æ—¥å¿—ï¼Œçœ‹æ˜¯å¦è·å–äº† leader æƒé™ã€‚</p><h3 id="10ã€scheduleré›†ç¾¤"><a href="#10ã€scheduleré›†ç¾¤" class="headerlink" title="10ã€scheduleré›†ç¾¤"></a>10ã€scheduleré›†ç¾¤</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3 ä¸ªèŠ‚ç‚¹ï¼Œå¯åŠ¨åå°†é€šè¿‡ç«äº‰é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“ leader èŠ‚ç‚¹ä¸å¯ç”¨åï¼Œå‰©ä½™èŠ‚ç‚¹å°†å†æ¬¡è¿›è¡Œé€‰ä¸¾äº§ç”Ÿæ–°çš„ leader èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ã€‚</p><p>ä¸ºä¿è¯é€šä¿¡å®‰å…¨ï¼Œæœ¬æ–‡æ¡£å…ˆç”Ÿæˆ x509 è¯ä¹¦å’Œç§é’¥ï¼Œkube-scheduler åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨è¯¥è¯ä¹¦ï¼š<br>1.ä¸ kube-apiserver çš„å®‰å…¨ç«¯å£é€šä¿¡;<br>2.åœ¨å®‰å…¨ç«¯å£(httpsï¼Œ10251) è¾“å‡º prometheus æ ¼å¼çš„ metricsï¼›</p><h4 id="10-1ã€åˆ›å»º-kube-scheduler-è¯ä¹¦å’Œç§é’¥"><a href="#10-1ã€åˆ›å»º-kube-scheduler-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="10.1ã€åˆ›å»º kube-scheduler è¯ä¹¦å’Œç§é’¥"></a>10.1ã€åˆ›å»º kube-scheduler è¯ä¹¦å’Œç§é’¥</h4><ul><li><p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.21.17.30"</span>,</span><br><span class="line">      <span class="string">"172.21.17.31"</span>,</span><br><span class="line">      <span class="string">"172.21.16.110"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"4Paradigm"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>hosts åˆ—è¡¨åŒ…å«æ‰€æœ‰ kube-scheduler èŠ‚ç‚¹ IPï¼›</p></li><li><p>CN å’Œ O å‡ä¸º system:kube-schedulerï¼Œkubernetes å†…ç½®çš„ ClusterRoleBindings system:kube-scheduler å°†èµ‹äºˆ kube-scheduler å·¥ä½œæ‰€éœ€çš„æƒé™ï¼›</p></li><li><p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ls kube-scheduler*pem</span></span><br><span class="line">kube-scheduler-key.pem  kube-scheduler.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler*pem  /etc/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="10-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶"><a href="#10-2ã€åˆ›å»ºå’Œåˆ†å‘-kubeconfig-æ–‡ä»¶" class="headerlink" title="10.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶"></a>10.2ã€åˆ›å»ºå’Œåˆ†å‘ kubeconfig æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kube-scheduler ä½¿ç”¨ kubeconfig æ–‡ä»¶è®¿é—® apiserverï¼Œè¯¥æ–‡ä»¶æä¾›äº† apiserver åœ°å€ã€åµŒå…¥çš„ CA è¯ä¹¦å’Œ kube-scheduler è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-credentials system:kube-scheduler \</span></span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config set-context system:kube-scheduler \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config use-context system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler.kubeconfig /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><h4 id="10-3ã€åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶"><a href="#10-3ã€åˆ›å»º-kube-scheduler-é…ç½®æ–‡ä»¶" class="headerlink" title="10.3ã€åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶"></a>10.3ã€åˆ›å»º kube-scheduler é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;kube-scheduler.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeSchedulerConfiguration</span><br><span class="line">bindTimeoutSeconds: 600</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-scheduler.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">enableContentionProfiling: <span class="literal">false</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">hardPodAffinitySymmetricWeight: 1</span><br><span class="line">healthzBindAddress: <span class="comment">##NODE_IP##:10251</span></span><br><span class="line">leaderElection:</span><br><span class="line">  leaderElect: <span class="literal">true</span></span><br><span class="line">metricsBindAddress: <span class="comment">##NODE_IP##:10251</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp kube-scheduler.yaml /etc/kubernetes/</span></span><br></pre></td></tr></table></figure><ul><li>â€“kubeconfigï¼šæŒ‡å®š kubeconfig æ–‡ä»¶è·¯å¾„ï¼Œkube-scheduler ä½¿ç”¨å®ƒè¿æ¥å’ŒéªŒè¯ kube-apiserverï¼›</li><li>â€“leader-elect=trueï¼šé›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œå¯ç”¨é€‰ä¸¾åŠŸèƒ½ï¼›è¢«é€‰ä¸º leader çš„èŠ‚ç‚¹è´Ÿè´£å¤„ç†å·¥ä½œï¼Œå…¶å®ƒèŠ‚ç‚¹ä¸ºé˜»å¡çŠ¶æ€ï¼›</li></ul><h4 id="10-4ã€åˆ›å»º-kube-scheduler-systemd-unit-æ¨¡æ¿æ–‡ä»¶"><a href="#10-4ã€åˆ›å»º-kube-scheduler-systemd-unit-æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="10.4ã€åˆ›å»º kube-scheduler systemd unit æ¨¡æ¿æ–‡ä»¶"></a>10.4ã€åˆ›å»º kube-scheduler systemd unit æ¨¡æ¿æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-scheduler.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/<span class="built_in">log</span>/k8s/kube-scheduler</span><br><span class="line">ExecStart=/usr/bin/kube-scheduler \</span><br><span class="line">  --config=/etc/kubernetes/kube-scheduler.yaml \</span><br><span class="line">  --<span class="built_in">bind</span>-address=0.0.0.0 \</span><br><span class="line">  --secure-port=10259 \</span><br><span class="line">  --port=0 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem \</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-allowed-names=<span class="string">""</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="10-5ã€å¯åŠ¨-kube-scheduler-æœåŠ¡"><a href="#10-5ã€å¯åŠ¨-kube-scheduler-æœåŠ¡" class="headerlink" title="10.5ã€å¯åŠ¨ kube-scheduler æœåŠ¡"></a>10.5ã€å¯åŠ¨ kube-scheduler æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/k8s/kube-scheduler</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler &amp;&amp; systemctl status kube-scheduler</span></span><br></pre></td></tr></table></figure><h4 id="10-6ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics"><a href="#10-6ã€æŸ¥çœ‹è¾“å‡ºçš„-metrics" class="headerlink" title="10.6ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics"></a>10.6ã€æŸ¥çœ‹è¾“å‡ºçš„ metrics</h4><p>kube-scheduler ç›‘å¬ 10251 å’Œ 10251 ç«¯å£ï¼š</p><ul><li>10251ï¼šæ¥æ”¶ http è¯·æ±‚ï¼Œéå®‰å…¨ç«¯å£ï¼Œä¸éœ€è¦è®¤è¯æˆæƒ</li><li>10259ï¼šæ¥æ”¶ https è¯·æ±‚ï¼Œå®‰å…¨ç«¯å£ï¼Œéœ€è¦è®¤è¯æˆæƒ</li></ul><p>ä¸¤ä¸ªæ¥å£éƒ½å¯¹å¤–æä¾› /metrics å’Œ /healthz çš„è®¿é—®ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat -lnpt |grep kube-sch</span></span><br><span class="line">tcp        0      0 172.21.17.31:10251      0.0.0.0:*               LISTEN      8441/kube-scheduler </span><br><span class="line">tcp6       0      0 :::10259                :::*                    LISTEN      8441/kube-scheduler</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s http://172.21.17.30:10251/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.17.30:10259/metrics |head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="10-7ã€æŸ¥çœ‹å½“å‰çš„-leader"><a href="#10-7ã€æŸ¥çœ‹å½“å‰çš„-leader" class="headerlink" title="10.7ã€æŸ¥çœ‹å½“å‰çš„ leader"></a>10.7ã€æŸ¥çœ‹å½“å‰çš„ leader</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kubectl get endpoints kube-scheduler --namespace=kube-system  -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"k8s-master-01.kxl_2a6e0bf9-d82b-11e9-b946-fa163effd55b","leaseDurationSeconds":15,"acquireTime":"2019-09-16T06:00:28Z","renewTime":"2019-09-16T07:41:57Z","leaderTransitions":1&#125;'</span></span><br><span class="line">  creationTimestamp: <span class="string">"2019-09-16T02:38:55Z"</span></span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"29215"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-scheduler</span><br><span class="line">  uid: 20a04151-d82b-11e9-baf3-fa163e53d4c8</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kuberntes v1.14</tag>
      </tags>
  </entry>
  <entry>
    <title>è·¯ç”±å™¨ç«¯å£æ˜ å°„</title>
    <url>/2019/09/10/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œh3c MSR3620è·¯ç”±å™¨åšç«¯å£æ˜ å°„åˆ°åç«¯æœåŠ¡å™¨,åŒ…å«å•ä¸ªç«¯å£å’Œç«¯å£æ®µçš„æ˜ å°„</p><a id="more"></a><h3 id="å•ä¸ªç«¯å£çš„æ˜ å°„"><a href="#å•ä¸ªç«¯å£çš„æ˜ å°„" class="headerlink" title="å•ä¸ªç«¯å£çš„æ˜ å°„"></a>å•ä¸ªç«¯å£çš„æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[router] interface GigabitEthernet0/2 å…¬ç½‘ipæ¥å£</span><br><span class="line">[router] nat server protocol tcp global å…¬ç½‘ip 80 inside å†…ç½‘ip 80</span><br></pre></td></tr></table></figure><h3 id="å¤šç«¯å£"><a href="#å¤šç«¯å£" class="headerlink" title="å¤šç«¯å£"></a>å¤šç«¯å£</h3><p>vsftpå¯ä»¥ä½¿ç”¨è¿™ä¸ª</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[router] interface GigabitEthernet0/2 å…¬ç½‘ipæ¥å£</span><br><span class="line">[router] nat server protocol tcp global current-interface 9000 9045 inside å†…ç½‘ip 9000 9045</span><br></pre></td></tr></table></figure><p><strong>å¤‡æ³¨:</strong> å¯ä»¥ä½¿ç”¨vsftpåœºæ™¯ï¼Œ<a href="https://xxlaila.github.io/2019/08/09/vsftpd%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">vsftpå®‰è£…</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>MSR3620</tag>
      </tags>
  </entry>
  <entry>
    <title>traefik httpsåº”ç”¨</title>
    <url>/2019/09/06/traefik-https%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰å·²ç»ä½¿ç”¨traefikæœåŠ¡ä½œä¸ºå…¥å£ï¼Œæµ‹è¯•å¹¶è®¿é—®äº†tomcatåº”ç”¨ï¼Œä¹‹å‰æ˜¯é€šè¿‡httpæ¥è®¿é—®çš„ï¼Œè€Œæˆ‘ä»¬åœ¨yamlæ–‡ä»¶é‡Œé¢ä¹Ÿæ·»åŠ 8443ç«¯å£ç”¨äºhttpsè®¿é—®ï¼Œåœ¨å®é™…ç¯å¢ƒä¸­æˆ‘ä»¬ä¹Ÿæ˜¯éœ€è¦httpsæ¥è¿›è¡Œè®¿é—®åº”ç”¨ï¼Œé€šè¿‡traefikå®ç°httpsï¼Œ<a href="https://xxlaila.github.io/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">traefik httpåº”ç”¨</a></p><h3 id="æ“ä½œå®è·µ"><a href="#æ“ä½œå®è·µ" class="headerlink" title="æ“ä½œå®è·µ"></a>æ“ä½œå®è·µ</h3><ul><li>è¿™é‡Œæˆ‘ç”¨äº†å…¬å¸çš„è¯ä¹¦ï¼Œå°±æ˜¯ä¸ºäº†è´´è¿‘çœŸå®ï¼Œä¹Ÿæ»¡è¶³æµ‹è¯•éœ€æ±‚ï¼Œ</li><li>åˆ›å»ºä¸€ä¸ªsecretï¼Œä¿å­˜httpsè¯ä¹¦</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">1_test.xxlaila.cn_bundle.crt  2_test.xxlaila.cn.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create secret generic traefik-cert --from-file=1_test.xxlaila.cn_bundle.crt --from-file=2_test.xxlaila.cn.key -n kube-system</span></span><br><span class="line">secret/traefik-cert created</span><br></pre></td></tr></table></figure><p>æŠŠè¯ä¹¦æ‹·è´åˆ°k8s nodeèŠ‚ç‚¹ï¼Œå­˜æ”¾è·¯å¾„ä¸º/etc/kubernetes/certsã€‚</p><h3 id="åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®"><a href="#åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®" class="headerlink" title="åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®"></a>åˆ›å»ºä¸€ä¸ªconfigmapï¼Œä¿å­˜traefixçš„é…ç½®</h3><p>traefixä¸­é…ç½®äº†æŠŠæ‰€æœ‰httpè¯·æ±‚å…¨éƒ¨rewriteä¸ºhttpsçš„è§„åˆ™ï¼Œå¹¶é…ç½®ç›¸åº”çš„è¯ä¹¦ä½ç½®</p><ul><li>traefik.toml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_test.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_test.xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line">$ kubectl create configmap traefik-conf --from-file=traefik.toml -n kube-system</span><br><span class="line">configmap/traefik-conf created</span><br></pre></td></tr></table></figure></li></ul><p>æŠŠtraefik.tomlæ–‡ä»¶æ‹·è´åˆ°k8s nodeèŠ‚ç‚¹,å­˜æ”¾è·¯å¾„ä¸º/etc/kubernetes/confã€‚</p><h3 id="é‡æ–°éƒ¨ç½²Traefix"><a href="#é‡æ–°éƒ¨ç½²Traefix" class="headerlink" title="é‡æ–°éƒ¨ç½²Traefix"></a>é‡æ–°éƒ¨ç½²Traefix</h3><p>ä¸»è¦æ˜¯è¦å…³è”åˆ›å»ºçš„secretå’ŒconfigMapï¼Œå¹¶æŒ‚è½½ç›¸å¯¹åº”çš„ä¸»æœºç›®å½•ã€‚</p><ul><li>deployment.yaml</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat deployment.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/certs"</span></span><br><span class="line">          name: <span class="string">"ssl"</span></span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/conf"</span></span><br><span class="line">          name: <span class="string">"config"</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --configFile=/etc/kubernetes/conf/traefik.toml</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f deployment.yaml </span><br><span class="line">deployment.extensions/traefik-ingress-lb configured</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•æ•ˆæœ"><a href="#æµ‹è¯•æ•ˆæœ" class="headerlink" title="æµ‹è¯•æ•ˆæœ"></a>æµ‹è¯•æ•ˆæœ</h3><p>ç™»é™†traefik-uiç•Œé¢,ç”¨åŸæœ¬httpçš„è®¿é—®ï¼Œtraefikä¼šç›´æ¥ç»™æˆ‘ä»¬é‡å®šå‘è‡³httpsã€‚<br><img src="https://img.xxlaila.cn/1567748749337.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºtraefik-uiä½¿ç”¨çš„åŸŸåä¸æ˜¯æˆ‘ä»¬è¯ä¹¦æ‰€æ”¯æŒçš„åŸŸåï¼Œæ‰€ä»¥è¿™é‡Œæç¤ºä¸å®‰å…¨ï¼Œä¿®æ”¹ä¹‹å‰åˆ›å»ºçš„ingressï¼Œä¿®æ”¹å…¶ä¸­çš„åŸŸåä¸ºæ”¯æŒè¯ä¹¦çš„åŸŸå</p><ul><li>traefik-ui.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system </span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8580</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f traefik-ui.yaml </span><br><span class="line">service/traefik-web-ui unchanged</span><br><span class="line">ingress.extensions/traefik-web-ui configured</span><br></pre></td></tr></table></figure></li></ul><p>ä¿®æ”¹hostsç‰ˆå®šçš„åŸŸåè¿›è¡Œè®¿é—®<br><img src="https://img.xxlaila.cn/1567749086159.jpg" alt="img"></p><ul><li><p>ä¿®æ”¹ä¹‹å‰éƒ¨ç½²çš„tomcatç¨‹åº</p></li><li><p>ingress-tomcat.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.test.xxlaila.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /test1/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line">      - path: /test2/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ingress-tomcat.yaml </span><br><span class="line">ingress.extensions/tomcat-test-web configured</span><br></pre></td></tr></table></figure></li></ul><p>è®¿é—®é“¾æ¥æµ‹è¯•<br><img src="https://img.xxlaila.cn/1567749278980.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567749309772.jpg" alt="img"></p><h3 id="å…¶ä»–éœ€æ±‚"><a href="#å…¶ä»–éœ€æ±‚" class="headerlink" title="å…¶ä»–éœ€æ±‚"></a>å…¶ä»–éœ€æ±‚</h3><p>åœ¨æˆ‘ä»¬çœŸå®çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œéœ€æ±‚è‚¯å®šæœ‰ä¸åŒçš„ï¼Œæ¯”å¦‚æˆ‘æ‰€åœ¨çš„å…¬å¸å¼€å‘ç¯å¢ƒå°±è¦åªæ˜¯httpå’Œhttpsï¼Œæµ‹è¯•ç¯å¢ƒä»¥ä¸Šçš„å°±å…¨éƒ¨å¼ºåˆ¶httpsã€‚è¿™å°±å¾—åˆ†å¼€è¿›è¡Œé…ç½®</p><h4 id="åŒæ—¶æ”¯æŒhttpå’Œhttps"><a href="#åŒæ—¶æ”¯æŒhttpå’Œhttps" class="headerlink" title="åŒæ—¶æ”¯æŒhttpå’Œhttps"></a>åŒæ—¶æ”¯æŒhttpå’Œhttps</h4><p>æŠŠhttpä¸­çš„rewriteä»£ç æ”¹æ‰</p><ul><li>traefik.toml</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">defaultEntryPoints = [<span class="string">"http"</span>,<span class="string">"https"</span>]</span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    entryPoint = <span class="string">"https"</span></span><br><span class="line">  [entryPoints.https]</span><br><span class="line">  address = <span class="string">":443"</span></span><br><span class="line">    [entryPoints.https.tls]</span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_test.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_test.xxlaila.cn.key"</span></span><br><span class="line">      [[entryPoints.https.tls.certificates]]</span><br><span class="line">      certFile = <span class="string">"/etc/kubernetes/certs/1_dev.xxlaila.cn_bundle.crt"</span></span><br><span class="line">      keyFile = <span class="string">"/etc/kubernetes/certs/2_dev.xxlaila.cn.key"</span></span><br><span class="line"></span><br><span class="line">[file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># rules</span></span><br><span class="line">[entryPoints]</span><br><span class="line">  [entryPoints.http]</span><br><span class="line">  address = <span class="string">":80"</span></span><br><span class="line">    [entryPoints.http.redirect]</span><br><span class="line">      regex = <span class="string">"^http://traefix.test.xxlaila.cn/(.*)"</span></span><br><span class="line">      replacement = <span class="string">"https://traefix.test.xxlaila.cn/<span class="variable">$1</span>"</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>traefik ingressä½¿ç”¨</title>
    <url>/2019/09/05/traefik-ingress%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="Traefikä»‹ç»"><a href="#Traefikä»‹ç»" class="headerlink" title="Traefikä»‹ç»"></a>Traefikä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç®€å•çš„è¯´ï¼Œingresså°±æ˜¯ä»kubernetesé›†ç¾¤å¤–è®¿é—®é›†ç¾¤çš„å…¥å£ï¼Œå°†ç”¨æˆ·çš„URLè¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„serviceä¸Šã€‚Ingressç›¸å½“äºnginxã€apacheç­‰è´Ÿè½½å‡è¡¡åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬è§„åˆ™å®šä¹‰ï¼Œå³URLçš„è·¯ç”±ä¿¡æ¯ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traefikæ˜¯ä¸€æ¬¾å¼€æºçš„åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å·¥å…·ã€‚å®ƒæœ€å¤§çš„ä¼˜ç‚¹æ˜¯èƒ½å¤Ÿä¸å¸¸è§çš„å¾®æœåŠ¡ç³»ç»Ÿç›´æ¥æ•´åˆï¼Œå®ç°è‡ªåŠ¨åŒ–åŠ¨æ€é…ç½®ã€‚Traefiké€šè¿‡ä¸æ–­åœ°è·Ÿ kubernetes API æ‰“äº¤é“ï¼Œå®æ—¶çš„æ„ŸçŸ¥åç«¯ serviceã€pod ç­‰å˜åŒ–ï¼Œæ¯”å¦‚podï¼Œservice å¢åŠ ä¸å‡å°‘ç­‰ï¼›å½“å¾—åˆ°è¿™äº›å˜åŒ–ä¿¡æ¯åï¼ŒIngressè‡ªåŠ¨æ›´æ–°é…ç½®å¹¶çƒ­é‡è½½ ï¼Œè¾¾åˆ°æœåŠ¡å‘ç°çš„ä½œç”¨ã€‚</p><a id="more"></a><p>traefix æ•´ä½“æ¶æ„å›¾å¦‚ä¸‹:<br><img src="https://img.xxlaila.cn/34238937snkhfskdy8923.png" alt="img"></p><h3 id="Traefikä¸»è¦ç‰¹æ€§è¯¦è§£"><a href="#Traefikä¸»è¦ç‰¹æ€§è¯¦è§£" class="headerlink" title="Traefikä¸»è¦ç‰¹æ€§è¯¦è§£"></a>Traefikä¸»è¦ç‰¹æ€§è¯¦è§£</h3><ul><li><p>è‡ªåŠ¨ç†”æ–­</p><ul><li>åœ¨é›†ç¾¤ä¸­ï¼Œå½“æŸä¸€ä¸ªæœåŠ¡å¤§é‡å‡ºç°è¯·æ±‚é”™è¯¯ï¼Œæˆ–è€…è¯·æ±‚å“åº”æ—¶é—´è¿‡ä¹…ï¼Œæˆ–è€…è¿”å›500+é”™è¯¯çŠ¶æ€ç æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥ä¸»åŠ¨å‰”é™¤è¯¥æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸åœ¨å°†è¯·æ±‚è½¬å‘åˆ°è¯¥æœåŠ¡ä¸Šï¼Œè€Œè¿™ä¸€ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦äººå·¥æ‰§è¡Œã€‚Traefik é€šè¿‡é…ç½®å¾ˆå®¹æ˜“å°±èƒ½å¸®æˆ‘ä»¬å®ç°ï¼ŒTraefik å¯ä»¥é€šè¿‡å®šä¹‰ç­–ç•¥æ¥ä¸»åŠ¨ç†”æ–­æœåŠ¡ã€‚</li><li>NetworkErrorRatio() &gt; 0.5ï¼šç›‘æµ‹æœåŠ¡é”™è¯¯ç‡è¾¾åˆ°50%æ—¶ï¼Œç†”æ–­</li><li>LatencyAtQuantileMS(50.0) &gt; 50ï¼šç›‘æµ‹å»¶æ—¶å¤§äº50msæ—¶ï¼Œç†”æ–­</li><li>ResponseCodeRatio(500, 600, 0, 600) &gt; 0.5ï¼šç›‘æµ‹è¿”å›çŠ¶æ€ç ä¸º[500-600]åœ¨[0-600]åŒºé—´å æ¯”è¶…è¿‡50%æ—¶ï¼Œç†”æ–­</li></ul></li><li><p>è´Ÿè½½å‡è¡¡ç­–ç•¥</p><ul><li>Traefik æä¾›ä¸¤ç§è´Ÿè½½å‡è¡¡ç­–ç•¥æ”¯æŒã€‚ä¸€ç§æ˜¯ wrrï¼ˆåŠ æƒè½®è®­è°ƒåº¦ç®—æ³•ï¼‰ï¼Œä¸€ç§æ˜¯ drrï¼ˆåŠ¨æ€åŠ æƒå¾ªç¯è°ƒåº¦ç®—æ³•ï¼‰</li><li>wrræ˜¯é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œæ–°åˆ›å»ºçš„ service æƒé‡éƒ½æ˜¯ä¸€æ ·ä¸º1ï¼Œè¿™æ ·çš„è¯ï¼Œè¯·æ±‚ä¼šå¹³å‡åˆ†ç»™æ¯ä¸ªæœåŠ¡ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå¤šæ—¶å€™ä¼šå‡ºç°èµ„æºåˆ†é…ä¸å‡è¡¡çš„é—®é¢˜ï¼Œæ¯”å¦‚ç”±äºé›†ç¾¤ä¸­æ¯ä¸ªæœºå™¨é…ç½®ä¸ä¸€æ ·ï¼Œè€Œä¸”æœåŠ¡æ¶ˆè€—ä¸ä¸€æ ·ï¼Œå‡è®¾ A èµ„æºä½¿ç”¨ç‡å·²ç»å¾ˆé«˜ï¼Œè€Œ B å±äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœè¿˜æ˜¯å‡æ‘Šåˆ°æ¯ä¸ªæœåŠ¡çš„è¯ï¼Œä¼šåŠ é‡ A çš„è´Ÿè·ï¼Œè¿™æ—¶å€™å› è¯¥æœ‰ä¸€ç§ç­–ç•¥èƒ½å¤Ÿä¸»åŠ¨è¯†åˆ«å¹¶åˆ†æ‹…æ›´å¤šæµé‡åˆ° B æ‰å¯¹</li><li>drr å°±æ›´åŠ æ™ºèƒ½ï¼Œå®ƒæ˜¯ä¸€ç§åŠ¨æ€åŠ æƒè½®è®­è°ƒåº¦æ–¹å¼ï¼Œå®ƒä¼šè®°å½•ä¸€æ®µæ—¶é—´å†…è½¬å‘åˆ° A çš„è¯·æ±‚æ•°ï¼Œè·Ÿè½¬å‘åˆ° B çš„è¯·æ±‚æ•°å¯¹æ¯”ï¼Œè½¬å‘æ•°é‡å¤šï¼Œè¯´æ˜å¤„ç†é€Ÿåº¦å¿«ï¼Œå“åº”æ—¶é—´å¿«ã€‚å¦‚æœ A å¤„ç†è¯·æ±‚é€Ÿåº¦æ¯” B å¿«ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒæ•´ A çš„æƒé‡ï¼Œæ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ï¼Œå°±ä¼šè½¬å‘æ›´å¤šè¯·æ±‚ç»™ Aï¼Œç›¸åº”çš„ B çš„è½¬å‘å°±å°‘ä¸€äº›ã€‚æ•´ä¸ªè¿‡ç¨‹éƒ½åœ¨ä¸æ–­çš„è°ƒæ•´æƒé‡ï¼Œå®ç°è¯·æ±‚çš„åˆç†åˆ†é…ï¼Œä»è€Œè¾¾åˆ°èµ„æºä½¿ç”¨æœ€å¤§åŒ–</li></ul></li></ul><h3 id="éƒ¨ç½²Traefik-ingress"><a href="#éƒ¨ç½²Traefik-ingress" class="headerlink" title="éƒ¨ç½²Traefik ingress"></a>éƒ¨ç½²Traefik ingress</h3><ul><li><p>åˆ›å»ºingress-rbac.yamlï¼Œå°†ç”¨äºservice accountéªŒè¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat ingress-rbac.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: ingress</span><br><span class="line">    namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºDepeloymentéƒ¨ç½²traefikï¼Œå¦‚æ–‡ä»¶åä¸ºdeployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>æ³¨æ„</strong>: æˆ‘ä»¬è¿™é‡Œç”¨çš„æ˜¯Deployç±»å‹ï¼Œæ²¡æœ‰é™å®šè¯¥podè¿è¡Œåœ¨å“ªä¸ªä¸»æœºä¸Šã€‚Traefikçš„ç«¯å£æ˜¯8580ã€‚</li></ul><ul><li>ç¼–å†™Traefik UIçš„ingresséƒ¨ç½²æ–‡ä»¶ï¼Œå¦‚æ–‡ä»¶åä¸ºtraefik-ui.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system <span class="comment">#å¢åŠ è¡Œ</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8580</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-web-ui</span><br><span class="line">          servicePort: web</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><ul><li><code>backend</code>ä¸­è¦é…ç½®default namespaceä¸­å¯åŠ¨çš„serviceåå­—ã€‚</li><li><code>path</code>å°±æ˜¯URLåœ°å€åçš„è·¯å¾„ï¼Œå¦‚<code>traefik.frontend.io/path</code>ï¼Œserviceå°†ä¼šæ¥å—pathè¿™ä¸ªè·¯å¾„</li><li><code>host</code>æœ€å¥½ä½¿ç”¨service-name.filed1.filed2.domain-nameè¿™ç§ç±»ä¼¼ä¸»æœºåç§°çš„å‘½åæ–¹å¼ï¼Œæ–¹ä¾¿åŒºåˆ†æœåŠ¡ã€‚</li></ul><ul><li><strong>é€¼é€¼ä¸€ä¸‹</strong>: ç›®å‰æˆ‘æ‰€åœ¨çš„å…¬å¸åç«¯å¾®æœåŠ¡100+ï¼Œå‰ç«¯60+ï¼Œå¦‚æœç”¨ä¼ ç»Ÿnginxçš„localæ¥åŒ¹é…ï¼Œä¼°è®¡è¦å†™æ­»äººï¼Œè€Œä¸”å¯¹äºè¿ç»´è‡ªåŠ¨åŒ–æ¥ä¹Ÿä¸æ˜¯å¾ˆå¥½åšï¼Œå†åˆ™æ˜¯å‡ºäº†é—®é¢˜ä¹Ÿè¿˜è¦å»çœ‹ä¸€ä¸‹æ˜¯å“ªä¸ªåº”ç”¨ï¼›æˆ‘ä»¬ç›®å‰æ˜¯é€šè¿‡æ¯ä¸ªæœåŠ¡æ¯ä¸€ä¸ªåŸŸåï¼ŒåŸŸåæ˜¯æ ¹æ®æœåŠ¡åæ¥è‡ªåŠ¨ç”Ÿæˆï¼Œé™¤äº†å‡ ä¸ªç‰¹å®šå¯¹å¤–å…¬å¼€çš„æ˜¯ç‰¹åˆ¶çš„åŸŸåï¼Œå…¶ä»–çš„å‡é‡‡ç”¨è¿™ç§æœºåˆ¶ï¼Œå½“æœ‰é—®é¢˜çš„æ—¶å€™ï¼Œä¸€ä¸‹å°±èƒ½åˆ¤æ–­å‡ºé‚£é‡Œå‡ºé—®é¢˜ï¼Œå¾ˆå¥½å®šä½ï¼Œæœ‰åŸŸåæœ‰ç‰¹æ®Šé…ç½®çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å•ç‹¬çš„è¿›è¡Œè®¾ç½®ï¼Œä½†æ˜¯æˆªæ­¢ç›®å‰ä¸¤å¹´å¤šæ¥ï¼Œè¿ç»´æ‹’ç»è¿™ç§ç‰¹æ®Šéœ€æ±‚(æœ‰è¿˜æœ‰ï¼Œå¾ˆå°‘ï¼Œåªæœ‰é‚£ä¹ˆä¸¤ä¸‰ä¸ª)</li></ul><ul><li><p>é…ç½®å®Œæˆåå°±å¯ä»¥å¯åŠ¨treafik ingressäº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line">deployment.extensions/traefik-ingress-lb created</span><br><span class="line">serviceaccount/ingress created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/ingress created</span><br><span class="line">service/traefik-web-ui created</span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system | grep traefik</span></span><br><span class="line"></span><br><span class="line">traefik-ingress-lb-5d7f658cfd-4vkjc     1/1     Running   0          29m</span><br><span class="line">traefik-ingress-lb-5d7f658cfd-7sszp     1/1     Running   0          19m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get ingress -o wide --all-namespaces </span></span><br><span class="line">NAMESPACE     NAME                HOSTS                ADDRESS   PORTS   AGE</span><br><span class="line">kube-system   traefik-web-ui      traefik.xxlaila.io             80      29m</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨æµè§ˆå™¨ç»‘å®šhostsåŸŸåè§£æï¼Œnodeçš„ipåœ°å€ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥traefik.xxlaila.ioå³å¯è®¿é—®äº†<br><img src="https://img.xxlaila.cn/1567676343800.jpg" alt="img"></p><p>å·¦ä¾§è“è‰²éƒ¨åˆ†åˆ—å‡ºçš„æ˜¯æ‰€æœ‰çš„å‰ç«¯(frontends)ï¼Œå³ä¾§ç»¿è‰²éƒ¨åˆ†æ˜¯æ‰€æœ‰çš„åç«¯(backend)ã€‚</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ä¸‹é¢æ¨¡æ‹Ÿéƒ¨ç½²ä¸€ä¸ªç¨‹åºï¼Œä»¥Nginx ä¸ºä¾‹ï¼Œå¹¶ä½¿ç”¨drråŠ¨æ€è½®è®­åŠ æƒç­–ç•¥ã€‚</p><ul><li><p>nginx-deployment.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.15.5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-service</span><br><span class="line">  annotations:</span><br><span class="line">    traefik.ingress.kubernetes.io/load-balancer-method: drr</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx-service</span><br><span class="line">        namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-pod</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: k8s.nginx.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx-service</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºnginx</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f nginx-deployment.yaml </span></span><br><span class="line">deployment.apps/nginx-pod created</span><br><span class="line">service/nginx-service created</span><br><span class="line">ingress.extensions/nginx-ingress created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰€æœ‰è®¿é—®è¿™äº›åœ°å€çš„æµé‡éƒ½ä¼šå‘é€ç»™172.16.0.180è¿™å°ä¸»æœºï¼Œå°±æ˜¯æˆ‘ä»¬å¯åŠ¨traefikçš„ä¸»æœºã€‚Traefikä¼šè§£æhttpè¯·æ±‚headeré‡Œçš„Hostå‚æ•°å°†æµé‡è½¬å‘ç»™Ingressé…ç½®é‡Œçš„ç›¸åº”serviceã€‚<br><img src="https://img.xxlaila.cn/1567676984150.jpg" alt="img"></p><p>å®¢æˆ·ç«¯ç»‘å®šhostï¼Œæµè§ˆå™¨è¿›è¡Œè®¿é—®: <a href="http://k8s.nginx.com" target="_blank" rel="noopener">http://k8s.nginx.com</a><br><img src="https://img.xxlaila.cn/1567677018297.jpg" alt="img"></p><p>åœ¨K8sé›†ç¾¤èŠ‚ç‚¹ä¸Šè®¿é—®æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -x 172.21.16.204 http://k8s.nginx.com</span></span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;503 Service Unavailable&lt;/h1&gt;</span><br><span class="line">No server is available to handle this request.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line">[root@k8s ~]<span class="comment"># curl -x 172.21.16.204:80 http://k8s.nginx.com</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h4 id="ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨"><a href="#ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨" class="headerlink" title="ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨"></a>ingressé…ç½®åŒåŸŸåä¸åŒè·¯å¾„ä»£ç†webåº”ç”¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¸æƒ³é…ç½®å¤ªå¤šçš„åŸŸåæ¥åŒºåˆ«åº”ç”¨ï¼Œä½¿ç”¨åŒåŸŸååˆ†è·¯å¾„çš„æ–¹å¼æ¥åŒºåˆ«åº”ç”¨å°±ç®€æ´æ–¹ä¾¿å¾ˆå¤šã€‚ingressä¹Ÿæä¾›äº†ç›¸å…³çš„é…ç½®ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‡è®¾ä¸¤ä¸ªåº”ç”¨tomcat-test1å’Œtomcat-test2ã€‚è¿™é‡Œå¯é…ç½®åŸŸåtomcat.xxlaila.ioï¼Œé€šè¿‡è·¯å¾„test1ã€test2æ¥åˆ†åˆ«ä»£ç†ä¸¤ä¸ªtomcatåº”ç”¨ã€‚å…¶ä¸­ï¼Œåˆ†è·¯å¾„é…ç½®éœ€æ·»åŠ é…ç½®ï¼štraefik.frontend.rule.type: PathPrefixStrip,é¦–å…ˆï¼Œæˆ‘å…ˆåˆ›å»ºtomcat-test1å’Œtomcat-test2çš„podå’Œserviceï¼Œå…¶ä¸­8080ä¸ºtomcatçš„httpç«¯å£ï¼Œ8443ä¸ºtomcatçš„httpsç«¯å£ï¼Œæœ¬ä¾‹ä¸­ä»…ä½¿ç”¨httpç«¯å£æµ‹è¯•ã€‚</p><ul><li><p>tomcat-test1.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1</span><br><span class="line">  labels: </span><br><span class="line">    app: tomcat-test1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1 </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-test1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-test1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-test1</span><br><span class="line">        image: tomcat</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1</span><br><span class="line">  labels:</span><br><span class="line">    name: tomcat-test1</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8443</span><br><span class="line">    targetPort: 8443</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test1</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080 </span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test1</span><br></pre></td></tr></table></figure></li><li><p>tomcat-test2.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test2</span><br><span class="line">  labels: </span><br><span class="line">    app: tomcat-test2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1 </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-test2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-test2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-test2</span><br><span class="line">        image: manjeetchauhan211/tomcat_test2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test2</span><br><span class="line">  labels:</span><br><span class="line">    name: tomcat-test2</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8443</span><br><span class="line">    targetPort: 8443</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080 </span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-test2</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"></span><br><span class="line">$ kubectl get deployment</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-pod      2/2     2            2           17h</span><br><span class="line">tomcat-test1   1/1     1            1           42m</span><br><span class="line">tomcat-test2   1/1     1            1           42m</span><br><span class="line"></span><br><span class="line">$ kubectl get svc</span><br><span class="line">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kubernetes       ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP    5d23h</span><br><span class="line">nginx-service    ClusterIP   10.254.149.69    &lt;none&gt;        80/TCP     17h</span><br><span class="line">tomcat-test1     ClusterIP   10.254.195.108   &lt;none&gt;        8080/TCP   42m</span><br><span class="line">tomcat-test2     ClusterIP   10.254.6.88      &lt;none&gt;        8080/TCP   42m</span><br><span class="line">traefik-web-ui   ClusterIP   10.254.22.102    &lt;none&gt;        80/TCP     17h</span><br></pre></td></tr></table></figure></li></ul><p>åˆ›å»ºtest1çš„ingressï¼Œæ¥å‘å¸ƒtomcat-test1æœåŠ¡</p><ul><li>ingress-tomcat1.yam<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat ingress-tomcat1.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test1-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f ingress-tomcat.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>åœ¨traefix-uiç•Œé¢ä¸Šï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æœ‰äº†ä¸€ä¸ª<code>tomcat.xxlaila.io</code>çš„åŸŸåè§„åˆ™.<br><img src="https://img.xxlaila.cn/1567739051461.jpg" alt="img"></p><p>åœ¨hostsæ–‡ä»¶æ·»åŠ tomcat.xxlaila.ioç»‘å®šæ¥è¿›è¡Œè®¿é—®<br><img src="https://img.xxlaila.cn/1567739162707.jpg" alt="img"></p><h5 id="ingressé…ç½®åŒåŸŸåå¯¹åº”location"><a href="#ingressé…ç½®åŒåŸŸåå¯¹åº”location" class="headerlink" title="ingressé…ç½®åŒåŸŸåå¯¹åº”location"></a>ingressé…ç½®åŒåŸŸåå¯¹åº”location</h5><ul><li><p>ingress-tomcat.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test-web</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /test1/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test1</span><br><span class="line">          servicePort: 8080</span><br><span class="line">      - path: /test2/</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-test2</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºå¹¶æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create -f ingress-tomcat.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl describe ingress tomcat-test-web</span><br><span class="line">Name:             tomcat-test-web</span><br><span class="line">Namespace:        default</span><br><span class="line">Address:          </span><br><span class="line">Default backend:  default-http-backend:80 (&lt;none&gt;)</span><br><span class="line">Rules:</span><br><span class="line">  Host               Path  Backends</span><br><span class="line">  ----               ----  --------</span><br><span class="line">  tomcat.xxlaila.io  </span><br><span class="line">                     /test1/   tomcat-test1:8080 (&lt;none&gt;)</span><br><span class="line">                     /test2/   tomcat-test2:8080 (&lt;none&gt;)</span><br><span class="line">Annotations:</span><br><span class="line">  traefik.frontend.rule.type:                        PathPrefixStrip</span><br><span class="line">  kubectl.kubernetes.io/last-applied-configuration:  &#123;<span class="string">"apiVersion"</span>:<span class="string">"extensions/v1beta1"</span>,<span class="string">"kind"</span>:<span class="string">"Ingress"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;<span class="string">"kubernetes.io/ingress.class"</span>:<span class="string">"traefik"</span>,<span class="string">"traefik.frontend.rule.type"</span>:<span class="string">"PathPrefixStrip"</span>&#125;,<span class="string">"name"</span>:<span class="string">"tomcat-test-web"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"rules"</span>:[&#123;<span class="string">"host"</span>:<span class="string">"tomcat.xxlaila.io"</span>,<span class="string">"http"</span>:&#123;<span class="string">"paths"</span>:[&#123;<span class="string">"backend"</span>:&#123;<span class="string">"serviceName"</span>:<span class="string">"tomcat-test1"</span>,<span class="string">"servicePort"</span>:8080&#125;,<span class="string">"path"</span>:<span class="string">"/test1/"</span>&#125;,&#123;<span class="string">"backend"</span>:&#123;<span class="string">"serviceName"</span>:<span class="string">"tomcat-test2"</span>,<span class="string">"servicePort"</span>:8080&#125;,<span class="string">"path"</span>:<span class="string">"/test2/"</span>&#125;]&#125;&#125;]&#125;&#125;</span><br><span class="line"></span><br><span class="line">  kubernetes.io/ingress.class:  traefik</span><br><span class="line">Events:                         &lt;none&gt;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç»™èŠ‚ç‚¹è®¾ç½®label"><a href="#ç»™èŠ‚ç‚¹è®¾ç½®label" class="headerlink" title="ç»™èŠ‚ç‚¹è®¾ç½®label"></a>ç»™èŠ‚ç‚¹è®¾ç½®label</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºæ˜¯ Kubernetes DeamonSet è¿™ç§æ–¹å¼éƒ¨ç½² Traefikï¼Œæ‰€ä»¥éœ€è¦æå‰ç»™èŠ‚ç‚¹è®¾ç½® Labelï¼Œè¿™æ ·å½“ç¨‹åºéƒ¨ç½²æ—¶ Pod ä¼šè‡ªåŠ¨è°ƒåº¦åˆ°è®¾ç½® Label çš„ç‚¹ä¸Šã€‚</p><h4 id="èŠ‚ç‚¹è®¾ç½®-Label-æ ‡ç­¾"><a href="#èŠ‚ç‚¹è®¾ç½®-Label-æ ‡ç­¾" class="headerlink" title="èŠ‚ç‚¹è®¾ç½® Label æ ‡ç­¾"></a>èŠ‚ç‚¹è®¾ç½® Label æ ‡ç­¾</h4><ul><li>æ ¼å¼ï¼škubectl label nodes [èŠ‚ç‚¹å] [key=value]<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> kubectl get nodes</span><br><span class="line">NAME            STATUS   ROLES    AGE    VERSION</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   7d5h   v1.13.3</span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   7d2h   v1.13.3</span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   7d2h   v1.13.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl label nodes 172.21.16.204 IngressProxy=true</span></span><br><span class="line">node/172.21.16.204 labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹labelè®¾ç½®æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment"># kubectl get nodes --show-labels</span></span><br><span class="line">NAME            STATUS   ROLES    AGE    VERSION   LABELS</span><br><span class="line">172.21.16.204   Ready    &lt;none&gt;   7d5h   v1.13.3   IngressProxy=<span class="literal">true</span>,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.204,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br><span class="line">172.21.16.240   Ready    &lt;none&gt;   7d2h   v1.13.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.240,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br><span class="line">172.21.16.87    Ready    &lt;none&gt;   7d2h   v1.13.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.21.16.87,node.kubernetes.io/k8s-node=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶"><a href="#ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶"></a>ä¿®æ”¹Traefixéƒ¨ç½²æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat deployment.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-lb</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å¢åŠ è¡Œ</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ssl</span><br><span class="line">        secret:</span><br><span class="line">          secretName: traefik-cert</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: traefik-conf</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: traefik</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/certs"</span></span><br><span class="line">          name: <span class="string">"ssl"</span></span><br><span class="line">        - mountPath: <span class="string">"/etc/kubernetes/conf"</span></span><br><span class="line">          name: <span class="string">"config"</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3000Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2000Mi</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8580</span><br><span class="line">          hostPort: 8580</span><br><span class="line">        args:</span><br><span class="line">        - --configFile=/etc/kubernetes/conf/traefik.toml</span><br><span class="line">        - --web</span><br><span class="line">        - --web.address=:8580</span><br><span class="line">        - --kubernetes</span><br><span class="line">      nodeSelector:</span><br><span class="line">        IngressProxy: <span class="string">"true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œéƒ¨ç½²å³å¯</span></span><br></pre></td></tr></table></figure><ul><li>traefix-uiç•Œé¢ä¸Šå¯ä»¥çœ‹åˆ°<br><img src="https://img.xxlaila.cn/1567739737385.jpg" alt="img"></li></ul><p>ä»describeä¿¡æ¯å’Œuiç•Œé¢ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œtomcat.test.k8såˆ†åˆ«æœ‰äº†/test1/å’Œ/test2/çš„åŸŸåä»£ç†ä»¥åŠç›¸å¯¹åº”çš„åç«¯<br><img src="https://img.xxlaila.cn/1567739822127.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567739856570.jpg" alt="img"></p><p><a href="https://xuchao918.github.io/2019/03/01/Kubernetes-traefik-ingress%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®2</a><br><a href="https://blog.51cto.com/icenycmh/2124502" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®1</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>traefik</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s-helm</title>
    <url>/2019/09/04/k8s-helm/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helmç±»ä¼¼ä¸linuxä¸‹é¢çš„yumï¼ŒHelmæ˜¯ä¸€ä¸ªç”¨äºkubernetesçš„åŒ…ç®¡ç†å™¨ï¼Œæ¯ä¸€ä¸ªåŒ…ä¸ºä¸€ä¸ªchartï¼Œä¸€ä¸ªchartæ˜¯ä¸€ä¸ªç›®å½•ï¼Œå¸¸å¸¸ä¼šå¯¹ç›®å½•è¿›è¡Œæ‰“åŒ…å‹ç¼©ï¼Œå½¢æˆä¸€ä¸ª${name}-version.tgzçš„æ ¼å¼è¿›è¡Œä¼ è¾“å’Œå­˜å‚¨ã€‚</p><ul><li>å¯¹äºåº”ç”¨å‘å¸ƒè€…è€Œè¨€ï¼Œå¯ä»¥é€šè¿‡Helmæ‰“åŒ…åº”ç”¨ï¼Œç®¡ç†åº”ç”¨ä¾èµ–å…³ç³»ï¼Œç®¡ç†åº”ç”¨ç‰ˆæœ¬å¹¶å‘å¸ƒåº”ç”¨åˆ°è½¯ä»¶ä»“åº“ã€‚</li><li>å¯¹äºä½¿ç”¨è€…è€Œè¨€ï¼Œä½¿ç”¨Helmåä¸ç”¨éœ€è¦äº†è§£Kubernetesçš„Yamlè¯­æ³•å¹¶ç¼–å†™åº”ç”¨éƒ¨ç½²æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡Helmä¸‹è½½å¹¶åœ¨kubernetesä¸Šå®‰è£…éœ€è¦çš„åº”ç”¨ã€‚</li></ul><p>Helmè¿˜æä¾›äº†kubernetesä¸Šçš„è½¯ä»¶éƒ¨ç½²ï¼Œåˆ é™¤ï¼Œå‡çº§ï¼Œå›æ»šåº”ç”¨çš„å¼ºå¤§åŠŸèƒ½</p><a id="more"></a><h3 id="1ã€helmç»„ä»¶"><a href="#1ã€helmç»„ä»¶" class="headerlink" title="1ã€helmç»„ä»¶"></a>1ã€helmç»„ä»¶</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œä¸‹çš„å®¢æˆ·ç«¯å·¥å…·ã€‚ä¸»è¦ç”¨äº Kubernetes åº”ç”¨ç¨‹åº Chart çš„åˆ›å»ºã€æ‰“åŒ…ã€å‘å¸ƒä»¥åŠåˆ›å»ºå’Œç®¡ç†æœ¬åœ°å’Œè¿œç¨‹çš„ Chart ä»“åº“ã€‚</p><h4 id="1-1ã€Tiller"><a href="#1-1ã€Tiller" class="headerlink" title="1.1ã€Tiller"></a>1.1ã€Tiller</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tiller æ˜¯ Helm çš„æœåŠ¡ç«¯ï¼Œéƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­ã€‚Tiller ç”¨äºæ¥æ”¶ Helm çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ® Chart ç”Ÿæˆ Kubernetes çš„éƒ¨ç½²æ–‡ä»¶ï¼ˆ Helm ç§°ä¸º Release ï¼‰ï¼Œç„¶åæäº¤ç»™ Kubernetes åˆ›å»ºåº”ç”¨ã€‚Tiller è¿˜æä¾›äº† Release çš„å‡çº§ã€åˆ é™¤ã€å›æ»šç­‰ä¸€ç³»åˆ—åŠŸèƒ½ã€‚</p><h4 id="1-2ã€Chart"><a href="#1-2ã€Chart" class="headerlink" title="1.2ã€Chart"></a>1.2ã€Chart</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm çš„è½¯ä»¶åŒ…ï¼Œé‡‡ç”¨ TAR æ ¼å¼ã€‚ç±»ä¼¼äº APT çš„ DEB åŒ…æˆ–è€… YUM çš„ RPM åŒ…ï¼Œå…¶åŒ…å«äº†ä¸€ç»„å®šä¹‰ Kubernetes èµ„æºç›¸å…³çš„ YAML æ–‡ä»¶</p><h4 id="1-3ã€Repoistory"><a href="#1-3ã€Repoistory" class="headerlink" title="1.3ã€Repoistory"></a>1.3ã€Repoistory</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Helm çš„è½¯ä»¶ä»“åº“ï¼ŒRepository æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨ä¿å­˜äº†ä¸€ç³»åˆ—çš„ Chart è½¯ä»¶åŒ…ä»¥ä¾›ç”¨æˆ·ä¸‹è½½ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªè¯¥ Repository çš„ Chart åŒ…çš„æ¸…å•æ–‡ä»¶ä»¥ä¾›æŸ¥è¯¢ã€‚Helm å¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ªä¸åŒçš„ Repository</p><h4 id="1-4ã€Release"><a href="#1-4ã€Release" class="headerlink" title="1.4ã€Release"></a>1.4ã€Release</h4><p>ä½¿ç”¨ helm install å‘½ä»¤åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²çš„ Chart ç§°ä¸º Release</p><h3 id="2ã€helmå®‰è£…"><a href="#2ã€helmå®‰è£…" class="headerlink" title="2ã€helmå®‰è£…"></a>2ã€helmå®‰è£…</h3><ul><li>ä¸‹è½½helm<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://storage.googleapis.com/kubernetes-helm/helm-v2.14.3-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf helm-v2.14.3-linux-amd64.tar.gz &amp;&amp; mv linux-amd64/&#123;helm,tiller&#125; /usr/bin</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·"><a href="#2-1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·" class="headerlink" title="2.1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·"></a>2.1ã€åˆ›å»ºåˆ†è˜–æœåŠ¡å¸æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount tiller --namespace kube-system</span></span><br><span class="line">serviceaccount/tiller created</span><br></pre></td></tr></table></figure><h4 id="2-2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"><a href="#2-2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²" class="headerlink" title="2.2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"></a>2.2ã€æˆäºˆåˆ†è˜–é›†ç¾¤ç®¡ç†å‘˜è§’è‰²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create clusterrolebinding tiller-admin-binding --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/tiller-admin-binding created</span><br></pre></td></tr></table></figure><h4 id="2-2ã€å®‰è£…tiller"><a href="#2-2ã€å®‰è£…tiller" class="headerlink" title="2.2ã€å®‰è£…tiller"></a>2.2ã€å®‰è£…tiller</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm init --service-account tiller --upgrade -i docker.io/sapcc/tiller:v2.14.3 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span><br></pre></td></tr></table></figure><h5 id="2-2-1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ"><a href="#2-2-1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ" class="headerlink" title="2.2.1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ"></a>2.2.1ã€æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods|grep tiller</span></span><br><span class="line">tiller-deploy-75b8f8575d-fplck          1/1     Running   0          17h</span><br><span class="line"></span><br><span class="line"><span class="comment"># helm version</span></span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.3"</span>, GitCommit:<span class="string">"0e7f3b6637f7af8fcfddb3d2941fcc7cbebb0085"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">"v2.14.3"</span>, GitCommit:<span class="string">"0e7f3b6637f7af8fcfddb3d2941fcc7cbebb0085"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é”™è¯¯</strong>: è¿™é‡Œå®‰è£…å®Œæˆåæ‰§è¡Œ<code>helm version</code>æç¤ºé”™è¯¯ï¼Œå†…å®¹å¦‚ä¸‹:<br><code>E0904 18:51:07.730671 22845 portforward.go:391] an error occurred forwarding 38767 -&gt; 44134: error forwarding port 44134 to pod b52064300cfa79e6d83795535584f89c97c33dc91ea39c024492b7b40e3fb68e, uid : unable to do port forwarding: socat not found.</code>è¿™ä¸ªé”™è¯¯éœ€è¦åœ¨å®¢æˆ·ç«¯å®‰è£…ä¸€ä¸ª<a href="https://github.com/helm/helm/issues/1371" target="_blank" rel="noopener">socatæ’ä»¶</a></li></ul><ul><li><p>åœ¨nodeå®‰è£…socat</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y socat</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹helmç¬¬ä¸‰æ–¹å­˜å‚¨åº“(å¯é€‰)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add stable https://burdenbear.github.io/kube-charts-mirror/</span></span><br><span class="line"><span class="comment"># helm repo list</span></span><br><span class="line">NAME     URL                                             </span><br><span class="line"><span class="built_in">local</span>    http://127.0.0.1:8879/charts                    </span><br><span class="line">monocular https://helm.github.io/monocular                </span><br><span class="line">stable   https://burdenbear.github.io/kube-charts-mirror/</span><br></pre></td></tr></table></figure></li></ul><h3 id="3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm-web"><a href="#3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm-web" class="headerlink" title="3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm web"></a>3ã€æµ‹è¯•å’Œå¯åŠ¨æœ¬åœ°helm web</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm list</span></span><br><span class="line"><span class="comment"># helm search</span></span><br><span class="line"><span class="comment"># helm search mysql --versions</span></span><br><span class="line"><span class="comment"># helm repo list</span></span><br><span class="line"><span class="comment"># helm serve --address 0.0.0.0:8879 &amp;</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567651293339.jpg" alt="img"></p><h3 id="4ã€helm-web-ui"><a href="#4ã€helm-web-ui" class="headerlink" title="4ã€helm web ui"></a>4ã€helm web ui</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;helmå®‰è£…ä»¥åï¼Œç»å¸¸ä½¿ç”¨helm cliå‘½æ¥è¿›è¡Œéƒ¨ç½²è¿˜æ˜¯æ¯”è¾ƒåƒåŠ›çš„ï¼Œè€Œä¸”å¯¹äºæœ‰äº›äººä¸å–œæ¬¢cliçš„æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç—›è‹¦çš„äº‹æƒ…ï¼Œè¿™é‡Œä»‹ç»ä¸€æ¬¾kubeappsï¼ŒKubeappsæ˜¯ä¸€ä¸ªåŸºäºWebçš„UIï¼Œç”¨äºåœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºã€‚ Kubeappså…è®¸æ‚¨ï¼š</p><ul><li>ä»å›¾è¡¨å­˜å‚¨åº“ä¸­æµè§ˆå’Œéƒ¨ç½²Helmå›¾è¡¨</li><li>æ£€æŸ¥ï¼Œå‡çº§å’Œåˆ é™¤ç¾¤é›†ä¸­å®‰è£…çš„åŸºäºHelmçš„åº”ç”¨ç¨‹åº</li><li>æ·»åŠ è‡ªå®šä¹‰å’Œç§æœ‰å›¾è¡¨å­˜å‚¨åº“ï¼ˆæ”¯æŒChartMuseumå’ŒJFrog Artifactory)</li><li>ä»æœåŠ¡ç›®å½•å’Œå¯ç”¨çš„Service Brokersæµè§ˆå’Œé…ç½®å¤–éƒ¨æœåŠ¡</li><li>ä½¿ç”¨æœåŠ¡ç›®å½•ç»‘å®šå°†åŸºäºHelmçš„åº”ç”¨ç¨‹åºè¿æ¥åˆ°å¤–éƒ¨æœåŠ¡</li><li>åŸºäºKubernetesåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶çš„å®‰å…¨èº«ä»½éªŒè¯å’Œæˆæƒ</li></ul><h4 id="4-1ã€å®‰è£…kubeapps"><a href="#4-1ã€å®‰è£…kubeapps" class="headerlink" title="4.1ã€å®‰è£…kubeapps"></a>4.1ã€å®‰è£…kubeapps</h4><p>ä½¿ç”¨Helmå›¾è¡¨å®‰è£…<a href="https://github.com/kubeapps/kubeapps" target="_blank" rel="noopener">æœ€æ–°ç‰ˆæœ¬çš„Kubeapps</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add bitnami https://charts.bitnami.com/bitnami</span></span><br><span class="line"><span class="comment"># helm install --name kubeapps --namespace kubeapps bitnami/kubeapps</span></span><br></pre></td></tr></table></figure><h4 id="4-2ã€å¯åŠ¨kubeappsDashboard"><a href="#4-2ã€å¯åŠ¨kubeappsDashboard" class="headerlink" title="4.2ã€å¯åŠ¨kubeappsDashboard"></a>4.2ã€å¯åŠ¨kubeappsDashboard</h4><p>å®‰è£…Kubeappsåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»ç³»ç»Ÿå®‰å…¨è®¿é—®Kubeapps Dashboard</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export POD_NAME=$(kubectl get pods --namespace kubeapps -l "app=kubeapps" -o jsonpath="&#123;.items[0].metadata.name&#125;")</span></span><br><span class="line"><span class="comment"># kubectl port-forward -n kubeapps $POD_NAME --address 0.0.0.0 8081:8080 &amp;</span></span><br><span class="line"><span class="comment"># æŠŠå®¹å™¨çš„8080 æ˜ å°„åˆ°æœ¬åœ°çš„8081ç«¯å£ï¼Œç”¨äºæµè§ˆå™¨è®¿é—®</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567650844980.jpg" alt="img"></p><h4 id="4-3ã€åˆ›å»ºtoken"><a href="#4-3ã€åˆ›å»ºtoken" class="headerlink" title="4.3ã€åˆ›å»ºtoken"></a>4.3ã€åˆ›å»ºtoken</h4><p>è®¿é—®ä»ªè¡¨æ¿éœ€è¦Kubernetes APIä»¤ç‰Œæ‰èƒ½é€šè¿‡Kubernetes APIæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount kubeapps-operator</span></span><br><span class="line">serviceaccount/kubeapps-operator created</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding kubeapps-operator --clusterrole=cluster-admin --serviceaccount=default:kubeapps-operator</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubeapps-operator created</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–token</span></span><br><span class="line"><span class="comment"># kubectl get secret $(kubectl get serviceaccount kubeapps-operator -o jsonpath='&#123;.secrets[].name&#125;') -o jsonpath='&#123;.data.token&#125;' | base64 --decode</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1567650971425.jpg" alt="img"></p><h5 id="4-3-1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬"><a href="#4-3-1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬" class="headerlink" title="4.3.1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬"></a>4.3.1ã€åˆ›å»ºtokenè®¿é—®è„šæœ¬</h5><p>æ¯æ¬¡è®¿é—®kubeappsçš„token éƒ½è¦è¾“å…¥ä¸€é•¿ä¸²ï¼Œè¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªshellè„šæœ¬ï¼Œæ”¾åœ¨<code>/usr/bin</code>ç›®å½•ï¼Œéœ€è¦çš„æ—¶å€™æ‰§è¡Œå‘½ä»¤å³å¯ï¼Œè¿™æ ·æ–¹ä¾¿ç”¨äºè®°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/bin/kubeapps</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">kubectl get secret $(kubectl get serviceaccount kubeapps-operator -o jsonpath=<span class="string">'&#123;.secrets[].name&#125;'</span>) -o jsonpath=<span class="string">'&#123;.data.token&#125;'</span> | base64 --decode</span><br><span class="line"><span class="comment"># chmod +x /usr/bin/kubeapps</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>helm</tag>
      </tags>
  </entry>
  <entry>
    <title>metrics-serverå®‰è£…å­£</title>
    <url>/2019/09/04/metrics-server%E5%AE%89%E8%A3%85%E5%AD%A3/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metrics-server é€šè¿‡ kube-apiserver å‘ç°æ‰€æœ‰èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨ kubelet APIsï¼ˆé€šè¿‡ https æ¥å£ï¼‰è·å¾—å„èŠ‚ç‚¹ï¼ˆNodeï¼‰å’Œ Pod çš„ CPUã€Memory ç­‰èµ„æºä½¿ç”¨æƒ…å†µã€‚Kubernetes 1.12 å¼€å§‹ï¼Œkubernetes çš„å®‰è£…è„šæœ¬ç§»é™¤äº† Heapsterï¼Œä» 1.13 å¼€å§‹å®Œå…¨ç§»é™¤äº†å¯¹ Heapster çš„æ”¯æŒï¼ŒHeapster ä¸å†è¢«ç»´æŠ¤ã€‚</p><ul><li>æ›¿ä»£æ–¹æ¡ˆå¦‚ä¸‹:<ul><li>ç”¨äºæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹çš„ CPU/memory HPA metricsï¼šmetrics-server</li><li>é€šç”¨çš„ç›‘æ§æ–¹æ¡ˆï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹å¯ä»¥è·å– Prometheus æ ¼å¼ç›‘æ§æŒ‡æ ‡çš„ç›‘æ§ç³»ç»Ÿï¼Œå¦‚ Prometheus Operator</li><li>äº‹ä»¶ä¼ è¾“ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æ¥ä¼ è¾“ã€å½’æ¡£ kubernetes events</li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨ metrics-server æ›¿ä»£ Heapsterï¼Œå°†æ— æ³•åœ¨ dashboard ä¸­ä»¥å›¾å½¢å±•ç¤º Pod çš„å†…å­˜å’Œ CPU æƒ…å†µï¼Œéœ€è¦é€šè¿‡ Prometheusã€Grafana ç­‰ç›‘æ§æ–¹æ¡ˆæ¥å¼¥è¡¥ã€‚</p><a id="more"></a><h4 id="1ã€ç›‘æ§æ¶æ„"><a href="#1ã€ç›‘æ§æ¶æ„" class="headerlink" title="1ã€ç›‘æ§æ¶æ„"></a>1ã€ç›‘æ§æ¶æ„</h4><p><img src="https://img.xxlaila.cn/2748678bdjsg848sd.png" alt="img"></p><h4 id="2ã€å®‰è£…-metrics-server"><a href="#2ã€å®‰è£…-metrics-server" class="headerlink" title="2ã€å®‰è£… metrics-server"></a>2ã€å®‰è£… metrics-server</h4><ul><li>ä» github clone æºç <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/metrics-server</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">aggregated-metrics-reader.yaml  auth-delegator.yaml  auth-reader.yaml  metrics-apiservice.yaml  metrics-server-deployment.yaml  metrics-server-service.yaml  resource-reader.yaml</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>æ³¨æ„</strong>: ä¹‹å‰åœ¨å®‰è£…çš„æ—¶å€™é‡åˆ°å¾ˆå¤šå‘ï¼Œè€Œä¸”ç½‘ä¸Šçœ‹äº†æ•™ç¨‹åŸºæœ¬ä¸Šä¸èƒ½ç”¨ï¼Œå¾ˆå‘ï¼Œè‡ªå·±çœ‹ç½‘ä¸Šæ•™ç¨‹ï¼Œç„¶åæ ¹æ®æ¯ä¸€ä¸ªé”™è¯¯æ¥è¿›è¡Œè§£å†³ï¼Œç»ˆäºï¼ŒåŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼ŒèŠ±äº†ä¸€å¤©åŠç»ˆäºæå®šå•¦ã€‚</li></ul><h4 id="3ã€metrics-server-æ–‡ä»¶ä¿®æ”¹"><a href="#3ã€metrics-server-æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="3ã€metrics-server æ–‡ä»¶ä¿®æ”¹"></a>3ã€metrics-server æ–‡ä»¶ä¿®æ”¹</h4><p>metrics-server yamlæ–‡ä»¶è¿™é‡Œæ–‡ä»¶å·²ç»ä¿®æ”¹å¥½äº†ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ï¼Œ<a href="https://github.com/kubernetes-incubator/metrics-server/issues/247" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a>ï¼Œ</p><h5 id="3-1ã€metrics-server-deployment-yaml"><a href="#3-1ã€metrics-server-deployment-yaml" class="headerlink" title="3.1ã€metrics-server-deployment.yaml"></a>3.1ã€metrics-server-deployment.yaml</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat metrics-server-deployment.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      hostNetwork: <span class="literal">true</span>   <span class="comment">#å¢åŠ è¡Œ</span></span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span><br><span class="line">      - name: tmp-dir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: mirrorgooglecontainers/metrics-server-amd64:v0.3.3</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/kubernetes/</span><br><span class="line">          name: ca-ssl</span><br><span class="line">        <span class="built_in">command</span>:   <span class="comment"># commandå†…å®¹å‡ä¸ºå¢åŠ </span></span><br><span class="line">        - /metrics-server</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br><span class="line">        - --requestheader-client-ca-file=/etc/ssl/kubernetes/front-proxy-ca.pem</span><br><span class="line">        - --kubelet-insecure-tls=<span class="literal">true</span></span><br><span class="line">      volumes:</span><br><span class="line">       - name: ca-ssl</span><br><span class="line">         hostPath:</span><br><span class="line">          path: /etc/kubernetes/ssl</span><br></pre></td></tr></table></figure><h5 id="3-2ã€"><a href="#3-2ã€" class="headerlink" title="3.2ã€"></a>3.2ã€</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat resource-reader.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/stats</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups: <span class="comment"># å¢åŠ </span></span><br><span class="line">  - <span class="string">"extensions"</span></span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure><h4 id="4ã€å‡†å¤‡è¯ä¹¦"><a href="#4ã€å‡†å¤‡è¯ä¹¦" class="headerlink" title="4ã€å‡†å¤‡è¯ä¹¦"></a>4ã€å‡†å¤‡è¯ä¹¦</h4><p>è¿™äº›è¯ä¹¦æ–‡ä»¶ä¸»è¦ç”¨åœ¨Metrics API aggregator ä¸Š,<a href="https://blog.51cto.com/ylw6006/2114338" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><ul><li><p>front-proxy-ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat front-proxy-ca-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>front-proxy-client-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"front-proxy-client"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="4-1ã€ç”Ÿæˆè¯ä¹¦"><a href="#4-1ã€ç”Ÿæˆè¯ä¹¦" class="headerlink" title="4.1ã€ç”Ÿæˆè¯ä¹¦"></a>4.1ã€ç”Ÿæˆè¯ä¹¦</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca</span></span><br><span class="line"><span class="comment"># cfssl gencert \</span></span><br><span class="line"> -ca=front-proxy-ca.pem \</span><br><span class="line"> -ca-key=front-proxy-ca-key.pem \</span><br><span class="line"> -config=/root/ssl/kubernetes-gencert.json \</span><br><span class="line"> -profile=kubernetes \</span><br><span class="line"> front-proxy-client-csr.json | cfssljson -bare front-proxy-client</span><br><span class="line"><span class="comment"># ls *.pem</span></span><br><span class="line">front-proxy-ca-key.pem  front-proxy-ca.pem  front-proxy-client-key.pem  front-proxy-client.pem</span><br></pre></td></tr></table></figure><ul><li>è¯ä¹¦ç”Ÿæˆå®Œæˆåï¼Œå§è¯ä¹¦å¤åˆ¶åˆ°æ‰€æœ‰çš„masterèŠ‚ç‚¹å’ŒnodeèŠ‚ç‚¹</li></ul><h4 id="5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶"></a>5ã€masterä¿®æ”¹é…ç½®æ–‡ä»¶</h4><h4 id="5-1ã€apiserver"><a href="#5-1ã€apiserver" class="headerlink" title="5.1ã€apiserver"></a>5.1ã€apiserver</h4><p>åœ¨apiserveré…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--runtime-config=api/all=<span class="literal">true</span> \</span><br><span class="line">--<span class="built_in">enable</span>-aggregator-routing=<span class="literal">true</span> \</span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/ssl/front-proxy-ca.pem \</span><br><span class="line">--requestheader-allowed-names=aggregator \</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \</span><br><span class="line">--requestheader-username-headers=X-Remote-User \</span><br><span class="line">--proxy-client-cert-file=/etc/kubernetes/ssl/front-proxy-client.pem \</span><br><span class="line">--proxy-client-key-file=/etc/kubernetes/ssl/front-proxy-client-key.pem \</span><br></pre></td></tr></table></figure><ul><li>apiserveré…ç½®æ–‡ä»¶KUBE_API_ARGSå†…å®¹å¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBE_API_ARGS=<span class="string">" --allow-privileged=true \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --alsologtostderr \</span></span><br><span class="line"><span class="string">                --apiserver-count=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">                --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">                --enable-aggregator-routing=true \</span></span><br><span class="line"><span class="string">                --audit-log-path=/var/log/kube-audit/audit.log \</span></span><br><span class="line"><span class="string">                --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span></span><br><span class="line"><span class="string">                --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">                --enable-garbage-collector \</span></span><br><span class="line"><span class="string">                --enable-logs-handler \</span></span><br><span class="line"><span class="string">                --endpoint-reconciler-type=lease \</span></span><br><span class="line"><span class="string">                --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span></span><br><span class="line"><span class="string">                --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">                --etcd-compaction-interval=0s \</span></span><br><span class="line"><span class="string">                --event-ttl=168h0m0s \</span></span><br><span class="line"><span class="string">                --kubelet-https=true \</span></span><br><span class="line"><span class="string">                --kubelet-certificate-authority=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem \</span></span><br><span class="line"><span class="string">                --kubelet-timeout=3s \</span></span><br><span class="line"><span class="string">                --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">                --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">                --service-account-key-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">                --requestheader-client-ca-file=/etc/kubernetes/ssl/front-proxy-ca.pem \</span></span><br><span class="line"><span class="string">                --requestheader-allowed-names=aggregator \</span></span><br><span class="line"><span class="string">                --requestheader-extra-headers-prefix=X-Remote-Extra- \</span></span><br><span class="line"><span class="string">                --requestheader-group-headers=X-Remote-Group \</span></span><br><span class="line"><span class="string">                --requestheader-username-headers=X-Remote-User \</span></span><br><span class="line"><span class="string">                --proxy-client-cert-file=/etc/kubernetes/ssl/front-proxy-client.pem \</span></span><br><span class="line"><span class="string">                --proxy-client-key-file=/etc/kubernetes/ssl/front-proxy-client-key.pem \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="5-2ã€kube-control-manager"><a href="#5-2ã€kube-control-manager" class="headerlink" title="5.2ã€kube-control-manager"></a>5.2ã€kube-control-manager</h5><p>åœ¨controller-manageræ–‡ä»¶å¢åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--horizontal-pod-autoscaler-use-rest-clients=<span class="literal">true</span> \</span><br></pre></td></tr></table></figure><ul><li>kube-control-manageré…ç½®æ–‡ä»¶KUBE_CONTROLLER_MANAGER_ARGSå¦‚ä¸‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">                                --cluster-signing-cert-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --cluster-signing-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">                                --deployment-controller-sync-period=10s \</span></span><br><span class="line"><span class="string">                                --experimental-cluster-signing-duration=87600h0m0s \</span></span><br><span class="line"><span class="string">                                --enable-garbage-collector=true \</span></span><br><span class="line"><span class="string">                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --leader-elect=true \</span></span><br><span class="line"><span class="string">                                --node-monitor-grace-period=20s \</span></span><br><span class="line"><span class="string">                                --node-monitor-period=5s \</span></span><br><span class="line"><span class="string">                                --port=10252 \</span></span><br><span class="line"><span class="string">                                --pod-eviction-timeout=2m0s \</span></span><br><span class="line"><span class="string">                                --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --terminated-pod-gc-threshold=50 \</span></span><br><span class="line"><span class="string">                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">                                --root-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --secure-port=10257 \</span></span><br><span class="line"><span class="string">                                --service-cluster-ip-range=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                                --service-account-private-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">                                --horizontal-pod-autoscaler-use-rest-clients=true \</span></span><br><span class="line"><span class="string">                                --v=2"</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="5-3ã€é‡å¯æœåŠ¡"><a href="#5-3ã€é‡å¯æœåŠ¡" class="headerlink" title="5.3ã€é‡å¯æœåŠ¡"></a>5.3ã€é‡å¯æœåŠ¡</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl  restart kube-apiserver.service &amp;&amp;systemctl  restart kube-controller-manager</span></span><br></pre></td></tr></table></figure><h4 id="6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹"><a href="#6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹"></a>6ã€nodeèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¿®æ”¹</h4><p>node èŠ‚ç‚¹ä¿®æ”¹ä¿®æ”¹kubeletæ–‡ä»¶</p><ul><li><p>kubeleté…ç½®æ–‡ä»¶å®Œæˆçš„KUBELET_ARGSå‚æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">KUBELET_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                --allow-privileged \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --authorization-mode=Webhook \</span></span><br><span class="line"><span class="string">                --authentication-token-webhook=true \</span></span><br><span class="line"><span class="string">                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --cgroup-driver=cgroupfs \</span></span><br><span class="line"><span class="string">                --cert-dir=/etc/kubernetes/ssl \</span></span><br><span class="line"><span class="string">                --cluster-dns=10.254.0.2 \</span></span><br><span class="line"><span class="string">                --cluster-domain=cluster.local \</span></span><br><span class="line"><span class="string">                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% \</span></span><br><span class="line"><span class="string">                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m \</span></span><br><span class="line"><span class="string">                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% \</span></span><br><span class="line"><span class="string">                --eviction-max-pod-grace-period=30 \</span></span><br><span class="line"><span class="string">                --image-gc-high-threshold=80 \</span></span><br><span class="line"><span class="string">                --image-gc-low-threshold=70 \</span></span><br><span class="line"><span class="string">                --image-pull-progress-deadline=30s \</span></span><br><span class="line"><span class="string">                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">                --max-pods=100 \</span></span><br><span class="line"><span class="string">                --minimum-image-ttl-duration=720h0m0s \</span></span><br><span class="line"><span class="string">                --node-labels=node.kubernetes.io/k8s-node=true \</span></span><br><span class="line"><span class="string">                --pod-infra-container-image=docker.io/kubernetes/pause:latest \</span></span><br><span class="line"><span class="string">                --port=10250 \</span></span><br><span class="line"><span class="string">                --read-only-port=0 \</span></span><br><span class="line"><span class="string">                --rotate-certificates \</span></span><br><span class="line"><span class="string">                --rotate-server-certificates \</span></span><br><span class="line"><span class="string">                --fail-swap-on=false \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯kubelet</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl restart kubelet</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="7ã€åˆ›å»ºmetrics"><a href="#7ã€åˆ›å»ºmetrics" class="headerlink" title="7ã€åˆ›å»ºmetrics"></a>7ã€åˆ›å»ºmetrics</h4><p>é€šè¿‡yamlæ–‡ä»¶åˆ›å»ºå¯¹åº”çš„èµ„æº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ./</span></span><br></pre></td></tr></table></figure><h5 id="7-1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ"><a href="#7-1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ" class="headerlink" title="7.1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ"></a>7.1ã€æŸ¥çœ‹è¿è¡Œæƒ…å†µ</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl -n kube-system get pods -l k8s-app=metrics-server</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-84b786c9bb-7trdr   1/1     Running   0          62m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get svc -n kube-system  metrics-server</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">metrics-server   ClusterIP   10.254.45.238   &lt;none&gt;        443/TCP   3h6m</span><br></pre></td></tr></table></figure><h5 id="7-2ã€è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯"><a href="#7-2ã€è·å–v1beta1-metrics-k8s-ioå¹¶éªŒè¯" class="headerlink" title="7.2ã€è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯"></a>7.2ã€è·å–v1beta1.metrics.k8s.ioå¹¶éªŒè¯</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰<code>v1beta1.metrics.k8s.io kube-system/metrics-server True 3h</code>å‚æ•°ä¸€ç›´æ˜¯<code>v1beta1.metrics.k8s.io kube-system/metrics-server False (FailedDiscoveryCheck) 16m</code>,</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kubectl get apiservice</span></span><br><span class="line">NAME                                    SERVICE                      AVAILABLE   AGE</span><br><span class="line">v1.                                     Local                        True        4d</span><br><span class="line">v1.apps                                 Local                        True        4d</span><br><span class="line">v1.authentication.k8s.io                Local                        True        4d</span><br><span class="line">v1.authorization.k8s.io                 Local                        True        4d</span><br><span class="line">v1.autoscaling                          Local                        True        4d</span><br><span class="line">v1.batch                                Local                        True        4d</span><br><span class="line">v1.networking.k8s.io                    Local                        True        4d</span><br><span class="line">v1.rbac.authorization.k8s.io            Local                        True        4d</span><br><span class="line">v1.storage.k8s.io                       Local                        True        4d</span><br><span class="line">v1alpha1.admissionregistration.k8s.io   Local                        True        4d</span><br><span class="line">v1alpha1.auditregistration.k8s.io       Local                        True        4d</span><br><span class="line">v1alpha1.rbac.authorization.k8s.io      Local                        True        4d</span><br><span class="line">v1alpha1.scheduling.k8s.io              Local                        True        4d</span><br><span class="line">v1alpha1.settings.k8s.io                Local                        True        4d</span><br><span class="line">v1alpha1.storage.k8s.io                 Local                        True        4d</span><br><span class="line">v1beta1.admissionregistration.k8s.io    Local                        True        4d</span><br><span class="line">v1beta1.apiextensions.k8s.io            Local                        True        4d</span><br><span class="line">v1beta1.apps                            Local                        True        4d</span><br><span class="line">v1beta1.authentication.k8s.io           Local                        True        4d</span><br><span class="line">v1beta1.authorization.k8s.io            Local                        True        4d</span><br><span class="line">v1beta1.batch                           Local                        True        4d</span><br><span class="line">v1beta1.certificates.k8s.io             Local                        True        4d</span><br><span class="line">v1beta1.coordination.k8s.io             Local                        True        4d</span><br><span class="line">v1beta1.events.k8s.io                   Local                        True        4d</span><br><span class="line">v1beta1.extensions                      Local                        True        4d</span><br><span class="line">v1beta1.metrics.k8s.io                  kube-system/metrics-server   True        3h</span><br><span class="line">v1beta1.policy                          Local                        True        4d</span><br><span class="line">v1beta1.rbac.authorization.k8s.io       Local                        True        4d</span><br><span class="line">v1beta1.scheduling.k8s.io               Local                        True        4d</span><br><span class="line">v1beta1.storage.k8s.io                  Local                        True        4d</span><br><span class="line">v1beta2.apps                            Local                        True        4d</span><br><span class="line">v2alpha1.batch                          Local                        True        4d</span><br><span class="line">v2beta1.autoscaling                     Local                        True        4d</span><br><span class="line">v2beta2.autoscaling                     Local                        True        4d</span><br></pre></td></tr></table></figure><h4 id="8ã€æŸ¥çœ‹-metrics-server-è¾“å‡ºçš„-metrics"><a href="#8ã€æŸ¥çœ‹-metrics-server-è¾“å‡ºçš„-metrics" class="headerlink" title="8ã€æŸ¥çœ‹ metrics-server è¾“å‡ºçš„ metrics"></a>8ã€æŸ¥çœ‹ metrics-server è¾“å‡ºçš„ metrics</h4><h5 id="8-1ã€é€šè¿‡-kube-apiserver-æˆ–-kubectl-proxy-è®¿é—®"><a href="#8-1ã€é€šè¿‡-kube-apiserver-æˆ–-kubectl-proxy-è®¿é—®" class="headerlink" title="8.1ã€é€šè¿‡ kube-apiserver æˆ– kubectl proxy è®¿é—®"></a>8.1ã€é€šè¿‡ kube-apiserver æˆ– kubectl proxy è®¿é—®</h5><ul><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes/" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/nodes/</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/pods" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/pods</a></li><li><a href="https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/namespace//pods/" target="_blank" rel="noopener">https://172.21.17.31:6443/apis/metrics.k8s.io/v1beta1/namespace//pods/</a></li></ul><h5 id="8-2ã€ç›´æ¥ä½¿ç”¨-kubectl-å‘½ä»¤è®¿é—®"><a href="#8-2ã€ç›´æ¥ä½¿ç”¨-kubectl-å‘½ä»¤è®¿é—®" class="headerlink" title="8.2ã€ç›´æ¥ä½¿ç”¨ kubectl å‘½ä»¤è®¿é—®"></a>8.2ã€ç›´æ¥ä½¿ç”¨ kubectl å‘½ä»¤è®¿é—®</h5><ul><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/nodes</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/pods</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/nodes/</li><li>kubectl get â€“raw /apis/metrics.k8s.io/v1beta1/namespace//pods/</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get --raw "/apis/metrics.k8s.io/v1beta1" | jq .</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"APIResourceList"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">  <span class="string">"groupVersion"</span>: <span class="string">"metrics.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"resources"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"nodes"</span>,</span><br><span class="line">      <span class="string">"singularName"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"namespaced"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"kind"</span>: <span class="string">"NodeMetrics"</span>,</span><br><span class="line">      <span class="string">"verbs"</span>: [</span><br><span class="line">        <span class="string">"get"</span>,</span><br><span class="line">        <span class="string">"list"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"pods"</span>,</span><br><span class="line">      <span class="string">"singularName"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"namespaced"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"kind"</span>: <span class="string">"PodMetrics"</span>,</span><br><span class="line">      <span class="string">"verbs"</span>: [</span><br><span class="line">        <span class="string">"get"</span>,</span><br><span class="line">        <span class="string">"list"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get --raw "/apis/metrics.k8s.io/v1beta1/nodes" | jq .</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"NodeMetricsList"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"metrics.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"metadata"</span>: &#123;</span><br><span class="line">    <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"items"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.204"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.204"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:40Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"63788460n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"1033152Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.240"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.240"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:40Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"41797865n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"837420Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"172.21.16.87"</span>,</span><br><span class="line">        <span class="string">"selfLink"</span>: <span class="string">"/apis/metrics.k8s.io/v1beta1/nodes/172.21.16.87"</span>,</span><br><span class="line">        <span class="string">"creationTimestamp"</span>: <span class="string">"2019-09-04T07:00:44Z"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"timestamp"</span>: <span class="string">"2019-09-04T07:00:34Z"</span>,</span><br><span class="line">      <span class="string">"window"</span>: <span class="string">"30s"</span>,</span><br><span class="line">      <span class="string">"usage"</span>: &#123;</span><br><span class="line">        <span class="string">"cpu"</span>: <span class="string">"37347688n"</span>,</span><br><span class="line">        <span class="string">"memory"</span>: <span class="string">"851232Ki"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>/apis/metrics.k8s.io/v1beta1/nodes å’Œ /apis/metrics.k8s.io/v1beta1/pods è¿”å›çš„ usage åŒ…å« CPU å’Œ Memoryï¼›</li></ul><h4 id="ä½¿ç”¨-kubectl-top"><a href="#ä½¿ç”¨-kubectl-top" class="headerlink" title="ä½¿ç”¨ kubectl top"></a>ä½¿ç”¨ kubectl top</h4><p>ä½¿ç”¨ kubectl top å‘½ä»¤æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ,kubectl top å‘½ä»¤ä» metrics-server è·å–é›†ç¾¤èŠ‚ç‚¹åŸºæœ¬çš„æŒ‡æ ‡ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl top node</span></span><br><span class="line">NAME            CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">172.21.16.204   69m          1%     1008Mi          13%       </span><br><span class="line">172.21.16.240   41m          2%     817Mi           23%       </span><br><span class="line">172.21.16.87    39m          1%     831Mi           23%</span><br></pre></td></tr></table></figure><p>metricsåˆ°è¿™é‡Œå°±å·²ç»æˆåŠŸçš„éƒ¨ç½²ï¼Œå‚æ•°æ²¡æœ‰ä¸€ä¸€ä»‹ç»ï¼ŒåæœŸæœ‰æ—¶é—´åœ¨åˆ—å‡ºæ¥</p><p>è¿™é‡Œè¿˜æœ‰å¾ˆå¤šå‚è€ƒçš„æ–‡æ¡£æ²¡æœ‰ä¸€ä¸€åˆ—å‡ºæ¥ï¼Œä¸»è¦æ˜¯æµè§ˆå™¨è¢«å…³é—­å•¦ï¼Œæ„Ÿè°¢é‚£äº›å‚è€ƒçš„æ–‡æ¡£ï¼ŒğŸ˜ŠğŸ˜ŠğŸ˜Š</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>metrics-server</tag>
      </tags>
  </entry>
  <entry>
    <title>kubeletæä¾›apiè¯·æ±‚æ¥å£</title>
    <url>/2019/09/04/kubelet%E6%8F%90%E4%BE%9Bapi%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="kubelet-æä¾›çš„-API-æ¥å£è®¤è¯"><a href="#kubelet-æä¾›çš„-API-æ¥å£è®¤è¯" class="headerlink" title="kubelet æä¾›çš„ API æ¥å£è®¤è¯"></a>kubelet æä¾›çš„ API æ¥å£è®¤è¯</h3><p><a href="https://xxlaila.github.io/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">nodeå®‰è£…å‚è€ƒ</a></p><p>kubelet å¯åŠ¨åç›‘å¬å¤šä¸ªç«¯å£ï¼Œç”¨äºæ¥æ”¶ kube-apiserver æˆ–å…¶å®ƒå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-3 ~]<span class="comment">#  netstat -lnpt|grep kubelet</span></span><br><span class="line">tcp        0      0 127.0.0.1:46395         0.0.0.0:*               LISTEN      8941/kubelet        </span><br><span class="line">tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      8941/kubelet        </span><br><span class="line">tcp6       0      0 :::10250                :::*                    LISTEN      8941/kubelet</span><br></pre></td></tr></table></figure><ul><li><strong>10248</strong>: healthz http æœåŠ¡</li><li><strong>10250</strong>: https æœåŠ¡ï¼Œè®¿é—®è¯¥ç«¯å£æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼ˆå³ä½¿è®¿é—® /healthz ä¹Ÿéœ€è¦ï¼‰</li><li>æœªå¼€å¯åªè¯»ç«¯å£ 10255</li><li>ä» K8S v1.10 å¼€å§‹ï¼Œå»é™¤äº† â€“cadvisor-port å‚æ•°ï¼ˆé»˜è®¤ 4194 ç«¯å£ï¼‰ï¼Œä¸æ”¯æŒè®¿é—® cAdvisor UI &amp; API</li></ul><a id="more"></a><p>kubelet æ¥æ”¶ 10250 ç«¯å£çš„ https è¯·æ±‚ï¼Œå¯ä»¥è®¿é—®å¦‚ä¸‹èµ„æºï¼š</p><ul><li>/podsã€/runningpods</li><li>/metricsã€/metrics/cadvisorã€/metrics/probes</li><li>/spec</li><li>/statsã€/stats/container</li><li>/logs</li><li>/run/ã€/exec/, /attach/, /portForward/, /containerLogs/<br><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/server/server.go#L434:3" target="_blank" rel="noopener">è¯¦æƒ…å‚è€ƒ</a></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºå…³é—­äº†åŒ¿åè®¤è¯ï¼ŒåŒæ—¶å¼€å¯äº† webhook æˆæƒï¼Œæ‰€æœ‰è®¿é—® 10250 ç«¯å£ https API çš„è¯·æ±‚éƒ½éœ€è¦è¢«è®¤è¯å’Œæˆæƒã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;é¢„å®šä¹‰çš„ ClusterRole system:kubelet-api-admin æˆäºˆè®¿é—® kubelet æ‰€æœ‰ API çš„æƒé™(kube-apiserver ä½¿ç”¨çš„ kubernetes è¯ä¹¦ User æˆäºˆäº†è¯¥æƒé™)ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:kubelet-api-admin</span></span><br><span class="line">Name:         system:kubelet-api-admin</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources      Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------      -----------------  --------------  -----</span><br><span class="line">  nodes/<span class="built_in">log</span>      []                 []              [*]</span><br><span class="line">  nodes/metrics  []                 []              [*]</span><br><span class="line">  nodes/proxy    []                 []              [*]</span><br><span class="line">  nodes/spec     []                 []              [*]</span><br><span class="line">  nodes/stats    []                 []              [*]</span><br><span class="line">  nodes          []                 []              [get list watch proxy]</span><br></pre></td></tr></table></figure><h3 id="kubelet-api-è®¤è¯å’Œæˆæƒ"><a href="#kubelet-api-è®¤è¯å’Œæˆæƒ" class="headerlink" title="kubelet api è®¤è¯å’Œæˆæƒ"></a>kubelet api è®¤è¯å’Œæˆæƒ</h3><p>kubelet é…ç½®äº†å¦‚ä¸‹è®¤è¯å‚æ•°:</p><ul><li><strong>â€“anonymous-auth=false</strong>: è®¾ç½®ä¸º falseï¼Œä¸å…è®¸åŒ¿åï¿½è®¿é—® 10250 ç«¯å£</li><li><strong>â€“authentication-token-webhook=true</strong>: æŒ‡å®šç­¾åå®¢æˆ·ç«¯è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œå¼€å¯ HTTPs è¯ä¹¦è®¤è¯</li><li><strong>â€“client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem</strong>: å¼€å¯ HTTPs bearer token è®¤è¯</li><li><strong>â€“authorization-mode=Webhook</strong>: å¼€å¯ RBAC æˆæƒ</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;kubelet æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ clientCAFile å¯¹è¯ä¹¦ç­¾åè¿›è¡Œè®¤è¯ï¼Œæˆ–è€…æŸ¥è¯¢ bearer token æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœä¸¤è€…éƒ½æ²¡é€šè¿‡ï¼Œåˆ™æ‹’ç»è¯·æ±‚ï¼Œæç¤º Unauthorized</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 ~]<span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem https://172.21.16.204:10250/metrics</span></span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é€šè¿‡è®¤è¯åï¼Œkubelet ä½¿ç”¨ SubjectAccessReview API å‘ kube-apiserver å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢è¯ä¹¦æˆ– token å¯¹åº”çš„ userã€group æ˜¯å¦æœ‰æ“ä½œèµ„æºçš„æƒé™(RBAC)ï¼›</p><h3 id="è¯ä¹¦è®¤è¯å’Œæˆæƒ"><a href="#è¯ä¹¦è®¤è¯å’Œæˆæƒ" class="headerlink" title="è¯ä¹¦è®¤è¯å’Œæˆæƒ"></a>è¯ä¹¦è®¤è¯å’Œæˆæƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æƒé™ä¸è¶³</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem  --cert /etc/kubernetes/ssl/kube-controller-manager.pem --key /etc/kubernetes/ssl/kube-controller-manager-key.pem https://172.21.16.204:10250/metrics</span></span><br><span class="line">Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ã€å…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦</span></span><br><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem --cert /etc/kubernetes/ssl/admin.pem --key /etc/kubernetes/ssl/admin-key.pem https://172.21.16.204:10250/metrics|head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"21600"</span>&#125; 0</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>: â€“cacertã€â€“certã€â€“key çš„å‚æ•°å€¼å¿…é¡»æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦åˆ™è¿”å› 401 Unauthorizedï¼›</li></ul><h4 id="bear-token-è®¤è¯å’Œæˆæƒ"><a href="#bear-token-è®¤è¯å’Œæˆæƒ" class="headerlink" title="bear token è®¤è¯å’Œæˆæƒ"></a>bear token è®¤è¯å’Œæˆæƒ</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºä¸€ä¸ª ServiceAccountï¼Œå°†å®ƒå’Œ ClusterRole system:kubelet-api-admin ç»‘å®šï¼Œä»è€Œå…·æœ‰è°ƒç”¨ kubelet API çš„æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">horization.k8s.io/kubelet-api-test created</span><br><span class="line"><span class="comment"># SECRET=$(kubectl get secrets | grep kubelet-api-test | awk '&#123;print $1&#125;')</span></span><br><span class="line"><span class="comment"># TOKEN=$(kubectl describe secret $&#123;SECRET&#125; | grep -E '^token' | awk '&#123;print $2&#125;')</span></span><br><span class="line"><span class="comment"># echo $&#123;TOKEN&#125;</span></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6Imt1YmVsZXQtYXBpLXRlc3QtdG9rZW4tNGJra3MiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoia3ViZWxldC1hcGktdGVzdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6Ijk3MDRhZDEwLWNlYjQtMTFlOS04ZDIwLWZhMTYzZTVhZjgzMyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0Omt1YmVsZXQtYXBpLXRlc3QifQ.ishvOaC5tppYKDNpEOXIiVhVtgjyqzjySZjzndot5Z5U9MkY9LN8ZSMWRe6lNsB1UuTgEWTsHlG3OIRfExnHehYhWIt59V9e39KKbeY17hHoT-RZSaD6GoB449t_vUdIJedd1FGZ8DckQvDr6X5fMuD7MSU3vRL077j-uls-y4IW5kaJHeAGJfc6eWoCnv96DCbI8mQ8yuYbwLFpfIPLb4u6FPkwMQL2KXy6FhWPY1va6zAh4LdjGWhH6IAkKleq0aqfMwvmlnk1_OUmnmBoGJGuB96IwqBATP0jFzrd-Sv6af3RsSYz2r8YzJUj3kat9bd__HNCCXampYYr8ffu8YEdn-J9p6HK13FWU4O9QSIDrRONNIOpUXclJ-ov3z6N1hiIcVq5UJU6xR2z4ccvPXmH9Sj7p8CquqKEuobZxK97TFtECGlb2Ex43u4t0UHRo23UCQA-qP2Zs4-U2Zmf_qu3I-Lm7jzuYzXFCAb27yZx_XOUY-ycnKhtM6PpUfVKhkcHfWBOYY-QtBEbYf6yHRqCWcjrsZ63C_B56qAYaU5ca3hAcr6RBuHmmHISGESlLbmrpGgJ_ajd5mrJSh3Z_qdqu-Xt0Ya0NLfXgAcGi5n8xWJLztRTeyHrFTj7g82MqERUfFk9bdLHcz77xmrNLnhRZ87GW9sTZLw8QRUjF1g</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -s --cacert /etc/kubernetes/ssl/kubernetes-ca.pem -H "Authorization: Bearer $&#123;TOKEN&#125;" https://172.21.16.204:10250/metrics|head</span></span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"21600"</span>&#125; 0</span><br></pre></td></tr></table></figure><h4 id="cadvisor-å’Œ-metrics"><a href="#cadvisor-å’Œ-metrics" class="headerlink" title="cadvisor å’Œ metrics"></a>cadvisor å’Œ metrics</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;cadvisor æ˜¯å†…åµŒåœ¨ kubelet äºŒè¿›åˆ¶ä¸­çš„ï¼Œç»Ÿè®¡æ‰€åœ¨èŠ‚ç‚¹å„å®¹å™¨çš„èµ„æº(CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘å¡)ä½¿ç”¨æƒ…å†µçš„æœåŠ¡.</p><blockquote><p>åœ¨è®¿é—®api-serverå®‰å…¨ç«¯å£ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›æ“ä½œæ‰èƒ½è®¿é—®ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œè®¿é—®</p></blockquote><h5 id="åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£"><a href="#åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£" class="headerlink" title="åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£"></a>åœ¨æµè§ˆå™¨è®¿é—®kube-apiserverå®‰å…¨ç«¯å£</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;æç¤ºè¯ä¹¦ä¸è¢«ä¿¡ä»»,è¿™æ˜¯å› ä¸º kube-apiserver çš„ server è¯ä¹¦æ˜¯æˆ‘ä»¬åˆ›å»ºçš„æ ¹è¯ä¹¦ ca.pem ç­¾åçš„ï¼Œéœ€è¦å°†æ ¹è¯ä¹¦ ca.pem å¯¼å…¥æ“ä½œç³»ç»Ÿï¼Œå¹¶è®¾ç½®æ°¸ä¹…ä¿¡ä»»ã€‚<br><img src="https://img.xxlaila.cn/1567564092242.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ç»™æµè§ˆå™¨ç”Ÿæˆä¸€ä¸ª client è¯ä¹¦ï¼Œè®¿é—® apiserver çš„ 6443 https ç«¯å£æ—¶ä½¿ç”¨ã€‚è¿™é‡Œä½¿ç”¨éƒ¨ç½² kubectl å‘½ä»¤è¡Œå·¥å…·æ—¶åˆ›å»ºçš„ admin è¯ä¹¦ã€ç§é’¥å’Œä¸Šé¢çš„ ca è¯ä¹¦ï¼Œåˆ›å»ºä¸€ä¸ªæµè§ˆå™¨å¯ä»¥ä½¿ç”¨ PKCS#12/PFX æ ¼å¼çš„è¯ä¹¦ï¼š</p><ul><li><p>ä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œè¿™é‡Œå¯†ç éœ€è¦è®°ä½ï¼Œä¸€ä¼šå€’å…¥è¯ä¹¦åˆ°æµè§ˆå™¨çš„æ—¶å€™éœ€è¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl pkcs12 -export -out admin.pfx -inkey admin-key.pem -in admin.pem -certfile kubernetes-ca.pem</span></span><br><span class="line">Enter Export Password:</span><br><span class="line">Verifying - Enter Export Password:</span><br></pre></td></tr></table></figure></li><li><p>å°†åˆ›å»ºçš„ admin.pfx å¯¼å…¥åˆ°ç³»ç»Ÿçš„è¯ä¹¦ä¸­,<br><img src="https://img.xxlaila.cn/1567564289155.jpg" alt="img"></p></li></ul><p>å†æ¬¡è®¿é—® apiserver åœ°å€ï¼Œæç¤ºé€‰æ‹©ä¸€ä¸ªæµè§ˆå™¨è¯ä¹¦ï¼Œè¿™é‡Œé€‰ä¸­ä¸Šé¢å¯¼å…¥çš„ admin.pfx<br><img src="https://img.xxlaila.cn/1567564393274.jpg" alt="img"></p><ul><li><p>æç¤ºéœ€è¦è¾“å…¥ç³»ç»Ÿçš„å¯†ç ,è¿™é‡Œæ˜¯macçš„ç”µè„‘<br><img src="https://img.xxlaila.cn/1567564441293.jpg" alt="img"></p></li><li><p>è¢«æˆæƒè®¿é—® kube-apiserver çš„å®‰å…¨ç«¯å£<br><img src="https://img.xxlaila.cn/1567564526664.jpg" alt="img"></p></li></ul><h5 id="å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†"><a href="#å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†" class="headerlink" title="å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†"></a>å®¢æˆ·ç«¯é€‰æ‹©è¯ä¹¦çš„åŸç†</h5><ul><li>è¯ä¹¦é€‰æ‹©æ˜¯åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ SSL/TLS æ¡æ‰‹åå•†é˜¶æ®µå•†å®šçš„ï¼›</li><li>æœåŠ¡ç«¯å¦‚æœè¦æ±‚å®¢æˆ·ç«¯æä¾›è¯ä¹¦ï¼Œåˆ™åœ¨æ¡æ‰‹æ—¶ä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå®ƒæ¥å—çš„ CA åˆ—è¡¨ï¼›</li><li>å®¢æˆ·ç«¯æŸ¥æ‰¾å®ƒçš„è¯ä¹¦åˆ—è¡¨(ä¸€èˆ¬æ˜¯æ“ä½œç³»ç»Ÿçš„è¯ä¹¦ï¼Œå¯¹äº Mac ä¸º keychain)ï¼Œçœ‹æœ‰æ²¡æœ‰è¢« CA ç­¾åçš„è¯ä¹¦ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†å®ƒä»¬æä¾›ç»™ç”¨æˆ·é€‰æ‹©ï¼ˆè¯ä¹¦çš„ç§é’¥ï¼‰ï¼›</li><li>ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªè¯ä¹¦ç§é’¥ï¼Œç„¶åå®¢æˆ·ç«¯å°†ä½¿ç”¨å®ƒå’ŒæœåŠ¡ç«¯é€šä¿¡ï¼›</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æµè§ˆå™¨è®¿é—® <a href="https://172.21.16.204:10250/metrics" target="_blank" rel="noopener">https://172.21.16.204:10250/metrics</a> å’Œ <a href="https://172.21.16.204:10250/metrics/cadvisor" target="_blank" rel="noopener">https://172.21.16.204:10250/metrics/cadvisor</a> åˆ†åˆ«è¿”å› kubelet å’Œ cadvisor çš„ metricsã€‚<br><img src="https://img.xxlaila.cn/1567563858215.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1567564733531.jpg" alt="img"></p><ul><li><strong>åŸå› </strong>: kubeleté…ç½®æ–‡ä»¶è®¾ç½®<code>--anonymous-auth=false</code>ä¸å…è®¸åŒ¿åè¯ä¹¦è®¿é—® 10250 çš„ https æœåŠ¡,æ‰€ä»¥æˆ‘ä»¬æ‰éœ€è¦é…ç½®è¯ä¹¦æ¥è¿›è¡Œè®¿é—®</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubelet</tag>
      </tags>
  </entry>
  <entry>
    <title>centos-nfs-512é”™è¯¯</title>
    <url>/2019/09/03/centos-nfs-512%E9%94%99%E8%AF%AF/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>nfs é”™è¯¯kernel: NFS: nfs4_discover_server_trunking unhandled error -512. Exiting with error EIO</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¾ˆä¹…æ²¡æŒ‚è½½è¿‡nfsï¼Œå¿˜è®°å®¢æˆ·ç«¯æ€ä¹ˆæŒ‚åœ¨nfsçš„äº†ï¼ŒæœåŠ¡ç«¯å¾ˆæ—©å°±å®‰è£…å¥½äº†ï¼Œä»Šå¤©ä¸€å°å®¢æˆ·æœºéœ€è¦æŒ‚è½½nfsï¼Œç„¶åå±…ç„¶æŠ¥é”™äº†ï¼Œç„¶åæ‰¾äº†ä¸€åœˆå±…ç„¶æ²¡æ‰¾åˆ°æ€ä¹ˆè§£å†³ï¼Œç„¶ååˆé‡æ–°çœ‹äº†ä¸€æ¬¡centos nfsçš„é…ç½®ï¼Œäºæ˜¯ä¹å°±æå®šäº†</p><p>åœ¨æŒ‚è½½nfsçš„æç¤ºå¾ˆæ…¢ï¼Œé•¿æ—¶é—´æ— å“åº”ï¼Œå¼ºè¡Œç»“æŸçœ‹çœ‹æ˜¯ä»€ä¹ˆé—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo tail -f /var/<span class="built_in">log</span>/messages</span><br><span class="line">Sep  3 11:23:51 dev-application kernel: NFS: nfs4_discover_server_trunking unhandled error -512. Exiting with error EIO</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind-service"><a href="#1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind-service" class="headerlink" title="1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind.service"></a>1ã€åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹rpcbind.service</h3><p>åœ¨å®¢æˆ·ç«¯æŸ¥çœ‹<code>rpcbind.service</code>æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼Œæ²¡æœ‰æ­£å¸¸å¯åŠ¨ï¼Œå°±éœ€è¦å¯åŠ¨ï¼Œæ²¡æœ‰å®‰è£…æœåŠ¡ï¼Œå°±éœ€è¦å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum -y install rpcbind</span><br><span class="line">$ sudo systemctl start rpcbind.service &amp;&amp; sudo systemctl <span class="built_in">enable</span> rpcbind.service</span><br></pre></td></tr></table></figure><ul><li>å†æ¬¡æŒ‚è½½çš„æ—¶å€™è¿˜æ˜¯æŒ‚è½½è¡¥ä¸Šï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æŒ‚è½½çš„æ—¶å€™å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€äº†æ•°æ®è¯·æ±‚ï¼Œè€Œä¸”è¿˜æ²¡æœ‰æ­£å¸¸çš„æ–­å¼€é“¾æ¥ï¼Œå¯ä»¥åœ¨æœåŠ¡ç«¯ç”¨<code>netstat -anp|grep tcp</code>æŸ¥çœ‹æœ‰æ²¡æœ‰å®¢æˆ·ç«¯çš„é“¾æ¥ä¿¡æ¯,çŠ¶æ€æ˜¯<code>ESTABLISHED</code>ï¼Œæœ‰çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒç»“æŸæ‰</li></ul><h3 id="2ã€linux-ç»“æŸtcpä¼šè¯"><a href="#2ã€linux-ç»“æŸtcpä¼šè¯" class="headerlink" title="2ã€linux ç»“æŸtcpä¼šè¯"></a>2ã€linux ç»“æŸtcpä¼šè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›®å‰ä¸çŸ¥é“ä»€ä¹ˆå‘½ä»¤,åæœŸæ›´æ–°</span></span><br><span class="line"><span class="comment"># é‡å¯nfsæœåŠ¡</span></span><br><span class="line">$ sudo systemctl restart nfs.service</span><br></pre></td></tr></table></figure><h3 id="3ã€å®¢æˆ·ç«¯æŒ‚è½½"><a href="#3ã€å®¢æˆ·ç«¯æŒ‚è½½" class="headerlink" title="3ã€å®¢æˆ·ç«¯æŒ‚è½½"></a>3ã€å®¢æˆ·ç«¯æŒ‚è½½</h3><p>å†æ¬¡æ¥åˆ°å®¢æˆ·æœºæŒ‚è½½ï¼Œå¯ä»¥æˆåŠŸçš„æŒ‚è½½</p><h3 id="4ã€rpcbindæœåŠ¡ä»‹ç»"><a href="#4ã€rpcbindæœåŠ¡ä»‹ç»" class="headerlink" title="4ã€rpcbindæœåŠ¡ä»‹ç»"></a>4ã€rpcbindæœåŠ¡ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿéœ€è¦æœåŠ¡ï¼Œçº¢å¸½ä¼ä¸šLinuxä½¿ç”¨æ ¸å¿ƒçº§çš„æ”¯æŒå’Œå®ˆæŠ¤è¿›ç¨‹çš„ç»„åˆæ¥æä¾›NFSæ–‡ä»¶å…±äº«.NFSä¾é è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è·¯ç”±è¯·æ±‚ã€‚åœ¨Linuxä¸‹RPCæœåŠ¡ç”±portmapæœåŠ¡æ§åˆ¶ã€‚</p><h4 id="4-1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ"><a href="#4-1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ" class="headerlink" title="4.1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ:"></a>4.1ã€ä¸ºäº†å…±äº«å’ŒåŠ è½½NFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢çš„æœåŠ¡è¦ä¸€èµ·å·¥ä½œ:</h4><ul><li>nfs - å¯åŠ¨ç›¸åº”RPCæœåŠ¡è¿›ç¨‹æ¥æœåŠ¡å¯¹äºNFSæ–‡ä»¶ç³»ç»Ÿçš„è¯·æ±‚.</li><li>nfslock - ä¸€ä¸ªå¯é€‰çš„æœåŠ¡ï¼Œç”¨äºå¯åŠ¨ç›¸åº”çš„RPCè¿›ç¨‹ï¼Œå…è®¸NFSå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ä¸Šå¯¹æ–‡ä»¶åŠ é”.</li><li>portmap - Linuxçš„RPCæœåŠ¡,å®ƒå“åº”RPCæœåŠ¡çš„è¯·æ±‚å’Œä¸è¯·æ±‚çš„RPCæœåŠ¡å»ºç«‹è¿æ¥.</li></ul><h4 id="4-2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡"><a href="#4-2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡" class="headerlink" title="4.2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡"></a>4.2ã€RPCè¿›ç¨‹åœ¨åå°ä¸€èµ·å·¥ä½œæœåŠ¡äºNFSæœåŠ¡</h4><ul><li>rpc.mountd - è¿™ä¸ªè¿›ç¨‹æ¥å—æ¥è‡ªNFSå®¢æˆ·ç«¯çš„åŠ è½½è¯·æ±‚å’ŒéªŒè¯è¯·æ±‚çš„æ–‡ä»¶ç³»ç»Ÿæ­£åœ¨è¢«è¾“å‡º.è¿™ä¸ªè¿›ç¨‹ç”±NFSæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li><li>rpc.nfsd - è¿™ä¸ªè¿›ç¨‹æ˜¯NFSæœåŠ¡å™¨.å®ƒå’ŒLinuxæ ¸å¿ƒä¸€èµ·å·¥ä½œæ¥æ»¡è¶³NFSå®¢æˆ·ç«¯çš„åŠ¨æ€éœ€æ±‚ï¼Œä¾‹å¦‚æä¾›ä¸ºæ¯ä¸ªNFSå®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚æœåŠ¡å™¨çº¿ç¨‹.è¿™ä¸ªè¿›ç¨‹å¯¹åº”äºnfsæœåŠ¡.</li><li>rpc.lockd - ä¸€ä¸ªå¯é€‰çš„è¿›ç¨‹ï¼Œå®ƒå…è®¸NFSå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ä¸Šå¯¹æ–‡ä»¶åŠ é”.è¿™ä¸ªè¿›ç¨‹å¯¹åº”äºnfslockæœåŠ¡.</li><li>rpc.statd - è¿™ä¸ªè¿›ç¨‹å®ç°äº†ç½‘ç»œçŠ¶æ€ç›‘æ§(NSM)RPCåè®®,é€šçŸ¥NFSå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ä¸€ä¸ªNFSæœåŠ¡å™¨éæ­£å¸¸é‡å¯åŠ¨.è¿™ä¸ªè¿›ç¨‹è¢«nfslockæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li><li>rpc.rquotad - è¿™ä¸ªè¿›ç¨‹å¯¹äºè¿œç¨‹ç”¨æˆ·æä¾›ç”¨æˆ·é…é¢ä¿¡æ¯. è¿™ä¸ªè¿›ç¨‹è¢«nfsæœåŠ¡è‡ªåŠ¨å¯åŠ¨ï¼Œä¸éœ€è¦ç”¨æˆ·çš„é…ç½®.</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sé›†ç¾¤éƒ¨ç½²heapster</title>
    <url>/2019/09/02/k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2heapster/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>kubernetesé›†ç¾¤å¯ç”¨tlsè®¤è¯éƒ¨ç½²heapsterï¼Œåœ¨éƒ¨ç½²æœŸé—´é‡åˆ°äº†å¾ˆå¤šçš„å‘ï¼Œèµ°è¿‡å¾ˆå¤šé›·ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹,ä¸è¿‡åœ¨æ–°ç‰ˆæœ¬ä¸­heapsterè¢«metrics-serverä»£æ›¿äº†ï¼Œmetrics-serveråç¯‡ä»‹ç»å’Œä½¿ç”¨</p><h2 id="1ã€å‡†å¤‡å·¥ä½œ"><a href="#1ã€å‡†å¤‡å·¥ä½œ" class="headerlink" title="1ã€å‡†å¤‡å·¥ä½œ"></a>1ã€å‡†å¤‡å·¥ä½œ</h2><p>ä¸‹è½½éœ€è¦çš„æ–‡ä»¶ï¼Œè¿™é‡Œç”¨ä¹‹å‰k8s-heapsteréƒ¨ç½²çš„æ–‡ä»¶æ‹¿æ¥è¿›è¡Œä¿®æ”¹ï¼Œ<a href="https://github.com/xxlaila/kubernetes-yaml/" target="_blank" rel="noopener">æ–‡ä»¶åœ°å€</a></p><h3 id="2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º"><a href="#2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º" class="headerlink" title="2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º"></a>2ã€æ‰§è¡Œæ–‡ä»¶åˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kubernetes-yaml/heapster-influxdb-grafana</span></span><br><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li><strong>é”™è¯¯æç¤º</strong>: è¿™é‡Œåœ¨æ‰§è¡Œåˆ›å»ºåï¼Œæ²¡æœ‰å›¾åƒæ˜¾ç¤ºï¼ŒæŸ¥çœ‹podsæ—¥å¿—å‘ç°é”™è¯¯<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system|grep he</span></span><br><span class="line">heapster-7b7b4754d-5p7tb                1/1     Running   0          17m</span><br><span class="line"><span class="comment"># kubectl logs heapster-7b7b4754d-5p7tb -n kube-system</span></span><br><span class="line">E0902 10:57:11.804543       1 reflector.go:190] k8s.io/heapster/metrics/processors/namespace_based_enricher.go:89: Failed to list *v1.Namespace: namespaces is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list resource <span class="string">"namespaces"</span> <span class="keyword">in</span> API group <span class="string">""</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br><span class="line">E0902 10:57:12.071117       1 reflector.go:190] k8s.io/heapster/metrics/util/util.go:30: Failed to list *v1.Node: nodes is forbidden: User <span class="string">"system:serviceaccount:kube-system:heapster"</span> cannot list resource <span class="string">"nodes"</span> <span class="keyword">in</span> API group <span class="string">""</span> at the cluster scope: RBAC: clusterrole.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br></pre></td></tr></table></figure></li></ul><ul><li>æ’é”™<br>æŸ¥çœ‹ClusterRole: system:heapsterçš„æƒé™,å‘ç°å¹¶æ²¡æœ‰</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe clusterrole system:heapster</span></span><br><span class="line">Error from server (NotFound): clusterroles.rbac.authorization.k8s.io <span class="string">"system:heapster"</span> not found</span><br></pre></td></tr></table></figure><p>æç¤ºè¿™ä¸ªé”™è¯¯ï¼Œåº”è¯¥æ˜¯æˆ‘ä¹‹å‰éƒ¨ç½²è¿‡ï¼Œç„¶åä¿®æ”¹è¿‡æƒé™ï¼Œä¸å°å¿ƒç»™åˆ æ‰å•¦ï¼Œè¿™é‡Œéœ€è¦å§æƒé™é‡å»ºä¸€æ¬¡å°±å¥½äº†ï¼Œ<a href="https://www.cnblogs.com/vincenshen/p/9638162.html" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><ul><li>æ–°å»ºheapster-clusterrole.yaml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster-clusterrole.yaml </span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:heapster</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  - namespaces</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br></pre></td></tr></table></figure></li></ul><p>å¹¶æ‰§è¡Œ kubectl apply -f heapster-clusterrole.yaml,åœ¨æ¬¡æŸ¥çœ‹æ—¥å¿—ï¼Œå‘ç°ä¹‹å‰çš„é”™è¯¯æ²¡æœ‰äº†ï¼Œä½†æ˜¯åˆå‡ºç°äº†ä¸€ä¸ªæ–°çš„é”™è¯¯<br><code>E0902 11:27:05.025300 1 manager.go:101] Error in scraping containers from kubelet:172.21.16.204:10250: failed to get all container stats from Kubelet URL &quot;https://172.21.16.204:10250/stats/container/&quot;: request failed - &quot;401 Unauthorized&quot;, response: &quot;Unauthorized&quot;</code></p><ul><li><p>ä¿®æ”¹heapster-clusterrole.yamlæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶é‡Œé¢æˆ‘ä»¬æ·»åŠ å‡ ä¸ªæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster-clusterrole.yaml </span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:heapster</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  - namespaces</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - nodes/stats</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f heapster-clusterrole.yaml</span></span><br><span class="line"><span class="comment"># é‡æ–°åˆ›å»ºheapster</span></span><br><span class="line"><span class="comment"># kubectl delete -f heapster.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f heapster.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>å®Œæˆä»¥åæˆ‘ä»¬ç»§ç»­çœ‹heapster podçš„æ—¥å¿—ï¼Œå‘ç°æ—¥å¿—é‡Œé¢è¿˜æ˜¯å‡ºç°<code>401 Unauthorized&quot;, response: &quot;Unauthorized&quot;</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹nodeèŠ‚ç‚¹ kubelet å¯åŠ¨çš„é…ç½®å‚æ•°ï¼Œæ·»åŠ <code>--authentication-token-webhook</code>å‚æ•°: ä½¿ç”¨tokenreview APIæ¥è¿›è¡Œä»¤ç‰Œè®¤è¯ã€‚Kubelet åœ¨é…ç½®çš„ API server ä¸Šè°ƒç”¨ TokenReview API ä»¥ç¡®å®šæ¥è‡ª bearer token çš„ç”¨æˆ·ä¿¡æ¯ã€‚<a href="https://k8smeetup.github.io/docs/admin/kubelet-authentication-authorization/" target="_blank" rel="noopener">å®˜æ–¹å‚è€ƒ</a>ï¼Œ<a href="https://github.com/kubernetes-retired/heapster/issues/1936" target="_blank" rel="noopener">githubä¸Šé”™è¯¯è§£å†³</a>ï¼Œ <a href="https://jimmysong.io/posts/user-authentication-in-kubernetes/" target="_blank" rel="noopener">å‚æ•°æ–‡ç« å­¦ä¹ </a></p><p>åˆ°æ­¤ä¸ºæ­¢: é”™è¯¯æ²¡æœ‰å•¦ï¼Œä½†æ˜¯ç•Œé¢æ•°æ®æ²¡å‡ºæ¥ï¼Œç¨ç­‰ç‰‡åˆ»</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>heapster</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sé…ç½®Dashboard</title>
    <url>/2019/08/29/k8s%E9%85%8D%E7%BD%AEDashboard/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;K8S Dashboardæ˜¯å®˜æ–¹çš„ä¸€ä¸ªåŸºäºWEBçš„ç”¨æˆ·ç•Œé¢ï¼Œä¸“é—¨ç”¨æ¥ç®¡ç†K8Sé›†ç¾¤ï¼Œå¹¶å¯å±•ç¤ºé›†ç¾¤çš„çŠ¶æ€ã€‚K8Sé›†ç¾¤å®‰è£…å¥½åé»˜è®¤æ²¡æœ‰åŒ…å«Dashboardï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–åˆ›å»ºå®ƒã€‚</p><h3 id="1ã€å®‰è£…dashboard"><a href="#1ã€å®‰è£…dashboard" class="headerlink" title="1ã€å®‰è£…dashboard"></a>1ã€å®‰è£…dashboard</h3><h4 id="1-1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶"><a href="#1-1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶" class="headerlink" title="1.1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶"></a>1.1ã€ä¸‹è½½å‡†å¤‡éœ€è¦çš„æ–‡ä»¶</h4><p>ç»è¿‡ä¿®æ”¹è¿‡åçš„æ–‡ä»¶ï¼Œå·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„<a href="https://github.com/xxlaila/kubernetes-yaml/" target="_blank" rel="noopener">æ–‡ä»¶</a></p><a id="more"></a><ul><li>åˆ›å»ºdashboard<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl create -f kubernetes-dashboard.yaml </span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br></pre></td></tr></table></figure></li></ul><h4 id="1-2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod"><a href="#1-2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod" class="headerlink" title="1.2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod"></a>1.2ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œpod</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl get service --all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">default       kubernetes             ClusterIP   10.254.0.1      &lt;none&gt;        443/TCP         18h</span><br><span class="line">kube-system   coredns                ClusterIP   10.254.0.10     &lt;none&gt;        53/UDP,53/TCP   16h</span><br><span class="line">kube-system   kubernetes-dashboard   NodePort    10.254.51.226   &lt;none&gt;        443:30001/TCP   15h</span><br></pre></td></tr></table></figure><ul><li><p>æŸ¥çœ‹serviceæè¿°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl describe  service kubernetes-dashboard -n kube-system</span></span><br><span class="line">Name:                     kubernetes-dashboard</span><br><span class="line">Namespace:                kube-system</span><br><span class="line">Labels:                   k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 k8s-app=kubernetes-dashboard</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP:                       10.254.51.226</span><br><span class="line">Port:                     &lt;<span class="built_in">unset</span>&gt;  443/TCP</span><br><span class="line">TargetPort:               8443/TCP</span><br><span class="line">NodePort:                 &lt;<span class="built_in">unset</span>&gt;  30001/TCP</span><br><span class="line">Endpoints:                10.254.39.3:8443</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹podæè¿°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 ~]<span class="comment"># kubectl describe pod kubernetes-dashboard-6c655d9445-6zntr --namespace=kube-system</span></span><br><span class="line">Name:           kubernetes-dashboard-6c655d9445-6zntr</span><br><span class="line">Namespace:      kube-system</span><br><span class="line">Node:           172.21.17.31/172.21.17.31</span><br><span class="line">Start Time:     Thu, 29 Aug 2019 17:47:20 +0800</span><br><span class="line">Labels:         k8s-app=kubernetes-dashboard</span><br><span class="line">                pod-template-hash=6c655d9445</span><br><span class="line">Annotations:    &lt;none&gt;</span><br><span class="line">Status:         Running</span><br><span class="line">IP:             10.254.39.3</span><br></pre></td></tr></table></figure></li></ul><h3 id="2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™"><a href="#2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™" class="headerlink" title="2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™"></a>2ã€æˆæƒDashboardè´¦æˆ·é›†ç¾¤ç®¡ç†æƒé™</h3><p>è‹¥æœä¸è¿›è¡Œæˆæƒæ“ä½œï¼Œæ‰“å¼€dashboardä¼šæŠ¥é”™ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/WechatIMG28864.png" alt="img"></p><ul><li><p>æ–°å»ºkubrnetes-dashboard-admin-rbac.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubernetes-dashboard-admin-rbac.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Create ClusterRoleBinding</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f kubernetes-dashboard-admin-rbac.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>æ‰¾åˆ°kubernete-dashboard-adminçš„tokenï¼Œå¤åˆ¶tokenåœ¨dashboardé¡µé¢è¿›è¡Œç™»å½•ï¼Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl -n kube-system get secret | grep admin-user</span></span><br><span class="line">admin-user-token-qv49g             kubernetes.io/service-account-token   3      15h</span><br><span class="line"></span><br><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '&#123;print $1&#125;')</span></span><br><span class="line">Name:         admin-user-token-qv49g</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: ea3f0e3f-ca42-11e9-8716-fa163effd55b</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1359 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXF2NDlnIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlYTNmMGUzZi1jYTQyLTExZTktODcxNi1mYTE2M2VmZmQ1NWIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.AbdsJdgi9d0rCYrmvoJkWf32HKSMT03OyOX55aRhPptjzIjDcGxxQYecT0w58N7Z_2L2RwTBfOrm4B3wTEDfFZKgYsnGJQOzJMtZDN9w5YJg2xGQ27E3KisTbbQzd_I5DgxSZWW75GwWf756_bIQpWuXNRO_KjheyWuNNv0tSEYRiXpcboSQpb-8R-Km-vP85mxke6s5cJFSk0WLMjFWow1vOF1ns23NZ5nslEmYOMZF3_Fxybh3LbiCyrpD4c0FtfRcXaBIBqACeyCPRriYMIIJq3OJjI-DzuqUedu1x2xH2prB4mNjxlKt2-7q0M1zCuvm5JhW_LzWgveu9ni2ig</span><br></pre></td></tr></table></figure><h3 id="3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜"><a href="#3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜" class="headerlink" title="3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜"></a>3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹è¯´æ˜</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;dashboard æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œé»˜è®¤çš„tokenå¤±æ•ˆçš„æ—¶é—´æ˜¯900ç§’ï¼Œ15åˆ†é’Ÿï¼Œæ¯15åˆ†é’Ÿå°±è¦è¿›è¡Œä¸€æ¬¡è®¤è¯ï¼Œè¿™æ ·å¯¹äºè¿ç»´äººå‘˜æ¥è¯´å°±ä¸æ˜¯ç‰¹åˆ«çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹token-ttlå‚æ•°æ¥è®¾ç½®ï¼Œä¸»è¦æ˜¯ä¿®æ”¹dashboradçš„yamlæ–‡ä»¶ï¼Œå¹¶é‡æ–°å»ºç«‹å³å¯</p><h4 id="3-1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹-æ·»åŠ "><a href="#3-1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹-æ·»åŠ " class="headerlink" title="3.1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹/æ·»åŠ "></a>3.1ã€åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹/æ·»åŠ </h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- containerPort: 8443</span><br><span class="line">  protocol: TCP</span><br><span class="line">args:</span><br><span class="line">  - --auto-generate-certificates</span><br><span class="line">  - --token-ttl=43200</span><br></pre></td></tr></table></figure><ul><li>é‡å»ºpod<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01 dashboard]<span class="comment"># kubectl apply -f kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>æˆ‘ä»¬å¯ä»¥è¾“å…¥ä»»æ„èŠ‚ç‚¹çš„ipåŠ 30001ç«¯å£å°±å¯ä»¥è®¿é—®dashboard, https://{ip}:30001ã€‚</p><h3 id="å…¶ä»–æ“ä½œ"><a href="#å…¶ä»–æ“ä½œ" class="headerlink" title="å…¶ä»–æ“ä½œ"></a>å…¶ä»–æ“ä½œ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ¯å¤©æˆ‘ä»¬æ¥å…¬å¸è¦ç™»å½•dashboardçš„æ—¶å€™éƒ½è¦å»è¾“å…¥ä¸€æ¬¡tokenï¼Œæ¯æ¬¡å»è·å–tokençš„æ—¶å€™éƒ½è¦è¾“å…¥å¾ˆé•¿çš„ä¸€ä¸²ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥å†™ä¸€ä¸ªè„šæœ¬ï¼Œè¦tokençš„æ—¶å€™æ‰§è¡Œä¸€ä¸‹è„šæœ¬ï¼Œå°±å¯ä»¥ã€‚</p><ul><li><p>åˆ›å»ºè„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim kube-token</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®è„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chmod +x kube-token</span></span><br><span class="line"><span class="comment"># mv kube-token /usr/bin</span></span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>k8såˆ é™¤nodeé‡æ–°åŠ å…¥</title>
    <url>/2019/08/29/k8s%E5%88%A0%E9%99%A4node%E9%87%8D%E6%96%B0%E5%8A%A0%E5%85%A5/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;æœ‰æ—¶å€™k8s node åœ¨åŠ å…¥é›†ç¾¤çš„æ—¶å€™ä¸ç»æ„çš„æ—¶å€™å¼„é”™å•¦æŸäº›ä¸œè¥¿ï¼Œè¿™æ—¶å€™å¯ä»¥æŠŠè¿™ä¸ªnodeåˆ é™¤ï¼Œç„¶åé‡æ–°åŠ å…¥ï¼Œåˆ é™¤èŠ‚ç‚¹ä¹‹å‰æˆ‘ä»¬éœ€è¦åšä¸€ä¸‹å¸¸è§„åŒ–çš„æ“ä½œï¼Œæ¥ä¿éšœè¿è¡Œåœ¨è¯¥èŠ‚ç‚¹çš„podè¿ç§»åˆ°å…¶ä»–çš„nodeä¸Šã€‚</p><a id="more"></a><ul><li><p>1ã€å…ˆé©±èµ¶ä¸Šé¢çš„pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl drain 172.21.110 --delete-local-data</span></span><br><span class="line">node/172.21.110 cordoned</span><br><span class="line">node/172.21.110 drained</span><br></pre></td></tr></table></figure></li><li><p>2ã€åˆ é™¤èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl delete node 172.21.110</span></span><br><span class="line">node <span class="string">"172.21.110"</span> deleted</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>kubectl delete</code> å‘½ä»¤æœ¬èº«æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥è¿›è¡Œä»»ä½•èµ„æºçš„åˆ é™¤<code>kubectl delete type typename</code>ï¼Œtypeæ˜¯èµ„æºç±»å‹ï¼Œå¯ä»¥æ˜¯<code>node, pod, rs, rc, deployment, service</code>ç­‰ç­‰ï¼Œtypenameæ˜¯è¿™ä¸ªèµ„æºçš„åç§°</p><ul><li><p>3ã€æŸ¥çœ‹nodeæ˜¯å¦è¢«åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.17.30   Ready    &lt;none&gt;   20m   v1.13.3</span><br><span class="line">172.21.17.31   Ready    &lt;none&gt;   10m   v1.13.3</span><br></pre></td></tr></table></figure></li><li><p>4ã€å½»åº•åˆ é™¤node<br>è¿›å…¥è¯¥èŠ‚ç‚¹ã€‚åˆ é™¤<code>kubelet.kubeconfig</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-3 kubernetes]<span class="comment"># rm -rf  kubelet.kubeconfig</span></span><br></pre></td></tr></table></figure></li><li><p>4ã€nodeé‡æ–°åŠ å…¥é›†ç¾¤<br>&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬çš„nodeæ‰§è¡Œåˆ é™¤ä»¥åï¼Œé‡æ–°å¯åŠ¨kubeletæœåŠ¡ä»¥åã€‚nodeåˆä¼šè‡ªåŠ¨çš„åŠ å…¥åˆ°é›†ç¾¤é‡Œé¢æ¥ï¼Œæ€ä¹ˆå½»åº•çš„åˆ é™¤ï¼Œè®©åé‡å¯kubeletçš„æ—¶å€™é‡æ–°åƒé›†ç¾¤é‡Œé¢å‘å‡ºcsrè¯·æ±‚ï¼Œé›†ç¾¤é‡æ–°é€šè¿‡è¯¥èŠ‚ç‚¹çš„csrè¯·æ±‚å§è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤æ¥ï¼Œ<code>kubelet.kubeconfig</code>ä¹Ÿé‡æ–°ç”Ÿæˆ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE     REQUESTOR           CONDITION</span><br><span class="line">node-csr-H1CAqJw4VZYY67-tk4Akuso_uuPPwpj3d5jK3xcL88M   8m      kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-YPvpbITaxGBrOxuCpGiY7jrGpPNSZ4sdbKhSkUEcdnc   7m54s   kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek   5s      kubelet-bootstrap   Pending</span><br><span class="line">node-csr-u4oi5e0Upt-ZmejSDEFm9Q0RU3wZf9bThU_o51nclgg   17m     kubelet-bootstrap   Approved,Issued</span><br></pre></td></tr></table></figure></li><li><p>5ã€é‡æ–°é€šè¿‡csr</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl certificate approve node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek </span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-odhUT58g0mdVuZdUeclj7doEpUmWzv1YzaiJYQaPeek approved</span><br></pre></td></tr></table></figure></li><li><p>6ã€åœ¨é›†ç¾¤æŸ¥çœ‹èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-master-01-2 kubernetes]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.16.110   Ready    &lt;none&gt;   36s   v1.13.3</span><br><span class="line">172.21.17.30    Ready    &lt;none&gt;   28m   v1.13.3</span><br><span class="line">172.21.17.31    Ready    &lt;none&gt;   17m   v1.13.3</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>node</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos routeç­–ç•¥</title>
    <url>/2019/08/28/Centos-route%E7%AD%96%E7%95%A5/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸ä¸šåŠ¡åœ¨ä¸€ä¸ªæ–°çš„äº‘å¹³å°ä¸Šçº¿ï¼Œè¯¥äº‘å¹³å°ä½¿ç”¨çš„æ˜¯æ¯”è¾ƒä¼ ç»Ÿçš„VMware vSphereæ¥åšçš„è™šæ‹ŸåŒ–ï¼Œè€Œä¸”è¯¥äº‘å¹³å°ç½‘ç»œä¹Ÿæ˜¯æˆ‘ä»¬ä¸æ¸…æ¥šçš„ï¼Œåæ­£å°±æ˜¯ä¸èƒ½è®¾ç½®(ä¸èƒ½åƒç°åœ¨ä¸»æµäº‘å¹³å°è‡ªå®šä¹‰ç½‘ç»œæˆ–è€…æ˜¯åœ°å€æ®µ)ï¼Œæ˜¯ä¸€ä¸ªæ”¿åºœçš„äº‘å¹³å°ï¼Œå…·ä½“å„ç§å¥‡è‘©çš„é™åˆ¶å°±ä¸è¯´å•¦ï¼Œä½ æ‡‚çš„â€¦â€¦</p></blockquote><a id="more"></a><p>&nbsp;&nbsp;&nbsp;&nbsp;æ ¹æ®æˆ‘ä»¬è‡ªèº«ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå†…ç½‘åœ°å€æ®µï¼Œå’Œå¯¹æ–¹åå•†åç»™æˆ‘ä»¬å¼€äº†ä¸€ä¸ª10ç½‘æ®µï¼Œ20çš„å­ç½‘ï¼Œç„¶åè¦äº†ä¸¤å°å¸¦æœ‰å¤–ç½‘ipçš„æœåŠ¡å™¨ï¼Œä¸€ä¸ªç”¨æ¥åšè·³æ¿æœºï¼Œä¸€ä¸ªç”¨æ¥åšåå‘ä»£ç†ã€‚ç„¶åç­‰äº†ä¸¤å¤©å¯¹æ–¹å§æœåŠ¡å™¨ç»™æˆ‘ä»¬å¼€å¥½äº†ï¼Œæˆ‘ä»¬ç™»å½•è·³æ¿æœºï¼Œå‘ç°åªæœ‰å¤–ç½‘ipçš„æœåŠ¡å™¨æ‰èƒ½ä¸Šç½‘ï¼Œå…¶ä»–çš„å‡ä¸èƒ½ä¸Šç½‘ï¼Œåšnatä¹Ÿä¸èƒ½ä¸Šï¼Œä½†æ˜¯è·³æ¿æœºæ˜¯å…¬ç½‘ï¼Œæ²¡æœ‰å†…ç½‘ï¼Œå¯ä»¥é€šå†…ç½‘çš„ipæœåŠ¡å™¨ï¼Œæ‰€ä»¥çŒœæµ‹ç½‘ç»œç­–ç•¥è‚¯å®šæ˜¯ä»–ä»¬åœ¨äº¤æ¢æœºä¸Šåšçš„ã€‚ç„¶åæˆ‘ä»¬è‡ªå·±yumæºæ¥å®‰è£…ä¸€äº›ä¸­é—´ä»¶ã€‚ï¼ˆä¸è¯´äº†ï¼Œåé¢è¿˜æœ‰ä¸€å †çš„å¥‡è‘©é—®é¢˜ï¼Œè¿›å…¥æ­£é¢˜å§ï¼‰</p><h3 id="åæœŸé—®é¢˜"><a href="#åæœŸé—®é¢˜" class="headerlink" title="åæœŸé—®é¢˜"></a>åæœŸé—®é¢˜</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å½“æˆ‘ä»¬æŠŠä¸šåŠ¡éƒ¨ç½²ä¸Šçº¿ä»¥åï¼Œè¿è¡Œä¸€æ®µæ—¶é—´åå‡ºç°å¾®æœåŠ¡ä¹‹é—´è°ƒç”¨è¶…æ—¶ï¼Œç„¶åæˆ‘ä»¬ç™»å½•æœåŠ¡å™¨æ’æŸ¥ç½‘ç»œé—®é¢˜ï¼Œåœ¨æœåŠ¡å™¨ä¹‹é—´pingå†…ç½‘æ²¡é—®é¢˜ï¼Œpingæ³¨å†Œä¸­å¿ƒã€æ•°æ®åº“éƒ½æ²¡é—®é¢˜ã€‚æœåŠ¡å™¨æœ‰å…¬ç½‘ï¼Œç„¶åå…¬ç½‘ä¹‹é—´pingéƒ½æ²¡é—®é¢˜ï¼Œç½‘ç»œå±‚é¢æ²¡æœ‰ä»»ä½•çš„é—®é¢˜ï¼ŒæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ä¹Ÿæœ‰å‘ç°é”™è¯¯ï¼Œç„¶åå•ç‹¬çš„å§å€Ÿå£åœ°å€æ‹¿å‡ºæ¥è¿›è¡Œ<code>curl</code>èƒ½è¿‡ä½†æ˜¯æœ‰ç‚¹æ…¢ï¼Œç„¶åå°±å§è¿™ä¸ªå‘½ä»¤å†™åœ¨è„šæœ¬é‡Œé¢ï¼Œè®©ä»–æ¯30ç§’è·‘ä¸€æ¬¡ï¼Œç„¶åè¿½åŠ æ—¥å¿—ï¼Œè·‘äº†ä¸¤ä¸‰ä¸ªå°æ—¶ï¼Œæˆ‘ä»¬æŸ¥çœ‹æ—¥å¿—ï¼Œæ—¥å¿—é‡Œé¢ä¹Ÿæœ‰è¶…æ—¶ç°è±¡ï¼Œå¥‡æ€ªäº†ï¼Œç„¶åå§è¿™ä¸ªé—®é¢˜è”ç³»å¯¹æ–¹äº‘å¹³å°çš„å·¥ç¨‹å¸ˆï¼Œç³»ç»Ÿå·¥ç¨‹å¸ˆã€ç½‘ç»œå·¥ç¨‹å¸ˆæ‹‰ç¾¤è®¨è®ºï¼Œæœ€åå¯¹æ–¹ç³»ç»Ÿå·¥ç¨‹å¸ˆæç¤ºæˆ‘ä»¬è®©æˆ‘ä»¬å§è·¯ç”±çš„<code>Metric</code>å€¼ä¸¤ä¸ªç½‘å¡ä¸è¦ä¸€æ ·ï¼Œå¯¹<code>Metric</code>åˆšå¼€å§‹ä¸€å¹´æ‡µé€¼ï¼Œå…ˆä¸ç®¡ï¼Œè§£å†³é—®é¢˜å†è¯´ï¼š</p><ul><li><p>ä¿®æ”¹Metric(å†…ç½‘å¡)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br><span class="line">$ sudo route add -net 10.10.20.0/22 dev ens160 metric 98</span><br><span class="line">$ sudo route  del -net 10.10.20.0/22 dev ens160 metric 100</span><br></pre></td></tr></table></figure></li><li><p>è®°ä½æ˜¯å…ˆæ·»åŠ åˆ é™¤ï¼Œé¡ºåºä¸è¦é¢ å€’</p></li><li><p>æŸ¥çœ‹è·¯ç”±</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         119.126.116.254 0.0.0.0         UG    100    0        0 ens192</span><br><span class="line">10.10.20.0      0.0.0.0         255.255.252.0   U     98     0        0 ens160</span><br><span class="line">119.126.116.128 0.0.0.0         255.255.255.128 U     100    0        0 ens192</span><br></pre></td></tr></table></figure></li><li><p>ens192(å¤–ç½‘å¡)</p></li><li><p>ens160(å†…ç½‘å¡)</p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;æ¶‰åŠåˆ°çš„ä¸šåŠ¡æœåŠ¡å™¨éƒ½ä¿®æ”¹ï¼Œä¿®æ”¹Metricå€¼ä»¥åï¼Œæˆ‘ä»¬<code>curl</code>ä¸€æ¬¡ï¼Œé€Ÿåº¦æ¯”ä»¥å‰å¿«å¤šäº†ï¼Œåˆè·‘äº†ä¸€æ¬¡è„šæœ¬ï¼Œè§‚å¯Ÿäº†å‡ ä¸ªå°æ—¶æ²¡é—®é¢˜ï¼Œè§‚å¯Ÿäº†ä¸¤å¤©ï¼Œä¸šåŠ¡æ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œæ—¥å¿—é‡Œé¢ä¹Ÿæ²¡æœ‰å‡ºç°è¶…æ—¶ï¼Œé—®é¢˜å¾—åˆ°è§£å†³</p><h3 id="Metric-ä»‹ç»"><a href="#Metric-ä»‹ç»" class="headerlink" title="Metric ä»‹ç»"></a>Metric ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºè·¯ç”±æŒ‡å®šæ‰€éœ€è·ƒç‚¹æ•°çš„æ•´æ•°å€¼ï¼ˆèŒƒå›´æ˜¯ 1 ~ 9999ï¼‰ï¼Œå®ƒç”¨æ¥åœ¨è·¯ç”±è¡¨é‡Œçš„å¤šä¸ªè·¯ç”±ä¸­é€‰æ‹©ä¸è½¬å‘åŒ…ä¸­çš„ç›®æ ‡åœ°å€æœ€ä¸ºåŒ¹é…çš„è·¯ç”±ã€‚æ‰€é€‰çš„è·¯ç”±å…·æœ‰æœ€å°‘çš„è·ƒç‚¹æ•°ã€‚è·ƒç‚¹æ•°èƒ½å¤Ÿåæ˜ è·ƒç‚¹çš„æ•°é‡ã€è·¯å¾„çš„é€Ÿåº¦ã€è·¯å¾„å¯é æ€§ã€è·¯å¾„ååé‡ä»¥åŠç®¡ç†å±æ€§ã€‚Metricçš„å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼›å¦‚æœä¸¤å—ç½‘å¡çš„Metricçš„å€¼ç›¸åŒï¼Œå°±ä¼šå‡ºç°æŠ¢å ä¼˜å…ˆçº§ç»§è€Œç½‘å¡å†²çªï¼Œå°†ä¼šæœ‰ä¸€å—ç½‘å¡æ— æ³•è¿æ¥</p><p>æ›´å¤šä»‹ç»<a href="https://www.cyberciti.biz/faq/what-is-a-routing-table/" target="_blank" rel="noopener">å‚è€ƒ</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>route</tag>
        <tag>Metric</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²ingress</title>
    <url>/2019/08/26/k8s%E9%83%A8%E7%BD%B2ingress/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><p>åœ¨kubernetes é›†ç¾¤ä¸­ï¼Œä¸€ä¸ªæœåŠ¡å®‰è£…ä»¥åæ€ä¹ˆå¯¹å¤–æä¾›è®¿é—®ï¼Œå¤–éƒ¨ç”¨æˆ·æ€ä¹ˆæ¥è®¿é—®æˆ‘ä»¬å®¹å™¨ä¸­ä¸šåŠ¡ã€‚</p><p><img src="https://img.xxlaila.cn/2373874sds43.png" alt="img"></p><h3 id="1ã€Ingress-ä»‹ç»"><a href="#1ã€Ingress-ä»‹ç»" class="headerlink" title="1ã€Ingress ä»‹ç»"></a>1ã€Ingress ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes æš´éœ²æœåŠ¡çš„æ–¹å¼ç›®å‰åªæœ‰ä¸‰ç§ï¼šLoadBlancer Serviceã€NodePort Serviceã€Ingressï¼›æœ¬æ–‡ä¸»è¦é€šè¿‡Ingressæ¥è®¿é—®</p><h3 id="2ã€Ingress-æ˜¯ä»€ä¹ˆ"><a href="#2ã€Ingress-æ˜¯ä»€ä¹ˆ" class="headerlink" title="2ã€Ingress æ˜¯ä»€ä¹ˆ"></a>2ã€Ingress æ˜¯ä»€ä¹ˆ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Ingress å°±æ˜¯èƒ½åˆ©ç”¨ Nginxã€Haproxy å•¥çš„è´Ÿè½½å‡è¡¡å™¨æš´éœ²é›†ç¾¤å†…æœåŠ¡çš„å·¥å…·é—®é¢˜æ¥äº†ï¼Œé›†ç¾¤å†…æœåŠ¡æƒ³è¦æš´éœ²å‡ºå»é¢ä¸´ç€å‡ ä¸ªé—®é¢˜ï¼š</p><a id="more"></a><ul><li><p>Pod æ¼‚ç§»é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¼—æ‰€å‘¨çŸ¥ Kubernetes å…·æœ‰å¼ºå¤§çš„å‰¯æœ¬æ§åˆ¶èƒ½åŠ›ï¼Œèƒ½ä¿è¯åœ¨ä»»æ„å‰¯æœ¬(Pod)æŒ‚æ‰æ—¶è‡ªåŠ¨ä»å…¶ä»–æœºå™¨å¯åŠ¨ä¸€ä¸ªæ–°çš„ï¼Œè¿˜å¯ä»¥åŠ¨æ€æ‰©å®¹ç­‰ï¼Œæ€»ä¹‹ä¸€å¥è¯ï¼Œè¿™ä¸ª Pod å¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»å‡ºç°åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»æ­»åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šï¼›é‚£ä¹ˆè‡ªç„¶éšç€ Pod çš„åˆ›å»ºå’Œé”€æ¯ï¼ŒPod IP è‚¯å®šä¼šåŠ¨æ€å˜åŒ–ï¼›é‚£ä¹ˆå¦‚ä½•æŠŠè¿™ä¸ªåŠ¨æ€çš„ Pod IP æš´éœ²å‡ºå»ï¼Ÿè¿™é‡Œå€ŸåŠ©äº Kubernetes çš„ Service æœºåˆ¶ï¼ŒService å¯ä»¥ä»¥æ ‡ç­¾çš„å½¢å¼é€‰å®šä¸€ç»„å¸¦æœ‰æŒ‡å®šæ ‡ç­¾çš„ Podï¼Œå¹¶ç›‘æ§å’Œè‡ªåŠ¨è´Ÿè½½ä»–ä»¬çš„ Pod IPï¼Œé‚£ä¹ˆæˆ‘ä»¬å‘å¤–æš´éœ²åªæš´éœ² Service IP å°±è¡Œäº†ï¼›è¿™å°±æ˜¯ NodePort æ¨¡å¼ï¼šå³åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¼€èµ·ä¸€ä¸ªç«¯å£ï¼Œç„¶åè½¬å‘åˆ°å†…éƒ¨ Service IP ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://img.xxlaila.cn/4dfs98347sdhsfs.png" alt="img"></p></li><li><p>ç«¯å£ç®¡ç†é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;é‡‡ç”¨ NodePort æ–¹å¼æš´éœ²æœåŠ¡é¢ä¸´ä¸€ä¸ªå‘çˆ¹çš„é—®é¢˜æ˜¯ï¼ŒæœåŠ¡ä¸€æ—¦å¤šèµ·æ¥ï¼ŒNodePort åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¼€å¯çš„ç«¯å£ä¼šåŠå…¶åºå¤§ï¼Œè€Œä¸”éš¾ä»¥ç»´æŠ¤ï¼›è¿™æ—¶å€™å¼•å‡ºçš„æ€è€ƒé—®é¢˜æ˜¯ â€œèƒ½ä¸èƒ½ä½¿ç”¨ Nginx å•¥çš„åªç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œæ¯”å¦‚ 80ï¼Œç„¶åæŒ‰ç…§åŸŸåå‘åè½¬å‘ï¼Ÿâ€ ç®€å•çš„å®ç°å°±æ˜¯ä½¿ç”¨ DaemonSet åœ¨æ¯ä¸ª node ä¸Šç›‘å¬ 80ï¼Œç„¶åå†™å¥½è§„åˆ™ï¼Œå› ä¸º Nginx å¤–é¢ç»‘å®šäº†å®¿ä¸»æœº 80 ç«¯å£(å°±åƒ NodePort)ï¼Œæœ¬èº«åˆåœ¨é›†ç¾¤å†…ï¼Œé‚£ä¹ˆå‘åç›´æ¥è½¬å‘åˆ°ç›¸åº” Service IP å°±è¡Œäº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://img.xxlaila.cn/85793kdfksdo43.png" alt="img"></p></li><li><p>åŸŸååˆ†é…åŠåŠ¨æ€æ›´æ–°é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢çš„æ€è·¯ï¼Œé‡‡ç”¨ Nginx ä¼¼ä¹å·²ç»è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯å…¶å®è¿™é‡Œé¢æœ‰ä¸€ä¸ªå¾ˆå¤§ç¼ºé™·ï¼šæ¯æ¬¡æœ‰æ–°æœåŠ¡åŠ å…¥æ€ä¹ˆæ”¹ Nginx é…ç½®ï¼Ÿæ€»ä¸èƒ½æ‰‹åŠ¨æ”¹æˆ–è€…æ¥ä¸ª Rolling Update å‰ç«¯ Nginx Pod å§ï¼Ÿè¿™æ—¶å€™ â€œä¼Ÿå¤§è€Œåˆæ­£ç›´å‹‡æ•¢çš„â€ Ingress ç™»åœºï¼Œå¦‚æœä¸ç®—ä¸Šé¢çš„ Nginxï¼ŒIngress åªæœ‰ä¸¤å¤§ç»„ä»¶ï¼šIngress Controller å’Œ Ingress<br>&nbsp;&nbsp;&nbsp;&nbsp;Ingress ç®€å•çš„ç†è§£å°±æ˜¯ ä½ åŸæ¥è¦æ”¹ Nginx é…ç½®ï¼Œç„¶åé…ç½®å„ç§åŸŸåå¯¹åº”å“ªä¸ª Serviceï¼Œç°åœ¨æŠŠè¿™ä¸ªåŠ¨ä½œæŠ½è±¡å‡ºæ¥ï¼Œå˜æˆä¸€ä¸ª Ingress å¯¹è±¡ï¼Œä½ å¯ä»¥ç”¨ yml åˆ›å»ºï¼Œæ¯æ¬¡ä¸è¦å»æ”¹ Nginx äº†ï¼Œç›´æ¥æ”¹ yml ç„¶ååˆ›å»º/æ›´æ–°å°±è¡Œäº†ï¼›é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šâ€Nginx å’‹æ•´ï¼Ÿâ€<br>&nbsp;&nbsp;&nbsp;&nbsp;Ingress Controller è¿™ä¸œè¥¿å°±æ˜¯è§£å†³ â€œNginx å’‹æ•´â€ çš„ï¼›Ingress Controoler é€šè¿‡ä¸ Kubernetes API äº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ Ingress è§„åˆ™å˜åŒ–ï¼Œç„¶åè¯»å–ä»–ï¼ŒæŒ‰ç…§ä»–è‡ªå·±æ¨¡æ¿ç”Ÿæˆä¸€æ®µ Nginx é…ç½®ï¼Œå†å†™åˆ° Nginx Pod é‡Œï¼Œæœ€å reload ä¸€ä¸‹ï¼Œå·¥ä½œæµç¨‹å¦‚ä¸‹å›¾:</p></li></ul><p><img src="https://img.xxlaila.cn/3248kjfiy4789wodjkshf3.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;å½“ç„¶åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæœ€æ–°ç‰ˆæœ¬ Kubernetes å·²ç»å°† Nginx ä¸ Ingress Controller åˆå¹¶ä¸ºä¸€ä¸ªç»„ä»¶ï¼Œæ‰€ä»¥ Nginx æ— éœ€å•ç‹¬éƒ¨ç½²ï¼Œåªéœ€è¦éƒ¨ç½² Ingress Controller å³å¯ã€‚</p><h3 id="3ã€Nginx-Ingress"><a href="#3ã€Nginx-Ingress" class="headerlink" title="3ã€Nginx Ingress"></a>3ã€Nginx Ingress</h3><h4 id="3-1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶"><a href="#3-1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶" class="headerlink" title="3.1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶"></a>3.1ã€ä¸‹è½½å®˜æ–¹æ–‡ä»¶</h4><p>å®˜æ–¹çš„mandatory.yamlæ–‡ä»¶é‡Œé¢åŒ…å«äº†ingress RBACï¼Œé‡è¦çš„ç»„ä»¶ <a href="https://github.com/kubernetes/ingress-nginx/tree/nginx-0.20.0/deploy" target="_blank" rel="noopener">Nginx+Ingres Controller</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mandatory.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-configuration</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: udp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-serviceaccount</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - endpoints</span><br><span class="line">      - nodes</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - nodes</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">"extensions"</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - events</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">      - patch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">"extensions"</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses/status</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">      - namespaces</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    resourceNames:</span><br><span class="line">      <span class="comment"># Defaults to "&lt;election-id&gt;-&lt;ingress-class&gt;"</span></span><br><span class="line">      <span class="comment"># Here: "&lt;ingress-controller-leader&gt;-&lt;nginx&gt;"</span></span><br><span class="line">      <span class="comment"># This has to be adapted if you change either parameter</span></span><br><span class="line">      <span class="comment"># when launching the nginx-ingress-controller.</span></span><br><span class="line">      - <span class="string">"ingress-controller-leader-nginx"</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">""</span></span><br><span class="line">    resources:</span><br><span class="line">      - endpoints</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role-nisa-binding</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">      app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: <span class="string">"10254"</span></span><br><span class="line">        prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx-ingress-controller</span><br><span class="line">          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.22.0</span><br><span class="line">          args:</span><br><span class="line">            - /nginx-ingress-controller</span><br><span class="line">            - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class="line">            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class="line">            - --publish-service=$(POD_NAMESPACE)/ingress-nginx</span><br><span class="line">            - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line">     --default-ssl-certificate=$(POD_NAMESPACE)/ingress-secret</span><br><span class="line">      --default-backend-service=$(POD_NAMESPACE)/default-http-backend</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: <span class="literal">true</span></span><br><span class="line">            capabilities:</span><br><span class="line">              drop:</span><br><span class="line">                - ALL</span><br><span class="line">              add:</span><br><span class="line">                - NET_BIND_SERVICE</span><br><span class="line">            <span class="comment"># www-data -&gt; 33</span></span><br><span class="line">            runAsUser: 33</span><br><span class="line">          env:</span><br><span class="line">            - name: POD_NAME</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.name</span><br><span class="line">            - name: POD_NAMESPACE</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.namespace</span><br><span class="line">          ports:</span><br><span class="line">            - name: http</span><br><span class="line">              containerPort: 80</span><br><span class="line">              hostPort: 80</span><br><span class="line">            - name: https</span><br><span class="line">              containerPort: 443</span><br><span class="line">              hostPort: 443</span><br><span class="line">          livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">          readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>hostNetwork: true</code>æ˜¯å¢åŠ çš„ï¼Œ å®˜æ–¹çš„ Ingress Controller æœ‰ä¸ªå‘ï¼Œé»˜è®¤æ³¨é‡Šäº†hostNetwork å·¥ä½œæ–¹å¼ã€‚ä»¥é˜²æ­¢ç«¯å£çš„åœ¨å®¿ä¸»æœºçš„å†²çªã€‚æ²¡æœ‰ç»‘å®šåˆ°å®¿ä¸»æœº 80 ç«¯å£ï¼Œä¹Ÿå°±æ˜¯è¯´å‰ç«¯ Nginx æ²¡æœ‰ç›‘å¬å®¿ä¸»æœº 80 ç«¯å£ï¼›æ‰€ä»¥éœ€è¦æŠŠé…ç½®æä¸‹æ¥è‡ªå·±åŠ ä¸€ä¸‹ hostNetworkã€‚</p><h4 id="3-2ã€éƒ¨ç½²é»˜è®¤åç«¯"><a href="#3-2ã€éƒ¨ç½²é»˜è®¤åç«¯" class="headerlink" title="3.2ã€éƒ¨ç½²é»˜è®¤åç«¯"></a>3.2ã€éƒ¨ç½²é»˜è®¤åç«¯</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬çŸ¥é“ å‰ç«¯çš„ Nginx æœ€ç»ˆè¦è´Ÿè½½åˆ°åç«¯ service ä¸Šï¼Œé‚£ä¹ˆå¦‚æœè®¿é—®ä¸å­˜åœ¨çš„åŸŸåå’‹æ•´ï¼Ÿå®˜æ–¹ç»™å‡ºçš„å»ºè®®æ˜¯éƒ¨ç½²ä¸€ä¸ª é»˜è®¤åç«¯ï¼Œå¯¹äºæœªçŸ¥è¯·æ±‚å…¨éƒ¨è´Ÿè½½åˆ°è¿™ä¸ªé»˜è®¤åç«¯ä¸Šï¼›è¿™ä¸ªåç«¯å•¥ä¹Ÿä¸å¹²ï¼Œå°±æ˜¯è¿”å› 404ï¼Œéƒ¨ç½²å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat default-backend.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: default-http-backend</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - name: default-http-backend</span><br><span class="line">        <span class="comment"># Any image is permissable as long as:</span></span><br><span class="line">        <span class="comment"># 1. It serves a 404 page at /</span></span><br><span class="line">        <span class="comment"># 2. It serves 200 on a /healthz endpoint</span></span><br><span class="line">        image: docker.io/xxlaila/defaultbackend:1.4</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line"><span class="comment">#      nodeSelector:</span></span><br><span class="line"><span class="comment">#        kubernetes.io/hostname: 172.21.16.231</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: default-http-backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: default-http-backend</span><br></pre></td></tr></table></figure><h4 id="3-3ã€æ‰§è¡Œåˆ›å»º-å®Œæˆåå¯ä»¥çœ‹åˆ°"><a href="#3-3ã€æ‰§è¡Œåˆ›å»º-å®Œæˆåå¯ä»¥çœ‹åˆ°" class="headerlink" title="3.3ã€æ‰§è¡Œåˆ›å»º,å®Œæˆåå¯ä»¥çœ‹åˆ°"></a>3.3ã€æ‰§è¡Œåˆ›å»º,å®Œæˆåå¯ä»¥çœ‹åˆ°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f mandatory.yaml </span></span><br><span class="line"><span class="comment"># kubectl create -f default-backend.yaml</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/34dnksjfh384yksfkjdsfsd.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n ingress-nginx</span></span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">default-http-backend-66cdcb6c7d-pb9sp      1/1     Running   0          8h</span><br><span class="line">nginx-ingress-controller-69585dbb4-m6fcm   1/1     Running   0          8h</span><br><span class="line"><span class="comment"># kubectl get svc -n ingress-nginx</span></span><br><span class="line">NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default-http-backend   ClusterIP   10.102.60.154   &lt;none&gt;        80/TCP    8h</span><br></pre></td></tr></table></figure><h3 id="4ã€éƒ¨ç½²-Ingress"><a href="#4ã€éƒ¨ç½²-Ingress" class="headerlink" title="4ã€éƒ¨ç½² Ingress"></a>4ã€éƒ¨ç½² Ingress</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»ä¸Šé¢å¯ä»¥çŸ¥é“ Ingress å°±æ˜¯ä¸ªè§„åˆ™ï¼ŒæŒ‡å®šå“ªä¸ªåŸŸåè½¬å‘åˆ°å“ªä¸ª Serviceï¼Œæ‰€ä»¥è¯´é¦–å…ˆæˆ‘ä»¬å¾—æœ‰ä¸ª Serviceï¼Œå½“ç„¶ Service å»å“ªæ‰¾è¿™é‡Œå°±ä¸ç®¡äº†ï¼›è¿™é‡Œé»˜è®¤ä¸ºå·²ç»æœ‰äº†ä¸¤ä¸ªå¯ç”¨çš„ Serviceï¼Œä»¥ä¸‹ä»¥ jenkinsã€Dashboard ä¸ºä¾‹<br>&nbsp;&nbsp;&nbsp;&nbsp;å…ˆå†™ä¸€ä¸ª Ingress æ–‡ä»¶ï¼Œè¯­æ³•æ ¼å¼å•¥çš„è¯·å‚è€ƒ å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºæˆ‘çš„ jenkinsåœ¨kube-opsï¼ŒDashboard åœ¨kube-system è¿™ä¸ªå‘½åç©ºé—´ï¼Œæ‰€ä»¥è¦æŒ‡å®š namespace.å‚è€ƒä¸‹é¢å®ä¾‹</p><h4 id="4-1ã€éƒ¨ç½²jenkinså®ä¾‹"><a href="#4-1ã€éƒ¨ç½²jenkinså®ä¾‹" class="headerlink" title="4.1ã€éƒ¨ç½²jenkinså®ä¾‹"></a>4.1ã€éƒ¨ç½²jenkinså®ä¾‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-ingress</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: ci.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: jenkins2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"><span class="comment"># kubectl create -f jenkins-ingress.yaml</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒåŸŸåè§£æåˆ°ipåœ°å€ï¼Œè®¿é—®jenkins</p><p><img src="https://img.xxlaila.cn/1566808344775.jpg" alt="img"></p><h4 id="4-2ã€éƒ¨ç½²kubernetes-dashboard"><a href="#4-2ã€éƒ¨ç½²kubernetes-dashboard" class="headerlink" title="4.2ã€éƒ¨ç½²kubernetes-dashboard"></a>4.2ã€éƒ¨ç½²kubernetes-dashboard</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat nginx-kubernetes-dashboard.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/ingress.class: nginx</span><br><span class="line">    nginx.ingress.kubernetes.io/secure-backends: <span class="string">"true"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-passthrough: <span class="string">"true"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - k8s.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">    - host: dashboard.xxlaila.io</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: kubernetes-dashboard</span><br><span class="line">            servicePort: 443</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/786jg656iojhf0.png" alt="img"></p><h3 id="5ã€éƒ¨ç½²-Ingress-TLS"><a href="#5ã€éƒ¨ç½²-Ingress-TLS" class="headerlink" title="5ã€éƒ¨ç½² Ingress TLS"></a>5ã€éƒ¨ç½² Ingress TLS</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢å·²ç»åšå¥½äº† Ingressï¼Œæ¥ä¸‹æ¥é…ç½®TLS ï¼›å®˜æ–¹ç»™å‡ºçš„æ ·ä¾‹å¾ˆç®€å•ï¼Œå¤§è‡´æ­¥éª¤å°±ä¸¤æ­¥ï¼šåˆ›å»ºä¸€ä¸ªå«æœ‰è¯ä¹¦çš„ secretã€åœ¨ Ingress å¼€å¯è¯ä¹¦ï¼›ä½†æ˜¯å®˜æ–¹çš„æœ‰å‘ï¼Œä¸‹é¢æ˜¯æ“ä½œæ­¥éª¤</p><h4 id="5-1ã€åˆ›å»ºè¯ä¹¦"><a href="#5-1ã€åˆ›å»ºè¯ä¹¦" class="headerlink" title="5.1ã€åˆ›å»ºè¯ä¹¦"></a>5.1ã€åˆ›å»ºè¯ä¹¦</h4><p>é¦–å…ˆç¬¬ä¸€æ­¥å½“ç„¶è¦æœ‰ä¸ªè¯ä¹¦ï¼Œç”±äºæˆ‘è¿™ä¸ª Ingress æœ‰ä¸¤ä¸ªæœåŠ¡åŸŸåï¼Œæ‰€ä»¥è¯ä¹¦è¦æ”¯æŒä¸¤ä¸ªåŸŸåï¼›ç”Ÿæˆè¯ä¹¦å‘½ä»¤å¦‚ä¸‹ï¼š</p><ul><li><p>ç”ŸæˆCAè¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir cert &amp;&amp; cd cert</span></span><br></pre></td></tr></table></figure></li><li><p>ç¼–è¾‘ openssl é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /etc/pki/tls/openssl.cnf .</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ä¸»è¦é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi openssl.cnf</span></span><br><span class="line">	[req]</span><br><span class="line">	req_extensions = v3_req <span class="comment"># è¿™è¡Œé»˜è®¤æ³¨é‡Šå…³ç€çš„ æŠŠæ³¨é‡Šåˆ æ‰</span></span><br></pre></td></tr></table></figure></li><li><p>å¢åŠ é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi openssl.cnf</span></span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = dashboard.mritd.me		<span class="comment">#éœ€è¦å¢åŠ çš„åŸŸå</span></span><br><span class="line">DNS.2 = kibana.mritd.me</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆè¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl genrsa -out ingress-key.pem 2048</span></span><br><span class="line"><span class="comment"># openssl req -new -key ingress-key.pem -out ingress.csr -subj "/CN=kube-ingress" -config openssl.cnf</span></span><br><span class="line"><span class="comment"># openssl x509 -req -in ingress.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out ingress.pem -days 365 -extensions v3_req -extfile openssl.cnf</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç”Ÿæˆåçš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">ca-key.pem  ca.pem  ca.srl  ingress-key.pem  ingress.csr  ingress.pem  openssl.cnf</span><br></pre></td></tr></table></figure></li></ul><h4 id="5-2ã€åˆ›å»º-secret"><a href="#5-2ã€åˆ›å»º-secret" class="headerlink" title="5.2ã€åˆ›å»º secret"></a>5.2ã€åˆ›å»º secret</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå¥½è¯ä¹¦ä»¥åï¼Œéœ€è¦å°†è¯ä¹¦å†…å®¹æ”¾åˆ° secret ä¸­ï¼Œsecret ä¸­å…¨éƒ¨å†…å®¹éœ€è¦ base64 ç¼–ç ï¼Œç„¶åæ³¨æ„å»æ‰æ¢è¡Œç¬¦(å˜æˆä¸€è¡Œ)ï¼›ä»¥ä¸‹æ˜¯æˆ‘çš„ secret æ ·ä¾‹(ä¸Šä¸€æ­¥ä¸­ ingress.pem æ˜¯è¯ä¹¦crtï¼Œingress-key.pem æ˜¯è¯ä¹¦çš„ key)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ingress-secret.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  tls.crt: MIIDAjCCAeqgAwIBAgIJAIUNBpFKFrg4MA0GCSqGSIb3DQEBCwUAMBIxEDAOBgNVBAMMB2t1YmUtY2EwHhcNMTkwMTI5MTAzMzQ3WhcNMjAwMTI5MTAzMzQ3WjAXMRUwEwYDVQQDDAxrdWJlLWluZ3Jlc3MwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC0rLcpYHdqVjN84vCJYF2l61F+LYuPRczPNWyo8Rba4XpT6MMMqoGqgmI164r4of2klBEMPZ0dm1mJaYnjb1Zq/qzVUlqaednxfXsr6u8Xm0a6l7ep+Yr+XcRISZC9AjgyqlFtgjzbNJauHkHTy0i+jqV2A4SkVUT2whBqF00WEKC6kQLhw4Ab1XBG5aOK2Jz4TZdP+Mw4n3AsihycHgjhFvhGNixKl4mpfHfLvFeKxmBa8ZoWT+3AGgkX186EXhdhsfdYqHeLT2TvwsqbUJI8E8F7nleo5VMifr9KGHxaCJ+ynr/WFX1c+0wYAGmSKsw4CnXh4EE+IvaeQjBz8O2HAgMBAAGjVjBUMAkGA1UdEwQCMAAwCwYDVR0PBAQDAgXgMDoGA1UdEQQzMDGCFmNpLnp4Yy5raW5neHVubGlhbi5jb22CF2s4cy56eGMua2luZ3h1bmxpYW4uY29tMA0GCSqGSIb3DQEBCwUAA4IBAQCShThVXg3Fnkrm82sHowxCEc9UG9uzOY2LbxhVN7mcm8U0cXy3acAXdKWLHUwdZnOxNJytpaBBWb/6KFFKrIekaSK+tSD+oRISJf43c1tbt0QEpplUaDagQ35NANyQY2VHQntDdVK4/NNJULbHNEqsu19vDDvmDFi0aLHvqPFAvlGnEBPgO1Ac297pDR2thHyMCGBzRKTQOJy2q3HKexa1pItHjAVmv/k71HBeTJ1en2tFHLUlR0kEhYYPBeRclVZ1oYWn7THRaBW8NtugdM6mxVNFAWQTq5goP0VcW44lWYiUF6mX/UZa2c+5FwsGWdSwbTqmZj7ptA2QcveUcN2/</span><br><span class="line">  tls.key: MIIEowIBAAKCAQEAtKy3KWB3alYzfOLwiWBdpetRfi2Lj0XMzzVsqPEW2uF6U+jDDKqBqoJiNeuK+KH9pJQRDD2dHZtZiWmJ429Wav6s1VJamnnZ8X17K+rvF5tGupe3qfmK/l3ESEmQvQI4MqpRbYI82zSWrh5B08tIvo6ldgOEpFVE9sIQahdNFhCgupEC4cOAG9VwRuWjitic+E2XT/jMOJ9wLIocnB4I4Rb4RjYsSpeJqXx3y7xXisZgWvGaFk/twBoJF9fOhF4XYbH3WKh3i09k78LKm1CSPBPBe55XqOVTIn6/Shh8Wgifsp6/1hV9XPtMGABpkirMOAp14eBBPiL2nkIwc/DthwIDAQABAoIBACLj97sV1fnDC85iRPFCmtMfzmz/fqP8ZsDdIE6/wBok0OrDWGdpxgCXjT+8bOn23nSZ43DptR2ykmfm6anyJk4jQF0xui16uovYH6ErjWCRq+b8xYsdlanpka4kBr95XkDqgy8Sp43taevWDABKkZG7Gljf9Q2HKfo9H85dEZXg7RKKz77wahcHpZofthNo0s5kkH2ckVpjwh5svM+M/gm8KhZkKayndr1ezEAmndT+K/P4EVuYbpPQyk5A6E1G7Dh9M2TczZZa6oiR5etloDk2sOIYxysIZqAblyMN2IrIO0hf4nGqSmfe0TZMCKzSXoVOV2Qe+ckJ+mSyOPcdbIECgYEA3EMWrrr4oc9R8o35mQ2FDCG0FUyXrCo9SN/CyhScdeUx1IRV00CBwL340H1CwzEpj5g4bj6LGGSeEw2g8qfPoPdzr1yxNnCv43dhaGrWRrSxGL6kGfKmIlbgHTPIuzRkAXGWiCgo5JnzPjQtjmpUTmwmxXwqDih8kpRsBSTsmx0CgYEA0f1ORGtmrj/bRBQU0NF+ztTVFJQbPV3lTHl21Qgd8QcEIcOHqzpI2fmkeGZdyYQXIfODA/X+PFng+Z6J5ubtvplN5jPzpQuQRtIZ47NRmtgn4DoH+GAqxIb2hFbwXpXuSR/LelFtzxb91nGiVKpdizvuwnitgOuAIbgGHYbgpfMCgYAvvA5fYb/eeWq+EUzFgauS3H8FmqrIMgNEFtJFL0BVQI2TC/b5qGI2XjVdIbhlSvNB3nBkXAOTDsM/R9XYoMubi+UzXPg+3x8PQeEHWxgDDMfQoAg6Y17j1EYPrhhTkeAWfAJukZ2DJWYU1gQFeD+7Gy8v31/R365XqfjbCIyKdQKBgD+/3tr2oB2WVUK9tfQPJag1BNtSe1KOBubImULjS/O4ZZC6g51//E3wc/X5Xc+nwj4UZ1n0fFJmFt6xOrxWryaF9BhG/VjFwe8+KY3vCn8v0CtKctD8oP842e4jVqXgbo7UkDl6LxQHrthDdzys2+lBMKLpcAMLe8LA01pzcA/xAoGBAK3KXGXz0AsM+5FBbUFVZFOROUQLcd+N8esHnSqD8i7/J0PJsxm9irutuLht0cYK7Fcq65fYmZ4lrJO7bpiBRzONR78lMgm/rcKfCCNr4o4n6almvuFxA+jGgEM2W7iYb9pW+FFOqIOjl0cSHy2hsN7seGv3JBcz5StRjtwuSWf6</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-secret</span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºå®Œæˆå create<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ingress-secret.yml</span></span><br><span class="line">secret/ingress-secret created</span><br></pre></td></tr></table></figure></li></ul><h4 id="5-3ã€å¿«é€Ÿåˆ›å»º"><a href="#5-3ã€å¿«é€Ÿåˆ›å»º" class="headerlink" title="5.3ã€å¿«é€Ÿåˆ›å»º"></a>5.3ã€å¿«é€Ÿåˆ›å»º</h4><p>5.2æ­¥éª¤å¯ä»¥ç®€åŒ–åˆ›å»ºï¼Œå¯ä»¥æ‰§è¡Œä¸€æ¡å‘½ä»¤è¿›è¡Œåˆ›å»ºï¼Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create secret tls ingress-secret --key cert/ingress-key.pem --cert cert/ingress.pem</span></span><br></pre></td></tr></table></figure><h4 id="5-4ã€é‡æ–°éƒ¨ç½²-Ingress"><a href="#5-4ã€é‡æ–°éƒ¨ç½²-Ingress" class="headerlink" title="5.4ã€é‡æ–°éƒ¨ç½² Ingress"></a>5.4ã€é‡æ–°éƒ¨ç½² Ingress</h4><p>åœ¨tlsç”Ÿæˆå®Œæˆåï¼Œéœ€è¦é‡æ–°éƒ¨ç½²Ingressï¼Œè®©Ingressèƒ½å¤Ÿå®¶åœ¨tlsã€‚ä¿®æ”¹é…ç½®æ–‡ä»¶</p><h5 id="5-4-1ã€jenkins-tls"><a href="#5-4-1ã€jenkins-tls" class="headerlink" title="5.4.1ã€jenkins tls"></a>5.4.1ã€jenkins tls</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi jenkins-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-ingress</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ci.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ci.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: jenkins2</span><br><span class="line">          servicePort: 8080</span><br><span class="line"><span class="comment"># kubect create -f jenkins-ingress.yaml</span></span><br></pre></td></tr></table></figure><p>è®¿é—®jenkinsåŸŸåï¼Œè¿™é‡Œè¾“å…¥httpè®¿é—®ä¼šå¼ºåˆ¶è·³è½¬åˆ°https<br><img src="https://img.xxlaila.cn/1566808668453.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566808711171.jpg" alt="img"></p><h5 id="5-4-2ã€kubernetes-dashboard-tls"><a href="#5-4-2ã€kubernetes-dashboard-tls" class="headerlink" title="5.4.2ã€kubernetes dashboard tls"></a>5.4.2ã€kubernetes dashboard tls</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim nginx-kubernetes-dashboard.yaml </span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - k8s.xxlaila.io</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: k8s.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 80</span><br><span class="line"><span class="comment"># kubectl create -f nginx-kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure><h3 id="6ã€ingress-é«˜çº§ç”¨æ³•"><a href="#6ã€ingress-é«˜çº§ç”¨æ³•" class="headerlink" title="6ã€ingress é«˜çº§ç”¨æ³•"></a>6ã€ingress é«˜çº§ç”¨æ³•</h3><p><img src="https://img.xxlaila.cn/34324kjsdfh8234ks.png" alt="img"></p><ul><li>lvs åå‘ä»£ç†åˆ° ç‰©ç†nginxã€‚å®Œæˆhttpsæ‹†åŒ…ï¼Œç»§æ‰¿nginxæ‰€æœ‰åŠŸèƒ½</li><li>nginx åå‘ä»£ç†åˆ°ingress-controlã€‚ ingress-control æœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ ã€‚<ul><li>ingress-control ä½¿ç”¨nodePort æ–¹å¼æš´æ¼æœåŠ¡</li><li>ingress-control ä½¿ç”¨hostNetwork æ–¹å¼æš´æ¼æœåŠ¡</li></ul></li></ul><h3 id="7ã€æ€»ç»“åˆ†æ"><a href="#7ã€æ€»ç»“åˆ†æ" class="headerlink" title="7ã€æ€»ç»“åˆ†æ"></a>7ã€æ€»ç»“åˆ†æ</h3><ul><li>ingress-control åœ¨è‡ªå·±çš„æ‰€å±çš„namespace=ingress, æ˜¯å¯ä»¥å¤¸ä¸åŒnamespaceæä¾›åå‘ä»£ç†æœ.</li><li>å¦‚æœéœ€è¦æä¾›å¤¸NS è®¿é—®ingressï¼Œå…ˆç»™ ingress-controlåˆ›å»ºRBAC</li><li>ingress-control ä½¿ç”¨hostnetwork æ¨¡å¼ æ€§èƒ½æ¯”ä½¿ç”¨service nodePort æ€§èƒ½å¥½å¾ˆå¤šã€‚å› ä¸ºhostnetwork æ˜¯ç›´æ¥è·å–pod çš„IPï¼Ÿ</li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Ingress</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²Weave Scope</title>
    <url>/2019/08/26/k8s%E9%83%A8%E7%BD%B2Weave-Scope/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="1ã€Weave-Scopeä»‹ç»"><a href="#1ã€Weave-Scopeä»‹ç»" class="headerlink" title="1ã€Weave Scopeä»‹ç»"></a>1ã€Weave Scopeä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;weave scope æ˜¯Dockerå’ŒKubernetesçš„æ•…éšœæ’é™¤å’Œç›‘æ§ï¼Œè‡ªåŠ¨ç”Ÿæˆåº”ç”¨ç¨‹åºçš„åœ°å›¾ï¼Œèƒ½å¤Ÿç›´è§‚åœ°äº†è§£ï¼Œç›‘æ§å’Œæ§åˆ¶åŸºäºå®¹å™¨çš„ï¼ŒåŸºäºå¾®æœåŠ¡çš„åº”ç”¨ç¨‹åºã€‚å¯ä»¥å®æ—¶çš„äº†è§£dockerå®¹å™¨ï¼Œé€‰æ‹©å®¹å™¨åŸºç¡€æ¶æ„çš„æ¦‚è¿°ï¼Œæˆ–å…³æ³¨ç‰¹å®šçš„å¾®æœåŠ¡ã€‚è½»æ¾è¯†åˆ«å’Œçº æ­£é—®é¢˜ï¼Œç¡®ä¿é›†è£…ç®±åŒ–åº”ç”¨çš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼ŒæŸ¥çœ‹å®¹å™¨çš„ä¸Šä¸‹æ–‡æŒ‡æ ‡ï¼Œæ ‡è®°å’Œå…ƒæ•°æ®ã€‚è½»æ¾åœ°åœ¨å®¹å™¨å†…çš„è¿›ç¨‹ä¹‹é—´å¯¼èˆªï¼Œä»¥è¿è¡Œå®¹å™¨ï¼Œåœ¨å¯æ‰©å±•çš„å¯æ’åºè¡¨ä¸­è¿›è¡Œæ’åˆ—ã€‚ä½¿ç”¨ç»™å®šä¸»æœºæˆ–æœåŠ¡çš„æœ€å¤§CPUæˆ–å†…å­˜è½»æ¾æ‰¾åˆ°å®¹å™¨ã€‚ç›´æ¥ä¸æ‚¨çš„å®¹å™¨äº¤äº’ï¼šæš‚åœï¼Œé‡æ–°å¯åŠ¨å’Œåœæ­¢å®¹å™¨ã€‚å¯åŠ¨å‘½ä»¤è¡Œã€‚å…¨éƒ¨ä¸ç¦»å¼€èŒƒå›´æµè§ˆå™¨çª—å£ã€‚</p><p><img src="https://img.xxlaila.cn/378246bsjfhsajkdq.png" alt="img"></p><h3 id="2ã€éƒ¨ç½²weave-scope"><a href="#2ã€éƒ¨ç½²weave-scope" class="headerlink" title="2ã€éƒ¨ç½²weave scope"></a>2ã€éƒ¨ç½²weave scope</h3><p>åˆæ¬¡å­¦ä¹ ï¼Œç›´æ¥ä¸‹è½½å®˜æ–¹é…ç½®æ–‡ä»¶ï¼Œæ²¡æœ‰ç»è¿‡ä»»ä½•ä¿®æ”¹ï¼Œä¸è¿‡ç›¸ä¿¡è‡ªå·±éšç€å­¦ä¹ çš„è¿›æ­¥ï¼Œä¼šé€æ¸æ·±å…¥ã€‚<a href="https://github.com/weaveworks/scope" target="_blank" rel="noopener">githubåœ°å€</a>ï¼Œ<a href="https://www.weave.works/docs/cloud/latest/overview/" target="_blank" rel="noopener">å®˜æ–¹åœ°å€</a></p><a id="more"></a><h4 id="2-1ã€ä¸‹è½½é…ç½®æ–‡ä»¶"><a href="#2-1ã€ä¸‹è½½é…ç½®æ–‡ä»¶" class="headerlink" title="2.1ã€ä¸‹è½½é…ç½®æ–‡ä»¶"></a>2.1ã€ä¸‹è½½é…ç½®æ–‡ä»¶</h4><p><a href="https://github.com/weaveworks/scope/tree/master/examples/k8s" target="_blank" rel="noopener">ä¸‹è½½é…ç½®æ–‡ä»¶</a>,é…ç½®æ–‡ä»¶å¦‚ä¸‹åˆ—è¡¨:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -l</span></span><br><span class="line">cluster-role-binding.yaml</span><br><span class="line">cluster-role.yaml</span><br><span class="line">deploy.yaml</span><br><span class="line">ds.yaml</span><br><span class="line">ns.yaml</span><br><span class="line">psp.yaml</span><br><span class="line">sa.yaml</span><br><span class="line">scope.yaml</span><br><span class="line">svc.yaml</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œåˆ›å»º<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f ./</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2ã€æŸ¥çœ‹éƒ¨ç½²"><a href="#2-2ã€æŸ¥çœ‹éƒ¨ç½²" class="headerlink" title="2.2ã€æŸ¥çœ‹éƒ¨ç½²"></a>2.2ã€æŸ¥çœ‹éƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc,pods -n weave</span></span><br><span class="line">NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/weave-scope-app   ClusterIP   10.99.252.207   &lt;none&gt;        80/TCP    25m</span><br><span class="line"></span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/weave-scope-agent-gpwmw            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-lmf22            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-r8vft            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-rph5p            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-agent-zfrnc            1/1     Running   0          24m</span><br><span class="line">pod/weave-scope-app-5c46dd7467-s8cp8   1/1     Running   0          24m</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/3489hdnsjkhd8324sd.png" alt="img"></p><h4 id="2-3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€"><a href="#2-3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€" class="headerlink" title="2.3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€"></a>2.3ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get services -n weave</span></span><br><span class="line">NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">weave-scope-app   ClusterIP   10.99.252.207   &lt;none&gt;        80/TCP    27m</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ°è¿™é‡Œweave-scopeéƒ¨ç½²å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œè®¿é—®ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¹‹å‰å­¦ä¹ çš„nginx Ingressæ¥å¯¹scopeé…ç½®ä¸€ä¸ªåŸŸåï¼Œç„¶åå§åŸŸåè§£æåˆ°åˆ¶å®šçš„ipåœ°å€ä¸Šè¿›è¡Œè®¿é—®</p><h3 id="3ã€é…ç½®scopeåŸŸå"><a href="#3ã€é…ç½®scopeåŸŸå" class="headerlink" title="3ã€é…ç½®scopeåŸŸå"></a>3ã€é…ç½®scopeåŸŸå</h3><p>æ–°å»ºç«‹ä¸€ä¸ªyamlæ–‡ä»¶ï¼Œå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat scope-ingress.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: scope-ingress</span><br><span class="line">  namespace: weave</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: scope.xxlaila.io</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">        - path: /</span><br><span class="line">          backend:</span><br><span class="line">            serviceName: weave-scope-app</span><br><span class="line">            servicePort: 80</span><br><span class="line"><span class="comment"># kubectl create -f scope-ingress.yaml</span></span><br></pre></td></tr></table></figure><blockquote><p>é€šè¿‡åŸŸåè®¿é—®ï¼š<a href="http://scope.xxlaila.io" target="_blank" rel="noopener">http://scope.xxlaila.io</a></p></blockquote><p><img src="https://img.xxlaila.cn/287346jskbdjy784kjs.png" alt="img"><br><img src="https://img.xxlaila.cn/3o4wndk9234sd.png" alt="img"><br><img src="https://img.xxlaila.cn/34873i24dfsd.png" alt="img"><br><img src="https://img.xxlaila.cn/458dskjfhu2y4skdsds.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Weave Scope</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²zookeeperé›†ç¾¤</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2zookeeper%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>zkå±äºæœ‰çŠ¶æ€æœåŠ¡ï¼Œéœ€è¦è¿æ¥å¤–éƒ¨å­˜å‚¨ï¼Œå§æ•°æ®å­˜æ”¾åœ¨æ•°æ®ç›˜é‡Œé¢ï¼Œå¦åˆ™å®¹å™¨æŒ‚äº†ï¼Œæ•°æ®æ²¡æœ‰äº†</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å‡†å¤‡zkçš„yamlæ–‡ä»¶</p><a id="more"></a><h3 id="1ã€é…ç½®zk-dataæ–‡ä»¶"><a href="#1ã€é…ç½®zk-dataæ–‡ä»¶" class="headerlink" title="1ã€é…ç½®zk-dataæ–‡ä»¶"></a>1ã€é…ç½®zk-dataæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat zk-data.yaml</span></span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk1</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">---</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk2</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">---</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-pv-zk3</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"anything"</span></span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/var/lib/zookeeper"</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line"><span class="comment"># cat zookeeper.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-hs</span><br><span class="line">  labels:</span><br><span class="line">    app: zk</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2888</span><br><span class="line">    name: server</span><br><span class="line">  - port: 3888</span><br><span class="line">    name: leader-election</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-cs</span><br><span class="line">  labels:</span><br><span class="line">    app: zk</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2181</span><br><span class="line">    name: client</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodDisruptionBudget</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-pdb</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  maxUnavailable: 1</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: zk</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  serviceName: zk-hs</span><br><span class="line">  replicas: 3</span><br><span class="line">  updateStrategy:</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdate</span><br><span class="line">  podManagementPolicy: Parallel</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: zk</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: <span class="string">"app"</span></span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                    - zk</span><br><span class="line">              topologyKey: <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-zookeeper</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        image: <span class="string">"xxlaila/kubernetes-zookeeper:1.0-3.4.10"</span></span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">"1Gi"</span></span><br><span class="line">            cpu: <span class="string">"0.5"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 2181</span><br><span class="line">          name: client</span><br><span class="line">        - containerPort: 2888</span><br><span class="line">          name: server</span><br><span class="line">        - containerPort: 3888</span><br><span class="line">          name: leader-election</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - <span class="string">"start-zookeeper \</span></span><br><span class="line"><span class="string">          --servers=3 \</span></span><br><span class="line"><span class="string">          --data_dir=/var/lib/zookeeper/data \</span></span><br><span class="line"><span class="string">          --data_log_dir=/var/lib/zookeeper/data/log \</span></span><br><span class="line"><span class="string">          --conf_dir=/opt/zookeeper/conf \</span></span><br><span class="line"><span class="string">          --client_port=2181 \</span></span><br><span class="line"><span class="string">          --election_port=3888 \</span></span><br><span class="line"><span class="string">          --server_port=2888 \</span></span><br><span class="line"><span class="string">          --tick_time=2000 \</span></span><br><span class="line"><span class="string">          --init_limit=10 \</span></span><br><span class="line"><span class="string">          --sync_limit=5 \</span></span><br><span class="line"><span class="string">          --heap=512M \</span></span><br><span class="line"><span class="string">          --max_client_cnxns=60 \</span></span><br><span class="line"><span class="string">          --snap_retain_count=3 \</span></span><br><span class="line"><span class="string">          --purge_interval=12 \</span></span><br><span class="line"><span class="string">          --max_session_timeout=40000 \</span></span><br><span class="line"><span class="string">          --min_session_timeout=4000 \</span></span><br><span class="line"><span class="string">          --log_level=INFO"</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">            - -c</span><br><span class="line">            - <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        livenessProbe:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">            - -c</span><br><span class="line">            - <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: datadir</span><br><span class="line">          mountPath: /var/lib/zookeeper</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 1000</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: datadir</span><br><span class="line">      annotations:</span><br><span class="line">        volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 3Gi</span><br></pre></td></tr></table></figure><h3 id="2ã€æ‰§è¡Œéƒ¨ç½²"><a href="#2ã€æ‰§è¡Œéƒ¨ç½²" class="headerlink" title="2ã€æ‰§è¡Œéƒ¨ç½²"></a>2ã€æ‰§è¡Œéƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f zookeeper.yaml -n kube-dev</span></span><br></pre></td></tr></table></figure><h3 id="3ã€æŸ¥çœ‹éƒ¨ç½²"><a href="#3ã€æŸ¥çœ‹éƒ¨ç½²" class="headerlink" title="3ã€æŸ¥çœ‹éƒ¨ç½²"></a>3ã€æŸ¥çœ‹éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide -n kube-dev</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">zk-0                            1/1     Running   0          6m13s   10.254.62.4   172.21.17.15    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">zk-1                            1/1     Running   0          6m12s   10.254.21.4   172.21.16.96    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">zk-2                            1/1     Running   0          6m12s   10.254.96.4   172.21.16.193   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜"><a href="#4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜" class="headerlink" title="4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜"></a>4ã€æŸ¥çœ‹æŒä¹…å·ç”³æ˜</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv -o wide -n kube-dev</span></span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                             STORAGECLASS          REASON   AGE</span><br><span class="line">pvc-d1cb6a1c-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-0             managed-nfs-storage            6m18s</span><br><span class="line">pvc-d20a95ec-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-1             managed-nfs-storage            6m18s</span><br><span class="line">pvc-d23577af-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            Delete           Bound    kube-dev/datadir-zk-2             managed-nfs-storage            6m23s</span><br></pre></td></tr></table></figure><h3 id="5ã€æŸ¥çœ‹pvc"><a href="#5ã€æŸ¥çœ‹pvc" class="headerlink" title="5ã€æŸ¥çœ‹pvc"></a>5ã€æŸ¥çœ‹pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pvc -o wide -n kube-dev</span></span><br><span class="line">NAME                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">datadir-zk-0             Bound    pvc-d1cb6a1c-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m38s</span><br><span class="line">datadir-zk-1             Bound    pvc-d20a95ec-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m37s</span><br><span class="line">datadir-zk-2             Bound    pvc-d23577af-407d-11e9-9436-fa163e14c5bd   3Gi        RWO            managed-nfs-storage   6m37s</span><br></pre></td></tr></table></figure><h3 id="6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸"><a href="#6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸" class="headerlink" title="6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸"></a>6ã€éªŒè¯é›†ç¾¤æ˜¯å¦å·¥ä½œæ­£å¸¸</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in 0 1 2; do kubectl exec zk-$i zkServer.sh status -n kube-dev; done</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><h3 id="7ã€é›†ç¾¤çš„è®¿é—®åœ°å€"><a href="#7ã€é›†ç¾¤çš„è®¿é—®åœ°å€" class="headerlink" title="7ã€é›†ç¾¤çš„è®¿é—®åœ°å€"></a>7ã€é›†ç¾¤çš„è®¿é—®åœ°å€</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server.1=zk-0.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br><span class="line">server.2=zk-1.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br><span class="line">server.3=zk-2.zk-hs.kube-dev.svc.cluster.local.:2888:3888</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²coredns</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2coredns/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;k8sé›†ç¾¤ä¸­çš„åº”ç”¨é€šå¸¸æ˜¯é€šè¿‡ingresså®ç°å¾®æœåŠ¡å‘å¸ƒçš„ï¼Œå‰æ–‡ä»‹ç»è¿‡åœ¨K8Sé›†ç¾¤ä¸­ä½¿ç”¨traefikå®ç°æœåŠ¡çš„è‡ªåŠ¨å‘å¸ƒï¼Œå…¶å®ç°æ–¹å¼æ˜¯traefiké€šè¿‡é›†ç¾¤çš„DNSæœåŠ¡æ¥è§£æserviceå¯¹åº”çš„é›†ç¾¤åœ°å€ï¼ˆclusteripï¼‰ï¼Œä»è€Œå°†ç”¨æˆ·çš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤åœ°å€ä¸Šã€‚å› æ­¤ï¼Œåœ¨éƒ¨ç½²å®Œé›†ç¾¤åçš„ç¬¬ä¸€ä»¶äº‹æƒ…åº”è¯¥æ˜¯é…ç½®DNSæœåŠ¡ï¼Œç›®å‰å¯é€‰çš„æ–¹æ¡ˆæœ‰skydns, kube-dns, corednsã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;kubednsæ˜¯Kubernetesä¸­çš„ä¸€ä¸ªå†…ç½®æ’ä»¶ï¼Œç›®å‰ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¼€æºé¡¹ç›®ç»´æŠ¤ï¼Œè§<a href="https://github.com/kubernetes/dnsã€‚è¯¥DNSæœåŠ¡å™¨åˆ©ç”¨SkyDNSçš„åº“æ¥ä¸ºKubernetes" target="_blank" rel="noopener">https://github.com/kubernetes/dnsã€‚è¯¥DNSæœåŠ¡å™¨åˆ©ç”¨SkyDNSçš„åº“æ¥ä¸ºKubernetes</a> podå’ŒæœåŠ¡æä¾›DNSè¯·æ±‚ã€‚CoreDNSé¡¹ç›®æ˜¯SkyDNS2çš„ä½œè€…ï¼ŒMiek Giebené‡‡ç”¨æ›´æ¨¡å—åŒ–ï¼Œå¯æ‰©å±•çš„æ¡†æ¶æ„å»º,å°†æ­¤DNSæœåŠ¡å™¨ä½œä¸ºKubeDNSçš„æ›¿ä»£å“ã€‚CoreDNSä½œä¸ºCNCFä¸­çš„æ‰˜ç®¡çš„ä¸€ä¸ªé¡¹ç›®ï¼Œåœ¨Kuberentes1.9ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨kubeadmæ–¹å¼å®‰è£…çš„é›†ç¾¤å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç›´æ¥å®‰è£…CoreDNSã€‚kubeadm init â€“feature-gates=CoreDNS=true</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å‡†å¤‡corednsçš„<a href="https://github.com/coredns/deployment.git" target="_blank" rel="noopener">yamlæ–‡ä»¶</a></p><a id="more"></a><p>é¦–å…ˆæˆ‘ä»¬çš„æŸ¥çœ‹<code>cat /etc/kubernetes/kubelet</code> dnsçš„ipåœ°å€æ˜¯å¤šå°‘ï¼Œè¿™é‡Œæˆ‘çš„æ˜¯<code>10.254.0.2</code>ï¼Œæ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œä¿®æ”¹</p><ul><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./deploy.sh -i 10.254.0.2 | kubectl apply -f -</span></span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure></li><li><p>æ“¦çœ‹corednsä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod,svc,deployment,rc -n kube-system|grep dns</span></span><br><span class="line">pod/coredns-799775f9b6-mgdc9                1/1     Running   0          12m</span><br><span class="line">pod/coredns-799775f9b6-v95lp                1/1     Running   0          12m</span><br><span class="line">service/kube-dns               ClusterIP   10.254.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   12m</span><br><span class="line"></span><br><span class="line">deployment.extensions/coredns                2/2     2            2           12m</span><br></pre></td></tr></table></figure></li></ul><h3 id="éƒ¨ç½²-DNS-è‡ªåŠ¨æ‰©å®¹"><a href="#éƒ¨ç½²-DNS-è‡ªåŠ¨æ‰©å®¹" class="headerlink" title="éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹"></a>éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å¤§è§„æ¨¡é›†ç¾¤çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦é›†ç¾¤ DNS è‡ªåŠ¨æ‰©å®¹ï¼Œå…·ä½“æ–‡æ¡£è¯·å‚è€ƒ DNS Horizontal Autoscalerï¼ŒDNS æ‰©å®¹ç®—æ³•å¯å‚è€ƒ Githubï¼Œå¦‚æœ‰éœ€è¦è¯·è‡ªè¡Œä¿®æ”¹ï¼›ä»¥ä¸‹ä¸ºå…·ä½“é…ç½®</p><ul><li><p>dns-horizontal-autoscaler.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kind: ServiceAccount</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns-autoscaler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"nodes"</span>]</span><br><span class="line">    verbs: [<span class="string">"list"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"replicationcontrollers/scale"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"deployments/scale"</span>, <span class="string">"replicasets/scale"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>]</span><br><span class="line"><span class="comment"># Remove the configmaps rule once below issue is fixed:</span></span><br><span class="line"><span class="comment"># kubernetes-incubator/cluster-proportional-autoscaler#16</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"configmaps"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>]</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kube-dns-autoscaler</span><br><span class="line">    namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-dns-autoscaler</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns-autoscaler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns-autoscaler</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns-autoscaler</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns-autoscaler</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: autoscaler</span><br><span class="line">        image: gcr.azk8s.cn/google_containers/cluster-proportional-autoscaler-amd64:1.1.2-r2</span><br><span class="line">        resources:</span><br><span class="line">            requests:</span><br><span class="line">                cpu: <span class="string">"20m"</span></span><br><span class="line">                memory: <span class="string">"10Mi"</span></span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">          - /cluster-proportional-autoscaler</span><br><span class="line">          - --namespace=kube-system</span><br><span class="line">          - --configmap=kube-dns-autoscaler</span><br><span class="line">          <span class="comment"># Should keep target in sync with cluster/addons/dns/kube-dns.yaml.base</span></span><br><span class="line">          - --target=Deployment/coredns</span><br><span class="line">          <span class="comment"># When cluster is using large nodes(with more cores), "coresPerReplica" should dominate.</span></span><br><span class="line">          <span class="comment"># If using small nodes, "nodesPerReplica" should dominate.</span></span><br><span class="line">          - --default-params=&#123;<span class="string">"linear"</span>:&#123;<span class="string">"coresPerReplica"</span>:256,<span class="string">"nodesPerReplica"</span>:16,<span class="string">"preventSinglePointFailure"</span>:<span class="literal">true</span>&#125;&#125;</span><br><span class="line">          - --logtostderr=<span class="literal">true</span></span><br><span class="line">          - --v=2</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line">        operator: <span class="string">"Exists"</span></span><br><span class="line">      serviceAccountName: kube-dns-autoscaler</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåˆ›å»º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f dns-horizontal-autoscaler.yaml </span></span><br><span class="line">serviceaccount/kube-dns-autoscaler created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:kube-dns-autoscaler created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:kube-dns-autoscaler created</span><br><span class="line">deployment.apps/kube-dns-autoscaler created</span><br></pre></td></tr></table></figure></li></ul><p>æ‰§è¡Œåˆ›å»ºä»¥åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°pod åˆ›å»ºäº†ä¸¤ä¸ªdns</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system|grep coredns</span></span><br><span class="line">coredns-68676b6b88-pw9c2                1/1     Running   0          7m18s</span><br><span class="line">coredns-68676b6b88-tgbbv                1/1     Running   0          100m</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²mysql</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2mysql/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;åç«¯å­˜å‚¨åˆ©ç”¨nfsæ¥è¿›è¡Œå­˜å‚¨æ•°æ®ï¼Œnfså®‰è£…ä¸é˜è¿°ï¼Œéœ€è¦æ³¨æ„æ³¨æ„çš„æ˜¯åœ¨åˆ›å»ºmysql çš„å…±äº«ç›®å½•çš„æ—¶å€™å‚æ•°è®¾å®š<code>/data/mysql *(rw,sync,no_root_squash,no_subtree_check)</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl  restart nfs.service</span><br><span class="line">$ sudo exportfs -arv</span><br></pre></td></tr></table></figure><h3 id="1ã€åˆ›å»ºmysqlå­˜å‚¨"><a href="#1ã€åˆ›å»ºmysqlå­˜å‚¨" class="headerlink" title="1ã€åˆ›å»ºmysqlå­˜å‚¨"></a>1ã€åˆ›å»ºmysqlå­˜å‚¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-pvc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc001</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  nfs:</span><br><span class="line">    server: 172.21.16.240</span><br><span class="line">    path: /data/mysql</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pvc</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 10Gi</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2ã€éƒ¨ç½²mysql"><a href="#2ã€éƒ¨ç½²mysql" class="headerlink" title="2ã€éƒ¨ç½²mysql"></a>2ã€éƒ¨ç½²mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-deploy.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-deploy</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: mysql-ops</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        name: mysql-ops</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: mysql</span><br><span class="line">          image: mysql:8.0.12</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          env:</span><br><span class="line">          - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">            value: <span class="string">"noc-mysql"</span></span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 3306</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: mysql-persistent-storage</span><br><span class="line">              mountPath: <span class="string">"/var/lib/mysql"</span></span><br><span class="line">      volumes:</span><br><span class="line">        - name: mysql-persistent-storage</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">            claimName: mysql-pvc</span><br></pre></td></tr></table></figure><h3 id="3ã€è®¾ç½®ç«¯å£æ˜ å°„"><a href="#3ã€è®¾ç½®ç«¯å£æ˜ å°„" class="headerlink" title="3ã€è®¾ç½®ç«¯å£æ˜ å°„"></a>3ã€è®¾ç½®ç«¯å£æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat mysql-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-svc</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  labels: </span><br><span class="line">    name: mysql-svc</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3306</span><br><span class="line">    name: http</span><br><span class="line">    nodePort: 30003</span><br><span class="line">  selector:</span><br><span class="line">    name: mysql-ops</span><br></pre></td></tr></table></figure><h3 id="4ã€æŸ¥çœ‹podéƒ¨ç½²"><a href="#4ã€æŸ¥çœ‹podéƒ¨ç½²" class="headerlink" title="4ã€æŸ¥çœ‹podéƒ¨ç½²"></a>4ã€æŸ¥çœ‹podéƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/8364iqhkdaskda.png" alt="img"></p><h3 id="5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹"><a href="#5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹" class="headerlink" title="5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹"></a>5ã€æŸ¥çœ‹mysqléƒ¨ç½²å“ªä¸ªnodeèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/42joud02jef24.png" alt="img"></p><h3 id="6ã€è¿›å…¥mysqlå®¹å™¨"><a href="#6ã€è¿›å…¥mysqlå®¹å™¨" class="headerlink" title="6ã€è¿›å…¥mysqlå®¹å™¨"></a>6ã€è¿›å…¥mysqlå®¹å™¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker ps -a</span><br><span class="line">$ sudo docker <span class="built_in">exec</span> -it ded7f2990db5 /bin/bash</span><br><span class="line">root@mysql-deploy-6dc5d9786b-lgkxk:/<span class="comment"># mysql -h127.0.0.1 -uroot -pnoc-mysql</span></span><br></pre></td></tr></table></figure><h4 id="6-1ã€è®¾ç½®mysql"><a href="#6-1ã€è®¾ç½®mysql" class="headerlink" title="6.1ã€è®¾ç½®mysql"></a>6.1ã€è®¾ç½®mysql</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter user <span class="string">'root'</span>@<span class="string">'%'</span> identified with mysql_native_password by<span class="string">'root'</span>;</span><br><span class="line">mysql&gt; alter  user <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'mysql'</span>;</span><br><span class="line">mysql&gt; alter  user <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'noc-mysql'</span>;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é€€å‡ºmysqlå’Œå®¹å™¨ï¼Œæ‰§è¡Œquit;é€€å‡ºmysqlï¼ŒæŒ‰ctrl+p+qä»å®¹å™¨ä¸­è¿”å›nodeä¸»æœºã€‚åˆ©ç”¨navicat é€šè¿‡nodeä¸»æœºçš„ipåœ°å€å’Œç«¯å£30003è¿æ¥mysqlæ•°æ®åº“<br><img src="https://img.xxlaila.cn/2348wndssmadklj3.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>k8sè§’è‰²è®¿é—®RBAC</title>
    <url>/2019/08/24/k8s%E8%A7%92%E8%89%B2%E8%AE%BF%E9%97%AERBAC/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="1ã€rbacä»‹ç»"><a href="#1ã€rbacä»‹ç»" class="headerlink" title="1ã€rbacä»‹ç»"></a>1ã€rbacä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesä¸­çš„ä¸¤ä¸ªç”¨äºé…ç½®ä¿¡æ¯çš„é‡è¦èµ„æºå¯¹è±¡ï¼šConfigMapå’ŒSecretï¼Œå…¶å®åˆ°è¿™é‡Œæˆ‘ä»¬åŸºæœ¬ä¸Šå­¦ä¹ çš„å†…å®¹å·²ç»è¦†ç›–åˆ°Kubernetesä¸­ä¸€äº›é‡è¦çš„èµ„æºå¯¹è±¡äº†ï¼Œæ¥éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åºæ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„äº†ã€‚åœ¨æˆ‘ä»¬æ¼”ç¤ºä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»™å¤§å®¶è®²è§£ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼šRBAC - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;RBACä½¿ç”¨rbac.authorization.k8s.io API Group æ¥å®ç°æˆæƒå†³ç­–ï¼Œå…è®¸ç®¡ç†å‘˜é€šè¿‡ Kubernetes API åŠ¨æ€é…ç½®ç­–ç•¥ï¼Œè¦å¯ç”¨RBACï¼Œéœ€è¦åœ¨ apiserver ä¸­æ·»åŠ å‚æ•°â€“authorization-mode=RBACï¼Œå¦‚æœä½¿ç”¨çš„kubeadmå®‰è£…çš„é›†ç¾¤ï¼Œ1.6 ç‰ˆæœ¬ä»¥ä¸Šçš„éƒ½é»˜è®¤å¼€å¯äº†RBACï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ Master èŠ‚ç‚¹ä¸Š apiserver çš„é™æ€Podå®šä¹‰æ–‡ä»¶ï¼š</p><h3 id="2ã€-kubernetes-å…³äºç©ºé—´æƒé™èµ‹äºˆ"><a href="#2ã€-kubernetes-å…³äºç©ºé—´æƒé™èµ‹äºˆ" class="headerlink" title="2ã€ kubernetes å…³äºç©ºé—´æƒé™èµ‹äºˆ"></a>2ã€ kubernetes å…³äºç©ºé—´æƒé™èµ‹äºˆ</h3><h4 id="1ã€è·å–å¹¶æŸ¥çœ‹"><a href="#1ã€è·å–å¹¶æŸ¥çœ‹" class="headerlink" title="1ã€è·å–å¹¶æŸ¥çœ‹"></a>1ã€è·å–å¹¶æŸ¥çœ‹</h4><ul><li>Role</li><li>ClusterRole</li><li>RoleBinding</li><li>ClusterRoleBinding</li></ul><a id="more"></a><ul><li><p>1.1ã€æŸ¥çœ‹kube-system namespaceä¸‹çš„æ‰€æœ‰role</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get role -n kube-system</span><br></pre></td></tr></table></figure></li><li><p>1.2ã€æŸ¥çœ‹æŸä¸ªroleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get role &lt;role-name&gt; -n kube-system -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.3ã€æŸ¥çœ‹kube-system namespaceä¸‹æ‰€æœ‰çš„rolebinding</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get rolebinding -n kube-system</span><br></pre></td></tr></table></figure></li><li><p>1.4ã€æŸ¥çœ‹kube-system namespaceä¸‹çš„æŸä¸ªrolebindingè¯¦ç»†ä¿¡æ¯ï¼ˆç»‘å®šçš„Roleå’Œsubjectï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get rolebinding &lt;rolebind-name&gt; -n kube-system -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.5ã€æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰çš„clusterrole</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole</span><br></pre></td></tr></table></figure></li><li><p>1.6ã€æŸ¥çœ‹æŸä¸ªclusterroleå®šä¹‰çš„èµ„æºæƒé™è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole &lt;clusterrole-name&gt; -o yaml</span><br></pre></td></tr></table></figure></li><li><p>1.7ã€æŸ¥çœ‹æ‰€æœ‰çš„clusterrolebinding</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrolebinding</span><br></pre></td></tr></table></figure></li><li><p>1.8ã€æŸ¥çœ‹æŸä¸€clusterrolebindingçš„è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrolebinding &lt;clusterrolebinding-name&gt; -o yaml</span><br></pre></td></tr></table></figure></li></ul><h4 id="2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚"><a href="#2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚" class="headerlink" title="2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚"></a>2ã€kubectlå‘½ä»¤å¯ä»¥ç”¨äºåœ¨å‘½åç©ºé—´å†…æˆ–è€…æ•´ä¸ªé›†ç¾¤å†…æˆäºˆè§’è‰²ã€‚</h4><ul><li><p>åœ¨æŸä¸€ç‰¹å®šåå­—ç©ºé—´å†…æˆäºˆRoleæˆ–è€…ClusterRoleã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding</span><br></pre></td></tr></table></figure></li><li><p>åœ¨åä¸ºâ€acmeâ€çš„åå­—ç©ºé—´ä¸­å°†admin ClusterRoleæˆäºˆç”¨æˆ·â€bobâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding bob-admin-binding --clusterrole=admin --user=bob --namespace=acme</span><br></pre></td></tr></table></figure></li><li><p>åœ¨åä¸ºâ€acmeâ€çš„åå­—ç©ºé—´ä¸­å°†view ClusterRoleæˆäºˆæœåŠ¡è´¦æˆ·â€myappâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding myapp-view-binding --clusterrole=view --serviceaccount=acme:myapp --namespace=acme</span><br><span class="line">kubectl create clusterrolebinding</span><br></pre></td></tr></table></figure></li></ul><h4 id="3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š"><a href="#3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š" class="headerlink" title="3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š"></a>3ã€åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æˆäºˆClusterRoleï¼ŒåŒ…æ‹¬æ‰€æœ‰åå­—ç©ºé—´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</h4><ul><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†cluster-admin ClusterRoleæˆäºˆç”¨æˆ·â€rootâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding root-cluster-admin-binding --clusterrole=cluster-admin --user=root</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†system:node ClusterRoleæˆäºˆç”¨æˆ·â€kubeletâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-node-binding --clusterrole=system:node --user=kubelet</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…å°†view ClusterRoleæˆäºˆåå­—ç©ºé—´â€acmeâ€å†…çš„æœåŠ¡è´¦æˆ·â€myappâ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding myapp-view-binding --clusterrole=view --serviceaccount=acme:myapp</span><br></pre></td></tr></table></figure></li></ul><h4 id="4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™"><a href="#4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™" class="headerlink" title="4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™"></a>4ã€å¯¹æŸä¸€ä¸ªnamespaceèµ‹äºˆjenkinséƒ¨ç½²æƒé™</h4><ul><li><p>æŸ¥çœ‹kube-ops ä¸‹é¢çš„è§’è‰²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role -n kube-ops</span></span><br><span class="line">NAME       AGE</span><br><span class="line">jenkins2   2d6h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹roleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role jenkins2 -n kube-ops -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2019-01-14T03:07:25Z"</span></span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  resourceVersion: <span class="string">"2389179"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/kube-ops/roles/jenkins2</span><br><span class="line">  uid: 84762132-17a9-11e9-8991-fa163e14c5bd</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">exec</span></span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">log</span></span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºjenkins2çš„æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test-3 ~]<span class="comment"># kubectl -n kube-system create sa jenkins2</span></span><br><span class="line">serviceaccount/jenkins2 created</span><br></pre></td></tr></table></figure></li><li><p>æˆæƒè®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test-3 ~]<span class="comment"># kubectl create clusterrolebinding jenkins2 --clusterrole cluster-admin --serviceaccount=kube-ops:jenkins2</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/jenkins2 created</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>RBAC</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s heapster</title>
    <url>/2019/08/24/k8s-heapster/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="1ã€heapster-ä»‹ç»"><a href="#1ã€heapster-ä»‹ç»" class="headerlink" title="1ã€heapster ä»‹ç»"></a>1ã€heapster ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Heapsteræ˜¯å®¹å™¨é›†ç¾¤ç›‘æ§å’Œæ€§èƒ½åˆ†æå·¥å…·,æ”¯æŒKuberneteså’ŒCoreOSã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetesæœ‰ä¸ªç›‘æ§agentâ€”cAdvisorã€‚åœ¨æ¯ä¸ªkubernetes Nodeä¸Šéƒ½ä¼šè¿è¡ŒcAdvisor,å®ƒä¼šæ”¶é›†æœ¬æœºä»¥åŠå®¹å™¨çš„ç›‘æ§æ•°æ®(cpu,memory,filesystem,network,uptime)ã€‚åœ¨è¾ƒæ–°çš„ç‰ˆæœ¬ä¸­ï¼ŒK8Så·²ç»å°†cAdvisoråŠŸèƒ½é›†æˆåˆ°kubeletç»„ä»¶ä¸­ã€‚æ¯ä¸ªNodeèŠ‚ç‚¹å¯ä»¥ç›´æ¥è¿›è¡Œwebè®¿é—®ã€‚</p><h3 id="2ã€heapster-å®‰è£…"><a href="#2ã€heapster-å®‰è£…" class="headerlink" title="2ã€heapster å®‰è£…"></a>2ã€heapster å®‰è£…</h3><p>ä¸‹è½½heapsterçš„<a href="https://github.com/kubernetes-retired/heapster/tree/master/deploy/kube-config" target="_blank" rel="noopener">yamlæ–‡ä»¶</a>ï¼Œä¸‹è½½å®Œæˆåæˆ‘ä»¬éœ€è¦å¯¹æ–‡ä»¶ä¿®æ”¹ï¼Œä»¥æ»¡è¶³æˆ‘ä»¬çš„çš„éœ€æ±‚.</p><h4 id="2-1ã€grafanaä¿®æ”¹"><a href="#2-1ã€grafanaä¿®æ”¹" class="headerlink" title="2.1ã€grafanaä¿®æ”¹"></a>2.1ã€grafanaä¿®æ”¹</h4><p>grafanaæ·»åŠ nodePort: 30003è®©grafanaæ”¯æŒå¤–éƒ¨è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç«¯å£è¿›è¡Œä½†å•ç‹¬çš„é¡µé¢é…ç½®ã€‚</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat grafana.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: k8s.gcr.io/heapster-grafana-amd64:v5.0.4</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/certs</span><br><span class="line">          name: ca-certificates</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">        - mountPath: /var</span><br><span class="line">          name: grafana-storage</span><br><span class="line">        env:</span><br><span class="line">        - name: INFLUXDB_HOST</span><br><span class="line">          value: monitoring-influxdb</span><br><span class="line">        - name: GF_SERVER_HTTP_PORT</span><br><span class="line">          value: <span class="string">"3000"</span></span><br><span class="line">          <span class="comment"># The following env variables are required to make Grafana accessible via</span></span><br><span class="line">          <span class="comment"># the kubernetes api-server proxy. On production clusters, we recommend</span></span><br><span class="line">          <span class="comment"># removing these env variables, setup auth for grafana, and expose the grafana</span></span><br><span class="line">          <span class="comment"># service using a LoadBalancer or a public IP.</span></span><br><span class="line">        - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">          value: <span class="string">"false"</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class="line">          value: Admin</span><br><span class="line">        - name: GF_SERVER_ROOT_URL</span><br><span class="line">          <span class="comment"># If you're only using the API Server proxy, set this value instead:</span></span><br><span class="line">          <span class="comment"># value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span></span><br><span class="line">          value: /</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ca-certificates</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/ssl/certs</span><br><span class="line">      - name: grafana-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></span><br><span class="line">    kubernetes.io/name: monitoring-grafana</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># In a production setup, we recommend accessing Grafana through an external Loadbalancer</span></span><br><span class="line">  <span class="comment"># or through a public IP.</span></span><br><span class="line">  <span class="comment"># type: LoadBalancer</span></span><br><span class="line">  <span class="comment"># You could also use NodePort to expose the service at a randomly-generated port</span></span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 3000</span><br><span class="line">    nodePort: 30003</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: grafana</span><br></pre></td></tr></table></figure><h4 id="2-2ã€heapsteræ–‡ä»¶ä¿®æ”¹"><a href="#2-2ã€heapsteræ–‡ä»¶ä¿®æ”¹" class="headerlink" title="2.2ã€heapsteræ–‡ä»¶ä¿®æ”¹"></a>2.2ã€heapsteræ–‡ä»¶ä¿®æ”¹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- --<span class="built_in">source</span>=kubernetes:https://kubernetes.default?useServiceAccount=<span class="literal">true</span>&amp;kubeletHttps=<span class="literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="literal">true</span></span><br><span class="line">è¿æ¥k8s apiçš„åœ°å€ï¼Œé»˜è®¤æ˜¯kubernetes.defaultï¼Œåé¢ä¸€æ®µåŠ å…¥ç”¨æˆ·è®¤è¯ï¼Œç«¯å£ï¼Œä»¥åŠhttps;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</span><br><span class="line">æŒ‡å®š influxdbæ•°æ®åº“çš„åœ°å€ï¼Œè¿™ä¸ªåœ¨infuxdbæ–‡ä»¶é‡Œé¢æœ‰è¿™ä¸ªåŸŸå</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat heapster.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: heapster</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: k8s.gcr.io/heapster-amd64:v1.5.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - /heapster</span><br><span class="line">        - --<span class="built_in">source</span>=kubernetes:https://kubernetes.default?useServiceAccount=<span class="literal">true</span>&amp;kubeletHttps=<span class="literal">true</span>&amp;kubeletPort=10250&amp;insecure=<span class="literal">true</span></span><br><span class="line">        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">'true'</span></span><br><span class="line">    kubernetes.io/name: Heapster</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: heapster</span><br></pre></td></tr></table></figure><h3 id="3ã€æ‰§è¡Œåˆ›å»ºheapster"><a href="#3ã€æ‰§è¡Œåˆ›å»ºheapster" class="headerlink" title="3ã€æ‰§è¡Œåˆ›å»ºheapster"></a>3ã€æ‰§è¡Œåˆ›å»ºheapster</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubect create -f ./</span></span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œåˆ›å»ºå®Œæˆåï¼Œç­‰å¾…ä¸€ä¼šæ˜¾ç¤ºå›¾åƒ<br><img src="https://img.xxlaila.cn/459348skndiy923s.png" alt="img"><br><img src="https://img.xxlaila.cn/34293knsdalsk0329.png" alt="img"></p><h4 id="3-1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸"><a href="#3-1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸" class="headerlink" title="3.1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸"></a>3.1ã€è®¿é—®grafanaæ˜¯å¦æ­£å¸¸</h4><p>å‰é¢åœ¨grafanaæ–‡ä»¶é‡Œé¢å¢åŠ äº†nodePoer: 30003çš„ç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»æ„èŠ‚ç‚¹ip:30003è¿›è¡Œè®¿é—®grafanaç•Œé¢ã€‚</p><p><img src="https://img.xxlaila.cn/453847sndkniuy234wds.png" alt="img"><br><strong>å¯ä»¥è¿›è¡Œé…ç½®grafanaã€‚</strong></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>heapster</tag>
      </tags>
  </entry>
  <entry>
    <title>k8séƒ¨ç½²eurekaé›†ç¾¤</title>
    <url>/2019/08/24/k8s%E9%83%A8%E7%BD%B2eureka%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><p>eureka ä¸é˜è¿°ä»‹ç»ï¼Œè¿™é‡Œç›´æ¥å¼€å§‹åœ¨kubernetesä¸‹éƒ¨ç½²eurekaé›†ç¾¤</p><h3 id="1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ "><a href="#1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ " class="headerlink" title="1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ "></a>1ã€é…ç½®æ–‡ä»¶çš„å¢åŠ </h3><p>eureka åªä¸€ä¸ªæœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œéƒ¨ç½²æœ‰çŠ¶æ€æœåŠ¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨StatefulSet</p><h4 id="1-1ã€å¢åŠ dockerfile"><a href="#1-1ã€å¢åŠ dockerfile" class="headerlink" title="1.1ã€å¢åŠ dockerfile"></a>1.1ã€å¢åŠ dockerfile</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat Dockerfile</span><br><span class="line">FROM docker.io/xxlaila/centos7.6-jdk1.8:latest</span><br><span class="line">MAINTAINER xxlaila <span class="string">"cq_xxlaila@163.com"</span></span><br><span class="line"><span class="comment"># Install dependent plugin</span></span><br><span class="line"></span><br><span class="line">ADD target/kxl-eureka.jar /opt/webapps/kxl-eureka.jar</span><br><span class="line">ADD application.yaml /opt/webapps/application.yaml</span><br><span class="line"></span><br><span class="line">WORKDIR /opt/webapps</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"-Dspring.profiles.active=dev"</span>, <span class="string">"kxl-eureka.jar"</span>]</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#1-2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="1.2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>1.2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><p>åœ¨åšeurekaé›†ç¾¤çš„æ—¶å€™ï¼Œapplication.yamlçš„é…ç½®æ–‡ä»¶å¾ˆé‡è¦ï¼Œé…ç½®æ–‡ä»¶åšä¸å¥½ï¼Œå°†ä¼šç›´æ¥å½±å“åˆ°eurekaçš„å¯åŠ¨ï¼Œè¿˜æœ‰é›†ç¾¤çš„æ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat application.yaml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: kxl-eureka</span><br><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line"><span class="comment">#    prefer-ip-address: true</span></span><br><span class="line">    hostname: <span class="variable">$&#123;EUREKA_HOST_NAME:peer1&#125;</span> <span class="comment">#æœåŠ¡ä¸»æœºå</span></span><br><span class="line">    appname: <span class="variable">$&#123;spring.application.name&#125;</span>  <span class="comment">#æœåŠ¡åç§°ï¼Œé»˜è®¤ä¸º unknow è¿™é‡Œç›´æ¥å– spring.application.name äº†</span></span><br><span class="line">    <span class="comment"># server ä»æœ€åä¸€æ¬¡æ”¶åˆ°å¿ƒè·³åˆ°ç§»é™¤åºŸå¼ƒæœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    lease-expiration-duration-in-seconds: 90</span><br><span class="line">    <span class="comment"># client ç»™ server å‘é€å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæ¯” lease-expiration-duration-in-seconds å°</span></span><br><span class="line">    lease-renewal-interval-in-seconds: 30</span><br><span class="line"></span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: <span class="variable">$&#123;EUREKA_URL_LIST:http://peer1:8761/eureka/&#125;</span> <span class="comment"># æŒ‡å®šæœåŠ¡ä¸­å¿ƒ eureka serverçš„åœ°å€</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦ä»eurekaä¸Šæ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    fetch-registry: <span class="variable">$&#123;BOOL_FETCH:true&#125;</span>   <span class="comment"># æ˜¯å¦æ‹‰å– eureka server çš„æ³¨å†Œä¿¡æ¯ã€‚ é»˜è®¤ä¸ºtrue</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦æ³¨å†Œåˆ°eurekaä¸Šï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    register-with-eureka: <span class="variable">$&#123;BOOL_REGISTER:true&#125;</span>  <span class="comment"># æ˜¯å¦æŠŠæœåŠ¡ä¸­å¿ƒæœ¬èº«å½“åšeureka client æ³¨å†Œã€‚é»˜è®¤ä¸ºtrue</span></span><br><span class="line">    <span class="comment"># client é—´éš”å¤šä¹…å»æ‹‰å»æœåŠ¡ä¿¡æ¯(ç§’)</span></span><br><span class="line">    registry-fetch-interval-seconds: 30</span><br><span class="line">  server:</span><br><span class="line">    <span class="comment"># è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåº”å¯¹ç½‘ç»œé—ªæ–­æƒ…å†µï¼Œå¤§é¢ç§¯ä¸¢å¤±è¿‡å¤šçš„clientï¼Œä¸åˆ é™¤æœåŠ¡</span></span><br><span class="line">    <span class="built_in">enable</span>-self-preservation: <span class="variable">$&#123;SELF_PRESERVATION:true&#125;</span>     <span class="comment"># æ˜¯å¦å¼€å¯è‡ªæˆ‘ä¿æŠ¤ã€‚ é»˜è®¤ä¸º true.</span></span><br><span class="line">    <span class="comment"># æ¯åˆ†é’Ÿå¿ƒè·³æ•° å®é™…/æœŸæœ›ï¼Œå¦‚æœå°äºé˜ˆå€¼(threshold)ï¼Œåˆ™è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</span></span><br><span class="line">    renewal-percent-threshold: 0.85</span><br><span class="line">    <span class="comment"># æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">    eviction-interval-timer-in-ms: 60000</span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: <span class="variable">$&#123;EUREKA_APPLICATION_NAME:eureka-server&#125;</span></span><br></pre></td></tr></table></figure><h4 id="1-3ã€åˆ›å»º-eureka-dockeré•œåƒ"><a href="#1-3ã€åˆ›å»º-eureka-dockeré•œåƒ" class="headerlink" title="1.3ã€åˆ›å»º eureka dockeré•œåƒ"></a>1.3ã€åˆ›å»º eureka dockeré•œåƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t xxlaila/kxl-eureka:v1 .</span><br><span class="line">$ docker push xxlaila/kxl-eureka:v1</span><br></pre></td></tr></table></figure><h3 id="2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤"><a href="#2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤" class="headerlink" title="2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤"></a>2ã€åœ¨k8såˆ›å»ºeurekaé›†ç¾¤</h3><h4 id="2-1ã€åˆ›å»ºeurekaé›†ç¾¤"><a href="#2-1ã€åˆ›å»ºeurekaé›†ç¾¤" class="headerlink" title="2.1ã€åˆ›å»ºeurekaé›†ç¾¤"></a>2.1ã€åˆ›å»ºeurekaé›†ç¾¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat kxl-eureka.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  labels:</span><br><span class="line">    app: eureka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8761</span><br><span class="line">    name: eureka</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"eureka"</span></span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: eureka</span><br><span class="line">        image:  docker.io/xxlaila/kxl-eureka:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8761</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">          <span class="comment"># Due to camelcase issues with "defaultZone" and "preferIpAddress", _JAVA_OPTIONS is used here</span></span><br><span class="line">        - name: eureka_client_serviceUrl_defaultZone</span><br><span class="line">          <span class="comment">#value: http://eureka-0.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/,http://eureka-1.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/</span></span><br><span class="line">          value: http://eureka-0.eureka:8761/eureka/,http://eureka-1.eureka:8761/eureka/,http://eureka-2.eureka:8761/eureka/</span><br><span class="line">        - name: EUREKA_CLIENT_REGISTERWITHEUREKA</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: EUREKA_CLIENT_FETCHREGISTRY</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">          <span class="comment"># In the docker image, this is set to localhost. Otherwise, we could leave this empty.</span></span><br><span class="line">          <span class="comment"># The hostnames must match with the the eureka serviceUrls, otherwise the replicas are reported as unavailable in the eureka dashboard</span></span><br><span class="line">        - name: EUREKA_INSTANCE_HOSTNAME</span><br><span class="line">          <span class="comment">#value: "$(MY_POD_NAME).eureka.&lt;namespace.svc.cluster.local"</span></span><br><span class="line">          value: <span class="string">"<span class="variable">$(MY_POD_NAME)</span>.eureka"</span></span><br><span class="line">          <span class="comment">#value: eureka</span></span><br><span class="line">          <span class="comment"># For the other (stateless) services, this should probably be set to true, since their pods have no DNS-resolvable  hostnames</span></span><br><span class="line">       <span class="comment">#- name: EUREKA_INSTANCE_PREFERIPADDRESS</span></span><br><span class="line">       <span class="comment">#  value: "false"</span></span><br><span class="line">  <span class="comment"># No need to start the pods in order. We just need the stable network identity</span></span><br><span class="line">  podManagementPolicy: <span class="string">"Parallel"</span></span><br></pre></td></tr></table></figure><p>åœ¨åšè¿™ä¸ªçš„æ—¶å€™å…¶å®é‡åˆ°äº†å¾ˆå¤šå‘ï¼Œä¹Ÿæ˜¯å‚è€ƒä¸€äº›æ–‡ç« æ‰å®Œæˆçš„,<a href="https://github.com/kingschan1204/blog/issues/5" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><h4 id="2-2ã€åˆ›å»ºeureka-Ingress"><a href="#2-2ã€åˆ›å»ºeureka-Ingress" class="headerlink" title="2.2ã€åˆ›å»ºeureka Ingress"></a>2.2ã€åˆ›å»ºeureka Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat eureka-ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka-ingress</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/secure-backends: <span class="string">"true"</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: eureka.xxlaila.io</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: eureka</span><br><span class="line">          servicePort: 8761</span><br></pre></td></tr></table></figure><h4 id="2-3ã€æ‰§è¡Œåˆ›å»º"><a href="#2-3ã€æ‰§è¡Œåˆ›å»º" class="headerlink" title="2.3ã€æ‰§è¡Œåˆ›å»º"></a>2.3ã€æ‰§è¡Œåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f .</span><br><span class="line">$ kubectl get pods -n kube-dev</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">eureka-0   1/1     Running   0          21m</span><br><span class="line">eureka-1   1/1     Running   0          21m</span><br><span class="line">eureka-2   1/1     Running   0          21m</span><br><span class="line">$ kubectl get pods,svc,rs -n kube-dev</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/eureka-0   1/1     Running   0          21m</span><br><span class="line">pod/eureka-1   1/1     Running   0          21m</span><br><span class="line">pod/eureka-2   1/1     Running   0          21m</span><br><span class="line"></span><br><span class="line">NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/eureka   ClusterIP   None         &lt;none&gt;        8761/TCP   21m</span><br></pre></td></tr></table></figure><h4 id="2-4ã€è®¿é—®éªŒè¯"><a href="#2-4ã€è®¿é—®éªŒè¯" class="headerlink" title="2.4ã€è®¿é—®éªŒè¯"></a>2.4ã€è®¿é—®éªŒè¯</h4><p><img src="https://img.xxlaila.cn/34239uskdnksjda.png" alt="img"><br>é€šè¿‡åŸŸåè®¿é—®ï¼š<br><img src="https://img.xxlaila.cn/89745jkndklsajkdhsajkbfa.png" alt="img"></p><h3 id="3ã€eureka-ç¯å¢ƒ"><a href="#3ã€eureka-ç¯å¢ƒ" class="headerlink" title="3ã€eureka ç¯å¢ƒ"></a>3ã€eureka ç¯å¢ƒ</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ ¹æ®2.4å°èŠ‚å¯ä»¥çœ‹åˆ°ï¼Œenviroonmentä¸ºtestï¼Œæˆ‘ä»¬åœ¨dockerfileæŒ‡å®šçš„ä¸ºdevï¼Œæ‰€ä»¥è¿™é‡Œå°±æœ‰ç‚¹å·®æ± ï¼Œä½†æ˜¯æŸ¥çœ‹äº†ä¸€ä¸‹èµ„æ–™ï¼Œè¿™ä¸ªè¦ä¹ˆå°±å†™å¤šä¸ªapplication.yamlçš„é…ç½®æ–‡ä»¶ï¼Œè¦ä¹ˆå°±æ‰“å¤šä¸ªåŒ…ï¼Œè¿™æ ·å°±æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”è€ƒè™‘åˆ°å…¬å¸å¾®æœåŠ¡çš„ç‰¹æ®Šæ€§ï¼Œæ—¢è¦æ»¡è¶³äºå…¬å¸çš„å¾®æœåŠ¡æ¶æ„ï¼Œæœ‰è¦è€ƒè™‘çš„æ¨¡ç‰ˆçš„é€šç”¨æ€§ï¼Œè¿˜éœ€è¦è€ƒè™‘è¿ç»´ç»´æŠ¤çš„ä¾¿æ·æ€§ã€‚ä¸‹é¢ä¸€èµ·æ¥çœ‹çœ‹åŸºäºå…¬å¸çš„å®šåˆ¶åŒ–æ¥æ”¹å˜è¿™ä¸ªå±€é™æ€§ã€‚</p><h4 id="3-1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡"><a href="#3-1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡" class="headerlink" title="3.1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡"></a>3.1ã€å…¬å¸çš„ç³»ç»Ÿç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CONFIG_API_SERVER=http://api.conf.xxlaila.io</span><br><span class="line">RUN_CLUSTER=default</span><br><span class="line">RUN_MODE=AUTO</span><br><span class="line">RUN_ENV=demo</span><br><span class="line">CONFIG_API_SERVERï¼šå…¬å¸é…ç½®ä¸­å¿ƒapiçš„åœ°å€ï¼Œappæ‹‰å–é…ç½®ä¸­å¿ƒçš„é…ç½®</span><br><span class="line">RUN_CLUSTERï¼šé»˜è®¤é›†ç¾¤ï¼Œåšç°åº¦å‘å¸ƒä½¿ç”¨</span><br><span class="line">RUN_MODEï¼š</span><br><span class="line">RUN_ENVï¼šå½“å‰ç³»ç»Ÿæ‰€è¿è¡Œçš„ç¯å¢ƒ</span><br></pre></td></tr></table></figure><h4 id="3-2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶"><a href="#3-2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶" class="headerlink" title="3.2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶"></a>3.2ã€ä¿®æ”¹eurekaçš„é…ç½®æ–‡ä»¶</h4><p>å¢åŠ é…ç½®eureka:<code>environment: ${RUN_ENV}</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat application.yaml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: kxl-eureka</span><br><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  environment: <span class="variable">$&#123;RUN_ENV&#125;</span></span><br><span class="line">  instance:</span><br><span class="line"><span class="comment">#    prefer-ip-address: true</span></span><br><span class="line">    hostname: <span class="variable">$&#123;EUREKA_HOST_NAME:peer1&#125;</span></span><br><span class="line">    appname: <span class="variable">$&#123;spring.application.name&#125;</span></span><br><span class="line">    <span class="comment"># server ä»æœ€åä¸€æ¬¡æ”¶åˆ°å¿ƒè·³åˆ°ç§»é™¤åºŸå¼ƒæœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    lease-expiration-duration-in-seconds: 90</span><br><span class="line">    <span class="comment"># client ç»™ server å‘é€å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæ¯” lease-expiration-duration-in-seconds å°</span></span><br><span class="line">    lease-renewal-interval-in-seconds: 30</span><br><span class="line"></span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: <span class="variable">$&#123;EUREKA_URL_LIST:http://peer1:8761/eureka/&#125;</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦ä»eurekaä¸Šæ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    fetch-registry: <span class="variable">$&#123;BOOL_FETCH:true&#125;</span></span><br><span class="line">    <span class="comment"># client æ˜¯å¦æ³¨å†Œåˆ°eurekaä¸Šï¼Œ serveræ¨¡å¼å¯å…³æ‰</span></span><br><span class="line">    register-with-eureka: <span class="variable">$&#123;BOOL_REGISTER:true&#125;</span></span><br><span class="line">    <span class="comment"># client é—´éš”å¤šä¹…å»æ‹‰å»æœåŠ¡ä¿¡æ¯(ç§’)</span></span><br><span class="line">    registry-fetch-interval-seconds: 30</span><br><span class="line">  server:</span><br><span class="line">    <span class="comment"># è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåº”å¯¹ç½‘ç»œé—ªæ–­æƒ…å†µï¼Œå¤§é¢ç§¯ä¸¢å¤±è¿‡å¤šçš„clientï¼Œä¸åˆ é™¤æœåŠ¡</span></span><br><span class="line">    <span class="built_in">enable</span>-self-preservation: <span class="variable">$&#123;SELF_PRESERVATION:true&#125;</span></span><br><span class="line">    <span class="comment"># æ¯åˆ†é’Ÿå¿ƒè·³æ•° å®é™…/æœŸæœ›ï¼Œå¦‚æœå°äºé˜ˆå€¼(threshold)ï¼Œåˆ™è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</span></span><br><span class="line">    renewal-percent-threshold: 0.85</span><br><span class="line">    <span class="comment"># æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">    eviction-interval-timer-in-ms: 60000</span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: <span class="variable">$&#123;EUREKA_APPLICATION_NAME:eureka-server&#125;</span></span><br></pre></td></tr></table></figure><h4 id="3-3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶"><a href="#3-3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶" class="headerlink" title="3.3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶"></a>3.3ã€ä¿®æ”¹eurekaéƒ¨ç½²æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat kxl-eureka.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">  labels:</span><br><span class="line">    app: eureka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8761</span><br><span class="line">    name: eureka</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  namespace: kube-dev</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"eureka"</span></span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: eureka</span><br><span class="line">        image:  docker.io/xxlaila/kxl-eureka:v2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8761</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">          <span class="comment"># Due to camelcase issues with "defaultZone" and "preferIpAddress", _JAVA_OPTIONS is used here</span></span><br><span class="line">        - name: eureka_client_serviceUrl_defaultZone</span><br><span class="line">          <span class="comment">#value: http://eureka-0.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/,http://eureka-1.eureka.&lt;namespace&gt;.svc.cluster.local:8761/eureka/</span></span><br><span class="line">          value: http://eureka-0.eureka:8761/eureka/,http://eureka-1.eureka:8761/eureka/,http://eureka-2.eureka:8761/eureka/</span><br><span class="line">        - name: EUREKA_CLIENT_REGISTERWITHEUREKA</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">        - name: EUREKA_CLIENT_FETCHREGISTRY</span><br><span class="line">          value: <span class="string">"true"</span></span><br><span class="line">          <span class="comment"># In the docker image, this is set to localhost. Otherwise, we could leave this empty.</span></span><br><span class="line">          <span class="comment"># The hostnames must match with the the eureka serviceUrls, otherwise the replicas are reported as unavailable in the eureka dashboard</span></span><br><span class="line">        - name: EUREKA_INSTANCE_HOSTNAME</span><br><span class="line">          <span class="comment">#value: "$(MY_POD_NAME).eureka.&lt;namespace.svc.cluster.local"</span></span><br><span class="line">          value: <span class="string">"<span class="variable">$(MY_POD_NAME)</span>.eureka"</span></span><br><span class="line">        - name: RUN_ENV</span><br><span class="line">          value: <span class="built_in">test</span></span><br><span class="line">        - name: CONFIG_API_SERVER</span><br><span class="line">          value: http://api.conf.xxlaila.io</span><br><span class="line">        - name: RUN_CLUSTER</span><br><span class="line">          value: default</span><br><span class="line">        - name: RUN_MODE</span><br><span class="line">          value: AUTO</span><br><span class="line">          <span class="comment">#value: eureka</span></span><br><span class="line">          <span class="comment"># For the other (stateless) services, this should probably be set to true, since their pods have no DNS-resolvable  hostnames</span></span><br><span class="line">       <span class="comment">#- name: EUREKA_INSTANCE_PREFERIPADDRESS</span></span><br><span class="line">       <span class="comment">#  value: "false"</span></span><br><span class="line">  <span class="comment"># No need to start the pods in order. We just need the stable network identity</span></span><br><span class="line">  podManagementPolicy: <span class="string">"Parallel"</span></span><br></pre></td></tr></table></figure><h4 id="3-4ã€é‡å»ºpod"><a href="#3-4ã€é‡å»ºpod" class="headerlink" title="3.4ã€é‡å»ºpod"></a>3.4ã€é‡å»ºpod</h4><p>podé‡å»ºä»¥åæˆ‘ä»¬ç»è¿‡è®¿é—®å¯ä»¥çœ‹åˆ°</p><p><img src="https://img.xxlaila.cn/453khskdha324.png" alt="img"><br><img src="https://img.xxlaila.cn/3746dfnks324.png" alt="img"></p><p><em>åç»­æŒç»­ä¼˜åŒ–</em></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>eureka</tag>
      </tags>
  </entry>
  <entry>
    <title>jiraæ¥å…¥LDAP</title>
    <url>/2019/08/24/jira%E6%8E%A5%E5%85%A5LDAP/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¹‹å‰ä»‹ç»äº†jira å’Œconfluenceçš„è´¦æˆ·ç»“åˆï¼Œjiraå’Œconfluenceå¯ä»¥ä½¿ç”¨ä¸€ä¸ªè´¦æˆ·ï¼Œæœ‰äººå‘˜ç¦»èŒä¹‹åç›´æ¥åœ¨jiraå§ç”¨æˆ·ç¦ç”¨å³å¯ï¼Œä¸€ç«¯æ“ä½œï¼Œæ–¹ä¾¿ä¸¤ç«¯ï¼Œä½†æ˜¯éšç€å…¬å¸äººå‘˜è¶Šæ¥è¶Šå¤šï¼Œè¿™æ ·çš„æ–¹å¼å·²ç»ä¸åœ¨é€‚åˆè¿™ç§äº†ï¼Œæ¥ä¸€ä¸ªç”¨æˆ·å°±éœ€è¦å»åˆ›å»ºï¼Œå¯¹è¿ç»´æ¥è¯´ï¼Œè¿™æ˜¯é‡å¤çš„å·¥ä½œï¼Œæå‡ä¸äº†ä»»ä½•æ•ˆç‡ï¼Œè€Œä¸”æ¯è‰æ— å‘³ã€‚è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ldapï¼Œjiraå’Œconfluenceéƒ½æ˜¯æ”¯æŒldapï¼Œldapçš„å¥½å¤„ï¼Œè¿™é‡Œä¸é˜è¿°ï¼Œä¸‹é¢æ¥çœ‹çœ‹å¦‚ä½•é…ç½®jiraä»‹å…¥ldapã€‚confluenceè¿˜æ˜¯æ¥å…¥jiraï¼Œè¿™æ ·æˆ‘ä»¬å°±åªæ“ä½œladpå’Œjiraï¼Œç®€å•çœäº‹ã€‚</p></blockquote><blockquote><p>é—®é¢˜ç‚¹:<br>&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºåœ¨å»ºç«‹jiraå’Œconfluenceçš„æ—¶å€™è¿˜æ²¡æœ‰ldapï¼Œldapæ˜¯åæœŸæ‰æ¥å…¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±å­˜åœ¨äºæ€ä¹ˆå§ä»¥å‰æœ‰jiraç™»å½•çš„è´¦æˆ·è®¤è¯åˆ‡æ¢åˆ°ldapã€‚è€Œä¸”ä¸å½±å“ä¹‹å‰çš„æ–‡æ¡£ï¼Œä½†æ˜¯ç”¨æˆ·æƒé™ä¼šå½±å“ï¼Œé—®é¢˜ä¸å¤§ï¼Œå¯ä»¥æ·»åŠ ã€‚ä¸‹é¢å¼€å§‹æ“ä½œ</p></blockquote><a id="more"></a><h3 id="1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢"><a href="#1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢" class="headerlink" title="1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢"></a>1ã€è¿›å…¥jiraç”¨æˆ·ç®¡ç†é¡µé¢</h3><p><img src="https://img.xxlaila.cn/image2018-7-12_11-12-55.png" alt="img"></p><h3 id="2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢"><a href="#2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢" class="headerlink" title="2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢"></a>2ã€é€‰æ‹©ldapï¼Œè¿›å…¥ldapé…ç½®é¡µé¢</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-32-32.png" alt="img"><br><img src="https://img.xxlaila.cn/image2019-6-12_15-32-48.png" alt="img"></p><h3 id="3ã€é«˜çº§è®¾ç½®"><a href="#3ã€é«˜çº§è®¾ç½®" class="headerlink" title="3ã€é«˜çº§è®¾ç½®"></a>3ã€é«˜çº§è®¾ç½®</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-17.png" alt="img"></p><h3 id="4ã€é…ç½®ç”¨æˆ·æ¨¡å¼"><a href="#4ã€é…ç½®ç”¨æˆ·æ¨¡å¼" class="headerlink" title="4ã€é…ç½®ç”¨æˆ·æ¨¡å¼"></a>4ã€é…ç½®ç”¨æˆ·æ¨¡å¼</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-35.png" alt="img"></p><h3 id="5ã€è®¾ç½®ç»„æ¨¡å¼"><a href="#5ã€è®¾ç½®ç»„æ¨¡å¼" class="headerlink" title="5ã€è®¾ç½®ç»„æ¨¡å¼"></a>5ã€è®¾ç½®ç»„æ¨¡å¼</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-33-55.png" alt="img"></p><h3 id="6ã€è®¾ç½®æˆå‘˜æ¨¡å¼"><a href="#6ã€è®¾ç½®æˆå‘˜æ¨¡å¼" class="headerlink" title="6ã€è®¾ç½®æˆå‘˜æ¨¡å¼"></a>6ã€è®¾ç½®æˆå‘˜æ¨¡å¼</h3><p>è¿™é‡Œldapä¸€å®šè¦å­˜åœ¨ä¸ladpçš„groupé‡Œé¢<br><img src="https://img.xxlaila.cn/image2019-6-12_15-34-23.png" alt="img"></p><h3 id="7ã€æµ‹è¯•å¹¶ä¿å­˜"><a href="#7ã€æµ‹è¯•å¹¶ä¿å­˜" class="headerlink" title="7ã€æµ‹è¯•å¹¶ä¿å­˜"></a>7ã€æµ‹è¯•å¹¶ä¿å­˜</h3><p>è¿™é‡Œæµ‹è¯•è´¦æˆ·ä¸€å®šæ˜¯ladpçš„è´¦æˆ·<br><img src="https://img.xxlaila.cn/image2019-6-12_15-34-58.png" alt="img"></p><h3 id="8ã€åŒæ­¥è´¦æˆ·"><a href="#8ã€åŒæ­¥è´¦æˆ·" class="headerlink" title="8ã€åŒæ­¥è´¦æˆ·"></a>8ã€åŒæ­¥è´¦æˆ·</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-35-50.png" alt="img"></p><h3 id="9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•"><a href="#9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•" class="headerlink" title="9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•"></a>9ã€ç”¨ladpè´¦æˆ·ç™»å½•æµ‹è¯•</h3><p><img src="https://img.xxlaila.cn/image2019-6-12_15-36-53.png" alt="img"></p><h2 id="jiraè´¦æˆ·åˆ‡æ¢è‡³ldap"><a href="#jiraè´¦æˆ·åˆ‡æ¢è‡³ldap" class="headerlink" title="jiraè´¦æˆ·åˆ‡æ¢è‡³ldap"></a>jiraè´¦æˆ·åˆ‡æ¢è‡³ldap</h2><blockquote><p>jiraé…ç½®ldapä»¥åé»˜è®¤æ˜¯æœ¬åœ°è´¦æˆ·å’Œldapæ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œç”¨æˆ·å¯ä»¥ç”¨ä»¥å‰çš„æœ¬åœ°è´¦æˆ·å’Œldapéƒ½ç™»å½•ï¼Œè¿™é‡Œå®ç°ldapç™»å½•ï¼Œç¦æ­¢æœ¬åœ°ç™»å½•ã€‚</p></blockquote><h3 id="å‰ç½®æ¡ä»¶"><a href="#å‰ç½®æ¡ä»¶" class="headerlink" title="å‰ç½®æ¡ä»¶"></a>å‰ç½®æ¡ä»¶</h3><ul><li>jiraçš„æœ¬åœ°è´¦æˆ·å’Œldapçš„è´¦æˆ·åç§°å¿…é¡»ä¸€æ ·</li><li>æ“ä½œå‰è¯·å¤‡ä»½æ•°æ®åº“</li><li>ç”¨æˆ·é‚®ç®±ä¿æŒä¸€è‡´</li><li>å¯†ç æ— æ‰€è°“ï¼Œä¸éœ€è¦ç»Ÿä¸€</li></ul><h3 id="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”"><a href="#æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”" class="headerlink" title="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”"></a>æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯å…³è”</h3><p>ç™»å½•jiraçš„æ•°æ®åº“ã€‚ç„¶åæ‰¾åˆ°cwd_userè¡¨</p><h4 id="cwd-userè¡¨"><a href="#cwd-userè¡¨" class="headerlink" title="cwd_userè¡¨"></a>cwd_userè¡¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;jiraçš„å‰å°ä¸èƒ½ç›´æ¥å»æ›´æ”¹ï¼Œåªæœ‰æ›´æ”¹æ•°æ®åº“ï¼Œè¿›å…¥æ•°æ®åº“ï¼Œæ‰¾åˆ°ä¸€å¼ cwd_userçš„è¡¨ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰ç”¨æˆ·çš„ç™»å½•è´¦å·ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå­—æ®µdirectory_idçš„ï¼Œè¿™ä¸ªå­—æ®µæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ¬åœ°è´¦æˆ·çš„idæ˜¯1ï¼ŒldapåŒæ­¥è¿‡æ¥çš„è´¦æˆ·æ˜¯10001ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://img.xxlaila.cn/1566617986314.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ç»§ç»­çœ‹è¯¥è¡¨çš„credentialå­—æ®µï¼Œå¯†ç ä¹Ÿæœ‰åŒºåˆ«,æœ¬åœ°è´¦æˆ·æ˜¯æœ‰ä¸€ä¸²åŠ å¯†åçš„å­—ç¬¦ä¸²ï¼Œldapè®¤è¯çš„æ˜¯nopassï¼ŒåŒ…æ‹¬åé¢çš„external_id ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img.xxlaila.cn/1566618124910.jpg" alt="img"></p><h4 id="cwd-directoryè¡¨"><a href="#cwd-directoryè¡¨" class="headerlink" title="cwd_directoryè¡¨"></a>cwd_directoryè¡¨</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰“å¼€cwd_directoryè¡¨ï¼Œé‡Œé¢æœ‰ä¸¤æ¡æ•°æ®ï¼Œä¸€ä¸ªå¯¹åº”çš„æ˜¯ldapï¼Œä¸€ä¸ªå¯¹åº”çš„æœ¬åœ°ï¼Œå’Œcwd_useræ˜¯å¯¹åº”çš„ï¼Œå¦‚å›¾ï¼š<br><img src="https://img.xxlaila.cn/image2019-6-13_10-0-47.png" alt="img"></p><h4 id="ä¿®æ”¹æ•°æ®åº“"><a href="#ä¿®æ”¹æ•°æ®åº“" class="headerlink" title="ä¿®æ”¹æ•°æ®åº“"></a>ä¿®æ”¹æ•°æ®åº“</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;è®°ä½ldapç›®å½•çš„idï¼Œç„¶ååœ¨cwd_userè¡¨é‡Œé¢åˆ é™¤ldapçš„ç›¸åŒè´¦æˆ·çš„æ•´æ¡è®°å½•ï¼Œå› ä¸ºè¦ä¼ªè£…åŸæœ¬ç³»ç»Ÿè‡ªå¸¦çš„ç›®å½•æœåŠ¡å™¨ï¼ŒåŸæ¥ç¼–è¾‘çš„æ–‡ä»¶å’Œå†…å®¹ä¸ºåŸå…ˆè¿™ä¸ªç”¨æˆ·çš„idã€‚ä¿®æ”¹directory_id ä¸ºldapçš„idï¼Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦ä¿®æ”¹çš„åœ°æ–¹ä¸ºCREDENTIALçš„å­—æ®µï¼ŒæŠŠå®ƒä¿®æ”¹ä¸ºnopassã€‚ä¿®æ”¹å®Œæˆåéœ€è¦é‡å¯jiraï¼Œä¸é‡å¯ä¸ä¼šç”Ÿæ•ˆï¼Œè€Œä¸”ç™»å½•æœåŠ¡å™¨è¿˜ä¼šæŠ¥é”™ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œjiraå’Œconfluenceæ˜¯åšäº†å…³è”çš„ï¼Œjiraä¿®æ”¹ä»¥åï¼Œconfluenceä¹Ÿå¯ä»¥è¿›è¡Œç™»å½•ï¼Œæ— éœ€åœ¨confluenceåœ¨è®¾ç½®ä¸€æ¬¡ldap;ä¿®æ”¹å®Œæˆåï¼Œä»¥å‰ç”¨æˆ·çš„ç®¡ç†å‘˜æƒé™æœ‰é—®é¢˜ï¼Œé‡æ–°æ·»åŠ ä¸€æ¬¡å³å¯ã€‚ä¸ä¼šå½±å“å…¶ä»–çš„ã€‚è®¾ç½®æ–‡æ¡£ï¼Œldapæƒé™è¦é€‰æ‹©ä¸ºåªè¯»ï¼Œä¸”ä¸ºæœ¬åœ°ç»„ã€‚ç„¶åå§jiaå’Œconfluenceçš„æ™®é€šç»„æ·»åŠ è¿›å»ï¼Œå¦åˆ™ç”¨æˆ·è¿›æ¥æ²¡æœ‰æƒé™</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jira</category>
      </categories>
      <tags>
        <tag>ldap</tag>
      </tags>
  </entry>
  <entry>
    <title>confluenceä¸jiraè´¦æˆ·æ‰“é€š</title>
    <url>/2019/08/24/confluence%E4%B8%8Ejira%E8%B4%A6%E6%88%B7%E6%89%93%E9%80%9A/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p><a href="http://xxlaila.github.io/2019/08/24/confluence-install/" target="_blank" rel="noopener">confluence</a>å®‰è£…</p><h3 id="ç™»å½•confluence"><a href="#ç™»å½•confluence" class="headerlink" title="ç™»å½•confluence"></a>ç™»å½•confluence</h3><p>ç‚¹å‡»ç”¨æˆ·ç®¡ç†</p><a id="more"></a><p><img src="https://img.xxlaila.cn/1566615435701.jpg" alt="img"></p><ul><li>ç‚¹å‡»ç”¨æˆ·ç›®å½•<br><img src="https://img.xxlaila.cn/1566615500778.jpg" alt="img"></li></ul><h3 id="å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥"><a href="#å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥" class="headerlink" title="å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥"></a>å¼€å§‹é…ç½®å’Œjiraçš„è¿æ¥</h3><ul><li>ç‚¹å‡»æ·»åŠ ç›®å½•</li></ul><p><img src="https://img.xxlaila.cn/1566615580951.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566616502650.jpg" alt="img"><br><img src="https://img.xxlaila.cn/1566616536151.jpg" alt="img"></p><p>ç‚¹å‡»æµ‹è¯•è¿æ¥ï¼Œè¿æ¥æˆåŠŸä»¥åï¼Œç‚¹å‡»æµ‹è¯•ä¿å­˜ã€‚å›åˆ°ç•Œé¢å¯ä»¥ç‚¹å‡»åŒæ­¥<br><img src="https://img.xxlaila.cn/1566616609967.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>confluence</category>
      </categories>
      <tags>
        <tag>confluence,jira</tag>
      </tags>
  </entry>
  <entry>
    <title>jiraå®‰è£…å’Œé…ç½®</title>
    <url>/2019/08/24/jira%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;JIRAæ˜¯Atlassianå…¬å¸å‡ºå“çš„é¡¹ç›®ä¸äº‹åŠ¡è·Ÿè¸ªå·¥å…·ï¼Œè¢«å¹¿æ³›åº”ç”¨äºç¼ºé™·è·Ÿè¸ªã€å®¢æˆ·æœåŠ¡ã€éœ€æ±‚æ”¶é›†ã€æµç¨‹å®¡æ‰¹ã€ä»»åŠ¡è·Ÿè¸ªã€é¡¹ç›®è·Ÿè¸ªå’Œæ•æ·ç®¡ç†ç­‰å·¥ä½œé¢†åŸŸã€‚</p><ul><li>ç¯å¢ƒå‡†å¤‡</li></ul><table><thead><tr><th>åº”ç”¨</th><th>æœåŠ¡å™¨é…ç½®</th><th>æ“ä½œç³»ç»Ÿ</th><th>æ’ä»¶</th></tr></thead><tbody><tr><td>mysql 5.6 +</td><td>2/4G/50G</td><td>centos 7.4</td><td></td></tr><tr><td>jira</td><td>4/8G/200G</td><td>centos 7.4</td><td>jdk1.8</td></tr></tbody></table><a id="more"></a><h3 id="å®‰è£…JIRA"><a href="#å®‰è£…JIRA" class="headerlink" title="å®‰è£…JIRA"></a>å®‰è£…JIRA</h3><ul><li>æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./atlassian-jira-software-7.2.2-x64.bin</span></span><br></pre></td></tr></table></figure></li></ul><p><img src="https://img.xxlaila.cn/1524710136913-900.png" alt="img"></p><ul><li><p>å®‰è£…å®Œæˆååœæ­¢JIRA</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒ/etc/init.d/jira stop</span><br></pre></td></tr></table></figure></li><li><p>å¤åˆ¶ç ´è§£åŒ…å’Œæ•°æ®åº“é©±åŠ¨è¿æ¥å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒcp mysql-connector-java-5.1.39-bin.jar atlassian-extras-3.1.2.jar /opt/atlassian/jira/atlassian-jira/WEB-INF/lib/</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨JIRA</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ï¼ƒ/etc/init.d/jira start</span><br></pre></td></tr></table></figure></li></ul><p>ç™»é™†ç½‘é¡µæ§åˆ¶å°è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œç•¥è¿‡ï¼Œè¿™é‡Œè¿™æ˜¯å®Œæˆï¼Œæ— æ³•æˆªå›¾(åæœŸæœ‰æœºä¼šå®‰è£…æˆªå›¾è¡¥ä¸Š)ï¼Œè®¾ç½®ä»¥åçš„æˆªå›¾<br><img src="https://img.xxlaila.cn/1524710090658-810.png" alt="img"></p><h3 id="é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨"><a href="#é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨" class="headerlink" title="é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨"></a>é…ç½®JIRAçš„é‚®ä»¶æœåŠ¡å™¨</h3><p><img src="https://img.xxlaila.cn/1524710057086-739.png" alt="img"><br><img src="https://img.xxlaila.cn/1524710038583-516.png" alt="img"></p><p>é…ç½®å®Œæˆåç‚¹å‡»æœ€ä¸‹é¢çš„æµ‹è¯•è¿æ¥</p><p><img src="https://img.xxlaila.cn/1524710027432-202.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jira</category>
      </categories>
      <tags>
        <tag>jira</tag>
      </tags>
  </entry>
  <entry>
    <title>gitæ¸…ç©ºcommitè®°å½•æ–¹æ³•</title>
    <url>/2019/08/24/git%E6%B8%85%E7%A9%BAcommit%E8%AE%B0%E5%BD%95%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><blockquote><p>è¯´æ˜:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¾‹å¦‚å°†ä»£ç æäº¤åˆ°gitä»“åº“ï¼Œå°†ä¸€äº›æ•æ„Ÿä¿¡æ¯æäº¤ï¼Œæ‰€ä»¥éœ€è¦åˆ é™¤æäº¤è®°å½•ä»¥å½»åº•æ¸…é™¤æäº¤ä¿¡æ¯ï¼Œä»¥å¾—åˆ°ä¸€ä¸ªå¹²å‡€çš„ä»“åº“ä¸”ä»£ç ä¸å˜</p></blockquote><h3 id="1-Checkout"><a href="#1-Checkout" class="headerlink" title="1.Checkout"></a>1.Checkout</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git checkout --orphan latest_branch</span><br></pre></td></tr></table></figure><h3 id="2-Add-all-the-files"><a href="#2-Add-all-the-files" class="headerlink" title="2. Add all the files"></a>2. Add all the files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add -A</span><br></pre></td></tr></table></figure><h3 id="3-Commit-the-changes"><a href="#3-Commit-the-changes" class="headerlink" title="3. Commit the changes"></a>3. Commit the changes</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git commit -am <span class="string">"commit message"</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="4-Delete-the-branch"><a href="#4-Delete-the-branch" class="headerlink" title="4. Delete the branch"></a>4. Delete the branch</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch -D master</span><br></pre></td></tr></table></figure><h3 id="5-Rename-the-current-branch-to-master"><a href="#5-Rename-the-current-branch-to-master" class="headerlink" title="5.Rename the current branch to master"></a>5.Rename the current branch to master</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git branch -m master</span><br></pre></td></tr></table></figure><h3 id="6-Finally-force-update-your-repository"><a href="#6-Finally-force-update-your-repository" class="headerlink" title="6.Finally, force update your repository"></a>6.Finally, force update your repository</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git push -f origin master</span><br></pre></td></tr></table></figure><h2 id="git-ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥"><a href="#git-ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥" class="headerlink" title="git ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥"></a>git ä¸»å¹²å’Œåˆ†æ”¯åŒæ­¥</h2><h3 id="1ã€è¿œç¨‹åˆ†æ”¯"><a href="#1ã€è¿œç¨‹åˆ†æ”¯" class="headerlink" title="1ã€è¿œç¨‹åˆ†æ”¯"></a>1ã€è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹å½“å‰çš„è¿œç¨‹åˆ†æ”¯</span><br><span class="line">$ git remote -v</span><br></pre></td></tr></table></figure><h3 id="2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯"><a href="#2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯" class="headerlink" title="2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯"></a>2ã€å¢åŠ è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git remote add latest https://github.com/xxlaila/work.git</span><br></pre></td></tr></table></figure><h3 id="3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯"><a href="#3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯" class="headerlink" title="3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯"></a>3ã€æ›´æ–°ä¸»åº“çš„è¿œç¨‹åˆ†æ”¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ›´æ–°è¿œç¨‹åˆ†æ”¯</span><br><span class="line">$ git fetch latest</span><br></pre></td></tr></table></figure><h3 id="4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç "><a href="#4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç " class="headerlink" title="4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç "></a>4ã€åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç </h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">åˆå¹¶ä¸»åº“çš„æœ€æ–°ä»£ç </span><br><span class="line">$ git rebase latest/dev</span><br></pre></td></tr></table></figure><h3 id="5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“"><a href="#5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“" class="headerlink" title="5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“"></a>5ã€æ¨é€æœ¬åœ°ä»£ç åˆ°è‡ªèº«è¿œç¨‹ä»“åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ¨é€è¿œç¨‹ä»“åº“</span><br><span class="line">$ git push</span><br></pre></td></tr></table></figure><h2 id="git-ä»£ç ä¿¡æ¯ç»Ÿè®¡"><a href="#git-ä»£ç ä¿¡æ¯ç»Ÿè®¡" class="headerlink" title="git ä»£ç ä¿¡æ¯ç»Ÿè®¡"></a>git ä»£ç ä¿¡æ¯ç»Ÿè®¡</h2><blockquote><p>è¯´æ˜: å…¬å¸æ¯ä¸ªå­£åº¦éƒ½è¦å¯¹å…¬å¸å¼€å‘äººå‘˜çš„å·¥ä½œé‡è¿›è¡Œæ•´ä½“è¯„ä¼°ï¼Œè¯„ä¼°gitä¸Šæ‰€æœ‰ä»£ç åº“çš„commitæ•°é‡å’Œä¿®æ”¹æ–‡ä»¶çš„æ€»è¡Œæ•°</p></blockquote><h3 id="ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡"><a href="#ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡" class="headerlink" title="ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡"></a>ç»Ÿè®¡æ—¶é—´åŒºé—´commitæ•°é‡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline --since==2019-04-1 --until=2019-06-30 | wc -l</span><br></pre></td></tr></table></figure><h3 id="ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°"><a href="#ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°" class="headerlink" title="ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°"></a>ç»Ÿè®¡æ·»åŠ ä¿®æ”¹çš„ä»£ç è¡Œæ•°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">log</span> --<span class="built_in">stat</span> --since=<span class="string">"2019-4-01"</span> --before=<span class="string">"2019-06-30"</span> |perl -ne <span class="string">'END &#123; print $c &#125; $c += $1 if /(\d+) insertions/'</span></span><br></pre></td></tr></table></figure><h2 id="git-stashä½¿ç”¨"><a href="#git-stashä½¿ç”¨" class="headerlink" title="git stashä½¿ç”¨"></a>git stashä½¿ç”¨</h2><blockquote><p>åœºæ™¯:<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»Šå¤©é‡åˆ°ä¸€ä¸ªç‰¹æ®Šçš„åœºæ™¯ï¼Œå†™çš„ä¸€ä¸ªpythonç¨‹åºåˆ°æœåŠ¡å™¨ä¸Šæœ‰ä¸€ä¸ªå°bugè¿è¡ŒæŠ¥é”™ï¼Œç„¶åå°±ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šè°ƒè¯•ï¼Œä¿®æ”¹äº†ç¨‹åºï¼Œç¨‹åºæ­£å¸¸è·‘èµ·ï¼Œç„¶è€Œæœ¬åœ°ä¹Ÿè¦ä¿®æ”¹ï¼Œä¿®æ”¹çš„æ—¶å€™åŒæ—¶ä¿®æ”¹äº†å…¶ä»–çš„åœ°æ–¹ï¼Œç„¶åæäº¤äº†gitä¸Šï¼Œè¿™æ—¶ï¼Œéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šæ›´æ–°æœ€æ–°çš„ä»£ç ï¼Œä½†æ˜¯æœåŠ¡å™¨ä¸Šçš„ä»£ç å’Œgitä¸Šçš„ä¸ä¸€è‡´ï¼Œè¿™å°±ä¼šå¯¼è‡´é”™è¯¯ï¼Œè¿™æ—¶gitçš„å¼ºå¤§ä¹‹å¤„å°±ä½“ç°å‡ºæ¥äº†ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git status</span><br><span class="line">èƒ½å¤Ÿå°†æ‰€æœ‰æœªæäº¤çš„ä¿®æ”¹ï¼ˆå·¥ä½œåŒºå’Œæš‚å­˜åŒºï¼‰ä¿å­˜è‡³å †æ ˆä¸­ï¼Œç”¨äºåç»­æ¢å¤å½“å‰å·¥ä½œç›®å½•ã€‚</span><br></pre></td></tr></table></figure><ul><li>æ›´æ–°ä»£ç <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git pull</span><br></pre></td></tr></table></figure></li></ul><p>å°†å½“å‰stashä¸­çš„å†…å®¹å¼¹å‡ºï¼Œå¹¶åº”ç”¨åˆ°å½“å‰åˆ†æ”¯å¯¹åº”çš„å·¥ä½œç›®å½•ä¸Šã€‚</p><blockquote><p>æ³¨:<br>&nbsp;&nbsp;&nbsp;&nbsp;è¯¥å‘½ä»¤å°†å †æ ˆä¸­æœ€è¿‘ä¿å­˜çš„å†…å®¹åˆ é™¤ï¼ˆæ ˆæ˜¯å…ˆè¿›åå‡ºï¼‰</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git stash pop</span><br></pre></td></tr></table></figure><p>æ›´å¤šçš„git stash å‘½ä»¤è¯¦è§£è¯·<a href="https://git-scm.com/book/zh/v1/Git-%E5%B7%A5%E5%85%B7-%E5%82%A8%E8%97%8F%EF%BC%88Stashing%EF%BC%89" target="_blank" rel="noopener">ç‚¹å‡»</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>confluence_install</title>
    <url>/2019/08/24/confluence-install/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Confluenceæ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼ä¸šçŸ¥è¯†ç®¡ç†ä¸ååŒè½¯ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨äºæ„å»ºä¼ä¸šwikiã€‚ä½¿ç”¨ç®€å•ï¼Œä½†å®ƒå¼ºå¤§çš„ç¼–è¾‘å’Œç«™ç‚¹ç®¡ç†ç‰¹å¾èƒ½å¤Ÿå¸®åŠ©å›¢é˜Ÿæˆå‘˜ä¹‹é—´å…±äº«ä¿¡æ¯ã€æ–‡æ¡£åä½œã€é›†ä½“è®¨è®ºï¼Œä¿¡æ¯æ¨é€ã€‚ä¸ºå›¢é˜Ÿæä¾›ä¸€ä¸ªåä½œç¯å¢ƒã€‚åœ¨è¿™é‡Œï¼Œå›¢é˜Ÿæˆå‘˜é½å¿ƒååŠ›ï¼Œå„æ“…å…¶èƒ½ï¼ŒååŒåœ°ç¼–å†™æ–‡æ¡£å’Œç®¡ç†é¡¹ç›®ã€‚ä»æ­¤æ‰“ç ´ä¸åŒå›¢é˜Ÿã€ä¸åŒéƒ¨é—¨ä»¥åŠä¸ªäººä¹‹é—´ä¿¡æ¯å­¤å²›çš„åƒµå±€ï¼ŒConfluenceçœŸæ­£å®ç°äº†ç»„ç»‡èµ„æºå…±äº«ã€‚</p><p>ç¯å¢ƒå‡†å¤‡</p><table><thead><tr><th>ç³»ç»Ÿç‰ˆæœ¬</th><th>æ’ä»¶</th><th>è½¯ä»¶</th><th>ç‰ˆæœ¬</th><th>æœåŠ¡é…ç½®</th></tr></thead><tbody><tr><td>centos 7.4</td><td></td><td>mysql</td><td>5.6+</td><td>2/4G/50G</td></tr><tr><td>centos 7.4</td><td>jdk 1.8</td><td>confluence</td><td>6.12.2</td><td>4/8G/200G</td></tr></tbody></table><p>confluence 6.12.2å®‰è£…å¹¶ç ´è§£ï¼Œmysql ç‰ˆæœ¬è¿™é‡Œä½¿ç”¨çš„æ˜¯5.7.24</p><a id="more"></a><h2 id="å®‰è£…mysql-5-7-24-ç‰ˆæœ¬"><a href="#å®‰è£…mysql-5-7-24-ç‰ˆæœ¬" class="headerlink" title="å®‰è£…mysql 5.7.24 ç‰ˆæœ¬"></a>å®‰è£…mysql 5.7.24 ç‰ˆæœ¬</h2><h3 id="å®‰è£…mysql"><a href="#å®‰è£…mysql" class="headerlink" title="å®‰è£…mysql"></a>å®‰è£…mysql</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -ivh http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum list |grep "mysql"</span></span><br><span class="line"><span class="comment"># yum install -y mysql-community-server</span></span><br></pre></td></tr></table></figure><ul><li><p>åŠ¨mysql</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysqld.service</span></span><br><span class="line"><span class="comment"># systemctl enable mysqld.service</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹myslqå¯†ç </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grep 'temporary password' /var/log/mysqld.log</span></span><br><span class="line">mysql&gt; SET PASSWORD = PASSWORD(<span class="string">'news password'</span>);</span><br><span class="line">mysql&gt; ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> PASSWORD EXPIRE NEVER;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚"><a href="#ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚" class="headerlink" title="ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚"></a>ä¿®æ”¹mysqlçš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ”¯æŒconfluenceçš„æœ€ä½å®‰è£…éœ€æ±‚</h3><blockquote><p>åœ¨my.cnfé…ç½®æ–‡ä»¶[mysqld]é‡Œé¢æ·»åŠ ä¸‹é¢é…ç½®å‚æ•°</p></blockquote><ul><li><p>å°†é»˜è®¤å­—ç¬¦é›†æŒ‡å®šä¸ºUTF-8</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_bin</span><br></pre></td></tr></table></figure></li><li><p>å°†é»˜è®¤å­˜å‚¨å¼•æ“è®¾ç½®ä¸ºInnoDB</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">default-storage-engine=INNODB</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šå€¼max_allowed_packetè‡³å°‘ä¸º256M</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">max_allowed_packet=512M</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šå€¼ innodb_log_file_size è‡³å°‘ä¸º2GB</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">innodb_log_file_size=2GB</span><br></pre></td></tr></table></figure></li><li><p>ç¡®ä¿æ•°æ®åº“çš„å…¨å±€äº‹åŠ¡éš”ç¦»çº§åˆ«å·²è®¾ç½®ä¸ºREAD-COMMITTED</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">transaction-isolation=READ-COMMITTED</span><br></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥äºŒè¿›åˆ¶æ—¥å¿—è®°å½•æ ¼å¼æ˜¯å¦é…ç½®ä¸ºä½¿ç”¨â€œåŸºäºè¡Œâ€çš„äºŒè¿›åˆ¶æ—¥å¿—è®°å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">binlog_format=row</span><br></pre></td></tr></table></figure></li><li><p>ç¡®ä¿sql_modeå‚æ•°æœªæŒ‡å®šNO_AUTO_VALUE_ON_ZERO</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sql_mode = <span class="string">"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span></span><br></pre></td></tr></table></figure></li><li><p>é‡å¯mysqlæ•°æ®åº“</p></li></ul><h3 id="ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“"><a href="#ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“" class="headerlink" title="ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“"></a>ä¸ºConfluenceåˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE confluence CHARACTER SET utf8 COLLATE utf8_bin;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON confluence.* TO confluence@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'password'</span></span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…Confluence"><a href="#å®‰è£…Confluence" class="headerlink" title="å®‰è£…Confluence"></a>å®‰è£…Confluence</h2><p>ä¸‹è½½Confluenceï¼Œè¿™é‡Œä¸‹è½½binæ–‡ä»¶è¿›è¡Œå®‰è£…ï¼Œ<a href="https://www.atlassian.com/software/confluence/download-archives" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a>,ä¸‹è½½çš„ç‰ˆæœ¬ä¸ºatlassian-confluence-6.12.2-x64.bin,åŒ…æœ‰ç‚¹å¤§ï¼Œéœ€è¦ç­‰å¾…â€¦â€¦</p><ul><li><p>èµ‹äºˆæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chmod a+x atlassian-confluence-6.12.2-x64.bin</span></span><br></pre></td></tr></table></figure></li><li><p>å¼€å§‹å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./atlassian-confluence-6.12.2-x64.bin</span></span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…è¿‡ç¨‹ä¸­éœ€è¦åšä¸€äº›åŸºæœ¬çš„é…ç½®ï¼Œè¯¦æƒ…æŸ¥çœ‹æˆ‘çš„é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Unpacking JRE ...</span><br><span class="line">Starting Installer ...</span><br><span class="line"></span><br><span class="line">This will install Confluence 6.12.2 on your computer.</span><br><span class="line">OK [o, Enter], Cancel [c]</span><br><span class="line">o ï¼ˆè¾“å…¥oåŒæ„ï¼‰</span><br><span class="line">Click Next to <span class="built_in">continue</span>, or Cancel to <span class="built_in">exit</span> Setup.</span><br><span class="line"></span><br><span class="line">Choose the appropriate installation or upgrade option.</span><br><span class="line">Please choose one of the following:</span><br><span class="line">Express Install (uses default settings) [1], </span><br><span class="line">Custom Install (recommended <span class="keyword">for</span> advanced users) [2, Enter], </span><br><span class="line">Upgrade an existing Confluence installation [3]</span><br><span class="line">2   (é€‰æ‹©2è‡ªå®šä¹‰å®‰è£…ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€äº›å®šåˆ¶çš„é…ç½®)</span><br></pre></td></tr></table></figure></li><li><p>å¼€å§‹è¿›è¡Œå®‰è£…å‚æ•°çš„é…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Select the folder <span class="built_in">where</span> you would like Confluence 6.12.2 to be installed,</span><br><span class="line"><span class="keyword">then</span> click Next.</span><br><span class="line">Where should Confluence 6.12.2 be installed?</span><br><span class="line">[/opt/atlassian/confluence](å®‰è£…ç›®å½•,ç›®å½•å˜åŒ–å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥ï¼Œè¿™é‡Œç›´æ¥å›è½¦)</span><br><span class="line"></span><br><span class="line">Default location <span class="keyword">for</span> Confluence data</span><br><span class="line">[/var/atlassian/application-data/confluence]ï¼ˆæ•°æ®çš„å­˜æ”¾ç›®å½•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¿®æ”¹åˆ°æˆ‘ä»¬çš„æ•°æ®ç›˜ï¼‰</span><br><span class="line">/opt/atlassian/confluence-data/</span><br><span class="line"></span><br><span class="line">Configure <span class="built_in">which</span> ports Confluence will use.</span><br><span class="line">Confluence requires two TCP ports that are not being used by any other</span><br><span class="line">applications on this machine. The HTTP port is <span class="built_in">where</span> you will access</span><br><span class="line">Confluence through your browser. The Control port is used to Startup and</span><br><span class="line">Shutdown Confluence.</span><br><span class="line">Use default ports (HTTP: 8090, Control: 8000) - Recommended [1, Enter], Set custom value <span class="keyword">for</span> HTTP and Control ports [2]</span><br><span class="line">ï¼ˆè¿™é‡Œæ˜¯è®¾ç½®ä½¿ç”¨çš„ç«¯å£ï¼Œé»˜è®¤å³å¯ï¼‰</span><br><span class="line"></span><br><span class="line">Confluence can be run <span class="keyword">in</span> the background.</span><br><span class="line">You may choose to run Confluence as a service, <span class="built_in">which</span> means it will start</span><br><span class="line">automatically whenever the computer restarts.</span><br><span class="line">Install Confluence as Service?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y</span><br><span class="line"></span><br><span class="line">Extracting files ...</span><br><span class="line">                                                                           </span><br><span class="line"></span><br><span class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> we configure Confluence.</span><br><span class="line"></span><br><span class="line">Installation of Confluence 6.12.2 is complete</span><br><span class="line">Start Confluence now?</span><br><span class="line">Yes [y, Enter], No [n]</span><br><span class="line">y</span><br><span class="line"></span><br><span class="line">Please <span class="built_in">wait</span> a few moments <span class="keyword">while</span> Confluence starts up.</span><br><span class="line">Launching Confluence ...</span><br><span class="line">è¾“å…¥yå›è½¦åConfluenceä¼šè¿›è¡Œåå°å®‰è£…ï¼Œè¿™é‡Œç­‰å¾…å®‰è£…å®Œæˆå³å¯</span><br><span class="line"></span><br><span class="line">Installation of Confluence 6.12.2 is complete</span><br><span class="line">Your installation of Confluence 6.12.2 is now ready and can be accessed via</span><br><span class="line">your browser.</span><br><span class="line">Confluence 6.12.2 can be accessed at http://localhost:8090</span><br><span class="line">å®‰è£…å®Œæˆ</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>é€šè¿‡æµè§ˆå™¨è®¿é—®è¯•ä¸€ä¸‹: <a href="http://ip:8090" target="_blank" rel="noopener">http://ip:8090</a></p></blockquote><h2 id="è¿›è¡Œè®¿é—®é…ç½®"><a href="#è¿›è¡Œè®¿é—®é…ç½®" class="headerlink" title="è¿›è¡Œè®¿é—®é…ç½®"></a>è¿›è¡Œè®¿é—®é…ç½®</h2><h3 id="å®‰è£…nginx-è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®"><a href="#å®‰è£…nginx-è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®" class="headerlink" title="å®‰è£…nginx è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®"></a>å®‰è£…nginx è¿›è¡Œæ–¹å‘ä»£ç†è®¿é—®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum install nginx -y</span></span><br><span class="line"><span class="comment"># systemctl start nginx.service</span></span><br><span class="line"><span class="comment"># systemctl enable nginx.service</span></span><br><span class="line">é…ç½®nginxçš„upstreamè¿™é‡Œå°†ä¸å†é˜è¿°</span><br></pre></td></tr></table></figure><h3 id="æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®"><a href="#æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®" class="headerlink" title="æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®"></a>æ¥ä¸‹æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œé…ç½®</h3><ul><li>æ‰“å¼€é¡µé¢</li></ul><p><img src="https://img.xxlaila.cn/1566609337530.jpg" alt="img"></p><ul><li>è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡å’Œäº§å“å®‰è£…</li></ul><p><img src="https://img.xxlaila.cn/1566609486131.jpg" alt="img"></p><p>åœ¨ä¸‹é¢çš„ä¸€ä¸ªç•Œé¢éœ€è¦è®°ä½æœåŠ¡å™¨çš„IDï¼Œè¿™ä¸ªipåœ¨åé¢ç ´è§£çš„æ—¶å€™éœ€è¦çš„</p><ul><li>åœæ­¢confluence<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/init.d/confluence stop</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ç ´è§£Confluence"><a href="#ç ´è§£Confluence" class="headerlink" title="ç ´è§£Confluence"></a>ç ´è§£Confluence</h3><ul><li>åœ¨æœ¬åœ°ä¸‹è½½ç ´è§£å™¨</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/xxlaila/work/blob/master/zip/confluence.zip</span></span><br><span class="line"><span class="comment"># unzip confluence.zip</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨æœåŠ¡å™¨ä¸ŠæŠŠatlassian-extras-decoder-v2-3.4.1.jarè¿›è¡Œå¦‚ä¸‹æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /opt/atlassian/confluence/confluence/WEB-INF/lib</span></span><br><span class="line"><span class="comment"># cp atlassian-extras-decoder-v2-3.4.1.jar /opt/atlassian-extras-2.4.jar</span></span><br><span class="line"><span class="comment"># mv atlassian-extras-decoder-v2-3.4.1.jar atlassian-extras-decoder-v2-3.4.1.jar.bak</span></span><br></pre></td></tr></table></figure></li><li><p>æŠŠ/opt/atlassian-extras-2.4.jarä¸‹è½½åˆ°æœ¬åœ°,åœ¨æœ¬åœ°å¯åŠ¨Confluenceç ´è§£å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ java -jar confluence_keygen.jar</span><br></pre></td></tr></table></figure><ul><li>ç‚¹å‡».patch! é€‰æ‹©ä¸‹è½½åˆ°æœ¬åœ°çš„atlassian-extras-2.4.jaråŒ…ï¼Œæ–‡ä»¶ç±»å‹ä¸å˜ï¼Œç‚¹å‡»æ‰“å¼€ï¼Œè‡ªåŠ¨ç”Ÿäº§ä¸€ä¸ªæ–°çš„atlassian-extras-2.4.jaråŒ…</li></ul><p><img src="https://img.xxlaila.cn/FA8682F205BB1655E20AAD392DF13417.jpg" alt="img"></p><ul><li>æŠŠæœåŠ¡å™¨idè¾“å…¥åˆ°server idï¼Œnameé¡¹éšä¾¿è¾“å…¥ï¼Œåç§°ä¸è¦è¿‡çŸ­ï¼Œåº—å®¶.gen!ç”Ÿæˆæˆæƒå—ï¼Œç„¶åæŠŠæˆæƒå¤åˆ¶åˆ°confluenceæ¡†é‡Œé¢</li></ul><p><img src="https://img.xxlaila.cn/CB99372F30342EBABC1125510FBC50B9.jpg" alt="img"></p><ul><li>æŠŠæ–°ç”Ÿæˆçš„åŒ…ä¸Šä¼ åˆ°/opt/atlassian/confluence/confluence/WEB-INF/lib/ç›®å½•ä¸‹é¢</li></ul><h3 id="ä¸‹è½½mysqlé©±åŠ¨"><a href="#ä¸‹è½½mysqlé©±åŠ¨" class="headerlink" title="ä¸‹è½½mysqlé©±åŠ¨"></a>ä¸‹è½½mysqlé©±åŠ¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.47.zip</span></span><br></pre></td></tr></table></figure><ul><li><p>å®Œæˆåè¿›è¡Œè§£å‹ï¼Œå¹¶æŠŠmysql-connector-java-5.1.47-bin.jar å¤åˆ¶åˆ°libç›®å½•ä¸‹é¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp mysql-connector-java-5.1.47-bin.jar /opt/atlassian/confluence/confluence/WEB-INF/lib</span></span><br><span class="line"><span class="comment"># /etc/init.d/confluence start</span></span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®æ•°æ®åº“</p></li></ul><p><img src="https://img.xxlaila.cn/EFF70DEA9DFBCA88E24BE83BEE9DFFC8.jpg" alt="img"><br><img src="https://img.xxlaila.cn/BF70624FCFA9E5ECFD4E121E02D08FD3.jpg" alt="img"></p><blockquote><p>è¿™æ˜¯å®Œæˆä»¥åè¿›è¡Œæµ‹è¯•ï¼Œæ˜¯å¦è”é€šï¼Œåœ¨ä¸‹ä¸€æ­¥ï¼ˆéœ€è¦è¿›è¡Œç­‰å¾…ï¼Œåå°åœ¨ç”Ÿæˆæ•°æ®åº“ï¼‰,ç”Ÿæˆå®Œæˆåï¼Œç³»ç»Ÿä¼šè·³è½¬åˆ°å¦å¤–ä¸€ä¸ªé¡µé¢ï¼Œè¿™é‡Œå¿˜è®°æˆªå›¾,æ˜¯è¿›è¡Œæ•°æ®å¯¼å…¥ã€ç«™ç‚¹æ¢å¤ç­‰</p></blockquote><ul><li><p>é‡æ–°æ‰“å¼€ç½‘å€è¿æ¥<br><img src="https://img.xxlaila.cn/BEE317A48B4CEE0407638F47CDBDF31F.jpg" alt="img"></p></li><li><p>ç”±äºè¿™é‡Œæ²¡æœ‰ladpå’Œjira,æ‰€ä»¥é€‰æ‹©åœ¨confluenceä¸­ç®¡ç†ç”¨æˆ·å’Œç»„</p></li><li><p>è®¾ç½®ç³»ç»Ÿç®¡ç†è´¦æˆ·</p></li></ul><p><img src="https://img.xxlaila.cn/93FDD95874C661340531C27CC77298FD.jpg" alt="img"><br><img src="https://img.xxlaila.cn/6B1F3A2EBF1B3DAF1A962317AA59DC15.jpg" alt="img"></p><blockquote><p>è¿™é‡Œè·³è¿‡ä¸ªäººå¤´åƒè®¾å®š,å¤´åƒè®¾å®šå®Œæˆåä¼šæç¤ºä½ æ–°å»ºä¸€ä¸ªç©ºé—´</p></blockquote><p><img src="https://img.xxlaila.cn/FCE130BD8B121A290010FEA2C2342898.jpg" alt="img"></p><ul><li>æŸ¥çœ‹æˆæƒæœŸé™</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è®¾ç½®â€”â€”&gt;ä¸€èˆ¬è®¾ç½®â€”â€”&gt;ç®¡ç†â€”â€”&gt;æˆæƒç»†èŠ‚</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/EEB25C9704F4C76C30E1DF32A2E1EDE0.jpg" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>confluence</category>
      </categories>
      <tags>
        <tag>confluence</tag>
      </tags>
  </entry>
  <entry>
    <title>nexus3æ­å»ºnpmç§æœ</title>
    <url>/2019/08/23/nexus3%E6%90%AD%E5%BB%BAnpm%E7%A7%81%E6%9C%8D/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å…¬å¸å‰ç«¯å…¨æ˜¯nodejsçš„ï¼Œnodejsåœ¨installçš„æ—¶å€™å¾€å¾€æ˜¯è¿æ¥å¤–ç½‘ï¼Œæˆ–è€…æ˜¯è®¾ç½®taobaoæºï¼Œå³ä½¿æ˜¯è®¾ç½®äº†taobaoæºï¼Œä½†æ˜¯è¿˜æ˜¯è§£å†³ä¸äº†æ…¢çš„é—®é¢˜ï¼Œä¸ºæ­¤æ­å»ºäº†ä¸€ä¸ªå†…éƒ¨çš„npmç§æœï¼Œè¿™é‡Œç”¨googleä¸€ä¸‹æœ‰å¾ˆå¤šéƒ½å¯ä»¥æ¥è¿›è¡Œæ­å»ºnpmç§æœï¼Œç„¶åä¹Ÿçœ‹åˆ°äº†nexusä¹Ÿå¯ä»¥æ¥åšï¼Œæ­£å¥½mavenç§æœä¹Ÿæ˜¯ç”¨çš„è¿™ä¸ªï¼Œéƒ½æ˜¯3ç‰ˆæœ¬ï¼Œä¸ºæ­¤é€‰æ‹©äº†nexusæ¥åšnpmçš„ç§æœï¼Œå’Œmavenä¸€å¥—ä¾¿äºç»´æŠ¤ã€‚</p><h3 id="nexuså®‰è£…"><a href="#nexuså®‰è£…" class="headerlink" title="nexuså®‰è£…"></a>nexuså®‰è£…</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸ä»‹ç»ï¼Œå®‰è£…å®Œæˆnexusåï¼Œåœ¨æµè§ˆå™¨æ‰“å¼€å¹¶è¿›è¡Œç™»å½•ï¼Œç¬¬ä¸€æ¬¡å®‰è£…ç™»å½•nexusçš„é»˜è®¤ç”¨æˆ·<code>admin</code>,é»˜è®¤å¯†ç æ˜¯<code>admin123</code></p><a id="more"></a><h3 id="1ã€åˆ›å»ºrepository"><a href="#1ã€åˆ›å»ºrepository" class="headerlink" title="1ã€åˆ›å»ºrepository"></a>1ã€åˆ›å»ºrepository</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Nexus Repository Manager 3 å¯ä»¥ç”¨äºå¤šç§ç±»å‹çš„åŒ…ç®¡ç†ã€‚æ­¤å¤„æˆ‘ä»¬è¦æ­å»ºçš„æ˜¯npmåŒ…ç®¡ç†ç§æœã€‚ç™»å½•åœ¨ç•Œé¢ç‚¹å‡»ä¸‹å›¾æ‰€ç¤ºæŒ‰é’®ã€‚<br><img src="https://img.xxlaila.cn/1566524933898.jpg" alt="img"></p><ul><li>è¿›å…¥è®¾ç½®ç•Œé¢<br><img src="https://img.xxlaila.cn/1566525058628.jpg" alt="img"></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šå›¾ä¸­å·¦é¢èœå•æœ‰å¾ˆå¤šåŠŸèƒ½ã€‚å¯ä»¥åœ¨ Security ä¸‹çš„ Users å¯ä»¥åˆ›å»ºç”¨æˆ·å¹¶è®¾ç½®ç”¨æˆ·æƒé™ï¼Œä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ã€‚Logging ä¸‹çš„ Log Viewer å¯ä»¥æŸ¥çœ‹è¿è¡Œæ—¥å¿—ã€‚è€Œæœ¬æ¬¡é…ç½®ä¸»è¦ç”¨åˆ°äº† Repository -&gt; Repositories å’Œ Security -&gt; Realms ä¸¤é¡¹</p><ul><li>é¦–å…ˆåœ¨ Repositories åˆ›å»ºä»“åº“</li></ul><p><img src="https://img.xxlaila.cn/1566526054409.jpg" alt="img"></p><ul><li><p>æ¥ä¸‹æ¥ä¼šè¿›å…¥åˆ° Repositorty çš„é€‰æ‹©ï¼šï¼ˆnpm æœ‰ä¸‰ç§ï¼‰<br><img src="https://img.xxlaila.cn/1566526144738.jpg" alt="img"></p></li><li><p>ç¬¬ä¸€ç§ï¼šä»£ç† npm ä»“åº“</p></li></ul><p><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Proxying npm Registries</a>å¯äº§çœ‹å®˜æ–¹æ–‡æ¡£</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å°†å…¬å…± npm æœåŠ¡å™¨çš„èµ„æºä»£ç†ç¼“å­˜ï¼Œå‡å°‘é‡å¤ä¸‹è½½ï¼ŒåŠ å¿«å¼€å‘äººå‘˜å’ŒCIæœåŠ¡å™¨çš„ä¸‹è½½é€Ÿåº¦ã€‚åˆ›å»ºæ—¶é€‰æ‹© npm(proxy) ï¼Œåªéœ€å¡«å†™ Name å’Œ Remote storage ï¼ˆå…¬æœ‰åº“åŸŸåï¼‰å³å¯ã€‚<br><img src="https://img.xxlaila.cn/1566526375641.jpg" alt="img"></p><ul><li>ç¬¬äºŒç§ï¼šç§æœ‰ npm ä»“åº“<br><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Private npm Registries</a>å®˜æ–¹æ–‡æ¡£</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äº ä¸Šä¼ è‡ªå·±çš„npmåŒ… ä»¥åŠç¬¬ä¸‰æ–¹npmåŒ…ã€‚åŒæ ·çš„åˆ›å»ºæ­¥éª¤ï¼Œåªä¸è¿‡é€‰æ‹©çš„ ä»“åº“ç±»å‹ä¸º npm(hosted)ã€‚ åªå¡«å†™ Name å³å¯</p><p><img src="https://img.xxlaila.cn/1566526835511.jpg" alt="img"></p><ul><li>ç¬¬ä¸‰ç§ï¼šnpm ä»“åº“ç»„<br><a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">Grouping npm Registries</a>å®˜æ–¹æ–‡æ¡£</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”¨äºå°†å¤šä¸ªå†…éƒ¨æˆ–å¤–éƒ¨ npm ä»“åº“ç»Ÿä¸€ä¸ºä¸€ä¸ª npmä»“åº“ã€‚è¢«æ·»åŠ åˆ° npmä»“åº“ç»„ ä¸­çš„ å…¶ä»–ä»“åº“å†…çš„åŒ…éƒ½èƒ½å¤Ÿé€šè¿‡è¯¥ npmä»“åº“ç»„ è®¿é—®åˆ°ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¾‹å¦‚ï¼šå¯ä»¥æ–°å»ºä¸€ä¸ªnpmä»“åº“ç»„å°† ä¸Šé¢ä¸¤ä¸ªåˆšåˆšåˆ›å»ºçš„ npm ä»“åº“éƒ½æ·»åŠ è¿›å»ã€‚è¿™æ ·å¯ä»¥é€šè¿‡è¿™ä¸ª npmä»“åº“ç»„ï¼Œæ—¢å¯ä»¥è®¿é—® å…¬æœ‰npmä»“åº“ åˆå¯ä»¥è®¿é—®è‡ªå·±çš„ ç§æœ‰npmä»“åº“ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;ä»“åº“ç±»å‹ä¸º npm(group)ï¼Œèµ·ä¸€ä¸ªåå­— Nameï¼Œç„¶åé€‰æ‹©éœ€è¦æ·»åŠ åˆ°ç»„é‡Œçš„ å…¶ä»– npm ä»“åº“ã€‚æ­¤å¤„æˆ‘é€‰æ‹©çš„æ˜¯ npm-kxl-external å’Œ npm-kxl-internal</p><p><img src="https://img.xxlaila.cn/1566527053731.jpg" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»“åº“éƒ½åˆ›å»ºå®Œæ¯•äº†ã€‚æ¥ä¸‹æ¥éœ€è¦éªŒè¯ä¸€ä¸‹æ˜¯å¦å¯ç”¨,åœ¨ Repositories ä¸­ç‚¹å‡»åˆ›å»ºçš„ ä»“åº“ã€‚å¯ä»¥æŸ¥çœ‹è¯¥ä»“åº“çš„ URLã€‚<br>åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º .npmrc æ–‡ä»¶ã€‚æ–‡ä»¶å†…å®¹ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">registry=http://172.21.16.90:8081/repository/npm-kxl-all/</span><br></pre></td></tr></table></figure><p>ç„¶åéšä¾¿å®‰è£…ä¸€ä¸ª åŒ… è¯•è¯•ï¼ˆæ—¥å¿—çº§åˆ«è®¾ç½®ä¸º infoï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm --loglevel info install react</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/1566528241640.jpg" alt="img"></p><p>å¦‚å›¾ã€‚ç¡®å®æ˜¯ä»è®¾ç½®çš„ npm ç§æœä¸‹è½½çš„reactã€‚æˆåŠŸ</p><h3 id="å‘å¸ƒåˆ°-npm-ç§æœ"><a href="#å‘å¸ƒåˆ°-npm-ç§æœ" class="headerlink" title="å‘å¸ƒåˆ° npm ç§æœ"></a>å‘å¸ƒåˆ° npm ç§æœ</h3><p>é™¤äº†ä» npm ä»“åº“å®‰è£…ä¾èµ–ã€‚æˆ‘ä»¬è¿˜éœ€è¦å°†å…¬å¸å†…éƒ¨çš„ ä»£ç æ‰“åŒ… å‘å¸ƒåˆ° npm çš„ç§æœã€‚è¿™é‡Œæ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå°±æ˜¯éœ€è¦è®¾ç½®ä¸€ä¸‹ Nexus Repository Manager çš„æƒé™ã€‚è¿™æ ·æ‰èƒ½ä½¿ç”¨ npm login è®¤è¯ç™»å½•åˆ°æˆ‘ä»¬çš„ç§æœã€‚</p><p><img src="https://img.xxlaila.cn/1566528346695.jpg" alt="img"></p><p>æ­¤å¤„åœ¨ Realms ä¸‹ã€‚å°† npm Bearer Token Realm æ·»åŠ åˆ° Active åˆ—è¡¨å†…ä¿å­˜å³å¯ã€‚<br>ç„¶åå¯ä»¥æ‰§è¡Œï¼ˆç™»å½• ç§æœ‰npmä»“åº“ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm login --registry=http://172.21.16.90:8081/repository/npm-kxl-internal/</span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Email: (this IS public) 1@qq.com</span><br><span class="line">Logged <span class="keyword">in</span> as admin on http://172.21.16.90:8081/repository/npm-kxl-internal/.</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤ï¼Œæç¤ºå¡«å†™è´¦å·å¯†ç å’Œé‚®ç®±ï¼ŒéªŒè¯é€šè¿‡åå°†ä¼šåœ¨ ç”¨æˆ·ä¸»ç›®å½•ä¸‹çš„ .npmrc æ–‡ä»¶ä¸­æ’å…¥ä¸€æ¡ æ­¤ä»“åº“ url å’Œå¯¹åº”çš„ tokenã€‚</p><p><img src="https://img.xxlaila.cn/1566528452423.jpg" alt="img"></p><p>åœ¨ç¡®ä¿é¡¹ç›®æœ‰ package.json å‰æä¸‹ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm publish --registry=http://172.21.16.90:8081/repository/npm-kxl-internal/</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œä½¿ç”¨ Nexus Repository Manager 3 æ­å»º npm ç§æœç»“æŸã€‚æ•´ä½“æµç¨‹å¹¶ä¸å¤æ‚ï¼Œæ–‡æ¡£å¾ˆè¯¦å°½,ç›´æ¥è¯»æ–‡æ¡£å¯èƒ½ä¼šé—æ¼ä¸€äº›ä¸œè¥¿ã€‚å¯ä»¥å‚è€ƒ<a href="https://help.sonatype.com/repomanager3/formats/npm-registry" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://xxlaila.github.io/2019/10/15/nexusé…ç½®ldap/" target="_blank" rel="noopener">nexus ldapé…ç½®</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nexus</category>
      </categories>
      <tags>
        <tag>npm</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx URL æ–œæ é—®é¢˜</title>
    <url>/2019/08/22/nginx-URL-%E6%96%9C%E6%9D%A0%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä»Šå¤©å…¬å¸æ–°ä¸Šçš„ä¸€ä¸ªå‰ç«¯åº”ç”¨é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯åœ¨å¾®ä¿¡ç™»å½•ç•Œé¢æ‰«ç ç™»å½•ä¹‹åï¼Œå¾®ä¿¡å›è°ƒç»™æˆ‘ä»¬çš„åœ°å€å¤šåŠ äº†ä¸€ä¸ªæ–œæ ;</p><blockquote><p>é”™è¯¯çš„åœ°å€:<a href="http://a.xxlaila.com/wx.html/?code=011amZet0h1IUf19Fvht0jg4ft0amZeN" target="_blank" rel="noopener">http://a.xxlaila.com/wx.html/?code=011amZet0h1IUf19Fvht0jg4ft0amZeN</a><br>æ­£ç¡®çš„åœ°å€:<a href="http://a.xxlaila.com/wx.html?code=011amZet0h1IUf19Fvht0jg4ft0amZeN" target="_blank" rel="noopener">http://a.xxlaila.com/wx.html?code=011amZet0h1IUf19Fvht0jg4ft0amZeN</a></p></blockquote><p>åœ¨nginxä¸Šé…ç½®éœ€è¦å§è¿™ä¸ªæ–œæ åˆ é™¤æ‰ã€‚ç”¨æˆ·æ‰èƒ½æ­£å¸¸çš„è®¿é—®ï¼›</p><h3 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><p>åœ¨é…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®é¡¹</p><a id="more"></a><ul><li>åˆ é™¤URLç»“å°¾çš„æ–œæ </li></ul><p><em>rewrite ^/(.</em>)/$ /$1 permanent;*</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  a.xxlaila.com;</span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)/$</span> /<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">  <span class="attribute">index</span> index.html index.htm index.jsp index.php;</span><br><span class="line">  <span class="attribute">root</span> /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> <span class="regexp">~* /</span> &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span>   /var/log/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨URLç»“å°¾æ·»åŠ æ–œæ <br>åœ¨é…ç½®æ–‡ä»¶å¢åŠ å¦‚ä¸‹é…ç½®é¡¹ç›®</li></ul><p><em>rewrite ^(.</em>[^/])$ $1/ permanent;*</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  a.xxlaila.com;</span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^(.*[^/])$</span> <span class="variable">$1</span>/ <span class="literal">permanent</span>;</span><br><span class="line">  <span class="attribute">index</span> index.html index.htm index.jsp index.php;</span><br><span class="line">  <span class="attribute">root</span> /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> <span class="regexp">~* /</span> &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span>   /var/log/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h2><p>åœ¨æµè§ˆå™¨è®¿é—®æŸä¸€ä¸ªurl/é¡µé¢çš„æ—¶å€™ï¼Œé€šå¸¸æœ‰æ—¶å€™å¸¦æœ‰.htmlçš„ä¸€ä¸ªæ‰©å±•åï¼Œç°éœ€æ±‚æ˜¯å¸¦<code>.html</code>å’Œä¸å¸¦<code>.html</code>éƒ½å¯ä»¥è®¿é—®</p><h3 id="ä¾‹"><a href="#ä¾‹" class="headerlink" title="ä¾‹"></a>ä¾‹</h3><p>å¢åŠ å¦‚ä¸‹é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;    </span><br><span class="line">       rewrite ^(.*)$ /<span class="variable">$1</span>.html last;</span><br><span class="line">       <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  charset utf-8;</span><br><span class="line">  server_name  a.xxlaila.com;</span><br><span class="line">  rewrite ^/(.*)/$ /<span class="variable">$1</span> permanent;</span><br><span class="line">  index index.html index.htm index.jsp index.php;</span><br><span class="line">  root /opt/webapps/a.xxlaila.com;</span><br><span class="line"></span><br><span class="line">  location ~* / &#123;</span><br><span class="line">    <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">       rewrite ^(.*)$ /<span class="variable">$1</span>.html last;</span><br><span class="line">       <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  access_log   /var/<span class="built_in">log</span>/nginx/a.xxlaila.com.access.log main;</span><br><span class="line"><span class="comment">#  error_log   /var/log/nginx/a.xxlaila.com.error.log debug;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(å››)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E5%9B%9B/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h2 id="1ã€Blue-Ocean"><a href="#1ã€Blue-Ocean" class="headerlink" title="1ã€Blue Ocean"></a>1ã€Blue Ocean</h2><p>å®‰è£…Blue Oceanæ’ä»¶</p><h3 id="1-1ã€åˆ›å»ºpipeline"><a href="#1-1ã€åˆ›å»ºpipeline" class="headerlink" title="1.1ã€åˆ›å»ºpipeline"></a>1.1ã€åˆ›å»ºpipeline</h3><p><img src="https://img.xxlaila.cn/348knfnsdlds.png" alt="img"></p><ul><li>é…ç½®ä»£ç åº“çš„åœ°å€</li><li>ç„¶åé…ç½®æˆæƒè´¦æˆ·</li></ul><p><img src="https://img.xxlaila.cn/9857jksdhfjkhdsfds.png" alt="img"></p><p>åœ¨è¿™å„¿ä¹‹å‰gitåº“é‡Œé¢å¿…é¡»å­˜åœ¨äºjenkinsfileæ–‡ä»¶ï¼Œpipelineä¼šè‡ªåŠ¨å»æ‰«æä»£ç åº“é‡Œé¢çš„åˆ†æ”¯ï¼Œç„¶åæ ¹æ®æ¯ä¸€ä¸ªåˆ†æ”¯å»ºç«‹ä¸€ä¸ªç±»ä¼¼äºjobçš„å½¢å¼ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æ ¹æ®æ¯ä¸€ä¸ªåˆ†æ”¯è¿›è¡Œéƒ¨ç½²ï¼Œå¯ä»¥æ‰§è¡Œå®šæ—¶è§¦å‘ï¼Œéƒ¨ç½²</p><p><img src="https://img.xxlaila.cn/382dklfjdskjfs.png" alt="img"></p><p>è¿™å„¿ï¼Œåªæœ‰ä¸€ä¸ªåˆ†æ”¯å­˜åœ¨äºjenkinsfileï¼Œæ‰€ä»¥åªæ˜¾ç¤ºä¸€ä¸ªåˆ†æ”¯ï¼Œå¦‚ä¸‹å›¾ï¼š</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>jenkins, ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(ä¸‰)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E4%B8%89/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;jenkins é…ç½®å®Œæˆåï¼Œæœ€ç»ˆå®ç°çš„æ˜¯ci/cdï¼Œåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°åç«¯javaçš„ï¼Œå‰ç«¯nodejsçš„ï¼Œè¿™é‡Œå°±éœ€è¦è¿›è¡Œä¸€ä¸ªk8såœ¨è°ƒåº¦çš„æ—¶å€™ç”Ÿäº§podæ¥è¿›è¡ŒæŒ‡å®špodè¿›è¡Œç¼–è¯‘</p><h3 id="1ã€åˆ¶ä½œå®¹å™¨"><a href="#1ã€åˆ¶ä½œå®¹å™¨" class="headerlink" title="1ã€åˆ¶ä½œå®¹å™¨"></a>1ã€åˆ¶ä½œå®¹å™¨</h3><p>è‡ªå®šä¹‰ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢åŒ…å«äº† javaï¼Œnodejsçš„æ‰€éœ€è¦çš„ç¯å¢ƒï¼ŒåŒæ—¶éœ€è¦åŒæ­¥å®¹å™¨çš„æ—¶é—´ï¼ŒåŒ…å«æ¥jenkinsçš„node</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat Dockerfile</span></span><br><span class="line"><span class="attr">FROM</span> <span class="string">docker.io/centos:latest</span></span><br><span class="line"><span class="attr">MAINTAINER</span> <span class="string">xxlaila "cq_xxlaila@163.com"</span></span><br><span class="line"><span class="comment"># Install dependent plugin</span></span><br><span class="line"><span class="attr">ENV</span> <span class="string">VERSION v10.15.1</span></span><br><span class="line"><span class="attr">RUN</span> <span class="string">yum install -y wget \</span></span><br><span class="line">    <span class="attr">git</span> <span class="string">\</span></span><br><span class="line">    <span class="meta">java-1.8.0-openjdk.x86_64</span> <span class="string">\</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">curl -sL https://rpm.nodesource.com/setup_11.x | bash - \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum install -y gcc gcc-c++ make \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum install -y nodejs \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">yum clean all</span></span><br><span class="line"><span class="comment"># System variable setting</span></span><br><span class="line"><span class="attr">RUN</span> <span class="string">echo "LANG=zh_CN.UTF-8" &gt;&gt; /etc/locale.conf \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">source /etc/locale.conf \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">echo "Asia/shanghai" &gt;&gt; /etc/timezone \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">groupadd -g 10000 jenkins \</span></span><br><span class="line">    <span class="meta">&amp;&amp;</span> <span class="string">useradd -g jenkins -u 10000 jenkins</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">EXPOSE</span> <span class="string">50000</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li><p>æ‰§è¡Œå®¹å™¨æ‰“åŒ…</p><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="attr"># docker build -t centos7</span><span class="number">.6</span>/<span class="symbol">node11</span>:latest .\</span><br></pre></td></tr></table></figure></li><li><p>æ¨é€å®¹å™¨åˆ°ç§æœ‰é•œåƒä»“åº“</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># docker tag centos7<span class="number">.6</span>/node11:latest docker.io/xxlaila/centos<span class="number">-7</span>-jdk1<span class="number">.8</span>-nodejs11<span class="number">.10</span>-jenkins:latest</span><br><span class="line"># docker push docker.io/xxlaila/centos<span class="number">-7</span>-jdk1<span class="number">.8</span>-nodejs11<span class="number">.10</span>-jenkins:latest</span><br></pre></td></tr></table></figure></li></ul><h3 id="2ã€jenkinsçš„é…ç½®"><a href="#2ã€jenkinsçš„é…ç½®" class="headerlink" title="2ã€jenkinsçš„é…ç½®"></a>2ã€jenkinsçš„é…ç½®</h3><h4 id="2-1ã€ç³»ç»Ÿé…ç½®"><a href="#2-1ã€ç³»ç»Ÿé…ç½®" class="headerlink" title="2.1ã€ç³»ç»Ÿé…ç½®"></a>2.1ã€ç³»ç»Ÿé…ç½®</h4><p>jenkinsâ€”â€”&gt;ç³»ç»Ÿç®¡ç†â€”â€”&gt;ç³»ç»Ÿè®¾ç½®<br><strong>åç§°</strong>ï¼škubernetes<br><strong>åœ°å€</strong>ï¼š<a href="https://kubernetes.default.svc.cluster.local" target="_blank" rel="noopener">https://kubernetes.default.svc.cluster.local</a><br><strong>jenkinsåœ°å€</strong>ï¼š<a href="http://jenkins2.kube-ops.svc.cluster.local:8080" target="_blank" rel="noopener">http://jenkins2.kube-ops.svc.cluster.local:8080</a><br><img src="https://img.xxlaila.cn/489kdngkdhfkodsmf.png" alt="img"></p><h4 id="2-2ã€å¢åŠ ä¸€ä¸ªkubenetes-pod-templates"><a href="#2-2ã€å¢åŠ ä¸€ä¸ªkubenetes-pod-templates" class="headerlink" title="2.2ã€å¢åŠ ä¸€ä¸ªkubenetes pod templates"></a>2.2ã€å¢åŠ ä¸€ä¸ªkubenetes pod templates</h4><p><img src="https://img.xxlaila.cn/83jknfkdslfds.png" alt="img"></p><h4 id="2-3ã€é…ç½®å®¹å™¨ç¯å¢ƒ"><a href="#2-3ã€é…ç½®å®¹å™¨ç¯å¢ƒ" class="headerlink" title="2.3ã€é…ç½®å®¹å™¨ç¯å¢ƒ"></a>2.3ã€é…ç½®å®¹å™¨ç¯å¢ƒ</h4><p><img src="https://img.xxlaila.cn/42clkdsjfkldsfs.png" alt="img"></p><h4 id="2-4ã€é…ç½®æƒé™"><a href="#2-4ã€é…ç½®æƒé™" class="headerlink" title="2.4ã€é…ç½®æƒé™"></a>2.4ã€é…ç½®æƒé™</h4><p><img src="https://img.xxlaila.cn/3486238kmxnfksd.png" alt="img"></p><h3 id="3ã€æµ‹è¯•job"><a href="#3ã€æµ‹è¯•job" class="headerlink" title="3ã€æµ‹è¯•job"></a>3ã€æµ‹è¯•job</h3><p>å»ºç«‹ä¸€ä¸ªtest job çš„pipelineæ¥è¿›è¡Œå®¹å™¨æ˜¯å¦æ­£å¸¸</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node (<span class="string">'agent-node'</span>)&#123;</span><br><span class="line">    container(<span class="string">'nodejs'</span>) &#123;</span><br><span class="line">        sh <span class="string">'whoami'</span></span><br><span class="line">        sh <span class="string">'hostname'</span></span><br><span class="line">        sh <span class="string">'echo $PATH'</span></span><br><span class="line">        sh <span class="string">'npm version'</span></span><br><span class="line">        sh <span class="string">'node -v'</span></span><br><span class="line">        sh <span class="string">'npx -v'</span></span><br><span class="line">        sh <span class="string">'java -version'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1ã€å»ºç«‹pipeline"><a href="#3-1ã€å»ºç«‹pipeline" class="headerlink" title="3.1ã€å»ºç«‹pipeline"></a>3.1ã€å»ºç«‹pipeline</h4><h5 id="3-1-1ã€å»ºç«‹ä¸€ä¸ªåç«¯"><a href="#3-1-1ã€å»ºç«‹ä¸€ä¸ªåç«¯" class="headerlink" title="3.1.1ã€å»ºç«‹ä¸€ä¸ªåç«¯"></a>3.1.1ã€å»ºç«‹ä¸€ä¸ªåç«¯</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'agent-build'</span>) &#123;</span><br><span class="line">   stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git credentialsId:<span class="string">'gitlabUser'</span>, url: <span class="string">'http://gitlab.xxlaila.com/plat/middleware/kxl-eureka.git'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'build'</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2. Start build <span class="variable">$&#123;JOB_NAME&#125;</span>"</span></span><br><span class="line">        sh <span class="string">'/opt/bin/mvn clean package'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'show package'</span>) &#123;</span><br><span class="line">        sh <span class="string">'pwd'</span></span><br><span class="line">        sh <span class="string">'ls -ltrh target/'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1-2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯"><a href="#3-1-2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯" class="headerlink" title="3.1.2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯"></a>3.1.2ã€å»ºç«‹ä¸€ä¸ªå‰ç«¯</h4><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'agent-build'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git credentialsId:<span class="string">'gitlabUser'</span>, ur<span class="variable">l:</span> <span class="string">'http://gitlab.xxlaila.com/front-end/portal/kts-platform.git'</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'install'</span>) &#123;</span><br><span class="line">        container(<span class="string">'nodejs'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"2. Start install $&#123;JOB_NAME&#125;"</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'node -v'</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'npm install'</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">'npm run build production'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'show package'</span>) &#123;</span><br><span class="line">        <span class="keyword">sh</span> <span class="string">'pwd'</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">'ls -ltrh'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-ci/cd-(äºŒ)</title>
    <url>/2019/08/20/kubernetes-ci-cd-%E4%BA%8C/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h1 id="åŸºäºjenkins-pipelineè¿›è¡Œéƒ¨ç½²"><a href="#åŸºäºjenkins-pipelineè¿›è¡Œéƒ¨ç½²" class="headerlink" title="åŸºäºjenkins  pipelineè¿›è¡Œéƒ¨ç½²"></a>åŸºäºjenkins pipelineè¿›è¡Œéƒ¨ç½²</h1><h2 id="1ã€jenkins-pipelineä»‹ç»"><a href="#1ã€jenkins-pipelineä»‹ç»" class="headerlink" title="1ã€jenkins pipelineä»‹ç»"></a>1ã€jenkins pipelineä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;è¦å®ç°åœ¨ Jenkins ä¸­çš„æ„å»ºå·¥ä½œï¼Œå¯ä»¥æœ‰å¤šç§æ–¹å¼ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨æ¯”è¾ƒå¸¸ç”¨çš„ Pipeline è¿™ç§æ–¹å¼ã€‚Pipelineï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸€å¥—è¿è¡Œåœ¨ Jenkins ä¸Šçš„å·¥ä½œæµæ¡†æ¶ï¼Œå°†åŸæ¥ç‹¬ç«‹è¿è¡Œäºå•ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ç‚¹çš„ä»»åŠ¡è¿æ¥èµ·æ¥ï¼Œå®ç°å•ä¸ªä»»åŠ¡éš¾ä»¥å®Œæˆçš„å¤æ‚æµç¨‹ç¼–æ’å’Œå¯è§†åŒ–çš„å·¥ä½œã€‚</p><p>Jenkins Pipeline æœ‰å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µ:</p><ul><li>Nodeï¼šèŠ‚ç‚¹ï¼Œä¸€ä¸ª Node å°±æ˜¯ä¸€ä¸ª Jenkins èŠ‚ç‚¹ï¼ŒMaster æˆ–è€… Agentï¼Œæ˜¯æ‰§è¡Œ Step çš„å…·ä½“è¿è¡Œç¯å¢ƒï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹‹å‰åŠ¨æ€è¿è¡Œçš„ Jenkins Slave å°±æ˜¯ä¸€ä¸ª Node èŠ‚ç‚¹</li><li>Stageï¼šé˜¶æ®µï¼Œä¸€ä¸ª Pipeline å¯ä»¥åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ª Stageï¼Œæ¯ä¸ª Stage ä»£è¡¨ä¸€ç»„æ“ä½œï¼Œæ¯”å¦‚ï¼šBuildã€Testã€Deployï¼ŒStage æ˜¯ä¸€ä¸ªé€»è¾‘åˆ†ç»„çš„æ¦‚å¿µï¼Œå¯ä»¥è·¨å¤šä¸ª Node</li><li>Stepï¼šæ­¥éª¤ï¼ŒStep æ˜¯æœ€åŸºæœ¬çš„æ“ä½œå•å…ƒï¼Œå¯ä»¥æ˜¯æ‰“å°ä¸€å¥è¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æ„å»ºä¸€ä¸ª Docker é•œåƒï¼Œç”±å„ç±» Jenkins æ’ä»¶æä¾›ï¼Œæ¯”å¦‚å‘½ä»¤ï¼šsh â€˜makeâ€™ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å¹³æ—¶ shell ç»ˆç«¯ä¸­æ‰§è¡Œ make å‘½ä»¤ä¸€æ ·ã€‚</li></ul><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åˆ›å»º Jenkins Pipline å‘¢ï¼Ÿ</p><ul><li>Pipeline è„šæœ¬æ˜¯ç”± Groovy è¯­è¨€å®ç°çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡å¿…è¦å•ç‹¬å»å­¦ä¹  Groovyï¼Œå½“ç„¶ä½ ä¼šçš„è¯æœ€å¥½</li><li>Pipeline æ”¯æŒä¸¤ç§è¯­æ³•ï¼šDeclarative(å£°æ˜å¼)å’Œ Scripted Pipeline(è„šæœ¬å¼)è¯­æ³•</li><li>Pipeline ä¹Ÿæœ‰ä¸¤ç§åˆ›å»ºæ–¹æ³•ï¼šå¯ä»¥ç›´æ¥åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­è¾“å…¥è„šæœ¬ï¼›ä¹Ÿå¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª Jenkinsfile è„šæœ¬æ–‡ä»¶æ”¾å…¥é¡¹ç›®æºç åº“ä¸­</li><li>ä¸€èˆ¬æˆ‘ä»¬éƒ½æ¨èåœ¨ Jenkins ä¸­ç›´æ¥ä»æºä»£ç æ§åˆ¶(SCMD)ä¸­ç›´æ¥è½½å…¥ Jenkinsfile Pipeline è¿™ç§æ–¹æ³•åˆ›å»ºä¸€ä¸ªç®€å•çš„ Pipeline<blockquote><p>æˆ‘ä»¬è¿™é‡Œæ¥ç»™å¤§å®¶å¿«é€Ÿåˆ›å»ºä¸€ä¸ªç®€å•çš„ Pipelineï¼Œç›´æ¥åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­è¾“å…¥è„šæœ¬è¿è¡Œã€‚</p></blockquote></li><li>æ–°å»º Jobï¼šåœ¨ Web UI ä¸­ç‚¹å‡» New Item -&gt; è¾“å…¥åç§°ï¼špipeline-demo -&gt; é€‰æ‹©ä¸‹é¢çš„ Pipeline -&gt; ç‚¹å‡» OK</li><li>é…ç½®ï¼šåœ¨æœ€ä¸‹æ–¹çš„ Pipeline åŒºåŸŸè¾“å…¥å¦‚ä¸‹ Script è„šæœ¬ï¼Œç„¶åç‚¹å‡»ä¿å­˜ã€‚</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell node &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span> </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span> </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"3.Build Stage"</span> </span><br><span class="line">        </span><br><span class="line">    &#125; </span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"4. Deploy Stage"</span> </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ„å»ºï¼šç‚¹å‡»å·¦ä¾§åŒºåŸŸçš„ Build Nowï¼Œå¯ä»¥çœ‹åˆ° Job å¼€å§‹æ„å»ºäº†<blockquote><p>éš”ä¸€ä¼šå„¿ï¼Œæ„å»ºå®Œæˆï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¾§åŒºåŸŸçš„ Console Outputï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºä¿¡æ¯ï¼š</p></blockquote></li></ul><p><img src="https://img.xxlaila.cn/sdsdsjid23874823ehsj.png" alt="img"></p><ul><li>åœ¨ Slave ä¸­æ„å»ºä»»åŠ¡<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ Pipeline ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªä»»åŠ¡å¹¶æ²¡æœ‰åœ¨ Jenkins çš„ Slave ä¸­è¿è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•è®©æˆ‘ä»¬çš„ä»»åŠ¡è·‘åœ¨ Slave ä¸­å‘¢ï¼Ÿè¿˜è®°å¾—ä¸ŠèŠ‚è¯¾æˆ‘ä»¬åœ¨æ·»åŠ  Slave Pod çš„æ—¶å€™ï¼Œä¸€å®šè¦è®°ä½æ·»åŠ çš„ label å—ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°è¿™ä¸ª labelï¼Œæˆ‘ä»¬é‡æ–°ç¼–è¾‘ä¸Šé¢åˆ›å»ºçš„ Pipeline è„šæœ¬ï¼Œç»™ node æ·»åŠ ä¸€ä¸ª label å±æ€§ï¼Œå¦‚ä¸‹:</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'jnlp-agent'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4. Deploy Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯ç»™ node æ·»åŠ äº†ä¸€ä¸ªjnlp-agentè¿™æ ·çš„ä¸€ä¸ªlabelï¼Œç„¶åæˆ‘ä»¬ä¿å­˜ï¼Œæ„å»ºä¹‹å‰æŸ¥çœ‹ä¸‹ kubernetes é›†ç¾¤ä¸­çš„ Podï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[<span class="built_in">test</span>] [root@k8s-zxc-test-3 ~]<span class="comment"># kubectl get pods -n kube-ops</span></span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">jenkins2-696b8fbdbb-q24nm   1/1     Running             0          45h</span><br><span class="line">jnlp-agent-342fv            0/1     ContainerCreating   0          0s</span><br><span class="line">[<span class="built_in">test</span>] [root@k8s-zxc-test-3 ~]<span class="comment"># kubectl get pods -n kube-ops</span></span><br><span class="line">NAME                        READY   STATUS              RESTARTS   AGE</span><br><span class="line">jenkins2-696b8fbdbb-q24nm   1/1     Running             0          45h</span><br><span class="line">jnlp-agent-342fv            0/1     ContainerCreating   0          1s</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/dhf482390dsfjkdsg.png" alt="img"></p><ul><li><p>kubernetes ç•Œé¢æ˜¾ç¤º<br><img src="https://img.xxlaila.cn/9374hkdhskfjsdd.png" alt="img"></p></li><li><p>jenkinsæ‰§è¡Œç»“æœæ˜¾ç¤º<br><img src="https://img.xxlaila.cn/23cvkndiuyriens.png" alt="img"></p></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp; è¯æ˜æˆ‘ä»¬å½“å‰çš„ä»»åŠ¡åœ¨è·‘åœ¨ä¸Šé¢åŠ¨æ€ç”Ÿæˆçš„è¿™ä¸ª Pod ä¸­ï¼Œä¹Ÿç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚æˆ‘ä»¬å›åˆ° Job çš„ä¸»ç•Œé¢ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°å¤§å®¶å¯èƒ½æ¯”è¾ƒç†Ÿæ‚‰çš„ Stage View ç•Œé¢ï¼š<br><img src="https://img.xxlaila.cn/45ksfh9whnkxa.png" alt="img"></p><h5 id="éƒ¨ç½²-Kubernetes-åº”ç”¨"><a href="#éƒ¨ç½²-Kubernetes-åº”ç”¨" class="headerlink" title="éƒ¨ç½² Kubernetes åº”ç”¨"></a>éƒ¨ç½² Kubernetes åº”ç”¨</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å·²ç»çŸ¥é“äº†å¦‚ä½•åœ¨ Jenkins Slave ä¸­æ„å»ºä»»åŠ¡äº†ï¼Œé‚£ä¹ˆå¦‚ä½•æ¥éƒ¨ç½²ä¸€ä¸ªåŸç”Ÿçš„ Kubernetes åº”ç”¨å‘¢ï¼Ÿ è¦éƒ¨ç½² Kubernetes åº”ç”¨ï¼Œæˆ‘ä»¬å°±å¾—å¯¹æˆ‘ä»¬ä¹‹å‰éƒ¨ç½²åº”ç”¨çš„æµç¨‹è¦éå¸¸ç†Ÿæ‚‰æ‰è¡Œï¼Œæˆ‘ä»¬ä¹‹å‰çš„æµç¨‹æ˜¯æ€æ ·çš„ï¼š</p><ul><li>1ã€ç¼–å†™ä»£ç </li><li>2ã€æµ‹è¯•</li><li>3ã€ç¼–å†™ Dockerfile</li><li>4ã€æ„å»ºæ‰“åŒ… Docker é•œåƒ</li><li>5ã€æ¨é€ Docker é•œåƒåˆ°ä»“åº“</li><li>6ã€ç¼–å†™ Kubernetes YAML æ–‡ä»¶</li><li>7ã€æ›´æ”¹ YAML æ–‡ä»¶ä¸­ Docker é•œåƒ TAG</li><li>8ã€åˆ©ç”¨ kubectl å·¥å…·éƒ¨ç½²åº”ç”¨</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬ä¹‹å‰åœ¨ Kubernetes ç¯å¢ƒä¸­éƒ¨ç½²ä¸€ä¸ªåŸç”Ÿåº”ç”¨çš„æµç¨‹åº”è¯¥åŸºæœ¬ä¸Šæ˜¯ä¸Šé¢è¿™äº›æµç¨‹å§ï¼Ÿç°åœ¨æˆ‘ä»¬å°±éœ€è¦æŠŠä¸Šé¢è¿™äº›æµç¨‹æ”¾å…¥ Jenkins ä¸­æ¥è‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆ(å½“ç„¶ç¼–ç é™¤å¤–)ï¼Œä»æµ‹è¯•åˆ°æ›´æ–° YAML æ–‡ä»¶å±äº CI æµç¨‹ï¼Œåé¢éƒ¨ç½²å±äº CD çš„æµç¨‹ã€‚å¦‚æœæŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬ç°åœ¨è¦æ¥ç¼–å†™ä¸€ä¸ª Pipeline çš„è„šæœ¬ã€‚</p><ul><li><p>ä¿®æ”¹test-spring-social-wechat-sample pipelineè„šæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'jnlp-agent'</span>) &#123;</span><br><span class="line">   stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'YAML'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"6. Deploy Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>1ï¼‰ã€å¢åŠ gitåœ°å€ï¼Œè¿›è¡Œä»£ç çš„clone</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Clone'</span>)</span></span> &#123;</span><br><span class="line">   echo <span class="string">"1.Clone Stage"</span></span><br><span class="line">   git url: <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>2ï¼‰ã€è¿›è¡Œæµ‹è¯•</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Test'</span>)</span></span> &#123;</span><br><span class="line">  echo <span class="string">"2.Test Stage"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>3ï¼‰ã€æ„å»ºä¸€ä¸ªdockeré•œåƒ</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Build'</span>)</span></span> &#123;</span><br><span class="line">  echo <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">  sh <span class="string">"docker build -t xxlaila/jenkins-demo:$&#123;build_tag&#125; ."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;å¹³æ—¶æ„å»ºçš„æ—¶å€™æ˜¯ä¸æ˜¯éƒ½æ˜¯ç›´æ¥ä½¿ç”¨docker buildå‘½ä»¤è¿›è¡Œæ„å»ºå°±è¡Œäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹å‘¢ï¼Ÿæˆ‘ä»¬ä¸ŠèŠ‚è¯¾ç»™å¤§å®¶æä¾›çš„ Slave Pod çš„é•œåƒé‡Œé¢æ˜¯ä¸æ˜¯é‡‡ç”¨çš„ Docker In Docker çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ Slave ä¸­ä½¿ç”¨ docker build å‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç›´æ¥ä½¿ç”¨ sh ç›´æ¥æ‰§è¡Œ docker build å‘½ä»¤å³å¯ï¼Œä½†æ˜¯é•œåƒçš„ tag å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬ä½¿ç”¨é•œåƒ tagï¼Œåˆ™æ¯æ¬¡éƒ½æ˜¯ latest çš„ tagï¼Œè¿™å¯¹äºä»¥åçš„æ’æŸ¥æˆ–è€…å›æ»šä¹‹ç±»çš„å·¥ä½œä¼šå¸¦æ¥å¾ˆå¤§éº»çƒ¦ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨å’Œgit commitçš„è®°å½•ä¸ºé•œåƒçš„ tagï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯é•œåƒçš„ tag å¯ä»¥å’Œ git æäº¤è®°å½•å¯¹åº”èµ·æ¥ï¼Œä¹Ÿæ–¹ä¾¿æ—¥åå¯¹åº”æŸ¥çœ‹ã€‚ä½†æ˜¯ç”±äºè¿™ä¸ª tag ä¸åªæ˜¯æˆ‘ä»¬è¿™ä¸€ä¸ª stage éœ€è¦ä½¿ç”¨ï¼Œä¸‹ä¸€ä¸ªæ¨é€é•œåƒæ˜¯ä¸æ˜¯ä¹Ÿéœ€è¦ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æŠŠè¿™ä¸ª tag ç¼–å†™æˆä¸€ä¸ªå…¬å…±çš„å‚æ•°ï¼ŒæŠŠå®ƒæ”¾åœ¨ Clone è¿™ä¸ª stage ä¸­ï¼Œä¿®æ”¹å‰é¢ä¸¤ä¸ª stage:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      git url: <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line">      script &#123;</span><br><span class="line">        build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">      sh <span class="string">"docker build -t xxlaila/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span> ."</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>4ï¼‰ã€æ¨é€é•œåƒ<br>&nbsp;&nbsp;&nbsp;&nbsp;é•œåƒæ„å»ºå®Œæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬å°±éœ€è¦å°†æ­¤å¤„æ„å»ºçš„é•œåƒæ¨é€åˆ°é•œåƒä»“åº“ä¸­å»ï¼Œå½“ç„¶å¦‚æœä½ æœ‰ç§æœ‰é•œåƒä»“åº“ä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰è‡ªå·±æ­å»ºç§æœ‰çš„ä»“åº“ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ docker hub å³å¯ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬çŸ¥é“ docker hub æ˜¯å…¬å…±çš„é•œåƒä»“åº“ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å–ä¸Šé¢çš„é•œåƒï¼Œä½†æ˜¯è¦å¾€ä¸Šæ¨é€é•œåƒæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°ä¸€ä¸ªå¸å·äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æå‰æ³¨å†Œä¸€ä¸ª docker hub çš„å¸å·ï¼Œè®°ä½ç”¨æˆ·åå’Œå¯†ç ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦ä½¿ç”¨ã€‚æ­£å¸¸æ¥è¯´æˆ‘ä»¬åœ¨æœ¬åœ°æ¨é€ docker é•œåƒçš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯éœ€è¦ä½¿ç”¨docker loginå‘½ä»¤ï¼Œç„¶åè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œè®¤è¯é€šè¿‡åï¼Œå°±å¯ä»¥ä½¿ç”¨docker pushå‘½ä»¤æ¥æ¨é€æœ¬åœ°çš„é•œåƒåˆ° docker hub ä¸Šé¢å»äº†ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬è¿™é‡Œçš„ Pipeline æ˜¯ä¸æ˜¯å°±è¯¥è¿™æ ·å†™äº†ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">      sh <span class="string">"docker login -u cq_xxlaila@163.com -p 111111"</span></span><br><span class="line">      sh <span class="string">"docker push xxlaila/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span>"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœåªæ˜¯åœ¨ Jenkins çš„ Web UI ç•Œé¢ä¸­æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡çš„è¯ï¼Œæˆ‘ä»¬è¿™é‡Œçš„ Pipeline æ˜¯å¯ä»¥è¿™æ ·å†™çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯ä¸æ˜¯æ¨èä½¿ç”¨ Jenkinsfile çš„å½¢å¼æ”¾å…¥æºç ä¸­è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬ç›´æ¥æŠŠ docker ä»“åº“çš„ç”¨æˆ·åå’Œå¯†ç æš´éœ²ç»™åˆ«äººè¿™æ ·å¾ˆæ˜¾ç„¶æ˜¯éå¸¸éå¸¸ä¸å®‰å…¨çš„ï¼Œæ›´ä½•å†µæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ github çš„å…¬å…±ä»£ç ä»“åº“ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥ç›´æ¥çœ‹åˆ°æˆ‘ä»¬çš„æºç ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ç”¨ä¸€ç§æ–¹å¼æ¥éšè—ç”¨æˆ·åå’Œå¯†ç è¿™ç§ç§å¯†ä¿¡æ¯ï¼Œå¹¸è¿çš„æ˜¯ Jenkins ä¸ºæˆ‘ä»¬æä¾›äº†è§£å†³æ–¹æ³•ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨é¦–é¡µç‚¹å‡» Credentials -&gt; Stores scoped to Jenkins ä¸‹é¢çš„ Jenkins -&gt; Global credentials (å‡­æ®) -&gt;system(ç³»ç»Ÿ)-&gt;å…¨å±€å‡­æ® (unrestricted)-&gt; å·¦ä¾§çš„ Add Credentials( æ·»åŠ å‡­æ®)ï¼šæ·»åŠ ä¸€ä¸ª Username with password ç±»å‹çš„è®¤è¯ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š<br><img src="https://img.xxlaila.cn/374kdjfkskfdsd.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;Add Credentials è¾“å…¥ docker hub çš„ç”¨æˆ·åå’Œå¯†ç ï¼ŒID éƒ¨åˆ†æˆ‘ä»¬è¾“å…¥dockerHubï¼Œæ³¨æ„ï¼Œè¿™ä¸ªå€¼éå¸¸é‡è¦ï¼Œåœ¨åé¢ Pipeline çš„è„šæœ¬ä¸­æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ª ID å€¼ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†ä¸Šé¢çš„ docker hub çš„ç”¨æˆ·åå’Œå¯†ç çš„è®¤è¯ä¿¡æ¯ï¼Œç°åœ¨ä¿®æ”¹ Pipeline ä¸­çš„ç¬¬å››éƒ¨ï¼Œä½¿ç”¨è¿™é‡Œçš„ç”¨æˆ·åå’Œå¯†ç ï¼š</p><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">stage('Push') &#123;</span><br><span class="line">     echo <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">     <span class="keyword">with</span><span class="constructor">Credentials([<span class="params">usernamePassword</span>(<span class="params">credentialsId</span>: '<span class="params">dockerHub</span>', <span class="params">passwordVariable</span>: '<span class="params">dockerHubPassword</span>', <span class="params">usernameVariable</span>: '<span class="params">dockerHubUser</span>')</span>]) &#123;</span><br><span class="line">         sh <span class="string">"docker login -u $&#123;dockerHubUser&#125; -p $&#123;dockerHubPassword&#125;"</span></span><br><span class="line">         sh <span class="string">"docker push xxlaila/jenkins-demo:$&#123;build_tag&#125;"</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><blockquote><p><em>æ³¨æ„</em>:<br>&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è¿™é‡Œåœ¨ stage ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæ–°çš„å‡½æ•°withCredentialsï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªcredentialsIdå€¼å°±æ˜¯æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ ID å€¼ï¼Œç„¶åå°±å¯ä»¥åœ¨è„šæœ¬ä¸­ç›´æ¥ä½¿ç”¨è¿™é‡Œä¸¤ä¸ªå˜é‡å€¼æ¥ç›´æ¥æ›¿æ¢æ‰ä¹‹å‰çš„ç™»å½• docker hub çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿™æ ·æ“ä½œå°±ç›¸å¯¹æ¥è¯´å°±å¾ˆå®‰å…¨äº†ï¼Œåªæ˜¯ä¼ é€’è¿›å»äº†ä¸¤ä¸ªå˜é‡è€Œå·²ï¼Œåˆ«äººå¹¶ä¸çŸ¥é“çœŸæ­£ç”¨æˆ·åå’Œå¯†ç ï¼Œåªæœ‰æˆ‘ä»¬è‡ªå·±çš„ Jenkins å¹³å°ä¸Šæ·»åŠ çš„æ‰çŸ¥é“ã€‚<br><em>æµ‹è¯•ç»“æœ</em>:</p></blockquote><p><img src="https://img.xxlaila.cn/4ykjdbfjdshfkojdsl.png" alt="img"></p><ul><li>5ï¼‰ã€æ›´æ”¹ YAML<br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šé¢å·²ç»å®Œæˆäº†é•œåƒçš„æ‰“åŒ…ã€æ¨é€çš„å·¥ä½œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥æ›´æ–° Kubernetes ç³»ç»Ÿä¸­åº”ç”¨çš„é•œåƒç‰ˆæœ¬äº†ï¼Œå½“ç„¶ä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç”¨ YAML æ–‡ä»¶çš„å½¢å¼æ¥ç¼–å†™åº”ç”¨éƒ¨ç½²è§„åˆ™ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„ YAML æ–‡ä»¶ï¼š(k8s.yaml)<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cat k8s.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins-demo</span><br><span class="line"><span class="symbol">  namespace:</span> default</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      labels:</span></span><br><span class="line"><span class="symbol">        app:</span> jenkins-demo</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">      - image: xxlaila/jenkins-demo:<span class="params">&lt;BUILD_TAG&gt;</span></span><br><span class="line"><span class="symbol">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="symbol">        name:</span> jenkins-demo</span><br><span class="line"><span class="symbol">        env:</span></span><br><span class="line">        - name: branch</span><br><span class="line"><span class="symbol">          value:</span> <span class="params">&lt;BRANCH_NAME&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨ä¸€ä¸ª Deployment èµ„æºå¯¹è±¡æ¥ç®¡ç† Podï¼Œè¯¥ Pod ä½¿ç”¨çš„å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ¨é€çš„é•œåƒï¼Œå”¯ä¸€ä¸åŒçš„åœ°æ–¹æ˜¯ Docker é•œåƒçš„ tag ä¸æ˜¯æˆ‘ä»¬å¹³å¸¸è§çš„å…·ä½“çš„ tagï¼Œè€Œæ˜¯ä¸€ä¸ª çš„æ ‡è¯†ï¼Œå®é™…ä¸Šå¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªæ ‡è¯†æ›¿æ¢æˆä¸Šé¢çš„ Docker é•œåƒçš„ tagï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯æœ€ç»ˆæˆ‘ä»¬æœ¬æ¬¡æ„å»ºéœ€è¦ä½¿ç”¨åˆ°çš„é•œåƒï¼Ÿæ€ä¹ˆæ›¿æ¢å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªsedå‘½ä»¤å°±å¯ä»¥å®ç°äº†ï¼š</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'YAML'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">      sh <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>sed å‘½ä»¤å°±æ˜¯å°† k8s.yaml æ–‡ä»¶ä¸­çš„ æ ‡è¯†ç»™æ›¿æ¢æˆå˜é‡ build_tag çš„å€¼ã€‚</p></blockquote><ul><li>6ï¼‰ã€éƒ¨ç½²<br>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes åº”ç”¨çš„ YAML æ–‡ä»¶å·²ç»æ›´æ”¹å®Œæˆäº†ï¼Œä¹‹å‰æˆ‘ä»¬æ‰‹åŠ¨çš„ç¯å¢ƒä¸‹ï¼Œæ˜¯ä¸æ˜¯ç›´æ¥ä½¿ç”¨ kubectl apply å‘½ä»¤å°±å¯ä»¥ç›´æ¥æ›´æ–°åº”ç”¨ã€‚å½“ç„¶è¿™é‡Œåªæ˜¯å†™å…¥åˆ°äº† Pipeline é‡Œé¢ï¼Œæ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ï¼š</li></ul><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Deploy'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"6. Deploy Stage"</span></span><br><span class="line">      sh <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>ç‚¹å‡»jenkinsè¿›è¡Œæ„å»º<br><img src="https://img.xxlaila.cn/56hjkshdfdksnfkldsj.png" alt="img"></li></ul><blockquote><p>å½“ç„¶ï¼Œè¿™é‡Œéƒ¨ç½²å¤±è´¥ï¼Œå…ˆåˆ«ç®¡ï¼Œè¯æ˜æµç¨‹æ˜¯å¯¹çš„ï¼Œå¯ä»¥è¿™ä¹ˆèµ°</p></blockquote><p><img src="https://img.xxlaila.cn/3947dnfdsflskfjdsf.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;ä»¥ä¸Šçš„é…ç½®åŸºæœ¬å·²ç»å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬çš„å®é™…é¡¹ç›®å®è·µè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€äº›äººå·¥å¹²é¢„çš„æ­¥éª¤ï¼Œæ¯”å¦‚æˆ‘ä»¬æäº¤äº†ä¸€æ¬¡ä»£ç ï¼Œæµ‹è¯•ä¹Ÿé€šè¿‡äº†ï¼Œé•œåƒä¹Ÿæ‰“åŒ…ä¸Šä¼ äº†ï¼Œä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬å¹¶ä¸ä¸€å®šå°±æ˜¯è¦ç«‹åˆ»ä¸Šçº¿åˆ°ç”Ÿäº§ç¯å¢ƒçš„ã€‚æˆ‘ä»¬å¯èƒ½éœ€è¦å°†è¯¥ç‰ˆæœ¬å…ˆå‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒã€QA ç¯å¢ƒã€æˆ–è€…é¢„è§ˆç¯å¢ƒä¹‹ç±»çš„ï¼Œæ€»ä¹‹ç›´æ¥å°±å‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒå»è¿˜æ˜¯æŒºå°‘è§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¢åŠ äººå·¥ç¡®è®¤çš„ç¯èŠ‚ï¼Œä¸€èˆ¬éƒ½æ˜¯åœ¨ CD çš„ç¯èŠ‚æ‰éœ€è¦äººå·¥å¹²é¢„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„æœ€åä¸¤æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å‰é¢åŠ ä¸Šç¡®è®¤ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">stage(<span class="string">'YAML'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"5. Change YAML File Stage"</span></span><br><span class="line">      def userInput = <span class="built_in">input</span>(</span><br><span class="line">          id: <span class="string">'userInput'</span>,</span><br><span class="line">          message: <span class="string">'Choose a deploy environment'</span>,</span><br><span class="line">          parameter<span class="variable">s:</span> [</span><br><span class="line">              [</span><br><span class="line">                  #clas<span class="variable">s:</span> <span class="string">'ChoiceParameterDefinition'</span>,</span><br><span class="line">                  choice<span class="variable">s:</span> <span class="string">"Dev\nTest\nUat\nDemo\nPord"</span>,</span><br><span class="line">                  name: <span class="string">'Env'</span></span><br><span class="line">                  ]</span><br><span class="line">              ]</span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">"This is a deploy step to $&#123;userInput.Env&#125;"</span></span><br><span class="line">          <span class="keyword">sh</span> <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä½¿ç”¨äº† input å…³é”®å­—ï¼Œé‡Œé¢ä½¿ç”¨ä¸€ä¸ª Choice çš„åˆ—è¡¨æ¥è®©ç”¨æˆ·è¿›è¡Œé€‰æ‹©ï¼Œç„¶ååœ¨æˆ‘ä»¬é€‰æ‹©äº†éƒ¨ç½²ç¯å¢ƒåï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿå¯ä»¥é’ˆå¯¹ä¸åŒçš„ç¯å¢ƒå†åšä¸€äº›æ“ä½œï¼Œæ¯”å¦‚å¯ä»¥ç»™ä¸åŒç¯å¢ƒçš„ YAML æ–‡ä»¶éƒ¨ç½²åˆ°ä¸åŒçš„ namespace ä¸‹é¢å»ï¼Œå¢åŠ ä¸åŒçš„æ ‡ç­¾ç­‰ç­‰æ“ä½œï¼š</p><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">stage</span><span class="params">(<span class="string">'Deploy'</span>)</span></span> &#123;</span><br><span class="line">      echo <span class="string">"6. Deploy Stage"</span></span><br><span class="line">      <span class="keyword">if</span> (userInput<span class="selector-class">.Env</span> == <span class="string">"Dev"</span>)&#123;</span><br><span class="line">          <span class="comment">// deploy dev stuff</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userInput<span class="selector-class">.Env</span> == <span class="string">"Test"</span>)&#123;</span><br><span class="line">          <span class="comment">// deploy test stuff</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// deploy prod stuff</span></span><br><span class="line">      &#125;</span><br><span class="line">      sh <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸€æ­¥ä¹Ÿå±äºéƒ¨ç½²çš„èŒƒç•´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æœ€åä¸¤æ­¥éƒ½åˆå¹¶æˆä¸€æ­¥ï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ Pipeline è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">node(<span class="string">'node-jnlp'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">        git ur<span class="variable">l:</span> <span class="string">"https://github.com/xxlaila/jenkins-demo.git"</span></span><br><span class="line">        script &#123;</span><br><span class="line">            build_tag = <span class="keyword">sh</span>(returnStdou<span class="variable">t:</span> true, <span class="keyword">scrip</span><span class="variable">t:</span> <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"docker build -t xxlaila/jenkins-demo:$&#123;build_tag&#125; ."</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">        withCredentials([usernamePassword(credentialsId: <span class="string">'dockerHub'</span>, passwordVariable: <span class="string">'dockerHubPassword'</span>, usernameVariable: <span class="string">'dockerHubUser'</span>)]) &#123;</span><br><span class="line">            <span class="keyword">sh</span> <span class="string">"docker login -u $&#123;dockerHubUser&#125; -p $&#123;dockerHubPassword&#125;"</span></span><br><span class="line">            <span class="keyword">sh</span> <span class="string">"docker push cnych/jenkins-demo:$&#123;build_tag&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"5. Deploy Stage"</span></span><br><span class="line">        def userInput = <span class="built_in">input</span>(</span><br><span class="line">            id: <span class="string">'userInput'</span>,</span><br><span class="line">            message: <span class="string">'Choose a deploy environment'</span>,</span><br><span class="line">            parameter<span class="variable">s:</span> [</span><br><span class="line">                [</span><br><span class="line">                    $clas<span class="variable">s:</span> <span class="string">'ChoiceParameterDefinition'</span>,</span><br><span class="line">                    choice<span class="variable">s:</span> <span class="string">"Dev\nQA\nProd"</span>,</span><br><span class="line">                    name: <span class="string">'Env'</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"This is a deploy step to $&#123;userInput&#125;"</span></span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/$&#123;build_tag&#125;/' k8s.yaml"</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">"Dev"</span>) &#123;</span><br><span class="line">            // deploy dev stuff</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userInput == <span class="string">"QA"</span>)&#123;</span><br><span class="line">            // deploy <span class="keyword">qa</span> stuff</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            // deploy prod stuff</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">sh</span> <span class="string">"kubectl apply -f k8s.yaml"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>é”™è¯¯</em>: åœ¨jenkinsæ‰§è¡Œæ„å»ºçš„æ—¶å€™æç¤º:</p><p><img src="https://img.xxlaila.cn/2846djkfhklsdjdklsd.png" alt="img"></p><blockquote><p>æ²¡æœ‰æƒé™è¿›è¡Œéƒ¨ç½²ï¼Œä¸‹é¢è¿›è¡Œæƒé™çš„åˆ†é…ã€‚</p></blockquote><ul><li><p>æŸ¥çœ‹kube-ops ä¸‹é¢çš„è§’è‰²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role -n kube-ops</span></span><br><span class="line">NAME       AGE</span><br><span class="line">jenkins2   2d6h</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹roleå®šä¹‰çš„èµ„æºæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get role jenkins2 -n kube-ops -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2019-01-14T03:07:25Z"</span></span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  resourceVersion: <span class="string">"2389179"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/kube-ops/roles/jenkins2</span><br><span class="line">  uid: 84762132-17a9-11e9-8991-fa163e14c5bd</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">exec</span></span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - patch</span><br><span class="line">  - update</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods/<span class="built_in">log</span></span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºjenkins2çš„æƒé™</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">[<span class="symbol">root@</span>k8s-zxc-test<span class="number">-3</span> ~]# kubectl -n kube-system create sa jenkins2</span><br><span class="line">serviceaccount/jenkins2 created</span><br></pre></td></tr></table></figure></li><li><p>æˆæƒè®¿é—®</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">[root@k8s-zxc-test<span class="number">-3</span> ~]# kubectl <span class="built_in">create</span> clusterrolebinding jenkins2 <span class="comment">--clusterrole cluster-admin --serviceaccount=kube-ops:jenkins2</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/jenkins2 created</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>zabbixä¼ä¸šå¾®ä¿¡å‘Šè­¦</title>
    <url>/2019/08/20/zabbix%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Zabbixå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼æŠŠå‘Šè­¦ä¿¡æ¯å‘é€åˆ°æŒ‡å®šäººï¼Œå¸¸ç”¨çš„æœ‰é‚®ä»¶ï¼ŒçŸ­ä¿¡æŠ¥è­¦æ–¹å¼ï¼Œä½†æ˜¯è¶Šæ¥è¶Šå¤šçš„ä¼ä¸šå¼€å§‹ä½¿ç”¨zabbixç»“åˆå¾®ä¿¡ä½œä¸ºä¸»è¦çš„å‘Šè­¦æ–¹å¼ï¼Œè¿™æ ·å¯ä»¥åŠæ—¶æœ‰æ•ˆçš„æŠŠå‘Šè­¦ä¿¡æ¯æ¨é€åˆ°æ¥æ”¶äººï¼Œæ–¹ä¾¿å‘Šè­¦çš„åŠæ—¶å¤„ç†ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;å¾®ä¿¡ä¼ä¸šå·éœ€è¦å…ˆåœ¨ä¼ä¸šé€šä¿¡å½•æ–°å»ºè¯¥å‘˜å·¥ï¼Œè¯¥å‘˜å·¥æ‰èƒ½å…³æ³¨è¯¥ä¼ä¸šå·ï¼Œè¿™æ ·å°±èƒ½å®ç°å‘Šè­¦ä¿¡æ¯çš„ç§å¯†æ€§ã€‚å¦‚æœä½¿ç”¨å…¬ä¼—å·ï¼Œåˆ™åªè¦æ‰€æœ‰å…³æ³¨äº†è¯¥å…¬ä¼—å·çš„äººéƒ½èƒ½æ”¶åˆ°å‘Šè­¦æ¶ˆæ¯ï¼Œå®¹æ˜“é€ æˆä¿¡æ¯æ³„éœ²ã€‚è€Œä¸”å‘˜å·¥æ•°å°‘äº200äººçš„ä¼ä¸šå·æ˜¯ä¸ç”¨é’±çš„ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ç”³è¯·é™åˆ¶.</p><h3 id="1ã€è„šæœ¬å­˜æ”¾ç›®å½•"><a href="#1ã€è„šæœ¬å­˜æ”¾ç›®å½•" class="headerlink" title="1ã€è„šæœ¬å­˜æ”¾ç›®å½•"></a>1ã€è„šæœ¬å­˜æ”¾ç›®å½•</h3><p>/usr/lib/zabbix/alertscriptsï¼Œè„šæœ¬çš„æƒé™æ˜¯zabbix è´¦æˆ·ï¼Œå…·æœ‰å¯æ‰§è¡Œæƒé™</p><a id="more"></a><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat wechat.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/python2.7</span></span><br><span class="line"><span class="comment">#_*_coding:utf-8 _*_</span></span><br><span class="line"><span class="built_in">import</span> requests,sys,json</span><br><span class="line"><span class="built_in">import</span> urllib3</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding('utf-<span class="number">8</span>')</span><br><span class="line">def GetToken(Corpid,Secret):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/gettoken"</span></span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"corpid"</span>:Corpid,</span><br><span class="line">        <span class="string">"corpsecret"</span>:Secret</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.get(<span class="attr">url=Url,params=Data,verify=False)</span></span><br><span class="line">    <span class="attr">Token</span> = r.json()['access_token']</span><br><span class="line">    return Token</span><br><span class="line">def SendMessage(Token,User,Agentid,Subject,Content):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s"</span> % Token</span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"touser"</span>: User,                                 <span class="comment"># ä¼ä¸šå·ä¸­çš„ç”¨æˆ·å¸å·ï¼Œåœ¨zabbixç”¨æˆ·Mediaä¸­é…ç½®ï¼Œå¦‚æœé…ç½®ä¸æ­£å¸¸ï¼Œå°†æŒ‰éƒ¨é—¨å‘é€ã€‚</span></span><br><span class="line">        <span class="comment">#"totag": Tagid,                                # ä¼ä¸šå·ä¸­çš„æ ‡ç­¾idï¼Œç¾¤å‘ä½¿ç”¨ï¼ˆæ¨èï¼‰</span></span><br><span class="line">        <span class="string">"toparty"</span>: <span class="string">"2"</span>,                            <span class="comment"># ä¼ä¸šå·ä¸­çš„éƒ¨é—¨idï¼Œç¾¤å‘æ—¶ä½¿ç”¨ã€‚</span></span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,                              <span class="comment"># æ¶ˆæ¯ç±»å‹ã€‚</span></span><br><span class="line">        <span class="string">"agentid"</span>: Agentid,                             <span class="comment"># ä¼ä¸šå·ä¸­çš„åº”ç”¨idã€‚</span></span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: Subject + '\n' + Content</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"safe"</span>: <span class="string">"0"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.post(<span class="attr">url=Url,data=json.dumps(Data),verify=False)</span></span><br><span class="line">    return r.text</span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == '__main__':</span><br><span class="line">    <span class="attr">User</span> = sys.argv[<span class="number">1</span>]                                                              <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Subject</span> = sys.argv[<span class="number">2</span>]                                                           <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Content</span> = sys.argv[<span class="number">3</span>]                                                           <span class="comment"># zabbixä¼ è¿‡æ¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="attr">Corpid</span> = <span class="string">"wwa9c9999"</span>                                                   <span class="comment"># CorpIDæ˜¯ä¼ä¸šå·çš„æ ‡è¯†</span></span><br><span class="line">    <span class="attr">Secret</span> = <span class="string">"VGbZvXJ5RiLskdksh2dkhaskdu92uihsjdhjksadh"</span>     <span class="comment"># Secretæ˜¯ç®¡ç†ç»„å‡­è¯å¯†é’¥</span></span><br><span class="line">    <span class="comment">#Tagid = "1"                                                                     # é€šè®¯å½•æ ‡ç­¾ID</span></span><br><span class="line">    <span class="attr">Agentid</span> = <span class="string">"1000001"</span>                                                                   <span class="comment"># åº”ç”¨ID</span></span><br><span class="line">    <span class="comment">#Partyid = "1"                                                                  # éƒ¨é—¨ID</span></span><br><span class="line">    <span class="attr">Token</span> = GetToken(Corpid, Secret)</span><br><span class="line">    <span class="attr">Status</span> = SendMessage(Token,User,Agentid,Subject,Content)</span><br><span class="line">    print Status</span><br></pre></td></tr></table></figure><h3 id="2ã€é‡è¦å‚æ•°ä»‹ç»"><a href="#2ã€é‡è¦å‚æ•°ä»‹ç»" class="headerlink" title="2ã€é‡è¦å‚æ•°ä»‹ç»"></a>2ã€é‡è¦å‚æ•°ä»‹ç»</h3><ul><li>topartyï¼šâ€2â€ è¿™ä¸ªå‚æ•°æ˜¯åœ¨ä¼ä¸šå¾®ä¿¡é‡Œé¢éƒ¨é—¨çš„id</li><li>Corpidï¼šä¼ä¸šçš„CorpIDæ ‡ç¤º</li><li>Secretï¼šç®¡ç†ç»„çš„å¯†é’¥å‡­è¯</li><li>Agentidï¼šæ–°å»ºåº”ç”¨çš„id</li><li>åªéœ€è¦æ±‚ä¿®æ”¹ä»¥ä¸Šå‚æ•°å³å¯</li></ul><p><img src="https://img.xxlaila.cn/image2018-8-23_16-8-30.png" alt="img"></p><ul><li>ä»¥ä¸Šéƒ¨é—¨æ²¡æœ‰æ–°å»ºï¼Œåªæ˜¯åœ¨è¿™ä¸ªåº”ç”¨ä¸­æ–°å¢åŠ äº†å‡ ä¸ªç”¨æˆ·ã€‚æœ€å¥½çš„æ–¹å¼æ˜¯å¢åŠ ä¸€ä¸ªéƒ¨é—¨ç»„ï¼Œç”¨æˆ·æ·»åŠ åˆ°éƒ¨é—¨ç»„é‡Œé¢ï¼Œè¿™ç§æ–¹å¼æœ€ç§‘å­¦</li></ul><h3 id="3ã€ç™»é™†zabbix-è¿›è¡Œé…ç½®"><a href="#3ã€ç™»é™†zabbix-è¿›è¡Œé…ç½®" class="headerlink" title="3ã€ç™»é™†zabbix è¿›è¡Œé…ç½®"></a>3ã€ç™»é™†zabbix è¿›è¡Œé…ç½®</h3><h4 id="3-1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹"><a href="#3-1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹" class="headerlink" title="3.1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹"></a>3.1ã€åˆ›å»ºä¸€ä¸ªåª’ä»‹ç±»å‹</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-11-59.png" alt="img"></p><h4 id="3-2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«"><a href="#3-2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«" class="headerlink" title="3.2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«"></a>3.2ã€åˆ›å»ºä¸€ä¸ªå‘Šè­¦ç±»åˆ«</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-12-53.png" alt="img"><br><img src="https://img.xxlaila.cn/image2018-8-23_16-13-9.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}å‘ç”Ÿ: {TRIGGER.NAME}æ•…éšœ!</p><p>å‘Šè­¦ä¸»æœº:{HOST.NAME}<br>å‘Šè­¦åœ°å€:{HOST.IP}<br>ç›‘æ§é¡¹ç›®:{ITEM.NAME}<br>ç›‘æ§å–å€¼:{ITEM.LASTVALUE}<br>å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY}<br>å½“å‰çŠ¶æ€:{TRIGGER.STATUS}<br>å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME}<br>å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME}<br>äº‹ä»¶ID:{EVENT.ID}</p></blockquote><p><img src="https://img.xxlaila.cn/image2018-8-23_16-13-20.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}: {TRIGGER.NAME}å·²æ¢å¤!</p><p>å‘Šè­¦ä¸»æœº:{HOST.NAME}<br>å‘Šè­¦åœ°å€:{HOST.IP}<br>ç›‘æ§é¡¹ç›®:{ITEM.NAME}<br>ç›‘æ§å–å€¼:{ITEM.LASTVALUE}<br>å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY}<br>å½“å‰çŠ¶æ€:{TRIGGER.STATUS}<br>å‘Šè­¦ä¿¡æ¯:{TRIGGER.NAME}<br>å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME}<br>æ¢å¤æ—¶é—´:{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}<br>æŒç»­æ—¶é—´:{EVENT.AGE}<br>äº‹ä»¶ID:{EVENT.ID}</p></blockquote><p><img src="https://img.xxlaila.cn/image2018-8-23_16-13-28.png" alt="img"></p><blockquote><p>æœåŠ¡å™¨:{HOST.NAME}: æŠ¥è­¦ç¡®è®¤</p><p>ç¡®è®¤äºº:{USER.FULLNAME}<br>æ—¶é—´:{ACK.DATE} {ACK.TIME}<br>ç¡®è®¤ä¿¡æ¯å¦‚ä¸‹:<br>â€œ{ACK.MESSAGE}â€<br>é—®é¢˜æœåŠ¡å™¨IP:{HOSTNAME1}<br>é—®é¢˜ID:{EVENT.ID}<br>å½“å‰çš„é—®é¢˜æ˜¯: {TRIGGER.NAME}</p></blockquote><h4 id="3-3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹"><a href="#3-3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹" class="headerlink" title="3.3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹"></a>3.3ã€ä¸ºç”¨æˆ·æ·»åŠ å‘Šè­¦ç±»å‹</h4><p><img src="https://img.xxlaila.cn/image2018-8-23_16-21-58.png" alt="img"><br>è¿™é‡Œä¸ºadminç”¨æˆ·æ·»åŠ çš„ å‘Šè­¦æ–¹å¼ã€‚æ³¨æ„ä¸€ä¸‹send to è¿™ä¸ªå‚æ•°ï¼Œè¿™é‡Œä¸€å®šè¦æ˜¯@allã€‚å¦åˆ™ä¸æˆåŠŸ</p><h3 id="4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•"><a href="#4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•" class="headerlink" title="4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•"></a>4ã€ä¼ä¸šå¾®ä¿¡æµ‹è¯•</h3><p><img src="https://img.xxlaila.cn/image2018-8-23_16-23-14.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
      </tags>
  </entry>
  <entry>
    <title>å¸§ä¸­ç»§é…ç½®</title>
    <url>/2019/08/19/%E5%B8%A7%E4%B8%AD%E7%BB%A7%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h3 id="ç‚¹å¯¹ç‚¹é…ç½®"><a href="#ç‚¹å¯¹ç‚¹é…ç½®" class="headerlink" title="ç‚¹å¯¹ç‚¹é…ç½®"></a>ç‚¹å¯¹ç‚¹é…ç½®</h3><p><img src="https://img.xxlaila.cn/1566222269423.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">102</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li></ul><a id="more"></a><ul><li>FRAME-RELAYé…ç½®:<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching                 å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>pvc 201<span class="built_in"> interface </span>s0/0 102    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰"><a href="#ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰" class="headerlink" title="ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰"></a>ç‚¹å¯¹å¤šç‚¹ï¼ˆæ˜Ÿå½¢ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222529208.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">102</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">103</span>                 </span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">103</span>  </span><br><span class="line">[RA-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>     é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>] encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCI</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">301</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">301</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching      å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰"><a href="#ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰" class="headerlink" title="ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰"></a>ç‚¹å¯¹å¤šç‚¹å­æ¥å£ï¼ˆæ˜Ÿå½¢ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222807499.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span></span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA]int s0/<span class="number">0.1</span> multipoint</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">102</span>     è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">103</span>                 </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">103</span>  </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">201</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RB-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay interface-dlci <span class="number">301</span>       è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·</span><br><span class="line">[RC-s0/<span class="number">0</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">301</span>  å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.3</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>    é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                    æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching    å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103   é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰"><a href="#ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰" class="headerlink" title="ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰"></a>ç‚¹å¯¹ç‚¹å­æ¥å£ï¼ˆå…¨ç½‘çŠ¶ï¼‰</h3><p><img src="https://img.xxlaila.cn/1566222918549.jpg" alt="img"></p><ul><li><p>RAé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RA]int s0/<span class="number">0</span> </span><br><span class="line">[RA-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RA-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RA-s0/<span class="number">0</span>]no sh               æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RA]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">102</span>        è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·              </span><br><span class="line">[RA-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">102</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br><span class="line">[RA]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RA-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">103</span>        è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·              </span><br><span class="line">[RA-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">103</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RA-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.2</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>    é…ç½®æœ¬å­æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RBé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RB]int s0/<span class="number">0</span></span><br><span class="line">[RB-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RB-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RB-s0/<span class="number">0</span>]no sh                   æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RB]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RB-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">201</span>     è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·             </span><br><span class="line">[RB-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">201</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.1</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>     é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RB]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RB-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">203</span>      è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·             </span><br><span class="line">[RB-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span> <span class="number">203</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RB-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.3</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>RCé…ç½®:</p><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">[RC]int s0/<span class="number">0</span></span><br><span class="line">[RC-s0/<span class="number">0</span>]encap frame-relay     å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[RC-s0/<span class="number">0</span>] frame-relay intf dte</span><br><span class="line">[RC-s0/<span class="number">0</span>]no sh                     æ‰“å¼€æ­¤ç‰©ç†æ¥å£</span><br><span class="line">[RC]int s0/<span class="number">0.1</span> point-to-point</span><br><span class="line">[RC-s0/<span class="number">0.1</span>]frame-relay interface-dlci <span class="number">301</span>         è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·                </span><br><span class="line">[RC-s0/<span class="number">0.1</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.3</span><span class="number">.1</span> <span class="number">301</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0.1</span>]ip add <span class="number">172.16</span><span class="number">.3</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>       é…ç½®æœ¬æ¥å£IPåœ°å€</span><br><span class="line">[RC]int s0/<span class="number">0.2</span> point-to-point</span><br><span class="line">[RC-s0/<span class="number">0.2</span>]frame-relay interface-dlci <span class="number">302</span>         è®¾ç½®æœ¬æ¥å£å¯¹åº”çš„INTERFACE-DLCIå·                </span><br><span class="line">[RC-s0/<span class="number">0.2</span>]frame-relay map ip <span class="number">172.16</span><span class="number">.2</span><span class="number">.1</span> <span class="number">302</span> å»ºç«‹å¯¹ç«¯åè®®åœ°å€ä¸æœ¬åœ°INTERFACE-DLCIå·çš„æ˜ å°„å…³ç³»</span><br><span class="line">[RC-s0/<span class="number">0.2</span>]ip add <span class="number">172.16</span><span class="number">.2</span><span class="number">.2</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>        é…ç½®æœ¬æ¥å£IPåœ°å€</span><br></pre></td></tr></table></figure></li><li><p>FRAME-RELAYé…ç½®:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[FRAME-RELAY]frame-relay switching                 å…è®¸å¸§ä¸­ç»§è¿›è¡ŒPVCäº¤æ¢</span><br><span class="line">[FRAME-RELAY]int s0/0</span><br><span class="line">[FRAME-RELAY-s0/0]encap frame-relay    å°è£…å¸§ä¸­ç»§åè®® </span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/0]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>102<span class="built_in"> interface </span>s0/1 201     é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/0]frame-relay<span class="built_in"> route </span>103<span class="built_in"> interface </span>s0/2 301     é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/1</span><br><span class="line">[FRAME-RELAY-s0/1]encap frame-relay           å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/1]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>201<span class="built_in"> interface </span>s0/0 102    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/1]frame-relay<span class="built_in"> route </span>pvc 203<span class="built_in"> interface </span>s0/0 302    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY]int s0/2</span><br><span class="line">[FRAME-RELAY-s0/2]encap frame-relay           å°è£…å¸§ä¸­ç»§åè®®</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay intf dce        è®¾ç½®å¸§ä¸­ç»§æ¥å£ç±»å‹ä¸ºDCEç«¯</span><br><span class="line">[FRAME-RELAY-s0/2]clock rate 630100            è®¾ç½®DCEæ—¶é’Ÿé¢‘ç‡</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>301<span class="built_in"> interface </span>s0/0 103    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br><span class="line">[FRAME-RELAY-s0/2]frame-relay<span class="built_in"> route </span>302<span class="built_in"> interface </span>s0/0 203    é…ç½®å¸§ä¸­ç»§PVCäº¤æ¢è·¯ç”±</span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>ç½‘ç»œè®¾å¤‡</category>
      </categories>
      <tags>
        <tag>å¸§ä¸­ç»§</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes ci/cd(ä¸€)</title>
    <url>/2019/08/12/kubernetes-ci-cd-%E4%B8%80/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><blockquote><p>åŸºäºjenkinsçš„CI/CDå®‰è£…</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jenkinsä¸€ä¸ªæµè¡Œçš„æŒç»­é›†æˆ/å‘å¸ƒå·¥å…·ï¼Œåœ¨Kubernetesä½¿ç”¨,æŒç»­æ„å»ºä¸å‘å¸ƒæ˜¯æˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ­¥éª¤ï¼Œç›®å‰å¤§å¤šå…¬å¸éƒ½é‡‡ç”¨ Jenkins é›†ç¾¤æ¥æ­å»ºç¬¦åˆéœ€æ±‚çš„ CI/CD æµç¨‹ï¼Œç„¶è€Œä¼ ç»Ÿçš„ Jenkins Slave ä¸€ä¸»å¤šä»æ–¹å¼ä¼šå­˜åœ¨ä¸€äº›ç—›ç‚¹ï¼Œæ¯”å¦‚ï¼šä¸» Master å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ï¼Œæ•´ä¸ªæµç¨‹éƒ½ä¸å¯ç”¨äº†ï¼›æ¯ä¸ª Slave çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²ï¼›èµ„æºåˆ†é…ä¸å‡è¡¡ï¼Œæœ‰çš„ Slave è¦è¿è¡Œçš„ job å‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„ Slave å¤„äºç©ºé—²çŠ¶æ€ï¼›æœ€åèµ„æºæœ‰æµªè´¹ï¼Œæ¯å° Slave å¯èƒ½æ˜¯å®ä½“æœºæˆ–è€… VMï¼Œå½“ Slave å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æºã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æåˆ°åŸºäºKuberneteçš„CI/CDï¼Œå¯ä»¥ä½¿ç”¨çš„å·¥å…·æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚Jenkinsã€Gitlab CIå·²ç»æ–°å…´çš„droneä¹‹ç±»çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä¼šä½¿ç”¨å¤§å®¶æœ€ä¸ºç†Ÿæ‚‰çš„Jeninsæ¥åšCI/CDçš„å·¥å…·ã€‚</p><ul><li>ä¼˜ç‚¹:<ul><li>Jenkins å®‰è£…å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸ç”¨æ€¥ç€å°±å»ä½¿ç”¨ï¼Œæˆ‘ä»¬è¦äº†è§£ä¸‹åœ¨ Kubernetes ç¯å¢ƒä¸‹é¢ä½¿ç”¨ Jenkins æœ‰ä»€ä¹ˆå¥½å¤„ã€‚éƒ½çŸ¥é“æŒç»­æ„å»ºä¸å‘å¸ƒæ˜¯æˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ­¥éª¤ï¼Œç›®å‰å¤§å¤šå…¬å¸éƒ½é‡‡ç”¨ Jenkins é›†ç¾¤æ¥æ­å»ºç¬¦åˆéœ€æ±‚çš„ CI/CD æµç¨‹ï¼Œç„¶è€Œä¼ ç»Ÿçš„ Jenkins Slave ä¸€ä¸»å¤šä»æ–¹å¼ä¼šå­˜åœ¨ä¸€äº›ç—›ç‚¹ï¼Œæ¯”å¦‚:<ul><li>E ä¸» Master å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ï¼Œæ•´ä¸ªæµç¨‹éƒ½ä¸å¯ç”¨äº†ã€‚</li><li>E æ¯ä¸ª Slave çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²ã€‚</li><li>E èµ„æºåˆ†é…ä¸å‡è¡¡ï¼Œæœ‰çš„ Slave è¦è¿è¡Œçš„ job å‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„ Slave å¤„äºç©ºé—²çŠ¶æ€ã€‚</li><li>E èµ„æºæœ‰æµªè´¹ï¼Œæ¯å° Slave å¯èƒ½æ˜¯ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºï¼Œå½“ Slave å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æºã€‚</li></ul></li><li>æ­£å› ä¸ºè¿™äº›ç§ç§ç—›ç‚¹ï¼Œæˆ‘ä»¬æ¸´æœ›ä¸€ç§æ›´é«˜æ•ˆæ›´å¯é çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ª CI/CD æµç¨‹ï¼Œè€Œ Docker è™šæ‹ŸåŒ–å®¹å™¨æŠ€æœ¯èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªç—›ç‚¹ï¼Œåˆç‰¹åˆ«æ˜¯åœ¨ Kubernetes é›†ç¾¤ç¯å¢ƒä¸‹é¢èƒ½å¤Ÿæ›´å¥½æ¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä¸‹å›¾æ˜¯åŸºäº Kubernetes æ­å»º Jenkins é›†ç¾¤çš„ç®€å•ç¤ºæ„å›¾<br><img src="https://img.xxlaila.cn/xjfhs84we.png" alt="img"></li></ul></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ° Jenkins Master å’Œ Jenkins Slave ä»¥ Pod å½¢å¼è¿è¡Œåœ¨ Kubernetes é›†ç¾¤çš„ Node ä¸Šï¼ŒMaster è¿è¡Œåœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†å…¶é…ç½®æ•°æ®å­˜å‚¨åˆ°ä¸€ä¸ª Volume ä¸Šå»ï¼ŒSlave è¿è¡Œåœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”å®ƒä¸æ˜¯ä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå®ƒä¼šæŒ‰ç…§éœ€æ±‚åŠ¨æ€çš„åˆ›å»ºå¹¶è‡ªåŠ¨åˆ é™¤ã€‚</p><a id="more"></a><ul><li>è¿™ç§æ–¹å¼çš„å·¥ä½œæµç¨‹å¤§è‡´ä¸º<ul><li>å½“ Jenkins Master æ¥å—åˆ° Build è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®é…ç½®çš„ Label åŠ¨æ€åˆ›å»ºä¸€ä¸ªè¿è¡Œåœ¨ Pod ä¸­çš„ Jenkins Slave å¹¶æ³¨å†Œåˆ° Master ä¸Šï¼Œå½“è¿è¡Œå®Œ Job åï¼Œè¿™ä¸ª Slave ä¼šè¢«æ³¨é”€å¹¶ä¸”è¿™ä¸ª Pod ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤ï¼Œæ¢å¤åˆ°æœ€åˆçŠ¶æ€ã€‚é‚£ä¹ˆä½¿ç”¨è¿™ç§æ–¹å¼å¸¦æ¥äº†å“ªäº›å¥½å¤„å‘¢ï¼Ÿ</li><li>E æœåŠ¡é«˜å¯ç”¨ï¼Œå½“ Jenkins Master å‡ºç°æ•…éšœæ—¶ï¼ŒKubernetes ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Jenkins Master å®¹å™¨ï¼Œå¹¶ä¸”å°† Volume åˆ†é…ç»™æ–°åˆ›å»ºçš„å®¹å™¨ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä»è€Œè¾¾åˆ°é›†ç¾¤æœåŠ¡é«˜å¯ç”¨ã€‚</li><li>E åŠ¨æ€ä¼¸ç¼©ï¼Œåˆç†ä½¿ç”¨èµ„æºï¼Œæ¯æ¬¡è¿è¡Œ Job æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Jenkins Slaveï¼ŒJob å®Œæˆåï¼ŒSlave è‡ªåŠ¨æ³¨é”€å¹¶åˆ é™¤å®¹å™¨ï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸” Kubernetes ä¼šæ ¹æ®æ¯ä¸ªèµ„æºçš„ä½¿ç”¨æƒ…å†µï¼ŒåŠ¨æ€åˆ†é… Slave åˆ°ç©ºé—²çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œé™ä½å‡ºç°å› æŸèŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œè¿˜æ’é˜Ÿç­‰å¾…åœ¨è¯¥èŠ‚ç‚¹çš„æƒ…å†µã€‚</li><li>E æ‰©å±•æ€§å¥½ï¼Œå½“ Kubernetes é›†ç¾¤çš„èµ„æºä¸¥é‡ä¸è¶³è€Œå¯¼è‡´ Job æ’é˜Ÿç­‰å¾…æ—¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„æ·»åŠ ä¸€ä¸ª Kubernetes Node åˆ°é›†ç¾¤ä¸­ï¼Œä»è€Œå®ç°æ‰©å±•ã€‚</li></ul></li></ul><h2 id="1ã€å®‰è£…jenkins"><a href="#1ã€å®‰è£…jenkins" class="headerlink" title="1ã€å®‰è£…jenkins"></a>1ã€å®‰è£…jenkins</h2><h3 id="1-1ã€æ–°å»ºä¸€ä¸ª-Deployment"><a href="#1-1ã€æ–°å»ºä¸€ä¸ª-Deployment" class="headerlink" title="1.1ã€æ–°å»ºä¸€ä¸ª Deployment"></a>1.1ã€æ–°å»ºä¸€ä¸ª Deployment</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#cat  jenkins-deployment.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">jenkins/jenkins:lts</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">512</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">          subPath:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LIMITS_MEMORY</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">limits.memory</span></span><br><span class="line"><span class="attr">              divisor:</span> <span class="number">1</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="bullet">-Xmx$(LIMITS_MEMORY)m</span> <span class="attr">-XshowSettings:vm</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.initialDelay=0</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN=50</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN0=0.85</span> <span class="bullet">-Duser.timezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">        persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">          claimName:</span> <span class="string">opspvc</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30002</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">agent</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å¯¹è±¡èµ„æºéƒ½æ”¾ç½®åœ¨ä¸€ä¸ªåä¸º kube-ops çš„ namespace ä¸‹é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ åˆ›å»ºä¸€ä¸ª namespace,namespace è¯·å‚è€ƒnamspaceç« èŠ‚çš„å…·ä½“ä»‹ç»</p><figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line"># kubectl <span class="keyword">create</span> <span class="keyword">namespace</span> kube-ops</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œä½¿ç”¨ä¸€ä¸ªåä¸º jenkins/jenkins:lts çš„å®˜æ–¹é•œåƒï¼Œè¿™æ˜¯ jenkins å®˜æ–¹çš„ Docker é•œåƒï¼Œç„¶åä¹Ÿæœ‰ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å®šåˆ¶ä¸€ä¸ªé•œåƒï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å°†ä¸€äº›æ’ä»¶æ‰“åŒ…åœ¨è‡ªå®šä¹‰çš„é•œåƒå½“ä¸­ï¼Œ<a href="https://github.com/jenkinsci/docker" target="_blank" rel="noopener">å¯ä»¥å‚è€ƒæ–‡æ¡£</a>ã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨é»˜è®¤çš„å®˜æ–¹é•œåƒå°±è¡Œï¼Œå¦å¤–ä¸€ä¸ªè¿˜éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å°†å®¹å™¨çš„ /var/jenkins_home ç›®å½•æŒ‚è½½åˆ°äº†ä¸€ä¸ªåä¸º opspvc çš„ PVC å¯¹è±¡ä¸Šé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ ·è¿˜å¾—æå‰åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ PVC å¯¹è±¡ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ä»¬å‰é¢çš„ StorageClass å¯¹è±¡æ¥è‡ªåŠ¨åˆ›å»ºï¼š(jenkins-pvc.yaml)</p><h3 id="1-2-Jenkins-StorageClass-åˆ›å»º"><a href="#1-2-Jenkins-StorageClass-åˆ›å»º" class="headerlink" title="1.2 Jenkins StorageClass åˆ›å»º"></a>1.2 Jenkins StorageClass åˆ›å»º</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">opspv</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">172.21</span><span class="number">.16</span><span class="number">.231</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/jenkins</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">opspvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">storage:</span> <span class="number">20</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºpvcå¯¹è±¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-pvc.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–è¿™é‡Œè¿˜éœ€è¦ä½¿ç”¨åˆ°ä¸€ä¸ªæ‹¥æœ‰ç›¸å…³æƒé™çš„ serviceAccountï¼šjenkins2ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ç»™jenkins èµ‹äºˆäº†ä¸€äº›å¿…è¦çš„æƒé™ï¼Œå½“ç„¶å¦‚æœä½ å¯¹ serviceAccount çš„æƒé™ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯ï¼Œæˆ‘ä»¬ç»™è¿™ä¸ª sa ç»‘å®šä¸€ä¸ª cluster-admin çš„é›†ç¾¤è§’è‰²æƒé™ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå½“ç„¶è¿™æ ·å…·æœ‰ä¸€å®šçš„å®‰å…¨é£é™©ï¼šï¼ˆjenkins-rbac.yamlï¼‰</p><h3 id="1-3-Jenkins-serviceAccount"><a href="#1-3-Jenkins-serviceAccount" class="headerlink" title="1.3 Jenkins serviceAccount"></a>1.3 Jenkins serviceAccount</h3><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cat jenkins-rbac.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> ServiceAccount</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line"><span class="symbol">kind:</span> Role</span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"><span class="symbol">rules:</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"create"</span>,<span class="string">"delete"</span>,<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"patch"</span>,<span class="string">"update"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods/exec"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"create"</span>,<span class="string">"delete"</span>,<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"patch"</span>,<span class="string">"update"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"pods/log"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"get"</span>,<span class="string">"list"</span>,<span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line"><span class="symbol">    resources:</span> [<span class="string">"secrets"</span>]</span><br><span class="line"><span class="symbol">    verbs:</span> [<span class="string">"get"</span>]</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1beta1</span><br><span class="line"><span class="symbol">kind:</span> RoleBinding</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">  namespace:</span> kube-ops</span><br><span class="line"><span class="symbol">roleRef:</span></span><br><span class="line"><span class="symbol">  apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="symbol">  kind:</span> Role</span><br><span class="line"><span class="symbol">  name:</span> jenkins2</span><br><span class="line"><span class="symbol">subjects:</span></span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line"><span class="symbol">    name:</span> jenkins2</span><br><span class="line"><span class="symbol">namespace:</span> kube-ops</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»º rbac ç›¸å…³çš„èµ„æºå¯¹è±¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-rbac.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé€šè¿‡ ingressçš„å½¢å¼æ¥è®¿é—®Jenkins çš„ web æœåŠ¡ï¼ŒJenkins æœåŠ¡ç«¯å£ä¸º8080ï¼Œ50000 ç«¯å£ä¸ºagentï¼Œè¿™ä¸ªç«¯å£ä¸»è¦æ˜¯ç”¨äº Jenkins çš„ master å’Œ slave ä¹‹é—´é€šä¿¡ä½¿ç”¨çš„ã€‚(jenkins-ingress.yaml)</p><h3 id="1-4-Jenkins-å¯¹å¤–æä¾›è®¿é—®"><a href="#1-4-Jenkins-å¯¹å¤–æä¾›è®¿é—®" class="headerlink" title="1.4 Jenkins å¯¹å¤–æä¾›è®¿é—®"></a>1.4 Jenkins å¯¹å¤–æä¾›è®¿é—®</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-ingress</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">ci.xxlaila.cn</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»º Jenkins æœåŠ¡<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f jenkins-deployment.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>åˆ›å»ºå®Œæˆådockeå›å»æ‹‰å»é•œåƒï¼Œéœ€è¦ç­‰å¾…ä¸€ä¼šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹jenkinsæ˜¯å¦éƒ¨ç½²æˆåŠŸ</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># kubectl <span class="keyword">get</span> pods -n kube-ops</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">jenkins2<span class="number">-84f</span>476cbb-vz4b2   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d19h</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å®Œæˆä»¥åæˆ‘ä¹ˆå¯ä»¥é€šè¿‡åœ¨jenkins-ingress.yamlé‡Œé¢ç»‘å®šè¿‡çš„åŸŸåè¿›è¡Œè®¿é—®ï¼Œç„¶åè¿›è¡Œå®‰è£…é…ç½®ï¼š<br><img src="https://img.xxlaila.cn/sfdsfdsf38432.png" alt="img"></p><blockquote><p>åˆå§‹åŒ–çš„å¯†ç æˆ‘ä»¬å¯ä»¥åœ¨ jenkins çš„å®¹å™¨çš„æ—¥å¿—ä¸­è¿›è¡ŒæŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ nfs çš„å…±äº«æ•°æ®ç›®å½•ä¸­æŸ¥çœ‹</p><p>$ cat /data/jenkins/jenkins2/secrets/initialAdminPassword</p></blockquote><p>å®Œæˆé…ç½®ï¼Œå°±å¯ä»¥åˆ°jenkinsçš„ç•Œé¢ï¼Œå°±å’Œæˆ‘ä»¬åœ¨vmä¸‹å®‰è£…çš„jenkinsæ²¡æœ‰ä»»ä½•çš„åŒºåˆ«ã€‚<br><img src="https://img.xxlaila.cn/isdy823723894324.png" alt="img"></p><h2 id="2-é…ç½®jenkins"><a href="#2-é…ç½®jenkins" class="headerlink" title="2 é…ç½®jenkins"></a>2 é…ç½®jenkins</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ¥é…ç½® Jenkinsï¼Œè®©ä»–èƒ½å¤ŸåŠ¨æ€çš„ç”Ÿæˆ Slave çš„ Podï¼Œå®‰è£…jenkinsçš„æ’ä»¶æ¸…å•</p><p><code>Kubernetes This plugin integrates Jenkins with Kubernetes</code><br>2.1 Kuberneteså’ŒJenkinsçš„ç»“åˆ<br>&nbsp;&nbsp;&nbsp;&nbsp;ç‚¹å‡» ç³»ç»Ÿç®¡ç†(Manage Jenkins) â€”&gt; ç³»ç»Ÿé…ç½®(Configure System) â€”&gt; (æ‹–åˆ°æœ€ä¸‹æ–¹)Add a new cloud â€”&gt; é€‰æ‹© Kubernetesï¼Œç„¶åå¡«å†™ Kubernetes å’Œ Jenkins é…ç½®ä¿¡æ¯ã€‚</p><p><img src="https://img.xxlaila.cn/di32sdsf.png" alt="img"></p><blockquote><p>æ³¨æ„ namespaceï¼Œæˆ‘ä»¬è¿™é‡Œå¡« kube-opsï¼Œç„¶åç‚¹å‡»Test Connectionï¼Œå¦‚æœå‡ºç° Connection test successful çš„æç¤ºä¿¡æ¯è¯æ˜Jenkins å·²ç»å¯ä»¥å’Œ Kubernetes ç³»ç»Ÿæ­£å¸¸é€šä¿¡äº†ï¼Œç„¶åä¸‹æ–¹çš„ Jenkins URL åœ°å€ï¼š<a href="http://jenkins2.kube-ops.svc.cluster.local:8080ï¼Œè¿™é‡Œçš„æ ¼å¼ä¸ºæœåŠ¡å.namespace.svc.cluster.local:8080ï¼Œæ ¹æ®ä¸Šé¢åˆ›å»ºçš„jenkinsçš„æœåŠ¡åå¡«å†™ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¹‹å‰åˆ›å»ºçš„åä¸ºjenkinsï¼Œå¦‚æœæ˜¯ç”¨ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å°±åº”è¯¥æ˜¯jenkins2" target="_blank" rel="noopener">http://jenkins2.kube-ops.svc.cluster.local:8080ï¼Œè¿™é‡Œçš„æ ¼å¼ä¸ºæœåŠ¡å.namespace.svc.cluster.local:8080ï¼Œæ ¹æ®ä¸Šé¢åˆ›å»ºçš„jenkinsçš„æœåŠ¡åå¡«å†™ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¹‹å‰åˆ›å»ºçš„åä¸ºjenkinsï¼Œå¦‚æœæ˜¯ç”¨ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å°±åº”è¯¥æ˜¯jenkins2</a></p></blockquote><h3 id="2-2ã€é…ç½®-Pod-Template"><a href="#2-2ã€é…ç½®-Pod-Template" class="headerlink" title="2.2ã€é…ç½® Pod Template"></a>2.2ã€é…ç½® Pod Template</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;é…ç½® Jenkins Slave è¿è¡Œçš„ Pod æ¨¡æ¿ï¼Œå‘½åç©ºé—´æˆ‘ä»¬åŒæ ·æ˜¯ç”¨kube-opsï¼ŒLabels è¿™é‡Œä¹Ÿéå¸¸é‡è¦ï¼Œå¯¹äºåé¢æ‰§è¡Œ Job çš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥å€¼ï¼Œç„¶åæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ cnych/jenkins:jnlp è¿™ä¸ªé•œåƒï¼Œè¿™ä¸ªé•œåƒæ˜¯åœ¨å®˜æ–¹çš„ jnlp é•œåƒåŸºç¡€ä¸Šå®šåˆ¶çš„ï¼ŒåŠ å…¥äº† kubectl ç­‰ä¸€äº›å®ç”¨çš„å·¥å…·ã€‚<br><img src="https://img.xxlaila.cn/897kdfhgdkjb4.png" alt="img"><br><img src="https://img.xxlaila.cn/kjgsadsad8234632.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–éœ€è¦æ³¨æ„æˆ‘ä»¬è¿™é‡Œéœ€è¦åœ¨ä¸‹é¢æŒ‚è½½ä¸€ä¸ªä¸»æœºç›®å½•ï¼Œä¸€ä¸ªæ˜¯ /var/run/docker.sockï¼Œè¯¥æ–‡ä»¶æ˜¯ç”¨äº Pod ä¸­çš„å®¹å™¨èƒ½å¤Ÿå…±äº«å®¿ä¸»æœºçš„ Dockerï¼Œè¿™å°±æ˜¯è¯´çš„ docker in docker çš„æ–¹å¼ï¼ŒDocker äºŒè¿›åˆ¶æ–‡ä»¶æˆ‘ä»¬å·²ç»æ‰“åŒ…åˆ°ä¸Šé¢çš„é•œåƒä¸­äº†ã€‚å¦‚æœåœ¨slave agentä¸­æƒ³è¦è®¿é—®kubernetes é›†ç¾¤ä¸­å…¶ä»–èµ„æºï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»‘å®šä¹‹å‰åˆ›å»ºçš„Service Account è´¦å·:jenkins2</p><p><img src="https://img.xxlaila.cn/khsdif28734knsdfkds.png" alt="img"><br>&nbsp;&nbsp;&nbsp;&nbsp;å¦å¤–è¿˜æœ‰å‡ ä¸ªå‚æ•°éœ€è¦æ³¨æ„ï¼Œä¸Šå›¾æœ‰ä¸€ä¸ªpodå¯¿å‘½ä»£ç†çš„ç©ºé—²å­˜æ´»æ—¶é—´ï¼ˆåˆ†ï¼‰ï¼Œæ„æ€æ˜¯å½“å¤„äºç©ºé—²çŠ¶æ€çš„æ—¶å€™ä¿ç•™ Slave Podå¤šé•¿æ—¶é—´ï¼Œè¿™ä¸ªå‚æ•°æœ€å¥½æˆ‘ä»¬ä¿å­˜é»˜è®¤å°±è¡Œäº†ï¼Œå¦‚æœä½ è®¾ç½®è¿‡å¤§çš„è¯ï¼ŒJob ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå¯¹åº”çš„ Slave Pod å°±ä¸ä¼šç«‹å³è¢«é”€æ¯åˆ é™¤ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬çš„ Kubernetes Pluginæ’ä»¶å°±ç®—é…ç½®å®Œæˆäº†</p><h3 id="2-3-Jenkins-æµ‹è¯•"><a href="#2-3-Jenkins-æµ‹è¯•" class="headerlink" title="2.3 Jenkins æµ‹è¯•"></a>2.3 Jenkins æµ‹è¯•</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Kubernetes æ’ä»¶çš„é…ç½®å·¥ä½œå®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ·»åŠ ä¸€ä¸ª Job ä»»åŠ¡ï¼Œçœ‹æ˜¯å¦èƒ½å¤Ÿåœ¨ Slave Pod ä¸­æ‰§è¡Œï¼Œä»»åŠ¡æ‰§è¡Œå®Œæˆåçœ‹ Pod æ˜¯å¦ä¼šè¢«é”€æ¯åœ¨ Jenkins é¦–é¡µç‚¹å‡»create new jobsï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•çš„ä»»åŠ¡ï¼Œè¾“å…¥ä»»åŠ¡åç§°ï¼Œç„¶åæˆ‘ä»¬é€‰æ‹© Freestyle project ç±»å‹çš„ä»»åŠ¡<br>&nbsp;&nbsp;&nbsp;&nbsp;æ–°å»ºä¸€ä¸ªjobä¸ºsimple-testï¼Œå¢åŠ ä¸€ä¸ªshellæ¨¡å—ï¼Œshellæ¨¡å—é‡Œé¢å¢åŠ ç®€å•çš„echoæ¥æµ‹è¯•slaveçš„åŠ¨æ€éƒ¨ç½²ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"æµ‹è¯• Kubernetes åŠ¨æ€ç”Ÿæˆ jenkins slave"</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"==============docker in docker==========="</span></span><br><span class="line">docker info</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=============kubectl============="</span></span><br><span class="line">kubectl <span class="built_in">get</span> pods -n kube-<span class="built_in">system</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/s94uskljdslfd.png" alt="img"></p><p>ç°åœ¨æˆ‘ä»¬ç›´æ¥åœ¨é¡µé¢ç‚¹å‡»åšæˆçš„ Build now è§¦å‘æ„å»ºå³å¯ï¼Œç„¶åè§‚å¯Ÿ Kubernetes é›†ç¾¤ä¸­ Pod çš„å˜åŒ–</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl get pods -n kube-ops</span></span><br></pre></td></tr></table></figure><p>Kubernetes ç•Œé¢ä¹Ÿä¼šå‡ºç°jenkins agentçš„è¿›è¡Œpodçš„è¿›è¡Œéƒ¨ç½²ã€‚éƒ¨ç½²å®ŒæˆåéšåŠåˆ é™¤podã€‚</p><p><img src="https://img.xxlaila.cn/sakhd89234klmds.png" alt="img"><br><img src="https://img.xxlaila.cn/nslkfhio3rsd.png" alt="img"></p><h2 id="3ã€Jenkinsé”™è¯¯è§£å†³"><a href="#3ã€Jenkinsé”™è¯¯è§£å†³" class="headerlink" title="3ã€Jenkinsé”™è¯¯è§£å†³"></a>3ã€Jenkinsé”™è¯¯è§£å†³</h2><p>ç¬¬ä¸€æ¬¡å­¦ä¹ å®‰è£…jenkinsè¸©äº†å¾ˆå¤šå‘ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå­¦ä¹ äº†å¾ˆå¤šçš„ï¼Œä¸‹é¢æ˜¯åœ¨k8sä¸Šå®‰è£…jenkinsé‡åˆ°çš„ä¸€äº›é”™è¯¯ï¼š</p><ul><li>æ‰“å¼€jenkinsé¡µé¢çš„æ—¶å€™æç¤ºdnsä¸èƒ½è§£æï¼Œæ´é¢å¦‚ä¸‹å›¾ï¼š</li></ul><p><img src="https://img.xxlaila.cn/skajdh823648uesd.png" alt="img"></p><ul><li>æŸ¥çœ‹jenkinsçš„æ—¥å¿—æç¤º</li></ul><p><img src="https://img.xxlaila.cn/8243ihkdfnklsads.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¯¼è‡´çš„é—®é¢˜æœ‰httpsã€ç½‘ç»œè¿æ¥ä¸é€šç•…ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å§httpsä¿®æ”¹ä¸ºhttpï¼Œéœ€è¦ä¿®æ”¹jenkinsçš„é…ç½®æ–‡ä»¶ã€‚ç„¶åå†é‡æ–°å»ºç«‹jenkinsçš„podã€‚è¿›å…¥jenkinsçš„ç›®å½•ä¿®æ”¹hudson.model.UpdateCenter.xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">$ cat hudson.model.UpdateCenter.xml</span><br><span class="line"><span class="meta">&lt;?xml version='1.1' encoding='UTF-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sites</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">site</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://updates.jenkins.io/update-center.json<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨åšk8sçš„æ—¶å€™ä¸€å®šè¦ç”¨è¯ä¹¦ï¼Œä¸ç„¶åæœŸåœ¨åšå„ç§æœåŠ¡çš„æ—¶å€™éƒ½ä¼šé‡åˆ°é”™è¯¯ï¼Œå› ä¸ºdockeré»˜è®¤å»ç§æœ‰registoryè¦httpsï¼Œkuber-apiè¦httpsã€‚å½“ç„¶æ²¡æœ‰ä½¿ç”¨httpséƒ½å¯ä»¥æ¢æˆhttpï¼Œåœ¨æ¬¡é‡æ–°éƒ¨ç½²jenkinsä»¥åæç¤ºç³»åˆ—ä¿¡æ¯ã€‚è®¿é—®ç›®å½•æ²¡æœ‰æƒé™ã€‚</p><p><img src="https://img.xxlaila.cn/2864jksfhjdsh.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿›å…¥nfsç›®å½•ï¼Œéœ€è¦ä¿®æ”¹ä¸‹ç›®å½•æƒé™, å› ä¸ºå½“æ˜ å°„æœ¬åœ°æ•°æ®å·æ—¶ï¼Œ/home/docker/jenkinsç›®å½•çš„æ‹¥æœ‰è€…ä¸ºrootç”¨æˆ·ï¼Œè€Œå®¹å™¨ä¸­jenkins userçš„uidä¸º1000</p><p><code>$ sudo chown -R 1000:1000 /data/jenkins</code></p><blockquote><p>è¿™é‡Œå§httpsè§£å†³äº†è¿˜æ˜¯é‡åˆ°æç¤ºç½‘ç»œä¸é€šã€‚ä¸‹å›¾</p></blockquote><p><img src="https://img.xxlaila.cn/xnks94uoildsfs.png" alt="img"></p><blockquote><p>è¿™é‡Œæ˜¯dnsçš„ä¸èƒ½è§£æçš„é—®é¢˜ï¼Œä»¥ä¸‹æ’é”™æ€è·¯ï¼šç™»é™†jenkinsçš„å®¹å™¨é‡Œé¢æŸ¥çœ‹è·¯ç”±æ˜¯å¦æ­£ç¡®</p></blockquote><p><img src="https://img.xxlaila.cn/382468365324.png" alt="img"></p><blockquote><p>ç„¶ååœ¨ç¡®è®¤å®¹å™¨æ˜¯å¦å¯ä»¥è”é€šå¤–ç½‘ï¼Œè¿˜æ˜¯dnsä¸èƒ½è§£æ<br><img src="https://img.xxlaila.cn/fnijwy4nkdsfkhdsf.png" alt="img"></p></blockquote><blockquote><p>è¿™é‡Œping 114æ²¡æœ‰é—®é¢˜ï¼ŒpingåŸŸåä¸èƒ½è§£æï¼Œè¯´æ˜æ˜¯dnsè§£ææœ‰é—®é¢˜ã€‚æ¥ç€æˆ‘ä»¬åœ¨æŸ¥çœ‹å®¹å™¨çš„dnsé…ç½®</p></blockquote><p><img src="https://img.xxlaila.cn/dkjfsg328943242.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæ˜¯dnsé—®é¢˜ã€‚è¿™é‡Œä¸é˜è¿°dnsï¼Œå‚è€ƒç¬¬äºŒç« k8s dns,jenkins åœ¨æ‰§è¡Œç¼–è¯‘çš„æ—¶å€™æç¤º: <code>â€˜Jenkinsâ€™ doesnâ€™t have label â€˜jnlp-agentâ€™</code>,åœ¨ç³»ç»Ÿé…ç½®é…ç½®é‡Œé¢è¿›è¡Œæµ‹è¯•è¿æ¥k8s çš„apiæç¤ºå¦‚ä¸‹é”™è¯¯</p><p><img src="https://img.xxlaila.cn/324768ksdjsfhds.png" alt="img"></p><ul><li>æ·»åŠ jenkinsçš„secretè®¤è¯</li></ul><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"># kubectl get secret  -<span class="keyword">n</span> kube-ops</span><br><span class="line">NAME                     <span class="keyword">TYPE</span>                                  DATA   AGE</span><br><span class="line">default-<span class="keyword">token</span>-4gzkv      kubernetes.io/service-account-<span class="keyword">token</span>   3      13d</span><br><span class="line">jenkins2-<span class="keyword">token</span>-mjnw4     kubernetes.io/service-account-<span class="keyword">token</span>   3      14m</span><br><span class="line">prometheus-<span class="keyword">token</span>-84p87   kubernetes.io/service-account-<span class="keyword">token</span>   3      13d</span><br><span class="line"># kubectl <span class="keyword">describe</span> secret jenkins2-<span class="keyword">token</span>-mjnw4 -<span class="keyword">n</span> kube-ops</span><br><span class="line">Name:         jenkins2-<span class="keyword">token</span>-mjnw4</span><br><span class="line">Namespace:    kube-ops</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: jenkins2</span><br><span class="line">              kubernetes.io/service-account.uid: ffced652-2f6c-11e9-98a4-fa163e14c5bd</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span>:  kubernetes.io/service-account-<span class="keyword">token</span></span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line"><span class="keyword">ca</span>.crt:     1025 bytes</span><br><span class="line">namespace:  8 bytes</span><br><span class="line"><span class="keyword">token</span>:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLW9wcyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJqZW5raW5zMi10b2tlbi1tam53NCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJqZW5raW5zMiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImZmY2VkNjUyLTJmNmMtMTFlOS05OGE0LWZhMTYzZTE0YzViZCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLW9wczpqZW5raW5zMiJ9.PlPvO_AST4Q6tJJ2i2zGFfufFN1xjWLlHZ5ipTK0aU5CdR49OAropPQhQ0TjLRWf4Z66h847g28OCABmxO1cSG_-8UpwVsohFROTCOjx9Ka3KACmaIkw9Bvihm_lPQlaLykdyXxVDrfI6TobtG0Y5KnKPFj8CjkIFPk5ewTKpOm5pDKVDKu4W_4uOhSnISfLVUvHp8A_ojK_JCVnBBr0Py3UeuEF8vjJES0_yKNxPUtXQq-vkWEZecnAC_x5sfFJTA5aB18sEnxCaeMzgUxzi4IflNxxyVjdZrbq0UdS8llmfnGg5Ur7Zf-lu2ajdOlRdQp6VRPMcQmQaWoHUuoevg</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/2372837934232.png" alt="img"><br><img src="https://img.xxlaila.cn/djfjsr3897493432.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>ci/cd</tag>
      </tags>
  </entry>
  <entry>
    <title>kube nfs åŠ¨æ€å­˜å‚¨</title>
    <url>/2019/08/12/kube-nfs-%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;nfs-client-provisioneræ˜¯ä¸€ä¸ªautomatic provisionerï¼Œä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œè‡ªåŠ¨åˆ›å»ºPVå’Œå¯¹åº”çš„PVCï¼Œæœ¬èº«ä¸æä¾›NFSå­˜å‚¨ï¼Œéœ€è¦å¤–éƒ¨å…ˆæœ‰ä¸€å¥—NFSå­˜å‚¨æœåŠ¡ã€‚</p><ul><li>PVä»¥ ${namespace}-${pvcName}-${pvName}çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">å®˜æ–¹è®¿é—®åœ°å€</a></p><h2 id="1ã€æƒé™ä½“ç³»æ„å»º"><a href="#1ã€æƒé™ä½“ç³»æ„å»º" class="headerlink" title="1ã€æƒé™ä½“ç³»æ„å»º"></a>1ã€æƒé™ä½“ç³»æ„å»º</h2><h3 id="1-1ã€åˆ›å»ºserviceaccount"><a href="#1-1ã€åˆ›å»ºserviceaccount" class="headerlink" title="1.1ã€åˆ›å»ºserviceaccount"></a>1.1ã€åˆ›å»ºserviceaccount</h3><p>ServiceAccountä¹Ÿæ˜¯ä¸€ç§è´¦å·, ä¾›è¿è¡Œåœ¨podä¸­çš„è¿›ç¨‹ä½¿ç”¨, ä¸ºpodä¸­çš„è¿›ç¨‹æä¾›å¿…è¦çš„èº«ä»½è¯æ˜.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat serviceaccount.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: kube-test</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="1-2ã€åˆ›å»ºrole"><a href="#1-2ã€åˆ›å»ºrole" class="headerlink" title="1.2ã€åˆ›å»ºrole"></a>1.2ã€åˆ›å»ºrole</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat  clusterrole.yaml</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  namespace: kube-test</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    resources: [<span class="string">"storageclasses"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"events"</span>]</span><br><span class="line">    verbs: [<span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services"</span>, <span class="string">"endpoints"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"create"</span>,<span class="string">"list"</span>, <span class="string">"watch"</span>,<span class="string">"update"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">"extensions"</span>]</span><br><span class="line">    resources: [<span class="string">"podsecuritypolicies"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"nfs-client-provisioner"</span>]</span><br><span class="line">    verbs: [<span class="string">"use"</span>]</span><br></pre></td></tr></table></figure><h3 id="1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"><a href="#1-3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š" class="headerlink" title="1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š"></a>1.3ã€è´¦æˆ·å’Œè§’è‰²ç»‘å®š</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat clusterrolebinding.yaml </span></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: kube-test</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">æ‰§è¡Œåˆ›å»º</span><br><span class="line">kubectl create -f serviceaccount.yaml -f clusterrole.yaml -f clusterrolebinding.yaml</span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…éƒ¨ç½²"><a href="#2ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="2ã€å®‰è£…éƒ¨ç½²"></a>2ã€å®‰è£…éƒ¨ç½²</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹è½½deployment.yamlæ–‡ä»¶,éœ€è¦ä¿®æ”¹NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ10.10.10.60ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/ifs/kubernetesï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><h3 id="2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"><a href="#2-1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·" class="headerlink" title="2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·"></a>2.1ã€éƒ¨ç½²å­˜å‚¨ä¾›åº”å·</h3><blockquote><p>æ ¹æ®PVCçš„è¯·æ±‚, åŠ¨æ€åˆ›å»ºPVå­˜å‚¨.</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat deployment.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: quay.io/external_storage/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.21.16.244</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /data</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 10.10.10.60</span><br><span class="line">            path: /ifs/kubernetes</span><br></pre></td></tr></table></figure><pre><code>* ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²class.yaml</code></pre><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´</p><h3 id="2-2ã€åˆ›å»ºstorageclass"><a href="#2-2ã€åˆ›å»ºstorageclass" class="headerlink" title="2.2ã€åˆ›å»ºstorageclass"></a>2.2ã€åˆ›å»ºstorageclass</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat class.yaml</span></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">"false"</span></span><br></pre></td></tr></table></figure><h4 id="2-2-1ã€æŸ¥çœ‹StorageClass"><a href="#2-2-1ã€æŸ¥çœ‹StorageClass" class="headerlink" title="2.2.1ã€æŸ¥çœ‹StorageClass"></a>2.2.1ã€æŸ¥çœ‹StorageClass</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get sc</span></span><br><span class="line"><span class="comment"># kubectl get storageclass</span></span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   19h</span><br></pre></td></tr></table></figure><h4 id="2-2-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"><a href="#2-2-2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨" class="headerlink" title="2.2.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨"></a>2.2.2ã€è®¾ç½®é»˜è®¤åç«¯å­˜å‚¨</h4><p>è®¾ç½®è¿™ä¸ªdefaultåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch storageclass managed-nfs-storage -p '&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3ã€æµ‹è¯•åˆ›å»ºPVC"><a href="#2-2-3ã€æµ‹è¯•åˆ›å»ºPVC" class="headerlink" title="2.2.3ã€æµ‹è¯•åˆ›å»ºPVC"></a>2.2.3ã€æµ‹è¯•åˆ›å»ºPVC</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat test-claim.yaml </span></span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-claim</span><br><span class="line">  namespace: kube-test</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: <span class="string">"managed-nfs-storage"</span></span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br></pre></td></tr></table></figure><h4 id="2-2-4ã€å¯åŠ¨æµ‹è¯•POD"><a href="#2-2-4ã€å¯åŠ¨æµ‹è¯•POD" class="headerlink" title="2.2.4ã€å¯åŠ¨æµ‹è¯•POD"></a>2.2.4ã€å¯åŠ¨æµ‹è¯•POD</h4><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat test-pod.yaml </span></span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span>-pod</span><br><span class="line">  namespace: kube-test</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: <span class="built_in">test</span>-pod</span><br><span class="line">    image: docker.io/busybox:1.24</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"/bin/sh"</span></span><br><span class="line">    args:</span><br><span class="line">      - <span class="string">"-c"</span></span><br><span class="line">      - <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        mountPath: <span class="string">"/mnt"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: <span class="built_in">test</span>-claim</span><br></pre></td></tr></table></figure><h4 id="2-2-5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ"><a href="#2-2-5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ" class="headerlink" title="2.2.5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ"></a>2.2.5ã€æ ¡éªŒæ˜¯å¦æˆåŠŸ</h4><p>å»NFSå…±äº«ç›®å½•æŸ¥çœ‹æœ‰æ²¡æœ‰SUCCESSæ–‡ä»¶<br><img src="https://img.xxlaila.cn/%E6%88%AA%E5%9B%BE.png" alt="img"><br><img src="https://img.xxlaila.cn/8934nsdlsa.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pvc -n kube-test</span></span><br><span class="line">NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line"><span class="built_in">test</span>-claim   Bound    pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd   1Mi        RWX            managed-nfs-storage   20h</span><br></pre></td></tr></table></figure><h3 id="2-3ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"><a href="#2-3ã€æ›´æ”¹PersistentVolumes-ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥" class="headerlink" title="2.3ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥"></a>2.3ã€æ›´æ”¹PersistentVolumes ä¸­çš„ä¸€ä¸ªå›æ”¶ç­–ç•¥</h3><ul><li><p>æŸ¥çœ‹é›†ç¾¤ä¸­PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹PersistentVolumes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch pv pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd -p '&#123;"spec":&#123;"persistentVolumeReclaimPolicy":"Retain"&#125;&#125;'</span></span><br><span class="line">persistentvolume/pvc-f8e08fa5-2de2-11e9-8991-fa163e14c5bd patched</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ›´æ”¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure></li></ul><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>nfs</tag>
      </tags>
  </entry>
  <entry>
    <title>pvc pv</title>
    <url>/2019/08/12/pvc-pv/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h2 id="1ã€ä»‹ç»"><a href="#1ã€ä»‹ç»" class="headerlink" title="1ã€ä»‹ç»"></a>1ã€ä»‹ç»</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;PersistentVolumeï¼ˆpvï¼‰å’ŒPersistentVolumeClaimï¼ˆpvcï¼‰æ˜¯k8sæä¾›çš„ä¸¤ç§APIèµ„æºï¼Œç”¨äºæŠ½è±¡å­˜å‚¨ç»†èŠ‚ã€‚ç®¡ç†å‘˜å…³æ³¨äºå¦‚ä½•é€šè¿‡pvæä¾›å­˜å‚¨åŠŸèƒ½è€Œæ— éœ€å…³æ³¨ç”¨æˆ·å¦‚ä½•ä½¿ç”¨ï¼ŒåŒæ ·çš„ç”¨æˆ·åªéœ€è¦æŒ‚è½½pvcåˆ°å®¹å™¨ä¸­è€Œä¸éœ€è¦å…³æ³¨å­˜å‚¨å·é‡‡ç”¨ä½•ç§æŠ€æœ¯å®ç°ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;pvcå’Œpvçš„å…³ç³»ä¸podå’Œnodeå…³ç³»ç±»ä¼¼ï¼Œå‰è€…æ¶ˆè€—åè€…çš„èµ„æºã€‚pvcå¯ä»¥å‘pvç”³è¯·æŒ‡å®šå¤§å°çš„å­˜å‚¨èµ„æºå¹¶è®¾ç½®è®¿é—®æ¨¡å¼,è¿™å°±å¯ä»¥é€šè¿‡Provision -&gt; Claim çš„æ–¹å¼ï¼Œæ¥å¯¹å­˜å‚¨èµ„æºè¿›è¡Œæ§åˆ¶ã€‚</p><h2 id="2ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#2ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2ã€ç”Ÿå‘½å‘¨æœŸ"></a>2ã€ç”Ÿå‘½å‘¨æœŸ</h2><p>pvå’Œpvcéµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š</p><ul><li>ä¾›åº”å‡†å¤‡ã€‚é€šè¿‡é›†ç¾¤å¤–çš„å­˜å‚¨ç³»ç»Ÿæˆ–è€…äº‘å¹³å°æ¥æä¾›å­˜å‚¨æŒä¹…åŒ–æ”¯æŒã€‚</li></ul><ul><li><p>é™æ€æä¾›ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¤šä¸ªPVï¼Œä¾›PVCä½¿ç”¨ã€‚</p></li><li><p>åŠ¨æ€æä¾›ï¼šåŠ¨æ€åˆ›å»ºPVCç‰¹å®šçš„PVï¼Œå¹¶ç»‘å®šã€‚</p><ul><li>ç»‘å®šã€‚ç”¨æˆ·åˆ›å»ºpvcå¹¶æŒ‡å®šéœ€è¦çš„èµ„æºå’Œè®¿é—®æ¨¡å¼ã€‚åœ¨æ‰¾åˆ°å¯ç”¨pvä¹‹å‰ï¼Œpvcä¼šä¿æŒæœªç»‘å®šçŠ¶æ€ã€‚</li><li>ä½¿ç”¨ã€‚ç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvcã€‚</li><li>é‡Šæ”¾ã€‚ç”¨æˆ·åˆ é™¤pvcæ¥å›æ”¶å­˜å‚¨èµ„æºï¼Œpvå°†å˜æˆâ€œreleasedâ€çŠ¶æ€ã€‚ç”±äºè¿˜ä¿ç•™ç€ä¹‹å‰çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥æ¥å¤„ç†ï¼Œå¦åˆ™è¿™äº›å­˜å‚¨èµ„æºæ— æ³•è¢«å…¶ä»–pvcä½¿ç”¨ã€‚</li><li>å›æ”¶(Reclaiming)ã€‚pvå¯ä»¥è®¾ç½®ä¸‰ç§å›æ”¶ç­–ç•¥ï¼šä¿ç•™ï¼ˆRetainï¼‰ï¼Œå›æ”¶ï¼ˆRecycleï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ã€‚</li></ul></li><li><p>ä¿ç•™ç­–ç•¥ï¼šå…è®¸äººå·¥å¤„ç†ä¿ç•™çš„æ•°æ®ã€‚</p></li><li><p>åˆ é™¤ç­–ç•¥ï¼šå°†åˆ é™¤pvå’Œå¤–éƒ¨å…³è”çš„å­˜å‚¨èµ„æºï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</p></li><li><p>å›æ”¶ç­–ç•¥ï¼šå°†æ‰§è¡Œæ¸…é™¤æ“ä½œï¼Œä¹‹åå¯ä»¥è¢«æ–°çš„pvcä½¿ç”¨ï¼Œéœ€è¦æ’ä»¶æ”¯æŒã€‚</p></li></ul><blockquote><p><em>ç›®å‰åªæœ‰NFSå’ŒHostPathç±»å‹å·æ”¯æŒå›æ”¶ç­–ç•¥ï¼ŒAWS EBS,GCE PD,Azure Diskå’ŒCinderæ”¯æŒåˆ é™¤(Delete)ç­–ç•¥ã€‚</em></p></blockquote><h3 id="2-1ã€Provisioning"><a href="#2-1ã€Provisioning" class="headerlink" title="2.1ã€Provisioning"></a>2.1ã€Provisioning</h3><p>ä¸¤ç§æ–¹å¼æä¾›çš„PVèµ„æºä¾›ç»™</p><a id="more"></a><p>static</p><ul><li>é€šè¿‡é›†ç¾¤ç®¡ç†è€…åˆ›å»ºå¤šä¸ªPVï¼Œä¸ºé›†ç¾¤â€œä½¿ç”¨è€…â€æä¾›å­˜å‚¨èƒ½åŠ›è€Œéšè—çœŸå®å­˜å‚¨çš„ç»†èŠ‚ã€‚å¹¶ä¸”å­˜åœ¨äºkubenretes apiä¸­ï¼Œå¯è¢«ç›´æ¥ä½¿ç”¨ã€‚</li></ul><p>dynamic</p><ul><li>åŠ¨æ€å·ä¾›ç»™æ˜¯kubernetesç‹¬æœ‰çš„åŠŸèƒ½ï¼Œè¿™ä¸€åŠŸèƒ½å…è®¸æŒ‰éœ€åˆ›å»ºå­˜å‚¨å»ºã€‚åœ¨æ­¤ä¹‹å‰ï¼Œé›†ç¾¤ç®¡ç†å‘˜éœ€è¦äº‹å…ˆåœ¨é›†ç¾¤å¤–ç”±å­˜å‚¨æä¾›è€…æˆ–è€…äº‘æä¾›å•†åˆ›å»º</li><li>å­˜å‚¨å·ï¼ŒæˆåŠŸä¹‹åå†åˆ›å»ºPersistentVolumeå¯¹è±¡ï¼Œæ‰èƒ½å¤Ÿåœ¨kubernetesä¸­ä½¿ç”¨ã€‚åŠ¨æ€å·ä¾›ç»™èƒ½è®©é›†ç¾¤ç®¡ç†å‘˜ä¸å¿…è¿›è¡Œé¢„å…ˆåˆ›å»ºå­˜å‚¨å·ï¼Œè€Œæ˜¯éšç€ç”¨æˆ·éœ€æ±‚è¿›è¡Œåˆ›å»ºã€‚åœ¨1.5ç‰ˆæœ¬æé«˜äº†åŠ¨æ€å·çš„å¼¹æ€§å’Œå¯ç”¨æ€§ã€‚</li></ul><h2 id="3ã€PVç±»å‹"><a href="#3ã€PVç±»å‹" class="headerlink" title="3ã€PVç±»å‹"></a>3ã€PVç±»å‹</h2><p>pvæ”¯æŒä»¥ä¸‹ç±»å‹:</p><pre><code>* GCEPersistentDisk
* AWSElasticBlockStore
* NFS
* iSCSI
* RBD (Ceph Block Device)
* Glusterfs
* AzureFile
* AzureDisk
* CephFS
* cinder
* FC
* FlexVolume
* Flocker
* PhotonPersistentDisk
* Quobyte
* VsphereVolume
* HostPath (single node testing only â€“ local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</code></pre><h3 id="3-1ã€PVå±æ€§"><a href="#3-1ã€PVå±æ€§" class="headerlink" title="3.1ã€PVå±æ€§"></a>3.1ã€PVå±æ€§</h3><ul><li>è®¿é—®æ¨¡å¼,ä¸pvçš„è¯­ä¹‰ç›¸åŒã€‚åœ¨è¯·æ±‚èµ„æºæ—¶ä½¿ç”¨ç‰¹å®šæ¨¡å¼ã€‚</li><li>èµ„æº,ç”³è¯·çš„å­˜å‚¨èµ„æºæ•°é¢ã€‚</li></ul><h3 id="3-2ã€PVå·é˜¶æ®µçŠ¶æ€"><a href="#3-2ã€PVå·é˜¶æ®µçŠ¶æ€" class="headerlink" title="3.2ã€PVå·é˜¶æ®µçŠ¶æ€"></a>3.2ã€PVå·é˜¶æ®µçŠ¶æ€</h3><ul><li>Available â€“ èµ„æºå°šæœªè¢«claimä½¿ç”¨</li><li>Bound â€“ å·å·²ç»è¢«ç»‘å®šåˆ°claimäº†</li><li>Released â€“ claimè¢«åˆ é™¤ï¼Œå·å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œä½†æœªè¢«é›†ç¾¤å›æ”¶ã€‚</li><li>Failed â€“ å·è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><h2 id="4ã€åˆ©ç”¨nfsåˆ›å»ºpv-pvc"><a href="#4ã€åˆ©ç”¨nfsåˆ›å»ºpv-pvc" class="headerlink" title="4ã€åˆ©ç”¨nfsåˆ›å»ºpv_pvc"></a>4ã€åˆ©ç”¨nfsåˆ›å»ºpv_pvc</h2><p>å‡†å¤‡ä¸€å°æœºå™¨ï¼Œæ­å»ºNFSæœåŠ¡ï¼Œnfsæ­å»ºè¿™é‡Œä¸é˜è¿°ï¼Œ</p><h3 id="4-1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv"><a href="#4-1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv" class="headerlink" title="4.1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv"></a>4.1ã€åœ¨masterèŠ‚ç‚¹åˆ›å»ºpv</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat pv.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: opspv</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/jenkins</span><br><span class="line">    server: 172.21.16.236</span><br><span class="line"><span class="comment"># kubectl create -f pv.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pv</span></span><br></pre></td></tr></table></figure><h3 id="4-2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc"><a href="#4-2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc" class="headerlink" title="4.2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc"></a>4.2ã€åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºpvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat pvc.yaml</span></span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: opspv</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line"><span class="comment"># kubectl create -f pvc.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pvc</span></span><br></pre></td></tr></table></figure><h3 id="4-3ã€åˆ›å»ºpodæŒ‚è½½pv-pvc"><a href="#4-3ã€åˆ›å»ºpodæŒ‚è½½pv-pvc" class="headerlink" title="4.3ã€åˆ›å»ºpodæŒ‚è½½pv_pvc"></a>4.3ã€åˆ›å»ºpodæŒ‚è½½pv_pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat jenkins-deployment.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: jenkins2</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins</span><br><span class="line">        image: jenkins/jenkins:lts</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: web</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 50000</span><br><span class="line">          name: agent</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 512Mi</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: jenkinshome</span><br><span class="line">          subPath: jenkins2</span><br><span class="line">          mountPath: /var/jenkins_home</span><br><span class="line">        env:</span><br><span class="line">        - name: LIMITS_MEMORY</span><br><span class="line">          valueFrom:</span><br><span class="line">            resourceFieldRef:</span><br><span class="line">              resource: limits.memory</span><br><span class="line">              divisor: 1Mi</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx$(LIMITS_MEMORY)m -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85 -Duser.timezone=Asia/Shanghai</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">      volumes:</span><br><span class="line">      - name: jenkinshome</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: opspvc</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins2</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  labels:</span><br><span class="line">    app: jenkins2</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: jenkins2</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30002</span><br><span class="line">  - name: agent</span><br><span class="line">    port: 50000</span><br><span class="line">    targetPort: agent</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <tags>
        <tag>pvc,pv,kubernetes,å­˜å‚¨</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes å•æœºå®‰è£…</title>
    <url>/2019/08/12/kubernetes-%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h2 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1.ç¯å¢ƒå‡†å¤‡"></a>1.ç¯å¢ƒå‡†å¤‡</h2><blockquote><p>ä¸€ä¸ªmasterèŠ‚ç‚¹ï¼Œå››ä¸ªnodeèŠ‚ç‚¹<br>masterèŠ‚ç‚¹ip</p><ul><li>172.21.16.244<br>nodeèŠ‚ç‚¹ip</li><li>172.21.16.24</li><li>172.21.16.231</li><li>172.21.16.202</li><li>172.21.16.55</li></ul></blockquote><ul><li>ä»¥ä¸‹æ˜¯æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå‡è¿›è¡Œæ“ä½œ</li></ul><h2 id="2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº"><a href="#2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº" class="headerlink" title="2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº"></a>2ã€æœåŠ¡å™¨æ·»åŠ é˜¿é‡Œäº‘yumæº</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">  http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="3ã€é‡æ–°å»ºç«‹yumç¼“å­˜"><a href="#3ã€é‡æ–°å»ºç«‹yumç¼“å­˜" class="headerlink" title="3ã€é‡æ–°å»ºç«‹yumç¼“å­˜"></a>3ã€é‡æ–°å»ºç«‹yumç¼“å­˜</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install epel-release &amp;&amp;yum clean all &amp;&amp;yum makecach</span></span><br></pre></td></tr></table></figure><ul><li>è®°å¾—åŒæ­¥ç³»ç»Ÿçš„æ—¶é—´</li></ul><h2 id="3ã€é…ç½®è½¬å‘è¯·æ±‚"><a href="#3ã€é…ç½®è½¬å‘è¯·æ±‚" class="headerlink" title="3ã€é…ç½®è½¬å‘è¯·æ±‚"></a>3ã€é…ç½®è½¬å‘è¯·æ±‚</h2><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">å…³é—­swap</span><br><span class="line"><span class="comment"># sudo swapoff -a</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># sysctl --system</span></span><br></pre></td></tr></table></figure><h2 id="4ã€å®‰è£…docker"><a href="#4ã€å®‰è£…docker" class="headerlink" title="4ã€å®‰è£…docker"></a>4ã€å®‰è£…docker</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install docker</span></span><br><span class="line"><span class="comment"># systemctl enable docker &amp;&amp; systemctl start docker</span></span><br></pre></td></tr></table></figure><h2 id="5ã€å®‰è£…k8s-éœ€è¦çš„æ’ä»¶"><a href="#5ã€å®‰è£…k8s-éœ€è¦çš„æ’ä»¶" class="headerlink" title="5ã€å®‰è£…k8s éœ€è¦çš„æ’ä»¶"></a>5ã€å®‰è£…k8s éœ€è¦çš„æ’ä»¶</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install kubelet kubeadm kubectl kubernetes-cni</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet &amp;&amp; systemctl start kubelet</span></span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ä¸º kubelet ä¸ºCgroupæ¨¡å¼</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CGROUP_ARGS=--cgroup-driver=systemd"</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure><h2 id="6ã€æ‹‰å–é•œåƒ"><a href="#6ã€æ‹‰å–é•œåƒ" class="headerlink" title="6ã€æ‹‰å–é•œåƒ"></a>6ã€æ‹‰å–é•œåƒ</h2><p>æ–°å»ºä¸€ä¸ªshell æ‹‰å–é•œåƒåˆ°æœ¬åœ°(æ‰€æœ‰èŠ‚ç‚¹å‡æ“ä½œ)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">images=(kube-proxy:v1.13.0 kube-scheduler:v1.13.0 kube-controller-manager:v1.13.0 kube-apiserver:v1.13.0 etcd:3.2.24 coredns:1.2.6 pause:3.1 kubernetes-dashboard-amd64:v1.10.0 kubernetes-dashboard-init-amd64:v1.0.1  k8s-dns-sidecar-amd64:1.14.9 k8s-dns-kube-dns-amd64:1.14.9 k8s-dns-dnsmasq-nanny:1.15.0 heapster:v1.5.2 kubernetes-dashboard-arm:v1.10.0)</span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">docker pull xxlaila/<span class="variable">$imageName</span></span><br><span class="line">docker tag xxlaila/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">docker rmi xxlaila/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>ä»¥ä¸‹æ“ä½œæ˜¯åœ¨k8sçš„masterè¿›è¡Œæ“ä½œ</li></ul><h2 id="7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ"><a href="#7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ" class="headerlink" title="7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ"></a>7ã€åˆå§‹åŒ–ç›¸å…³é•œåƒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm init --kubernetes-version=v1.13.0 --pod-network-cidr=10.244.0.0/16</span></span><br><span class="line"><span class="comment"># è®°ä¸‹è¿™å¥è¯ï¼Œåé¢nodeèŠ‚ç‚¹åŠ å…¥éœ€è¦</span></span><br><span class="line"><span class="comment"># kubeadm join 172.21.17.4:6443 --token 0mdk7x.du3cn19qm1jl2b0e --discovery-token-ca-cert-hash sha256:19bf79b41a931735b1f2f5138e1daa436ab26a4f19781ccf2015cff749ddb4b9</span></span><br></pre></td></tr></table></figure><h3 id="7-1ã€æ‰§è¡Œåˆ›å»ºç›®å½•"><a href="#7-1ã€æ‰§è¡Œåˆ›å»ºç›®å½•" class="headerlink" title="7.1ã€æ‰§è¡Œåˆ›å»ºç›®å½•"></a>7.1ã€æ‰§è¡Œåˆ›å»ºç›®å½•</h3><p>åé¢åœ¨ç”Ÿæˆè¯ä¹¦çš„æ—¶å€™éœ€è¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><h3 id="7-2ã€æŸ¥çœ‹éªŒè¯"><a href="#7-2ã€æŸ¥çœ‹éªŒè¯" class="headerlink" title="7.2ã€æŸ¥çœ‹éªŒè¯"></a>7.2ã€æŸ¥çœ‹éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatus</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br><span class="line"><span class="comment"># kubectl get cs</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="8ã€å®‰è£…flannel-ç½‘ç»œ"><a href="#8ã€å®‰è£…flannel-ç½‘ç»œ" class="headerlink" title="8ã€å®‰è£…flannel ç½‘ç»œ"></a>8ã€å®‰è£…flannel ç½‘ç»œ</h2><blockquote><p>(é…ç½®æ–‡ä»¶å’Œç›®å½•æ¯ä¸ªnodeéƒ½è¦å»ºç«‹)</p></blockquote><h3 id="8-1-åˆ›å»ºflannelé…ç½®æ–‡ä»¶"><a href="#8-1-åˆ›å»ºflannelé…ç½®æ–‡ä»¶" class="headerlink" title="8.1 åˆ›å»ºflannelé…ç½®æ–‡ä»¶"></a>8.1 åˆ›å»ºflannelé…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/cni/net.d/</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF&gt; /etc/cni/net.d/10-flannel.conf</span></span><br><span class="line">&#123;</span><br><span class="line">â€œnameâ€: â€œcbr0â€,</span><br><span class="line">â€œ<span class="built_in">type</span>â€: â€œflannelâ€,</span><br><span class="line">â€œdelegateâ€: &#123;</span><br><span class="line">â€œisDefaultGatewayâ€: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="8-2-åˆ›å»ºç½‘ç»œé…ç½®"><a href="#8-2-åˆ›å»ºç½‘ç»œé…ç½®" class="headerlink" title="8.2 åˆ›å»ºç½‘ç»œé…ç½®"></a>8.2 åˆ›å»ºç½‘ç»œé…ç½®</h3><blockquote><p>(åªéœ€è¦åœ¨ä¸»èŠ‚ç‚¹æ“ä½œå³å¯)</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-amd64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-ppc64le created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-s390x created</span><br></pre></td></tr></table></figure><h2 id="9ã€æŸ¥çœ‹å‘½åç©ºé—´"><a href="#9ã€æŸ¥çœ‹å‘½åç©ºé—´" class="headerlink" title="9ã€æŸ¥çœ‹å‘½åç©ºé—´"></a>9ã€æŸ¥çœ‹å‘½åç©ºé—´</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get ns</span></span><br><span class="line">NAME          STATUS   AGE</span><br><span class="line">default       Active   27m</span><br><span class="line">kube-public   Active   27m</span><br><span class="line">kube-system   Active   27m</span><br></pre></td></tr></table></figure><h2 id="10ã€æŸ¥çœ‹systemçš„pod"><a href="#10ã€æŸ¥çœ‹systemçš„pod" class="headerlink" title="10ã€æŸ¥çœ‹systemçš„pod"></a>10ã€æŸ¥çœ‹systemçš„pod</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-86c58d9df4-4gfvd                     1/1     Running   0          27m</span><br><span class="line">coredns-86c58d9df4-cxtz5                     1/1     Running   0          27m</span><br><span class="line">etcd-k8s-zxc-test-3.kxl                      1/1     Running   0          26m</span><br><span class="line">kube-apiserver-k8s-zxc-test-3.kxl            1/1     Running   0          26m</span><br><span class="line">kube-controller-manager-k8s-zxc-test-3.kxl   1/1     Running   0          26m</span><br><span class="line">kube-flannel-ds-nh95x                        1/1     Running   0          15m</span><br><span class="line">kube-proxy-kvlng                             1/1     Running   0          27m</span><br><span class="line">kube-scheduler-k8s-zxc-test-3.kxl            1/1     Running   0          27m</span><br></pre></td></tr></table></figure><h2 id="11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter"><a href="#11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter" class="headerlink" title="11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter"></a>11ã€èŠ‚ç‚¹åŠ å…¥åˆ°kuberneter</h2><ul><li>ä»¥ä¸‹æ˜¯æ¯ä¸ªnodeèŠ‚ç‚¹æ‰§è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm join 172.21.17.4:6443 --token 0mdk7x.du3cn19qm1jl2b0e --discovery-token-ca-cert-hash sha256:19bf79b41a931735b1f2f5138e1daa436ab26a4f19781ccf2015cff749ddb4b9</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦åŠ å…¥</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨kubectl get podså‘½ä»¤æ¥æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€</span></span><br><span class="line"><span class="comment"># kubectl get pods --all-namespaces</span></span><br></pre></td></tr></table></figure><h2 id="12ã€å®‰è£…kubernetes-dashboard"><a href="#12ã€å®‰è£…kubernetes-dashboard" class="headerlink" title="12ã€å®‰è£…kubernetes dashboard"></a>12ã€å®‰è£…kubernetes dashboard</h2><p>ä¸‹è½½å®˜ç½‘çš„dashboardæ–‡ä»¶ä¿®æ”¹kubernetes-dashboard.yamlæ–‡ä»¶,ç”¨ä¿®æ”¹ä¹‹åçš„kubernetes-dashboard.yaml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»ºdashboard</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/kubernetes-dashboard</span></span><br><span class="line"><span class="comment"># kubectl apply -f kubernetes-dashboard.yaml</span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br></pre></td></tr></table></figure><h2 id="13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ"><a href="#13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ" class="headerlink" title="13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ"></a>13ã€æŸ¥çœ‹dashboardéƒ¨ç½²æ˜¯å¦æˆåŠŸ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -n kube-system</span></span><br></pre></td></tr></table></figure><h3 id="13-1ã€æŸ¥çœ‹dashboard-info"><a href="#13-1ã€æŸ¥çœ‹dashboard-info" class="headerlink" title="13.1ã€æŸ¥çœ‹dashboard info"></a>13.1ã€æŸ¥çœ‹dashboard info</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe svc kubernetes-dashboard -n kube-system</span></span><br></pre></td></tr></table></figure><h3 id="13-2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹"><a href="#13-2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹" class="headerlink" title="13.2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹"></a>13.2ã€æŸ¥çœ‹dashboardéƒ¨ç½²åœ¨é‚£ä¸ªèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get pods -n kube-system -o wide</span></span><br></pre></td></tr></table></figure><h3 id="13-3ã€æŸ¥çœ‹service-èŠ‚ç‚¹ç«¯å£"><a href="#13-3ã€æŸ¥çœ‹service-èŠ‚ç‚¹ç«¯å£" class="headerlink" title="13.3ã€æŸ¥çœ‹service èŠ‚ç‚¹ç«¯å£"></a>13.3ã€æŸ¥çœ‹service èŠ‚ç‚¹ç«¯å£</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get service -n kube-system -o wide</span></span><br></pre></td></tr></table></figure><h3 id="13-4ã€åˆ›å»ºdashboard-admin-è´¦æˆ·"><a href="#13-4ã€åˆ›å»ºdashboard-admin-è´¦æˆ·" class="headerlink" title="13.4ã€åˆ›å»ºdashboard admin è´¦æˆ·"></a>13.4ã€åˆ›å»ºdashboard admin è´¦æˆ·</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f admin-user.yaml</span></span><br><span class="line">è·å–tokens</span><br><span class="line"><span class="comment"># kubectl describe serviceaccount admin -n kube-system</span></span><br><span class="line">Name:                admin</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:         kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                       &#123;<span class="string">"apiVersion"</span>:<span class="string">"v1"</span>,<span class="string">"kind"</span>:<span class="string">"ServiceAccount"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"labels"</span>:&#123;<span class="string">"k8s-app"</span>:<span class="string">"kubernetes-dashboard"</span>&#125;,<span class="string">"name"</span>:<span class="string">"admin"</span>,<span class="string">"namesp...</span></span><br><span class="line"><span class="string">Image pull secrets:  &lt;none&gt;</span></span><br><span class="line"><span class="string">Mountable secrets:   admin-token-kxs6k</span></span><br><span class="line"><span class="string">Tokens:              admin-token-kxs6k</span></span><br><span class="line"><span class="string">Events:              &lt;none&gt;</span></span><br><span class="line"><span class="string">æŸ¥çœ‹token ä¿¡æ¯</span></span><br><span class="line"><span class="string"># kubectl describe secret admin-token-kxs6k -n kube-system</span></span><br></pre></td></tr></table></figure><h2 id="14ã€dashboard-è®¿é—®"><a href="#14ã€dashboard-è®¿é—®" class="headerlink" title="14ã€dashboard è®¿é—®"></a>14ã€dashboard è®¿é—®</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;åˆ©ç”¨èŠ‚ç‚¹ip+30001 ç«¯å£è¿›è¡Œè®¿é—®ã€‚è®¿é—®ä¹‹å‰éœ€è¦åœ¨masterèŠ‚ç‚¹ç”Ÿæˆè¯ä¹¦ï¼ŒæŠŠè¯ä¹¦(kubecfg.p12)ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè¿›è¡Œå¯¼å…¥åˆ°æµè§ˆå™¨ï¼Œè¿™é‡Œä½¿ç”¨ç«ç‹æµè§ˆå™¨ï¼Œgoogleæµè§ˆå™¨å¯¼å…¥,ä¸æˆåŠŸï¼Œç”Ÿäº§è¯ä¹¦ä¹‹å‰è®°å¾—ç¬¬9æ­¥å·²æ“ä½œ</p><h3 id="14-1ã€ç”Ÿæˆè¯ä¹¦"><a href="#14-1ã€ç”Ÿæˆè¯ä¹¦" class="headerlink" title="14.1ã€ç”Ÿæˆè¯ä¹¦"></a>14.1ã€ç”Ÿæˆè¯ä¹¦</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grep 'client-certificate-data' ~/.kube/config | head -n 1 | awk '&#123;print $2&#125;' | base64 -d &gt;&gt; kubecfg.crt</span></span><br><span class="line"><span class="comment"># grep 'client-key-data' ~/.kube/config | head -n 1 | awk '&#123;print $2&#125;' | base64 -d &gt;&gt; kubecfg.key</span></span><br><span class="line"><span class="comment"># openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name "kubernetes-client"</span></span><br></pre></td></tr></table></figure><h3 id="14-2ã€dashboard-é…ç½®ä¿®æ”¹"><a href="#14-2ã€dashboard-é…ç½®ä¿®æ”¹" class="headerlink" title="14.2ã€dashboard é…ç½®ä¿®æ”¹"></a>14.2ã€dashboard é…ç½®ä¿®æ”¹</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;kubernetes dashboard v1.10.0ä½¿ç”¨çš„æ˜¯åŒå› å­ç™»é™†ï¼Œé»˜è®¤tokenå¤±æ•ˆçš„æ—¶é—´æ˜¯900ç§’ï¼Œ15åˆ†é’Ÿï¼Œæ¯15åˆ†é’Ÿå°±è¦è¿›è¡Œä¸€æ¬¡è®¤è¯ã€‚æˆ‘ä»¬å¯ä»¥åŠŸè¿‡ä¿®æ”¹token-ttlå‚æ•°æ¥è®¾ç½®ï¼Œä¸»è¦æ˜¯ä¿®æ”¹dashboard.yamlæ–‡ä»¶ï¼Œå¹¶é‡æ–°å»ºç«‹å³å¯</p><ul><li>åœ¨é…ç½®æ–‡ä»¶é‡Œé¢æ·»åŠ <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ports:</span><br><span class="line">- containerPort: 8443</span><br><span class="line">  protocol: TCP</span><br><span class="line">args:</span><br><span class="line">  - --auto-generate-certificates</span><br><span class="line">  - --token-ttl=43200</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>é‡å»ºdashboard,é€šè¿‡åˆ©ç”¨httpæ·»åŠ ç«¯å£30001ï¼Œç„¶ååˆ©ç”¨tonkenè¿›è¡ŒéªŒè¯ç™»é™†,å®‰è£…å¤±è´¥æ¸…ç†ç¯å¢ƒ</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm reset</span></span><br><span class="line">æŸ¥çœ‹åŠ å…¥é›†ç¾¤token</span><br><span class="line"><span class="comment"># kubeadm token list</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos 5.5 å®‰è£…DRBD</title>
    <url>/2019/08/11/Centos-5-5-%E5%AE%89%E8%A3%85DRBD/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>Centos5.5 32bitå®‰è£…DRBD</p><ul><li>å®‰è£…å‰å‡†å¤‡</li></ul><table><thead><tr><th>èŠ‚ç‚¹ç±»å‹</th><th>IPåœ°å€è§„åˆ’</th><th>ä¸»æœºå</th></tr></thead><tbody><tr><td>ä¸»ç”¨èŠ‚ç‚¹</td><td>192.168.1.101</td><td>node2</td></tr><tr><td>å¤‡ç”¨èŠ‚ç‚¹</td><td>192.168.1.102</td><td>node1</td></tr><tr><td>ç£ç›˜</td><td>ä¸¤å°10Gç£ç›˜</td><td></td></tr></tbody></table><h2 id="åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD"><a href="#åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD" class="headerlink" title="åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD"></a>åœ¨ä¸»èŠ‚ç‚¹å®‰è£…DRBD</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># yum -y install kmod-drbd83 drbd83</span></span><br></pre></td></tr></table></figure><p>å®‰è£…æˆåŠŸä¹‹å/sbinç›®å½•ä¸‹é¢æœ‰drbdadmï¼Œdrbdmetaï¼Œdrbdsetupå‘½ä»¤ï¼Œä»¥åŠ/etc /init.d/drbdå¯åŠ¨è„šæœ¬ã€‚</p><ul><li>å¤‡ç”¨èŠ‚ç‚¹å®‰è£…DRBD</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># yum -y install kmod-drbd83 drbd83</span></span><br></pre></td></tr></table></figure><blockquote><p>å®‰è£…å®Œæˆåã€‚é»˜è®¤é…ç½®æ–‡ä»¶/etc/drbd.confï¼Œä»¥ä¸‹æ˜¯ä¸¤å°çš„ä¸»æœºé…ç½®å®ä¾‹:</p></blockquote><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># cat /etc/drbd.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># please have a a look at the example configuration file in</span></span><br><span class="line"><span class="comment"># /usr/share/doc/drbd83/drbd.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># drbd.conf</span></span><br><span class="line"><span class="comment"># create by dba.gao@gmail.com at 2010-10-11</span></span><br><span class="line">global &#123;</span><br><span class="line">    <span class="comment"># minor-count 64;</span></span><br><span class="line">    <span class="comment"># dialog-refresh 5; # 5 seconds</span></span><br><span class="line">    <span class="comment"># disable-ip-verification;</span></span><br><span class="line">usage-count no; <span class="comment">#æ˜¯å¦å‚åŠ DRBDä½¿ç”¨è€…ç»Ÿè®¡ï¼Œé»˜è®¤yes</span></span><br><span class="line">&#125;</span><br><span class="line">common &#123;</span><br><span class="line">    syncer &#123; rate <span class="comment">#è®¾ç½®ä¸»å¤‡èŠ‚ç‚¹åŒæ­¥æ—¶çš„ç½‘ç»œé€Ÿç‡æœ€å¤§å€¼ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚</span></span><br><span class="line">        200M; &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource r0 &#123;</span><br><span class="line">protocol C;</span><br><span class="line"><span class="comment"># ä½¿ç”¨drbdçš„ç¬¬ä¸‰ç§åŒæ­¥åè®®,è¡¨ç¤ºæ”¶åˆ°è¿œç¨‹ä¸»æœºçš„å†™å…¥ç¡®è®¤å,åˆ™è®¤ä¸ºå†™å…¥å®Œæˆ</span></span><br><span class="line">handlers &#123;</span><br><span class="line">    pri-on-incon-degr <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">    pri-lost-after-sb <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">    <span class="built_in">local</span>-io-error <span class="string">"echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</span><br><span class="line">fence-peer <span class="string">"/usr/lib64/heartbeat/drbd-peer-outdater -t 5"</span>;</span><br><span class="line">pri-lost <span class="string">"echo pri-lost. Have a look at the log files. | mail -s 'DRBD Alert' root"</span>;</span><br><span class="line">    split-brain <span class="string">"/usr/lib/drbd/notify-split-brain.sh root"</span>;</span><br><span class="line">    out-of-sync <span class="string">"/usr/lib/drbd/notify-out-of-sync.sh root"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">net &#123;</span><br><span class="line"><span class="comment"># timeout 60;</span></span><br><span class="line"><span class="comment"># connect-int 10;</span></span><br><span class="line"><span class="comment"># ping-int 10;</span></span><br><span class="line"><span class="comment"># max-buffers 2048;</span></span><br><span class="line"><span class="comment"># max-epoch-size 2048;</span></span><br><span class="line">cram-hmac-alg <span class="string">"sha1"</span>;</span><br><span class="line">shared-secret <span class="string">"MySQL-HA"</span>;</span><br><span class="line"><span class="comment"># DRBDåŒæ­¥æ—¶ä½¿ç”¨çš„éªŒè¯æ–¹å¼å’Œå¯†ç ä¿¡æ¯ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line">disk &#123;</span><br><span class="line">    on-io-error detach;</span><br><span class="line">fencing resource-only;</span><br><span class="line">&#125;</span><br><span class="line">startup &#123;</span><br><span class="line">    wfc-timeout 120;</span><br><span class="line">    degr-wfc-timeout 120;</span><br><span class="line">  &#125;</span><br><span class="line">  device        /dev/drbd0;</span><br><span class="line"><span class="comment">#è¿™é‡Œé…ç½®æ¡£æˆ‘ä»¬æŒ‚åœ¨çš„ç³»ç»Ÿçš„ç£ç›˜æ ‡ç¤ºé©±åŠ¨ç›˜ç¬¦; on node2 &#123;</span></span><br><span class="line"><span class="comment">#æ¯ä¸ªä¸»æœºçš„è¯´æ˜ä»¥onå¼€å¤´,åé¢æ˜¯hostname(uname - n)ï¼Œåœ¨åé¢çš„&#123;&#125;ä¸­ä¸ºè¿™ä¸ªä¸»æœºçš„é…ç½®ã€‚</span></span><br><span class="line">disk /dev/sdb5;</span><br><span class="line"><span class="comment">#/dev/drbd0ä½¿ç”¨çš„ç£ç›˜åˆ†åŒºæ˜¯/dev/sdb5</span></span><br><span class="line">address     192.168.1.101:7788;</span><br><span class="line">IPåœ°å€ä»¥åŠDRBDä½¿ç”¨çš„ç«¯å£ meta-disk internal;</span><br><span class="line">&#125;</span><br><span class="line">on node1 &#123;</span><br><span class="line">disk /dev/sdb5;</span><br><span class="line">address 192.168.1.102:7788; å’Œä¸Šè¿°ä¸€æ ·</span><br><span class="line">meta-disk internal; <span class="comment">#drbdçš„å…ƒæ•°æ®å­˜æ”¾æ–¹å¼ &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;é…ç½®å®Œæˆåå¯åŠ¨èŠ‚ç‚¹ï¼Œåœ¨å¯åŠ¨DRBDä¹‹å‰,ä½ éœ€è¦åˆ†åˆ«åœ¨ä¸¤å°ä¸»æœºçš„hdåˆ†åŒºä¸Š,åˆ›å»ºä¾›DRBDè®°å½•ä¿¡æ¯çš„æ•°æ®å—.åˆ†åˆ«åœ¨ä¸¤å°ä¸»æœºä¸Šæ‰§è¡Œ(è¿™é‡Œæ³¨æ„:åœ¨åˆ›å»ºåˆ†åŒºä¹‹å‰æˆ‘ä»¬éœ€è¦å§ç£ç›˜çš„åˆ†åŒºåˆ†å¥½)</p><p><img src alt="img"></p><p>åˆ†åŒºåˆ†å¥½ä»¥åå…ˆä¸è¦æŒ‚åœ¨å’Œæ ¼å¼åŒ–(æŒ‚åœ¨ä»¥ååˆ›å»ºä¼šæŠ¥é”™)ï¼Œç„¶ååˆ›å»ºä¾›DRBDè®° å½•ä¿¡æ¯çš„æ•°æ®å—</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># drbdadm create-md r0</span></span><br><span class="line">[root@node1 ~]<span class="comment"># drbdadm create-md r0</span></span><br><span class="line">æˆ–è€…æ‰§è¡Œdrbdadm create-md all</span><br></pre></td></tr></table></figure><ul><li><p>åœ¨ä¸¤ä¸ªèŠ‚ç‚¹å¯åŠ¨æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># /etc/init.d/drbd start</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /etc/init.d/drbd start</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨ä»»æ„èŠ‚ç‚¹æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</p></li></ul><blockquote><p>1: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C râ€”-<br>ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:2007644</p></blockquote><blockquote><p>å¯¹è¾“å‡ºçš„å«ä¹‰è§£é‡Šå¦‚ä¸‹:<br>roè¡¨ç¤ºè§’è‰²ä¿¡æ¯ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨drbdæ—¶ï¼Œä¸¤ä¸ªdrbdèŠ‚ç‚¹é»˜è®¤éƒ½å¤„äºSecondaryçŠ¶æ€,<br>dsæ˜¯ç£ç›˜çŠ¶æ€ä¿¡æ¯ï¼Œâ€œInconsistent/Inconsistenâ€ï¼Œå³ä¸ºâ€œä¸ä¸€è‡´/ä¸ä¸€è‡´â€ çŠ¶æ€ï¼Œè¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹çš„ç£ç›˜æ•°æ®å¤„äºä¸ä¸€è‡´çŠ¶æ€ã€‚<br>Nsè¡¨ç¤ºç½‘ç»œå‘é€çš„æ•°æ®åŒ…ä¿¡æ¯ã€‚</p></blockquote><h3 id="è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2"><a href="#è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2" class="headerlink" title="è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2"></a>è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># drbdsetup /dev/drbd1 primary â€“o æˆ–è€…æ‰§è¡Œä¸‹é¢å‘½ä»¤ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line">[root@node2 ~]<span class="comment">#drbdadm -- --overwrite-data-of-peer primary all</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæ­¤å‘½ä»¤åï¼Œåœ¨åé¢å¦‚æœéœ€è¦è®¾ç½®å“ªä¸ªæ˜¯ä¸»èŠ‚ç‚¹æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨å¦ å¤–ä¸€ä¸ªå‘½ä»¤:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment">#/sbin/drbdadm primary r0æˆ–è€…/sbin/drbdadm primary all</span></span><br></pre></td></tr></table></figure><blockquote><p>æ‰§è¡Œæ­¤å‘½ä»¤åï¼Œå¼€å§‹åŒæ­¥ä¸¤å°æœºå™¨å¯¹åº”ç£ç›˜çš„æ•°æ®</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ node2 ~]<span class="comment">#cat /proc/drbd</span></span><br><span class="line">1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r--- -</span><br><span class="line">ns:576224 nr:0 dw:0 dr:581760 al:0 bm:34 lo:84 pe:369 ua:256 ap:0 ep:1 wo:b oos:1443196</span><br><span class="line">[====&gt;...............] sync<span class="string">'ed: 28.4% (1443196/2007644)K delay_probe: 69</span></span><br><span class="line"><span class="string">finish: 0:03:56 speed: 6,024 (5,876) K/sec</span></span><br></pre></td></tr></table></figure><blockquote><p>æœ€åæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ,ç”±äºmountæ“ä½œåªèƒ½åœ¨ä¸»èŠ‚ç‚¹è¿›è¡Œï¼Œæ‰€ä»¥åªæœ‰è®¾ç½®äº†ä¸»èŠ‚ç‚¹åæ‰èƒ½æ ¼å¼åŒ–ç£ç›˜åˆ† åŒºï¼Œç„¶åæŒ‚è½½:</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node2 ~]<span class="comment"># mkfs -t ext3 /dev/drbd0</span></span><br><span class="line">[root@node2 ~]<span class="comment"># mount /dev/drbd0 /data/</span></span><br><span class="line">[root@node2 ~]<span class="comment"># df -h</span></span><br><span class="line">Filesystem</span><br><span class="line">/dev/sda3</span><br><span class="line">/dev/sda1</span><br><span class="line">tmpfs</span><br><span class="line">/dev/drbd0</span><br><span class="line">Size  Used Avail Use% Mounted on</span><br><span class="line"> 28G  3.7G   23G  15% /</span><br><span class="line">487M   22M  440M   5% /boot</span><br><span class="line">125M     0  125M   0% /dev/shm</span><br><span class="line">9.9G  151M  9.2G   2% /data</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;Dwæ˜¯ç£ç›˜å†™ä¿¡æ¯;Dræ˜¯ç£ç›˜è¯»ä¿¡æ¯;å¯åŠ¨DRBDåè®¾ç½®ä¸»æ¬¡èŠ‚ç‚¹ï¼Œé€‰æ‹©éœ€è¦è®¾ç½®ä¸»æœºçš„ä¸»èŠ‚ç‚¹ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤: è¿™é‡Œæˆ‘è®¾ç½®æ˜¯node2</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>å­˜å‚¨,Centos</category>
      </categories>
      <tags>
        <tag>drdb</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle ORA-12519</title>
    <url>/2019/08/10/oracle-ORA-12519/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><blockquote><p>oracle ORA-12519é”™è¯¯è§£å†³<br>ä»Šå¤©é‡åˆ°åšç³»ç»Ÿå‹åŠ›æµ‹è¯•çš„æ—¶å€™ï¼Œç³»ç»ŸæŠ¥äº†ä¸€ä¸ªé”™è¯¯<br>OERR: ORA-12519 TNS:no appropriate service handler found</p></blockquote><p><img src="https://img.xxlaila.cn/ORA-12519-error.png" alt="img"></p><p>åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€ä¸‹oralcçš„é”™è¯¯ä¿¡æ¯ORA-12519ï¼Œè§£å†³åŠæ³•æŒºå¤šçš„ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p><h3 id="ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“"><a href="#ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“" class="headerlink" title="ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“"></a>ç™»é™†oracleçš„æœåŠ¡å™¨ï¼Œåœ¨ç™»é™†oracleæ•°æ®åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlplus <span class="string">"/as sysdba"</span></span><br></pre></td></tr></table></figure><blockquote><p>é¦–å…ˆæ£€æŸ¥processå’Œsessionçš„ä½¿ç”¨æƒ…å†µ</p></blockquote><p><img src="https://img.xxlaila.cn/parameter_%20processes_1.png" alt="img"><br><img src="https://img.xxlaila.cn/parameter_%20session_3.png" alt="img"></p><a id="more"></a><ul><li>è¿™é‡Œå¯ä»¥çœ‹åˆ°processå‡ ä¹å·²ç»æ»¡äº†</li></ul><h3 id="ä¿®æ”¹oracleçš„processå’Œsessionå€¼"><a href="#ä¿®æ”¹oracleçš„processå’Œsessionå€¼" class="headerlink" title="ä¿®æ”¹oracleçš„processå’Œsessionå€¼"></a>ä¿®æ”¹oracleçš„processå’Œsessionå€¼</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œæˆ‘ä»¬æŠŠè¿™äº›å€¼ä¿®æ”¹ä¸º1000å’Œ1135</span><br><span class="line">SQL&gt; alter system <span class="built_in">set</span> processes=1000 scope=spfile;</span><br><span class="line">ç³»ç»Ÿå·²æ›´æ”¹ã€‚</span><br><span class="line">SQL&gt; alter system <span class="built_in">set</span> sessions=1135 scope=spfile;</span><br><span class="line">ç³»ç»Ÿå·²æ›´æ”¹ã€‚</span><br></pre></td></tr></table></figure><h3 id="é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ"><a href="#é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ" class="headerlink" title="é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ"></a>é‡å¯æ•°æ®åº“åå‚æ•°ä¿®æ”¹å®Œæˆ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; shutdown abort;</span><br><span class="line">ORACLE ä¾‹ç¨‹å·²ç»å…³é—­ã€‚</span><br><span class="line">SQL&gt; startup;</span><br><span class="line">ORACLE ä¾‹ç¨‹å·²ç»å¯åŠ¨ã€‚</span><br><span class="line">Total System Global Area  534462464 bytes</span><br><span class="line">Fixed Size                  2215064 bytes</span><br><span class="line">Variable Size             234881896 bytes</span><br><span class="line">Database Buffers          289406976 bytes</span><br><span class="line">Redo Buffers                7958528 bytes</span><br><span class="line">æ•°æ®åº“è£…è½½å®Œæ¯•ã€‚</span><br><span class="line">æ•°æ®åº“å·²ç»æ‰“å¼€ã€‚</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹å¹¶éªŒè¯"><a href="#æŸ¥çœ‹å¹¶éªŒè¯" class="headerlink" title="æŸ¥çœ‹å¹¶éªŒè¯"></a>æŸ¥çœ‹å¹¶éªŒè¯</h2><p><img src="https://img.xxlaila.cn/W.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>oracle</category>
      </categories>
      <tags>
        <tag>ORA-12519</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx https</title>
    <url>/2019/08/10/nginx-https/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>nginx http å¼ºåˆ¶è·³è½¬åˆ°https</p><h2 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$server_port</span> = 80 ) &#123;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$server_port</span> = 80 ) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123; <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>; &#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$host</span> != xxx.test.com) &#123; <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://xxx.test.com<span class="variable">$request_uri</span>; &#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ—å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name xxx.test.com;</span><br><span class="line">    index index.html index.php index.htm;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123; <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$host</span> != xxx.test.com) &#123; <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://xxx.test.com<span class="variable">$request_uri</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•å››"><a href="#æ–¹æ³•å››" class="headerlink" title="æ–¹æ³•å››"></a>æ–¹æ³•å››</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    rewrite ^(.*) https://www.test.com<span class="variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¾‹å­</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    rewrite ^(.*) https://www.test.com<span class="variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    root ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•äº”"><a href="#æ–¹æ³•äº”" class="headerlink" title="æ–¹æ³•äº”"></a>æ–¹æ³•äº”</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com www.test.com;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>https</tag>
      </tags>
  </entry>
  <entry>
    <title>haproxy keepalived </title>
    <url>/2019/08/10/haproxy-keepalived/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>æœ¬æ–‡ä¸»è¦æ˜¯ä»£ç†kubernetes masterçš„é«˜å¯ç”¨ã€‚</p><h2 id="å®‰è£…haproxyå’Œkeepalived"><a href="#å®‰è£…haproxyå’Œkeepalived" class="headerlink" title="å®‰è£…haproxyå’Œkeepalived"></a>å®‰è£…haproxyå’Œkeepalived</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install keepalived.x86_64</span></span><br><span class="line"><span class="comment"># yum -y install haproxy18u.x86_64</span></span><br></pre></td></tr></table></figure><h2 id="2ã€é…ç½®haproxy"><a href="#2ã€é…ç½®haproxy" class="headerlink" title="2ã€é…ç½®haproxy"></a>2ã€é…ç½®haproxy</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/haproxy/haproxy.cfg</span></span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  uid 99</span><br><span class="line">  gid 99</span><br><span class="line">  <span class="comment">#daemon</span></span><br><span class="line">  nbproc 1</span><br><span class="line">  pidfile haproxy.pid</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  retries 3</span><br><span class="line">  timeout connect 5s</span><br><span class="line">  timeout client 30s</span><br><span class="line">  timeout server 30s</span><br><span class="line">  timeout check 2s</span><br><span class="line"></span><br><span class="line">listen admin_stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:1080</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  stats refresh 30s</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    admin:admin1</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats admin <span class="keyword">if</span> TRUE</span><br><span class="line"></span><br><span class="line">frontend k8s-https</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  default_backend k8s-http</span><br><span class="line"></span><br><span class="line">backend k8s-http</span><br><span class="line">  mode tcp</span><br><span class="line">  balance roundrobin</span><br><span class="line">  server k8s-master-01 172.21.17.4:6443</span><br><span class="line">  server k8s-master-02 172.21.16.230:6443</span><br><span class="line">  server k8s-master-03 172.21.240:6443</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="3ã€keepalivedé…ç½®"><a href="#3ã€keepalivedé…ç½®" class="headerlink" title="3ã€keepalivedé…ç½®"></a>3ã€keepalivedé…ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  notification_email &#123;</span><br><span class="line">    cq_xxlaila@163.com</span><br><span class="line">    &#125;</span><br><span class="line">  notification_email_from cq_xxlaila@163.com</span><br><span class="line">  smtp_server 127.0.0.1</span><br><span class="line">  smtp_connect_timeout 30</span><br><span class="line">  router_id haproxy-01</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/haproxy_check.sh"</span></span><br><span class="line">  interval 2</span><br><span class="line">  timeout 2</span><br><span class="line">  fall 3</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    dont_track_primary</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass 57D0BC82E074C9D6</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      172.21.16.45</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç›‘æµ‹è„šæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat haproxy_check.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">A=`ps -C haproxy --no-header | wc -l`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$A</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    systemctl start haproxy</span><br><span class="line">    sleep 3</span><br><span class="line">    <span class="keyword">if</span> [ `ps -C haproxy --no-header | wc -l ` -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        systemctl stop haproxy</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æœåŠ¡</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl enable haproxy &amp;&amp;systemctl enable keepalived</span></span><br><span class="line"><span class="comment"># systemctl start keepalived &amp;&amp;systemctl start haproxy</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>haproxy,keepalived,kubernetes</category>
      </categories>
      <tags>
        <tag>haproxy,keepalived</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s-prometheus</title>
    <url>/2019/08/10/k8s-prometheus/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p><a href="https://prometheus.io/" target="_blank" rel="noopener">Prometheus</a>æ˜¯ä¸€ä¸ªé›†æ•°æ®æ”¶é›†å­˜å‚¨ã€æ•°æ®æŸ¥è¯¢å’Œæ•°æ®å›¾è¡¨æ˜¾ç¤ºäºä¸€èº«çš„å¼€æºç›‘æ§ç»„ä»¶ã€‚æœ¬æ–‡ä¸»è¦è®²è§£å¦‚ä½•æ­å»ºPrometheusï¼Œå¹¶ä½¿ç”¨å®ƒç›‘æ§Kubernetesé›†ç¾¤ã€‚</p><h2 id="1ã€ä¸‹è½½ç›¸å…³yaml"><a href="#1ã€ä¸‹è½½ç›¸å…³yaml" class="headerlink" title="1ã€ä¸‹è½½ç›¸å…³yaml"></a>1ã€ä¸‹è½½ç›¸å…³yaml</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/xxlaila/kubernetes-yaml/tree/master/prometheus-grafana</span></span><br><span class="line"><span class="comment"># ls -l</span></span><br><span class="line">configmap.yaml</span><br><span class="line">grafana-deploy.yaml</span><br><span class="line">grafana-ingress.yaml</span><br><span class="line">grafana-svc.yaml</span><br><span class="line">node-exporter.yaml</span><br><span class="line">prometheus-deploy.yaml</span><br><span class="line">prometheus-svc.yaml</span><br><span class="line">rbac-setup.yaml</span><br><span class="line">prometheus-ingress.yaml</span><br></pre></td></tr></table></figure><h2 id="2ã€å¼€å§‹éƒ¨ç½²"><a href="#2ã€å¼€å§‹éƒ¨ç½²" class="headerlink" title="2ã€å¼€å§‹éƒ¨ç½²"></a>2ã€å¼€å§‹éƒ¨ç½²</h2><h3 id="2-1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶"><a href="#2-1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶" class="headerlink" title="2.1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶"></a>2.1ã€é‡‡ç”¨daemonsetæ–¹å¼éƒ¨ç½²node-exporterç»„ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f  node-exporter.yaml</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="2-2ã€éƒ¨ç½²prometheusç»„ä»¶"><a href="#2-2ã€éƒ¨ç½²prometheusç»„ä»¶" class="headerlink" title="2.2ã€éƒ¨ç½²prometheusç»„ä»¶"></a>2.2ã€éƒ¨ç½²prometheusç»„ä»¶</h3><h4 id="2-2-1ã€rbacæ–‡ä»¶"><a href="#2-2-1ã€rbacæ–‡ä»¶" class="headerlink" title="2.2.1ã€rbacæ–‡ä»¶"></a>2.2.1ã€rbacæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f rbac-setup.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶"><a href="#2-2-2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶" class="headerlink" title="2.2.2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶"></a>2.2.2ã€ä»¥configmapçš„å½¢å¼ç®¡ç†prometheusç»„ä»¶çš„é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f configmap.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3ã€Prometheus-deployment-æ–‡ä»¶"><a href="#2-2-3ã€Prometheus-deployment-æ–‡ä»¶" class="headerlink" title="2.2.3ã€Prometheus deployment æ–‡ä»¶"></a>2.2.3ã€Prometheus deployment æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f  prometheus-deploy.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-4ã€Prometheus-serviceæ–‡ä»¶"><a href="#2-2-4ã€Prometheus-serviceæ–‡ä»¶" class="headerlink" title="2.2.4ã€Prometheus serviceæ–‡ä»¶"></a>2.2.4ã€Prometheus serviceæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f prometheus-svc.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-2-5ã€é…ç½®Ingress"><a href="#2-2-5ã€é…ç½®Ingress" class="headerlink" title="2.2.5ã€é…ç½®Ingress"></a>2.2.5ã€é…ç½®Ingress</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f prometheus-ingress.yaml</span></span><br></pre></td></tr></table></figure><h3 id="2-3ã€éƒ¨ç½²grafanaç»„ä»¶"><a href="#2-3ã€éƒ¨ç½²grafanaç»„ä»¶" class="headerlink" title="2.3ã€éƒ¨ç½²grafanaç»„ä»¶"></a>2.3ã€éƒ¨ç½²grafanaç»„ä»¶</h3><h4 id="2-3-1ã€grafana-deploymenté…ç½®æ–‡ä»¶"><a href="#2-3-1ã€grafana-deploymenté…ç½®æ–‡ä»¶" class="headerlink" title="2.3.1ã€grafana deploymenté…ç½®æ–‡ä»¶"></a>2.3.1ã€grafana deploymenté…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-deploy.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-3-2ã€grafana-serviceé…ç½®æ–‡ä»¶"><a href="#2-3-2ã€grafana-serviceé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.2ã€grafana serviceé…ç½®æ–‡ä»¶"></a>2.3.2ã€grafana serviceé…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-svc.yaml</span></span><br></pre></td></tr></table></figure><h4 id="2-3-3ã€grafana-ingressé…ç½®æ–‡ä»¶"><a href="#2-3-3ã€grafana-ingressé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.3ã€grafana ingressé…ç½®æ–‡ä»¶"></a>2.3.3ã€grafana ingressé…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f grafana-ingress.yaml</span></span><br></pre></td></tr></table></figure><h3 id="2-4ã€WEBç•Œé¢é…ç½®"><a href="#2-4ã€WEBç•Œé¢é…ç½®" class="headerlink" title="2.4ã€WEBç•Œé¢é…ç½®"></a>2.4ã€WEBç•Œé¢é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc,pods -n kube-ops</span></span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/46ds9824.png" alt="img"></p><h4 id="2-4-1-æŸ¥çœ‹node-exporter"><a href="#2-4-1-æŸ¥çœ‹node-exporter" class="headerlink" title="2.4.1 æŸ¥çœ‹node-exporter"></a>2.4.1 æŸ¥çœ‹node-exporter</h4><p><img src="https://img.xxlaila.cn/8764kjfnks.png" alt="img"></p><h4 id="2-4-2ã€æŸ¥çœ‹promethues"><a href="#2-4-2ã€æŸ¥çœ‹promethues" class="headerlink" title="2.4.2ã€æŸ¥çœ‹promethues"></a>2.4.2ã€æŸ¥çœ‹promethues</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;prometheuså¯¹åº”çš„nodeportç«¯å£ä¸º30005ï¼Œé€šè¿‡è®¿é—®<a href="http://172.21.17.4:30005/targets" target="_blank" rel="noopener">http://172.21.17.4:30005/targets</a> å¯ä»¥çœ‹åˆ°prometheuså·²ç»æˆåŠŸè¿æ¥ä¸Šäº†k8sçš„apiserver,è¿™é‡Œæˆ‘ä»¬å‰é¢å¢åŠ äº†prometheusçš„ingressï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥é€šè¿‡åŸŸåè¿›è¡Œè®¿é—®</p><p><img src="https://img.xxlaila.cn/skd9234342.png" alt="img"></p><h4 id="2-4-3ã€è®¿é—®grafana"><a href="#2-4-3ã€è®¿é—®grafana" class="headerlink" title="2.4.3ã€è®¿é—®grafana"></a>2.4.3ã€è®¿é—®grafana</h4><p>é€šè¿‡åŸŸåè®¿é—®grafanaï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç å‡ä¸ºadminï¼Œé…ç½®æ•°æ®æº<br><img src="https://img.xxlaila.cn/sld023423.png" alt="img"></p><ul><li>åˆ°grafanaå®˜æ–¹<a href="https://grafana.com/dashboards/315" target="_blank" rel="noopener">ä¸‹è½½æ¨¡ç‰ˆ</a>ï¼Œå¯¼å…¥jsonæ¨¡ç‰ˆ</li></ul><p><img src="https://img.xxlaila.cn/kf24skdsfds.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>kubednsæ’ä»¶é…ç½®</title>
    <url>/2019/08/10/kubedns%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h1 id="å®‰è£…å’Œé…ç½®kubednsæ’ä»¶"><a href="#å®‰è£…å’Œé…ç½®kubednsæ’ä»¶" class="headerlink" title="å®‰è£…å’Œé…ç½®kubednsæ’ä»¶"></a>å®‰è£…å’Œé…ç½®kubednsæ’ä»¶</h1><h2 id="1ã€é…ç½®æ–‡ä»¶å‡†å¤‡"><a href="#1ã€é…ç½®æ–‡ä»¶å‡†å¤‡" class="headerlink" title="1ã€é…ç½®æ–‡ä»¶å‡†å¤‡"></a>1ã€é…ç½®æ–‡ä»¶å‡†å¤‡</h2><p>ä¸‹è½½å®˜æ–¹çš„yamlæ–‡ä»¶ç›®å½•ï¼škubernetes/cluster/addons/dnsã€‚è¯¥æ’ä»¶ç›´æ¥ä½¿ç”¨kuberneteséƒ¨ç½²,yamlæ–‡ä»¶ç»è¿‡ä¿®æ”¹å®Œæˆéƒ¨ç½²</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/xxlaila/kubernetes-yaml.git</span></span><br><span class="line"><span class="comment"># cd kubernetes-yaml/coredns</span></span><br><span class="line"><span class="comment"># sed -i 's/10.96.0.10/10.254.0.2/g' coredns-service.yaml</span></span><br><span class="line"><span class="comment"># kubectl create -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods,svc,rs -n kube-system</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-68676b6b88-l7b5g   1/1     Running   0          16m</span><br><span class="line"></span><br><span class="line">NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">service/coredns   ClusterIP   10.254.0.2   &lt;none&gt;        53/UDP,53/TCP   16m</span><br><span class="line"></span><br><span class="line">NAME                                       DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.extensions/coredns-68676b6b88   1         1         1       16m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-68676b6b88-l7b5g                1/1     Running   0          40m     10.254.28.2   172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…å’Œé…ç½®dashboard"><a href="#2ã€å®‰è£…å’Œé…ç½®dashboard" class="headerlink" title="2ã€å®‰è£…å’Œé…ç½®dashboard"></a>2ã€å®‰è£…å’Œé…ç½®dashboard</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;å®˜æ–¹é…ç½®æ–‡ä»¶kubernetes/cluster/addons/dashboardï¼Œè¿™é‡Œå·²ç»ä¿®æ”¹è¿‡äº†ï¼Œç»è¿‡æµ‹è¯•éƒ¨ç½²ï¼Œç›´æ¥è¿›å…¥dashboardç›®å½•ï¼Œä¿®æ”¹inageså‚æ•°è¿›è¡Œéƒ¨ç½²</p><a id="more"></a><h3 id="2-1ã€å®‰è£…dashboard"><a href="#2-1ã€å®‰è£…dashboard" class="headerlink" title="2.1ã€å®‰è£…dashboard"></a>2.1ã€å®‰è£…dashboard</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ../kubernetes-dashboard</span></span><br><span class="line"><span class="comment"># kubectl create -f kubernetes-dashboard.yaml </span></span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">kubernetes-dashboard-6c655d9445-4557x   1/1     Running   0          6m54s   10.254.90.2   172.21.16.110   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="2-2ã€é…ç½®è´¦æˆ·æˆæƒ"><a href="#2-2ã€é…ç½®è´¦æˆ·æˆæƒ" class="headerlink" title="2.2ã€é…ç½®è´¦æˆ·æˆæƒ"></a>2.2ã€é…ç½®è´¦æˆ·æˆæƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f admin-user.yaml </span></span><br><span class="line">serviceaccount/admin created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin created</span><br><span class="line"><span class="comment"># kubectl describe serviceaccount admin -n kube-system</span></span><br><span class="line">Name:                admin</span><br><span class="line">Namespace:           kube-system</span><br><span class="line">Labels:              k8s-app=kubernetes-dashboard</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   admin-token-wwjw8</span><br><span class="line">Tokens:              admin-token-wwjw8</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"><span class="comment"># kubectl describe secret admin-token-wwjw8 -n kube-system</span></span><br><span class="line">åœ¨æµè§ˆå™¨è®¿é—®ä»»æ„èŠ‚ç‚¹IPåœ°å€http://&lt;node_ip&gt;:30001</span><br></pre></td></tr></table></figure><h2 id="3ã€ç›‘æ§å®‰è£…"><a href="#3ã€ç›‘æ§å®‰è£…" class="headerlink" title="3ã€ç›‘æ§å®‰è£…"></a>3ã€ç›‘æ§å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ../heapster-influxdb-grafana</span></span><br><span class="line"><span class="comment"># kubectl create -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods -o wide -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE   IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">heapster-658646db69-lh5tx               1/1     Running   0          11m   10.254.28.3   172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">monitoring-grafana-7bfc56ffcd-kgh56     1/1     Running   0          11m   10.254.90.3   172.21.16.110   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">monitoring-influxdb-7478d7675c-9255v    1/1     Running   0          11m   10.254.85.2   172.21.16.244   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œé‡åˆ°ä¸€ä¸ªæ€ªäº‹æƒ…ï¼›heapsterå®‰è£…ä»¥åå›¾å§‹ç»ˆæ— æ³•å‡ºæ¥ï¼Œè¿™é‡ŒæŠ˜è…¾å·®ä¸å¤šå¤§åŠå¤©ã€‚æœ€ååœ¨dashboardçš„yamlæ–‡ä»¶é‡Œé¢æ·»åŠ äº†ä»¥ä¸‹å‚æ•°ï¼Œå›¾å°±å¯ä»¥äº†ï¼Œ</p><p><img src="https://img.xxlaila.cn/4udfs93.png" alt="img"></p><p>args:<br>- â€“auto-generate-certificates<br>- â€“token-ttl=43200<br><em>- â€“heapster-host=<a href="http://heapster" target="_blank" rel="noopener">http://heapster</a></em></p><p><img src="https://img.xxlaila.cn/ds832948dk.png" alt="img"></p><p>Prometheusçš„å®‰è£…è¯·å‚è€ƒ<a href="http://xxlaila.github.io/2019/08/10/k8s-prometheus/" target="_blank" rel="noopener">ã€ŠPrometheus å…¥é—¨ã€‹</a>æ–‡ç« ï¼Œgrafanaä¸éœ€è¦é‡å¤éƒ¨ç½²ã€‚åªéœ€è¦åœ¨grafanaé‡Œé¢å¢åŠ ç›®å½•æŒ‚åœ¨ï¼Œå§kube-ops ä¿®æ”¹kube-systemå³å¯</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kube-dns,dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes nodeèŠ‚ç‚¹å®‰è£…</title>
    <url>/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><p>More: <a href="https://xxlaila.github.io/2019/08/09/kubernetes-v1-13-3%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">masterèŠ‚ç‚¹å®‰è£…è¯·å‚è€ƒ</a></p><h2 id="1ã€éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹"><a href="#1ã€éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹" class="headerlink" title="1ã€éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹"></a>1ã€éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹</h2><p>Kubernetes nodeèŠ‚ç‚¹åŒ…å«å¦‚ä¸‹ç»„ä»¶ï¼š</p><ul><li><strong>Flanneld</strong>: ä¹‹å‰å•æœºèŠ‚ç‚¹å®‰è£…æ²¡æœ‰é…ç½®TLSï¼Œç°åœ¨éœ€è¦åœ¨serviceé…ç½®æ–‡ä»¶ä¸­å¢åŠ TLSé…ç½®</li><li><strong>Docker</strong>: version 18.06.2-ce</li><li><strong>kubelet</strong></li><li><strong>kube-proxy</strong></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls /etc/kubernetes/</span></span><br><span class="line">bootstrap.kubeconfig  kubelet   kube-proxy.kubeconfig  proxy  ssl</span><br><span class="line"><span class="comment"># ls /etc/kubernetes/ssl</span></span><br><span class="line">admin-key.pem  kube-apiserver-key.pem  kube-controller-manager-key.pem  kubelet-api-admin-key.pem   kube-proxy-key.pem  kubernetes-ca-key.pem  kube-scheduler-key.pem</span><br><span class="line">admin.pem      kube-apiserver.pem      kube-controller-manager.pem      kubelet-api-admin.pem       kube-proxy.pem      kubernetes-ca.pem      kube-scheduler.pem</span><br></pre></td></tr></table></figure><h3 id="å¢åŠ docker-æº"><a href="#å¢åŠ docker-æº" class="headerlink" title="å¢åŠ docker æº"></a>å¢åŠ docker æº</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum-config-manager \</span></span><br><span class="line">  --add-repo \</span><br><span class="line">  https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><ul><li><p>æ ¹æ®å®é™…æŸ¥æ‰¾å½“å‰ç‰ˆæœ¬ (å¯é€‰)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum list docker-ce --showduplicates | sort -r</span></span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœç¡®å®šäº†ç‰ˆæœ¬,ç›´æ¥å®‰è£…,å¦‚æœè¦è£…17ã€‚03ç›´æ¥ä¿®æ”¹ä¸‹é¢æ•°å­—å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install docker-ce-18.06.2.ce-3.el7  # ä¸»æ„ç‰ˆæœ¬å¡«å†™åŒ…åçš„æ ¼å¼.</span></span><br></pre></td></tr></table></figure></li><li><p>å¯dockeræœåŠ¡,å’Œå¼€æœºå¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="1-1ã€å®‰è£…flanneld"><a href="#1-1ã€å®‰è£…flanneld" class="headerlink" title="1.1ã€å®‰è£…flanneld"></a>1.1ã€å®‰è£…flanneld</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mv kubernetes  /etc/ &amp;&amp; chown -R root: /etc/kubernetes</span></span><br><span class="line"><span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf flannel-v0.11.0-linux-amd64.tar.gz &amp;&amp; mv flanneld mk-docker-opts.sh /usr/bin/ &amp;&amp; rm -rf flannel-v0.11.0-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><h4 id="1-1-1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶"><a href="#1-1-1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶" class="headerlink" title="1.1.1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶"></a>1.1.1ã€flanneldå¯åŠ¨é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/flanneld.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=etcd.service</span><br><span class="line">Before=docker.service</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/etc/sysconfig/flanneld</span><br><span class="line">ExecStart=/usr/bin/flanneld -etcd-endpoints=<span class="variable">$&#123;FLANNEL_ETCD&#125;</span> <span class="variable">$FLANNEL_OPTIONS</span></span><br><span class="line">ExecStartPost=/usr/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">RequiredBy=docker.service</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="1-1-2ã€flanneldé…ç½®æ–‡ä»¶"><a href="#1-1-2ã€flanneldé…ç½®æ–‡ä»¶" class="headerlink" title="1.1.2ã€flanneldé…ç½®æ–‡ä»¶"></a>1.1.2ã€flanneldé…ç½®æ–‡ä»¶</h4><p>flanneld é…ç½®æ–‡ä»¶è¿æ¥äº†etcdï¼Œè€Œåœ¨é…ç½®etcdçš„æ—¶å€™éœ€è¦è¯ä¹¦ï¼Œæ‰€ä»¥è®°çš„å§è¯ä¹¦copyåˆ°nodeèŠ‚ç‚¹ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/sysconfig/flanneld</span></span><br><span class="line"><span class="comment"># Flanneld configuration options</span></span><br><span class="line"><span class="comment"># etcd url location.  Point this to the server where etcd runs</span></span><br><span class="line">FLANNEL_ETCD=<span class="string">"https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379"</span></span><br><span class="line"><span class="comment"># etcd config key.  This is the configuration key that flannel queries</span></span><br><span class="line"><span class="comment"># For address range assignment</span></span><br><span class="line">FLANNEL_ETCD_PREFIX=<span class="string">"/coreos.com/network"</span></span><br><span class="line"><span class="comment"># Any additional options that you want to pass</span></span><br><span class="line">FLANNEL_OPTIONS=<span class="string">"-etcd-cafile=/etc/etcd/ssl/etcd-ca.pem -etcd-certfile=/etc/etcd/ssl/etcd.pem -etcd-keyfile=/etc/etcd/ssl/etcd-key.pem"</span></span><br></pre></td></tr></table></figure><ul><li>åœ¨å¯åŠ¨flanneldä¹‹å‰ï¼Œéœ€è¦åœ¨etcdä¸­æ·»åŠ ä¸€æ¡ç½‘ç»œé…ç½®è®°å½•ï¼Œè¿™ä¸ªé…ç½®å°†ç”¨äºflanneldåˆ†é…ç»™æ¯ä¸ªdockerçš„è™šæ‹Ÿipåœ°å€æ®µ,</li><li>åœ¨ä»»æ„ä¸€å°masteræ‰§è¡Œ<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl set /coreos.com/network/config '&#123; "Network": "10.254.0.0/16" &#125;'</span></span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"10.254.0.0/16"</span> &#125;</span><br><span class="line"><span class="comment"># etcdctl get  /coreos.com/network/config </span></span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"10.254.0.0/16"</span> &#125;</span><br></pre></td></tr></table></figure></li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨æ‰§è¡Œçš„æ—¶å€™æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºå‰é¢etcdæ˜¯å¯ç”¨äº†httpsçš„ï¼Œå¦åˆ™çš„è¯ï¼Œä¼šæŠ¥<code>Error: client: etcd cluster is unavailable or misconfigured; error #0: x509: certificate signed by unknown authority</code>çš„é”™è¯¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcd.rc</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_ENDPOINT=https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CERT_FILE=/etc/etcd/ssl/etcd.pem</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_KEY_FILE=/etc/etcd/ssl/etcd-key.pem</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CA_FILE=/etc/etcd/ssl/etcd-ca.pem</span><br></pre></td></tr></table></figure><h3 id="1-1-3ã€å¯åŠ¨flanneld"><a href="#1-1-3ã€å¯åŠ¨flanneld" class="headerlink" title="1.1.3ã€å¯åŠ¨flanneld"></a>1.1.3ã€å¯åŠ¨flanneld</h3><p>åœ¨å¯åŠ¨flanneldä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹dockerçš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/docker.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable flanneld &amp;&amp;systemctl start flanneld &amp;&amp;systemctl status flanneld</span></span><br></pre></td></tr></table></figure><p>é‡å¯äº†dockerå’Œflanneldä»¥åï¼Œæˆ‘ä»¬åœ¨ä»»æ„ä¸€å°nodeèŠ‚ç‚¹ä¸Šé€šè¿‡ip add så¯ä»¥æŸ¥çœ‹ã€‚flanneld å’Œdocker ç½‘ç»œç»‘å®šçš„æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip add s</span></span><br></pre></td></tr></table></figure><h2 id="2ã€å®‰è£…å’Œé…ç½®kubelet"><a href="#2ã€å®‰è£…å’Œé…ç½®kubelet" class="headerlink" title="2ã€å®‰è£…å’Œé…ç½®kubelet"></a>2ã€å®‰è£…å’Œé…ç½®kubelet</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;kubeletå¯åŠ¨æ—¶å‘kube-apiserverå‘é€tls bootstrappingè¯·æ±‚ï¼Œéœ€è¦å°†bootstrap tokenæ–‡ä»¶ä¸­kube-bootsrapç”¨æˆ·æˆäºˆsystem:node-bootstrapper clusterè§’è‰²ï¼ˆroleï¼‰ï¼Œç„¶åkubeletæ‰èƒ½æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚ï¼ˆcertificate signing requestsï¼‰</p><h3 id="2-1ã€å®‰è£…kubelet"><a href="#2-1ã€å®‰è£…kubelet" class="headerlink" title="2.1ã€å®‰è£…kubelet"></a>2.1ã€å®‰è£…kubelet</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.13.3/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar -xzf kubernetes-server-linux-amd64.tar.gz &amp;&amp;cp -r ./kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; /usr/bin/ &amp;&amp; rm -rf ./kubernetes*</span></span><br></pre></td></tr></table></figure><h3 id="2-2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶"><a href="#2-2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶" class="headerlink" title="2.2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶"></a>2.2ã€åˆ›å»ºkubeletå¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kubelet.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kubelet</span><br><span class="line">ExecStart=/usr/bin/kubelet \</span><br><span class="line">           <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">           <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">           <span class="variable">$KUBELET_API_SERVER</span> \</span><br><span class="line">           <span class="variable">$KUBELET_ADDRESS</span> \</span><br><span class="line">           <span class="variable">$KUBELET_PORT</span> \</span><br><span class="line">           <span class="variable">$KUBELET_HOSTNAME</span> \</span><br><span class="line">           <span class="variable">$KUBE_ALLOW_PRIV</span> \</span><br><span class="line">           <span class="variable">$KUBELET_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="2-3ã€kubeleté…ç½®æ–‡ä»¶"><a href="#2-3ã€kubeleté…ç½®æ–‡ä»¶" class="headerlink" title="2.3ã€kubeleté…ç½®æ–‡ä»¶"></a>2.3ã€kubeleté…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/kubelet</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes kubelet (minion) config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span></span><br><span class="line">KUBELET_ADDRESS=<span class="string">"--node-ip=&#123;node_ip&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The port for the info server to serve on</span></span><br><span class="line"><span class="comment"># KUBELET_PORT="--port=10250"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may leave this blank to use the actual hostname</span></span><br><span class="line">KUBELET_HOSTNAME=<span class="string">"--hostname-override=&#123;node_ip&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># location of the api-server</span></span><br><span class="line"><span class="comment"># KUBELET_API_SERVER=""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBELET_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                --allow-privileged \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --authorization-mode=Webhook \</span></span><br><span class="line"><span class="string">                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --cgroup-driver=cgroupfs \</span></span><br><span class="line"><span class="string">                --cert-dir=/etc/kubernetes/ssl \</span></span><br><span class="line"><span class="string">                --cluster-dns=10.254.0.2 \</span></span><br><span class="line"><span class="string">                --cluster-domain=cluster.local \</span></span><br><span class="line"><span class="string">                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% \</span></span><br><span class="line"><span class="string">                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m \</span></span><br><span class="line"><span class="string">                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% \</span></span><br><span class="line"><span class="string">                --eviction-max-pod-grace-period=30 \</span></span><br><span class="line"><span class="string">                --image-gc-high-threshold=80 \</span></span><br><span class="line"><span class="string">                --image-gc-low-threshold=70 \</span></span><br><span class="line"><span class="string">                --image-pull-progress-deadline=30s \</span></span><br><span class="line"><span class="string">                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">                --max-pods=100 \</span></span><br><span class="line"><span class="string">                --minimum-image-ttl-duration=720h0m0s \</span></span><br><span class="line"><span class="string">                --node-labels=node.kubernetes.io/k8s-node=true \</span></span><br><span class="line"><span class="string">                --pod-infra-container-image=docker.io/kubernetes/pause:latest \</span></span><br><span class="line"><span class="string">                --port=10250 \</span></span><br><span class="line"><span class="string">                --read-only-port=0 \</span></span><br><span class="line"><span class="string">                --rotate-certificates \</span></span><br><span class="line"><span class="string">                --rotate-server-certificates \</span></span><br><span class="line"><span class="string">                --fail-swap-on=false \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure><h3 id="2-4ã€å¯åŠ¨kubelet"><a href="#2-4ã€å¯åŠ¨kubelet" class="headerlink" title="2.4ã€å¯åŠ¨kubelet"></a>2.4ã€å¯åŠ¨kubelet</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /var/lib/kubelet -p</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet &amp;&amp;systemctl start kubelet &amp;&amp; systemctl status kubelet</span></span><br><span class="line"><span class="comment"># journalctl -fxeu kubelet</span></span><br></pre></td></tr></table></figure><h2 id="3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚"><a href="#3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚" class="headerlink" title="3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚"></a>3ã€é€šè¿‡kubeletçš„tlsè¯·æ±‚</h2><p>kubeleté¦–æ¬¡å¯åŠ¨æ—¶åƒkube-apiserverå‘é€è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œå¿…é¡»é€šè¿‡åkubernetesç³»ç»Ÿæ‰ä¼šå°†è¯¥nodeåŠ å…¥é›†ç¾¤ï¼š</p><h3 id="3-1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚"><a href="#3-1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚" class="headerlink" title="3.1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚"></a>3.1ã€æŸ¥çœ‹æœªæˆæƒcsrè¯·æ±‚</h3><ul><li>ä»»æ„masterèŠ‚ç‚¹å‡å¯</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE   REQUESTOR                   CONDITION</span><br><span class="line">csr-kxfql                                              78m   system:node:172.21.16.204   Pending</span><br><span class="line">node-csr-QptfMgAu2y4GmUZX1Ph9B0XomA0Rg-fxcgs0Yzd-XRU   79m   system:bootstrap:ff90fd     Approved,Issued</span><br><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure><h3 id="3-2ã€é€šè¿‡csrè¯·æ±‚"><a href="#3-2ã€é€šè¿‡csrè¯·æ±‚" class="headerlink" title="3.2ã€é€šè¿‡csrè¯·æ±‚"></a>3.2ã€é€šè¿‡csrè¯·æ±‚</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl certificate approve csr-kxfql</span></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-kxfql approved</span><br></pre></td></tr></table></figure><ul><li>è‡ªåŠ¨ç”Ÿæˆkubelet kubeconfigæ–‡ä»¶å’Œå…¬ç§é’¥,æ–°ç‰ˆæœ¬ kubelet server çš„è¯ä¹¦è‡ªåŠ¨ç­¾å‘å·²ç»è¢«å…³é—­,æ‰€ä»¥å¯¹äº kubelet server çš„è¯ä¹¦ä»éœ€è¦æ‰‹åŠ¨ç­¾ç½²</li></ul><h2 id="4ã€é…ç½®kube-proxy"><a href="#4ã€é…ç½®kube-proxy" class="headerlink" title="4ã€é…ç½®kube-proxy"></a>4ã€é…ç½®kube-proxy</h2><h3 id="4-1ã€kupe-proxy-å¯åŠ¨æ–‡ä»¶"><a href="#4-1ã€kupe-proxy-å¯åŠ¨æ–‡ä»¶" class="headerlink" title="4.1ã€kupe-proxy å¯åŠ¨æ–‡ä»¶"></a>4.1ã€kupe-proxy å¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-proxy.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/proxy</span><br><span class="line">ExecStart=/usr/bin/kube-proxy \</span><br><span class="line">       <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">       <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">       <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">       <span class="variable">$KUBE_PROXY_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="4-2ã€kube-proxyé…ç½®æ–‡ä»¶"><a href="#4-2ã€kube-proxyé…ç½®æ–‡ä»¶" class="headerlink" title="4.2ã€kube-proxyé…ç½®æ–‡ä»¶"></a>4.2ã€kube-proxyé…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/proxy</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes proxy config</span></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_PROXY_ARGS=<span class="string">"   --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                    --cleanup-ipvs=true \</span></span><br><span class="line"><span class="string">                    --cluster-cidr=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                    --hostname-override=docker4.node \</span></span><br><span class="line"><span class="string">                    --healthz-bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                    --healthz-port=10256 \</span></span><br><span class="line"><span class="string">                    --masquerade-all=true \</span></span><br><span class="line"><span class="string">                    --proxy-mode=ipvs \</span></span><br><span class="line"><span class="string">                    --ipvs-min-sync-period=5s \</span></span><br><span class="line"><span class="string">                    --ipvs-sync-period=5s \</span></span><br><span class="line"><span class="string">                    --ipvs-scheduler=wrr \</span></span><br><span class="line"><span class="string">                    --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \</span></span><br><span class="line"><span class="string">                    --logtostderr=true \</span></span><br><span class="line"><span class="string">                    --v=2"</span></span><br></pre></td></tr></table></figure><h3 id="4-3ã€å¯åŠ¨kube-proxy"><a href="#4-3ã€å¯åŠ¨kube-proxy" class="headerlink" title="4.3ã€å¯åŠ¨kube-proxy"></a>4.3ã€å¯åŠ¨kube-proxy</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-proxy &amp;&amp; systemctl start kube-proxy &amp;&amp; systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure><h3 id="4-4-åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰"><a href="#4-4-åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰" class="headerlink" title="4.4 åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰"></a>4.4 åœ¨kube-proxyå’Œkubeletå¯åŠ¨ä¹‹å‰</h3><p>ç”±äº kubelet ç»„ä»¶æ˜¯é‡‡ç”¨ TLS Bootstrap å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆåˆ›å»ºç›¸å…³é…ç½®</p><ul><li>åˆ›å»ºç”¨äº tls bootstrap çš„ token secret<blockquote><p>masterèŠ‚ç‚¹æ“ä½œ</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f bootstrap.secret.yaml</span></span><br></pre></td></tr></table></figure></li></ul><p>ä¸ºäº†èƒ½è®© kubelet å®ç°è‡ªåŠ¨æ›´æ–°è¯ä¹¦ï¼Œéœ€è¦é…ç½®ç›¸å…³ clusterrolebinding</p><ul><li><p>å…è®¸ kubelet tls bootstrap åˆ›å»º csr è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding create-csrs-for-bootstrapping \</span><br><span class="line">    --clusterrole=system:node-bootstrapper \</span><br><span class="line">    --group=system:bootstrappers</span><br></pre></td></tr></table></figure></li><li><p>è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding auto-approve-csrs-for-group \</span><br><span class="line">    --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient \</span><br><span class="line">    --group=system:bootstrappers</span><br></pre></td></tr></table></figure></li><li><p>è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding auto-approve-renewals-for-nodes \</span><br><span class="line">    --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient \</span><br><span class="line">    --group=system:nodes</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ kubelet server å¼€å¯ api è®¤è¯çš„æƒ…å†µä¸‹ï¼Œapiserver åå‘è®¿é—® kubelet 10250 éœ€è¦æ­¤æˆæƒ(eg: kubectl logs)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding system:kubelet-api-admin \</span><br><span class="line">    --clusterrole=system:kubelet-api-admin \</span><br><span class="line">    --user=system:kubelet-api-admin</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>é—®é¢˜</strong>:<br>åœ¨å¯åŠ¨kubeletçš„æ—¶å€™ï¼ŒnodeèŠ‚ç‚¹åœ¨masterèŠ‚ç‚¹æ— æ³•æŸ¥çœ‹ï¼ŒæŸ¥çœ‹kubeletçš„æ—¥å¿—æç¤ºå¦‚ä¸‹ï¼š</li><li>æŸ¥çœ‹kubeletçš„æ—¥å¿—æ–¹å¼æœ‰ä¸¤ç§</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># journalctl -f -u kubelet</span></span><br><span class="line"><span class="comment"># systemctl  status kubelet -l</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹nodes<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class="line">172.21.16.244   Ready    &lt;none&gt;   12m   v1.13.3</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><strong>éªŒè¯æµ‹è¯•é›†ç¾¤</strong><br>åˆ›å»ºä¸€ä¸ªnginxæµ‹è¯•é›†ç¾¤æ˜¯å¦å¯ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl run nginx --image=docker.io/nginx:latest --replicas=2 --labels run=nginx</span></span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line"><span class="comment"># kubectl expose deployment nginx --port=80 --type=NodePort</span></span><br><span class="line">service/nginx exposed</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹podæƒ…å†µ</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME                     READY   STATUS              RESTARTS   AGE   IP            NODE            NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-766994fc9f-gcv4n   0/1     ContainerCreating   0          55s   &lt;none&gt;        172.21.16.248   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-766994fc9f-w2j8p   1/1     Running             0          55s   10.254.45.2   172.21.16.83    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹å¯¹å¤–çš„æœåŠ¡</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc nginx</span></span><br><span class="line">NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">nginx   NodePort   10.254.11.147   &lt;none&gt;        80:48713/TCP   31s</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å®Œæˆåï¼Œé€šè¿‡ä»»æ„nodeèŠ‚ç‚¹IPçš„åœ°å€åŠ ç«¯å£48713å³å¯è®¿é—®<br><a href="http://node-ip:48713/" target="_blank" rel="noopener">http://node-ip:48713/</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes v13.3 node</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes v1.13.3å®‰è£…</title>
    <url>/2019/08/09/kubernetes-v1-13-3%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:23 GMT+0800 (China Standard Time) --><h2 id="1ã€-ç¯å¢ƒå‡†å¤‡"><a href="#1ã€-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ ç¯å¢ƒå‡†å¤‡"></a>1ã€ ç¯å¢ƒå‡†å¤‡</h2><table><thead><tr><th>ip</th><th>type</th><th>docker</th><th>os</th><th>k8s version</th></tr></thead><tbody><tr><td>172.21.17.4</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td>v1.13.3</td></tr><tr><td>172.21.16.230</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.240</td><td>master,etcd</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.244</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.248</td><td>node,flanneld,ha+kee</td><td>18.06.2-ce</td><td>CentOS Linux release 7.4.1708</td><td></td></tr><tr><td>172.21.16.45</td><td>vip</td><td></td><td>CentOS Linux release 7.4.1708</td><td></td></tr></tbody></table><h2 id="2ã€éƒ¨ç½²ETCé›†ç¾¤"><a href="#2ã€éƒ¨ç½²ETCé›†ç¾¤" class="headerlink" title="2ã€éƒ¨ç½²ETCé›†ç¾¤"></a>2ã€éƒ¨ç½²ETCé›†ç¾¤</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;etcdçš„æ­£å¸¸è¿è¡Œæ˜¯k8sé›†ç¾¤è¿è¡Œçš„æå‰æ¡ä»¶ï¼Œå› æ­¤éƒ¨ç½²k8sé›†ç¾¤é¦–å…ˆéƒ¨ç½²etcdé›†ç¾¤ã€‚å®‰è£…CAè¯ä¹¦ï¼Œå®‰è£…CFSSLè¯ä¹¦ç®¡ç†å·¥å…·ã€‚ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…</p><a id="more"></a><h3 id="2-1ã€ä¸‹è½½cfssl"><a href="#2-1ã€ä¸‹è½½cfssl" class="headerlink" title="2.1ã€ä¸‹è½½cfssl"></a>2.1ã€ä¸‹è½½cfssl</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -o cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line"><span class="comment"># curl -o cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"><span class="comment"># chmod +x * &amp;&amp;mv cfssl* /usr/bin/</span></span><br></pre></td></tr></table></figure><h3 id="2-2-ã€åˆ›å»ºetcdè¯ä¹¦"><a href="#2-2-ã€åˆ›å»ºetcdè¯ä¹¦" class="headerlink" title="2.2 ã€åˆ›å»ºetcdè¯ä¹¦"></a>2.2 ã€åˆ›å»ºetcdè¯ä¹¦</h3><ul><li><p>etcd-ca-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir etcd_ssl &amp;&amp; cd etcd_ssl</span></span><br><span class="line"><span class="comment"># cat etcd-ca-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd-ca"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 4096</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"etcd Security"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"ca"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>etcd-gencert.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat etcd-gencert.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">          <span class="string">"signing"</span>,</span><br><span class="line">          <span class="string">"key encipherment"</span>,</span><br><span class="line">          <span class="string">"server auth"</span>,</span><br><span class="line">          <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>etcd-csr.json</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat etcd-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"etcd Security"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"172.21.17.4"</span>,</span><br><span class="line">        <span class="string">"172.21.16.231"</span>,</span><br><span class="line">        <span class="string">"172.21.16.240"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥æ‰§è¡Œç”Ÿæˆå³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert --initca=true etcd-ca-csr.json | cfssljson --bare etcd-ca</span></span><br><span class="line"><span class="comment"># cfssl gencert --ca etcd-ca.pem --ca-key etcd-ca-key.pem --config etcd-gencert.json etcd-csr.json | cfssljson --bare etcd</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/etcd/ssl &amp;&amp;mkdir -p /var/lib/etcd</span></span><br><span class="line"><span class="comment"># cp *.pem /etc/etcd/ssl</span></span><br><span class="line"><span class="comment"># ls /etc/etcd/ssl/</span></span><br><span class="line">etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem</span><br><span class="line"><span class="comment"># scp -r /etc/etcd k8s-master-02:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/etcd k8s-master-03:/etc</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="2-3ã€å¼€å§‹é…ç½®etcd"><a href="#2-3ã€å¼€å§‹é…ç½®etcd" class="headerlink" title="2.3ã€å¼€å§‹é…ç½®etcd"></a>2.3ã€å¼€å§‹é…ç½®etcd</h3><h4 id="2-3-1ã€ä¸‹è½½etcd"><a href="#2-3-1ã€ä¸‹è½½etcd" class="headerlink" title="2.3.1ã€ä¸‹è½½etcd"></a>2.3.1ã€ä¸‹è½½etcd</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.3.15/etcd-v3.3.15-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf etcd-v3.3.15-linux-amd64.tar.gz &amp;&amp;cd etcd-v3.3.15-linux-amd64 &amp;&amp;cp -arp etcd* /usr/bin/</span></span><br></pre></td></tr></table></figure><h4 id="2-3-2ã€åˆ›å»ºetcdçš„Systemd-unit-æ–‡ä»¶"><a href="#2-3-2ã€åˆ›å»ºetcdçš„Systemd-unit-æ–‡ä»¶" class="headerlink" title="2.3.2ã€åˆ›å»ºetcdçš„Systemd unit æ–‡ä»¶"></a>2.3.2ã€åˆ›å»ºetcdçš„Systemd unit æ–‡ä»¶</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;Etcd è¿™é‡Œé‡‡ç”¨æœ€æ–°çš„ 3.3.15 ç‰ˆæœ¬ï¼Œå®‰è£…æ–¹å¼ç›´æ¥å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ã€systemd service é…ç½®å³å¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„ç›¸å…³ç”¨æˆ·æƒé™é—®é¢˜ï¼Œä»¥ä¸‹è„šæœ¬é…ç½®ç­‰å‚è€ƒäº† etcd rpm å®‰è£…åŒ…</p><h4 id="2-3-3ã€é…ç½®etcd-conf"><a href="#2-3-3ã€é…ç½®etcd-conf" class="headerlink" title="2.3.3ã€é…ç½®etcd.conf"></a>2.3.3ã€é…ç½®etcd.conf</h4><ul><li>k8s-master-01<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd1</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.17.4:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.17.4:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.17.4:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.17.4:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p>k8s-master-02</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd2</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.16.231:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.16.231:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.16.231:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.16.231:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li><li><p>k8s-master-03</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="comment"># [member]</span></span><br><span class="line">ETCD_NAME=etcd3</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd"</span></span><br><span class="line">ETCD_SNAPSHOT_COUNT=<span class="string">"100"</span></span><br><span class="line">ETCD_HEARTBEAT_INTERVAL=<span class="string">"100"</span></span><br><span class="line">ETCD_ELECTION_TIMEOUT=<span class="string">"1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.21.16.240:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_MAX_SNAPSHOTS=<span class="string">"5"</span></span><br><span class="line">ETCD_MAX_WALS=<span class="string">"5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://172.21.17.4:2380,etcd2=https://172.21.16.231:2380,etcd3=https://172.21.16.240:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.21.16.240:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [security]</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_AUTO_TLS=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">ETCD_PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_TRUSTED_CA_FILE=<span class="string">"/etc/etcd/ssl/etcd-ca.pem"</span></span><br><span class="line">ETCD_PEER_AUTO_TLS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-3-4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶"><a href="#2-3-4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶" class="headerlink" title="2.3.4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶"></a>2.3.4ã€é…ç½®etcdå¯åŠ¨æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/etcd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">User=etcd</span><br><span class="line"><span class="comment"># set GOMAXPROCS to number of processors</span></span><br><span class="line">ExecStart=/bin/bash -c <span class="string">"GOMAXPROCS=<span class="variable">$(nproc)</span> /usr/bin/etcd --name=\"<span class="variable">$&#123;ETCD_NAME&#125;</span>\" --data-dir=\"<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span>\" --listen-client-urls=\"<span class="variable">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>\""</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="2-3-5ã€etcdæˆæƒ"><a href="#2-3-5ã€etcdæˆæƒ" class="headerlink" title="2.3.5ã€etcdæˆæƒ"></a>2.3.5ã€etcdæˆæƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># groupadd -r etcd</span></span><br><span class="line"><span class="comment"># useradd -r -g etcd -d /var/lib/etcd -s /sbin/nologin -c "etcd user" etcd</span></span><br><span class="line"><span class="comment"># chown -R etcd:etcd /etc/etcd &amp;&amp; chmod -R 755 /etc/etcd/ssl &amp;&amp;chown -R etcd:etcd /var/lib/etcd</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp;systemctl start etcd &amp;&amp; systemctl status etcd</span></span><br></pre></td></tr></table></figure><h4 id="2-3-6ã€éªŒè¯etcd"><a href="#2-3-6ã€éªŒè¯etcd" class="headerlink" title="2.3.6ã€éªŒè¯etcd"></a>2.3.6ã€éªŒè¯etcd</h4><p>ç”±äºetcdä½¿ç”¨äº†è¯ä¹¦ï¼Œæ‰€ä»¥etcdå‘½ä»¤éœ€è¦å¸¦ä¸Šè¯ä¹¦</p><ul><li><p>æŸ¥çœ‹æˆå‘˜åˆ—è¡¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl --key-file /etc/etcd/ssl/etcd-key.pem --cert-file /etc/etcd/ssl/etcd.pem --ca-file /etc/etcd/ssl/etcd-ca.pem member list</span></span><br><span class="line">93c04a995ff8aa8: name=etcd3 peerURLs=https://172.21.16.240:2380 clientURLs=https://172.21.16.240:2379 isLeader=<span class="literal">false</span></span><br><span class="line">7cc4daf6e4db3a8a: name=etcd2 peerURLs=https://172.21.16.231:2380 clientURLs=https://172.21.16.231:2379 isLeader=<span class="literal">false</span></span><br><span class="line">ec7ea930930d012e: name=etcd1 peerURLs=https://172.21.17.4:2380 clientURLs=https://172.21.17.4:2379 isLeader=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># etcdctl --key-file /etc/etcd/ssl/etcd-key.pem --cert-file /etc/etcd/ssl/etcd.pem --ca-file /etc/etcd/ssl/etcd-ca.pem cluster-health</span></span><br><span class="line">member 93c04a995ff8aa8 is healthy: got healthy result from https://172.21.16.240:2379</span><br><span class="line">member 7cc4daf6e4db3a8a is healthy: got healthy result from https://172.21.16.231:2379</span><br><span class="line">member ec7ea930930d012e is healthy: got healthy result from https://172.21.17.4:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure></li></ul><h2 id="3ã€éƒ¨ç½²kubernetes"><a href="#3ã€éƒ¨ç½²kubernetes" class="headerlink" title="3ã€éƒ¨ç½²kubernetes"></a>3ã€éƒ¨ç½²kubernetes</h2><h3 id="3-1-ä»‹ç»"><a href="#3-1-ä»‹ç»" class="headerlink" title="3.1 ä»‹ç»"></a>3.1 ä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;æ–°ç‰ˆæœ¬å·²ç»è¶Šæ¥è¶Šè¶‹è¿‘å…¨é¢ TLS + RBAC é…ç½®ï¼Œæ‰€ä»¥æœ¬æ¬¡å®‰è£…å°†ä¼šå¯åŠ¨å¤§éƒ¨åˆ† TLS + RBAC é…ç½®ï¼ŒåŒ…æ‹¬ kube-controler-managerã€kube-scheduler ç»„ä»¶ä¸å†è¿æ¥æœ¬åœ° kube-apiserver çš„ 8080 éè®¤è¯ç«¯å£ï¼Œkubelet ç­‰ç»„ä»¶ API ç«¯ç‚¹å…³é—­åŒ¿åè®¿é—®ï¼Œå¯åŠ¨ RBAC è®¤è¯ç­‰ï¼›ä¸ºäº†æ»¡è¶³è¿™äº›è®¤è¯ï¼Œéœ€è¦ç­¾ç½²ä»¥ä¸‹è¯ä¹¦</p><h3 id="3-2ã€åˆ›å»ºCA"><a href="#3-2ã€åˆ›å»ºCA" class="headerlink" title="3.2ã€åˆ›å»ºCA"></a>3.2ã€åˆ›å»ºCA</h3><h4 id="3-2-1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶"><a href="#3-2-1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶" class="headerlink" title="3.2.1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶"></a>3.2.1ã€åˆ›å»ºCAé…ç½®æ–‡ä»¶</h4><ul><li><p>kubernetes-ca-csr.jsoné›†ç¾¤CAæ ¹è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir ssl &amp;&amp; cd ssl/</span></span><br><span class="line"><span class="comment"># cat kubernetes-ca-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 4096</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"ca"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>â€œCNâ€</strong>: Common Nameï¼Œkube-apiserver ä»è¯¥è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·åï¼ˆUser Nameï¼‰;æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™åˆæ³•æ€§ï¼›</li><li><strong>â€œOâ€</strong>: Organizationï¼Œkube-apiserverä»è¯¥è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±ç»„ï¼ˆGroupï¼‰ï¼›</li></ul></li><li><p>kubernetes-gencert.json<br>ç”¨äºç”Ÿæˆå…¶ä»–è¯ä¹¦çš„æ ‡å‡†</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubernetes-gencert.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"signing"</span>: &#123;</span><br><span class="line">        <span class="string">"default"</span>: &#123;</span><br><span class="line">            <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"profiles"</span>: &#123;</span><br><span class="line">            <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">                <span class="string">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"server auth"</span>,</span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-apiserver-csr.json<br>apiserver TLS è®¤è¯ç«¯å£éœ€è¦çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-apiserver-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"10.254.0.1"</span>,</span><br><span class="line">        <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"172.21.16.45"</span>,</span><br><span class="line">        <span class="string">"*.master.kubernetes.node"</span>,</span><br><span class="line">        <span class="string">"kubernetes"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li><strong>172.21.16.45</strong>: vipåœ°å€</li><li>å¦‚æœhostså­—æ®µä¸ä¸ºç©ºåˆ™éœ€è¦æŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ipæˆ–åŸŸååˆ—è¡¨,kube-apiserveræŒ‡å®šçš„service-cluster-ip-rangeç½‘æ®µçš„ç¬¬ä¸€ä¸ªipï¼Œå¦‚10.254.0.1</li></ul><ul><li><p>kube-controller-manager-csr.json<br>controller manager è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« 10257 ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-controller-manager-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"localhost"</span>,</span><br><span class="line">    <span class="string">"*.master.kubernetes.node"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-scheduler-csr.json<br>schedulerè¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« 10259 ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-scheduler-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"localhost"</span>,</span><br><span class="line">    <span class="string">"*.master.kubernetes.node"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kube-proxy-csr.json<br>proxy ç»„ä»¶è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kube-proxy-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>kubelet-api-admin-csr.json<br>apiserver åå‘è¿æ¥ kubelet ç»„ä»¶ 10250 ç«¯å£éœ€è¦ä½¿ç”¨çš„è¯ä¹¦(ä¾‹å¦‚æ‰§è¡Œ kubectl logs)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat kubelet-api-admin-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kubelet-api-admin"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:kubelet-api-admin"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>admin-csr.json<br>é›†ç¾¤ç®¡ç†å‘˜(kubectl)è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat admin-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>æ³¨æ„</strong>: è¯ä¹¦æ–‡ä»¶é‡Œé¢çš„CNã€Oå­—æ®µï¼Œä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„å­—æ®µï¼ŒåŸºæœ¬éƒ½æ˜¯system:å¼€å¤´ï¼Œæ˜¯ä¸ºäº†åŒ¹é…RBACè§„åˆ™,<a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings" target="_blank" rel="noopener">è¯¦æƒ…å‚è€ƒ</a></p><h4 id="3-3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯"><a href="#3-3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯" class="headerlink" title="3.3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯"></a>3.3ã€ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå³å¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cfssl gencert --initca=true kubernetes-ca-csr.json | cfssljson --bare kubernetes-ca</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for targetName in kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet-api-admin admin; do</span></span><br><span class="line">  cfssl gencert --ca kubernetes-ca.pem --ca-key kubernetes-ca-key.pem --config kubernetes-gencert.json --profile kubernetes <span class="variable">$targetName</span>-csr.json | cfssljson --bare <span class="variable">$targetName</span>; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="3-4ã€åˆ†å‘è¯ä¹¦"><a href="#3-4ã€åˆ†å‘è¯ä¹¦" class="headerlink" title="3.4ã€åˆ†å‘è¯ä¹¦"></a>3.4ã€åˆ†å‘è¯ä¹¦</h4><p>å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ï¼ˆåç¼€åä¸º.pemï¼‰æ‹·è´åˆ°æ‰€æœ‰æœºå™¨ï¼›kubernetesç³»ç»Ÿçš„å„ä¸ªç»„å»ºéœ€è¦ä½¿ç”¨tlsè¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†ã€‚</p><h5 id="1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š"><a href="#1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š" class="headerlink" title="1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š"></a>1ï¼‰ã€ç”Ÿæˆçš„è¯ä¹¦caè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š</h5><ul><li>admin-key.pem</li><li>admin.pem</li><li>kube-apiserver-key.pem</li><li>kube-apiserver.pem</li><li>kube-controller-manager-key.pem</li><li>kube-controller-manager.pem</li><li>kubelet-api-admin-key.pem</li><li>kubelet-api-admin.pem</li><li>kube-proxy-key.pem</li><li>kube-proxy.pem</li><li>kubernetes-ca-key.pem</li><li>kubernetes-ca.pem</li><li>kube-scheduler-key.pem</li><li>kube-scheduler.pem</li></ul><h5 id="3ï¼‰ã€è¯ä¹¦æ‹·è´"><a href="#3ï¼‰ã€è¯ä¹¦æ‹·è´" class="headerlink" title="3ï¼‰ã€è¯ä¹¦æ‹·è´"></a>3ï¼‰ã€è¯ä¹¦æ‹·è´</h5><ul><li><p><strong>master èŠ‚ç‚¹æ‹·è´</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/kubernetes/ssl</span></span><br><span class="line"><span class="comment"># cp *.pem /etc/kubernetes/ssl/</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes k8s-master-02:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes k8s-master-03:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes node-01:/etc</span></span><br><span class="line"><span class="comment"># scp -r /etc/kubernetes node-02:/etc</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºç›®å½•</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/log/kube-audit &amp;&amp; mkdir /var/lib/kubelet -p &amp;&amp; mkdir /usr/libexec -p</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="4ã€åˆ›å»ºkube-configæ–‡ä»¶"><a href="#4ã€åˆ›å»ºkube-configæ–‡ä»¶" class="headerlink" title="4ã€åˆ›å»ºkube configæ–‡ä»¶"></a>4ã€åˆ›å»ºkube configæ–‡ä»¶</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;kubeletã€kube-proxyç­‰Nodeæœºå™¨ä¸Šçš„ç»å¸¸ä¸masteræœºå™¨çš„kube-apiserverè¿›ç¨‹é€šä¿¡æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼›kubernetes 1.4 å¼€å§‹æ”¯æŒæœ‰kube-apiserverä¸ºå®¢æˆ·ç«¯ç”Ÿæˆtlsè¯ä¹¦çš„ TLS BootstrappingåŠŸèƒ½ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦äº†ï¼Œè¯¥åŠŸèƒ½å½“å‰ä»…æ”¯æŒä¸ºkueletç”Ÿæˆè¯ä¹¦ï¼›</p><h3 id="4-1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶"><a href="#4-1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶" class="headerlink" title="4.1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶"></a>4.1ã€ç”Ÿæˆé…ç½®æ–‡ä»¶</h3><ul><li>bootstrap.kubeconfig kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µéœ€è¦ä½¿ç”¨çš„é…ç½®æ–‡ä»¶</li><li>kube-controller-manager.kubeconfig controller manager ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li><li>kube-scheduler.kubeconfig scheduler ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li><li>kube-proxy.kubeconfig proxy ç»„ä»¶è¿æ¥ apiserver æ‰€éœ€é…ç½®æ–‡ä»¶</li><li>audit-policy.yaml apiserver RBAC å®¡è®¡æ—¥å¿—é…ç½®æ–‡ä»¶</li><li>bootstrap.secret.yaml kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µä½¿ç”¨ Bootstrap Token æ–¹å¼å¼•å¯¼ï¼Œéœ€è¦é¢„å…ˆåˆ›å»ºæ­¤ Token</li></ul><h3 id="4-2ã€åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶"><a href="#4-2ã€åˆ›å»ºkubelet-bootstrapping-kubeconfigæ–‡ä»¶" class="headerlink" title="4.2ã€åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶"></a>4.2ã€åˆ›å»ºkubelet bootstrapping kubeconfigæ–‡ä»¶</h3><p>åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦ä¸‹è½½kubernetes ç›¸å…³çš„äºŒè¿›åˆ¶åŒ…ï¼ŒæŠŠå¯¹åº”çš„å·¥å…·å’Œå‘½ä»¤æ‹·è´åˆ°/usr/binç›®å½•ä¸‹é¢;ä¸‹è½½äºŒè¿›åˆ¶åŒ…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://dl.k8s.io/v1.13.3/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxf kubernetes-server-linux-amd64.tar.gz &amp;&amp; cd kubernetes/server/bin</span></span><br></pre></td></tr></table></figure><ul><li>masterèŠ‚ç‚¹æ‹·è´</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mv apiextensions-apiserver cloud-controller-manager hyperkube kube-apiserver kube-controller-manager kube-proxy kube-scheduler kubectl kubelet mounter kubeadm /usr/bin/ &amp;&amp; cd &amp;&amp;rm -rf kubernetes kubernetes-server-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><h4 id="4-2-1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping"><a href="#4-2-1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping" class="headerlink" title="4.2.1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping"></a>4.2.1ã€ç”Ÿæˆæ–‡ä»¶bootstrapping</h4><ul><li>master-01<br>&nbsp;&nbsp;&nbsp;&nbsp;config æ˜¯ä¸€ä¸ªé€šç”¨é…ç½®æ–‡ä»¶è¦è¿æ¥æœ¬åœ°çš„ 6443 åŠ å¯†ç«¯å£ï¼›è€Œè¿™ä¸ªå˜é‡å°†ä¼šè¦†ç›– kubeconfig ä¸­æŒ‡å®šçš„master_vipåœ°å€172.21.16.45:6443 åœ°å€</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export KUBE_APISERVER="https://172.21.16.45:6443"</span></span><br></pre></td></tr></table></figure><ul><li>ç”Ÿæˆ Bootstrap Token<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># BOOTSTRAP_TOKEN_ID=$(head -c 6 /dev/urandom | md5sum | head -c 6)</span></span><br><span class="line"><span class="comment"># BOOTSTRAP_TOKEN_SECRET=$(head -c 16 /dev/urandom | md5sum | head -c 16)</span></span><br><span class="line"><span class="comment"># BOOTSTRAP_TOKEN="$&#123;BOOTSTRAP_TOKEN_ID&#125;.$&#123;BOOTSTRAP_TOKEN_SECRET&#125;"</span></span><br><span class="line"><span class="comment"># echo "Bootstrap Tokne: $&#123;BOOTSTRAP_TOKEN&#125;"</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="4-2-2ã€ç”Ÿæˆ-kubelet-tls-bootstrap-é…ç½®"><a href="#4-2-2ã€ç”Ÿæˆ-kubelet-tls-bootstrap-é…ç½®" class="headerlink" title="4.2.2ã€ç”Ÿæˆ kubelet tls bootstrap é…ç½®"></a>4.2.2ã€ç”Ÿæˆ kubelet tls bootstrap é…ç½®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:bootstrap:$&#123;BOOTSTRAP_TOKEN_ID&#125;" \</span></span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=<span class="string">"system:bootstrap:<span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span>"</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-3ã€ç”Ÿæˆ-kube-controller-manager-é…ç½®æ–‡ä»¶"><a href="#4-2-3ã€ç”Ÿæˆ-kube-controller-manager-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.3ã€ç”Ÿæˆ kube-controller-manager é…ç½®æ–‡ä»¶"></a>4.2.3ã€ç”Ÿæˆ kube-controller-manager é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-controller-manager" \</span></span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-4ã€ç”Ÿæˆ-kube-scheduler-é…ç½®æ–‡ä»¶"><a href="#4-2-4ã€ç”Ÿæˆ-kube-scheduler-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.4ã€ç”Ÿæˆ kube-scheduler é…ç½®æ–‡ä»¶"></a>4.2.4ã€ç”Ÿæˆ kube-scheduler é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-scheduler" \</span></span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-5ã€ç”Ÿæˆ-kube-proxy-é…ç½®æ–‡ä»¶"><a href="#4-2-5ã€ç”Ÿæˆ-kube-proxy-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.5ã€ç”Ÿæˆ kube-proxy é…ç½®æ–‡ä»¶"></a>4.2.5ã€ç”Ÿæˆ kube-proxy é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">  --certificate-authority=kubernetes-ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-credentials "system:kube-proxy" \</span></span><br><span class="line">  --client-certificate=kube-proxy.pem \</span><br><span class="line">  --client-key=kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config set-context default \</span></span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br></pre></td></tr></table></figure><h4 id="4-2-6ã€ç”Ÿæˆ-apiserver-RBAC-å®¡è®¡é…ç½®æ–‡ä»¶"><a href="#4-2-6ã€ç”Ÿæˆ-apiserver-RBAC-å®¡è®¡é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.6ã€ç”Ÿæˆ apiserver RBAC å®¡è®¡é…ç½®æ–‡ä»¶"></a>4.2.6ã€ç”Ÿæˆ apiserver RBAC å®¡è®¡é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; audit-policy.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="comment"># Log all requests at the Metadata level.</span></span><br><span class="line">apiVersion: audit.k8s.io/v1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">- level: Metadata</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-2-7ã€ç”Ÿæˆ-tls-bootstrap-token-secret-é…ç½®æ–‡ä»¶"><a href="#4-2-7ã€ç”Ÿæˆ-tls-bootstrap-token-secret-é…ç½®æ–‡ä»¶" class="headerlink" title="4.2.7ã€ç”Ÿæˆ tls bootstrap token secret é…ç½®æ–‡ä»¶"></a>4.2.7ã€ç”Ÿæˆ tls bootstrap token secret é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; bootstrap.secret.yaml &lt;&lt;EOF</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># Name MUST be of form "bootstrap-token-&lt;token id&gt;"</span></span><br><span class="line">  name: bootstrap-token-<span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span></span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="comment"># Type MUST be 'bootstrap.kubernetes.io/token'</span></span><br><span class="line"><span class="built_in">type</span>: bootstrap.kubernetes.io/token</span><br><span class="line">stringData:</span><br><span class="line">  <span class="comment"># Human readable description. Optional.</span></span><br><span class="line">  description: <span class="string">"The default bootstrap token."</span></span><br><span class="line">  <span class="comment"># Token ID and secret. Required.</span></span><br><span class="line">  token-id: <span class="variable">$&#123;BOOTSTRAP_TOKEN_ID&#125;</span></span><br><span class="line">  token-secret: <span class="variable">$&#123;BOOTSTRAP_TOKEN_SECRET&#125;</span></span><br><span class="line">  <span class="comment"># Expiration. Optional.</span></span><br><span class="line">  expiration: $(date -d<span class="string">'+2 day'</span> -u +<span class="string">"%Y-%m-%dT%H:%M:%SZ"</span>)</span><br><span class="line">  <span class="comment"># Allowed usages.</span></span><br><span class="line">  usage-bootstrap-authentication: <span class="string">"true"</span></span><br><span class="line">  usage-bootstrap-signing: <span class="string">"true"</span></span><br><span class="line">  <span class="comment"># Extra groups to authenticate the token as. Must start with "system:bootstrappers:"</span></span><br><span class="line"><span class="comment">#  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-3ã€å¤åˆ¶æ–‡ä»¶"><a href="#4-3ã€å¤åˆ¶æ–‡ä»¶" class="headerlink" title="4.3ã€å¤åˆ¶æ–‡ä»¶"></a>4.3ã€å¤åˆ¶æ–‡ä»¶</h4><p>æŠŠåˆšç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°<code>/etc/kubernetes</code>ç›®å½•ä¸‹é¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># cp audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig /etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig k8s-master-02:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r audit-policy.yaml bootstrap.kubeconfig  bootstrap.secret.yaml kube-proxy.kubeconfig  kube-scheduler.kubeconfig k8s-master-03:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># node èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># scp -r  bootstrap.kubeconfig kube-proxy.kubeconfig node-01:/etc/kubernetes</span></span><br><span class="line"><span class="comment"># scp -r  bootstrap.kubeconfig kube-proxy.kubeconfig node-02:/etc/kubernetes</span></span><br></pre></td></tr></table></figure><h4 id="4-4ã€å¤„ç†-ipvs-åŠä¾èµ–"><a href="#4-4ã€å¤„ç†-ipvs-åŠä¾èµ–" class="headerlink" title="4.4ã€å¤„ç† ipvs åŠä¾èµ–"></a>4.4ã€å¤„ç† ipvs åŠä¾èµ–</h4><p>&nbsp;&nbsp;&nbsp;&nbsp; æ–°ç‰ˆæœ¬ç›®å‰ kube-proxy ç»„ä»¶å…¨éƒ¨é‡‡ç”¨ ipvs æ–¹å¼è´Ÿè½½ï¼Œæ‰€ä»¥ä¸ºäº† kube-proxy èƒ½æ­£å¸¸å·¥ä½œéœ€è¦é¢„å…ˆå¤„ç†ä¸€ä¸‹ ipvs é…ç½®ä»¥åŠç›¸å…³ä¾èµ–(æ¯å° node éƒ½è¦å¤„ç†)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># sysctl -p</span></span><br></pre></td></tr></table></figure><p>kubernetes ä¸­å¯ç”¨ ipvs,è¯¦ç»†ä»‹ç»ï¼Œ<a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/proxy/ipvs" target="_blank" rel="noopener">å®˜æ–¹</a>,<a href="https://juejin.im/entry/5b7e409ce51d4538b35c03df" target="_blank" rel="noopener">å‚è€ƒæ–‡çŒ®</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install ipvsadm</span></span><br><span class="line"><span class="comment"># cat &gt;&gt; /etc/modules &lt;&lt;EOF</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver"><a href="#5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver" class="headerlink" title="5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver"></a>5ã€é…ç½®å’Œå¯åŠ¨kube-apiserver</h2><h3 id="5-1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶"><a href="#5-1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶"></a>5.1ã€è®¾ç½®å¯åŠ¨æ–‡ä»¶</h3><ul><li><strong>kube-apiserver.service</strong><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service</span></span><br><span class="line">[Unit]</span><br><span class="line">  Description=Kubernetes API Service</span><br><span class="line">  Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">  After=network.target</span><br><span class="line">  After=etcd.service</span><br><span class="line">[Service]</span><br><span class="line">  EnvironmentFile=-/etc/kubernetes/apiserver</span><br><span class="line">  ExecStart=/usr/bin/kube-apiserver \</span><br><span class="line">          <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">          <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">          <span class="variable">$KUBE_ETCD_SERVERS</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_ADDRESS</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_PORT</span> \</span><br><span class="line">          <span class="variable">$KUBELET_PORT</span> \</span><br><span class="line">          <span class="variable">$KUBE_ALLOW_PRIV</span> \</span><br><span class="line">          <span class="variable">$KUBE_SERVICE_ADDRESSES</span> \</span><br><span class="line">          <span class="variable">$KUBE_ADMISSION_CONTROL</span> \</span><br><span class="line">          <span class="variable">$KUBE_API_ARGS</span></span><br><span class="line">  Restart=on-failure</span><br><span class="line">  Type=notify</span><br><span class="line">  LimitNOFILE=65536</span><br><span class="line">[Install]</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-2ã€apiserveré…ç½®æ–‡ä»¶"><a href="#5-2ã€apiserveré…ç½®æ–‡ä»¶" class="headerlink" title="5.2ã€apiserveré…ç½®æ–‡ä»¶"></a>5.2ã€apiserveré…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/apiserver</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes system config</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The following values are used to configure the kube-apiserver</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address on the local server to listen to.</span></span><br><span class="line">KUBE_API_ADDRESS=<span class="string">"--advertise-address=172.21.17.4 --bind-address=0.0.0.0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The port on the local server to listen on.</span></span><br><span class="line">KUBE_API_PORT=<span class="string">"--secure-port=6443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port minions listen on</span></span><br><span class="line"><span class="comment"># KUBELET_PORT="--kubelet-port=10250"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Comma separated list of nodes in the etcd cluster</span></span><br><span class="line">KUBE_ETCD_SERVERS=<span class="string">"--etcd-servers=https://172.21.17.4:2379,https://172.21.16.230:2379,https://172.21.16.240:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Address range to use for services</span></span><br><span class="line">KUBE_SERVICE_ADDRESSES=<span class="string">"--service-cluster-ip-range=10.254.0.0/16"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default admission control policies</span></span><br><span class="line">KUBE_ADMISSION_CONTROL=<span class="string">"--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,Priority,ResourceQuota"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_API_ARGS=<span class="string">" --allow-privileged=true \</span></span><br><span class="line"><span class="string">                --anonymous-auth=false \</span></span><br><span class="line"><span class="string">                --alsologtostderr \</span></span><br><span class="line"><span class="string">                --apiserver-count=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">                --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">                --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">                --audit-log-path=/var/log/kube-audit/audit.log \</span></span><br><span class="line"><span class="string">                --audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span></span><br><span class="line"><span class="string">                --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">                --enable-garbage-collector \</span></span><br><span class="line"><span class="string">                --enable-logs-handler \</span></span><br><span class="line"><span class="string">                --endpoint-reconciler-type=lease \</span></span><br><span class="line"><span class="string">                --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span></span><br><span class="line"><span class="string">                --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">                --etcd-compaction-interval=0s \</span></span><br><span class="line"><span class="string">                --event-ttl=168h0m0s \</span></span><br><span class="line"><span class="string">                --kubelet-https=true \</span></span><br><span class="line"><span class="string">                --kubelet-certificate-authority=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem \</span></span><br><span class="line"><span class="string">                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem \</span></span><br><span class="line"><span class="string">                --kubelet-timeout=3s \</span></span><br><span class="line"><span class="string">                --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">                --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">                --service-account-key-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">                --v=2"</span></span><br></pre></td></tr></table></figure><ul><li><strong>â€“client-ca-file</strong>: å®šä¹‰å®¢æˆ·ç«¯ CA</li><li><strong>â€“endpoint-reconciler-type</strong>: master endpoint ç­–ç•¥</li><li><strong>â€“kubelet-client-certificateã€â€“kubelet-client-key</strong>: master åå‘è¿æ¥ kubelet ä½¿ç”¨çš„è¯ä¹¦</li><li><strong>â€“service-account-key-file</strong>: service account ç­¾å key(ç”¨äºæœ‰æ•ˆæ€§éªŒè¯)</li><li><strong>â€“tls-cert-fileã€â€“tls-private-key-file</strong>: master apiserver 6443 ç«¯å£è¯ä¹¦<br>è¯¦ç»†å‚æ•°<a href="https://www.jianshu.com/p/36ad3028a710" target="_blank" rel="noopener">ä»‹ç»</a></li></ul><h3 id="5-2-1ã€å¯åŠ¨kube-apiserver"><a href="#5-2-1ã€å¯åŠ¨kube-apiserver" class="headerlink" title="5.2.1ã€å¯åŠ¨kube-apiserver"></a>5.2.1ã€å¯åŠ¨kube-apiserver</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-apiserver &amp;&amp;systemctl start kube-apiserver &amp;&amp;systemctl status kube-apiserver</span></span><br></pre></td></tr></table></figure><h3 id="5-3ã€é…ç½®kube-controller-manager"><a href="#5-3ã€é…ç½®kube-controller-manager" class="headerlink" title="5.3ã€é…ç½®kube-controller-manager"></a>5.3ã€é…ç½®kube-controller-manager</h3><p>åˆ›å»ºkube-controller-managerçš„serviceé…ç½®æ–‡ä»¶</p><h3 id="5-3-1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶"><a href="#5-3-1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.3.1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶"></a>5.3.1ã€é…ç½®kube-controller-managerå¯åŠ¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /usr/lib/systemd/system/kube-controller-manager.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/controller-manager</span><br><span class="line">ExecStart=/usr/bin/kube-controller-manager \</span><br><span class="line">	    <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">	    <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">	    <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">	    <span class="variable">$KUBE_CONTROLLER_MANAGER_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="5-3-2ã€é…ç½®controller-manageræ–‡ä»¶"><a href="#5-3-2ã€é…ç½®controller-manageræ–‡ä»¶" class="headerlink" title="5.3.2ã€é…ç½®controller-manageræ–‡ä»¶"></a>5.3.2ã€é…ç½®controller-manageræ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/controller-manager</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># The following values are used to configure the kubernetes controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defaults from config and apiserver should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_CONTROLLER_MANAGER_ARGS=<span class="string">"  --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                                --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">                                --cluster-signing-cert-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --cluster-signing-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">                                --deployment-controller-sync-period=10s \</span></span><br><span class="line"><span class="string">                                --experimental-cluster-signing-duration=87600h0m0s \</span></span><br><span class="line"><span class="string">                                --enable-garbage-collector=true \</span></span><br><span class="line"><span class="string">                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">                                --leader-elect=true \</span></span><br><span class="line"><span class="string">                                --node-monitor-grace-period=20s \</span></span><br><span class="line"><span class="string">                                --node-monitor-period=5s \</span></span><br><span class="line"><span class="string">                                --port=10252 \</span></span><br><span class="line"><span class="string">                                --pod-eviction-timeout=2m0s \</span></span><br><span class="line"><span class="string">                                --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --terminated-pod-gc-threshold=50 \</span></span><br><span class="line"><span class="string">                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">                                --root-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                                --secure-port=10257 \</span></span><br><span class="line"><span class="string">                                --service-cluster-ip-range=10.254.0.0/16 \</span></span><br><span class="line"><span class="string">                                --service-account-private-key-file=/etc/kubernetes/ssl/kubernetes-ca-key.pem \</span></span><br><span class="line"><span class="string">                                --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">                                --v=2"</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;controller manager å°†ä¸å®‰å…¨ç«¯å£ 10252 ç»‘å®šåˆ° 127.0.0.1 ç¡®ä¿ kuebctl get cs æœ‰æ­£ç¡®è¿”å›ï¼›å°†å®‰å…¨ç«¯å£ 10257 ç»‘å®šåˆ° 0.0.0.0 å…¬å¼€ï¼Œæä¾›æœåŠ¡è°ƒç”¨ï¼›ç”±äº controller manager å¼€å§‹è¿æ¥ apiserver çš„ 6443 è®¤è¯ç«¯å£ï¼Œæ‰€ä»¥éœ€è¦ â€“use-service-account-credentials é€‰é¡¹æ¥è®© controller manager åˆ›å»ºå•ç‹¬çš„ service account(é»˜è®¤ system:kube-controller-manager ç”¨æˆ·æ²¡æœ‰é‚£ä¹ˆé«˜æƒé™)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused   </span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused   </span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="5-3-3ã€å¯åŠ¨kube-controller-manager"><a href="#5-3-3ã€å¯åŠ¨kube-controller-manager" class="headerlink" title="5.3.3ã€å¯åŠ¨kube-controller-manager"></a>5.3.3ã€å¯åŠ¨kube-controller-manager</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl enable kube-controller-manager &amp;&amp;systemctl start kube-controller-manager &amp;&amp;systemctl status kube-controller-manager</span></span><br></pre></td></tr></table></figure><h3 id="5-4ã€é…ç½®kube-scheduler"><a href="#5-4ã€é…ç½®kube-scheduler" class="headerlink" title="5.4ã€é…ç½®kube-scheduler"></a>5.4ã€é…ç½®kube-scheduler</h3><p>åˆ›å»ºkube-schedulerçš„serviceé…ç½®æ–‡ä»¶</p><h4 id="5-4-1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶"><a href="#5-4-1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶" class="headerlink" title="5.4.1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶"></a>5.4.1ã€åˆ›å»ºkube-schedulerå¯åŠ¨æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /lib/systemd/system/kube-scheduler.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler Plugin</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/scheduler</span><br><span class="line">ExecStart=/usr/bin/kube-scheduler \</span><br><span class="line">	    <span class="variable">$KUBE_LOGTOSTDERR</span> \</span><br><span class="line">	    <span class="variable">$KUBE_LOG_LEVEL</span> \</span><br><span class="line">	    <span class="variable">$KUBE_MASTER</span> \</span><br><span class="line">	    <span class="variable">$KUBE_SCHEDULER_ARGS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h4 id="5-4-2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶"><a href="#5-4-2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶" class="headerlink" title="5.4.2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶"></a>5.4.2ã€åˆ›å»ºscheduleré…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/scheduler </span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes scheduler config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line">KUBE_SCHEDULER_ARGS=<span class="string">"   --address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                        --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">                        --client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                        --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">                        --requestheader-client-ca-file=/etc/kubernetes/ssl/kubernetes-ca.pem \</span></span><br><span class="line"><span class="string">                        --secure-port=10259 \</span></span><br><span class="line"><span class="string">                        --leader-elect=true \</span></span><br><span class="line"><span class="string">                        --port=10251 \</span></span><br><span class="line"><span class="string">                        --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \</span></span><br><span class="line"><span class="string">                        --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem \</span></span><br><span class="line"><span class="string">                        --v=2"</span></span><br></pre></td></tr></table></figure><p>shceduler åŒ controller manager ä¸€æ ·å°†ä¸å®‰å…¨ç«¯å£ç»‘å®šåœ¨æœ¬åœ°ï¼Œå®‰å…¨ç«¯å£å¯¹å¤–å…¬å¼€</p><h4 id="5-4-3ã€å¯åŠ¨kube-scheduler"><a href="#5-4-3ã€å¯åŠ¨kube-scheduler" class="headerlink" title="5.4.3ã€å¯åŠ¨kube-scheduler"></a>5.4.3ã€å¯åŠ¨kube-scheduler</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-scheduler &amp;&amp;systemctl start kube-scheduler &amp;&amp;systemctl status kube-scheduler</span></span><br></pre></td></tr></table></figure><h3 id="5-4ã€éªŒè¯masterèŠ‚ç‚¹"><a href="#5-4ã€éªŒè¯masterèŠ‚ç‚¹" class="headerlink" title="5.4ã€éªŒè¯masterèŠ‚ç‚¹"></a>5.4ã€éªŒè¯masterèŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤masterèŠ‚ç‚¹éƒ¨ç½²å®Œæ¯•</p><p>kubernetesé«˜å¯ç”¨ä½¿ç”¨haproxyè¿›è¡Œä»£ç†,<a href="https://xxlaila.github.io/2019/08/10/haproxy-keepalived/" target="_blank" rel="noopener">haproxy</a>ä»£ç†å®‰è£…</p><p><a href="https://xxlaila.github.io/2019/08/10/kubernetes-node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">nodeèŠ‚ç‚¹å®‰è£…</a></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes v1.13.3</tag>
      </tags>
  </entry>
  <entry>
    <title>vsftpdå®‰è£…</title>
    <url>/2019/08/09/vsftpd%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Centosä¸‹ftpçš„å®‰è£…ä¸€èˆ¬é‡‡ç”¨çš„æ˜¯vsftpdï¼Œä½†æ˜¯åœ¨ftpçš„æ¨¡å¼ä¸­åˆæœ‰å‡ ä¸ªç”¨æˆ·é…ç½®é¡¹éœ€è¦æ³¨æ„ï¼Œæœ‰äº›äººå–œæ¬¢ç”¨æœ¬åœ°ç”¨æˆ·å»ç™»é™†FTPï¼Œè™½ç„¶åœ¨å»ºç«‹æœ¬åœ°ç”¨æˆ·çš„æ—¶å€™åŠ äº†/sbin/nologinå‚æ•°ï¼Œä½†æ˜¯è¿™ä¸ªè¿˜æ˜¯ä¸å¤Ÿå®‰å…¨ï¼Œè€Œä¸”è¿™æ ·æƒé™æ§åˆ¶ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼Œä»–ä»¬éƒ½æ˜¯ç»Ÿä¸€çš„æ§åˆ¶æƒé™ï¼Œè¿™é‡Œé‡‡ç”¨è™šæ‹Ÿç”¨æˆ·å‰æ¥é…ç½®ã€‚è™šæ‹Ÿç”¨æˆ·é…åˆé˜²ç«å¢™selinuxè¿˜æœ‰å•ä¸ªç”¨æˆ·çš„æƒé™ï¼Œè¿™ä½¿å¾—FTPæœ‰ç€è¶³å¤Ÿçš„å®‰å…¨ã€‚è€Œä¸”æƒé™æ§åˆ¶ç‰¹åˆ«çµæ´»ï¼Œä¿®æ”¹ä¸€ä¸ªç”¨æˆ·çš„æƒé™ä¸ä¼šå½±å“åˆ°å…¶ä»–ç”¨æˆ·ã€‚<br>centos ç³»ç»Ÿç‰ˆæœ¬(5.5ã€5.3ã€6.0ã€6.5)<br>centos 7.4 å·²ç»éªŒè¯</p><h3 id="é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd"><a href="#é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd" class="headerlink" title="é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd"></a>é¦–å…ˆæˆ‘ä»¬å®‰è£…vsftpd</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum â€“y install vsftpd</span></span><br></pre></td></tr></table></figure><h3 id="2ã€å¯åŠ¨å’ŒåŠ è½½vsftp"><a href="#2ã€å¯åŠ¨å’ŒåŠ è½½vsftp" class="headerlink" title="2ã€å¯åŠ¨å’ŒåŠ è½½vsftp"></a>2ã€å¯åŠ¨å’ŒåŠ è½½vsftp</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># service vsftpd restart</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chkconfig â€“level 35 vsftpd on</span></span><br></pre></td></tr></table></figure><h3 id="3ã€å¼€å§‹é…ç½®vsftpd"><a href="#3ã€å¼€å§‹é…ç½®vsftpd" class="headerlink" title="3ã€å¼€å§‹é…ç½®vsftpd"></a>3ã€å¼€å§‹é…ç½®vsftpd</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Vsftpdçš„é…ç½®æ–‡ä»¶åœ¨/etc/vsftpdä¸‹é¢ï¼Œåœ¨é…ç½®ä¹‹å‰æˆ‘ä»¬å…ˆcpä¸€ä»½åšå¤‡ä»½ç”¨ä»¥å…å‘ç”Ÿæ„å¤–(åšä»€ä¹ˆéƒ½è¦éšæ‰‹å¤‡ä»½ï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸‡ï¼Œåªæœ‰ä¸‡ä¸€ã€‚)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment">#  cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.bak</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vim /etc/vsftpd/vsftpd.conf</span></span><br></pre></td></tr></table></figure><ul><li><strong>vsftpdçš„å‚æ•°ä»‹ç»</strong></li></ul><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reverse_lookup_enable=NO <span class="comment">#æ·»åŠ æ­¤è¡Œï¼Œè§£å†³å®¢æˆ·ç«¯ç™»é™†ç¼“æ…¢é—®é¢˜ï¼é‡è¦ï¼é»˜è®¤vsftpdå¼€å¯äº†DNSåå“è§£æï¼è¿™é‡Œéœ€è¦å…³é—­ï¼Œå¦‚æœå¯åŠ¨æœ‰é”™è¯¯ï¼Œè¯·æ³¨é”€ï¼</span></span><br><span class="line">listen_port=21 <span class="comment">#é»˜è®¤æ— æ­¤è¡Œï¼Œftpç«¯å£ä¸º21ï¼Œæ·»åŠ listen_port=2222æŠŠé»˜è®¤ç«¯å£ä¿®æ”¹ä¸º2222ï¼Œæ³¨æ„ï¼šé˜²ç«å¢™åŒæ—¶è¦å¼€å¯2222ç«¯å£</span></span><br><span class="line">anonymous_enable=NOã€€ã€€ <span class="comment">#ç¦æ­¢åŒ¿åç”¨æˆ·</span></span><br><span class="line">local_enable=YES</span><br><span class="line">è®¾å®šæœ¬åœ°ç”¨æˆ·å¯ä»¥è®¿é—®ã€‚æ³¨æ„ï¼šä¸»è¦æ˜¯ä¸ºè™šæ‹Ÿå®¿ä¸»ç”¨æˆ·ï¼Œå¦‚æœè¯¥é¡¹ç›®è®¾å®šä¸ºNOé‚£ä¹ˆæ‰€æœ‰è™šæ‹Ÿç”¨æˆ·å°†æ— æ³•è®¿é—®</span><br><span class="line">write_enable=YES <span class="comment">#å…¨å±€è®¾ç½®ï¼Œæ˜¯å¦å®¹è®¸å†™å…¥ï¼ˆæ— è®ºæ˜¯åŒ¿åç”¨æˆ·è¿˜æ˜¯æœ¬åœ°ç”¨æˆ·ï¼Œè‹¥è¦å¯ç”¨ä¸Šä¼ æƒé™çš„è¯ï¼Œå°±è¦å¼€å¯ä»–ï¼‰</span></span><br><span class="line">local_umask=022 è®¾å®šä¸Šä¼ åæ–‡ä»¶çš„æƒé™æ©ç ã€‚</span><br><span class="line">anon_upload_enable=NO ç¦æ­¢åŒ¿åç”¨æˆ·ä¸Šä¼ ã€‚</span><br><span class="line">anon_mkdir_write_enable=NO ç¦æ­¢åŒ¿åç”¨æˆ·å»ºç«‹ç›®å½•ã€‚</span><br><span class="line">dirmessage_enable=YES è®¾å®šå¼€å¯ç›®å½•æ ‡è¯­åŠŸèƒ½ã€‚</span><br><span class="line">xferlog_enable=YES è®¾å®šå¼€å¯æ—¥å¿—è®°å½•åŠŸèƒ½ã€‚</span><br><span class="line">connect_from_port_20=YES è®¾å®šç«¯å£20è¿›è¡Œæ•°æ®è¿æ¥ã€‚</span><br><span class="line">chown_uploads=NO è®¾å®šç¦æ­¢ä¸Šä¼ æ–‡ä»¶æ›´æ”¹å®¿ä¸»ã€‚</span><br><span class="line">xferlog_file=/var/<span class="built_in">log</span>/vsftpd.log æ—¥å¿—ä¿å­˜è·¯å¾„ï¼ˆå…ˆåˆ›å»ºå¥½æ–‡ä»¶ï¼‰</span><br><span class="line">xferlog_std_format=YESã€€ã€€ <span class="comment">#ä½¿ç”¨æ ‡å‡†æ ¼å¼</span></span><br><span class="line">async_abor_enable=YES è®¾å®šæ”¯æŒå¼‚æ­¥ä¼ è¾“åŠŸèƒ½ã€‚</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES è®¾å®šæ”¯æŒASCIIæ¨¡å¼çš„ä¸Šä¼ å’Œä¸‹è½½åŠŸèƒ½ã€‚</span><br><span class="line">ftpd_banner=Welcome to Awei FTP servers è®¾å®šVsftpdçš„ç™»é™†æ ‡è¯­ã€‚</span><br><span class="line">chroot_local_user=YES ç¦æ­¢æœ¬åœ°ç”¨æˆ·ç™»å‡ºè‡ªå·±çš„FTPä¸»ç›®å½•ã€‚</span><br><span class="line">pam_service_name=vsftpd è®¾å®šPAMæœåŠ¡ä¸‹Vsftpdçš„éªŒè¯é…ç½®æ–‡ä»¶åã€‚å› æ­¤ï¼ŒPAMéªŒè¯å°†å‚è€ƒ/etc/pam.d/ä¸‹çš„vsftpdæ–‡ä»¶é…ç½®ã€‚</span><br><span class="line">userlist_enable=YES è®¾ä¸ºYESçš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·åæ˜¯åœ¨userlist_fileå‚æ•°æŒ‡å®šçš„æ–‡ä»¶ä¸­ï¼Œ</span><br><span class="line"> é‚£ä¹ˆåœ¨è¦æ±‚ä»–ä»¬è¾“å…¥å¯†ç ä¹‹å‰ï¼Œä¼šç›´æ¥æ‹’ç»ä»–ä»¬ç™»é™†ã€‚</span><br><span class="line">tcp_wrappers=YES æ˜¯å¦æ”¯æŒtcp_wrappers</span><br></pre></td></tr></table></figure><ul><li><strong>ä»¥ä¸‹æ˜¯æˆ‘ä½¿ç”¨çš„å‚æ•°,ä½¿ç”¨çš„æ˜¯è¢«åŠ¨æ¨¡å¼</strong><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">anonymous_enable=No</span><br><span class="line">listen_port=21</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"><span class="comment">#chown_uploads=YES</span></span><br><span class="line">xferlog_file=/var/<span class="built_in">log</span>/vsftpd.log</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">async_abor_enable=YES</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES</span><br><span class="line">ftpd_banner=Welcome to blah FTP service.</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">listen=YES</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line">reverse_lookup_enable=No</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=vsftpd</span><br><span class="line">user_config_dir=/etc/vsftpd/vconf</span><br><span class="line">virtual_use_local_privs=YES</span><br><span class="line">pasv_min_port=9000</span><br><span class="line">pasv_max_port=9045</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">allow_writeable_chroot=YES</span><br><span class="line"><span class="comment">#port_enable=YES</span></span><br><span class="line"><span class="comment">#connect_from_port_20=YES</span></span><br><span class="line">pasv_enable=yes</span><br></pre></td></tr></table></figure></li></ul><ul><li>å¤‡æ³¨: è¿™é‡Œvsftpé‡‡ç”¨çš„è¢«åŠ¨æ¨¡å¼ï¼Œè¢«åŠ¨æ¨¡å¼å¼€æ”¾äº†ä¸€ä¸ªç«¯å£æ®µï¼Œå…¬å¸è·¯ç”±å™¨ä¸Šéœ€è¦å¼€æ”¾è¿™ä¸€ä¸ªç«¯å£ç«¯ï¼Œ<a href="https://xxlaila.github.io/2019/09/10/è·¯ç”±å™¨ç«¯å£æ˜ å°„/" target="_blank" rel="noopener">è·¯ç”±å™¨ç«¯å£æ˜ å°„</a></li></ul><h3 id="4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶"><a href="#4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶" class="headerlink" title="4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶"></a>4ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·åå•æ–‡ä»¶</h3><p>ç¼–è¾‘è™šæ‹Ÿç”¨æˆ·çš„åå•ï¼šï¼ˆç¬¬ä¸€è¡Œç”¨æˆ·åã€‚ç¬¬äºŒè¡Œå¯†ç ã€‚ä¸èƒ½ä½¿ç”¨rootï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># vim /etc/vsftpd/xuniusers</span></span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">23123213</span><br><span class="line">test1</span><br><span class="line">34dsfds</span><br><span class="line">test2</span><br><span class="line">df43sd</span><br></pre></td></tr></table></figure><h3 id="5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶"><a href="#5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶" class="headerlink" title="5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶"></a>5ã€å¼€å§‹å»ºç«‹ç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶</h3><p>è¿™é‡Œéœ€è¦å®‰è£…db4,è®¾ç½®PAMæ–‡ä»¶æƒé™ï¼Œå¹¶åˆ¶å®šè™šæ‹Ÿç”¨æˆ·æ•°æ®åº“æ–‡ä»¶è¯»å–</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum â€“y install db4-utils</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># db_load -T -t hash -f /etc/vsftpd/xuniusers /etc/vsftpd/xuniusers.db</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chmod 600 /etc/vsftpd/xuniusers.db</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;åœ¨/etc/pam.d/vsftpdçš„æ–‡ä»¶å¤´éƒ¨åŠ å…¥ä»¥ä¸‹ä¿¡æ¯ï¼ˆæ³¨*è¿™é‡Œä¸€å®šè¦åœ¨å‰é¢ï¼Œä¸èƒ½å†åé¢ï¼Œåˆšå¼€å§‹æˆ‘ä¹ŸåŠ è½½åˆ°åé¢ç™»é™†çš„æ—¶å€™æç¤ºé”™è¯¯ï¼‰,ä¿®æ”¹å‰å…ˆå¤‡ä»½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># cp /etc/pam.d/vsftpd /etc/pam.d/vsftpd.bak</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vi /etc/pam.d/vsftpd</span></span><br><span class="line">auth sufficient /lib/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br><span class="line">account sufficient /lib/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br></pre></td></tr></table></figure><p><img src="https://img.xxlaila.cn/%E5%9B%BE%E7%89%87%201.png" alt="img"></p><ul><li>æ³¨*64ä½çš„æ“ä½œç³»ç»Ÿï¼Œåˆ™ä¸Šé¢libæ”¹ä¸º64ã€‚ä¸ç„¶é…ç½®ä¹Ÿä¼šæ— æ•ˆ</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">auth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br><span class="line">account sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/xuniusers</span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;å»ºç«‹ä¸€ä¸ªç³»ç»Ÿç”¨æˆ·vsftpdï¼Œç”¨æˆ·çš„ä¸»ç›®å½•å¯ä»¥è‡ªå·±è®¾ç½®ï¼Œ/home/wwwrootï¼Œè®¾ç½®ç”¨æˆ·ç™»é™†çš„ç»ˆç«¯ä¸º/bin/false</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># useradd vsftpd -d /home/wwwroot -s /bin/false</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chown vsftpd:vsftpd /home/wwwroot -R</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># chown www:www /home/wwwroot â€“R #å¦‚æœè™šæ‹Ÿç”¨æˆ·çš„å®¿ä¸»ç”¨æˆ·ä¸ºnginxï¼Œéœ€è¦è¿™æ ·è®¾ç½®ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶"><a href="#6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶" class="headerlink" title="6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶"></a>6ã€å»ºç«‹è™šæ‹Ÿç”¨æˆ·ä¸ªäººvsftpçš„é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># mkdir /etc/vsftpd/vconf</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># cd /etc/vsftpd/vconf</span></span><br><span class="line">touch test1 test2 test3 <span class="comment">#è¿™é‡Œåˆ›å»ºä¸‰ä¸ªè™šæ‹Ÿç”¨æˆ·é…ç½®æ–‡ä»¶</span></span><br><span class="line">vi web1 <span class="comment">#ç¼–è¾‘ç”¨æˆ·test1é…ç½®æ–‡ä»¶ï¼Œå…¶ä»–çš„è·Ÿè¿™ä¸ªé…ç½®æ–‡ä»¶ç±»ä¼¼</span></span><br><span class="line">[root@RAID1 ~]<span class="comment"># vim test1</span></span><br><span class="line">local_root=/home/wwwroot/test1/</span><br><span class="line">write_enable=YES</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod u-w /home/wwwroot</span></span><br></pre></td></tr></table></figure><p>&nbsp;&nbsp;&nbsp;&nbsp;æœ€åé‡å¯vsftpdæœåŠ¡,ä¸å…³é—­Selinuxå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é€šè¿‡FTPã€‚é˜²ç«å¢™å¼€æ”¾ç«¯å£<code>setsebool -P ftpd_disable_trans 1</code><br>&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¿°é…ç½®å®Œæˆåè¿˜å¯ä»¥é€šè¿‡#adduser -d /ç›®å½•è·¯å¾„ -g vsftpd -s /sbin/nologin ç”¨æˆ·å è¿™ä¸ªå‘½ä»¤æ¥æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œä¸éœ€è¦é…ç½®ä»»ä½•æƒé™éƒ½å¯ä»¥è¿›è¡ŒFTPçš„è®¿é—®,æœ€åè¡¥å……è¯´æ˜ï¼Œéœ€è¦å®‰è£…çš„å…¶ä»–æ’ä»¶</p><ul><li><p>éœ€è¦å®‰è£…çš„çš„æ˜¯pan</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># yum install -y pam</span></span><br></pre></td></tr></table></figure></li><li><p>è¿™é‡Œæˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹æ—¥å¿—ï¼Œå¯ä»¥æ ¹æ®æç¤ºçš„æç¤ºæ¥åˆ¤æ–­ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@RAID1 ~]<span class="comment"># cat /var/log/secure</span></span><br></pre></td></tr></table></figure></li></ul><p>æµ‹è¯•ç”¨æˆ·ç™»å½•è™šæ‹Ÿç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±æœ¬èº«çš„ç›®å½• ï¼Œä¸èƒ½å»å…¶ä»–ç›®å½•æŸ¥çœ‹(åˆ°è¿™é‡Œvsftpdé…ç½®ç»“æŸ)</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>Centos</category>
      </categories>
      <tags>
        <tag>vsftpd</tag>
      </tags>
  </entry>
  <entry>
    <title>TeamViewer macç ´è§£</title>
    <url>/2019/08/09/TeamViewer-mac%E7%A0%B4%E8%A7%A3/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h2 id="TeamViewer14-4-MACç ´è§£"><a href="#TeamViewer14-4-MACç ´è§£" class="headerlink" title="TeamViewer14.4 MACç ´è§£"></a>TeamViewer14.4 MACç ´è§£</h2><h3 id="åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤"><a href="#åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤" class="headerlink" title="åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤"></a>åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo python TeamViewer-id-changer.py</span><br><span class="line">ä½¿ç”¨macè‡ªå¸¦python2.7 æ‰§è¡Œå³å¯</span><br></pre></td></tr></table></figure><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim TeamViewer-id-changer.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2019/8/1 14:57</span></span><br><span class="line"><span class="comment"># @Author  : xxlaila</span></span><br><span class="line"><span class="comment"># @Site    : </span></span><br><span class="line"><span class="comment"># @File    : TeamViewer-id-changer.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">import platform</span><br><span class="line">import random</span><br><span class="line">import re</span><br><span class="line">import string</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">--------------------------------</span></span><br><span class="line"><span class="string">TeamViewer 14 ID Changer for MAC OS</span></span><br><span class="line"><span class="string">Version: 0.2 2019</span></span><br><span class="line"><span class="string">--------------------------------</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> platform.system() != <span class="string">"Darwin"</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"This script can be run only on MAC OS."</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.geteuid() != 0:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"This script must be run form root."</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">"SUDO_USER"</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">    USERNAME = os.environ[<span class="string">"SUDO_USER"</span>]</span><br><span class="line">    <span class="keyword">if</span> USERNAME == <span class="string">"root"</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Can not find user name. Run this script via sudo from regular user"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Can not find user name. Run this script via sudo from regular user"</span>)</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line">HOMEDIRLIB = <span class="string">"/Users/"</span> + USERNAME + <span class="string">"/library/preferences/"</span></span><br><span class="line">GLOBALLIB = <span class="string">"/library/preferences/"</span></span><br><span class="line"></span><br><span class="line">CONFIGS = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Find config files</span></span><br><span class="line"></span><br><span class="line">def listdir_fullpath(d):</span><br><span class="line">    <span class="built_in">return</span> [os.path.join(d, f) <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(d)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> listdir_fullpath(HOMEDIRLIB):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'teamviewer'</span> <span class="keyword">in</span> file.lower():</span><br><span class="line">        CONFIGS.append(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> listdir_fullpath(GLOBALLIB):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'teamviewer'</span> <span class="keyword">in</span> file.lower():</span><br><span class="line">        CONFIGS.append(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not CONFIGS:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">            There is no TemViewer configs found.</span></span><br><span class="line"><span class="string">            Maybe you have deleted it manualy or never run TeamViewer after installation.</span></span><br><span class="line"><span class="string">            Nothing to delete.</span></span><br><span class="line"><span class="string">            '</span><span class="string">''</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Delete config files</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Configs found:\n"</span>)</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> CONFIGS:</span><br><span class="line">        <span class="built_in">print</span>(file)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">        This files will be DELETED permanently.</span></span><br><span class="line"><span class="string">        All TeamViewer settings will be lost</span></span><br><span class="line"><span class="string">        '</span><span class="string">''</span>)</span><br><span class="line">        raw_input(<span class="string">"Press Enter to continue or CTR+C to abort..."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> CONFIGS:</span><br><span class="line">        try:</span><br><span class="line">            os.remove(file)</span><br><span class="line">        except:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Cannot delete config files. Permission denied?"</span>)</span><br><span class="line">            sys.exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Done."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find binaryes</span></span><br><span class="line"></span><br><span class="line">TMBINARYES = [</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/MacOS/TeamViewer'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/MacOS/TeamViewer_Service'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/Helpers/TeamViewer_Desktop'</span>,</span><br><span class="line">    <span class="string">'/Applications/TeamViewer.app/Contents/Helpers/TeamViewer_Assignment'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> TMBINARYES:</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(file):</span><br><span class="line">        pass</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"File not found: "</span> + file)</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">"Install TeamViewer correctly"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Patch files</span></span><br><span class="line"></span><br><span class="line">def idpatch(fpath, platf, serial):</span><br><span class="line">    file = open(fpath, <span class="string">'r+b'</span>)</span><br><span class="line">    binary = file.read()</span><br><span class="line">    PlatformPattern = <span class="string">"IOPlatformExpert.&#123;6&#125;"</span></span><br><span class="line">    SerialPattern = <span class="string">"IOPlatformSerialNumber%s%s%s"</span></span><br><span class="line"></span><br><span class="line">    binary = re.sub(PlatformPattern, platf, binary)</span><br><span class="line">    binary = re.sub(SerialPattern % (chr(0), <span class="string">"[0-9a-zA-Z]&#123;8,8&#125;"</span>, chr(0)), SerialPattern % (chr(0), serial, chr(0)), binary)</span><br><span class="line"></span><br><span class="line">    file = open(fpath, <span class="string">'wb'</span>).write(binary)</span><br><span class="line">    <span class="built_in">return</span> True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def random_generator(size=8, chars=string.ascii_uppercase + string.ascii_lowercase + string.digits):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join(random.choice(chars) <span class="keyword">for</span> _ <span class="keyword">in</span> range(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RANDOMSERIAL = random_generator(8)</span><br><span class="line">RANDOMPLATFORM = <span class="string">"IOPlatformExpert"</span> + random_generator(6)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> TMBINARYES:</span><br><span class="line">    try:</span><br><span class="line">        idpatch(file, RANDOMPLATFORM, RANDOMSERIAL)</span><br><span class="line">    except:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Error: can not patch file "</span> + file)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"PlatformDevice: "</span> + RANDOMPLATFORM)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"PlatformSerial: "</span> + RANDOMSERIAL)</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">"sudo codesign -f -s - /Applications/TeamViewer.app/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">ID changed sucessfully.</span></span><br><span class="line"><span class="string">!!! Restart computer before using TeamViewer !!!!</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span>)</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      <categories>
        <category>TeamViewer</category>
      </categories>
      <tags>
        <tag>TeamViewer</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkins jobç®¡ç†</title>
    <url>/2019/08/09/jenkins-job%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><ul><li><strong>ä»‹ç»</strong>: ç”±äºå…¬å¸çš„ciç”¨äºç¼–è¯‘çš„ç¯å¢ƒæ¯”è¾ƒå¤šï¼Œä¸ºäº†æ›´å¥½çš„åŒºåˆ†ï¼Œä¸ºæ¯ä¸€ä¸ªç¯å¢ƒå»ºç«‹äº†ä¸€ä¸ªview</li><li><strong>ç—›ç‚¹</strong>: è¿ç»´äººå‘˜åœ¨å»ºç«‹jobçš„æ—¶å€™éœ€è¦åˆ°å¯¹åº”çš„viewä¸‹é¢å»ºç«‹ï¼Œè™½ç„¶è¿™ä¸æ˜¯ç‹ ç—›è‹¦ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚</li><li><strong>è§£å†³</strong>: äººå‘˜ç™»é™†é»˜è®¤æ˜¯åœ¨all viewä¸‹é¢ï¼Œæ¯ä¸ªè¿ç»´äººå‘˜åœ¨è¿™ä¸‹é¢å»ºç«‹jobï¼Œç„¶åæ¯ä¸ªviewæ ¹æ®è‡ªå·±çš„è§„åˆ™å§å¯¹åº”çš„jobæ·»åŠ è¿›æ¥ã€‚jobè§„åˆ™è‡ªå·±æå‰å®šä¹‰å¥½</li></ul><h2 id="1ã€å®‰è£…jenkinsæ’ä»¶"><a href="#1ã€å®‰è£…jenkinsæ’ä»¶" class="headerlink" title="1ã€å®‰è£…jenkinsæ’ä»¶"></a>1ã€å®‰è£…jenkinsæ’ä»¶</h2><p>view job è¿‡æ»¤æ’ä»¶view-job-filtersï¼Œå®‰è£…è¿‡ç¨‹ä¸ç´¯èµ˜</p><h2 id="2ã€é…ç½®viewè§„åˆ™"><a href="#2ã€é…ç½®viewè§„åˆ™" class="headerlink" title="2ã€é…ç½®viewè§„åˆ™"></a>2ã€é…ç½®viewè§„åˆ™</h2><p>è¿™é‡Œè®¾ç½®ä¸¤ä¸ªå‰ç«¯å’Œä¸€ä¸ªåç«¯å®ä¾‹</p><a id="more"></a><h3 id="2-1ã€å‰ç«¯1"><a href="#2-1ã€å‰ç«¯1" class="headerlink" title="2.1ã€å‰ç«¯1"></a>2.1ã€å‰ç«¯1</h3><p><img src="https://img.xxlaila.cn/image2018-5-29_10-47-20.png" alt="img"></p><h3 id="2-2ã€å‰ç«¯test"><a href="#2-2ã€å‰ç«¯test" class="headerlink" title="2.2ã€å‰ç«¯test"></a>2.2ã€å‰ç«¯test</h3><p>test æˆ‘ä»¬ç”¨å®‰è£…çš„è¿™ä¸ªæ’ä»¶æ¥è¿›è¡Œé…ç½®,ç‚¹å‡»Add Job Filterâ€”â€”&gt;ä¼šæœ‰å¾ˆå¤šçš„è§„åˆ™ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„çŠ¶æ€ã€æ ç›®æ¥è¿›è¡Œå´åˆ†ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©</p><p><img src="https://img.xxlaila.cn/image2018-5-29_10-49-46.png" alt="img"><br><img src="https://img.xxlaila.cn/image2018-5-29_10-52-49.png" alt="img"></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œæ·»åŠ äº†ä¸¤æ¡è§„åˆ™ï¼Œè¿™ä¸ªæ˜¯å»ºç«‹jobçš„æ—¶å€™æœ‰ç‚¹ç‰¹æ®Šæ€§ï¼Œç”¨ç¬¬ä¸€ç§æ–¹å¼å®ç°å°±ä¼šæœ‰é—®é¢˜ï¼Œç¬¬ä¸€æ¡è§„åˆ™æ˜¯ç°å®æ‰€æœ‰testç±»çš„jobï¼Œä½†æ˜¯å§ä¸‹é¢çš„ä¸€æ¡ç»™åŠ è¿›æ¥äº†ï¼Œä¸ç°å®è¿™ç±»jobã€‚ä¿æŒå³å¯</p><h2 id="åç«¯javaç¨‹åº"><a href="#åç«¯javaç¨‹åº" class="headerlink" title="åç«¯javaç¨‹åº"></a>åç«¯javaç¨‹åº</h2><p>devç¯å¢ƒä¸ºä¾‹å­</p><p><img src="https://img.xxlaila.cn/image2018-5-29_10-54-54.png" alt="img"></p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins job</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkinsç”¨æˆ·æƒé™é…ç½®</title>
    <url>/2019/08/09/jenkins%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><h3 id="1ã€jenkinsç”¨æˆ·æƒé™"><a href="#1ã€jenkinsç”¨æˆ·æƒé™" class="headerlink" title="1ã€jenkinsç”¨æˆ·æƒé™"></a>1ã€jenkinsç”¨æˆ·æƒé™</h3><ul><li>å¯ä»¥é›†æˆgitlabã€jenkinsä¸“æœ‰è´¦æˆ·ã€LDAPã€Servletå®¹å™¨ä»£ç†ã€Unixç”¨æˆ·/ç»„æ•°æ®åº“</li></ul><h3 id="2ã€æˆæƒç­–ç•¥"><a href="#2ã€æˆæƒç­–ç•¥" class="headerlink" title="2ã€æˆæƒç­–ç•¥"></a>2ã€æˆæƒç­–ç•¥</h3><ul><li>Gitlab Commiter Authorization Strategy</li><li>Role-Based Strategy</li><li>ä»»ä½•ç”¨æˆ·å¯ä»¥åšä»»ä½•äº‹(æ²¡æœ‰ä»»ä½•é™åˆ¶)</li><li>å®‰å…¨çŸ©é˜µ</li><li>ç™»å½•ç”¨æˆ·å¯ä»¥åšä»»ä½•äº‹</li><li>é—ç•™æ¨¡å¼</li><li>é¡¹ç›®çŸ©é˜µæˆæƒç­–ç•¥</li></ul><h3 id="3ã€æ’ä»¶å®‰è£…"><a href="#3ã€æ’ä»¶å®‰è£…" class="headerlink" title="3ã€æ’ä»¶å®‰è£…"></a>3ã€æ’ä»¶å®‰è£…</h3><p>å®‰è£…æ’ä»¶ï¼šRole-based Authorization Strategy</p><a id="more"></a><h3 id="4ã€jenkinsè®¾ç½®"><a href="#4ã€jenkinsè®¾ç½®" class="headerlink" title="4ã€jenkinsè®¾ç½®"></a>4ã€jenkinsè®¾ç½®</h3><p>ç³»ç»Ÿç®¡ç†â€”â€”&gt;å…¨å±€å®‰å…¨é…ç½®â€”â€”&gt;<br><img src="https://img.xxlaila.cn/image2018-5-11_14-26-37.png" alt="img"></p><p>å›åˆ°ç³»ç»Ÿç®¡ç†ç•Œé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°å¤šå‡ºæ¥ä¸€ä¸ªæ’ä»¶: Mangge and Assing Roles</p><h3 id="5ã€æƒé™è®¾ç½®"><a href="#5ã€æƒé™è®¾ç½®" class="headerlink" title="5ã€æƒé™è®¾ç½®"></a>5ã€æƒé™è®¾ç½®</h3><p>è¿›å…¥Manager and Assign Rolesâ€”â€”&gt;Manage Roles,è¿™é‡Œå»ºç«‹äº†å››ä¸ªæƒé™ï¼Œåˆ†åˆ«æ¥å¯¹åº”ä¸åŒçš„äººå‘˜<br><img src="https://img.xxlaila.cn/image2018-5-24_11-35-15.png" alt="img"></p><ul><li>åˆ›å»ºé¡¹ç›®è§’è‰²:</li></ul><p><img src="https://img.xxlaila.cn/image2018-5-24_11-35-27.png" alt="img"></p><p>å›åˆ°Manage and Assign Rolesç•Œé¢</p><h3 id="6ã€é…ç½®è§’è‰²"><a href="#6ã€é…ç½®è§’è‰²" class="headerlink" title="6ã€é…ç½®è§’è‰²"></a>6ã€é…ç½®è§’è‰²</h3><p>é€‰æ‹©Assign Roles,ç”¨æˆ·æ–°å»ºä»¥åï¼Œæ ¹æ®ç”¨æˆ·ä¸åŒç±»å‹çš„å‹¾é€‰ä¸åŒçš„æƒé™,</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodbå‰¯æœ¬é›†</title>
    <url>/2019/08/09/mongodb%E5%89%AF%E6%9C%AC%E9%9B%86/</url>
    <content><![CDATA[<!-- build time:Fri Nov 01 2019 20:14:22 GMT+0800 (China Standard Time) --><p>&nbsp;&nbsp;&nbsp;&nbsp;Mongodb replica setå®‰è£…åŠ è®¤è¯ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯keyFileè¿›è¡Œè®¤è¯ï¼Œä¹‹å‰çœ‹è¿‡å¾ˆå¤šæ–‡ç« ï¼Œå‘ä¸€å¤§å †ï¼Œè¿™é‡Œæ˜¯çœ‹äº†ä¸¤å¤©çš„å®˜æ–¹æ–‡æ¡£è¿›è¡Œçš„å®‰è£…ï¼Œå¹¶ç”¨æˆ·ç”Ÿäº§ï¼Œé…ç½®æ–‡ä»¶å‚æ•°è´´ä¸€éƒ¨åˆ†,ä¸‰ä¸ªå¸¦æœ‰æ•°æ®é›†çš„èŠ‚ç‚¹ç»„æˆçš„å¤åˆ¶é›†æ‹¥æœ‰ï¼Œæ¶æ„å›¾å¦‚ä¸‹ï¼Œå‚è€ƒå®˜æ–¹</p><p><img src="https://img.xxlaila.cn/image2018-8-13_15-27-53.png" alt="img"><br>ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ï¼Œè¿™ä¸¤ä¸ªä»èŠ‚ç‚¹éƒ½å¯ä»¥åœ¨é€‰ä¸¾ä¸­å‡çº§ä¸ºä¸»èŠ‚ç‚¹</p><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>ä¸‰å°æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">primary: 192.168.32.7</span><br><span class="line">secaodray: 192.168.32.11</span><br><span class="line">secondary: 192.168.32.14</span><br></pre></td></tr></table></figure><h2 id="1ã€å®‰è£…mongodb"><a href="#1ã€å®‰è£…mongodb" class="headerlink" title="1ã€å®‰è£…mongodb"></a>1ã€å®‰è£…mongodb</h2><h3 id="1-1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ"><a href="#1-1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ" class="headerlink" title="1.1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ"></a>1.1ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo vim /etc/yum.repos.d/mongodb-enterprise.repo</span></span><br><span class="line">[mongodb-enterprise]</span><br><span class="line">name=MongoDB Enterprise Repository</span><br><span class="line">baseurl=https://repo.mongodb.com/yum/redhat/<span class="variable">$releasever</span>/mongodb-enterprise/3.4/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc   </span><br><span class="line"></span><br><span class="line"><span class="comment"># sudo yum install -y mongodb-enterprise</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå¦‚æœé‡‡ç”¨æºç åŒ…æ–¹å¼å®‰è£…éœ€è¦å®‰è£…ä¸€ä¸‹æ’ä»¶</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo yum install cyrus-sasl cyrus-sasl-plain cyrus-sasl-gssapi krb5-libs lm_sensors-libs net-snmp-agent-libs net-snmp openssl rpm-libs tcp_wrappers-libs libcurl</span></span><br></pre></td></tr></table></figure><h2 id="2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶-æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ"><a href="#2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶-æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ" class="headerlink" title="2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶(æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ)"></a>2ã€ä¿®æ”¹mongodbçš„é…ç½®æ–‡ä»¶(æ¯ä¸ªèŠ‚ç‚¹å‡æ“ä½œ)</h2><h3 id="è‡ªå®šä¹‰mongodbçš„ç›®å½•"><a href="#è‡ªå®šä¹‰mongodbçš„ç›®å½•" class="headerlink" title="è‡ªå®šä¹‰mongodbçš„ç›®å½•"></a>è‡ªå®šä¹‰mongodbçš„ç›®å½•</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /opt/mongodb/&#123;data,conf,logs&#125; -p</span></span><br><span class="line"><span class="comment"># sudo vim /etc/mongod.conf</span></span><br><span class="line"> systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /opt/mongodb/logs/mongod.log</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /opt/mongodb/data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  pidFilePath: /opt/mongodb/logs/mongod.pid</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0</span><br></pre></td></tr></table></figure><h3 id="3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶-åœ¨mong01ä¸Šæ“ä½œ"><a href="#3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶-åœ¨mong01ä¸Šæ“ä½œ" class="headerlink" title="3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶(åœ¨mong01ä¸Šæ“ä½œ)"></a>3ã€ç”Ÿæˆå¯†é’¥æ–‡ä»¶(åœ¨mong01ä¸Šæ“ä½œ)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openssl rand -base64 756 &gt; ï¼opt/mongodb/conf/mongo-keyfile</span></span><br><span class="line"><span class="comment"># sudo chmod 400 /opt/mongo/mongo-keyfile</span></span><br><span class="line"><span class="comment"># scp â€“r mongo-keyfile user@192.168.32.11:/opt/mongodb/conf</span></span><br><span class="line"><span class="comment"># scp â€“r mongo-keyfile user@192.168.32.14:/opt/mongodb/conf</span></span><br></pre></td></tr></table></figure><h3 id="4ã€ä¿®æ”¹mongodbçš„é…ç½®"><a href="#4ã€ä¿®æ”¹mongodbçš„é…ç½®" class="headerlink" title="4ã€ä¿®æ”¹mongodbçš„é…ç½®"></a>4ã€ä¿®æ”¹mongodbçš„é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">security:</span><br><span class="line">  keyFile: /opt/mongodb/conf/mongo-keyfile</span><br><span class="line">replication:</span><br><span class="line">  replSetName: xxlaila01ï¼ˆå¯å˜åŒ–ï¼Œè‡ªå®šä¹‰ï¼‰</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«åœ¨ä¸‰å°æœåŠ¡å™¨ä¸Šå¯åŠ¨mongodb</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mongod --config /etc/mongod.conf</span></span><br></pre></td></tr></table></figure><h3 id="5ã€å»ºç«‹é›†ç¾¤"><a href="#5ã€å»ºç«‹é›†ç¾¤" class="headerlink" title="5ã€å»ºç«‹é›†ç¾¤"></a>5ã€å»ºç«‹é›†ç¾¤</h3><p>åœ¨ä½ éœ€è¦è®¤ä¸ºæ˜¯ä¸»èŠ‚ç‚¹çš„æœåŠ¡å™¨è¿›è¡Œmongodbçš„ç™»é™†ï¼Œå’Œè´¦æˆ·æƒé™çš„å»ºç«‹ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©çš„192.168.32.7</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongo --shell --host 127.0.0.1</span><br></pre></td></tr></table></figure><p>ç™»é™†è¿›å»ä»¥åå¯ä»¥è¿›è¡Œä¸€ä¸ªç®€å•çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹</p><p><img src="https://img.xxlaila.cn/image2018-8-13_15-37-2.png" alt="img"></p><h3 id="6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†"><a href="#6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†" class="headerlink" title="6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†"></a>6ã€æŠŠæœåŠ¡å™¨åŠ å…¥å‰¯æœ¬é›†</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise &gt; config = &#123; _id:<span class="string">"kxlprod01"</span>,members:[ &#123;_id:0,host:<span class="string">"192.168.32.7:27017"</span>&#125;,</span><br><span class="line">...   &#123;_id:1,host:<span class="string">"192.168.32.11:27017"</span>&#125; ,&#123;_id:2,host:<span class="string">"192.168.32.14:27017"</span>&#125;] &#125;</span><br></pre></td></tr></table></figure><p>config = { _id:â€kxlprod01â€,members:[ {_id:0,host:â€192.168.32.7:27017â€},{_id:1,host:â€192.168.32.11:27017â€} ,{_id:2,host:â€192.168.32.14:27017â€}] }ï¼Œå¢åŠ å†…å®¹</p><h4 id="6-1-çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€"><a href="#6-1-çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€" class="headerlink" title="6.1 çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€"></a>6.1 çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€</h4><p>åˆ©ç”¨rs.status()å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰å‰¯æœ¬é›†çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; rs.status()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæç¤ºé…ç½®è¿˜æ²¡æœ‰åŠ è½½åˆ°mongodbå‰¯æœ¬é‡Œé¢</p><h4 id="6-2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†"><a href="#6-2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†" class="headerlink" title="6.2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†"></a>6.2ã€åŠ è½½é…ç½®åˆ°å‰¯æœ¬é›†</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; rs.initiate(config)</span><br></pre></td></tr></table></figure><p>å†æ¬¡æŸ¥çœ‹å‰¯æœ¬çš„çŠ¶æ€å°±å¯ä»¥çœ‹åˆ°mongodbçš„å‰¯æœ¬é›†å·²å»ºç«‹ï¼Œå¦‚æœæ­¤æ—¶ä¸»èŠ‚ç‚¹æœªè¢«é€‰ä¸¾å‡ºæ¥ï¼Œç¨å¾®ç­‰ä¸€ä¼šå°±æˆåŠŸ</p><h3 id="7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯"><a href="#7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯" class="headerlink" title="7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯"></a>7ã€åˆ›å»ºmongodbå‰¯æœ¬é›†è®¤è¯</h3><p>ä¸‹é¢ä¸¤è¡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡ä¸»èŠ‚ç‚¹æ²¡æœ‰é€‰ä¸¾æˆåŠŸï¼Œéšå³æˆ‘ä»¬åœ¨å›è½¦PRIMARYèŠ‚ç‚¹é€‰ä¸¾æˆåŠŸäº†ï¼Œä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise xxlaila01:SECONDARY&gt; admin = db.getSiblingDB(<span class="string">"admin"</span>)</span><br><span class="line">MongoDB Enterprise xxlaila01:PRIMARY&gt;</span><br><span class="line">admin.createUser(</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    user: <span class="string">"root"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"123456"</span>,</span><br><span class="line"></span><br><span class="line">    roles: [ &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"root"</span>, <span class="string">"123456"</span> )</span><br></pre></td></tr></table></figure><h4 id="7-1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·"><a href="#7-1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·" class="headerlink" title="7.1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·"></a>7.1ã€åˆ›å»ºé›†ç¾¤è´¦æˆ·</h4><p>åˆ›å»ºä¸€ä¸ªé›†ç¾¤ç®¡ç†è´¦æˆ·ï¼Œé›†ç¾¤è´¦æˆ·å…·æœ‰ç®¡ç†æ•´ä¸ªå‰¯æœ¬é›†çš„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo -u <span class="string">"root"</span> -p <span class="string">"123456"</span> --authenticationDatabase <span class="string">"admin"</span></span><br><span class="line"></span><br><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"user"</span> : <span class="string">"manger"</span>,</span><br><span class="line">    <span class="string">"pwd"</span> : <span class="string">"123456"</span>,</span><br><span class="line">    roles: [ &#123; <span class="string">"role"</span> : <span class="string">"clusterAdmin"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span> &#125; ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="7-2-åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·"><a href="#7-2-åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·" class="headerlink" title="7.2 åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·"></a>7.2 åˆ›å»ºä¸€ä¸ªç¨‹åºè¿æ¥çš„è´¦æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db.getSiblingDB(<span class="string">"admin"</span>).createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"user"</span> : <span class="string">"systemprod"</span>,</span><br><span class="line">    <span class="string">"pwd"</span> : <span class="string">"123456"</span>,</span><br><span class="line">    roles: [ &#123; <span class="string">"role"</span> : <span class="string">"root"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è‡³æ­¤mongodbçš„å‰¯æœ¬é›†åˆ›å»ºå®Œæˆã€‚æµ‹è¯•æ²¡æœ‰é—®é¢˜,ç™»é™†å…¶ä¸­ä¸€å°SECONDARYæœåŠ¡å™¨è¿›è¡Œæµ‹è¯•,è¿™é‡Œæµ‹è¯•192.168.32.11æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo</span><br><span class="line"></span><br><span class="line">&gt; rs.status()    <span class="comment"># è¿™é‡Œæç¤ºæ²¡æœ‰æƒé™ï¼ˆç™»å½•è¿›æ¥ä»¥åå¦‚æœä¸æ˜¯ä¸»å‡ ç‚¹ï¼Œmognodbå°±ä¼šé»˜è®¤æ˜¾ç¤ºæœªsecondaryï¼‰</span></span><br><span class="line"></span><br><span class="line">&gt; use admin 	<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">&gt; db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"manger"</span>, <span class="string">"123456"</span>)</span><br></pre></td></tr></table></figure><p>å®Œæˆåæˆ‘ä»¬åœ¨æ‰§è¡Œrs.status()å°±å¯ä»¥çœ‹åˆ°å‰¯æœ¬é›†çš„ä¿¡æ¯</p><h4 id="7-3-æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·"><a href="#7-3-æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·" class="headerlink" title="7.3 æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·"></a>7.3 æµ‹è¯•ç¨‹åºè¿æ¥è´¦æˆ·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MongoDB Enterprise xxlaila01:SECONDARY&gt; db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"systemprod"</span>, <span class="string">"123456"</span> )</span><br><span class="line">&gt; show dbs;	<span class="comment">#ä¼šæç¤º â€œnot master and slaveok=falseâ€</span></span><br><span class="line"></span><br><span class="line">&gt; db.getMongo().setSlaveOk()</span><br><span class="line">&gt; show dbs;	<span class="comment">#åœ¨æ¬¡æ‰§è¡Œä¼šæ˜¾ç¤ºå‡ºç»“æœ</span></span><br></pre></td></tr></table></figure><p>å‰¯æœ¬é›†æ²¡æœ‰è¯»çš„æƒé™ï¼Œéœ€è¦æ‰§è¡Œdb.getMongo().setSlaveOk()</p><!-- rebuild by neat -->]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>mongodb,mongodbå‰¯æœ¬é›†,mongodbé«˜å¯ç”¨</tag>
      </tags>
  </entry>
</search>
